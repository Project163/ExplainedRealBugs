{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5462","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5462/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5462/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5462/events","html_url":"https://github.com/sidekiq/sidekiq/issues/5462","id":1332893679,"node_id":"I_kwDOADDA9M5Pclfv","number":5462,"title":"uninitialized constant Sidekiq::Component after upgrading from 6.5.1 to 6.5.4","user":{"login":"denisj","id":722010,"node_id":"MDQ6VXNlcjcyMjAxMA==","avatar_url":"https://avatars.githubusercontent.com/u/722010?v=4","gravatar_id":"","url":"https://api.github.com/users/denisj","html_url":"https://github.com/denisj","followers_url":"https://api.github.com/users/denisj/followers","following_url":"https://api.github.com/users/denisj/following{/other_user}","gists_url":"https://api.github.com/users/denisj/gists{/gist_id}","starred_url":"https://api.github.com/users/denisj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/denisj/subscriptions","organizations_url":"https://api.github.com/users/denisj/orgs","repos_url":"https://api.github.com/users/denisj/repos","events_url":"https://api.github.com/users/denisj/events{/privacy}","received_events_url":"https://api.github.com/users/denisj/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2022-08-09T08:20:39Z","updated_at":"2022-08-12T16:49:15Z","closed_at":"2022-08-09T13:34:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 3.1.2\r\nRails version: 7.0.3.1\r\nSidekiq / Pro / Enterprise version(s): 6.5.4 (normal version)\r\nOS : Ubuntu 18.04.6 LTS\r\n\r\nAfter upgrading to 6.5.4 and running `bundle exec rails test`, I got this error:\r\n\r\n### Backtrace\r\n```\r\n/home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/sidekiq-6.5.4/lib/sidekiq/job_retry.rb:66:in `<class:JobRetry>': uninitialized constant Sidekiq::Component (NameError)\r\n\r\n    include Sidekiq::Component\r\n                   ^^^^^^^^^^^\r\nDid you mean?  Complex\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/sidekiq-6.5.4/lib/sidekiq/job_retry.rb:61:in `<module:Sidekiq>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/sidekiq-6.5.4/lib/sidekiq/job_retry.rb:6:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/sidekiq-status-2.1.3/lib/sidekiq-status/server_middleware.rb:2:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/sidekiq-status-2.1.3/lib/sidekiq-status.rb:6:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bundler-2.3.11/lib/bundler/runtime.rb:60:in `block (2 levels) in require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bundler-2.3.11/lib/bundler/runtime.rb:55:in `each'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bundler-2.3.11/lib/bundler/runtime.rb:55:in `block in require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bundler-2.3.11/lib/bundler/runtime.rb:44:in `each'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bundler-2.3.11/lib/bundler/runtime.rb:44:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bundler-2.3.11/lib/bundler.rb:176:in `require'\r\n\tfrom /home/djean/workspace/conversation-stable/config/application.rb:23:in `<main>'\r\n\tfrom /home/djean/workspace/conversation-stable/config/environment.rb:2:in `require_relative'\r\n\tfrom /home/djean/workspace/conversation-stable/config/environment.rb:2:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/workspace/conversation-stable/test/test_helper.rb:22:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/workspace/conversation-stable/test/controllers/admin/networks_controller_test.rb:1:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/test_unit/runner.rb:47:in `block in load_tests'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/test_unit/runner.rb:47:in `each'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/test_unit/runner.rb:47:in `load_tests'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/test_unit/runner.rb:40:in `run'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/commands/test/test_command.rb:33:in `perform'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/command/base.rb:87:in `perform'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/command.rb:48:in `invoke'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/railties-7.0.3.1/lib/rails/commands.rb:18:in `<main>'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom /home/djean/software/ecairn/rvm/gems/ruby-3.1.2@rails7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n\tfrom script/rails:8:in `<main>'\r\n```\r\n\r\n### sidekiq.yml\r\n```\r\ndevelopment:\r\n  :require: /home/djean/workspace/conversation-stable/config/environment.rb\r\n  :client_pool_size: 1\r\n  :server_pool_size: 13\r\n  :timeout: 10\r\n  :concurrency: 10\r\n\r\ntest:\r\n  :require: /home/djean/workspace/conversation-stable/config/environment.rb\r\n  :client_pool_size: 1\r\n  :server_pool_size: 13\r\n  :timeout: 10\r\n  :concurrency: 10\r\n\r\nproduction:\r\n  :require: /home/djean/workspace/conversation-stable/config/environment.rb\r\n  :client_pool_size: 1\r\n  :server_pool_size: 13\r\n  :timeout: 10\r\n  :concurrency: 10\r\n\r\n:queues:\r\n  - mailer\r\n  - [network_report, 2]\r\n  - [digest, 2]\r\n  - [top_articles_report, 4]\r\n  - [enrichment, 4]\r\n  - [labeling, 4]\r\n  - [classification, 4]\r\n  - [twitter_api, 4]\r\n  - [import, 4]\r\n  - [prediction, 4]\r\n  - [adv_app, 4]\r\n  - [affluent_kb, 4]\r\n  - [expand, 5]\r\n  - [compute_metrics, 5]\r\n  - [compute_relationships, 5]\r\n  - [other, 5]\r\n\r\n:limits:\r\n  network_report: 2\r\n  digest: 2\r\n  twitter_api: 2\r\n  labeling: 2\r\n  classification: 2\r\n  enrichment: 2\r\n  import: 2\r\n  prediction: 2\r\n  affluent_kb: 2\r\n\r\n:process_limits:\r\n  network_report: 1\r\n  digest: 1\r\n```\r\n\r\n### Initializer\r\n```\r\nrequire 'fileutils'\r\nrequire 'redis/connection_pool'\r\nrequire 'sidekiq/admin'\r\nrequire 'sidekiq/rails'\r\nrequire 'sidekiq-status'\r\nrequire 'sidekiq/middleware/server/expiring_jobs'\r\nrequire 'sidekiq/middleware/server/sentry_error_logger'\r\nrequire 'sidekiq/extensions/action_mailer'\r\n\r\n# exception_notification provides a Sidekiq middleware (server)\r\n# that notify in case of exception by passing Sidekiq data.\r\nrequire 'exception_notification/sidekiq'\r\n\r\nRedis.exists_returns_integer = true\r\n\r\n# see https://github.com/mperham/sidekiq/blob/v3.3.2/lib/sidekiq/rails.rb#L35\r\n# see https://github.com/mperham/sidekiq/wiki/Delayed-extensions\r\n# Delayed extensions are disabled by default in sidekiq5+\r\n# Sidekiq.remove_delay!\r\n\r\nActiveSupport.on_load(:action_mailer) do\r\n  extend Sidekiq::Extensions::ActionMailer\r\nend\r\n\r\n# https://github.com/mhenrixon/sidekiq-unique-jobs/blob/master/README.md#add-the-middleware\r\nSidekiq.configure_server do |config|\r\n  # re-define Rails.logger as Sidekiq logger\r\n  ::Rails.logger = Sidekiq.logger\r\n\r\n  config.redis = Redis.connection('sidekiq', Sidekiq::Admin.server_pool_size)\r\n\r\n  config.client_middleware do |chain|\r\n    chain.add SidekiqUniqueJobs::Middleware::Client\r\n    chain.add Sidekiq::Status::ClientMiddleware, expiration: 30.minutes\r\n  end\r\n\r\n  config.server_middleware do |chain|\r\n    chain.add Sidekiq::Middleware::Server::ExpiringJobs\r\n    chain.add Sidekiq::Middleware::Server::SentryErrorLogger\r\n    chain.add Sidekiq::Status::ServerMiddleware, expiration: 30.minutes\r\n    chain.add SidekiqUniqueJobs::Middleware::Server\r\n\r\n    if Sidekiq::Admin.profile_every\r\n      require 'sidekiq/middleware/server/memory_profiler'\r\n      heap_dir = File.join(::Rails.root, 'tmp', 'sidekiq', ::Rails.env)\r\n      ::FileUtils.mkdir_p heap_dir\r\n\r\n      chain.add Sidekiq::Middleware::Server::MemoryProfiler,\r\n        every: Sidekiq::Admin.profile_every,\r\n        dir: heap_dir\r\n\r\n      Sidekiq.logger.info \"Memory profiler configured to dump heap every #{Sidekiq::Admin.profile_every} job(s)\"\r\n    end\r\n  end\r\n\r\n  SidekiqUniqueJobs::Server.configure(config)\r\n\r\n  # Change DB pool size for ActiveRecord\r\n  # https://github.com/mperham/sidekiq/issues/503\r\n  if defined?(ActiveRecord::Base)\r\n    ActiveRecord::Base.connection_pool.disconnect!\r\n    db_config = ::Rails.application.config.database_configuration[::Rails.env]\r\n    db_config['pool'] = Sidekiq::Admin.concurrency + 2 # Give it some buffer\r\n    ActiveRecord::Base.establish_connection(db_config)\r\n  end\r\nend\r\n\r\nSidekiq.configure_client do |config|\r\n  config.redis = Redis.connection('sidekiq', Sidekiq::Admin.client_pool_size)\r\n\r\n  config.client_middleware do |chain|\r\n    chain.add SidekiqUniqueJobs::Middleware::Client\r\n    chain.add Sidekiq::Status::ClientMiddleware, expiration: 30.minutes\r\n  end\r\nend\r\n\r\n# change default sidekiq options for Sidekiq::Extensions::DelayedMailer\r\nmodule Sidekiq\r\n  module Extensions\r\n    class DelayedMailer\r\n      sidekiq_options queue: :mailer, retry: true\r\n    end\r\n  end\r\nend\r\n```","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5462/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5462/timeline","performed_via_github_app":null,"state_reason":"not_planned"}