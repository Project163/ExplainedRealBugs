{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6688","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6688/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6688/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6688/events","html_url":"https://github.com/sidekiq/sidekiq/issues/6688","id":3021641456,"node_id":"I_kwDOADDA9M60Gpbw","number":6688,"title":"CSRF Middleware Issue With Sinatra","user":{"login":"richpeck","id":1104431,"node_id":"MDQ6VXNlcjExMDQ0MzE=","avatar_url":"https://avatars.githubusercontent.com/u/1104431?v=4","gravatar_id":"","url":"https://api.github.com/users/richpeck","html_url":"https://github.com/richpeck","followers_url":"https://api.github.com/users/richpeck/followers","following_url":"https://api.github.com/users/richpeck/following{/other_user}","gists_url":"https://api.github.com/users/richpeck/gists{/gist_id}","starred_url":"https://api.github.com/users/richpeck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/richpeck/subscriptions","organizations_url":"https://api.github.com/users/richpeck/orgs","repos_url":"https://api.github.com/users/richpeck/repos","events_url":"https://api.github.com/users/richpeck/events{/privacy}","received_events_url":"https://api.github.com/users/richpeck/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-04-26T09:05:30Z","updated_at":"2025-04-28T15:44:25Z","closed_at":"2025-04-27T23:49:38Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 3.4.3\nRails version: N/A\nSidekiq / Pro / Enterprise version(s): Free 8.0.3\n\n--\n\nUpon upgrading to 8.x, I found that when I mounted the `Sidekiq::Web` class in Sinatra/Padrino, it would throw an error due to the CSRF protection middleware not having access to the rack sessions cookie.\n\nThe way I managed to fix this previously was to add the `Rack::Sessions::Cookie\" class to the middleware stack of Sidekiq: -\n\n`Sidekiq::Web.use Rack::Session::Cookie, secret: 'xxxxxxx'`\n\nThis stopped working with the latest version of `Sidekiq`.\n\nThe reason why it stopped working is because the session cookie middleware was added after the CSRF token middleware. This is what I saw from the middleware when I inspected it: -\n\n`[Sidekiq::Web::CsrfProtection, [[Rack::Session::Cookie, {secret: \"xxxxxx\"}], nil]] `\n\nThe error that was being thrown was: -\n\n`Sidekiq::Web needs a valid Rack session for CSRF protection...`\n\nThis is present [here](https://github.com/sidekiq/sidekiq/blob/main/lib/sidekiq/web/csrf_protection.rb#L68).\n\nThe core problem was the `CsrfProtection` middleware was invoked *before* the session cookie one.\n\nI managed to get it to work by using the following after adding the session cookie middleware with the `use` method: -\n\n`Sidekiq::Web.middlewares.reverse! `\n\nThus, my initializer looked like: -\n\n```\nif(Object.const_defined?('Sidekiq'))\n\n    ## RPECK 19/04/2024 - Required to allow the Sidekiq Web UI to work\n    ## https://stackoverflow.com/a/73116790/1143732\n    Sidekiq::Web.use Rack::Session::Cookie, secret: 'xxxxxx') # => added the cookie to ENV but it can be hard coded as it doesn't do much\n\n    ## RPECK 26/04/2025 - Reverse the Middlewares property of the Sidekiq::Web class\n    ## This was required to get the Sidekiq Web interface to function\n    ## --\n    ## The reason is because when you add the above cookie middleware, it will append it to the middlewares array, which already has the CSRF protection array value: [Sidekiq::Web::CsrfProtection, [[Rack::Session::Cookie, {secret: \"xxxxxx\"}], nil]] \n    ## The way to fix it is to basically make the Rack::Session::Cookie middleware first\n    ## Ref: ./vendor/gems/.../sidekiq-8.0.3/web.rb line 101\n    Sidekiq::Web.middlewares.reverse! \n    \nend\n```\n\nThis managed to get it working.\n\nI don't have any suggestions and, really, just wanted to highlight this in case anybody wanted to Google the solution. I think it should be mentioned somewhere in the documentation.","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6688/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6688/timeline","performed_via_github_app":null,"state_reason":"completed"}