{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4495","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4495/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4495/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4495/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4495","id":583398388,"node_id":"MDU6SXNzdWU1ODMzOTgzODg=","number":4495,"title":"Redis errors in acknowledge for super_fetch cause them to retry only after restart","user":{"login":"mattbooks","id":784761,"node_id":"MDQ6VXNlcjc4NDc2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/784761?v=4","gravatar_id":"","url":"https://api.github.com/users/mattbooks","html_url":"https://github.com/mattbooks","followers_url":"https://api.github.com/users/mattbooks/followers","following_url":"https://api.github.com/users/mattbooks/following{/other_user}","gists_url":"https://api.github.com/users/mattbooks/gists{/gist_id}","starred_url":"https://api.github.com/users/mattbooks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattbooks/subscriptions","organizations_url":"https://api.github.com/users/mattbooks/orgs","repos_url":"https://api.github.com/users/mattbooks/repos","events_url":"https://api.github.com/users/mattbooks/events{/privacy}","received_events_url":"https://api.github.com/users/mattbooks/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2020-03-18T01:25:35Z","updated_at":"2020-06-19T19:10:39Z","closed_at":"2020-06-19T19:10:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.6.5\r\nSidekiq / Pro / Enterprise version(s): sidekiq 5.2.7 / sidekiq-pro 4.0.5\r\n\r\nUsing an old version, but I don't see a fix listed in the sidekiq pro changelog.\r\n\r\n**Problem**\r\nWe use super_fetch, and (because of failovers) it sometimes fails to `lrem` the job from the \"local_queue\" when acknowledging the job's success (and to make matters worse, the error is swallowed by `processor_died`). When this happens, the job sits there until the sidekiq worker is shut down/rebooted, when it is re-enqueued by `bulk_requeue`. We make sure that our jobs are idempotent so that it is fine for them to be re-enqueued, but the fact that it doesn't run again until we restart is somewhat problematic for us, because some of the services we interact with are only idempotent for a period of time (one example is 3 days, after which a retry will cause an additional side-effect); so if we don't restart our application for too long after a failover, we can run into duplicate side-effects.\r\n\r\nWe can also detect these by inspecting all of the local/private queues and seeing if any have been enqueued longer than we expect our jobs to take — is there any more reliable way to determine if there is nothing actually running those jobs anymore and re-enqueueing them more aggressively?\r\n\r\nI'm also curious: is it intentional that none of the redis calls have retries for connection errors? We have failovers regularly and if sidekiq retried some of these commands on connection errors it would those much smoother for us; not sure if I'm missing some technical reason why that would be dangerous.","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4495/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4495/timeline","performed_via_github_app":null,"state_reason":"completed"}