{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4821","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4821/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4821/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4821/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4821","id":812154171,"node_id":"MDU6SXNzdWU4MTIxNTQxNzE=","number":4821,"title":"Sidekiq's UI logs out the user session (multiple suggestions tried)","user":{"login":"altjx","id":4023423,"node_id":"MDQ6VXNlcjQwMjM0MjM=","avatar_url":"https://avatars.githubusercontent.com/u/4023423?v=4","gravatar_id":"","url":"https://api.github.com/users/altjx","html_url":"https://github.com/altjx","followers_url":"https://api.github.com/users/altjx/followers","following_url":"https://api.github.com/users/altjx/following{/other_user}","gists_url":"https://api.github.com/users/altjx/gists{/gist_id}","starred_url":"https://api.github.com/users/altjx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/altjx/subscriptions","organizations_url":"https://api.github.com/users/altjx/orgs","repos_url":"https://api.github.com/users/altjx/repos","events_url":"https://api.github.com/users/altjx/events{/privacy}","received_events_url":"https://api.github.com/users/altjx/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2021-02-19T16:19:23Z","updated_at":"2021-02-20T16:42:08Z","closed_at":"2021-02-20T00:07:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"_**Versions**_\r\nSidekiq Pro: 5.2.1\r\nRuby on Rails: 5.2.3\r\nRuby: 2.5.8\r\n\r\n_**Issue**_\r\nI've been trying to figure out what's causing my app to do this for quite some time, and I finally just realized yesterday that the Sidekiq UI is logging out my session.\r\n\r\n_**Issue reproduction**_\r\n\r\n1. Navigate to my application's URL and login\r\n2. Navigate to my application's URL in a second tab with `/sidekiq` appended, to visit the Sidekiq Pro Web UI\r\n3. Refresh the first tab\r\n4. First tab now requires me to login again\r\n\r\n_**Suggestion 1 (unsuccessful)**_\r\nRE: https://stackoverflow.com/questions/38742116/rails-devise-and-sidekiq-routes\r\nRE: https://github.com/mperham/sidekiq/issues/3085\r\nRE: https://github.com/mperham/sidekiq/issues/3792\r\n\r\nI've tried adding this to my Rails routes file:\r\n\r\n```\r\ndevise_scope :user do\r\n  authenticated :user do\r\n    mount Sidekiq::Web => '/sidekiq'\r\n  end\r\nend\r\n```\r\n\r\nat the very top of my `config/routes.rb` file, but no luck. Still logs out the user when browsing to the Sidekiq Pro web interface.\r\n\r\n_**Suggestion 2 (unsuccessful)**_\r\nThe comment in https://github.com/mperham/sidekiq/issues/3792 suggests https://github.com/mperham/sidekiq/wiki/Monitoring#forbidden, which suggests adding\r\n\r\n```\r\nrequire \"sidekiq/pro/web\"\r\nSidekiq::Web.set :session_secret, Rails.application.credentials[:secret_key_base]\r\n```\r\n\r\nto the `config/initializers/sidekiq.rb` file. \r\n\r\nI have tried doing that and nothing has changed -- still logs me out when navigating to the Sidekiq UI. I have also confirmed that the `secret_key_base` variable in the Rails credentials exist, so it's definitely getting a valid string there returned.\r\n\r\nOne observation that I made was that, when I login to my application, ActiveRecord::SessionStore::Session is setting my session to a pretty long value, as shown here (from the rails console):\r\n\r\n```\r\n  ActiveRecord::SessionStore::Session Update (1.9ms)  UPDATE \"sessions\" SET \"data\" = $1, \"updated_at\" = $2 WHERE \"sessions\".\"id\" = $3  [[\"data\", \"BAh7CUkiGXdhcmRlbi51c2VyLnVzZXIua2V5BjoGRVRbB1sGaQZJIiIkMmEk\\nMTEkZVpPR1YubDBUb0MwT3o1eEt0QS8wTwY7AFRJIh13YXJkZW4udXNlci51\\nc2VyLnNlc3Npb24GOwBUewZJIhRsYXN0X3JlcXVlc3RfYXQGOwBUbCsHWeQv\\nYEkiFHJlZGlyZWN0X2RvbWF\r\npbgY7AEZJIht2cGVudGVzdC1kZXYudm9uYWhp\\nLmlvBjsAVEkiEF9jc3JmX3Rva2VuBjsARkkiMVB5TXhoeXFRRmpTZDZhNW5R\\nTVFDaURWelhKL0VzOXNYY2hqK2ZzcXJZcWM9BjsARg==\\n\"], [\"updated_at\", \"2021-02-19 16:16:26.179589\"], [\"id\", 4820716]]  \r\n```\r\n\r\nBut when I navigate to the Sidekiq Pro UI, I notice that the session data is a lot shorter:\r\n\r\n```\r\n  ActiveRecord::SessionStore::Session Update (2.0ms)  UPDATE \"sessions\" SET \"data\" = $1, \"updated_at\" = $2 WHERE \"sessions\".\"id\" = $3  [[\"data\", \"BAh7B0kiD3Nlc3Npb25faWQGOgZFVEkiRWFlNGJjNGRjZjU1NzFiNWMxNjAx\\nOTVmOTQwYTBiMWM1OTdkM2Q0N2U5ZTdkN2RmMTUyMDFhY2I0MTBkYTNkOGEG\\nOwBGSSIJY3NyZgY7AEZJIjFKR3NSMDYyejRnNlNoeWRGV0IzYmtrNG5pc09w\\ndEVKMW1WSTRZZVZSS2VBPQY7AEY=\\n\"], [\"updated_at\", \"2021-02-19 16:18:23.368663\"], [\"id\", 4820718]]\r\n```\r\n\r\nAny other tips that I can use to further investigate?","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4821/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4821/timeline","performed_via_github_app":null,"state_reason":"completed"}