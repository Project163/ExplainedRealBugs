{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3659","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3659/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3659/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3659/events","html_url":"https://github.com/sidekiq/sidekiq/issues/3659","id":272047512,"node_id":"MDU6SXNzdWUyNzIwNDc1MTI=","number":3659,"title":"`sidekiq_options_hash` class attribute sometimes undefined?","user":{"login":"PikachuEXE","id":1018543,"node_id":"MDQ6VXNlcjEwMTg1NDM=","avatar_url":"https://avatars.githubusercontent.com/u/1018543?v=4","gravatar_id":"","url":"https://api.github.com/users/PikachuEXE","html_url":"https://github.com/PikachuEXE","followers_url":"https://api.github.com/users/PikachuEXE/followers","following_url":"https://api.github.com/users/PikachuEXE/following{/other_user}","gists_url":"https://api.github.com/users/PikachuEXE/gists{/gist_id}","starred_url":"https://api.github.com/users/PikachuEXE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PikachuEXE/subscriptions","organizations_url":"https://api.github.com/users/PikachuEXE/orgs","repos_url":"https://api.github.com/users/PikachuEXE/repos","events_url":"https://api.github.com/users/PikachuEXE/events{/privacy}","received_events_url":"https://api.github.com/users/PikachuEXE/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-11-08T01:48:19Z","updated_at":"2017-11-08T07:44:44Z","closed_at":"2017-11-08T07:44:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This error happens sometimes (not always)\r\nThread related issue with class attribute?\r\n\r\nRuby version:\r\nSidekiq / Pro / Enterprise version(s):\r\nOpen source `5.0.5`\r\n\r\nPlease include your initializer and any error message with the full backtrace.\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"sidekiq\"\r\nrequire \"sidekiq-statistic\"\r\nrequire \"marginalia\"\r\n\r\n# Written like\r\n# https://github.com/mperham/sidekiq/blob/5-0/lib/sidekiq/middleware/server/active_record.rb\r\nclass SidekiqMarginaliaIntegeration\r\n  def call(worker, _msg, _queue)\r\n    Marginalia::Comment.update_job!(worker)\r\n    yield\r\n  ensure\r\n    Marginalia::Comment.clear_job!\r\n  end\r\nend\r\n\r\n# To config Redis server, please use REDIS_PROVIDER or REDIS_URL\r\n# https://github.com/mperham/sidekiq/wiki/Advanced-Options#setting-the-location-of-your-redis-server\r\n\r\n# Assign new concurrency from ENV if it equals to the default (25)\r\n# @see https://github.com/mperham/sidekiq/wiki/Advanced-Options\r\nDEFAULT_CONCURRENCY = 25\r\nis_default_concurrency = (Sidekiq.options[:concurrency] == DEFAULT_CONCURRENCY)\r\nsidekiq_concurrency_number = is_default_concurrency ? ENV![:SIDEKIQ_CONCURRENCY] : Sidekiq.options[:concurrency]\r\nSidekiq.options[:concurrency] = sidekiq_concurrency_number\r\n\r\nSidekiq.configure_server do |config|\r\n  config.redis = {\r\n    namespace: \"#{Rails.application.class.parent_name.underscore}:#{Rails.env.to_s.underscore}:sidekiq\",\r\n    size: sidekiq_concurrency_number + 1,\r\n    url: Rails.configuration.redis_url,\r\n  }\r\n\r\n  # Change DB pool size for ActiveRecord\r\n  # Replace with MongoDB or whatever\r\n  if defined?(ActiveRecord::Base)\r\n    # Note we use `ActiveRecord::Base.connection_pool`\r\n    # Not `ActiveRecord::Base.connection`\r\n    # Not sure why\r\n    ActiveRecord::Base.connection_pool.disconnect!\r\n    # Could be nil in 4.1\r\n    ar_config = ActiveRecord::Base.configurations[Rails.env] || {}\r\n    ar_config['reaping_frequency']   = ENV![:DATABASE_REAPING_FREQUENCY] # seconds\r\n    ar_config['pool']                = sidekiq_concurrency_number + 2 # Give it some buffer\r\n    ar_config['prepared_statements'] = ENV![:DATABASE_USE_PREPARED_STATEMENTS]\r\n    ActiveRecord::Base.establish_connection(ar_config)\r\n    Rails.logger.info('Connected to ActiveRecord in Sidekiq')\r\n  end\r\n\r\n  config.server_middleware do |chain|\r\n    chain.add(::SidekiqMarginaliaIntegeration)\r\n  end\r\nend\r\n\r\nSidekiq.configure_client do |config|\r\n  config.redis = {\r\n    namespace: \"#{Rails.application.class.parent_name.underscore}:#{Rails.env.to_s.underscore}:sidekiq\",\r\n    size: 1, # Client only needs one connection\r\n    url: Rails.configuration.redis_url,\r\n  }\r\nend\r\n\r\n# Sidekiq got a bug for this default option\r\n# Some gems are depending on the default queue value to override the queue name\r\n# So we don't set it here\r\n# Default queue name is `default` in `String`\r\nSidekiq.default_worker_options = { retry: false, backtrace: true }.stringify_keys\r\n\r\n# Required in 5.x\r\nSidekiq::Extensions.enable_delay!\r\n\r\n# Log to file and allow to be read by another gem\r\nsidekiq_logfile_path = \"log/sidekiq.log\"\r\nSidekiq.logger = ::ActiveSupport::Logger.new(STDOUT)\r\n\r\nlog_level = (\r\n[\r\n  (ENV![:LOG_LEVEL] ||\r\n    ::Rails.application.config.log_level).to_s.upcase,\r\n  \"INFO\",\r\n] & %w[DEBUG INFO WARN ERROR FATAL UNKNOWN]\r\n).compact.first\r\n\r\nif ENV![:LOGGLIER_DESTINATION_URL].present?\r\n  require \"logglier\"\r\n\r\n  loggly_logger = Logglier.new(\r\n    ENV![:LOGGLIER_DESTINATION_URL],\r\n    threaded: true,\r\n    format: :json,\r\n  )\r\n  loggly_logger.level = log_level\r\n  loggly_logger.formatter = Sidekiq::Logging::Pretty.new\r\n\r\n  Sidekiq.logger.extend(\r\n    ActiveSupport::Logger.broadcast(loggly_logger),\r\n  )\r\nend\r\n\r\nSidekiq.logger.level = log_level\r\nSidekiq.logger.formatter = Sidekiq::Logging::Pretty.new\r\n\r\nSidekiq::Statistic.configuration do |config|\r\n  config.log_file = sidekiq_logfile_path\r\n  config.last_log_lines = 10_000\r\n  config.max_timelist_length = 500_000\r\nend\r\n```\r\n\r\nStacktrace:\r\n![stacktrace](https://user-images.githubusercontent.com/1018543/32527640-0d23dc26-c46a-11e7-8eff-9f5fc4fd8cd8.png)\r\n\r\nEdit 1:\r\nForgot to add stacktrace\r\n","closed_by":{"login":"PikachuEXE","id":1018543,"node_id":"MDQ6VXNlcjEwMTg1NDM=","avatar_url":"https://avatars.githubusercontent.com/u/1018543?v=4","gravatar_id":"","url":"https://api.github.com/users/PikachuEXE","html_url":"https://github.com/PikachuEXE","followers_url":"https://api.github.com/users/PikachuEXE/followers","following_url":"https://api.github.com/users/PikachuEXE/following{/other_user}","gists_url":"https://api.github.com/users/PikachuEXE/gists{/gist_id}","starred_url":"https://api.github.com/users/PikachuEXE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PikachuEXE/subscriptions","organizations_url":"https://api.github.com/users/PikachuEXE/orgs","repos_url":"https://api.github.com/users/PikachuEXE/repos","events_url":"https://api.github.com/users/PikachuEXE/events{/privacy}","received_events_url":"https://api.github.com/users/PikachuEXE/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3659/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3659/timeline","performed_via_github_app":null,"state_reason":"completed"}