{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/840","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/840/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/840/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/840/events","html_url":"https://github.com/sidekiq/sidekiq/issues/840","id":13011425,"node_id":"MDU6SXNzdWUxMzAxMTQyNQ==","number":840,"title":"Workers aren't cleaned up from redis if we disconnect from redis while processing a job","user":{"login":"yoav-steinberg","id":1160578,"node_id":"MDQ6VXNlcjExNjA1Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1160578?v=4","gravatar_id":"","url":"https://api.github.com/users/yoav-steinberg","html_url":"https://github.com/yoav-steinberg","followers_url":"https://api.github.com/users/yoav-steinberg/followers","following_url":"https://api.github.com/users/yoav-steinberg/following{/other_user}","gists_url":"https://api.github.com/users/yoav-steinberg/gists{/gist_id}","starred_url":"https://api.github.com/users/yoav-steinberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yoav-steinberg/subscriptions","organizations_url":"https://api.github.com/users/yoav-steinberg/orgs","repos_url":"https://api.github.com/users/yoav-steinberg/repos","events_url":"https://api.github.com/users/yoav-steinberg/events{/privacy}","received_events_url":"https://api.github.com/users/yoav-steinberg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2013-04-10T09:54:52Z","updated_at":"2013-04-10T18:39:36Z","closed_at":"2013-04-10T16:03:47Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If our redis connection goes down while processing a job we get an exception in the `ensure` after the job is executed and the Processor thread dies. This block is responsible for deleting the the worker info from redis and updating the \"processed\" stats.\nSince this never happens we end up with a few bad thing (even after the redis connection is restored):\n- orphan \"worker:xxx\" keys and elements in the \"workers\" set inside redis.\n- incorrect \"stat:processed\" and \"stat:processed:xxx\" inside redis.\n- invalid indication of number of \"Busy\" jobs in the web interface. This this is a result of checking the size of the \"workers\" set, which wasn't cleaned.\n\nI think there should be some cleanup process to handle these cases once we reconnect to redis.\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/840/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/840/timeline","performed_via_github_app":null,"state_reason":"completed"}