{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6553","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6553/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6553/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6553/events","html_url":"https://github.com/sidekiq/sidekiq/issues/6553","id":2744562893,"node_id":"I_kwDOADDA9M6jlrTN","number":6553,"title":"Sidekiq::Periodic::Manager#inspect can consume GBs of memory","user":{"login":"jdelStrother","id":2377,"node_id":"MDQ6VXNlcjIzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/2377?v=4","gravatar_id":"","url":"https://api.github.com/users/jdelStrother","html_url":"https://github.com/jdelStrother","followers_url":"https://api.github.com/users/jdelStrother/followers","following_url":"https://api.github.com/users/jdelStrother/following{/other_user}","gists_url":"https://api.github.com/users/jdelStrother/gists{/gist_id}","starred_url":"https://api.github.com/users/jdelStrother/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdelStrother/subscriptions","organizations_url":"https://api.github.com/users/jdelStrother/orgs","repos_url":"https://api.github.com/users/jdelStrother/repos","events_url":"https://api.github.com/users/jdelStrother/events{/privacy}","received_events_url":"https://api.github.com/users/jdelStrother/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-12-17T10:38:20Z","updated_at":"2024-12-17T19:21:23Z","closed_at":"2024-12-17T19:21:22Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 3.2.4\r\nRails version: 7.2\r\nSidekiq / Pro / Enterprise version(s): 7.3.3\r\n\r\nI have sentry installed to catch errors. When an error occurs, sentry [ends up calling inspect](https://github.com/getsentry/sentry-ruby/blob/d21c5000d5d9e9fa5a8ba93403c2ed65a8173808/sentry-ruby/lib/sentry/interfaces/single_exception.rb#L51) on the job that failed.\r\n\r\nWhen this happened on our sidekiq leader process, I sometimes saw it consuming ever-increasing amounts of memory, eventually getting killed at around the 7GB mark. The job has a @_context ivar that, on the leader process, eventually leads to a large Containers::Heap structure which seems to get exponentially larger based on the number of registered cronjobs.\r\n\r\nI believe I've more-or-less reproduced the problem here:\r\n\r\n```ruby\r\n#!/usr/bin/env ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"sidekiq\"\r\nrequire \"sidekiq/cli\"\r\nrequire \"sidekiq-ent\"\r\nrequire \"sidekiq-ent/periodic\"\r\nrequire \"sidekiq-ent/periodic/config\"\r\nrequire \"sidekiq-ent/periodic/manager\"\r\nrequire \"sidekiq-ent/senate\"\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext\"\r\nrequire \"logger\"\r\n\r\ndef rss_size\r\n  pid = $$\r\n  [\"/proc/#{pid}/status\", \"/system/lxproc/#{pid}/status\"].each do |proc_path|\r\n    next unless File.exist?(proc_path)\r\n    if File.read(proc_path) =~ /VmRSS:\\s*(\\d+) kB/\r\n      return $1.to_i\r\n    end\r\n  end\r\n  IO.popen(%W[ps -o rss= -p #{pid}]) { _1.read.to_i }\r\nend\r\n\r\nclass SomeJob\r\n  include Sidekiq::Job\r\n  def perform(number)\r\n  end\r\nend\r\n\r\n# Potential fixes:\r\n# require \"sidekiq-ent/heap\"\r\n# class Containers::Heap\r\n#   def inspect\r\n#     \"<#{self.class.name} size=#{size}>\"\r\n#   end\r\n# end\r\n# class Sidekiq::Periodic::Manager\r\n#   def inspect\r\n#     \"#<#{self.class.name}>\"\r\n#   end\r\n# end\r\n\r\nconfig = Sidekiq.default_configuration\r\nconfig.logger = Logger.new($stdout).tap { _1.level = 1 }\r\nsenate = config.lookup(\"ent:senate\", Sidekiq::Senate)\r\nloop do\r\n  senate.stage_coup!\r\n  break if senate.leader?\r\n  puts \"trying to stage a coup...\"\r\n  sleep 1\r\nend\r\n\r\ncfg = config.lookup(\"ent:croncfg\", Sidekiq::Periodic::Config)\r\nNUMBER_OF_CRONJOBS = 40\r\nNUMBER_OF_CRONJOBS.times do |i|\r\n  cfg.register \"* * * * *\", \"SomeJob\", args: [i]\r\nend\r\n\r\n\r\nact = config.lookup(\"ent:periodic\", Sidekiq::Periodic::Manager)\r\nact.persist(cfg)\r\n\r\nputs \"RSS=#{rss_size}\"\r\nact.process(Time.now)\r\nact.process(Time.now + 1.minute)\r\nact.process(Time.now + 1.day)\r\n\r\nputs \"done! Inspecting....\"\r\nputs \"Inspection is #{config.inspect.length / 1024 / 1024}MB long\"\r\n# puts config.inspect\r\n\r\nputs \"RSS=#{rss_size}\"\r\n```\r\n\r\nThis script doesn't show the boundless memory growth we were seeing in production, I think maybe that's triggered by having 1 thread trying to inspect a job while another thread is running Sidekiq::Periodic::Manager#process. But you can increase NUMBER_OF_CRONJOBS to, say, 50 to see that the inspect-size seems to get exponentially worse.\r\n\r\n\r\nIt might be worth overriding `inspect` on Containers::Heap and/or Sidekiq::Periodic::Manager to avoid this. I've patched it locally in our own app for now.\r\n\r\n\r\n(Our own cronjobs aren't all \"* * * * *\", nor do they all use a single job class. But we do have 50-or-so of them, not sure if that's an unprecedented amount..?)","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6553/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6553/timeline","performed_via_github_app":null,"state_reason":"completed"}