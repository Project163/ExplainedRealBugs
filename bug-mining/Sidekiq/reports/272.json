{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5090","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5090/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5090/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5090/events","html_url":"https://github.com/sidekiq/sidekiq/issues/5090","id":1075583010,"node_id":"I_kwDOADDA9M5AHBgi","number":5090,"title":"`cattr` from CurrentAttributes are lost when retrying jobs","user":{"login":"baptistejub","id":18444083,"node_id":"MDQ6VXNlcjE4NDQ0MDgz","avatar_url":"https://avatars.githubusercontent.com/u/18444083?v=4","gravatar_id":"","url":"https://api.github.com/users/baptistejub","html_url":"https://github.com/baptistejub","followers_url":"https://api.github.com/users/baptistejub/followers","following_url":"https://api.github.com/users/baptistejub/following{/other_user}","gists_url":"https://api.github.com/users/baptistejub/gists{/gist_id}","starred_url":"https://api.github.com/users/baptistejub/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/baptistejub/subscriptions","organizations_url":"https://api.github.com/users/baptistejub/orgs","repos_url":"https://api.github.com/users/baptistejub/repos","events_url":"https://api.github.com/users/baptistejub/events{/privacy}","received_events_url":"https://api.github.com/users/baptistejub/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-12-09T13:37:31Z","updated_at":"2021-12-10T12:30:39Z","closed_at":"2021-12-09T21:15:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.7.5p203\r\nRails version: 6.1.4.1\r\nSidekiq / Pro / Enterprise version(s): sidekiq 6.3.1\r\n\r\nWhen a job having some current attributes fails and is put into the retry queue, we can see that, when retrying it, the current attributes (`cattr`) are missing from the retried job payload.\r\nI was expected to see the whole payload and thus the current attributes when retrying a job. Not sure if it's the desired behaviour.\r\n\r\nI think it's happening here:\r\nhttps://github.com/mperham/sidekiq/blob/main/lib/sidekiq/middleware/current_attributes.rb#L23\r\nwhen the server is pushing back the job from the retry queue to the processing queue, nothing sets the attributes of the Rails CurrentAttributes class (which is then empty) and so it overwrites the original `cattr` with an empty hash.\r\n\r\nNot sure if we should skip setting the `cattr` key here when already present or ensure that a retried job sets the CurrentAttributes before pushing back to the queue.\r\n\r\nSimple example :\r\ninitializer\r\n```ruby\r\nrequire 'sidekiq/web'\r\nrequire 'sidekiq/middleware/current_attributes'\r\n\r\nSidekiq::CurrentAttributes.persist(JobContext)\r\n```\r\n\r\nlib/my_job.rb\r\n```ruby\r\nclass MyJob\r\n  include Sidekiq::Job\r\n\r\n  sidekiq_options queue: \"critical\", retry: 1\r\n\r\n  def perform\r\n    puts \"Locale attribute: #{JobContext.locale}\"\r\n    raise 'oops'\r\n  end\r\nend\r\n```\r\n\r\n```\r\n2021-12-09T10:18:08.859Z pid=47468 tid=6h38 class=MyJob jid=f2227185b134bd4d063ba672 INFO: start\r\nLocale attribute: en\r\n2021-12-09T10:18:08.909Z pid=47468 tid=6h38 class=MyJob jid=f2227185b134bd4d063ba672 elapsed=0.05 INFO: fail\r\n2021-12-09T10:18:08.909Z pid=47468 tid=6h38 WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":1,\"queue\":\"critical\",\"class\":\"MyJob\",\"args\":[],\"jid\":\"f2227185b134bd4d063ba672\",\"created_at\":1639045088.83644,\"cattr\":{\"locale\":\"en\"},\"enqueued_at\":1639045088.853143},\"jobstr\":\"{\\\"retry\\\":1,\\\"queue\\\":\\\"critical\\\",\\\"class\\\":\\\"MyJob\\\",\\\"args\\\":[],\\\"jid\\\":\\\"f2227185b134bd4d063ba672\\\",\\\"created_at\\\":1639045088.83644,\\\"cattr\\\":{\\\"locale\\\":\\\"en\\\"},\\\"enqueued_at\\\":1639045088.853143}\"}\r\n2021-12-09T10:18:08.909Z pid=47468 tid=6h38 WARN: RuntimeError: oops\r\n2021-12-09T10:18:08.909Z pid=47468 tid=6h38 WARN: /my_project/lib/my_job.rb:8:in `perform'\r\n2021-12-09T10:18:26.990Z pid=47468 tid=6h8o class=MyJob jid=f2227185b134bd4d063ba672 INFO: start\r\nLocale attribute:\r\n2021-12-09T10:18:27.034Z pid=47468 tid=6h8o class=MyJob jid=f2227185b134bd4d063ba672 INFO: Adding dead MyJob job f2227185b134bd4d063ba672\r\n2021-12-09T10:18:27.038Z pid=47468 tid=6h8o class=MyJob jid=f2227185b134bd4d063ba672 elapsed=0.048 INFO: fail\r\n2021-12-09T10:18:27.038Z pid=47468 tid=6h8o WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":1,\"queue\":\"critical\",\"class\":\"MyJob\",\"args\":[],\"jid\":\"f2227185b134bd4d063ba672\",\"created_at\":1639045088.83644,\"cattr\":{},\"enqueued_at\":1639045106.987346,\"error_message\":\"oops\",\"error_class\":\"RuntimeError\",\"failed_at\":1639045088.904974,\"retry_count\":0},\"jobstr\":\"{\\\"retry\\\":1,\\\"queue\\\":\\\"critical\\\",\\\"class\\\":\\\"MyJob\\\",\\\"args\\\":[],\\\"jid\\\":\\\"f2227185b134bd4d063ba672\\\",\\\"created_at\\\":1639045088.83644,\\\"cattr\\\":{},\\\"enqueued_at\\\":1639045106.987346,\\\"error_message\\\":\\\"oops\\\",\\\"error_class\\\":\\\"RuntimeError\\\",\\\"failed_at\\\":1639045088.904974,\\\"retry_count\\\":0}\"}\r\n2021-12-09T10:18:27.038Z pid=47468 tid=6h8o WARN: RuntimeError: oops\r\n2021-12-09T10:18:27.038Z pid=47468 tid=6h8o WARN: /my_project/lib/my_job.rb:8:in `perform'\r\n```\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5090/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5090/timeline","performed_via_github_app":null,"state_reason":"completed"}