{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2336","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2336/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2336/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2336/events","html_url":"https://github.com/sidekiq/sidekiq/issues/2336","id":73921498,"node_id":"MDU6SXNzdWU3MzkyMTQ5OA==","number":2336,"title":"Fake testing & batches","user":{"login":"mikz","id":154571,"node_id":"MDQ6VXNlcjE1NDU3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/154571?v=4","gravatar_id":"","url":"https://api.github.com/users/mikz","html_url":"https://github.com/mikz","followers_url":"https://api.github.com/users/mikz/followers","following_url":"https://api.github.com/users/mikz/following{/other_user}","gists_url":"https://api.github.com/users/mikz/gists{/gist_id}","starred_url":"https://api.github.com/users/mikz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikz/subscriptions","organizations_url":"https://api.github.com/users/mikz/orgs","repos_url":"https://api.github.com/users/mikz/repos","events_url":"https://api.github.com/users/mikz/events{/privacy}","received_events_url":"https://api.github.com/users/mikz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-05-07T09:47:41Z","updated_at":"2015-05-13T12:35:45Z","closed_at":"2015-05-13T12:35:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Given following code:\n\n``` ruby\nrequire 'sidekiq-pro'\nrequire 'sidekiq/testing'\n\nclass Worker\n  include Sidekiq::Worker\n\n  def self.enqueue\n    batch = Sidekiq::Batch.new\n    batch.description = 'test batch'\n\n    batch.jobs do\n      perform_async self\n    end\n  end\n\n\n  def perform(*)\n    batch.jobs do\n      raise 'expected error'\n    end\n  end\nend\n\nWorker.enqueue\nWorker.perform_one\n```\n\nRaising 'expected error' is expected, but `NoMethodError: undefined method 'jobs' for nil:NilClass` is raised instead.\n\nWhy? Looks like `Sidekiq::Testing.fake!` [does set just `jid` of the job, not `bid`](https://github.com/mperham/sidekiq/blob/19ef4722e19c29bd14ee714045fabdcaf10ed6f9/lib/sidekiq/testing.rb#L164).\n\nSuggested solution: initialize both `jid`  and `bid` if available. I know batches testing is not exactly supported, but this breaks it hard.\n\nOr do you have some suggestion how to implement it differently so it is testable ?\nInside the job, I'd like to enqueue more jobs to the batch.\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2336/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2336/timeline","performed_via_github_app":null,"state_reason":"completed"}