{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2887","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2887/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2887/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2887/events","html_url":"https://github.com/sidekiq/sidekiq/issues/2887","id":141222302,"node_id":"MDU6SXNzdWUxNDEyMjIzMDI=","number":2887,"title":"NoMethodError: undefined method `[]' for false:FalseClass","user":{"login":"NielsKSchjoedt","id":570755,"node_id":"MDQ6VXNlcjU3MDc1NQ==","avatar_url":"https://avatars.githubusercontent.com/u/570755?v=4","gravatar_id":"","url":"https://api.github.com/users/NielsKSchjoedt","html_url":"https://github.com/NielsKSchjoedt","followers_url":"https://api.github.com/users/NielsKSchjoedt/followers","following_url":"https://api.github.com/users/NielsKSchjoedt/following{/other_user}","gists_url":"https://api.github.com/users/NielsKSchjoedt/gists{/gist_id}","starred_url":"https://api.github.com/users/NielsKSchjoedt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NielsKSchjoedt/subscriptions","organizations_url":"https://api.github.com/users/NielsKSchjoedt/orgs","repos_url":"https://api.github.com/users/NielsKSchjoedt/repos","events_url":"https://api.github.com/users/NielsKSchjoedt/events{/privacy}","received_events_url":"https://api.github.com/users/NielsKSchjoedt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-03-16T09:54:10Z","updated_at":"2016-03-16T21:02:06Z","closed_at":"2016-03-16T16:26:17Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"After the last update of sidekiq, where I also started using the unique jobs feature (I'm running sidekiq-ent) I started to see the following errors from time to time. I have no clue what it is:\n\n```\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:179:in `atomic_push'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:172:in `block (2 levels) in raw_push'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/redis-3.2.2/lib/redis.rb:2244:in `block in multi'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/redis-3.2.2/lib/redis.rb:57:in `block in synchronize'\n/home/dep_user/.rbenv/versions/2.3.0/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/redis-3.2.2/lib/redis.rb:57:in `synchronize'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/redis-3.2.2/lib/redis.rb:2237:in `multi'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:171:in `block in raw_push'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/connection_pool-2.2.0/lib/connection_pool.rb:64:in `block (2 levels) in with'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/connection_pool-2.2.0/lib/connection_pool.rb:63:in `handle_interrupt'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/connection_pool-2.2.0/lib/connection_pool.rb:63:in `block in with'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/connection_pool-2.2.0/lib/connection_pool.rb:60:in `handle_interrupt'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/connection_pool-2.2.0/lib/connection_pool.rb:60:in `with'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:170:in `raw_push'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-pro-3.0.5/lib/sidekiq/batch/client.rb:36:in `raw_push_with_batch'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:91:in `push_bulk'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:123:in `push_bulk'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/ac_policy.rb:202:in `push_jobs'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/ac_policy.rb:139:in `block in enqueue_scraper_jobs'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/ac_policy.rb:138:in `each'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/ac_policy.rb:138:in `enqueue_scraper_jobs'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/ac_policy.rb:127:in `enqueue_jobs!'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/ac_policy.rb:38:in `handle!'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/indexing_templates/collectors/bc.rb:73:in `handle_advert_candidates!'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/indexing_templates/collectors/bc.rb:33:in `handle_current_advert_candidate_slice'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/indexing_templates/collectors/mc/bmc.rb:38:in `block in run_it!'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/indexing_templates/collectors/mc/bmc.rb:33:in `loop'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/indexing_templates/collectors/mc/bmc.rb:33:in `run_it!'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/worker_jobs/ac_collector_job.rb:62:in `run_collector!'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/bundler/gems/dc-d41b8538e33e/lib/dc/worker_jobs/ac_collector_job.rb:36:in `perform'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:150:in `execute_job'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:132:in `block (2 levels) in process'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:127:in `block in invoke'\n/home/dep_user/au/releases/20160315155502/config/initializers/sidekiq.rb:75:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/releases/20160315155502/config/initializers/sidekiq.rb:39:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/honeybadger-2.0.12/lib/honeybadger/plugins/sidekiq.rb:11:in `block in call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/honeybadger-2.0.12/lib/honeybadger/trace.rb:62:in `instrument'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/honeybadger-2.0.12/lib/honeybadger/trace.rb:18:in `instrument'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/honeybadger-2.0.12/lib/honeybadger/plugins/sidekiq.rb:10:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/newrelic_rpm-3.15.0.314/lib/new_relic/agent/instrumentation/sidekiq.rb:33:in `block in call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/newrelic_rpm-3.15.0.314/lib/new_relic/agent/instrumentation/controller_instrumentation.rb:362:in `perform_action_with_newrelic_trace'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/newrelic_rpm-3.15.0.314/lib/new_relic/agent/instrumentation/sidekiq.rb:29:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-pro-3.0.5/lib/sidekiq/batch/middleware.rb:33:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-ent-1.2.0/lib/sidekiq-ent/unique.rb:103:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-ent-1.2.0/lib/sidekiq-ent/limiter/middleware.rb:38:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/server/active_record.rb:6:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/server/retry_jobs.rb:74:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/server/logging.rb:11:in `block in call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/logging.rb:30:in `with_context'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/server/logging.rb:7:in `call'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:129:in `block in invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/middleware/chain.rb:132:in `invoke'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:127:in `block in process'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:166:in `stats'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:126:in `process'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:79:in `process_one'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/processor.rb:67:in `run'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/util.rb:16:in `watchdog'\n/home/dep_user/au/shared/bundle/ruby/2.3.0/gems/sidekiq-4.1.0/lib/sidekiq/util.rb:24:in `block in safe_thread'\n```\n\nSimilar errors are also raised from: \n\n```\n/gems/sidekiq-4.1.0/lib/sidekiq/client.rb:188 :in `block in atomic_push`\n```\n\nVersions:\nsidekiq (4.1.0)\nsidekiq-ent (1.2.0)\nsidekiq-pro (3.0.5)\n\nMy middleware setup looks like this:\n\n``` ruby\nmodule CountryBased\n  module Sidekiq\n    module Middleware\n\n      class Client\n        def call(_worker_class, item, _queue, _redis_pool=nil)\n          set_country(item)\n          yield\n        end\n\n        private\n\n        def set_country item\n          item[\"au_country\"] ||= CountryManager.country.to_s\n          # Used for sidekiq unique jobs extension\n          item[\"args\"] << \"au_country_#{item['au_country']}\" unless item[\"args\"].last == \"au_country_#{item['au_country']}\"\n        end\n      end\n\n      class Server\n        def call(_worker_class, item, queue)\n          read_country(item)\n\n          if is_localized_queue?(queue)\n            I18n.locale = CountryManager.default_locale_for_current_country\n          else\n            I18n.locale = CountryManager.default_locale\n          end\n\n          yield\n\n        ensure\n          RequestStore.clear!\n        end\n\n        private\n\n        def read_country item\n          CountryManager.country = item['au_country'].to_sym\n          item[\"args\"].delete(\"au_country_#{item['au_country']}\") # Remove before actually calling #perform with arguments\n        end\n\n        def is_localized_queue? queue\n          ['critical_jobs', 'mailer_jobs'].include?(queue)\n        end\n      end\n\n    end\n  end\nend\n\n\nmodule MemoryManagement\n  module Sidekiq\n    module Middleware\n      class Server\n        def call(_worker_class, _item, _queue)\n          verify_memory_below_limit!\n          yield\n        end\n\n        def verify_memory_below_limit!\n          current_memory = NewRelic::Agent::Samplers::MemorySampler.new.sampler.get_sample\n          return :all_ok if current_memory < 3000.0 #MB\n\n          Rails.logger.warn \"Killing sidekiq process with #{Process.pid}. \" \\\n            \"Current memory size: #{current_memory} MB\"\n          Process.kill(\"TERM\", Process.pid)\n        end\n      end\n    end\n  end\nend\n\nSidekiq::Logging.logger.level = Logger::WARN if Rails.env.production?\n\nSidekiq.configure_client do |config|\n  config.redis = {:url => Rails.application.secrets.redis_sidekiq_url}\n  config.client_middleware{|chain| chain.add CountryBased::Sidekiq::Middleware::Client}\nend\n\nSidekiq.configure_server do |config|\n  config.redis = {:url => Rails.application.secrets.redis_sidekiq_url}\n\n  config.client_middleware{|chain| chain.add CountryBased::Sidekiq::Middleware::Client}\n  config.server_middleware{|chain| chain.add CountryBased::Sidekiq::Middleware::Server}\n\n  config.server_middleware{|chain| chain.add MemoryManagement::Sidekiq::Middleware::Server}\nend\n\nSidekiq::Limiter.configure do |config|\n  config.redis = {url: Rails.application.secrets.redis_ratelimit_url }\nend\n\n# Disable uniqueness in testing, this has the potential to cause much head scratching...\nSidekiq::Enterprise.unique! unless Rails.env.test?\n\n```\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2887/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2887/timeline","performed_via_github_app":null,"state_reason":"completed"}