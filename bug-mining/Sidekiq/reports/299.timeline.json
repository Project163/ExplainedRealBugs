[{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361663237","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1361663237","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1361663237,"node_id":"IC_kwDOADDA9M5RKVUF","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T16:51:31Z","updated_at":"2022-12-21T16:51:31Z","body":"Please supply the full backtrace of the error.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361663237/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361668970","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1361668970","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1361668970,"node_id":"IC_kwDOADDA9M5RKWtq","user":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T16:56:53Z","updated_at":"2022-12-21T16:56:53Z","body":"Sure. Here's the backtrace:\r\n\r\n```\r\nConnectionPool::TimeoutError: Waited 1 sec, 0/5 available\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool/timed_stack.rb:77:in `block (2 levels) in pop'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool/timed_stack.rb:69:in `loop'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool/timed_stack.rb:69:in `block in pop'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool/timed_stack.rb:68:in `synchronize'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool/timed_stack.rb:68:in `pop'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool.rb:80:in `checkout'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool.rb:62:in `block in with'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool.rb:61:in `handle_interrupt'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/connection_pool-2.3.0/lib/connection_pool.rb:61:in `with'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.0.2/lib/sidekiq/client.rb:211:in `raw_push'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.0.5/lib/sidekiq/batch/client.rb:40:in `raw_push'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-pro-7.0.5/lib/sidekiq/pro/push.rb:41:in `raw_push'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.0.2/lib/sidekiq/client.rb:92:in `push'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.0.2/lib/sidekiq/job.rb:365:in `client_push'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.0.2/lib/sidekiq/job.rb:198:in `perform_async'\r\n  /app/vendor/bundle/ruby/3.1.0/gems/sidekiq-7.0.2/lib/sidekiq/job.rb:290:in `perform_async'\r\n  /app/app/controllers/api/v1/data_controller.rb:261:in `send_data_async'\r\n  /app/app/controllers/api/v1/data_controller.rb:16:in `send_data'\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361668970/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361860658","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1361860658","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1361860658,"node_id":"IC_kwDOADDA9M5RLFgy","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T18:39:39Z","updated_at":"2022-12-21T18:39:39Z","body":"Sidekiq logs when it actually instantiates a connection pool:\r\n\r\n```ruby\r\nlogger&.info { \"Sidekiq #{Sidekiq::VERSION} connecting to Redis with options #{scrub(symbolized_options)}\" }\r\n```\r\n\r\nAdd a `puts` right before `config.redis = {` in your configure_client block and see if the connection pool is being created **before** that block runs (i.e. the log comes before the puts).","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361860658/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361865768","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1361865768","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1361865768,"node_id":"IC_kwDOADDA9M5RLGwo","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T18:41:43Z","updated_at":"2022-12-21T18:41:43Z","body":"The connection pool is timing out after 1 sec. It shouldn't take more than a few ms to push a job to Redis unless you have something very unusual going on. You need to get backtraces from all threads in the process to determine why 5 threads are actively holding a Redis connection.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1361865768/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362034655","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362034655","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362034655,"node_id":"IC_kwDOADDA9M5RLv_f","user":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T20:08:21Z","updated_at":"2022-12-21T20:08:21Z","body":"Added a log and can confirm the connection pool is being created after the block runs.\r\n\r\n```\r\nweb  | [WARN] Sidekiq client config initialized\r\nweb  | 2022-12-21T19:48:53.132Z pid=30 tid=2cxe INFO: Sidekiq 7.0.2 connecting to Redis with options {:host=>\"redis\", :password=>\"REDACTED\", :size=>5, :pool_name=>\"internal\", :url=>nil}\r\n```\r\n\r\nI should have stressed how sporadic this has been happening as well. There were 4 occurrences in the last 3 days.\r\nWe run with 40 threads on the puma processes and deal with significant traffic from webhooks.\r\nWe'll keep looking into it to try and figure out if there may be additional factors at play here such as latency.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362034655/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362062737","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362062737","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362062737,"node_id":"IC_kwDOADDA9M5RL22R","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T20:34:06Z","updated_at":"2022-12-21T20:34:06Z","body":"And if you change to size: 10, the log still says 5?","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362062737/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362068225","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362068225","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362068225,"node_id":"IC_kwDOADDA9M5RL4MB","user":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T20:40:06Z","updated_at":"2022-12-21T20:41:07Z","body":"> And if you change to size: 10, the log still says 5?\r\n\r\nYes. I never changed it back it. It still has `size: 10` set.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362068225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362072411","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362072411","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362072411,"node_id":"IC_kwDOADDA9M5RL5Nb","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T20:45:35Z","updated_at":"2022-12-21T20:45:35Z","body":"Please post your entire initializer.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362072411/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362084034","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362084034","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362084034,"node_id":"IC_kwDOADDA9M5RL8DC","user":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T20:59:32Z","updated_at":"2022-12-21T20:59:32Z","body":"```ruby\r\nSidekiq::Client.reliable_push! unless Rails.env.test?\r\nSidekiq::Enterprise.unique! unless Rails.env.test?\r\nSidekiq.strict_args!\r\n\r\nSidekiq.configure_client do |config|\r\n  config.redis = {\r\n    host: ENV.fetch(\"REDIS_HOST\"),\r\n    password: ENV.fetch(\"REDIS_PASSWORD\"),\r\n    size: 10\r\n  }\r\nend\r\n\r\nSidekiq.configure_server do |config|\r\n  config.redis = {host: ENV.fetch(\"REDIS_HOST\"), password: ENV.fetch(\"REDIS_PASSWORD\")}\r\n  config.logger.formatter = Sidekiq::Logger::Formatters::Base.new\r\n  config.super_fetch!\r\n  config.reliable_scheduler!\r\nend\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362084034/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362088980","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362088980","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362088980,"node_id":"IC_kwDOADDA9M5RL9QU","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T21:04:46Z","updated_at":"2022-12-21T21:04:46Z","body":"Move the first three lines to the bottom.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362088980/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362095989","html_url":"https://github.com/sidekiq/sidekiq/issues/5702#issuecomment-1362095989","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5702","id":1362095989,"node_id":"IC_kwDOADDA9M5RL-91","user":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-21T21:14:32Z","updated_at":"2022-12-21T21:15:55Z","body":"For the sake of completeness I also added back the log line. Here's the full initializer after the update:\r\n\r\n```ruby\r\nSidekiq.configure_client do |config|\r\n  Rails.logger.warn(\"Sidekiq client config initialized\")\r\n\r\n  config.redis = {\r\n    host: ENV.fetch(\"REDIS_HOST\"),\r\n    password: ENV.fetch(\"REDIS_PASSWORD\"),\r\n    size: 10\r\n  }\r\nend\r\n\r\nSidekiq.configure_server do |config|\r\n  config.redis = {host: ENV.fetch(\"REDIS_HOST\"), password: ENV.fetch(\"REDIS_PASSWORD\")}\r\n  config.logger.formatter = Sidekiq::Logger::Formatters::Base.new\r\n  config.super_fetch!\r\n  config.reliable_scheduler!\r\nend\r\n\r\nSidekiq::Client.reliable_push! unless Rails.env.test?\r\nSidekiq::Enterprise.unique! unless Rails.env.test?\r\nSidekiq.strict_args!\r\n```\r\n\r\nAnd the resulting log:\r\n```\r\nweb  | [WARN] Sidekiq client config initialized\r\nweb  | 2022-12-21T21:12:17.238Z pid=31 tid=2cxf INFO: Sidekiq 7.0.2 connecting to Redis with options {:host=>\"redis\", :password=>\"REDACTED\", :size=>5, :pool_name=>\"internal\", :url=>nil}\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1362095989/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"andreccosta","id":1365853,"node_id":"MDQ6VXNlcjEzNjU4NTM=","avatar_url":"https://avatars.githubusercontent.com/u/1365853?v=4","gravatar_id":"","url":"https://api.github.com/users/andreccosta","html_url":"https://github.com/andreccosta","followers_url":"https://api.github.com/users/andreccosta/followers","following_url":"https://api.github.com/users/andreccosta/following{/other_user}","gists_url":"https://api.github.com/users/andreccosta/gists{/gist_id}","starred_url":"https://api.github.com/users/andreccosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreccosta/subscriptions","organizations_url":"https://api.github.com/users/andreccosta/orgs","repos_url":"https://api.github.com/users/andreccosta/repos","events_url":"https://api.github.com/users/andreccosta/events{/privacy}","received_events_url":"https://api.github.com/users/andreccosta/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8091054521,"node_id":"CE_lADOADDA9M5ZxhgUzwAAAAHiQ7G5","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/8091054521","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"0c1e466fdb995b67ab14ae08aa23e02a55f28593","commit_url":"https://api.github.com/repos/sidekiq/sidekiq/commits/0c1e466fdb995b67ab14ae08aa23e02a55f28593","created_at":"2022-12-21T22:45:53Z","state_reason":null,"performed_via_github_app":null},{"actor":{"login":"sos4nt","id":28232,"node_id":"MDQ6VXNlcjI4MjMy","avatar_url":"https://avatars.githubusercontent.com/u/28232?v=4","gravatar_id":"","url":"https://api.github.com/users/sos4nt","html_url":"https://github.com/sos4nt","followers_url":"https://api.github.com/users/sos4nt/followers","following_url":"https://api.github.com/users/sos4nt/following{/other_user}","gists_url":"https://api.github.com/users/sos4nt/gists{/gist_id}","starred_url":"https://api.github.com/users/sos4nt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sos4nt/subscriptions","organizations_url":"https://api.github.com/users/sos4nt/orgs","repos_url":"https://api.github.com/users/sos4nt/repos","events_url":"https://api.github.com/users/sos4nt/events{/privacy}","received_events_url":"https://api.github.com/users/sos4nt/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-01-27T15:22:46Z","updated_at":"2023-01-27T15:22:46Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5752","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5752/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5752/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5752/events","html_url":"https://github.com/sidekiq/sidekiq/issues/5752","id":1559929418,"node_id":"I_kwDOADDA9M5c-qJK","number":5752,"title":"ConnectionPool::TimeoutError when using limiter inside capsule (with fix suggestion)","user":{"login":"sos4nt","id":28232,"node_id":"MDQ6VXNlcjI4MjMy","avatar_url":"https://avatars.githubusercontent.com/u/28232?v=4","gravatar_id":"","url":"https://api.github.com/users/sos4nt","html_url":"https://github.com/sos4nt","followers_url":"https://api.github.com/users/sos4nt/followers","following_url":"https://api.github.com/users/sos4nt/following{/other_user}","gists_url":"https://api.github.com/users/sos4nt/gists{/gist_id}","starred_url":"https://api.github.com/users/sos4nt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sos4nt/subscriptions","organizations_url":"https://api.github.com/users/sos4nt/orgs","repos_url":"https://api.github.com/users/sos4nt/repos","events_url":"https://api.github.com/users/sos4nt/events{/privacy}","received_events_url":"https://api.github.com/users/sos4nt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-01-27T15:13:52Z","updated_at":"2023-01-27T15:42:26Z","closed_at":"2023-01-27T15:42:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":3195124,"node_id":"MDEwOlJlcG9zaXRvcnkzMTk1MTI0","name":"sidekiq","full_name":"sidekiq/sidekiq","private":false,"owner":{"login":"sidekiq","id":124714131,"node_id":"O_kgDOB278kw","avatar_url":"https://avatars.githubusercontent.com/u/124714131?v=4","gravatar_id":"","url":"https://api.github.com/users/sidekiq","html_url":"https://github.com/sidekiq","followers_url":"https://api.github.com/users/sidekiq/followers","following_url":"https://api.github.com/users/sidekiq/following{/other_user}","gists_url":"https://api.github.com/users/sidekiq/gists{/gist_id}","starred_url":"https://api.github.com/users/sidekiq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sidekiq/subscriptions","organizations_url":"https://api.github.com/users/sidekiq/orgs","repos_url":"https://api.github.com/users/sidekiq/repos","events_url":"https://api.github.com/users/sidekiq/events{/privacy}","received_events_url":"https://api.github.com/users/sidekiq/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sidekiq/sidekiq","description":"Simple, efficient background processing for Ruby","fork":false,"url":"https://api.github.com/repos/sidekiq/sidekiq","forks_url":"https://api.github.com/repos/sidekiq/sidekiq/forks","keys_url":"https://api.github.com/repos/sidekiq/sidekiq/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sidekiq/sidekiq/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sidekiq/sidekiq/teams","hooks_url":"https://api.github.com/repos/sidekiq/sidekiq/hooks","issue_events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events{/number}","events_url":"https://api.github.com/repos/sidekiq/sidekiq/events","assignees_url":"https://api.github.com/repos/sidekiq/sidekiq/assignees{/user}","branches_url":"https://api.github.com/repos/sidekiq/sidekiq/branches{/branch}","tags_url":"https://api.github.com/repos/sidekiq/sidekiq/tags","blobs_url":"https://api.github.com/repos/sidekiq/sidekiq/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sidekiq/sidekiq/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sidekiq/sidekiq/git/refs{/sha}","trees_url":"https://api.github.com/repos/sidekiq/sidekiq/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sidekiq/sidekiq/statuses/{sha}","languages_url":"https://api.github.com/repos/sidekiq/sidekiq/languages","stargazers_url":"https://api.github.com/repos/sidekiq/sidekiq/stargazers","contributors_url":"https://api.github.com/repos/sidekiq/sidekiq/contributors","subscribers_url":"https://api.github.com/repos/sidekiq/sidekiq/subscribers","subscription_url":"https://api.github.com/repos/sidekiq/sidekiq/subscription","commits_url":"https://api.github.com/repos/sidekiq/sidekiq/commits{/sha}","git_commits_url":"https://api.github.com/repos/sidekiq/sidekiq/git/commits{/sha}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/comments{/number}","issue_comment_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments{/number}","contents_url":"https://api.github.com/repos/sidekiq/sidekiq/contents/{+path}","compare_url":"https://api.github.com/repos/sidekiq/sidekiq/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sidekiq/sidekiq/merges","archive_url":"https://api.github.com/repos/sidekiq/sidekiq/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sidekiq/sidekiq/downloads","issues_url":"https://api.github.com/repos/sidekiq/sidekiq/issues{/number}","pulls_url":"https://api.github.com/repos/sidekiq/sidekiq/pulls{/number}","milestones_url":"https://api.github.com/repos/sidekiq/sidekiq/milestones{/number}","notifications_url":"https://api.github.com/repos/sidekiq/sidekiq/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/labels{/name}","releases_url":"https://api.github.com/repos/sidekiq/sidekiq/releases{/id}","deployments_url":"https://api.github.com/repos/sidekiq/sidekiq/deployments","created_at":"2012-01-16T23:17:27Z","updated_at":"2025-11-09T20:20:41Z","pushed_at":"2025-11-07T17:29:44Z","git_url":"git://github.com/sidekiq/sidekiq.git","ssh_url":"git@github.com:sidekiq/sidekiq.git","clone_url":"https://github.com/sidekiq/sidekiq.git","svn_url":"https://github.com/sidekiq/sidekiq","homepage":"https://sidekiq.org","size":14680,"stargazers_count":13447,"watchers_count":13447,"language":"Ruby","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":true,"forks_count":2471,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":40,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["background-jobs","jobs","ruby","sidekiq"],"visibility":"public","forks":2471,"open_issues":40,"watchers":13447,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Ruby version: 3.0.4\r\nRails version: n/a\r\nSidekiq / Pro / **Enterprise** version(s): 7.0.3\r\n\r\nPossibly related to #5702, #5685, and #5684.\r\n\r\nWe recently upgraded to Sidekiq 7 and encountered `ConnectionPool::TimeoutError` exceptions in our workers after setting up a single-threaded [capsule](https://github.com/mperham/sidekiq/blob/main/docs/capsule.md) along with Sidekiq's [rate limiting](https://github.com/mperham/sidekiq/wiki/Ent-Rate-Limiting). For now, we've reverted our changes to not using capsules, but I really wanted to get this working.\r\n\r\nTracking down the cause wasn't easy because the errors occurred sporadically and didn't seem to follow a pattern. However, after a lot of digging in the depth of Sidekiq's codebase, I finally managed to create a small setup to reproduce the exception: (for simplicity without Rails)\r\n\r\n```ruby\r\n# sidekiq.rb\r\n\r\nrequire 'sidekiq-ent'\r\n\r\nSidekiq.configure_server do |config|\r\n  config.capsule('single-threaded') do |cap|\r\n    cap.concurrency = 1\r\n    cap.queues = %w[single]\r\n  end\r\nend\r\n\r\nLIMITER = Sidekiq::Limiter.concurrent('limiter', 30)\r\n\r\nclass WorkerA\r\n  include Sidekiq::Job\r\n  sidekiq_options queue: :default, retry: false, backtrace: true\r\n\r\n  def perform(value)\r\n    LIMITER.within_limit { puts(value) }\r\n  end\r\nend\r\n\r\nclass WorkerB\r\n  include Sidekiq::Job\r\n  sidekiq_options queue: :single, retry: false, backtrace: true\r\n\r\n  def perform(value)\r\n    LIMITER.within_limit { puts(value) }\r\n  end\r\nend\r\n```\r\n\r\nI'm starting Sidekiq with `sidekiq -r ./sidekiq.rb`. Inside IRB, I can now schedule `WorkerB` which runs in the \"single\" capsule and then `WorkerA` which runs in the \"default\" capsule: (the order of execution is important)\r\n\r\n```\r\n$ irb -r ./sidekiq.rb\r\nirb(main):001:0> WorkerB.perform_async('hello from worker b')\r\n=> \"c5360245000d1e1df50e9f79\"\r\nirb(main):002:0> WorkerA.perform_async('hello from worker a')\r\n=> \"2bf003b6f8214c6dffb90ff5\"\r\n```\r\n\r\nThe Sidekiq process / log shows that WorkerB runs fine but WorkerA is causing the aforementioned exception\r\n\r\n```\r\n2023-01-27T14:14:47.981Z pid=14758 tid=9rm class=WorkerB jid=c5360245000d1e1df50e9f79 INFO: start\r\nhello from worker b\r\n2023-01-27T14:14:47.983Z pid=14758 tid=9rm class=WorkerB jid=c5360245000d1e1df50e9f79 elapsed=0.002 INFO: done\r\n\r\n2023-01-27T14:15:21.275Z pid=14758 tid=9qy class=WorkerA jid=2bf003b6f8214c6dffb90ff5 elapsed=1.005 INFO: fail\r\n2023-01-27T14:15:21.275Z pid=14758 tid=9qy WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":false,\"queue\":\"default\",\"backtrace\":true,\"args\":[\"hello from worker a\"],\"class\":\"WorkerA\",\"jid\":\"2bf003b6f8214c6dffb90ff5\",\"created_at\":1674828920.269701,\"enqueued_at\":1674828920.269772},\"_config\":\"#<Sidekiq::Config:0x00007fa7a49ded08>\"}\r\n2023-01-27T14:15:21.275Z pid=14758 tid=9qy WARN: ConnectionPool::TimeoutError: Waited 1 sec, 0/1 available\r\n```\r\n\r\nAlong with a long stack trace pointing to `sidekiq-ent/limiter/concurrent.rb`.\r\n\r\nI could also get this exception when running WorkerA before WorkerB but not as consistent (maybe a timing issue with the connection pool). In this case, WorkerB will fail and the error message is \"Waited 1 sec, 0/5 available\".\r\n\r\n---\r\n\r\nI further tried to debug the problem and found that the `redis_pool` inside the `Sidekiq::Limiter::Concurrent` class was set to a `size` of 1 for both workers. Finally, I found the `redis_pool` method in `Sidekiq::Limiter` which looks like this:\r\n\r\n```ruby\r\n# sidekiq-ent-7.0.3/lib/sidekiq-ent/limiter.rb\r\n\r\nmodule Sidekiq\r\n  module Limiter\r\n    # ...\r\n    def self.redis_pool\r\n      @redis ||= Sidekiq.redis_pool\r\n    end\r\n    # ...\r\n  end\r\nend\r\n```\r\n\r\nIf I understand the code correctly, this will memoize the redis pool from `Thread.current[:sidekiq_capsule]` which is the first capsule being used. When removing the `@redis ||=` part, the above example works fine, i.e.\r\n\r\n```ruby\r\n    def self.redis_pool\r\n      Sidekiq.redis_pool\r\n    end\r\n```\r\n\r\nWith this change applied, the `redis_pool.size` inside `Sidekiq::Limiter::Concurrent` changed from 1 to 5 and back depending on the worker / queue (as it should?) an no exception occurred anymore.\r\n\r\nAlthough this fix \"works\", I'm not sure if this is the correct way to solve the issue. Besides, I didn't really understand why running a worker inside a wrong capsule / config would immediately cause a `ConnectionPool::TimeoutError` in the first place. Is the connection pool size synchronized with the number of Sidekiq threads? (maybe you can shed some light on the way connection pools are used in Sidekiq, just out of interest)\r\n\r\nI hope you can fix this problem soon with the given information.","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5752/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5752/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"krasnoukhov","id":944286,"node_id":"MDQ6VXNlcjk0NDI4Ng==","avatar_url":"https://avatars.githubusercontent.com/u/944286?v=4","gravatar_id":"","url":"https://api.github.com/users/krasnoukhov","html_url":"https://github.com/krasnoukhov","followers_url":"https://api.github.com/users/krasnoukhov/followers","following_url":"https://api.github.com/users/krasnoukhov/following{/other_user}","gists_url":"https://api.github.com/users/krasnoukhov/gists{/gist_id}","starred_url":"https://api.github.com/users/krasnoukhov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krasnoukhov/subscriptions","organizations_url":"https://api.github.com/users/krasnoukhov/orgs","repos_url":"https://api.github.com/users/krasnoukhov/repos","events_url":"https://api.github.com/users/krasnoukhov/events{/privacy}","received_events_url":"https://api.github.com/users/krasnoukhov/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-04-20T12:19:58Z","updated_at":"2023-04-20T12:19:58Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5886","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5886/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5886/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5886/events","html_url":"https://github.com/sidekiq/sidekiq/issues/5886","id":1676611783,"node_id":"I_kwDOADDA9M5j7xDH","number":5886,"title":"RAILS_MAX_THREADS does not affect client redis pool configuration","user":{"login":"krasnoukhov","id":944286,"node_id":"MDQ6VXNlcjk0NDI4Ng==","avatar_url":"https://avatars.githubusercontent.com/u/944286?v=4","gravatar_id":"","url":"https://api.github.com/users/krasnoukhov","html_url":"https://github.com/krasnoukhov","followers_url":"https://api.github.com/users/krasnoukhov/followers","following_url":"https://api.github.com/users/krasnoukhov/following{/other_user}","gists_url":"https://api.github.com/users/krasnoukhov/gists{/gist_id}","starred_url":"https://api.github.com/users/krasnoukhov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krasnoukhov/subscriptions","organizations_url":"https://api.github.com/users/krasnoukhov/orgs","repos_url":"https://api.github.com/users/krasnoukhov/repos","events_url":"https://api.github.com/users/krasnoukhov/events{/privacy}","received_events_url":"https://api.github.com/users/krasnoukhov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-04-20T12:19:58Z","updated_at":"2023-05-02T15:27:04Z","closed_at":"2023-04-20T18:17:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":3195124,"node_id":"MDEwOlJlcG9zaXRvcnkzMTk1MTI0","name":"sidekiq","full_name":"sidekiq/sidekiq","private":false,"owner":{"login":"sidekiq","id":124714131,"node_id":"O_kgDOB278kw","avatar_url":"https://avatars.githubusercontent.com/u/124714131?v=4","gravatar_id":"","url":"https://api.github.com/users/sidekiq","html_url":"https://github.com/sidekiq","followers_url":"https://api.github.com/users/sidekiq/followers","following_url":"https://api.github.com/users/sidekiq/following{/other_user}","gists_url":"https://api.github.com/users/sidekiq/gists{/gist_id}","starred_url":"https://api.github.com/users/sidekiq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sidekiq/subscriptions","organizations_url":"https://api.github.com/users/sidekiq/orgs","repos_url":"https://api.github.com/users/sidekiq/repos","events_url":"https://api.github.com/users/sidekiq/events{/privacy}","received_events_url":"https://api.github.com/users/sidekiq/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sidekiq/sidekiq","description":"Simple, efficient background processing for Ruby","fork":false,"url":"https://api.github.com/repos/sidekiq/sidekiq","forks_url":"https://api.github.com/repos/sidekiq/sidekiq/forks","keys_url":"https://api.github.com/repos/sidekiq/sidekiq/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sidekiq/sidekiq/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sidekiq/sidekiq/teams","hooks_url":"https://api.github.com/repos/sidekiq/sidekiq/hooks","issue_events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events{/number}","events_url":"https://api.github.com/repos/sidekiq/sidekiq/events","assignees_url":"https://api.github.com/repos/sidekiq/sidekiq/assignees{/user}","branches_url":"https://api.github.com/repos/sidekiq/sidekiq/branches{/branch}","tags_url":"https://api.github.com/repos/sidekiq/sidekiq/tags","blobs_url":"https://api.github.com/repos/sidekiq/sidekiq/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sidekiq/sidekiq/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sidekiq/sidekiq/git/refs{/sha}","trees_url":"https://api.github.com/repos/sidekiq/sidekiq/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sidekiq/sidekiq/statuses/{sha}","languages_url":"https://api.github.com/repos/sidekiq/sidekiq/languages","stargazers_url":"https://api.github.com/repos/sidekiq/sidekiq/stargazers","contributors_url":"https://api.github.com/repos/sidekiq/sidekiq/contributors","subscribers_url":"https://api.github.com/repos/sidekiq/sidekiq/subscribers","subscription_url":"https://api.github.com/repos/sidekiq/sidekiq/subscription","commits_url":"https://api.github.com/repos/sidekiq/sidekiq/commits{/sha}","git_commits_url":"https://api.github.com/repos/sidekiq/sidekiq/git/commits{/sha}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/comments{/number}","issue_comment_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments{/number}","contents_url":"https://api.github.com/repos/sidekiq/sidekiq/contents/{+path}","compare_url":"https://api.github.com/repos/sidekiq/sidekiq/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sidekiq/sidekiq/merges","archive_url":"https://api.github.com/repos/sidekiq/sidekiq/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sidekiq/sidekiq/downloads","issues_url":"https://api.github.com/repos/sidekiq/sidekiq/issues{/number}","pulls_url":"https://api.github.com/repos/sidekiq/sidekiq/pulls{/number}","milestones_url":"https://api.github.com/repos/sidekiq/sidekiq/milestones{/number}","notifications_url":"https://api.github.com/repos/sidekiq/sidekiq/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/labels{/name}","releases_url":"https://api.github.com/repos/sidekiq/sidekiq/releases{/id}","deployments_url":"https://api.github.com/repos/sidekiq/sidekiq/deployments","created_at":"2012-01-16T23:17:27Z","updated_at":"2025-11-09T20:20:41Z","pushed_at":"2025-11-07T17:29:44Z","git_url":"git://github.com/sidekiq/sidekiq.git","ssh_url":"git@github.com:sidekiq/sidekiq.git","clone_url":"https://github.com/sidekiq/sidekiq.git","svn_url":"https://github.com/sidekiq/sidekiq","homepage":"https://sidekiq.org","size":14680,"stargazers_count":13447,"watchers_count":13447,"language":"Ruby","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":true,"forks_count":2471,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":40,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["background-jobs","jobs","ruby","sidekiq"],"visibility":"public","forks":2471,"open_issues":40,"watchers":13447,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Ruby version: 2.7.7\r\nRails version: 6.1.7.3\r\nSidekiq / Pro / Enterprise version(s): 7.0.9 / 7.0.10 / 7.0.8\r\n\r\nSeems like it's recommended to use `RAILS_MAX_THREADS` to configure concurrency since Sidekiq 7.x. It works quite fine for sidekiq server: everything is set to use the same variable (AR pool, Sidekiq's redis pool, Sidekiq's thread number). However it seems like when Sidekiq is in client mode this variable is ignored for its redis pool configuration and defaults for 5. So if you have more than 5 puma threads Sidekiq client will still use pool of 5 redis connections, which leads to errors. Thanks to the fix in #5702 one could still configure it through `size` option but that seems redundant in case when `RAILS_MAX_THREADS` is already provided.\r\n\r\nCan be reproduced like this:\r\n\r\n```\r\nRAILS_MAX_THREADS=7 rails c\r\nSidekiq.redis_pool.size # returns 5, expected 7\r\n```","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5886/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5886/timeline","performed_via_github_app":null,"state_reason":"not_planned"}},"event":"cross-referenced"},{"id":11730285206,"node_id":"REFE_lADOADDA9M5ZxhgUzwAAAAK7LfKW","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/11730285206","actor":{"login":"motchang","id":1159316,"node_id":"MDQ6VXNlcjExNTkzMTY=","avatar_url":"https://avatars.githubusercontent.com/u/1159316?v=4","gravatar_id":"","url":"https://api.github.com/users/motchang","html_url":"https://github.com/motchang","followers_url":"https://api.github.com/users/motchang/followers","following_url":"https://api.github.com/users/motchang/following{/other_user}","gists_url":"https://api.github.com/users/motchang/gists{/gist_id}","starred_url":"https://api.github.com/users/motchang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/motchang/subscriptions","organizations_url":"https://api.github.com/users/motchang/orgs","repos_url":"https://api.github.com/users/motchang/repos","events_url":"https://api.github.com/users/motchang/events{/privacy}","received_events_url":"https://api.github.com/users/motchang/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"0c1e466fdb995b67ab14ae08aa23e02a55f28593","commit_url":"https://api.github.com/repos/motchang/sidekiq/commits/0c1e466fdb995b67ab14ae08aa23e02a55f28593","created_at":"2024-02-07T10:21:23Z","performed_via_github_app":null},{"actor":{"login":"calvincchen","id":10647197,"node_id":"MDQ6VXNlcjEwNjQ3MTk3","avatar_url":"https://avatars.githubusercontent.com/u/10647197?v=4","gravatar_id":"","url":"https://api.github.com/users/calvincchen","html_url":"https://github.com/calvincchen","followers_url":"https://api.github.com/users/calvincchen/followers","following_url":"https://api.github.com/users/calvincchen/following{/other_user}","gists_url":"https://api.github.com/users/calvincchen/gists{/gist_id}","starred_url":"https://api.github.com/users/calvincchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calvincchen/subscriptions","organizations_url":"https://api.github.com/users/calvincchen/orgs","repos_url":"https://api.github.com/users/calvincchen/repos","events_url":"https://api.github.com/users/calvincchen/events{/privacy}","received_events_url":"https://api.github.com/users/calvincchen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-12-20T15:52:08Z","updated_at":"2024-12-20T15:52:08Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6560","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6560/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6560/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6560/events","html_url":"https://github.com/sidekiq/sidekiq/issues/6560","id":2753002496,"node_id":"I_kwDOADDA9M6kF3wA","number":6560,"title":"Periodic subsystem skipping ticks","user":{"login":"calvincchen","id":10647197,"node_id":"MDQ6VXNlcjEwNjQ3MTk3","avatar_url":"https://avatars.githubusercontent.com/u/10647197?v=4","gravatar_id":"","url":"https://api.github.com/users/calvincchen","html_url":"https://github.com/calvincchen","followers_url":"https://api.github.com/users/calvincchen/followers","following_url":"https://api.github.com/users/calvincchen/following{/other_user}","gists_url":"https://api.github.com/users/calvincchen/gists{/gist_id}","starred_url":"https://api.github.com/users/calvincchen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calvincchen/subscriptions","organizations_url":"https://api.github.com/users/calvincchen/orgs","repos_url":"https://api.github.com/users/calvincchen/repos","events_url":"https://api.github.com/users/calvincchen/events{/privacy}","received_events_url":"https://api.github.com/users/calvincchen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2024-12-20T15:52:07Z","updated_at":"2025-01-21T02:06:24Z","closed_at":"2025-01-21T02:06:22Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":3195124,"node_id":"MDEwOlJlcG9zaXRvcnkzMTk1MTI0","name":"sidekiq","full_name":"sidekiq/sidekiq","private":false,"owner":{"login":"sidekiq","id":124714131,"node_id":"O_kgDOB278kw","avatar_url":"https://avatars.githubusercontent.com/u/124714131?v=4","gravatar_id":"","url":"https://api.github.com/users/sidekiq","html_url":"https://github.com/sidekiq","followers_url":"https://api.github.com/users/sidekiq/followers","following_url":"https://api.github.com/users/sidekiq/following{/other_user}","gists_url":"https://api.github.com/users/sidekiq/gists{/gist_id}","starred_url":"https://api.github.com/users/sidekiq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sidekiq/subscriptions","organizations_url":"https://api.github.com/users/sidekiq/orgs","repos_url":"https://api.github.com/users/sidekiq/repos","events_url":"https://api.github.com/users/sidekiq/events{/privacy}","received_events_url":"https://api.github.com/users/sidekiq/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/sidekiq/sidekiq","description":"Simple, efficient background processing for Ruby","fork":false,"url":"https://api.github.com/repos/sidekiq/sidekiq","forks_url":"https://api.github.com/repos/sidekiq/sidekiq/forks","keys_url":"https://api.github.com/repos/sidekiq/sidekiq/keys{/key_id}","collaborators_url":"https://api.github.com/repos/sidekiq/sidekiq/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/sidekiq/sidekiq/teams","hooks_url":"https://api.github.com/repos/sidekiq/sidekiq/hooks","issue_events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events{/number}","events_url":"https://api.github.com/repos/sidekiq/sidekiq/events","assignees_url":"https://api.github.com/repos/sidekiq/sidekiq/assignees{/user}","branches_url":"https://api.github.com/repos/sidekiq/sidekiq/branches{/branch}","tags_url":"https://api.github.com/repos/sidekiq/sidekiq/tags","blobs_url":"https://api.github.com/repos/sidekiq/sidekiq/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/sidekiq/sidekiq/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/sidekiq/sidekiq/git/refs{/sha}","trees_url":"https://api.github.com/repos/sidekiq/sidekiq/git/trees{/sha}","statuses_url":"https://api.github.com/repos/sidekiq/sidekiq/statuses/{sha}","languages_url":"https://api.github.com/repos/sidekiq/sidekiq/languages","stargazers_url":"https://api.github.com/repos/sidekiq/sidekiq/stargazers","contributors_url":"https://api.github.com/repos/sidekiq/sidekiq/contributors","subscribers_url":"https://api.github.com/repos/sidekiq/sidekiq/subscribers","subscription_url":"https://api.github.com/repos/sidekiq/sidekiq/subscription","commits_url":"https://api.github.com/repos/sidekiq/sidekiq/commits{/sha}","git_commits_url":"https://api.github.com/repos/sidekiq/sidekiq/git/commits{/sha}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/comments{/number}","issue_comment_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments{/number}","contents_url":"https://api.github.com/repos/sidekiq/sidekiq/contents/{+path}","compare_url":"https://api.github.com/repos/sidekiq/sidekiq/compare/{base}...{head}","merges_url":"https://api.github.com/repos/sidekiq/sidekiq/merges","archive_url":"https://api.github.com/repos/sidekiq/sidekiq/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/sidekiq/sidekiq/downloads","issues_url":"https://api.github.com/repos/sidekiq/sidekiq/issues{/number}","pulls_url":"https://api.github.com/repos/sidekiq/sidekiq/pulls{/number}","milestones_url":"https://api.github.com/repos/sidekiq/sidekiq/milestones{/number}","notifications_url":"https://api.github.com/repos/sidekiq/sidekiq/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/labels{/name}","releases_url":"https://api.github.com/repos/sidekiq/sidekiq/releases{/id}","deployments_url":"https://api.github.com/repos/sidekiq/sidekiq/deployments","created_at":"2012-01-16T23:17:27Z","updated_at":"2025-11-09T20:20:41Z","pushed_at":"2025-11-07T17:29:44Z","git_url":"git://github.com/sidekiq/sidekiq.git","ssh_url":"git@github.com:sidekiq/sidekiq.git","clone_url":"https://github.com/sidekiq/sidekiq.git","svn_url":"https://github.com/sidekiq/sidekiq","homepage":"https://sidekiq.org","size":14680,"stargazers_count":13447,"watchers_count":13447,"language":"Ruby","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":true,"forks_count":2471,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":40,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["background-jobs","jobs","ruby","sidekiq"],"visibility":"public","forks":2471,"open_issues":40,"watchers":13447,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Ruby version: 3.3.5\r\nRails version: 7.2.2.1\r\nSidekiq / Pro / Enterprise version(s): 7.3.7 / 7.3.4 / 7.3.4\r\n\r\n### Summary\r\nWe upgraded from Sidekiq 7.1.6 to 7.3.7 earlier this week and have noticed more logs for `\"Periodic subsystem skipped tick\"`. This seems to spike unpredictability throughout the day, and has led to us missing a number of periodic jobs.\r\n\r\n<img width=\"1341\" alt=\"image\" src=\"https://github.com/user-attachments/assets/b3852637-4fd4-4a9f-b2d3-10aa4c615c8f\" />\r\n\r\n\r\n### Configuration\r\nWe're running Sidekiq Swarm with 5 processes x 1 concurrency per box.\r\n\r\nSidekiq Redis configuration\r\n```rb\r\nSidekiq.configure_server do |config|\r\n  config.redis = {\r\n    url: my_url,\r\n    timeout: 3,\r\n    size: 10,\r\n  }\r\nend\r\n```\r\n\r\nServer initialization logs\r\n```\r\n#internal\r\nSidekiq 7.3.7 connecting to Redis with options {:size=>10, :pool_name=>\"internal\", :url=>my_url, :timeout=>3}\r\n\r\n#default\r\nSidekiq 7.3.7 connecting to Redis with options {:size=>10, :pool_name=>\"default\", :url=>my_url, :timeout=>3}\r\n```\r\n\r\n### Additional Context\r\nThe `\"Periodic subsystem skipped tick\"` occurrence appears to correlate with warnings of `ConnectionPool::TimeoutError: Waited 5 sec, 0/1 available`\r\n\r\nStacktrace\r\n```\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool/timed_stack.rb:77:in `block (2 levels) in pop'\r\n<internal:kernel>:187:in `loop'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool/timed_stack.rb:69:in `block in pop'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool/timed_stack.rb:68:in `synchronize'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool/timed_stack.rb:68:in `pop'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:125:in `checkout'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:107:in `block in with'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `handle_interrupt'\r\n/usr/local/bundle/ruby/3.3.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `with'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-pro-7.3.4/lib/sidekiq/pro/metrics.rb:129:in `batch'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-gusto-12.3.4/lib/sidekiq-gusto/stats/client_middleware.rb:31:in `call'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-pro-7.3.4/lib/sidekiq/pro/expiry.rb:24:in `call'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/contrib/sidekiq/client_tracer.rb:49:in `block in call'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/trace_operation.rb:226:in `block in measure'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/span_operation.rb:150:in `measure'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/trace_operation.rb:226:in `measure'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/tracer.rb:403:in `start_span'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/tracer.rb:158:in `block in trace'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/context.rb:45:in `activate!'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/tracer.rb:157:in `trace'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing.rb:30:in `trace'\r\n/usr/local/bundle/ruby/3.3.0/gems/datadog-2.7.1/lib/datadog/tracing/contrib/sidekiq/client_tracer.rb:26:in `call'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-pro-7.3.4/lib/sidekiq/batch/middleware.rb:18:in `call'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:183:in `block in traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-ent-7.3.4/lib/sidekiq-ent/unique.rb:163:in `call'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:182:in `traverse'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/middleware/chain.rb:173:in `invoke'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/client.rb:105:in `push'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/transaction_aware_client.rb:23:in `block in push'\r\n/usr/local/bundle/ruby/3.3.0/gems/after_commit_everywhere-1.5.0/lib/after_commit_everywhere.rb:117:in `register_callback'\r\n/usr/local/bundle/ruby/3.3.0/gems/after_commit_everywhere-1.5.0/lib/after_commit_everywhere.rb:47:in `after_commit'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/transaction_aware_client.rb:23:in `push'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/job.rb:372:in `client_push'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/job.rb:209:in `perform_async'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-ent-7.3.4/lib/sidekiq-ent/periodic/manager.rb:173:in `enqueue_job'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-ent-7.3.4/lib/sidekiq-ent/periodic/manager.rb:126:in `process'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-ent-7.3.4/lib/sidekiq-ent/periodic/manager.rb:79:in `block in cycle'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/rails.rb:16:in `block in call'\r\n/usr/local/bundle/ruby/3.3.0/bundler/gems/rails-c5c170501e81/activesupport/lib/active_support/reloader.rb:77:in `block in wrap'\r\n/usr/local/bundle/ruby/3.3.0/bundler/gems/rails-c5c170501e81/activesupport/lib/active_support/execution_wrapper.rb:91:in `wrap'\r\n/usr/local/bundle/ruby/3.3.0/bundler/gems/rails-c5c170501e81/activesupport/lib/active_support/reloader.rb:74:in `wrap'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/rails.rb:15:in `call'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-ent-7.3.4/lib/sidekiq-ent/periodic/manager.rb:78:in `cycle'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/component.rb:10:in `watchdog'\r\n/usr/local/bundle/ruby/3.3.0/gems/sidekiq-7.3.7/lib/sidekiq/component.rb:19:in `block in safe_thread'\r\n```\r\n\r\nI came across a couple similar threads (https://github.com/sidekiq/sidekiq/issues/5685, https://github.com/sidekiq/sidekiq/issues/5684, https://github.com/sidekiq/sidekiq/issues/5752, https://github.com/sidekiq/sidekiq/issues/5702) but wasn't able to resolve this issue. Any advice or suggestions would be greatly appreciated!\r\n\r\n\r\n### Additional Questions\r\n1. Where is the `1` from `ConnectionPool::TimeoutError: Waited 5 sec, 0/1 available` come from? Is this the capsule concurrency? Is there a configuration to increase the pool size without increasing the capsule concurrency of the process?\r\n2. We have a thread of our own that makes calls to redis using `Sidekiq.redis` for stats reporting, could this be exacerbating the issue?\r\n\r\nThank you and please let me know if there's additional context I can provide!","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6560/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6560/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]