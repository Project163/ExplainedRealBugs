{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6371","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6371/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6371/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6371/events","html_url":"https://github.com/sidekiq/sidekiq/issues/6371","id":2422819707,"node_id":"I_kwDOADDA9M6QaUt7","number":6371,"title":"7.3.0+: Issue when running sidekiq-scheduler specs against 2.7","user":{"login":"tagliala","id":556268,"node_id":"MDQ6VXNlcjU1NjI2OA==","avatar_url":"https://avatars.githubusercontent.com/u/556268?v=4","gravatar_id":"","url":"https://api.github.com/users/tagliala","html_url":"https://github.com/tagliala","followers_url":"https://api.github.com/users/tagliala/followers","following_url":"https://api.github.com/users/tagliala/following{/other_user}","gists_url":"https://api.github.com/users/tagliala/gists{/gist_id}","starred_url":"https://api.github.com/users/tagliala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tagliala/subscriptions","organizations_url":"https://api.github.com/users/tagliala/orgs","repos_url":"https://api.github.com/users/tagliala/repos","events_url":"https://api.github.com/users/tagliala/events{/privacy}","received_events_url":"https://api.github.com/users/tagliala/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-07-22T12:58:54Z","updated_at":"2024-07-24T07:12:45Z","closed_at":"2024-07-24T06:47:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\r\n\r\nthis can be a bug in Ruby, however I think it should be reported\r\n\r\nRuby version: 2.7.8\r\nRails version: n/a\r\nSidekiq / Pro / Enterprise version(s): `7.3.0` and current `main`\r\n\r\nRef: https://github.com/sidekiq-scheduler/sidekiq-scheduler/actions/runs/10040804893/job/27747574809?pr=486#step:5:108\r\n\r\n```\r\n  1) Sidekiq::Web GET /recurring-jobs when the next execution time is setted \r\n     Failure/Error: erb File.read(File.join(VIEW_PATH, 'recurring_jobs.erb'))\r\n     \r\n     FrozenError:\r\n       can't modify frozen String: \"<link\"\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/helpers.rb:42:in `block in html_tag'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/helpers.rb:40:in `each_pair'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/helpers.rb:40:in `html_tag'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/helpers.rb:22:in `style_tag'\r\n     # (erb):2:in `_erb'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/action.rb:93:in `_erb'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/action.rb:64:in `erb'\r\n     # ./lib/sidekiq-scheduler/web.rb:15:in `block in registered'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/application.rb:416:in `instance_exec'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/application.rb:416:in `block in call'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/application.rb:414:in `catch'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web/application.rb:414:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-2.2.9/lib/rack/session/abstract/id.rb:266:in `context'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-2.2.9/lib/rack/session/abstract/id.rb:260:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-2.2.9/lib/rack/static.rb:161:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-2.2.9/lib/rack/static.rb:161:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-2.2.9/lib/rack/builder.rb:244:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web.rb:121:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/bundler/gems/sidekiq-0226e311d02d/lib/sidekiq/web.rb:126:in `call'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-test-2.1.0/lib/rack/test.rb:360:in `process_request'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-test-2.1.0/lib/rack/test.rb:163:in `custom_request'\r\n     # ~/.rvm/gems/ruby-2.7.8/gems/rack-test-2.1.0/lib/rack/test.rb:112:in `get'\r\n     # ./spec/sidekiq-scheduler/web_spec.rb:39:in `block (3 levels) in <top (required)>'\r\n     # ./spec/sidekiq-scheduler/web_spec.rb:72:in `block (4 levels) in <top (required)>'\r\n```\r\n\r\n### Cause of the issue\r\n\r\nhttps://github.com/sidekiq/sidekiq/blob/0226e311d02de8ea77563c17c96a3d6527d0ec7f/lib/sidekiq/web/helpers.rb#L39\r\n\r\nApparently, in Ruby 2.7 `s` is frozen (Ruby bug? Behavior change in 3.0?), causing subsequent calls to `<<` to fail.\r\n\r\n### Solution(s)\r\n\r\nA. Bump minimum required Ruby version to 3.0\r\nB. `add a +` to unfreeze the string and add a note to drop the `+` together with Ruby 2.7 support\r\n  ```diff\r\n  - s = \"<#{tagname}\" \r\n  + s = +\"<#{tagname}\" # TODO: remove `+` when dropping 2.7 support, sidekiq/sidekiq#6371\r\n  ```","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6371/timeline","performed_via_github_app":null,"state_reason":"completed"}