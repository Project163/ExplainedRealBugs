{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2531","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2531/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2531/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2531/events","html_url":"https://github.com/sidekiq/sidekiq/issues/2531","id":104583305,"node_id":"MDU6SXNzdWUxMDQ1ODMzMDU=","number":2531,"title":"Sidekiq can lose jobs even with reliable fetch","user":{"login":"sanjayprabhu","id":75855,"node_id":"MDQ6VXNlcjc1ODU1","avatar_url":"https://avatars.githubusercontent.com/u/75855?v=4","gravatar_id":"","url":"https://api.github.com/users/sanjayprabhu","html_url":"https://github.com/sanjayprabhu","followers_url":"https://api.github.com/users/sanjayprabhu/followers","following_url":"https://api.github.com/users/sanjayprabhu/following{/other_user}","gists_url":"https://api.github.com/users/sanjayprabhu/gists{/gist_id}","starred_url":"https://api.github.com/users/sanjayprabhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sanjayprabhu/subscriptions","organizations_url":"https://api.github.com/users/sanjayprabhu/orgs","repos_url":"https://api.github.com/users/sanjayprabhu/repos","events_url":"https://api.github.com/users/sanjayprabhu/events{/privacy}","received_events_url":"https://api.github.com/users/sanjayprabhu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-09-02T22:17:54Z","updated_at":"2015-09-09T19:39:41Z","closed_at":"2015-09-09T19:39:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm on sidekiq version `2.17.8` (and sidekiq-pro `1.5.1`) and investigating an issue where sidekiq is not performing some jobs even with reliable queueing enabled. \n\nCurrently, looks like this can happen if there was an exception in any of the middleware in the stack before it hits the `RetryJobs` middleware. Or, say, an exception in the `RetryJobs` middleware anytime before it queues up the retry (less likely).\n\nThis is because in [this block of code](https://github.com/mperham/sidekiq/blob/v2.17.8/lib/sidekiq/processor.rb#L40-L62):\n\n``` ruby\n        ack = true\n        begin\n          msg = Sidekiq.load_json(msgstr)\n          klass  = msg['class'].constantize\n          worker = klass.new\n          worker.jid = msg['jid']\n\n          stats(worker, msg, queue) do\n            Sidekiq.server_middleware.invoke(worker, msg, queue) do\n              worker.perform(*cloned(msg['args']))\n            end\n          end\n        rescue Sidekiq::Shutdown\n          # Had to force kill this job because it didn't finish\n          # within the timeout.  Don't acknowledge the work since\n          # we didn't properly finish it.\n          ack = false\n        rescue Exception => ex\n          handle_exception(ex, msg || { :message => msgstr })\n          raise\n        ensure\n          work.acknowledge if ack\n        end\n```\n\nIt ack's the job even though the middleware may not have executed successfully. You can reproduce this locally by running sidekiq within foreman, sending it a lot of jobs and `ctrl-c`ing it. [This line](https://github.com/mperham/sidekiq/blob/v2.17.8/lib/sidekiq/middleware/server/logging.rb#L10) fails with `Broken pipe @ io_write - <STDERR>` and you lose the job (`perform` was never called on the worker, `RetryJobs` was never reached, so it doesn't try to retry but we still ack the work so nobody else is going to work on it). My [test worker](https://gist.github.com/sanjayprabhu/350d952f47c5a71fdae2) if you're interested.\n\nThoughts on how to fix this? Maybe start with `ack=false` and do something like\n\n``` ruby\n            Sidekiq.server_middleware.invoke(worker, msg, queue) do\n              ack = true # we attempted to perform the job\n              worker.perform(*cloned(msg['args']))\n            end\n            ack = true # middleware invoked successfully (may or may not have decided to perform the job)\n```\n\nI can open a PR for that if you think that sounds reasonable.\n\nThe real kicker is, this codepath is not hit in production for us (`RetryJobs` is the first middleware in our chain), so there's at least one more bug which is causing us to lose jobs. I'm continuing to investigate that.\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2531/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2531/timeline","performed_via_github_app":null,"state_reason":"completed"}