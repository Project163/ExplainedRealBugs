{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4416","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4416/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4416/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4416/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4416","id":546923190,"node_id":"MDU6SXNzdWU1NDY5MjMxOTA=","number":4416,"title":"Need A Better Check for `rails_app?`","user":{"login":"benhutton","id":61645,"node_id":"MDQ6VXNlcjYxNjQ1","avatar_url":"https://avatars.githubusercontent.com/u/61645?v=4","gravatar_id":"","url":"https://api.github.com/users/benhutton","html_url":"https://github.com/benhutton","followers_url":"https://api.github.com/users/benhutton/followers","following_url":"https://api.github.com/users/benhutton/following{/other_user}","gists_url":"https://api.github.com/users/benhutton/gists{/gist_id}","starred_url":"https://api.github.com/users/benhutton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benhutton/subscriptions","organizations_url":"https://api.github.com/users/benhutton/orgs","repos_url":"https://api.github.com/users/benhutton/repos","events_url":"https://api.github.com/users/benhutton/events{/privacy}","received_events_url":"https://api.github.com/users/benhutton/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-01-08T15:11:55Z","updated_at":"2020-01-08T16:46:58Z","closed_at":"2020-01-08T16:46:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.6.5\r\nSidekiq / Pro / Enterprise version(s): Sidekiq 6.0.4\r\n\r\n```\r\n019-12-27T21:43:44.852961+00:00 heroku[worker.1]: State changed from crashed to starting\r\n2019-12-27T21:43:48.890470+00:00 heroku[worker.1]: Starting process with command `bundle exec bin/sidekiq -e production -q default`\r\n2019-12-27T21:43:49.489252+00:00 heroku[worker.1]: State changed from starting to up\r\n2019-12-27T21:43:55.938630+00:00 heroku[worker.1]: State changed from up to crashed\r\n2019-12-27T21:43:55.805818+00:00 app[worker.1]: undefined method `version’ for Rails:Module\r\n2019-12-27T21:43:55.805841+00:00 app[worker.1]: /app/vendor/bundle/ruby/2.6.0/gems/sidekiq-6.0.4/lib/sidekiq/cli.rb:41:in `run’\r\n2019-12-27T21:43:55.805844+00:00 app[worker.1]: /app/vendor/bundle/ruby/2.6.0/gems/sidekiq-6.0.4/bin/sidekiq:12:in `<top (required)>'\r\n2019-12-27T21:43:55.805846+00:00 app[worker.1]: /app/vendor/bundle/ruby/2.6.0/bin/sidekiq:23:in `load’\r\n2019-12-27T21:43:55.805848+00:00 app[worker.1]: /app/vendor/bundle/ruby/2.6.0/bin/sidekiq:23:in `<main>'\r\n2019-12-27T21:43:55.923021+00:00 heroku[worker.1]: Process exited with status 0\r\n```\r\n\r\nThe issue at hand is that this is not a safe way to check if the app is a rails app: https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/cli.rb#L383-L385\r\n\r\nWe are NOT a rails app, yet `Rails` is defined because we use one of Rails' spun-off gems: https://github.com/rails/rails-html-sanitizer/blob/master/lib/rails-html-sanitizer.rb#L6\r\n\r\nWe are not actually loading the rails gem that would define `Rails.version`. In our system, `Rails` is just a module.\r\n\r\nChecking for the presence of a `Rails.version` (properly guarded, of course) would be a better check, though still not foolproof (you could load a lot of Rails into your app and still not be a rails app)\r\n\r\n```\r\ndef rails_app?\r\n  defined?(Rails) && Rails&.version.present?\r\nend\r\n```\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4416/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4416/timeline","performed_via_github_app":null,"state_reason":"completed"}