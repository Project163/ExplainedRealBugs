{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/109","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/109/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/109/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/109/events","html_url":"https://github.com/sidekiq/sidekiq/issues/109","id":3940539,"node_id":"MDU6SXNzdWUzOTQwNTM5","number":109,"title":"Sidekiq retry jobs puts jobs on wrong queue when using namespaces","user":{"login":"Burgestrand","id":99166,"node_id":"MDQ6VXNlcjk5MTY2","avatar_url":"https://avatars.githubusercontent.com/u/99166?v=4","gravatar_id":"","url":"https://api.github.com/users/Burgestrand","html_url":"https://github.com/Burgestrand","followers_url":"https://api.github.com/users/Burgestrand/followers","following_url":"https://api.github.com/users/Burgestrand/following{/other_user}","gists_url":"https://api.github.com/users/Burgestrand/gists{/gist_id}","starred_url":"https://api.github.com/users/Burgestrand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Burgestrand/subscriptions","organizations_url":"https://api.github.com/users/Burgestrand/orgs","repos_url":"https://api.github.com/users/Burgestrand/repos","events_url":"https://api.github.com/users/Burgestrand/events{/privacy}","received_events_url":"https://api.github.com/users/Burgestrand/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2012-04-03T07:46:45Z","updated_at":"2012-04-03T14:09:51Z","closed_at":"2012-04-03T14:09:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi!\n\n[The new fetcher using blpop](https://github.com/mperham/sidekiq/blob/b58d1256591694710757b9eaf95d3859661786ef/lib/sidekiq/fetch.rb#L35) does not take namespaces into account when [cleaning off the prefix of the queue name](https://github.com/mperham/sidekiq/blob/b58d1256591694710757b9eaf95d3859661786ef/lib/sidekiq/fetch.rb#L38).\n\nAssume a namespace of `resque` and looking at line #35 of fetch.rb:\n\n``` ruby\nSidekiq.redis { |conn| (queue, msg) = conn.blpop(*@cmd) }\n```\n\n`@cmd` will be a list of all queues, that’ll be namespaced by Redis::Namespace, meaning the actual queue names will be `resque:queue:default` and so on. Since `blpop` returns the queue name, it’ll also be namespaced, so `queue` itself will be assigned `resque:queue:default` as well.\n\nNow, when cleaning it off on line #38 of fetch.rb, only `queue:` is removed (but only if it’s at the start of the queue name):\n\n``` ruby\n@mgr.assign!(msg, queue.gsub(/\\Aqueue:/, ''))\n```\n\nAssuming a queue name of `resque:queue:default`, nothing will get cleaned off. Perhaps changing the regex will suffice: `/.*queue:/`.\n\nThe reason that RetryJobs fails is that it [uses the `queue` passed on through the middleware](https://github.com/mperham/sidekiq/blob/b58d1256591694710757b9eaf95d3859661786ef/lib/sidekiq/middleware/server/retry_jobs.rb#L32), which is now invalid. Since this error is so far up the chain, all server middleware is affected by this error as they may potentially use this value. It also affects Sidekiq::Web, since it displays the queue names for each job.\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/109/timeline","performed_via_github_app":null,"state_reason":"completed"}