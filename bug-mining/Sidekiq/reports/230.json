{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4149","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4149/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4149/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4149/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4149","id":433784685,"node_id":"MDU6SXNzdWU0MzM3ODQ2ODU=","number":4149,"title":"Change in instrumentation behavior after 5.2.6 upgrade","user":{"login":"fixr","id":374099,"node_id":"MDQ6VXNlcjM3NDA5OQ==","avatar_url":"https://avatars.githubusercontent.com/u/374099?v=4","gravatar_id":"","url":"https://api.github.com/users/fixr","html_url":"https://github.com/fixr","followers_url":"https://api.github.com/users/fixr/followers","following_url":"https://api.github.com/users/fixr/following{/other_user}","gists_url":"https://api.github.com/users/fixr/gists{/gist_id}","starred_url":"https://api.github.com/users/fixr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fixr/subscriptions","organizations_url":"https://api.github.com/users/fixr/orgs","repos_url":"https://api.github.com/users/fixr/repos","events_url":"https://api.github.com/users/fixr/events{/privacy}","received_events_url":"https://api.github.com/users/fixr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-04-16T13:37:16Z","updated_at":"2019-04-16T16:13:50Z","closed_at":"2019-04-16T15:42:53Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.5.5\r\nSidekiq / Pro / Enterprise version(s): Sidekiq Enterprise 5.2.6\r\n\r\nAfter upgrading to `5.2.6` we noticed an unexpected behaviour in our metrics for one of queues. Right after the upgrade, queue delays went up to hours, which didn't reflect the reality on the enqueued items.\r\n\r\nTo calculate the delay, we use this formula:\r\n\r\n```ruby\r\nqueueing_delay_ms = (Time.current.to_f * 1000).to_i - (msg[\"enqueued_at\"].to_f * 1000).to_i\r\n```\r\n\r\nThe peculiarity on this queue is that we schedule jobs for many days in the future under it. It also has a higher chance of jobs failing and being retried.\r\n\r\nWe believe the changes introduced in https://github.com/mperham/sidekiq/commit/cfe53e5fadfe88c53b62608d1dfc75ecf2ac18a0 to be culprit. Before these changes, we would get a new `enqueued_at` value when it was re-enqueued. Now, the original value is kept.\r\n\r\nIs this side-effect intended? If so, then we may look to alternatives. Any hint on how to handle it now, would be greatly appreciated!","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4149/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4149/timeline","performed_via_github_app":null,"state_reason":"completed"}