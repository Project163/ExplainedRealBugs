{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6040","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6040/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6040/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6040/events","html_url":"https://github.com/sidekiq/sidekiq/issues/6040","id":1901200713,"node_id":"I_kwDOADDA9M5xUgVJ","number":6040,"title":"`Sidekiq::Client.push_bulk` repeats `at` array values after `batch_size` items, ignoring the rest","user":{"login":"aprescott","id":342081,"node_id":"MDQ6VXNlcjM0MjA4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/342081?v=4","gravatar_id":"","url":"https://api.github.com/users/aprescott","html_url":"https://github.com/aprescott","followers_url":"https://api.github.com/users/aprescott/followers","following_url":"https://api.github.com/users/aprescott/following{/other_user}","gists_url":"https://api.github.com/users/aprescott/gists{/gist_id}","starred_url":"https://api.github.com/users/aprescott/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aprescott/subscriptions","organizations_url":"https://api.github.com/users/aprescott/orgs","repos_url":"https://api.github.com/users/aprescott/repos","events_url":"https://api.github.com/users/aprescott/events{/privacy}","received_events_url":"https://api.github.com/users/aprescott/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-09-18T15:29:27Z","updated_at":"2023-09-18T16:52:56Z","closed_at":"2023-09-18T16:37:11Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 3.2.2\r\nRails version: 7.0.8, since that's what `bundle exec rake` in the Sidekiq repo seems to use for me\r\nSidekiq / Pro / Enterprise version(s): Sidekiq 7.1.4 (and confirmed on `main` as of 1ba89bbb22d2fd574b11702d8b6ed63ae59e2256)\r\n\r\n(I have reproduced problem on the current `main` branch, using the `client_test.rb` test below, it does not seem to be mentioned in CHANGELOG.)\r\n\r\n## Summary\r\n\r\n`Sidekiq::Client.push_bulk` with an `at` array argument will start repeating `at` values after `batch_size` items, instead of using all `at` values given.\r\n\r\nThis breaks an expectation when trying to enqueue N jobs (with N in excess of `batch_size`) each with distinct `at` times, since the first `batch_size` values in `at` will start to repeat, ignoring the remaining given `at` values.\r\n\r\n## Example\r\n\r\nFor example:\r\n\r\n```ruby\r\nSidekiq::Client.push_bulk(\r\n  \"class\" => FooJob,\r\n  \"args\" => [[1], [2], [3]],\r\n  \"at\" => 3.times.map { |i| Time.new(2019, 1, i + 1).to_f },\r\n  :batch_size => 2\r\n)\r\n```\r\n\r\nBased on the way [`push_bulk` checks `args.size` and `at.size`](https://github.com/sidekiq/sidekiq/blob/1ba89bbb22d2fd574b11702d8b6ed63ae59e2256/lib/sidekiq/client.rb#L121), I think the expectation with the above code is that the `args` and `at` values are paired:\r\n\r\n- `[1]` and `Time.new(2019, 1, 1)`\r\n- `[2]` and `Time.new(2019, 1, 2)`\r\n- `[3]` and `Time.new(2019, 1, 3)`\r\n\r\nIn reality, the index value loops through `0..(batch_size-1)` [because of the way the `with_index` is applied](https://github.com/sidekiq/sidekiq/blob/1ba89bbb22d2fd574b11702d8b6ed63ae59e2256/lib/sidekiq/client.rb#L131). The inner index is used, which resets for each batch, resulting in the following unexpected pairing:\r\n\r\n- `[1]` and `Time.new(2019, 1, 1)`\r\n- `[2]` and `Time.new(2019, 1, 2)`\r\n- `[3]` and `Time.new(2019, 1, 1)` (resets back to the first `at` value)\r\n\r\nThis seems to have been introduced as part of 1b2c3e8d0ba77447f12a4fb5035cf238ced2d23c included in v7.1.0, which made `push_bulk` batch-aware (later affecting `perform_bulk` in c1607198815d68f60d138010907dd3426d6521bb).\r\n\r\n## Failing test case\r\n\r\nOn `main` as of 1ba89bbb22d2fd574b11702d8b6ed63ae59e2256, this test I added locally to `client_test.rb` fails:\r\n\r\n```ruby\r\n# in client_test.rb\r\n\r\nit \"can specify different times when there are more jobs than the batch size\" do\r\n  times = job_count.times.map { |i| Time.new(2019, 1, i + 1) }\r\n  args = job_count.times.map { |i| [i] }\r\n  # When there are 3 jobs, we want to use `times[2]` for the final job.\r\n  batch_size = 2\r\n\r\n  jids = Sidekiq::Client.push_bulk(\"class\" => QueuedJob, \"args\" => args, \"at\" => times.map(&:to_f), :batch_size => batch_size)\r\n\r\n  assert_equal job_count, jids.size\r\n  assert_equal times, jids.map { |jid| Sidekiq::ScheduledSet.new.find_job(jid).at }\r\nend\r\n```\r\n\r\nTest output:\r\n\r\n```\r\nFailure:\r\nSidekiq::Client::bulk#test_0009_can specify different times when there are more jobs than the batch size [/private/tmp/sidekiq/test/client_test.rb:376]:\r\n--- expected\r\n+++ actual\r\n@@ -1 +1 @@\r\n-[2019-01-01 00:00:00 -0500, 2019-01-02 00:00:00 -0500, 2019-01-03 00:00:00 -0500]\r\n+[2019-01-01 05:00:00 UTC, 2019-01-02 05:00:00 UTC, 2019-01-01 05:00:00 UTC]\r\n```\r\n\r\nA corresponding diff, just for completeness:\r\n\r\n```diff\r\ndiff --git a/test/client_test.rb b/test/client_test.rb\r\nindex 8d6ecd27..37f49ea2 100644\r\n--- a/test/client_test.rb\r\n+++ b/test/client_test.rb\r\n@@ -363,6 +363,18 @@ describe Sidekiq::Client do\r\n         assert_equal job_count, jids.size\r\n         assert_equal times, jids.map { |jid| Sidekiq::ScheduledSet.new.find_job(jid).at }\r\n       end\r\n+\r\n+      it \"pairs all `at` values with each `args` value when there are more jobs than the batch size\" do\r\n+        times = job_count.times.map { |i| Time.new(2019, 1, i + 1) }\r\n+        args = job_count.times.map { |i| [i] }\r\n+        # When there are 3 jobs, we want to use `times[2]` for the final job.\r\n+        batch_size = 2\r\n+\r\n+        jids = Sidekiq::Client.push_bulk(\"class\" => QueuedJob, \"args\" => args, \"at\" => times.map(&:to_f), :batch_size => batch_size)\r\n+\r\n+        assert_equal job_count, jids.size\r\n+        assert_equal times, jids.map { |jid| Sidekiq::ScheduledSet.new.find_job(jid).at }\r\n+      end\r\n     end\r\n \r\n     it \"can push jobs scheduled using ActiveSupport::Duration\" do\r\n```","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6040/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6040/timeline","performed_via_github_app":null,"state_reason":"completed"}