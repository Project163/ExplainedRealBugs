{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4825","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4825/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4825/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4825/events","html_url":"https://github.com/sidekiq/sidekiq/issues/4825","id":814252463,"node_id":"MDU6SXNzdWU4MTQyNTI0NjM=","number":4825,"title":"Sidekiq Pro, Redis::CommandError: ERR wrong number of arguments for 'brpop' command, when pausing queue","user":{"login":"thibaudgg","id":1322,"node_id":"MDQ6VXNlcjEzMjI=","avatar_url":"https://avatars.githubusercontent.com/u/1322?v=4","gravatar_id":"","url":"https://api.github.com/users/thibaudgg","html_url":"https://github.com/thibaudgg","followers_url":"https://api.github.com/users/thibaudgg/followers","following_url":"https://api.github.com/users/thibaudgg/following{/other_user}","gists_url":"https://api.github.com/users/thibaudgg/gists{/gist_id}","starred_url":"https://api.github.com/users/thibaudgg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thibaudgg/subscriptions","organizations_url":"https://api.github.com/users/thibaudgg/orgs","repos_url":"https://api.github.com/users/thibaudgg/repos","events_url":"https://api.github.com/users/thibaudgg/events{/privacy}","received_events_url":"https://api.github.com/users/thibaudgg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-02-23T08:53:39Z","updated_at":"2021-02-23T17:28:13Z","closed_at":"2021-02-23T17:12:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.6.6\r\nRails version: 6.0.3.5\r\nSidekiq / Pro / Enterprise version(s): 6.1.2 / 5.2.0 / 2.1.2\r\n\r\nHi,\r\n\r\nWe are getting this `Redis::CommandError: ERR wrong number of arguments for 'brpop' command` error, when pausing a queue from the Web UI queues list.\r\n\r\nThis issue is easily reproducible and is only happening when the paused queue is the only one processed by the `sidekiq` command, i.e. ` sidekiq-q default`. When two queues are processed (i.e.`sidekiq -q default -q low`) this error isn't triggered unless the two queues are paused together. To resume, this is triggered when the last active queue is paused.\r\n\r\nWe found that this issue is coming from the `basic_fetch` strategy overwritten in Sidekiq Pro as we aren't using the `super_fetch` strategy.\r\nSidekiq Pro overwrittes the `Sidekiq::Pro::BasicFetch::queues_cmd` method and left the `@queues` variable empty when only one queue is processed (see `queues = (@original - @paused.to_a).map { |q| \"queue:#{q}\" }`), which then triggers this error from here: https://github.com/mperham/sidekiq/blob/3b5ae30c4e5e9e760268243ab5c14664a2f8d236/lib/sidekiq/fetch.rb#L39\r\n\r\n\r\nBacktrace:\r\n```\r\nRedis::CommandError: ERR wrong number of arguments for 'brpop' command\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis/client.rb:127 :in `call`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis/client.rb:221 :in `block in call_with_timeout`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis/client.rb:295 :in `with_socket_timeout`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis/client.rb:220 :in `call_with_timeout`\r\n218\t\r\n219\t    def call_with_timeout(command, timeout, &blk)\r\n220\t      with_socket_timeout(timeout) do\r\n221\t        call(command, &blk)\r\n222\t      end\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis.rb:1224 :in `block in _bpop`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis.rb:69 :in `block in synchronize`\r\n[PROJECT_ROOT]/vendor/ruby-2.6.6/lib/ruby/2.6.0/monitor.rb:235 :in `mon_synchronize`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis.rb:69 :in `synchronize`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis.rb:1221 :in `_bpop`\r\n [GEM_ROOT]/gems/redis-4.2.2/lib/redis.rb:1266 :in `brpop`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/fetch.rb:39 :in `block in retrieve_work`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq.rb:98 :in `block in redis`\r\n [GEM_ROOT]/gems/connection_pool-2.2.3/lib/connection_pool.rb:63 :in `block (2 levels) in with`\r\n [GEM_ROOT]/gems/connection_pool-2.2.3/lib/connection_pool.rb:62 :in `handle_interrupt`\r\n [GEM_ROOT]/gems/connection_pool-2.2.3/lib/connection_pool.rb:62 :in `block in with`\r\n [GEM_ROOT]/gems/connection_pool-2.2.3/lib/connection_pool.rb:59 :in `handle_interrupt`\r\n [GEM_ROOT]/gems/connection_pool-2.2.3/lib/connection_pool.rb:59 :in `with`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq.rb:95 :in `redis`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/fetch.rb:39 :in `retrieve_work`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/processor.rb:83 :in `get_one`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/processor.rb:95 :in `fetch`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/processor.rb:77 :in `process_one`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/processor.rb:68 :in `run`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/util.rb:15 :in `watchdog`\r\n [GEM_ROOT]/gems/sidekiq-6.1.2/lib/sidekiq/util.rb:24 :in `block in safe_thread`\r\n```\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4825/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/4825/timeline","performed_via_github_app":null,"state_reason":"completed"}