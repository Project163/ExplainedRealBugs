{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5095","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5095/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5095/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5095/events","html_url":"https://github.com/sidekiq/sidekiq/issues/5095","id":1079876196,"node_id":"I_kwDOADDA9M5AXZpk","number":5095,"title":"Cleanup logic not always executed by threads","user":{"login":"teckwan","id":36706647,"node_id":"MDQ6VXNlcjM2NzA2NjQ3","avatar_url":"https://avatars.githubusercontent.com/u/36706647?v=4","gravatar_id":"","url":"https://api.github.com/users/teckwan","html_url":"https://github.com/teckwan","followers_url":"https://api.github.com/users/teckwan/followers","following_url":"https://api.github.com/users/teckwan/following{/other_user}","gists_url":"https://api.github.com/users/teckwan/gists{/gist_id}","starred_url":"https://api.github.com/users/teckwan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/teckwan/subscriptions","organizations_url":"https://api.github.com/users/teckwan/orgs","repos_url":"https://api.github.com/users/teckwan/repos","events_url":"https://api.github.com/users/teckwan/events{/privacy}","received_events_url":"https://api.github.com/users/teckwan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2021-12-14T15:10:29Z","updated_at":"2022-01-24T09:47:43Z","closed_at":"2021-12-14T19:53:38Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.7.4\r\nRails version: 6.1.3\r\nSidekiq / Pro / Enterprise version(s): Sidekiq (6.2.2) Pro (5.2.0)\r\n\r\nHello,\r\nMy organization leverages extensive use of Sidekiq and we have been very satisfied with how it has been performing.\r\nWe have however recently came across an issue. Our stack is deployed on Heroku, and due to business logic necessities,\r\nsome of our job classes have clean-up logic integrated(light operations such as deleting a redis key) to assure\r\ngraceful exit in case of dyno restarts or redeployments.\r\n\r\nMost of our clean-up logic goes by the form of :\r\n```ruby\r\ndef perform\r\n  # do stuff\r\nrescue SignalException\r\n  # clean up\r\n  raise\r\nend\r\n```\r\n\r\nWe have however noticed that this logic is not always run. Through investigation, we found out that this is due to\r\nhow Sidekiq exits. On `hard_shutdown`, `Sidekiq::Shutdown` is raised in the threads and `exit(0)` is called afterwards\r\nwithout waiting for the threads to respond to this error. Some threads are then killed before it can handle the `Sidekiq::Shutdown`.\r\nIâ€™m wondering if it is possible to have a configuration to allow waiting for the response of these threads before exiting\r\n(with the existence of the `wait` parameter in `#kill`), or if you have a better idea on handling job-specific graceful exit logic.\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5095/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5095/timeline","performed_via_github_app":null,"state_reason":"completed"}