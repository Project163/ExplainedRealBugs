{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2985","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2985/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2985/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2985/events","html_url":"https://github.com/sidekiq/sidekiq/issues/2985","id":156573149,"node_id":"MDU6SXNzdWUxNTY1NzMxNDk=","number":2985,"title":"Better integration between Sidekiq thread count and Active Record pool size.","user":{"login":"schneems","id":59744,"node_id":"MDQ6VXNlcjU5NzQ0","avatar_url":"https://avatars.githubusercontent.com/u/59744?v=4","gravatar_id":"","url":"https://api.github.com/users/schneems","html_url":"https://github.com/schneems","followers_url":"https://api.github.com/users/schneems/followers","following_url":"https://api.github.com/users/schneems/following{/other_user}","gists_url":"https://api.github.com/users/schneems/gists{/gist_id}","starred_url":"https://api.github.com/users/schneems/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schneems/subscriptions","organizations_url":"https://api.github.com/users/schneems/orgs","repos_url":"https://api.github.com/users/schneems/repos","events_url":"https://api.github.com/users/schneems/events{/privacy}","received_events_url":"https://api.github.com/users/schneems/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2016-05-24T18:09:06Z","updated_at":"2019-09-13T04:56:18Z","closed_at":"2016-08-01T16:33:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Right now if someone wants to use sidekiq they must configure the number of threads they want to run on or use the default (25). If they are using a database (likely) then to not hit a connection timeout error they will need to have at least as many connections in their database pool as sidekiq threads. Currently they must configure these two values in two different places, database pool in `database.yml` for ActiveRecord, and sidekiq connections either via command line or the sidekiq yml file. This is a problem as it is difficult to remember when you are modifying one value that you need to modify both.\n\nIn Rails 5 there is a default environment variable to configure the number of threads that will be in the database connection pool\n\n``` yml\n# config/database.yml\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\n```\n\nThis convention is used along side of web server configuration values. For example Rails 5 also ships with puma which is configured to read from this value:\n\n``` ruby\n# config/puma.rb\nthreads_count = ENV.fetch(\"RAILS_MAX_THREADS\") { 5 }.to_i\nthreads threads_count, threads_count\n```\n\nIt is common that the number of sidekiq threads run in a \"worker\" process would be greater than the number of web threads used by a server like Puma. For this reason it does not make sense to default the sidekiq connections to `RAILS_MAX_THREADS`. However it would make sense for sidekiq to use this enviornment variable interface and se the environment variable:\n\n``` ruby\n# sidekiq/lib/<somewhere>.rb\nENV[\"RAILS_MAX_THREADS\"] = Sidekiq.number_of_threads #pseudo code\n```\n\nSo now when the application boots in a \"worker\" process via the `sidekiq` command and we know that we are using Rails, the appropriate number of database connections will be configured by default.\n## Potential Problems\n\nThis behavior may be slightly unexpected (for Sidekiq to change an environment variable at boot time) however I believe it is perfectly warranted. As a mitigation step we could detect when an enviornment variable was already set\n\n``` ruby\n# sidekiq/lib/<somewhere>.rb\nputs \"Sidekiq is setting RAILS_MAX_THREADS=#{ Sidekiq.number_of_threads }, was previously #{ ENV['RAILS_MAX_THREADS'] }\"\nENV[\"RAILS_MAX_THREADS\"] = Sidekiq.number_of_threads #pseudo code\n```\n\nA warning or similar would eliminate any confusion. It would also allow the use of `RAILS_MAX_THREADS` for when the web process is booted, and a different configuration option for use when sidekiq is booted.\n\nPeople may want to opt out of this behavior. They can do this by modifying their `database.yml` file to use a different environment variable\n\n``` ruby\n# config/database.yml\n  pool: <%= ENV['SIDEKIQ_CUSTOM_DB_SIZE'] || ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\n```\n\nSo now they have the ability to not rely on the behavior of setting `RAILS_MAX_THREADS`.\n## Recap\n\nRight now if you try the default database size of 5 will artificially limit the default sidekiq size of 25. Applying this change means that Rails applications will work with sidekiq out of the box. It also means that as Sidekiq is scaled up or down that the database size will be set appropriately without additional action (if conventions are being followed). I believe the costs to be minimal and the benefits to outweigh them.\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2985/reactions","total_count":26,"+1":23,"-1":0,"laugh":0,"hooray":3,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/2985/timeline","performed_via_github_app":null,"state_reason":"completed"}