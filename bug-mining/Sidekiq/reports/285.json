{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5336","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5336/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5336/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5336/events","html_url":"https://github.com/sidekiq/sidekiq/issues/5336","id":1241379711,"node_id":"I_kwDOADDA9M5J_fN_","number":5336,"title":"Unusual proposal","user":{"login":"paneq","id":65587,"node_id":"MDQ6VXNlcjY1NTg3","avatar_url":"https://avatars.githubusercontent.com/u/65587?v=4","gravatar_id":"","url":"https://api.github.com/users/paneq","html_url":"https://github.com/paneq","followers_url":"https://api.github.com/users/paneq/followers","following_url":"https://api.github.com/users/paneq/following{/other_user}","gists_url":"https://api.github.com/users/paneq/gists{/gist_id}","starred_url":"https://api.github.com/users/paneq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/paneq/subscriptions","organizations_url":"https://api.github.com/users/paneq/orgs","repos_url":"https://api.github.com/users/paneq/repos","events_url":"https://api.github.com/users/paneq/events{/privacy}","received_events_url":"https://api.github.com/users/paneq/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-05-19T07:56:58Z","updated_at":"2022-05-31T20:41:43Z","closed_at":"2022-05-31T20:41:43Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: unrelated\r\nRails version: 6.05 and many higher and lower versions\r\nSidekiq / Pro / Enterprise version(s): 6.4.1 and higher probably\r\n\r\nHey :)\r\n\r\nI am coming to you with a very unusual story and request and I understand if you decide to reject this idea. But this caused a couple of hour of debugging and firefighting in my team so I hope you can see that I am coming with good intentions.\r\n\r\nImagine you have:\r\n\r\n* a sidekiq job which has this code (for some unrelated reasons):\r\n\r\n```\r\ndef sidekiq_queue\r\n  @sidekiq_queue ||= Sidekiq::Queue.all.find { |q| q.name == 'foo' }\r\nend\r\n```\r\n\r\n* Sidekiq Queue implementation of \r\n\r\n```\r\nclass Queue\r\n    include Enumerable\r\n\r\n    def each\r\n      ...\r\n    end\r\n```\r\n\r\n* Rails active support extension of:\r\n\r\n```\r\nmodule Enumerable\r\n  def as_json(options = nil) #:nodoc:\r\n    to_a.as_json(options)\r\n  end\r\nend\r\n```\r\n\r\n* An exception tracker which tries to a serialize job context (i.e. instance variables) when reporting an error and using sidekiq itself as a delivery mechanism.\r\n\r\nResult:\r\n\r\n* `@sidekiq_queue` ivar can get serialized to hundreds of MBs depending on queue size\r\n* A job of such size is being put to redis to send an error exception to error tracker backend\r\n\r\nAs you can see this is a pretty unusual combination of multiple of things and no-ones fault at particular with sidekiq deserving no blame at all. Sidekiq does not implement `as_json` and yet the class is serializable by taking into account all its elements :(\r\n\r\nI kindly propose you implement something akin to\r\n\r\n```\r\nclass Queue\r\n  include Enumerable\r\n\r\n  def as_json(options = nil) #:nodoc:\r\n    {name: name}\r\n  end\r\nend\r\n```\r\n\r\nto overwrite this problematic rails definition coming from `Enumerable` extension.\r\n\r\nI doubt anyone ever uses `Sidekiq::Queue#as_json` intentionally so I believe it would not be a breaking change.","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5336/reactions","total_count":2,"+1":1,"-1":0,"laugh":1,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/5336/timeline","performed_via_github_app":null,"state_reason":"completed"}