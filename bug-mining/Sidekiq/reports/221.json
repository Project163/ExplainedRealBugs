{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3979","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3979/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3979/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3979/events","html_url":"https://github.com/sidekiq/sidekiq/issues/3979","id":363979018,"node_id":"MDU6SXNzdWUzNjM5NzkwMTg=","number":3979,"title":"Out of space super_fetch issue","user":{"login":"swistak35","id":332289,"node_id":"MDQ6VXNlcjMzMjI4OQ==","avatar_url":"https://avatars.githubusercontent.com/u/332289?v=4","gravatar_id":"","url":"https://api.github.com/users/swistak35","html_url":"https://github.com/swistak35","followers_url":"https://api.github.com/users/swistak35/followers","following_url":"https://api.github.com/users/swistak35/following{/other_user}","gists_url":"https://api.github.com/users/swistak35/gists{/gist_id}","starred_url":"https://api.github.com/users/swistak35/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/swistak35/subscriptions","organizations_url":"https://api.github.com/users/swistak35/orgs","repos_url":"https://api.github.com/users/swistak35/repos","events_url":"https://api.github.com/users/swistak35/events{/privacy}","received_events_url":"https://api.github.com/users/swistak35/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-09-26T11:21:04Z","updated_at":"2018-09-28T18:22:28Z","closed_at":"2018-09-28T18:22:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ruby version: 2.4.3\r\nSidekiq / Pro / Enterprise version(s): Sidekiq 5.1.3 / Pro 4.0.3 / Ent 1.7.1\r\n\r\nHi, we had recently an outage which caused some of the sidekiq jobs to be lost.\r\nWe have `super_fetch!` enable and we can see it's working (logs say it's working, and if we observe redis keys we see queues with `sq` in it).\r\n\r\nThe outage was trivial, one of our sidekiq nodes went out of space. After that the sidekiq process still worked, it was picking up the jobs and sending them into void - we have 3 nodes with 25 workers each, and from our other logging mechanisms (on web workers, and on sidekiq nodes which were working fine) we've calculated that we've lost about ~27% of the jobs (we were thankfully able to retrieve and retry almost all of them).\r\n\r\nI haven't tried to reproduce it exaclty (because out-of-space environment being troublesome to set up), but we've tried to retrace the problem in sidekiq code.\r\nJob disappearing could happen if the `ack` flag was set to true in `Processor#process`, and the error was raised in that part of the code: https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/processor.rb#L166-L168\r\n\r\nThis is because we have later `ensure` block ( https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/processor.rb#L179-L180 ) which acknowledges the job, which in `super_fetch!` version means removing the job from the private queue.\r\n\r\nIn general, if any error is raised (including \"out ouf space\" one), the retry mechanism in dispatch, either global or local ( https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/processor.rb#L136-L138 ), should retry the job. However the retry mechanism itself, just before it adds a job to the queue, has a logger ( https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/job_retry.rb#L161-L166 ). At this point, if the disk is out of space, the error is raised in `JobRetry#attempt_retry`, then `JobRetry#local`, and then similarly in `global` `JobRetry`, going back to `Processor#process` handler for any `Exception`. After that, the control flow of the code is jumping to the `ensure` and acknowledging the job. The result is, that the job isn't scheduled to be retried, isn't present in the logs (because we're out of space), but the job is acknowledged and removed from the private queue.\r\n\r\nIt would be great to have that use-case covered in the future. :)\r\n","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3979/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3979/timeline","performed_via_github_app":null,"state_reason":"completed"}