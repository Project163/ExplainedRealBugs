[{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1995246884","html_url":"https://github.com/sidekiq/sidekiq/issues/6227#issuecomment-1995246884","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6227","id":1995246884,"node_id":"IC_kwDOADDA9M527Q0k","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-03-13T18:14:18Z","updated_at":"2024-03-13T18:14:55Z","body":"Here's the results of tuning the operation. Mainly I've restructured the code to take advantage of the fact that HSET can accept multiple key/value pairs. Today the code only pushes one at a time which leads to a lot of time waiting on network latency. By restructuring, we greatly reduce the amount of time spent setting the hash data and so we greatly reduce the window of time where data can be orphaned.\r\n\r\nOriginal / Tuned has 25 jobs in progress. The small variant only has one job in progress.\r\n\r\n```\r\nCalculating -------------------------------------\r\n            original      6.899k (± 0.8%) i/s -     35.100k in   5.087657s\r\n               tuned      9.970k (± 1.0%) i/s -     50.745k in   5.090055s\r\n      original/small     21.431k (± 1.4%) i/s -    107.250k in   5.005571s\r\n         tuned/small     21.542k (± 0.7%) i/s -    109.140k in   5.066537s\r\n```\r\n\r\nTime constructing hash (and thus the size of the race condition window)\r\n\r\nBefore: 2.37965\r\nAfter: 0.20298\r\n\r\nThat's a 90% drop, a fantastic result.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1995246884/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1995277543","html_url":"https://github.com/sidekiq/sidekiq/issues/6227#issuecomment-1995277543","issue_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/6227","id":1995277543,"node_id":"IC_kwDOADDA9M527YTn","user":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-03-13T18:23:13Z","updated_at":"2024-03-13T18:23:13Z","body":"And with that optimization, I think we can move back to use MULTI, removing the race condition completely.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/comments/1995277543/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":12107600585,"node_id":"CE_lADOADDA9M6CNfLjzwAAAALRq1LJ","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/12107600585","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"d12fa084984fccec3dfb3771ac6a8ef525a13bd9","commit_url":"https://api.github.com/repos/sidekiq/sidekiq/commits/d12fa084984fccec3dfb3771ac6a8ef525a13bd9","created_at":"2024-03-13T18:29:07Z","state_reason":null,"performed_via_github_app":null},{"id":12240200807,"node_id":"REFE_lADOADDA9M6CNfLjzwAAAALZkqRn","url":"https://api.github.com/repos/sidekiq/sidekiq/issues/events/12240200807","actor":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"d12fa084984fccec3dfb3771ac6a8ef525a13bd9","commit_url":"https://api.github.com/repos/sidekiq/sidekiq/commits/d12fa084984fccec3dfb3771ac6a8ef525a13bd9","created_at":"2024-03-25T20:12:15Z","performed_via_github_app":null}]