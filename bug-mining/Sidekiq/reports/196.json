{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3519","repository_url":"https://api.github.com/repos/sidekiq/sidekiq","labels_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3519/labels{/name}","comments_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3519/comments","events_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3519/events","html_url":"https://github.com/sidekiq/sidekiq/issues/3519","id":236583828,"node_id":"MDU6SXNzdWUyMzY1ODM4Mjg=","number":3519,"title":"`status.complete?` overall batch never returns true, even if children are `complete?`","user":{"login":"srpouyet","id":196046,"node_id":"MDQ6VXNlcjE5NjA0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/196046?v=4","gravatar_id":"","url":"https://api.github.com/users/srpouyet","html_url":"https://github.com/srpouyet","followers_url":"https://api.github.com/users/srpouyet/followers","following_url":"https://api.github.com/users/srpouyet/following{/other_user}","gists_url":"https://api.github.com/users/srpouyet/gists{/gist_id}","starred_url":"https://api.github.com/users/srpouyet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/srpouyet/subscriptions","organizations_url":"https://api.github.com/users/srpouyet/orgs","repos_url":"https://api.github.com/users/srpouyet/repos","events_url":"https://api.github.com/users/srpouyet/events{/privacy}","received_events_url":"https://api.github.com/users/srpouyet/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-06-16T20:19:50Z","updated_at":"2017-06-21T20:11:09Z","closed_at":"2017-06-21T20:11:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi Mike or colleague,\r\n\r\nI'm implementing a Sidekiq Pro batch using [Really Complex Workflows with Batches](https://github.com/mperham/sidekiq/wiki/Really-Complex-Workflows-with-Batches) as a starting point. At the moment this has got me stumped: `status.complete?` of the \"overall\" batch never returns `true`, even though its child batches do. \r\n\r\nYou can find a testcase in this [gist](https://gist.github.com/srpouyet/68b634626d61c4539bf0e6c1de734169).\r\n\r\nThe only strange thing I noticed is that one job seems to be deleted:\r\n\r\n```\r\n=> #<Sidekiq::Batch::Status:0x007f95c7fc58a0\r\n @bid=\"A5IBIDKKBY0pew\",\r\n @completed=0,\r\n @failures=0,\r\n @pending=0,\r\n @props=\r\n  {\"kids\"=>\"3\",\r\n   \"created_at\"=>\"1497539062.073876\",\r\n   \"description\"=>\"Overall batch\",\r\n   \"total\"=>\"1\",\r\n   \"deleted\"=>\"1\",\r\n   \"pending\"=>\"0\",\r\n   \"callbacks\"=>\"{\\\"complete\\\":[{\\\"WorkFlowCallbacks\\\":{}}],\\\"success\\\":[{\\\"WorkFlowCallbacks\\\":{}}]}\"}\r\n```\r\n\r\nHave I missed something, is this expected behaviour or is something amiss?\r\n\r\nTested with ruby 2.3.1p112, sidekiq 4.2.10, sidekiq-pro 3.4.5, Redis 3.2.9, Rails 4.2.8\r\n\r\nSidekiq initializer:\r\n```\r\nSidekiq.configure_server do |config|\r\n\t# TODO: Use unix socket instead of TCP with { path: \"/var/run/redis/redis.sock\", db: 12, namespace: \"#{Rails.env}:sidekiq\" } option.\r\n\tif Rails.env.production? || Rails.env.demo?\r\n\t\tconfig.redis = { url: ENV['REDIS_WORKER_URL'] }\r\n\telse\r\n\t\tconfig.redis = { url: ENV['REDIS_WORKER_URL'], namespace: \":#{Rails.env}:sidekiq\" }\r\n\tend\r\nend\r\n\r\n\r\nSidekiq.configure_client do |config|\r\n\tif Rails.env.production? || Rails.env.demo?\r\n\t\tconfig.redis = { url: ENV['REDIS_WORKER_URL'] }\r\n\telse\r\n\t\tconfig.redis = { url: ENV['REDIS_WORKER_URL'], namespace: \":#{Rails.env}:sidekiq\" }\r\n\tend\r\nend\r\n\r\nSidekiq.default_worker_options = { 'backtrace' => true }\r\n\r\n# Perform Sidekiq jobs immediately in development,\r\n# so you don't have to run a separate process.\r\n# You'll also benefit from code reloading.\r\n# if Rails.env.development?\r\n# \trequire 'sidekiq/testing'\r\n# \tSidekiq::Testing.inline!\r\n# end\r\n```\r\n\r\nThank you for looking into this!","closed_by":{"login":"mperham","id":2911,"node_id":"MDQ6VXNlcjI5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/2911?v=4","gravatar_id":"","url":"https://api.github.com/users/mperham","html_url":"https://github.com/mperham","followers_url":"https://api.github.com/users/mperham/followers","following_url":"https://api.github.com/users/mperham/following{/other_user}","gists_url":"https://api.github.com/users/mperham/gists{/gist_id}","starred_url":"https://api.github.com/users/mperham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mperham/subscriptions","organizations_url":"https://api.github.com/users/mperham/orgs","repos_url":"https://api.github.com/users/mperham/repos","events_url":"https://api.github.com/users/mperham/events{/privacy}","received_events_url":"https://api.github.com/users/mperham/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3519/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sidekiq/sidekiq/issues/3519/timeline","performed_via_github_app":null,"state_reason":"completed"}