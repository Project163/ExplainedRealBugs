{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/3673","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3673/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3673/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3673/events","html_url":"https://github.com/launchbadge/sqlx/issues/3673","id":2777505574,"node_id":"I_kwDODb6dM86ljV8m","number":3673,"title":"Parallel workers not used on Postgres","user":{"login":"twitu","id":23196890,"node_id":"MDQ6VXNlcjIzMTk2ODkw","avatar_url":"https://avatars.githubusercontent.com/u/23196890?v=4","gravatar_id":"","url":"https://api.github.com/users/twitu","html_url":"https://github.com/twitu","followers_url":"https://api.github.com/users/twitu/followers","following_url":"https://api.github.com/users/twitu/following{/other_user}","gists_url":"https://api.github.com/users/twitu/gists{/gist_id}","starred_url":"https://api.github.com/users/twitu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/twitu/subscriptions","organizations_url":"https://api.github.com/users/twitu/orgs","repos_url":"https://api.github.com/users/twitu/repos","events_url":"https://api.github.com/users/twitu/events{/privacy}","received_events_url":"https://api.github.com/users/twitu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1757378993,"node_id":"MDU6TGFiZWwxNzU3Mzc4OTkz","url":"https://api.github.com/repos/launchbadge/sqlx/labels/bug","name":"bug","color":"e11d21","default":true,"description":""},{"id":1757436691,"node_id":"MDU6TGFiZWwxNzU3NDM2Njkx","url":"https://api.github.com/repos/launchbadge/sqlx/labels/db:postgres","name":"db:postgres","color":"336791","default":false,"description":"Related to PostgreSQL"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-01-09T11:00:33Z","updated_at":"2025-04-14T04:55:15Z","closed_at":"2025-04-14T04:55:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### I have found these related issues/pull requests\r\n\r\nI could not find any issues in sqlx repo related to parallel workers not being launched. However, this issue seems somewhat related to https://github.com/brianc/node-postgres/issues/3344. The issue is showing very similar logs as the ones as I'm seeing and mentions that streaming query does not use parallel workers for some reason.\r\n\r\n### Description\r\n\r\nSqlx query is not taking advantage of parallel workers decided by query plan. It is taking double the time to execute query than other tools which are using parallel workers.\r\n\r\n### Reproduction steps\r\n\r\n```rust\r\nuse eyre::Result;\r\nuse sqlx::{postgres::PgPoolOptions, Executor, Row};\r\nuse tracing;\r\n\r\n#[tokio::main]\r\nasync fn main() -> Result<()> {\r\n    // Connect to database\r\n    let url = <TODO>;\r\n\r\n    let pool = PgPoolOptions::new()\r\n        .max_connections(5)\r\n        .after_connect(|conn, _| {\r\n            Box::pin(async move {\r\n                tracing::info!(\"New connection established\");\r\n                // Enable statement logging\r\n                conn.execute(\"SET log_statement = 'all'\").await?;\r\n                conn.execute(\"LOAD 'auto_explain'\").await?;\r\n                conn.execute(\"SET auto_explain.log_min_duration = '0ms'\")\r\n                    .await?;\r\n                conn.execute(\"SET auto_explain.log_analyze = 'on'\").await?;\r\n                conn.execute(\"SET auto_explain.log_buffers = 'on'\").await?;\r\n                conn.execute(\"SET auto_explain.log_timing = 'on'\").await?;\r\n\r\n                let settings = conn.fetch_all(\"SHOW ALL\").await?;\r\n                tracing::info!(\"PostgreSQL settings: {:?}\", settings);\r\n                Ok(())\r\n            })\r\n        })\r\n        .connect(url)\r\n        .await\r\n        .map_err(|e| eyre::eyre!(\"Failed to create database pool: {}\", e))?;\r\n\r\n    // Create a wide table with many columns\r\n    sqlx::query(\r\n        r#\"\r\n        CREATE TABLE IF NOT EXISTS wide_table (\r\n            id SERIAL PRIMARY KEY,\r\n            col1 TEXT, col2 TEXT, col3 TEXT, col4 TEXT, col5 TEXT,\r\n            col6 TEXT, col7 TEXT, col8 TEXT, col9 TEXT, col10 TEXT,\r\n            value INTEGER\r\n        )\"#,\r\n    )\r\n    .execute(&pool)\r\n    .await?;\r\n\r\n    // Insert dummy data (1M rows to force parallel scan)\r\n    sqlx::query(\r\n        r#\"\r\n        INSERT INTO wide_table (col1, col2, col3, col4, col5, col6, col7, col8, col9, col10, value)\r\n        SELECT \r\n            md5(random()::text), md5(random()::text), md5(random()::text),\r\n            md5(random()::text), md5(random()::text), md5(random()::text),\r\n            md5(random()::text), md5(random()::text), md5(random()::text),\r\n            md5(random()::text), floor(random() * 1000000)::int\r\n        FROM generate_series(1, 1000000)\"#,\r\n    )\r\n    .execute(&pool)\r\n    .await?;\r\n\r\n    // Query that should trigger parallel scan\r\n    println!(\"Executing query with sqlx...\");\r\n    let start = std::time::Instant::now();\r\n    let result = sqlx::query(\r\n        r#\"\r\n        SELECT sum(value) \r\n        FROM wide_table \r\n        WHERE value > 50000000\"#,\r\n    )\r\n    .fetch_optional(&pool)\r\n    .await?;\r\n\r\n    println!(\"Query took: {:?}\", start.elapsed());\r\n    println!(\"Result: {}\", result.is_some());\r\n\r\n    // Compare with direct psql\r\n    println!(\"\\nTo compare, run this in psql:\");\r\n    println!(\r\n        r#\"\r\n    EXPLAIN (ANALYZE, BUFFERS)\r\n    SELECT sum(value) FROM wide_table WHERE value > 500000;\r\n    \"#\r\n    );\r\n\r\n    Ok(())\r\n}\r\n```\r\n\r\nDb logs from running query with sqlx with the above script\r\n```\r\n2025-01-09 10:42:13.363 GMT [24484] LOG:  execute sqlx_s_2: \r\n\t        SELECT sum(value) \r\n\t        FROM wide_table \r\n\t        WHERE value > 50000000\r\n2025-01-09 10:42:13.612 GMT [24484] LOG:  duration: 249.180 ms  plan:\r\n\tQuery Text: \r\n\t        SELECT sum(value) \r\n\t        FROM wide_table \r\n\t        WHERE value > 50000000\r\n\tFinalize Aggregate  (cost=54440.44..54440.45 rows=1 width=8) (actual time=249.176..249.177 rows=1 loops=1)\r\n\t  Buffers: shared hit=887 read=46733 dirtied=46748 written=46733\r\n\t  ->  Gather  (cost=54440.22..54440.43 rows=2 width=8) (actual time=249.174..249.174 rows=1 loops=1)\r\n\t        Workers Planned: 2\r\n\t        Workers Launched: 0\r\n\t        Buffers: shared hit=887 read=46733 dirtied=46748 written=46733\r\n\t        ->  Partial Aggregate  (cost=53440.22..53440.23 rows=1 width=8) (actual time=249.173..249.174 rows=1 loops=1)\r\n\t              Buffers: shared hit=887 read=46733 dirtied=46748 written=46733\r\n\t              ->  Parallel Seq Scan on wide_table  (cost=0.00..53076.46 rows=145505 width=4) (actual time=249.171..249.171 rows=0 loops=1)\r\n\t                    Filter: (value > 50000000)\r\n\t                    Rows Removed by Filter: 1000000\r\n\t                    Buffers: shared hit=887 read=46733 dirtied=46748 written=46733\r\n```\r\n\r\nDb logs from running query with psql `Workers Launched: 2`\r\n```\r\n\tQuery Text: LOAD 'auto_explain';\r\n\tSET auto_explain.log_min_duration = '50ms';\r\n\tSET auto_explain.log_analyze = 'on';\r\n\tSET auto_explain.log_buffers = 'on';\r\n\tSET auto_explain.log_timing = 'on';\r\n\tEXPLAIN (ANALYZE, BUFFERS) SELECT sum(value) FROM wide_table WHERE value > 50000000\r\n\t\r\n\tFinalize Aggregate  (cost=53828.59..53828.60 rows=1 width=8) (actual time=231.420..232.170 rows=1 loops=1)\r\n\t  Buffers: shared hit=732 read=46888\r\n\t  ->  Gather  (cost=53828.38..53828.59 rows=2 width=8) (actual time=231.352..232.164 rows=3 loops=1)\r\n\t        Workers Planned: 2\r\n\t        Workers Launched: 2\r\n\t        Buffers: shared hit=732 read=46888\r\n\t        ->  Partial Aggregate  (cost=52828.38..52828.39 rows=1 width=8) (actual time=227.663..227.663 rows=1 loops=3)\r\n\t              Buffers: shared hit=732 read=46888\r\n\t              ->  Parallel Seq Scan on wide_table  (cost=0.00..52828.27 rows=42 width=4) (actual time=227.659..227.660 rows=0 loops=3)\r\n\t                    Filter: (value > 50000000)\r\n\t                    Rows Removed by Filter: 333333\r\n\t                    Buffers: shared hit=732 read=46888\r\n```\t\r\n\r\n### SQLx version\r\n\r\n\"0.8.2\"\r\n\r\n### Enabled SQLx features\r\n\r\n\"runtime-tokio-native-tls\", \"postgres\", \"time\"\r\n\r\n### Database server and version\r\n\r\n{   \"version\": \"PostgreSQL 14.5 on aarch64-apple-darwin21.3.0, compiled by clang version 11.1.0, 64-bit\" }\r\n\r\n### Operating system\r\n\r\nMacOS 15.11\r\n\r\n### Rust version\r\n\r\nrustc 1.82.0 (f6e511eec 2024-10-15) (built from a source tarball)","closed_by":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/3673/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3673/timeline","performed_via_github_app":null,"state_reason":"completed"}