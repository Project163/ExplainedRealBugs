{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/3200","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3200/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3200/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3200/events","html_url":"https://github.com/launchbadge/sqlx/issues/3200","id":2246119425,"node_id":"I_kwDODb6dM86F4RAB","number":3200,"title":"SQLx CLI error: Using @variable in WHERE statement causes \"Illegal mix of collations\" ","user":{"login":"LucHayward","id":20114222,"node_id":"MDQ6VXNlcjIwMTE0MjIy","avatar_url":"https://avatars.githubusercontent.com/u/20114222?v=4","gravatar_id":"","url":"https://api.github.com/users/LucHayward","html_url":"https://github.com/LucHayward","followers_url":"https://api.github.com/users/LucHayward/followers","following_url":"https://api.github.com/users/LucHayward/following{/other_user}","gists_url":"https://api.github.com/users/LucHayward/gists{/gist_id}","starred_url":"https://api.github.com/users/LucHayward/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LucHayward/subscriptions","organizations_url":"https://api.github.com/users/LucHayward/orgs","repos_url":"https://api.github.com/users/LucHayward/repos","events_url":"https://api.github.com/users/LucHayward/events{/privacy}","received_events_url":"https://api.github.com/users/LucHayward/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1757378993,"node_id":"MDU6TGFiZWwxNzU3Mzc4OTkz","url":"https://api.github.com/repos/launchbadge/sqlx/labels/bug","name":"bug","color":"e11d21","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-04-16T13:49:16Z","updated_at":"2025-07-08T07:39:49Z","closed_at":"2025-07-08T07:39:49Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Description\r\nWhen using the sqlx CLI to run migrations on MariaDB, using variables in where statements results in a mixed collation error. \r\nThis does not occur if you run the sql queries \"manually\".\r\n\r\nUsing the minimal example below you will see:\r\n```error: while executing migrations: error returned from database: 1267 (HY000): Illegal mix of collations (utf8mb4_general_ci,IMPLICIT) and (utf8mb4_unicode_ci,IMPLICIT) for operation '='```\r\n\r\nThis can be resolved by forcing the collation to be utf8mb4_unicode_ci for the given statement.\r\n\r\n### Minimal Reproduction\r\nPlace these two files into `./migrations/`\r\n**1_collate_example.up.sql**\r\n```sql\r\nCREATE TABLE users\r\n(\r\n    `id`                     BIGINT AUTO_INCREMENT,\r\n    `username`               VARCHAR(128) NOT NULL,\r\n    PRIMARY KEY (id)\r\n);\r\n```\r\n\r\n**2_collate_example.up.sql**\r\n```sql\r\nSET @myvar := 'test@test.com';\r\nselect id from users where username = @myvar;\r\n```\r\n\r\nAssuming you have a mysql/MariaDB server setup with a user, the following will create and run our migrations.\r\n```sh\r\nexport DATABASE_URL=mysql://zulzi:zulzi@localhost/collate-example\r\nsqlx database drop -y\r\nsqlx database create\r\nsqlx migrate run\r\n```\r\n\r\nA working example for **2_collate_example.up.sql** would be\r\n```sql\r\nSET @myvar := 'test@test.com';\r\nselect id from users where username = @myvar COLLATE utf8mb4_unicode_ci;\r\n```\r\nOR \r\n```sql\r\nselect id from users where username = 'test@test.com';\r\n```\r\n\r\n### Info\r\n* SQLx version: sqlx-cli 0.7.4\r\n* SQLx features enabled: Don't think this applies\r\n* Database server and version: mysql from 11.3.2-MariaDB, client 15.2 for osx10.19 (arm64) using  EditLine wrapper\r\n* Operating system: macOS 14.4.1 (23E224)\r\n* `rustc --version`: rustc 1.77.1 (7cf61ebde 2024-03-27)\r\n","closed_by":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/3200/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/3200/timeline","performed_via_github_app":null,"state_reason":"completed"}