{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/30","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/30/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/30/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/30/events","html_url":"https://github.com/launchbadge/sqlx/issues/30","id":545715118,"node_id":"MDU6SXNzdWU1NDU3MTUxMTg=","number":30,"title":"buffer reset the indexes error","user":{"login":"liangyongrui","id":24314057,"node_id":"MDQ6VXNlcjI0MzE0MDU3","avatar_url":"https://avatars.githubusercontent.com/u/24314057?v=4","gravatar_id":"","url":"https://api.github.com/users/liangyongrui","html_url":"https://github.com/liangyongrui","followers_url":"https://api.github.com/users/liangyongrui/followers","following_url":"https://api.github.com/users/liangyongrui/following{/other_user}","gists_url":"https://api.github.com/users/liangyongrui/gists{/gist_id}","starred_url":"https://api.github.com/users/liangyongrui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liangyongrui/subscriptions","organizations_url":"https://api.github.com/users/liangyongrui/orgs","repos_url":"https://api.github.com/users/liangyongrui/repos","events_url":"https://api.github.com/users/liangyongrui/events{/privacy}","received_events_url":"https://api.github.com/users/liangyongrui/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1757378993,"node_id":"MDU6TGFiZWwxNzU3Mzc4OTkz","url":"https://api.github.com/repos/launchbadge/sqlx/labels/bug","name":"bug","color":"e11d21","default":true,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2020-01-06T13:01:59Z","updated_at":"2020-01-06T19:13:48Z","closed_at":"2020-01-06T18:54:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"dependencies\r\n\r\n```toml\r\n[dependencies.sqlx]\r\ngit = 'https://github.com/launchbadge/sqlx.git'\r\nfeatures = ['mysql']\r\n```\r\n\r\ncode\r\n\r\n```rust\r\nsqlx::query(\r\n        \"SELECT ... from ...\r\n        where id = ?\",\r\n    )\r\n    .bind(id)\r\n    .fetch_optional(&mut *conn)\r\n    .await?\r\n    .map(|row| .......)\r\n```\r\n\r\nerror backtrace\r\n\r\n```text\r\nthread 'test_schedule_job' panicked at 'assertion failed: `(left == right)`\r\n  left: `8174`,\r\n right: `8192`', /Users/liangyongrui/.cargo/git/checkouts/sqlx-f05f33ba4f5c3036/5c532a8/sqlx-core/src/io/buf_stream.rs:77:17\r\nstack backtrace:\r\n   0: <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt\r\n   1: core::fmt::write\r\n   2: std::io::Write::write_fmt\r\n   3: std::panicking::default_hook::{{closure}}\r\n   4: std::panicking::default_hook\r\n   5: std::panicking::rust_panic_with_hook\r\n   6: std::panicking::continue_panic_fmt\r\n   7: std::panicking::begin_panic_fmt\r\n   8: sqlx_core::io::buf_stream::BufStream<S>::peek::{{closure}}\r\n   9: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  10: std::future::set_task_context\r\n  11: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  12: std::future::poll_with_tls_context::{{closure}}\r\n  13: std::future::get_task_context\r\n  14: std::future::poll_with_tls_context\r\n  15: sqlx_core::mysql::connection::MySqlConnection::try_receive::{{closure}}\r\n  16: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  17: std::future::set_task_context\r\n  18: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  19: std::future::poll_with_tls_context::{{closure}}\r\n  20: std::future::get_task_context\r\n  21: std::future::poll_with_tls_context\r\n  22: sqlx_core::mysql::connection::MySqlConnection::receive::{{closure}}\r\n  23: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  24: std::future::set_task_context\r\n  25: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  26: std::future::poll_with_tls_context::{{closure}}\r\n  27: std::future::get_task_context\r\n  28: std::future::poll_with_tls_context\r\n  29: sqlx_core::mysql::executor::<impl sqlx_core::mysql::connection::MySqlConnection>::prepare_with_cache::{{closure}}\r\n  30: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  31: std::future::set_task_context\r\n  32: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  33: std::future::poll_with_tls_context::{{closure}}\r\n  34: std::future::get_task_context\r\n  35: std::future::poll_with_tls_context\r\n  36: sqlx_core::mysql::executor::<impl sqlx_core::mysql::connection::MySqlConnection>::fetch::{{closure}}\r\n  37: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  38: std::future::set_task_context\r\n  39: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  40: <async_stream::async_stream::AsyncStream<T,U> as futures_core::stream::Stream>::poll_next\r\n  41: <core::pin::Pin<P> as futures_core::stream::Stream>::poll_next\r\n  42: <S as futures_core::stream::TryStream>::try_poll_next\r\n  43: futures_util::stream::try_stream::TryStreamExt::try_poll_next_unpin\r\n  44: <futures_util::stream::try_stream::try_next::TryNext<St> as core::future::future::Future>::poll\r\n  45: std::future::poll_with_tls_context::{{closure}}\r\n  46: std::future::get_task_context\r\n  47: std::future::poll_with_tls_context\r\n  48: sqlx_core::executor::Executor::fetch_optional::{{closure}}\r\n  49: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  50: std::future::set_task_context\r\n  51: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  52: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n  53: std::future::poll_with_tls_context::{{closure}}\r\n  54: std::future::get_task_context\r\n  55: std::future::poll_with_tls_context\r\n  56: sqlx_core::query::Query<DB,P>::fetch_optional::{{closure}}\r\n  57: <std::future::GenFuture<T> as core::future::future::Future>::poll::{{closure}}\r\n  58: std::future::set_task_context\r\n  59: <std::future::GenFuture<T> as core::future::future::Future>::poll\r\n  60: std::future::poll_with_tls_context::{{closure}}\r\n  61: std::future::get_task_context\r\n  62: std::future::poll_with_tls_context\r\n...\r\n```\r\n\r\nbuf_stream.rs 77:17\r\n\r\n```rust\r\n            // If we are out of space to write to in the read buffer,\r\n            // we reset the indexes\r\n            if self.rbuf.len() < (self.rbuf_windex + cnt) {\r\n                // TODO: This assumes that all data is consumed when we need to re-allocate\r\n                debug_assert_eq!(self.rbuf_rindex, self.rbuf_windex);\r\n\r\n                self.rbuf_rindex = 0;\r\n                self.rbuf_windex = 0;\r\n            }\r\n```","closed_by":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/30/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/30/timeline","performed_via_github_app":null,"state_reason":"completed"}