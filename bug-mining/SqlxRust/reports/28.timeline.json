[{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/649893281","html_url":"https://github.com/launchbadge/sqlx/issues/447#issuecomment-649893281","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447","id":649893281,"node_id":"MDEyOklzc3VlQ29tbWVudDY0OTg5MzI4MQ==","user":{"login":"Cocalus","id":23244939,"node_id":"MDQ6VXNlcjIzMjQ0OTM5","avatar_url":"https://avatars.githubusercontent.com/u/23244939?v=4","gravatar_id":"","url":"https://api.github.com/users/Cocalus","html_url":"https://github.com/Cocalus","followers_url":"https://api.github.com/users/Cocalus/followers","following_url":"https://api.github.com/users/Cocalus/following{/other_user}","gists_url":"https://api.github.com/users/Cocalus/gists{/gist_id}","starred_url":"https://api.github.com/users/Cocalus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cocalus/subscriptions","organizations_url":"https://api.github.com/users/Cocalus/orgs","repos_url":"https://api.github.com/users/Cocalus/repos","events_url":"https://api.github.com/users/Cocalus/events{/privacy}","received_events_url":"https://api.github.com/users/Cocalus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-06-26T01:10:04Z","updated_at":"2020-06-26T01:26:48Z","body":"After looking around a bit more, it looks like tokio-postgres (with it's own [complications](https://github.com/sfackler/rust-postgres/issues/591)) returns a Notifications and Notices enum\r\nhttps://docs.rs/tokio-postgres/0.5.4/tokio_postgres/enum.AsyncMessage.html\r\nSo the simplest solution I can think if is to replace PgNotifice with PgAsyncMessage in PgListen where\r\n```\r\nenum PgAsyncMessage {\r\n    Notice(DbError), // I don't think there's an equivalent in SQLx, but there probably should be if tokio-postgres has it\r\n    Notification(PgNotification),\r\n    ConnectionReset, //Or maybe some other name that indicates it should get remade \r\n}\r\n```\r\n\r\nThen when the connection gets reset in PgNotification::recv a ConnectionRest  can be returned. I think adding the Notice may also resolve the comment on \r\nhttps://github.com/launchbadge/sqlx/blob/master/sqlx-core/src/postgres/connection/stream.rs#L105 \r\n\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/649893281/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Cocalus","id":23244939,"node_id":"MDQ6VXNlcjIzMjQ0OTM5","avatar_url":"https://avatars.githubusercontent.com/u/23244939?v=4","gravatar_id":"","url":"https://api.github.com/users/Cocalus","html_url":"https://github.com/Cocalus","followers_url":"https://api.github.com/users/Cocalus/followers","following_url":"https://api.github.com/users/Cocalus/following{/other_user}","gists_url":"https://api.github.com/users/Cocalus/gists{/gist_id}","starred_url":"https://api.github.com/users/Cocalus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cocalus/subscriptions","organizations_url":"https://api.github.com/users/Cocalus/orgs","repos_url":"https://api.github.com/users/Cocalus/repos","events_url":"https://api.github.com/users/Cocalus/events{/privacy}","received_events_url":"https://api.github.com/users/Cocalus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/650690498","html_url":"https://github.com/launchbadge/sqlx/issues/447#issuecomment-650690498","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447","id":650690498,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MDY5MDQ5OA==","user":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-06-28T04:11:56Z","updated_at":"2020-06-28T04:11:56Z","body":"Currently the usage looks like this:\r\n\r\n```rust\r\nloop {\r\n  let notification = listener.recv().await?;\r\n  \r\n  // handle notification\r\n}\r\n```\r\n\r\nIt would be simple to change it like this:\r\n\r\n```rust\r\nloop {\r\n  while let Some(notification) = listener.recv().await? {\r\n    // handle notification\r\n  }\r\n\r\n  // connection was lost, do something fun and continue \r\n  // to re-connect and start the receive loop over\r\n}\r\n```\r\n\r\nTo keep it backwards-compatible it could make sense to call this variant `.try_recv()`.\r\n\r\n---\r\n\r\n> So erroring early would be better for this use case but there maybe others I'm unaware of that don't want that.\r\n\r\nWe emit messages immediately so it does error early currently. If you reuse the listener as a connection ( for executing queries ), then messages can be buffered though.\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/650690498/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/650698797","html_url":"https://github.com/launchbadge/sqlx/issues/447#issuecomment-650698797","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447","id":650698797,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MDY5ODc5Nw==","user":{"login":"Cocalus","id":23244939,"node_id":"MDQ6VXNlcjIzMjQ0OTM5","avatar_url":"https://avatars.githubusercontent.com/u/23244939?v=4","gravatar_id":"","url":"https://api.github.com/users/Cocalus","html_url":"https://github.com/Cocalus","followers_url":"https://api.github.com/users/Cocalus/followers","following_url":"https://api.github.com/users/Cocalus/following{/other_user}","gists_url":"https://api.github.com/users/Cocalus/gists{/gist_id}","starred_url":"https://api.github.com/users/Cocalus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cocalus/subscriptions","organizations_url":"https://api.github.com/users/Cocalus/orgs","repos_url":"https://api.github.com/users/Cocalus/repos","events_url":"https://api.github.com/users/Cocalus/events{/privacy}","received_events_url":"https://api.github.com/users/Cocalus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-06-28T05:19:11Z","updated_at":"2020-06-28T05:19:11Z","body":"That looks nicer than my suggestion. I'm fine with try_recv but the regular recv's docs should have a note about potential lost notifications pointing at try_recv.\r\n\r\nIt looks like the only way for me to detect the error is to consume the notifications sitting in the queue first. Early exit would mean that when connection dies it purges the queue. It can done with the suggested API, the user needs a second queue aggressively pushed to by try_recv, which the user can purge that queue when try_recv errors.\r\n\r\nSo I would be perfectly happy with try_recv.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/650698797/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Cocalus","id":23244939,"node_id":"MDQ6VXNlcjIzMjQ0OTM5","avatar_url":"https://avatars.githubusercontent.com/u/23244939?v=4","gravatar_id":"","url":"https://api.github.com/users/Cocalus","html_url":"https://github.com/Cocalus","followers_url":"https://api.github.com/users/Cocalus/followers","following_url":"https://api.github.com/users/Cocalus/following{/other_user}","gists_url":"https://api.github.com/users/Cocalus/gists{/gist_id}","starred_url":"https://api.github.com/users/Cocalus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cocalus/subscriptions","organizations_url":"https://api.github.com/users/Cocalus/orgs","repos_url":"https://api.github.com/users/Cocalus/repos","events_url":"https://api.github.com/users/Cocalus/events{/privacy}","received_events_url":"https://api.github.com/users/Cocalus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3562039554,"node_id":"MDExOkNsb3NlZEV2ZW50MzU2MjAzOTU1NA==","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/3562039554","actor":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"49ffcf6f46b3ea27353b884fc7a73ba6be286cfb","commit_url":"https://api.github.com/repos/launchbadge/sqlx/commits/49ffcf6f46b3ea27353b884fc7a73ba6be286cfb","created_at":"2020-07-19T04:43:11Z","state_reason":null,"performed_via_github_app":null},{"id":13478501983,"node_id":"REFE_lADODb6dM84mdhAYzwAAAAMjYZ5f","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/13478501983","actor":{"login":"audunhalland","id":5767935,"node_id":"MDQ6VXNlcjU3Njc5MzU=","avatar_url":"https://avatars.githubusercontent.com/u/5767935?v=4","gravatar_id":"","url":"https://api.github.com/users/audunhalland","html_url":"https://github.com/audunhalland","followers_url":"https://api.github.com/users/audunhalland/followers","following_url":"https://api.github.com/users/audunhalland/following{/other_user}","gists_url":"https://api.github.com/users/audunhalland/gists{/gist_id}","starred_url":"https://api.github.com/users/audunhalland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/audunhalland/subscriptions","organizations_url":"https://api.github.com/users/audunhalland/orgs","repos_url":"https://api.github.com/users/audunhalland/repos","events_url":"https://api.github.com/users/audunhalland/events{/privacy}","received_events_url":"https://api.github.com/users/audunhalland/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"49ffcf6f46b3ea27353b884fc7a73ba6be286cfb","commit_url":"https://api.github.com/repos/audunhalland/sqlx/commits/49ffcf6f46b3ea27353b884fc7a73ba6be286cfb","created_at":"2024-07-11T21:53:16Z","performed_via_github_app":null}]