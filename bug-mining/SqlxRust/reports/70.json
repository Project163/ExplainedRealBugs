{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928/events","html_url":"https://github.com/launchbadge/sqlx/issues/1928","id":1283437570,"node_id":"I_kwDODb6dM85Mf7QC","number":1928,"title":"0.6.0: Pool::close does not completely close when awaited","user":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2022-06-24T08:33:40Z","updated_at":"2023-03-02T02:41:31Z","closed_at":"2023-03-02T02:41:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have a [somewhat-hackish setup](https://github.com/TimDeve/slice-n-dice/blob/85db589654597ff4a593e4b96b1b2cc5bf7430ec/server/tests/with_db/integration_scaffold.rs) to create a test database for every integration tests, on struct creation it creates the database with a connection pool and on drop it closes the pool before deleting the database. (Side Note: if someone has a better way of doing that I am definitely interested)\r\n\r\nSince upgrading to v0.6.0 the database drop fails because there is still connections open:\r\n\r\n```\r\nCould not drop test db because of error returned from database: database \"slicendice-integration-test-b61901b5-b86a-4e9b-820b-a8c81bf3cc8\" is being accessed by other users\r\n```\r\n\r\nIt only seems to happen on MacOS (I have not tested locally on Linux but [here is a CI run](https://github.com/TimDeve/slice-n-dice/actions/runs/2544074076/attempts/1) demonstrating the problem).\r\n\r\nI have not been able to create a small example that demonstrate the problem, following is my attempt that does not exhibit it.\r\n\r\n<details>\r\n  <summary>Simple example</summary>\r\n  \r\n```rust\r\n\r\nuse std::env;\r\nuse std::time::Duration;\r\n\r\nuse anyhow::{Context, Result};\r\nuse async_std::task;\r\nuse sqlx::Connection;\r\nuse sqlx::{PgConnection, PgPool};\r\nuse tide::http::Url;\r\nuse uuid::Uuid;\r\n\r\nasync fn use_db(pool: PgPool) -> Result<()> {\r\n    sqlx::query(\r\n        \"CREATE TABLE things (\r\n          id SERIAL PRIMARY KEY,\r\n          name TEXT NOT NULL\r\n        )\",\r\n    )\r\n    .execute(&pool)\r\n    .await?;\r\n\r\n    sqlx::query(\r\n        \"INSERT INTO things ( name )\r\n         VALUES ( 'A name' )\",\r\n    )\r\n    .execute(&pool)\r\n    .await?;\r\n\r\n    Ok(())\r\n}\r\n\r\n#[async_std::main]\r\nasync fn main() -> Result<()> {\r\n    let db_url_string =\r\n        env::var(\"DATABASE_URL\").context(\"DATABASE_URL env variable needs to be set\")?;\r\n\r\n    // Create DB\r\n    let mut db_url = Url::parse(&db_url_string)?;\r\n    let id: Uuid = Uuid::new_v4();\r\n    let mut db_name = String::from(\"slicendice-integration-test-\");\r\n    db_name.push_str(&id.to_string());\r\n\r\n    db_url.set_path(\"/\");\r\n    let mut conn = PgConnection::connect(&db_url.to_string()).await?;\r\n\r\n    sqlx::query(&format!(r#\"CREATE DATABASE \"{}\"\"#, &db_name))\r\n        .execute(&mut conn)\r\n        .await?;\r\n\r\n    // Use DB\r\n    let mut db_path = String::from(\"/\");\r\n    db_path.push_str(&db_name);\r\n    db_url.set_path(&db_path);\r\n    let pool = PgPool::connect(&db_url.to_string()).await?;\r\n    use_db(pool.clone()).await?;\r\n\r\n    // Drop DB\r\n    pool.close().await;\r\n\r\n    dbg!(pool.size());\r\n    dbg!(pool.num_idle());\r\n\r\n    let mut db_url = db_url.clone();\r\n    db_url.set_path(\"/\");\r\n\r\n    let mut conn = PgConnection::connect(&db_url.to_string()).await?;\r\n    // Using format here because bind doesn't work for DROP DATABASE\r\n    sqlx::query(&format!(r#\"DROP DATABASE \"{}\"\"#, &db_name))\r\n        .execute(&mut conn)\r\n        .await?;\r\n\r\n    Ok(())\r\n}\r\n```\r\n\r\n</details>\r\n\r\nMy guess would be that because I am [passing](https://github.com/TimDeve/slice-n-dice/blob/85db589654597ff4a593e4b96b1b2cc5bf7430ec/server/tests/with_db/recipes_integration_tests.rs#L31) the pool to tide's context it's being held longer that in my simple example as when I create a test that only creates the scaffold and makes a call to the database without creating a tide application the problem does not happen.\r\n\r\nI have added a call to `Pool::size` after an awaited `Pool::close`, in v0.5 it is consistently equal to 0 while in v0.6 it is always equal to 1.","closed_by":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928/timeline","performed_via_github_app":null,"state_reason":"completed"}