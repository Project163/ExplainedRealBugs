[{"id":5190591485,"node_id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50NTE5MDU5MTQ4NQ==","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/5190591485","actor":{"login":"sify21","id":11829223,"node_id":"MDQ6VXNlcjExODI5MjIz","avatar_url":"https://avatars.githubusercontent.com/u/11829223?v=4","gravatar_id":"","url":"https://api.github.com/users/sify21","html_url":"https://github.com/sify21","followers_url":"https://api.github.com/users/sify21/followers","following_url":"https://api.github.com/users/sify21/following{/other_user}","gists_url":"https://api.github.com/users/sify21/gists{/gist_id}","starred_url":"https://api.github.com/users/sify21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sify21/subscriptions","organizations_url":"https://api.github.com/users/sify21/orgs","repos_url":"https://api.github.com/users/sify21/repos","events_url":"https://api.github.com/users/sify21/events{/privacy}","received_events_url":"https://api.github.com/users/sify21/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2021-08-22T08:32:26Z","rename":{"from":"connection pool runs out on custom threads","to":"connection pool runs out when used in custom threads"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/903400902","html_url":"https://github.com/launchbadge/sqlx/issues/1396#issuecomment-903400902","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1396","id":903400902,"node_id":"IC_kwDODb6dM8412M3G","user":{"login":"sify21","id":11829223,"node_id":"MDQ6VXNlcjExODI5MjIz","avatar_url":"https://avatars.githubusercontent.com/u/11829223?v=4","gravatar_id":"","url":"https://api.github.com/users/sify21","html_url":"https://github.com/sify21","followers_url":"https://api.github.com/users/sify21/followers","following_url":"https://api.github.com/users/sify21/following{/other_user}","gists_url":"https://api.github.com/users/sify21/gists{/gist_id}","starred_url":"https://api.github.com/users/sify21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sify21/subscriptions","organizations_url":"https://api.github.com/users/sify21/orgs","repos_url":"https://api.github.com/users/sify21/repos","events_url":"https://api.github.com/users/sify21/events{/privacy}","received_events_url":"https://api.github.com/users/sify21/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-23T02:48:16Z","updated_at":"2021-08-23T02:48:16Z","body":"I experimented a little, and found a working version `/nostuck2`.  \r\nHowever, along the way I found an interesting thing: If I do `tokio::time::sleep`, the problem is gone. `stuck2`, `nostuck3`, `nostuck4` demonstrates this. It really confuses me. Hope someone who knows the internals can explain to me.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/903400902/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sify21","id":11829223,"node_id":"MDQ6VXNlcjExODI5MjIz","avatar_url":"https://avatars.githubusercontent.com/u/11829223?v=4","gravatar_id":"","url":"https://api.github.com/users/sify21","html_url":"https://github.com/sify21","followers_url":"https://api.github.com/users/sify21/followers","following_url":"https://api.github.com/users/sify21/following{/other_user}","gists_url":"https://api.github.com/users/sify21/gists{/gist_id}","starred_url":"https://api.github.com/users/sify21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sify21/subscriptions","organizations_url":"https://api.github.com/users/sify21/orgs","repos_url":"https://api.github.com/users/sify21/repos","events_url":"https://api.github.com/users/sify21/events{/privacy}","received_events_url":"https://api.github.com/users/sify21/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/905127568","html_url":"https://github.com/launchbadge/sqlx/issues/1396#issuecomment-905127568","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1396","id":905127568,"node_id":"IC_kwDODb6dM8418yaQ","user":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-08-25T02:27:04Z","updated_at":"2022-01-06T08:24:21Z","body":"This issue is very similar to #1389 in that it's caused by the runtime going away while we're trying to spawn a task that's important to SQLx functioning correctly.\r\n\r\nIn this case, it's due to waiting to call `.float()` here until we're running in the async future (which is passed to `sqlx_rt::spawn()` in the drop handler of `PoolConnection`): https://github.com/launchbadge/sqlx/blob/v0.5.6/sqlx-core/src/pool/connection.rs#L104\r\n\r\nBecause you're using a single-threaded runtime, the task we spawn in `PoolConnection::drop()` will simply not be run because the runtime dies when the current running future returns. Because of that, we never call `.float()`, so the connection is effectively leaked from the pool.\r\n\r\nIf you were using a multi-threaded runtime, you'd probably see similar panics to #1389.\r\n\r\nI need to fix this so that `DecrementSizeGuard` just holds the `Arc<SharedPool<DB>>` and not a `&SharedPool<DB>`, so the `Floating` can be created before being passed to the future which must otherwise be `'static`, and then we should never have a situation where a connection is not covered by `DecrementSizeGuard`.\r\n\r\nHowever, in the meantime, you probably don't want to be spawning a new runtime every time you want to run something in the background. You could instead use `actix_web::rt::spawn()` to spawn the future in the current Actix runtime, although that is still single-threaded(\\*) so you probably want to either limit the total number of background tasks running to keep your API fast, or else concurrently run a multi-threaded Tokio runtime, which you can do using a pattern like this:\r\n\r\n```rust\r\nuse actix_web::web::Data;\r\nuse tokio::runtime::Handle;\r\n\r\npub type TokioRuntime = Data<Handle>;\r\n\r\n#[tokio::main(flavor = \"multi_threaded\")]\r\nasync fn main() {\r\n    let multithreaded_tokio = Data::new(Handle::current());\r\n\r\n    // do async setup stuff, like opening a `PgPool` and running migrations...\r\n\r\n    // `actix_main()` will quit on Ctrl-C\r\n    tokio::task::block_in_place(|| actix_main(multithreaded_tokio));\r\n}\r\n\r\n#[actix_web::main]\r\nasync fn actix_main(multithreaded_tokio: TokioRuntime) {\r\n   // now in the Actix runtime\r\n    HttpServer::new(move || {\r\n        App::new()\r\n            .app_data(multithreaded_tokio)\r\n            .service(handle_request)\r\n    })\r\n    .bind(\"0.0.0.0:8080\")\r\n    .unwrap()\r\n    .run()\r\n    .await\r\n    .unwrap();\r\n}\r\n\r\n#[get(\"/v1/some/route\")]\r\nasync fn handle_request(\r\n    tokio: TokioRuntime,\r\n) -> HttpResponse {\r\n    tokio.spawn(async move { /* some long-running async operation */ });\r\n\r\n    HttpResponse::Ok().finish()\r\n}\r\n```\r\n\r\n\r\n(\\*): I keep forgetting that Actix-web _is_ technically multithreaded in that it spawns a set of threads on start up, each with an Actix runtime, and then dispatches new connections to the threads. Spawned tasks in a given Actix runtime, however, will always execute on the same thread, and no work-stealing occurs between threads, so you could end up in a situation where one runtime is loaded down with more tasks than the others.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/905127568/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":5203942046,"node_id":"MDEyOkxhYmVsZWRFdmVudDUyMDM5NDIwNDY=","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/5203942046","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2021-08-25T02:27:31Z","label":{"name":"bug","color":"e11d21"},"performed_via_github_app":null},{"id":5203942048,"node_id":"MDEyOkxhYmVsZWRFdmVudDUyMDM5NDIwNDg=","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/5203942048","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2021-08-25T02:27:31Z","label":{"name":"pool","color":"7680ed"},"performed_via_github_app":null},{"id":5203943250,"node_id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50NTIwMzk0MzI1MA==","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/5203943250","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2021-08-25T02:28:04Z","rename":{"from":"connection pool runs out when used in custom threads","to":"`PoolConnection::drop`: don't wait until inside the future to call `.float()` "},"performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1057820525","html_url":"https://github.com/launchbadge/sqlx/issues/1396#issuecomment-1057820525","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1396","id":1057820525,"node_id":"IC_kwDODb6dM84_DQ9t","user":{"login":"sify21","id":11829223,"node_id":"MDQ6VXNlcjExODI5MjIz","avatar_url":"https://avatars.githubusercontent.com/u/11829223?v=4","gravatar_id":"","url":"https://api.github.com/users/sify21","html_url":"https://github.com/sify21","followers_url":"https://api.github.com/users/sify21/followers","following_url":"https://api.github.com/users/sify21/following{/other_user}","gists_url":"https://api.github.com/users/sify21/gists{/gist_id}","starred_url":"https://api.github.com/users/sify21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sify21/subscriptions","organizations_url":"https://api.github.com/users/sify21/orgs","repos_url":"https://api.github.com/users/sify21/repos","events_url":"https://api.github.com/users/sify21/events{/privacy}","received_events_url":"https://api.github.com/users/sify21/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-03T08:58:49Z","updated_at":"2022-03-03T08:58:49Z","body":"Hi @abonander , there is something I can't figure out in the pattern you've proposed, I wish you could kindly help me understand.\r\n\r\nI've read in other posts that tokio runtimes can't be nested. It will [panic when starting](https://stackoverflow.com/questions/62536566/how-can-i-create-a-tokio-runtime-inside-another-tokio-runtime-without-getting-th) and [dropping](https://stackoverflow.com/questions/65426683/why-does-tokio-return-the-error-cannot-drop-a-runtime-in-a-context-where-blocki/65427209#65427209).\r\n\r\nIn your pattern, `#[tokio::main(flavor = \"multi_thread\")]` creates a multi-thread runtime, and `#[actix_web::main]` creates a current-thread runtime. But I've tested your code, it works nicely,  and I can send signal 15 to the running process and make it shutdown gracefully. Why is that?\r\n\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1057820525/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sify21","id":11829223,"node_id":"MDQ6VXNlcjExODI5MjIz","avatar_url":"https://avatars.githubusercontent.com/u/11829223?v=4","gravatar_id":"","url":"https://api.github.com/users/sify21","html_url":"https://github.com/sify21","followers_url":"https://api.github.com/users/sify21/followers","following_url":"https://api.github.com/users/sify21/following{/other_user}","gists_url":"https://api.github.com/users/sify21/gists{/gist_id}","starred_url":"https://api.github.com/users/sify21/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sify21/subscriptions","organizations_url":"https://api.github.com/users/sify21/orgs","repos_url":"https://api.github.com/users/sify21/repos","events_url":"https://api.github.com/users/sify21/events{/privacy}","received_events_url":"https://api.github.com/users/sify21/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":6176493319,"node_id":"MEE_lADODb6dM846MXXjzwAAAAFwJc8H","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/6176493319","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-03-03T08:58:49Z","performed_via_github_app":null},{"id":6176493323,"node_id":"SE_lADODb6dM846MXXjzwAAAAFwJc8L","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/6176493323","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-03-03T08:58:49Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1057827195","html_url":"https://github.com/launchbadge/sqlx/issues/1396#issuecomment-1057827195","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1396","id":1057827195,"node_id":"IC_kwDODb6dM84_DSl7","user":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-03-03T09:06:37Z","updated_at":"2022-03-03T09:06:37Z","body":"It's because `block_in_place()` essentially makes the thread no longer a core thread for its duration. The thread-local Tokio context is cleared so to the new runtime the environment is indistinguishable from a freshly started process.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1057827195/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-11T18:09:34Z","updated_at":"2022-04-11T18:09:34Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1792","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1792/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1792/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1792/events","html_url":"https://github.com/launchbadge/sqlx/issues/1792","id":1198989919,"node_id":"I_kwDODb6dM85HdyJf","number":1792,"title":"`PoolTransaction::drop()` schedules `self.return_to_pool()` too late (aka connections are sometimes not returned back into the pool)","user":{"login":"Patryk27","id":3395477,"node_id":"MDQ6VXNlcjMzOTU0Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/3395477?v=4","gravatar_id":"","url":"https://api.github.com/users/Patryk27","html_url":"https://github.com/Patryk27","followers_url":"https://api.github.com/users/Patryk27/followers","following_url":"https://api.github.com/users/Patryk27/following{/other_user}","gists_url":"https://api.github.com/users/Patryk27/gists{/gist_id}","starred_url":"https://api.github.com/users/Patryk27/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Patryk27/subscriptions","organizations_url":"https://api.github.com/users/Patryk27/orgs","repos_url":"https://api.github.com/users/Patryk27/repos","events_url":"https://api.github.com/users/Patryk27/events{/privacy}","received_events_url":"https://api.github.com/users/Patryk27/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-04-10T11:15:17Z","updated_at":"2022-04-11T18:18:18Z","closed_at":"2022-04-11T18:09:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":230595891,"node_id":"MDEwOlJlcG9zaXRvcnkyMzA1OTU4OTE=","name":"sqlx","full_name":"launchbadge/sqlx","private":false,"owner":{"login":"launchbadge","id":10077001,"node_id":"MDEyOk9yZ2FuaXphdGlvbjEwMDc3MDAx","avatar_url":"https://avatars.githubusercontent.com/u/10077001?v=4","gravatar_id":"","url":"https://api.github.com/users/launchbadge","html_url":"https://github.com/launchbadge","followers_url":"https://api.github.com/users/launchbadge/followers","following_url":"https://api.github.com/users/launchbadge/following{/other_user}","gists_url":"https://api.github.com/users/launchbadge/gists{/gist_id}","starred_url":"https://api.github.com/users/launchbadge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/launchbadge/subscriptions","organizations_url":"https://api.github.com/users/launchbadge/orgs","repos_url":"https://api.github.com/users/launchbadge/repos","events_url":"https://api.github.com/users/launchbadge/events{/privacy}","received_events_url":"https://api.github.com/users/launchbadge/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/launchbadge/sqlx","description":"ðŸ§° The Rust SQL Toolkit. An async, pure Rust SQL crate featuring compile-time checked queries without a DSL. Supports PostgreSQL, MySQL, and SQLite.","fork":false,"url":"https://api.github.com/repos/launchbadge/sqlx","forks_url":"https://api.github.com/repos/launchbadge/sqlx/forks","keys_url":"https://api.github.com/repos/launchbadge/sqlx/keys{/key_id}","collaborators_url":"https://api.github.com/repos/launchbadge/sqlx/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/launchbadge/sqlx/teams","hooks_url":"https://api.github.com/repos/launchbadge/sqlx/hooks","issue_events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/events{/number}","events_url":"https://api.github.com/repos/launchbadge/sqlx/events","assignees_url":"https://api.github.com/repos/launchbadge/sqlx/assignees{/user}","branches_url":"https://api.github.com/repos/launchbadge/sqlx/branches{/branch}","tags_url":"https://api.github.com/repos/launchbadge/sqlx/tags","blobs_url":"https://api.github.com/repos/launchbadge/sqlx/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/launchbadge/sqlx/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/launchbadge/sqlx/git/refs{/sha}","trees_url":"https://api.github.com/repos/launchbadge/sqlx/git/trees{/sha}","statuses_url":"https://api.github.com/repos/launchbadge/sqlx/statuses/{sha}","languages_url":"https://api.github.com/repos/launchbadge/sqlx/languages","stargazers_url":"https://api.github.com/repos/launchbadge/sqlx/stargazers","contributors_url":"https://api.github.com/repos/launchbadge/sqlx/contributors","subscribers_url":"https://api.github.com/repos/launchbadge/sqlx/subscribers","subscription_url":"https://api.github.com/repos/launchbadge/sqlx/subscription","commits_url":"https://api.github.com/repos/launchbadge/sqlx/commits{/sha}","git_commits_url":"https://api.github.com/repos/launchbadge/sqlx/git/commits{/sha}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/comments{/number}","issue_comment_url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments{/number}","contents_url":"https://api.github.com/repos/launchbadge/sqlx/contents/{+path}","compare_url":"https://api.github.com/repos/launchbadge/sqlx/compare/{base}...{head}","merges_url":"https://api.github.com/repos/launchbadge/sqlx/merges","archive_url":"https://api.github.com/repos/launchbadge/sqlx/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/launchbadge/sqlx/downloads","issues_url":"https://api.github.com/repos/launchbadge/sqlx/issues{/number}","pulls_url":"https://api.github.com/repos/launchbadge/sqlx/pulls{/number}","milestones_url":"https://api.github.com/repos/launchbadge/sqlx/milestones{/number}","notifications_url":"https://api.github.com/repos/launchbadge/sqlx/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/launchbadge/sqlx/labels{/name}","releases_url":"https://api.github.com/repos/launchbadge/sqlx/releases{/id}","deployments_url":"https://api.github.com/repos/launchbadge/sqlx/deployments","created_at":"2019-12-28T10:40:57Z","updated_at":"2025-11-10T07:15:41Z","pushed_at":"2025-10-29T18:37:49Z","git_url":"git://github.com/launchbadge/sqlx.git","ssh_url":"git@github.com:launchbadge/sqlx.git","clone_url":"https://github.com/launchbadge/sqlx.git","svn_url":"https://github.com/launchbadge/sqlx","homepage":"","size":9641,"stargazers_count":15938,"watchers_count":15938,"language":"Rust","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1502,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":701,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["async","await","mariadb","mysql","postgres","postgresql","rust","sql","sqlite"],"visibility":"public","forks":1502,"open_issues":701,"watchers":15938,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"Hi ðŸ™‚\r\n\r\nSince code is worth a thousand words - this little boi:\r\n\r\n```rust\r\n#[tokio::main]\r\nasync fn main() {\r\n    let pool = sqlx::SqlitePool::connect_with(Default::default())\r\n        .await\r\n        .unwrap();\r\n\r\n    for i in 0..11 {\r\n        println!(\"Acquiring connection ({})\", i);\r\n        let tx = pool.begin().await.unwrap();\r\n        tx.commit().await.unwrap();\r\n        println!(\"Releasing connection\");\r\n    }\r\n}\r\n```\r\n\r\n... correctly prints:\r\n\r\n```\r\nAcquiring connection (0)\r\nReleasing connection\r\nAcquiring connection (1)\r\nReleasing connection\r\n/* ... */\r\nAcquiring connection (10)\r\nReleasing connection\r\n```\r\n\r\n... but if we modify that code ever so slightly, so that `tx.commit()` is sent into a separate runtime that dies _right after_ `.commit().await` finishes working:\r\n\r\n```rust\r\n#[tokio::main]\r\nasync fn main() {\r\n    let pool = sqlx::SqlitePool::connect_with(Default::default())\r\n        .await\r\n        .unwrap();\r\n\r\n    for i in 0..11 {\r\n        println!(\"Acquiring connection ({})\", i);\r\n        let tx = pool.begin().await.unwrap();\r\n\r\n        tokio::task::spawn_blocking(move || {\r\n            let rt = tokio::runtime::Builder::new_current_thread()\r\n                .enable_all()\r\n                .build()\r\n                .unwrap();\r\n\r\n            rt.block_on(async move {\r\n                tx.commit().await.unwrap();\r\n            });\r\n        })\r\n        .await\r\n        .unwrap();\r\n\r\n        println!(\"Releasing connection\");\r\n    }\r\n}\r\n```\r\n\r\n... the code gets stuck at `Acquiring connection (10)` - because if the runtime dies right after `.commit().await`, then `PoolTransaction::drop()` has not enough time to schedule & execute `self.return_to_pool()`:\r\n\r\n```rust\r\nimpl<DB: Database> Drop for PoolConnection<DB> {\r\n    fn drop(&mut self) {\r\n        if self.live.is_some() {\r\n            if let Ok(handle) = sqlx_rt::Handle::try_current() {\r\n                handle.spawn(self.return_to_pool());\r\n                // ----------^^^^^^^^^^^^^^^^^^^^^\r\n                // | ayy - this gets *scheduled* to be executed, but the runtime\r\n                // | dies before it has a chance to see that `.spawn()` happened\r\n                // ---\r\n            }\r\n\r\n            /* ... */\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nYielding the future for a single tick seems to help:\r\n\r\n```rust\r\nrt.block_on(async move {\r\n    let res = tx.commit().await.unwrap();\r\n    tokio::task::yield_now().await;\r\n    res\r\n});\r\n```\r\n\r\n... because then Tokio has enough time to notice \"hey, something got spawned - let's wait for it, too!\"\r\n\r\nNow, I'm not sure if that's a bug in Tokio or sqlx - but on sqlx's side this can be kinda-sorta fixed by introducing `yield_now()`:\r\n\r\n```rust\r\nimpl<'c, DB> Transaction<'c, DB>\r\n/* ... */\r\n{\r\n    /* ... */\r\n    pub async fn commit(mut self) -> Result<(), Error> {\r\n        DB::TransactionManager::commit(&mut self.connection).await?;\r\n        self.open = false;\r\n\r\n        drop(self); \r\n        tokio::task::yield_now().await; \r\n\r\n        Ok(())\r\n    }\r\n\r\n    pub async fn rollback(mut self) -> Result<(), Error> {\r\n        DB::TransactionManager::rollback(&mut self.connection).await?;\r\n        self.open = false;\r\n\r\n        drop(self);\r\n        tokio::task::yield_now().await;\r\n\r\n        Ok(())\r\n    }\r\n}\r\n```\r\n\r\nUnfortunately, this doesn't fix the case when someone just executes `drop(tx);` without calling `.commit()` or `.rollback()` - then the connection might _still_ not get returned back into the pool :cry:\r\n\r\nFor reference, `Cargo.toml`:\r\n\r\n```toml\r\n[package]\r\nname = \"sqlx-example\"\r\nversion = \"0.1.0\"\r\nedition = \"2021\"\r\n\r\n[dependencies]\r\nsqlx = { version = \"0.5\", features = [\"runtime-tokio-rustls\", \"sqlite\"] }\r\ntokio = { version = \"1.17\", features = [\"full\"] }\r\n```\r\n\r\n(fwiw, I've also checked `sqlx`'s master branch and the issue seems to be still there.)\r\n","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1792/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":6430611042,"node_id":"REFE_lADODb6dM846MXXjzwAAAAF_S1Zi","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/6430611042","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"73f1e5cc625cfaad6297aab2bd1c3ddd55a861da","commit_url":"https://api.github.com/repos/launchbadge/sqlx/commits/73f1e5cc625cfaad6297aab2bd1c3ddd55a861da","created_at":"2022-04-13T21:57:59Z","performed_via_github_app":null},{"actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-13T21:58:17Z","updated_at":"2022-04-13T21:58:17Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1799","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1799/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1799/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1799/events","html_url":"https://github.com/launchbadge/sqlx/pull/1799","id":1203830544,"node_id":"PR_kwDODb6dM842NEDB","number":1799,"title":"fix(pool): don't leak connections if drop task doesn't run","user":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-13T21:58:17Z","updated_at":"2022-04-13T23:39:08Z","closed_at":"2022-04-13T23:39:07Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":230595891,"node_id":"MDEwOlJlcG9zaXRvcnkyMzA1OTU4OTE=","name":"sqlx","full_name":"launchbadge/sqlx","private":false,"owner":{"login":"launchbadge","id":10077001,"node_id":"MDEyOk9yZ2FuaXphdGlvbjEwMDc3MDAx","avatar_url":"https://avatars.githubusercontent.com/u/10077001?v=4","gravatar_id":"","url":"https://api.github.com/users/launchbadge","html_url":"https://github.com/launchbadge","followers_url":"https://api.github.com/users/launchbadge/followers","following_url":"https://api.github.com/users/launchbadge/following{/other_user}","gists_url":"https://api.github.com/users/launchbadge/gists{/gist_id}","starred_url":"https://api.github.com/users/launchbadge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/launchbadge/subscriptions","organizations_url":"https://api.github.com/users/launchbadge/orgs","repos_url":"https://api.github.com/users/launchbadge/repos","events_url":"https://api.github.com/users/launchbadge/events{/privacy}","received_events_url":"https://api.github.com/users/launchbadge/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/launchbadge/sqlx","description":"ðŸ§° The Rust SQL Toolkit. An async, pure Rust SQL crate featuring compile-time checked queries without a DSL. Supports PostgreSQL, MySQL, and SQLite.","fork":false,"url":"https://api.github.com/repos/launchbadge/sqlx","forks_url":"https://api.github.com/repos/launchbadge/sqlx/forks","keys_url":"https://api.github.com/repos/launchbadge/sqlx/keys{/key_id}","collaborators_url":"https://api.github.com/repos/launchbadge/sqlx/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/launchbadge/sqlx/teams","hooks_url":"https://api.github.com/repos/launchbadge/sqlx/hooks","issue_events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/events{/number}","events_url":"https://api.github.com/repos/launchbadge/sqlx/events","assignees_url":"https://api.github.com/repos/launchbadge/sqlx/assignees{/user}","branches_url":"https://api.github.com/repos/launchbadge/sqlx/branches{/branch}","tags_url":"https://api.github.com/repos/launchbadge/sqlx/tags","blobs_url":"https://api.github.com/repos/launchbadge/sqlx/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/launchbadge/sqlx/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/launchbadge/sqlx/git/refs{/sha}","trees_url":"https://api.github.com/repos/launchbadge/sqlx/git/trees{/sha}","statuses_url":"https://api.github.com/repos/launchbadge/sqlx/statuses/{sha}","languages_url":"https://api.github.com/repos/launchbadge/sqlx/languages","stargazers_url":"https://api.github.com/repos/launchbadge/sqlx/stargazers","contributors_url":"https://api.github.com/repos/launchbadge/sqlx/contributors","subscribers_url":"https://api.github.com/repos/launchbadge/sqlx/subscribers","subscription_url":"https://api.github.com/repos/launchbadge/sqlx/subscription","commits_url":"https://api.github.com/repos/launchbadge/sqlx/commits{/sha}","git_commits_url":"https://api.github.com/repos/launchbadge/sqlx/git/commits{/sha}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/comments{/number}","issue_comment_url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments{/number}","contents_url":"https://api.github.com/repos/launchbadge/sqlx/contents/{+path}","compare_url":"https://api.github.com/repos/launchbadge/sqlx/compare/{base}...{head}","merges_url":"https://api.github.com/repos/launchbadge/sqlx/merges","archive_url":"https://api.github.com/repos/launchbadge/sqlx/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/launchbadge/sqlx/downloads","issues_url":"https://api.github.com/repos/launchbadge/sqlx/issues{/number}","pulls_url":"https://api.github.com/repos/launchbadge/sqlx/pulls{/number}","milestones_url":"https://api.github.com/repos/launchbadge/sqlx/milestones{/number}","notifications_url":"https://api.github.com/repos/launchbadge/sqlx/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/launchbadge/sqlx/labels{/name}","releases_url":"https://api.github.com/repos/launchbadge/sqlx/releases{/id}","deployments_url":"https://api.github.com/repos/launchbadge/sqlx/deployments","created_at":"2019-12-28T10:40:57Z","updated_at":"2025-11-10T07:15:41Z","pushed_at":"2025-10-29T18:37:49Z","git_url":"git://github.com/launchbadge/sqlx.git","ssh_url":"git@github.com:launchbadge/sqlx.git","clone_url":"https://github.com/launchbadge/sqlx.git","svn_url":"https://github.com/launchbadge/sqlx","homepage":"","size":9641,"stargazers_count":15938,"watchers_count":15938,"language":"Rust","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1502,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":701,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["async","await","mariadb","mysql","postgres","postgresql","rust","sql","sqlite"],"visibility":"public","forks":1502,"open_issues":701,"watchers":15938,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/launchbadge/sqlx/pulls/1799","html_url":"https://github.com/launchbadge/sqlx/pull/1799","diff_url":"https://github.com/launchbadge/sqlx/pull/1799.diff","patch_url":"https://github.com/launchbadge/sqlx/pull/1799.patch","merged_at":"2022-04-13T23:39:07Z"},"body":"fixes #1396","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1799/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":6430941579,"node_id":"CE_lADODb6dM846MXXjzwAAAAF_UGGL","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/6430941579","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2022-04-13T23:39:07Z","state_reason":null,"performed_via_github_app":null},{"id":6430941652,"node_id":"REFE_lADODb6dM846MXXjzwAAAAF_UGHU","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/6430941652","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"6c7006c4ccafede145811b03da98cebbe8203be8","commit_url":"https://api.github.com/repos/launchbadge/sqlx/commits/6c7006c4ccafede145811b03da98cebbe8203be8","created_at":"2022-04-13T23:39:09Z","performed_via_github_app":null},{"actor":{"login":"mlodato517","id":18740355,"node_id":"MDQ6VXNlcjE4NzQwMzU1","avatar_url":"https://avatars.githubusercontent.com/u/18740355?v=4","gravatar_id":"","url":"https://api.github.com/users/mlodato517","html_url":"https://github.com/mlodato517","followers_url":"https://api.github.com/users/mlodato517/followers","following_url":"https://api.github.com/users/mlodato517/following{/other_user}","gists_url":"https://api.github.com/users/mlodato517/gists{/gist_id}","starred_url":"https://api.github.com/users/mlodato517/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mlodato517/subscriptions","organizations_url":"https://api.github.com/users/mlodato517/orgs","repos_url":"https://api.github.com/users/mlodato517/repos","events_url":"https://api.github.com/users/mlodato517/events{/privacy}","received_events_url":"https://api.github.com/users/mlodato517/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-04-21T16:30:18Z","updated_at":"2022-04-21T16:30:18Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1824","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1824/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1824/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1824/events","html_url":"https://github.com/launchbadge/sqlx/issues/1824","id":1211276635,"node_id":"I_kwDODb6dM85IMp1b","number":1824,"title":"Pools/connections not being closed in tests","user":{"login":"mlodato517","id":18740355,"node_id":"MDQ6VXNlcjE4NzQwMzU1","avatar_url":"https://avatars.githubusercontent.com/u/18740355?v=4","gravatar_id":"","url":"https://api.github.com/users/mlodato517","html_url":"https://github.com/mlodato517","followers_url":"https://api.github.com/users/mlodato517/followers","following_url":"https://api.github.com/users/mlodato517/following{/other_user}","gists_url":"https://api.github.com/users/mlodato517/gists{/gist_id}","starred_url":"https://api.github.com/users/mlodato517/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mlodato517/subscriptions","organizations_url":"https://api.github.com/users/mlodato517/orgs","repos_url":"https://api.github.com/users/mlodato517/repos","events_url":"https://api.github.com/users/mlodato517/events{/privacy}","received_events_url":"https://api.github.com/users/mlodato517/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-04-21T16:30:18Z","updated_at":"2022-06-16T19:56:28Z","closed_at":"2022-06-16T19:56:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":230595891,"node_id":"MDEwOlJlcG9zaXRvcnkyMzA1OTU4OTE=","name":"sqlx","full_name":"launchbadge/sqlx","private":false,"owner":{"login":"launchbadge","id":10077001,"node_id":"MDEyOk9yZ2FuaXphdGlvbjEwMDc3MDAx","avatar_url":"https://avatars.githubusercontent.com/u/10077001?v=4","gravatar_id":"","url":"https://api.github.com/users/launchbadge","html_url":"https://github.com/launchbadge","followers_url":"https://api.github.com/users/launchbadge/followers","following_url":"https://api.github.com/users/launchbadge/following{/other_user}","gists_url":"https://api.github.com/users/launchbadge/gists{/gist_id}","starred_url":"https://api.github.com/users/launchbadge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/launchbadge/subscriptions","organizations_url":"https://api.github.com/users/launchbadge/orgs","repos_url":"https://api.github.com/users/launchbadge/repos","events_url":"https://api.github.com/users/launchbadge/events{/privacy}","received_events_url":"https://api.github.com/users/launchbadge/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/launchbadge/sqlx","description":"ðŸ§° The Rust SQL Toolkit. An async, pure Rust SQL crate featuring compile-time checked queries without a DSL. Supports PostgreSQL, MySQL, and SQLite.","fork":false,"url":"https://api.github.com/repos/launchbadge/sqlx","forks_url":"https://api.github.com/repos/launchbadge/sqlx/forks","keys_url":"https://api.github.com/repos/launchbadge/sqlx/keys{/key_id}","collaborators_url":"https://api.github.com/repos/launchbadge/sqlx/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/launchbadge/sqlx/teams","hooks_url":"https://api.github.com/repos/launchbadge/sqlx/hooks","issue_events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/events{/number}","events_url":"https://api.github.com/repos/launchbadge/sqlx/events","assignees_url":"https://api.github.com/repos/launchbadge/sqlx/assignees{/user}","branches_url":"https://api.github.com/repos/launchbadge/sqlx/branches{/branch}","tags_url":"https://api.github.com/repos/launchbadge/sqlx/tags","blobs_url":"https://api.github.com/repos/launchbadge/sqlx/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/launchbadge/sqlx/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/launchbadge/sqlx/git/refs{/sha}","trees_url":"https://api.github.com/repos/launchbadge/sqlx/git/trees{/sha}","statuses_url":"https://api.github.com/repos/launchbadge/sqlx/statuses/{sha}","languages_url":"https://api.github.com/repos/launchbadge/sqlx/languages","stargazers_url":"https://api.github.com/repos/launchbadge/sqlx/stargazers","contributors_url":"https://api.github.com/repos/launchbadge/sqlx/contributors","subscribers_url":"https://api.github.com/repos/launchbadge/sqlx/subscribers","subscription_url":"https://api.github.com/repos/launchbadge/sqlx/subscription","commits_url":"https://api.github.com/repos/launchbadge/sqlx/commits{/sha}","git_commits_url":"https://api.github.com/repos/launchbadge/sqlx/git/commits{/sha}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/comments{/number}","issue_comment_url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments{/number}","contents_url":"https://api.github.com/repos/launchbadge/sqlx/contents/{+path}","compare_url":"https://api.github.com/repos/launchbadge/sqlx/compare/{base}...{head}","merges_url":"https://api.github.com/repos/launchbadge/sqlx/merges","archive_url":"https://api.github.com/repos/launchbadge/sqlx/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/launchbadge/sqlx/downloads","issues_url":"https://api.github.com/repos/launchbadge/sqlx/issues{/number}","pulls_url":"https://api.github.com/repos/launchbadge/sqlx/pulls{/number}","milestones_url":"https://api.github.com/repos/launchbadge/sqlx/milestones{/number}","notifications_url":"https://api.github.com/repos/launchbadge/sqlx/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/launchbadge/sqlx/labels{/name}","releases_url":"https://api.github.com/repos/launchbadge/sqlx/releases{/id}","deployments_url":"https://api.github.com/repos/launchbadge/sqlx/deployments","created_at":"2019-12-28T10:40:57Z","updated_at":"2025-11-10T07:15:41Z","pushed_at":"2025-10-29T18:37:49Z","git_url":"git://github.com/launchbadge/sqlx.git","ssh_url":"git@github.com:launchbadge/sqlx.git","clone_url":"https://github.com/launchbadge/sqlx.git","svn_url":"https://github.com/launchbadge/sqlx","homepage":"","size":9641,"stargazers_count":15938,"watchers_count":15938,"language":"Rust","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":1502,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":701,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["async","await","mariadb","mysql","postgres","postgresql","rust","sql","sqlite"],"visibility":"public","forks":1502,"open_issues":701,"watchers":15938,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## Crazy High Level\r\nAfter upgrading from `0.5.11` to `0.5.12` (and trying `0.5.13`), our test\r\nsuite fails because of this error:\r\nâ€‹\r\n```\r\nremaining connection slots are reserved for non-replication superuser connections\r\n```\r\nâ€‹\r\nI cloned `sqlx` and `git bisect`ed it and got to https://github.com/launchbadge/sqlx/pull/1799.\r\nâ€‹\r\n## Details And Debugging\r\nEvery test in this particular test suite runs with `#[tokio::test]` so that seems\r\nawfully related to the discussion of runtimes in https://github.com/launchbadge/sqlx/issues/1396#issuecomment-905127568. Every test in this\r\ntest suite calls a function which creates its own `PgPool` to run some queries.\r\nThis is, of course, not what pools are for but, if I add a `pool.close().await` to\r\nthe end of that function, the tests all pass.\r\nâ€‹\r\nOriginally I thought I'd just do that, problem solved. However we also have\r\na bunch of tests that, I think, can't share a pool. Every unit test\r\nclones a template database and then connects a pool to its specific database.\r\nThis ensures no tests collide which is nice but, I think, prevents us from\r\nsharing one pool among them.\r\nâ€‹\r\n## Minimal Reproduction (sort of)\r\nThis reproducer shows the \"bug\" in both `0.5.11` and `0.5.13` so maybe\r\nthis is something we were bound to run into eventually but our test suite\r\nhappens to consistently pass on `0.5.11` and consistently fail otherwise.\r\nThis also, obviously, isn't how our tests work - we don't create the pools\r\nin a loop, each test creates its own. But this is fewer lines of code :-).\r\nâ€‹\r\n```rust\r\n#[cfg(test)]\r\nmod tests {\r\n    struct DropDetector(usize, sqlx::PgPool);\r\n    impl Drop for DropDetector {\r\n        fn drop(&mut self) {\r\n            println!(\"Dropping {}\", self.0);\r\n        }\r\n    }\r\nâ€‹\r\n    async fn handwavy_test_setup(i: usize) {\r\n        let db_url = \"your_connection_string_here\";\r\n        let drop_detector = DropDetector(i, sqlx::PgPool::connect(db_url).await.unwrap());\r\n        let DropDetector(_, pool) = &drop_detector;\r\nâ€‹\r\n        // This \"fixes\" the \"problem\".\r\n        // pool.close().await;\r\n    }\r\nâ€‹\r\n    #[tokio::test]\r\n    async fn test_stuff() {\r\n        for i in 0..100 {\r\n            println!(\"Starting test {i}\");\r\n            handwavy_test_setup(i).await;\r\nâ€‹\r\n            // Give time for pool to close? Simulate doing ... test stuff.\r\n            tokio::time::sleep(std::time::Duration::from_millis(100)).await;\r\n        }\r\n    }\r\n}\r\n```\r\n`Cargo.toml`:\r\n```toml\r\n[package]\r\nname = \"sqlx-pools\"\r\nversion = \"0.1.0\"\r\nedition = \"2021\"\r\nâ€‹\r\n[dependencies]\r\nsqlx = { version = \"=0.5.11\", default-features = false, features = [\"runtime-actix-rustls\", \"postgres\"] }\r\ntokio = { version = \"=1.17.0\", default-features = false, features = [\"macros\", \"rt\"] }\r\n```\r\nâ€‹\r\n## Versions And Things\r\nThing | Version\r\n--------|-----------\r\ntest suite `sqlx` | works on `0.5.11`, did not on `0.5.12`, does not on `0.5.13`\r\nreproducer `sqlx` | fails on `0.5.11` and `0.5.13` (at least)\r\ndriver | postgres\r\n`postgresql` | 14.1 and 12.6","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1824/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1824/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]