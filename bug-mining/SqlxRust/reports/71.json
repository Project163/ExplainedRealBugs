{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/2372","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2372/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2372/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2372/events","html_url":"https://github.com/launchbadge/sqlx/issues/2372","id":1598820168,"node_id":"I_kwDODb6dM85fTA9I","number":2372,"title":"Memory leak / unlimited caching kills the server","user":{"login":"MartinKavik","id":18517402,"node_id":"MDQ6VXNlcjE4NTE3NDAy","avatar_url":"https://avatars.githubusercontent.com/u/18517402?v=4","gravatar_id":"","url":"https://api.github.com/users/MartinKavik","html_url":"https://github.com/MartinKavik","followers_url":"https://api.github.com/users/MartinKavik/followers","following_url":"https://api.github.com/users/MartinKavik/following{/other_user}","gists_url":"https://api.github.com/users/MartinKavik/gists{/gist_id}","starred_url":"https://api.github.com/users/MartinKavik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MartinKavik/subscriptions","organizations_url":"https://api.github.com/users/MartinKavik/orgs","repos_url":"https://api.github.com/users/MartinKavik/repos","events_url":"https://api.github.com/users/MartinKavik/events{/privacy}","received_events_url":"https://api.github.com/users/MartinKavik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1757378993,"node_id":"MDU6TGFiZWwxNzU3Mzc4OTkz","url":"https://api.github.com/repos/launchbadge/sqlx/labels/bug","name":"bug","color":"e11d21","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-02-24T15:12:34Z","updated_at":"2023-03-04T00:50:28Z","closed_at":"2023-03-04T00:50:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Description\r\nThe connection (pool) \"remembers\" the query with the biggest memory size. It means when you insert some binary data (e.g. 100 MB) then it doesn't free the memory even though the data are already stored in the database. \r\n\r\nI've tried to call `persistent(false)` or set various settings like `max_lifetime` but nothing really helped.\r\n\r\nI've noticed the bug because my Rust app that uses sqlx through SeaORM was crashing on the server with the error \"out of memory\". The app uploads temporary binary data (~1-40MB) to Postgres and it allocates hundreds of MBs because of the sqlx bug until I set the maximum number of connections to a lower number with aggressive short lifetime and min_connections 0.\r\n\r\nI've tried to debug it by myself by no luck unfortunately.\r\n\r\n### Minimal Reproduction\r\nhttps://github.com/MartinKavik/sqlx-memory-debug\r\n(instructions + a screenshot  in the README)\r\n\r\n### Info\r\n* SQLx version: **0.6**\r\n* SQLx features enabled: **[ \"runtime-tokio-rustls\" , \"postgres\" ]**\r\n* Database server and version: **Postgres 13.5 or newer (other DBs not tested)**\r\n* Operating system: **desktop Kubuntu, server Ubuntu**\r\n* `rustc --version`: **rustc 1.67.1 (d5a82bbd2 2023-02-07)**\r\n\r\nThank you!","closed_by":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/2372/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2372/timeline","performed_via_github_app":null,"state_reason":"completed"}