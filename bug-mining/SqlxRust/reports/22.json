{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/422","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/422/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/422/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/422/events","html_url":"https://github.com/launchbadge/sqlx/issues/422","id":642271546,"node_id":"MDU6SXNzdWU2NDIyNzE1NDY=","number":422,"title":"[mysql] MySQL with ProxySQL in front reports errors and stalls","user":{"login":"neoeinstein","id":18165,"node_id":"MDQ6VXNlcjE4MTY1","avatar_url":"https://avatars.githubusercontent.com/u/18165?v=4","gravatar_id":"","url":"https://api.github.com/users/neoeinstein","html_url":"https://github.com/neoeinstein","followers_url":"https://api.github.com/users/neoeinstein/followers","following_url":"https://api.github.com/users/neoeinstein/following{/other_user}","gists_url":"https://api.github.com/users/neoeinstein/gists{/gist_id}","starred_url":"https://api.github.com/users/neoeinstein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neoeinstein/subscriptions","organizations_url":"https://api.github.com/users/neoeinstein/orgs","repos_url":"https://api.github.com/users/neoeinstein/repos","events_url":"https://api.github.com/users/neoeinstein/events{/privacy}","received_events_url":"https://api.github.com/users/neoeinstein/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-06-20T00:18:31Z","updated_at":"2020-06-27T12:55:35Z","closed_at":"2020-06-27T12:55:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We have a ProxySQL proxy fronting our MySQL database. When connecting to the database and beginning to execute queries, the first query may execute successfully, but subsequent queries stall out and do not proceed.\r\n\r\nThese are the logs from ProxySQL:\r\n```\r\nMySQL_Session.cpp:4895:handler___status_WAITING_CLIENT_DATA___STATE_SLEEP___MYSQL_COM_QUERY_qpo(): [WARNING] Unable to parse multi-statements command with SET statement: setting lock hostgroup . Command: \r\nSET sql_mode=(SELECT CONCAT(@@sql_mode, ',PIPES_AS_CONCAT,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE'));\r\nSET time_zone = '+00:00';\r\nSET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;\r\n```\r\n\r\nWhen I try to execute the next query, the execution seems to stall out in the middle of the query and it never resolves to either an error or a success. I'm doing this inside of a Warp server, and because the future never resolves, it hangs the HTTP connection. Cancelling the HTTP request drops the future, and the next query executes correctly, but on a new MySQL connection. If I gracefully shut down the Warp server instead, it will hang waiting for the request to finish until the timeout expires.\r\n\r\nI could add some timeouts surrounding the queries, but that wouldn't solve the underlying issue of every other query failing to resolve.\r\n\r\nSome times, when starting up, I will receive an error back from the ProxySQL instance:\r\n\r\n```\r\nYou have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near 'SET time_zone = '+00:00';\r\n      SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci' at line 2\r\n```\r\n\r\nThis may just require issuing each `SET` command as a separate `execute` rather than all in one, as is currently done.\r\n\r\nIssue #263 may be related.","closed_by":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/422/timeline","performed_via_github_app":null,"state_reason":"completed"}