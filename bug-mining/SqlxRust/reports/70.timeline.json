[{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1212551230","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1212551230","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1212551230,"node_id":"IC_kwDODb6dM85IRhA-","user":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-11T22:15:58Z","updated_at":"2022-08-11T22:15:58Z","body":"Hey, so I run into this just now with my similarly custom funky test harness. I was able to home the issue to the usage of the `block_on` executor for closing the database pool in the `Drop` implementation. I.e. an executor different from the `Tokio` executor it was created in not to mention which `sqlx` was feature-flag-configured with. Looking at your link, it appears to be a similar case. \r\n\r\nGood day.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1212551230/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1213051277","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1213051277","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1213051277,"node_id":"IC_kwDODb6dM85ITbGN","user":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-12T12:17:28Z","updated_at":"2022-08-12T12:17:28Z","body":"Thanks for taking the time to look at my code, do you mean that you were using tokio as an executor but used async-std `block_on`? As far as I know I'm using async-std everywhere. Do you know if there is anything in my feature flag that I should be doing differently?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1213051277/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1213216598","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1213216598","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1213216598,"node_id":"IC_kwDODb6dM85IUDdW","user":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-12T15:08:53Z","updated_at":"2022-08-12T15:10:14Z","body":"Having a similar issue for an identical use case, it's not just macOS. I have issue on docker setup as well. However, my issue with postgres, `pool.close().await` never returns when run from a different thread.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1213216598/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1213615415","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1213615415","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1213615415,"node_id":"IC_kwDODb6dM85IVk03","user":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-13T00:37:25Z","updated_at":"2022-08-13T00:37:25Z","body":"@TimDeve Not all futures are portable across runtimes even if the runtimes are from the same library and in some cases, even if they're configured identically. In this case, the connections in the pool are being spawned and used in the probably multi threaded sophisticated runtime your app is using but you're trying to close them on a simple `block_on` runtime. What I did to fix the bug was use a dedicated async `close` function on the `Scaffold` and used block scoping in order to be able to call it after all the objects borrowing from it are dropped.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1213615415/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7182523937,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGsHJ4h","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7182523937","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-13T00:37:25Z","performed_via_github_app":null},{"id":7182523940,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGsHJ4k","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7182523940","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-13T00:37:25Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214164042","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1214164042","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1214164042,"node_id":"IC_kwDODb6dM85IXqxK","user":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-13T13:57:36Z","updated_at":"2022-08-13T13:57:36Z","body":"I believe [this](https://github.com/TimDeve/slice-n-dice/blob/1f94ce18d27970a5507323f4a5763d0524500275/server/tests/with_db/recipes_integration_tests.rs#L53-L91) is what you are suggesting: No `block_on`, everything else but the pool as been dropped by the block scope and the async drop is called manually from withing the same runtime.\r\n\r\nHowever the error is still there.\r\n\r\nIt seems the refactoring of `Pool::close` in `0.5 -> 0.6` has introduce a regression as the docs say the following:\r\n\r\n> [Pool::close] returns a Future which can be .awaited to ensure all connections are gracefully closed. It will first close any idle connections currently waiting in the pool, then wait for all checked-out connections to be returned or closed.\r\n\r\nIt clearly doesn't wait otherwise the following error wouldn't happen:\r\n```\r\n database \"slicendice-integration-test-8af97dc3-158e-42f6-b16a-364ec4d3f37\" is being accessed by other users\r\n ```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214164042/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214167195","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1214167195","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1214167195,"node_id":"IC_kwDODb6dM85IXrib","user":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-13T14:20:58Z","updated_at":"2022-08-13T14:21:05Z","body":"@Yohe-Am \r\n\r\n> What I did to fix the bug was use a dedicated async close function on the Scaffold and used block scoping in order to be able to call it after all the objects borrowing from it are dropped.\r\n\r\nI'm confused what you mean here. If you don't put the cleanup calls in the Drop impl, then on failure the database won't be cleaned up. Unfortunately, Drop isn't async so we must create a separate runtime. Which causes issues with closing pools (at least with postgres).","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214167195/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7183444935,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGsKqvH","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7183444935","actor":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-13T14:20:59Z","performed_via_github_app":null},{"id":7183444937,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGsKqvJ","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7183444937","actor":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-13T14:20:59Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214170313","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1214170313","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1214170313,"node_id":"IC_kwDODb6dM85IXsTJ","user":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-13T14:41:36Z","updated_at":"2022-08-13T14:42:30Z","body":"After some additional testing it seems the problem doesn't happen if the pool has been dropped, so a potential workaround if your setup is similar (a Pool field in a struct where you've defined Drop) then wrapping Pool in a Option and setting that to None once you have called `Pool::close` should do the trick.\r\n\r\n[Here's](https://gist.github.com/TimDeve/2c392c78673506d56eeb4b10e6863ff9) an example in Gist.\r\n\r\nI'm trying to figure out what has changed in the sqlx source code to cause that but I've not found it yet.\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214170313/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214170715","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1214170715","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1214170715,"node_id":"IC_kwDODb6dM85IXsZb","user":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-13T14:44:37Z","updated_at":"2022-08-13T14:44:37Z","body":"Maybe I should open a new issue. I'm pretty sure @TimDeve 's solution would block [here](https://gist.github.com/TimDeve/2c392c78673506d56eeb4b10e6863ff9#file-scaffold-rs-L58) with postgres ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214170715/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7183467880,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGsKwVo","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7183467880","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-13T14:44:37Z","performed_via_github_app":null},{"id":7183467882,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGsKwVq","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7183467882","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-13T14:44:37Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214171433","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1214171433","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1214171433,"node_id":"IC_kwDODb6dM85IXskp","user":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-13T14:49:14Z","updated_at":"2022-08-13T14:49:14Z","body":"Ah you're right we have opposite problem it seems? Mine is that `Pool::close` returns despite not having closed all connections and yours that it doesn't return ðŸ˜…","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214171433/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7183891841,"node_id":"RTE_lADODb6dM85Mf7QCzwAAAAGsMX2B","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7183891841","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2022-08-13T22:27:00Z","rename":{"from":"0.6.0: Pool::close does not completely close when awaited on MacOS","to":"0.6.0: Pool::close does not completely close when awaited"},"performed_via_github_app":null},{"id":7185020137,"node_id":"REFE_lADODb6dM85Mf7QCzwAAAAGsQrTp","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7185020137","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5433a13fb85c910031bda138317829a995863182","commit_url":"https://api.github.com/repos/TimDeve/slice-n-dice/commits/5433a13fb85c910031bda138317829a995863182","created_at":"2022-08-14T18:08:38Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214720016","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1214720016","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1214720016,"node_id":"IC_kwDODb6dM85IZygQ","user":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-15T07:49:55Z","updated_at":"2022-08-15T08:19:15Z","body":"> @jbis9051  I'm confused what you mean here. If you don't put the cleanup calls in the Drop impl, then on failure the database won't be cleaned up. \r\n\r\nYes, this is correct. Sorry I forgot to mention that. The [builtin](https://docs.rs/sqlx/latest/sqlx/attr.test.html) test runner also has this as a \"feature\" for debugging sakes. But this got me curious and the [internal impl](https://github.com/launchbadge/sqlx/blob/326254fb51d4f8b5de7bf610af7a5f4b7ecbfa3b/sqlx-core/src/pool/connection.rs#L133) of `PoolConnection` makes use of the `sqlx-rt` crate to fetch a [statically stored common runtime](https://github.com/launchbadge/sqlx/blob/326254fb51d4f8b5de7bf610af7a5f4b7ecbfa3b/sqlx-rt/src/rt_tokio.rs#L20) for AsyncDrop purposes. I guess this means that pool connections are designed to be transferable across runtimes from the same library and this is indeed a bug.\r\n\r\n> @TimDeve However the error is still there.\r\n\r\nCurious. You can see what worked for me [here](https://github.com/skorpi-and-friends/template_web_api_rust/blob/5fc1e2e1f30d6e86516d94b89c5461db3bc09cb7/src/main.rs#L310) and [here](https://github.com/skorpi-and-friends/template_web_api_rust/blob/5fc1e2e1f30d6e86516d94b89c5461db3bc09cb7/src/main.rs#L462-L466). I did try dropping the pool first but it did not help. \r\n\r\nAfter some investigation, I see that the async-std `block_on` function is not the same as the `futures::runtime::block_on` and yes, from the finding above, that should be sufficient for `pool.close` to function. Apologies for the confusion.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1214720016/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Yohe-Am","id":56622350,"node_id":"MDQ6VXNlcjU2NjIyMzUw","avatar_url":"https://avatars.githubusercontent.com/u/56622350?v=4","gravatar_id":"","url":"https://api.github.com/users/Yohe-Am","html_url":"https://github.com/Yohe-Am","followers_url":"https://api.github.com/users/Yohe-Am/followers","following_url":"https://api.github.com/users/Yohe-Am/following{/other_user}","gists_url":"https://api.github.com/users/Yohe-Am/gists{/gist_id}","starred_url":"https://api.github.com/users/Yohe-Am/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Yohe-Am/subscriptions","organizations_url":"https://api.github.com/users/Yohe-Am/orgs","repos_url":"https://api.github.com/users/Yohe-Am/repos","events_url":"https://api.github.com/users/Yohe-Am/events{/privacy}","received_events_url":"https://api.github.com/users/Yohe-Am/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7186794117,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGsXcaF","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7186794117","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-15T07:49:55Z","performed_via_github_app":null},{"id":7186794124,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGsXcaM","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7186794124","actor":{"login":"TimDeve","id":15091071,"node_id":"MDQ6VXNlcjE1MDkxMDcx","avatar_url":"https://avatars.githubusercontent.com/u/15091071?v=4","gravatar_id":"","url":"https://api.github.com/users/TimDeve","html_url":"https://github.com/TimDeve","followers_url":"https://api.github.com/users/TimDeve/followers","following_url":"https://api.github.com/users/TimDeve/following{/other_user}","gists_url":"https://api.github.com/users/TimDeve/gists{/gist_id}","starred_url":"https://api.github.com/users/TimDeve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimDeve/subscriptions","organizations_url":"https://api.github.com/users/TimDeve/orgs","repos_url":"https://api.github.com/users/TimDeve/repos","events_url":"https://api.github.com/users/TimDeve/events{/privacy}","received_events_url":"https://api.github.com/users/TimDeve/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-15T07:49:55Z","performed_via_github_app":null},{"id":7186794130,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGsXcaS","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7186794130","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-15T07:49:55Z","performed_via_github_app":null},{"id":7186794135,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGsXcaX","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7186794135","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-15T07:49:55Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217272838","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1217272838","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1217272838,"node_id":"IC_kwDODb6dM85IjhwG","user":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-16T23:31:40Z","updated_at":"2022-08-16T23:31:40Z","body":"> But this got me curious and the [internal impl](https://github.com/launchbadge/sqlx/blob/326254fb51d4f8b5de7bf610af7a5f4b7ecbfa3b/sqlx-core/src/pool/connection.rs#L133) of PoolConnection makes use of the sqlx-rt crate to fetch a [statically stored common runtime](https://github.com/launchbadge/sqlx/blob/326254fb51d4f8b5de7bf610af7a5f4b7ecbfa3b/sqlx-rt/src/rt_tokio.rs#L20) for AsyncDrop purposes.\r\n\r\nNo, it does not. It references the Tokio runtime set for the current thread the code is executing on (`sqlx_rt::Handle` is a reexport of `tokimo::runtime::Handle`), _only_ if the `runtime-tokio-*` feature is enabled. That static `RUNTIME` is for use in `sqlx-macros` only, which is implied by the comment immediately above it. It doesn't really need to exist in `sqlx-rt` for that reason which is why I've moved it in my current refactoring effort (#2039).\r\n\r\n>  I guess this means that pool connections are designed to be transferable across runtimes from the same library and this is indeed a bug.\r\n\r\nThey are not, and Tokio actually does _not_ like it when you move `TcpStream`s from one runtime to another. It _does_ continue to work but only until the `TcpStream`'s original runtime exits, at which point it will panic if you try to use it.\r\n\r\n`async-std` only ever has one runtime per process so that's different.\r\n\r\n> The [builtin](https://docs.rs/sqlx/latest/sqlx/attr.test.html) test runner also has this as a \"feature\" for debugging sakes.\r\n\r\nThat is a deliberate feature, yes. If you have a test failure, it's useful to go back and look at the contents of the database to help figure out what went wrong. They won't pile up forever, though. Old test databases are cleaned up every time on startup of any binary using `#[sqlx::test]` (as stated in the next paragraph after the one that describes this feature), so at most you'll have as many as the number of failed tests in the latest run.\r\n\r\nI had intended to add commands to `sqlx-cli` to manage test databases but I wanted to focus on getting the core `#[sqlx::test]` functionality working and merged.\r\n\r\n---\r\n\r\nAll that aside, I've realized that there's likely a TOCTOU bug in `Pool::close()` where it _thinks_ all connections have been released and then returns, but there may still be some in-flight.\r\n\r\nSpecifically, here: https://github.com/launchbadge/sqlx/blob/main/sqlx-core/src/pool/inner.rs#L257\r\n\r\nIf `.close()` is called on another thread between `.acquire_permit()` and `.try_increment_size()` when the size is zero, `.close()` will exit because it sees the size is zero and (incorrectly) assumes that there will never be any more connections on the pool.\r\n\r\nIt used to acquire `self.options.max_connections` permits right away, which would preclude any concurrent connection attempts, but that had to be changed with the `#[sqlx::test]` functionality as that allows pools to have a parent/child relationship where the child steals semaphore permits from the parent as needed, in order to enforce a global connection limit for all running tests. Simply put, there may not be `max_connections` permits on the semaphore anymore, and stealing them from the parent pool just so the child pool can close would be wasteful.\r\n\r\nI think the fix here would be to change `.try_increment_size()` to immediately return `Err(permit)` if the pool is closed, and then the logic in `acquire()` will loop back to the top and then return `Err(Error::PoolClosed)` on the next call to `.acquire_permit()`.\r\n\r\nThat should eliminate the possibility of `size` being zero and thus `.close()` returning while connection attempts can still be pending.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217272838/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217281498","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1217281498","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1217281498,"node_id":"IC_kwDODb6dM85Ijj3a","user":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-16T23:46:05Z","updated_at":"2022-08-16T23:46:28Z","body":"@abonander Have you been able to find any details with the postgres issue? or is it simply unsupported because of tokio? ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217281498/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7201214851,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGtOdGD","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7201214851","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-16T23:46:05Z","performed_via_github_app":null},{"id":7201214858,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGtOdGK","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7201214858","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-16T23:46:05Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217324506","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1217324506","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1217324506,"node_id":"IC_kwDODb6dM85IjuXa","user":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-17T00:51:12Z","updated_at":"2022-08-17T00:51:12Z","body":"The original issue concerns async-std, not Tokio. The discussion as a whole has been muddied quite a bit because of that.\r\n\r\nRegarding Tokio, using a separate runtime to close the pool is likely going to break things so I would avoid doing that. You should also never use `futures::executor::block_on()` as that may prevent Tokio's I/O driver from running, especially on a current-thread runtime like that created with `#[tokio::test]`.\r\n\r\nA minimal example reproducing the issue would be a big help.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217324506/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217407084","html_url":"https://github.com/launchbadge/sqlx/issues/1928#issuecomment-1217407084","issue_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1928","id":1217407084,"node_id":"IC_kwDODb6dM85IkChs","user":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-08-17T03:09:54Z","updated_at":"2022-08-17T03:09:54Z","body":"@abonander I can create a new issue if need be. Here's an example:\r\n\r\n```rs\r\nuse sqlx::migrate::MigrateDatabase;\r\nuse sqlx::postgres::PgPoolOptions;\r\nuse sqlx::{Executor, Pool, Postgres};\r\nuse std::{env, thread};\r\nuse tokio::runtime::Runtime;\r\nuse uuid::Uuid;\r\n\r\nstruct TempDb {\r\n    pool: Option<Pool<Postgres>>,\r\n    db_url: String,\r\n}\r\n\r\nimpl TempDb {\r\n    pub async fn new() -> TempDb {\r\n        let db_url = format!(\"{}/{}\", env::var(\"DB_URL\").unwrap(), Uuid::new_v4());\r\n        Postgres::create_database(&db_url).await.unwrap();\r\n        let pool = PgPoolOptions::new()\r\n            .max_connections(5)\r\n            .connect(&db_url)\r\n            .await\r\n            .unwrap();\r\n\r\n        Self {\r\n            pool: Some(pool),\r\n            db_url,\r\n        }\r\n    }\r\n\r\n    pub fn pool(&self) -> &Pool<Postgres> {\r\n        self.pool.as_ref().unwrap()\r\n    }\r\n}\r\n\r\nimpl Drop for TempDb {\r\n    fn drop(&mut self) {\r\n        let pool = self.pool.take().unwrap();\r\n        let db_url = self.db_url.clone();\r\n        thread::spawn(move || {\r\n            let runtime = Runtime::new().unwrap();\r\n            runtime.block_on(async {\r\n                println!(\"inside runtime\");\r\n                pool.close().await;\r\n                println!(\"closed\");\r\n                drop(pool);\r\n                println!(\"dropped\");\r\n                Postgres::drop_database(&db_url).await.unwrap();\r\n                println!(\"dropped db\");\r\n            });\r\n        })\r\n        .join()\r\n        .expect(\"thread failed\");\r\n    }\r\n}\r\n\r\n#[tokio::test]\r\npub async fn example() {\r\n    let db = TempDb::new().await;\r\n    let pool = db.pool();\r\n    pool.execute(\"SELECT 1\").await.unwrap();\r\n}\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/comments/1217407084/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jbis9051","id":32957090,"node_id":"MDQ6VXNlcjMyOTU3MDkw","avatar_url":"https://avatars.githubusercontent.com/u/32957090?v=4","gravatar_id":"","url":"https://api.github.com/users/jbis9051","html_url":"https://github.com/jbis9051","followers_url":"https://api.github.com/users/jbis9051/followers","following_url":"https://api.github.com/users/jbis9051/following{/other_user}","gists_url":"https://api.github.com/users/jbis9051/gists{/gist_id}","starred_url":"https://api.github.com/users/jbis9051/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbis9051/subscriptions","organizations_url":"https://api.github.com/users/jbis9051/orgs","repos_url":"https://api.github.com/users/jbis9051/repos","events_url":"https://api.github.com/users/jbis9051/events{/privacy}","received_events_url":"https://api.github.com/users/jbis9051/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7201894487,"node_id":"MEE_lADODb6dM85Mf7QCzwAAAAGtRDBX","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7201894487","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-08-17T03:09:54Z","performed_via_github_app":null},{"id":7201894489,"node_id":"SE_lADODb6dM85Mf7QCzwAAAAGtRDBZ","url":"https://api.github.com/repos/launchbadge/sqlx/issues/events/7201894489","actor":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-08-17T03:09:54Z","performed_via_github_app":null}]