{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1966","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1966/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1966/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1966/events","html_url":"https://github.com/launchbadge/sqlx/issues/1966","id":1301902795,"node_id":"I_kwDODb6dM85NmXXL","number":1966,"title":"Postgres migrations: incomplete transaction handling","user":{"login":"crepererum","id":1529400,"node_id":"MDQ6VXNlcjE1Mjk0MDA=","avatar_url":"https://avatars.githubusercontent.com/u/1529400?v=4","gravatar_id":"","url":"https://api.github.com/users/crepererum","html_url":"https://github.com/crepererum","followers_url":"https://api.github.com/users/crepererum/followers","following_url":"https://api.github.com/users/crepererum/following{/other_user}","gists_url":"https://api.github.com/users/crepererum/gists{/gist_id}","starred_url":"https://api.github.com/users/crepererum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/crepererum/subscriptions","organizations_url":"https://api.github.com/users/crepererum/orgs","repos_url":"https://api.github.com/users/crepererum/repos","events_url":"https://api.github.com/users/crepererum/events{/privacy}","received_events_url":"https://api.github.com/users/crepererum/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-07-12T11:06:55Z","updated_at":"2022-09-13T00:52:05Z","closed_at":"2022-09-13T00:52:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Abstract\r\nFor postgres, the migration script and the `_sqlx_migrations` state change run in two different transactions, which requires that the migration scripts are idempotent. This is quite hard to archive for certain scripts. It would be nice if both parts would run within the same transaction.\r\n\r\n# Technical Details\r\nSee this code here:\r\n\r\nhttps://github.com/launchbadge/sqlx/blob/d9fd21c94e57db3e02bf2ef6b3a9cc94296ce64a/sqlx-core/src/postgres/migrate.rs#L217-L247\r\n\r\nNow imagine that the process dies here:\r\n\r\nhttps://github.com/launchbadge/sqlx/blob/d9fd21c94e57db3e02bf2ef6b3a9cc94296ce64a/sqlx-core/src/postgres/migrate.rs#L229\r\n\r\nNow the migration script was executed and committed, but SQLx forgot about that fact. A subsequent migrator run will execute the script again.\r\n\r\n# References\r\nI'm quite certain that I've observed that issue with [InfluxDB IOx](https://github.com/influxdata/influxdb_iox/) (commit `500ece7c138e6b4f04b6761c68bd447ad69a6845`) which uses `sqlx = 0.6.0` and postgres 13.6.","closed_by":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/1966/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/1966/timeline","performed_via_github_app":null,"state_reason":"completed"}