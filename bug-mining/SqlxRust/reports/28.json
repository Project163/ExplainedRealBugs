{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/447","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447/events","html_url":"https://github.com/launchbadge/sqlx/issues/447","id":645271576,"node_id":"MDU6SXNzdWU2NDUyNzE1NzY=","number":447,"title":"PgListener will silently lose notifications","user":{"login":"Cocalus","id":23244939,"node_id":"MDQ6VXNlcjIzMjQ0OTM5","avatar_url":"https://avatars.githubusercontent.com/u/23244939?v=4","gravatar_id":"","url":"https://api.github.com/users/Cocalus","html_url":"https://github.com/Cocalus","followers_url":"https://api.github.com/users/Cocalus/followers","following_url":"https://api.github.com/users/Cocalus/following{/other_user}","gists_url":"https://api.github.com/users/Cocalus/gists{/gist_id}","starred_url":"https://api.github.com/users/Cocalus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cocalus/subscriptions","organizations_url":"https://api.github.com/users/Cocalus/orgs","repos_url":"https://api.github.com/users/Cocalus/repos","events_url":"https://api.github.com/users/Cocalus/events{/privacy}","received_events_url":"https://api.github.com/users/Cocalus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-06-25T07:41:15Z","updated_at":"2020-07-19T04:43:11Z","closed_at":"2020-07-19T04:43:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The current PgListener API will silently lose notifications that occur during a connection reset. The notification loss is unavoidable with how they work on postgres side, but the silence can be fixed.\r\n\r\nOne use of notifications is to keep a data structure closely in sync with the database (by putting notification generating triggers in the right places). This is even mentioned as a use case in paragraph 5 of\r\nhttps://www.postgresql.org/docs/11/sql-notify.html\r\n\r\nThis avoids having to poll with potentially heavy queries. Typically if the session (connection) breaks, then on reconnect the listen is remade then the data structure is resync to the database via the expensive query. This is because only notifications that occur after the listen will be returned, so any notifications that occur after the connection breaks to before the reconnect does the listen are lost.\r\n\r\nThe problem is the PgListener API has no way to indicate that the session was lost (and with it potentially notifications), so it's not possible to know when local data structure needs a full resync.\r\n\r\nEither there needs to be some kind of reset flags/message in the notification stream. Or some lower level API that needs to be explicitly reconnected (streams until error, with a reset method). For this particular pattern as soon as the connection is lost, a full resync is needed, so any notifications not already process are not needed. So erroring early would be better for this use case but there maybe others I'm unaware of that don't want that.","closed_by":{"login":"mehcode","id":753919,"node_id":"MDQ6VXNlcjc1MzkxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/753919?v=4","gravatar_id":"","url":"https://api.github.com/users/mehcode","html_url":"https://github.com/mehcode","followers_url":"https://api.github.com/users/mehcode/followers","following_url":"https://api.github.com/users/mehcode/following{/other_user}","gists_url":"https://api.github.com/users/mehcode/gists{/gist_id}","starred_url":"https://api.github.com/users/mehcode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mehcode/subscriptions","organizations_url":"https://api.github.com/users/mehcode/orgs","repos_url":"https://api.github.com/users/mehcode/repos","events_url":"https://api.github.com/users/mehcode/events{/privacy}","received_events_url":"https://api.github.com/users/mehcode/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/447/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/447/timeline","performed_via_github_app":null,"state_reason":"completed"}