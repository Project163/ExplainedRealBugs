{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/2834","repository_url":"https://api.github.com/repos/launchbadge/sqlx","labels_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2834/labels{/name}","comments_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2834/comments","events_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2834/events","html_url":"https://github.com/launchbadge/sqlx/issues/2834","id":1964611979,"node_id":"I_kwDODb6dM851GZmL","number":2834,"title":"sqlx query a lot of data cause tokio bad task.","user":{"login":"yuyang-ok","id":96557710,"node_id":"U_kgDOBcFajg","avatar_url":"https://avatars.githubusercontent.com/u/96557710?v=4","gravatar_id":"","url":"https://api.github.com/users/yuyang-ok","html_url":"https://github.com/yuyang-ok","followers_url":"https://api.github.com/users/yuyang-ok/followers","following_url":"https://api.github.com/users/yuyang-ok/following{/other_user}","gists_url":"https://api.github.com/users/yuyang-ok/gists{/gist_id}","starred_url":"https://api.github.com/users/yuyang-ok/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yuyang-ok/subscriptions","organizations_url":"https://api.github.com/users/yuyang-ok/orgs","repos_url":"https://api.github.com/users/yuyang-ok/repos","events_url":"https://api.github.com/users/yuyang-ok/events{/privacy}","received_events_url":"https://api.github.com/users/yuyang-ok/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1757378993,"node_id":"MDU6TGFiZWwxNzU3Mzc4OTkz","url":"https://api.github.com/repos/launchbadge/sqlx/labels/bug","name":"bug","color":"e11d21","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-10-27T01:34:01Z","updated_at":"2023-11-05T09:38:51Z","closed_at":"2023-11-04T00:23:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Description\r\nsqlx query a lot of data cause tokio bad task.\r\n\r\n\r\n### Minimal Reproduction\r\nA small code snippet or a link to a Github repo or Gist, with instructions on reproducing the bug.\r\n~~~\r\nuse std::time::Duration;\r\n\r\nuse bb8_postgres::tokio_postgres::{self, NoTls};\r\nuse sqlx::Connection;\r\n\r\n#[tokio::main]\r\n\r\nasync fn main() {\r\n    // for _ in 0..10 {\r\n    //     println!(\"sqlx used:{:?}\", sqlx_time().await.unwrap());\r\n    //     println!(\"bb8 used:{:?}\", bb8_time().await.unwrap());\r\n    // }\r\n    // tokio::spawn(async {\r\n    //     println!(\"sqlx used:{:?}\", sqlx_time().await.unwrap());\r\n    // });\r\n    tokio::spawn(async {\r\n        println!(\"sqlx used:{:?}\", sqlx_time().await.unwrap());\r\n    });\r\n    let now = std::time::Instant::now();\r\n    loop {\r\n        tokio::time::sleep(std::time::Duration::from_secs(1)).await;\r\n        println!(\"print from main:{:?}\", now.elapsed());\r\n    }\r\n}\r\n\r\nconst Q: &str = \"select * from orders\";\r\n\r\nasync fn sqlx_time() -> anyhow::Result<Duration> {\r\n    let mut opts = sqlx::postgres::PgConnectOptions::new();\r\n    opts = opts\r\n        .host(\"192.168.0.227\")\r\n        .username(\"postgres\")\r\n        .password(\"zalando\")\r\n        .database(\"citus\")\r\n        .port(19000);\r\n\r\n    let mut client = sqlx::postgres::PgConnection::connect_with(&opts).await?;\r\n    let now = std::time::Instant::now();\r\n\r\n    let _: Vec<_> = sqlx::query(Q).fetch_all(&mut client).await?;\r\n\r\n    Ok(now.elapsed())\r\n}\r\n\r\n~~~\r\n\r\n\r\n~~~\r\n[package]\r\nname = \"abc-rust\"\r\nversion = \"0.1.0\"\r\nedition = \"2021\"\r\n\r\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\r\n\r\n[dependencies]\r\nanyhow = \"1.0.75\"\r\nbb8-postgres = \"0.8.1\"\r\nconsole-subscriber = \"0.2.0\"\r\nsqlx = { version = \"0.7.2\", features = [\"postgres\", \"runtime-tokio\"] }\r\ntokio = { version = \"1.32.0\", features = [\"full\"] }\r\ntracing = \"0.1.40\"\r\ntracing-subscriber = \"0.3.17\"\r\n\r\n~~~\r\n\r\n~~~\r\nprint from main:5.869607887s\r\nprint from main:8.865092778s\r\nprint from main:14.790433884s\r\nprint from main:15.791615327s\r\nprint from main:16.799191212s\r\nprint from main:20.282701128s\r\nprint from main:24.261279304s\r\nprint from main:36.98605543s\r\nprint from main:38.656715161s\r\nprint from main:42.124719785s\r\nprint from main:43.537019533s\r\nprint from main:44.54424445s\r\nsqlx used:44.795342161s\r\nprint from main:45.548273104s\r\nprint from main:46.565033701s\r\nprint from main:47.57896779s\r\n~~~\r\nI use `tokio-console` I get this.\r\n~~~\r\nconnection: http://127.0.0.1:6669/ (CONNECTED)\r\nviews: t = tasks, r = resources\r\ncontrols: return to task list = ⎋ esc, toggle pause = space, quit = q              \r\n╭Warnings───────────────────────────────────────────────────────────────────────────────────────────────────╮\r\n│⚠ This task has woken itself for more than 50% of its total wakeups (99%)                                  │\r\n╰───────────────────────────────────────────────────────────────────────────────────────────────────────────╯\r\n╭Task────────────────────────────────────────────────╮╭Waker────────────────────────────────────────────────╮\r\n│ID: 10 ▶                                            ││Current wakers: 0 (clones: 2530933, drops: 2530933)  │\r\n│Target: tokio::task                                 ││Woken: 2530933 times, last woken: 20.371µs ago       │\r\n│Location: src/main.rs:19:5                          ││Self Wakes: 2530928 times (99%)                      │\r\n│Total Time: 30.00s                                  ││                                                     │\r\n│Busy: 29.98s (99.92%)                               ││                                                     │\r\n│Scheduled: 283.75µs (0.00%)                         ││                                                     │\r\n│Idle: 22.42ms (0.07%)                               ││                                                     │\r\n│                                                    ││                                                     │\r\n╰────────────────────────────────────────────────────╯╰─────────────────────────────────────────────────────╯\r\n╭Poll Times Percentiles─╮╭Poll Times Histogram──────────────────────────────────────────────────────────────╮\r\n│p10: 137.22µs          ││1█   █           █              █                                              █  │\r\n│p25: 149.50µs          ││ 136.19µs                                                                385.02µs │\r\n╰───────────────────────╯╰──────────────────────────────────────────────────────────────────────────────────\r\n~~~\r\n\r\n\r\n\r\n### Info\r\n* SQLx version: [REQUIRED]\r\n 0.7.2\r\n* SQLx features enabled: [REQUIRED]\r\n \"postgres\", \"runtime-tokio\"\r\n* Database server and version: [REQUIRED] (MySQL / Postgres / SQLite <x.y.z>)\r\n* Operating system: [REQUIRED]\r\n ~~~\r\n  uname -a \r\nLinux yuyang-virtual-machine 6.2.0-35-generic #35~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Oct  6 10:23:26 UTC 2 x86_64 x86_64 x86_64 GNU/Linux\r\n ~~~\r\n* `rustc --version`: [REQUIRED]\r\n~~~\r\nyuyang@yuyang-virtual-machine:~/data-fabric$ rustc --version \r\nrustc 1.74.0-nightly (3223b0b5e 2023-09-20)\r\n~~~","closed_by":{"login":"abonander","id":3198595,"node_id":"MDQ6VXNlcjMxOTg1OTU=","avatar_url":"https://avatars.githubusercontent.com/u/3198595?v=4","gravatar_id":"","url":"https://api.github.com/users/abonander","html_url":"https://github.com/abonander","followers_url":"https://api.github.com/users/abonander/followers","following_url":"https://api.github.com/users/abonander/following{/other_user}","gists_url":"https://api.github.com/users/abonander/gists{/gist_id}","starred_url":"https://api.github.com/users/abonander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abonander/subscriptions","organizations_url":"https://api.github.com/users/abonander/orgs","repos_url":"https://api.github.com/users/abonander/repos","events_url":"https://api.github.com/users/abonander/events{/privacy}","received_events_url":"https://api.github.com/users/abonander/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/launchbadge/sqlx/issues/2834/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/launchbadge/sqlx/issues/2834/timeline","performed_via_github_app":null,"state_reason":"completed"}