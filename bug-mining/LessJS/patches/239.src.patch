diff --git a/Gruntfile.js b/Gruntfile.js
index ae240510..f56e1043 100644
--- a/Gruntfile.js
+++ b/Gruntfile.js
@@ -200,9 +200,7 @@ module.exports = function(grunt) {
                 }
             },
             build: {
-                command: [
-                    scriptRuntime + " build/rollup.js --dist"
-                ].join(" && ")
+                command: scriptRuntime + " build/rollup.js --dist"
             },
             testbuild: {
                 command: [
@@ -211,6 +209,12 @@ module.exports = function(grunt) {
                     scriptRuntime + " build/rollup.js --browser --out=./test/browser/less.min.js"
                 ].join(" && ")
             },
+            testcjs: {
+                command: scriptRuntime + " build/rollup.js --node --out=./tmp/less.cjs.js"
+            },
+            testbrowser: {
+                command: scriptRuntime + " build/rollup.js --browser --out=./test/browser/less.min.js"
+            },
             test: {
                 command: "node test/index.js"
             },
@@ -495,7 +499,7 @@ module.exports = function(grunt) {
 
     // Create the browser version of less.js
     grunt.registerTask("browsertest-lessjs", [
-        "shell:testbuild"
+        "shell:testbrowser"
     ]);
 
     // Run all browser tests
@@ -567,8 +571,11 @@ module.exports = function(grunt) {
     // Run shell plugin test
     grunt.registerTask("shell-plugin", ["shell:plugin"]);
 
-    // Run all tests except browsertest
-    grunt.registerTask("quicktest", testTasks.slice(0, -1));
+    // Quickly build and run Node tests
+    grunt.registerTask("quicktest", [
+        "shell:testcjs",
+        "shell:test"
+    ]);
 
     // generate a good test environment for testing sourcemaps
     grunt.registerTask("sourcemap-test", [
@@ -579,5 +586,8 @@ module.exports = function(grunt) {
     ]);
 
     // Run benchmark
-    grunt.registerTask("benchmark", ["shell:benchmark"]);
+    grunt.registerTask("benchmark", [
+        "shell:testcjs",
+        "shell:benchmark"
+    ]);
 };
diff --git a/benchmark/benchmark.less b/benchmark/benchmark.less
index c2887a69..72aa04f6 100644
--- a/benchmark/benchmark.less
+++ b/benchmark/benchmark.less
@@ -3976,4 +3976,7 @@ body {
 
 .mixout ('left') {
   left: 1;
-}
\ No newline at end of file
+}
+
+// add extend
+.btn:extend(.button all) {}
\ No newline at end of file
diff --git a/benchmark/index.js b/benchmark/index.js
index 87b3da77..3dfb14ab 100644
--- a/benchmark/index.js
+++ b/benchmark/index.js
@@ -2,7 +2,7 @@ var path = require('path'),
     fs = require('fs'),
     now = require("performance-now");
 
-var less = require('../lib/less-node');
+var less = require('../test/less');
 var file = path.join(__dirname, 'benchmark.less');
 
 if (process.argv[2]) { file = path.join(process.cwd(), process.argv[2]) }
diff --git a/lib/less/parser/parser.js b/lib/less/parser/parser.js
index 0e534a3f..a5e5585c 100644
--- a/lib/less/parser/parser.js
+++ b/lib/less/parser/parser.js
@@ -327,8 +327,8 @@ const Parser = function Parser(context, imports, fileInfo) {
                         continue;
                     }
 
-                    node = mixin.definition() || this.declaration() || this.ruleset() ||
-                        mixin.call(false, false) || this.variableCall() || this.entities.call() || this.atrule();
+                    node = mixin.definition() || this.declaration() || mixin.call(false, false) || 
+                        this.ruleset() || this.variableCall() || this.entities.call() || this.atrule();
                     if (node) {
                         root.push(node);
                     } else {
@@ -1159,7 +1159,7 @@ const Parser = function Parser(context, imports, fileInfo) {
                             parserInput.restore();
                         }
                     } else {
-                        parserInput.forget();
+                        parserInput.restore();
                     }
                 },
             
diff --git a/test/css/namespacing/namespacing-functions.css b/test/css/namespacing/namespacing-functions.css
index 78ea7b17..87208fd7 100644
--- a/test/css/namespacing/namespacing-functions.css
+++ b/test/css/namespacing/namespacing-functions.css
@@ -2,3 +2,9 @@
   width: 20px;
   bar: val;
 }
+.bar {
+  width: test;
+}
+.example {
+  value: lookup;
+}
diff --git a/test/less-test.js b/test/less-test.js
index 841579d5..5e127ab9 100644
--- a/test/less-test.js
+++ b/test/less-test.js
@@ -7,15 +7,7 @@ module.exports = function() {
         doBomTest = false,
         clone = require('clone');
 
-    var less;
-
-    // Dist fallback for NPM-installed Less (for plugins that do testing)
-    try {
-        less = require('../tmp/less.cjs.js');
-    }
-    catch (e) {
-        less = require('../dist/less.cjs.js');
-    }
+    var less = require('./less');
 
     var stylize = require('../lib/less-node/lessc-helper').stylize;
 
diff --git a/test/less.js b/test/less.js
new file mode 100644
index 00000000..c74cc0b4
--- /dev/null
+++ b/test/less.js
@@ -0,0 +1,11 @@
+var less;
+
+// Dist fallback for NPM-installed Less (for plugins that do testing)
+try {
+    less = require('../tmp/less.cjs.js');
+}
+catch (e) {
+    less = require('../dist/less.cjs.js');
+}
+
+module.exports = less;
\ No newline at end of file
diff --git a/test/less/namespacing/namespacing-functions.less b/test/less/namespacing/namespacing-functions.less
index 4be4ce91..8e09263a 100644
--- a/test/less/namespacing/namespacing-functions.less
+++ b/test/less/namespacing/namespacing-functions.less
@@ -8,4 +8,30 @@
 
 @return: {
   single: val;
+}
+
+// Issue #3405
+#lookup {
+  @prop: test;
+}
+
+.mix (@var) {
+  width: @var;
+}
+
+.bar {
+  .mix(#lookup[@prop]);
+}
+
+// Issue #3406
+.mix2 (@n) {
+  value: @n;
+}
+#lookup2 {
+  @var: .mix2(lookup);
+}
+.example {
+  // #lookup[@var](); -- fails, need the following alias
+  @dr: #lookup2[@var];
+  @dr();
 }
\ No newline at end of file
