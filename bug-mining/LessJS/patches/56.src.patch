diff --git a/lib/less/browser.js b/lib/less/browser.js
index 43559ad1..193014bc 100644
--- a/lib/less/browser.js
+++ b/lib/less/browser.js
@@ -138,8 +138,8 @@ function loadStyleSheet(sheet, callback, reload, remaining) {
     var contents  = sheet.contents || {};  // Passing a ref to top importing parser content cache trough 'sheet' arg.
     var url       = window.location.href.replace(/[#?].*$/, '');
     var href      = sheet.href.replace(/\?.*$/, '');
-    var css       = cache && cache.getItem(href);
-    var timestamp = cache && cache.getItem(href + ':timestamp');
+    var css       = cache && cache.getItem(sheet.href);
+    var timestamp = cache && cache.getItem(sheet.href + ':timestamp');
     var styles    = { css: css, timestamp: timestamp };
 
     // Stylesheets in IE don't always return the full path
@@ -169,16 +169,16 @@ function loadStyleSheet(sheet, callback, reload, remaining) {
                     'contents': contents,    // Passing top importing parser content cache ref down.
                     dumpLineNumbers: less.dumpLineNumbers
                 }).parse(data, function (e, root) {
-                    if (e) { return error(e, href) }
+                    if (e) { return error(e, sheet.href) }
                     try {
                         callback(e, root, data, sheet, { local: false, lastModified: lastModified, remaining: remaining });
-                        removeNode(document.getElementById('less-error-message:' + extractId(href)));
+                        removeNode(document.getElementById('less-error-message:' + extractId(sheet.href)));
                     } catch (e) {
-                        error(e, href);
+                        error(e, sheet.href);
                     }
                 });
             } catch (e) {
-                error(e, href);
+                error(e, sheet.href);
             }
         }
     }, function (status, url) {
@@ -189,8 +189,7 @@ function loadStyleSheet(sheet, callback, reload, remaining) {
 function extractId(href) {
     return href.replace(/^[a-z]+:\/\/?[^\/]+/, '' )  // Remove protocol & domain
                .replace(/^\//,                 '' )  // Remove root /
-               .replace(/\?.*$/,               '' )  // Remove query
-               .replace(/\.[^\.\/]+$/,         '' )  // Remove file extension
+               .replace(/\.[a-zA-Z]+$/,        '' )  // Remove simple extension
                .replace(/[^\.\w-]+/g,          '-')  // Replace illegal characters
                .replace(/\./g,                 ':'); // Replace dots with colons(for valid id)
 }
@@ -199,7 +198,7 @@ function createCSS(styles, sheet, lastModified) {
     var css;
 
     // Strip the query-string
-    var href = sheet.href ? sheet.href.replace(/\?.*$/, '') : '';
+    var href = sheet.href || '';
 
     // If there is no title set, use the filename, minus the extension
     var id = 'less:' + (sheet.title || extractId(href));
@@ -211,7 +210,7 @@ function createCSS(styles, sheet, lastModified) {
         if( sheet.media ){ css.media = sheet.media; }
         css.id = id;
         var nextEl = sheet && sheet.nextSibling || null;
-        nextEl.parentNode.insertBefore(css, nextEl);
+        (nextEl || document.getElementsByTagName('head')[0]).parentNode.insertBefore(css, nextEl);
     }
 
     if (css.styleSheet) { // IE
@@ -308,7 +307,7 @@ function error(e, href) {
     var template = '<li><label>{line}</label><pre class="{class}">{content}</pre></li>';
     var elem = document.createElement('div'), timer, content, error = [];
     var filename = e.filename || href;
-    var filenameNoPath = filename.match(/([^\/]+)$/)[1];
+    var filenameNoPath = filename.match(/([^\/]+(\?.*)?)$/)[1];
 
     elem.id        = id;
     elem.className = "less-error-message";
@@ -400,4 +399,3 @@ function error(e, href) {
         }, 10);
     }
 }
-
