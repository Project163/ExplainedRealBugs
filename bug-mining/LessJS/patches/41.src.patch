diff --git a/lib/less/tree/media.js b/lib/less/tree/media.js
index 3bc4c54a..d2a53476 100644
--- a/lib/less/tree/media.js
+++ b/lib/less/tree/media.js
@@ -22,10 +22,6 @@ tree.Media.prototype = {
             env.mediaPath = [];
         }
         
-        var blockIndex = env.mediaBlocks.length;
-        env.mediaPath.push(this);
-        env.mediaBlocks.push(this);
-
         var media = new(tree.Media)([], []);
         if(this.debugInfo) {
             this.ruleset.debugInfo = this.debugInfo;
@@ -33,11 +29,13 @@ tree.Media.prototype = {
         }
         media.features = this.features.eval(env);
         
+        env.mediaPath.push(media);
+        env.mediaBlocks.push(media);
+        
         env.frames.unshift(this.ruleset);
         media.ruleset = this.ruleset.eval(env);
         env.frames.shift();
         
-        env.mediaBlocks[blockIndex] = media;
         env.mediaPath.pop();
 
         return env.mediaPath.length === 0 ? media.evalTop(env) :
diff --git a/test/css/media.css b/test/css/media.css
index 2be53ef7..d16ce63f 100644
--- a/test/css/media.css
+++ b/test/css/media.css
@@ -174,3 +174,22 @@
     background: red;
   }
 }
+body {
+  background: red;
+}
+@media (max-width: 500px) {
+  body {
+    background: green;
+  }
+}
+@media (max-width: 1000px) {
+  body {
+    background: red;
+    background: blue;
+  }
+}
+@media (max-width: 1000px) and (max-width: 500px) {
+  body {
+    background: green;
+  }
+}
diff --git a/test/less/media.less b/test/less/media.less
index 3dc1aabb..b401ae9f 100644
--- a/test/less/media.less
+++ b/test/less/media.less
@@ -177,3 +177,23 @@ body {
     background: red;
   }
 }
+
+.bg() {
+    background: red;
+
+    @media (max-width: 500px) {
+        background: green;
+    }
+}
+
+body {
+    .bg();
+}
+
+@bpMedium: 1000px;
+@media (max-width: @bpMedium) {
+    body {        
+        .bg();
+        background: blue;
+    }
+}
