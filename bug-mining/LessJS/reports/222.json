{"url":"https://api.github.com/repos/less/less.js/issues/3205","repository_url":"https://api.github.com/repos/less/less.js","labels_url":"https://api.github.com/repos/less/less.js/issues/3205/labels{/name}","comments_url":"https://api.github.com/repos/less/less.js/issues/3205/comments","events_url":"https://api.github.com/repos/less/less.js/issues/3205/events","html_url":"https://github.com/less/less.js/issues/3205","id":319085385,"node_id":"MDU6SXNzdWUzMTkwODUzODU=","number":3205,"title":"Variables in detached rulesets not visited by visitor?","user":{"login":"miyaokamarina","id":37388187,"node_id":"MDQ6VXNlcjM3Mzg4MTg3","avatar_url":"https://avatars.githubusercontent.com/u/37388187?v=4","gravatar_id":"","url":"https://api.github.com/users/miyaokamarina","html_url":"https://github.com/miyaokamarina","followers_url":"https://api.github.com/users/miyaokamarina/followers","following_url":"https://api.github.com/users/miyaokamarina/following{/other_user}","gists_url":"https://api.github.com/users/miyaokamarina/gists{/gist_id}","starred_url":"https://api.github.com/users/miyaokamarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/miyaokamarina/subscriptions","organizations_url":"https://api.github.com/users/miyaokamarina/orgs","repos_url":"https://api.github.com/users/miyaokamarina/repos","events_url":"https://api.github.com/users/miyaokamarina/events{/privacy}","received_events_url":"https://api.github.com/users/miyaokamarina/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2103265,"node_id":"MDU6TGFiZWwyMTAzMjY1","url":"https://api.github.com/repos/less/less.js/labels/bug","name":"bug","color":"e10c02","default":true,"description":null},{"id":9603611,"node_id":"MDU6TGFiZWw5NjAzNjEx","url":"https://api.github.com/repos/less/less.js/labels/high%20priority","name":"high priority","color":"E00000","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2018-05-01T01:03:14Z","updated_at":"2018-06-27T06:26:02Z","closed_at":"2018-06-27T06:26:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have the following plugin `foo.js`\r\n\r\n```javascript\r\nmodule.exports = {\r\n    install({ tree: { Quoted }, visitors }, manager) {\r\n        class Visitor {\r\n            constructor() {\r\n                this.native = new visitors.Visitor(this);\r\n\r\n                this.isPreEvalVisitor = true;\r\n                this.isReplacing = true;\r\n            }\r\n\r\n            run(root) {\r\n                console.log(\r\n                    root\r\n                        .rules[2]\r\n                        .rules[0]\r\n                        .arguments[0]\r\n                        .value\r\n                        .ruleset\r\n                        .rules[0]\r\n                        .value\r\n                        .value[0]\r\n                        .value[0]\r\n                        .type,\r\n                ); // 'Variable'\r\n\r\n                return this.native.visit(root);\r\n            }\r\n\r\n            visitVariable(node) {\r\n                console.log('visited');\r\n\r\n                return new Quoted(`'`, 'bar', true);\r\n            }\r\n        }\r\n\r\n        manager.addVisitor(new Visitor());\r\n    },\r\n};\r\n```\r\n\r\nand the following Less code\r\n\r\n```less\r\n@plugin './foo';\r\n\r\n.foo(@rules: {}) {\r\n    :root.foo & {\r\n        @rules();\r\n    }\r\n}\r\n\r\n.foo {\r\n    .foo({\r\n        --foo: @foo;\r\n    });\r\n}\r\n```\r\n\r\nWhen trying to compile this code using `lessc` and/or `less-loader`, Less fails with error `SyntaxError: variable @foo is undefined`.\r\n\r\nVariables in other contexts (in non-detached rulesets, at top level, in _named_ detached rulests) are visited as expected:\r\n\r\n```less\r\n@plugin './foo';\r\n\r\n@bar: @foo;\r\n\r\n.foo {\r\n    --foo: @foo;\r\n    --bar: @bar;\r\n    @baz();\r\n}\r\n\r\n@baz: {\r\n    --baz: @foo;\r\n};\r\n\r\n// ↓↓↓↓\r\n\r\n.foo {\r\n  --foo: bar;\r\n  --bar: bar;\r\n  --baz: bar;\r\n}\r\n```\r\n\r\nMaybe other node types also affected, but I didn't test it.\r\n\r\n**Less version:** 3.0.2.","closed_by":{"login":"matthew-dean","id":414752,"node_id":"MDQ6VXNlcjQxNDc1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/414752?v=4","gravatar_id":"","url":"https://api.github.com/users/matthew-dean","html_url":"https://github.com/matthew-dean","followers_url":"https://api.github.com/users/matthew-dean/followers","following_url":"https://api.github.com/users/matthew-dean/following{/other_user}","gists_url":"https://api.github.com/users/matthew-dean/gists{/gist_id}","starred_url":"https://api.github.com/users/matthew-dean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthew-dean/subscriptions","organizations_url":"https://api.github.com/users/matthew-dean/orgs","repos_url":"https://api.github.com/users/matthew-dean/repos","events_url":"https://api.github.com/users/matthew-dean/events{/privacy}","received_events_url":"https://api.github.com/users/matthew-dean/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/less/less.js/issues/3205/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/less/less.js/issues/3205/timeline","performed_via_github_app":null,"state_reason":"completed"}