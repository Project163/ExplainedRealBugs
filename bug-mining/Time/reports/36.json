{"url":"https://api.github.com/repos/JodaOrg/joda-time/issues/171","repository_url":"https://api.github.com/repos/JodaOrg/joda-time","labels_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/171/labels{/name}","comments_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/171/comments","events_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/171/events","html_url":"https://github.com/JodaOrg/joda-time/issues/171","id":41752117,"node_id":"MDU6SXNzdWU0MTc1MjExNw==","number":171,"title":"Deadlock in DateTimeZone/FixedDateTimeZone static initialization","user":{"login":"david-at-aws","id":5216241,"node_id":"MDQ6VXNlcjUyMTYyNDE=","avatar_url":"https://avatars.githubusercontent.com/u/5216241?v=4","gravatar_id":"","url":"https://api.github.com/users/david-at-aws","html_url":"https://github.com/david-at-aws","followers_url":"https://api.github.com/users/david-at-aws/followers","following_url":"https://api.github.com/users/david-at-aws/following{/other_user}","gists_url":"https://api.github.com/users/david-at-aws/gists{/gist_id}","starred_url":"https://api.github.com/users/david-at-aws/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/david-at-aws/subscriptions","organizations_url":"https://api.github.com/users/david-at-aws/orgs","repos_url":"https://api.github.com/users/david-at-aws/repos","events_url":"https://api.github.com/users/david-at-aws/events{/privacy}","received_events_url":"https://api.github.com/users/david-at-aws/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":42317690,"node_id":"MDU6TGFiZWw0MjMxNzY5MA==","url":"https://api.github.com/repos/JodaOrg/joda-time/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null},{"id":42318930,"node_id":"MDU6TGFiZWw0MjMxODkzMA==","url":"https://api.github.com/repos/JodaOrg/joda-time/labels/Fixed","name":"Fixed","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-09-02T20:39:49Z","updated_at":"2014-09-08T23:00:10Z","closed_at":"2014-09-08T16:22:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We've got a [user reporting a deadlock](https://forums.aws.amazon.com/thread.jspa?messageID=566952#566952) while using the AWS SDK for Java. The user is calling into two different parts of the SDK from two different threads. One ends up accessing [DateTimeZone.UTC](https://github.com/JodaOrg/joda-time/blob/master/src/main/java/org/joda/time/DateTimeZone.java#L94) while the other ends up directly creating a new [FixedDateTimeZone](https://github.com/JodaOrg/joda-time/blob/master/src/main/java/org/joda/time/tz/FixedDateTimeZone.java).\n\nThread 1 grabs a lock on DateTimeZone to run its static initialization block. Thread 2 grabs a lock on FixedDateTimeZone to run its static initialization block. FixedDateTimeZone extends DateTimeZone, so the first thing Thread 2 does is try to grab a lock on DateTimeZone to see if it has been initialized yet. Meanwhile, Thread 1 attempts to grab a lock on FixedDateTimeZone to see if it has been initialized yet because the static initializer creates an instance of FixedDateTimeZone to assign to DateTimeZone.UTC. Boom, deadlock.\n\nMinimal repro code:\n\n``` java\nimport org.joda.time.DateTimeZone;\nimport org.joda.time.tz.FixedDateTimeZone;\n\npublic class Test {\n    public static void main(String[] args) {\n        Thread one = new Thread() {\n            @Override\n            public void run() {\n                DateTimeZone zone = DateTimeZone.UTC;\n            }\n        };\n\n        Thread two = new Thread() {\n            @Override\n            public void run() {\n                new FixedDateTimeZone(\"GMT\", \"GMT\", 0, 0);\n            }\n        };\n\n        one.start();\n        two.start();\n    }\n}\n```\n\ndeadlocks pretty reliably for me with:\n\n```\n\"Thread-1\" prio=10 tid=0x0a01a800 nid=0xbfb in Object.wait() [0x6db8d000]\n   java.lang.Thread.State: RUNNABLE\n        at Test$2.run(Test.java:16)\n\n\"Thread-0\" prio=10 tid=0x0a019000 nid=0xbfa in Object.wait() [0x6dbde000]\n   java.lang.Thread.State: RUNNABLE\n        at org.joda.time.DateTimeZone.<clinit>(DateTimeZone.java:95)\n        at Test$1.run(Test.java:9)\n```\n\nIs this something that other people have run into? I can certainly work around it by adding no-op references to DateTimeZone before creating any FixedDateTimeZone instances, but that seems awfully fragile (and in particular doesn't protect against something else in my users' processes directly referencing FixedDateTimeZone and locking in the other direction). Any other recommendations? Unfortunately, there doesn't seem to be a straightforward way of fixing this in JodaTime without breaking DateTimeZone.UTC...\n","closed_by":{"login":"jodastephen","id":213212,"node_id":"MDQ6VXNlcjIxMzIxMg==","avatar_url":"https://avatars.githubusercontent.com/u/213212?v=4","gravatar_id":"","url":"https://api.github.com/users/jodastephen","html_url":"https://github.com/jodastephen","followers_url":"https://api.github.com/users/jodastephen/followers","following_url":"https://api.github.com/users/jodastephen/following{/other_user}","gists_url":"https://api.github.com/users/jodastephen/gists{/gist_id}","starred_url":"https://api.github.com/users/jodastephen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jodastephen/subscriptions","organizations_url":"https://api.github.com/users/jodastephen/orgs","repos_url":"https://api.github.com/users/jodastephen/repos","events_url":"https://api.github.com/users/jodastephen/events{/privacy}","received_events_url":"https://api.github.com/users/jodastephen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/JodaOrg/joda-time/issues/171/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/171/timeline","performed_via_github_app":null,"state_reason":"completed"}