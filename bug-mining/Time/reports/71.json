{"url":"https://api.github.com/repos/JodaOrg/joda-time/issues/386","repository_url":"https://api.github.com/repos/JodaOrg/joda-time","labels_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/386/labels{/name}","comments_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/386/comments","events_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/386/events","html_url":"https://github.com/JodaOrg/joda-time/issues/386","id":165413426,"node_id":"MDU6SXNzdWUxNjU0MTM0MjY=","number":386,"title":"Timezone the binary search implementation doesn't pivot on string length correctly with trailing literals.","user":{"login":"jmax01","id":789402,"node_id":"MDQ6VXNlcjc4OTQwMg==","avatar_url":"https://avatars.githubusercontent.com/u/789402?v=4","gravatar_id":"","url":"https://api.github.com/users/jmax01","html_url":"https://github.com/jmax01","followers_url":"https://api.github.com/users/jmax01/followers","following_url":"https://api.github.com/users/jmax01/following{/other_user}","gists_url":"https://api.github.com/users/jmax01/gists{/gist_id}","starred_url":"https://api.github.com/users/jmax01/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmax01/subscriptions","organizations_url":"https://api.github.com/users/jmax01/orgs","repos_url":"https://api.github.com/users/jmax01/repos","events_url":"https://api.github.com/users/jmax01/events{/privacy}","received_events_url":"https://api.github.com/users/jmax01/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":42317690,"node_id":"MDU6TGFiZWw0MjMxNzY5MA==","url":"https://api.github.com/repos/JodaOrg/joda-time/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null},{"id":42318930,"node_id":"MDU6TGFiZWw0MjMxODkzMA==","url":"https://api.github.com/repos/JodaOrg/joda-time/labels/Fixed","name":"Fixed","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-07-13T20:26:35Z","updated_at":"2016-07-20T23:25:46Z","closed_at":"2016-07-20T23:25:27Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Enviroment\n- Joda-Time 2.9.2 - 2.9.4\n- TimeZone.getDefault(): sun.util.calendar.ZoneInfo[id=\"America/Chicago\",offset=-21600000,dstSavings=3600000,useDaylight=true,transitions=235,lastRule=java.util.SimpleTimeZone[id=America/Chicago,offset=-21600000,dstSavings=3600000,useDaylight=true,startYear=0,startMode=3,startMonth=2,startDay=8,startDayOfWeek=1,startTime=7200000,startTimeMode=0,endMode=3,endMonth=10,endDay=1,endDayOfWeek=1,endTime=7200000,endTimeMode=0]]\n- DateTimeZone.getDefault(): America/Chicago\n### Problem description\n\nIt appears that https://github.com/JodaOrg/joda-time/pull/332 actually made parsing worse as it fails to handle literals after ZoneIds.\n#### 2.9.1\n\n2.9.1 is able to round trip (ZonedDateTime.toString()->DateTime->ZonedDateTime) 600 of 617 ZoneIds using a formatter designed to mimic ZonedDateTime's toString scheme (it is defined in the test below, it may not be perfect but worked for ~97% of ZoneIds).\n\nTotal Count: 617\nTranslation success Count: 600\nTranslation failed Count: 17\n\nThe failed ones are listed below:\n- Etc/GMT Invalid format: \"2016-07-13T19:26:56.352Z[Etc/GMT]\" is malformed at \"[Etc/GMT]\"\n- Etc/GMT+1 Invalid format: \"2016-07-13T18:26:56.367-01:00[Etc/GMT+1]\" is malformed at \"[Etc/GMT+1]\"\n- Etc/GMT-1 Invalid format: \"2016-07-13T20:26:56.367+01:00[Etc/GMT-1]\" is malformed at \"[Etc/GMT-1]\"\n- GMT Invalid format: \"2016-07-13T19:26:56.461Z[GMT]\" is malformed at \"[GMT]\"\n- SystemV/AST4 Invalid format: \"2016-07-13T15:26:56.508-04:00[SystemV/AST4]\" is malformed at \"[SystemV/AST4]\"\n- SystemV/AST4ADT Invalid format: \"2016-07-13T16:26:56.508-03:00[SystemV/AST4ADT]\" is malformed at \"[SystemV/AST4ADT]\"\n- SystemV/CST6 Invalid format: \"2016-07-13T13:26:56.508-06:00[SystemV/CST6]\" is malformed at \"[SystemV/CST6]\"\n- SystemV/CST6CDT Invalid format: \"2016-07-13T14:26:56.508-05:00[SystemV/CST6CDT]\" is malformed at \"[SystemV/CST6CDT]\"\n- SystemV/EST5 Invalid format: \"2016-07-13T14:26:56.508-05:00[SystemV/EST5]\" is malformed at \"[SystemV/EST5]\"\n- SystemV/EST5EDT Invalid format: \"2016-07-13T15:26:56.508-04:00[SystemV/EST5EDT]\" is malformed at \"[SystemV/EST5EDT]\"\n- SystemV/HST10 Invalid format: \"2016-07-13T09:26:56.508-10:00[SystemV/HST10]\" is malformed at \"[SystemV/HST10]\"\n- SystemV/MST7 Invalid format: \"2016-07-13T12:26:56.508-07:00[SystemV/MST7]\" is malformed at \"[SystemV/MST7]\"\n- SystemV/MST7MDT Invalid format: \"2016-07-13T13:26:56.508-06:00[SystemV/MST7MDT]\" is malformed at \"[SystemV/MST7MDT]\"\n- SystemV/PST8 Invalid format: \"2016-07-13T11:26:56.508-08:00[SystemV/PST8]\" is malformed at \"[SystemV/PST8]\"\n- SystemV/PST8PDT Invalid format: \"2016-07-13T12:26:56.508-07:00[SystemV/PST8PDT]\" is malformed at \"[SystemV/PST8PDT]\"\n- SystemV/YST9 Invalid format: \"2016-07-13T10:26:56.508-09:00[SystemV/YST9]\" is malformed at \"[SystemV/YST9]\"\n- SystemV/YST9YDT Invalid format: \"2016-07-13T11:26:56.508-08:00[SystemV/YST9YDT]\" is malformed at \"[SystemV/YST9YDT]\"\n#### 2.9.2 - 2.9.4\n\nTotal Count: 617\nTranslation success Count: 3\nTranslation failed Count: 614\n\nThe 614 fail with errors like this one:\nInvalid format: \"2016-07-13T23:13:04.160+03:00[Africa/Addis_Ababa]\" is malformed at \"[Africa/Addis_Ababa]\"\n### Test case\n\n``` java\n    @Test\n    public void test() {\n        class Results {\n            final DateTimeFormatter ZONED_ISO_DATE_TIME_FORMATTER = new DateTimeFormatterBuilder().appendYear(4, 4)\n                .appendLiteral('-')\n                .appendMonthOfYear(2)\n                .appendLiteral('-')\n                .appendDayOfMonth(2)\n                .appendLiteral('T')\n                .appendHourOfDay(2)\n                .appendLiteral(':')\n                .appendMinuteOfHour(2)\n                .appendLiteral(':')\n                .appendSecondOfMinute(2)\n                .appendLiteral('.')\n                .appendFractionOfSecond(0, 9)\n                .appendTimeZoneOffset(\"Z\", true, 2, 2)\n                .appendOptional(new DateTimeFormatterBuilder().appendLiteral('[')\n                    .appendTimeZoneId()\n                    .appendLiteral(']')\n                    .toParser())\n                .toFormatter();\n\n            final DateTimeFormatter ZONED_ISO_DATE_TIME_PRINTER = new DateTimeFormatterBuilder().appendYear(4, 4)\n                .appendLiteral('-')\n                .appendMonthOfYear(2)\n                .appendLiteral('-')\n                .appendDayOfMonth(2)\n                .appendLiteral('T')\n                .appendHourOfDay(2)\n                .appendLiteral(':')\n                .appendMinuteOfHour(2)\n                .appendLiteral(':')\n                .appendSecondOfMinute(2)\n                .appendLiteral('.')\n                .appendFractionOfSecond(0, 9)\n                .appendTimeZoneOffset(\"Z\", true, 2, 2)\n                .appendLiteral('[')\n                .appendTimeZoneId()\n                .appendLiteral(']')\n                .toFormatter();\n\n            final ZoneId zoneId;\n\n            final ZonedDateTime zonedDateTime;\n\n            final String zonedDateTimeAsString;\n\n            DateTime dateTime;\n\n            String dateTimeAsString;\n\n            String toDateTimeError;\n\n            ZonedDateTime zonedDateTimeFromDateTime;\n\n            String toZonedDateTimeError;\n\n            Boolean roundTripEquals;\n\n            Boolean roundTripIsEquals;\n\n            Results(ZoneId zoneId) {\n                this.zoneId = zoneId;\n                this.zonedDateTime = ZonedDateTime.now(zoneId);\n                this.zonedDateTimeAsString = this.zonedDateTime.toString();\n                this.toDateTime();\n                this.fromDateTime();\n            }\n\n            private void fromDateTime() {\n\n                if (this.dateTime != null) {\n\n                    try {\n                        this.zonedDateTimeFromDateTime = ZonedDateTime.parse(this.dateTimeAsString);\n                        this.roundTripEquals = this.zonedDateTime.equals(this.zonedDateTimeFromDateTime);\n                        this.roundTripIsEquals = this.zonedDateTime.isEqual(this.zonedDateTimeFromDateTime);\n\n                    } catch (Exception e) {\n                        this.toZonedDateTimeError = e.getMessage();\n                    }\n                }\n            }\n\n            void toDateTime() {\n                try {\n                    this.dateTime = this.ZONED_ISO_DATE_TIME_FORMATTER.parseDateTime(this.zonedDateTimeAsString);\n                    this.dateTimeAsString = this.dateTime.toString(this.ZONED_ISO_DATE_TIME_PRINTER);\n                } catch (Exception e) {\n                    this.toDateTimeError = e.getMessage();\n                }\n            }\n\n            public boolean failedToTranslation() {\n                return !(this.toDateTimeError == null && this.toZonedDateTimeError == null);\n            }\n\n            public boolean equalityFailed() {\n                return !this.failedToTranslation() && (!(this.roundTripEquals || this.roundTripIsEquals));\n            }\n\n            @Override\n            public String toString() {\n                return new StringBuilder().append(this.zoneId)\n                    .append('-')\n                    .append('[')\n                    .append(this.failedToTranslation() ? \"translation: failed\" : \"translation: passed\")\n                    .append(this.roundTripEquals != null ? this.equalityFailed() ? \", equality: failed\"\n                            : \", equality: passed\" : \"\")\n                    .append(']')\n                    .append(\"\\n\\n\\t\")\n                    .append(\"ZonedDateTime: \")\n                    .append(this.zonedDateTimeAsString)\n                    .append(\"\\n\\t\")\n                    .append(Optional.ofNullable(this.dateTime)\n                        .map(dt -> \"DateTime: \" + this.dateTime)\n                        .orElseGet(() -> \"ZoneDateTime to DateTime error: \" + this.toDateTimeError))\n                    .append(Optional.ofNullable(this.dateTimeAsString)\n                        .map(dts -> \"\\n\\tDateTime As ISO String: \" + dts)\n                        .orElse(\"\"))\n                    .append(Optional.ofNullable(this.zonedDateTimeFromDateTime)\n                        .map(rd -> \"\\n\\tZonedDateTime from DateTime: \" + rd)\n                        .orElse(\"\"))\n                    .append(Optional.ofNullable(this.roundTripEquals)\n                        .map(b -> \"\\n\\tRound Trip ZonedDateTime equals: \" + b)\n                        .orElse(\"\"))\n                    .append(Optional.ofNullable(this.roundTripIsEquals)\n                        .map(b -> \"\\n\\tRound Trip ZonedDateTime isEquals: \" + b)\n                        .orElse(\"\"))\n                    .append(Optional.ofNullable(this.toZonedDateTimeError)\n                        .map(err -> \"\\n\\tDateTime to ZonedDateTime error: \" + err)\n                        .orElse(\"\"))\n                    .append(\"\\n\\n\")\n                    .toString();\n\n            }\n        }\n\n        List<Results> results = Stream.of(TimeZone.getAvailableIDs())\n            .map(TimeZone::getTimeZone)\n            .map(TimeZone::toZoneId)\n            .map(Results::new)\n            .collect(Collectors.toList());\n\n        System.out.println(\"Total Count: \" + results.stream()\n            .count());\n\n        System.out.println(\"Translation success Count: \" + results.stream()\n            .filter(r -> !r.failedToTranslation())\n            .count());\n\n        System.out.println(\"Translation failed Count: \" + results.stream()\n            .filter(r -> r.failedToTranslation())\n            .count());\n\n        System.out.println(\"Equality success Count: \" + results.stream()\n            .filter(r -> !r.equalityFailed() && !r.failedToTranslation())\n            .count());\n\n        System.out.println(\"Equality failed Count: \" + results.stream()\n            .filter(r -> r.equalityFailed())\n            .count());\n\n        System.out.println(\"Failed to translate:\\n\");\n        results.stream()\n            .filter(r -> r.failedToTranslation())\n            .forEach(System.out::println);\n\n        System.out.println(\"Successfully translated:\\n\");\n        results.stream()\n            .filter(r -> !r.failedToTranslation())\n            .forEach(System.out::println);\n\n        System.out.println(\"Failed to equality:\\n\");\n        results.stream()\n            .filter(r -> r.equalityFailed())\n            .forEach(System.out::println);\n```\n","closed_by":{"login":"jodastephen","id":213212,"node_id":"MDQ6VXNlcjIxMzIxMg==","avatar_url":"https://avatars.githubusercontent.com/u/213212?v=4","gravatar_id":"","url":"https://api.github.com/users/jodastephen","html_url":"https://github.com/jodastephen","followers_url":"https://api.github.com/users/jodastephen/followers","following_url":"https://api.github.com/users/jodastephen/following{/other_user}","gists_url":"https://api.github.com/users/jodastephen/gists{/gist_id}","starred_url":"https://api.github.com/users/jodastephen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jodastephen/subscriptions","organizations_url":"https://api.github.com/users/jodastephen/orgs","repos_url":"https://api.github.com/users/jodastephen/repos","events_url":"https://api.github.com/users/jodastephen/events{/privacy}","received_events_url":"https://api.github.com/users/jodastephen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/JodaOrg/joda-time/issues/386/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/386/timeline","performed_via_github_app":null,"state_reason":"completed"}