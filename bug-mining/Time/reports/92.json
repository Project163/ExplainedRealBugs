{"url":"https://api.github.com/repos/JodaOrg/joda-time/issues/587","repository_url":"https://api.github.com/repos/JodaOrg/joda-time","labels_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/587/labels{/name}","comments_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/587/comments","events_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/587/events","html_url":"https://github.com/JodaOrg/joda-time/issues/587","id":1212326115,"node_id":"I_kwDOABrMvs5IQqDj","number":587,"title":"DateTimeZone.getDefault() is prone to race condition","user":{"login":"spand","id":1454142,"node_id":"MDQ6VXNlcjE0NTQxNDI=","avatar_url":"https://avatars.githubusercontent.com/u/1454142?v=4","gravatar_id":"","url":"https://api.github.com/users/spand","html_url":"https://github.com/spand","followers_url":"https://api.github.com/users/spand/followers","following_url":"https://api.github.com/users/spand/following{/other_user}","gists_url":"https://api.github.com/users/spand/gists{/gist_id}","starred_url":"https://api.github.com/users/spand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spand/subscriptions","organizations_url":"https://api.github.com/users/spand/orgs","repos_url":"https://api.github.com/users/spand/repos","events_url":"https://api.github.com/users/spand/events{/privacy}","received_events_url":"https://api.github.com/users/spand/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":42317690,"node_id":"MDU6TGFiZWw0MjMxNzY5MA==","url":"https://api.github.com/repos/JodaOrg/joda-time/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-04-22T12:53:19Z","updated_at":"2022-10-02T20:41:12Z","closed_at":"2022-05-15T22:28:32Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Key information\r\n- Joda-Time version: Latest\r\n\r\nI am mostly just documenting the problem here since the library is no longer in active development but obviously it would be nice to get fixed.\r\n\r\n### Problem description\r\n`DateTimeZone.getDefault()` is specified to check in order:\r\n1. `user.timezone` property\r\n2. `java.util.TimeZone.getDefault()`\r\n3. Use UTC\r\n\r\nThis is problematic because the `user.timezone` property is not fixed but can change as `java.util.TimeZone.getDefault()` is specified to set the `user.timezone` if it is missing. If `java.util.TimeZone.setDefault()` is called prior to `getDefault()` then it will never be set. In effect this means that `user.timezone` is set (quite unintuitively imo) on two conditions:\r\n1. Provided by the user as -Duser.timezone\r\n2. or picked up from the environment.\r\n\r\nI believe and assume that the `DateTimeZone.getDefault()` checks `user.timezone` first because it is assumed to only be set in case 1.\r\n\r\n### The Problem\r\n\r\nOk. So what is the problem? You might say\r\n> Just call `java.util.TimeZone.setDefault()`\" and at startup and Joda will use that\r\n\r\nThat is what we do currently. However, it seems that is not enough. We initially discovered this when adding the NewRelic agent to our production system but have since discovered that when running the jvm even just in debug mode in IDEA then `user.timezone` is set before even before the main method starts executing. In effect having jodatime getting stuck on the environment timezone and never checking `java.util.TimeZone.getDefault()`. I can only assume that the agents has a codepath that triggers `java.util.TimeZone.getDefault()` on startup.\r\n\r\n### Proposed solution\r\nStop checking the user.timezone property. Instead use the following algorithm\r\n1. Check a `org.joda.time.defaulttimezone` property if one really wants to override jodatimes default timezone from the commandline. Technically this is not needed for us but I assume the `user.timezone` check is present to override any prior calls to `java.util.TimeZone.setDefault()`.\r\n2. `java.util.TimeZone.getDefault()` which will then in turn check user.timezone if needed.\r\n3. Use UTC \r\n\r\nThis should provide a stable algorithm free of races.\r\n\r\n### Test case (In Kotlin. It doesnt happen in plain java)\r\n\r\n```kotlin\r\nimport java.util.*\r\nimport org.joda.time.DateTimeZone\r\n\r\nfun main() {\r\n    System.out.println(\"user.timezone \" + System.getProperty(\"user.timezone\"))\r\n    System.out.println(\"java.util.TimeZone.getDefault() = \" + TimeZone.getDefault().id)\r\n    System.out.println(\"user.timezone \" + System.getProperty(\"user.timezone\"))\r\n}\r\n```\r\n\r\nWhen run nomally:\r\n```\r\nuser.timezone null\r\njava.util.TimeZone.getDefault() = Europe/Paris\r\nuser.timezone Europe/Paris\r\n\r\nProcess finished with exit code 0\r\n```\r\n\r\nIn debug:\r\n```\r\nConnected to the target VM, address: '127.0.0.1:57990', transport: 'socket'\r\nuser.timezone Europe/Paris\r\njava.util.TimeZone.getDefault() = Europe/Paris\r\nuser.timezone Europe/Paris\r\nDisconnected from the target VM, address: '127.0.0.1:57990', transport: 'socket'\r\n\r\nProcess finished with exit code 0\r\n```\r\n","closed_by":{"login":"jodastephen","id":213212,"node_id":"MDQ6VXNlcjIxMzIxMg==","avatar_url":"https://avatars.githubusercontent.com/u/213212?v=4","gravatar_id":"","url":"https://api.github.com/users/jodastephen","html_url":"https://github.com/jodastephen","followers_url":"https://api.github.com/users/jodastephen/followers","following_url":"https://api.github.com/users/jodastephen/following{/other_user}","gists_url":"https://api.github.com/users/jodastephen/gists{/gist_id}","starred_url":"https://api.github.com/users/jodastephen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jodastephen/subscriptions","organizations_url":"https://api.github.com/users/jodastephen/orgs","repos_url":"https://api.github.com/users/jodastephen/repos","events_url":"https://api.github.com/users/jodastephen/events{/privacy}","received_events_url":"https://api.github.com/users/jodastephen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/JodaOrg/joda-time/issues/587/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/JodaOrg/joda-time/issues/587/timeline","performed_via_github_app":null,"state_reason":"completed"}