{"url":"https://api.github.com/repos/go-gorm/gorm/issues/912","repository_url":"https://api.github.com/repos/go-gorm/gorm","labels_url":"https://api.github.com/repos/go-gorm/gorm/issues/912/labels{/name}","comments_url":"https://api.github.com/repos/go-gorm/gorm/issues/912/comments","events_url":"https://api.github.com/repos/go-gorm/gorm/issues/912/events","html_url":"https://github.com/go-gorm/gorm/issues/912","id":141470216,"node_id":"MDU6SXNzdWUxNDE0NzAyMTY=","number":912,"title":"Callbacks aren't called on slices of pointers","user":{"login":"jlburkhead","id":3596494,"node_id":"MDQ6VXNlcjM1OTY0OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/3596494?v=4","gravatar_id":"","url":"https://api.github.com/users/jlburkhead","html_url":"https://github.com/jlburkhead","followers_url":"https://api.github.com/users/jlburkhead/followers","following_url":"https://api.github.com/users/jlburkhead/following{/other_user}","gists_url":"https://api.github.com/users/jlburkhead/gists{/gist_id}","starred_url":"https://api.github.com/users/jlburkhead/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jlburkhead/subscriptions","organizations_url":"https://api.github.com/users/jlburkhead/orgs","repos_url":"https://api.github.com/users/jlburkhead/repos","events_url":"https://api.github.com/users/jlburkhead/events{/privacy}","received_events_url":"https://api.github.com/users/jlburkhead/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-03-17T03:37:31Z","updated_at":"2016-04-04T14:49:55Z","closed_at":"2016-04-04T14:49:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Callback's aren't called when using a slice of pointers. This seems like a pretty common thing to do.\n\n``` go\npackage main\n\nimport (\n    \"fmt\"\n\n    \"github.com/jinzhu/gorm\"\n    _ \"github.com/mattn/go-sqlite3\"\n)\n\ntype Product struct {\n    Code  string\n    Price uint\n    name  string\n}\n\nfunc (this *Product) AfterFind() error {\n    this.name = this.Code\n    return nil\n}\n\nvar db *gorm.DB\n\nfunc init() {\n    var err error\n    db, err = gorm.Open(\"sqlite3\", \"test.db\")\n    if err != nil {\n        panic(err)\n    }\n    db.LogMode(true)\n}\n\nfunc main() {\n\n    db.DropTableIfExists(&Product{})\n    db.CreateTable(&Product{})\n\n    if err := db.Create(&Product{Code: \"L1212\", Price: 1000}).Error; err != nil {\n        panic(err)\n    }\n    if err := db.Create(&Product{Code: \"A1234\", Price: 200}).Error; err != nil {\n        panic(err)\n    }\n\n    var products []Product\n    db.Find(&products)\n\n    for _, p := range products {\n        fmt.Printf(\"%#v\\n\", p)\n    }\n\n    var pproducts []*Product\n    db.Find(&pproducts)\n\n    for _, p := range pproducts {\n        fmt.Printf(\"%#v\\n\", p)\n    }\n\n}\n```\n\nThis is a patch which gets this example to work.\n\n``` diff\ncommit 84c4b06b1ed401fb6ef1b2f65135732591d192e6\nAuthor: xx <xx>\nDate:   Wed Mar 16 20:31:32 2016 -0700\n\n    wip slice of pointers callbacks\n\ndiff --git a/scope.go b/scope.go\nindex 65a438c..26cea9e 100644\n--- a/scope.go\n+++ b/scope.go\n@@ -417,6 +417,8 @@ func (scope *Scope) callMethod(methodName string, reflectValue reflect.Value) {\n                reflectValue = reflectValue.Addr()\n        }\n\n+       reflectValue = ptr(reflectValue)\n+\n        if methodValue := reflectValue.MethodByName(methodName); methodValue.IsValid() {\n                switch method := methodValue.Interface().(type) {\n                case func():\ndiff --git a/utils.go b/utils.go\nindex dc69e80..dfb453c 100644\n--- a/utils.go\n+++ b/utils.go\n@@ -129,6 +129,16 @@ func indirect(reflectValue reflect.Value) reflect.Value {\n        return reflectValue\n }\n\n+func ptr(reflectValue reflect.Value) reflect.Value {\n+       if reflectValue.Kind() != reflect.Ptr {\n+               return reflectValue\n+       }\n+       if reflectValue.Elem().Kind() != reflect.Ptr {\n+               return reflectValue\n+       }\n+       return ptr(reflectValue.Elem())\n+}\n+\n func toQueryMarks(primaryValues [][]interface{}) string {\n        var results []string\n\n```\n","closed_by":{"login":"jinzhu","id":6843,"node_id":"MDQ6VXNlcjY4NDM=","avatar_url":"https://avatars.githubusercontent.com/u/6843?v=4","gravatar_id":"","url":"https://api.github.com/users/jinzhu","html_url":"https://github.com/jinzhu","followers_url":"https://api.github.com/users/jinzhu/followers","following_url":"https://api.github.com/users/jinzhu/following{/other_user}","gists_url":"https://api.github.com/users/jinzhu/gists{/gist_id}","starred_url":"https://api.github.com/users/jinzhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jinzhu/subscriptions","organizations_url":"https://api.github.com/users/jinzhu/orgs","repos_url":"https://api.github.com/users/jinzhu/repos","events_url":"https://api.github.com/users/jinzhu/events{/privacy}","received_events_url":"https://api.github.com/users/jinzhu/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gorm/gorm/issues/912/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gorm/gorm/issues/912/timeline","performed_via_github_app":null,"state_reason":"completed"}