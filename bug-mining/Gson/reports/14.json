{"url":"https://api.github.com/repos/google/gson/issues/2739","repository_url":"https://api.github.com/repos/google/gson","labels_url":"https://api.github.com/repos/google/gson/issues/2739/labels{/name}","comments_url":"https://api.github.com/repos/google/gson/issues/2739/comments","events_url":"https://api.github.com/repos/google/gson/issues/2739/events","html_url":"https://github.com/google/gson/issues/2739","id":2525471144,"node_id":"I_kwDOAfCA986Wh6Go","number":2739,"title":"Class loading deadlock with `JsonElementTypeAdapter`","user":{"login":"eamonnmcmanus","id":5246810,"node_id":"MDQ6VXNlcjUyNDY4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/5246810?v=4","gravatar_id":"","url":"https://api.github.com/users/eamonnmcmanus","html_url":"https://github.com/eamonnmcmanus","followers_url":"https://api.github.com/users/eamonnmcmanus/followers","following_url":"https://api.github.com/users/eamonnmcmanus/following{/other_user}","gists_url":"https://api.github.com/users/eamonnmcmanus/gists{/gist_id}","starred_url":"https://api.github.com/users/eamonnmcmanus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eamonnmcmanus/subscriptions","organizations_url":"https://api.github.com/users/eamonnmcmanus/orgs","repos_url":"https://api.github.com/users/eamonnmcmanus/repos","events_url":"https://api.github.com/users/eamonnmcmanus/events{/privacy}","received_events_url":"https://api.github.com/users/eamonnmcmanus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":189516447,"node_id":"MDU6TGFiZWwxODk1MTY0NDc=","url":"https://api.github.com/repos/google/gson/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":189516454,"node_id":"MDU6TGFiZWwxODk1MTY0NTQ=","url":"https://api.github.com/repos/google/gson/labels/Type-Defect","name":"Type-Defect","color":"ededed","default":false,"description":null},{"id":189516862,"node_id":"MDU6TGFiZWwxODk1MTY4NjI=","url":"https://api.github.com/repos/google/gson/labels/Priority-High","name":"Priority-High","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"eamonnmcmanus","id":5246810,"node_id":"MDQ6VXNlcjUyNDY4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/5246810?v=4","gravatar_id":"","url":"https://api.github.com/users/eamonnmcmanus","html_url":"https://github.com/eamonnmcmanus","followers_url":"https://api.github.com/users/eamonnmcmanus/followers","following_url":"https://api.github.com/users/eamonnmcmanus/following{/other_user}","gists_url":"https://api.github.com/users/eamonnmcmanus/gists{/gist_id}","starred_url":"https://api.github.com/users/eamonnmcmanus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eamonnmcmanus/subscriptions","organizations_url":"https://api.github.com/users/eamonnmcmanus/orgs","repos_url":"https://api.github.com/users/eamonnmcmanus/repos","events_url":"https://api.github.com/users/eamonnmcmanus/events{/privacy}","received_events_url":"https://api.github.com/users/eamonnmcmanus/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"eamonnmcmanus","id":5246810,"node_id":"MDQ6VXNlcjUyNDY4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/5246810?v=4","gravatar_id":"","url":"https://api.github.com/users/eamonnmcmanus","html_url":"https://github.com/eamonnmcmanus","followers_url":"https://api.github.com/users/eamonnmcmanus/followers","following_url":"https://api.github.com/users/eamonnmcmanus/following{/other_user}","gists_url":"https://api.github.com/users/eamonnmcmanus/gists{/gist_id}","starred_url":"https://api.github.com/users/eamonnmcmanus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eamonnmcmanus/subscriptions","organizations_url":"https://api.github.com/users/eamonnmcmanus/orgs","repos_url":"https://api.github.com/users/eamonnmcmanus/repos","events_url":"https://api.github.com/users/eamonnmcmanus/events{/privacy}","received_events_url":"https://api.github.com/users/eamonnmcmanus/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2024-09-13T18:57:42Z","updated_at":"2024-09-16T22:43:02Z","closed_at":"2024-09-16T22:43:02Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"At Google we import Gson from HEAD periodically. After the last such import, we had reports of a server appearing to get stuck, which we were able to track down to a class loading deadlock introduced by https://github.com/google/gson/pull/2727. In short, what happens is that Thread 1 calls `GsonBuilder.registerTypeHierarchyAdapter` which triggers a load of the `TypeAdapters` class [here](https://github.com/google/gson/blob/48889dba12f20c7e828469f2617e1bb49b6cfe30/gson/src/main/java/com/google/gson/GsonBuilder.java#L791). That in turn requires `JsonElementTypeAdapter` to be loaded for a static final field [here](https://github.com/google/gson/blob/48889dba12f20c7e828469f2617e1bb49b6cfe30/gson/src/main/java/com/google/gson/internal/bind/TypeAdapters.java#L823). Meanwhile, Thread 2 calls `GsonBuilder.create`, which triggers a load of `JsonElementTypeAdapter` [here](https://github.com/google/gson/blob/48889dba12f20c7e828469f2617e1bb49b6cfe30/gson/src/main/java/com/google/gson/Gson.java#L328). That involves calling `TypeAdapters.newTypeHierarchyFactory` [here](https://github.com/google/gson/blob/48889dba12f20c7e828469f2617e1bb49b6cfe30/gson/src/main/java/com/google/gson/internal/bind/JsonElementTypeAdapter.java#L39), which requires `TypeAdapters` to be loaded. So Thread 1 is loading `TypeAdapters` and waiting for `JsonElementTypeAdapter` to be loaded, while Thread 2 is loading `JsonElementTypeAdapter` and waiting for `TypeAdapters` to be loaded.\r\n\r\nThe deadlock might be due to my [request](https://github.com/google/gson/pull/2727#pullrequestreview-2231845896) on that PR that the static final fields in `TypeAdapters` be preserved, because some existing projects are depending on them.\r\n\r\nThe fix is straightforward, in any case. Instead of `JsonElementTypeAdapter` and `EnumTypeAdapter` being public classes that are referenced directly from the `Gson` class, we should go back to having that class reference static final fields in `TypeAdapters`. Then every classloading path goes through `TypeAdapters` and the deadlock is averted.\r\n\r\nFortunately this bug didn't make it into any release, so most users will be unaffected.","closed_by":{"login":"eamonnmcmanus","id":5246810,"node_id":"MDQ6VXNlcjUyNDY4MTA=","avatar_url":"https://avatars.githubusercontent.com/u/5246810?v=4","gravatar_id":"","url":"https://api.github.com/users/eamonnmcmanus","html_url":"https://github.com/eamonnmcmanus","followers_url":"https://api.github.com/users/eamonnmcmanus/followers","following_url":"https://api.github.com/users/eamonnmcmanus/following{/other_user}","gists_url":"https://api.github.com/users/eamonnmcmanus/gists{/gist_id}","starred_url":"https://api.github.com/users/eamonnmcmanus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eamonnmcmanus/subscriptions","organizations_url":"https://api.github.com/users/eamonnmcmanus/orgs","repos_url":"https://api.github.com/users/eamonnmcmanus/repos","events_url":"https://api.github.com/users/eamonnmcmanus/events{/privacy}","received_events_url":"https://api.github.com/users/eamonnmcmanus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google/gson/issues/2739/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google/gson/issues/2739/timeline","performed_via_github_app":null,"state_reason":"completed"}