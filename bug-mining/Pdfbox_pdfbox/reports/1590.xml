<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:04:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-3566] ClassCastException in JPEGFactory.createFromImage()</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-3566</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I was trying to save all the pages from a PDF as images and adding them to a newly created PDF.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PDDocument newDoc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument();

PDFRenderer pdfRenderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFRenderer(oldDoc);

floag width = ...
&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; height = ...

page.setMediaBox(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDRectangle(width, height));

newDoc.addPage(page);

PDPageContentStream contents = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPageContentStream(newDoc, page);

BufferedImage bufferedImage = pdfRenderer.renderImageWithDPI(0, 200, ImageType.RGB);

PDImageXObject imageXObject = JPEGFactory.createFromImage(newDoc, bufferedImage, 0.75);

contents.drawImage(imageXObject, 0, 0, width, height);

contents.close();

...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sometimes it&apos;s working just fine, sometimes it&apos;s trowing a ClassCastException in JPEGFactory.createFromImage:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ClassCastException: com.sun.media.imageioimpl.plugins.jpeg.CLibJPEGImageWriteParam cannot be cast to javax.imageio.plugins.jpeg.JPEGImageWriteParam
	at org.apache.pdfbox.pdmodel.graphics.image.JPEGFactory.encodeImageToJPEGStream(JPEGFactory.java:244)
	at org.apache.pdfbox.pdmodel.graphics.image.JPEGFactory.createJPEG(JPEGFactory.java:212)
	at org.apache.pdfbox.pdmodel.graphics.image.JPEGFactory.createFromImage(JPEGFactory.java:175)
	at org.apache.pdfbox.pdmodel.graphics.image.JPEGFactory.createFromImage(JPEGFactory.java:160)
	at com.mimecast.ttpservice.app.jpati.ConvertPDF.saveDoc(ConvertPDF.java:1390)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is happening in the following code of above mentioned class:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;imageWriter = ImageIO.getImageWritersBySuffix(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpeg&quot;&lt;/span&gt;).next();
...
JPEGImageWriteParam jpegParam = (JPEGImageWriteParam)imageWriter.getDefaultWriteParam();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In my case I can get more than one ImageWritter when calling &lt;b&gt;ImageIO.getImageWritersBySuffix(&quot;jpeg&quot;)&lt;/b&gt; as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;com.sun.imageio.plugins.jpeg.JPEGImageWriter
com.sun.media.imageioimpl.plugins.jpeg.CLibJPEGImageWriter
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I suspect that sometimes the &lt;b&gt;CLibJPEGImageWriter&lt;/b&gt; is returned before &lt;b&gt;JPEGImageWriter&lt;/b&gt;, which produces the ClassCastException a bit later.&lt;/p&gt;

&lt;p&gt;As I need to keep the JAI installed, is it possible to change the above code to loop through all ImageWriters found in order to pick the one needed by PdfBox?&lt;/p&gt;

&lt;p&gt;I would recommend doing something like this: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Iterator&amp;lt;ImageWriter&amp;gt; iterator = ImageIO.getImageWritersBySuffix(&lt;span class=&quot;code-quote&quot;&gt;&quot;jpeg&quot;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iterator.hasNext()) {
    ImageWriter foundWriter = iterator.next();

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (foundWriter &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; JPEGImageWriter) {
        imageWriter = foundWriter;
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (imageWriter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvalidStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;No image writer found of JPEGImageWriter type&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Linux OS, Java 1.8, Oracle Java Advanced Imaging (JAI) installed.</environment>
        <key id="13020063">PDFBOX-3566</key>
            <summary>ClassCastException in JPEGFactory.createFromImage()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="ceakki">ceakki</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Nov 2016 09:39:38 +0000</created>
                <updated>Sat, 25 Mar 2017 18:13:08 +0000</updated>
                            <resolved>Fri, 11 Nov 2016 17:06:41 +0000</resolved>
                                    <version>2.0.3</version>
                                    <fixVersion>2.0.4</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15657495" author="tilman" created="Fri, 11 Nov 2016 16:48:46 +0000"  >&lt;p&gt;No we won&apos;t use &lt;tt&gt;JPEGImageWriter&lt;/tt&gt; because this would bring a dependency on com.sun.*. There is no mandatory use of that. For example, I use twelvemonkeys.&lt;/p&gt;

&lt;p&gt;What we should do is to find a way to avoid that CCE early, e.g. by choosing a plugin that delivers the correct type (&lt;tt&gt;JPEGImageWriteParam&lt;/tt&gt;) instead of just using the first possible writer. We already do something in ImageIOUtil so I&apos;m optimistic that I can fix this very soon.&lt;/p&gt;</comment>
                            <comment id="15657535" author="jira-bot" created="Fri, 11 Nov 2016 17:05:03 +0000"  >&lt;p&gt;Commit 1769317 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1769317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1769317&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3566&quot; title=&quot;ClassCastException in JPEGFactory.createFromImage()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3566&quot;&gt;&lt;del&gt;PDFBOX-3566&lt;/del&gt;&lt;/a&gt;: avoid ClassCastException due to incompatible plugin&lt;/p&gt;</comment>
                            <comment id="15657536" author="jira-bot" created="Fri, 11 Nov 2016 17:05:07 +0000"  >&lt;p&gt;Commit 1769318 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1769318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1769318&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3566&quot; title=&quot;ClassCastException in JPEGFactory.createFromImage()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3566&quot;&gt;&lt;del&gt;PDFBOX-3566&lt;/del&gt;&lt;/a&gt;: avoid ClassCastException due to incompatible plugin&lt;/p&gt;</comment>
                            <comment id="15657538" author="tilman" created="Fri, 11 Nov 2016 17:06:10 +0000"  >&lt;p&gt;And done. Snapshot should be available within hours at&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.4-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.4-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i367qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>