<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:10:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4788] Flattening fields results in non-widget annotations being removed</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4788</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I&apos;m running into an issue when flattening form fields, using PDFBox version v2.0.19. When calling &lt;tt&gt;PDAcroForm.flatten()&lt;/tt&gt;, all annotations on pages without form fields get removed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I created a sample document to illustrate this issue, this document contains 2 pages:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;page 1: a text field and a link annotation&lt;/li&gt;
	&lt;li&gt;page 2: only a link annotation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When you flatten this document, the link annotation on the 2nd page gets removed, while it shouldn&apos;t be.&lt;/p&gt;

&lt;p&gt;PDF Documents and Java files to reproduce this are attached:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;CreateDocument.java&lt;/tt&gt; creates &lt;tt&gt;flatten.pdf&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FlattenDocument.java&lt;/tt&gt; flattens &lt;tt&gt;flatten.pdf&lt;/tt&gt; and creates &lt;tt&gt;flattened.pdf&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;After debugging, I think I found the cause. In the &lt;tt&gt;PDAcroForm&lt;/tt&gt; class, &lt;tt&gt;flatten(...)&lt;/tt&gt; calls the &lt;tt&gt;buildPagesWidgetsMap(...)&lt;/tt&gt; method, which iterates over the form fields and builds a map of pages and their widget annotations. Because the 2nd page doesn&apos;t contain form fields, this page is not added to the map. Then &lt;tt&gt;flatten()&lt;/tt&gt; iterates over the pages and gets the widgets for that page from the created &lt;tt&gt;pagesWidgetsMap&lt;/tt&gt; map. However, because the 2nd page didn&apos;t have annotations and therefore wasn&apos;t added to the map, this results in&#160;&lt;tt&gt;widgetsForPageMap&lt;/tt&gt; being &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Next, for every annotation on this page, the following check is performed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (widgetsForPageMap != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !widgetsForPageMap.contains(annotation.getCOSObject()))
{
    annotations.add(annotation);                 
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Because &lt;tt&gt;widgetsForPageMap&lt;/tt&gt; is &lt;tt&gt;null&lt;/tt&gt;, the annotation is not added to the &lt;tt&gt;annotations&lt;/tt&gt; list and therefore not retained. The first page did contain a field and is thus added to the &lt;tt&gt;pagesWidgetsMap&lt;/tt&gt;, resulting in &lt;tt&gt;widgetsForPageMap&lt;/tt&gt; not being null, the annotation being added the &lt;tt&gt;annotations&lt;/tt&gt; list and thus the annotation is retained.&lt;/p&gt;

&lt;p&gt;I thinks this is a regression from &lt;a href=&quot;https://svn.apache.org/r1828871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1828871&lt;/a&gt;&#160;and could be solved by using:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (widgetsForPageMap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !widgetsForPageMap.contains(annotation.getCOSObject()))
{
    annotations.add(annotation);                 
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please let me know if you have any questions!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13288070">PDFBOX-4788</key>
            <summary>Flattening fields results in non-widget annotations being removed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="dvdm">DvdM</reporter>
                        <labels>
                            <label>flatten</label>
                    </labels>
                <created>Thu, 27 Feb 2020 14:38:51 +0000</created>
                <updated>Mon, 15 Jun 2020 04:54:13 +0000</updated>
                            <resolved>Fri, 28 Feb 2020 10:06:01 +0000</resolved>
                                    <version>2.0.19</version>
                                    <fixVersion>2.0.20</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>AcroForm</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17046937" author="tilman" created="Thu, 27 Feb 2020 19:45:27 +0000"  >&lt;p&gt;Thank you for your analysis which makes sense. One of us will fix this for 2.0.20.&lt;/p&gt;</comment>
                            <comment id="17047346" author="jira-bot" created="Fri, 28 Feb 2020 09:12:18 +0000"  >&lt;p&gt;Commit 1874608 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
 [ &lt;a href=&quot;https://svn.apache.org/r1874608&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874608&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: add disabled test&lt;/p&gt;</comment>
                            <comment id="17047347" author="jira-bot" created="Fri, 28 Feb 2020 09:12:23 +0000"  >&lt;p&gt;Commit 1874609 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
 [ &lt;a href=&quot;https://svn.apache.org/r1874609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874609&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: add disabled test&lt;/p&gt;</comment>
                            <comment id="17047372" author="jira-bot" created="Fri, 28 Feb 2020 09:38:57 +0000"  >&lt;p&gt;Commit 1874610 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1874610&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874610&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: fix bug that resulted in non-widget annotations getting deleted on pages without widget annotations, as suggested by DvdM&lt;/p&gt;</comment>
                            <comment id="17047373" author="jira-bot" created="Fri, 28 Feb 2020 09:39:01 +0000"  >&lt;p&gt;Commit 1874611 from Tilman Hausherr in branch &apos;pdfbox/branches/issue45&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1874611&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874611&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: fix bug that resulted in non-widget annotations getting deleted on pages without widget annotations, as suggested by DvdM&lt;/p&gt;</comment>
                            <comment id="17047374" author="jira-bot" created="Fri, 28 Feb 2020 09:39:05 +0000"  >&lt;p&gt;Commit 1874612 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1874612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874612&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: fix bug that resulted in non-widget annotations getting deleted on pages without widget annotations, as suggested by DvdM&lt;/p&gt;</comment>
                            <comment id="17047375" author="jira-bot" created="Fri, 28 Feb 2020 09:40:07 +0000"  >&lt;p&gt;Commit 1874613 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1874613&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874613&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: activate test&lt;/p&gt;</comment>
                            <comment id="17047403" author="jira-bot" created="Fri, 28 Feb 2020 09:57:30 +0000"  >&lt;p&gt;Commit 1874615 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1874615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1874615&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: activate test&lt;/p&gt;</comment>
                            <comment id="17047414" author="tilman" created="Fri, 28 Feb 2020 10:06:01 +0000"  >&lt;p&gt;Done. Thank you again!&lt;/p&gt;</comment>
                            <comment id="17121174" author="jira-bot" created="Mon, 1 Jun 2020 17:01:42 +0000"  >&lt;p&gt;Commit 1878369 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1878369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1878369&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: disable flattening tests that fail on mac&lt;/p&gt;</comment>
                            <comment id="17121175" author="jira-bot" created="Mon, 1 Jun 2020 17:01:47 +0000"  >&lt;p&gt;Commit 1878370 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1878370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1878370&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4788&quot; title=&quot;Flattening fields results in non-widget annotations being removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4788&quot;&gt;&lt;del&gt;PDFBOX-4788&lt;/del&gt;&lt;/a&gt;: disable flattening tests that fail on mac&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12994789" name="CreateDocument.java" size="4379" author="dvdm" created="Thu, 27 Feb 2020 14:09:16 +0000"/>
                            <attachment id="12994788" name="FlattenDocument.java" size="532" author="dvdm" created="Thu, 27 Feb 2020 14:09:16 +0000"/>
                            <attachment id="12994791" name="flatten.pdf" size="2818" author="dvdm" created="Thu, 27 Feb 2020 14:08:25 +0000"/>
                            <attachment id="12994790" name="flattened.pdf" size="2627" author="dvdm" created="Thu, 27 Feb 2020 14:08:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0byq0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>