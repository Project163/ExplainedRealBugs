<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:58:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-1512] TextPositionComparator is not compatible with Java 7</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-1512</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;The TextPostionCompartor causes the following exception running on Java 7: Unexpected RuntimeException from org.apache.tika.parser.ParserDecorator$1@9007fa2 Original cause: Comparison method violates its general contract!&lt;/p&gt;

&lt;p&gt;I think the problem is with this check:&lt;/p&gt;

&lt;p&gt;if ( yDifference &amp;lt; .1 ||&lt;br/&gt;
    (pos2YBottom &amp;gt;= pos1YTop &amp;amp;&amp;amp; pos2YBottom &amp;lt;= pos1YBottom) ||&lt;br/&gt;
    (pos1YBottom &amp;gt;= pos2YTop &amp;amp;&amp;amp; pos1YBottom &amp;lt;= pos2YBottom))&lt;/p&gt;

&lt;p&gt;as it violates the contract requirement:&lt;/p&gt;

&lt;p&gt;The implementor must also ensure that the relation is transitive: ((compare(x, y)&amp;gt;0) &amp;amp;&amp;amp; (compare(y, z)&amp;gt;0)) implies compare(x, z)&amp;gt;0.&lt;/p&gt;

&lt;p&gt;Finally, the implementor must ensure that compare(x, y)==0 implies that sgn(compare(x, z))==sgn(compare(y, z)) for all z.&lt;/p&gt;

&lt;p&gt;Java 7 now is strict and throws exceptions when the contract is violated.&lt;/p&gt;</description>
                <environment>Java 7</environment>
        <key id="12631225">PDFBOX-1512</key>
            <summary>TextPositionComparator is not compatible with Java 7</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="bpapez">Benjamin Papez</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Feb 2013 09:36:37 +0000</created>
                <updated>Fri, 27 Nov 2015 23:12:29 +0000</updated>
                            <resolved>Sun, 12 Oct 2014 13:11:28 +0000</resolved>
                                    <version>1.7.1</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.8.8</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Text extraction</component>
                        <due></due>
                            <votes>12</votes>
                                    <watches>23</watches>
                                                                                                                <comments>
                            <comment id="13573350" author="bpapez" created="Thu, 7 Feb 2013 09:41:16 +0000"  >&lt;p&gt;I modified the implementation and tried with the attached file, which no longer braught the exception.&lt;/p&gt;</comment>
                            <comment id="13575419" author="lehmi" created="Sun, 10 Feb 2013 11:09:55 +0000"  >&lt;p&gt;Thanks for your fix. Please attach either the pdf in question or provide as with a set of textpostion values so that we can create a unit test.&lt;/p&gt;</comment>
                            <comment id="13597974" author="lehmi" created="Sat, 9 Mar 2013 15:29:36 +0000"  >&lt;p&gt;Unfortunately your fix breaks the text extraction tests. I guess we have to dig deeper into it.&lt;/p&gt;</comment>
                            <comment id="13604593" author="lehmi" created="Sun, 17 Mar 2013 13:26:08 +0000"  >&lt;p&gt;The pdf attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-161&quot; title=&quot;java.util.EmptyStackException from PDFTextStripper.writeText&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-161&quot;&gt;&lt;del&gt;PDFBOX-161&lt;/del&gt;&lt;/a&gt; triggers the exception&lt;/p&gt;</comment>
                            <comment id="13650683" author="lehmi" created="Tue, 7 May 2013 10:49:06 +0000"  >&lt;p&gt;I investigated some time into this and I still run into the exception. I guess the problem is, that we can&apos;t just compare the absolute position of the textpositions to be compared. In some case we have to take the context into account, e.g. if a text contains super- or subscript parts those characters have to be sorted using the x-coordinate and the fact the two characters belong together. In such cases the y-ccordinate doesn&apos;t matter. This can lead to the described exception depending on the starting point (number of textposition, starting order etc.)&lt;/p&gt;

&lt;p&gt;So I&apos;m not sure if there is a solution, maybe we have to implement our own sort algo.&lt;/p&gt;</comment>
                            <comment id="13651623" author="lxu" created="Wed, 8 May 2013 04:54:46 +0000"  >&lt;p&gt;&lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/compatibility-417013.html#source&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.oracle.com/technetwork/java/javase/compatibility-417013.html#source&lt;/a&gt; suggests that using the system property  java.util.Arrays.useLegacyMergeSort would revert the sort behavior back to 1.6. I&apos;m unable to make it work. Any of you tried?&lt;/p&gt;

&lt;p&gt;================&lt;br/&gt;
Area: API: Utilities&lt;br/&gt;
Synopsis: Updated sort behavior for Arrays and Collections may throw an IllegalArgumentException&lt;br/&gt;
Description: The sorting algorithm used by java.util.Arrays.sort and (indirectly) by java.util.Collections.sort has been replaced. The new sort implementation may throw an IllegalArgumentException if it detects a Comparable that violates the Comparable contract. The previous implementation silently ignored such a situation.&lt;br/&gt;
If the previous behavior is desired, you can use the new system property, java.util.Arrays.useLegacyMergeSort, to restore previous mergesort behavior.&lt;br/&gt;
Nature of Incompatibility: behavioral&lt;br/&gt;
RFE: 6804124&lt;/p&gt;</comment>
                            <comment id="13652013" author="lxu" created="Wed, 8 May 2013 16:03:49 +0000"  >&lt;p&gt;I think I&apos;ve figured out the workaround. Oracle&apos;s doc is correct that you can indeed use the java.util.Arrays.useLegacyMergeSort override. However, I first tried it with System.setProperty() and it did not work. When I pass it to jvm as -Djava.util.Arrays.useLegacyMergeSort=true, I&apos;m now able to avoid this error.&lt;/p&gt;</comment>
                            <comment id="13653586" author="lehmi" created="Fri, 10 May 2013 06:25:04 +0000"  >&lt;p&gt;Thanks for the hint, that&apos;s a good work around to avoid the exception. But in the long run we have to solve this issue somehow.&lt;/p&gt;</comment>
                            <comment id="13689002" author="hannibal218bc" created="Thu, 20 Jun 2013 08:19:24 +0000"  >&lt;p&gt;Another file that triggers exactly this issue.&lt;/p&gt;</comment>
                            <comment id="13689034" author="thiyaga" created="Thu, 20 Jun 2013 09:06:28 +0000"  >&lt;p&gt;It is working fine with the Java build 1.7.0_17-b02.&lt;/p&gt;</comment>
                            <comment id="13690179" author="hannibal218bc" created="Fri, 21 Jun 2013 10:26:35 +0000"  >&lt;p&gt;I&apos;m not sure what Thiyaga&apos;s comment refers to (the problem itself or the workaround). I&apos;ve just verified that the problem can be reproduced using Oracle&apos;s 1.7.0_21 .&lt;/p&gt;</comment>
                            <comment id="13729555" author="fguillaume" created="Mon, 5 Aug 2013 15:02:58 +0000"  >&lt;p&gt;This really needs to be fixed... Crashing under Java 7 is not really a good thing.&lt;/p&gt;</comment>
                            <comment id="13760203" author="sbscom" created="Fri, 6 Sep 2013 13:13:40 +0000"  >&lt;p&gt;As Andreas Lehmk&#252;hler pointed out, the problem lies in the check of overlays in the code, but changing the code breaks previous implementations.&lt;br/&gt;
We did a try/catch around the sort to avoid the break of the sort algorithm&lt;br/&gt;
&amp;lt;code&amp;gt;&lt;br/&gt;
        try &lt;/p&gt;
{
          Collections.sort(textList, WFI_PDFParser_TextPositionComparator.getInstance());
        }
&lt;p&gt; catch (Exception ex) &lt;/p&gt;
{
          // Sort algorithm break contract -&amp;gt; do sorting in safemode 
          Collections.sort(textList, WFI_PDFParser_TextPositionComparator.getSafeInstance());
        }
&lt;p&gt;&amp;lt;/code&amp;gt;&lt;/p&gt;

&lt;p&gt;and modified the compare method (have a look at attached WFI_PDFParser_TextPostionComparator.txt). Maybe this helps ...&lt;/p&gt;</comment>
                            <comment id="13783802" author="tilman" created="Wed, 2 Oct 2013 10:31:26 +0000"  >&lt;p&gt;I get the exception on page 11 of the file of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1730&quot; title=&quot;Image in PDF has extremely different colors when rendered&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1730&quot;&gt;&lt;del&gt;PDFBOX-1730&lt;/del&gt;&lt;/a&gt; (page 12 when looking at it with acrobat viewer, it&apos;s a table). It does not crash with the change. Sort by position is set to true.&lt;/p&gt;</comment>
                            <comment id="13791926" author="tilman" created="Thu, 10 Oct 2013 20:02:50 +0000"  >&lt;p&gt;The attached file brings also the exception, although at a different place:&lt;br/&gt;
java.lang.IllegalArgumentException: Comparison method violates its general contract!&lt;br/&gt;
	at java.util.TimSort.mergeLo(TimSort.java:747)&lt;br/&gt;
	at java.util.TimSort.mergeAt(TimSort.java:483)&lt;br/&gt;
	at java.util.TimSort.mergeForceCollapse(TimSort.java:426)&lt;br/&gt;
	at java.util.TimSort.sort(TimSort.java:223)&lt;br/&gt;
	at java.util.TimSort.sort(TimSort.java:173)&lt;br/&gt;
	at java.util.Arrays.sort(Arrays.java:659)&lt;br/&gt;
	at java.util.Collections.sort(Collections.java:217)&lt;br/&gt;
	at org.apache.pdfbox.util.PDFTextStripper.writePage(PDFTextStripper.java:542)&lt;br/&gt;
	at org.apache.pdfbox.util.PDFTextStripper.processPage(PDFTextStripper.java:436)&lt;br/&gt;
	at org.apache.pdfbox.util.PDFTextStripper.processPages(PDFTextStripper.java:359)&lt;br/&gt;
	at org.apache.pdfbox.util.PDFTextStripper.writeText(PDFTextStripper.java:315)&lt;br/&gt;
	at pdfboxpageimageextraction.ExtractImages.doPdf(ExtractImages.java:158)&lt;br/&gt;
	at pdfboxpageimageextraction.ExtractImages.main(ExtractImages.java:101)&lt;/p&gt;</comment>
                            <comment id="13937402" author="fguillaume" created="Mon, 17 Mar 2014 01:24:49 +0000"  >&lt;p&gt;Could someone knowledgeable please take a stab at this? Otherwise PDFBox quite often crashes without &lt;tt&gt;-Djava.util.Arrays.useLegacyMergeSort=true&lt;/tt&gt;...&lt;/p&gt;</comment>
                            <comment id="13938585" author="jahewson" created="Tue, 18 Mar 2014 00:08:19 +0000"  >&lt;p&gt;Perhaps we should migrate away from using Collections.sort altogether and use some other sorting algorithm?&lt;/p&gt;</comment>
                            <comment id="13939027" author="hannibal218bc" created="Tue, 18 Mar 2014 10:06:14 +0000"  >&lt;p&gt;The issue is not related to a specific sorting algorithm. At the moment, the desired order of the elements is not sufficiently defined.&lt;/p&gt;

&lt;p&gt;Some algorithms don&apos;t care, which may result in inconsistent ordering across multiple calls, some algorithms (as those Java7 defaults to) detect this and throw an exception.&lt;/p&gt;

&lt;p&gt;I did try hacking the Comparator, but so far it doesn&apos;t pass the TextExtract test cases &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13939639" author="jahewson" created="Tue, 18 Mar 2014 18:54:33 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Some algorithms don&apos;t care, which may result in inconsistent ordering across multiple calls&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t see how this would happen unless the algorithm was randomised. For a given input the output should always be the same, regardless.&lt;/p&gt;

&lt;p&gt;But as you say the ordering is not sufficiently defined, so there may be more than one solution. Perhaps we need some more sophisticated rules for determining reading order? Off the top of my head, it seems like &lt;a href=&quot;http://en.wikipedia.org/wiki/Topological_sorting&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Topological sorting&lt;/a&gt; may be of relevance.&lt;/p&gt;</comment>
                            <comment id="13942537" author="hannibal218bc" created="Thu, 20 Mar 2014 23:48:43 +0000"  >&lt;p&gt;The issue here is that the ordering rules are flawed and produce circular ranks.&lt;/p&gt;


&lt;p&gt;If my understanding is correct, the current rules to compare two textpositions A,B are:&lt;/p&gt;

&lt;p&gt;1) if the bottom positions are very close or the elements overlap vertically, order by horizontal position (left first)&lt;/p&gt;

&lt;p&gt;2) else, order by vertical position (top first).&lt;/p&gt;


&lt;p&gt;Check out the drawing I&apos;ll attach and the following comparations a sorting algo would do:&lt;/p&gt;

&lt;p&gt;A-B: vertical overlap, rule 1, left wins, A&amp;lt;B&lt;br/&gt;
B-C: no overlap, not close, rule 2, upper bottom wins, B&amp;lt;C&lt;br/&gt;
A-C: vertical overlap, rule 1, left wins, C&amp;lt;A&lt;/p&gt;

&lt;p&gt;So in a nutshell, A comes before B; but C shall be inserted both after B and before A, which is inconsistent.&lt;/p&gt;


&lt;p&gt;Just by looking at the drawing I don&apos;t have any idea what a meaningful ordering of these boxes would be anyways...&lt;/p&gt;</comment>
                            <comment id="13947608" author="msahyoun" created="Wed, 26 Mar 2014 07:02:35 +0000"  >&lt;p&gt;I&#8217;d think that we can find a sorting algorithm which can handle such cases. Before that what would be the expectation of the sorting result looking at the drawing Hannes provided? Shall we look at inspecting the results of other tools such as Adobe Reader and replicate their behavior?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Update&amp;#93;&lt;/span&gt; Adobe Reader would extract the sample to C,A,B&lt;/p&gt;

&lt;p&gt;I&#8217;m willing to look into solving the issue but would like to have some input on the end result first.&lt;/p&gt;

&lt;p&gt;Maruan&lt;/p&gt;</comment>
                            <comment id="13947645" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"  >&lt;p&gt;A series of sample files model after the chart in &lt;a href=&quot;http://en.wikipedia.org/wiki/Topological_sorting&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://en.wikipedia.org/wiki/Topological_sorting&lt;/a&gt; together with the text extraction done by Adobe Reader.&lt;/p&gt;</comment>
                            <comment id="14029015" author="lehmi" created="Thu, 12 Jun 2014 10:46:44 +0000"  >&lt;p&gt;To avoid misunderstandings, IMHO the comparison itself isn&apos;t broken it works well, but it breaks the contract of the sort algorithm of the Collections framework.&lt;/p&gt;

&lt;p&gt;The issue is that PDFBox not only uses the x,y values of a text position. In some cases the context is taken into account if two positions are compared which are neighbors. So that there are cases where there same combination of x,y values may lead to different results if the sorting is done in another order.&lt;/p&gt;

&lt;p&gt;Saying that, it should be possible to simply replace the Collections.sort() call with our own sort implementation (e.g. based on quicksort) using the very same TestPositionComparator.&lt;/p&gt;

&lt;p&gt;Maybe there is some place for an improvement: &lt;br/&gt;
The whole text is splitted into text postition, one for each character, so that we have to sort all single characters. The information of text chunks/whole words/lines of text got lost. We could preserve that information within the TextPosition (number of chunk/ index within the chunk) to simplify the comparison.&lt;/p&gt;</comment>
                            <comment id="14127473" author="uwe_pachler" created="Tue, 9 Sep 2014 20:02:40 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I wrote a patch to implement quicksort, see quicksort.patch.&lt;/p&gt;

&lt;p&gt;Note: While the patch is written against the PDFBox 1.7 branch, it should be easy to apply on the trunk as well. The patch adds this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A Quicksort implementation and unit test&lt;/li&gt;
	&lt;li&gt;A check if we&apos;re running on JDK6 or less: If yes: use Collections.sort(), if no, use the QuickSort.sort()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The custom quicksort implementation is probably a fair bit slower than the one in the JDK (on my box the unit test TestTextStripper takes about 13s instead of 3 (4x), which is the reason for the JDK check. Another option would be to simply catch the exception and only run quicksort as a fallback in this case.&lt;/p&gt;

&lt;p&gt;Uwe&lt;/p&gt;</comment>
                            <comment id="14127476" author="uwe_pachler" created="Tue, 9 Sep 2014 20:07:14 +0000"  >&lt;p&gt;Adds a stock standard quicksort implementation and code to use it in PDFTextStripper if JDK version &amp;gt;= 1.7&lt;/p&gt;</comment>
                            <comment id="14128304" author="lehmi" created="Wed, 10 Sep 2014 10:09:48 +0000"  >&lt;p&gt;That&apos;s good news. I already tried that some time ago but I failed for some reason. I&apos;ll run some additional tests.&lt;/p&gt;</comment>
                            <comment id="14151565" author="akirakozov" created="Mon, 29 Sep 2014 10:10:11 +0000"  >&lt;p&gt;Hi, I have the same problem with java8. Any news?&lt;/p&gt;</comment>
                            <comment id="14151648" author="uwe_pachler" created="Mon, 29 Sep 2014 12:53:03 +0000"  >&lt;p&gt;I haven&apos;t yet, same as you I&apos;m waiting on Andreas&apos; feedback.&lt;/p&gt;

&lt;p&gt;@Andreas: How did the tests go? Anything I can do to help?&lt;/p&gt;</comment>
                            <comment id="14151927" author="tomc" created="Mon, 29 Sep 2014 17:27:10 +0000"  >&lt;p&gt;Part of the issue here is that &lt;tt&gt;TextPositionComparator&lt;/tt&gt; breaks the contract for &lt;tt&gt;Comparator&lt;/tt&gt;. Specifically, it doesn&apos;t ensure that the ordering is transitive. The &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/util/Comparator.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Comparator&lt;/a&gt; interface specifies that:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The implementor must also ensure that the relation is transitive: &lt;tt&gt;((compare(x, y)&amp;gt;0) &amp;amp;&amp;amp; (compare(y, z)&amp;gt;0))&lt;/tt&gt; implies &lt;tt&gt;compare(x, z)&amp;gt;0&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is currently not the case due to the vertical position tolerance. So &lt;tt&gt;TextPositionComparator&lt;/tt&gt; is not a valid &lt;tt&gt;Comparator&lt;/tt&gt; and it shouldn&apos;t be used for sorting. Using a custom Quicksort probably won&apos;t help much, as the ordering of the results will depend on the order in which elements are compared.&lt;/p&gt;</comment>
                            <comment id="14152349" author="uwe_pachler" created="Mon, 29 Sep 2014 21:43:03 +0000"  >&lt;p&gt;You&apos;re right, Tom, in principle we&apos;d need a different solution here to make the whole thing water tight (fix transitivity).&lt;/p&gt;

&lt;p&gt;But the intention for my patch wasn&apos;t to make the comparison perfect. The motivation was to simply extend what is the status quo on JDK 6 (an imperfect but working text stripper) to JDK 7 and onwards (status quo: unpredictably throwing exceptions). People have been living with the imperfect comparator for years in their solutions, so they won&apos;t notice a change - only that they can now use JDK 7 safely. &lt;/p&gt;

&lt;p&gt;Don&apos;t get me wrong; if you can provide a comparator that solves the problem, post it here, I&apos;d love to fix this properly.&lt;/p&gt;

&lt;p&gt;However, I&apos;ve been holding back migrating my project to JDK7 for over a year now because of this issue - I&apos;d much rather implement an imperfect but working solution today than having to wait for another year for an ideal fix.&lt;/p&gt;</comment>
                            <comment id="14153072" author="uwe_pachler" created="Tue, 30 Sep 2014 11:32:41 +0000"  >&lt;p&gt;No idea, I&apos;m simply a user who needs a fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
The patch I wrote is as unintrusive as it can be. On the other hand, using a different comparator will certainly change the behaviour of the library. I suspect that the person who wrote the comparator in the first place had a good reason to write it in the way it is now.&lt;/p&gt;

&lt;p&gt;But you can try and run the unit tests; if they dont&apos;t fail with that comparator of yours then it&apos;ll have my vote.&lt;/p&gt;</comment>
                            <comment id="14167901" author="jahewson" created="Sat, 11 Oct 2014 01:15:14 +0000"  >&lt;p&gt;&amp;gt; I suspect that the person who wrote the comparator in the first place had a good reason to write it in the way it is now.&lt;/p&gt;

&lt;p&gt;The infallibility of the previous author is probably not a safe assumption. I&apos;ve just noticed that &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-731&quot; title=&quot;Inconsistencies in TextPositionComparator and sortByPosition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-731&quot;&gt;&lt;del&gt;PDFBOX-731&lt;/del&gt;&lt;/a&gt; actually raises some of the shortcomings in the existing sort algorithm.&lt;/p&gt;</comment>
                            <comment id="14168121" author="uwe_pachler" created="Sat, 11 Oct 2014 12:23:45 +0000"  >&lt;p&gt;&amp;gt; The infallibility of the previous author is probably not a safe assumption.&lt;br/&gt;
I wouldn&apos;t go so far as to to assume the infallibility of any coder &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The current algo will have its weaknesses, no doubt. But devising one that works reliably may not be as easy as it seems.&lt;/p&gt;

&lt;p&gt;Why don&apos;t we:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Fix the released versions (1.7.x, 1.8.x) with the patch I provided? It&apos;s safe to do so, because it won&apos;t change the algorithm. It just makes it work on Java 1.7+&lt;/li&gt;
	&lt;li&gt;Fix the trunk (2.0+) properly, with a new comparator/algorithm&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This way, everyone wins:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Users of the released versions (like myself) get a quick fix that they desperately need.&lt;/li&gt;
	&lt;li&gt;PDFBox Developers get a chance to clean up this issue properly in the trunk, and on the same token improve the text extraction feature&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="14168131" author="tilman" created="Sat, 11 Oct 2014 12:51:26 +0000"  >&lt;p&gt;I agree with Uwe (although I didn&apos;t test the patch), although the workaround mentioned before (-Djava.util.Arrays.useLegacyMergeSort=true) would do the same (i.e. use a sort algorithm that doesn&apos;t detect the comparator flaw).&lt;/p&gt;</comment>
                            <comment id="14168139" author="lfcnassif" created="Sat, 11 Oct 2014 13:03:37 +0000"  >&lt;p&gt;+1 to Uwe proposed approach.&lt;/p&gt;</comment>
                            <comment id="14168141" author="uwe_pachler" created="Sat, 11 Oct 2014 13:06:12 +0000"  >&lt;p&gt;@Tilman:&lt;br/&gt;
The problem with the workaround is that it needs to be done outside the application, you can&apos;t just activate it around a PDFBox call. It also affects EVERY sort operation in the entire JVM.&lt;/p&gt;

&lt;p&gt;With a single JVM on a dedicated server this may not be a concern, but with larger installations I find the workaround a little too invasive.&lt;br/&gt;
You may not even have control over the JVM in which the library is running, so you can&apos;t apply the workaround in this case.&lt;/p&gt;</comment>
                            <comment id="14168152" author="tilman" created="Sat, 11 Oct 2014 13:42:42 +0000"  >&lt;p&gt;To the 21 watchers of this issue: is there anyone of you who can either 1) test the patch of Uwe in your own application, or if you don&apos;t build from source 2) are willing to test a 1.8 or a 2.0 snapshot? (if you respond please specify)&lt;/p&gt;

&lt;p&gt;I can commit the patch, but I&apos;m not using the text extraction so much, and I prefer a real world test, even if Uwe has provided a test.&lt;br/&gt;
I would count &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; remark of June (&quot;it should be possible to simply...&quot;) as a +1.&lt;/p&gt;</comment>
                            <comment id="14168634" author="jira-bot" created="Sun, 12 Oct 2014 12:56:55 +0000"  >&lt;p&gt;Commit 1631169 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631169&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1512&quot; title=&quot;TextPositionComparator is not compatible with Java 7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1512&quot;&gt;&lt;del&gt;PDFBOX-1512&lt;/del&gt;&lt;/a&gt;: don&apos;t use Collections.sort for JDKs &amp;gt;= 1.7 to avoid an IllegalArgumentException as proposed by Uwe Pachler&lt;/p&gt;</comment>
                            <comment id="14168636" author="jira-bot" created="Sun, 12 Oct 2014 13:07:23 +0000"  >&lt;p&gt;Commit 1631170 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; in branch &apos;pdfbox/branches/1.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631170&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1512&quot; title=&quot;TextPositionComparator is not compatible with Java 7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1512&quot;&gt;&lt;del&gt;PDFBOX-1512&lt;/del&gt;&lt;/a&gt;: don&apos;t use Collections.sort for JDKs &amp;gt;= 1.7 to avoid an IllegalArgumentException as proposed by Uwe Pachler&lt;/p&gt;</comment>
                            <comment id="14168638" author="lehmi" created="Sun, 12 Oct 2014 13:11:28 +0000"  >&lt;p&gt;I&apos;ve applied the Uwes Patch to the trunk and the 1.8 branch.&lt;/p&gt;

&lt;p&gt;Thanks for the contribution!&lt;/p&gt;</comment>
                            <comment id="14168681" author="tilman" created="Sun, 12 Oct 2014 15:42:10 +0000"  >&lt;p&gt;There&apos;s one thing that needs to be decided that is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2397&quot; title=&quot;Running within an Applet throws an AccessControlException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2397&quot;&gt;&lt;del&gt;PDFBOX-2397&lt;/del&gt;&lt;/a&gt; (applet security): what will we do when the applet is running in a sandbox without permissions, i.e. what would be the default setting? Applets are considered &quot;dangerous&quot;, so the few people who still use them will probably run a recent JRE version.&lt;/p&gt;</comment>
                            <comment id="14168707" author="lehmi" created="Sun, 12 Oct 2014 16:28:07 +0000"  >&lt;p&gt;AFAIU &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2397&quot; title=&quot;Running within an Applet throws an AccessControlException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2397&quot;&gt;&lt;del&gt;PDFBOX-2397&lt;/del&gt;&lt;/a&gt; the issue isn&apos;t limited to applets but to signed jars as used with java webstart as well. To answer your question, IMHO in such cases the default value for &quot;useCustomQuicksort&quot; should be &quot;true&quot; to be sure that everything works well.&lt;/p&gt;</comment>
                            <comment id="14169435" author="jira-bot" created="Mon, 13 Oct 2014 15:58:59 +0000"  >&lt;p&gt;Commit 1631448 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631448&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1512&quot; title=&quot;TextPositionComparator is not compatible with Java 7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1512&quot;&gt;&lt;del&gt;PDFBOX-1512&lt;/del&gt;&lt;/a&gt;: use quicksort if run in an applet&lt;/p&gt;</comment>
                            <comment id="14169438" author="jira-bot" created="Mon, 13 Oct 2014 16:00:16 +0000"  >&lt;p&gt;Commit 1631449 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/1.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1631449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1631449&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1512&quot; title=&quot;TextPositionComparator is not compatible with Java 7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1512&quot;&gt;&lt;del&gt;PDFBOX-1512&lt;/del&gt;&lt;/a&gt;: use quicksort if run in an applet&lt;/p&gt;</comment>
                            <comment id="14169443" author="tilman" created="Mon, 13 Oct 2014 16:03:06 +0000"  >&lt;p&gt;I&apos;ll make a better solution when &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bgillis&quot; class=&quot;user-hover&quot; rel=&quot;bgillis&quot;&gt;bgillis&lt;/a&gt; has answered my question in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2397&quot; title=&quot;Running within an Applet throws an AccessControlException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2397&quot;&gt;&lt;del&gt;PDFBOX-2397&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15030305" author="lars t" created="Fri, 27 Nov 2015 23:12:29 +0000"  >&lt;p&gt;Which PDF caused the IllegalArgumentException in TIKA?&lt;/p&gt;

&lt;p&gt;For testing purposes in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2996&quot; title=&quot;StackOverflow in Quicksort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2996&quot;&gt;&lt;del&gt;PDFBOX-2996&lt;/del&gt;&lt;/a&gt; I want to check if the useLegacyMergeSort option is working.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12602631">TIKA-972</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12465120">PDFBOX-731</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12896625">PDFBOX-2996</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12607874" name="FOP-2252.pdf" size="210279" author="tilman" created="Thu, 10 Oct 2013 20:02:50 +0000"/>
                            <attachment id="12568399" name="TextPositionComparator.java" size="3543" author="bpapez" created="Thu, 7 Feb 2013 09:41:16 +0000"/>
                            <attachment id="12636876" name="Topo.pdf" size="17647" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"/>
                            <attachment id="12636875" name="Topo.txt" size="30" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"/>
                            <attachment id="12636872" name="TopoContained.pdf" size="19401" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"/>
                            <attachment id="12636871" name="TopoContained.txt" size="30" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"/>
                            <attachment id="12636874" name="TopoOverlap.pdf" size="18654" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"/>
                            <attachment id="12636873" name="TopoOverlap.txt" size="33" author="msahyoun" created="Wed, 26 Mar 2014 07:57:26 +0000"/>
                            <attachment id="12601826" name="WFI_PDFParser_TextPostionComparator.txt" size="3104" author="sbscom" created="Fri, 6 Sep 2013 13:16:28 +0000"/>
                            <attachment id="12635917" name="illustration-of-inconsistent-sorting.png" size="2648" author="hannibal218bc" created="Thu, 20 Mar 2014 23:50:16 +0000"/>
                            <attachment id="12588783" name="immo-kurier_arsenal_93x62.pdf" size="1710575" author="hannibal218bc" created="Thu, 20 Jun 2013 08:19:24 +0000"/>
                            <attachment id="12667469" name="quicksort.patch" size="8018" author="uwe_pachler" created="Tue, 9 Sep 2014 20:07:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hsn3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312067</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>