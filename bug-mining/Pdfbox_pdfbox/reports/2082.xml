<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:08:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4392] PDF completely blow up the RAM on amazon instances</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4392</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;Hi all&lt;/p&gt;

&lt;p&gt;The issue is pretty straightforward. I receive a lot of pdfs every day and render them. In most of the cases everything is OK, but PDFs which produces&#160;&lt;/p&gt;

&lt;p&gt;WARN org.apache.pdfbox.pdmodel.graphics.color.PDICCBased - ICC profile is Perceptual, ignoring, treating as Display class&lt;/p&gt;

&lt;p&gt;working super long, and are super memory consumable.&#160;&lt;/p&gt;

&lt;p&gt;It takes from 5 to 15 min on m5.large amazon instance. But attached PDF completely killed the instance. The java process is just killed by linux during processing with no exception in logs.&#160;&lt;/p&gt;

&lt;p&gt;So could you please provide explanations what is going on with files with WARN message above, and how can I improve the rendering.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is my VM options&#160;&lt;/p&gt;

&lt;p&gt;-Dorg.apache.pdfbox.rendering.UsePureJavaCMYKConversion=true -Xmx3G -Xms2G -Dsun.java2d.cmm=sun.java2d.cmm.kcms.KcmsServiceProvider&quot;&lt;/p&gt;

&lt;p&gt;Also don&apos;t hesitate to ask me about more PDF, I have tones of them &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And also a question, does GPU have influence on rendering?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13201964">PDFBOX-4392</key>
            <summary>PDF completely blow up the RAM on amazon instances</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="AlexFaster">Oleksandr Skoryi</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Dec 2018 11:16:33 +0000</created>
                <updated>Thu, 28 Feb 2019 17:44:52 +0000</updated>
                            <resolved>Sun, 9 Dec 2018 13:37:17 +0000</resolved>
                                    <version>2.0.12</version>
                                    <fixVersion>2.0.14</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>Rendering</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16707094" author="tilman" created="Mon, 3 Dec 2018 12:09:48 +0000"  >&lt;p&gt;The file has 4521 small images in it. See in PDFDebugger at &lt;tt&gt;Root/Pages/Kids/&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;/Resources/XObject/Im4/Resources/XObject/Im0&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;You could try the strategies mentioned here:&lt;br/&gt;
&lt;a href=&quot;https://pdfbox.apache.org/2.0/faq.html#im-getting-an-outofmemoryerror-what-can-i-do&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/2.0/faq.html#im-getting-an-outofmemoryerror-what-can-i-do&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16707114" author="tilman" created="Mon, 3 Dec 2018 12:22:31 +0000"  >&lt;p&gt;On my PC it takes 106 seconds to render in the &lt;del&gt;&quot;ridiculous speed&quot;&lt;/del&gt; &quot;ultimate speed&quot; mode of Windows 10, I have set -Xmx2g. Yes GPU may be relevant. The warning is not really important.&lt;/p&gt;</comment>
                            <comment id="16707121" author="itai" created="Mon, 3 Dec 2018 12:29:51 +0000"  >&lt;p&gt;I started looking at the warning message, and the potential performance impact of copying and re-parsing the entire ICC profile in case it is Perceptual, and I came across something peculiar, which may be a bug.&#160;&lt;/p&gt;

&lt;p&gt;In line 220 of the file PDICCBased.java the following test is used to check whether the profile is perceptual:&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;if (profileData&lt;span class=&quot;error&quot;&gt;&amp;#91;ICC_Profile.icHdrRenderingIntent&amp;#93;&lt;/span&gt; == ICC_Profile.icPerceptual)&#160;&#160;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Where icHdrRenderingIntent has the value 64 and icPerceptual is 0.&#160;&lt;/p&gt;

&lt;p&gt;The ICC format specification (&lt;a href=&quot;http://www.color.org/specification/ICC1v43_2010-12.pdf)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.color.org/specification/ICC1v43_2010-12.pdf)&lt;/a&gt;&#160;has a table in page 19 describing the format of the header, in which the field Rendering Intent is indeed in bytes 64-67 of the header. In page 23 however, where Rendering Intent is described, it says &quot;The field is a uInt32Number in which the least-significant 16 bits shall be used to encode the rendering intent. The most significant 16 bits shall be set to zero (0000h).&quot; .&#160; Since the entire format is Big-Endian, this to me means the value to be checked should actually be in index 67 (profileData&lt;span class=&quot;error&quot;&gt;&amp;#91;ICC_Profile.icHdrRenderingIntent + 3&amp;#93;&lt;/span&gt;), and the current test will always return true - regardless of the rendering intent.&#160;&#160;&lt;/p&gt;

&lt;p&gt;If this is indeed the case, PDFBox may be wrongfully changing profiles, which may impact both performance and accuracy.&#160;&#160;&lt;/p&gt;

&lt;p&gt;Or am I misunderstanding the specification?&#160;&lt;/p&gt;</comment>
                            <comment id="16707163" author="itai" created="Mon, 3 Dec 2018 12:57:27 +0000"  >&lt;p&gt;Regardless of whether the Intent is checked correctly, I have put together a patch to read the profile data and make the necessary fix before calling ICC_Profile.getInstance. Testing on the file attached here - before this change it takes 104s to render on my machine, and after the change it takes 62s, so at least in such cases with thousands of problematic profiles it makes a significant difference.&#160;&lt;/p&gt;

&lt;p&gt;I do not have the time currently for more extensive tests, and the patch could use some refining (currently on errors I return null, should probably throw an exception instead, etc.), but I&apos;m hoping to get to it later this week (unless someone else does it first).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950397/12950397_4392-prereadICC.patch&quot; title=&quot;4392-prereadICC.patch attached to PDFBOX-4392&quot;&gt;4392-prereadICC.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16707200" author="alexfaster" created="Mon, 3 Dec 2018 13:32:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=itai&quot; class=&quot;user-hover&quot; rel=&quot;itai&quot;&gt;itai&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks a lot!&lt;/p&gt;

&lt;p&gt;In which version can I expect the fix? And do u have information about memory consumption after fix?&lt;/p&gt;</comment>
                            <comment id="16707204" author="tilman" created="Mon, 3 Dec 2018 13:33:07 +0000"  >&lt;p&gt;I sounds like a good idea so I tested it; but there are many differences. For example, the file from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3549&quot; title=&quot;Can&amp;#39;t read embedded ICC 4 profile (Invalid profile sequence)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3549&quot;&gt;&lt;del&gt;PDFBOX-3549&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;http://www.color.org/version4pdf.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.color.org/version4pdf.pdf&lt;/a&gt; ) is different on the upper right quadrant, in the file of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2142&quot; title=&quot;some /ICCBased colorspaces not rendered correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2142&quot;&gt;&lt;del&gt;PDFBOX-2142&lt;/del&gt;&lt;/a&gt; the &quot;logo&quot; box of XYZ is different. Tested with KCMS set.&lt;/p&gt;</comment>
                            <comment id="16707271" author="itai" created="Mon, 3 Dec 2018 14:28:41 +0000"  >&lt;p&gt;Thanks for the problematic examples Tilman!&#160;&lt;/p&gt;

&lt;p&gt;Looks like I was reading the length wrong, and upon fixing this the results are almost exactly back to the original version. I&apos;ll try looking into it again later, as it seems at least some improvement should be possible, but for now - sorry for the false hope!&#160;&lt;/p&gt;</comment>
                            <comment id="16707355" author="alexfaster" created="Mon, 3 Dec 2018 15:19:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=itai&quot; class=&quot;user-hover&quot; rel=&quot;itai&quot;&gt;itai&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for efforts, I will try to use&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;disable the cache for&#160;&lt;tt&gt;PDImageXObject&lt;/tt&gt;&#160;objects by calling&#160;&lt;tt&gt;PDDocument.setResourceCache()&lt;/tt&gt;&#160;with a cache object that is derived from&#160;&lt;tt&gt;DefaultResourceCache&lt;/tt&gt;&#160;and whose call&#160;&lt;tt&gt;public void put(COSObject indirect, PDXObject xobject)&lt;/tt&gt;&#160;does nothing. Be aware that this will slow down rendering for PDF files that have an identical image in several pages (e.g. a company logo or a background). More about this can be read in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3700&quot; title=&quot;OutOfMemoryException converting PDF to TIFF Images&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3700&quot;&gt;&lt;del&gt;PDFBOX-3700&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;this one from advices, other cases are already applied, reduce dpi is not the case for my flow&lt;/p&gt;

&lt;p&gt;But anyway let me know if I can tune the performance somehow&lt;/p&gt;</comment>
                            <comment id="16711354" author="itai" created="Thu, 6 Dec 2018 11:58:29 +0000"  >&lt;p&gt;So I looked into it more closely using a profiler (should have done this in the first place, as it revealed the call to `ensureDisplayProfile`&#160;has&#160;negligible performance impact), and it seems lots of time is wasted on the call to `toRGB` in line 170 of PDICCBased.&#160; According to the comment above the call, this is done to test for bad ICC profiles as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1295&quot; title=&quot;Unable to create the color instance / bg color inverted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1295&quot;&gt;&lt;del&gt;PDFBOX-1295&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1740&quot; title=&quot;Umlaut not rendered correctly in TTF composite glyph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1740&quot;&gt;&lt;del&gt;PDFBOX-1740&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3610&quot; title=&quot;ArrayIndexOutOfBoundsException in PDICCBased.loadICCProfile()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3610&quot;&gt;&lt;del&gt;PDFBOX-3610&lt;/del&gt;&lt;/a&gt;.&#160; &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1740&quot; title=&quot;Umlaut not rendered correctly in TTF composite glyph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1740&quot;&gt;&lt;del&gt;PDFBOX-1740&lt;/del&gt;&lt;/a&gt; seems totally unrelated, so perhaps a typo in the comment? I have tried removing the call, and the files from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1295&quot; title=&quot;Unable to create the color instance / bg color inverted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1295&quot;&gt;&lt;del&gt;PDFBOX-1295&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3610&quot; title=&quot;ArrayIndexOutOfBoundsException in PDICCBased.loadICCProfile()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3610&quot;&gt;&lt;del&gt;PDFBOX-3610&lt;/del&gt;&lt;/a&gt; both render correctly (even with the call - no exception is thrown).&#160; Furthermore, removing this call cuts render time on the file in this issue by ~50%.&#160;&lt;/p&gt;

&lt;p&gt;Could this be an issue with a bug in an older JDK version, and so is no longer needed? If so - perhaps a test can be added so `toRGB` is only called on known bad JDK versions?&#160;&lt;/p&gt;</comment>
                            <comment id="16711383" author="itai" created="Thu, 6 Dec 2018 12:33:56 +0000"  >&lt;p&gt;This may shed some more light on the issue - the next line (172) creates a new `Color` object, which itself calls `toRGB` on the given color space - this seems to have been done later as a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3549&quot; title=&quot;Can&amp;#39;t read embedded ICC 4 profile (Invalid profile sequence)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3549&quot;&gt;&lt;del&gt;PDFBOX-3549&lt;/del&gt;&lt;/a&gt;. This explains why removing the first call to `toRGB` improves performance by 50% - it was being called 2 times! To me this seems like proof the first call is redundant - the exception will be thrown in the constructor of `Color`, if it passed the previous test.&#160;&lt;/p&gt;

&lt;p&gt;Since the call to `toRGB` seems to be extremely slow, perhaps it is wise to also reverse the order of remaining to tests (creating a `Color` and a `ComponentColorModel`), so the slowest test is saved for last, and skipped if the profile is deemed problematic sooner.&#160;&lt;/p&gt;</comment>
                            <comment id="16711426" author="tilman" created="Thu, 6 Dec 2018 13:17:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1740&quot; title=&quot;Umlaut not rendered correctly in TTF composite glyph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1740&quot;&gt;&lt;del&gt;PDFBOX-1740&lt;/del&gt;&lt;/a&gt; is not a typo - the file was mentioned by me and by John in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1893&quot; title=&quot;Refactor color spaces&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1893&quot;&gt;&lt;del&gt;PDFBOX-1893&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll retest with KCMS and LCMS whether we can delete the call from line 170.&lt;/p&gt;

&lt;p&gt;I think the order doesn&apos;t matter because most files don&apos;t fail.&lt;/p&gt;</comment>
                            <comment id="16711485" author="tilman" created="Thu, 6 Dec 2018 14:00:39 +0000"  >&lt;p&gt;I looked into the Color source code, that explains it LOL.&lt;/p&gt;</comment>
                            <comment id="16711504" author="jira-bot" created="Thu, 6 Dec 2018 14:24:13 +0000"  >&lt;p&gt;Commit 1848318 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1848318&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1848318&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4392&quot; title=&quot;PDF completely blow up the RAM on amazon instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4392&quot;&gt;&lt;del&gt;PDFBOX-4392&lt;/del&gt;&lt;/a&gt;: remove toRGB() which is contained in Color() construction, thanks Itai Shaked&lt;/p&gt;</comment>
                            <comment id="16711505" author="jira-bot" created="Thu, 6 Dec 2018 14:24:18 +0000"  >&lt;p&gt;Commit 1848319 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1848319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1848319&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4392&quot; title=&quot;PDF completely blow up the RAM on amazon instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4392&quot;&gt;&lt;del&gt;PDFBOX-4392&lt;/del&gt;&lt;/a&gt;: remove toRGB() which is contained in Color() construction, thanks Itai Shaked&lt;/p&gt;</comment>
                            <comment id="16711528" author="tilman" created="Thu, 6 Dec 2018 14:46:07 +0000"  >&lt;p&gt;I&apos;ll retest with KCMS and LCMS whether the ComponentColorModel construction is still needed. And also whether the &quot;new Color&quot; is needed on LCMS.&lt;/p&gt;</comment>
                            <comment id="16711613" author="tilman" created="Thu, 6 Dec 2018 15:45:54 +0000"  >&lt;p&gt;ComponentColorModel construction is still needed when using LCMS.&lt;/p&gt;

&lt;p&gt;Everything else isn&apos;t needed when using LCMS.&lt;/p&gt;
</comment>
                            <comment id="16711704" author="jira-bot" created="Thu, 6 Dec 2018 17:04:40 +0000"  >&lt;p&gt;Commit 1848341 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1848341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1848341&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4392&quot; title=&quot;PDF completely blow up the RAM on amazon instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4392&quot;&gt;&lt;del&gt;PDFBOX-4392&lt;/del&gt;&lt;/a&gt;: work around java CMS bugs depending of the jdk version / the CMS type&lt;/p&gt;</comment>
                            <comment id="16711705" author="jira-bot" created="Thu, 6 Dec 2018 17:04:45 +0000"  >&lt;p&gt;Commit 1848342 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1848342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1848342&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4392&quot; title=&quot;PDF completely blow up the RAM on amazon instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4392&quot;&gt;&lt;del&gt;PDFBOX-4392&lt;/del&gt;&lt;/a&gt;: work around java CMS bugs depending of the jdk version / the CMS type&lt;/p&gt;</comment>
                            <comment id="16711722" author="tilman" created="Thu, 6 Dec 2018 17:19:05 +0000"  >&lt;p&gt;&lt;tt&gt;isMinJdk8()&lt;/tt&gt; is now double... (also in PDFRenderer) I don&apos;t have a good idea where to put it and how to name it.&lt;/p&gt;</comment>
                            <comment id="16712491" author="jira-bot" created="Fri, 7 Dec 2018 08:37:56 +0000"  >&lt;p&gt;Commit 1848383 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1848383&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1848383&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4392&quot; title=&quot;PDF completely blow up the RAM on amazon instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4392&quot;&gt;&lt;del&gt;PDFBOX-4392&lt;/del&gt;&lt;/a&gt;: Reorder the modifiers to comply with the Java Language Specification&lt;/p&gt;</comment>
                            <comment id="16712492" author="jira-bot" created="Fri, 7 Dec 2018 08:38:00 +0000"  >&lt;p&gt;Commit 1848384 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1848384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1848384&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4392&quot; title=&quot;PDF completely blow up the RAM on amazon instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4392&quot;&gt;&lt;del&gt;PDFBOX-4392&lt;/del&gt;&lt;/a&gt;: Reorder the modifiers to comply with the Java Language Specification&lt;/p&gt;</comment>
                            <comment id="16712514" author="tilman" created="Fri, 7 Dec 2018 09:05:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AlexFaster&quot; class=&quot;user-hover&quot; rel=&quot;AlexFaster&quot;&gt;AlexFaster&lt;/a&gt; please test with a snapshot&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.14-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.14-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and tell whether time and/or space got better for you. Also mention what java version you are using.&lt;/p&gt;</comment>
                            <comment id="16712515" author="alexfaster" created="Fri, 7 Dec 2018 09:08:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am using java 8&lt;/p&gt;</comment>
                            <comment id="16712527" author="tilman" created="Fri, 7 Dec 2018 09:22:17 +0000"  >&lt;p&gt;There are several different java 8 versions, the early ones (I think up to 1.8.0_40) were really bad. For example, mine is:&lt;/p&gt;

&lt;p&gt;java version &quot;1.8.0_192&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.8.0_192-b12)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)&lt;/p&gt;

&lt;p&gt;If you are using oracle java 8, then make sure to update at least to &lt;font color=&quot;#333333&quot;&gt;1.8.0_191&lt;/font&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.oracle.com/technetwork/java/javase/downloads/index.html#JDK8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.oracle.com/technetwork/java/javase/downloads/index.html#JDK8&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16712554" author="alexfaster" created="Fri, 7 Dec 2018 09:42:33 +0000"  >&lt;p&gt;hmm, probably it is the root of the issue, because currently we are using 1.8.0_25 on production.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also very interesting thing, I tested with &lt;b&gt;2.0.12&lt;/b&gt; again and !!! For attached pdf the recommendation to use&#160;-Dsun.java2d.cmm=sun.java2d.cmm.kcms.KcmsServiceProvider make everything slower, not faster. I am using 1.8.0_181 on my local machine&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;With KCMS&#160; version=2.12&#160; 2min 22sec&lt;/p&gt;

&lt;p&gt;&#160;Without KCMS version= 2.12&#160; 1min 23sec&lt;/p&gt;

&lt;p&gt;&lt;b&gt;UPDATE&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;With KCMS&#160; version=2.14&#160; 2min 20sec&lt;/p&gt;

&lt;p&gt;&#160;Without KCMS version= 2.14 1min 03sec&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Significant difference&lt;/p&gt;

&lt;p&gt;I have macbook pro 15, 2015 basic model with 256GB SSD&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16712599" author="alexfaster" created="Fri, 7 Dec 2018 10:07:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I will try same tests with java _192 version&lt;/p&gt;

&lt;p&gt;Almost no changes comparing with _181&lt;/p&gt;

&lt;p&gt;But what I know now, that I will definitely turn off&#160;&lt;br/&gt;
-Dsun.java2d.cmm=sun.java2d.cmm.kcms.KcmsServiceProvider&lt;/p&gt;

&lt;p&gt;It reduces speed significantly!&lt;/p&gt;

&lt;p&gt;Do u struggle the same issue?&lt;/p&gt;</comment>
                            <comment id="16712663" author="tilman" created="Fri, 7 Dec 2018 11:01:58 +0000"  >&lt;p&gt;Yes I can confirm that dropping KCMS makes it faster. We had such a case before, it seems that Oracle has removed the worst slowness from LCMS.&lt;/p&gt;</comment>
                            <comment id="16712666" author="tilman" created="Fri, 7 Dec 2018 11:04:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=itai&quot; class=&quot;user-hover&quot; rel=&quot;itai&quot;&gt;itai&lt;/a&gt; do you still intend to improve your patch or not? I just ran the profiler too and like you mentioned, &lt;tt&gt;ensureDisplayProfile()&lt;/tt&gt; didn&apos;t appear.&lt;/p&gt;</comment>
                            <comment id="16712916" author="alexfaster" created="Fri, 7 Dec 2018 14:25:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&quot;Yes I can confirm that dropping KCMS makes it faster. We had such a case before, it seems that Oracle has removed the worst slowness from LCMS.&quot;&lt;/p&gt;

&lt;p&gt;Probably you should remove those WARN message&lt;/p&gt;</comment>
                            <comment id="16713137" author="tilman" created="Fri, 7 Dec 2018 17:59:46 +0000"  >&lt;p&gt;Will be done in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4401&quot; title=&quot;Fine-tune KCMS warning message + update documentation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4401&quot;&gt;&lt;del&gt;PDFBOX-4401&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16713909" author="itai" created="Sun, 9 Dec 2018 09:42:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; - As profiling shows there is almost no impact to re-parsing the ICC profile, I don&apos;t think I will continue working on the patch. At most it will have negligible performance improvement, and it means more code to be maintained in PDFBox which already exists in the JDK, so I personally don&apos;t think it will be worth it.&#160;&lt;/p&gt;

&lt;p&gt;What I am thinking of maybe doing is trying to find a way to &quot;predict&quot; whether LCMS/KCMS will have a problem with the ICC profile, so maybe fallback can be performed without actually calling `new Color` or other potentially-slow operations. I am not entirely sure it is possible, but learning more about ICC profiles was something I&apos;ve been meaning to do anyway.&#160;&lt;/p&gt;

&lt;p&gt;If I do manage to find a quick and reliable way to test the validity (in the sense tested by the lines discussed here) of an ICC profile I will create a new patch, but perhaps by then it would make sense to create a new issue altogether.&#160;&lt;/p&gt;</comment>
                            <comment id="16713978" author="tilman" created="Sun, 9 Dec 2018 13:37:17 +0000"  >&lt;p&gt;OK, and thanks all for the input here. Setting to resolved.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13139268">PDFBOX-4114</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12950374" name="2f0f8f77-7a85-416d-b5d2-47a07d1416d4_3.pdf" size="16559557" author="AlexFaster" created="Mon, 3 Dec 2018 11:10:45 +0000"/>
                            <attachment id="12950397" name="4392-prereadICC.patch" size="3756" author="itai" created="Mon, 3 Dec 2018 12:57:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s013n4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>