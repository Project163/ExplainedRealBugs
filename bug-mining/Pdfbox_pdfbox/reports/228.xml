<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:53:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-807] NullPointerException in StandardSecurityHandler.java:261</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-807</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I like to add text to a PDF and used the example code AddMessageToEachPage.java to do this. I added decryption to support encrypted docs:&lt;/p&gt;

&lt;p&gt;                doc = PDDocument.load(sourceFile);&lt;br/&gt;
                if (doc.isEncrypted()) &lt;/p&gt;
{
                    doc.decrypt(ownerPwd);
                }


&lt;p&gt;When my document is encrypted, the decryption succeeds without error message, but for such encrypted docs, when callinf doc.save(), a NullPointerException occurs:&lt;/p&gt;

&lt;p&gt;-----------------------------------------&lt;br/&gt;
    java.lang.NullPointerException&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.encryption.StandardSecurityHandler.prepareDocumentForEncryption(StandardSecurityHandler.java:261)&lt;br/&gt;
    	at org.apache.pdfbox.pdfwriter.COSWriter.write(COSWriter.java:1013)&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:911)&lt;br/&gt;
    	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:892)&lt;br/&gt;
-----------------------------------------------------------------&lt;/p&gt;</description>
                <environment>JDK 1.6.0_21, Windows XP 32 Bit.</environment>
        <key id="12472917">PDFBOX-807</key>
            <summary>NullPointerException in StandardSecurityHandler.java:261</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="mhilpert">MH</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Aug 2010 09:09:49 +0000</created>
                <updated>Tue, 1 Jan 2013 16:02:03 +0000</updated>
                            <resolved>Sat, 19 May 2012 17:12:29 +0000</resolved>
                                    <version>1.2.1</version>
                                    <fixVersion>1.7.0</fixVersion>
                                    <component>PDModel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="12905631" author="adamnichols" created="Thu, 2 Sep 2010 18:36:32 +0000"  >&lt;p&gt;If possible, you should use the latest code from SVN.  I&apos;m using the latest code and I noticed the lines don&apos;t match up to your stacktrace.  Also, if you can provide an example file so we can duplicate the issue and debug, that might help us get this resolved.&lt;/p&gt;

&lt;p&gt;If your goal is to save an unencrypted PDF, you&apos;ll want to call doc.setAllSecurityToBeRemoved(true); before saving.&lt;/p&gt;

&lt;p&gt;If your goal is to save the PDF in its encrypted form, then I believe what you have should work.  You call decrypt(String) which calls openProtection() and that should pull get the securityHandler.  In fact, it must be getting a securityHandler, as the following line would throw a NPE if it was null.&lt;/p&gt;

&lt;p&gt;I think I&apos;ll need an example document to be able to sort this on out.  As far as I can tell, the only times the securityHandler can be modified is in protect() and openProtection().  So I&apos;m not sure what&apos;s going on here.  I&apos;m sure a quick trip down debugger lane will shed some light on the problem though.&lt;/p&gt;</comment>
                            <comment id="12929058" author="avacondio" created="Sat, 6 Nov 2010 16:12:44 +0000"  >&lt;p&gt;This can actually be reproduced always using the boudled Decrypt utility (but you have to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-888&quot; title=&quot;Decrypt doesn&amp;#39;t allow more then 3 args&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-888&quot;&gt;&lt;del&gt;PDFBOX-888&lt;/del&gt;&lt;/a&gt; before being able to run it) and trying to decrypt any encrypted document providing an owner password. Calling doc.setAllSecurityToBeRemoved(true) before saving fixed the issue.&lt;br/&gt;
What happen I think is that MH tried to create a simple decrypt class following the provided example (like me) with a NPE as result.&lt;/p&gt;

&lt;p&gt;Here is a stack trace taken running a test with pdfbox 1.4.0-SNAPSHOT revision 1032087. &lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.encryption.StandardSecurityHandler.prepareDocumentForEncryption(StandardSecurityHandler.java:261)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.write(COSWriter.java:1018)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:911)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:892)&lt;br/&gt;
	at org.apache.pdfbox.Decrypt.decrypt(Decrypt.java:153)&lt;br/&gt;
	at org.apache.pdfbox.Decrypt.main(Decrypt.java:57)&lt;br/&gt;
	at org.apache.pdfbox.DecryptTest.testMain(DecryptTest.java:11)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;/p&gt;

</comment>
                            <comment id="13056790" author="adamnichols" created="Tue, 28 Jun 2011 21:15:33 +0000"  >&lt;p&gt;According to my earlier comments, I wasn&apos;t able to duplicate this issue.  Andrea says it can be duplicated using the code from the issue and confirms that Calling doc.setAllSecurityToBeRemoved(true) before saving fixed the issue.  You should be able to save without removing the encryption though, as long as you have the correct password, of course.&lt;/p&gt;

&lt;p&gt;If anyone is still having issues with this, please comment.  If nobody responds, I&apos;ll go ahead and close out this issue.&lt;/p&gt;</comment>
                            <comment id="13093669" author="torakiki" created="Tue, 30 Aug 2011 12:05:58 +0000"  >&lt;p&gt;Encrypted document with owner password &quot;test&quot;&lt;/p&gt;</comment>
                            <comment id="13093671" author="torakiki" created="Tue, 30 Aug 2011 12:08:04 +0000"  >&lt;p&gt;I attached an encrypted document with owner password &quot;test&quot;. Using PDFBox 1.6.0 I created a simple test:&lt;/p&gt;

&lt;p&gt;public void testDec() throws Exception {&lt;/p&gt;

&lt;p&gt;        String[] args = &lt;/p&gt;
{ &quot;-password&quot;, &quot;test&quot;,
                &quot;/tmp/enc_test_test_file.pdf&quot;,
                &quot;/tmp/out.pdf&quot; }
&lt;p&gt;;&lt;br/&gt;
        Decrypt.main(args);&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;And I got the following stacktrace:&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.encryption.StandardSecurityHandler.prepareDocumentForEncryption(StandardSecurityHandler.java:283)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.write(COSWriter.java:1306)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:1121)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:1102)&lt;br/&gt;
	at org.apache.pdfbox.Decrypt.decrypt(Decrypt.java:153)&lt;br/&gt;
	at org.apache.pdfbox.Decrypt.main(Decrypt.java:57)&lt;br/&gt;
	........&lt;/p&gt;</comment>
                            <comment id="13279589" author="lehmi" created="Sat, 19 May 2012 17:12:29 +0000"  >&lt;p&gt;As Adam already mentioned. I just added a call of PDDocument#setAllSecurityToBeRemoved(true) before saving the pdf to the Decrypt class in revision 1340517.&lt;/p&gt;

&lt;p&gt;This was easy to solve as Adam already did all the work.&lt;/p&gt;</comment>
                            <comment id="13541652" author="karlnicholas" created="Tue, 1 Jan 2013 16:02:03 +0000"  >&lt;p&gt;I don&apos;t really think this should be marked as fix and it should be reopened. I ran across this bug in versino 1.7.1. I worked around the issue by calling PDDocument#encrypt(&quot;&quot;, &quot;&quot;) before calling PDDocument#save(). I have to call this even though the PDDocument says it&apos;s not encryped. The document was once was encrypted and had to be decrypted after it was loaded. When you call PDDocument#save() it realizes that it once was, or should be, encrypted and improperly constructs StandardSecurityHandler without a StandardProtectionPolicy. StandardProtectionPolicy is where the passwords and Permissions are stored, so that&apos;s why it gets a NPE when trying to encrypt the document before &quot;saving&quot; it. &lt;/p&gt;

&lt;p&gt;I chased the problem a little bit. The issue is that the document was encrypted, so the I decrypt it after loading it, so as to work on it. In my case I was reading and writing fields. Then, when I call myPDFDoc.save, PDFBox realizes the document &quot;wants&quot; to be encrypted but the proper constructor in ...StandardSecurityHandler is not called. Calling PDDocument#encrypt(&quot;&quot;, &quot;&quot;) causes the proper StandardSecurityHandler constructror to be called and instantiated in the document.&lt;/p&gt;

&lt;p&gt;True, you can also work around the problem by calling PDDocument#setAllSecurityToBeRemoved(true), but this merely makes the document get saved as unencrypted. This may not be what a PDFBox user wants.&lt;/p&gt;

&lt;p&gt;Anyway, I think it points to a larger issue about how consistantly encryption is being handled in a API and implementation.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12492230" name="enc_test_test_file.pdf" size="44855" author="torakiki" created="Tue, 30 Aug 2011 12:05:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63150</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 46 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zfcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204790</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>