<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:00:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2781] Opening pdf document after encrypting it with PDFBox throws IllegalBlockSizeException</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2781</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I&apos;m trying to encrypt pdf document as per &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PDDocument doc = PDDocument.loadNonSeq(getClass().getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;/testform_protected.pdf&quot;&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);

&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; keyLength = 128; &lt;span class=&quot;code-comment&quot;&gt;// 40 or 128; 256 will be available in version 2.0
&lt;/span&gt;AccessPermission ap = doc.getCurrentAccessPermission();

StandardProtectionPolicy spp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StandardProtectionPolicy(&lt;span class=&quot;code-quote&quot;&gt;&quot;12345&quot;&lt;/span&gt;, &quot;&quot;, ap);
spp.setEncryptionKeyLength(keyLength);
spp.setPermissions(ap);
doc.protect(spp);

File outFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;./target/testform_saved.pdf&quot;&lt;/span&gt;);

doc.save(outFile);
doc.close();

PDDocument loaded = PDDocument.loadNonSeq(outFile, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It works fine but opening the encrypted document with PDFBox (last line of above code) throws:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.pdfbox.exceptions.WrappedIOException
	at org.apache.pdfbox.pdmodel.encryption.SecurityHandler.encryptData(SecurityHandler.java:371)
	at org.apache.pdfbox.pdmodel.encryption.SecurityHandler.decryptString(SecurityHandler.java:577)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.decryptString(NonSequentialPDFParser.java:1571)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.decryptDictionary(NonSequentialPDFParser.java:1535)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.decrypt(NonSequentialPDFParser.java:1596)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.parseObjectDynamically(NonSequentialPDFParser.java:1460)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.parseObjectDynamically(NonSequentialPDFParser.java:1343)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.initialParse(NonSequentialPDFParser.java:383)
	at org.apache.pdfbox.pdfparser.NonSequentialPDFParser.parse(NonSequentialPDFParser.java:886)
	at org.apache.pdfbox.pdmodel.PDDocument.loadNonSeq(PDDocument.java:1273)
	at org.apache.pdfbox.pdmodel.PDDocument.loadNonSeq(PDDocument.java:1256)
	at com.remion.bronto.proex.pdf.PDFBoxEncryptionTest.testEncryptDecrypt(PDFBoxEncryptionTest.java:30)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.testng.internal.MethodInvocationHelper.invokeMethod(MethodInvocationHelper.java:84)
	at org.testng.internal.Invoker.invokeMethod(Invoker.java:714)
	at org.testng.internal.Invoker.invokeTestMethod(Invoker.java:901)
	at org.testng.internal.Invoker.invokeTestMethods(Invoker.java:1231)
	at org.testng.internal.TestMethodWorker.invokeTestMethods(TestMethodWorker.java:127)
	at org.testng.internal.TestMethodWorker.run(TestMethodWorker.java:111)
	at org.testng.TestRunner.privateRun(TestRunner.java:767)
	at org.testng.TestRunner.run(TestRunner.java:617)
	at org.testng.SuiteRunner.runTest(SuiteRunner.java:334)
	at org.testng.SuiteRunner.runSequentially(SuiteRunner.java:329)
	at org.testng.SuiteRunner.privateRun(SuiteRunner.java:291)
	at org.testng.SuiteRunner.run(SuiteRunner.java:240)
	at org.testng.SuiteRunnerWorker.runSuite(SuiteRunnerWorker.java:52)
	at org.testng.SuiteRunnerWorker.run(SuiteRunnerWorker.java:86)
	at org.testng.TestNG.runSuitesSequentially(TestNG.java:1224)
	at org.testng.TestNG.runSuitesLocally(TestNG.java:1149)
	at org.testng.TestNG.run(TestNG.java:1057)
	at org.testng.remote.RemoteTestNG.run(RemoteTestNG.java:111)
	at org.testng.remote.RemoteTestNG.initAndRun(RemoteTestNG.java:204)
	at org.testng.remote.RemoteTestNG.main(RemoteTestNG.java:175)
Caused by: javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher
	at com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:750)
	at com.sun.crypto.provider.CipherCore.doFinal(CipherCore.java:676)
	at com.sun.crypto.provider.AESCipher.engineDoFinal(AESCipher.java:313)
	at javax.crypto.Cipher.doFinal(Cipher.java:1970)
	at org.apache.pdfbox.pdmodel.encryption.SecurityHandler.encryptData(SecurityHandler.java:351)
	... 35 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Opening the saved document with Acrobat works fine.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://pdfbox.apache.org/1.8/cookbook/encryption.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pdfbox.apache.org/1.8/cookbook/encryption.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>jdk 1.7.0_55, bouncy castle provider 1.52</environment>
        <key id="12825847">PDFBOX-2781</key>
            <summary>Opening pdf document after encrypting it with PDFBox throws IllegalBlockSizeException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="ssaarinen">Samuli Saarinen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Apr 2015 07:55:28 +0000</created>
                <updated>Thu, 23 Jul 2015 06:35:44 +0000</updated>
                            <resolved>Wed, 29 Apr 2015 19:30:12 +0000</resolved>
                                    <version>1.8.9</version>
                    <version>1.8.10</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.8.10</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Crypto</component>
                    <component>PDModel</component>
                    <component>Writing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14518928" author="ssaarinen" created="Wed, 29 Apr 2015 07:56:59 +0000"  >&lt;p&gt;the PDF file used in the test&lt;/p&gt;</comment>
                            <comment id="14519925" author="jira-bot" created="Wed, 29 Apr 2015 18:47:22 +0000"  >&lt;p&gt;Commit 1676815 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1676815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1676815&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2781&quot; title=&quot;Opening pdf document after encrypting it with PDFBox throws IllegalBlockSizeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2781&quot;&gt;&lt;del&gt;PDFBOX-2781&lt;/del&gt;&lt;/a&gt;: remove / ignore the CF, StmF, and StrF entries if V is not 4 or 5.&lt;/p&gt;</comment>
                            <comment id="14519977" author="jira-bot" created="Wed, 29 Apr 2015 19:10:32 +0000"  >&lt;p&gt;Commit 1676820 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/1.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1676820&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1676820&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2781&quot; title=&quot;Opening pdf document after encrypting it with PDFBox throws IllegalBlockSizeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2781&quot;&gt;&lt;del&gt;PDFBOX-2781&lt;/del&gt;&lt;/a&gt;: remove / ignore the CF, StmF, and StrF entries if V is not 4 or 5.&lt;/p&gt;</comment>
                            <comment id="14520024" author="tilman" created="Wed, 29 Apr 2015 19:30:12 +0000"  >&lt;p&gt;You have encovered two bugs, which have popped up because you re-encrypted a file that was already encrypted, and in a different strength.&lt;/p&gt;

&lt;p&gt;1) You encrypted the file with a non-AES method, but the encryption dictionary keeps old values that point to AES. From the spec about V = 4 or 5:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The security handler defines the use of encryption and decryption in the document, using the rules specified by the CF, StmF, and StrF entries.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It also tells this about the CF, StmF, and StrF entries:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;meaningful only when the value of V is 4 or 5&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;By itself, this is harmless, but not useful. So we need to remove the CF, StmF, and StrF entries if V is not 4 or 5.&lt;/p&gt;

&lt;p&gt;2) The file is then decrypted with AES, despite that it wasn&apos;t encrypted with AES, and this fails. This happens because it finds &quot;AESV2&quot; from the previous encryption. It shouldn&apos;t have looked at that one at all, because your encryption has set V to be 2, so the CF dictionary should have been ignored anyway.&lt;/p&gt;

&lt;p&gt;So we MUST ignore the CF, StmF, and StrF entries if V is not 4 or 5.&lt;/p&gt;</comment>
                            <comment id="14520916" author="ssaarinen" created="Thu, 30 Apr 2015 05:59:11 +0000"  >&lt;p&gt;Thanks for the quick follow up!&lt;/p&gt;

&lt;p&gt;Is it possible to use AES encryption with PDFbox and if so are there any samples/test cases I could take a look? I was not able to find anything on that by browsing the source and tools (Encrypter).&lt;/p&gt;

&lt;p&gt;BTW if I run the same test without setting the encryption settings (comment out doc.protect(spp)) I get NPE at org.apache.pdfbox.pdmodel.encryption.StandardSecurityHandler.computeRevisionNumber(StandardSecurityHandler.java:128)&lt;/p&gt;

&lt;p&gt;Is this expected or should I file another Issue?&lt;/p&gt;

&lt;p&gt;My goal here is to load PDF, fill some form fields and save it with original security settings (if possible).&lt;/p&gt;</comment>
                            <comment id="14520947" author="tilman" created="Thu, 30 Apr 2015 06:20:09 +0000"  >&lt;p&gt;AES encryption with key length other than 256 bits is not supported, and AES256 is supported only in the unreleased 2.0 version that you can get with svn. See the table in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1594&quot; title=&quot;Add support for AES256 Encryption &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1594&quot;&gt;&lt;del&gt;PDFBOX-1594&lt;/del&gt;&lt;/a&gt; for what is supported.&lt;/p&gt;

&lt;p&gt;The NPE you get is because you must set setAllSecurityToBeRemoved(true) first. The next version will have a useful error message instead of an NPE, i.e. that one was fixed recently (&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2769&quot; title=&quot;NPE when saving encrypted file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2769&quot;&gt;&lt;del&gt;PDFBOX-2769&lt;/del&gt;&lt;/a&gt;) but only in 2.0 (I&apos;ll think about that again, now that you mention it, and will see if it can be fixed in 1.8.*).&lt;/p&gt;

&lt;p&gt;You can look at TestSymmetricKeyEncryption.java, this has a lot of testcases.&lt;/p&gt;

&lt;p&gt;Please ask any &quot;how to&quot; questions in the mailing list.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12729091" name="testform_protected.pdf" size="66350" author="ssaarinen" created="Wed, 29 Apr 2015 07:56:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2e2a7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>