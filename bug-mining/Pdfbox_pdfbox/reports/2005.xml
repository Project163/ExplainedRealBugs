<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:07:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4294] Scratch file already closed when redoing overlay</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4294</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;Here&apos;s some sample code to reproduce the problem:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = &lt;span class=&quot;code-quote&quot;&gt;&quot;orig.pdf&quot;&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; stampPath = &lt;span class=&quot;code-quote&quot;&gt;&quot;stamp.pdf&quot;&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PDDocument doc = PDDocument.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(path));
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Overlay o = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Overlay();
o.setInputPDF(doc);
o.setOverlayPosition(Position.FOREGROUND);
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; m = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
m.put(0, stampPath);
PDDocument res = o.overlay(m);
res.close();
res = o.overlay(m);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Basically I&apos;m doing an overlay, closing the resulting document, then doing it again (normally&#160;I would make some changes first, but I didn&apos;t include that for the sake of brevity).&lt;/p&gt;

&lt;p&gt;The last line throws&#160;java.io.IOException: Scratch file already closed&lt;/p&gt;

&lt;p&gt;If I remove &quot;res.close()&quot; then the code works, but if I do the overlay multiple times, I get warnings like:&#160;org.apache.pdfbox.cos.COSDocument - Warning: You did not close a PDF Document&lt;br/&gt;
which suggests that I should actually close the document when I&apos;m done with it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13179923">PDFBOX-4294</key>
            <summary>Scratch file already closed when redoing overlay</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="aditsu">Adrian S&#225;ndor</reporter>
                        <labels>
                            <label>Overlay</label>
                    </labels>
                <created>Mon, 20 Aug 2018 10:20:07 +0000</created>
                <updated>Sat, 10 Nov 2018 13:54:45 +0000</updated>
                                            <version>2.0.11</version>
                                                    <component>Utilities</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16585930" author="aditsu" created="Mon, 20 Aug 2018 13:30:40 +0000"  >&lt;p&gt;One detail I missed initially is that the overlay method actually modifies the input document (if provided via a&#160;PDDocument object). That is not documented, and if it&apos;s intended, then the following code shouldn&apos;t print warnings, yet it does:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = &lt;span class=&quot;code-quote&quot;&gt;&quot;orig.pdf&quot;&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; stampPath = &lt;span class=&quot;code-quote&quot;&gt;&quot;stamp.pdf&quot;&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PDDocument doc = PDDocument.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(path));
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Overlay o = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Overlay();
o.setInputPDF(doc);
o.setOverlayPosition(Position.FOREGROUND);
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; m = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
m.put(1, stampPath);
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; ++i) {
&#160;o.overlay(m);
}
doc.close();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;font color=&quot;#d04437&quot;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Finalizer&amp;#93;&lt;/span&gt; WARN org.apache.pdfbox.cos.COSDocument - Warning: You did not close a PDF Document&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#d04437&quot;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Finalizer&amp;#93;&lt;/span&gt; WARN org.apache.pdfbox.cos.COSDocument - Warning: You did not close a PDF Document&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#d04437&quot;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Finalizer&amp;#93;&lt;/span&gt; WARN org.apache.pdfbox.cos.COSDocument - Warning: You did not close a PDF Document&lt;/font&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16585936" author="aditsu" created="Mon, 20 Aug 2018 13:54:49 +0000"  >&lt;p&gt;In fact, the javadoc for the overlay method says that it returns &quot;the resulting pdf, which has to be saved and closed be the caller&quot;. So the initial code (including &quot;res.close()&quot;) is supposed to work then.&lt;/p&gt;</comment>
                            <comment id="16592549" author="tilman" created="Sat, 25 Aug 2018 11:05:07 +0000"  >&lt;p&gt;What you do (calling &lt;tt&gt;overlay()&lt;/tt&gt; several times) does not really make sense. To avoid the &quot;You did not close a PDF Document&quot; message, you should close the overlay object.&lt;/p&gt;</comment>
                            <comment id="16592554" author="jira-bot" created="Sat, 25 Aug 2018 11:28:18 +0000"  >&lt;p&gt;Commit 1839026 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1839026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1839026&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4294&quot; title=&quot;Scratch file already closed when redoing overlay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4294&quot;&gt;PDFBOX-4294&lt;/a&gt;: clarify javadoc&lt;/p&gt;</comment>
                            <comment id="16592555" author="jira-bot" created="Sat, 25 Aug 2018 11:28:26 +0000"  >&lt;p&gt;Commit 1839027 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1839027&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1839027&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4294&quot; title=&quot;Scratch file already closed when redoing overlay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4294&quot;&gt;PDFBOX-4294&lt;/a&gt;: clarify javadoc&lt;/p&gt;</comment>
                            <comment id="16592556" author="tilman" created="Sat, 25 Aug 2018 11:29:44 +0000"  >&lt;p&gt;So I improved the javadoc based on your input. Did this help, or should more be done?&lt;/p&gt;</comment>
                            <comment id="16592557" author="tilman" created="Sat, 25 Aug 2018 11:30:46 +0000"  >&lt;p&gt;I wonder if I should make&#160;&lt;tt&gt;Overlay&lt;/tt&gt; closeable.&lt;/p&gt;</comment>
                            <comment id="16592838" author="jira-bot" created="Sun, 26 Aug 2018 08:39:09 +0000"  >&lt;p&gt;Commit 1839173 from tilman@apache.org in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1839173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1839173&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4294&quot; title=&quot;Scratch file already closed when redoing overlay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4294&quot;&gt;PDFBOX-4294&lt;/a&gt;: fix html in javadoc&lt;/p&gt;</comment>
                            <comment id="16592839" author="jira-bot" created="Sun, 26 Aug 2018 08:39:17 +0000"  >&lt;p&gt;Commit 1839174 from tilman@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1839174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1839174&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4294&quot; title=&quot;Scratch file already closed when redoing overlay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4294&quot;&gt;PDFBOX-4294&lt;/a&gt;: fix html in javadoc&lt;/p&gt;</comment>
                            <comment id="16592854" author="aditsu" created="Sun, 26 Aug 2018 10:04:01 +0000"  >&lt;p&gt;The javadoc helps, but I&apos;m still generally unsatisfied with the way the class works. It has too much code to manage loading and closing of various documents, and it&apos;s quite clearly made mainly for a particular use case of overlaying all the pages the same way (and only once), with potential&#160;differences for the first/last page and even/odd pages. That&apos;s not how I want to use it.&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;What you do (calling&#160;&lt;tt&gt;overlay()&lt;/tt&gt;&#160;several times) does not really make sense.&lt;/p&gt;

&lt;p&gt;Well, it makes sense for what I want to do, but I had a wrong assumption that I could reuse the original document, while it was in fact modifying it (rather than a copy) in the process. So in order to redo the overlay, I&apos;d have to reload the document every time, which is quite inefficient.&lt;/p&gt;

&lt;p&gt;Fortunately the code is free/open source, so I was able to modify it to work exactly the way I wanted it. I&apos;ll attach the class I came up with (which is very different from an API point of view) in case you&apos;re interested.&lt;/p&gt;</comment>
                            <comment id="16592859" author="aditsu" created="Sun, 26 Aug 2018 10:17:50 +0000"  >&lt;p&gt;Some comments about the MyOverlay class I attached:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the code is&#160;much&#160;shorter and simpler&lt;/li&gt;
	&lt;li&gt;it doesn&apos;t do any loading or closing whatsoever, that is left to the user&lt;/li&gt;
	&lt;li&gt;the input document is attached at construction&lt;/li&gt;
	&lt;li&gt;the main methods to use are:&#160;getLayoutPage,&#160;processPage and&#160;resetDoc;&#160;LayoutPage inner class is public&lt;/li&gt;
	&lt;li&gt;processPage processes only one page at a time, and takes an&#160;AffineTransform argument for full and easy customization&lt;/li&gt;
	&lt;li&gt;overlays can be added in any order, and the document is usable at any point; there is no special handling for &quot;all pages&quot;, first/last/even/odd pages, nor any map of page numbers to file names; the user can just add overlays as they wish&lt;/li&gt;
	&lt;li&gt;resetDoc reverts to the original document without reloading&lt;/li&gt;
	&lt;li&gt;page numbers are 0-based (as they should be)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16596286" author="aditsu" created="Wed, 29 Aug 2018 12:51:58 +0000"  >&lt;p&gt;In the meantime I renamed MyOverlay to OverlayEngine, made a bunch of improvements, and refactored the Overlay class (based on&#160;revision 1839173 in branch 2.0) to make use of it. This will let people use Overlay exactly the same way as before, and give them an additional option to use the more flexible OverlayEngine if they want to.&#160;Feel free to add my code to pdfbox and make any changes you deem necessary.&lt;/p&gt;</comment>
                            <comment id="16596315" author="aditsu" created="Wed, 29 Aug 2018 13:18:34 +0000"  >&lt;p&gt;Maybe LayoutPage should be renamed to OverlayPage or OverlayInfo. And I guess you prefer full words, so resetDoc should probably be resetDocument.&lt;/p&gt;</comment>
                            <comment id="16596669" author="tilman" created="Wed, 29 Aug 2018 18:05:31 +0000"  >&lt;p&gt;I haven&apos;t looked at the new one, but the old one may have a problem because you&apos;re saving the content stream but not the resources, I think these can also change. I&apos;m somewhat reluctant to use your change, because I&apos;d like to keep the API as much as possible (different API mean support calls for us), and I also think it isn&apos;t that terrible to reopen the PDF file.&lt;/p&gt;</comment>
                            <comment id="16596732" author="aditsu" created="Wed, 29 Aug 2018 18:58:10 +0000"  >&lt;p&gt;Ok, I&apos;m not familiar with the internal structure of documents in pdfbox, I only saw the contents being modified.&#160;I looked for any changes to resources now, and I found a&#160;likely modification in only one place - createOverlayXObject. I can try to save/restore the resources too, I&apos;ll probably give you an updated version.&lt;/p&gt;

&lt;p&gt;The main point of my&#160;2nd attachment (overlay.zip) is that I refactored the Overlay class to use my code while keeping&#160;its&#160;own API 100% identical. And the modified Overlay class doesn&apos;t use the &quot;save original&quot; feature. About reopening the PDF, well, I&apos;d like to be able to do as many overlays per second as possible, so every little thing matters.&lt;/p&gt;</comment>
                            <comment id="16596778" author="aditsu" created="Wed, 29 Aug 2018 19:45:58 +0000"  >&lt;p&gt;I added version 2 of my code. Main changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;removed the (optional) auto-saving in constructor, added a save method instead&lt;/li&gt;
	&lt;li&gt;it now saves and restores page resources too&lt;/li&gt;
	&lt;li&gt;did the renames I suggested before; also renamed everything &quot;layout&quot; to &quot;overlay&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16614109" author="aditsu" created="Thu, 13 Sep 2018 22:00:56 +0000"  >&lt;p&gt;Hi, hope you can take a look at it sometime and give your comments. I think I&apos;ve addressed your concerns.&lt;/p&gt;</comment>
                            <comment id="16614420" author="tilman" created="Fri, 14 Sep 2018 06:29:31 +0000"  >&lt;p&gt;Sorry, I didn&apos;t have the time to have a &quot;deep&quot; look into it, I need 1-2 hours of &quot;quiet time&quot; at day time and it&apos;s difficult to find. Btw, could you please resubmit your change by also using the recent changes I did in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4298&quot; title=&quot;NullPointerException when doing overlay&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4298&quot;&gt;&lt;del&gt;PDFBOX-4298&lt;/del&gt;&lt;/a&gt; (see the end of the issue)? Preferably as a patch against the trunk. Do not make any formatting changes. If you can&apos;t then just resubmit the main file.&lt;/p&gt;</comment>
                            <comment id="16625090" author="tilman" created="Sun, 23 Sep 2018 12:20:27 +0000"  >&lt;p&gt;While I like refactoring, the problem with the new code is that it contains both new features and a refactoring. It would be easier to understand if these are separated. Either first submit the new features, or first submit the refactoring.&lt;/p&gt;</comment>
                            <comment id="16628859" author="aditsu" created="Wed, 26 Sep 2018 14:29:19 +0000"  >&lt;p&gt;Thanks for taking a look, sorry it&apos;s my turn to be busy &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I&apos;ll submit a refactoring first, also checking for recent changes, when I find some time (probably in a couple of days).&lt;br/&gt;
Shall we continue in this same bug report?&lt;/p&gt;</comment>
                            <comment id="16629001" author="tilman" created="Wed, 26 Sep 2018 16:17:22 +0000"  >&lt;p&gt;Yes, this is ok, much details have been written here. The only changes made are javadoc related.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12937166" name="MyOverlay.java" size="8592" author="aditsu" created="Sun, 26 Aug 2018 10:04:51 +0000"/>
                            <attachment id="12937678" name="overlay-v2.zip" size="6250" author="aditsu" created="Wed, 29 Aug 2018 19:39:00 +0000"/>
                            <attachment id="12937620" name="overlay.zip" size="6269" author="aditsu" created="Wed, 29 Aug 2018 12:46:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x7pb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>