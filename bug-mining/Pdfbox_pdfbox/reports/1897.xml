<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:06:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4058] High memory consumption when extracting image from PDF file</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4058</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;When rendering an image at 300 dpi from the included PDF, my java process uses a huge amount of memory.&lt;br/&gt;
The document is only 45 Kb in size and contains 2 pages, my JVM is unable to extract even 1 page with 3G of memory. Setting Xmx to 4G works but is not the solution I want.&lt;br/&gt;
The error occurs when calling PDFRenderer.renderImageWithDPI()&lt;/p&gt;

&lt;p&gt;I already tried tweaking the memory usage in my application to use a scratch file while loading the document as well as avoiding caching of XObjects as described here: &lt;a href=&quot;https://pdfbox.apache.org/2.0/faq.html#outofmemoryerror&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/2.0/faq.html#outofmemoryerror&lt;/a&gt;&lt;br/&gt;
These didn&apos;t work.&lt;/p&gt;

&lt;p&gt;The issue can be reproduced using the pdfbox-app utility:&lt;br/&gt;
java -Xmx3G -jar pdfbox-app-2.0.8.jar PDFToImage &lt;br/&gt;
HighMemoryFootprint.pdf -dpi 300 -color RGB -page 1&lt;/p&gt;

&lt;p&gt;What can not be changed?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;300 dpi will not be decreased.&lt;/li&gt;
	&lt;li&gt;Max Java memory will not be increased: 3GB is ridiculous for a 45kb PDF file.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>windows 10 / Linux</environment>
        <key id="13129270">PDFBOX-4058</key>
            <summary>High memory consumption when extracting image from PDF file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="bjorn.misseghers">Bjorn Misseghers</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Mon, 8 Jan 2018 15:19:01 +0000</created>
                <updated>Sat, 24 Mar 2018 09:41:38 +0000</updated>
                            <resolved>Wed, 10 Jan 2018 20:44:02 +0000</resolved>
                                    <version>2.0.5</version>
                    <version>2.0.6</version>
                    <version>2.0.7</version>
                    <version>2.0.8</version>
                                    <fixVersion>2.0.9</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>Rendering</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16316611" author="tilman" created="Mon, 8 Jan 2018 17:16:09 +0000"  >&lt;p&gt;Although that file is so small, it has vector graphics in patterns down 7 levels:&lt;br/&gt;
&lt;tt&gt;Root/Pages/Kids/[0]/Resources/XObject/X44/Resources/Pattern/p5/Resources/XObject/x8/Resources/Pattern/p10/Resources/XObject/x13/Resources/Pattern/p15/Resources/XObject/x19&lt;/tt&gt;&lt;br/&gt;
patterns are temporarly stored in a BufferedImage after rendering, that is probably the cause.&lt;/p&gt;</comment>
                            <comment id="16316624" author="tilman" created="Mon, 8 Jan 2018 17:24:08 +0000"  >&lt;p&gt;I am able to render your file with &lt;/p&gt;

&lt;p&gt;java -Xmx3G -jar pdfbox-app-2.0.8.jar PDFToImage -color RGB -dpi 300 HighMemoryFootprint.pdf&lt;/p&gt;

&lt;p&gt;on jdk9 but not on jdk8.&lt;/p&gt;</comment>
                            <comment id="16316691" author="tilman" created="Mon, 8 Jan 2018 18:05:15 +0000"  >&lt;p&gt;With 2.0.4 it works too. So this is likely connected to &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3688&quot; title=&quot;Cache TilingPaint generation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3688&quot;&gt;&lt;del&gt;PDFBOX-3688&lt;/del&gt;&lt;/a&gt; which introduced a weak cache for tiling patterns to speed things up.&lt;/p&gt;</comment>
                            <comment id="16316744" author="tilman" created="Mon, 8 Jan 2018 18:30:23 +0000"  >&lt;p&gt;If you can build from source, you can disable the tiling cache by commenting this line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
weakCache.put(tilingPaintParameter, paint);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in the &lt;tt&gt;TilingPaintFactory&lt;/tt&gt; class. Then it works with 2700 MB on jdk8, and with 2GB on jdk9.&lt;/p&gt;</comment>
                            <comment id="16320780" author="jira-bot" created="Wed, 10 Jan 2018 18:25:46 +0000"  >&lt;p&gt;Commit 1820768 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1820768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1820768&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4058&quot; title=&quot;High memory consumption when extracting image from PDF file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4058&quot;&gt;&lt;del&gt;PDFBOX-4058&lt;/del&gt;&lt;/a&gt;: additional WeakReference makes gc work better&lt;/p&gt;</comment>
                            <comment id="16320781" author="jira-bot" created="Wed, 10 Jan 2018 18:25:50 +0000"  >&lt;p&gt;Commit 1820769 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1820769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1820769&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4058&quot; title=&quot;High memory consumption when extracting image from PDF file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4058&quot;&gt;&lt;del&gt;PDFBOX-4058&lt;/del&gt;&lt;/a&gt;: additional WeakReference makes gc work better&lt;/p&gt;</comment>
                            <comment id="16320783" author="tilman" created="Wed, 10 Jan 2018 18:26:12 +0000"  >&lt;p&gt;I ran the profiler and the only good news is that the weak cache does work somewhat, i.e. the size of the cache varies depending of tracing. (I noticed that I can render at 300 dpi when saving the paint image file. This suggests that gc works in parallel and the jdk doesn&apos;t wait for it to be done).&lt;/p&gt;

&lt;p&gt;This is confirmed by JDK-4802550: &quot;It is not guaranteed that the garbage collector will always reclaim those objects before an OutOfMemoryError is thrown&quot;.&lt;/p&gt;

&lt;p&gt;I tried caching only patterns with an image below a certain size, but it turned out that this would also slow down rendering the file from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3688&quot; title=&quot;Cache TilingPaint generation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3688&quot;&gt;&lt;del&gt;PDFBOX-3688&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Allowing to disable the cache would be the &quot;desperate&quot; solution but then I found out that adding an additional WeakReference level works too. The WeakHashMap javadoc suggests this too but for a different reason.&lt;/p&gt;</comment>
                            <comment id="16321033" author="tilman" created="Wed, 10 Jan 2018 20:30:47 +0000"  >&lt;p&gt;snapshot available here:&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.9-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.9-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I was able to render the file with -Xmx2700m on jdk8.&lt;/p&gt;</comment>
                            <comment id="16321862" author="tboehme" created="Thu, 11 Jan 2018 08:38:04 +0000"  >&lt;p&gt;I would say that putting the values in weak-references is the correct solution if you look at how WeakHashMap works: only the keys are weak and may be garbage collected at any time but the values are not. The table entries are cleared only if you run a method (get/put/size/...) on the table. Without accessing the table all entries remain (especially the values). Thus in order to allow also the values to be garbage collected if needed it is required to put them into a WeakReference as you have done.&lt;/p&gt;</comment>
                            <comment id="16322037" author="bjorn.misseghers" created="Thu, 11 Jan 2018 10:51:48 +0000"  >&lt;p&gt;First of all many thanks for the quick response! It is highly appreciated.&lt;/p&gt;

&lt;p&gt;Do you have any idea when 2.0.9 will be released? And what about 3.0?&lt;br/&gt;
For now, I duplicated your fix in the 2.0.8 sources and made my own build, which works.&lt;br/&gt;
However, I still can&apos;t get my head around the fact that we need close to 3G to extract what seems a very basic image. Is there maybe a way we can use PDFBox to detect PDF pages with high-memory consuming objects (objects with multiple layers?) without actually having to render them?&lt;/p&gt;</comment>
                            <comment id="16322600" author="tilman" created="Thu, 11 Jan 2018 17:31:34 +0000"  >&lt;p&gt;The 2.0.9 release is planned for some time this month. I&apos;d rather expect the end of the month. If we find regressions then it could take longer. No info about 3.0.&lt;/p&gt;

&lt;p&gt;I understand that you find it upsetting that this seemingly small file has such a huge memory footprint. The patterns images (for the logos) created at 300dpi are so huge. The pattern tile dimensions are larger than the PDF dimensions. To see this, have a look at TilingPaint.getImage() and save the image that is returned at the end of the method. The pattern classes do not have a knowledge of the PDF bounds so they can&apos;t create a smaller one. An alternative would be to render directly on the target image but this isn&apos;t the way it is being done. (I suspect that Adobe Reader does both, depending on the size of the pattern). &lt;/p&gt;

&lt;p&gt;No there isn&apos;t an easy way to find out whether a page has a huge memory footprint.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13043694">PDFBOX-3688</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12905106" name="HighMemoryFootprint.pdf" size="45178" author="bjorn.misseghers" created="Mon, 8 Jan 2018 14:48:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 44 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3on2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>