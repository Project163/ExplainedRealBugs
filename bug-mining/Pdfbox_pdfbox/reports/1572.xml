<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:04:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-3521] FontProvider not thread safe</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-3521</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I understand that PDFBox is not yet thread-safe, however, from reading this comment on a &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3071?focusedCommentId=14982069&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14982069&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;similar ticket&lt;/a&gt;, it seems like the fonts should be thread safe and is something that we want to fix. However, I am experiencing an intermittent  NullPointerException when running multi-threaded unit tests that attempt to read several PDFs at once (see details &lt;a href=&quot;http://stackoverflow.com/questions/39831376/pdfbox-npe-loading-fonts&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Inside FontMapperImpl.java the getProvider and setProvider methods are synchronised:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void setProvider(FontProvider fontProvider)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.fontProvider = fontProvider;
        fontInfoByName = createFontInfoByName(fontProvider.getFontInfo());
    }

    /**
     * Returns the font service provider. Defaults to using FileSystemFontProvider.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; FontProvider getProvider()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fontProvider == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            setProvider(DefaultFontProvider.INSTANCE);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fontProvider;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, the calling code from the findFont() method is not synchronised:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// make sure the font provider is initialized
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fontProvider == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            getProvider();
        }

        &lt;span class=&quot;code-comment&quot;&gt;// first &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to match the PostScript name
&lt;/span&gt;        FontInfo info = getFont(format, postScriptName);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (info != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; info.getFont();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As a result, if multiple threads attempt to access this at once, thread A may be in the setProvider method and have set fontProvider, but still processing the creation of fontInfoByName - so thread B could attempt to access before initialised.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13009236">PDFBOX-3521</key>
            <summary>FontProvider not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="robhinds">rob hinds</reporter>
                        <labels>
                            <label>concurrency</label>
                    </labels>
                <created>Mon, 3 Oct 2016 13:33:29 +0000</created>
                <updated>Sat, 25 Mar 2017 18:13:17 +0000</updated>
                            <resolved>Sat, 8 Oct 2016 18:51:48 +0000</resolved>
                                    <version>2.0.3</version>
                    <version>3.0.0 PDFBox</version>
                                    <fixVersion>2.0.4</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>PDModel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15543005" author="jahewson" created="Mon, 3 Oct 2016 18:02:58 +0000"  >&lt;p&gt;Why would calling code from the findFont() method need to be synchronized? getProvider() is already a synchronized method.&lt;/p&gt;

&lt;p&gt;&amp;gt; still processing the creation of fontInfoByName &lt;/p&gt;

&lt;p&gt;Ok, but what are the implications of this?&lt;/p&gt;</comment>
                            <comment id="15543363" author="robhinds" created="Mon, 3 Oct 2016 20:39:46 +0000"  >&lt;p&gt;The investigation I did was only fairly preliminary, so I may be wrong with my assertions - but the behaviour I saw, was during some unit tests (run by gradle) I was getting a NullPointerException whilst trying to acces fontInfoByName:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARNING: Using fallback font &lt;span class=&quot;code-quote&quot;&gt;&apos;LiberationSans-Bold&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;Arial-BoldItalicMT&apos;&lt;/span&gt;
  java.lang.NullPointerException:
  at org.apache.pdfbox.pdmodel.font.FontMapperImpl.getFont(FontMapperImpl.java:463)
  at org.apache.pdfbox.pdmodel.font.FontMapperImpl.findFont(FontMapperImpl.java:417)
  at org.apache.pdfbox.pdmodel.font.FontMapperImpl.getTrueTypeFont(FontMapperImpl.java:321)
  at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.&amp;lt;init&amp;gt;(PDTrueTypeFont.java:198)
  at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:75)
  at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:123)
  at org.apache.pdfbox.contentstream.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.text.SetFontAndSize.process(SetFontAndSize.java:60)
  at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:815)
  at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:472)
  at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:446)
  ...
Oct 03, 2016 12:21:24 PM org.apache.pdfbox.pdmodel.font.PDTrueTypeFont &amp;lt;init&amp;gt;
WARNING: Using fallback font &lt;span class=&quot;code-quote&quot;&gt;&apos;LiberationSans-Bold&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;Arial-BoldMT&apos;&lt;/span&gt;
Oct 03, 2016 12:21:24 PM org.apache.pdfbox.pdmodel.font.PDTrueTypeFont &amp;lt;init&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it looks like because the checks are for fontProvider are used to determine if the initialisation has been completed, but that can be initialised whilst fontByInfoName is still not initialised (if this is the case, it seems like it could be fixed by changing the order of the setProvider method call so that the fontProvider is initialised last - being as that is what is being used to check if initialisation complete - but there is probably a prettier solution).&lt;/p&gt;</comment>
                            <comment id="15543482" author="tilman" created="Mon, 3 Oct 2016 21:29:00 +0000"  >&lt;p&gt;Makes sense to me. Either change the sequence as you suggest, or have some variable &quot;initializationCompleted&quot; that is set at the end, and checked by the caller.&lt;/p&gt;</comment>
                            <comment id="15544659" author="robhinds" created="Tue, 4 Oct 2016 07:52:37 +0000"  >&lt;p&gt;Cool. If you guys think it&apos;s a sensible fix, I&apos;m happy to implement it and submit a pull request?&lt;/p&gt;</comment>
                            <comment id="15544711" author="tilman" created="Tue, 4 Oct 2016 08:21:03 +0000"  >&lt;p&gt;Lets wait what John is saying. Don&apos;t make pull requests, that repository on github is read only. Just attach a .patch or .diff file with &quot;More&quot;, &quot;attach files&quot;. Be aware that the committed change might still be different than yours.&lt;/p&gt;</comment>
                            <comment id="15558456" author="jahewson" created="Sat, 8 Oct 2016 18:13:31 +0000"  >&lt;p&gt;+1 for changing the sequence&lt;/p&gt;</comment>
                            <comment id="15558516" author="jira-bot" created="Sat, 8 Oct 2016 18:49:49 +0000"  >&lt;p&gt;Commit 1763930 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1763930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1763930&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3521&quot; title=&quot;FontProvider not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3521&quot;&gt;&lt;del&gt;PDFBOX-3521&lt;/del&gt;&lt;/a&gt;: set fontProvider last to avoid concurrency problems, as suggested by Rob Hinds&lt;/p&gt;</comment>
                            <comment id="15558517" author="jira-bot" created="Sat, 8 Oct 2016 18:49:53 +0000"  >&lt;p&gt;Commit 1763931 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1763931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1763931&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3521&quot; title=&quot;FontProvider not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3521&quot;&gt;&lt;del&gt;PDFBOX-3521&lt;/del&gt;&lt;/a&gt;: set fontProvider last to avoid concurrency problems, as suggested by Rob Hinds&lt;/p&gt;</comment>
                            <comment id="15558520" author="tilman" created="Sat, 8 Oct 2016 18:51:49 +0000"  >&lt;p&gt;Setting to resolved. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robhinds&quot; class=&quot;user-hover&quot; rel=&quot;robhinds&quot;&gt;robhinds&lt;/a&gt; thanks for your investigation. Snapshot version to be available on&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox/2.0.4-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox/2.0.4-SNAPSHOT/&lt;/a&gt;&lt;br/&gt;
within hours.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34d3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>