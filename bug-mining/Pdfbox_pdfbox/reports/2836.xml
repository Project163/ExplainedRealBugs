<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:13:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-5681] ConcurrentModificationException in getObjectsByType() in 3.x</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-5681</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&apos;s regression testing turned up this exception when we integrate PDFBox 3.0.0 into Tika:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.util.ConcurrentModificationException
	at java.base/java.util.HashMap$HashIterator.nextNode(HashMap.java:1597)
	at java.base/java.util.HashMap$KeyIterator.next(HashMap.java:1620)
	at org.apache.pdfbox.cos.COSDocument.getObjectsByType(COSDocument.java:254)
	at org.apache.pdfbox.cos.COSDocument.getObjectsByType(COSDocument.java:240)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can replicate this exception consistently on the attached file.&lt;/p&gt;

&lt;p&gt;With this code:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        Path path = Paths.get(&quot;/.../PDFBOX-3714-2.pdf&quot;);
        PDDocument document = Loader.loadPDF(path.toFile());
        List&amp;lt;COSObject&amp;gt; objs = document.getDocument().getObjectsByType(COSName.FILESPEC);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13550232">PDFBOX-5681</key>
            <summary>ConcurrentModificationException in getObjectsByType() in 3.x</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="tallison">Tim Allison</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Sep 2023 14:23:26 +0000</created>
                <updated>Thu, 30 Nov 2023 21:19:24 +0000</updated>
                            <resolved>Sat, 16 Sep 2023 17:41:26 +0000</resolved>
                                    <version>3.0.0 PDFBox</version>
                                    <fixVersion>3.0.1 PDFBox</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17763754" author="tallison@mitre.org" created="Mon, 11 Sep 2023 14:41:32 +0000"  >&lt;p&gt;I initially thought this was a threading issue, but it isn&apos;t.  The exception can be thrown if any modification is made to the underlying collection while the iterator is iterating, even if in the same thread.&lt;/p&gt;

&lt;p&gt;My guess is that the computeIfAbsent call in &lt;tt&gt;getObjectFromPool&lt;/tt&gt; is somehow changing the xRefTable keyset that is being iterated over???&lt;/p&gt;

&lt;p&gt;There may be another iteration + modification on a different collection during the parse.  The triggering object &lt;tt&gt;5 0 R&lt;/tt&gt; requires parsing numerous objects from an xrefstream.&lt;/p&gt;

</comment>
                            <comment id="17763759" author="tallison@mitre.org" created="Mon, 11 Sep 2023 14:51:34 +0000"  >&lt;p&gt;When I run the demo code in PDFBox trunk with logging on, I see this in the log before the new exception.  Further, when running debug in the PDFBox project, I can confirm that the xrefTable is somehow being modified during the iteration of the objects.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;11.09.2023 10:49:07 ERROR cos.COSObject:126 - Can&apos;t dereference COSObject{5, 0}
java.io.IOException: Wrong type of referenced length object COSObject{6, 0}: COSDictionary
	at org.apache.pdfbox.pdfparser.COSParser.getLength(COSParser.java:845) ~[classes/:?]
	at org.apache.pdfbox.pdfparser.COSParser.parseCOSStream(COSParser.java:875) ~[classes/:?]
	at org.apache.pdfbox.pdfparser.COSParser.parseFileObject(COSParser.java:710) ~[classes/:?]
	at org.apache.pdfbox.pdfparser.COSParser.parseObjectDynamically(COSParser.java:631) ~[classes/:?]
	at org.apache.pdfbox.pdfparser.COSParser.dereferenceCOSObject(COSParser.java:586) ~[classes/:?]
	at org.apache.pdfbox.cos.COSObject.getObject(COSObject.java:121) ~[classes/:?]
	at org.apache.pdfbox.cos.COSDocument.getObjectsByType(COSDocument.java:257) ~[classes/:?]
	at org.apache.pdfbox.cos.COSDocument.getObjectsByType(COSDocument.java:240) ~[classes/:?]
	at org.apache.pdfbox.TestConcurrentModification.oneOff(TestConcurrentModification.java:18) ~[test-classes/:?]
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17763826" author="tilman" created="Mon, 11 Sep 2023 17:01:30 +0000"  >&lt;p&gt;Wow, great find!&lt;/p&gt;

&lt;p&gt;I guess this part should be replaced by something that restarts the iteration if any changes are done.&lt;/p&gt;</comment>
                            <comment id="17763995" author="axh" created="Tue, 12 Sep 2023 03:14:34 +0000"  >&lt;p&gt;A quick remedy would be to replace this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (COSObjectKey objectKey : xrefTable.keySet()) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;by&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (COSObjectKey objectKey : List.copyOf(xrefTable.keySet())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;`Set.copyOf(...)` could also be used, but I think in this case, a list might perform better.&lt;/p&gt;</comment>
                            <comment id="17763997" author="tilman" created="Tue, 12 Sep 2023 03:42:37 +0000"  >&lt;p&gt;Yeah something similar was my first thought, but then I thought that this wouldn&apos;t be correct. Wouldn&apos;t we want all the &quot;extras&quot; gathered by the extra parsing?&lt;/p&gt;</comment>
                            <comment id="17764000" author="axh" created="Tue, 12 Sep 2023 03:57:07 +0000"  >&lt;p&gt;You are right. It would fix the crash, but the result might be incorrect.&lt;/p&gt;

&lt;p&gt;I just came up with this, I did a mvn verify and it looks good. I did not check whether/how it affects performance. What do you think?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;COSObject&amp;gt; getObjectsByType(COSName type1, COSName type2)
    {
        List&amp;lt;COSObject&amp;gt; retval = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
        Set&amp;lt;COSObjectKey&amp;gt; processedKeys = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;();
        Set&amp;lt;COSObjectKey&amp;gt; remainingKeys = Set.copyOf(xrefTable.keySet());
        &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (COSObjectKey objectKey : remainingKeys)
            {
                COSObject objectFromPool = getObjectFromPool(objectKey);
                COSBase realObject = objectFromPool.getObject();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( realObject &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSDictionary )
                {
                    COSName dictType = ((COSDictionary) realObject).getCOSName(COSName.TYPE);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (type1.equals(dictType) || (type2 != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; type2.equals(dictType)))
                    {
                        retval.add(objectFromPool);
                    }
                }
            }
            processedKeys.addAll(remainingKeys);
            remainingKeys=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;(xrefTable.keySet());
            remainingKeys.removeAll(processedKeys);
        } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!remainingKeys.isEmpty());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; retval;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17765999" author="jira-bot" created="Sat, 16 Sep 2023 17:35:01 +0000"  >&lt;p&gt;Commit 1912356 from lehmi@apache.org in branch &apos;pdfbox/branches/3.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1912356&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1912356&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5681&quot; title=&quot;ConcurrentModificationException in getObjectsByType() in 3.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5681&quot;&gt;&lt;del&gt;PDFBOX-5681&lt;/del&gt;&lt;/a&gt;: avoid ConcurrentModificationException&lt;/p&gt;</comment>
                            <comment id="17766000" author="jira-bot" created="Sat, 16 Sep 2023 17:35:57 +0000"  >&lt;p&gt;Commit 1912357 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1912357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1912357&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5681&quot; title=&quot;ConcurrentModificationException in getObjectsByType() in 3.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5681&quot;&gt;&lt;del&gt;PDFBOX-5681&lt;/del&gt;&lt;/a&gt;: avoid ConcurrentModificationException&lt;/p&gt;</comment>
                            <comment id="17766003" author="lehmi" created="Sat, 16 Sep 2023 17:41:26 +0000"  >&lt;p&gt;I&apos;ve found a way to avoid the ConcurrentModificationException. The solution ia similar to the proposal of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=axh&quot; class=&quot;user-hover&quot; rel=&quot;axh&quot;&gt;axh&lt;/a&gt;, but not that complex and IMHO easier to understand &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Only two iterations are needed: the first one processes all objects for the cross reference table and the second one processes additional objects which may be added during the first iteration. The second step is only needed if the number of indirect objects was increased during step one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13062806" name="PDFBOX-3714-2.pdf" size="169437" author="tallison" created="Mon, 11 Sep 2023 14:23:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ka6w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>