<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:10:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4997] Incremental update adds certain objects not marked as needing update</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4997</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;&lt;em&gt;This bug causes the eSignature DSS issue &lt;a href=&quot;https://ec.europa.eu/cefdigital/tracker/browse/DSS-2260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DSS-2260&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;If during an incremental update an indirect object containing only a name object is checked for need of writing, it always is added to the objects to write and, therefore, eventually written to the update section.&lt;/p&gt;

&lt;p&gt;For example in the attached document &lt;tt&gt;signed-000.pdf&lt;/tt&gt; each page has a color space resource entry &lt;b&gt;CS1&lt;/b&gt; referring to the indirect object 54 containing only the name object, &lt;b&gt;DeviceGray&lt;/b&gt;. Whenever a page is marked as needing an update, the bug causes object 54 also to be written even if it is not changed at all.&lt;/p&gt;

&lt;p&gt;While this seems like a minor annoyance only, it has serious repercussions: In multi-signature use cases this makes Adobe Reader claim previous signatures to be broken whenever a new signature with visualization is added using PDFBox, see also &lt;a href=&quot;https://ec.europa.eu/cefdigital/tracker/browse/DSS-2260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DSS-2260&lt;/a&gt;.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;The cause of the bug is &lt;tt&gt;org.apache.pdfbox.pdfwriter.COSWriter.addObjectToWrite(COSBase)&lt;/tt&gt; where the following &lt;tt&gt;if&lt;/tt&gt; clause attempts to determine whether the inspected object does not need to be written:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (actual != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; objectKeys.containsKey(actual) 
    &amp;amp;&amp;amp; object &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSUpdateInfo &amp;amp;&amp;amp; !((COSUpdateInfo)object).isNeedToBeUpdated() 
    &amp;amp;&amp;amp; cosBase &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSUpdateInfo &amp;amp;&amp;amp; !((COSUpdateInfo)cosBase).isNeedToBeUpdated() )
{
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here &lt;tt&gt;cosBase&lt;/tt&gt; contains the content of the indirect object, in the case in question the &lt;tt&gt;COSName&lt;/tt&gt; &lt;b&gt;DeviceGray&lt;/b&gt;. As &lt;tt&gt;COSName&lt;/tt&gt; does not implement &lt;tt&gt;COSUpdateInfo&lt;/tt&gt;, the condition never evaluates to &lt;tt&gt;true&lt;/tt&gt;, so the flow never returns here but instead always continues with the following lines where the object is added to the collection of objects to write.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13336294">PDFBOX-4997</key>
            <summary>Incremental update adds certain objects not marked as needing update</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="mkl">Michael Klink</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Oct 2020 13:15:49 +0000</created>
                <updated>Sun, 20 Dec 2020 18:47:58 +0000</updated>
                            <resolved>Tue, 20 Oct 2020 17:59:00 +0000</resolved>
                                    <version>2.0.21</version>
                    <version>3.0.0 PDFBox</version>
                                    <fixVersion>2.0.22</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>Writing</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17217630" author="mkl" created="Tue, 20 Oct 2020 14:27:53 +0000"  >&lt;p&gt;Probably one can fix this by replacing the &lt;tt&gt;if&lt;/tt&gt; clause by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (actual != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; objectKeys.containsKey(actual) 
    &amp;amp;&amp;amp; object &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSUpdateInfo &amp;amp;&amp;amp; !((COSUpdateInfo)object).isNeedToBeUpdated() 
    &amp;amp;&amp;amp; !(cosBase &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSUpdateInfo &amp;amp;&amp;amp; ((COSUpdateInfo)cosBase).isNeedToBeUpdated()) )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This change assumes that an object not implementing &lt;tt&gt;COSUpdateInfo&lt;/tt&gt; cannot have its internal state updated and, therefore, has an implicit &lt;tt&gt;isNeedToBeUpdated&lt;/tt&gt; value of &lt;tt&gt;false&lt;/tt&gt;.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;As an aside, the issue is not limited to indirect objects containing a name object, other object classes not implementing &lt;tt&gt;COSUpdateInfo&lt;/tt&gt; also are affected, in particular number and string classes.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;As yet another aside, while debugging I found more code with a &lt;em&gt;suspicious smell&lt;/em&gt;, in &lt;tt&gt;org.apache.pdfbox.pdfwriter.COSWriter&lt;/tt&gt;; in &lt;tt&gt;prepareIncrement(PDDocument)&lt;/tt&gt; two maps are filled, one mapping object references to objects and the other vice versa:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (object != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; cosObjectKey!= &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !(object &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSNumber))
{
    objectKeys.put(object, cosObjectKey);
    keyObject.put(cosObjectKey,object);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If some code assumes those two maps are inverse, that code may fail in case of objects that are &lt;tt&gt;COSName&lt;/tt&gt; instances: &lt;tt&gt;COSName&lt;/tt&gt; enforces a value object nature, you get the same instance for the same name. Thus, in case of multiple indirect objects containing only the same name the map &lt;tt&gt;objectKeys&lt;/tt&gt; has fewer entries than &lt;tt&gt;keyObject&lt;/tt&gt; and, therefore, is not the inverse.&lt;/p&gt;

&lt;p&gt;Apparently a similar issue for &lt;tt&gt;COSNumber&lt;/tt&gt; objects had already been recognized and was fixed by ignoring them.&lt;/p&gt;

&lt;p&gt;Even worse, recently there have been attempts to make &lt;tt&gt;equals&lt;/tt&gt; and &lt;tt&gt;hashcode&lt;/tt&gt; consider dictionaries and arrays equal if they have equal entries. Thus, even for them the two maps above are not necessarily inverse to each other anymore.&lt;/p&gt;</comment>
                            <comment id="17217659" author="jira-bot" created="Tue, 20 Oct 2020 15:08:32 +0000"  >&lt;p&gt;Commit 1882702 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882702&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4997&quot; title=&quot;Incremental update adds certain objects not marked as needing update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4997&quot;&gt;&lt;del&gt;PDFBOX-4997&lt;/del&gt;&lt;/a&gt;: treat non-COSUpdateInfo objects as isNeedToBeUpdated == false, as suggested by Michael Klink&lt;/p&gt;</comment>
                            <comment id="17217660" author="jira-bot" created="Tue, 20 Oct 2020 15:08:35 +0000"  >&lt;p&gt;Commit 1882703 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882703&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882703&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4997&quot; title=&quot;Incremental update adds certain objects not marked as needing update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4997&quot;&gt;&lt;del&gt;PDFBOX-4997&lt;/del&gt;&lt;/a&gt;: treat non-COSUpdateInfo objects as isNeedToBeUpdated == false, as suggested by Michael Klink&lt;/p&gt;</comment>
                            <comment id="17217700" author="tilman" created="Tue, 20 Oct 2020 15:51:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danielg%40comda.co.il&quot; class=&quot;user-hover&quot; rel=&quot;danielg@comda.co.il&quot;&gt;danielg@comda.co.il&lt;/a&gt; snapshot here:&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.22-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox-app/2.0.22-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkl&quot; class=&quot;user-hover&quot; rel=&quot;mkl&quot;&gt;mkl&lt;/a&gt; thanks for analyzing and fixing this. &lt;br/&gt;
I wonder how the problem you mention could appear, or why it didn&apos;t. Maybe PDFs with the same COSName as different objects?&lt;/p&gt;</comment>
                            <comment id="17217707" author="tilman" created="Tue, 20 Oct 2020 15:52:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcom1981%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;marcom1981@gmail.com&quot;&gt;marcom1981@gmail.com&lt;/a&gt; please run your tests and reopen this issue if we broke something.&lt;/p&gt;</comment>
                            <comment id="17217738" author="mkl" created="Tue, 20 Oct 2020 16:31:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;thanks for analyzing and fixing this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I hope the proposed fix does work as desired in general.&lt;/p&gt;

&lt;p&gt;In my test &lt;tt&gt;testSignSigned000&lt;/tt&gt; in &lt;a href=&quot;https://github.com/mkl-public/testarea-pdfbox2/blob/master/src/test/java/mkl/testarea/pdfbox2/sign/CreateSignature.java#L751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CreateSignature&lt;/a&gt; the fix does work properly (object 54 is not copied unnecessarily to the incremental update anymore and nothing else goes wrong), but I cannot claim to know the whole saving apparatus of PDFBox well enough to preclude unwanted side effects.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I wonder how the problem you mention could appear, or why it didn&apos;t. Maybe PDFs with the same COSName as different objects?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I assume the questionable situations are too seldom or the effects are too diffuse to be ascribed to the incremental update mechanism.&lt;/p&gt;

&lt;p&gt;If I had too much time to spare, I&apos;d try too construct an example file visualizing the effect (or fail doing so if the smell turned out to be a mere phantom smell), but I&apos;m afraid there is too much else to do...&lt;/p&gt;</comment>
                            <comment id="17217829" author="jira-bot" created="Tue, 20 Oct 2020 17:56:06 +0000"  >&lt;p&gt;Commit 1882711 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882711&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4997&quot; title=&quot;Incremental update adds certain objects not marked as needing update&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4997&quot;&gt;&lt;del&gt;PDFBOX-4997&lt;/del&gt;&lt;/a&gt;: summerize warning from Michael Klink as a comment&lt;/p&gt;</comment>
                            <comment id="17217832" author="tilman" created="Tue, 20 Oct 2020 17:59:00 +0000"  >&lt;p&gt;I&apos;ve summarized your text as a comment in the hope that it will warn us the next time we get some really weird problems. Thanks again.&lt;/p&gt;</comment>
                            <comment id="17220796" author="marcom1981@gmail.com" created="Mon, 26 Oct 2020 16:23:39 +0000"  >&lt;p&gt;Thanks, let&apos;s try to do the test in the week.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13336134">PDFBOX-4995</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13013872" name="signed-000.pdf" size="52167" author="mkl" created="Tue, 20 Oct 2020 11:08:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jukg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>