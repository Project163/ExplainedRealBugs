<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:53:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-1445] /ImageMask true does not work. Patch included.</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-1445</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I have the following pdf...&lt;/p&gt;

&lt;p&gt;10 0 obj&lt;br/&gt;
&amp;lt;&amp;lt; &lt;br/&gt;
/Type /Page &lt;br/&gt;
/MediaBox [ 0 0 612.0 792.0 ] &lt;br/&gt;
/Parent 3 0 R &lt;br/&gt;
/Resources &amp;lt;&amp;lt; /XObject &amp;lt;&amp;lt; /Obj4 4 0 R /Obj5 5 0 R /Obj6 6 0 R /Obj7 7 0 R &amp;gt;&amp;gt; /ProcSet [ /PDF /Text /ImageB /ImageC /ImageI ] &amp;gt;&amp;gt; &lt;br/&gt;
/Contents [ 8 0 R 9 0 R ] &lt;br/&gt;
&amp;gt;&amp;gt; &lt;br/&gt;
endobj&lt;/p&gt;

&lt;p&gt;Which then draws 4 images. The first one is a &quot;base&quot; and then rest are image masks&lt;/p&gt;

&lt;p&gt;9 0 obj&lt;br/&gt;
&amp;lt;&amp;lt; /Filter /FlateDecode /Length 121 &amp;gt;&amp;gt; &lt;br/&gt;
stream&lt;br/&gt;
q&lt;br/&gt;
612.00 0 0 792.00 0.00 0.00 cm&lt;br/&gt;
/Obj4 Do&lt;br/&gt;
Q&lt;br/&gt;
q&lt;br/&gt;
0.129 g&lt;br/&gt;
524.16 0 0 556.80 48.00 127.68 cm&lt;br/&gt;
/Obj5 Do&lt;br/&gt;
Q&lt;br/&gt;
q&lt;br/&gt;
0.302 g&lt;br/&gt;
220.80 0 0 398.40 48.00 286.08 cm&lt;br/&gt;
/Obj6 Do&lt;br/&gt;
Q&lt;br/&gt;
q&lt;br/&gt;
0.204 g&lt;br/&gt;
524.16 0 0 469.44 48.00 185.28 cm&lt;br/&gt;
/Obj7 Do&lt;br/&gt;
Q&lt;br/&gt;
endstream&lt;br/&gt;
endobj&lt;/p&gt;


&lt;p&gt;4 0 obj&lt;br/&gt;
&amp;lt;&amp;lt; /Type /XObject /Subtype /Image /Width 1275 /Height 1650 /BitsPerComponent 8 &lt;br/&gt;
/ColorSpace /DeviceGray /Filter [ /FlateDecode /DCTDecode ] /Length 50485 &amp;gt;&amp;gt; &lt;br/&gt;
stream&lt;br/&gt;
endstream&lt;br/&gt;
endobj&lt;/p&gt;


&lt;p&gt;5 0 obj&lt;br/&gt;
&amp;lt;&amp;lt; /Type /XObject /Subtype /Image /Width 2184 /Height 2320 /BitsPerComponent 1 &lt;br/&gt;
/ImageMask true /Filter /CCITTFaxDecode /DecodeParms &amp;lt;&amp;lt; /K -1 /Columns 2184 &amp;gt;&amp;gt; &lt;br/&gt;
/Length 15580 &amp;gt;&amp;gt; &lt;br/&gt;
stream&lt;/p&gt;


&lt;p&gt;etc ...&lt;/p&gt;


&lt;p&gt;The current code simply treats the imagemask as an image. Since this is just a 1 bit image it has no Alpha channel it overwrites the existing image and we simply get the last image drawn.&lt;/p&gt;

&lt;p&gt;In&lt;/p&gt;

&lt;p&gt;org.apache.pdfbox.util.operator.pagedrawer.Invoke.java&lt;/p&gt;

&lt;p&gt;method&lt;/p&gt;

&lt;p&gt;public void process(PDFOperator operator, List&amp;lt;COSBase&amp;gt; arguments) throws IOException&lt;/p&gt;

&lt;p&gt;after &lt;/p&gt;

&lt;p&gt;if (awtImage == null) &lt;/p&gt;
                {
                    LOG.warn(&quot;getRGBImage returned NULL&quot;);
                    return;//TODO PKOCH
                }

&lt;p&gt;If you add the following code it fixes the problem. I can not provide the sample doc due to privacy reasons. &lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Spec 8.9.6.2&lt;/li&gt;
	&lt;li&gt;If ImageMask is true then the image is one bit. Black means draw the current colour and white means use the colour on the current image (ie Mask).&lt;/li&gt;
	&lt;li&gt;Convert the map to an image with an Alpha channel so we can lay it on top&lt;br/&gt;
                 */&lt;br/&gt;
                if(image.getImageMask())&lt;br/&gt;
                {&lt;br/&gt;
                	Color currentColour = drawer.getGraphicsState().getStrokingColor().getJavaColor();&lt;br/&gt;
                	final int onColour = 0xff000000 | currentColour.getRGB();&lt;br/&gt;
                	BufferedImage bia = new BufferedImage(awtImage.getWidth(),awtImage.getHeight(),BufferedImage.TYPE_INT_ARGB);&lt;br/&gt;
                	for(int y=0;y&amp;lt;awtImage.getHeight();y++)
                	&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {                		for(int x=0;x&amp;lt;awtImage.getWidth();x++)                		{
                			bia.setRGB(x, y, (awtImage.getRGB(x, y) &amp;amp; 0x00ffffff) == 0xffffff ? 0x00ffffff : onColour);
                		}                	}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;                	awtImage = bia;&lt;br/&gt;
                }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





</description>
                <environment></environment>
        <key id="12615895">PDFBOX-1445</key>
            <summary>/ImageMask true does not work. Patch included.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="dave.smith">Dave Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Nov 2012 13:49:10 +0000</created>
                <updated>Sat, 23 Mar 2013 12:56:12 +0000</updated>
                            <resolved>Sun, 18 Nov 2012 14:20:50 +0000</resolved>
                                                    <fixVersion>1.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13496354" author="lehmi" created="Tue, 13 Nov 2012 17:27:08 +0000"  >&lt;p&gt;Can&apos;t we just use the code which already exists in PDPixelMap (starting at line 369)? It should be faster.&lt;/p&gt;

&lt;p&gt;P.S.: Please attach patches as diff to make it easier for us the apply them&lt;/p&gt;</comment>
                            <comment id="13496369" author="dave.smith" created="Tue, 13 Nov 2012 17:59:02 +0000"  >&lt;p&gt;Nope. We only have one ImageMask and the current state of the drawn images. PDPixelMap assumes you have an image and a image mask. What I am doing is converting an ImageMask to an image that we can write on top to the current image&lt;/p&gt;

&lt;p&gt;I will figure out how eclipse generates patches and go from there. Unfortunately  there is other debug code I have in there so it is not so easy .....&lt;/p&gt;</comment>
                            <comment id="13496376" author="lehmi" created="Tue, 13 Nov 2012 18:05:56 +0000"  >&lt;p&gt;PDPixelMap combines 2 images if it contains a soft mask (SMask == true). If it is an image mask it will be used to create a mask using the nonstroking color and the 1-pixel map.&lt;/p&gt;</comment>
                            <comment id="13496380" author="dave.smith" created="Tue, 13 Nov 2012 18:19:35 +0000"  >&lt;p&gt;I see it now. BUT .. In my case I have an /ImageMask that is type PDCcitt and a /Mask that is a JBIG2 and they do not go through the PDPixelMap code...&lt;/p&gt;</comment>
                            <comment id="13496387" author="lehmi" created="Tue, 13 Nov 2012 18:26:41 +0000"  >&lt;p&gt;The idea is to replace your code with the code from PDPixelMap and remove the code from PDPIxelMap. So that the ImageMask stuff will be used with all kind of PDXObjectImages (PixelMap, Ccitt and Jpeg). WDYT&lt;/p&gt;</comment>
                            <comment id="13496630" author="dave.smith" created="Tue, 13 Nov 2012 22:43:09 +0000"  >&lt;p&gt;These move the /ImageMask and /Mask code to the base PDXObjectImage class &lt;/p&gt;

&lt;p&gt;Each class that extends the PDXObjectImage simply call applyMask at the end. &lt;/p&gt;
</comment>
                            <comment id="13496633" author="dave.smith" created="Tue, 13 Nov 2012 22:44:51 +0000"  >&lt;p&gt;I have included fixed for both /ImageMask and /Mask . The latter was not being handled at all. I have samples for both but I need the ttps://issues.apache.org/jira/browse/PDFBOX-1067 applied to test the /Mask case...&lt;/p&gt;</comment>
                            <comment id="13499808" author="lehmi" created="Sun, 18 Nov 2012 14:20:50 +0000"  >&lt;p&gt;I applied the patch in revision 1410890 as proposed.&lt;/p&gt;

&lt;p&gt;Thanks for the contribution&lt;/p&gt;</comment>
                            <comment id="13527497" author="lehmi" created="Sun, 9 Dec 2012 15:04:50 +0000"  >&lt;p&gt;Revision 1410890 introduced a regression. PDJpeg#write2OutputStream no longer writes the image due to a null reference.&lt;/p&gt;

&lt;p&gt;I fixed that in revision 1419000.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12553394" name="PDCcitt.java.patch" size="2045" author="dave.smith" created="Tue, 13 Nov 2012 22:43:09 +0000"/>
                            <attachment id="12553393" name="PDJpeg.java.patch" size="1094" author="dave.smith" created="Tue, 13 Nov 2012 22:43:09 +0000"/>
                            <attachment id="12553391" name="PDPixelMap.java.patch" size="3357" author="dave.smith" created="Tue, 13 Nov 2012 22:43:09 +0000"/>
                            <attachment id="12553392" name="PDXObjectImage.java.patch" size="3594" author="dave.smith" created="Tue, 13 Nov 2012 22:43:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>257374</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0jy73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114472</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>