<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:13:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-5486] &quot;RandomAccessBuffer already closed&quot; when opening smaller fonts</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-5486</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I wonder if this is related to one of the memory management / inputstream changes, PDTrueTypeFont.load() can&apos;t load smaller ttf fonts (I discovered this while working with the font from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5484&quot; title=&quot;PDFRenderer does not render letters when converting page to image&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5484&quot;&gt;&lt;del&gt;PDFBOX-5484&lt;/del&gt;&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        File fontDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;C:/windows/fonts&quot;&lt;/span&gt;);
        File[] files = fontDir.listFiles((File dir, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) -&amp;gt; name.toLowerCase().endsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;.ttf&quot;&lt;/span&gt;));
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (File file : files)
        {
            PDDocument doc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument();
            PDTrueTypeFont ttf = PDTrueTypeFont.load(doc, file, WinAnsiEncoding.INSTANCE);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ttf.hasGlyph(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;))
            {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                {
                    ttf.getPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ex)
                {
                    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;font &quot;&lt;/span&gt; + ttf.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; failed, size: &quot;&lt;/span&gt; + file.length() +
                            &lt;span class=&quot;code-quote&quot;&gt;&quot;, glyphs: &quot;&lt;/span&gt; + ttf.getTrueTypeFont().getNumberOfGlyphs() + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + ex.getMessage());
                    ex.printStackTrace();
                }
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;font BookAntiqua-Bold failed, size: 151000, glyphs: 669: RandomAccessBuffer already closed
java.io.IOException: RandomAccessBuffer already closed
    at org.apache.pdfbox.io.RandomAccessReadBuffer.checkClosed(RandomAccessReadBuffer.java:337)
    at org.apache.pdfbox.io.RandomAccessReadBuffer.getPosition(RandomAccessReadBuffer.java:188)
    at org.apache.fontbox.ttf.RandomAccessReadDataStream.getCurrentPosition(RandomAccessReadDataStream.java:80)
    at org.apache.fontbox.ttf.GlyphTable.getGlyph(GlyphTable.java:135)
    at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.getPath(PDTrueTypeFont.java:498) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It does not happen with larger fonts, e.g. Arial.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13475207">PDFBOX-5486</key>
            <summary>&quot;RandomAccessBuffer already closed&quot; when opening smaller fonts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="tilman">Tilman Hausherr</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Aug 2022 17:02:42 +0000</created>
                <updated>Fri, 18 Aug 2023 05:46:10 +0000</updated>
                            <resolved>Fri, 21 Oct 2022 05:46:55 +0000</resolved>
                                    <version>3.0.0 PDFBox</version>
                                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>FontBox</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17575591" author="lehmi" created="Fri, 5 Aug 2022 05:51:43 +0000"  >&lt;p&gt;I&apos;m pretty sure it is related. I&apos;m going to have a look&lt;/p&gt;</comment>
                            <comment id="17575908" author="tilman" created="Fri, 5 Aug 2022 15:28:53 +0000"  >&lt;p&gt;it turns out that our included font has the problem too and this would improve our code coverage:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PDDocument doc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument();
PDTrueTypeFont ttf = PDTrueTypeFont.load(doc, PDFontTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;/org/apache/pdfbox/resources/ttf/LiberationSans-Regular.ttf&quot;&lt;/span&gt;), WinAnsiEncoding.INSTANCE);
ttf.getPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;);
doc.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17576228" author="jira-bot" created="Sat, 6 Aug 2022 13:59:14 +0000"  >&lt;p&gt;Commit 1903254 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1903254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1903254&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5486&quot; title=&quot;&amp;quot;RandomAccessBuffer already closed&amp;quot; when opening smaller fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5486&quot;&gt;&lt;del&gt;PDFBOX-5486&lt;/del&gt;&lt;/a&gt;: cache the data fro the glyph table so that the font data stream can be closed if it is no longer needed&lt;/p&gt;</comment>
                            <comment id="17576230" author="jira-bot" created="Sat, 6 Aug 2022 14:03:00 +0000"  >&lt;p&gt;Commit 1903255 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1903255&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1903255&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5486&quot; title=&quot;&amp;quot;RandomAccessBuffer already closed&amp;quot; when opening smaller fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5486&quot;&gt;&lt;del&gt;PDFBOX-5486&lt;/del&gt;&lt;/a&gt;: add test as proposed by Tilman&lt;/p&gt;</comment>
                            <comment id="17576238" author="lehmi" created="Sat, 6 Aug 2022 14:14:16 +0000"  >&lt;p&gt;I&apos;ve found the root cause and fixed it. The interesting part was the question why it happens with some fonts but aren&apos;t affected. It wasn&apos;t a question of size. Those big fonts don&apos;t support ps-names in the post table so that getPath(&quot;A&quot;) returns an empty GeneralPath and the problematic code isn&apos;t triggered at all.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; thanks for your analysis and the valuable input. I&apos;ve added your test with some minor changes&lt;/p&gt;</comment>
                            <comment id="17576250" author="tilman" created="Sat, 6 Aug 2022 15:18:07 +0000"  >&lt;p&gt;I noticed the comment &quot;we don&apos;t actually read the complete table here because it can contain tens of thousands of glyphs&quot; but now we do keep the entire table, isn&apos;t it? That&apos;s 22410874 bytes for arialuni.ttf .&lt;/p&gt;</comment>
                            <comment id="17576372" author="lehmi" created="Sun, 7 Aug 2022 12:25:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; That is still correct. The origin idea of the on demand parsing of glyph data was to minimize the time to load huge external fonts if just some of the glyphs are needed for rendering, see &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2303&quot; title=&quot;Lazy loading of glyphs in TrueType fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2303&quot;&gt;&lt;del&gt;PDFBOX-2303&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;PDFBox 2.0.x doesn&apos;t close true type fonts until the corresponding pdf document is closed or the finalizer closes them. Furthermore some external fonts are cached and PDFBox keeps them open until the JVM is terminated. Some of the font data is copied to ScratchFileBuffers and depending on the configuration ends up in the memory.&lt;/p&gt;

&lt;p&gt;In the current trunk some of the caches are removed and the font data is copied to memory before parsing it. In many cases the input data of the parser is closed after parsing it so that the memory is released. Just the data for the glyph data is chached in memory so that the on demand creation of the glyphs still works.&lt;/p&gt;

&lt;p&gt;True type fonts keep the origin data of the font if they are embedded and aren&apos;t closed until the corresponding pdf is closed. The font embedding code needs the origin data. That is on my TODO list for 4.0.x or later as well. &lt;/p&gt;

&lt;p&gt;Some parts of the code have concurrent caching mechanisms and those doesn&apos;t complement one another but may be sometimes counterproductive. At least the code is hard to maintain.&lt;/p&gt;

&lt;p&gt;I guess everybody knows my opinion about that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Let us remove such constructs, simplify and see where it ends. If there is really need for some caching we might reimplement something new which suits better to the structures we have. It is not a new and of course not my finding that every now or then a refactoring is a good idea needed to break up old structures.&lt;/p&gt;</comment>
                            <comment id="17576373" author="jira-bot" created="Sun, 7 Aug 2022 12:29:48 +0000"  >&lt;p&gt;Commit 1903270 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1903270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1903270&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5486&quot; title=&quot;&amp;quot;RandomAccessBuffer already closed&amp;quot; when opening smaller fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5486&quot;&gt;&lt;del&gt;PDFBOX-5486&lt;/del&gt;&lt;/a&gt;: close embedded true type font after parsing&lt;/p&gt;</comment>
                            <comment id="17621498" author="lehmi" created="Fri, 21 Oct 2022 05:46:55 +0000"  >&lt;p&gt;Let us see how this ends up. It should be easier to implement some improvements if needed after simplifying the code. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17heo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>