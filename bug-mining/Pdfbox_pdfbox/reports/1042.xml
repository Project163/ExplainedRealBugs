<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:59:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2739] Saving merged documents causes IOException</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2739</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;When some documents are used within a merge, it is not more possible to save the resulting PDDocument, calling method  PDDocument.save() throws &quot;java.io.IOException: COSStream has been closed and cannot be read. Perhaps its enclosing PDDocument has been closed?&quot;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.io.IOException: COSStream has been closed and cannot be read. Perhaps its enclosing PDDocument has been closed?
	at org.apache.pdfbox.cos.COSStream.getFilteredStream(COSStream.java:163)
	at org.apache.pdfbox.pdfwriter.COSWriter.visitFromStream(COSWriter.java:1147)
	at org.apache.pdfbox.cos.COSStream.accept(COSStream.java:280)
	at org.apache.pdfbox.cos.COSObject.accept(COSObject.java:158)
	at org.apache.pdfbox.pdfwriter.COSWriter.doWriteObject(COSWriter.java:538)
	at org.apache.pdfbox.pdfwriter.COSWriter.doWriteBody(COSWriter.java:450)
	at org.apache.pdfbox.pdfwriter.COSWriter.visitFromDocument(COSWriter.java:1031)
	at org.apache.pdfbox.cos.COSDocument.accept(COSDocument.java:464)
	at org.apache.pdfbox.pdfwriter.COSWriter.write(COSWriter.java:1307)
	at org.apache.pdfbox.pdfwriter.COSWriter.write(COSWriter.java:1215)
	at org.apache.pdfbox.pdmodel.PDDocument.save(PDDocument.java:944)
	at ch.ge.afc.ael.commun.piecejointe.Test.main(Test.java:37)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For instance, problem occures with testPopupAnnotation.pdf when I try to merge it to testPDF.pdf  (see  &lt;a href=&quot;http://svn.apache.org/repos/asf/tika/trunk/tika-parsers/src/test/resources/test-documents/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/tika/trunk/tika-parsers/src/test/resources/test-documents/&lt;/a&gt;  for these 2 documents)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Test.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
	File dir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;D:/temp/b&quot;&lt;/span&gt;);

	PDFMergerUtility pdfMerge = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFMergerUtility();
	PDDocument targetDocument = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument();


	PDFParser ns = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFParser(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;testPDF.pdf&quot;&lt;/span&gt;));
	ns.parse();
	PDDocument pddDocument1 = ns.getPDDocument();
	pdfMerge.appendDocument(targetDocument, pddDocument1);
	pddDocument1.close();

	ns = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFParser(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;testPopupAnnotation.pdf&quot;&lt;/span&gt;));
	ns.parse();
	PDDocument pddDocument2 = ns.getPDDocument();
	pdfMerge.appendDocument(targetDocument, pddDocument2);
	pddDocument2.close();

	pdfMerge.mergeDocuments();

	FileOutputStream fout = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;targetDocument.pdf&quot;&lt;/span&gt;));
	targetDocument.save(fout);

}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</description>
                <environment>windows 7</environment>
        <key id="12787281">PDFBOX-2739</key>
            <summary>Saving merged documents causes IOException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="jgi74">jerome girardini</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Apr 2015 07:30:59 +0000</created>
                <updated>Thu, 17 Mar 2016 19:06:43 +0000</updated>
                            <resolved>Wed, 1 Apr 2015 16:36:39 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Writing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14390240" author="msahyoun" created="Wed, 1 Apr 2015 08:48:07 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;the reason is that you are closing pddDocument1 before the target document has been saved. In addition the code could be simplified doing&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        PDFMergerUtility merger = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFMergerUtility();
        merger.addSource(&lt;span class=&quot;code-quote&quot;&gt;&quot;testPDF.pdf&quot;&lt;/span&gt;);
        merger.addSource(&lt;span class=&quot;code-quote&quot;&gt;&quot;testPopupAnnotation.pdf&quot;&lt;/span&gt;);
        merger.setDestinationFileName(&lt;span class=&quot;code-quote&quot;&gt;&quot;targetDocument.pdf&quot;&lt;/span&gt;);
        merger.mergeDocuments();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this way merger will handle the closing of the source documents for you.&lt;/p&gt;
</comment>
                            <comment id="14390241" author="tilman" created="Wed, 1 Apr 2015 08:51:18 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Perhaps its enclosing PDDocument has been closed?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Please try again without prematurely closing the documents, i.e. close them after mergeDocuments().&lt;/p&gt;</comment>
                            <comment id="14390356" author="jgi74" created="Wed, 1 Apr 2015 10:34:00 +0000"  >&lt;p&gt;Maruan Sahyoun : thank you for the tip, doing your way works, but unfortunatelly in my real application I don&apos;t have physical files, I can&apos;t use addSource.&lt;/p&gt;

&lt;p&gt;Tilman Hausherr : I followed your recommandation, indeed when I close pddDocument2  after the save operation, it works.&lt;/p&gt;

&lt;p&gt;When I do the operations in this order, it works -&amp;gt; &lt;br/&gt;
pdfMerge.appendDocument(targetDocument, pddDocument1);&lt;br/&gt;
pdfMerge.appendDocument(targetDocument, pddDocument2);&lt;br/&gt;
pdfMerge.mergeDocuments();&lt;br/&gt;
targetDocument.save(fout);&lt;br/&gt;
pddDocument1.close();&lt;br/&gt;
pddDocument2.close();&lt;/p&gt;


&lt;p&gt;Now I have a workaround I will change my code to close my documents after the save operation (but I have a lot of documents to merge so I&apos;m not sure It&apos;s the best way to preserve memory usage)&lt;/p&gt;

&lt;p&gt;What&apos;s strange in this behavior is, firstly closing the files before merge is not a problem when I use pdfBox 1.8.8, &lt;br/&gt;
and secondly even with version 2.0.0 it&apos;s not a problem for most of pdf files, I merge about 50 differents pdf files for tests purposes, and only two of them are causing the current issue.&lt;/p&gt;
</comment>
                            <comment id="14390362" author="msahyoun" created="Wed, 1 Apr 2015 10:42:44 +0000"  >&lt;p&gt;you could use &lt;tt&gt;addSource(InputStream source)&lt;/tt&gt; to pass a ByteArrayInputStream and &lt;tt&gt;setDestinationStream(OutputStream destStream)&lt;/tt&gt; to write to a ByteArrayOutputStream&lt;/p&gt;

&lt;p&gt;see &lt;a href=&quot;https://pdfbox.apache.org/docs/2.0.0-SNAPSHOT/javadocs/org/apache/pdfbox/multipdf/PDFMergerUtility.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/docs/2.0.0-SNAPSHOT/javadocs/org/apache/pdfbox/multipdf/PDFMergerUtility.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14390370" author="tilman" created="Wed, 1 Apr 2015 10:51:31 +0000"  >&lt;p&gt;The 2.0 version is doing better clean-up of unused resources, that is why. I&apos;d have some doubt about whether the &quot;successfully&quot; merged files are OK with your previous method. I&apos;ll add an error msg later.&lt;/p&gt;

&lt;p&gt;mergeDocuments() calls appendDocument(), so it isn&apos;t needed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14390483" author="jgi74" created="Wed, 1 Apr 2015 12:32:56 +0000"  >&lt;p&gt;Ok now I understand why 2.0.0 is complaining, even if it&apos;s worked well with 1.8, the way I was doing it was not really what is expected. Sorry for the inconvenience, my thanks to both of you for your expertise.&lt;/p&gt;</comment>
                            <comment id="14390947" author="jira-bot" created="Wed, 1 Apr 2015 16:36:24 +0000"  >&lt;p&gt;Commit 1670722 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1670722&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1670722&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2739&quot; title=&quot;Saving merged documents causes IOException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2739&quot;&gt;&lt;del&gt;PDFBOX-2739&lt;/del&gt;&lt;/a&gt;: throw exception if document closed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 33 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27muf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>