<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:03:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-3272] Loaded fonts file descriptors open after closing document</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-3272</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I am experiencing problems with TTF fonts loaded for generating PDFs which eventually result in too many open files on Linux. The PDFBox version I tested last was 2.0.0-RC3.&lt;/p&gt;

&lt;p&gt;Basically for each PDF I create a document and load two fonts which I want to use. After the document is generated I close all the resources, but the file descriptors for both fonts remain open.&lt;/p&gt;

&lt;p&gt;The file descriptors should be automatically closed or an API should exist to close font resources.&lt;/p&gt;

&lt;p&gt;My basic code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.File;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.management.ManagementFactory;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.io.output.ByteArrayOutputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.PDDocument;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.PDPage;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.PDPageContentStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.common.PDRectangle;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.font.PDFont;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.font.PDType0Font;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FontTest
{
	&lt;span class=&quot;code-comment&quot;&gt;// Run the program which will create 1 PDF document and close all resources per second &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 100 seconds.
&lt;/span&gt;	&lt;span class=&quot;code-comment&quot;&gt;// The font open file descriptor count will increase all the time, until the program finishes.
&lt;/span&gt;	&lt;span class=&quot;code-comment&quot;&gt;// Command to check open files: lsof -p PID | grep ttf
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args)
	{
		&lt;span class=&quot;code-comment&quot;&gt;// should print out PID before @&amp;lt;hostname&amp;gt;
&lt;/span&gt;		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;process id: &quot;&lt;/span&gt; + ManagementFactory.getRuntimeMXBean().getName());
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; i++)
		{
			createPDF();
			&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
			{
				&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
			}
			&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e)
			{
				e.printStackTrace();
			}
		}
	}

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void createPDF()
	{
		PDDocument doc = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
		PDPage page = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
		ByteArrayOutputStream bos = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
		{
			doc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument();
			page = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPage(PDRectangle.A4);

			doc.addPage(page);
			&lt;span class=&quot;code-comment&quot;&gt;// using standard font
&lt;/span&gt;			PDFont font = PDType0Font.load(doc, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;./pdf/OpenSans-Regular.ttf&quot;&lt;/span&gt;));

			PDPageContentStream content = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPageContentStream(doc, page);

			content.beginText();
			content.setFont(font, 72);
			content.showText(&lt;span class=&quot;code-quote&quot;&gt;&quot;OMG&quot;&lt;/span&gt;);
			content.endText();
			content.close();

			bos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
			doc.save(bos);
			&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = bos.toByteArray();
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; pdf with size: &quot;&lt;/span&gt; + bytes.length);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e)
		{
			e.printStackTrace();
		}
		&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
		{
			&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
			{
				doc.close();
				bos.close();
			}
			&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
			{
				e.printStackTrace();
			}
		}
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Apache Tomcat, Linux</environment>
        <key id="12949807">PDFBOX-3272</key>
            <summary>Loaded fonts file descriptors open after closing document</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="gregor.ambrozic@gmail.com">Gregor Ambrozic</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Mar 2016 09:06:10 +0000</created>
                <updated>Sat, 25 Mar 2017 18:13:35 +0000</updated>
                            <resolved>Tue, 22 Mar 2016 18:25:50 +0000</resolved>
                                    <version>1.8.11</version>
                    <version>2.0.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>FontBox</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15193113" author="lehmi" created="Mon, 14 Mar 2016 11:16:30 +0000"  >&lt;p&gt;Do you close the created pdf after saving it?&lt;/p&gt;</comment>
                            <comment id="15193115" author="gregor.ambrozic@gmail.com" created="Mon, 14 Mar 2016 11:19:58 +0000"  >&lt;p&gt;Yes I did. I edited example code which you can now try yourself.&lt;/p&gt;</comment>
                            <comment id="15193127" author="gregor.ambrozic@gmail.com" created="Mon, 14 Mar 2016 11:30:56 +0000"  >&lt;p&gt;Attached the font I am using.&lt;/p&gt;</comment>
                            <comment id="15193142" author="lehmi" created="Mon, 14 Mar 2016 11:41:17 +0000"  >&lt;p&gt;I had a quick look and it looks like the TrueTypeEmbedder holds a ttf instance which is never closed. We should close those fonts in PDocument#save after creating the subset&lt;/p&gt;</comment>
                            <comment id="15193152" author="gregor.ambrozic@gmail.com" created="Mon, 14 Mar 2016 11:58:34 +0000"  >&lt;p&gt;I understand. We are using similar code in production currently. Do you have any suggestions for workaround? &lt;/p&gt;</comment>
                            <comment id="15193208" author="lehmi" created="Mon, 14 Mar 2016 12:45:56 +0000"  >&lt;p&gt;We need to fix this before releasing the final version and no I don&apos;t have any work around in my mind.&lt;/p&gt;</comment>
                            <comment id="15193581" author="jira-bot" created="Mon, 14 Mar 2016 16:30:53 +0000"  >&lt;p&gt;Commit 1734954 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1734954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1734954&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3272&quot; title=&quot;Loaded fonts file descriptors open after closing document&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3272&quot;&gt;&lt;del&gt;PDFBOX-3272&lt;/del&gt;&lt;/a&gt;: close the parsed true type font after subsetting&lt;/p&gt;</comment>
                            <comment id="15193586" author="lehmi" created="Mon, 14 Mar 2016 16:32:22 +0000"  >&lt;p&gt;Close the loaded true type font after subsetting&lt;/p&gt;</comment>
                            <comment id="15193890" author="gregor.ambrozic@gmail.com" created="Mon, 14 Mar 2016 18:55:04 +0000"  >&lt;p&gt;I built and tested the trunk version after commit and unfortunately, it didn&apos;t solve the problem for me.&lt;/p&gt;

&lt;p&gt;After some digging around PDFBox code I found the reason.&lt;/p&gt;

&lt;p&gt;The missing close is in the &quot;org.apache.fontbox.ttf.TTFParser&quot; class. Method &quot;public TrueTypeFont parse(File ttfFile)&quot; should call &quot;close()&quot; on the InputStream it creates from the file supplied with &quot;ttfFile&quot; argument. The &quot;close&quot; shoud be called right after the actual parsing is done by method &quot;TrueTypeFont parse(TTFDataStream raf)&quot;.&lt;/p&gt;

&lt;p&gt;Also, I found a workaround for now. &lt;/p&gt;

&lt;p&gt;Before: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PDFont font = PDType0Font.load(doc, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;./pdf/OpenSans-Regular.ttf&quot;&lt;/span&gt;));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead of passing file to &quot;load&quot; method, I pass &quot;InputStream&quot; which I can close after &quot;load&quot; call:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;File fontFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;./pdf/OpenSans-Regular.ttf&quot;&lt;/span&gt;);
FileInputStream fis = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(fontFile);
PDFont font = PDType0Font.load(doc, fis);
fis.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope this helps.&lt;/p&gt;</comment>
                            <comment id="15193893" author="gregor.ambrozic@gmail.com" created="Mon, 14 Mar 2016 18:55:27 +0000"  >&lt;p&gt;Reopening for the reasons in my last comment.&lt;/p&gt;</comment>
                            <comment id="15194107" author="lehmi" created="Mon, 14 Mar 2016 20:55:46 +0000"  >&lt;p&gt;You are right it seems that my fix just solves one half of the issue. I&apos;m going to look deeper into it.&lt;/p&gt;</comment>
                            <comment id="15198494" author="jahewson" created="Thu, 17 Mar 2016 00:44:25 +0000"  >&lt;p&gt;The stream can&apos;t be closed after the parsing, because TTF parsing is actually lazy, the TrueTypeFont holds on to the stream and can subsequently read further data from it. For that reason there&apos;s a TrueTypeFont#close() method which allows any streams held by the font to be closed once we&apos;re done with it. I suspect that we&apos;re missing a call to that method somewhere.&lt;/p&gt;</comment>
                            <comment id="15198846" author="lehmi" created="Thu, 17 Mar 2016 06:43:43 +0000"  >&lt;p&gt;I already added that missing close. The remaining issue seems to be a missing close in RAFDataStream#close, the provided file isn&apos;t closed when closing the stream. BUt I&apos;ve to run some further tests to be sure.&lt;/p&gt;</comment>
                            <comment id="15202161" author="jahewson" created="Fri, 18 Mar 2016 21:00:59 +0000"  >&lt;p&gt;Makes sense, close() does certainly need to actually close something.&lt;/p&gt;</comment>
                            <comment id="15206954" author="jira-bot" created="Tue, 22 Mar 2016 18:18:26 +0000"  >&lt;p&gt;Commit 1736223 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1736223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1736223&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3272&quot; title=&quot;Loaded fonts file descriptors open after closing document&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3272&quot;&gt;&lt;del&gt;PDFBOX-3272&lt;/del&gt;&lt;/a&gt;: close replaced font when creating subset&lt;/p&gt;</comment>
                            <comment id="15206959" author="jira-bot" created="Tue, 22 Mar 2016 18:21:34 +0000"  >&lt;p&gt;Commit 1736224 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1736224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1736224&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3272&quot; title=&quot;Loaded fonts file descriptors open after closing document&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3272&quot;&gt;&lt;del&gt;PDFBOX-3272&lt;/del&gt;&lt;/a&gt;: close replaced font when creating subset&lt;/p&gt;</comment>
                            <comment id="15206969" author="lehmi" created="Tue, 22 Mar 2016 18:25:50 +0000"  >&lt;p&gt;The origin font was replaced with the subsetted one without closing it. After adding the missing close everything works fine.&lt;br/&gt;
I didn&apos;t fix the 1.8 branch as there would be a lot more to do than in the 2.0-branch/trunk.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gregor.ambrozic%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;gregor.ambrozic@gmail.com&quot;&gt;gregor.ambrozic@gmail.com&lt;/a&gt; Thanks for the report and the retest&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12793296" name="OpenSans-Regular.ttf" size="217360" author="gregor.ambrozic@gmail.com" created="Mon, 14 Mar 2016 11:30:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ul7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>