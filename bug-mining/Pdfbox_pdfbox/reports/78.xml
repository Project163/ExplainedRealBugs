<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:52:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-866] Indexed images are sometimes corrupted when encrypting the PDF</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-866</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;While &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-99&quot; title=&quot;Indexed color images have wrong colors after encryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-99&quot;&gt;&lt;del&gt;PDFBOX-99&lt;/del&gt;&lt;/a&gt; did fix this problem with some images, it did not solve the problem in 100% of the cases.  I&apos;ll be attaching a file which demonstrates the problem and I plan on fixing this once I figure out what&apos;s going awry.&lt;/p&gt;</description>
                <environment>Windows Vista (32-bit)&lt;br/&gt;
Java 1.5&lt;br/&gt;
Head tag of PDFBox</environment>
        <key id="12477414">PDFBOX-866</key>
            <summary>Indexed images are sometimes corrupted when encrypting the PDF</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adamnichols">Adam Nichols</assignee>
                                    <reporter username="adamnichols">Adam Nichols</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Oct 2010 00:29:53 +0000</created>
                <updated>Tue, 26 Oct 2010 09:34:41 +0000</updated>
                            <resolved>Tue, 19 Oct 2010 18:29:03 +0000</resolved>
                                    <version>0.7.0</version>
                    <version>0.7.1</version>
                    <version>0.7.2</version>
                    <version>0.7.3</version>
                    <version>0.8.0-incubator</version>
                    <version>1.0.0</version>
                    <version>1.1.0</version>
                    <version>1.2.0</version>
                    <version>1.2.1</version>
                    <version>1.3.1</version>
                                    <fixVersion>1.3.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12921189" author="adamnichols" created="Fri, 15 Oct 2010 00:33:34 +0000"  >&lt;p&gt;HelpOrderingAppraisal_page1.unc.pdf demonstrates the problem and will be used to verify it is fixed.&lt;br/&gt;
bitmaptest.pdf is a file which should be used for regression testing.&lt;/p&gt;</comment>
                            <comment id="12921610" author="adamnichols" created="Sat, 16 Oct 2010 00:53:04 +0000"  >&lt;p&gt;The problem in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-99&quot; title=&quot;Indexed color images have wrong colors after encryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-99&quot;&gt;&lt;del&gt;PDFBOX-99&lt;/del&gt;&lt;/a&gt; was that this information was not getting encrypted; this is not the case here... it is getting encrypted, but it&apos;s not being encrypted properly.  For the &quot;TL;DR&quot; people, I&apos;m close to having this solved.&lt;/p&gt;

&lt;p&gt;I&apos;ll step through the HelpOrderingAppraisal_page1.unc.pdf to explain the bug and how it was fixed.  In this PDF object 18 is the image and the colorspace is 21.  This makes sense.  When PDFBox writes out the image, the image is written out with the colorstream at both included in the same object (object id: 34).  However, there&apos;s another ColorSpace which is associated with this image.  Object 7 is references Object 19 as its XObject and that maps /R17 to our image (object 34).  At the same time, there&apos;s also a colorspace associated with object 7, which is object 17.  What happens in the code is that it encrypts the colorspace for object 34 when it writes out object 17, then it encrypts it again when it writes out object 34.&lt;/p&gt;

&lt;p&gt;While debugging I manipulated it to skip the encryption when it was writing out object 17 and everything was output correctly.  I&apos;m not sure how 17 is connected to 34, but I expect to go through the code and the PDF spec to see how everything is connected and processed and come up with a patch.&lt;/p&gt;</comment>
                            <comment id="12922232" author="adamnichols" created="Mon, 18 Oct 2010 20:07:27 +0000"  >&lt;p&gt;The original PDF has two nodes which both refer to object 21 (the colorspace, complete with the Index map).  When it writes out these two nodes, it does not write out a reference to a colorspace, but instead it writes out the entire colorspace twice.  This would be fine except that the colorspace is encrytped inline, so the first time it&apos;s written out correctly, but then the second time it&apos;s written out double encrypted (aka corrupted).&lt;/p&gt;

&lt;p&gt;We can&apos;t solve this in the parser because if objects A and B reference C, you can&apos;t make a copy of C when parsing objects A and B because C hasn&apos;t been read yet.  So the solution must be to make a copy before encrypting and writing out.  I implemented this for COSStrings in visitFromArray() of COSWriter and it solved the issue for this PDF and did not cause any regression issues with the PDF from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-99&quot; title=&quot;Indexed color images have wrong colors after encryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-99&quot;&gt;&lt;del&gt;PDFBOX-99&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I was wondering how others felt about this solution.  It&apos;s in the COSWriter, which is only used for saving, so it should have a minimal impact (i.e. the parser, text extraction, and so forth is not affected).  My only concerns is that we&apos;ll run into this same issue in other places and need to make copies.  The memory usage increase will be small as I&apos;m only adding a local variable which is destroyed after executing the accept() method.  I will be doing a large number of tests to make sure this patch actually solves the problem and does not cause any undesired side effects.  If my tests come out okay and there are no objections, I will commit the patch.&lt;/p&gt;</comment>
                            <comment id="12922654" author="adamnichols" created="Tue, 19 Oct 2010 18:29:03 +0000"  >&lt;p&gt;Unfortunately this fix didn&apos;t make it into the 1.3.0 release, but I&apos;ve tested this patch with several hundred PDFs from various sources and couldn&apos;t find a single image which was corrupted.  It seems this long-standing issue is finally completely resolved.  Committed in revision 1024346.&lt;/p&gt;</comment>
                            <comment id="12922966" author="jukkaz" created="Wed, 20 Oct 2010 13:59:17 +0000"  >&lt;p&gt;A regression was detected in the 1.3.0 release candidate, so I&apos;m including this fix in the followup 1.3.1 release.&lt;/p&gt;

&lt;p&gt;Merged to the 1.3 branch in revision 1025584.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457216" name="HelpOrderingAppraisal_page1.unc.pdf" size="417718" author="adamnichols" created="Fri, 15 Oct 2010 00:33:34 +0000"/>
                            <attachment id="12457502" name="PDFBOX-866.patch" size="729" author="adamnichols" created="Mon, 18 Oct 2010 23:20:36 +0000"/>
                            <attachment id="12457215" name="bitmaptest.pdf" size="14049" author="adamnichols" created="Fri, 15 Oct 2010 00:33:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163542</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 5 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zkk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>205633</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>