<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:09:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4559] Parse error reading document from several threads</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4559</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I got following error while running&#160;a simple&#160;parallel rendering code. However, the error doesn&apos;t happen when I change parallelStream to sequential (stream()). Interestingly, both methods will render exact same images. I saw a possible related ticket&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3654&quot; title=&quot;Parse error reading embedded Type1 font&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3654&quot;&gt;&lt;del&gt;PDFBOX-3654&lt;/del&gt;&lt;/a&gt;. But seems that issue was fixed. I&apos;d like to learn if we have some more bugs related?&#160;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Sample code&lt;/b&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PDDocument document = PDDocument.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(pdfFilename));
List&amp;lt;PDDocument&amp;gt; pdfPages = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Splitter().split(document);
pdfPages.parallelStream().forEach(page -&amp;gt; {
 &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {

PDFRenderer renderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFRenderer(page);
renderer.renderImageWithDPI(0, 180, ImageType.RGB); &lt;span class=&quot;code-comment&quot;&gt;// change dpi to your number
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
 &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(e);
}

&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
 pdfPage.close();
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ignored) {
}
});

&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
 document.close();
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ignored) {
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Error log&lt;/b&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [PDType1Font] Can&apos;t read the embedded Type1 font POAEND+Gotham-Book
java.io.IOException: unexpected closing parenthesis
 at org.apache.fontbox.type1.Type1Lexer.readToken(Type1Lexer.java:123) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.fontbox.type1.Type1Lexer.nextToken(Type1Lexer.java:75) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.fontbox.type1.Type1Parser.readValue(Type1Parser.java:398) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.fontbox.type1.Type1Parser.readOtherSubrs(Type1Parser.java:707) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.fontbox.type1.Type1Parser.parseBinary(Type1Parser.java:550) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.fontbox.type1.Type1Parser.parse(Type1Parser.java:64) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.fontbox.type1.Type1Font.createWithSegments(Type1Font.java:85) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.pdmodel.font.PDType1Font.&amp;lt;init&amp;gt;(PDType1Font.java:262) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:62) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.pdmodel.PDResources.getFont(PDResources.java:146) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.contentstream.operator.text.SetFontAndSize.process(SetFontAndSize.java:60) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:869) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:505) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:479) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:152) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.rendering.PageDrawer.drawPage(PageDrawer.java:265) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:314) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:243) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]
 at org.apache.pdfbox.rendering.PDFRenderer.renderImageWithDPI(PDFRenderer.java:229) ~[pdfbox-2.0.15-snapshot108.jar:2.0.15-SNAPSHOT]

WARN [PDType1Font] Using fallback font Helvetica for POAEND+Gotham-Book
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Oracle Java 8 update125 on both Mac OS X and centos</environment>
        <key id="13237644">PDFBOX-4559</key>
            <summary>Parse error reading document from several threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jiangyurong609">Jack</reporter>
                        <labels>
                            <label>concurrency</label>
                            <label>multithreading</label>
                            <label>type1</label>
                            <label>type1font</label>
                    </labels>
                <created>Wed, 5 Jun 2019 05:03:34 +0000</created>
                <updated>Tue, 22 Mar 2022 17:17:20 +0000</updated>
                                            <version>2.0.15</version>
                                                    <component>Rendering</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16856415" author="tilman" created="Wed, 5 Jun 2019 06:58:00 +0000"  >&lt;p&gt;What is the &lt;tt&gt;pdfPages&lt;/tt&gt; variable that is getting closed? If this is the &lt;tt&gt;page&lt;/tt&gt; variable (really a document object), then try closing it only after all has been done.&lt;/p&gt;

&lt;p&gt;I wonder if the cause is somehow related to several threads accessing common resources. The current version of the splitter doesn&apos;t make deep copies IIRC (which would have other disadvantages).&lt;/p&gt;</comment>
                            <comment id="16856750" author="jiangyurong609" created="Wed, 5 Jun 2019 14:27:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; thanks for helping take a look. I removed the per page close, but same error still persists. What are the common resources that are shared across pages? Any suggestions for correctly doing parallel processing on pages? Thanks&lt;/p&gt;</comment>
                            <comment id="16856785" author="tilman" created="Wed, 5 Jun 2019 15:18:00 +0000"  >&lt;p&gt;Another thing to try: just call getPages() in the original document, create a parallel stream from a spliterator() and use the PDPage objects. I.e. don&apos;t use the PDFBox splitter class.&lt;/p&gt;
</comment>
                            <comment id="16856798" author="jiangyurong609" created="Wed, 5 Jun 2019 15:42:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&#160;I didn&apos;t find a way to create parallel stream on spliterator(), do you have any suggestions?&#160;I tried both code below, I have another question, from&#160;&lt;a href=&quot;https://pdfbox.apache.org/2.0/migration.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/2.0/migration.html&lt;/a&gt;, I found with PDPage, you have to pass the page index to render, how do you do that with parallel stream? Thanks so much&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PDDocument document = PDDocument.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(pdfFilename));
document.getPages().spliterator().forEachRemaining(page -&amp;gt; processPDF(page, pdfRenderer, path + UUID.randomUUID().toString() + &lt;span class=&quot;code-quote&quot;&gt;&quot;.png&quot;&lt;/span&gt;));

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PDPage page : document.getPages()) {
  processPDF(page, pdfRenderer, path + UUID.randomUUID().toString() + &lt;span class=&quot;code-quote&quot;&gt;&quot;.png&quot;&lt;/span&gt;);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16856942" author="tilman" created="Wed, 5 Jun 2019 18:52:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://pdfbox.apache.org/2.0/faq.html#is-pdfbox-thread-safe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/2.0/faq.html#is-pdfbox-thread-safe&lt;/a&gt;&lt;br/&gt;
 &quot;PDFBox has experimental support for read-only operations on the same PDDocument from different threads.&quot;&lt;/p&gt;

&lt;p&gt;I wonder if it is a problem that different documents share the same memory scratch &quot;file&quot; object.&lt;/p&gt;

&lt;p&gt;You don&apos;t have to use the splitter:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PDFRenderer renderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFRenderer(document);
Stream&amp;lt;PDPage&amp;gt; stream = StreamSupport.stream(document.getPages().spliterator(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; makes it parallel
&lt;/span&gt;stream.forEach(page -&amp;gt;
{
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
    {
        renderer.renderImageWithDPI(0, 180, ImageType.RGB); &lt;span class=&quot;code-comment&quot;&gt;// change dpi to your number
&lt;/span&gt;    }
    &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
    {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt; + page);
        e.printStackTrace();
    }
});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I didn&apos;t get the exception with that one, and it seemed faster too: 3 seconds instead of 19 seconds.&lt;/p&gt;</comment>
                            <comment id="16856948" author="jiangyurong609" created="Wed, 5 Jun 2019 19:01:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; awesome, thanks so much&lt;/p&gt;</comment>
                            <comment id="16857257" author="tilman" created="Thu, 6 Jun 2019 03:42:55 +0000"  >&lt;p&gt;Did the exception also go away in your application?&lt;/p&gt;</comment>
                            <comment id="16857798" author="jiangyurong609" created="Thu, 6 Jun 2019 15:24:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; yes, the exceptions are gone for this file. For &quot;PDFBox has experimental support for read-only operations on the same PDDocument from different threads&quot;, what&apos;s reliability for the multi-threading? thanks&lt;/p&gt;</comment>
                            <comment id="16857856" author="tilman" created="Thu, 6 Jun 2019 16:35:12 +0000"  >&lt;p&gt;I don&apos;t know, I think this was related to the rewriting of the memory management code. We haven&apos;t had any such troubles until this issue.&lt;/p&gt;

&lt;p&gt;I&apos;ll improve the javadoc to mention that result files should not be used concurrently.&lt;/p&gt;</comment>
                            <comment id="16857895" author="jiangyurong609" created="Thu, 6 Jun 2019 17:03:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; I just realized this code always render the first page&lt;/p&gt;</comment>
                            <comment id="16857898" author="tilman" created="Thu, 6 Jun 2019 17:06:01 +0000"  >&lt;p&gt;Ooooooops!!! Sorry about that. I&apos;ll come up with better code.&lt;/p&gt;</comment>
                            <comment id="16857908" author="tilman" created="Thu, 6 Jun 2019 17:13:41 +0000"  >&lt;p&gt;new code, no longer so fast (that was too good to be true LOL):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PDFRenderer renderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFRenderer(document);
PDPageTree pageTree = document.getPages();
Stream&amp;lt;PDPage&amp;gt; stream = StreamSupport.stream(pageTree.spliterator(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; makes it parallel
&lt;/span&gt;stream.forEach(page -&amp;gt;
{
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; p = pageTree.indexOf(page);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; renderer.renderImageWithDPI(p, 180, ImageType.RGB); &lt;span class=&quot;code-comment&quot;&gt;// change dpi to your number
&lt;/span&gt;&#160;&#160;&#160; }
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt; + page);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.printStackTrace();
&#160;&#160;&#160; }
});&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16857916" author="jiangyurong609" created="Thu, 6 Jun 2019 17:24:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; thanks for the help. However, this seems fall back to sequential execution time.&#160;&lt;/p&gt;</comment>
                            <comment id="16857932" author="tilman" created="Thu, 6 Jun 2019 17:39:57 +0000"  >&lt;p&gt;This one works in parallel, but now the exception is back. (and more error messages)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PDFRenderer renderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFRenderer(document);
PDPageTree pageTree = document.getPages();
List&amp;lt;PDPage&amp;gt; pages = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PDPage page : pageTree)
{
&#160;&#160;&#160; pages.add(page);
}
pages.parallelStream().forEach(page -&amp;gt;
{
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; p = pageTree.indexOf(page);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; renderer.renderImageWithDPI(p, 180, ImageType.RGB); &lt;span class=&quot;code-comment&quot;&gt;// change dpi to your number
&lt;/span&gt;&#160;&#160;&#160; }
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt; + page);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; e.printStackTrace();
&#160;&#160;&#160; }
});&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16857964" author="jiangyurong609" created="Thu, 6 Jun 2019 18:08:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&#160;thanks, this falls back to original Splitter problem.&#160;&lt;/p&gt;</comment>
                            <comment id="16862507" author="ethuang" created="Wed, 12 Jun 2019 22:30:19 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;,&#160;&lt;/p&gt;

&lt;p&gt;Does this mean PDFBOX 2.0.15 is still not read-thread-safe?&#160;&lt;/p&gt;

&lt;p&gt;In your FAQ: &quot;PDFBox has experimental support for read-only operations on the same PDDocument from different threads.&quot;&lt;/p&gt;

&lt;p&gt;Can this guarantee&#160;PDFRenderer is thread safe on reads? For now, it looks like not. Please confirm, thanks!&lt;/p&gt;</comment>
                            <comment id="16862689" author="tilman" created="Thu, 13 Jun 2019 03:28:46 +0000"  >&lt;p&gt;Indeed, for now, it is not.&lt;/p&gt;</comment>
                            <comment id="16863217" author="ethuang" created="Thu, 13 Jun 2019 16:07:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; Thanks! Do we have plan on making rendering thread safe for a single doc?&#160;&lt;/p&gt;</comment>
                            <comment id="16863242" author="tilman" created="Thu, 13 Jun 2019 16:31:59 +0000"  >&lt;p&gt;I&apos;m currently investigating this. Watch this space.&lt;/p&gt;</comment>
                            <comment id="16863248" author="jira-bot" created="Thu, 13 Jun 2019 16:38:08 +0000"  >&lt;p&gt;Commit 1861274 from Tilman Hausherr in branch &apos;pdfbox/branches/issue45&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1861274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1861274&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4559&quot; title=&quot;Parse error reading document from several threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4559&quot;&gt;PDFBOX-4559&lt;/a&gt;: if read failed don&apos;t alter position and log error&lt;/p&gt;</comment>
                            <comment id="16863249" author="jira-bot" created="Thu, 13 Jun 2019 16:38:13 +0000"  >&lt;p&gt;Commit 1861275 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1861275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1861275&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4559&quot; title=&quot;Parse error reading document from several threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4559&quot;&gt;PDFBOX-4559&lt;/a&gt;: if read failed don&apos;t alter position and log error&lt;/p&gt;</comment>
                            <comment id="16863251" author="jira-bot" created="Thu, 13 Jun 2019 16:38:18 +0000"  >&lt;p&gt;Commit 1861276 from Tilman Hausherr in branch &apos;pdfbox/branches/issue4569&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1861276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1861276&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4559&quot; title=&quot;Parse error reading document from several threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4559&quot;&gt;PDFBOX-4559&lt;/a&gt;: if read failed don&apos;t alter position and log error&lt;/p&gt;</comment>
                            <comment id="16863252" author="jira-bot" created="Thu, 13 Jun 2019 16:38:23 +0000"  >&lt;p&gt;Commit 1861277 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1861277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1861277&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4559&quot; title=&quot;Parse error reading document from several threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4559&quot;&gt;PDFBOX-4559&lt;/a&gt;: if read failed don&apos;t alter position and log error&lt;/p&gt;</comment>
                            <comment id="16863253" author="tilman" created="Thu, 13 Jun 2019 16:41:03 +0000"  >&lt;p&gt;The last commit fixes the cause of the stack trace below (one of the many problems that sporadically happened with the test code):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.io.IOException: Negative seek offset: -1
	at org.apache.pdfbox.io.ScratchFileBuffer.seek(ScratchFileBuffer.java:314)
	at org.apache.pdfbox.io.RandomAccessInputStream.restorePosition(RandomAccessInputStream.java:47)
	at org.apache.pdfbox.io.RandomAccessInputStream.read(RandomAccessInputStream.java:78)
	at java.io.InputStream.read(InputStream.java:101)
	at org.apache.pdfbox.filter.FlateFilter.decompress(FlateFilter.java:70)
	at org.apache.pdfbox.filter.FlateFilter.decode(FlateFilter.java:50)
	at org.apache.pdfbox.filter.Filter.decode(Filter.java:87)
	at org.apache.pdfbox.cos.COSInputStream.create(COSInputStream.java:84)
	at org.apache.pdfbox.cos.COSStream.createInputStream(COSStream.java:178)
        at org.apache.pdfbox.cos.COSStream.createInputStream(COSStream.java:166)
	at org.apache.pdfbox.pdmodel.common.PDStream.createInputStream(PDStream.java:230)
	at org.apache.pdfbox.pdmodel.font.PDTrueTypeFont.&amp;lt;init&amp;gt;(PDTrueTypeFont.java:108)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;position can only be -1 if &lt;tt&gt;input.read&lt;/tt&gt; returns -1 and was 0 before. Such a read fail happens at EOF time and shouldn&apos;t happen because &lt;tt&gt;input.isEOF()&lt;/tt&gt; was checked before. That is just a symptom of the concurrency problems but I&apos;m fixing it anyway.&lt;/p&gt;</comment>
                            <comment id="16863274" author="jiangyurong609" created="Thu, 13 Jun 2019 16:47:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; cool, thanks for taking care of this, what&apos;ll be the new version?&lt;/p&gt;</comment>
                            <comment id="16863315" author="tilman" created="Thu, 13 Jun 2019 17:23:39 +0000"  >&lt;p&gt;The fix above is just for one of the symptoms and doesn&apos;t address the root cause. I don&apos;t even know if it can be fixed at all. In the worst case, we&apos;d just update the documentation and you&apos;d have to open the file several times.&lt;/p&gt;

&lt;p&gt;I have a fix that makes the test code work properly, sadly it doesn&apos;t work if the file is uncompressed (&lt;tt&gt;WriteDecodedDoc&lt;/tt&gt; operation in pdfbox-app). The idea was to synchronize on &lt;tt&gt;scratchFile&lt;/tt&gt; in &lt;tt&gt;COSInputStream.create()&lt;/tt&gt; when it isn&apos;t null. The problem is that it doesn&apos;t synchronize all accesses to the scratch file.&lt;/p&gt;

&lt;p&gt;I also tried to put &lt;tt&gt;synchronized&lt;/tt&gt; on the methods of &lt;tt&gt;RandomAccessInputStream&lt;/tt&gt; but that doesn&apos;t help at all. My thought was that a concurrent read could take place between a call to &lt;tt&gt;restorePosition&lt;/tt&gt; and the read a few lines later.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tboehme&quot; class=&quot;user-hover&quot; rel=&quot;tboehme&quot;&gt;tboehme&lt;/a&gt; any ideas? Was this ever intended to allow concurrent access?&lt;/p&gt;</comment>
                            <comment id="16865403" author="tboehme" created="Mon, 17 Jun 2019 07:46:03 +0000"  >&lt;p&gt;I think we have to explore different levels of creating/using streams in regard to be thread safe. The base implementation for our memory paging - ScratchFile - is (as the Javadoc states) thread safe (at least it was meant to be &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). However the RandomAccess instances (ScratchFileBuffer) created from it are not - as we have possibilities of mixed reads and writes (and so far parallel access to an instance was not supported by the API). RandomAccessInputStream is only a small layer on top of RandomAccessRead - here as ScratchFileBuffer. The first step would be to switch the ScratchFileBuffer in a read-only mode (or have a small wrapper only allowing thread-safe read access, implementing RandomAccessRead).&lt;/p&gt;

&lt;p&gt;However even this might not help in this case as using a single RandomAccessInputStream from multiple threads will lead to errors (even if the methods would be synchronized) as one thread would not see a sequential stream of input bytes because the other threads will read some bytes in between.&lt;/p&gt;

&lt;p&gt;For thread safe access the RandomAccessInputStream has to be created on request of a specific thread and method which wants to read the data. Thus the COSInputStream would have to store the thread safe RandomAccessRead implementation (as it does so indirectly now for the ScratchFileBuffer underlying the RandomAccessInputStream) and would have a method for creating a RandomAccessInputStream each time it is needed (being only a small access wrapper for the data).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16865733" author="tilman" created="Mon, 17 Jun 2019 16:11:24 +0000"  >&lt;p&gt;OK, this sounds tricky, i.e. won&apos;t probably be solved easily.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=msahyoun&quot; class=&quot;user-hover&quot; rel=&quot;msahyoun&quot;&gt;msahyoun&lt;/a&gt;, please replace the segment at&lt;br/&gt;
 &lt;a href=&quot;https://pdfbox.apache.org/2.0/faq.html#is-pdfbox-thread-safe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/2.0/faq.html#is-pdfbox-thread-safe&lt;/a&gt;&lt;br/&gt;
 with the segment from&lt;br/&gt;
 &lt;a href=&quot;https://pdfbox.apache.org/1.8/faq.html#is-pdfbox-thread-safe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pdfbox.apache.org/1.8/faq.html#is-pdfbox-thread-safe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16971166" author="jira-bot" created="Sun, 10 Nov 2019 17:36:54 +0000"  >&lt;p&gt;Commit 6145c813fe20ffa1372f3e39b9db19af39ae71bc in pdfbox-docs&apos;s branch refs/heads/master from Maruan Sahyoun&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=pdfbox-docs.git;h=6145c81&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=pdfbox-docs.git;h=6145c81&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3330&quot; title=&quot;Enhance and update PDFBox website &amp;amp; documentation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3330&quot;&gt;&lt;del&gt;PDFBOX-3330&lt;/del&gt;&lt;/a&gt;; &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4559&quot; title=&quot;Parse error reading document from several threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4559&quot;&gt;PDFBOX-4559&lt;/a&gt;: Correct statement for experimental multithreading support&lt;/p&gt;</comment>
                            <comment id="17420996" author="divekarsc" created="Mon, 27 Sep 2021 19:45:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; Is this still being worked on? I encountered the same issue (NPE) while trying to access different PDPages of the same PDDocument in read-only operation. Is there any way I can avoid this issue? For example, what if I created a copy of PDPage object array and iterated parallely over that? Would it result in the same error?&lt;/p&gt;</comment>
                            <comment id="17421528" author="tilman" created="Tue, 28 Sep 2021 17:12:21 +0000"  >&lt;p&gt;No; you should use different PDDocument objects; No; Yes. &lt;/p&gt;</comment>
                            <comment id="17421531" author="divekarsc" created="Tue, 28 Sep 2021 17:17:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&#160;Thank you. Do you mean open multiple PDDocument objects for the same PDF and read pages? And also, will this be fixed as part of any future releases? (e.g. PDFBox 3.0)&lt;/p&gt;</comment>
                            <comment id="17421563" author="tilman" created="Tue, 28 Sep 2021 17:38:20 +0000"  >&lt;p&gt;Yes I mean opening a PDF several times. I don&apos;t know if it will ever be fixed. It&apos;s tricky, see the comment from June 17 2019.&lt;/p&gt;</comment>
                            <comment id="17510276" author="lehmi" created="Tue, 22 Mar 2022 07:21:44 +0000"  >&lt;p&gt;PDFBox 3.0.0 doesn&apos;t use ScratchFile to read a pdf and should show a different behaviour but I&apos;m not sure if it is a better one.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;&#160; do you still have the test code used for the improvements added earlier? Maybe you could give a try, or maybe someone else?&lt;/p&gt;</comment>
                            <comment id="17510535" author="JIRAUSER286513" created="Tue, 22 Mar 2022 14:46:33 +0000"  >&lt;p&gt;As of version 2.0.24 we&apos;ve seen issues with this method as well when called in parallel.&lt;/p&gt;

&lt;p&gt;While we did not see the stack trace(s) described above, we saw issues with glyphs not being found when the following type of operation was performed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; pageNumber = pageIndex + 1; &lt;span class=&quot;code-comment&quot;&gt;// The page number used with PDFTextStripper is one-based and inclusive.
&lt;/span&gt;
        PDFTextStripper textStripper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFTextStripper();
        textStripper.setStartPage(pageNumber);
        textStripper.setEndPage(pageNumber);

        renderedImage = pdfRenderer.renderImageWithDPI(pageIndex, dpi, ImageType.RGB);
        pageText = textStripper.getText(pdfDocument);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;While these two methods appear to be thread-safe at a high level they both interface with the internal font system in a way which is not.&lt;/p&gt;

&lt;p&gt;If the two calls at the end of this sample are not synchronized then all manner of warnings are thrown as glyphs are requested. Often the resulting image is missing text.&lt;/p&gt;

&lt;p&gt;I don&apos;t want to muddy the waters by adding yet another problem but as Tilman has suggested, any thread-safety work here is likely to go fairly deep into the code.&lt;/p&gt;</comment>
                            <comment id="17510769" author="tilman" created="Tue, 22 Mar 2022 17:17:20 +0000"  >&lt;p&gt;This is the code I used and I immediately got troubles&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ParallelTest4559
{
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        PDDocument document = Loader.loadPDF(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;PDFBOX-4559.pdf&quot;&lt;/span&gt;));
        PDFRenderer renderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFRenderer(document);
        PDPageTree pageTree = document.getPages();
        List&amp;lt;PDPage&amp;gt; pages = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PDPage page : pageTree)
        {
            pages.add(page);
        }
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;---&quot;&lt;/span&gt;);
        pages.parallelStream().forEach(page -&amp;gt;
        {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; p = pageTree.indexOf(page);
                renderer.renderImageWithDPI(p, 180, ImageType.RGB); &lt;span class=&quot;code-comment&quot;&gt;// change dpi to your number
&lt;/span&gt;            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e)
            {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt; + page);
                e.printStackTrace();
            }
        });

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
        {
            document.close();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ignored)
        {
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12970915" name="test.pdf" size="16488782" author="jiangyurong609" created="Wed, 5 Jun 2019 05:05:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03fe0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>