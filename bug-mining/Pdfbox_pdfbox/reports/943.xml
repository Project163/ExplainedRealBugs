<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:59:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2649] Character widths incorrect in a loaded font</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2649</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
testRelativeWidth() {
PDFont font = PDType0Font.load(document, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass().getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;/LiberationSans-Regular.ttf&quot;&lt;/span&gt;));
&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; wO = font.getStringWidth(&lt;span class=&quot;code-quote&quot;&gt;&quot;O&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; wP = font.getStringWidth(&lt;span class=&quot;code-quote&quot;&gt;&quot;P&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; wN = font.getStringWidth(&lt;span class=&quot;code-quote&quot;&gt;&quot;N&quot;&lt;/span&gt;);
Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;O must be wider than P&quot;&lt;/span&gt;, wO&amp;gt;wP);
Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;O must be wider than N&quot;&lt;/span&gt;, wO&amp;gt;wN);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can see that there is a confusion in the process between GID and CID values. The reason may not be entirely clear to me, but PDCIDFontType2Embedder.buildWidths(COSDictionary cidFont) seems to name &quot;cid&quot; something that in my opinion is still a glyph id. And when it comes to PDCIDFont.getWidth(int), the &quot;widths&quot; map that should presumably contain cid-&amp;gt;width values in reality contains git-&amp;gt;width.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12771536">PDFBOX-2649</key>
            <summary>Character widths incorrect in a loaded font</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jahewson">John Hewson</assignee>
                                    <reporter username="nev">Alex Nevidomsky</reporter>
                        <labels>
                    </labels>
                <created>Sat, 31 Jan 2015 16:15:05 +0000</created>
                <updated>Thu, 17 Mar 2016 19:07:36 +0000</updated>
                            <resolved>Sat, 31 Jan 2015 22:00:15 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>PDModel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14299878" author="nev" created="Sat, 31 Jan 2015 16:19:51 +0000"  >&lt;p&gt;In addition to this, the codeToGID() function seems to return identity map, which is incorrect.&lt;/p&gt;</comment>
                            <comment id="14299993" author="jahewson" created="Sat, 31 Jan 2015 21:28:02 +0000"  >&lt;p&gt;PDFont.getStringWidth is one of the few 1.8 methods which hasn&apos;t been rewritten yet in 2.0 and is known to be broken. There&apos;s a &quot;todo&quot; comment to that effect in the code. Obviously this is something which we need to address.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I can see that there is a confusion in the process between GID and CID values. The reason may not be entirely clear to me, but PDCIDFontType2Embedder.buildWidths(COSDictionary cidFont) seems to name &quot;cid&quot; something that in my opinion is still a glyph id. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re probably not going to find these sorts of basic mistakes in the newer 2.0 code, it&apos;s been fairly well tested. That method builds an &lt;em&gt;Identity&lt;/em&gt; CIDToGIDMap, where CID = GID. It&apos;s also not related to the glyph widths you get from getStringWidth().&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;when it comes to PDCIDFont.getWidth(int), the &quot;widths&quot; map that should presumably contain cid-&amp;gt;width values in reality contains gid-&amp;gt;width.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, the widths array maps CIDs to widths. This is correct.&lt;/p&gt;

&lt;p&gt;In summary, the line with the &quot;todo&quot; is the case of problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; getStringWidth(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; text) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
{
    &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; width = 0;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; offset = 0, length = text.length();
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (offset &amp;lt; length)
    {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; codePoint = text.codePointAt(offset);
        offset += &lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.charCount(codePoint);
        width += getWidth(codePoint); &lt;span class=&quot;code-comment&quot;&gt;// todo: *no* getWidth expects a PDF &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; code, not a Unicode code point
&lt;/span&gt;    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; width;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14299995" author="nev" created="Sat, 31 Jan 2015 21:39:25 +0000"  >&lt;p&gt;Ah, sorry again, missed that comment while looking downstream.&lt;/p&gt;</comment>
                            <comment id="14299998" author="nev" created="Sat, 31 Jan 2015 21:42:03 +0000"  >&lt;p&gt;I just did my own hacked external implementation of Unicode-&amp;gt;GID table for the font I need (or at least the code that is used in the hmtx table of the font), and then getWidth works like a charm. Was not able to get the GID values from the font directly, though.&lt;/p&gt;</comment>
                            <comment id="14300008" author="jira-bot" created="Sat, 31 Jan 2015 21:58:46 +0000"  >&lt;p&gt;Commit 1656254 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jahewson&quot; class=&quot;user-hover&quot; rel=&quot;jahewson&quot;&gt;jahewson&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1656254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1656254&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2649&quot; title=&quot;Character widths incorrect in a loaded font&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2649&quot;&gt;&lt;del&gt;PDFBOX-2649&lt;/del&gt;&lt;/a&gt;: Map Unicode points to PDF char codes when fetching widths&lt;/p&gt;</comment>
                            <comment id="14300010" author="jahewson" created="Sat, 31 Jan 2015 21:59:57 +0000"  >&lt;p&gt;This fixes the underlying problem in PDFont.getStringWidth() by encoding the Unicode text to PDF char codes before fetching the glyph widths.&lt;/p&gt;</comment>
                            <comment id="14300019" author="nev" created="Sat, 31 Jan 2015 22:41:53 +0000"  >&lt;p&gt;I see. It&apos;s much trickier than I thought.&lt;/p&gt;

&lt;p&gt;Did you mean&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = encode(codePoint);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;instead of &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = encode(text);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in the code, though?&lt;/p&gt;</comment>
                            <comment id="14300023" author="nev" created="Sat, 31 Jan 2015 22:52:26 +0000"  >&lt;p&gt;Oh, and is there any particular reason for encode(int) to be protected? &lt;br/&gt;
I&apos;m currently trying to fit text lines into table, which means that I&apos;m doing a slightly more complicated version of getStringWidth() (that stops when reaching a specific width while looking for good break points). I can replicate the logic but calling getStringWidth on single character strings would be a bit of an overhead.&lt;/p&gt;</comment>
                            <comment id="14300042" author="jahewson" created="Sun, 1 Feb 2015 00:53:07 +0000"  >&lt;p&gt;Yes, thanks - that will simplify things too.&lt;/p&gt;</comment>
                            <comment id="14300043" author="jahewson" created="Sun, 1 Feb 2015 00:56:53 +0000"  >&lt;p&gt;encode(int) isn&apos;t the right API for that, because what you really want is getWidth(unicode), perhaps we could add that in the future. We&apos;re trying to keep the font API as small as possible in 2.0, it was too big in 1.8 and this caused confusion and lots of bugs.&lt;/p&gt;

&lt;p&gt;Right now, if you have performance issues then I&apos;d recommend caching the widths, as even encode(int) has to do quite a lot of work.&lt;/p&gt;</comment>
                            <comment id="14300044" author="jira-bot" created="Sun, 1 Feb 2015 00:57:16 +0000"  >&lt;p&gt;Commit 1656260 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jahewson&quot; class=&quot;user-hover&quot; rel=&quot;jahewson&quot;&gt;jahewson&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1656260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1656260&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2649&quot; title=&quot;Character widths incorrect in a loaded font&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2649&quot;&gt;&lt;del&gt;PDFBOX-2649&lt;/del&gt;&lt;/a&gt;: encode string only once&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i251kf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>