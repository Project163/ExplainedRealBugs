<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:02:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-3175] PDFTextStreamEngine probably miscalculates text height</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-3175</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;When parsing a PDF document, TextPosition is created with constant text height, about 2 time smaller than character width, regardless of font size.&lt;br/&gt;
The following workaround to calculate dyDisplay fixes the issue:&lt;/p&gt;

&lt;p&gt;        float verticalScaling = 1/1000f;&lt;br/&gt;
        if (font instanceof PDType3Font) &lt;/p&gt;
{
            Matrix fontMatrix = font.getFontMatrix();
            verticalScaling = fontMatrix.getValue(1, 1);
        }
&lt;p&gt;        float dyDisplay = bbox.getHeight() * fontSize * verticalScaling;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12924775">PDFBOX-3175</key>
            <summary>PDFTextStreamEngine probably miscalculates text height</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="ElEl">Leo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Dec 2015 01:40:19 +0000</created>
                <updated>Thu, 17 Mar 2016 19:07:59 +0000</updated>
                            <resolved>Wed, 6 Jan 2016 20:57:38 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Text extraction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15074623" author="tilman" created="Wed, 30 Dec 2015 04:47:21 +0000"  >&lt;p&gt;It would be better to explain what you tried to do, and how PDFBox failed. Your change makes the text extraction tests fail, and not just one, but many. You&apos;re not making any argument why your text extraction is better than the existing one.&lt;/p&gt;

&lt;p&gt;The tests are at &quot;PDFBox reactor\pdfbox\src\test\resources\input&quot;, the output is at &quot;PDFBox reactor\pdfbox\target\test-output&quot;.&lt;/p&gt;

&lt;p&gt;Re correct heights, please run the DrawPrintTextLocations example on your file. The red mark is a helper used for text extraction, the blue is the bounding box. Ideally, the red mark should cover small glyphs, e.g. &quot;a&quot;, &quot;o&quot;, &quot;n&quot;, etc. It is not always perfect, but comes close.&lt;/p&gt;</comment>
                            <comment id="15074813" author="elel" created="Wed, 30 Dec 2015 09:07:53 +0000"  >&lt;p&gt;Sorry for such brief discription of the problem on my part. Here are more detailed explanations:&lt;/p&gt;

&lt;p&gt;1. What I&apos;m trying to achieve is to make an text extraction class by extending PDFTextStreamEngine class. To make this, I edited the source to make the class public and extending it in a way PDFTextStripper does. Perhaps, it is not intended for such extensions, and that&apos;s the source of the problem, though I don&apos;t see a reason, why it should be. Unfortunately using PDFTextStripper is a costly option for me.&lt;/p&gt;

&lt;p&gt;2. Current height calculation as of trunk is performed by the following code:&lt;br/&gt;
// 1/2 the bbox is used as the height todo: why?&lt;br/&gt;
float glyphHeight = bbox.getHeight() / 2;&lt;br/&gt;
...&lt;br/&gt;
// transformPoint from glyph space -&amp;gt; text space&lt;br/&gt;
float height = font.getFontMatrix().transformPoint(0, glyphHeight).y;&lt;br/&gt;
...&lt;br/&gt;
float dyDisplay = height * textRenderingMatrix.getScalingFactorY();&lt;br/&gt;
So I assume that dyDisplay which is used to as maxHeight parameter to TextPosition is bbox-based.&lt;/p&gt;

&lt;p&gt;3. I use my own visualization tool similar to the one you&apos;ve described to draw the boxes, the maxHeight is constant at about 1/2 of width. I will do the procedure with DrawPrintTextLocations later as you request, and report it&apos;s result later&lt;/p&gt;

&lt;p&gt;4. The issue may be somehow related to &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1001&quot; title=&quot;TextPosition.getHeight() returns erroneous value for some PDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1001&quot;&gt;&lt;del&gt;PDFBOX-1001&lt;/del&gt;&lt;/a&gt; (regression?), the file I&apos;m dealing with uses the same generator. At least it pointed me to the place of code where to try to make the workaround. The PDF file, if of any interest, may be obtained here: &lt;a href=&quot;http://www.micex.ru/file/151022/MarketT_140815.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.micex.ru/file/151022/MarketT_140815.pdf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5. My workaround is not intended as a patch, it&apos;s only the way to get the correct heights for the PDF files I&apos;m dealing with. I&apos;m not suggesting it for a merge. It is an adaptation of the way the height was calculated in 1.8 branch. It is probable that I misunderstand something about what maxHeight should contain.&lt;/p&gt;</comment>
                            <comment id="15074889" author="tilman" created="Wed, 30 Dec 2015 10:00:23 +0000"  >&lt;p&gt;The file from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1001&quot; title=&quot;TextPosition.getHeight() returns erroneous value for some PDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1001&quot;&gt;&lt;del&gt;PDFBOX-1001&lt;/del&gt;&lt;/a&gt; works fine with DrawPrintTextLocations (i.e. the marks are as expected), but your own file does have problems so I won&apos;t close this issue now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The red marks are too small, and the blue ones are completely wrong, probably because of the rotation. I&apos;ll need to compare this with 1.8 and/or find out why this is so small, and fix DrawPrintTextLocations, and then we&apos;ll see... (Sometimes bad red marks come from incorrect data in the PDF itself)&lt;/p&gt;

&lt;p&gt;I&apos;ll be busy with other stuff today, so be patient. And if you do write your own text extraction, compare it with the existing tests if you intend to extract on different types of files.&lt;/p&gt;</comment>
                            <comment id="15074911" author="elel" created="Wed, 30 Dec 2015 10:24:45 +0000"  >&lt;p&gt;I&apos;m not sure, but I think the problem is because of different PDFTextStreamEngine&apos;s class dyDisplay and TextPosition&apos;s maxHeight semantics. As per Andreas Lehmk&#252;hler&apos;s comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1001&quot; title=&quot;TextPosition.getHeight() returns erroneous value for some PDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1001&quot;&gt;&lt;del&gt;PDFBOX-1001&lt;/del&gt;&lt;/a&gt;, they probably should be contained in different fields and not their usage should not be mixed up: &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1001?focusedCommentId=13059335&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13059335&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PDFBOX-1001?focusedCommentId=13059335&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13059335&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;maxHeight is used by getHeight() method in TextPosition which is described as &quot;This will get the maximum height of all characters in this string.&quot; in JavaDoc, but it is not populated with the font height, but with vertical delta.&lt;/p&gt;

&lt;p&gt;I will surely try to port the existing test to my extraction engine, but as of now it is not trivial, as they have to be ported to my interface. I&apos;m writing that in Clojure and some sort of work on adapter will be needed to compare the results of existing PDFTextStripper-based test results to PDFStreamEngine-Clojure-extended test results.&lt;/p&gt;</comment>
                            <comment id="15074949" author="elel" created="Wed, 30 Dec 2015 11:26:32 +0000"  >&lt;p&gt;Example of text extraction from my engine with my suggested workaround. This comes from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3038&quot; title=&quot;Text extraction shows glyphs with zero height&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3038&quot;&gt;&lt;del&gt;PDFBOX-3038&lt;/del&gt;&lt;/a&gt;-001033-p2.pdf. The red boxes show the clusters of TextPosition, their height is the maximum height of all TextPositions in cluster. The original test with my workaround applied fails, returning &quot;I&quot; and &quot;Introduction&quot; as a single line, while expecting it to be only &quot;I&quot;. My extraction engine handles the case according to the expected data in the original test, as can be seen from screenshot.&lt;/p&gt;</comment>
                            <comment id="15074951" author="jira-bot" created="Wed, 30 Dec 2015 11:29:56 +0000"  >&lt;p&gt;Commit 1722316 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1722316&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1722316&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3175&quot; title=&quot;PDFTextStreamEngine probably miscalculates text height&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3175&quot;&gt;&lt;del&gt;PDFBOX-3175&lt;/del&gt;&lt;/a&gt;: adjust transform for rotated pages&lt;/p&gt;</comment>
                            <comment id="15074955" author="tilman" created="Wed, 30 Dec 2015 11:30:59 +0000"  >&lt;p&gt;DrawPrintTextLocations output of page 1 of your file with red and blue marks (red marks too small, but blue marks might be what you&apos;re looking for)&lt;/p&gt;</comment>
                            <comment id="15075016" author="tilman" created="Wed, 30 Dec 2015 13:12:27 +0000"  >&lt;p&gt;The red marks with 1.8. Glyphs are missing, because rendering doesn&apos;t work properly for that file in 1.8. But it shows that the heights are bigger there. The strategy in guessing the height has changed between 1.8 and 2.0, see some discussion about this at the bottom of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3062&quot; title=&quot;Text extraction and height different in 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3062&quot;&gt;&lt;del&gt;PDFBOX-3062&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Btw the text extraction of your file works fine in 2.0 despite the bad height calculations. The height is only relevant to decide whether texts on different y coordinates should belong to the same line or not. A height that is too small would mean that small differences (e.g. superscript / subscript) result in text lines being splitted.&lt;/p&gt;</comment>
                            <comment id="15075072" author="elel" created="Wed, 30 Dec 2015 14:42:11 +0000"  >&lt;p&gt;I&apos;ve read the discussion of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3062&quot; title=&quot;Text extraction and height different in 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3062&quot;&gt;&lt;del&gt;PDFBOX-3062&lt;/del&gt;&lt;/a&gt; and it is not clear to me, what should I use in cases like with this file, i.e. when the 2.0 way of height calculation fails, but the correct value can be obtained by the calculation in the suggested workaround. Should we consider such files &quot;bad&quot; and to process them I need to make the calculation on the callee-side (ignore TextPosition.getHeight(), obtain Font, obtain bbox from it, multiply height by fontSize and scaling factor)? Or should some heuristics be applied in PDFTextStreamEngine, which detects these files and uses the workaround calculation only in cases when the detection is triggered, so a patch is needed? For me any of the two options is ok, I can continue using PDFBox&apos;s fork with my fixes for the project. But I would like to know the &quot;official&quot; way, since it&apos;s affects how to continue with my project.&lt;/p&gt;

&lt;p&gt;Just to explain myself clearer, I&apos;m not trying to do the &quot;text extraction&quot; as it is done by extending PdfTextStripper. In particular, I&apos;m not interested in the order Pdfbox returns the TextPositions or how it joins them into single lines, and all the &quot;writer&quot; operations PdfTextStripper does. I&apos;m only interested in a stream of raw TextPositions with correct dimension info and extend directly PDFTextStreamEngine. My algorithm uses an alternative approach to join TextPositions itself. Is it a wrong way to do it? PDFTextStreamEngine for some reason is not declared public in the sources. &lt;/p&gt;</comment>
                            <comment id="15075147" author="tilman" created="Wed, 30 Dec 2015 16:11:06 +0000"  >&lt;p&gt;I can&apos;t tell you what heuristics you should use... the existing ones (both in PDFTextStreamEngine for metrics, and in PDFTextStripper for decision what is a word / line) seem to work. That&apos;s the &quot;official&quot; way. We&apos;re open source, so you can either change the whole source code, or extend your own PDFTextStreamEngine.&lt;/p&gt;

&lt;p&gt;IIRC the reason PDFTextStreamEngine isn&apos;t extendable is because the weird calculations we do are only for PDFTextStripper.&lt;/p&gt;

&lt;p&gt;To get really accurate glyph sizes, you&apos;d have to get the path from a glyph and then get the bounding box. There is no example for this yet (but it can be done), it is something we&apos;re thinking about for 2.1.&lt;/p&gt;

&lt;p&gt;In the meantime I may have found the problem, and the solution is similar to yours but at another place, it is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2508&quot; title=&quot;Text extraction getting zero font height, bad widths, and ? for text in this PDF with Type 3 Fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2508&quot;&gt;&lt;del&gt;PDFBOX-2508&lt;/del&gt;&lt;/a&gt; and analog to [ &lt;a href=&quot;https://svn.apache.org/r1711701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1711701&lt;/a&gt; ]. I.e. the suspicious line is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; height = font.getFontMatrix().transformPoint(0, glyphHeight).y;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This should be done only for type 3 fonts this way. For all others it is 1/1000. (I was wondering why I didn&apos;t get bigger red marks even if I hardcoded to use &lt;tt&gt;glyphHeight = capHeight&lt;/tt&gt;, but got correct blue marks in the DrawPrint tool).&lt;/p&gt;</comment>
                            <comment id="15075162" author="jira-bot" created="Wed, 30 Dec 2015 16:28:21 +0000"  >&lt;p&gt;Commit 1722375 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1722375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1722375&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3175&quot; title=&quot;PDFTextStreamEngine probably miscalculates text height&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3175&quot;&gt;&lt;del&gt;PDFBOX-3175&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2508&quot; title=&quot;Text extraction getting zero font height, bad widths, and ? for text in this PDF with Type 3 Fonts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2508&quot;&gt;&lt;del&gt;PDFBOX-2508&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3062&quot; title=&quot;Text extraction and height different in 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3062&quot;&gt;&lt;del&gt;PDFBOX-3062&lt;/del&gt;&lt;/a&gt;: fix height calculations analog to rev 1711701, font matrix is to be used only for type3 fonts&lt;/p&gt;</comment>
                            <comment id="15075185" author="tilman" created="Wed, 30 Dec 2015 16:45:05 +0000"  >&lt;p&gt;None of the official test files are different with the latest commit, but these files of mine:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2996&quot; title=&quot;StackOverflow in Quicksort&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2996&quot;&gt;&lt;del&gt;PDFBOX-2996&lt;/del&gt;&lt;/a&gt;.pdf - two lines now together that were very close&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3110&quot; title=&quot;Extract by beads doesn&amp;#39;t work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3110&quot;&gt;&lt;del&gt;PDFBOX-3110&lt;/del&gt;&lt;/a&gt;-003422-p1-beads.pdf - four subscript / superscript now in same line&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-679&quot; title=&quot;Corruption of Arabic output due to Japanese bug fix&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-679&quot;&gt;&lt;del&gt;PDFBOX-679&lt;/del&gt;&lt;/a&gt;-toobig.pdf - several differences in the sorted output only I can&apos;t tell whether better or not (arabic).&lt;/li&gt;
	&lt;li&gt;Extraction of 005021.pdf (of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3062&quot; title=&quot;Text extraction and height different in 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3062&quot;&gt;&lt;del&gt;PDFBOX-3062&lt;/del&gt;&lt;/a&gt;) now identical to 1.8.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The commit doesn&apos;t have to be done for 1.8 - the earlier 1.8 commit [ &lt;a href=&quot;https://svn.apache.org/r1711714&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1711714&lt;/a&gt; ] applies to width and height. It&apos;s the 2.0 commit that was incomplete.&lt;/p&gt;</comment>
                            <comment id="15075262" author="tilman" created="Wed, 30 Dec 2015 18:00:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3175&quot; title=&quot;PDFTextStreamEngine probably miscalculates text height&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3175&quot;&gt;&lt;del&gt;PDFBOX-3175&lt;/del&gt;&lt;/a&gt;-reduced.pdf is a reduced version of your file I used for debugging.&lt;/p&gt;</comment>
                            <comment id="15075872" author="elel" created="Thu, 31 Dec 2015 09:51:02 +0000"  >&lt;p&gt;Commit 1722375 almost fixes the issue with getHeight(), the returned height is exactly 1/2 of the actual. The offending lines left in PDFTextStreamEngine are:&lt;/p&gt;

&lt;p&gt;// 1/2 the bbox is used as the height todo: why?&lt;br/&gt;
float glyphHeight = bbox.getHeight() / 2;&lt;/p&gt;

&lt;p&gt;Removing the division by 2 makes call to TextPosition almost identical to 1.8 style behavior. The only difference I notice, is that the height is also adjusted by Font descent (previously, the top left corner of the glyph box had to be calculated as: pos = y - getHeight() + (fontDescent * fontSize * 0.001; now: pos = y - getHeight())&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="15075881" author="tilman" created="Thu, 31 Dec 2015 10:21:56 +0000"  >&lt;p&gt;I get this result with both PrintTextLocations examples on the &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3175&quot; title=&quot;PDFTextStreamEngine probably miscalculates text height&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3175&quot;&gt;&lt;del&gt;PDFBOX-3175&lt;/del&gt;&lt;/a&gt;-reduced.pdf file:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[400.0,200.0 fs=20.0 xscale=20.0 height=11.2 space=5.5200005 width=16.200012]M
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[416.2,200.0 fs=20.0 xscale=20.0 height=11.2 space=5.5200005 width=5.1600037]I
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[421.36002,200.0 fs=20.0 xscale=20.0 height=11.2 space=5.5200005 width=14.480011]C
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[435.84003,200.0 fs=20.0 xscale=20.0 height=11.2 space=5.5200005 width=13.440002]E
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[449.28003,200.0 fs=20.0 xscale=20.0 height=11.2 space=5.5200005 width=12.76001]X
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You wrote that&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Removing the division by 2 makes call to TextPosition almost identical to 1.8 style behavior&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What value is different for you? Note that this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// 1/2 the bbox is used as the height todo: why?
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; glyphHeight = bbox.getHeight() / 2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is the intended behavior at this time. Yes it looks weird, but it is a good value to help identify lines that go together. If you don&apos;t like it, use the solution for the blue marks in DrawPrintTextLocations, that uses the bounding box only with no heuristics and no adjustment of &quot;wild&quot; values.&lt;/p&gt;</comment>
                            <comment id="15075885" author="elel" created="Thu, 31 Dec 2015 10:32:15 +0000"  >&lt;p&gt;The values are probably correct for PDFTextStripper class usage. I thought that clustering TextPosition into lines is not a concern of PDFTextStreamEngine, but of concern of PDFTextStripper class. So if a particular extention of PDFTextStreamEngine class needs the coordinates to be divided by 2 it does not mean that every other possible extention will also need them to be divided. I think that particular line of code belongs to the part where line calculations are done, not where the character stream is produced. Maybe it should be just moved to PDFTextStripper?&lt;/p&gt;

&lt;p&gt;That all said, of course, if I understand correctly the point of architecturing the two classes as separate.&lt;/p&gt;</comment>
                            <comment id="15075896" author="tilman" created="Thu, 31 Dec 2015 11:07:16 +0000"  >&lt;p&gt;Your argument &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;clustering TextPosition into lines is not a concern of PDFTextStreamEngine, but of concern of PDFTextStripper class&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;is of course correct, i.e. that all the &quot;voodoo&quot; should be in PDFTextStripper only and PDFTextStreamEngine should have only hard, realistic data. But this would also mean that TextPosition would return different data than in 1.8, which would be a problem for many users. (We found our bugs in the text extraction thanks to people who noticed the values from the PrintTextLocations were different, and this includes you) See also the first comment by John in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3062&quot; title=&quot;Text extraction and height different in 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3062&quot;&gt;&lt;del&gt;PDFBOX-3062&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15075899" author="elel" created="Thu, 31 Dec 2015 11:17:59 +0000"  >&lt;p&gt;If the 1/2 thing is not removed, but just moved to PDFTextStripper class, as I suggest, the people who use PDFTextStripper class will continue to get the exact same values of TextPosition as they get now. There won&apos;t be any break of output of PDFTextStreamEngine for 1.8 users because it did not exist at the time, and because I&apos;m probably it&apos;s only user, since it is currently package-private in the trunk. But it would be a huge advantage for people, who start using the new PDFTextStreamEngine, if it is decided to be declared public officially (I opened a new issue with suggestion for that): they won&apos;t ever start using it with wrong values.&lt;br/&gt;
Moreover, accoring to the docs of TextPosition getHeight() both in 1.8 2.0 it should return &quot;This will get the maximum height of all characters in this string.&quot; Obviously, currently it returns 1/2 of that height which is a break of API description.&lt;/p&gt;</comment>
                            <comment id="15075907" author="tilman" created="Thu, 31 Dec 2015 11:34:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If the 1/2 thing is not removed, but just moved to PDFTextStripper class, as I suggest, the people who use PDFTextStripper class will continue to get the exact same values of TextPosition as they get now. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But the people who use the TextPosition would get the double values, see in PrintTextLocations.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Moreover, according to the docs of TextPosition getHeight() both in 1.8 2.0 it should return &quot;This will get the maximum height of all characters in this string.&quot; Obviously, currently it returns 1/2 of that height which is a break of API description.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ouch. Yes, that API doc is incorrect, and I don&apos;t have a good replacement text idea. Even if we&apos;d return the double, it would still be incorrect, because the bounding box height is often bigger than the actual glyphs height. So at this time, we try to do everything as in 1.8.&lt;/p&gt;

&lt;p&gt;After releasing 2.0 there should probably be a refactoring that&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;returns the actual height by getting it from the glyph paths if somebody wants it&lt;/li&gt;
	&lt;li&gt;returns the vodoo values if they are needed&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15075915" author="elel" created="Thu, 31 Dec 2015 11:56:38 +0000"  >&lt;p&gt;PrintTextLocation uses PDFTextStripper as i judge by &quot;public class PrintTextLocations extends PDFTextStripper&quot; line. TextLocations produced by PDFTextStripper will continue to be 1/2 as they are now if we move that division to PDFTextStripper class. At the same time PDFTextStreamEngine class will be free of the 1/2 miscalculation. We just move that 1/2 line from constructor call in PDFStreamTextEngine to PDFTextStripper. Under this scenario no changes for the current users of PDFTextStripper class will be visible. I&apos;m not sure how easily that line could be integrated, PDFTextStripper is very messy. But I think it&apos;s the only way to keep the compatibility for the old erroneous value users and return correct data according the original API design.&lt;br/&gt;
As for the docstring, I don&apos;t think backfitting the API design to an obviously erroneous behavior is a good idea. The getHeight() should return what it says it returns, the height. &lt;/p&gt;

&lt;p&gt;By the way, I can&apos;t find the equivalent of division by 2 line in 1.8 branch. Was it introduced into that place of PDFTextStreamEngine as a hotfix to comply with TextPosition values of 1.8? If so, PDFTextStreamEngine&apos;s location of that line is probably not the place, where in 1.8 that 1/2 coefficient was introduced at all.&lt;/p&gt;</comment>
                            <comment id="15075933" author="tilman" created="Thu, 31 Dec 2015 13:23:49 +0000"  >&lt;p&gt;See in PDSimpleFont.getFontHeight(). Will answer the rest tomorrow (it&apos;s party time!).&lt;/p&gt;</comment>
                            <comment id="15076270" author="tilman" created="Fri, 1 Jan 2016 10:40:57 +0000"  >&lt;p&gt;But both PDFTextStreamEngine and PDFTextStripper have TextLocation objects. If we don&apos;t divide it by 2, then these TextLocation would appear on top of PDFTextStripper, for the people who extend that one to get the positions. (And as you, PDFTextStreamEngine won&apos;t be made public). The other reason that that the font bbbox / 2 is not always the &quot;height&quot; that is stored, sometimes it is a different value from the font descriptor (see in the source code, at the comment &quot;sometimes the bbox has very high values, but CapHeight is OK&quot;).&lt;/p&gt;

&lt;p&gt;You can see what I mean by making the change you think about and then running the tests, and also compare the output of DrawPrintTextLocations to the previous output.&lt;/p&gt;

&lt;p&gt;I&apos;d like to set this issue to resolved and end this discussion which is rather something for 2.1. I do get your point that the current structure is weird, and the API doc incorrect. But just removing the &quot;/ 2&quot; and making one class public isn&apos;t the magic solution. But you (and Ben McCann) are welcome to help with code, ideas or criticism to build a better text extraction in the future.&lt;/p&gt;

&lt;p&gt;I suspect that the structure should be 3-part, i.e. a &quot;pure&quot; PDFStreamTextEngine without any hacks, a new class that does the heuristics to get the height and also offers exact heights if needed, and an improved PDFTextStripper that fixes the problems that Ben McCann mentioned in several issues.&lt;/p&gt;</comment>
                            <comment id="15076647" author="jahewson" created="Sat, 2 Jan 2016 19:51:25 +0000"  >&lt;p&gt;Please note that PDFTextStreamEngine &lt;em&gt;deliberately&lt;/em&gt; miscalculates text bounds, for legacy reasons of maintaining compatibility with PDFTextStripper. No other code should be using this class - we&apos;ve provided PDFStreamEngine for this purpose, which performs the correct calculations. You can see an example of creating a custom subclass &lt;a href=&quot;https://github.com/apache/pdfbox/blob/trunk/examples/src/main/java/org/apache/pdfbox/examples/rendering/CustomGraphicsStreamEngine.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;ve read the discussion of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3062&quot; title=&quot;Text extraction and height different in 2.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3062&quot;&gt;&lt;del&gt;PDFBOX-3062&lt;/del&gt;&lt;/a&gt; and it is not clear to me, what should I use in cases like with this file, i.e. when the 2.0 way of height calculation fails, but the correct value can be obtained by the calculation in the suggested workaround. Should we consider such files &quot;bad&quot; and to process them I need to make the calculation on the callee-side (ignore TextPosition.getHeight(), obtain Font, obtain bbox from it, multiply height by fontSize and scaling factor)? Or should some heuristics be applied in PDFTextStreamEngine, which detects these files and uses the workaround calculation only in cases when the detection is triggered, so a patch is needed? For me any of the two options is ok, I can continue using PDFBox&apos;s fork with my fixes for the project. But I would like to know the &quot;official&quot; way, since it&apos;s affects how to continue with my project.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There&apos;s nothing bad about such PDFs - the bbox is simply a box larger than the glyphs in the font - there&apos;s no requirement that it&apos;s the smallest such box. PDFBox should not be using this heuristic at all, but as mentioned, we do so for legacy compatibility. If you want accurate bounding boxes, we have 100% perfect bounds available by inspecting the vector outlines of the glyphs themselves - PDFTextStream doesn&apos;t do this, but we have &lt;a href=&quot;https://github.com/apache/pdfbox/blob/trunk/examples/src/main/java/org/apache/pdfbox/examples/rendering/CustomPageDrawer.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;an example&lt;/a&gt; which does. Take a look at that. PDFBox includes all the pieces to get perfect glyph bounds, we just don&apos;t use them ourselves yet.&lt;/p&gt;</comment>
                            <comment id="15076653" author="elel" created="Sat, 2 Jan 2016 20:17:11 +0000"  >&lt;p&gt;I understand that this miscalculation is deliberate. Still these values are not used only by PDFTextStripper but by any class that subclasses PDFTextStripper as well. According to API docs of getHeight() method, the TextPosition structure should return some height: bounding box or the largest glyph - it does not matter which exactly, compared to what it returns now, 1/2 of the bounding box which is not close to any of the interpretation of a &quot;height&quot;. Or does PDFTextStripper, having received it&apos;s 1/2 heights, patch the TextPositions with doubled values?&lt;br/&gt;
I personally don&apos;t have anything against these hotfixes. But imagine such situation (in fact it was the path I walked): someone needs to process PDF file characterwise and needs some adequate height info. She googles for a solution, and since the instructions on the web all talk about extending PDFTextStripper for that, follows the way. The result is not ok, the heights are wrong, though the Javadoc about TextPosition structure confirms her understanding. Then she makes all the way digging PDFTextStripper up to PDFStreamEngine just to discover that it returns TextPositions that do not comply with API docs.&lt;br/&gt;
For me, now that I&apos;ve already done everything of the above, it&apos;s not a problem to write a solution, which I did. But if the thing is not fixed somehow, other people would need to repeat this source code digging each time.&lt;/p&gt;

&lt;p&gt;And if PDFTextStripper is not intended to be extended at all, it should be marked as such, just as it is the case with PDFTextStreamEngine now.&lt;/p&gt;</comment>
                            <comment id="15076742" author="jahewson" created="Sun, 3 Jan 2016 01:19:40 +0000"  >&lt;p&gt;The whole 1/2 bbox thing is just how PDFStreamEngine used to work in 1.8, and PDFTextStreamEngine emulates that behaviour for compatibility for subclasses that need it. It&apos;s obviously not an accurate height but it&apos;s also not a terrible approximation of height - the bbox is often around 2x the em height, so halving it gives values which approximate the em height (for the entire font thought, not a single glyph). The whole PDFTextStripper API has all of these incorrect assumptions built into it and really needs to be thrown away - but until that happens we&apos;re stuck with what we have.&lt;/p&gt;

&lt;p&gt;We&apos;ve historically supported subclassing PDFTextStripper, so we can&apos;t remove it without breaking other&apos;s code, and we don&apos;t currently offer an alternative. Personally I don&apos;t think PDFTextStripper should be kept around for much longer - for all its complexity it achieves very little. Whatever replaces PDFTextStripper will simply subclass PDFStreamEngine directly.&lt;/p&gt;</comment>
                            <comment id="15086266" author="tilman" created="Wed, 6 Jan 2016 20:57:38 +0000"  >&lt;p&gt;I&apos;m once again setting this to resolved. The core problem shown in the attached file has been solved and also resulted in being able to set another issue to resolved. That the text height passed currently is not the real height has been discussed here and elsewhere, and we&apos;re aware of this. It will possibly being taken care of in a redesign of text extraction in the future.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12907997">PDFBOX-3062</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12756309">PDFBOX-2508</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12779979" name="MarketT_140815-1-marked-1-18.png" size="90048" author="tilman" created="Wed, 30 Dec 2015 13:12:27 +0000"/>
                            <attachment id="12779958" name="MarketT_140815-1-marked-1.png" size="521676" author="tilman" created="Wed, 30 Dec 2015 11:30:59 +0000"/>
                            <attachment id="12780019" name="PDFBOX-3175-reduced.pdf" size="14301" author="tilman" created="Wed, 30 Dec 2015 18:00:05 +0000"/>
                            <attachment id="12779956" name="snapshot.png" size="101935" author="ElEl" created="Wed, 30 Dec 2015 11:26:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2qdzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>