<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:14:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-5731] org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-5731</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065115/13065115_image-2023-12-08-16-02-12-293.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065116/13065116_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13561107">PDFBOX-5731</key>
            <summary>org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="lycheng">liu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Dec 2023 08:02:16 +0000</created>
                <updated>Sat, 6 Jan 2024 15:54:12 +0000</updated>
                                            <version>2.0.30</version>
                    <version>3.0.1 PDFBox</version>
                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17794573" author="JIRAUSER297279" created="Fri, 8 Dec 2023 08:06:18 +0000"  >&lt;p&gt;1. I feel that this cache is not very useful. It is better to put it in the ResourceCache of each PDDocument.&lt;br/&gt;
2. Or learn from and switch to spring&#8217;s ConcurrentReferenceHashMap.&lt;/p&gt;</comment>
                            <comment id="17794606" author="tilman" created="Fri, 8 Dec 2023 09:30:19 +0000"  >&lt;p&gt;Yes, I suspect that this might grow forever if many PDFs are opened that have random COSNames.&lt;/p&gt;

&lt;p&gt;Is your screenshot from running PDFBox for months or did you provoke this by creating the situation I mentioned?&lt;/p&gt;

&lt;p&gt;I think that the cache is needed so that identical names turn into the same object.&lt;/p&gt;</comment>
                            <comment id="17794609" author="JIRAUSER297279" created="Fri, 8 Dec 2023 09:33:00 +0000"  >&lt;p&gt;Continuous operation for 2 months&lt;/p&gt;</comment>
                            <comment id="17794610" author="JIRAUSER297279" created="Fri, 8 Dec 2023 09:34:02 +0000"  >&lt;p&gt;Can it be solved if it is changed to spring&apos;s ConcurrentReferenceHashMap?&lt;/p&gt;</comment>
                            <comment id="17794611" author="JIRAUSER297279" created="Fri, 8 Dec 2023 09:36:44 +0000"  >&lt;p&gt;In fact, it is also good to put it in ResourceCache of each PDDocument.&lt;/p&gt;</comment>
                            <comment id="17794615" author="tilman" created="Fri, 8 Dec 2023 09:48:41 +0000"  >&lt;p&gt;No: &quot;The use of references means that there is no guarantee that items placed into the map will be subsequently available.&quot;&lt;/p&gt;

&lt;p&gt;Changing this will be tricky, &lt;tt&gt;COSName.getPDFName(key)&lt;/tt&gt; is widely used at places where neither resourceCache or PDDocument is available.&lt;/p&gt;</comment>
                            <comment id="17794617" author="JIRAUSER297279" created="Fri, 8 Dec 2023 09:54:15 +0000"  >&lt;p&gt;We have not used COSName.getPDFName(key) separately, only PDDocument, but such a design will still cause memory leaks.I think this cannot be confused.It is wasteful to save the COSName of other pdfs.&lt;/p&gt;</comment>
                            <comment id="17794645" author="mkl" created="Fri, 8 Dec 2023 11:32:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think that the cache is needed so that identical names turn into the same object.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Maybe that design choice should be reconsidered.&lt;/p&gt;

&lt;p&gt;But maybe the proposed replacement map type (or a similar one) would be ok. If that type works sensibly, entries only are removed if there is no hard link to the name in question anymore. In that case dropping the entry and later creating a new name object for the same name wouldn&apos;t hurt as there are no instances of the old name object to compare to anymore.&lt;/p&gt;</comment>
                            <comment id="17795293" author="JIRAUSER297279" created="Mon, 11 Dec 2023 11:19:04 +0000"  >&lt;p&gt;hi&#65281;Is there any error that occurs when I execute COSName.clearResources() when using PDFBox to convert an image or add a watermark? When is it safe to execute COSName.clearResources()?&lt;/p&gt;</comment>
                            <comment id="17795559" author="JIRAUSER297279" created="Tue, 12 Dec 2023 01:47:03 +0000"  >&lt;p&gt;This memory leak problem seems to be similar.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4290&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PDFBOX-4290&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17795593" author="lehmi" created="Tue, 12 Dec 2023 05:41:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;hi&#65281;Is there any error that occurs when I execute COSName.clearResources() when using PDFBox to convert an image or add a watermark? When is it safe to execute COSName.clearResources()?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That method is what you are looking for. You may want to call &lt;tt&gt;COSName.clearResources()&lt;/tt&gt; from time to time to clear the cache as the exactly as the javadoc proposes for long running environment. The underlying map is synchonized so that you should not call the method to often to avoid dead locks&lt;/p&gt;</comment>
                            <comment id="17795600" author="JIRAUSER297279" created="Tue, 12 Dec 2023 05:59:16 +0000"  >&lt;p&gt;I can&apos;t tell when pdfbox will be called to process pdf. If this method&#65288;COSName.clearResources()&#65289; is called during the process of using pdfbox to process pdf, this may cause that identical names turn into the same object.Will this cause any problems?&lt;/p&gt;</comment>
                            <comment id="17795610" author="lehmi" created="Tue, 12 Dec 2023 06:38:22 +0000"  >&lt;p&gt;It is safe to call it any time, as equals compares the underlying strings of COSName values.&lt;/p&gt;</comment>
                            <comment id="17795611" author="JIRAUSER297279" created="Tue, 12 Dec 2023 06:42:43 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065233/13065233_screenshot-2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065234/13065234_screenshot-3.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
These don&apos;t seem to guarantee safety.&lt;/p&gt;</comment>
                            <comment id="17795623" author="lehmi" created="Tue, 12 Dec 2023 07:20:30 +0000"  >&lt;p&gt;I didn&apos;t get your point. The following test demonstrates how the cache works&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    void checkCache()
    {
        COSName nameBlubb1 = COSName.getPDFName(&lt;span class=&quot;code-quote&quot;&gt;&quot;blubb&quot;&lt;/span&gt;);
        COSName nameBlubb2 = COSName.getPDFName(&lt;span class=&quot;code-quote&quot;&gt;&quot;blubb&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;// due to the underlying cache nameBlubb1 and nameBlubb2 share the same instance
&lt;/span&gt;        assertTrue(nameBlubb1 == nameBlubb2);
        assertEquals(nameBlubb1, nameBlubb2);
        &lt;span class=&quot;code-comment&quot;&gt;// clear the cache
&lt;/span&gt;        COSName.clearResources();
        &lt;span class=&quot;code-comment&quot;&gt;// blubb1 and blubb2 still share the same instances and therefore are still identical
&lt;/span&gt;        assertTrue(nameBlubb1 == nameBlubb2);
        assertEquals(nameBlubb1, nameBlubb2);
        &lt;span class=&quot;code-comment&quot;&gt;// get another COSName value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;blubb&quot;&lt;/span&gt;
&lt;/span&gt;        COSName nameBlubb3 = COSName.getPDFName(&lt;span class=&quot;code-quote&quot;&gt;&quot;blubb&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;// nameBlubb3 is another instance of COSName &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the value &lt;span class=&quot;code-quote&quot;&gt;&quot;blubb&quot;&lt;/span&gt;
&lt;/span&gt;        assertFalse(nameBlubb1 == nameBlubb3);
        &lt;span class=&quot;code-comment&quot;&gt;// both instances are still equal as the underlying strings have equal values
&lt;/span&gt;        assertEquals(nameBlubb1, nameBlubb3);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;IMHO everything is fine&lt;/p&gt;</comment>
                            <comment id="17795630" author="JIRAUSER297279" created="Tue, 12 Dec 2023 07:32:14 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065242/13065242_screenshot-4.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
Will this cause problems with the content?&lt;/p&gt;</comment>
                            <comment id="17795635" author="JIRAUSER297279" created="Tue, 12 Dec 2023 08:05:32 +0000"  >&lt;p&gt;Can you help confirm this solution:&lt;br/&gt;
If I start a scheduled task every 10 seconds to detect, if I find that the map is larger than 1000000, call COSName.clearResources() to clean it up, there won&#8217;t be any problems, right?&lt;/p&gt;</comment>
                            <comment id="17795901" author="lehmi" created="Tue, 12 Dec 2023 19:11:56 +0000"  >&lt;p&gt;That should work, but I&apos;m not sure if an interval of 10 seconds is really necessary.  &lt;/p&gt;</comment>
                            <comment id="17795969" author="JIRAUSER297279" created="Wed, 13 Dec 2023 01:29:35 +0000"  >&lt;p&gt;Thank you, I will use this solution for the time being and hope that PDFbox can be optimized better.&lt;/p&gt;</comment>
                            <comment id="17796016" author="axh" created="Wed, 13 Dec 2023 06:01:24 +0000"  >&lt;p&gt;Hi, I&apos;d like to tackle this as I might run into similar issues with my software. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; can you provide some minimal code to expose the problem? Maybe a couple of PDFs that you have that lead to OOM when loaded one after the other from the same process (could reduce -Xmx to trigger OOM earlier). I&apos;d then try to reproduce and create a patch that solves this.&lt;/p&gt;</comment>
                            <comment id="17796027" author="JIRAUSER297279" created="Wed, 13 Dec 2023 06:36:14 +0000"  >&lt;p&gt;As long as COSName.getPDFName is called, a value will be recorded to org.apache.pdfbox.cos.COSName#nameMap, and there is no place in pdfbox to actively or release the useless values &#8203;&#8203;in it.&lt;/p&gt;

&lt;p&gt;This will cause the jvm to store some data that is irrelevant to the usage scenario.&lt;/p&gt;

&lt;p&gt;Such as font-related keywords used in other scenarios.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065274/13065274_screenshot-5.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;But these things are actually not what I need for my current PDF.&lt;/p&gt;

&lt;p&gt;For example, the scenario of using pdf to convert images:&lt;br/&gt;
pdfA has a keyword COSName called COSName1. When we use pdfbox to convert pdfA into a picture, COSName.nameMap will permanently record COSName1.&lt;/p&gt;

&lt;p&gt;When converting to pdfB, pdfB does not have COSName1. In fact, during the process of converting to pdfB, COSName1 is not needed at all. But there will still be COSName1 in the jvm, which is a memory leak.&lt;/p&gt;</comment>
                            <comment id="17796052" author="axh" created="Wed, 13 Dec 2023 08:04:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; I have created a patch for current trunk. Could you please try it out?&lt;/p&gt;

&lt;p&gt;What it does: I replaced nameMap and commonNameMap by a Map that holds WeakReference instances to values (we cannot use a WeakHashMap since that one holds weak keys instead). The clearResources() method is automatically invoked every time a new COSName instance is created (that is, if it is not yet present in the cache). This step is necessary, because the problem with unused COSName instances is that they hold a reference to their key. That means, the bulk of memory can only be released, if the string used as key can also be GCed.&lt;/p&gt;

&lt;p&gt;Using a WeakHashMap would not help here because weak references to keys would not become stale unless the value is removed, which will not happen before the key is removed etc.&lt;/p&gt;

&lt;p&gt;I have confirmed that unused entries are removed automatically. The instances that were stored in the commonNameMap before are also retained because their references never become stale (because they are defined as constants in COSName).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Calling clearResources manually is still possible but should not be necessary.&lt;/li&gt;
	&lt;li&gt;I also have tried to call clearResources only every 100th time the nameMap is changed but I could see no measurable performance impact, so I removed that code again.&lt;/li&gt;
	&lt;li&gt;I think there should no extra synchronisation be necessary when calling clearResources as IMHO the worst that could happen is that we end up with a couple of extra COSName instances. But this probably needs some more testing.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please let me know if this solves your problem.&lt;/p&gt;

&lt;p&gt;Added patch &quot;attempted_fix_for_&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;__clear_out_unused_COSName_instances_automatically.patch&quot;.&lt;/p&gt;</comment>
                            <comment id="17796094" author="JIRAUSER297279" created="Wed, 13 Dec 2023 09:03:33 +0000"  >&lt;p&gt;Leave commonNameMap as is,&lt;br/&gt;
It would be better to move nameMap to org.apache.pdfbox.pdmodel.DefaultResourceCache.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065284/13065284_image-2023-12-13-17-04-22-073.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17796160" author="axh" created="Wed, 13 Dec 2023 11:06:06 +0000"  >&lt;p&gt;commonNameMap is not needed. Why would you want to keep it? Also using SoftReferences instead of WeakReferences for COSNames seems less than optimal.&lt;/p&gt;</comment>
                            <comment id="17796164" author="JIRAUSER297279" created="Wed, 13 Dec 2023 11:12:20 +0000"  >&lt;p&gt;As a constant, there is no need to increase the burden on the map collection, and it can also reduce the number of traversals during cleaning.&lt;/p&gt;

&lt;p&gt;A pdf corresponds to a pddocument corresponding to the DefaultResourceCache, so that it is best to only cache the keywords of the current pdf.&lt;/p&gt;</comment>
                            <comment id="17796205" author="axh" created="Wed, 13 Dec 2023 11:53:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; But you would spoil the effort to reduce memory consumption because COSName is extremely lightweight. If you create a COSName instance, the name takes up more memory than is added by the COSName instance itself.&lt;/p&gt;

&lt;p&gt;The COSName itself on a 64 bit JVM usually takes exactly 16 bytes. A WeakReference to an object takes 24 bytes, not counting the object it refers to.&lt;/p&gt;

&lt;p&gt;By using the DefaultResourceCache in the way it is implemented now, you would add an overhead of 24 bytes, which is more than you gain when the WeakReference is released. If the key uses 40 bytes, you will have 40 bytes for the key, 24 bytes for the WeakReference, and 16 bytes for the COSName instance. That makes 80 bytes of memory. When the reference gets stale and later collected, 16 bytes used by the COSName instance are released, so you still use 64 bytes.&lt;/p&gt;

&lt;p&gt;If you just store the COSName directly, you use even less memory (56 bytes). And with the patch I provided, the whole 80 bytes will be freed. So I really see no advantage in using the DefaultResourceCache in this case.&lt;/p&gt;

&lt;p&gt;But the worst is in the current implementation of DefaultResourceCache, the string used as the key will stay in memory.&lt;/p&gt;

&lt;p&gt;I don&apos;t know much about the DefaultResourcecache. But if it is allocated per document, it would indeed make sense to move the name map there, but just use a Map&amp;lt;String, COSName&amp;gt;. Then the commonNameMap would stay in COSName, also no WeakReferences needed. The Problem I see is that COSName does not know which instance of DefaultResourceCache should be used. That means all calls to COSName.getPdfName() have to be changed, no matter if you change getPDFName and add a parameter for the cache instance, or make it a method of DefaultResourceCache itself. My IDE tells me that&apos;s 711 calls in the PDFBox codebase alone, and it also would be a breaking change for users.&#160;&lt;/p&gt;

&lt;p&gt;Please try the patch I provided. It&apos;s fully transparent to the rest of the code. If you are worried that the sweeping of the map takes to much time, run a profiler. If it is really a problem, the easiest solution would be to get back the commonNameMap and only put user defined COSName instances into the nameMap to reduce sweep times.&lt;/p&gt;

&lt;p&gt;Last but not least, the radical solution would be to put away COSName completely and just use String instead - it would solve all caching problems at once, but I doubt this would get support from the maintainers.&lt;/p&gt;</comment>
                            <comment id="17796219" author="msahyoun" created="Wed, 13 Dec 2023 12:17:13 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Last but not least, the radical solution would be to put away COSName completely and just use String instead - it would solve all caching problems at once, but I doubt this would get support from the maintainers.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Indeed - COSName represents a PDF type and as such should exist.&lt;/p&gt;</comment>
                            <comment id="17796252" author="JIRAUSER297279" created="Wed, 13 Dec 2023 12:26:45 +0000"  >&lt;p&gt;1&#12289;Keep the original commonNameMap.&lt;br/&gt;
2&#12289;When cleaning, you can use the ReferenceQueue to obtain the gc object and delete the key, such as the java.util.WeakHashMap#expungeStaleEntries method of weakhashmap, which can reduce a lot of invalid traversals.&lt;/p&gt;

&lt;p&gt;You can try this to see if you can get support from the maintainers.&lt;/p&gt;

&lt;p&gt;I personally think that to really solve this problem, we can only cache the COSName of the current PDF scene instead of storing other PDFs, although this change is relatively large.&lt;/p&gt;</comment>
                            <comment id="17796295" author="axh" created="Wed, 13 Dec 2023 14:18:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; I updated the patch. Instead of doing a sweep each time a new COSName instance is created, I use a &lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/Cleaner.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Cleaner&lt;/a&gt; instance to automatically remove the key once the value is garbage collected. This works from Java 9 onwards and looks a lot cleaner (sic!) and easier to maintain than the reference queue.&lt;/p&gt;

&lt;p&gt;I have tested that entries get removed, and while doing so have seen that apparently PDFDebugger has a memory leak because the WeakReferences never went stale (also when sweeping the map manually and even running System.gc() after loading different documents).&lt;/p&gt;

&lt;p&gt;Please try and comment.&lt;/p&gt;</comment>
                            <comment id="17796309" author="axh" created="Wed, 13 Dec 2023 14:41:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; Wait, there&apos;s an oversight. I should use a singleton Cleaner instance. I&apos;ll update the patch once more.&lt;/p&gt;</comment>
                            <comment id="17796332" author="axh" created="Wed, 13 Dec 2023 15:07:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; Ok, this should finally work as expected. Added patch &quot;attempted_fix_for_&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;__clear_out_unused_COSName_instances_automatically_using_cleaner.patch&quot;.&lt;/p&gt;</comment>
                            <comment id="17796509" author="JIRAUSER297279" created="Thu, 14 Dec 2023 01:45:01 +0000"  >&lt;p&gt;I think the logic is a bit strange. Registering for recycling when a certain name is empty seems to have no effect.&lt;/p&gt;

&lt;p&gt;jdk8 does not seem to have Cleaner.create(), register() methods.&lt;/p&gt;

&lt;p&gt;Moreover, Cleaner is generally used for automatic recycling of off-heap memory. Using Cleaner may affect other functions in the system.&lt;/p&gt;

&lt;p&gt;like this&#65306;&lt;br/&gt;
 &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065302/13065302_COSName.java&quot; title=&quot;COSName.java attached to PDFBOX-5731&quot;&gt;COSName.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17796643" author="axh" created="Thu, 14 Dec 2023 09:54:51 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think the logic is a bit strange. Registering for recycling when a certain name is empty seems to have no effect.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t get what you mean here? `name` is the COSName instance. If name is null, it means it&apos;s not in the cache, and we create a new one. The synchronized block makes sure that even when multiple threads try to create identical COSName instances at the same time, only one is created. I used double checked locking to avoid having to make the complete method synchronized.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;jdk8 does not seem to have Cleaner.create(), register() methods.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, exactly. That&apos;s why I wrote &quot;This works from Java 9 onwards&quot; &#160;in the original comment. As PDFBox 3.x requires Java 11, I see no problem with that.&lt;/p&gt;

&lt;p&gt;In Java 8 you had finalize() for this kind of cleanup action, finalize has been deprecated for 6 years now.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Moreover, Cleaner is generally used for automatic recycling of off-heap memory. Using Cleaner may affect other functions in the system.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah, did you get that off ChatGPT? Cleaner has been introduced &lt;em&gt;exactly&lt;/em&gt; for this kind oh cleanup actions. Freeing off-heap memory is just one (and the most common example) for using Cleaner, because the JVM cannot handle that by itself without a user supplied cleanup action. Other use cases are all kinds of resources acquired using JNI calls etc.&lt;/p&gt;

&lt;p&gt;Starting with Java 9, using Cleaner is the recommended way of handling resource cleanup (in cases where automatic resource management with try-with-resources is not possible), see &lt;a href=&quot;https://openjdk.org/jeps/421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JEP 421&lt;/a&gt; for details.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;like this:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Your code essentially re-implements what Cleaner does, just that Cleaner is maintained and tested by the JDK developers. If in doubt, trust the JDK devs to do it right.&lt;/p&gt;

&lt;p&gt;Your code also has the issue that the cleanup is only triggered when a new COSName instance is created. If you have one million COSName instances in your document, then load another document, the map will not be cleaned unless you add a new COSName instance that is different from the million ones you already have.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have changed your test code like this to better see what is going on:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10_000_000; i++) {
            test(&lt;span class=&quot;code-quote&quot;&gt;&quot;123_&quot;&lt;/span&gt;+i);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i%1_000_000==0) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(i+&lt;span class=&quot;code-quote&quot;&gt;&quot;, size=&quot;&lt;/span&gt;+NAME_MAP.size());
            }
        }
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;after loop: &quot;&lt;/span&gt;+NAME_MAP.size());
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc();
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(10_000);
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc(): &quot;&lt;/span&gt;+NAME_MAP.size());
        clearResources();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;after clearResources(): &quot;&lt;/span&gt;+NAME_MAP.size());
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void test(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name){
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; COSName pdfName = COSName.getPDFName(name);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And this is the output I get (using Cleaner):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0, size=570
1000000, size=970902
2000000, size=1883450
3000000, size=2820630
4000000, size=3749494
5000000, size=4698729
6000000, size=5646001
7000000, size=6623271
8000000, size=7574087
9000000, size=8574087
after loop: 9520798
System.gc(): 569
after clearResources(): 569
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see, the cleaning action runs when the COSName objects are GCed.&lt;/p&gt;

&lt;p&gt;I did not run your version using a reference queue because your code is not based on trunk and does not compile. I would expect the results to be more or less the same.&lt;/p&gt;

&lt;p&gt;As for PDFBox 3+ I&apos;d definitely recommend the Cleaner based solution as it is much simpler than manipulating ReferenceQueues yourself (that&apos;s also the main reason Cleaner was introduced, it uses ReferenceQueues internally).&lt;/p&gt;

&lt;p&gt;If you absolutely need a patch for PDFBox 2, please prepare a patch using ReferenceQueue.&lt;/p&gt;</comment>
                            <comment id="17796652" author="JIRAUSER297279" created="Thu, 14 Dec 2023 10:02:26 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065309/13065309_screenshot-6.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
PDFBox 3.0 requires at least Java 8. &lt;/p&gt;</comment>
                            <comment id="17796655" author="JIRAUSER297279" created="Thu, 14 Dec 2023 10:06:07 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065312/13065312_image-2023-12-14-18-10-14-278.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065311/13065311_screenshot-8.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
The entire jvm cleaner is executed by this thread, which will definitely affect other logic, such as off-heap memory recycling.&lt;/p&gt;</comment>
                            <comment id="17796659" author="axh" created="Thu, 14 Dec 2023 10:33:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; Sorry, I am always on trunk (PDFBox 4). I thought 3 was already on 11.&lt;/p&gt;

&lt;p&gt;But I don&apos;t understand your second comment. What JDK version is that from, JDK 8? In JDK 9+, there is not only one jvm cleaner. You can create as many as you like. Each cleaner holds its own reference queue.&lt;/p&gt;</comment>
                            <comment id="17796661" author="axh" created="Thu, 14 Dec 2023 10:36:38 +0000"  >&lt;p&gt;I&apos;ll prepare a second patch for PDFBox 3 (should probably also work for PDFBox 2), but for trunk I strongly suggest using the Cleaner as the code is much easier to maintain.&lt;/p&gt;</comment>
                            <comment id="17796711" author="axh" created="Thu, 14 Dec 2023 12:18:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lycheng&quot; class=&quot;user-hover&quot; rel=&quot;lycheng&quot;&gt;lycheng&lt;/a&gt; I have created a patch for PDFBox 3. I use a cleanup thread instead, to prevent the memory leak I mentioned earlier. Also the locking should not be on the queue but on nameMap to prevent a race condition that could lead to another memory leak. I am referring to this piece from your proposed code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void removeNameMapKey() {
        Reference&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; COSName&amp;gt; ref;
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((ref = queue.poll()) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (queue) {
                Entry entry = (Entry) ref;
                nameMap.remove(entry.getName());
            }
        }
    } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The output I get from the test code looks good:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0, size=570
1000000, size=850072
2000000, size=1643475
3000000, size=2583958
4000000, size=3398540
5000000, size=4223199
6000000, size=5030981
7000000, size=5838754
8000000, size=6836608
9000000, size=7576135
after loop: 8569358
System.gc(): 569
after clearResources(): 569&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Added patch for &lt;b&gt;PDFBox 3&lt;/b&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065772/13065772_PDFBox5731_clear_out_unused_COSName_instances_automatically_PDFBOX3.patch&quot; title=&quot;PDFBox5731_clear_out_unused_COSName_instances_automatically_PDFBOX3.patch attached to PDFBOX-5731&quot;&gt;PDFBox5731_clear_out_unused_COSName_instances_automatically_PDFBOX3.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17796721" author="axh" created="Thu, 14 Dec 2023 12:41:42 +0000"  >&lt;p&gt;Added patch for &lt;b&gt;PDFBox 2&lt;/b&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065773/13065773_PDFBOX-5731_clear_out_unused_COSName_instances_automatically_PDFBOX2.patch&quot; title=&quot;PDFBOX-5731_clear_out_unused_COSName_instances_automatically_PDFBOX2.patch attached to PDFBOX-5731&quot;&gt;PDFBOX-5731_clear_out_unused_COSName_instances_automatically_PDFBOX2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Test results:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0, size=536
1000000, size=851241
2000000, size=1644093
3000000, size=2583211
4000000, size=3396553
5000000, size=4225041
6000000, size=5032822
7000000, size=5840594
8000000, size=6840054
9000000, size=7581711
after loop: 8579952
System.gc(): 535
after clearResources(): 535&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17796722" author="axh" created="Thu, 14 Dec 2023 12:43:01 +0000"  >&lt;p&gt;Patch for &lt;b&gt;PDFBox 4&lt;/b&gt; (trunk) is still  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13065297/13065297_attempted_fix_for_PDFBOX-5731__clear_out_unused_COSName_instances_automatically_using_cleaner.patch&quot; title=&quot;attempted_fix_for_PDFBOX-5731__clear_out_unused_COSName_instances_automatically_using_cleaner.patch attached to PDFBOX-5731&quot;&gt;attempted_fix_for_PDFBOX-5731__clear_out_unused_COSName_instances_automatically_using_cleaner.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17797425" author="lehmi" created="Sat, 16 Dec 2023 13:21:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;commonNameMap is not needed. Why would you want to keep it? Also using SoftReferences instead of WeakReferences for COSNames seems less than optimal.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Removing commonNameMap will make the usage of constants less useful. Whenever a pdf is read it starts with parsing the document and the parser will perform a lot of COSName.getPDFName calls which will recreate even those common values whenever the value isn&apos;t part of the cache any more ignoring the static instance in COSName.&lt;/p&gt;</comment>
                            <comment id="17797428" author="axh" created="Sat, 16 Dec 2023 13:29:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; No, that&apos;s not the case with the proposed change. All values previously in commonNameMap are now included in nameMap. And they will never be removed because the associated COSName instance is bound to the constant defined in COSName. You can verify that by the output above: even after GC runs, the 569 instances formerly in commonNameMap are retained.&lt;/p&gt;</comment>
                            <comment id="17797430" author="axh" created="Sat, 16 Dec 2023 13:37:16 +0000"  >&lt;p&gt;PS &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt;: If these constants were not retained, the tests would also fail at once - I tried it yesterday to see what the actual effect of caching the instances is. I removed both maps and had getPDFName() create a new instance every time. The tests failed. This was surprising to me because it would mean that there&apos;s a problem with equals()/hashCode(). But that&apos;s not it. The problem is that in many places, COSName instances are compared using operator == instead of equals().&lt;/p&gt;</comment>
                            <comment id="17797916" author="axh" created="Sun, 17 Dec 2023 12:30:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; One more thing: if the patch goes into trunk for PDFBox 4, I suggest to remove COSName.clearResources() as that method will have no effect any more. When GC runs, the Cleaner is guaranteed to remove all obsolete keys so the sweeping and looking for stale references should never find any keys to remove. For PDFBox 2 and 3, the method has to stay there because user code could call it. But it could be changed to a no-op.&lt;/p&gt;</comment>
                            <comment id="17799495" author="jira-bot" created="Thu, 21 Dec 2023 16:35:52 +0000"  >&lt;p&gt;Commit 1914829 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1914829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1914829&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;: use cleaner to remove no longer needed COSName instances from global cache as proposed by Axel Howind&lt;/p&gt;</comment>
                            <comment id="17799496" author="lehmi" created="Thu, 21 Dec 2023 16:39:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=axh&quot; class=&quot;user-hover&quot; rel=&quot;axh&quot;&gt;axh&lt;/a&gt; thanks for the pointer, I&apos;ve overlooked the obvious &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve started with applying your patch for 4.0 &lt;/p&gt;</comment>
                            <comment id="17799861" author="pascal.schumacher@t-systems.com" created="Fri, 22 Dec 2023 15:27:04 +0000"  >&lt;p&gt;Would it not be better to keep initializing the ConcurrentHashMap with an initial capacity as otherwise even the 569 common names will cause multiple resizings of the map (default initial table size is only 16)?&lt;/p&gt;</comment>
                            <comment id="17800036" author="jira-bot" created="Sat, 23 Dec 2023 12:01:17 +0000"  >&lt;p&gt;Commit 1914888 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1914888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1914888&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;: restore former higher value as initial capacity as proposed by Pascal Schumacher&lt;/p&gt;</comment>
                            <comment id="17800290" author="jira-bot" created="Mon, 25 Dec 2023 11:07:18 +0000"  >&lt;p&gt;Commit 1914920 from lehmi@apache.org in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1914920&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1914920&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;: remove no longer needed method clearResources&lt;/p&gt;</comment>
                            <comment id="17800291" author="jira-bot" created="Mon, 25 Dec 2023 11:07:39 +0000"  >&lt;p&gt;Commit 1914921 from lehmi@apache.org in branch &apos;pdfbox/branches/3.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1914921&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1914921&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;: deprecate method clearResources&lt;/p&gt;</comment>
                            <comment id="17802082" author="lehmi" created="Wed, 3 Jan 2024 09:18:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=axh&quot; class=&quot;user-hover&quot; rel=&quot;axh&quot;&gt;axh&lt;/a&gt; I had a look at your patches for 2.0.x and 3.0.x and I don&apos;t like the idea of having an always running thread cleaning up possible no longer used COSName instances. IMHO we don&apos;t need to clean up those instances as fast as possible and more important such a solution increases the chance to slow down the processing speed of bigger installations and in the worst case we might run into a dead lock.&lt;/p&gt;

&lt;p&gt;I&apos;d prefer a task which is called periodically, e.g. every 5 minutes.&lt;/p&gt;</comment>
                            <comment id="17802125" author="msahyoun" created="Wed, 3 Jan 2024 11:26:05 +0000"  >&lt;p&gt;Although it&apos;s more effort and won&apos;t help for 2.x, 3.x wouldn&apos;t it be better to bind the COSNames to the PDDocument instance?  &lt;/p&gt;</comment>
                            <comment id="17802164" author="lehmi" created="Wed, 3 Jan 2024 12:57:48 +0000"  >&lt;p&gt;Maybe a misunderstanding, I&apos;m ok with the solution for the trunk and I already committed it. The trunk implements a cleaner which is triggered by the garbage collector. It isn&apos;t an always running thread. &lt;/p&gt;</comment>
                            <comment id="17803476" author="axh" created="Fri, 5 Jan 2024 09:48:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=msahyoun&quot; class=&quot;user-hover&quot; rel=&quot;msahyoun&quot;&gt;msahyoun&lt;/a&gt; No, it would not have any benefit. The COSNames behave like value objects. If we bind them to the PDDocument, we would need more heap if we have instances with the same name in multiple PDDocument instances. Maybe you think if we bind them to the PDDocument they could simply be cleared once the document is GCed. But that&apos;s the same that happens now: once GC runs, all unused instances will be automatically GCed. IMHO such a binding would only introduce overhead.&lt;/p&gt;</comment>
                            <comment id="17803480" author="axh" created="Fri, 5 Jan 2024 09:57:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; Oh yes, you are right the patches for 2.0 and 3.0 are rather bad. I should not have used poll(). I will look into this later.&lt;/p&gt;</comment>
                            <comment id="17803830" author="axh" created="Sat, 6 Jan 2024 15:38:37 +0000"  >&lt;p&gt;I have replaced the patch for 3.0. It now correctly uses `ReferenceQueue.&lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/ReferenceQueue.html#remove()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;remove()&lt;/a&gt;` instead of poll(). remove() blocks until stale references become available which does not happen unless the GC runs.&lt;/p&gt;</comment>
                            <comment id="17803831" author="axh" created="Sat, 6 Jan 2024 15:53:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; I have now replaced both patches with updated versions that do not do a busy wait (see my comment above).&lt;/p&gt;

&lt;p&gt;updated &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5731&quot; title=&quot;org.apache.pdfbox.cos.COSName#nameMap There is a memory leak problem.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5731&quot;&gt;PDFBOX-5731&lt;/a&gt;_clear_out_unused_COSName_instances_automatically_PDFBOX2.patch&quot;&lt;br/&gt;
updated &quot;PDFBox5731_clear_out_unused_COSName_instances_automatically_PDFBOX3.patch&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13065302" name="COSName.java" size="44217" author="lycheng" created="Thu, 14 Dec 2023 02:59:51 +0000"/>
                            <attachment id="13065773" name="PDFBOX-5731_clear_out_unused_COSName_instances_automatically_PDFBOX2.patch" size="78089" author="axh" created="Sat, 6 Jan 2024 15:51:36 +0000"/>
                            <attachment id="13065772" name="PDFBox5731_clear_out_unused_COSName_instances_automatically_PDFBOX3.patch" size="81851" author="axh" created="Sat, 6 Jan 2024 15:32:45 +0000"/>
                            <attachment id="13065283" name="attempted_fix_for_PDFBOX-5731__clear_out_unused_COSName_instances_automatically.patch" size="80494" author="axh" created="Wed, 13 Dec 2023 08:04:05 +0000"/>
                            <attachment id="13065293" name="attempted_fix_for_PDFBOX-5731__clear_out_unused_COSName_instances_automatically_2.patch" size="80609" author="axh" created="Wed, 13 Dec 2023 14:12:26 +0000"/>
                            <attachment id="13065297" name="attempted_fix_for_PDFBOX-5731__clear_out_unused_COSName_instances_automatically_using_cleaner.patch" size="80773" author="axh" created="Wed, 13 Dec 2023 15:06:15 +0000"/>
                            <attachment id="13065115" name="image-2023-12-08-16-02-12-293.png" size="151124" author="lycheng" created="Fri, 8 Dec 2023 08:02:15 +0000"/>
                            <attachment id="13065284" name="image-2023-12-13-17-04-22-073.png" size="79211" author="lycheng" created="Wed, 13 Dec 2023 09:04:23 +0000"/>
                            <attachment id="13065312" name="image-2023-12-14-18-10-14-278.png" size="131415" author="lycheng" created="Thu, 14 Dec 2023 10:10:14 +0000"/>
                            <attachment id="13065116" name="screenshot-1.png" size="223815" author="lycheng" created="Fri, 8 Dec 2023 08:08:33 +0000"/>
                            <attachment id="13065233" name="screenshot-2.png" size="78846" author="lycheng" created="Tue, 12 Dec 2023 06:41:17 +0000"/>
                            <attachment id="13065234" name="screenshot-3.png" size="209426" author="lycheng" created="Tue, 12 Dec 2023 06:41:52 +0000"/>
                            <attachment id="13065242" name="screenshot-4.png" size="49536" author="lycheng" created="Tue, 12 Dec 2023 07:31:36 +0000"/>
                            <attachment id="13065274" name="screenshot-5.png" size="96024" author="lycheng" created="Wed, 13 Dec 2023 06:25:24 +0000"/>
                            <attachment id="13065309" name="screenshot-6.png" size="234901" author="lycheng" created="Thu, 14 Dec 2023 10:01:45 +0000"/>
                            <attachment id="13065311" name="screenshot-8.png" size="93835" author="lycheng" created="Thu, 14 Dec 2023 10:05:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>16.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1m4x4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>