<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:05:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-3743] Running GC between signing and saving document closes stream</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-3743</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;Running GC between signing and saving document closes stream and signing process fails. It happens only if signature image is added via PDVisibleSignDesigner e.g.&lt;/p&gt;

&lt;p&gt;import org.apache.commons.io.IOUtils;&lt;br/&gt;
import org.apache.pdfbox.pdmodel.PDDocument;&lt;br/&gt;
import org.apache.pdfbox.pdmodel.interactive.digitalsignature.PDSignature;&lt;br/&gt;
import org.apache.pdfbox.pdmodel.interactive.digitalsignature.SignatureOptions;&lt;br/&gt;
import org.apache.pdfbox.pdmodel.interactive.digitalsignature.visible.PDVisibleSigProperties;&lt;br/&gt;
import org.apache.pdfbox.pdmodel.interactive.digitalsignature.visible.PDVisibleSignDesigner;&lt;/p&gt;

&lt;p&gt;import java.io.*;&lt;br/&gt;
import java.net.URISyntaxException;&lt;/p&gt;

&lt;p&gt;import static java.lang.Thread.currentThread;&lt;/p&gt;

&lt;p&gt;public class Foo {&lt;br/&gt;
  public static void main(String[] args) throws IOException, URISyntaxException {&lt;br/&gt;
    byte[] unsignedPdf = getResourceAsBytes(&quot;pdf-sample.pdf&quot;);&lt;/p&gt;

&lt;p&gt;    try (PDDocument doc = PDDocument.load(unsignedPdf)) {&lt;br/&gt;
      doc.addSignature(&lt;br/&gt;
          new PDSignature(),&lt;br/&gt;
          is -&amp;gt; new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;,&lt;br/&gt;
          getSignatureOptions(doc, getFile(&quot;util/test-pdf-signature.jpg&quot;))&lt;br/&gt;
      );&lt;/p&gt;

&lt;p&gt;      System.gc();&lt;/p&gt;

&lt;p&gt;      try (FileOutputStream out = new FileOutputStream(File.createTempFile(&quot;signed&quot;, &quot;.pdf&quot;))) &lt;/p&gt;
{
        doc.saveIncremental(out);
      }
&lt;p&gt;    }&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;  private static SignatureOptions getSignatureOptions(PDDocument doc, File signatureImage) throws IOException {&lt;br/&gt;
    SignatureOptions result = new SignatureOptions();&lt;/p&gt;

&lt;p&gt;    PDVisibleSignDesigner visibleSignature;&lt;br/&gt;
    try (InputStream input = new FileInputStream(signatureImage)) &lt;/p&gt;
{
      visibleSignature = new PDVisibleSignDesigner(doc, input, 1);
    }

&lt;p&gt;    PDVisibleSigProperties visibleSignatureProperties = new PDVisibleSigProperties();&lt;br/&gt;
    visibleSignatureProperties.setPdVisibleSignature(visibleSignature).buildSignature();&lt;br/&gt;
    result.setVisualSignature(visibleSignatureProperties);&lt;/p&gt;

&lt;p&gt;    return result;&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;  public static byte[] getResourceAsBytes(String filePath) throws IOException, URISyntaxException &lt;/p&gt;
{
    return IOUtils.toByteArray(getFile(filePath).toURI());
  }

&lt;p&gt;  public static File getFile(String filePath) throws URISyntaxException &lt;/p&gt;
{
    return new File(currentThread().getContextClassLoader().getResource(filePath).toURI());
  }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;constantly fails with:&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; java.io.IOException: COSStream has been closed and cannot be read. Perhaps its enclosing PDDocument has been closed?&lt;br/&gt;
	at org.apache.pdfbox.cos.COSStream.checkClosed(COSStream.java:77)&lt;br/&gt;
	at org.apache.pdfbox.cos.COSStream.createRawInputStream(COSStream.java:125)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.visitFromStream(COSWriter.java:1203)&lt;br/&gt;
	at org.apache.pdfbox.cos.COSStream.accept(COSStream.java:383)&lt;br/&gt;
	at org.apache.pdfbox.cos.COSObject.accept(COSObject.java:158)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.doWriteObject(COSWriter.java:522)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.doWriteObjects(COSWriter.java:460)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.doWriteBody(COSWriter.java:444)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.visitFromDocument(COSWriter.java:1099)&lt;br/&gt;
	at org.apache.pdfbox.cos.COSDocument.accept(COSDocument.java:419)&lt;br/&gt;
	at org.apache.pdfbox.pdfwriter.COSWriter.write(COSWriter.java:1370)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.PDDocument.saveIncremental(PDDocument.java:1276)&lt;br/&gt;
	at Foo.main(Foo.java:27)&lt;/p&gt;</description>
                <environment>Ubuntu 16.04 64-bit, play framework 1.5</environment>
        <key id="13061050">PDFBOX-3743</key>
            <summary>Running GC between signing and saving document closes stream</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="dmitrie">Dmitri Ess</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Apr 2017 07:37:40 +0000</created>
                <updated>Mon, 15 May 2017 20:28:12 +0000</updated>
                            <resolved>Tue, 4 Apr 2017 15:38:27 +0000</resolved>
                                    <version>2.0.5</version>
                                    <fixVersion>2.0.6</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>Documentation</component>
                    <component>Signing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15954808" author="dmitrie" created="Tue, 4 Apr 2017 08:29:19 +0000"  >&lt;p&gt;I added a failing piece of code to original message.&lt;/p&gt;</comment>
                            <comment id="15955249" author="tilman" created="Tue, 4 Apr 2017 15:28:59 +0000"  >&lt;p&gt;Here&apos;s your code modified so that it runs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PDFBox3743SigProblem
{
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; dir = &lt;span class=&quot;code-quote&quot;&gt;&quot;XXXXXXXXXXXXXXXXXXX&quot;&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, URISyntaxException
    {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (PDDocument doc = PDDocument.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;xxx.pdf&quot;&lt;/span&gt;)))
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
            {
                doc.addSignature(
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDSignature(),
                        is -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[0],
                        getSignatureOptions(doc, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;sig.jpg&quot;&lt;/span&gt;))
                );
                &lt;span class=&quot;code-comment&quot;&gt;// IOException when gc(): COSStream has been closed and cannot be read. Perhaps its enclosing PDDocument has been closed?
&lt;/span&gt;            }
            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            {
                SignatureOptions signatureOptions = getSignatureOptions(doc, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;sig.jpg&quot;&lt;/span&gt;));
                doc.addSignature(
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDSignature(),
                        is -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[0],
                        signatureOptions
                );
                &lt;span class=&quot;code-comment&quot;&gt;// works
&lt;/span&gt;            }

            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc();

            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (FileOutputStream out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;xxx-signed.pdf&quot;&lt;/span&gt;)))
            {
                doc.saveIncremental(out);
            }
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; SignatureOptions getSignatureOptions(PDDocument doc, File signatureImage) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        SignatureOptions signatureOptions = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SignatureOptions();

        PDVisibleSignDesigner visibleSignature;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (InputStream input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(signatureImage))
        {
            visibleSignature = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDVisibleSignDesigner(doc, input, 1);
        }

        PDVisibleSigProperties visibleSignatureProperties = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDVisibleSigProperties();
        visibleSignatureProperties.setPdVisibleSignature(visibleSignature).buildSignature();
        signatureOptions.setVisualSignature(visibleSignatureProperties);

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; signatureOptions;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Look at the first &quot;if&quot; statement. When the condition is &quot;true&quot;, the code fails. When it is false, the code succeeds. It is related to signatureOptions falling out of scope. You might also have seen this log output:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;WARN  [Finalizer] org.apache.pdfbox.cos.COSDocument:478 - Warning: You did not close a PDF Document&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That one means that PDFBox closes a COSDocument object (that is in the signatureOptions) for you. I made a modification to SignatureOptions to see if finalize is called before things go bad, and yes it is &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Your problem reminds me of this&lt;br/&gt;
&lt;a href=&quot;https://stackoverflow.com/questions/42208399/pdfbox-how-to-clone-a-page&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/42208399/pdfbox-how-to-clone-a-page&lt;/a&gt;&lt;br/&gt;
see the comment by mkl.&lt;/p&gt;

&lt;p&gt;So signatureOptions goes out of scope, and thus COSDocument is also not needed anymore either... but the signed PDF keeps references of some of the streams in the COSDocument. Because the COSDocument is no longer referenced, it gets closed at the gc() moment, which also closes streams that are still needed. So the solution in the CreateVisibleSignature example is the correct one: keep signatureOptions until done, and close it yourself (i.e. even the &quot;false&quot; branch here is not really correct!!!). I will add a comment into the CreateVisibleSignature example and improve the javadoc of SignatureOptions.close().&lt;/p&gt;

&lt;p&gt;Thus, TODO for you: add &lt;tt&gt;signatureOptions.close();&lt;/tt&gt; as last statement.&lt;/p&gt;

&lt;p&gt;Btw your code is incorrect, it doesn&apos;t sign anything. Unlike the CreateVisibleSignature example, which can sign.&lt;/p&gt;</comment>
                            <comment id="15955264" author="jira-bot" created="Tue, 4 Apr 2017 15:37:18 +0000"  >&lt;p&gt;Commit 1790137 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1790137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1790137&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3743&quot; title=&quot;Running GC between signing and saving document closes stream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3743&quot;&gt;&lt;del&gt;PDFBOX-3743&lt;/del&gt;&lt;/a&gt;: javadoc and comment explaining that signatureOptions should not go out of scope before saving is finished&lt;/p&gt;</comment>
                            <comment id="15955265" author="jira-bot" created="Tue, 4 Apr 2017 15:37:24 +0000"  >&lt;p&gt;Commit 1790138 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1790138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1790138&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3743&quot; title=&quot;Running GC between signing and saving document closes stream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3743&quot;&gt;&lt;del&gt;PDFBOX-3743&lt;/del&gt;&lt;/a&gt;: javadoc and comment explaining that signatureOptions should not go out of scope before saving is finished&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3d4bb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>