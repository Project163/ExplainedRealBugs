<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:02:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-3001] FileSystemFontProvider cache instability</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-3001</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;FileSystemFontProvider uses Java&apos;s Preferences API to cache font metadata, however it doesn&apos;t seem to work out of the box on Windows (due to file permissions) and one user on the mailing list has complained that on Linux file paths with more than 80 characters can&apos;t be handed. Serializable is also slow.&lt;/p&gt;

&lt;p&gt;It looks like Preferences wasn&apos;t a good choice here. We&apos;re going to need to roll our own cache file format and save it somewhere we have write access to.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12901198">PDFBOX-3001</key>
            <summary>FileSystemFontProvider cache instability</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jahewson">John Hewson</assignee>
                                    <reporter username="jahewson">John Hewson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Sep 2015 00:41:42 +0000</created>
                <updated>Thu, 17 Mar 2016 19:07:28 +0000</updated>
                            <resolved>Thu, 5 Nov 2015 21:57:05 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14965496" author="tilman" created="Tue, 20 Oct 2015 18:16:12 +0000"  >&lt;p&gt;duplicate by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adamhooper&quot; class=&quot;user-hover&quot; rel=&quot;adamhooper&quot;&gt;adamhooper&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3039&quot; title=&quot;FileSystemFontProvider: java.lang.IllegalArgumentException: Key too long: /usr/local/share/fonts/chromeos/notofonts-20140815/NotoSansGujaratiUI-Regular.ttf&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3039&quot;&gt;&lt;del&gt;PDFBOX-3039&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;FileSystemFontProvider: java.lang.IllegalArgumentException: Key too long: /usr/local/share/fonts/chromeos/notofonts-20140815/NotoSansGujaratiUI-Regular.ttf&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;FileSystemFontProvider&lt;/tt&gt; calls &lt;tt&gt;Preferences.putByteArray()&lt;/tt&gt;, which crashes if the key is longer than 80 characters.&lt;/p&gt;

&lt;p&gt;Font filenames are often longer than 80 characters.&lt;/p&gt;

&lt;p&gt;So FileSystemFontProvider often crashes. This happens even if I try to use &lt;tt&gt;PDType1Font.HELVETICA&lt;/tt&gt; ... meaning PDFBox can&apos;t read or write PDFs on my system.&lt;/p&gt;</comment>
                            <comment id="14965513" author="tilman" created="Tue, 20 Oct 2015 18:25:21 +0000"  >&lt;p&gt;Re paths only - how about using an MD5 hash for the path?&lt;/p&gt;</comment>
                            <comment id="14965540" author="adamhooper" created="Tue, 20 Oct 2015 18:50:18 +0000"  >&lt;p&gt;Use SHA1 hashes instead of full filenames&lt;/p&gt;</comment>
                            <comment id="14965542" author="adamhooper" created="Tue, 20 Oct 2015 18:50:35 +0000"  >&lt;p&gt;Attached a patch that fixes the issue for me.&lt;/p&gt;</comment>
                            <comment id="14965549" author="adamhooper" created="Tue, 20 Oct 2015 18:56:13 +0000"  >&lt;p&gt;Patch that compiles for Java 6&lt;/p&gt;</comment>
                            <comment id="14965562" author="tilman" created="Tue, 20 Oct 2015 19:09:42 +0000"  >&lt;p&gt;patch for MD5 hash&lt;/p&gt;</comment>
                            <comment id="14965564" author="tilman" created="Tue, 20 Oct 2015 19:11:02 +0000"  >&lt;p&gt;Oops... you did the same. (I took MD5 because this isn&apos;t a security application)&lt;/p&gt;</comment>
                            <comment id="14965574" author="adamhooper" created="Tue, 20 Oct 2015 19:13:35 +0000"  >&lt;p&gt;Hehe, I take no offence. Really, I only wrote the patch so I could get on with my testing.&lt;/p&gt;

&lt;p&gt;I like the BigInteger trick &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14965587" author="tilman" created="Tue, 20 Oct 2015 19:17:37 +0000"  >&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/415953/how-can-i-generate-an-md5-hash&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/415953/how-can-i-generate-an-md5-hash&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14965895" author="jahewson" created="Tue, 20 Oct 2015 22:31:43 +0000"  >&lt;p&gt;Yes, we could hash the path to make it shorter. But we&apos;re also seeing Windows users on the mailing list with this exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;java.util.prefs.WindowsPreferences &amp;lt;init&amp;gt; - WARNING: Could not open/create prefs root node Software\JavaSoft\Prefs at root 0x80000002. Windows RegCreateKeyEx(...) returned error code 5.&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A quick Google search suggests that the only workaround is for an administrator to create that registry key and assign it user permissions. That&apos;s going to be a problem for server deployments.&lt;/p&gt;

&lt;p&gt;Adding in the fact that Java Serialization is pretty slow, the current implementation of the cache isn&apos;t looking like it&apos;s good enough for production right now. I&apos;m thinking that I just need to bite the bullet and implement a custom file serialisation to $HOME/.pdfbox.cache. I&apos;d tried to avoid that extra effort but it&apos;s clearly the right technical choice. Thoughts?&lt;/p&gt;</comment>
                            <comment id="14965911" author="msahyoun" created="Tue, 20 Oct 2015 22:44:50 +0000"  >&lt;p&gt;I&apos;d think that&apos;s the way to go. Apache FOP is doing the same I guess &lt;tt&gt;org.apache.fop.fonts&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14966266" author="tilman" created="Wed, 21 Oct 2015 05:29:15 +0000"  >&lt;p&gt;Would this work in a tomcat servlet with security restrictions?&lt;br/&gt;
&lt;a href=&quot;http://serverfault.com/questions/156759/where-to-write-files-form-a-web-application-running-on-tomcat-on-ubuntu&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://serverfault.com/questions/156759/where-to-write-files-form-a-web-application-running-on-tomcat-on-ubuntu&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://tomcat.10.x6.nabble.com/Reading-and-writing-files-outside-tomcat-directory-td2161788.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://tomcat.10.x6.nabble.com/Reading-and-writing-files-outside-tomcat-directory-td2161788.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and in an applet?&lt;/p&gt;</comment>
                            <comment id="14966272" author="msahyoun" created="Wed, 21 Oct 2015 05:32:57 +0000"  >&lt;p&gt;I haven&apos;t looked at the detailed implementation of Apache FOP but they have font detection and caching for much longer than we have so it might be worth looking at how they do it.&lt;/p&gt;</comment>
                            <comment id="14966311" author="msahyoun" created="Wed, 21 Oct 2015 06:09:02 +0000"  >&lt;p&gt;quickly looked it up.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for a &apos;regular&apos; app we can write to the users directory&lt;/li&gt;
	&lt;li&gt;for containers we can write to System.getProperty(&quot;java.io.tmpdir&quot;);&lt;/li&gt;
	&lt;li&gt;if that&apos;s not possible for an applet we can create a temp file and look up it&apos;s path to get the directory we can write to.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14966770" author="adamhooper" created="Wed, 21 Oct 2015 13:01:15 +0000"  >&lt;p&gt;What&apos;s their reasoning for writing to /tmp? I understand the homedir approach; but I can&apos;t envision use cases in which writing to a tempdir is better than just keeping the cache in memory. That goes doubly for applets.&lt;/p&gt;

&lt;p&gt;My /tmp uses tmpfs so it costs RAM anyway; and like many /tmp directories, it&apos;s wiped every reboot. Moreover, reading from a predictable tempfile name is one step closer to a security vulnerability, since anybody can plant a file in /tmp.&lt;/p&gt;

&lt;p&gt;Obviously, writing to /tmp would make some invocations faster. But it wouldn&apos;t make them faster in a deterministic manner, and it might create a security vulnerabilty.&lt;/p&gt;

&lt;p&gt;As an end-user, I&apos;d prefer a default `$HOME/.something`, configurable via system property.&lt;/p&gt;</comment>
                            <comment id="14979839" author="jahewson" created="Thu, 29 Oct 2015 05:25:26 +0000"  >&lt;p&gt;I agree, writing to writing to /tmp is probably not that useful, especially as on some systems each process is siloed into its own tmp subdir, which would prevent the cache from being shared or re-loaded. Containers are doomed anyway, as the entire point is that they&apos;re ephemeral so the cache won&apos;t be persisted between runs.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;As an end-user, I&apos;d prefer a default `$HOME/.something`, configurable via system property.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="14979926" author="msahyoun" created="Thu, 29 Oct 2015 06:41:52 +0000"  >&lt;p&gt;In their implementation they first try to establish the cache at the users home directory and then on java.io.tmpdir which may or may not be /tmp. Adding the capability to overwrite that using a system property would be a very good addition.&lt;/p&gt;</comment>
                            <comment id="14979994" author="jahewson" created="Thu, 29 Oct 2015 07:52:06 +0000"  >&lt;blockquote&gt;
&lt;p&gt;which may or may not be /tmp&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It &lt;em&gt;could&lt;/em&gt; be a stable path, in which case the cache would work. So it&apos;s not predictable but still better than nothing. System property is also wise.&lt;/p&gt;</comment>
                            <comment id="14984068" author="jahewson" created="Sat, 31 Oct 2015 17:35:34 +0000"  >&lt;p&gt;Note that the current cache does not handle TTC files correctly, see &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3014&quot; title=&quot;ZapfDingbats not finding a substitute in Windows 8.1 Pro&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3014&quot;&gt;&lt;del&gt;PDFBOX-3014&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14992561" author="jira-bot" created="Thu, 5 Nov 2015 21:53:57 +0000"  >&lt;p&gt;Commit 1712872 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jahewson&quot; class=&quot;user-hover&quot; rel=&quot;jahewson&quot;&gt;jahewson&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1712872&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1712872&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3001&quot; title=&quot;FileSystemFontProvider cache instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3001&quot;&gt;&lt;del&gt;PDFBOX-3001&lt;/del&gt;&lt;/a&gt;: write on-disk font cache to a custom file&lt;/p&gt;</comment>
                            <comment id="14992567" author="jahewson" created="Thu, 5 Nov 2015 21:56:40 +0000"  >&lt;p&gt;The font metadata cache is now saved to a file using a simple custom format. This avoids problems with the Preferences API and restores TTC caching. It also avoids the slowness of Java&apos;s Serializable. An added benefit is that the font cache is now plain-text and can be read by a human, the format is simple, one font per line:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Arial-Black|TTF||384|805|2000009f|dfd70000|0|020b0a04020102020204|/Library/Fonts/Arial Black.ttf
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By default the cache is written to &lt;tt&gt;user.home&lt;/tt&gt;/&lt;tt&gt;.pdfbox.cache&lt;/tt&gt;, but a custom path can be set using the system property &lt;tt&gt;pdfbox.fontcache&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14992905" author="jira-bot" created="Fri, 6 Nov 2015 01:42:35 +0000"  >&lt;p&gt;Commit 1712897 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jahewson&quot; class=&quot;user-hover&quot; rel=&quot;jahewson&quot;&gt;jahewson&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1712897&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1712897&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3001&quot; title=&quot;FileSystemFontProvider cache instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3001&quot;&gt;&lt;del&gt;PDFBOX-3001&lt;/del&gt;&lt;/a&gt;: typo&lt;/p&gt;</comment>
                            <comment id="14993120" author="msahyoun" created="Fri, 6 Nov 2015 04:55:15 +0000"  >&lt;p&gt;Could we also add &lt;tt&gt;System.getProperty(&quot;java.io.tmpdir&quot;)&lt;/tt&gt; if &lt;tt&gt;user.home&lt;/tt&gt; is empty? Should deal with app servers.&lt;/p&gt;</comment>
                            <comment id="14994513" author="jahewson" created="Fri, 6 Nov 2015 21:49:07 +0000"  >&lt;p&gt;Yes, lets do that.&lt;/p&gt;</comment>
                            <comment id="14994515" author="jira-bot" created="Fri, 6 Nov 2015 21:50:06 +0000"  >&lt;p&gt;Commit 1713042 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jahewson&quot; class=&quot;user-hover&quot; rel=&quot;jahewson&quot;&gt;jahewson&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1713042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1713042&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3001&quot; title=&quot;FileSystemFontProvider cache instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3001&quot;&gt;&lt;del&gt;PDFBOX-3001&lt;/del&gt;&lt;/a&gt;: use java.io.tmpdir as fallback location for font cache&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12906332">PDFBOX-3039</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12903777">PDFBOX-3014</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12863339">PDFBOX-2967</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12767643" name="md5.diff" size="2706" author="tilman" created="Tue, 20 Oct 2015 19:09:42 +0000"/>
                            <attachment id="12767641" name="patch" size="3361" author="adamhooper" created="Tue, 20 Oct 2015 18:56:13 +0000"/>
                            <attachment id="12767640" name="patch" size="3319" author="adamhooper" created="Tue, 20 Oct 2015 18:50:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mdxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>