<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:55:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2057] Importing BufferedImage into PDPixelMap is broken in 1.8.5</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2057</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;Try to import a BufferedImage in a PDDocument with PDPixelMap&lt;/p&gt;

&lt;p&gt;BufferedImage with TYPE_4BYTE_ABGR works fine with PDFBox 1.8.4 (though, the pdf file contains instruction /ColorSpace /DeviceGray)&lt;/p&gt;

&lt;p&gt;BufferedImage with TYPE_4BYTE_ABGR produces an unreadable PDF with PDFBox 1.8.5 (though, the pdf file contains instruction /ColorSpace /DeviceRGB).&lt;/p&gt;

&lt;p&gt;Code used to demonstrate the problem is as follows (image has also been colored with some Graphics instructions to demonstrate that 1.8.4 is working) :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            PDDocument doc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument();
            PDPage page = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPage();
            doc.addPage(page);
            BufferedImage awtImage = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedImage(100,100, BufferedImage.TYPE_4BYTE_ABGR);
            PDPixelMap ximage = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPixelMap(doc, awtImage);
            PDPageContentStream contentStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPageContentStream(doc, page);
            contentStream.drawXObject(ximage, 200, 200, 100, 100);
            contentStream.close();
            doc.save(&lt;span class=&quot;code-quote&quot;&gt;&quot;C:\\Temp\\PDF\\test185_4babgr.pdf&quot;&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(COSVisitorException|IOException e) {
            e.printStackTrace();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also tried with a BufferedImage with TYPE_INT_ARGB but it throws an exception with PDFBox 1.8.4 and 1.8.5 :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.IllegalArgumentException: Raster IntegerInterleavedRaster: width = 100 height = 100 #Bands = 1 xOff = 0 yOff = 0 dataOffset[0] 0 is incompatible with ColorModel ColorModel: #pixelBits = 8 numComponents = 1 color space = java.awt.color.ICC_ColorSpace@1dc80063 transparency = 1 has alpha = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; isAlphaPre = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
	at java.awt.image.BufferedImage.&amp;lt;init&amp;gt;(BufferedImage.java:630)
	at org.apache.pdfbox.pdmodel.graphics.xobject.PDPixelMap.createImageStream(PDPixelMap.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My main purpose was to use a BufferedImage with a CMYK ColorSpace, but PDPixelMap seems to accept 1 component and 3 component ColorSpace only.&lt;/p&gt;</description>
                <environment>windows vista / jdk 1.7.0_45</environment>
        <key id="12712190">PDFBOX-2057</key>
            <summary>Importing BufferedImage into PDPixelMap is broken in 1.8.5</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="Micha&#235;l">Micha&#235;l Michaud</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Sun, 4 May 2014 14:34:04 +0000</created>
                <updated>Sun, 22 Jun 2014 14:34:51 +0000</updated>
                            <resolved>Sat, 17 May 2014 15:04:08 +0000</resolved>
                                    <version>1.8.5</version>
                    <version>1.8.6</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.8.6</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>PDModel</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13989035" author="tilman" created="Sun, 4 May 2014 16:31:56 +0000"  >&lt;p&gt;My current theory is that the &quot;smask&quot; has the wrong (RGB) color space. If I change that one with an editor then it works. This is related to another change that I made because Gray images weren&apos;t displayed properly. But a mask must have the gray colorspace.&lt;/p&gt;</comment>
                            <comment id="13989083" author="tilman" created="Sun, 4 May 2014 18:43:51 +0000"  >&lt;p&gt;I have adjusted the code so that a mask is always created with a gray colorspace. I decided to avoid the DeviceGray colorspace for gray images because image colors are somewhat too light in the 1.8 branch, which is why I saved them as RGB. The change makes an exception for masks. I also added a test that checks this. This was done in rev 1592410. You can try a snapshot within a few hours here&lt;br/&gt;
&lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox/1.8.6-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox/1.8.6-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Next thing I&apos;ll do it to see whether we can handle TYPE_INT_ARGB, and check whether the (unreleased) 2.0 version also at risk. Re: CMYK, the best is always to prove code that fails. I don&apos;t know if it will be possible, the 1.8 branch has trouble with that.&lt;/p&gt;</comment>
                            <comment id="13989159" author="micha&#235;l" created="Sun, 4 May 2014 21:29:45 +0000"  >&lt;p&gt;For TYPE_4BYTE_ARGB, the problem is solved for me in 1.8.6-SNAPSHOT.&lt;/p&gt;

&lt;p&gt;TYPE_INT_ARGB still throws an error : I would say that in this case, alphaRaster derived from bi has the same Integer DataBuffer type as bi, which is not compatible with the BYTE DataBuffer of the new alphaImage colorModel).&lt;/p&gt;

&lt;p&gt;java.lang.IllegalArgumentException: Raster IntegerInterleavedRaster: width = 100 height = 100 #Bands = 1 xOff = 0 yOff = 0 dataOffset&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; 0 is incompatible with ColorModel ColorModel: #pixelBits = 8 numComponents = 1 color space = java.awt.color.ICC_ColorSpace@6ce664ac transparency = 1 has alpha = false isAlphaPre = false&lt;br/&gt;
	at java.awt.image.BufferedImage.&amp;lt;init&amp;gt;(BufferedImage.java:630)&lt;br/&gt;
	at org.apache.pdfbox.pdmodel.graphics.xobject.PDPixelMap.createImageStream(PDPixelMap.java:132)&lt;/p&gt;</comment>
                            <comment id="13989179" author="tilman" created="Sun, 4 May 2014 22:47:43 +0000"  >&lt;p&gt;Yes, I&apos;m working on this, trying to copy the raster... in the meantime, the best for you would be to copy your images to one of the types that work. Re: the CMYK problem, if you have test images that are not confidential, please attach them. If it is JPEG, try PDJpeg( PDDocument doc, InputStream is ).&lt;/p&gt;</comment>
                            <comment id="13989637" author="tilman" created="Mon, 5 May 2014 15:59:41 +0000"  >&lt;p&gt;I&apos;m currently having a weird problem: I can&apos;t extract the RGB part of an TYPE_4BYTE_ABGR image properly. If the alpha value is 0, then the RGB image is also set to 0 i.e. black. This does not happen with TYPE_INT_ARGB. The relevant code is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; rgbImage = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedImage(width, height, BufferedImage.TYPE_3BYTE_BGR);
 Graphics2D g = rgbImage.createGraphics();
 g.setComposite(AlphaComposite.Src);
 g.drawImage(bi, 0, 0, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
 g.dispose();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;bi is the image with an alpha component.&lt;/p&gt;</comment>
                            <comment id="13990024" author="tilman" created="Mon, 5 May 2014 21:56:00 +0000"  >&lt;p&gt;Until there&apos;s a better solution, I&apos;m will use a simpler but probably slower method to get the RGB info, so that the tests pass, because correct code is always better than speed.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; x = 0; x &amp;lt; width; ++x)
       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; y = 0; y &amp;lt; height; ++y)
           rgbImage.setRGB(x, y, bi.getRGB(x, y) &amp;amp; 0xFFFFFF);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;ll do this tomorrow, I need to clean up the tests first.&lt;/p&gt;</comment>
                            <comment id="13990795" author="tilman" created="Tue, 6 May 2014 16:13:24 +0000"  >&lt;p&gt;I have improved PDPixelMap and its tests in rev 1592793. Masks are now supported for TYPE_4BYTE_ABGR and TYPE_INT_ARGB. I have also found a way to support grayscale images in the 1.8 branch: since they are read into the raster, I have to write them from the raster and not from the getRGB call because java does some modifications with the values.&lt;/p&gt;

&lt;p&gt;Next thing I&apos;ll add some tests to the trunk to check whether it has the same problems.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Micha%C3%ABl&quot; class=&quot;user-hover&quot; rel=&quot;Micha&#235;l&quot;&gt;Micha&#235;l&lt;/a&gt; please test the snapshot when it is available.&lt;/p&gt;</comment>
                            <comment id="13991006" author="tilman" created="Tue, 6 May 2014 19:06:04 +0000"  >&lt;p&gt;I added tests to the trunk and while the masks problem didn&apos;t happen, the &quot;black image when alpha is 0&quot; did happen. I changed the code accordingly and later I realized that I don&apos;t even need getColorImage().&lt;/p&gt;

&lt;p&gt;I also realized that there&apos;s a difference between getRGBImage() of 1.8 and getImage() of 2.0: the former returns only RGB, the later returns the image with the masks applied. So I added the use of SampledImageReader.getRGBImage(), one can never have too many tests &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;This was done in rev 1592839.&lt;/p&gt;</comment>
                            <comment id="13991073" author="micha&#235;l" created="Tue, 6 May 2014 20:16:12 +0000"  >&lt;p&gt;Thanks for the effort,&lt;/p&gt;

&lt;p&gt;I&apos;ll try to have a test tomorrow.&lt;br/&gt;
Should I use &lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox/1.8.6-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/pdfbox/pdfbox/1.8.6-SNAPSHOT/&lt;/a&gt;&lt;br/&gt;
or&lt;br/&gt;
should I build from the source (I tried to build from the trunk just now, but could not package the jar because there is a tests failures in TestTTFParser)&lt;/p&gt;</comment>
                            <comment id="13991178" author="tilman" created="Tue, 6 May 2014 21:43:46 +0000"  >&lt;p&gt;Building from source has the advantage that you get the changes faster, and that you can look in the source code, even make (local) changes in your own version.&lt;/p&gt;

&lt;p&gt;Re test failure - either it is related to the current server problems, or maybe you built only the pdfbox subproject, instead of the whole &quot;PDFBox Reactor&quot; (which will automatically build the subprojects, even if you didn&apos;t open them in the IDE).&lt;/p&gt;</comment>
                            <comment id="13991273" author="david.keller" created="Tue, 6 May 2014 22:43:16 +0000"  >&lt;p&gt;&quot;Tilman Hausherr added a comment - Yesterday 20:14&lt;br/&gt;
David KELLER I have updated &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2057&quot; title=&quot;Importing BufferedImage into PDPixelMap is broken in 1.8.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2057&quot;&gt;&lt;del&gt;PDFBOX-2057&lt;/del&gt;&lt;/a&gt;, please look there, test the change, set a watch, and tell me if it works or not.&quot;&lt;/p&gt;

&lt;p&gt;Dear Tilman Hausherr :&lt;br/&gt;
=&amp;gt; I just build the trunk of pdfbox and now the image is completly transparent&lt;br/&gt;
=&amp;gt; I do the same with Itext and it respect the alpha channel &lt;br/&gt;
renderTransparentImage.zip contains source code, image and pdf render by Itext and PdfBox&lt;/p&gt;

&lt;p&gt;Best regards,&lt;br/&gt;
David KELLER&lt;/p&gt;
</comment>
                            <comment id="13991899" author="tilman" created="Wed, 7 May 2014 15:19:28 +0000"  >&lt;p&gt;Your example is quite complex, and I have some idea what you&apos;re doing, but it is missing some files: CoinImageUtil, PdfBoxTextUtil, FileUtilBasic, PdfBoxUtil, ReplaceTextByImage. So I can&apos;t verify that it is called with the correct image, and at the correct position. Instead I tried to reproduce what I think you wanted to do.&lt;/p&gt;

&lt;p&gt;Copy the code from AddImageToPDF.java from the example subproject and then make the following changes below the comment &quot;define and set the target rectangle&quot;:&lt;br/&gt;
old code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; scale = 1f; &lt;span class=&quot;code-comment&quot;&gt;// reduce &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; value &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the image is too large
&lt;/span&gt;  contentStream.drawXObject(ximage, 20, 20, ximage.getWidth()*scale, ximage.getHeight()*scale);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;new code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; scale = 0.5f; &lt;span class=&quot;code-comment&quot;&gt;// reduce &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; value &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the image is too large
&lt;/span&gt;  contentStream.drawXObject(ximage, 320, 285, ximage.getWidth()*scale, ximage.getHeight()*scale);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then write a caller for AddImageToPDF:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; stampFile = &lt;span class=&quot;code-quote&quot;&gt;&quot;......./Signature_test_out.png&quot;&lt;/span&gt;;
 &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; documentFile = &lt;span class=&quot;code-quote&quot;&gt;&quot;......./CS-Convocation entretien.pdf&quot;&lt;/span&gt;;
 &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; outFile = &lt;span class=&quot;code-quote&quot;&gt;&quot;..../CS-Convocation entretien signed.pdf&quot;&lt;/span&gt;;

 AddImageToPDF addImageToPDF = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AddImageToPDF();
 addImageToPDF.createPDFFromImage(documentFile, stampFile, outFile);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Et voil&#224;! The result is the attached pdf file. Is that what you wanted?&lt;/p&gt;</comment>
                            <comment id="13992592" author="chupacabras" created="Thu, 8 May 2014 08:18:38 +0000"  >&lt;p&gt;I see the fix in ImageFactory.getAlphaImage(BufferedImage image).&lt;br/&gt;
But isn&apos;t it much easier to do it like this?&lt;/p&gt;

&lt;p&gt;WritableRaster alphaRaster = image.getAlphaRaster();&lt;br/&gt;
BufferedImage bi=new BufferedImage(alphaRaster.getWidth(), alphaRaster.getHeight(), BufferedImage.TYPE_BYTE_GRAY);&lt;br/&gt;
bi.setData(alphaRaster);&lt;/p&gt;</comment>
                            <comment id="13992859" author="micha&#235;l" created="Thu, 8 May 2014 15:48:44 +0000"  >&lt;p&gt;A pdf produced with 3 different types of BufferedImage (RGB (byte) / RGB (int) / CMYK) and with/without transparency.&lt;/p&gt;</comment>
                            <comment id="13992860" author="micha&#235;l" created="Thu, 8 May 2014 15:49:40 +0000"  >&lt;p&gt;Hi Tilman&lt;/p&gt;

&lt;p&gt;Good work !!!&lt;br/&gt;
I did not dive into the code but compiled the source code in 2.0 trunk and get good results (still an error when I compiled the whole project, but I deactivated the TestTTFParser).&lt;br/&gt;
I attach an image showing that I could create a pdf with&lt;br/&gt;
TYPE_4BYTE_ABGR BufferedImage&lt;br/&gt;
TYPE_INT_ARGB BufferedImage&lt;br/&gt;
TYPE_CMYK BufferedImage&lt;br/&gt;
second line contains the same image as the first and the second one + transparency&lt;/p&gt;

&lt;p&gt;Keep the good job &lt;/p&gt;</comment>
                            <comment id="13992895" author="tilman" created="Thu, 8 May 2014 16:26:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Micha%C3%ABl&quot; class=&quot;user-hover&quot; rel=&quot;Micha&#235;l&quot;&gt;Micha&#235;l&lt;/a&gt; glad it works for you. See &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2005&quot; title=&quot;JDK 1.8 build fails in TestTTFParser&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2005&quot;&gt;&lt;del&gt;PDFBOX-2005&lt;/del&gt;&lt;/a&gt; for the TestTTFParser problem. I bet you have JDK8 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Btw if you had looked into the modified code of the last few days, you would have found something I have put there in the honor of you and David &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13992913" author="tilman" created="Thu, 8 May 2014 16:50:12 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chupacabras&quot; class=&quot;user-hover&quot; rel=&quot;chupacabras&quot;&gt;chupacabras&lt;/a&gt;! I&apos;m surprised myself that it works, because I once looked into these raster arrays while debugging, and the alpha values were either in the highest byte or in every fourth byte, so I&apos;m surprised that it ends at the correct place. I committed the change in rev 1593329 for the trunk.&lt;/p&gt;</comment>
                            <comment id="13992976" author="chupacabras" created="Thu, 8 May 2014 18:04:50 +0000"  >&lt;p&gt;That was just a suggestion &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I did not make wide testing.&lt;/p&gt;</comment>
                            <comment id="13992997" author="tilman" created="Thu, 8 May 2014 18:32:18 +0000"  >&lt;p&gt;Improved the tests and added &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chupacabras&quot; class=&quot;user-hover&quot; rel=&quot;chupacabras&quot;&gt;chupacabras&lt;/a&gt;&apos;s suggestion in the 1.8 branch in rev 1593365.&lt;/p&gt;</comment>
                            <comment id="13993094" author="tilman" created="Thu, 8 May 2014 20:52:38 +0000"  >&lt;p&gt;I added code to check that the masks have a certain amount of different colors - this way we can detect if a mask is black after a modification. I can&apos;t check for identity between the alpha values I set in the test and the values within a BufferedImage.TYPE_BYTE_GRAY because the raster values and the RGB values are not identical, the RGB values are calculated by java somehow. This was done in rev 1593414 for the trunk and rev 1593416 for the 1.8 branch.&lt;/p&gt;</comment>
                            <comment id="13993195" author="david.keller" created="Thu, 8 May 2014 22:24:54 +0000"  >&lt;p&gt;Dear Tilman,&lt;br/&gt;
I just have make some test. Sorry for the complex example but in the past (dev starts in 2007 !) I need to combine iText and PDFBox to add transparent image in a PDF...&lt;br/&gt;
So I have do a more simple example and I found the issue, it is not a ratio problem, but a kind of image not supported by PDFBox after doing a filter on the image. &lt;/p&gt;

&lt;p&gt;So I find a workarround, I will explain it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; !&lt;/p&gt;


&lt;p&gt;If i use IText I can write :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	public void applyTransparencyFilter() throws IOException {
		this.bufferedImage = ImageFilterOp.getImageWhiteTransparency(this.bufferedImage);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I do the same with PDFBox I have a blank image.&lt;br/&gt;
=&amp;gt; PDFBox do not deal with Transparency.BITMASK  image&lt;/p&gt;

&lt;p&gt;@see in ImageFilterOp.java&lt;br/&gt;
BufferedImage out =&lt;br/&gt;
			gc.createCompatibleImage(in.getWidth(), in.getHeight(), Transparency.BITMASK);&lt;/p&gt;


&lt;p&gt;So I do this workarround, and it works fine now :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	public void applyTransparencyFilter() throws IOException {
		this.bufferedImage = ImageFilterOp.getImageWhiteTransparency(this.bufferedImage);
		// Workarround @see https://issues.apache.org/jira/browse/PDFBOX-2057
		ByteArrayOutputStream baos = new ByteArrayOutputStream();
		ImageIO.write(bufferedImage, &quot;png&quot;, baos);
		this.bufferedImage = ImageIO.read(new ByteArrayInputStream(baos.toByteArray()));
		System.gc();
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13993443" author="tilman" created="Fri, 9 May 2014 07:00:41 +0000"  >&lt;p&gt;Got it. I must take BufferedImage.getTransparency() into consideration when using the values I get from the alpha raster. Will do so tonight or this weekend.&lt;/p&gt;</comment>
                            <comment id="13993667" author="tilman" created="Fri, 9 May 2014 16:21:03 +0000"  >&lt;p&gt;I added code to handle BITMASK transparency properly. Please give feedback whether you can get rid of your workaround.&lt;/p&gt;

&lt;p&gt;I also added a test to prevent this from breaking in the future.&lt;/p&gt;

&lt;p&gt;I also removed double assignments from CCITTFactory and added a test to check that they are really there.&lt;/p&gt;

&lt;p&gt;This was done in rev 1593569 for the trunk, which also added the modifications of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2068&quot; title=&quot;Add filter parameter to PDImageXObject(document, filteredStream) constructor &quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2068&quot;&gt;&lt;del&gt;PDFBOX-2068&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Next: will look whether the problem occurs for jpeg (see &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2067&quot; title=&quot;Error creating JPEG image with SMask&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2067&quot;&gt;&lt;del&gt;PDFBOX-2067&lt;/del&gt;&lt;/a&gt;) and in the 1.8 branch.&lt;/p&gt;</comment>
                            <comment id="13993963" author="tilman" created="Fri, 9 May 2014 21:52:24 +0000"  >&lt;p&gt;Some DRY refactoring done in rev 1593627 for the trunk, moved the encoding into its own method.&lt;/p&gt;</comment>
                            <comment id="13994250" author="tilman" created="Sat, 10 May 2014 16:17:15 +0000"  >&lt;p&gt;Added a BITMASK transparency test for 4BYTE_ABGR in rev 1593706 for the trunk.&lt;/p&gt;</comment>
                            <comment id="13994255" author="tilman" created="Sat, 10 May 2014 16:30:33 +0000"  >&lt;p&gt;Added dummy rendering in rev 1593708 for the trunk. In long term, the test should go full circle, i.e. extract the graphics from the pdf and compare them to the original graphics.&lt;/p&gt;</comment>
                            <comment id="13994633" author="tilman" created="Sun, 11 May 2014 18:16:07 +0000"  >&lt;p&gt;More refactoring of the tests in rev 1593833.&lt;/p&gt;</comment>
                            <comment id="14000802" author="tilman" created="Sat, 17 May 2014 15:04:08 +0000"  >&lt;p&gt;I added BITMASK transparency handling in rev 1595492 and tests in rev 1595493 for the 1.8 branch. This resolves this issue. Please comment and/or reopen if you&apos;re not 100% satisfied &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14012590" author="tilman" created="Thu, 29 May 2014 17:42:30 +0000"  >&lt;p&gt;Replaced a call to static method with the correct call in rev 1598341 of the trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12708617">PDFBOX-2030</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12712956">PDFBOX-2067</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12643767" name="CS-Convocation entretien signed.pdf" size="53442" author="tilman" created="Wed, 7 May 2014 15:19:28 +0000"/>
                            <attachment id="12644026" name="CS-Convocation entretien-IText.pdf" size="53577" author="david.keller" created="Thu, 8 May 2014 22:24:54 +0000"/>
                            <attachment id="12644027" name="CS-Convocation entretien-PDFBox-with-workarround.pdf" size="53538" author="david.keller" created="Thu, 8 May 2014 22:24:54 +0000"/>
                            <attachment id="12644025" name="CS-Convocation entretien-PDFBox.pdf" size="53538" author="david.keller" created="Thu, 8 May 2014 22:24:54 +0000"/>
                            <attachment id="12644024" name="ImageFilterOp.java" size="19855" author="david.keller" created="Thu, 8 May 2014 22:24:54 +0000"/>
                            <attachment id="12643960" name="differentBufferedImages.pdf" size="5279" author="Micha&#235;l" created="Thu, 8 May 2014 15:48:44 +0000"/>
                            <attachment id="12643650" name="renderTransparentImage.zip" size="183067" author="david.keller" created="Tue, 6 May 2014 22:43:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390509</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 25 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1v9jj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>390762</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>