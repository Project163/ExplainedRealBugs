<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:01:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2901] High CPU load and OutOfMemoryError when rendering shading</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2901</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;By Frank D. from the mailing list:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When we try to convert the attached pdf, the CPU load of tomcat is raising and it seems, that the process hangs. The tomcat process is no more responsive and after a long while, we get an memory overflow. Also the server load is very high meanwhile. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Some debugging at 50 dpi:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PDFOperator{cs}: [COSName{CS0}]
PDFOperator{scn}: [COSName{P0}]
PDFOperator{gs}: [COSName{GS0}]
PDFOperator{m}: [COSFloat{-10551.00391}, COSFloat{667.6051}]
PDFOperator{l}: [COSFloat{-10551.00391}, COSFloat{1447.09143}]
PDFOperator{l}: [COSFloat{9338.57129}, COSFloat{1447.09143}]
PDFOperator{l}: [COSFloat{9338.57129}, COSFloat{667.6051}]
PDFOperator{f}: []

f = Fill path using non zero winding rule

(...wait...)

PDFOperator{cs}: [COSName{CS0}]
PDFOperator{scn}: [COSName{P0}]
PDFOperator{gs}: [COSName{GS0}]
PDFOperator{m}: [COSFloat{-18801.79492}, COSFloat{667.6051}]
PDFOperator{l}: [COSFloat{-18801.79492}, COSFloat{1447.09143}]
PDFOperator{l}: [COSFloat{1087.7804}, COSFloat{1447.09143}]
PDFOperator{l}: [COSFloat{1087.7804}, COSFloat{667.6051}]
PDFOperator{f}: []

(...wait...)

PDFOperator{cs}: [COSName{CS0}]
PDFOperator{scn}: [COSName{P0}]
PDFOperator{gs}: [COSName{GS0}]
PDFOperator{m}: [COSFloat{-18801.79492}, COSFloat{11.15869}]
PDFOperator{l}: [COSFloat{-18801.79492}, COSFloat{790.64502}]
PDFOperator{l}: [COSFloat{1087.7804}, COSFloat{790.64502}]
PDFOperator{l}: [COSFloat{1087.7804}, COSFloat{11.15869}]
PDFOperator{f}: []

(...wait...)
(...wait...)
(...wait...)

PDFOperator{cs}: [COSName{CS0}]
PDFOperator{scn}: [COSName{P0}]
PDFOperator{gs}: [COSName{GS0}]
PDFOperator{m}: [COSFloat{-10551.00391}, COSFloat{667.6051}]
PDFOperator{l}: [COSFloat{-10551.00391}, COSFloat{1447.09143}]
PDFOperator{l}: [COSFloat{9338.57129}, COSFloat{1447.09143}]
PDFOperator{l}: [COSFloat{9338.57129}, COSFloat{667.6051}]
PDFOperator{f}: []

Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: GC overhead limit exceeded
        at sun.java2d.cmm.kcms.CMMImageLayout.&amp;lt;init&amp;gt;(Unknown Source)
        at sun.java2d.cmm.kcms.ICC_Transform.colorConvert(Unknown Source)
        at java.awt.color.ICC_ColorSpace.toRGB(Unknown Source)
        at org.apache.pdfbox.pdmodel.graphics.color.PDDeviceRGB.toRGB(PDDeviceRGB.java:82)
        at org.apache.pdfbox.pdmodel.graphics.shading.ShadingContext.convertToRGB(ShadingContext.java:142)
        at org.apache.pdfbox.pdmodel.graphics.shading.TriangleBasedShadingContext.evalFunctionAndConvertToRGB(TriangleBasedShadingContext.java:167)
        at org.apache.pdfbox.pdmodel.graphics.shading.TriangleBasedShadingContext.calcPixelTable(TriangleBasedShadingContext.java:121)
        at org.apache.pdfbox.pdmodel.graphics.shading.GouraudShadingContext.calcPixelTable(GouraudShadingContext.java:111)
        at org.apache.pdfbox.pdmodel.graphics.shading.TriangleBasedShadingContext.createPixelTable(TriangleBasedShadingContext.java:80)
        at org.apache.pdfbox.pdmodel.graphics.shading.Type4ShadingContext.&amp;lt;init&amp;gt;(Type4ShadingContext.java:65)
        at org.apache.pdfbox.pdmodel.graphics.shading.Type4ShadingPaint.createContext(Type4ShadingPaint.java:66)
        at sun.java2d.pipe.AlphaPaintPipe.startSequence(Unknown Source)
        at sun.java2d.pipe.SpanShapeRenderer$Composite.startSequence(Unknown Source)
        at sun.java2d.pipe.SpanShapeRenderer.renderSpans(Unknown Source)
        at sun.java2d.pipe.SpanShapeRenderer.fill(Unknown Source)
        at sun.java2d.pipe.ValidatePipe.fill(Unknown Source)
        at sun.java2d.SunGraphics2D.fill(Unknown Source)
        at org.apache.pdfbox.rendering.PageDrawer.fillPath(PageDrawer.java:611)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is that a type 4 shading (&quot;gouraud shading&quot;) is called with huge triangles (not shown here but I saw it in debugging) and huge device bounds (e.g. x=-10551.004,y=667.6051,w=19889.574,h=779.4863). The shading routines of types 4-7 create a mapping table for the color of every point in a shading triangle. Because these triangles and the device bounds are so huge, the table is huge and takes a long time to be calculated, uses a lot of memory, with the result above.&lt;/p&gt;

&lt;p&gt;IMHO it is a java bug, it should consider the clipping when calculating the device bounds when calling Paint.createContext() and not pass device bounds outside of the clipping region. The solution will be (once again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ) to do ourselves what java doesn&apos;t.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12846933">PDFBOX-2901</key>
            <summary>High CPU load and OutOfMemoryError when rendering shading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="tilman">Tilman Hausherr</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Jul 2015 16:21:27 +0000</created>
                <updated>Wed, 2 Nov 2016 10:35:41 +0000</updated>
                            <resolved>Wed, 22 Jul 2015 18:58:51 +0000</resolved>
                                    <version>1.8.9</version>
                    <version>1.8.10</version>
                    <version>1.8.11</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.8.11</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Rendering</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14637142" author="tilman" created="Wed, 22 Jul 2015 16:23:35 +0000"  >&lt;p&gt;According to virustotal.com, one (Dr.Web) of 51 programs claims that it is a virus (SCRIPT.Virus). I&apos;ve send it to them for analysis. Until then, don&apos;t view it with Adobe Reader.&lt;/p&gt;</comment>
                            <comment id="14637153" author="jira-bot" created="Wed, 22 Jul 2015 16:37:18 +0000"  >&lt;p&gt;Commit 1692301 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/1.8&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1692301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1692301&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2901&quot; title=&quot;High CPU load and OutOfMemoryError when rendering shading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2901&quot;&gt;&lt;del&gt;PDFBOX-2901&lt;/del&gt;&lt;/a&gt;: apply clip to path to avoid oversized device bounds in shading contexts&lt;/p&gt;</comment>
                            <comment id="14637155" author="tilman" created="Wed, 22 Jul 2015 16:40:01 +0000"  >&lt;p&gt;I could apply the clip for all paints, but that would make too many (small) differences and cost more time.&lt;/p&gt;</comment>
                            <comment id="14637354" author="jira-bot" created="Wed, 22 Jul 2015 18:19:14 +0000"  >&lt;p&gt;Commit 1692311 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1692311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1692311&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2901&quot; title=&quot;High CPU load and OutOfMemoryError when rendering shading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2901&quot;&gt;&lt;del&gt;PDFBOX-2901&lt;/del&gt;&lt;/a&gt;: apply clip to path to avoid oversized device bounds in shading contexts&lt;/p&gt;</comment>
                            <comment id="15628270" author="evansayer" created="Wed, 2 Nov 2016 09:00:11 +0000"  >&lt;p&gt;I believe we&apos;re hitting another variation of this problem that wasn&apos;t fixed by the patch here.  I&apos;ll attach a stack-trace from a thread-dump of a JVM that has been churning through the shading code for &amp;gt; 10 minutes now to parse a ~200k PDF.  This test is running version 2.0.1.&lt;/p&gt;

&lt;p&gt;We seem descend into the same costly shading code here as well, but before the logic in the patch here can clip the shaded area: &lt;a href=&quot;https://github.com/apache/pdfbox/blob/2.0.1/pdfbox/src/main/java/org/apache/pdfbox/rendering/PageDrawer.java#L588&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pdfbox/blob/2.0.1/pdfbox/src/main/java/org/apache/pdfbox/rendering/PageDrawer.java#L588&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15628279" author="evansayer" created="Wed, 2 Nov 2016 09:03:13 +0000"  >&lt;p&gt;Here&apos;s a stack-trace from a thread-dump of the stuck JVM:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;pf_test-emitter-0&quot;&lt;/span&gt; #323 daemon prio=5 os_prio=0 tid=0x00007fc09839a000 nid=0x32a6 runnable [0x00007fbfad6bc000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(Native Method)
        at java.util.HashMap$TreeNode.tieBreakOrder(HashMap.java:1896)
        at java.util.HashMap$TreeNode.putTreeVal(HashMap.java:1992)
        at java.util.HashMap.putVal(HashMap.java:637)
        at java.util.HashMap.put(HashMap.java:611)
        at org.apache.pdfbox.pdmodel.graphics.shading.TriangleBasedShadingContext.calcPixelTable(TriangleBasedShadingContext.java:121)
        at org.apache.pdfbox.pdmodel.graphics.shading.GouraudShadingContext.calcPixelTable(GouraudShadingContext.java:111)
        at org.apache.pdfbox.pdmodel.graphics.shading.TriangleBasedShadingContext.createPixelTable(TriangleBasedShadingContext.java:80)
        at org.apache.pdfbox.pdmodel.graphics.shading.Type4ShadingContext.&amp;lt;init&amp;gt;(Type4ShadingContext.java:65)
        at org.apache.pdfbox.pdmodel.graphics.shading.Type4ShadingPaint.createContext(Type4ShadingPaint.java:66)
        at sun.java2d.pipe.AlphaPaintPipe.startSequence(AlphaPaintPipe.java:84)
        at sun.java2d.pipe.AAShapePipe.renderTiles(AAShapePipe.java:168)
        at sun.java2d.pipe.AAShapePipe.renderPath(AAShapePipe.java:159)
        at sun.java2d.pipe.AAShapePipe.fill(AAShapePipe.java:68)
        at sun.java2d.pipe.PixelToParallelogramConverter.fill(PixelToParallelogramConverter.java:164)
        at sun.java2d.pipe.ValidatePipe.fill(ValidatePipe.java:160)
        at sun.java2d.SunGraphics2D.fill(SunGraphics2D.java:2527)
        at org.apache.pdfbox.rendering.PageDrawer.shadingFill(PageDrawer.java:921)
        at org.apache.pdfbox.contentstream.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.graphics.ShadingFill.process(ShadingFill.java:41)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:815)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:472)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processTilingPattern(PDFStreamEngine.java:371)
        at org.apache.pdfbox.rendering.PageDrawer.drawTilingPattern(PageDrawer.java:222)
        at org.apache.pdfbox.rendering.TilingPaint.getImage(TilingPaint.java:171)
        at org.apache.pdfbox.rendering.TilingPaint.&amp;lt;init&amp;gt;(TilingPaint.java:69)
        at org.apache.pdfbox.rendering.PageDrawer.getPaint(PageDrawer.java:251)
        at org.apache.pdfbox.rendering.PageDrawer.getNonStrokingPaint(PageDrawer.java:529)
        at org.apache.pdfbox.rendering.PageDrawer.fillPath(PageDrawer.java:588)
        at org.apache.pdfbox.contentstream.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.graphics.FillEvenOddRule.process(FillEvenOddRule.java:36)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processOperator(PDFStreamEngine.java:815)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processStreamOperators(PDFStreamEngine.java:472)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processStream(PDFStreamEngine.java:446)
        at org.apache.pdfbox.contentstream.PDFStreamEngine.processPage(PDFStreamEngine.java:149)
        at org.apache.pdfbox.rendering.PageDrawer.drawPage(PageDrawer.java:189)
        at org.apache.pdfbox.rendering.PDFRenderer.renderPage(PDFRenderer.java:208)
        at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:139)
        at org.apache.pdfbox.rendering.PDFRenderer.renderImageWithDPI(PDFRenderer.java:94)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;PageDrawer.getNonStrokingPaint()&lt;/tt&gt; can lead to that same shading logic it seems, but that call happens before the patch here is applied to clip the shaded area.  Or that&apos;s my understanding, any assistance/advice is much appreciated. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15628542" author="tilman" created="Wed, 2 Nov 2016 10:35:41 +0000"  >&lt;p&gt;Please create a new issue and attach your PDF.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12746564" name="PDFBOX-2901-outofmemory.pdf" size="266825" author="tilman" created="Wed, 22 Jul 2015 16:23:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hk87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>