<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:10:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4963] TTF file leakage in font cache</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4963</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;We observe many TTF opened files in our production server, which result in exhausting file descriptors.&lt;br/&gt;
We have checked and rechecked that every PDDocument is properly closed (try with resource everywhere).&lt;br/&gt;
By looking at pdfbox source code, I suspect 2 problems in FontCache and in FileSystemFontProvider&lt;/p&gt;

&lt;p&gt;1 - FontCache&lt;/p&gt;

&lt;p&gt;In FontCache, a map keeps SoftReference&amp;lt;FontBoxFont&amp;gt; as values.&lt;br/&gt;
IIUC for TTF fonts, the values are instances of org.apache.fontbox.ttf.TrueTypeFont. Such instances have a TTFDataStream member, which is RAFDataStream (so there is an opened file).&lt;/p&gt;

&lt;p&gt;Problem is that if the soft reference is cleared by GC, we can suppose the TrueTypeFont objects are GCed (is that guaranteed?) ; but what about the RAFDataStream sub-object ? There is no RAFDataStream.close() in TrueTypeFont finalizer&lt;/p&gt;

&lt;p&gt;2 - FileSystemFontProvider&lt;/p&gt;

&lt;p&gt;There seems to be a TOCTOU-like race condition when a font is needed. Code looks like below (simplified) :&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
      public FontBoxFont getFont()&lt;br/&gt;
       {&lt;br/&gt;
          FontBoxFont cached = parent.cache.getFont(this);&lt;br/&gt;
          if (cached != null) &lt;/p&gt;
{
               return cached;
          }

&lt;p&gt;          FontBoxFont font = ... // instantiate font&lt;br/&gt;
          parent.cache.addFont(this, font);  // &amp;lt;--- not thread safe ?&lt;br/&gt;
          return font;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;The font, if not in cache, is instantiated and added into cache. But two threads can do that at the same time, and the last addFont() wins. So the first SoftReference&amp;lt;FontBoxFont&amp;gt; object is now eligible to GC; but the FontBoxFont has not been closed.&lt;br/&gt;
This problem is probably less frequent.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13329157">PDFBOX-4963</key>
            <summary>TTF file leakage in font cache</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="momaison">Maison</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Sep 2020 08:32:41 +0000</created>
                <updated>Wed, 26 Oct 2022 09:38:30 +0000</updated>
                                            <version>2.0.21</version>
                                                    <component>PDModel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17202516" author="jira-bot" created="Sat, 26 Sep 2020 04:37:05 +0000"  >&lt;p&gt;Commit 1882034 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882034&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882034&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4963&quot; title=&quot;TTF file leakage in font cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4963&quot;&gt;PDFBOX-4963&lt;/a&gt;: avoid TOCTOU-like race condition when a font is needed, as suggested by Maison&lt;/p&gt;</comment>
                            <comment id="17202517" author="jira-bot" created="Sat, 26 Sep 2020 04:37:10 +0000"  >&lt;p&gt;Commit 1882035 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882035&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4963&quot; title=&quot;TTF file leakage in font cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4963&quot;&gt;PDFBOX-4963&lt;/a&gt;: avoid TOCTOU-like race condition when a font is needed, as suggested by Maison&lt;/p&gt;</comment>
                            <comment id="17202520" author="jira-bot" created="Sat, 26 Sep 2020 05:31:25 +0000"  >&lt;p&gt;Commit 1882038 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882038&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4963&quot; title=&quot;TTF file leakage in font cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4963&quot;&gt;PDFBOX-4963&lt;/a&gt;: avoid memory leak when a SoftReference font cleared, as suggested by Maison&lt;/p&gt;</comment>
                            <comment id="17202521" author="jira-bot" created="Sat, 26 Sep 2020 05:31:29 +0000"  >&lt;p&gt;Commit 1882039 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1882039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1882039&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4963&quot; title=&quot;TTF file leakage in font cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4963&quot;&gt;PDFBOX-4963&lt;/a&gt;: avoid memory leak when a SoftReference font cleared, as suggested by Maison&lt;/p&gt;</comment>
                            <comment id="17202522" author="tilman" created="Sat, 26 Sep 2020 05:34:34 +0000"  >&lt;p&gt;Thanks for the analysis... I&apos;ve seen so many articles about &lt;tt&gt;finalize()&lt;/tt&gt; being bad.&lt;/p&gt;

&lt;p&gt;There are reference queues, but I&apos;ve not really understood the concept&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/1638859/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/1638859/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and we would have to export a member that is currently private.&lt;/p&gt;</comment>
                            <comment id="17204147" author="tilman" created="Tue, 29 Sep 2020 17:08:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=momaison&quot; class=&quot;user-hover&quot; rel=&quot;momaison&quot;&gt;momaison&lt;/a&gt; Do you have a way to test this? The risk is that the finalizer might run too late or not at all.&lt;/p&gt;</comment>
                            <comment id="17205489" author="momaison" created="Thu, 1 Oct 2020 12:53:39 +0000"  >&lt;p&gt;Unfortunately no.&lt;br/&gt;
I&apos;ve tried to reproduce the problem, but no luck up to now (except the duplicate addFont() in case of multi-thread pdf rendering ; but that shouldn&apos;t be the main source of problem ?)&lt;/p&gt;

&lt;p&gt;Regarding the added finalizers, indeed all articles I could find on internet suggest that it is bad idea. The best alternative seems to be the reference queue, but as you mention the TrueTypeFont would have to somehow publish its internal &lt;tt&gt;TTFDataStream data;&lt;/tt&gt; it can publish this member as a Closeable however : &lt;tt&gt;Closeable getInnerCloseable()&lt;/tt&gt; ?&lt;/p&gt;
</comment>
                            <comment id="17205732" author="tilman" created="Thu, 1 Oct 2020 18:12:07 +0000"  >&lt;p&gt;Yeah but there might still be people who abuse this by casting it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I found another article:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.infoworld.com/article/2077581/java-tip-79--interact-with-garbage-collector-to-avoid-memory-leaks.html?page=2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.infoworld.com/article/2077581/java-tip-79--interact-with-garbage-collector-to-avoid-memory-leaks.html?page=2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I still haven&apos;t fully understood the concept, but that article looks like one can queue the real element.&lt;/p&gt;

&lt;p&gt;These refererence queues are so obscure that even &quot;Effective Java&quot; doesn&apos;t mention them.&lt;/p&gt;</comment>
                            <comment id="17206600" author="tilman" created="Sat, 3 Oct 2020 04:13:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/a/41379293/535646&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/a/41379293/535646&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The &quot;update&quot; segment mentions that get() will always return null, so it&apos;s useless to expect the real object (I tried before finding this SO question). Which takes us back to the SO answer I mentioned first.&lt;/p&gt;

&lt;p&gt;I think I mostly understand now. And now I think this ReferenceQueue is useless even if we export the Closeable because using this ReferenceQueue does not solve the problem that we don&apos;t know WHEN the object will be finalized.&lt;/p&gt;

&lt;p&gt;We&apos;d probably have to do something completely different, like some LRU cache, or no cache at all except the standard 14.&lt;/p&gt;</comment>
                            <comment id="17207856" author="momaison" created="Mon, 5 Oct 2020 06:48:11 +0000"  >&lt;p&gt;Yes, the font cache holding Closeable objects in SoftReferences is a java challenge... Unless fonts caching is refactored, I am afraid that using a reference queue is the only way to go.&lt;/p&gt;

&lt;p&gt; Note that when referent becomes unreachable and the rerefence is cleared, the reference is somehow &quot;guaranteed&quot; to be added to the reference queue : this occurs before finalization (which can be delayed).&lt;/p&gt;

&lt;p&gt; Now, emptying this queue can be performed by the thread who calls getFont() or addFont() : this is exactly what guava cache does when SoftReferences are used : SoftReferences are created with a queue &apos;segment.valueReferenceQueue&apos; here :&lt;br/&gt;
 &#160; &lt;a href=&quot;https://github.com/google/guava/blob/master/guava/src/com/google/common/cache/LocalCache.java#L400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/google/guava/blob/master/guava/src/com/google/common/cache/LocalCache.java#L400&lt;/a&gt;&lt;br/&gt;
 and this queue is processed in drainValueReferenceQueue() : &lt;a href=&quot;https://github.com/google/guava/blob/master/guava/src/com/google/common/cache/LocalCache.java#L2468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/google/guava/blob/master/guava/src/com/google/common/cache/LocalCache.java#L2468&lt;/a&gt;&lt;br/&gt;
 The processing is performed at several steps : get(), if possible, and IIUC at each write &lt;span class=&quot;error&quot;&gt;&amp;#91;see line 3427 : preWriteCleanup() calls runLockedCleanup()&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt; I couldn&apos;t find a way to use this ref queue pattern without a getter {{ TrueTypeFont.getRAFStream()}}, which indeed slightly pollutes API.&lt;/p&gt;</comment>
                            <comment id="17622961" author="JIRAUSER297386" created="Mon, 24 Oct 2022 05:54:19 +0000"  >&lt;p&gt;Hey guys.&lt;br/&gt;
Is there a solution in this case? Please let me know if you have a solution, even if it is tentative. An actual example would be very helpful. Also, has anyone tried this with other versions? (e.g., version 3)&lt;br/&gt;
Thank you in advance.&lt;/p&gt;</comment>
                            <comment id="17623347" author="momaison" created="Mon, 24 Oct 2022 18:49:09 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;This bug has somehow been fixed by overriding TrueTypeFont.finalize() method. From my observations, although not optimal, this works (at least with jdk11).&lt;/p&gt;

&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5362&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PDFBOX-5362&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17624321" author="JIRAUSER297386" created="Wed, 26 Oct 2022 09:38:30 +0000"  >&lt;p&gt;Thank you for your prompt reply.&lt;br/&gt;
I was able to confirm that GC works and finalize() runs a lot, but it is leaking.&lt;br/&gt;
We worked around this by changing the processing sequence so that the font object is static and can be used around.&lt;br/&gt;
If it is not released, the idea is to make it resident. (It&apos;s tentative, with an anti-pattern.)&lt;br/&gt;
I will also consider overriding the finalize() method.&lt;br/&gt;
Thank you very much.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ivi8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>