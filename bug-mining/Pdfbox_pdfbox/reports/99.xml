<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:52:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-854] PDPageContentStream.drawString() doesn&apos;t work with all PDFs</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-854</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I add custom text to misc exsiting PDF files. Now I wondered why my text doesn&apos;t appear for a specific PDF. It is not encrypted, has the same page size and adding Text with iText 2.1.7 works as expected. My code to add text is:&lt;/p&gt;

&lt;p&gt;----------------------------------&lt;br/&gt;
                            final PDPage page = (PDPage) allPages.get&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
                            final PDPageContentStream contentStream = new PDPageContentStream(doc, page, true, false);&lt;br/&gt;
                            contentStream.beginText();&lt;br/&gt;
                            contentStream.setFont(font, sizeOfFont);&lt;br/&gt;
                            contentStream.moveTextPositionByAmount(xf, yf);&lt;br/&gt;
                            contentStream.drawString(text);&lt;br/&gt;
                            contentStream.endText();&lt;br/&gt;
                            contentStream.close();&lt;br/&gt;
---------------------------------&lt;/p&gt;

&lt;p&gt;I tried to find differences between this PDF and other PDFs. What I noticed: the PDF where I can&apos;t see the text has a PDF-Version &quot;1.3&quot; and was created by &quot;AFPL Ghostscript 8.54&quot;. Is there some known issue with PDFBox and such &quot;older&quot; PDF formats?&lt;/p&gt;</description>
                <environment>JDK 1.6.0_21</environment>
        <key id="12476672">PDFBOX-854</key>
            <summary>PDPageContentStream.drawString() doesn&apos;t work with all PDFs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="mhilpert">MH</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Oct 2010 13:44:01 +0000</created>
                <updated>Mon, 20 Dec 2010 09:38:20 +0000</updated>
                            <resolved>Sat, 11 Dec 2010 17:15:38 +0000</resolved>
                                    <version>1.3.1</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>PDModel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12918900" author="mhilpert" created="Thu, 7 Oct 2010 12:35:05 +0000"  >&lt;p&gt;Example PDF to demonstrate this effect. The website is in A4 as other test PDFs are also A4 and the added text is always printed at the same x/y location. I also upgraded GhostScript to 8.64 and configured to output in PDF-1.4. But this didn&apos;t help: the text is still not displayed and no error occurs.&lt;/p&gt;</comment>
                            <comment id="12918942" author="lehmi" created="Thu, 7 Oct 2010 15:18:16 +0000"  >&lt;p&gt;What text did you add to the pdf? What font did you use? Did you save the pdf?&lt;/p&gt;</comment>
                            <comment id="12919003" author="mhilpert" created="Thu, 7 Oct 2010 18:21:39 +0000"  >&lt;p&gt;The text consists of numbers/digits, spaces and &apos;-&apos; signs. The font doesn&apos;t matter as the same behaviour is for arbitrary fonts. Yes I saved the PDF of course, otherwise I wouldn&apos;t see the result. This is not a &quot;first implementation&quot; bug, as adding this text was formelry done with iText 2.1.7. Then I change the implementation to use PDFBox and it worked without errors as expected, i.e. the text is written as expected. This works for self-generated PDFs via Apache FOP that are postprocessed with PDFBox (contatenation, properties setting). The last step is adding text to a document. And now I have some external PDFs like I posted as an attachement (generated via Windows print to PDF printer that generates the PDF with Ghostscript). And the very same code that writes the text to all other PDF pages, fails with this PDF - with &quot;fails&quot;, I mean: the resulting PDF does not show the text added. I debugged my method to see if there is some swallowed exception, but the debugger steps as expected through each line as with all other PDFs, with same page size, same fonts, same x/y location of the text, even same text content, for not encrypted PDFs. So, no error, no exception, but the resulting PDF does not have/show the added text. I also tried the latest 1.3.0-snapshot of PDFBox, but without any progress.&lt;/p&gt;</comment>
                            <comment id="12919050" author="lehmi" created="Thu, 7 Oct 2010 20:27:11 +0000"  >&lt;p&gt;Can you be more specific about the text? I&apos;d like to search for some hints in the resulting pdf and without knowing the exact string that would be difficult. I&apos;d also like to know some details about the used font. Do you use an external font? Is the font embedded into the pdf? Do you try to use a font from the original pdf?&lt;/p&gt;</comment>
                            <comment id="12919201" author="mhilpert" created="Fri, 8 Oct 2010 08:43:02 +0000"  >&lt;p&gt;Okay, the text is e.g. &quot;23 - 35&quot;. Your questions about the used font are interesting: for the PDFs that &quot;work&quot;, they are generated with the same fonts as the font used for the additional text, i.e. the font is also embedded in the PDF. For the external PDF, this must not necessarily be true! &lt;/p&gt;

&lt;p&gt;Just to repeat: if I exchange my method with the iText implementation, the text is written with the same parameters (PDF, Text, Font, etc.) =&amp;gt; it&apos;s something within PDFBox.&lt;/p&gt;

&lt;p&gt;I debugged my code again: I can&apos;t see any differences in the PDFBox calls. The font is also loaded. I use:&lt;/p&gt;

&lt;p&gt;font = PDTrueTypeFont.loadTTF(doc, nameOfFont);&lt;/p&gt;

&lt;p&gt;and the javadoc for this method says:&lt;/p&gt;

&lt;p&gt;&quot;This will load a TTF font from a font file.&lt;/p&gt;

&lt;p&gt;doc The PDF document that will hold the embedded font.&lt;br/&gt;
file The file on the filesystem that holds the font file.&quot;&lt;/p&gt;

&lt;p&gt;So it loads a font from the file system and embeds it in the destination document =&amp;gt; the font has not to be embedded in the destination PDF as it is loaded from the file system and will be embedded in the destination doc.&lt;/p&gt;

&lt;p&gt;Perhaps you will see the difference bettwer when you try to add text with a different font than any of the PDF fonts. (As this seems to be the problem.)&lt;/p&gt;</comment>
                            <comment id="12919209" author="mhilpert" created="Fri, 8 Oct 2010 09:40:42 +0000"  >&lt;p&gt;I tried to trick PDFBox: I called my method 2 times in hope that the first call will embed the font and the second call would be sure that the used font is embedded in the PDF. Here&apos;s the result:&lt;/p&gt;

&lt;p&gt;1. it didn&apos;t help, i.e. the text is still not display. =&amp;gt; it seems that the problem is not, that the used font for the additional text is not already embedded in the destination PDF.&lt;/p&gt;

&lt;p&gt;2. after the first call, the font is embedded in the destination PDF. The second call loads this PDF and will embed the font A SECOND TIME in the result PDF! So the result PDF after the second call shows 2 times the same font as embedded (viewed with Acrobat Reader). Then I checked all my PDFs (concatenated and postprocessed with PDFBox) and noticed that after each postprocessing status, the fonts get duplicated again and again! =&amp;gt; another bug?&lt;/p&gt;</comment>
                            <comment id="12919254" author="mhilpert" created="Fri, 8 Oct 2010 12:06:36 +0000"  >&lt;p&gt;Ha! It&apos;s not the font! It&apos;s the coordinates! added some &quot;debug&quot; code:&lt;/p&gt;

&lt;p&gt;-----------------------&lt;br/&gt;
                                contentStream.beginText();&lt;br/&gt;
                                contentStream.setStrokingColor(java.awt.Color.red); //test&lt;br/&gt;
                                contentStream.setNonStrokingColor(java.awt.Color.blue); //test: text (foreground) color&lt;br/&gt;
                                contentStream.drawLine(0.0f, 0.0f, 100.0f, 200.0f); //test&lt;br/&gt;
                                contentStream.setFont(font, sizeOfFont);&lt;/p&gt;

&lt;p&gt;                                contentStream.moveTextPositionByAmount(xf, yf);&lt;br/&gt;
                                contentStream.drawString(text);&lt;/p&gt;

&lt;p&gt;                                contentStream.moveTextPositionByAmount(-xf, -yf); //test&lt;br/&gt;
                                contentStream.drawString(text+&quot; ***&quot;); //test&lt;/p&gt;

&lt;p&gt;                                contentStream.endText();&lt;br/&gt;
------------------------&lt;/p&gt;

&lt;p&gt;And here&apos;s the result:&lt;/p&gt;

&lt;p&gt;The &quot;missing&quot; text is probably not missing but drawn at the wrong place! First I added the colors, then the line. For the PDFs with the &quot;visible&quot; (correct) text, the line draws from the bottom left corner upwards+right. For the PDFs with the &quot;missing&quot; text, the line draws from the TOP left corner downwards+right!!! &lt;/p&gt;

&lt;p&gt;Then I added &quot;text+***&quot; and this text also got drawn on the problematic PDFS: for the &quot;good&quot; PDFS, the additional text is written horizontally at the bottom left corner. For the &quot;bad&quot; PDFs, the text is written VERTICALLY starting from the TOP left corner!&lt;/p&gt;

&lt;p&gt;=&amp;gt; somehow the coordinates (system) is different in the problematic PDFs!&lt;/p&gt;</comment>
                            <comment id="12919269" author="mhilpert" created="Fri, 8 Oct 2010 12:38:22 +0000"  >&lt;p&gt;I searched for some bug reports concerning coordinates and found e.g. &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-828&quot; title=&quot;Spaces dissapear and text is shifted left&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-828&quot;&gt;&lt;del&gt;PDFBOX-828&lt;/del&gt;&lt;/a&gt; from 30.09.2010. So I reveretd pdfbox/fontbox/jempbox back to the 1.2.1 release but the same problem exists there. I also browsed the PDFBox API to somehow read the coordinate system, also inspected PDPage.getRotation() which returned null or 90 and wasn&apos;t related to the &quot;good&quot; and &quot;bad&quot; PDFs.&lt;/p&gt;

&lt;p&gt;Is there a way to get the coordinate&apos;s system &quot;orientation&quot;, so we can at least work around this by transforming x,y location and text rotation?&lt;/p&gt;</comment>
                            <comment id="12921271" author="lehmi" created="Fri, 15 Oct 2010 08:03:33 +0000"  >&lt;p&gt;The problem is the current transformation matrix (ctm). It is defined for every page and can&apos;t be reset to an user-defined value. Every change to it will be done by concatenating a new ctm to it (see cm-operator for further details). The matrix maps positions from user coordinates to device coordinates. In your case it is among other things used to create a landscape pdf. PDFBox provides a sample on how to create landscpae pdfs &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;br/&gt;
I don&apos;t know any way to get the ctm without parsing the contentstream before adding further content. Can you attach a iText example pdf? Probably we can learn from that how to compensate a ctm.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/viewvc/pdfbox/trunk/pdfbox/src/main/java/org/apache/pdfbox/examples/pdmodel/CreateLandscapePDF.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/pdfbox/trunk/pdfbox/src/main/java/org/apache/pdfbox/examples/pdmodel/CreateLandscapePDF.java?view=markup&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12922072" author="mhilpert" created="Mon, 18 Oct 2010 13:45:30 +0000"  >&lt;p&gt;Example of text addition with iText 2.1.7. The text added is &quot;1 - 1&quot; at the lower right corner of the landscape page. The same text added with PDFBox on the same source PDF is added somwehere else outside the A4 visibility.&lt;/p&gt;</comment>
                            <comment id="12922629" author="lehmi" created="Tue, 19 Oct 2010 17:32:05 +0000"  >&lt;p&gt;Gotcha!! Instead of just adding a new stream iText first inserts a new stream at the beginning. This stream only contains a &quot;q&quot;-command to save the initial graphics state. After that the original stream is added. Finally a third stream is created, which starts with a &quot;Q-command&quot; to restore the initial graphics state without any modifications especially no changes to the ctm. That&apos;s quite smart. I&apos;ll improve the PDPageStreamContent constructor to copy that behaviour.&lt;/p&gt;</comment>
                            <comment id="12970481" author="lehmi" created="Sat, 11 Dec 2010 17:08:35 +0000"  >&lt;p&gt;I added some text to the given example using the new possibility to reset the graphics context of an existing content stream.&lt;/p&gt;</comment>
                            <comment id="12970482" author="lehmi" created="Sat, 11 Dec 2010 17:15:38 +0000"  >&lt;p&gt;I added the discussed functionality to the PDPageContentStream class in revision 1044678. I also improved the AddMessageToEachPage example &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; to demonstrate how to use it.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://svn.apache.org/viewvc/pdfbox/trunk/pdfbox/src/main/java/org/apache/pdfbox/examples/pdmodel/AddMessageToEachPage.java?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/pdfbox/trunk/pdfbox/src/main/java/org/apache/pdfbox/examples/pdmodel/AddMessageToEachPage.java?view=markup&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12970777" author="mhilpert" created="Mon, 13 Dec 2010 10:51:13 +0000"  >&lt;p&gt;Tested with latest snapshots (pdfbox-1.4.0-20101211.181302-26.jar, fontbox-1.4.0-20101211.181302-27.jar, jempbox-1.4.0-20101211.181302-27.jar), ensured to recompile everything (log shows new PDFBox version number) but text &quot;jumped&quot; all over the place. I had to do translations of my &quot;original&quot; x/y coordinates myself that I expected PDFBox is doing for me:&lt;/p&gt;

&lt;p&gt;------------------------------------------------------------------------------&lt;br/&gt;
cs.beginText();&lt;br/&gt;
cs.setFont(font, sizeOfFont);&lt;/p&gt;

&lt;p&gt;final int rotation = page.findRotation();&lt;br/&gt;
final PDRectangle pageSize = page.findMediaBox();&lt;br/&gt;
final float tf = xf; //temporary save xf value&lt;br/&gt;
switch (rotation) {&lt;br/&gt;
case 90 :&lt;br/&gt;
    xf = pageSize.getWidth() - yf;&lt;br/&gt;
    yf = tf;&lt;br/&gt;
    cs.setTextRotation(Math.PI/2.0, xf, yf); //rotate text 90&#176; counterclockwise&lt;br/&gt;
    break;&lt;br/&gt;
case 180 : //NOT tested!&lt;br/&gt;
    xf = -xf;&lt;br/&gt;
    yf = pageSize.getHeight() - yf;&lt;br/&gt;
    cs.setTextTranslation(xf, yf); //move to x/y position without text rotation&lt;br/&gt;
    break;&lt;br/&gt;
case 270 : //NOT tested!&lt;br/&gt;
    xf = -pageSize.getWidth() + yf;&lt;br/&gt;
    yf = -tf;&lt;br/&gt;
    cs.setTextRotation(Math.PI/2.0, xf, yf); //rotate text 90&#176; counterclockwise&lt;br/&gt;
    break;&lt;br/&gt;
case 0 :&lt;br/&gt;
case 360 : //NOT tested!&lt;br/&gt;
default:&lt;br/&gt;
    cs.setTextTranslation(xf, yf); //move to x/y position without text rotation&lt;br/&gt;
    break;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;//cs.moveTextPositionByAmount(xf, yf);&lt;br/&gt;
cs.drawString(text);&lt;br/&gt;
-------------------------------------------------------------------------&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457444" name="Text_Added_With_iText.zip" size="82793" author="mhilpert" created="Mon, 18 Oct 2010 13:45:30 +0000"/>
                            <attachment id="12456592" name="Website_A4_Landscape_PDF14.zip" size="77579" author="mhilpert" created="Thu, 7 Oct 2010 12:35:05 +0000"/>
                            <attachment id="12466061" name="Website_A4_Landscape_PDF14_addedText.pdf" size="87092" author="lehmi" created="Sat, 11 Dec 2010 17:08:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163533</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0zjif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>205463</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>