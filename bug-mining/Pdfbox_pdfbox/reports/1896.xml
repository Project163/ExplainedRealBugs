<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:06:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4028] SaveIncremental on same opened file</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4028</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;The incremental save does not work correctly if it is done on the same opened document. It produces corrupted file. The save incremental should append changes at the end of file (after last origin EOF).&lt;br/&gt;
Newly saved file contains changes also in the middle of the file not only at the end. Changes in the middle of file contains zeroed bytes or garbage. &lt;/p&gt;

&lt;p&gt;Tested with the latest stable version of PDFBox 2.0.8.&lt;/p&gt;

&lt;p&gt;Sample code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fileName = &lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/document.pdf&quot;&lt;/span&gt;;
PDDocument doc = PDDocument.load((&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(fileName));
...
document changes
...
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; ( OutputStream outStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(fileName)) {
	doc.saveIcremental(outStream);
}
&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; ....
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13123141">PDFBOX-4028</key>
            <summary>SaveIncremental on same opened file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mato7d5">Martin Mancuska</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Dec 2017 09:49:50 +0000</created>
                <updated>Sun, 7 Jan 2018 13:25:50 +0000</updated>
                                            <version>2.0.8</version>
                                                    <component>Writing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16280504" author="tilman" created="Wed, 6 Dec 2017 17:00:21 +0000"  >&lt;p&gt;SaveIncremental is used only for signing. It does not work very well on other incremental changes, this is one of the oldest issues (&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-45&quot; title=&quot;Support incremental save&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-45&quot;&gt;&lt;del&gt;PDFBOX-45&lt;/del&gt;&lt;/a&gt;). Please submit a test case, i.e. a PDF file that is corrupted by your code. Please complete the code to show the smallest possible change to the PDF that triggers the effect. I know only about trouble when there is a signature in the PDF.&lt;/p&gt;</comment>
                            <comment id="16283691" author="mato7d5" created="Fri, 8 Dec 2017 15:01:56 +0000"  >&lt;p&gt;Usually it fails on larger files (small are not affected). I cannot provide internal PDF file, but PDF reference 1.7 can be used for this purpose of testing. I&apos;ve attached to this case.&lt;br/&gt;
Here is piece of code, pls update path to PDF file according to your environment:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-comment&quot;&gt;//    encryptFile();
&lt;/span&gt;            PDDocument doc = PDDocument.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;e:\\pdf_reference_1-7.pdf&quot;&lt;/span&gt;));
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;# Pages: &quot;&lt;/span&gt; + doc.getPages().getCount() + &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt;);
            
            PDStructureTreeRoot stRoot = doc.getDocumentCatalog().getStructureTreeRoot();
            COSDictionary stDict = stRoot.getCOSObject();
            stDict.setNeedToBeUpdated(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            COSDictionary catalogDict = doc.getDocumentCatalog().getCOSObject();
            catalogDict.setNeedToBeUpdated(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            saveIncremental(doc, &lt;span class=&quot;code-quote&quot;&gt;&quot;e:\\pdf_reference_1-7 copy.pdf&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;//This is ok
&lt;/span&gt;            saveIncremental(doc, &lt;span class=&quot;code-quote&quot;&gt;&quot;e:\\pdf_reference_1-7.pdf&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;//This gets corrupted
&lt;/span&gt;                 
            doc.close();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InvalidPasswordException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ex) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;IO chyba.&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16284961" author="tilman" created="Sat, 9 Dec 2017 19:04:09 +0000"  >&lt;p&gt;I looked at the &quot;bad&quot; result file, and it starts with content that belongs to position 4898816. That number is 2^14 * 13 * 23.&lt;/p&gt;

&lt;p&gt;2^14 = 16384 which is a typical buffer size.&lt;/p&gt;

&lt;p&gt;My theory is that something goes wrong while reading a RandomAccessFile and writing a FileOutputStream. I&apos;ve tried to simplify the code in COSWriter to this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void doWriteIncrement() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        ByteArrayOutputStream baos = (ByteArrayOutputStream) output; &lt;span class=&quot;code-comment&quot;&gt;// that&apos;s the incremental part
&lt;/span&gt;
        IOUtils.copy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessInputStream(incrementalInput), incrementalOutput);
        incrementalOutput.write(baos.toByteArray());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and it still happened. Even if I read from incrementalInput directly and wrote into incrementalOutput and took care to seek in between, it still happened.&lt;/p&gt;</comment>
                            <comment id="16286483" author="tilman" created="Mon, 11 Dec 2017 20:13:30 +0000"  >&lt;p&gt;This code produces an empty file:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;PDF_32000_2008.pdf&quot;&lt;/span&gt;;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;PDF_32000_2008 - Kopie.pdf&quot;&lt;/span&gt;;
        Files.copy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(name1).toPath(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(name2).toPath(),  StandardCopyOption.REPLACE_EXISTING);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (RandomAccessFile raf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessFile(name2, &lt;span class=&quot;code-quote&quot;&gt;&quot;r&quot;&lt;/span&gt;);
             FileOutputStream fos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(name2))
        {
            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] buffer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[4096];
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n;
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (-1 != (n = raf.read(buffer)))
            {
                fos.write(buffer, 0, n);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So there&apos;s no way you could get a good result by overwriting your input file. What remains is the question why there isn&apos;t an exception.&lt;/p&gt;

&lt;p&gt;This code produces a bad result. When debugging one can see that the first write has correct data, the second one has 4096 zeroes.&lt;/p&gt;

&lt;p&gt;RandomAccessBufferedFileInputStream uses RandomAccessFile inside.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;PDF_32000_2008.pdf&quot;&lt;/span&gt;;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;PDF_32000_2008 - Kopie.pdf&quot;&lt;/span&gt;;
        Files.copy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(name1).toPath(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(name2).toPath(),  StandardCopyOption.REPLACE_EXISTING);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (RandomAccessBufferedFileInputStream raf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessBufferedFileInputStream(name2);
             FileOutputStream fos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(name2))
        {
            &lt;span class=&quot;code-comment&quot;&gt;// at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; time, the destination file is empty
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] buffer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[4096];
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n;
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (-1 != (n = raf.read(buffer)))
            {
                fos.write(buffer, 0, n);
                fos.flush();
                fos.getFD().sync();
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One might argue that it is a bug in RandomAccessBufferedFileInputStream... It does a seek past the new end and then reads nothing. But this isn&apos;t reported in any way.&lt;/p&gt;

&lt;p&gt;I tried throwing an exception but existing tests failed.&lt;/p&gt;

&lt;p&gt;I then modified RandomAccessBufferedFileInputStream to use the actual file length instead of the one from the beginning... the result is empty.&lt;/p&gt;

&lt;p&gt;So for your test, you&apos;d only get the increment part.&lt;/p&gt;

&lt;p&gt;Thus what you do will always fail.&lt;/p&gt;

&lt;p&gt;What you did is a bad idea anyway, even if it would be possible to write while reading. Imaging a power failure while writing - you&apos;d have your PDF in an unknown state.&lt;/p&gt;</comment>
                            <comment id="16287660" author="mato7d5" created="Tue, 12 Dec 2017 14:14:04 +0000"  >&lt;p&gt;We solved this problem by workaround -&amp;gt; performing save incremental into the temporary file and then replace the original by this temporary file.&lt;br/&gt;
I don&apos;t think that it&apos;s bad idea to do incremental save into same file. User should have option to save/update current file.&lt;/p&gt;</comment>
                            <comment id="16315257" author="jira-bot" created="Sun, 7 Jan 2018 13:25:45 +0000"  >&lt;p&gt;Commit 1820455 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1820455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1820455&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4028&quot; title=&quot;SaveIncremental on same opened file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4028&quot;&gt;PDFBOX-4028&lt;/a&gt;: improve javadoc that destination stream should not point to source&lt;/p&gt;</comment>
                            <comment id="16315258" author="jira-bot" created="Sun, 7 Jan 2018 13:25:50 +0000"  >&lt;p&gt;Commit 1820456 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1820456&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1820456&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4028&quot; title=&quot;SaveIncremental on same opened file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4028&quot;&gt;PDFBOX-4028&lt;/a&gt;: improve javadoc that destination stream should not point to source&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12901248" name="pdf_reference_1-7.pdf" size="32472771" author="mato7d5" created="Fri, 8 Dec 2017 15:04:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nlfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>