<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:14:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-5784] AppearanceGeneratorHelper assumes fontscale 1000</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-5784</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;The user in the attached SO question noticed that the comb adjustment needed a factor of 2 to work correctly. A look at the font shows UnitsPerEm = 2048.&lt;/p&gt;

&lt;p&gt;Sample code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
doc.getDocumentCatalog().getAcroForm().getField(&lt;span class=&quot;code-quote&quot;&gt;&quot;field1&quot;&lt;/span&gt;).setValue(&lt;span class=&quot;code-quote&quot;&gt;&quot;WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW&quot;&lt;/span&gt;);
doc.getDocumentCatalog().getAcroForm().getField(&lt;span class=&quot;code-quote&quot;&gt;&quot;field2&quot;&lt;/span&gt;).setValue(&lt;span class=&quot;code-quote&quot;&gt;&quot;MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13067387/13067387_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13571508">PDFBOX-5784</key>
            <summary>AppearanceGeneratorHelper assumes fontscale 1000</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="msahyoun">Maruan Sahyoun</assignee>
                                    <reporter username="tilman">Tilman Hausherr</reporter>
                        <labels>
                            <label>Appearance</label>
                    </labels>
                <created>Mon, 11 Mar 2024 16:34:33 +0000</created>
                <updated>Fri, 2 Aug 2024 03:44:04 +0000</updated>
                            <resolved>Fri, 5 Apr 2024 08:58:10 +0000</resolved>
                                                    <fixVersion>2.0.32</fixVersion>
                    <fixVersion>3.0.3 PDFBox</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>AcroForm</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17825738" author="lehmi" created="Tue, 12 Mar 2024 16:59:27 +0000"  >&lt;p&gt;At least for TrueType fonts we have to take the value of unitsPerEM into account. In most cases it is 1000 but there are fonts using 2048.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.fontbox.ttf.TrueTypeFont.getUnitsPerEm()&lt;/tt&gt;  can be used to get that value&lt;/p&gt;</comment>
                            <comment id="17825743" author="tilman" created="Tue, 12 Mar 2024 17:13:29 +0000"  >&lt;p&gt;There is a usage in DrawPrintTextLocations.java for the type 0 font too. I thought this issue is a low hanging fruit (just replace FONTSCALE) but it&apos;s not &#128514;&lt;/p&gt;</comment>
                            <comment id="17825925" author="lehmi" created="Wed, 13 Mar 2024 07:09:34 +0000"  >&lt;p&gt;IMHO there are two possible solutions. Either we add something like the following to AppearanceGeneratorHelper&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getFontScale(PDFont font) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (font &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PDTrueTypeFont)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ((PDTrueTypeFont) font).getTrueTypeFont().getUnitsPerEm();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (font &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PDType0Font)
        {
            PDCIDFont cidFont = ((PDType0Font) font).getDescendantFont();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cidFont &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PDCIDFontType2)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ((PDCIDFontType2) cidFont).getTrueTypeFont().getUnitsPerEm();
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DEFAULT_FONTSCALE;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Or we are extending PDFont with a similar implementation&lt;/p&gt;</comment>
                            <comment id="17825928" author="tilman" created="Wed, 13 Mar 2024 07:23:14 +0000"  >&lt;p&gt;What I meant is that even if we replace FONTSCALE with the actual value, i.e. 2048 here, the result is still wrong in this code line:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; currCharWidth = font.getStringWidth(combString) / FONTSCALE * fontSize/2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here replacing it would be almost as if dividing by 2 once more, however the SO person removed &quot;/2&quot; i.e. multiplied by 2.&lt;/p&gt;

&lt;p&gt;Maybe we need to do similar, i.e. multiplying by (UnitsPerEm / FONTSCALE).&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;getStringWidth&lt;/tt&gt; uses 1000, I couldn&apos;t find in the code that it does any adjustment, which means that its value would be too small.&lt;/p&gt;</comment>
                            <comment id="17825937" author="msahyoun" created="Wed, 13 Mar 2024 07:36:10 +0000"  >&lt;p&gt;Feel free to assign it to me - I have off next week and planned to do some PDFBox programming.&lt;/p&gt;</comment>
                            <comment id="17825947" author="msahyoun" created="Wed, 13 Mar 2024 07:45:00 +0000"  >&lt;p&gt;From the screen shots one can see that neither with dividing by 2 nor without the characters are correctly placed centred within the comb boxes. It&apos;s also a good test to do the same filling with Adobe tooling to compare the output and generated appearance. &lt;/p&gt;</comment>
                            <comment id="17832195" author="msahyoun" created="Fri, 29 Mar 2024 12:57:36 +0000"  >&lt;p&gt;I have a working solution which works better as the initial offset of the first character was calculated wrongly. All the other offsets, padding etc. match what Adobe generates. Unfortunately the initial offset still doesn&apos;t match the value to be compared with. I first need to generate more examples to understand the calculation better and reengineer from that.&lt;/p&gt;</comment>
                            <comment id="17834176" author="jira-bot" created="Fri, 5 Apr 2024 07:36:36 +0000"  >&lt;p&gt;Commit 1916814 from Maruan Sahyoun in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1916814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1916814&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5784&quot; title=&quot;AppearanceGeneratorHelper assumes fontscale 1000&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5784&quot;&gt;&lt;del&gt;PDFBOX-5784&lt;/del&gt;&lt;/a&gt;: fix character alignment, draw dviders for comb&lt;/p&gt;</comment>
                            <comment id="17834177" author="jira-bot" created="Fri, 5 Apr 2024 07:37:34 +0000"  >&lt;p&gt;Commit 1916815 from Maruan Sahyoun in branch &apos;pdfbox/branches/3.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1916815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1916815&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5784&quot; title=&quot;AppearanceGeneratorHelper assumes fontscale 1000&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5784&quot;&gt;&lt;del&gt;PDFBOX-5784&lt;/del&gt;&lt;/a&gt;: fix character alignment, draw dviders for comb&lt;/p&gt;</comment>
                            <comment id="17834179" author="jira-bot" created="Fri, 5 Apr 2024 07:43:08 +0000"  >&lt;p&gt;Commit 1916816 from Maruan Sahyoun in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1916816&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1916816&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5784&quot; title=&quot;AppearanceGeneratorHelper assumes fontscale 1000&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5784&quot;&gt;&lt;del&gt;PDFBOX-5784&lt;/del&gt;&lt;/a&gt;: fix character alignment, draw dviders for comb&lt;/p&gt;</comment>
                            <comment id="17834181" author="msahyoun" created="Fri, 5 Apr 2024 07:48:38 +0000"  >&lt;p&gt;I&apos;ve fixed the character positioning and also added some code to draw the dividers for comb fields if the field has border set which hasn&apos;t been done before. There are edge cases which I need to look into in more detail - field is not high enough and comb is smaller than character width. for these the expected result can be seen in the right column of fields of the form template which has been filled using Acrobat.&lt;/p&gt;

&lt;p&gt;What we can also see in comparing the content streams is that the positions of the characters are slighty different to how Acrobat places these. This is also true for most of the other form filling results. It looks like Adobe is taking additional/other font metrics into account than we do.&lt;/p&gt;</comment>
                            <comment id="17834182" author="msahyoun" created="Fri, 5 Apr 2024 07:49:21 +0000"  >&lt;p&gt;IMHO we are done here and can close the ticket. The edge cases can be dealt with in another ticket. WDYT?&lt;/p&gt;</comment>
                            <comment id="17834199" author="jira-bot" created="Fri, 5 Apr 2024 08:28:44 +0000"  >&lt;p&gt;Commit 1916817 from Maruan Sahyoun in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1916817&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1916817&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-5784&quot; title=&quot;AppearanceGeneratorHelper assumes fontscale 1000&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-5784&quot;&gt;&lt;del&gt;PDFBOX-5784&lt;/del&gt;&lt;/a&gt;: don&apos;t use Math.floorDiv&lt;/p&gt;</comment>
                            <comment id="17834205" author="tilman" created="Fri, 5 Apr 2024 08:52:42 +0000"  >&lt;p&gt;I agree + thanks for fixing this!&lt;/p&gt;</comment>
                            <comment id="17834207" author="msahyoun" created="Fri, 5 Apr 2024 08:56:49 +0000"  >&lt;p&gt;It&apos;s always a bit tricky to fix these layout things as they are not documented. &lt;/p&gt;</comment>
                            <comment id="17834208" author="msahyoun" created="Fri, 5 Apr 2024 08:58:10 +0000"  >&lt;p&gt;Setting to resolved - edge cases will be dealt with in a different low pri ticket&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13587620">PDFBOX-5859</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13067806" name="PDFBOX5784-template.pdf" size="1036196" author="msahyoun" created="Tue, 2 Apr 2024 16:24:12 +0000"/>
                            <attachment id="13067387" name="screenshot-1.png" size="185812" author="tilman" created="Mon, 11 Mar 2024 16:36:31 +0000"/>
                            <attachment id="13067393" name="with_dividing_by_2.pdf" size="616651" author="tilman" created="Tue, 12 Mar 2024 08:25:06 +0000"/>
                            <attachment id="13067392" name="without_dividing.pdf" size="616651" author="tilman" created="Tue, 12 Mar 2024 08:25:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://stackoverflow.com/questions/78141089/potentially-incorrect-calculation-of-the-character-width-when-filling-in-the-acr]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 31 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nwlc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>