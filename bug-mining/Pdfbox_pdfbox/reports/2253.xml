<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:09:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4540] COSWriter sometimes retrieves wrong ObjectKey</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4540</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;If a COSBase is directly embedded in a COSObject, it should not be assigned a new object number by the writer. We suggest the following implementation for `COSWriter.getObjectKey(COSBase)`: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * This will get the object key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the object.
 *
 * @param obj The object to get the key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;.
 *
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; The object key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the object.
*/
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; COSObjectKey getObjectKey( COSBase obj )
{
    COSBase actual = obj;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( actual &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSObject )
    {
        actual = ((COSObject)obj).getObject();
    }
    COSObjectKey key = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    key = objectKeys.get(obj);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( key == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; actual != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
    {
        key = objectKeys.get(actual);
    } 
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    {
        setNumber(getNumber()+1);
        key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; COSObjectKey(getNumber(),0);
        objectKeys.put(obj, key);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( actual != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; )
        {
            objectKeys.put(actual, key);
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; key;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13232452">PDFBOX-4540</key>
            <summary>COSWriter sometimes retrieves wrong ObjectKey</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tilman">Tilman Hausherr</assignee>
                                    <reporter username="Rahn2">Jonathan</reporter>
                        <labels>
                            <label>patch</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 9 May 2019 11:43:59 +0000</created>
                <updated>Fri, 28 Jun 2019 04:39:52 +0000</updated>
                            <resolved>Fri, 10 May 2019 08:34:36 +0000</resolved>
                                    <version>2.0.14</version>
                                    <fixVersion>2.0.16</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>Writing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16836300" author="tilman" created="Thu, 9 May 2019 11:49:38 +0000"  >&lt;p&gt;If you are alleging a bug, please explain how it fails. Ideally a test that fails.&lt;/p&gt;</comment>
                            <comment id="16836310" author="rahn2" created="Thu, 9 May 2019 11:59:22 +0000"  >&lt;p&gt;Sure, I&apos;ll do. Basically, for us, it produced defective PDF files. I can retrieve the examples for you&lt;/p&gt;</comment>
                            <comment id="16836327" author="rahn2" created="Thu, 9 May 2019 12:19:39 +0000"  >&lt;p&gt;Frankly, after revisiting the issue in more detail, I&apos;m not sure if an issue would ever arise during normal use of PDFBox. We have a rather special case here, as we use PDFBox&apos;s infrastructure to write linearized pdfs. We have the following method which assigns object numbers to every object contained in the pdf:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void setObjectNumbers(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PDFObjectQueue queue,  &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LinearizedPDFWriter writer)
   {
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map.Entry&amp;lt;COSBase, ObjectMetaData&amp;gt; entry : queue.entrySet())
      {
         writer.getObjectKeys().put(entry.getKey(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; COSObjectKey(entry.getValue().objNumber, 0));  &lt;span class=&quot;code-comment&quot;&gt;// always gen 0
&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry.getKey() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSObject)
         {
            writer.getObjectKeys().put(((COSObject)entry.getKey()).getObject(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; COSObjectKey(entry.getValue().objNumber, 0));  &lt;span class=&quot;code-comment&quot;&gt;// always gen 0
&lt;/span&gt;         }
      }
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Later, when we then write the pdf, `COSWriter.doWriteObject(COSBase)` calls `COSWriter.getObjectKey(COSBase)` to obtain the `currentObjectKey` for the element to be written. Without my fix, the object will be assigned a new number, even though it was already defined previously.&lt;/p&gt;

&lt;p&gt;I&apos;ve uploaded a pdf which displays the issue when used as input.&lt;/p&gt;</comment>
                            <comment id="16836388" author="tilman" created="Thu, 9 May 2019 13:42:30 +0000"  >&lt;p&gt;Could you explain &quot;If a COSBase is directly embedded in a COSObject&quot; - a COSObject is something like &quot;16 0 R&quot; so it can&apos;t &quot;embed&quot;, it is a reference, a COSBase can be anything, including a COSObject. In code like &quot;base = ((COSObject)obj).getObject();&quot;, it is usually &quot;the real thing&quot;, i.e. a dictionary or an array. (but could also be a number, a string, etc)&lt;/p&gt;</comment>
                            <comment id="16836390" author="tilman" created="Thu, 9 May 2019 13:44:28 +0000"  >&lt;p&gt;Can you also mention to what object it applies in the attached file?&lt;/p&gt;</comment>
                            <comment id="16836469" author="rahn2" created="Thu, 9 May 2019 15:21:52 +0000"  >&lt;p&gt;In the sample document I provided, the issue always occurs with an object which wraps around a Number. The object number are 193, 185, 177, 201 and 169. Perhaps it is the following problem: &lt;br/&gt;
I noticed that all these objects refer to these same number, that is 532. I don&apos;t know exactly what kind of hash the HashMap objectKeys of COSWriter uses, but could there perhaps be a collision? These are different objects, and they are treated as different objects. Still, the content is the same and this could cause the COSObjectKey in the HashMap to become erroneous. I circumvented the problem by querying for the COSObjects around the number, which are distinctable due to their different object numbers.&lt;/p&gt;</comment>
                            <comment id="16836485" author="tilman" created="Thu, 9 May 2019 15:49:05 +0000"  >&lt;p&gt;OK, I thimk I&apos;m closer to understand. The COSWriter as it is now does not always keep the indirect references, only when incremental saving or when it is a dictionary. So the code as it is now writes the numbers directly. Your new code adds stuff to &lt;tt&gt;objectKeys&lt;/tt&gt;, because that one is accessible. (Now you know what I meant with &quot;weird manipulations that were not thought about in the first place&quot; I mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4538&quot; title=&quot;Expose more internal API as protected and public&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4538&quot;&gt;PDFBOX-4538&lt;/a&gt;). Thus new keys are created and you get a &quot;gap&quot; and possibly worse.&lt;/p&gt;

&lt;p&gt;Re collision, I don&apos;t think so. These are different objects. (These might be identical objects when between -100 and 256, but that&apos;s not the case here. And even if it was, I don&apos;t really see how there would be trouble)&lt;/p&gt;

&lt;p&gt;So what you wish is that if a COSObject is already in &lt;tt&gt;objectKeys&lt;/tt&gt;, then there shouldn&apos;t be a new key assigned. Kindof makes sense. I&apos;ll sleep over this.&lt;/p&gt;</comment>
                            <comment id="16836970" author="rahn2" created="Fri, 10 May 2019 07:14:59 +0000"  >&lt;p&gt;Yes, basically that is what it is meant for. I guess we are indeed doing weird and&#160; unusual stuff, but it makes more sense to use the infrastructure provided by COSWriter (and the other subsystems we modified) than to just reimplement everything by ourselves.&lt;/p&gt;

&lt;p&gt;I reckon the currently exposed API is fine if all you do is using PDFBox &apos;as is&apos;. Right now we just find that it is really hard to modify the framework&apos;s behaviour without either reimplementing entire subsystems or exposing additional API.&lt;/p&gt;</comment>
                            <comment id="16837008" author="msahyoun" created="Fri, 10 May 2019 08:10:26 +0000"  >&lt;p&gt;Maybe it makes sense to getter a better understanding about the use cases you are trying to support using PDFBox - we might come up with a way that you don&apos;t need to work with the internals&lt;/p&gt;</comment>
                            <comment id="16837012" author="tilman" created="Fri, 10 May 2019 08:21:28 +0000"  >&lt;p&gt;I&apos;m doing the change anyway (unless there&apos;s a specific reason not to, or a specific reason why it is what it is now), the reason being that if the COSObject is already in the &lt;tt&gt;objectKeys&lt;/tt&gt; map, then we shouldn&apos;t get a new key. At first this is just one line added, but after refactoring, it ends like the proposed changed.&lt;/p&gt;</comment>
                            <comment id="16837013" author="tilman" created="Fri, 10 May 2019 08:24:02 +0000"  >&lt;blockquote&gt;
&lt;p&gt;we might come up with a way that you don&apos;t need to work with the internals&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yeah, the reassigning of objects seems weird to me... OTOH we all stayed away from supporting linerarization so who knows what we would have done, and COSWriter is a really tricky class.&lt;/p&gt;</comment>
                            <comment id="16837014" author="jira-bot" created="Fri, 10 May 2019 08:24:44 +0000"  >&lt;p&gt;Commit 1859066 from Tilman Hausherr in branch &apos;pdfbox/branches/issue45&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1859066&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1859066&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4540&quot; title=&quot;COSWriter sometimes retrieves wrong ObjectKey&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4540&quot;&gt;&lt;del&gt;PDFBOX-4540&lt;/del&gt;&lt;/a&gt;: include that COSObject obj might already be in the objectKeys map, as suggested by Jonathan&lt;/p&gt;</comment>
                            <comment id="16837015" author="jira-bot" created="Fri, 10 May 2019 08:24:48 +0000"  >&lt;p&gt;Commit 1859067 from Tilman Hausherr in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1859067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1859067&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4540&quot; title=&quot;COSWriter sometimes retrieves wrong ObjectKey&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4540&quot;&gt;&lt;del&gt;PDFBOX-4540&lt;/del&gt;&lt;/a&gt;: include that COSObject obj might already be in the objectKeys map, as suggested by Jonathan&lt;/p&gt;</comment>
                            <comment id="16837016" author="jira-bot" created="Fri, 10 May 2019 08:24:52 +0000"  >&lt;p&gt;Commit 1859068 from Tilman Hausherr in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1859068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1859068&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4540&quot; title=&quot;COSWriter sometimes retrieves wrong ObjectKey&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4540&quot;&gt;&lt;del&gt;PDFBOX-4540&lt;/del&gt;&lt;/a&gt;: include that COSObject obj might already be in the objectKeys map, as suggested by Jonathan&lt;/p&gt;</comment>
                            <comment id="16837017" author="msahyoun" created="Fri, 10 May 2019 08:25:12 +0000"  >&lt;p&gt;ack - the change itself is useful. Understanding the use case might help us to better understand what we might need to expose and what not. Using COSWriter directly shouldn&apos;t be done by consumers of the lib IMHO&lt;/p&gt;</comment>
                            <comment id="16837020" author="tilman" created="Fri, 10 May 2019 08:34:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Rahn2&quot; class=&quot;user-hover&quot; rel=&quot;Rahn2&quot;&gt;Rahn2&lt;/a&gt; I&apos;d wish I had a simple &quot;previously failing&quot; test. If you have one that is simple enough please submit it (reopen); if not, then don&apos;t forget to create one in your project.&lt;/p&gt;</comment>
                            <comment id="16837034" author="rahn2" created="Fri, 10 May 2019 08:43:02 +0000"  >&lt;p&gt;I happily give you more information about what we have done:&lt;/p&gt;

&lt;p&gt;The company I work for develops an electronic file management system which is used by some major German governmental institutions. A certain group of customers requested a feature where they wanted to display a large number of distinct pdf files as one large file. The straight-forward solution was to download each file and then append them on client side. This lead to serious performance issues for our clients, so we aimed to implement a server-side solution.&lt;/p&gt;

&lt;p&gt;Upon client request we now parse each indidual file on server side. To reduce our memory consumption here, we implemented changes to PDFParser and COSStream to not load large streams into memory. Then we do a basic algorithm to append these documents to each other and then linearize the result. The algorithm we used was inspired by QPDF. We subclassed COSWriter to allow us to write dummy versions of our objects in order to calculate the length and offset information we need for the hint tables and linearization dictionary.&lt;/p&gt;

&lt;p&gt;Our COSWriter subclass also does not write to a file but to a java object structure which contains all the pdf information except the aforementioned large streams, which are still referenced from outside. Upon client request we then dynamically rebuild chunks of the resulting pdf and serve them.&lt;/p&gt;

&lt;p&gt;I am going to open some other issues concerning a fix for issues with direct/indirect object and one for those lazy streams.&lt;/p&gt;</comment>
                            <comment id="16837035" author="rahn2" created="Fri, 10 May 2019 08:43:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; What do you mean with this &quot;previously failing test&quot;?&lt;/p&gt;</comment>
                            <comment id="16837041" author="tilman" created="Fri, 10 May 2019 08:51:37 +0000"  >&lt;p&gt;I mean a test that would fail without the recent change, but succeed now.&lt;/p&gt;</comment>
                            <comment id="16837049" author="rahn2" created="Fri, 10 May 2019 08:57:55 +0000"  >&lt;p&gt;Ah sure. We currently have a failing precondiction when we are gathering information for our cross-reference tables. I will think about a test which could be included more easily.&lt;/p&gt;</comment>
                            <comment id="16837136" author="mkl" created="Fri, 10 May 2019 10:07:30 +0000"  >&lt;p&gt;Just a hint, if you want such functionalities (which use PDFBox in unexpected ways but still are of general interest, like linearization) to not break in the course of PDFBox development, you should consider offering to share that very functionality with the PDFBox project. Doing so with some appropriate unit tests would make bells ring as soon as some change would break your functionality.&lt;/p&gt;</comment>
                            <comment id="16837229" author="rahn2" created="Fri, 10 May 2019 12:31:46 +0000"  >&lt;p&gt;As a development team we&apos;d like to share these changes. However, the development took considerable development resources and is for us as a company a selling proposition. In short, we&apos;ll have to run this by the management.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12968298" name="sample.pdf" size="54836" author="Rahn2" created="Thu, 9 May 2019 12:20:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02jfk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>