<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:56:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2082] signing corrupts PDF when signature exactly fits allocated space</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2082</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;The current check does not take &quot;&amp;lt;&amp;gt;&quot; into account, so if you are (un)lucky, the signature overwrites &quot;&amp;gt;&quot; and corrupts the PDF.&lt;/p&gt;

&lt;p&gt;Fix for 1.8:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
index 3165589..80fbad2 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
@@ -778,13 +778,15 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;COSWriter &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ICOSVisitor, Closeable
         
             SignatureInterface signatureInterface = doc.getSignatureInterface();
             &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] sign = signatureInterface.sign(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(pdfContent));
+            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; assumes that the dummy signature has been writen as &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;0000...&amp;gt;&quot;&lt;/span&gt;
&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; signature = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; COSString(sign).getHexString();
-            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; leftSignaturerange = signaturePosition[1]-signaturePosition[0]-signature.length();
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(leftSignaturerange&amp;lt;0)
+            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; startPos = signaturePosition[0] + 1; &lt;span class=&quot;code-comment&quot;&gt;// move past &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;&quot;&lt;/span&gt;
&lt;/span&gt;+            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; endPos = signaturePosition[1] - 1; &lt;span class=&quot;code-comment&quot;&gt;// move in front of &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&quot;&lt;/span&gt;
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (startPos + signature.length() &amp;gt; endPos)
             {
                 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Can&apos;t write signature, not enough space&quot;&lt;/span&gt;);
             }
-            getStandardOutput().setPos(signaturePosition[0]+1);
+            getStandardOutput().setPos(startPos);
             getStandardOutput().write(signature.getBytes());
         }
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another thing is that pdfbox now allocates (2 * preferedSize + 2) for a signature. It quite confused me to see 16k+4 bytes allocated when I called setPreferedSignatureSize(4k) - it should have allocated 8k (each signature byte takes 2 bytes in the pdf). &lt;/p&gt;

&lt;p&gt;Fix for 1.8:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDDocument.java b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDDocument.java
index 358364a..23dd3ab 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDDocument.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/PDDocument.java
@@ -309,7 +309,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PDDocument &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Pageable, Closeable
         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; preferedSignatureSize = options.getPreferedSignatureSize();
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (preferedSignatureSize &amp;gt; 0)
         {
-            sigObject.setContents(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[preferedSignatureSize * 2 + 2]);
+            sigObject.setContents(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[preferedSignatureSize]);
         }
         &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
         {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12714788">PDFBOX-2082</key>
            <summary>signing corrupts PDF when signature exactly fits allocated space</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="koloom@yahoo.com">&#352;t&#283;p&#225;n Schejbal</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 May 2014 15:48:28 +0000</created>
                <updated>Sun, 22 Jun 2014 14:34:53 +0000</updated>
                            <resolved>Wed, 18 Jun 2014 18:37:48 +0000</resolved>
                                    <version>1.8.5</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.8.6</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Writing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14032852" author="lehmi" created="Mon, 16 Jun 2014 19:54:09 +0000"  >&lt;p&gt;I&apos;m not a signature expert but as fas as I can know &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; signature = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; COSString(sign).getHexString();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;produces a string without the enclosing &quot;&amp;lt;&amp;gt;&quot;. So that I can&apos;t see a need for your first patch&lt;/p&gt;

&lt;p&gt;IMO the second one is also invalid. If a given signature is written as hex string we need twice as much bytes as in the signature itself. There are 2 addtional bytes needed for the enclosing &quot;&amp;lt;&amp;gt;&quot;. Looks like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;preferredSize * 2 + 2 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is just the right thing to do.&lt;/p&gt;

&lt;p&gt;Or am I missing something?&lt;/p&gt;</comment>
                            <comment id="14033816" author="koloom@yahoo.com" created="Tue, 17 Jun 2014 14:04:55 +0000"  >&lt;blockquote&gt;
&lt;p&gt;produces a string without the enclosing &quot;&amp;lt;&amp;gt;&quot;. So that I can&apos;t see a need for your first patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It produces the string wihtout &quot;&amp;lt;&amp;gt;&quot;, but the allocated space in the pdf i.e. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;signaturePosition[1] - signaturePosition[0]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;  includes &quot;&amp;lt;&amp;gt;&quot;, so you must subtract 2 bytes when comparing it with the signature length (in bytes). The original code subtracted only one byte (&quot;&amp;lt;&quot;), making it possible to overwrite &quot;&amp;gt;&quot; and screw up the pdf.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;IMO the second one is also invalid.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are wrong again, what do you think &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;setContents(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[100])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; does? It certainly does not allocate 100 byte in the PDF. It allocates just enough space to store 100 bytes encoded as a hexadecimal string i.e. 202 bytes in the PDF. The original code would allocate 406 bytes by doing x2 + 2 unnecessarily.&lt;/p&gt;</comment>
                            <comment id="14036117" author="lehmi" created="Wed, 18 Jun 2014 18:37:48 +0000"  >&lt;p&gt;I&apos;ve added the patch in revisions &lt;a href=&quot;http://svn.apache.org/r1603566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1603566&lt;/a&gt; (trunk) and &lt;a href=&quot;http://svn.apache.org/r1603567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1603567&lt;/a&gt; (1.8 branch) with some slight additions.&lt;/p&gt;

&lt;p&gt;Thanks for the detailed explanation and the contribution itself!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393101</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 22 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1voxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393268</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>