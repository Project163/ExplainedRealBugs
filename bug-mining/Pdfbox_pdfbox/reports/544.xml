<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:55:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-2101] Surprising memory consumption when extracting images</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-2101</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;ExtractImages seems to fail to release memory resources on some files in both PDFBox 1.8.5 and trunk.  &lt;/p&gt;

&lt;p&gt;On this file 4MB file &lt;a href=&quot;http://digitalcorpora.org/corp/nps/files/govdocs1/239/239665.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://digitalcorpora.org/corp/nps/files/govdocs1/239/239665.pdf&lt;/a&gt;, if extracting every image on every page (and there are many, many duplicate images), there is an OOM with -Xmx1g.  If there is no Xmx and there is &amp;gt; 2.5g available, ExtractImages will work.&lt;/p&gt;

&lt;p&gt;With some experimentation, the triggers seem to be JPEG images that have masks.  I&apos;m not sure, though, whether the issue is with PDFBox or Java.&lt;/p&gt;

&lt;p&gt;Commandlines:&lt;br/&gt;
1.8.5:&lt;br/&gt;
java -Xmx1g -cp pdfbox-app-1.8.5.jar org.apache.pdfbox.ExtractImages 239665.pdf&lt;/p&gt;

&lt;p&gt;2.0_SNAPSHOT:&lt;br/&gt;
java -Xmx1g -cp pdfbox-app-2.0.0-SNAPSHOT.jar org.apache.pdfbox.tools.ExtractImages -addkey 239665.pdf&lt;/p&gt;

&lt;p&gt;Results:&lt;br/&gt;
1.8.5: 906 files before OOM&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space
        at java.util.Arrays.copyOf(Arrays.java:2271)
        at java.io.ByteArrayOutputStream.grow(ByteArrayOutputStream.java:113)
        at java.io.ByteArrayOutputStream.ensureCapacity(ByteArrayOutputStream.ja
va:93)
        at java.io.ByteArrayOutputStream.write(ByteArrayOutputStream.java:140)
        at org.apache.pdfbox.pdmodel.common.PDStream.getByteArray(PDStream.java:
514)
        at org.apache.pdfbox.pdmodel.graphics.xobject.PDPixelMap.getRGBImage(PDP
ixelMap.java:217)
        at org.apache.pdfbox.pdmodel.graphics.xobject.PDPixelMap.write2OutputStr
eam(PDPixelMap.java:363)
        at org.apache.pdfbox.pdmodel.graphics.xobject.PDXObjectImage.write2file(
PDXObjectImage.java:254)
        at org.apache.pdfbox.ExtractImages.processResources(ExtractImages.java:2
02)
        at org.apache.pdfbox.ExtractImages.extractImages(ExtractImages.java:160)

        at org.apache.pdfbox.ExtractImages.main(ExtractImages.java:65)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.0_SNAPSHOT: 428 files before OOM&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space
        at java.util.Arrays.copyOf(Arrays.java:2271)
        at java.io.ByteArrayOutputStream.grow(ByteArrayOutputStream.java:113)
        at java.io.ByteArrayOutputStream.ensureCapacity(ByteArrayOutputStream.ja
va:93)
        at java.io.ByteArrayOutputStream.write(ByteArrayOutputStream.java:140)
        at org.apache.pdfbox.io.IOUtils.copy(IOUtils.java:70)
        at org.apache.pdfbox.io.IOUtils.toByteArray(IOUtils.java:52)
        at org.apache.pdfbox.pdmodel.graphics.image.SampledImageReader.from8bit(
SampledImageReader.java:171)
        at org.apache.pdfbox.pdmodel.graphics.image.SampledImageReader.getRGBIma
ge(SampledImageReader.java:154)
        at org.apache.pdfbox.pdmodel.graphics.image.PDImageXObject.getImage(PDIm
ageXObject.java:171)
        at org.apache.pdfbox.tools.ExtractImages.write2file(ExtractImages.java:2
31)
        at org.apache.pdfbox.tools.ExtractImages.processResources(ExtractImages.
java:206)
        at org.apache.pdfbox.tools.ExtractImages.extractImages(ExtractImages.jav
a:164)
        at org.apache.pdfbox.tools.ExtractImages.main(ExtractImages.java:69)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Windows 7&lt;br/&gt;
java version &amp;quot;1.7.0_55&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_55-b13)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 24.55-b03, mixed mode)&lt;br/&gt;
</environment>
        <key id="12717072">PDFBOX-2101</key>
            <summary>Surprising memory consumption when extracting images</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lehmi">Andreas Lehmk&#252;hler</assignee>
                                    <reporter username="tallison">Tim Allison</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 May 2014 16:07:49 +0000</created>
                <updated>Sun, 7 Sep 2014 08:19:37 +0000</updated>
                            <resolved>Sun, 15 Jun 2014 11:34:45 +0000</resolved>
                                    <version>1.8.5</version>
                                    <fixVersion>1.8.6</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Utilities</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14011439" author="lehmi" created="Wed, 28 May 2014 18:43:28 +0000"  >&lt;p&gt;I can confirm the described OOM on windows 7 64bit but NOT on linux fedora 20. I&apos;ve checked both for pdfbox 1.8.5.&lt;/p&gt;</comment>
                            <comment id="14011445" author="jeremias@apache.org" created="Wed, 28 May 2014 18:50:32 +0000"  >&lt;p&gt;While working on this it should be considered to switch to the ByteArrayOutputStream provided by Commons IO which doesn&apos;t need to constantly copy arrays when growing. That makes it faster &lt;del&gt;and it has a lower peak memory consumption&lt;/del&gt; (that is only true if you can use the writeTo(OutputStream) method and don&apos;t need the toByteArray()).&lt;/p&gt;</comment>
                            <comment id="14011452" author="lehmi" created="Wed, 28 May 2014 18:56:53 +0000"  >&lt;p&gt;java.io.ByteArrayOutputStream is used on many occasions, do you have a special one in your mind?&lt;/p&gt;</comment>
                            <comment id="14011455" author="lehmi" created="Wed, 28 May 2014 19:00:50 +0000"  >&lt;p&gt;I&apos;ve fixed the issue in revisions 1598103 (trunk) and 1598104 (1.8 branch) by clearing the resources at the end of each step.&lt;/p&gt;</comment>
                            <comment id="14011457" author="tilman" created="Wed, 28 May 2014 19:03:38 +0000"  >&lt;p&gt;2.0 has a higher memory consumption, this is because of a clone in some class (I mentioned this a few months ago).&lt;/p&gt;

&lt;p&gt;The real cause of the problem IMHO is that images are cached. What could be done is to create some sort of cache manager that stores a certain amount of images and &quot;orphans&quot; them when new images are built. I.e. images, after being built, aren&apos;t stored in the image object, but in the cache manager, who will return null or an object the next time the image is requested.&lt;/p&gt;</comment>
                            <comment id="14011469" author="jeremias@apache.org" created="Wed, 28 May 2014 19:16:43 +0000"  >&lt;p&gt;java.io.ByteArrayOutputStream is just a bit na&#239;vely implemented. The Commons IO variant has the exact same API but doesn&apos;t copy data around so much. So, no, no special occasion. It&apos;s just a better replacement in every case.&lt;/p&gt;</comment>
                            <comment id="14011472" author="lehmi" created="Wed, 28 May 2014 19:18:48 +0000"  >&lt;p&gt;Ok, I see. We should keep that in mind, a refactor some of the code from time to time. That class is used a lot within pdfbox.&lt;/p&gt;</comment>
                            <comment id="14011475" author="lehmi" created="Wed, 28 May 2014 19:20:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tallison@apache.org&quot;&gt;tallison@apache.org&lt;/a&gt; Please double check if this works as it seems to be at least partly platform/environment specific.&lt;/p&gt;</comment>
                            <comment id="14011725" author="jahewson" created="Wed, 28 May 2014 22:34:56 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The real cause of the problem IMHO is that images are cached. What could be done is to create some sort of cache manager that stores a certain amount of images and &quot;orphans&quot; them when new images are built.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t know, it seems like the ImageXObject is being kept around for too long, the cached image only lives as long as this object. If that&apos;s a problem then I&apos;d recommend just getting rid of image caching and letting the end-user do it in the (relatively rare?) case that they need it.&lt;/p&gt;</comment>
                            <comment id="14011787" author="tilman" created="Wed, 28 May 2014 23:03:17 +0000"  >&lt;p&gt;What if the image is a company logo that is on every page of a big file? In that case caching would make sense, and the user can&apos;t do it if he just wants to render all the pages.&lt;/p&gt;</comment>
                            <comment id="14011875" author="tallison@mitre.org" created="Thu, 29 May 2014 00:22:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt;, thank you for looking into this so quickly.  Your mods definitely took the edge off!  Thank you.  Both 1.8.6 SNAPSHOT and 2.0 SNAPSHOT passed with -Xmx1g.  On Windows 7, Java was choosing to use up to 800mb with 2.0 SNAPSHOT and ~600mb with 1.8.6 SNAPSHOT.  Both versions of PDFBox were also still successful with -Xmx500m.&lt;/p&gt;

&lt;p&gt;It still feels like something odd is going on in that Java is choosing to consume up to 800m to export images from a 4m file.  It feels a bit like the old substring() &quot;feature&quot; of Java.&lt;/p&gt;

&lt;p&gt;Your modifications have definitely helped, but my poor gc is very, very tired. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Thank you!&lt;/p&gt;


&lt;p&gt;P.S. For the record, I tested 1.8.5 on:&lt;br/&gt;
Red Hat Enterprise Linux Server release 6.5 (Santiago)&lt;/p&gt;

&lt;p&gt;java version &quot;1.7.0_40&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_40-b43)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 24.0-b56, mixed mode)&lt;/p&gt;

&lt;p&gt;and I still had OOM with -Xmx1g...it isn&apos;t just Windows (although I&apos;m willing to believe it could be!)&lt;/p&gt;
</comment>
                            <comment id="14012145" author="jeremias@apache.org" created="Thu, 29 May 2014 07:15:13 +0000"  >&lt;p&gt;One thing here is that image compression can be extremely efficient, but if an image is decoded into a BufferedImage just so it can be exported into a compressed file again, it can take a lot of memory as we see here. In the case of PDJpeg, it&apos;s a bit unfortunate that the image is loaded into a BufferedImage since JPEG is a lossy compression format. Ideally, this class&apos; write2OutputStream() method would just extract the compressed image since what&apos;s in there is almost exactly a normal JFIF/JPEG file. In Apache FOP, for example, we can embedd the compressed data stream into the PDF without actually decompressing and recompressing the image data (it&apos;s damn fast, too, and memory consumption is reduced to a little copy buffer). We&apos;re just filtering out stuff like the color profile which goes into a separate object. Here it would have to be implemented the other way around: Gathering the various objects associated with the JPEG image and re-assemble the JFIF/JPEG file as closely to the original as possible. &lt;/p&gt;</comment>
                            <comment id="14012162" author="tilman" created="Thu, 29 May 2014 07:38:43 +0000"  >&lt;p&gt;I&apos;ll test whether it is possible to change write2OutputStream() similar to the method in PDCcitt, which works the way you want.&lt;/p&gt;</comment>
                            <comment id="14012179" author="tilman" created="Thu, 29 May 2014 08:08:00 +0000"  >&lt;p&gt;2 files: the same JPEG image, once extracted indirectly, once directly. The &quot;good&quot; (directly extracted) has half the size. I get a similar result with another, much bigger image.&lt;/p&gt;</comment>
                            <comment id="14012191" author="tilman" created="Thu, 29 May 2014 08:16:17 +0000"  >&lt;p&gt;Done in rev 1598218 for the 1.8 branch and in rev 1598223 for the trunk.&lt;/p&gt;</comment>
                            <comment id="14012199" author="jeremias@apache.org" created="Thu, 29 May 2014 08:38:46 +0000"  >&lt;p&gt;Please note that color fidelity will suffer like that as the resulting JPEG will no longer have a color profile if one was assigned explicitely inside the PDF file.&lt;/p&gt;</comment>
                            <comment id="14012212" author="tilman" created="Thu, 29 May 2014 09:16:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeremias.maerki%40outline.ch&quot; class=&quot;user-hover&quot; rel=&quot;jeremias.maerki@outline.ch&quot;&gt;jeremias.maerki@outline.ch&lt;/a&gt; yes... this is a matter about how extractImages is defined. Should it extract the &quot;only the payload&quot; or should it do a full service job, or some of it? Is there a method to insert the color profile into the jpeg stream?&lt;/p&gt;

&lt;p&gt;I could also revert the change... JPEG images are not that often anyway.&lt;/p&gt;</comment>
                            <comment id="14012247" author="jeremias@apache.org" created="Thu, 29 May 2014 10:02:06 +0000"  >&lt;p&gt;Well, I guess it&apos;s a matter of priorities. What&apos;s more important? Lower memory consumption and better performance or color fidelity (which can also be added later should anyone complain). I&apos;d leave it like this for now. The important thing is that it&apos;s documented. The only thing that could be useful would be a TODO in the source code.&lt;/p&gt;</comment>
                            <comment id="14012261" author="tilman" created="Thu, 29 May 2014 10:27:34 +0000"  >&lt;p&gt;Added TODO in rev 1598244 for the 1.8 branch and rev 1598245 for the trunk.&lt;/p&gt;</comment>
                            <comment id="14012278" author="lehmi" created="Thu, 29 May 2014 11:19:01 +0000"  >&lt;p&gt;It depends on the point of view. We already extract just the raw data without some &quot;post processing&quot; in some cases (e.g. masked images, grouped content etc.)&lt;/p&gt;

&lt;p&gt;I guess, for now we are done here, aren&apos;t we?&lt;/p&gt;</comment>
                            <comment id="14012289" author="tilman" created="Thu, 29 May 2014 11:25:34 +0000"  >&lt;p&gt;We certainly fixed the command line utility. What I&apos;m wondering is whether this also solves the problem that Tim mentioned in the dev list re TIKA (&quot;Some users have noticed some eyebrow-raising memory consumption after we made the change with some files&quot;) or if we should do more.&lt;/p&gt;

&lt;p&gt;Re the caching of bufferedimages, a more simpler solution than the one I mentioned yesterday would be to make the caching fully optional, through some config option.&lt;/p&gt;</comment>
                            <comment id="14012298" author="tallison@mitre.org" created="Thu, 29 May 2014 11:46:36 +0000"  >&lt;p&gt;Thank you, all, for your work this!  &lt;/p&gt;

&lt;p&gt;I can&apos;t speak for the entire Tika community, but I suspect that the most common use case would be to extract one of each image (whether or not the image appears on 20 pages).  A caching parameter would be very handy for this.  For those who want to extract 20 copies of the same image, they can choose to take the potential memory hit for the sake of speed.  We have a decent method to configure PDFBox on Tika, and it would be great to add this if it isn&apos;t too much effort.&lt;/p&gt;

&lt;p&gt;Thank you, again.&lt;/p&gt;</comment>
                            <comment id="14012306" author="lehmi" created="Thu, 29 May 2014 12:04:22 +0000"  >&lt;p&gt;Just to avoid a misunderstanding. An image which is used more than once should be part of the document resources and not be part of the page resources on which the image appears. So that such images won&apos;t be extracted more than once. Tilmans approach takes into account that maybe those images from page 1 are no longer needed if page 2 is rendered and therefore shouldn&apos;t be cached anymore. Those resources are dropped when calling clear() on PDResources which is done automatically when parsing a pdf and I&apos;ve added the same behaviour to the ExtractImages class.&lt;/p&gt;</comment>
                            <comment id="14012326" author="tallison@mitre.org" created="Thu, 29 May 2014 12:38:26 +0000"  >&lt;p&gt;Ah, ok, thank you.  That makes sense.&lt;/p&gt;

&lt;p&gt;To confirm my understanding of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeremias.maerki%40outline.ch&quot; class=&quot;user-hover&quot; rel=&quot;jeremias.maerki@outline.ch&quot;&gt;jeremias.maerki@outline.ch&lt;/a&gt;&apos;s point...PDFBox is&lt;br/&gt;
caching the uncompressed image?  That would explain why I&apos;m seeing this:&lt;/p&gt;

&lt;p&gt;I&apos;m running hprof with trunk now with no -Xmx on a linux box, and ExtractImages has exported 223 images (many more to go!).  The exported images take up ~17m, but Java is choosing to use 1.1gb of memory. &lt;/p&gt;

&lt;p&gt;That would also explain why I was getting 2.6g of corrupt images from this file when I was just writing directly to the outputstream instead of using the correct image utils (thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; for pointing that out!).&lt;/p&gt;

&lt;p&gt;I&apos;ll submit the hprof results when that completes for kicks...&lt;/p&gt;</comment>
                            <comment id="14012426" author="tallison@mitre.org" created="Thu, 29 May 2014 15:11:08 +0000"  >&lt;p&gt;hprof finally finished.  Looks like applying the mask is creating quite a few objects. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14012588" author="jahewson" created="Thu, 29 May 2014 17:41:43 +0000"  >&lt;p&gt;We probably shouldn&apos;t be dumping the JPEG stream directly to disk, it&apos;s not necessarily a useful JPEG file, because PDF can perform quite a bit of post-processing. Tilman&apos;s changes in r1598244/r1598245 cause a regression in ExtractImages for the DocuPrint file from &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1058&quot; title=&quot;Converting PDF to Image gives error and the image generated is of poor quality&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1058&quot;&gt;&lt;del&gt;PDFBOX-1058&lt;/del&gt;&lt;/a&gt; for example - the extracted images are inverted. Perhaps we could dump the raw JPEG in cases where we&apos;re sure that there is no post-processing, to provide a fast and non-lossy common path.&lt;/p&gt;</comment>
                            <comment id="14012596" author="jahewson" created="Thu, 29 May 2014 17:45:48 +0000"  >&lt;p&gt;Also, lets try to make sure that sample PDF files are always attached to the issue, because URLs have a habit of disappearing and we tend to refer back to issues a lot &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14012619" author="tilman" created="Thu, 29 May 2014 17:53:00 +0000"  >&lt;p&gt;Maybe add some option so that both is possible? The regression that you mention is exactly what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeremias%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;jeremias@apache.org&quot;&gt;jeremias@apache.org&lt;/a&gt; expected.&lt;/p&gt;</comment>
                            <comment id="14012622" author="jahewson" created="Thu, 29 May 2014 17:55:44 +0000"  >&lt;p&gt;I&apos;m not sure that&apos;s what Jeremias was expecting - it&apos;s not a classic color fidelity issue with the colors being slightly off due to the wrong profile - it&apos;s completely the wrong color model, with YCbCr being treated as CMYK!&lt;/p&gt;</comment>
                            <comment id="14012784" author="tilman" created="Thu, 29 May 2014 19:43:45 +0000"  >&lt;p&gt;I thought again about this and decided to revert, done in rev 1598379 for the 1.8 branch and rev 1598382 for the trunk. The reason is that it would provide a bad user experience, and lead to support requests. I&apos;m thinking about a better idea: only write those JPEGs directly that have no decodeParams.&lt;/p&gt;</comment>
                            <comment id="14012796" author="jahewson" created="Thu, 29 May 2014 19:59:04 +0000"  >&lt;p&gt;Yeah, we can dump the raw JPEG in cases where we&apos;re sure that there is no post-processing, which excludes DecodeParams but also YCCK (see DCTFilter) and images using PDF color spaces.&lt;/p&gt;</comment>
                            <comment id="14012906" author="jahewson" created="Thu, 29 May 2014 21:09:34 +0000"  >&lt;p&gt;I did some memory profiling, and COSStream is holding onto a copy of the stream data in a RandomAccessFileInputStream instance variable &quot;unFilteredStream&quot;, which it keeps as long as the COSStream is around.&lt;/p&gt;

&lt;p&gt;Each PDPage holds a reference to its &quot;Page&quot; COSDictionary, which in turn contains the Resources, and ultimately a COSStream containing a named image XObject stream:&lt;/p&gt;

&lt;p&gt;Page&lt;br/&gt;
... Resources&lt;br/&gt;
...... XObject&lt;br/&gt;
......... obj1 (COSStream)&lt;/p&gt;

&lt;p&gt;This would be fine, except that COSStream caches its data once it has been read! Specifically when reading an image, COSStream.getUnfilteredStream() will be called which causes RandomAccessFileOutputStream unFilteredStream to be populated. The only way to close unFilteredStream is to call COSStream.close() but that destroys the entire COSStream object, preventing it from being read in the future and clearing its dictionary.&lt;/p&gt;

&lt;p&gt;Furthermore, the COSStream is kept around for the entire lifetime of the COSDocument, as its ancestor, the document Catalog is retained by COSDocument.objectPool. That&apos;s by design, and it&apos;s ok. However, it means that every time a COSStream is read, its contents is cached until the document is closed.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the best solution seems to be to prevent COSStream from caching anything, then make sure callers of COSStream methods are equipped to handle that.&lt;/p&gt;</comment>
                            <comment id="14012962" author="tilman" created="Thu, 29 May 2014 21:41:39 +0000"  >&lt;p&gt;This means that image objects are cached twice, i.e. once as BufferedImage and once as unfilteredStream (= the decoded version of whats in the pdf).&lt;/p&gt;</comment>
                            <comment id="14013001" author="jahewson" created="Thu, 29 May 2014 22:05:45 +0000"  >&lt;p&gt;Yep, that&apos;s right. I set up my JVM to dump the heap at 200MB, here&apos;s what I got:&lt;/p&gt;

&lt;p&gt;Approx 25MB of ByteBandedRaster + 60MB of IntegerInterleavedRaster (cached images).&lt;br/&gt;
Approx 72MB (4500 x 16kb) buffers in RandomAccessBuffer(s) belonging to COSStream.&lt;/p&gt;</comment>
                            <comment id="14013303" author="jahewson" created="Fri, 30 May 2014 05:06:07 +0000"  >&lt;p&gt;I modified ExtractImages to only write out non-duplicate images in revision 1598457 in the trunk. This doesn&apos;t change the memory usage but it prevents unnecessary output.&lt;/p&gt;</comment>
                            <comment id="14013797" author="lehmi" created="Fri, 30 May 2014 15:30:52 +0000"  >&lt;p&gt;I&apos;ve added a clear() method to PDFont and PDXObject to delete cached resources if necessary in revisions 1598627 (trunk) and 1598633 (1.8 branch). Those methods are called when clearing PDResources.&lt;br/&gt;
PDFont.clear is still empty but I&apos;m going to fill in some stuff soon.&lt;/p&gt;</comment>
                            <comment id="14013904" author="lehmi" created="Fri, 30 May 2014 16:25:51 +0000"  >&lt;p&gt;I&apos;ve implemented clear() for some of the classes inherited from PDFont in revisions 1598655 (trunk) and 1598657 (1.8 branch). &lt;br/&gt;
This should lead to a smaller memory foot print as some objects could be released earlier&lt;/p&gt;</comment>
                            <comment id="14014083" author="tilman" created="Fri, 30 May 2014 18:41:50 +0000"  >&lt;p&gt;Sorry, but there&apos;s a rendering problem with the 2nd page of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2103&quot; title=&quot;JPXFilter fails to decode some Jpeg2000 images&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2103&quot;&gt;&lt;del&gt;PDFBOX-2103&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Start rendering page 2
30.05.2014 20:39:20.854 WARN  [main] org.apache.pdfbox.util.PDFStreamEngine:557 - java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at java.util.ArrayList.rangeCheck(ArrayList.java:635)
	at java.util.ArrayList.get(ArrayList.java:411)
	at org.apache.pdfbox.cos.COSArray.getObject(COSArray.java:188)
	at org.apache.pdfbox.pdmodel.font.PDType0Font.&amp;lt;init&amp;gt;(PDType0Font.java:63)
	at org.apache.pdfbox.pdmodel.font.PDFontFactory.createFont(PDFontFactory.java:72)
	at org.apache.pdfbox.pdmodel.PDResources.getFonts(PDResources.java:209)
	at org.apache.pdfbox.util.PDFStreamEngine.getFonts(PDFStreamEngine.java:615)
	at org.apache.pdfbox.util.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.SetTextFont.process(SetTextFont.java:53)
	at org.apache.pdfbox.util.PDFStreamEngine.processOperator(PDFStreamEngine.java:544)
	at org.apache.pdfbox.util.PDFStreamEngine.processSubStream(PDFStreamEngine.java:264)
	at org.apache.pdfbox.util.PDFStreamEngine.processSubStream(PDFStreamEngine.java:223)
	at org.apache.pdfbox.util.PDFStreamEngine.processStream(PDFStreamEngine.java:205)
	at org.apache.pdfbox.rendering.PageDrawer.drawPage(PageDrawer.java:164)
	at org.apache.pdfbox.rendering.PDFRenderer.renderPage(PDFRenderer.java:214)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:147)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImageWithDPI(PDFRenderer.java:96)
	at pdfboxpageimageextraction.ExtractImages.doPdf(ExtractImages.java:414)
	at pdfboxpageimageextraction.ExtractImages.main(ExtractImages.java:208)
30.05.2014 20:39:20.866 WARN  [main] org.apache.pdfbox.util.PDFStreamEngine:356 - java.lang.NullPointerException
java.lang.NullPointerException
	at org.apache.pdfbox.util.PDFStreamEngine.processEncodedText(PDFStreamEngine.java:352)
	at org.apache.pdfbox.util.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.ShowText.process(ShowText.java:43)
	at org.apache.pdfbox.util.PDFStreamEngine.processOperator(PDFStreamEngine.java:544)
	at org.apache.pdfbox.util.PDFStreamEngine.processSubStream(PDFStreamEngine.java:264)
	at org.apache.pdfbox.util.PDFStreamEngine.processSubStream(PDFStreamEngine.java:223)
	at org.apache.pdfbox.util.PDFStreamEngine.processStream(PDFStreamEngine.java:205)
	at org.apache.pdfbox.rendering.PageDrawer.drawPage(PageDrawer.java:164)
	at org.apache.pdfbox.rendering.PDFRenderer.renderPage(PDFRenderer.java:214)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImage(PDFRenderer.java:147)
	at org.apache.pdfbox.rendering.PDFRenderer.renderImageWithDPI(PDFRenderer.java:96)
	at pdfboxpageimageextraction.ExtractImages.doPdf(ExtractImages.java:414)
	at pdfboxpageimageextraction.ExtractImages.main(ExtractImages.java:208)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14014101" author="tilman" created="Fri, 30 May 2014 18:52:51 +0000"  >&lt;p&gt;The files of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1283&quot; title=&quot;Unicode characters displayed with wrong Advance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1283&quot;&gt;&lt;del&gt;PDFBOX-1283&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1756&quot; title=&quot;ClassCastException CosString cannot be cast to COSName&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1756&quot;&gt;&lt;del&gt;PDFBOX-1756&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1283&quot; title=&quot;Unicode characters displayed with wrong Advance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1283&quot;&gt;&lt;del&gt;PDFBOX-1283&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2048&quot; title=&quot;TextExtraction only working after uncompressing with pdftk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2048&quot;&gt;&lt;del&gt;PDFBOX-2048&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1692&quot; title=&quot;java.lang.OutOfMemoryError: Java heap space&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1692&quot;&gt;&lt;del&gt;PDFBOX-1692&lt;/del&gt;&lt;/a&gt; have also a rendering problem.&lt;/p&gt;</comment>
                            <comment id="14014700" author="lehmi" created="Sat, 31 May 2014 16:00:18 +0000"  >&lt;p&gt;I&apos;ve fixed the regression in revisions 1598883 and 1598884. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; Thanks for the pointer!&lt;/p&gt;</comment>
                            <comment id="14014795" author="tilman" created="Sat, 31 May 2014 20:20:06 +0000"  >&lt;p&gt;Yes that solved it, thanks.&lt;/p&gt;</comment>
                            <comment id="14014972" author="tilman" created="Sun, 1 Jun 2014 12:37:29 +0000"  >&lt;p&gt;I have inserted another clear() in extractImages in rev 1598978 for the trunk and rev 1598979 for the 1.8 branch, this makes it possible to handle the file of &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-1350&quot; title=&quot;OutOfMemory on reading FlateFilter images in PDF&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-1350&quot;&gt;&lt;del&gt;PDFBOX-1350&lt;/del&gt;&lt;/a&gt; without getting an OutOfMemoryError. The current resources.clear() is too late because it is triggered only after the whole list of images has been done.&lt;/p&gt;</comment>
                            <comment id="14015024" author="tilman" created="Sun, 1 Jun 2014 17:51:46 +0000"  >&lt;p&gt;John - Re: ExtractImages and YCCK etc: after testing a lot it looks to me as if it would be enough to check that JPEG files have Gray or RGB colorspace, i.e. that all these can be written directly.&lt;/p&gt;</comment>
                            <comment id="14015504" author="jahewson" created="Mon, 2 Jun 2014 16:14:00 +0000"  >&lt;p&gt;Yes, that should work nicely.&lt;/p&gt;</comment>
                            <comment id="14017814" author="dave.smith" created="Wed, 4 Jun 2014 16:14:06 +0000"  >
&lt;p&gt;What we do is convert each page of the pdf to an image. Once I have the image I am done with the page. What would be nice is if the references that the page was holding could be cleared out of the global cache. If page 2 needed a filter that was already loaded on page one then so be it. Right now we can not render more than 30 pages without the JMV running out of memory. Sure it might be a bit slower but it is better than it not working at all..&lt;/p&gt;
</comment>
                            <comment id="14018712" author="tilman" created="Thu, 5 Jun 2014 11:55:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dave.smith&quot; class=&quot;user-hover&quot; rel=&quot;dave.smith&quot;&gt;dave.smith&lt;/a&gt; did you try this with the current version from svn after rendering?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pdPage.getResources() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    {   
      pdPage.getResources().clear(); 
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14018734" author="dave.smith" created="Thu, 5 Jun 2014 12:31:18 +0000"  >&lt;p&gt;That works VERY nicely. Should we add an option to PDFRenderer so it could clear it&apos;s resources after it&apos;s finished rendering the page?&lt;/p&gt;</comment>
                            <comment id="14018745" author="tilman" created="Thu, 5 Jun 2014 12:42:49 +0000"  >&lt;p&gt;I don&apos;t think that this belongs in PDFRenderer. I&apos;d rather add a clear() method to PDPage that does this call.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lehmi&quot; class=&quot;user-hover&quot; rel=&quot;lehmi&quot;&gt;lehmi&lt;/a&gt; WDYT ?&lt;/p&gt;</comment>
                            <comment id="14018754" author="dave.smith" created="Thu, 5 Jun 2014 12:52:11 +0000"  >&lt;p&gt;I would agree that adding a clearResources to PDPage would be great  however it would be nice to bury the whole logic of clearing page resources into the renderer itself. It would alert anyone using PDFRenderer that  resources can be cleaded up (plus then we do not have to lookup the page again) Compare ..&lt;/p&gt;

&lt;p&gt;List&amp;lt;PDPage&amp;gt; pages = document.getDocumentCatalog().getAllPages();&lt;br/&gt;
PDFRenderer render = new PDFRenderer(document);&lt;br/&gt;
for (int i=0;i&amp;lt;pages.size();i++)&lt;br/&gt;
{&lt;br/&gt;
BufferedImage pageImage = render.renderImageWithDPI(i,200f,ImageType.GRAY);&lt;/p&gt;

&lt;p&gt;	PDPage pdPage = pages.get&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;; // clear resources once the page is finished loading&lt;br/&gt;
	 if (pdPage.getResources() != null)&lt;/p&gt;
	    {
		      pdPage.getResources().clear();
	    }	
&lt;p&gt;// do something here&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;With&lt;br/&gt;
List&amp;lt;PDPage&amp;gt; pages = document.getDocumentCatalog().getAllPages();&lt;br/&gt;
PDFRenderer render = new PDFRenderer(document);&lt;br/&gt;
render.clearPageResourcesAfterRender(); // &lt;br/&gt;
for (int i=0;i&amp;lt;pages.size();i++)&lt;br/&gt;
{&lt;br/&gt;
BufferedImage pageImage = render.renderImageWithDPI(i,200f,ImageType.GRAY);&lt;br/&gt;
// do something with the image&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="14018977" author="lehmi" created="Thu, 5 Jun 2014 17:11:12 +0000"  >&lt;p&gt;All resources of a page are now automatically cleared after the conversion to an image per default. The user may decide to disable that  feature when creating the PDFRenderer. I&apos;ve added those changes in revision &lt;a href=&quot;http://svn.apache.org/r1600699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1600699&lt;/a&gt; to the trunk. The 1.8 branch doesn&apos;t have a PDFRenderer so that I&apos;ve added a clear method to the PDPage class only in revsion &lt;a href=&quot;http://svn.apache.org/r1600701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1600701&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt; IMHO it&apos;s more convenient to clear the resources automatically as the user may not be aware about those cached values.&lt;/p&gt;</comment>
                            <comment id="14020125" author="tilman" created="Fri, 6 Jun 2014 17:51:31 +0000"  >&lt;p&gt;Committed 2nd attempt in rev 1600968 for the trunk and rev 1601862 to the 1.8 branch to save JPEGs directly, only RGB and Gray.&lt;/p&gt;

&lt;p&gt;I&apos;m aware that it isn&apos;t perfect (see &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-2128&quot; title=&quot;CMYK images are not supported correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-2128&quot;&gt;&lt;del&gt;PDFBOX-2128&lt;/del&gt;&lt;/a&gt;) but I wanted to have the same strategy between the two versions.&lt;/p&gt;</comment>
                            <comment id="14031832" author="lehmi" created="Sun, 15 Jun 2014 10:47:28 +0000"  >&lt;p&gt;IMHO for now we are done here, aren&apos;t we? I&apos;d like to close this before releasing 1.8.6.&lt;/p&gt;</comment>
                            <comment id="14031834" author="tilman" created="Sun, 15 Jun 2014 10:57:41 +0000"  >&lt;p&gt;Yes&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12456903">PDFBOX-626</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12738950">PDFBOX-2313</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12729459">TIKA-1375</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12738791">PDFBOX-2310</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12739543">PDFBOX-2323</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12618135">PDFBOX-1462</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12713662">TIKA-1294</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12647397" name="239665.pdf" size="4092837" author="jahewson" created="Thu, 29 May 2014 17:45:48 +0000"/>
                            <attachment id="12647321" name="PDFBOX-2101-298-good.jpg" size="12288" author="tilman" created="Thu, 29 May 2014 08:08:00 +0000"/>
                            <attachment id="12647322" name="PDFBOX-2101-714-poor.jpg" size="35097" author="tilman" created="Thu, 29 May 2014 08:08:00 +0000"/>
                            <attachment id="12647380" name="java.hprof.zip" size="64498" author="tallison" created="Thu, 29 May 2014 15:11:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395280</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1w21r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>395411</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>