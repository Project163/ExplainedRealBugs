<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:06:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PDFBOX-4066] Merging documents with nested fields duplicates child fields</title>
                <link>https://issues.apache.org/jira/browse/PDFBOX-4066</link>
                <project id="12310760" key="PDFBOX">PDFBox</project>
                    <description>&lt;p&gt;I have a pdf with a lot of acroforms, I do some manipulation on it which results in a new pdf. So I have PDF-1 (which is the original one )and PDF-2 (just a duplication of PDF-1), now I want to merge them. Both PDFs have some acroforms for example: field_a, field_2...&lt;/p&gt;

&lt;p&gt;Before I merge them I flatten PDF-1, because I only want to have acrofields from PDF-2. When I check then my new merged PDF I can see that there are no visible fields on on the pages from PDF-1 and there are fields on pages of fields of PDF-2. At the first look it seems ok, but when I inspect the fields I can see that the merger has renamed all the fields for PDF-2 e.g. field_a_dummy123, field_b_dummy232 ...&lt;/p&gt;

&lt;p&gt;It seems to me, that flattening does not remove the fields and thats why the PDFMerger from PDFBox will rename the fields for PDF-2 because acrofields need to be unique.Another guess was that&#160;there is a bug in mergeAcroForm()&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void flattenAndMerge() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    File testForm = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(classLoader.getResource(&lt;span class=&quot;code-quote&quot;&gt;&quot;./TestForm.pdf&quot;&lt;/span&gt;).getFile());

    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] testFormAsByte = Files.readAllBytes(testForm.toPath());
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] testFormAsByte2 = Files.readAllBytes(testForm.toPath());

    PDDocument pdf1 = PDDocument.load(testFormAsByte);
    PDAcroForm acroform = pdf1.getDocumentCatalog().getAcroForm();
    acroform.flatten();
    Path flattendedPdf = Files.createTempFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;flatten&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;.pdf&quot;&lt;/span&gt;);
    pdf1.save(flattendedPdf.toFile());


    PDFMergerUtility merger = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDFMergerUtility();
    merger.addSource(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(Files.readAllBytes(flattendedPdf)));
    merger.addSource(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(testFormAsByte2));
    merger.setDestinationFileName(&lt;span class=&quot;code-quote&quot;&gt;&quot;./build/flattenAndMerge.pdf&quot;&lt;/span&gt;);
    merger.mergeDocuments(MemoryUsageSetting.setupMainMemoryOnly());

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here is my SO Article&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/48271924/pdfbox-flatten-pdf-does-not-remove-acroform-elements?noredirect=1#comment83544858_48271924&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/48271924/pdfbox-flatten-pdf-does-not-remove-acroform-elements?noredirect=1#comment83544858_48271924&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13131222">PDFBOX-4066</key>
            <summary>Merging documents with nested fields duplicates child fields</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="msahyoun">Maruan Sahyoun</assignee>
                                    <reporter username="AlPhaba">Al Phaba</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jan 2018 12:30:30 +0000</created>
                <updated>Sat, 24 Mar 2018 09:41:35 +0000</updated>
                            <resolved>Fri, 2 Feb 2018 17:16:34 +0000</resolved>
                                    <version>2.0.8</version>
                                    <fixVersion>2.0.9</fixVersion>
                    <fixVersion>3.0.0 PDFBox</fixVersion>
                                    <component>AcroForm</component>
                    <component>Utilities</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16327218" author="msahyoun" created="Tue, 16 Jan 2018 15:17:26 +0000"  >&lt;p&gt;&lt;tt&gt;PDAcroForm.flatten()&lt;/tt&gt; works correct as all fields are removed - see &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12906236/12906236_TestForm-flattened.pdf&quot; title=&quot;TestForm-flattened.pdf attached to PDFBOX-4066&quot;&gt;TestForm-flattened.pdf&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16327289" author="tilman" created="Tue, 16 Jan 2018 15:57:59 +0000"  >&lt;p&gt;The title is misleading, the flattening works fine and has nothing to do with the problem, it&apos;s the merging that doesn&apos;t work properly.&lt;br/&gt;
 &lt;tt&gt;PDFMergerUtility.mergeAcroForm&lt;/tt&gt; copies the non terminal field &quot;cb_a&quot; and then hits all its children and tries to copy them again... see also remark by mkl in the SO issue.&lt;/p&gt;

&lt;p&gt;How about remembering the last full name of a non terminal field:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; nonTerminalPrefix = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PDField srcField : srcAcroForm.getFieldTree())
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (nonTerminalPrefix != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; srcField.getFullyQualifiedName().startsWith(nonTerminalPrefix))
                    &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (srcField &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; PDNonTerminalField)
                    nonTerminalPrefix = srcField.getFullyQualifiedName();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16327327" author="msahyoun" created="Tue, 16 Jan 2018 16:20:14 +0000"  >&lt;p&gt;As the dictionary entry is cloned by &lt;tt&gt;PDCloneUtility&lt;/tt&gt; it should be sufficient to check if the root fields names are duplicates. If yes we rename it otherwise we keep it. The child fields are handled by the cloning.&lt;/p&gt;

&lt;p&gt;So we could change &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PDField srcField : srcAcroForm.getFieldTree())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PDField srcField : srcAcroForm.getFields())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="16327331" author="tilman" created="Tue, 16 Jan 2018 16:23:37 +0000"  >&lt;p&gt;Can there be non terminal fields that don&apos;t have a name?&lt;/p&gt;</comment>
                            <comment id="16327343" author="msahyoun" created="Tue, 16 Jan 2018 16:33:40 +0000"  >&lt;p&gt;The field name is a required entry. &lt;/p&gt;</comment>
                            <comment id="16327353" author="tilman" created="Tue, 16 Jan 2018 16:43:04 +0000"  >&lt;p&gt;Then your change should work.&lt;/p&gt;</comment>
                            <comment id="16327397" author="msahyoun" created="Tue, 16 Jan 2018 17:09:51 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12906253/12906253_TestForm-merged.pdf&quot; title=&quot;TestForm-merged.pdf attached to PDFBOX-4066&quot;&gt;TestForm-merged.pdf&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; merges the original file 3 times. The first instance is flattened, the others are not. &lt;/p&gt;</comment>
                            <comment id="16327406" author="jira-bot" created="Tue, 16 Jan 2018 17:16:09 +0000"  >&lt;p&gt;Commit 1821276 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=msahyoun&quot; class=&quot;user-hover&quot; rel=&quot;msahyoun&quot;&gt;msahyoun&lt;/a&gt; in branch &apos;pdfbox/branches/2.0&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1821276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1821276&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4066&quot; title=&quot;Merging documents with nested fields duplicates child fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4066&quot;&gt;&lt;del&gt;PDFBOX-4066&lt;/del&gt;&lt;/a&gt;: check only root level fields for duplicate naming&lt;/p&gt;</comment>
                            <comment id="16327419" author="jira-bot" created="Tue, 16 Jan 2018 17:23:37 +0000"  >&lt;p&gt;Commit 1821277 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=msahyoun&quot; class=&quot;user-hover&quot; rel=&quot;msahyoun&quot;&gt;msahyoun&lt;/a&gt; in branch &apos;pdfbox/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1821277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1821277&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-4066&quot; title=&quot;Merging documents with nested fields duplicates child fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-4066&quot;&gt;&lt;del&gt;PDFBOX-4066&lt;/del&gt;&lt;/a&gt;: check only root level fields for duplicate naming&lt;/p&gt;</comment>
                            <comment id="16328611" author="mkl" created="Wed, 17 Jan 2018 10:47:49 +0000"  >&lt;p&gt;To make things a bit more complicated... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t a complete solution in case of a duplicate non-terminal root field check whether the entries other than the child fields are identical and in that case consider these top level fields merged and&#160;continue inspecting the child fields? If the child fields have distinct names, then all children of either duplicate can simply become children of the merged field.&lt;/p&gt;

&lt;p&gt;In case of duplicate non-terminal child fields the same consideration can take place as for the&#160;duplicate non-terminal root field.&lt;/p&gt;

&lt;p&gt;Even in case of duplicate terminal fields with identical entries other than the widgets one can consider merging them as multiple widgets of the same field. This should be optional, though, as this might not be wanted.&lt;/p&gt;

&lt;p&gt;Only in the case of&#160;duplicate non-terminal or terminal fields with incompatible entries one of the duplicates&#160;needs to be renamed...&lt;/p&gt;

&lt;p&gt;Ok, not trivial... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16328622" author="msahyoun" created="Wed, 17 Jan 2018 11:06:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkl&quot; class=&quot;user-hover&quot; rel=&quot;mkl&quot;&gt;mkl&lt;/a&gt; very kind to provide some feedback on that.&lt;br/&gt;
There are different strategies for merging AcroForm fields. PDFBox always (up to now) considered additional documents having the same form fields (at root level or childs) to be treated as new fields. That is different to how Adobe handles that situation where when merging fields with the same fully qualified name (and the same type) they are merged i.e. the to be merged field is treated as a new occurrence of the same field and as a result the annotations are merged into the same field entry.&lt;/p&gt;

&lt;p&gt;To me Adobe strategy makes more sense but there was discussion in another ticket (I&apos;ve forgotten the issue number) where the user didn&apos;t want them to be combined.&lt;/p&gt;

&lt;p&gt;So for now I think the fix is OK  as it is in line with the current behavior of PDFBox. But we should consider changing that for the 3.x release. WDYT? &lt;/p&gt;</comment>
                            <comment id="16346745" author="mkl" created="Wed, 31 Jan 2018 12:35:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=msahyoun&quot; class=&quot;user-hover&quot; rel=&quot;msahyoun&quot;&gt;msahyoun&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ok, a bit late, but yes, first of all the actual bug needed to be fixed. What remains is an improvement which one might or might not schedule early.&lt;/p&gt;</comment>
                            <comment id="16347628" author="joeeoj" created="Wed, 31 Jan 2018 21:14:02 +0000"  >&lt;p&gt;I agree there is definitely a use case where you want the duplicated-named merged fields to not be renamed, instead merged into the same field entry with multiple widgets.&#160; Seems like the best way to approach this would be an option on the PDFMergerUtility or maybe an extended class.&#160; I&apos;ve tinkered with the code to try and accomplish this but I&apos;m not familiar enough with the document structure or PDFBox in general.&lt;/p&gt;</comment>
                            <comment id="16350668" author="msahyoun" created="Fri, 2 Feb 2018 17:16:34 +0000"  >&lt;p&gt;I&apos;m resolving this as the bug itself has been resolved. For the enhancements to merging AcroForms please see &lt;a href=&quot;https://issues.apache.org/jira/browse/PDFBOX-3111&quot; title=&quot;Replicate Acrobat behavior when merging PDFs with interactive forms&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PDFBOX-3111&quot;&gt;PDFBOX-3111&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkl&quot; class=&quot;user-hover&quot; rel=&quot;mkl&quot;&gt;mkl&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joeeoj&quot; class=&quot;user-hover&quot; rel=&quot;joeeoj&quot;&gt;joeeoj&lt;/a&gt; I&apos;ve added you as a watcher there. Thanks for your input.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12906236" name="TestForm-flattened.pdf" size="35912" author="msahyoun" created="Tue, 16 Jan 2018 15:15:48 +0000"/>
                            <attachment id="12906253" name="TestForm-merged.pdf" size="103277" author="msahyoun" created="Tue, 16 Jan 2018 17:08:36 +0000"/>
                            <attachment id="12906219" name="TestForm.pdf" size="37492" author="AlPhaba" created="Tue, 16 Jan 2018 12:27:05 +0000"/>
                            <attachment id="12906220" name="flattenAndMerge.pdf" size="69438" author="AlPhaba" created="Tue, 16 Jan 2018 12:26:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oy9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>