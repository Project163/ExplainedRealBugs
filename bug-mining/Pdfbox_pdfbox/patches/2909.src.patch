diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
index bbd5f4d9c7..07e9791422 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
@@ -1075,6 +1075,12 @@ public class COSWriter implements ICOSVisitor
             actual = ((COSObject) obj).getObject();
             if (actual == null)
             {
+                // the referenced object isn't there due to a malformed pdf
+                // check if a key is present, otherwise create a new one
+                if (key == null)
+                {
+                    key = new COSObjectKey(++number, 0);
+                }
                 objectKeys.put(obj, key);
                 return key;
             }
