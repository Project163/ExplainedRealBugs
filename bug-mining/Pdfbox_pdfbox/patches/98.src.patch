diff --git a/pdfbox/src/main/java/org/apache/pdfbox/cos/COSName.java b/pdfbox/src/main/java/org/apache/pdfbox/cos/COSName.java
index ede31add29..3aa1608b2d 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/cos/COSName.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/cos/COSName.java
@@ -382,6 +382,9 @@ public final class COSName extends COSBase implements Comparable<COSName>
     /** "Encrypt" */
     public static final COSName ENCRYPT = new COSName( "Encrypt" );
 
+    /** "EncryptMetaData" */
+    public static final COSName ENCRYPT_META_DATA = new COSName( "EncryptMetadata" );
+    
     /** "ExtGState" */
     public static final COSName EXT_G_STATE = new COSName( "ExtGState" );
 
diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/PDEncryptionDictionary.java b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/PDEncryptionDictionary.java
index 2d81a01101..eaa21d1137 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/PDEncryptionDictionary.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/PDEncryptionDictionary.java
@@ -20,6 +20,8 @@ package org.apache.pdfbox.pdmodel.encryption;
 import java.io.IOException;
 
 import org.apache.pdfbox.cos.COSArray;
+import org.apache.pdfbox.cos.COSBase;
+import org.apache.pdfbox.cos.COSBoolean;
 import org.apache.pdfbox.cos.COSDictionary;
 import org.apache.pdfbox.cos.COSName;
 import org.apache.pdfbox.cos.COSString;
@@ -301,6 +303,25 @@ public class PDEncryptionDictionary
         return encryptionDictionary.getInt( COSName.P, 0 );
     }
 
+    /**
+     * Will get the EncryptMetaData dictionary info.
+     * 
+     * @return true if EncryptMetaData is explicitly set to false (the default is true)
+     */
+    public boolean isEncryptMetaData()
+    {
+        // default is true (see 7.6.3.2 Standard Encryption Dictionary PDF 32000-1:2008)
+        boolean encryptMetaData = true;
+        
+        COSBase value = encryptionDictionary.getDictionaryObject(COSName.ENCRYPT_META_DATA);
+        
+        if (value instanceof COSBoolean) {
+            encryptMetaData = ((COSBoolean)value).getValue();
+        }
+        
+        return encryptMetaData;
+    }
+    
     /**
      * This will set the Recipients field of the dictionary. This field contains an array
      * of string.
diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/SecurityHandler.java b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/SecurityHandler.java
index 4b6099eca8..4201bd86df 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/SecurityHandler.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/SecurityHandler.java
@@ -223,6 +223,10 @@ public abstract class SecurityHandler
     public void encryptData(long objectNumber, long genNumber, InputStream data, OutputStream output, boolean decrypt) 
     throws CryptographyException, IOException
     {
+        if (aes && !decrypt) {
+            throw new IllegalArgumentException("AES encryption is not yet implemented.");
+        }
+        
         byte[] newKey = new byte[ encryptionKey.length + 5 ];
         System.arraycopy( encryptionKey, 0, newKey, 0, encryptionKey.length );
         //PDF 1.4 reference pg 73
diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/StandardSecurityHandler.java b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/StandardSecurityHandler.java
index b4545ec174..c72a4bfe8b 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/StandardSecurityHandler.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdmodel/encryption/StandardSecurityHandler.java
@@ -180,6 +180,9 @@ public class StandardSecurityHandler extends SecurityHandler
             documentIDBytes = new byte[0];
         }
 
+        // we need to know whether the meta data was encrypted for password calculation
+        boolean encryptMetadata = dictionary.isEncryptMetaData();
+        
         byte[] u = dictionary.getUserKey();
         byte[] o = dictionary.getOwnerKey();
 
@@ -191,7 +194,8 @@ public class StandardSecurityHandler extends SecurityHandler
                 dicPermissions,
                 documentIDBytes,
                 dicRevision,
-                dicLength );
+                dicLength,
+                encryptMetadata);
         boolean isOwnerPassword =
             isOwnerPassword(
                 password.getBytes(),
@@ -200,7 +204,8 @@ public class StandardSecurityHandler extends SecurityHandler
                 dicPermissions,
                 documentIDBytes,
                 dicRevision,
-                dicLength );
+                dicLength,
+                encryptMetadata);
 
         if( isUserPassword )
         {
@@ -212,7 +217,8 @@ public class StandardSecurityHandler extends SecurityHandler
                     dicPermissions,
                     documentIDBytes,
                     dicRevision,
-                    dicLength );
+                    dicLength,
+                    encryptMetadata );
         }
         else if( isOwnerPassword )
         {
@@ -225,7 +231,8 @@ public class StandardSecurityHandler extends SecurityHandler
                     dicPermissions,
                     documentIDBytes,
                     dicRevision,
-                    dicLength );
+                    dicLength,
+                    encryptMetadata);
         }
         else
         {
@@ -330,10 +337,10 @@ public class StandardSecurityHandler extends SecurityHandler
 
         byte[] u = computeUserPassword(
             userPassword.getBytes("ISO-8859-1"),
-            o, permissionInt, id.getBytes(), revision, length);
+            o, permissionInt, id.getBytes(), revision, length, true);
 
         encryptionKey = computeEncryptedKey(
-            userPassword.getBytes("ISO-8859-1"), o, permissionInt, id.getBytes(), revision, length);
+            userPassword.getBytes("ISO-8859-1"), o, permissionInt, id.getBytes(), revision, length, true);
 
         encryptionDictionary.setOwnerKey(o);
         encryptionDictionary.setUserKey(u);
@@ -366,11 +373,12 @@ public class StandardSecurityHandler extends SecurityHandler
             int permissions,
             byte[] id,
             int encRevision,
-            int length)
+            int length,
+            boolean encryptMetadata)
             throws CryptographyException, IOException
     {
         byte[] userPassword = getUserPassword( ownerPassword, o, encRevision, length );
-        return isUserPassword( userPassword, u, o, permissions, id, encRevision, length );
+        return isUserPassword( userPassword, u, o, permissions, id, encRevision, length, encryptMetadata );
     }
 
     /**
@@ -501,7 +509,8 @@ public class StandardSecurityHandler extends SecurityHandler
             int permissions,
             byte[] id,
             int encRevision,
-            int length )
+            int length,
+            boolean encryptMetadata)
             throws CryptographyException
         {
             byte[] result = new byte[ length ];
@@ -531,6 +540,15 @@ public class StandardSecurityHandler extends SecurityHandler
 
                 //step 5
                 md.update( id );
+                
+                //(Security handlers of revision 4 or greater) If document metadata is not being encrypted, 
+                //pass 4 bytes with the value 0xFFFFFFFF to the MD5 hash function.
+                //see 7.6.3.3 Algorithm 2 Step f of PDF 32000-1:2008
+                if( encRevision == 4 && !encryptMetadata)
+                {
+                    md.update(new byte[]{(byte)0xff, (byte)0xff, (byte)0xff, (byte)0xff});
+                }
+                
                 byte[] digest = md.digest();
 
                 //step 6
@@ -581,12 +599,13 @@ public class StandardSecurityHandler extends SecurityHandler
             int permissions,
             byte[] id,
             int encRevision,
-            int length )
+            int length,
+            boolean encryptMetadata)
             throws CryptographyException, IOException
         {
             ByteArrayOutputStream result = new ByteArrayOutputStream();
             //STEP 1
-            byte[] encryptionKey = computeEncryptedKey( password, o, permissions, id, encRevision, length );
+            byte[] encryptionKey = computeEncryptedKey( password, o, permissions, id, encRevision, length, encryptMetadata );
 
             if( encRevision == 2 )
             {
@@ -764,12 +783,14 @@ public class StandardSecurityHandler extends SecurityHandler
             int permissions,
             byte[] id,
             int encRevision,
-            int length)
+            int length,
+            boolean encryptMetadata)
             throws CryptographyException, IOException
         {
             boolean matches = false;
             //STEP 1
-            byte[] computedValue = computeUserPassword( password, o, permissions, id, encRevision, length );
+            byte[] computedValue = computeUserPassword( password, o, permissions, id, encRevision, length, 
+                    encryptMetadata );
             if( encRevision == 2 )
             {
                 //STEP 2
@@ -810,11 +831,12 @@ public class StandardSecurityHandler extends SecurityHandler
             int permissions,
             byte[] id,
             int encRevision,
-            int length)
+            int length,
+            boolean encryptMetadata )
             throws CryptographyException, IOException
             {
                 return isUserPassword(password.getBytes(),
-                        u,o,permissions, id, encRevision, length);
+                        u,o,permissions, id, encRevision, length, encryptMetadata);
             }
 
     /**
@@ -840,11 +862,12 @@ public class StandardSecurityHandler extends SecurityHandler
             int permissions,
             byte[] id,
             int encRevision,
-            int length)
+            int length,
+            boolean encryptMetadata)
             throws CryptographyException, IOException
             {
                 return isOwnerPassword(password.getBytes(),
-                        u,o,permissions, id, encRevision, length);
+                        u,o,permissions, id, encRevision, length, encryptMetadata);
             }
 
     private static final boolean arraysEqual( byte[] first, byte[] second, int count )
