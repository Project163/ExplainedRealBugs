diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
index e92e297049..97d52459e6 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/COSWriter.java
@@ -489,13 +489,13 @@ public class COSWriter implements ICOSVisitor
                 objectKeys.put(object, key);
                 keyObject.put(key, object);
             }
+            number = compressionPool.getHighestXRefObjectNumber();
             for (COSObjectKey key : compressionPool.getTopLevelObjects())
             {
                 currentObjectKey = key;
                 doWriteObject(key, keyObject.get(key));
             }
             // Append object streams to document.
-            number = compressionPool.getHighestXRefObjectNumber();
             for (COSWriterObjectStream finalizedObjectStream : compressionPool
                     .createObjectStreams())
             {
@@ -1090,24 +1090,20 @@ public class COSWriter implements ICOSVisitor
     }
 
     @Override
-    public void visitFromArray(COSArray obj) throws IOException
+    public void visitFromArray(COSArray array) throws IOException
     {
         int count = 0;
         getStandardOutput().write(ARRAY_OPEN);
-        for (Iterator<COSBase> i = obj.iterator(); i.hasNext();)
+        for (Iterator<COSBase> i = array.iterator(); i.hasNext();)
         {
             COSBase current = i.next();
             if( current instanceof COSDictionary )
             {
-                if (current.isDirect())
-                {
-                    visitFromDictionary((COSDictionary)current);
-                }
-                else
-                {
-                    addObjectToWrite( current );
-                    writeReference( current );
-                }
+                writeDictionary((COSDictionary) current);
+            }
+            else if (current instanceof COSArray)
+            {
+                writeArray((COSArray) current);
             }
             else if( current instanceof COSObject )
             {
@@ -1139,6 +1135,32 @@ public class COSWriter implements ICOSVisitor
         getStandardOutput().writeEOL();
     }
 
+    private void writeArray(COSArray array) throws IOException
+    {
+        if (array.isDirect())
+        {
+            visitFromArray(array);
+        }
+        else
+        {
+            addObjectToWrite(array);
+            writeReference(array);
+        }
+    }
+
+    private void writeDictionary(COSDictionary dictionary) throws IOException
+    {
+        if (dictionary.isDirect())
+        {
+            visitFromDictionary(dictionary);
+        }
+        else
+        {
+            addObjectToWrite(dictionary);
+            writeReference(dictionary);
+        }
+    }
+
     @Override
     public void visitFromBoolean(COSBoolean obj) throws IOException
     {
@@ -1177,18 +1199,7 @@ public class COSWriter implements ICOSVisitor
                             item.setDirect(true);
                         }
                     }
-
-                    if(dict.isDirect())
-                    {
-                        // If the object should be written direct, we need
-                        // to pass the dictionary to the visitor again.
-                        visitFromDictionary(dict);
-                    }
-                    else
-                    {
-                        addObjectToWrite( dict );
-                        writeReference( dict );
-                    }
+                    writeDictionary(dict);
                 }
                 else if( value instanceof COSObject )
                 {
@@ -1215,7 +1226,14 @@ public class COSWriter implements ICOSVisitor
                     }
                     else
                     {
-                        value.accept(this);
+                        if (value instanceof COSArray)
+                        {
+                            writeArray((COSArray) value);
+                        }
+                        else
+                        {
+                            value.accept(this);
+                        }
                     }
                 }
                 getStandardOutput().writeEOL();
diff --git a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/compress/COSWriterCompressionPool.java b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/compress/COSWriterCompressionPool.java
index c3d13e26b2..dd4bfc1506 100644
--- a/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/compress/COSWriterCompressionPool.java
+++ b/pdfbox/src/main/java/org/apache/pdfbox/pdfwriter/compress/COSWriterCompressionPool.java
@@ -153,7 +153,9 @@ public class COSWriterCompressionPool
     {
         COSBase base = current;
         if (current instanceof COSStream
-                || (current instanceof COSDictionary && !current.isDirect()))
+                || (current instanceof COSDictionary && !current.isDirect()) //
+                || (current instanceof COSArray && !current.isDirect()) //
+        )
         {
             base = addObjectToPool(base.getKey(), current);
         }
