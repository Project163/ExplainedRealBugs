{"url":"https://api.github.com/repos/netty/netty/issues/6282","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/6282/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/6282/comments","events_url":"https://api.github.com/repos/netty/netty/issues/6282/events","html_url":"https://github.com/netty/netty/issues/6282","id":203413095,"node_id":"MDU6SXNzdWUyMDM0MTMwOTU=","number":6282,"title":"Incorrect allocations value for PoolArena (tiny / small / normal)","user":{"login":"isdom","id":2010691,"node_id":"MDQ6VXNlcjIwMTA2OTE=","avatar_url":"https://avatars.githubusercontent.com/u/2010691?v=4","gravatar_id":"","url":"https://api.github.com/users/isdom","html_url":"https://github.com/isdom","followers_url":"https://api.github.com/users/isdom/followers","following_url":"https://api.github.com/users/isdom/following{/other_user}","gists_url":"https://api.github.com/users/isdom/gists{/gist_id}","starred_url":"https://api.github.com/users/isdom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/isdom/subscriptions","organizations_url":"https://api.github.com/users/isdom/orgs","repos_url":"https://api.github.com/users/isdom/repos","events_url":"https://api.github.com/users/isdom/events{/privacy}","received_events_url":"https://api.github.com/users/isdom/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/157","html_url":"https://github.com/netty/netty/milestone/157","labels_url":"https://api.github.com/repos/netty/netty/milestones/157/labels","id":2246859,"node_id":"MDk6TWlsZXN0b25lMjI0Njg1OQ==","number":157,"title":"4.0.44.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":32,"state":"closed","created_at":"2017-01-12T10:23:46Z","updated_at":"2017-01-30T18:17:24Z","due_on":null,"closed_at":"2017-01-30T18:17:24Z"},"comments":6,"created_at":"2017-01-26T16:14:10Z","updated_at":"2017-01-30T09:45:52Z","closed_at":"2017-01-30T09:34:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I found some PoolArena allocations value was incorrect, more specifically is:\r\n\r\n    long numTinyAllocations();\r\n    long numSmallAllocations();\r\n    long numNormalAllocations();\r\n\r\nand\r\n\r\n    long numNormalDeallocations();\r\n\r\nWhen I alloc Pooled ByteBuf & and release all these Bufs,\r\n\r\n### Expected behavior\r\n \r\nPoolArena's Metric SHOULD meet the following conditions:\r\n```\r\n           numTinyAllocations() == numTinyDeallocations()\r\n     &&   numSmallAllocations() == numSmallDeallocations()\r\n     &&   numNormalAllocations() == numNormalDeallocations()\r\n```\r\n### Actual behavior\r\n\r\nBUT now result:\r\n```\r\n           numTinyAllocations() < numTinyDeallocations()\r\n     &&   numSmallAllocations() < numSmallDeallocations()\r\n     &&   numNormalAllocations() > numNormalDeallocations()\r\n```\r\nIt seems some tiny & small allocations increase normal's counter,  I export PoolArenaMetric as MBean by [code](https://github.com/isdom/jocean-http/blob/9d8d528a2a3ee6bf2ca12f04054523dec94d3507/jocean-http/src/main/java/org/jocean/http/util/NettyStats.java) and show MBean by Web using zkoss, see below:\r\n\r\n<img width=\"905\" alt=\"2017-01-25 11 23 34\" src=\"https://cloud.githubusercontent.com/assets/2010691/22338996/a21ee320-e423-11e6-8575-0fee497ae401.png\">\r\n\r\nIn this case, \r\n\r\n`numAllocations(2404) == numDeallocations(2404)`\r\n\r\nBUT  \r\n```\r\n   (numTinyDeallocations - numTinyAllocations)       //  == 17\r\n+ (numSmallDeallocations - numSmallAllocations)       //  == 9\r\n```\r\nequals\r\n\r\n` (numNormalAllocations - numNormalDeallocations)       // == 26`\r\n\r\n### Steps to reproduce\r\n\r\nI start test code with VM flag (disable thread local cache): \r\n```\r\n-XX:MaxDirectMemorySize=96M\r\n-Dio.netty.allocator.tinyCacheSize=0 \r\n-Dio.netty.allocator.smallCacheSize=0 \r\n-Dio.netty.allocator.normalCacheSize=0 \r\n-Dio.netty.allocator.type=pooled\r\n```\r\nthen alloc some ByteBuf and release Bufs.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nTestCase to reproduce: https://github.com/isdom/jocean-http/blob/6bc6cfa9ae1e71395a4dd52355b1b0a8365bb530/jocean-http/src/test/java/org/jocean/netty/buffer/PooledByteBufAllocatorTestCase.java\r\n\r\nand make sure run this test with VM flag: -XX:MaxDirectMemorySize=96M\r\n\r\nIt fail at:\r\n\r\n```\r\nassertEquals(metric.numTinyDeallocations(), metric.numTinyAllocations());\r\nassertEquals(metric.numSmallDeallocations(), metric.numSmallAllocations());\r\nassertEquals(metric.numNormalDeallocations(), metric.numNormalAllocations());\r\n```\r\noutput : \r\n```\r\njava.lang.AssertionError: expected:<1> but was:<0>\r\n\tat org.junit.Assert.fail(Assert.java:88)\r\n```\r\n\r\nIf this is confirmed as a issueï¼ŒI can open a PR to fix it.\r\n\r\n### Netty version\r\n\r\nnetty-all-4.1.7.Final\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\njava version \"1.8.0_102\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_102-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\nLinux xxx 3.10.0-327.22.2.el7.x86_64 #1 SMP Thu Jun 23 17:05:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/6282/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/6282/timeline","performed_via_github_app":null,"state_reason":"completed"}