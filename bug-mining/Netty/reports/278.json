{"url":"https://api.github.com/repos/netty/netty/issues/13540","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/13540/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/13540/comments","events_url":"https://api.github.com/repos/netty/netty/issues/13540/events","html_url":"https://github.com/netty/netty/issues/13540","id":1842622501,"node_id":"I_kwDOABA-c85t1DAl","number":13540,"title":"Unexpected characters are synthesized by DefaultHttp2HeadersDecoder when Huffman encoding is enabled in HpackEncoder","user":{"login":"Lincong","id":9780681,"node_id":"MDQ6VXNlcjk3ODA2ODE=","avatar_url":"https://avatars.githubusercontent.com/u/9780681?v=4","gravatar_id":"","url":"https://api.github.com/users/Lincong","html_url":"https://github.com/Lincong","followers_url":"https://api.github.com/users/Lincong/followers","following_url":"https://api.github.com/users/Lincong/following{/other_user}","gists_url":"https://api.github.com/users/Lincong/gists{/gist_id}","starred_url":"https://api.github.com/users/Lincong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lincong/subscriptions","organizations_url":"https://api.github.com/users/Lincong/orgs","repos_url":"https://api.github.com/users/Lincong/repos","events_url":"https://api.github.com/users/Lincong/events{/privacy}","received_events_url":"https://api.github.com/users/Lincong/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-08-09T07:05:07Z","updated_at":"2023-08-17T03:31:56Z","closed_at":"2023-08-17T03:31:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What happened?\r\n1. Create a header `DefaultHttp2Headers` with a certain value that exceeds certain size and contain non-ASCII characters, \r\n2. Encode the header using `DefaultHttp2HeadersEncoder`.\r\n3. Decode the encoded header using `DefaultHttp2HeadersDecoder`.\r\n4. If Huffman encoding is enabled in the `HpackDecoder` (used inside `DefaultHttp2HeadersDecoder`), unexpected character(s) magically show up in the decoded string. \r\n\r\n\"Unexpected characters\" means:\r\n1. They are not in the original header value which is encoded.\r\n2. Their unicode code points are smaller than 32.\r\n\r\nPlease note that different header value input can yield different unexpected characters. In the below repro code, `NULL (U+0000)` is the unexpected character. We also have header value (which contains company-specific information) that would yield `\\r` as unexpected characters.\r\n\r\nIMO the first thing is to confirm that there is indeed a bug in the HPACK implementation (and/or any other components).\r\n\r\n### Steps to reproduce\r\nPlease refer to the below code.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n```scala\r\ntest(\"NULL character is magically synthesized by DefaultHttp2HeadersDecoder when Huffman encoding is enabled in HpackEncoder\") {\r\n import io.netty.handler.codec.http2.DefaultHttp2Headers\r\n import io.netty.handler.codec.http2.DefaultHttp2HeadersEncoder\r\n import io.netty.buffer.Unpooled\r\n import io.netty.handler.codec.http2.DefaultHttp2HeadersDecoder\r\n\r\n val headers = new DefaultHttp2Headers\r\n val badHeaderValue =\r\n   \"{\\\"xxxx\\\":\\\"xxxxxxxxxxxxxxxxxxxxxxxxxxxx\\\",\\\"xxxxxxx\\\":\\\"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\\\",\\\"xxxx\\\":\\\"x\\\",\\\"xxxxxxx\\\":\\\"xxxxxxxxxxxxxxxxxxxxxxxxxx\\\",\\\"xxxxxxxxxxxxxx\\\":\\\"Êàë‰ª¨Âú®Netty‰∏≠ÂèëÁé∞‰∫Ü‰∏Ä‰∏™bug_–º–∏ –∑–Ω–∞–π—à–ª–∏ –ø—Ä–æ–±–ª–µ–º—É –≤_123–º—ã–Ω–∞—à–ª–∏–ø—Ä–æ–±–ª–µ–º—É–≤_Ïö∞Î¶¨ÎäîÏóêÏÑúÎ¨∏Ï†úÎ•ºÎ∞úÍ≤¨ÌñàÏäµÎãàÎã§Saturday10311031UsersVlad@Alex_ver10311031Shared„ÅßÂïèÈ°å„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüIAPKI_ActivityVlad@AlexÏö∞Î¶¨ÎäîÏóêÏÑúÎ¨∏Ï†úÎ•ºÎ∞úÍ≤¨ÌñàÏäµÎãàÎã§BatchWeFound_10311031UsersVlad@Alex_ver10311031Shared\\\",\\\"xxxxxx\\\":\\\"xxxxxxxx\\\",\\\"xxxxxxxx\\\":\\\"xxxxxx-87\\\",\\\"xxxxxxxxx\\\":\\\"xxxxxx.xxxxxx.xxxxxx.xxxxxx.24hgjbu2g2hgwoejf231Xxxxxxx/Xxxx\\\"}\"\r\n headers.set(\"some-key\", badHeaderValue)\r\n\r\n val neverSensitive: SensitivityDetector = new SensitivityDetector() {\r\n   override def isSensitive(name: CharSequence, value: CharSequence) = false\r\n }\r\n val enableHuffmanEncoding = true\r\n // Use the below threshold to control whether Huffman encoding is enabled for the above header value at runtime.\r\n val huffCodeThreshold: Int = if (enableHuffmanEncoding) 512 else 51200\r\n\r\n val encoder = new DefaultHttp2HeadersEncoder(\r\n   neverSensitive,\r\n   false, // ignoreMaxHeaderListSize, same value as default.\r\n   64, // dynamicTableArraySizeHint, same value as default.\r\n   huffCodeThreshold\r\n )\r\n val buf = Unpooled.buffer(10000)\r\n encoder.encodeHeaders(1, headers, buf)\r\n\r\n val decoder = new DefaultHttp2HeadersDecoder()\r\n val decodedHeader = decoder.decodeHeaders(1, buf)\r\n val decodedHeaderValue: String = decodedHeader.get(\"some-key\").toString\r\n val nullChar: Char = 0.toChar\r\n\r\n assert(!badHeaderValue.contains(nullChar)) // `Null` is not in the original header value.\r\n if (enableHuffmanEncoding) {\r\n   // üëáüëáüëá Unexpected 'Null' character gets synthesized in the header value ü´¢\r\n   assert(decodedHeaderValue.contains(nullChar))\r\n } else {\r\n   // Huffman encoding is disabled.\r\n   assert(!decodedHeaderValue.contains(nullChar))\r\n }\r\n\r\n val scalaVersion: String = scala.util.Properties.scalaPropOrElse(\"version.number\", \"unknown\")\r\n println(s\"Scala version: $scalaVersion\") // 2.12.15\r\n val javaVersion: String = System.getProperty(\"java.version\")\r\n println(s\"Java version number: $javaVersion\") // 11.0.10\r\n val javaVendor: String = System.getProperty(\"java.vendor\")\r\n println(s\"Java vendor: $javaVendor\") // Azul Systems, Inc\r\n}\r\n```\r\n\r\n### Netty version\r\n`4.1.86.Final`\r\n\r\n### JVM version (e.g. `java -version`)\r\n```\r\nScala version: 2.12.15\r\nJava version number: 11.0.10\r\nJava vendor: Azul Systems, Inc\r\n```","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/13540/reactions","total_count":7,"+1":7,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/13540/timeline","performed_via_github_app":null,"state_reason":"completed"}