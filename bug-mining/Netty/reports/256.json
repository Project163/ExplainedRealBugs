{"url":"https://api.github.com/repos/netty/netty/issues/12959","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/12959/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/12959/comments","events_url":"https://api.github.com/repos/netty/netty/issues/12959/events","html_url":"https://github.com/netty/netty/issues/12959","id":1433208118,"node_id":"I_kwDOABA-c85VbQU2","number":12959,"title":"Netty's BlockHound integration assumes `FastThreadLocalThread` is always non-blocking","user":{"login":"jrhee17","id":8510579,"node_id":"MDQ6VXNlcjg1MTA1Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/8510579?v=4","gravatar_id":"","url":"https://api.github.com/users/jrhee17","html_url":"https://github.com/jrhee17","followers_url":"https://api.github.com/users/jrhee17/followers","following_url":"https://api.github.com/users/jrhee17/following{/other_user}","gists_url":"https://api.github.com/users/jrhee17/gists{/gist_id}","starred_url":"https://api.github.com/users/jrhee17/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrhee17/subscriptions","organizations_url":"https://api.github.com/users/jrhee17/orgs","repos_url":"https://api.github.com/users/jrhee17/repos","events_url":"https://api.github.com/users/jrhee17/events{/privacy}","received_events_url":"https://api.github.com/users/jrhee17/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/265","html_url":"https://github.com/netty/netty/milestone/265","labels_url":"https://api.github.com/repos/netty/netty/milestones/265/labels","id":8535848,"node_id":"MI_kwDOABA-c84Agj8o","number":265,"title":"4.1.85.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":28,"state":"closed","created_at":"2022-10-13T08:23:45Z","updated_at":"2022-11-09T22:55:16Z","due_on":null,"closed_at":"2022-11-09T22:55:16Z"},"comments":0,"created_at":"2022-11-02T14:07:07Z","updated_at":"2022-11-09T07:29:41Z","closed_at":"2022-11-09T07:26:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n\r\nThe motivation is similar to https://github.com/netty/netty/issues/12125 which has already been reported and closed.\r\n\r\nI'm wondering if `FastThreadLocalThread` can be used for executing blocking tasks while integrating with Netty's `BlockHound` integration.\r\n\r\n### Actual behavior\r\n\r\nSome libraries utilize `FastThreadLocalThread` not only for event loops but also for blocking task executors.\r\nFor this case, it is acceptable that a blocking task is executed within a `FastThreadLocalThread`.\r\n\r\nHowever, Netty's `BlockHound` integration assumes that all `FastThreadLocalThread` instances should be non-blocking.\r\n\r\nhttps://github.com/netty/netty/blob/cfcc5144578d3f998d353cc3c3b448fc56333e0d/common/src/main/java/io/netty/util/internal/Hidden.java#L173\r\n\r\nI'm wondering if it would be possible to define a separate `FastThreadLocalThread` (e.g. `NonBlockingFastThreadLocalThread`) and apply `BlockHound` predicates on the `NonBlocking` variant instead.\r\n\r\nI guess users may override `DefaultThreadFactory#newThread` and apply their own `FastThreadLocalThread` variant if they would like.\r\n\r\nA potential diffset:\r\n\r\n```\r\ndiff --git a/common/src/main/java/io/netty/util/concurrent/DefaultThreadFactory.java b/common/src/main/java/io/netty/util/concurrent/DefaultThreadFactory.java\r\nindex a18f236309..6e2b25f67c 100644\r\n--- a/common/src/main/java/io/netty/util/concurrent/DefaultThreadFactory.java\r\n+++ b/common/src/main/java/io/netty/util/concurrent/DefaultThreadFactory.java\r\n@@ -118,6 +118,6 @@ public class DefaultThreadFactory implements ThreadFactory {\r\n     }\r\n \r\n     protected Thread newThread(Runnable r, String name) {\r\n-        return new FastThreadLocalThread(threadGroup, r, name);\r\n+        return new NonBlockingFastThreadLocalThread(threadGroup, r, name);\r\n     }\r\n }\r\ndiff --git a/common/src/main/java/io/netty/util/concurrent/NonBlockingFastThreadLocalThread.java b/common/src/main/java/io/netty/util/concurrent/NonBlockingFastThreadLocalThread.java\r\nnew file mode 100644\r\nindex 0000000000..00b2455e43\r\n--- /dev/null\r\n+++ b/common/src/main/java/io/netty/util/concurrent/NonBlockingFastThreadLocalThread.java\r\n@@ -0,0 +1,31 @@\r\n+/*\r\n+ * Copyright 2022 The Netty Project\r\n+ *\r\n+ * The Netty Project licenses this file to you under the Apache License,\r\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\r\n+ * with the License. You may obtain a copy of the License at:\r\n+ *\r\n+ *   https://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\r\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\r\n+ * License for the specific language governing permissions and limitations\r\n+ * under the License.\r\n+ */\r\n+\r\n+package io.netty.util.concurrent;\r\n+\r\n+/**\r\n+ * A special {@link Thread} that provides fast access to {@link FastThreadLocal} variables.\r\n+ */\r\n+public final class NonBlockingFastThreadLocalThread extends FastThreadLocalThread {\r\n+\r\n+    public NonBlockingFastThreadLocalThread(ThreadGroup threadGroup, Runnable r, String name) {\r\n+        super(threadGroup, r, name);\r\n+    }\r\n+\r\n+    public NonBlockingFastThreadLocalThread(Runnable runnable) {\r\n+        super(runnable);\r\n+    }\r\n+}\r\ndiff --git a/common/src/main/java/io/netty/util/internal/Hidden.java b/common/src/main/java/io/netty/util/internal/Hidden.java\r\nindex fec14d1254..4c67b7f166 100644\r\n--- a/common/src/main/java/io/netty/util/internal/Hidden.java\r\n+++ b/common/src/main/java/io/netty/util/internal/Hidden.java\r\n@@ -16,13 +16,13 @@\r\n \r\n package io.netty.util.internal;\r\n \r\n-import io.netty.util.concurrent.FastThreadLocalThread;\r\n-import reactor.blockhound.BlockHound;\r\n-import reactor.blockhound.integration.BlockHoundIntegration;\r\n-\r\n import java.util.function.Function;\r\n import java.util.function.Predicate;\r\n \r\n+import io.netty.util.concurrent.NonBlockingFastThreadLocalThread;\r\n+import reactor.blockhound.BlockHound;\r\n+import reactor.blockhound.integration.BlockHoundIntegration;\r\n+\r\n /**\r\n  * Contains classes that must have public visibility but are not public API.\r\n  */\r\n@@ -170,7 +170,7 @@ class Hidden {\r\n                         @Override\r\n                         @SuppressJava6Requirement(reason = \"Predicate#test\")\r\n                         public boolean test(Thread thread) {\r\n-                            return p.test(thread) || thread instanceof FastThreadLocalThread;\r\n+                            return p.test(thread) || thread instanceof NonBlockingFastThreadLocalThread;\r\n                         }\r\n                     };\r\n                 }\r\ndiff --git a/common/src/main/java/io/netty/util/internal/ObjectCleaner.java b/common/src/main/java/io/netty/util/internal/ObjectCleaner.java\r\nindex 0eb7b3495f..e1e76e6688 100644\r\n--- a/common/src/main/java/io/netty/util/internal/ObjectCleaner.java\r\n+++ b/common/src/main/java/io/netty/util/internal/ObjectCleaner.java\r\n@@ -15,7 +15,8 @@\r\n  */\r\n package io.netty.util.internal;\r\n \r\n-import io.netty.util.concurrent.FastThreadLocalThread;\r\n+import static io.netty.util.internal.SystemPropertyUtil.getInt;\r\n+import static java.lang.Math.max;\r\n \r\n import java.lang.ref.ReferenceQueue;\r\n import java.lang.ref.WeakReference;\r\n@@ -24,8 +25,7 @@ import java.security.PrivilegedAction;\r\n import java.util.Set;\r\n import java.util.concurrent.atomic.AtomicBoolean;\r\n \r\n-import static io.netty.util.internal.SystemPropertyUtil.getInt;\r\n-import static java.lang.Math.max;\r\n+import io.netty.util.concurrent.NonBlockingFastThreadLocalThread;\r\n \r\n /**\r\n  * Allows a way to register some {@link Runnable} that will executed once there are no references to an {@link Object}\r\n@@ -100,7 +100,7 @@ public final class ObjectCleaner {\r\n \r\n         // Check if there is already a cleaner running.\r\n         if (CLEANER_RUNNING.compareAndSet(false, true)) {\r\n-            final Thread cleanupThread = new FastThreadLocalThread(CLEANER_TASK);\r\n+            final Thread cleanupThread = new NonBlockingFastThreadLocalThread(CLEANER_TASK);\r\n             cleanupThread.setPriority(Thread.MIN_PRIORITY);\r\n             // Set to null to ensure we not create classloader leaks by holding a strong reference to the inherited\r\n             // classloader.\r\n\r\n\r\n```\r\n\r\n### Steps to reproduce\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\n### Netty version\r\n\r\n4.1.82\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\nn/a\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\nn/a","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/12959/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/12959/timeline","performed_via_github_app":null,"state_reason":"completed"}