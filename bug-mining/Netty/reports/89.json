{"url":"https://api.github.com/repos/netty/netty/issues/9212","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/9212/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/9212/comments","events_url":"https://api.github.com/repos/netty/netty/issues/9212/events","html_url":"https://github.com/netty/netty/issues/9212","id":451120025,"node_id":"MDU6SXNzdWU0NTExMjAwMjU=","number":9212,"title":"UDP ports may remain open after calling RoundRobinDnsAddressResolverGroup#close()","user":{"login":"jchambers","id":31352,"node_id":"MDQ6VXNlcjMxMzUy","avatar_url":"https://avatars.githubusercontent.com/u/31352?v=4","gravatar_id":"","url":"https://api.github.com/users/jchambers","html_url":"https://github.com/jchambers","followers_url":"https://api.github.com/users/jchambers/followers","following_url":"https://api.github.com/users/jchambers/following{/other_user}","gists_url":"https://api.github.com/users/jchambers/gists{/gist_id}","starred_url":"https://api.github.com/users/jchambers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jchambers/subscriptions","organizations_url":"https://api.github.com/users/jchambers/orgs","repos_url":"https://api.github.com/users/jchambers/repos","events_url":"https://api.github.com/users/jchambers/events{/privacy}","received_events_url":"https://api.github.com/users/jchambers/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/210","html_url":"https://github.com/netty/netty/milestone/210","labels_url":"https://api.github.com/repos/netty/netty/milestones/210/labels","id":4274617,"node_id":"MDk6TWlsZXN0b25lNDI3NDYxNw==","number":210,"title":"4.1.37.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":102,"state":"closed","created_at":"2019-04-30T16:35:51Z","updated_at":"2019-06-28T09:58:22Z","due_on":null,"closed_at":"2019-06-28T09:58:22Z"},"comments":2,"created_at":"2019-06-01T20:09:51Z","updated_at":"2019-06-04T12:14:41Z","closed_at":"2019-06-04T12:13:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In Netty 4.1.36 (and several versions prior), we've found that UDP ports can \"leak\" when using multiple `RoundRobinDnsAddressResolverGroup` instances. Please let me begin by acknowledging that I may be missing something important about how `RoundRobinDnsAddressResolverGroup` is _supposed_ to be used, but I _think_ this might be a bug.\r\n\r\n### Expected behavior\r\n\r\nWhen calling `RoundRobinDnsAddressResolverGroup#close()`, any persistent resources (UDP ports, in this case) opened by the resolver group should be closed/released.\r\n\r\n### Actual behavior\r\n\r\nSome UDP ports may remain open after calling `RoundRobinDnsAddressResolverGroup#close()`.\r\n\r\n### Steps to reproduce\r\n\r\nIn a loop, create a new `RoundRobinDnsAddressResolverGroup` and use it to resolve an address. Close the resolver group at the end of each iteration. While running, observe the number of open UDP ports over time (I used `netstat -ap udp | wc -l` under macOS).\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\n```java\r\nfinal NioEventLoopGroup eventLoopGroup = new NioEventLoopGroup(1);\r\n\r\ntry {\r\n    while (true) {\r\n        final RoundRobinDnsAddressResolverGroup resolverGroup =\r\n                new RoundRobinDnsAddressResolverGroup(NioDatagramChannel.class,\r\n                        DefaultDnsServerAddressStreamProvider.INSTANCE);\r\n\r\n        // UDP ports don't get opened unless we actually try to do something with\r\n        // the resolver; in the real use case, this happens by way of\r\n        // bootstrap.connect(), but I've opted to use this as a more concise example.\r\n        // I definitely recognize the possibility that there may be nuanced\r\n        // differences between the real use case and this minimal example, but hope\r\n        // it gets the point across.\r\n        resolverGroup.getResolver(eventLoopGroup.next()).resolve(\r\n                InetSocketAddress.createUnresolved(\"example.com\", 80)).get();\r\n\r\n        // In a vacuum, I would expect any ports opened by the resolver to be closed\r\n        // by this statement, but they appear to remain open even after the resolver\r\n        // group is closed.\r\n        resolverGroup.close();\r\n\r\n        Thread.sleep(1000);\r\n    }\r\n} finally {\r\n    eventLoopGroup.shutdownGracefully().await();\r\n}\r\n```\r\n\r\n### Netty version\r\n\r\n4.1.36 (going back to at least 4.1.32, and probably earlier than that)\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\n```\r\n$ java -version\r\nopenjdk version \"11.0.1\" 2018-10-16\r\nOpenJDK Runtime Environment 18.9 (build 11.0.1+13)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11.0.1+13, mixed mode)\r\n```\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\n```\r\n$ uname -a\r\nDarwin laminar.local 18.6.0 Darwin Kernel Version 18.6.0: Thu Apr 25 23:16:27 PDT 2019; root:xnu-4903.261.4~2/RELEASE_X86_64 x86_64\r\n```","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/9212/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/9212/timeline","performed_via_github_app":null,"state_reason":"completed"}