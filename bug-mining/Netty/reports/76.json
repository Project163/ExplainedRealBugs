{"url":"https://api.github.com/repos/netty/netty/issues/8846","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/8846/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/8846/comments","events_url":"https://api.github.com/repos/netty/netty/issues/8846/events","html_url":"https://github.com/netty/netty/issues/8846","id":407138959,"node_id":"MDU6SXNzdWU0MDcxMzg5NTk=","number":8846,"title":"When more than one connection header is present in h2c upgrade request, upgrade fails","user":{"login":"arukshani","id":12377918,"node_id":"MDQ6VXNlcjEyMzc3OTE4","avatar_url":"https://avatars.githubusercontent.com/u/12377918?v=4","gravatar_id":"","url":"https://api.github.com/users/arukshani","html_url":"https://github.com/arukshani","followers_url":"https://api.github.com/users/arukshani/followers","following_url":"https://api.github.com/users/arukshani/following{/other_user}","gists_url":"https://api.github.com/users/arukshani/gists{/gist_id}","starred_url":"https://api.github.com/users/arukshani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arukshani/subscriptions","organizations_url":"https://api.github.com/users/arukshani/orgs","repos_url":"https://api.github.com/users/arukshani/repos","events_url":"https://api.github.com/users/arukshani/events{/privacy}","received_events_url":"https://api.github.com/users/arukshani/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-02-06T09:10:46Z","updated_at":"2019-02-12T16:05:30Z","closed_at":"2019-02-12T16:05:30Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n$subject occurs, with this change https://github.com/netty/netty/pull/7824. (@bryce-anderson and @normanmaurer )\r\n\r\nNow that more than one connection header is allowed with this https://github.com/netty/netty/pull/7824,\r\n line https://github.com/netty/netty/blob/737519314153f9146eaf532cd4e945a621cf3fa5/codec-http/src/main/java/io/netty/handler/codec/http/HttpServerUpgradeHandler.java#L295 returns false and the upgrade fails since the connection header value returned from this is not the upgrade but some other connection header value. \r\n\r\nIf we are allowing multiple connection headers, then in HttpServerUpgradeHandler I think we need to check  whether any of the connection header value is upgrade and then remove other connection headers. https://tools.ietf.org/html/rfc7540#section-8.1.2.2\r\n\r\n### Steps to reproduce\r\nSend an upgrade request with multiple conection headers to HTTP/2 server and the request hangs.\r\n\r\nExample request:\r\nGET / HTTP/1.1\r\nHost: localhost:9000\r\nconnection: keep-alive\r\nforwarded: by=127.0.0.1\r\ncontent-length: 0\r\nupgrade: h2c\r\nHTTP2-Settings: AAEAABAAAAIAAAABAAN_____AAQAAP__AAUAAEAAAAYAACAA\r\nconnection: HTTP2-Settings,upgrade\r\n\r\n### Netty version\r\nFrom 4.1.33.Final (This issue  started to occur from From 4.1.23.Final onwards)\r\n\r\n\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/8846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/8846/timeline","performed_via_github_app":null,"state_reason":"completed"}