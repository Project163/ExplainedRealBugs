{"url":"https://api.github.com/repos/netty/netty/issues/7280","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7280/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7280/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7280/events","html_url":"https://github.com/netty/netty/issues/7280","id":263240957,"node_id":"MDU6SXNzdWUyNjMyNDA5NTc=","number":7280,"title":"throwing exception on h2c upgrade","user":{"login":"mosesn","id":156562,"node_id":"MDQ6VXNlcjE1NjU2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/156562?v=4","gravatar_id":"","url":"https://api.github.com/users/mosesn","html_url":"https://github.com/mosesn","followers_url":"https://api.github.com/users/mosesn/followers","following_url":"https://api.github.com/users/mosesn/following{/other_user}","gists_url":"https://api.github.com/users/mosesn/gists{/gist_id}","starred_url":"https://api.github.com/users/mosesn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mosesn/subscriptions","organizations_url":"https://api.github.com/users/mosesn/orgs","repos_url":"https://api.github.com/users/mosesn/repos","events_url":"https://api.github.com/users/mosesn/events{/privacy}","received_events_url":"https://api.github.com/users/mosesn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2017-10-05T19:35:38Z","updated_at":"2017-12-08T00:46:17Z","closed_at":"2017-12-08T00:46:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I occasionally see a failure when I'm doing an h2c upgrade, although not very frequently.\r\n\r\nThe exception looks like:\r\n\r\n```\r\nWAR [20171004-22:30:36.811] twitter: Unhandled exception in connection with /10.70.113.107:40092, shutting down connection\r\nWAR [20171004-22:30:36.811] twitter: io.netty.handler.codec.http2.Http2Exception: Attempting to return too many bytes for stream 0\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2Exception.connectionError(Http2Exception.java:85)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2Exception.streamError(Http2Exception.java:128)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.DefaultHttp2LocalFlowController$DefaultState.returnProcessedBytes(DefaultHttp2LocalFlowController.java\\\r\n:432)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.DefaultHttp2LocalFlowController$DefaultState.consumeBytes(DefaultHttp2LocalFlowController.java:441)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.DefaultHttp2LocalFlowController.consumeBytes(DefaultHttp2LocalFlowController.java:190)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2FrameCodec.consumeBytes(Http2FrameCodec.java:315)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2MultiplexCodec.onBytesConsumed(Http2MultiplexCodec.java:384)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2MultiplexCodec$DefaultHttp2StreamChannel$Http2ChannelUnsafe.doRead0(Http2MultiplexCodec.java:947)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2MultiplexCodec$DefaultHttp2StreamChannel.fireChildRead(Http2MultiplexCodec.java:734)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2MultiplexCodec.onHttp2StreamFrame(Http2MultiplexCodec.java:286)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2MultiplexCodec.onHttp2Frame(Http2MultiplexCodec.java:221)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2FrameCodec$FrameListener.onDataRead(Http2FrameCodec.java:527)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.InboundHttpToHttp2Adapter.handle(InboundHttpToHttp2Adapter.java:67)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http2.Http2FrameCodec.userEventTriggered(Http2FrameCodec.java:250)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:329)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.channel.AbstractChannelHandlerContext.invokeUserEventTriggered(AbstractChannelHandlerContext.java:315)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.channel.AbstractChannelHandlerContext.fireUserEventTriggered(AbstractChannelHandlerContext.java:307)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http.HttpServerUpgradeHandler$1.operationComplete(HttpServerUpgradeHandler.java:329)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http.HttpServerUpgradeHandler$1.operationComplete(HttpServerUpgradeHandler.java:318)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:507)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:481)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:420)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.util.concurrent.DefaultPromise.addListener(DefaultPromise.java:163)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.channel.DefaultChannelPromise.addListener(DefaultChannelPromise.java:93)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.channel.DefaultChannelPromise.addListener(DefaultChannelPromise.java:28)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http.HttpServerUpgradeHandler.upgrade(HttpServerUpgradeHandler.java:318)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http.HttpServerUpgradeHandler.decode(HttpServerUpgradeHandler.java:239)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.http.HttpServerUpgradeHandler.decode(HttpServerUpgradeHandler.java:40)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:88)\r\nWAR [20171004-22:30:36.811] twitter:     at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n```\r\n\r\nAnd it comes from [here](https://github.com/netty/netty/blob/4.1/codec-http2/src/main/java/io/netty/handler/codec/http2/DefaultHttp2LocalFlowController.java?utf8=%E2%9C%93#L432-L433):\r\n\r\n```\r\n        private void returnProcessedBytes(int delta) throws Http2Exception {\r\n            if (processedWindow - delta < window) {\r\n                throw streamError(stream.id(), INTERNAL_ERROR,\r\n                        \"Attempting to return too many bytes for stream %d\", stream.id());\r\n            }\r\n            processedWindow -= delta;\r\n        }\r\n```\r\n\r\nAny idea what's going on here?  Is the issue that the client isn't respecting flow control?","closed_by":{"login":"Scottmitch","id":7562868,"node_id":"MDQ6VXNlcjc1NjI4Njg=","avatar_url":"https://avatars.githubusercontent.com/u/7562868?v=4","gravatar_id":"","url":"https://api.github.com/users/Scottmitch","html_url":"https://github.com/Scottmitch","followers_url":"https://api.github.com/users/Scottmitch/followers","following_url":"https://api.github.com/users/Scottmitch/following{/other_user}","gists_url":"https://api.github.com/users/Scottmitch/gists{/gist_id}","starred_url":"https://api.github.com/users/Scottmitch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Scottmitch/subscriptions","organizations_url":"https://api.github.com/users/Scottmitch/orgs","repos_url":"https://api.github.com/users/Scottmitch/repos","events_url":"https://api.github.com/users/Scottmitch/events{/privacy}","received_events_url":"https://api.github.com/users/Scottmitch/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7280/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7280/timeline","performed_via_github_app":null,"state_reason":"completed"}