{"url":"https://api.github.com/repos/netty/netty/issues/12708","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/12708/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/12708/comments","events_url":"https://api.github.com/repos/netty/netty/issues/12708/events","html_url":"https://github.com/netty/netty/issues/12708","id":1341674403,"node_id":"I_kwDOABA-c85P-FOj","number":12708,"title":"HttpObjectEncoder scalability issue due to instanceof checks","user":{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185729,"node_id":"MDU6TGFiZWwxODU3Mjk=","url":"https://api.github.com/repos/netty/netty/labels/improvement","name":"improvement","color":"0052cc","default":false,"description":null},{"id":1780053712,"node_id":"MDU6TGFiZWwxNzgwMDUzNzEy","url":"https://api.github.com/repos/netty/netty/labels/benchmark","name":"benchmark","color":"661c8c","default":false,"description":"Affect the JMH benchmarks"},{"id":3845487934,"node_id":"LA_kwDOABA-c87lNX0-","url":"https://api.github.com/repos/netty/netty/labels/important","name":"important","color":"f9d0c4","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2022-08-17T12:16:00Z","updated_at":"2022-08-25T14:29:57Z","closed_at":"2022-08-25T14:29:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Due to https://bugs.openjdk.org/browse/JDK-8180450 the chain of instanceof checks on `HttpObjectEncoder` competes to update `Klass::secondary_super_cache field` causing a scalability issue (very relevant with many cores and NUMA topologies).\r\n\r\nDetection of such issue isn't easy for 3 reasons:\r\n1. performance hit won't happen in any Java code (ie no BCI - byte code index)\r\n2. updates on `Klass::secondary_super_cache field` cause false sharing over other fields sitting on the same cache line used to perform other parts of the `instanceof` logic ([Klass::secondary_supers](https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/klass.hpp#L135)'s length read to perform [MacroAssembler::check_klass_subtype_slow_path](https://github.com/openjdk/jdk11/blob/37115c8ea4aff13a8148ee2b8832b20888a5d880/src/hotspot/cpu/x86/macroAssembler_x86.cpp#L5502)) causing other instructions to receive a performance penalty while not directly causing the issue itself\r\n3. benchmarks (and micro-benchmarks) tends to use just a single http msg type making the JIT able to NOT perform any `instanceof`, but placing an uncommon trap to guard against new types used (ie by making the issue to not happen)\r\n\r\nThe 1. and 2. makes profilers very confused (see http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html) if other Java methods are inlined near (forward/backward - the direction depends by the profiler, really) the guilty emitted JIT checks, getting all the blame. Only assembly analysis using tools like https://builds.shipilev.net/perfasm/ and perf c2c makes evident which instructions to blame.\r\nThe last reason means that validation benchmarks should consider polluting the JIT profiling data at the `instanceof` call-sites (see https://wiki.openjdk.org/display/HotSpot/MethodData) in order to have a synthetic way to provoke/detect it.\r\n\r\nSadly Netty 4.1 cannot rewrite the existing http types (that are public) in order to NOT use the type information to perform state changes on the encoder, but Netty 5 can consider a different approach to solve this performance issue.\r\n\r\nIn an ideal world where there's a single implementor for each interface type (implementing just one too), the issue shouldn't happen.\r\n\r\nTo better understand (one flavour of) this issue, an example below.\r\nLet's consider `DefaultFullHttpRequest`; it implements `FullHttpRequest ` and (transitively) `ReferenceCounted` too.\r\nIn a code like this:\r\n```java\r\n    void write(Object o) {\r\n        try {\r\n            if (o instanceof FullHttpMessage) {\r\n                foo(o);\r\n            }\r\n            // ... other logic\r\n        } finally {\r\n            if (o instanceof ReferenceCounted) { \r\n                ((ReferenceCounted) o).release();\r\n            }\r\n       } \r\n    }\r\n```\r\nif the both instanceof check observes more then 1 concrete types eg `DefaultFullHttpRequest` and `DefaultHttpRequest`\r\nthen the checks will make use of the mechanism explained in https://bugs.openjdk.org/browse/JDK-8180450.\r\n\r\nFor example, if a single thread `write(o)` and  `o` is a `DefaultFullHttpRequest`, the checks invalidate the mentioned `DefaultFullHttpRequest` Klass field (first check set it to `FullHttpMessage`, second to `ReferenceCounted`), that's just inefficient; but if many threads will do it, they would compete vs the same Klass field, invalidating each others and causing false sharing for surrounding Klass fields eg length of the Klass array used to perform the slow path check.\r\n\r\nIn the existing code base this is the simplest form of `Klass::secondary_super_cache field` invalidation, but the logic of the encoder can make that happen too.","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/12708/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/12708/timeline","performed_via_github_app":null,"state_reason":"completed"}