{"url":"https://api.github.com/repos/netty/netty/issues/15449","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/15449/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/15449/comments","events_url":"https://api.github.com/repos/netty/netty/issues/15449/events","html_url":"https://github.com/netty/netty/issues/15449","id":3209599277,"node_id":"I_kwDOABA-c86_Tpkt","number":15449,"title":"FastThreadLocal's check with virtual threads improvement","user":{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185729,"node_id":"MDU6TGFiZWwxODU3Mjk=","url":"https://api.github.com/repos/netty/netty/labels/improvement","name":"improvement","color":"0052cc","default":false,"description":null},{"id":4341678528,"node_id":"LA_kwDOABA-c88AAAABAsjBwA","url":"https://api.github.com/repos/netty/netty/labels/loom","name":"loom","color":"F400B8","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2025-07-07T16:21:40Z","updated_at":"2025-08-08T21:58:21Z","closed_at":"2025-08-08T21:58:21Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"https://github.com/netty/netty/pull/15222 has introduced a way to enable virtual threads (which cannot extends FastThreadLocal) to use many `FastThredLocalThread` optimizations e.g. adaptive unshared magazines, FastThreadLocal::get, etc etc.\n\nThis has introduced a binary search vs the thread's id to verify a thread belong to the known set of registered fast thread local threads.\nSince loom enable to create many virtual threads which are not fast thread local thread and we can still have a some which are event loops (see https://micronaut.io/2025/06/30/transitioning-to-virtual-threads-using-the-micronaut-loom-carrier/ and https://github.com/franz1981/Netty-VirtualThread-Scheduler) we would like a O(1) way to detect if a virtual thread doesn't belong to this set (ideally, but we need to measure it - which can be tricky!): in https://github.com/franz1981/netty/tree/4.2_not_fasttl_bench I've implemented a microbench which doesn't stress the branch predictor but still stress the log2(event loops) comparisons for such (negative) test.\n\nI was thinking we could implement such in this way (used in https://github.com/openjdk/jdk/pull/18309):\n- create an array of (fast thread local) Thread's id ordered based on their hashing value \n- store in a long (8 bytes) a bit for each id in the array (`hash(id) % 64`-th bit position)\n- checking for id presence check first the (hash(id) % 64)-th bit: if there's none, it returns immediately\n- if the bit is set, count the previous other bits (it's a single ASM instruction) to know the position where to start with searching in the array of ids \n- etc etc\n\nThis should grant that for decently distributed thread ids and a cheap enough hashing we can have O(1)-ish for both; with slow-path w for loops search (starting from the computed position). Differently from Open addressing with linear probing we cannot just stop searching till the first \"empty\" is found - since the `long` id \"bloom filter\"(ish, again :P ) doesn't allow it (the order of bit set is there to allow the array of ids to be compressed - there are no `empty` slots, like for hash maps). \n\nwdyt?","closed_by":{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/15449/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/15449/timeline","performed_via_github_app":null,"state_reason":"completed"}