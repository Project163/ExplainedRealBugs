{"url":"https://api.github.com/repos/netty/netty/issues/10797","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/10797/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/10797/comments","events_url":"https://api.github.com/repos/netty/netty/issues/10797/events","html_url":"https://github.com/netty/netty/issues/10797","id":742834891,"node_id":"MDU6SXNzdWU3NDI4MzQ4OTE=","number":10797,"title":"Netty on GraalVM with substitutions not fully working as expected","user":{"login":"ArjanSchouten","id":5930718,"node_id":"MDQ6VXNlcjU5MzA3MTg=","avatar_url":"https://avatars.githubusercontent.com/u/5930718?v=4","gravatar_id":"","url":"https://api.github.com/users/ArjanSchouten","html_url":"https://github.com/ArjanSchouten","followers_url":"https://api.github.com/users/ArjanSchouten/followers","following_url":"https://api.github.com/users/ArjanSchouten/following{/other_user}","gists_url":"https://api.github.com/users/ArjanSchouten/gists{/gist_id}","starred_url":"https://api.github.com/users/ArjanSchouten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ArjanSchouten/subscriptions","organizations_url":"https://api.github.com/users/ArjanSchouten/orgs","repos_url":"https://api.github.com/users/ArjanSchouten/repos","events_url":"https://api.github.com/users/ArjanSchouten/events{/privacy}","received_events_url":"https://api.github.com/users/ArjanSchouten/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/230","html_url":"https://github.com/netty/netty/milestone/230","labels_url":"https://api.github.com/repos/netty/netty/milestones/230/labels","id":6093653,"node_id":"MDk6TWlsZXN0b25lNjA5MzY1Mw==","number":230,"title":"4.1.55.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":29,"state":"closed","created_at":"2020-11-11T09:34:51Z","updated_at":"2020-12-16T15:06:36Z","due_on":null,"closed_at":"2020-12-08T14:40:16Z"},"comments":9,"created_at":"2020-11-13T22:48:56Z","updated_at":"2020-12-07T17:22:40Z","closed_at":"2020-11-24T19:18:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\nThe `NetUtilSubstitutions` implement a set InetAddress, Inet4Address and Inet6Address dummy implementation.\r\n\r\n### Actual behavior\r\nSee logging with exceptions below. I expect no exceptions related to netty.\r\n\r\n### Steps to reproduce\r\nHave a running docker engine since it uses the buildpacks from spring.\r\n```\r\ngit clone git@github.com:ArjanSchouten/spring-native-netty-reproduce.git\r\ncd spring-native-netty-reproduce\r\n./gradlew bootBuildImage\r\n```\r\n### Minimal yet complete reproducer code (or URL to code)\r\nSee steps to reproduce.\r\n\r\n### Netty version\r\n4.1.54.Final\r\n\r\n### JVM version (e.g. `java -version`)\r\n11.0\r\n\r\n### OS version (e.g. `uname -a`)\r\nDarwin computername 19.6.0 Darwin Kernel Version 19.6.0: Mon Aug 31 22:12:52 PDT 2020; root:xnu-6153.141.2~1/RELEASE_X86_64 x86_64\r\n\r\nIn PR https://github.com/netty/netty/pull/10630 the NetUtilSubstitutions where added. I try to use Netty with https://github.com/spring-projects-experimental/spring-graalvm-native and it fails with:\r\n```\r\n[creator]     22:25:44.836 [ForkJoinPool-2-worker-15] DEBUG io.netty.buffer.AdvancedLeakAwareByteBuf - -Dio.netty.leakDetection.acquireAndReleaseOnly: false\r\n    [creator]     Warning: class initialization of class io.netty.util.internal.logging.Log4JLogger failed with exception java.lang.NoClassDefFoundError: org/apache/log4j/Priority. This class will be initialized at run time because option --allow-incomplete-classpath is used for image building. Use the option --initialize-at-run-time=io.netty.util.internal.logging.Log4JLogger to explicitly request delayed initialization of this class.\r\n    [creator]     22:25:49.486 [ForkJoinPool-2-worker-3] DEBUG io.netty.channel.nio.NioEventLoop - -Dio.netty.noKeySetOptimization: false\r\n    [creator]     22:25:49.486 [ForkJoinPool-2-worker-3] DEBUG io.netty.channel.nio.NioEventLoop - -Dio.netty.selectorAutoRebuildThreshold: 512\r\n    [creator]     22:25:49.605 [ForkJoinPool-2-worker-7] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.maxCapacityPerThread: 4096\r\n    [creator]     22:25:49.606 [ForkJoinPool-2-worker-7] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.maxSharedCapacityFactor: 2\r\n    [creator]     22:25:49.606 [ForkJoinPool-2-worker-7] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.linkCapacity: 16\r\n    [creator]     22:25:49.606 [ForkJoinPool-2-worker-7] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.ratio: 8\r\n    [creator]     22:25:49.607 [ForkJoinPool-2-worker-7] DEBUG io.netty.util.Recycler - -Dio.netty.recycler.delayedQueue.ratio: 8\r\n    [creator]     22:25:54.431 [ForkJoinPool-2-worker-11] DEBUG io.netty.handler.codec.compression.ZlibCodecFactory - -Dio.netty.noJdkZlibDecoder: false\r\n    [creator]     22:25:54.432 [ForkJoinPool-2-worker-11] DEBUG io.netty.handler.codec.compression.ZlibCodecFactory - -Dio.netty.noJdkZlibEncoder: false\r\n    [creator]     22:25:55.835 [ForkJoinPool-2-worker-9] DEBUG io.netty.handler.ssl.OpenSsl - netty-tcnative not in the classpath; OpenSslEngine will be unavailable.\r\n    [creator]     22:25:57.117 [ForkJoinPool-2-worker-7] DEBUG io.netty.channel.MultithreadEventLoopGroup - -Dio.netty.eventLoopThreads: 16\r\n    [creator]     22:25:58.173 [ForkJoinPool-2-worker-15] DEBUG io.netty.util.internal.PlatformDependent - org.jctools-core.MpscChunkedArrayQueue: available\r\n    [creator]     [/layers/paketo-buildpacks_spring-boot-native-image/native-image/com.example.springnative.Application:169]     analysis:  42,689.86 ms,  2.63 GB\r\n    [creator]     Fatal error:com.oracle.graal.pointsto.util.AnalysisError$ParsingError: Error encountered while parsing io.netty.util.NetUtil.<clinit>()\r\n    [creator]     Parsing context: <no parsing context available>\r\n    [creator]\r\n    [creator]           at com.oracle.graal.pointsto.util.AnalysisError.parsingError(AnalysisError.java:138)\r\n    [creator]           at com.oracle.graal.pointsto.flow.MethodTypeFlow.doParse(MethodTypeFlow.java:327)\r\n    [creator]           at com.oracle.graal.pointsto.flow.MethodTypeFlow.ensureParsed(MethodTypeFlow.java:302)\r\n    [creator]           at com.oracle.graal.pointsto.flow.MethodTypeFlow.addContext(MethodTypeFlow.java:103)\r\n    [creator]           at com.oracle.graal.pointsto.BigBang$1.run(BigBang.java:428)\r\n    [creator]           at com.oracle.graal.pointsto.util.CompletionExecutor.lambda$execute$0(CompletionExecutor.java:173)\r\n    [creator]           at java.base/java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(ForkJoinTask.java:1426)\r\n    [creator]           at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)\r\n    [creator]           at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)\r\n    [creator]           at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)\r\n    [creator]           at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)\r\n    [creator]           at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)\r\n    [creator]     Caused by: org.graalvm.compiler.java.BytecodeParser$BytecodeParserError: com.oracle.svm.core.util.VMError$HostedError: Error in @InjectAccessors handling of field io.netty.util.NetUtil.LOCALHOST4, accessors class io.netty.util.NetUtilSubstitutions$NetUtilLocalhost4Accessor: found no method named set or setLOCALHOST4\r\n    [creator]           at parsing io.netty.util.NetUtil.<clinit>(NetUtil.java:139)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.throwParserError(BytecodeParser.java:2580)\r\n    [creator]           at com.oracle.svm.hosted.phases.SharedGraphBuilderPhase$SharedBytecodeParser.throwParserError(SharedGraphBuilderPhase.java:100)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.iterateBytecodesForBlock(BytecodeParser.java:3418)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.processBlock(BytecodeParser.java:3220)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.build(BytecodeParser.java:1090)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.buildRootMethod(BytecodeParser.java:984)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.GraphBuilderPhase$Instance.run(GraphBuilderPhase.java:84)\r\n    [creator]           at com.oracle.svm.hosted.phases.SharedGraphBuilderPhase.run(SharedGraphBuilderPhase.java:74)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.phases.Phase.run(Phase.java:49)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.phases.BasePhase.apply(BasePhase.java:214)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.phases.Phase.apply(Phase.java:42)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.phases.Phase.apply(Phase.java:38)\r\n    [creator]           at com.oracle.graal.pointsto.flow.MethodTypeFlowBuilder.parse(MethodTypeFlowBuilder.java:223)\r\n    [creator]           at com.oracle.graal.pointsto.flow.MethodTypeFlowBuilder.apply(MethodTypeFlowBuilder.java:357)\r\n    [creator]           at com.oracle.graal.pointsto.flow.MethodTypeFlow.doParse(MethodTypeFlow.java:313)\r\n    [creator]           ... 10 more\r\n    [creator]     Caused by: com.oracle.svm.core.util.VMError$HostedError: Error in @InjectAccessors handling of field io.netty.util.NetUtil.LOCALHOST4, accessors class io.netty.util.NetUtilSubstitutions$NetUtilLocalhost4Accessor: found no method named set or setLOCALHOST4\r\n    [creator]           at com.oracle.svm.core.util.VMError.shouldNotReachHere(VMError.java:68)\r\n    [creator]           at com.oracle.svm.hosted.phases.InjectedAccessorsPlugin.error(InjectedAccessorsPlugin.java:152)\r\n    [creator]           at com.oracle.svm.hosted.phases.InjectedAccessorsPlugin.handleField(InjectedAccessorsPlugin.java:89)\r\n    [creator]           at com.oracle.svm.hosted.phases.InjectedAccessorsPlugin.handleStoreStaticField(InjectedAccessorsPlugin.java:62)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.genPutStatic(BytecodeParser.java:4970)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.genPutStatic(BytecodeParser.java:4941)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.processBytecode(BytecodeParser.java:5335)\r\n    [creator]           at jdk.internal.vm.compiler/org.graalvm.compiler.java.BytecodeParser.iterateBytecodesForBlock(BytecodeParser.java:3413)\r\n    [creator]           ... 22 more\r\n    [creator]     Error: Image build request failed with exit status 1\r\n```\r\n\r\nI tried to add a substitute myself but it looks like there can only be one substitute. It looks like the author of the stackoverflow answer posted the PR: https://stackoverflow.com/questions/63328298/how-do-you-debug-a-no-instances-of-are-allowed-in-the-image-heap-when-buil (which is great!!)\r\n\r\nI think that a set implementation like the stackoverflow answer from @rpuch like in part 4 of the answer will solve my issue?! @rpuch can you validate that my assumption is correct?\r\n\r\n_edit: according to the documentation: https://javadoc.io/doc/org.graalvm.nativeimage/svm/latest/com/oracle/svm/core/annotate/InjectAccessors.html_\r\n\r\n> Inject accessors methods for the field denoted using a Alias annotation. All loads and stores to the original field are redirected to accessor methods located in the class provided in the InjectAccessors.value() property. The class must implement the marker interface InjectAccessors. The accessor methods are static methods in that class, named either get / set or getFoo / setFoo for a field name foo. Depending on the kind of accessor (get / set for a static / non-static field), the accessor must have 0, 1, or 2 parameters. If the field is non-static, the first method parameter is the accessed object. The type of the parameter must be the class that declared the field. The null check on the object is performed before the accessor is called, in the same way as the null check for a regular field access. For get-accessors, the return type of the method must be the type of the field. For set-accessors, the last method parameter must be the type of the field and denotes the value stored to the field. **If no set-accessor is provided, stores to the field lead to a fatal error during image generation**. If no get-accessor is provided, loads of the field lead to a fatal error during image generation. The injected accessors must not access the original field. Since all field accesses use the accessors, that would lead to a recursive call of the accessors. Instead, data must be stored in either a new static field, or an injected instance field.\r\n\r\nAccording to the documentation, is the setLOCALHOST4 accessed illegally or do we have to implement the static set method as an empty method?\r\n\r\n(I believe this will be a blocker for https://github.com/spring-projects-experimental/spring-graalvm-native/issues/184 as well)","closed_by":{"login":"ArjanSchouten","id":5930718,"node_id":"MDQ6VXNlcjU5MzA3MTg=","avatar_url":"https://avatars.githubusercontent.com/u/5930718?v=4","gravatar_id":"","url":"https://api.github.com/users/ArjanSchouten","html_url":"https://github.com/ArjanSchouten","followers_url":"https://api.github.com/users/ArjanSchouten/followers","following_url":"https://api.github.com/users/ArjanSchouten/following{/other_user}","gists_url":"https://api.github.com/users/ArjanSchouten/gists{/gist_id}","starred_url":"https://api.github.com/users/ArjanSchouten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ArjanSchouten/subscriptions","organizations_url":"https://api.github.com/users/ArjanSchouten/orgs","repos_url":"https://api.github.com/users/ArjanSchouten/repos","events_url":"https://api.github.com/users/ArjanSchouten/events{/privacy}","received_events_url":"https://api.github.com/users/ArjanSchouten/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/10797/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/10797/timeline","performed_via_github_app":null,"state_reason":"completed"}