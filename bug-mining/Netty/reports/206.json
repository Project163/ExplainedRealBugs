{"url":"https://api.github.com/repos/netty/netty/issues/11568","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/11568/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/11568/comments","events_url":"https://api.github.com/repos/netty/netty/issues/11568/events","html_url":"https://github.com/netty/netty/issues/11568","id":966087082,"node_id":"MDU6SXNzdWU5NjYwODcwODI=","number":11568,"title":"HttpServerUpgradeHandler causing StringIndexOutOfBoundsException","user":{"login":"dpy1123","id":3691507,"node_id":"MDQ6VXNlcjM2OTE1MDc=","avatar_url":"https://avatars.githubusercontent.com/u/3691507?v=4","gravatar_id":"","url":"https://api.github.com/users/dpy1123","html_url":"https://github.com/dpy1123","followers_url":"https://api.github.com/users/dpy1123/followers","following_url":"https://api.github.com/users/dpy1123/following{/other_user}","gists_url":"https://api.github.com/users/dpy1123/gists{/gist_id}","starred_url":"https://api.github.com/users/dpy1123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dpy1123/subscriptions","organizations_url":"https://api.github.com/users/dpy1123/orgs","repos_url":"https://api.github.com/users/dpy1123/repos","events_url":"https://api.github.com/users/dpy1123/events{/privacy}","received_events_url":"https://api.github.com/users/dpy1123/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-08-11T07:01:18Z","updated_at":"2021-08-14T04:43:27Z","closed_at":"2021-08-12T16:04:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We are using netty as a proxy server. And added HttpServerUpgradeHandler incase client wants to talk in h2c.\r\nBut with a normal http1 request, we see the following exceptions.\r\n\r\n```io.netty.handler.codec.DecoderException: java.lang.StringIndexOutOfBoundsException: String index out of range: -1\r\n\tat io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:98)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelRead(CombinedChannelDuplexHandler.java:436)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:324)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:296)\r\n\tat io.netty.channel.CombinedChannelDuplexHandler.channelRead(CombinedChannelDuplexHandler.java:251)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\r\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:714)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:650)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:576)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: java.lang.StringIndexOutOfBoundsException: String index out of range: -1\r\n\tat java.base/java.lang.AbstractStringBuilder.setLength(AbstractStringBuilder.java:275)\r\n\tat java.base/java.lang.StringBuilder.setLength(StringBuilder.java:85)\r\n\tat io.netty.handler.codec.http.HttpServerUpgradeHandler.upgrade(HttpServerUpgradeHandler.java:297)\r\n\tat io.netty.handler.codec.http.HttpServerUpgradeHandler.decode(HttpServerUpgradeHandler.java:239)\r\n\tat io.netty.handler.codec.http.HttpServerUpgradeHandler.decode(HttpServerUpgradeHandler.java:40)\r\n\tat io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:88)\r\n\t... 22 more\r\n```\r\n\r\n\r\n\r\nAs far as I can see, it seems like the if conditon should also add isEmpty().\r\n```        if (connectionHeaderValues == null || connectionHeaderValues.isEmpty()) {\r\n            return false;\r\n        }\r\n```\r\n\r\nhttps://github.com/netty/netty/blob/3f8dab5ad00a718dc8ad6c00e27b740783ea23c5/codec-http/src/main/java/io/netty/handler/codec/http/HttpServerUpgradeHandler.java#L326","closed_by":{"login":"NiteshKant","id":820005,"node_id":"MDQ6VXNlcjgyMDAwNQ==","avatar_url":"https://avatars.githubusercontent.com/u/820005?v=4","gravatar_id":"","url":"https://api.github.com/users/NiteshKant","html_url":"https://github.com/NiteshKant","followers_url":"https://api.github.com/users/NiteshKant/followers","following_url":"https://api.github.com/users/NiteshKant/following{/other_user}","gists_url":"https://api.github.com/users/NiteshKant/gists{/gist_id}","starred_url":"https://api.github.com/users/NiteshKant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NiteshKant/subscriptions","organizations_url":"https://api.github.com/users/NiteshKant/orgs","repos_url":"https://api.github.com/users/NiteshKant/repos","events_url":"https://api.github.com/users/NiteshKant/events{/privacy}","received_events_url":"https://api.github.com/users/NiteshKant/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/11568/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/11568/timeline","performed_via_github_app":null,"state_reason":"completed"}