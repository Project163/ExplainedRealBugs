{"url":"https://api.github.com/repos/netty/netty/issues/14368","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/14368/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/14368/comments","events_url":"https://api.github.com/repos/netty/netty/issues/14368/events","html_url":"https://github.com/netty/netty/issues/14368","id":2545837374,"node_id":"I_kwDOABA-c86XvmU-","number":14368,"title":"Tasks scheduled on EpollEventLoop are delayed in 4.1.76","user":{"login":"dsidorov","id":102506,"node_id":"MDQ6VXNlcjEwMjUwNg==","avatar_url":"https://avatars.githubusercontent.com/u/102506?v=4","gravatar_id":"","url":"https://api.github.com/users/dsidorov","html_url":"https://github.com/dsidorov","followers_url":"https://api.github.com/users/dsidorov/followers","following_url":"https://api.github.com/users/dsidorov/following{/other_user}","gists_url":"https://api.github.com/users/dsidorov/gists{/gist_id}","starred_url":"https://api.github.com/users/dsidorov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dsidorov/subscriptions","organizations_url":"https://api.github.com/users/dsidorov/orgs","repos_url":"https://api.github.com/users/dsidorov/repos","events_url":"https://api.github.com/users/dsidorov/events{/privacy}","received_events_url":"https://api.github.com/users/dsidorov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/300","html_url":"https://github.com/netty/netty/milestone/300","labels_url":"https://api.github.com/repos/netty/netty/milestones/300/labels","id":11659697,"node_id":"MI_kwDOABA-c84Asemx","number":300,"title":"4.1.115.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":25,"state":"closed","created_at":"2024-10-01T13:59:35Z","updated_at":"2024-11-12T13:41:34Z","due_on":null,"closed_at":"2024-11-12T13:41:34Z"},"comments":2,"created_at":"2024-09-24T16:19:05Z","updated_at":"2024-11-04T07:31:36Z","closed_at":"2024-11-04T07:25:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\nA task scheduled on an EpollEventLoop is expected to fire after the specified delay.\r\n\r\n### Actual behavior\r\nStarting from Netty-4.1.76, scheduled tasks may be delayed or missed in applications that are regularly interrupted by signals.\r\n\r\n### Steps to reproduce\r\nIt is hard to reproduce in isolation. I'll describe the behavior we've seen in our test environment, and will try to come up with minimal code example demonstrating the problem.\r\n\r\nOur server application is using scheduled tasks to track different types of timeouts (connection/stream idle timeouts, connection time-to-live, etc). After upgrading Netty from 4.1.68 to 4.1.111 the tests verifying server timeouts started failing because the scheduled tasks were delayed by a few seconds or never triggered. I was able to track the problem down to a change in Netty's `epollWait` behavior - when a scheduled task is submitted to an EpollEventLoop, and there are no other I/O activity on the interest list, it blocks for a longer time than specified timeout. By adding some debug diagnostics around syscall to `epoll_wait` I could see that when the syscall is interrupted by a signal, `netty_epoll_native_epollWait` would retry it with the same timeout value, effectively resetting the timeout duration.\r\n\r\nIn our case the application uses a profiler library that triggers SIGVTALRM signal every second, and in our test environment, the signal was consistently landing on the thread serving an EpollEventLoop, and interrupted `epoll_wait` calls. It goes like this:\r\n\r\n- Application schedules a task with 2 second delay\r\n- No other scheduled tasks on the event loop, so the poll deadline is `now + 2000ms`\r\n- `netty_epoll_native_epollWait` calls `epoll_wait` with timeout=2000ms in a loop:\r\n```\r\n    do {\r\n        result = epoll_wait(efd, ev, len, timeout);\r\n        if (result >= 0) {\r\n            return result;\r\n        }\r\n    } while((err = errno) == EINTR);\r\n```\r\n- One second later a SIGVTALRM signal interrupts the thread, and `epoll_wait` call fails with `EINTR` error\r\n- The call is restarted with a fresh timeout of 2000ms, resetting the wait\r\n- One second later another SIGVTALRM signal interrupts the thread, etc ...\r\n\r\nAs far as I understood, this has not been a problem with older versions of Netty because prior to [Epoll timer optimization](https://github.com/netty/netty/commit/86004b7303621784f7ec8850323d9a707f17f9f8) introduced in 4.1.76, `netty_epoll_native_epollWait0` has always armed a timer descriptor via `timerfd_settime`, and called `epoll_wait` with indefinite (-1) timeout. The timer descriptor would keep the target notification deadline, and does not need to be adjusted for interrupted and retried system calls.\r\n\r\nOne way to fix this would be to track the time spent in a failed `epoll_wait` call, and cut down the `timeout` value by that amount when retrying interrupted calls. I didn't get a chance to try it on newer Linux kernels, but I think the same applies to `epoll_pwait2` retry loop in [netty_epoll_native_epollWait0](https://github.com/netty/netty/blob/4.1/transport-native-epoll/src/main/c/netty_epoll_native.c#L283-L288)\r\n\r\nIn fact, when I disable Epoll timer optimization by setting `io.netty.channel.epoll.epollWaitThreshold` system property to `0`, it falls back to old behavior, and our tests are passing again.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\nWIP. It is hard to predict which thread will pick up a signal in a multi-threaded application (decided by kernel and implementation/version dependent). So far could only reproduce this in our test environment, where signal lands on the EpollEventLoop thread serving a connection. In a similar minimal example app, the same signal is picked up by other random threads.\r\n\r\n### Netty version\r\nThe issue originally discovered in 4.1.111, but it seems to go back to 4.1.76 when Epoll timer optimization was introduced - [86004b7](https://github.com/netty/netty/commit/86004b7303621784f7ec8850323d9a707f17f9f8)\r\n\r\n### JVM version (e.g. `java -version`)\r\n```\r\nopenjdk version \"17.0.12\" 2024-07-16 LTS\r\nOpenJDK Runtime Environment 1.0.2048.0 (build 17.0.12+8-LTS)\r\nOpenJDK 64-Bit Server VM 1.0.2048.0 (build 17.0.12+8-LTS, mixed mode, sharing)\r\n```\r\n\r\n### OS version (e.g. `uname -a`)\r\n```\r\nLinux [...].us-west-2.compute.internal 4.14.352-267.564.amzn2.aarch64 #1 SMP Tue Aug 27 09:56:36 UTC 2024 aarch64 aarch64 aarch64 GNU/Linux\r\n```","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/14368/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/14368/timeline","performed_via_github_app":null,"state_reason":"completed"}