{"url":"https://api.github.com/repos/netty/netty/issues/11984","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/11984/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/11984/comments","events_url":"https://api.github.com/repos/netty/netty/issues/11984/events","html_url":"https://github.com/netty/netty/issues/11984","id":1097290780,"node_id":"I_kwDOABA-c85BZ1Qc","number":11984,"title":"PooledByteBufAllocator.pinnedDirectMemory is sometimes returning 0 even if some direct buffers are used","user":{"login":"pderop","id":650758,"node_id":"MDQ6VXNlcjY1MDc1OA==","avatar_url":"https://avatars.githubusercontent.com/u/650758?v=4","gravatar_id":"","url":"https://api.github.com/users/pderop","html_url":"https://github.com/pderop","followers_url":"https://api.github.com/users/pderop/followers","following_url":"https://api.github.com/users/pderop/following{/other_user}","gists_url":"https://api.github.com/users/pderop/gists{/gist_id}","starred_url":"https://api.github.com/users/pderop/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pderop/subscriptions","organizations_url":"https://api.github.com/users/pderop/orgs","repos_url":"https://api.github.com/users/pderop/repos","events_url":"https://api.github.com/users/pderop/events{/privacy}","received_events_url":"https://api.github.com/users/pderop/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/248","html_url":"https://github.com/netty/netty/milestone/248","labels_url":"https://api.github.com/repos/netty/netty/milestones/248/labels","id":7481806,"node_id":"MI_kwDOABA-c84AcinO","number":248,"title":"4.1.73.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":39,"state":"closed","created_at":"2021-12-13T11:11:43Z","updated_at":"2022-02-04T13:08:03Z","due_on":null,"closed_at":"2022-01-12T10:59:35Z"},"comments":2,"created_at":"2022-01-09T20:17:28Z","updated_at":"2022-01-11T22:22:13Z","closed_at":"2022-01-11T22:22:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm trying to monitor the estimate of memory that is used by in-use direct buffers.\r\nTo do so, I'm trying to use the PooledByteBufAllocator.pinnedDirectMemory() method but sometimes, it seems that this method is returning 0 even if some buffers are currently allocated and used (not yet released).\r\n\r\n### Expected behavior\r\n\r\nPooledByteBufAllocator.pinnedDirectMemory() should not return 0 in case some buffers are currently allocated.\r\n\r\n### Actual behavior\r\n\r\nSometimes, not always, it seems that the PooledByteBufAllocator.pinnedDirectMemory() is returning 0 even if some buffers are allocated.\r\n\r\n### Steps to reproduce\r\n\r\nPlease check attached sample project: \r\n\r\n[netty.pinnedMemory.test.tar.gz](https://github.com/netty/netty/files/7835795/netty.pinnedMemory.test.tar.gz)\r\n\r\nThe Test class is allocating some buffers, and before releasing them, it displays the pinned direct memory. It also displays an estimate of used memory by traversing arena of direct buffers, and for each arena, it accumulates the diff between the  chunk size and the bytes that are not yet allocated by in-use buffers:\r\n\r\n```\r\n    static long usedMem(List<PoolArenaMetric> arenas) {\r\n        long totalUsed = 0;\r\n        for (PoolArenaMetric arenaMetrics : arenas) {\r\n            for (PoolChunkListMetric arenaMetric : arenaMetrics.chunkLists()) {\r\n                for (PoolChunkMetric chunkMetric : arenaMetric) {\r\n                    // chunkMetric.chunkSize() returns maximum of bytes that can be served out of the chunk\r\n                    // and chunkMetric.freeBytes() returns the bytes that are not yet allocated by in-use buffers\r\n                    totalUsed += (chunkMetric.chunkSize() - chunkMetric.freeBytes());\r\n                }\r\n            }\r\n        }\r\n        return totalUsed;\r\n    }\r\n```\r\nTo run the program:\r\n\r\n./gradlew jar\r\n./gradlew runTest\r\n\r\nThe program displays many logs, like this:\r\n\r\n```\r\nused=1810432, pinned=1372971008\r\nused=2097152, pinned=1373257728\r\nused=1974272, pinned=1371643904\r\n```\r\n\r\n_used_ corresponds to the result of the _usedMem_ method shown above, and _pinned_ corresponds to the result of the call to alloc.pinnedDirectMemory().\r\n\r\nNow, sometimes, you will notice that the pinned memory is zero:\r\n\r\n```\r\nused=2031616, pinned=1835008\r\nused=1892352, pinned=188416\r\nused=1916928, pinned=212992\r\nused=1892352, pinned=0\r\nused=2023424, pinned=0\r\nused=2072576, pinned=0\r\n...\r\nused=2220032, pinned=2146779136\r\nused=2310144, pinned=2146869248\r\nused=1843200, pinned=2144354304\r\nused=1974272, pinned=2144485376\r\nused=2007040, pinned=2144518144\r\nused=1998848, pinned=2143215616\r\nused=2138112, pinned=2143354880\r\n```\r\n\r\nTo stop, just press CTRL-C\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nPlease see attached sample project above\r\n\r\n### Netty version\r\n\r\n4.1.72.Final\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\nopenjdk version \"1.8.0_302\"\r\nOpenJDK Runtime Environment (Zulu 8.56.0.23-CA-macos-aarch64) (build 1.8.0_302-b08)\r\nOpenJDK 64-Bit Server VM (Zulu 8.56.0.23-CA-macos-aarch64) (build 25.302-b08, mixed mode)\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\nMacOS M1:\r\n\r\nDarwin xxx 21.1.0 Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:24 PDT 2021; root:xnu-8019.41.5~1/RELEASE_ARM64_T8101 arm64\r\n\r\nThe issue is also observed on linux Ubuntu:\r\n\r\nLinux xxx 5.13.0-22-generic #22-Ubuntu SMP Fri Nov 5 13:21:36 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\r\n","closed_by":{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/11984/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/11984/timeline","performed_via_github_app":null,"state_reason":"completed"}