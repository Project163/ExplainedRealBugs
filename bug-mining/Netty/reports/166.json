{"url":"https://api.github.com/repos/netty/netty/issues/10838","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/10838/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/10838/comments","events_url":"https://api.github.com/repos/netty/netty/issues/10838/events","html_url":"https://github.com/netty/netty/issues/10838","id":756389958,"node_id":"MDU6SXNzdWU3NTYzODk5NTg=","number":10838,"title":"Check for valid status codes should be done in CloseWebSocketFrame instead of WebSocketCloseStatus","user":{"login":"violetagg","id":696661,"node_id":"MDQ6VXNlcjY5NjY2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/696661?v=4","gravatar_id":"","url":"https://api.github.com/users/violetagg","html_url":"https://github.com/violetagg","followers_url":"https://api.github.com/users/violetagg/followers","following_url":"https://api.github.com/users/violetagg/following{/other_user}","gists_url":"https://api.github.com/users/violetagg/gists{/gist_id}","starred_url":"https://api.github.com/users/violetagg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/violetagg/subscriptions","organizations_url":"https://api.github.com/users/violetagg/orgs","repos_url":"https://api.github.com/users/violetagg/repos","events_url":"https://api.github.com/users/violetagg/events{/privacy}","received_events_url":"https://api.github.com/users/violetagg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/230","html_url":"https://github.com/netty/netty/milestone/230","labels_url":"https://api.github.com/repos/netty/netty/milestones/230/labels","id":6093653,"node_id":"MDk6TWlsZXN0b25lNjA5MzY1Mw==","number":230,"title":"4.1.55.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":29,"state":"closed","created_at":"2020-11-11T09:34:51Z","updated_at":"2020-12-16T15:06:36Z","due_on":null,"closed_at":"2020-12-08T14:40:16Z"},"comments":1,"created_at":"2020-12-03T17:15:08Z","updated_at":"2020-12-07T12:22:23Z","closed_at":"2020-12-07T12:20:09Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"According to the specification https://tools.ietf.org/html/rfc6455#section-7.4\r\n\r\n```\r\n1006 is a reserved value and MUST NOT be set as a status code in a\r\nClose control frame by an endpoint.  It is designated for use in\r\napplications expecting a status code to indicate that the\r\nconnection was closed abnormally, e.g., without sending or\r\nreceiving a Close control frame.\r\n```\r\n\r\nI want to use `WebSocketCloseStatus` in the applications in order to indicate that the\r\nconnection was closed abnormally.\r\n\r\nI do not intent to send `CloseWebSocketFrame` with such `WebSocketCloseStatus` (with 1006 status code).\r\n\r\nHowever the current implementation checks the validity of the status codes in `WebSocketCloseStatus`\r\ninstead of `CloseWebSocketFrame`.\r\n\r\nIsn't it more correct if the check for a valid status code is in `CloseWebSocketFrame`?\r\n\r\n### Expected behavior\r\nTo be able to create `WebSocketCloseStatus` with status code 1006\r\nand `CloseWebSocketFrame ` to fail when constructed with `WebSocketCloseStatus` with status code 1006\r\n\r\n### Actual behavior\r\n`WebSocketCloseStatus` fails when created with status code 1006\r\n\r\n### Proposed solution\r\n\r\nI can create a PR with the patch below\r\n\r\n```\r\ndiff --git a/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/CloseWebSocketFrame.java b/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/CloseWebSocketFrame.java\r\nindex 7231bde8f4..834d0e6eee 100644\r\n--- a/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/CloseWebSocketFrame.java\r\n+++ b/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/CloseWebSocketFrame.java\r\n@@ -40,7 +40,7 @@ public class CloseWebSocketFrame extends WebSocketFrame {\r\n      *            example, <tt>1000</tt> indicates normal closure.\r\n      */\r\n     public CloseWebSocketFrame(WebSocketCloseStatus status) {\r\n-        this(status.code(), status.reasonText());\r\n+        this(requireValidStatusCode(status), status.reasonText());\r\n     }\r\n \r\n     /**\r\n@@ -53,7 +53,7 @@ public class CloseWebSocketFrame extends WebSocketFrame {\r\n      *            Reason text. Set to null if no text.\r\n      */\r\n     public CloseWebSocketFrame(WebSocketCloseStatus status, String reasonText) {\r\n-        this(status.code(), reasonText);\r\n+        this(requireValidStatusCode(status), reasonText);\r\n     }\r\n \r\n     /**\r\n@@ -201,4 +201,13 @@ public class CloseWebSocketFrame extends WebSocketFrame {\r\n         super.touch(hint);\r\n         return this;\r\n     }\r\n+\r\n+    static int requireValidStatusCode(WebSocketCloseStatus status) {\r\n+        if (WebSocketCloseStatus.isValidStatusCode(status.code())) {\r\n+            return status.code();\r\n+        }\r\n+        else {\r\n+            throw new IllegalArgumentException(\"WebSocket close status code does NOT comply with RFC-6455: \" + status.code());\r\n+        }\r\n+    }\r\n }\r\ndiff --git a/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseStatus.java b/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseStatus.java\r\nindex 92b1dbaef5..f634240ef5 100644\r\n--- a/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseStatus.java\r\n+++ b/codec-http/src/main/java/io/netty/handler/codec/http/websocketx/WebSocketCloseStatus.java\r\n@@ -208,16 +208,26 @@ public final class WebSocketCloseStatus implements Comparable<WebSocketCloseStat\r\n \r\n     // 1004, 1005, 1006, 1015 are reserved and should never be used by user\r\n     //public static final WebSocketCloseStatus SPECIFIC_MEANING = register(1004, \"...\");\r\n-    //public static final WebSocketCloseStatus EMPTY = register(1005, \"Empty\");\r\n-    //public static final WebSocketCloseStatus ABNORMAL_CLOSURE = register(1006, \"Abnormal closure\");\r\n-    //public static final WebSocketCloseStatus TLS_HANDSHAKE_FAILED(1015, \"TLS handshake failed\");\r\n+\r\n+    public static final WebSocketCloseStatus EMPTY =\r\n+        new WebSocketCloseStatus(1005, \"Empty\");\r\n+\r\n+    public static final WebSocketCloseStatus ABNORMAL_CLOSURE =\r\n+        new WebSocketCloseStatus(1006, \"Abnormal closure\");\r\n+\r\n+    public static final WebSocketCloseStatus TLS_HANDSHAKE_FAILED =\r\n+        new WebSocketCloseStatus(1015, \"TLS handshake failed\");\r\n \r\n     private final int statusCode;\r\n     private final String reasonText;\r\n     private String text;\r\n \r\n     public WebSocketCloseStatus(int statusCode, String reasonText) {\r\n-        if (!isValidStatusCode(statusCode)) {\r\n+        this(statusCode, reasonText, true);\r\n+    }\r\n+\r\n+    public WebSocketCloseStatus(int statusCode, String reasonText, boolean validate) {\r\n+        if (validate && !isValidStatusCode(statusCode)) {\r\n             throw new IllegalArgumentException(\r\n                 \"WebSocket close status code does NOT comply with RFC-6455: \" + statusCode);\r\n         }\r\n```\r\n\r\n### Netty version\r\n4.1.55.Final-SNAPSHOT\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/10838/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/10838/timeline","performed_via_github_app":null,"state_reason":"completed"}