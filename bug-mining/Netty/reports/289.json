{"url":"https://api.github.com/repos/netty/netty/issues/13870","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/13870/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/13870/comments","events_url":"https://api.github.com/repos/netty/netty/issues/13870/events","html_url":"https://github.com/netty/netty/issues/13870","id":2151387274,"node_id":"I_kwDOABA-c86AO5CK","number":13870,"title":"DefaultHttp2HeadersEncoder corrupts unpooled memory metrics?","user":{"login":"hpple","id":5455032,"node_id":"MDQ6VXNlcjU0NTUwMzI=","avatar_url":"https://avatars.githubusercontent.com/u/5455032?v=4","gravatar_id":"","url":"https://api.github.com/users/hpple","html_url":"https://github.com/hpple","followers_url":"https://api.github.com/users/hpple/followers","following_url":"https://api.github.com/users/hpple/following{/other_user}","gists_url":"https://api.github.com/users/hpple/gists{/gist_id}","starred_url":"https://api.github.com/users/hpple/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hpple/subscriptions","organizations_url":"https://api.github.com/users/hpple/orgs","repos_url":"https://api.github.com/users/hpple/repos","events_url":"https://api.github.com/users/hpple/events{/privacy}","received_events_url":"https://api.github.com/users/hpple/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/288","html_url":"https://github.com/netty/netty/milestone/288","labels_url":"https://api.github.com/repos/netty/netty/milestones/288/labels","id":10545208,"node_id":"MI_kwDOABA-c84AoOg4","number":288,"title":"4.1.108.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":55,"state":"closed","created_at":"2024-02-12T18:03:11Z","updated_at":"2024-03-25T11:19:05Z","due_on":null,"closed_at":"2024-03-24T18:28:00Z"},"comments":0,"created_at":"2024-02-23T16:09:37Z","updated_at":"2024-02-27T22:35:02Z","closed_at":"2024-02-27T22:34:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\nHeap memory counter in `UnpooledByteBufAllocatorMetric` correlates with the actual heap consumption.\r\n\r\n### Actual behavior\r\nHeap memory counter is always growing, but there is no evidence of the genuine memory leak. \r\n\r\n### Steps to reproduce\r\n### Minimal yet complete reproducer code (or URL to code)\r\nI may craft an executable example if it is needed, but I believe this is the already known issue (sort of).\r\n\r\n### Netty version\r\n`4.1.63.Final`, but I guess it's still here\r\n\r\n### JVM version (e.g. `java -version`)\r\n`openjdk 17.0.3` (custom build, but it is irrelevant here)\r\n\r\n### OS version (e.g. `uname -a`)\r\n`Linux <redacted> 5.4.161-26.3 #1 SMP Mon Feb 7 14:47:58 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\nHi! \r\n\r\nI'm using gRPC (and as a result Netty HTTP2 implementation as well). \r\nAlso, I'm tracking the memory consumption of pooled/unpooled heap/offheap netty allocators by using built-in allocator metrics.\r\nAnd right now, I observe some peculiar behaviour: unpooled heap counter is always growing like the memory is leaking, but the actual heap consumption of JVM does not correllate with this metric.\r\n\r\nAfter some debugging I've found the only place there unpooled allocator is used in my app:\r\n```\r\nBreakpoint reached\r\n\tat io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf.allocateArray(UnpooledByteBufAllocator.java:145)\r\n\tat io.netty.buffer.UnpooledHeapByteBuf.<init>(UnpooledHeapByteBuf.java:59)\r\n\tat io.netty.buffer.UnpooledUnsafeHeapByteBuf.<init>(UnpooledUnsafeHeapByteBuf.java:34)\r\n\tat io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf.<init>(UnpooledByteBufAllocator.java:139)\r\n\tat io.netty.buffer.UnpooledByteBufAllocator.newHeapBuffer(UnpooledByteBufAllocator.java:82)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.heapBuffer(AbstractByteBufAllocator.java:168)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.heapBuffer(AbstractByteBufAllocator.java:154)\r\n\tat io.netty.buffer.Unpooled.buffer(Unpooled.java:101)\r\n\tat io.netty.handler.codec.http2.DefaultHttp2HeadersEncoder.<init>(DefaultHttp2HeadersEncoder.java:30)\r\n\tat io.netty.handler.codec.http2.DefaultHttp2HeadersEncoder.<init>(DefaultHttp2HeadersEncoder.java:37)\r\n\tat io.netty.handler.codec.http2.DefaultHttp2HeadersEncoder.<init>(DefaultHttp2HeadersEncoder.java:33)\r\n\tat io.netty.handler.codec.http2.DefaultHttp2FrameWriter.<init>(DefaultHttp2FrameWriter.java:88)\r\n\tat io.grpc.netty.NettyServerHandler.newHandler(NettyServerHandler.java:169)\r\n\tat io.grpc.netty.NettyServerTransport.createHandler(NettyServerTransport.java:263)\r\n\tat io.grpc.netty.NettyServerTransport.start(NettyServerTransport.java:131)\r\n\tat io.grpc.netty.NettyServer$1.initChannel(NettyServer.java:290)\r\n\tat io.netty.channel.ChannelInitializer.initChannel(ChannelInitializer.java:129)\r\n\tat io.netty.channel.ChannelInitializer.handlerAdded(ChannelInitializer.java:112)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.callHandlerAdded(AbstractChannelHandlerContext.java:938)\r\n\tat io.netty.channel.DefaultChannelPipeline.callHandlerAdded0(DefaultChannelPipeline.java:609)\r\n\tat io.netty.channel.DefaultChannelPipeline.access$100(DefaultChannelPipeline.java:46)\r\n\tat io.netty.channel.DefaultChannelPipeline$PendingHandlerAddedTask.execute(DefaultChannelPipeline.java:1463)\r\n\tat io.netty.channel.DefaultChannelPipeline.callHandlerAddedForAllHandlers(DefaultChannelPipeline.java:1115)\r\n\tat io.netty.channel.DefaultChannelPipeline.invokeHandlerAddedIfNeeded(DefaultChannelPipeline.java:650)\r\n\tat io.netty.channel.AbstractChannel$AbstractUnsafe.register0(AbstractChannel.java:514)\r\n\tat io.netty.channel.AbstractChannel$AbstractUnsafe.access$200(AbstractChannel.java:429)\r\n\tat io.netty.channel.AbstractChannel$AbstractUnsafe$1.run(AbstractChannel.java:486)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:164)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472)\r\n\tat io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:384)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\nHere I've spotted that the similar problem with the memory leaks is already known in HTTP2 module for v5: #12781\r\nI guess that we have the same problem in 4.x version too.\r\n\r\nThe `tableSizeChangeOutput` is allocated as unpooled buf there, so it does not lead to the actual memory leak, only corrupts the mem counter (always incremented but never decremented). \r\n\r\nI'd like to make a PR and backport the fix if you are ok with that.\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/13870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/13870/timeline","performed_via_github_app":null,"state_reason":"completed"}