{"url":"https://api.github.com/repos/netty/netty/issues/14176","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/14176/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/14176/comments","events_url":"https://api.github.com/repos/netty/netty/issues/14176/events","html_url":"https://github.com/netty/netty/issues/14176","id":2400234872,"node_id":"I_kwDOABA-c86PEK14","number":14176,"title":"Declarative JPMS support","user":{"login":"vietj","id":225674,"node_id":"MDQ6VXNlcjIyNTY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/225674?v=4","gravatar_id":"","url":"https://api.github.com/users/vietj","html_url":"https://github.com/vietj","followers_url":"https://api.github.com/users/vietj/followers","following_url":"https://api.github.com/users/vietj/following{/other_user}","gists_url":"https://api.github.com/users/vietj/gists{/gist_id}","starred_url":"https://api.github.com/users/vietj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vietj/subscriptions","organizations_url":"https://api.github.com/users/vietj/orgs","repos_url":"https://api.github.com/users/vietj/repos","events_url":"https://api.github.com/users/vietj/events{/privacy}","received_events_url":"https://api.github.com/users/vietj/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2024-07-10T09:30:45Z","updated_at":"2024-09-21T12:03:45Z","closed_at":null,"author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The current version of Netty supports automatic modules.\r\n\r\nThis should bring declarative JPMS support in the new Netty 4.2 branch with explicit modules whenever possible that provides a better JPMS support for Netty consumers and benefits to Netty with the evolution of Java runtimes.\r\n\r\n## Motivation\r\n\r\nAlthough Netty remains compatible with old version of Java, the Java runtime can often be a recent JVM. The JEP [Integrity by default](https://openjdk.org/jeps/8305968) will restrict how Netty operates in the future (JNI, Unsafe). Supporting JPMS will help to mitigate this by making Netty a clear identified consumer of these features, letting users configure Netty to use them (e.g. `--enable-native-access=io.netty.xxx`).\r\n\r\nJPMS is a multi-year / multi-project effort, this is a second step toward JPMS support.\r\n\r\n## Goals\r\n\r\n- Netty continue to operate as before when Netty jars are on the classpath\r\n- No breaking changes with classpath, module path might have behavioural changes which should be considered as acceptable\r\n- Give the opportunity to JPMS consumers (libraries / frameworks / applications) of Netty (e.g. Eclipse Vert.x) to use Netty on the module path instead of the classpath\r\n\r\n## Non goals\r\n\r\n- Encapsulation is not a goal as it requires impacting changes in Netty\r\n\r\n## Implementation\r\n\r\nSince Netty 4.2 aims to use Java 8, the considered approach is the generation of module descriptors in Netty jars using a tool like [moditect](https://github.com/moditect/moditect) or [module-info](https://github.com/dmlloyd/module-info).\r\n\r\nModule descriptors is generated at `META-INF/versions/11/module-info.class` (multi release jar) which makes it invisible as a class to Java 8 class loading.\r\n\r\nDescriptor will export all Netty packages by default, it might be restricted in later versions, e.g. having logging internal packages could be attempted.\r\n\r\nMaven integration tests should be provided to test the behaviour, e.g. creating a jlink image (jlink does not accept automatic modules), etc...\r\n\r\n## Known issues and open concerns\r\n\r\n- for most modules, jar and test-jar exhibit split packages\r\n  - prevents test jar reuse\r\n  - not blocker, but might be in the future\r\n- `netty-common` coupling to `io.projectreactor.tools:blockhound`\r\n  - this currently works because the `io.netty.util.internal.Hidden` and `META-INF/services/reactor.blockhound.integration.BlockHoundIntegration` are ignored by Java\r\n  - Java requires to publish this as a `providesâ€¦with` module declaration which couple the module with this jar which might not be desirable for most users\r\n  - not blocker, but might be in the future\r\n  - this could be offloaded to a third party jar and does not require to be in `netty-common`\r\n  - block hound integration does not work with the module path\r\n  - https://github.com/netty/netty/issues/14260\r\n- there is a difference between native transport and openssl native engine with respect to the naming of module with a classifier (containing the native libraries to load)\r\n  -  openssl assumes only a single dependency can be present at runtime and jars with classifier use the same module name `io.netty.internal.tcnative`\r\n  - native transports declare module names with the classifier, e.g. `io.netty.transport.kqueue.osx.aarch_64`\r\n  - we need to judge pros and cons for both approach and settle on the best approach\r\n- integration test for BouncyCastle is not trivial since there are fallbacks when it is missing\r\n- [x] split package [issue](https://github.com/netty/netty/issues/14228) between `netty-codec` and `netty-codec-xml`\r\n- [x] [decouple](https://github.com/netty/netty/pull/14241) netty-codec from compression/marshalling/protobuf \r\n- [x] split package [issue](https://github.com/netty/netty/issues/14244) between `netty-handler` and `netty-handler-ssl-ocsp`\r\n- [x] native transports base jar contains an incorrect module name (pretty much like we had for tcnative)\r\n\r\n## Modularity coverage\r\n\r\n| Artifact    | Modular |Restrictions|\r\n| -------- | ------- |------- |\r\n| netty-buffer  | yes ||\r\n| netty-common  | yes ||\r\n| netty-codec  | yes ||\r\n| netty-codec-compression  | yes | lzma-java/jzlib/lz4j/ztsd-jini automatic |\r\n| netty-codec-dns  | yes ||\r\n| netty-codec-haproxy  | yes ||\r\n| netty-codec-http  | yes ||\r\n| netty-codec-http2  | yes ||\r\n| netty-codec-marshalling  | yes | jboss-marshalling automatic |\r\n| netty-codec-memcache  | yes ||\r\n| netty-codec-mqtt  | yes ||\r\n| netty-codec-memcache  | yes ||\r\n| netty-codec-protobuf  | yes | protobuf-java automatic |\r\n| netty-codec-redis  | yes ||\r\n| netty-codec-smtp  | yes ||\r\n| netty-codec-socks  | yes ||\r\n| netty-codec-stomp  | yes ||\r\n| netty-codec-xml  | yes ||\r\n| netty-common  | yes ||\r\n| netty-handler | yes | conscript not tested |\r\n| netty-handler-proxy | yes ||\r\n| netty-handler-ssl-ocsp | yes ||\r\n| netty-resolver | yes ||\r\n| netty-resolver-dns | yes ||\r\n| netty-resolver-dns-classes-macos | yes ||\r\n| netty-resolver-dns-native-macos | yes ||\r\n| netty-transport | yes ||\r\n| netty-transport-classes-epoll | yes ||\r\n| netty-transport-classes-io_uring | yes ||\r\n| netty-transport-classes-kqueue | yes ||\r\n| netty-native-epoll | yes ||\r\n| netty-native-io_uring | yes ||\r\n| netty-native-kqueue | yes ||\r\n| netty-native-unix-common | yes ||\r\n| netty-transport-rxtx | no |  marked as [deprecated](https://github.com/netty/netty/commit/8c8779669e1acdd8307e5faafb7ca9b378348831) and dropped in Netty 5 |\r\n| netty-transport-sctp | no | [dropped](https://github.com/netty/netty/issues/11555) in Netty 5 |\r\n| netty-transport-udt | no | marked as [deprecated](https://github.com/netty/netty/commit/4734ef61a57b15df3e313b071956218fde98da2c) and dropped in Netty 5 |\r\n\r\n## Testing\r\n\r\nTesting module descriptors is achieve through a dedicated test suite that requires Java 11 or above.\r\n\r\nThere are several level of testing of a module\r\n- compilation: the tested module is used as a dependency\r\n- execution: there is a test that is executed with unit and use it\r\n- jlink creation: a jlink image can be create with the module\r\n- jlink runtime: the feature can be tested in a jlink generated image\r\n\r\n## Upstream declarative JPMS support\r\n\r\nNetty dependencies should also provide declarative JPMS descriptors, some dependencies already support it.\r\n\r\nMost of the dependencies below are optional and the lack of declarative JPMS support means taking the appropriate measure and might not be a blocker issue.\r\n\r\n### Logging dependencies\r\n\r\n- [x] modular commons logging\r\n- [x] modular log4j\r\n- [x] slf4j modular\r\n- [x] modular logback\r\n\r\n### Dependencies already supporting declarative JPMS\r\n\r\n- [x] [brotli4j](https://github.com/hyperxpro/Brotli4j) \r\n- [x] bouncy castle\r\n- [x] [compress-lzf](https://github.com/ning/compress)\r\n- [x] [zstd-jini](https://github.com/luben/zstd-jni)\r\n  - [issue](https://github.com/luben/zstd-jni/issues/322)\r\n- [x] [FasterXML/aalto-xml](https://github.com/FasterXML/aalto-xml) and [FasterXML/stax2-api](https://github.com/FasterXML/stax2-api)\r\n  - [issue](https://github.com/netty/netty/pull/14232)\r\n\r\n### Dependencies that shall support declarative JPMS in a reasonable time frame\r\n\r\n- [x] [tcnative](https://github.com/netty/netty-tcnative)\r\n  - [x] [contrib](https://github.com/netty/netty-tcnative/pull/879)\r\n  - [x] [issue](https://github.com/netty/netty-tcnative/issues/880) to fix\r\n- [ ] [prototobuf](https://github.com/protocolbuffers/protobuf)\r\n  - [issue](https://github.com/protocolbuffers/protobuf/issues/16133)\r\n  - [contrib](https://github.com/protocolbuffers/protobuf/pull/16502) by @sgammon\r\n- [ ] [jboss-marshalling](https://github.com/jboss-remoting/jboss-marshalling/tree/main)\r\n\r\n### Dependencies under investigation\r\n\r\n- [ ] [lzma-java](https://github.com/jponge/lzma-java)\r\n- [ ] [conscrypt](https://github.com/google/conscrypt)\r\n\r\n### Dependencies considered inactive or deprecated\r\n\r\nDoes not mean it is hopeless.\r\n\r\n- [ ] [jzlib](https://github.com/ymnk/jzlib): project maintenance [seems](https://github.com/ymnk/jzlib/issues/22) discontinued\r\n- [ ] [lz4](https://github.com/lz4/lz4-java): project maintenance is [discontinued](https://github.com/lz4/lz4-java/issues/214#issuecomment-1715242055)\r\n\r\nSee also this relate discussion https://github.com/netty/netty/issues/12271\r\n\r\n### Dependencies excluded from modular effort after resolution\r\n\r\n- [x] [Jetty/alpn-api](https://github.com/jetty/jetty-alpn-api): [dropped](https://github.com/netty/netty/issues/14227) since OpenJDK8 supports ALPN \r\n- [x] [Jetty/npn](https://github.com/jetty/jetty-npn): [dropped](https://github.com/netty/netty/pull/14240) since Jetty NPN repository is archived as considered [deprecated](https://github.com/jetty-project/jetty-npn) in favour of ALPN.\r\n- [x] [rxtx](https://github.com/rxtx/rxtx)\r\n- [x] [barchart-udt](https://github.com/barchart/barchart-udt): the project looks [inactive](https://github.com/barchart/barchart-udt/issues/75)\r\n\r\n## Contribution\r\n\r\nI am volunteering to implement JPMS support and supporting it in the long run. I welcome any help for this effort of course.","closed_by":null,"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/14176/reactions","total_count":8,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":6,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/14176/timeline","performed_via_github_app":null,"state_reason":null}