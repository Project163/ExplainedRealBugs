{"url":"https://api.github.com/repos/netty/netty/issues/9553","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/9553/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/9553/comments","events_url":"https://api.github.com/repos/netty/netty/issues/9553/events","html_url":"https://github.com/netty/netty/issues/9553","id":490954896,"node_id":"MDU6SXNzdWU0OTA5NTQ4OTY=","number":9553,"title":"HttpContentEncoder does not handle multiple Accept-Encoding headers correctly","user":{"login":"wilkinsona","id":914682,"node_id":"MDQ6VXNlcjkxNDY4Mg==","avatar_url":"https://avatars.githubusercontent.com/u/914682?v=4","gravatar_id":"","url":"https://api.github.com/users/wilkinsona","html_url":"https://github.com/wilkinsona","followers_url":"https://api.github.com/users/wilkinsona/followers","following_url":"https://api.github.com/users/wilkinsona/following{/other_user}","gists_url":"https://api.github.com/users/wilkinsona/gists{/gist_id}","starred_url":"https://api.github.com/users/wilkinsona/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wilkinsona/subscriptions","organizations_url":"https://api.github.com/users/wilkinsona/orgs","repos_url":"https://api.github.com/users/wilkinsona/repos","events_url":"https://api.github.com/users/wilkinsona/events{/privacy}","received_events_url":"https://api.github.com/users/wilkinsona/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/215","html_url":"https://github.com/netty/netty/milestone/215","labels_url":"https://api.github.com/repos/netty/netty/milestones/215/labels","id":4649917,"node_id":"MDk6TWlsZXN0b25lNDY0OTkxNw==","number":215,"title":"4.1.41.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":73,"state":"closed","created_at":"2019-09-11T07:09:53Z","updated_at":"2019-09-23T13:31:07Z","due_on":null,"closed_at":"2019-09-12T17:32:26Z"},"comments":5,"created_at":"2019-09-09T08:31:42Z","updated_at":"2019-09-12T08:35:16Z","closed_at":"2019-09-11T06:46:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n\r\nWhen a request contains multiple `Accept-Encoding` headers, their values will be treated as if they had been sent as the comma-separated values of a single `Accept-Encoding` header.\r\n\r\n### Actual behavior\r\n\r\nOnly the first `Accept-Encoding` header is considered and all subsequent `Accept-Encoding` headers are ignored.\r\n\r\n### Steps to reproduce\r\n\r\nConfigure an HTTP server with `HttpContentCompressor` in its pipeline and send a request with multiple `Accept-Encoding` headers. Using curl that would look something like this:\r\n\r\n```\r\n curl -H \"Accept-Encoding: unknown\" -H \"Accept-Encoding: gzip\" localhost:8080\r\n```\r\n\r\nObserve that the response is not gzipped.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\n```java\r\npackage com.example.demo;\r\n\r\nimport static io.netty.handler.codec.http.HttpHeaderNames.CONNECTION;\r\nimport static io.netty.handler.codec.http.HttpHeaderNames.CONTENT_LENGTH;\r\nimport static io.netty.handler.codec.http.HttpHeaderNames.CONTENT_TYPE;\r\nimport static io.netty.handler.codec.http.HttpHeaderValues.CLOSE;\r\nimport static io.netty.handler.codec.http.HttpHeaderValues.KEEP_ALIVE;\r\nimport static io.netty.handler.codec.http.HttpHeaderValues.TEXT_PLAIN;\r\nimport static io.netty.handler.codec.http.HttpResponseStatus.OK;\r\n\r\nimport io.netty.bootstrap.ServerBootstrap;\r\nimport io.netty.buffer.Unpooled;\r\nimport io.netty.channel.Channel;\r\nimport io.netty.channel.ChannelFuture;\r\nimport io.netty.channel.ChannelFutureListener;\r\nimport io.netty.channel.ChannelHandlerContext;\r\nimport io.netty.channel.ChannelInitializer;\r\nimport io.netty.channel.ChannelOption;\r\nimport io.netty.channel.ChannelPipeline;\r\nimport io.netty.channel.EventLoopGroup;\r\nimport io.netty.channel.SimpleChannelInboundHandler;\r\nimport io.netty.channel.nio.NioEventLoopGroup;\r\nimport io.netty.channel.socket.SocketChannel;\r\nimport io.netty.channel.socket.nio.NioServerSocketChannel;\r\nimport io.netty.handler.codec.http.DefaultFullHttpResponse;\r\nimport io.netty.handler.codec.http.FullHttpResponse;\r\nimport io.netty.handler.codec.http.HttpContentCompressor;\r\nimport io.netty.handler.codec.http.HttpObject;\r\nimport io.netty.handler.codec.http.HttpRequest;\r\nimport io.netty.handler.codec.http.HttpServerCodec;\r\nimport io.netty.handler.codec.http.HttpServerExpectContinueHandler;\r\nimport io.netty.handler.codec.http.HttpUtil;\r\n\r\npublic final class HttpHelloWorldServer {\r\n\r\n    public static void main(String[] args) throws Exception {\r\n        EventLoopGroup bossGroup = new NioEventLoopGroup(1);\r\n        EventLoopGroup workerGroup = new NioEventLoopGroup();\r\n        try {\r\n            ServerBootstrap b = new ServerBootstrap();\r\n            b.option(ChannelOption.SO_BACKLOG, 1024);\r\n            b.group(bossGroup, workerGroup)\r\n             .channel(NioServerSocketChannel.class)\r\n             .childHandler(new HttpHelloWorldServerInitializer());\r\n            Channel ch = b.bind(8080).sync().channel();\r\n            ch.closeFuture().sync();\r\n        } finally {\r\n            bossGroup.shutdownGracefully();\r\n            workerGroup.shutdownGracefully();\r\n        }\r\n    }\r\n    \r\n    static final class HttpHelloWorldServerInitializer extends ChannelInitializer<SocketChannel> {\r\n\r\n        @Override\r\n        public void initChannel(SocketChannel ch) {\r\n            ChannelPipeline p = ch.pipeline();\r\n            p.addLast(new HttpServerCodec());\r\n            p.addLast(new HttpContentCompressor());\r\n            p.addLast(new HttpServerExpectContinueHandler());\r\n            p.addLast(new HttpHelloWorldServerHandler());\r\n        }\r\n        \r\n    }\r\n    \r\n    static final class HttpHelloWorldServerHandler extends SimpleChannelInboundHandler<HttpObject> {\r\n    \t\r\n        private static final byte[] CONTENT = { 'H', 'e', 'l', 'l', 'o', ' ', 'W', 'o', 'r', 'l', 'd' };\r\n\r\n        @Override\r\n        public void channelReadComplete(ChannelHandlerContext context) {\r\n            context.flush();\r\n        }\r\n\r\n        @Override\r\n        public void channelRead0(ChannelHandlerContext context, HttpObject message) {\r\n            if (message instanceof HttpRequest) {\r\n                HttpRequest req = (HttpRequest) message;\r\n\r\n                boolean keepAlive = HttpUtil.isKeepAlive(req);\r\n                FullHttpResponse response = new DefaultFullHttpResponse(req.protocolVersion(), OK, Unpooled.wrappedBuffer(CONTENT));\r\n                response.headers().set(CONTENT_TYPE, TEXT_PLAIN).setInt(CONTENT_LENGTH, response.content().readableBytes());\r\n\r\n                if (keepAlive) {\r\n                    if (!req.protocolVersion().isKeepAliveDefault()) {\r\n                        response.headers().set(CONNECTION, KEEP_ALIVE);\r\n                    }\r\n                } else {\r\n                    // Tell the client we're going to close the connection.\r\n                    response.headers().set(CONNECTION, CLOSE);\r\n                }\r\n\r\n                ChannelFuture f = context.write(response);\r\n\r\n                if (!keepAlive) {\r\n                    f.addListener(ChannelFutureListener.CLOSE);\r\n                }\r\n            }\r\n        }\r\n\r\n        @Override\r\n        public void exceptionCaught(ChannelHandlerContext context, Throwable ex) {\r\n            ex.printStackTrace();\r\n            context.close();\r\n        }\r\n        \r\n    }\r\n    \r\n}\r\n```\r\n\r\n### Netty version\r\n\r\n4.1.39\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\n```\r\nopenjdk version \"1.8.0_202\"\r\nOpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_202-b08)\r\nOpenJDK 64-Bit Server VM (AdoptOpenJDK)(build 25.202-b08, mixed mode)\r\n```\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\nDarwin Andys-MacBook-Pro.local 17.7.0 Darwin Kernel Version 17.7.0: Sun Jun  2 20:31:42 PDT 2019; root:xnu-4570.71.46~1/RELEASE_X86_64 x86_64","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/9553/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/9553/timeline","performed_via_github_app":null,"state_reason":"completed"}