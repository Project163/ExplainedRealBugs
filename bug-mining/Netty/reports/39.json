{"url":"https://api.github.com/repos/netty/netty/issues/7566","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7566/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7566/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7566/events","html_url":"https://github.com/netty/netty/issues/7566","id":286169306,"node_id":"MDU6SXNzdWUyODYxNjkzMDY=","number":7566,"title":"JdkZlibDecoder ignores everything but first GZIP stream, non-compliant with RFC 1952","user":{"login":"asarkar","id":1302775,"node_id":"MDQ6VXNlcjEzMDI3NzU=","avatar_url":"https://avatars.githubusercontent.com/u/1302775?v=4","gravatar_id":"","url":"https://api.github.com/users/asarkar","html_url":"https://github.com/asarkar","followers_url":"https://api.github.com/users/asarkar/followers","following_url":"https://api.github.com/users/asarkar/following{/other_user}","gists_url":"https://api.github.com/users/asarkar/gists{/gist_id}","starred_url":"https://api.github.com/users/asarkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asarkar/subscriptions","organizations_url":"https://api.github.com/users/asarkar/orgs","repos_url":"https://api.github.com/users/asarkar/repos","events_url":"https://api.github.com/users/asarkar/events{/privacy}","received_events_url":"https://api.github.com/users/asarkar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/178","html_url":"https://github.com/netty/netty/milestone/178","labels_url":"https://api.github.com/repos/netty/netty/milestones/178/labels","id":2970375,"node_id":"MDk6TWlsZXN0b25lMjk3MDM3NQ==","number":178,"title":"4.0.55.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":19,"state":"closed","created_at":"2017-12-11T06:45:16Z","updated_at":"2018-07-07T18:37:55Z","due_on":null,"closed_at":"2018-01-22T06:57:36Z"},"comments":6,"created_at":"2018-01-05T01:58:01Z","updated_at":"2018-01-17T17:58:47Z","closed_at":"2018-01-17T05:11:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\ngzip content is fully consumed\r\n### Actual behavior\r\ngzip content is partially consumed\r\n### Steps to reproduce\r\nn/a\r\n### Minimal yet complete reproducer code (or URL to code)\r\nn/a\r\n### Netty version\r\n4.1.17\r\n### JVM version (e.g. `java -version`)\r\nn/a\r\n### OS version (e.g. `uname -a`)\r\nn/a\r\n\r\n\r\nI'm using Spring WebClient to read a large (12 million records) gzipped response. I've set up the Netty pipeline as follows:\r\n```\r\nctx.addHandlerLast(new ReadTimeoutHandler(readTimeoutMillis, TimeUnit.MILLISECONDS));\r\nctx.addHandlerLast(new Slf4JLoggingHandler());\r\nif (forceDecompression) {\r\n    io.netty.handler.codec.http.HttpHeaders httpHeaders = new ReadOnlyHttpHeaders(\r\n            true,\r\n            CONTENT_ENCODING, GZIP,\r\n            CONTENT_TYPE, APPLICATION_JSON\r\n    );\r\n    HttpResponseHeadersHandler headersModifier = new HttpResponseHeadersHandler(httpHeaders);\r\n    ctx.addHandlerFirst(headersModifier);\r\n}\r\nctx.addHandlerLast(new HttpContentDecompressor());\r\n```\r\nThe `HttpResponseHeadersHandler` overwrites headers in the response because the server doesn't send an `Content-Encoding` header. Details and implementation can be found [here](https://github.com/netty/netty/issues/7553#issuecomment-355249883).\r\n\r\nProblem is, processing stops after about 130,000 records. No errors are shown. I've debugged and found out that the `JdkZlibDecoder` used for decompression stops reading and enters the finished block. I've tests that work fine for fewer number of records (100 or so).\r\n\r\nHowever, using a different client (okhttp), if I don't set the `Content-Encoding` header and wrap the input stream with `GZIPInputStream`, everything works as expected.\r\n\r\nSo, question is, if `GZIPInputStream` doesn't have a problem, why does `JdkZlibDecoder`? And since it does, why won't it report what it thinks is the issue?\r\n\r\n```\r\n>> GET http://myserver.mycompany.com/.../businesses.20180104.json.gz\r\n<< 200 OK\r\n<< connection -> [keep-alive]\r\n<< accept-ranges -> [bytes]\r\n<< content-disposition -> [attachment; filename=\"businesses.20180104.json.gz\"; filename*=UTF-8''businesses.20180104.json.gz] \r\n<< content-type -> [application/x-gzip]\r\n<< content-length -> [3384998203]\r\n<< date -> [Fri, 05 Jan 2018 00:43:32 GMT]\r\n<< etag -> [0e49d5fa7ba9f68058bfbb4a98bef032c3a73871]\r\n<< last-modified -> [Thu, 04 Jan 2018 23:54:26 GMT]\r\n<< x-artifactory-id -> [9732f56568ea1e3d:59294f65:160b8066066:-8000]\r\n<< x-checksum-md5 -> [451ca1b1414e7b511de874e61fd33eb2]\r\n<< x-artifactory-filename -> [businesses.20180104.json.gz]\r\n<< server -> [Artifactory/5.3.0]\r\n<< x-checksum-sha1 -> [0e49d5fa7ba9f68058bfbb4a98bef032c3a73871]\r\n```\r\n\r\nFor full disclosure, Initially posted a [question](https://stackoverflow.com/q/48094553/839733) on stackoverflow. Also related to https://github.com/square/okhttp/issues/3759.\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7566/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7566/timeline","performed_via_github_app":null,"state_reason":"completed"}