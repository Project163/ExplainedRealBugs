{"url":"https://api.github.com/repos/netty/netty/issues/14876","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/14876/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/14876/comments","events_url":"https://api.github.com/repos/netty/netty/issues/14876/events","html_url":"https://github.com/netty/netty/issues/14876","id":2886519128,"node_id":"I_kwDOABA-c86sDMlY","number":14876,"title":"JMH: assertion should be disabled by default when doing JMH test","user":{"login":"laosijikaichele","id":29225782,"node_id":"MDQ6VXNlcjI5MjI1Nzgy","avatar_url":"https://avatars.githubusercontent.com/u/29225782?v=4","gravatar_id":"","url":"https://api.github.com/users/laosijikaichele","html_url":"https://github.com/laosijikaichele","followers_url":"https://api.github.com/users/laosijikaichele/followers","following_url":"https://api.github.com/users/laosijikaichele/following{/other_user}","gists_url":"https://api.github.com/users/laosijikaichele/gists{/gist_id}","starred_url":"https://api.github.com/users/laosijikaichele/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/laosijikaichele/subscriptions","organizations_url":"https://api.github.com/users/laosijikaichele/orgs","repos_url":"https://api.github.com/users/laosijikaichele/repos","events_url":"https://api.github.com/users/laosijikaichele/events{/privacy}","received_events_url":"https://api.github.com/users/laosijikaichele/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2025-02-28T08:23:37Z","updated_at":"2025-03-04T09:29:21Z","closed_at":"2025-03-04T06:43:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Currently, assertion is enabled by default when doing JMH test, by the `AbstractMicrobenchmark`'s default constructor:\nhttps://github.com/netty/netty/blob/24479a05cd20394d6d393b1ce3037046218158cc/microbench/src/main/java/io/netty/microbench/util/AbstractMicrobenchmark.java#L109-L111\n\nBut some assertion code may hurt performance, which may jitter the JMH results, for example:\nhttps://github.com/netty/netty/blob/24479a05cd20394d6d393b1ce3037046218158cc/buffer/src/main/java/io/netty/buffer/PoolChunkList.java#L129-L131\n\nThe `chunk.usage()` calls `ReentrantLock.lock()` internally, which may hurt performance, thus will not reflect the real performance.\n\nAssertion is commonly disabled in production to avoid performance penalty. \nSince the JMH tests are mainly aimed to evaluate the performance, rather than logic correctness(which assertion does), so the JMH tests should do the same as the production, to exclude the noise introduced by assertion.\n\nI noticed there is another constructor method in `AbstractMicrobenchmark` which can disable assertion, but only a few JMH tests use it, so I suggest we make the assertion disabled in the default constructor.","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/14876/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/14876/timeline","performed_via_github_app":null,"state_reason":"completed"}