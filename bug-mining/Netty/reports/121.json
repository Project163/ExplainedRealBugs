{"url":"https://api.github.com/repos/netty/netty/issues/9770","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/9770/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/9770/comments","events_url":"https://api.github.com/repos/netty/netty/issues/9770/events","html_url":"https://github.com/netty/netty/issues/9770","id":520588278,"node_id":"MDU6SXNzdWU1MjA1ODgyNzg=","number":9770,"title":"Websoket frame failes if the frame content is deflated partial EOM (0,0,-1,-1) from Tomcat.","user":{"login":"sakshamverma","id":45144070,"node_id":"MDQ6VXNlcjQ1MTQ0MDcw","avatar_url":"https://avatars.githubusercontent.com/u/45144070?v=4","gravatar_id":"","url":"https://api.github.com/users/sakshamverma","html_url":"https://github.com/sakshamverma","followers_url":"https://api.github.com/users/sakshamverma/followers","following_url":"https://api.github.com/users/sakshamverma/following{/other_user}","gists_url":"https://api.github.com/users/sakshamverma/gists{/gist_id}","starred_url":"https://api.github.com/users/sakshamverma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sakshamverma/subscriptions","organizations_url":"https://api.github.com/users/sakshamverma/orgs","repos_url":"https://api.github.com/users/sakshamverma/repos","events_url":"https://api.github.com/users/sakshamverma/events{/privacy}","received_events_url":"https://api.github.com/users/sakshamverma/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"amizurov","id":8257855,"node_id":"MDQ6VXNlcjgyNTc4NTU=","avatar_url":"https://avatars.githubusercontent.com/u/8257855?v=4","gravatar_id":"","url":"https://api.github.com/users/amizurov","html_url":"https://github.com/amizurov","followers_url":"https://api.github.com/users/amizurov/followers","following_url":"https://api.github.com/users/amizurov/following{/other_user}","gists_url":"https://api.github.com/users/amizurov/gists{/gist_id}","starred_url":"https://api.github.com/users/amizurov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amizurov/subscriptions","organizations_url":"https://api.github.com/users/amizurov/orgs","repos_url":"https://api.github.com/users/amizurov/repos","events_url":"https://api.github.com/users/amizurov/events{/privacy}","received_events_url":"https://api.github.com/users/amizurov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"amizurov","id":8257855,"node_id":"MDQ6VXNlcjgyNTc4NTU=","avatar_url":"https://avatars.githubusercontent.com/u/8257855?v=4","gravatar_id":"","url":"https://api.github.com/users/amizurov","html_url":"https://github.com/amizurov","followers_url":"https://api.github.com/users/amizurov/followers","following_url":"https://api.github.com/users/amizurov/following{/other_user}","gists_url":"https://api.github.com/users/amizurov/gists{/gist_id}","starred_url":"https://api.github.com/users/amizurov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amizurov/subscriptions","organizations_url":"https://api.github.com/users/amizurov/orgs","repos_url":"https://api.github.com/users/amizurov/repos","events_url":"https://api.github.com/users/amizurov/events{/privacy}","received_events_url":"https://api.github.com/users/amizurov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/218","html_url":"https://github.com/netty/netty/milestone/218","labels_url":"https://api.github.com/repos/netty/netty/milestones/218/labels","id":4781003,"node_id":"MDk6TWlsZXN0b25lNDc4MTAwMw==","number":218,"title":"4.1.44.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":113,"state":"closed","created_at":"2019-10-24T15:58:51Z","updated_at":"2019-12-18T14:17:08Z","due_on":null,"closed_at":"2019-12-18T14:17:08Z"},"comments":5,"created_at":"2019-11-10T11:27:11Z","updated_at":"2019-12-11T14:01:15Z","closed_at":"2019-12-11T14:00:53Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Scenario is when the tomcat communicates to netty with websocket connection. The frmae size is 8192 bytes.\r\nTomcat sends the compressed websocket data frames to netty. \r\nWhen tomcat sends the websocket frames to netty, every frame ends with the EOM byte sequence which is 0,0,-1,-1. \r\nThere are four conditions now:\r\n1. The compressed data is small enough that the complete content and the EOM is contained in one frame. \r\n\r\n2. The data is large that it takes multiple frames to complete and the last frame contains some part data and the complete EOM. \r\n\r\n3. The  data is such that the EOM is in the two frames. e.g. the data is 8189 bytes, so the EOM starts in one and spreads over the next one. \r\n\r\n4.  The data and the EOM totals the 8192bytes. even in this case a next frame is sent with 0 as the first byte.\r\n\r\nThe conditions 1and 2 passes but 3 and 4 fails. Becuase the frame that contains only the partial EOM of previous frame is unable to be deflated in the DeflateDecoder\r\nio.netty.handler.codec.compression.JdkZlibDecoder.decode(ChannelHandlerContext, ByteBuf, List<Object>)\r\n\r\n### Expected behavior\r\nThe websocket message should be successfully sent. \r\n\r\n### Actual behavior\r\nThe message fils with the below exception \r\nCaused by: io.netty.handler.codec.CodecException: cannot read uncompressed buffer\r\nat io.netty.handler.codec.http.websocketx.extensions.compression.DeflateDecoder.decode(DeflateDecoder.java:89)\r\nat io.netty.handler.codec.http.websocketx.extensions.compression.PerMessageDeflateDecoder.decode(PerMessageDeflateDecoder.java:64)\r\nat io.netty.handler.codec.http.websocketx.extensions.compression.PerMessageDeflateDecoder.decode(PerMessageDeflateDecoder.java:30)\r\nat io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:88)\r\n\r\n### Steps to reproduce\r\nHost a zip file in tomcat and transfer to netty application on a websocket connection.\r\nBut it is not reproducible with any zip file, only with the ones where content is not compressible by the java Deflater class. \r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\nI have debugged in a complicated software, I am in process of creating a minimal code, but if the issue is crlear can we please get the fix. \r\n\r\nThough not in a perfect way, but I was able to fix the code by following changes in DeflateDecoder\r\n[DeflateDecoder.txt](https://github.com/netty/netty/files/3828375/DeflateDecoder.txt)\r\n:\r\n\r\nboolean partialEOMFrame = true;\r\n        for (int i = 0; i < msg.content().readableBytes(); i++) {\r\n            byte contentAtI = msg.content().readByte();\r\n            if (contentAtI != 0 && contentAtI != -1) {\r\n                partialEOMFrame = false;\r\n                break;\r\n            }\r\n        }\r\n        msg.content().readerIndex(0);\r\n;\r\n;\r\n;\r\n\r\n\r\nif (!partialEOMFrame && readable && compositeUncompressedContent.numComponents() <= 0) {\r\n            compositeUncompressedContent.release();\r\n            throw new CodecException(\"cannot read uncompressed buffer\");\r\n        }\r\n\r\n\r\n### Netty version\r\n4.1.15\r\n### JVM version (e.g. `java -version`)\r\n1.8\r\n### OS version (e.g. `uname -a`)\r\nwindows.","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/9770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/9770/timeline","performed_via_github_app":null,"state_reason":"completed"}