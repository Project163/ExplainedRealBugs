{"url":"https://api.github.com/repos/netty/netty/issues/13166","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/13166/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/13166/comments","events_url":"https://api.github.com/repos/netty/netty/issues/13166/events","html_url":"https://github.com/netty/netty/issues/13166","id":1560685141,"node_id":"I_kwDOABA-c85dBipV","number":13166,"title":"The problem of low efficiency and multiple cycles may occur in the TimeWheel Algorithm","user":{"login":"1294566108","id":91858554,"node_id":"U_kgDOBXmmeg","avatar_url":"https://avatars.githubusercontent.com/u/91858554?v=4","gravatar_id":"","url":"https://api.github.com/users/1294566108","html_url":"https://github.com/1294566108","followers_url":"https://api.github.com/users/1294566108/followers","following_url":"https://api.github.com/users/1294566108/following{/other_user}","gists_url":"https://api.github.com/users/1294566108/gists{/gist_id}","starred_url":"https://api.github.com/users/1294566108/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/1294566108/subscriptions","organizations_url":"https://api.github.com/users/1294566108/orgs","repos_url":"https://api.github.com/users/1294566108/repos","events_url":"https://api.github.com/users/1294566108/events{/privacy}","received_events_url":"https://api.github.com/users/1294566108/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2023-01-28T04:24:19Z","updated_at":"2024-01-29T10:26:53Z","closed_at":"2024-01-29T10:26:53Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Your Question\r\nIn the **HashedWheelTimer#normalizeTicksPerWheel** method, when the value of **ticksPerWheel** is large, the method will cycle many times, the method execution time is unstable, and the efficiency may be low.\r\n![image](https://user-images.githubusercontent.com/91858554/215241258-f9ce7151-5185-46be-90ef-a42e57aa00a0.png)\r\n\r\n### Your scenes\r\nUse the relevant implementation of **java8 HashMap** to improve the algorithm.\r\nThe **HashedWheelTimer#normalizeTicksPerWheel** method achieves the same purpose as the method in **java8 HashMap**. Both can get a number greater than or equal to ticksPerWheel (and this number is a power of 2) and return.\r\n\r\n### Your advice\r\nThe following algorithms can be used to improve efficiency：\r\nint n = ticksPerWheel - 1;\r\nn |= n >>> 1;\r\nn |= n >>> 2;\r\nn |= n >>> 4;\r\nn |= n >>> 8;\r\nn |= n >>> 16;\r\n//Here 1073741824=2 ^ 30 to prevent overflow\r\nreturn (n < 0) ? 1 : (n >= 1073741824) ? 1073741824 : n + 1;\r\nBecause the type of the parameter **ticksPerWheel** passed in by the **HashedWheelTimer#normalizeTicksPerWheel** method is [int], a total of **2 to the 31st power** has been calculated（16+8+4+2+1==31）. Since the maximum value of int type is the 31st power of 2, the input int type parameters can be moved to. There is no conversion failure caused by insufficient shift times.\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\n### Netty version\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\n### OS version (e.g. `uname -a`)\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/13166/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/13166/timeline","performed_via_github_app":null,"state_reason":"completed"}