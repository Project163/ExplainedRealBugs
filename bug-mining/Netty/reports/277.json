{"url":"https://api.github.com/repos/netty/netty/issues/12065","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/12065/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/12065/comments","events_url":"https://api.github.com/repos/netty/netty/issues/12065/events","html_url":"https://github.com/netty/netty/issues/12065","id":1120882863,"node_id":"I_kwDOABA-c85Cz1Cv","number":12065,"title":"Throwing protocol error when http2 max concurrent streams is exceeded instead of resStream","user":{"login":"stefanklas","id":98832797,"node_id":"U_kgDOBeQRnQ","avatar_url":"https://avatars.githubusercontent.com/u/98832797?v=4","gravatar_id":"","url":"https://api.github.com/users/stefanklas","html_url":"https://github.com/stefanklas","followers_url":"https://api.github.com/users/stefanklas/followers","following_url":"https://api.github.com/users/stefanklas/following{/other_user}","gists_url":"https://api.github.com/users/stefanklas/gists{/gist_id}","starred_url":"https://api.github.com/users/stefanklas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stefanklas/subscriptions","organizations_url":"https://api.github.com/users/stefanklas/orgs","repos_url":"https://api.github.com/users/stefanklas/repos","events_url":"https://api.github.com/users/stefanklas/events{/privacy}","received_events_url":"https://api.github.com/users/stefanklas/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/275","html_url":"https://github.com/netty/netty/milestone/275","labels_url":"https://api.github.com/repos/netty/netty/milestones/275/labels","id":9554783,"node_id":"MI_kwDOABA-c84Akctf","number":275,"title":"4.1.95.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":22,"state":"closed","created_at":"2023-06-19T10:27:17Z","updated_at":"2023-07-27T18:13:18Z","due_on":null,"closed_at":"2023-07-20T16:11:02Z"},"comments":4,"created_at":"2022-02-01T15:59:48Z","updated_at":"2023-07-27T18:13:18Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\nI'm new to Http2, and was trying to implement some load shedding on our server by limiting the number of concurrent streams set. This is currently fixed at 100. When setting the maxConcurrentStream in the HttpToHttp2ConnectionHandler, I was expecting to get see the behaviour mentioned in the spec (https://httpwg.org/specs/rfc7540.html#rfc.section.8.1.4)  and get a RST_STREAM frame back to the client. \r\n\r\n### Actual behavior\r\nInstead i am getting an error, Stream ID does not exist. This results in a connection error, causing a GOAWAY with \"PROTOCOL_ERROR\" and closes the whole connection instead of just the stream? I have not understood if I am doing anything wrong here.\r\n\r\n![Screenshot 2022-02-01 at 15 50 15](https://user-images.githubusercontent.com/98832797/152010319-bf8355f0-bf74-4ac8-8244-06019b706653.png)\r\n\r\n\r\n![Screenshot 2022-02-01 at 15 50 30](https://user-images.githubusercontent.com/98832797/152004563-d3ad7869-029b-49cb-a845-d45a1ca9e60b.png)\r\n\r\n![Screenshot 2022-02-01 at 16 32 55](https://user-images.githubusercontent.com/98832797/152009792-addba3b9-86a0-4d91-b435-3d15457d3bfc.png)\r\n\r\n### Steps to reproduce\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nServer Configuration\r\n\r\n```\r\npublic class Http2OnlyHandler extends ApplicationProtocolNegotiationHandler {\r\n @Override\r\n    protected void configurePipeline(ChannelHandlerContext ctx, String protocol) throws Exception {\r\n        if (ApplicationProtocolNames.HTTP_2.equals(protocol)) {\r\n            configureRedisPipeline(ctx);\r\n            return;\r\n        }\r\n\r\n        if (ApplicationProtocolNames.HTTP_1_1.equals(protocol)) {\r\n            configureFallback(ctx);\r\n            return;\r\n        }\r\n\r\n        throw new IllegalStateException(\"Unsupported protocol: \" + protocol);\r\n    }\r\n\r\n\r\n  private void configureRedisPipeline(ChannelHandlerContext ctx) {\r\n  \r\n    DefaultHttp2Connection connection = new DefaultHttp2Connection(true);\r\n     InboundHttp2ToHttpAdapter listener = new InboundHttp2ToHttpAdapterBuilder(connection)\r\n        .propagateSettings(true).validateHttpHeaders(false)\r\n        .maxContentLength(maxContentLength).build();\r\n  \r\n    HttpToHttp2ConnectionHandler connectionHandler = new HttpToHttp2ConnectionHandlerBuilder()\r\n        .frameListener(tester)\r\n        .initialSettings(new Http2Settings().maxConcurrentStreams(100))\r\n        .connection(connection).build();\r\n  \r\n    ctx.pipeline().addLast(connectionHandler);\r\n  }\r\n}\r\n\r\n\r\n bootstrap.group(bossGroup, workerGroup)\r\n                .channel(channelClazz)\r\n                .childHandler(new ChannelInitializer<SocketChannel>() {\r\n                    @Override\r\n                    protected void initChannel(SocketChannel ch) {\r\n                        ch.pipeline().addLast(sslCtx.newHandler(ch.alloc()),\r\n                            new Http2OnlyHandler(),\r\n                            etc...)\r\n                    }\r\n                 })\r\n```\r\n\r\nClient:\r\n```\r\nchannel.eventLoop().submit(() -> {\r\n            int streamId = this.streamId.addAndGet(2);\r\n\r\n            req.headers().setInt(HttpConversionUtil.ExtensionHeaderNames.STREAM_ID.text(), streamId);\r\n            req.headers().set(HttpConversionUtil.ExtensionHeaderNames.SCHEME.text(), \"https\");\r\n            req.headers().set(HttpHeaderNames.HOST, \"server\");\r\n            req.headers().add(HttpHeaderNames.ACCEPT_ENCODING, HttpHeaderValues.GZIP);\r\n            req.headers().add(HttpHeaderNames.ACCEPT_ENCODING, HttpHeaderValues.DEFLATE);\r\n\r\n            pendingRequests.put(streamId, new PendingReq<>(responseTransformer, future, System.currentTimeMillis(), (timeoutMs > 0) ? System.currentTimeMillis() + timeoutMs : -1));\r\n            channel.writeAndFlush(req, channel.voidPromise());\r\n        });\r\n\r\n}\r\n```\r\n\r\n\r\n### Netty version\r\n4.1.70.Final\r\n\r\n### JVM version (e.g. `java -version`)\r\njava version \"1.8.0_271\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_271-b09)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)\r\n### OS version (e.g. `uname -a`)\r\nDarwin sklas-mac 19.6.0 Darwin Kernel Version 19.6.0: Sun Nov 14 19:58:51 PST 2021; root:xnu-6153.141.50~1/RELEASE_X86_64 x86_64","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/12065/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/12065/timeline","performed_via_github_app":null,"state_reason":"reopened"}