[{"url":"https://api.github.com/repos/netty/netty/issues/comments/1151083755","html_url":"https://github.com/netty/netty/issues/12433#issuecomment-1151083755","issue_url":"https://api.github.com/repos/netty/netty/issues/12433","id":1151083755,"node_id":"IC_kwDOABA-c85EnCTr","user":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-09T12:54:24Z","updated_at":"2022-06-09T12:54:24Z","body":"sounds good... Do you want to contribute something ? I think this is very similar that what SwiftNIO does:\r\n\r\nhttps://github.com/apple/swift-nio/blob/main/Sources/NIOEmbedded/Embedded.swift#L146","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/netty/netty/issues/comments/1151083755/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/netty/netty/issues/comments/1151190763","html_url":"https://github.com/netty/netty/issues/12433#issuecomment-1151190763","issue_url":"https://api.github.com/repos/netty/netty/issues/12433","id":1151190763,"node_id":"IC_kwDOABA-c85Encbr","user":{"login":"yawkat","id":2395297,"node_id":"MDQ6VXNlcjIzOTUyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/2395297?v=4","gravatar_id":"","url":"https://api.github.com/users/yawkat","html_url":"https://github.com/yawkat","followers_url":"https://api.github.com/users/yawkat/followers","following_url":"https://api.github.com/users/yawkat/following{/other_user}","gists_url":"https://api.github.com/users/yawkat/gists{/gist_id}","starred_url":"https://api.github.com/users/yawkat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yawkat/subscriptions","organizations_url":"https://api.github.com/users/yawkat/orgs","repos_url":"https://api.github.com/users/yawkat/repos","events_url":"https://api.github.com/users/yawkat/events{/privacy}","received_events_url":"https://api.github.com/users/yawkat/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-09T14:27:29Z","updated_at":"2022-06-09T14:27:29Z","body":"Yep, I'll try implementing it. The swift-nio thing indeed sounds similar","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/netty/netty/issues/comments/1151190763/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"yawkat","id":2395297,"node_id":"MDQ6VXNlcjIzOTUyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/2395297?v=4","gravatar_id":"","url":"https://api.github.com/users/yawkat","html_url":"https://github.com/yawkat","followers_url":"https://api.github.com/users/yawkat/followers","following_url":"https://api.github.com/users/yawkat/following{/other_user}","gists_url":"https://api.github.com/users/yawkat/gists{/gist_id}","starred_url":"https://api.github.com/users/yawkat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yawkat/subscriptions","organizations_url":"https://api.github.com/users/yawkat/orgs","repos_url":"https://api.github.com/users/yawkat/repos","events_url":"https://api.github.com/users/yawkat/events{/privacy}","received_events_url":"https://api.github.com/users/yawkat/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"yawkat","id":2395297,"node_id":"MDQ6VXNlcjIzOTUyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/2395297?v=4","gravatar_id":"","url":"https://api.github.com/users/yawkat","html_url":"https://github.com/yawkat","followers_url":"https://api.github.com/users/yawkat/followers","following_url":"https://api.github.com/users/yawkat/following{/other_user}","gists_url":"https://api.github.com/users/yawkat/gists{/gist_id}","starred_url":"https://api.github.com/users/yawkat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yawkat/subscriptions","organizations_url":"https://api.github.com/users/yawkat/orgs","repos_url":"https://api.github.com/users/yawkat/repos","events_url":"https://api.github.com/users/yawkat/events{/privacy}","received_events_url":"https://api.github.com/users/yawkat/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-10T12:58:27Z","updated_at":"2022-06-10T12:58:27Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/netty/netty/issues/12459","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/12459/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/12459/comments","events_url":"https://api.github.com/repos/netty/netty/issues/12459/events","html_url":"https://github.com/netty/netty/pull/12459","id":1267510340,"node_id":"PR_kwDOABA-c845dwI2","number":12459,"title":"Allow controlling time flow for EmbeddedEventLoop","user":{"login":"yawkat","id":2395297,"node_id":"MDQ6VXNlcjIzOTUyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/2395297?v=4","gravatar_id":"","url":"https://api.github.com/users/yawkat","html_url":"https://github.com/yawkat","followers_url":"https://api.github.com/users/yawkat/followers","following_url":"https://api.github.com/users/yawkat/following{/other_user}","gists_url":"https://api.github.com/users/yawkat/gists{/gist_id}","starred_url":"https://api.github.com/users/yawkat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yawkat/subscriptions","organizations_url":"https://api.github.com/users/yawkat/orgs","repos_url":"https://api.github.com/users/yawkat/repos","events_url":"https://api.github.com/users/yawkat/events{/privacy}","received_events_url":"https://api.github.com/users/yawkat/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/255","html_url":"https://github.com/netty/netty/milestone/255","labels_url":"https://api.github.com/repos/netty/netty/milestones/255/labels","id":7950113,"node_id":"MI_kwDOABA-c84AeU8h","number":255,"title":"4.1.78.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":25,"state":"closed","created_at":"2022-05-06T10:52:51Z","updated_at":"2022-06-16T00:54:59Z","due_on":null,"closed_at":"2022-06-16T00:54:59Z"},"comments":5,"created_at":"2022-06-10T12:58:27Z","updated_at":"2022-06-13T08:37:08Z","closed_at":"2022-06-13T06:44:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":1064563,"node_id":"MDEwOlJlcG9zaXRvcnkxMDY0NTYz","name":"netty","full_name":"netty/netty","private":false,"owner":{"login":"netty","id":473791,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQ3Mzc5MQ==","avatar_url":"https://avatars.githubusercontent.com/u/473791?v=4","gravatar_id":"","url":"https://api.github.com/users/netty","html_url":"https://github.com/netty","followers_url":"https://api.github.com/users/netty/followers","following_url":"https://api.github.com/users/netty/following{/other_user}","gists_url":"https://api.github.com/users/netty/gists{/gist_id}","starred_url":"https://api.github.com/users/netty/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/netty/subscriptions","organizations_url":"https://api.github.com/users/netty/orgs","repos_url":"https://api.github.com/users/netty/repos","events_url":"https://api.github.com/users/netty/events{/privacy}","received_events_url":"https://api.github.com/users/netty/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/netty/netty","description":"Netty project - an event-driven asynchronous network application framework","fork":false,"url":"https://api.github.com/repos/netty/netty","forks_url":"https://api.github.com/repos/netty/netty/forks","keys_url":"https://api.github.com/repos/netty/netty/keys{/key_id}","collaborators_url":"https://api.github.com/repos/netty/netty/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/netty/netty/teams","hooks_url":"https://api.github.com/repos/netty/netty/hooks","issue_events_url":"https://api.github.com/repos/netty/netty/issues/events{/number}","events_url":"https://api.github.com/repos/netty/netty/events","assignees_url":"https://api.github.com/repos/netty/netty/assignees{/user}","branches_url":"https://api.github.com/repos/netty/netty/branches{/branch}","tags_url":"https://api.github.com/repos/netty/netty/tags","blobs_url":"https://api.github.com/repos/netty/netty/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/netty/netty/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/netty/netty/git/refs{/sha}","trees_url":"https://api.github.com/repos/netty/netty/git/trees{/sha}","statuses_url":"https://api.github.com/repos/netty/netty/statuses/{sha}","languages_url":"https://api.github.com/repos/netty/netty/languages","stargazers_url":"https://api.github.com/repos/netty/netty/stargazers","contributors_url":"https://api.github.com/repos/netty/netty/contributors","subscribers_url":"https://api.github.com/repos/netty/netty/subscribers","subscription_url":"https://api.github.com/repos/netty/netty/subscription","commits_url":"https://api.github.com/repos/netty/netty/commits{/sha}","git_commits_url":"https://api.github.com/repos/netty/netty/git/commits{/sha}","comments_url":"https://api.github.com/repos/netty/netty/comments{/number}","issue_comment_url":"https://api.github.com/repos/netty/netty/issues/comments{/number}","contents_url":"https://api.github.com/repos/netty/netty/contents/{+path}","compare_url":"https://api.github.com/repos/netty/netty/compare/{base}...{head}","merges_url":"https://api.github.com/repos/netty/netty/merges","archive_url":"https://api.github.com/repos/netty/netty/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/netty/netty/downloads","issues_url":"https://api.github.com/repos/netty/netty/issues{/number}","pulls_url":"https://api.github.com/repos/netty/netty/pulls{/number}","milestones_url":"https://api.github.com/repos/netty/netty/milestones{/number}","notifications_url":"https://api.github.com/repos/netty/netty/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/netty/netty/labels{/name}","releases_url":"https://api.github.com/repos/netty/netty/releases{/id}","deployments_url":"https://api.github.com/repos/netty/netty/deployments","created_at":"2010-11-09T09:22:21Z","updated_at":"2025-11-10T05:10:03Z","pushed_at":"2025-11-08T09:13:35Z","git_url":"git://github.com/netty/netty.git","ssh_url":"git@github.com:netty/netty.git","clone_url":"https://github.com/netty/netty.git","svn_url":"https://github.com/netty/netty","homepage":"http://netty.io","size":102527,"stargazers_count":34575,"watchers_count":34575,"language":"Java","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":16233,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":670,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":16233,"open_issues":670,"watchers":34575,"default_branch":"4.2","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/netty/netty/pulls/12459","html_url":"https://github.com/netty/netty/pull/12459","diff_url":"https://github.com/netty/netty/pull/12459.diff","patch_url":"https://github.com/netty/netty/pull/12459.patch","merged_at":"2022-06-13T06:44:56Z"},"body":"Motivation:\r\n\r\nTests using EmbeddedEventLoop can run faster if they can \"advance time\" so that scheduled tasks (e.g. timeouts) run earlier. Additionally, \"freeze time\" functionality can improve reliability of such tests.\r\n\r\nModification:\r\n\r\n- Introduce a protected method `AbstractScheduledEventExecutor.getCurrentTimeNanos` that replaces the previous static `nanoTime` method (now deprecated). Replace usages of `nanoTime` with the new method.\r\n- Override `getCurrentTimeNanos` with the new time control (freeze, unfreeze, advanceBy) features in `EmbeddedEventLoop`.\r\n- Add a microbenchmark that tests one of the sites that seemed most likely to see negative performance impact by the change (`ScheduledFutureTask.delayNanos`).\r\n\r\nResult:\r\n\r\nFixes  #12433. \r\n\r\nLocal runs of the `ScheduleFutureTaskBenchmark` microbenchmark shows no evidence for performance impact (within error bounds of each other):\r\n\r\n```\r\nbefore:\r\nBenchmark                                                   (num)   Mode  Cnt    Score    Error  Units\r\nScheduleFutureTaskBenchmark.scheduleCancelLotsOutsideLoop  100000  thrpt   20  132.437 ± 15.116  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLots                   100000  thrpt   20  694.475 ±  8.184  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLotsOutsideLoop        100000  thrpt   20   88.037 ±  4.013  ops/s\r\nafter:\r\nBenchmark                                                   (num)   Mode  Cnt    Score   Error  Units\r\nScheduleFutureTaskBenchmark.scheduleCancelLotsOutsideLoop  100000  thrpt   20  149.629 ± 7.514  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLots                   100000  thrpt   20  688.954 ± 7.831  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLotsOutsideLoop        100000  thrpt   20   85.426 ± 1.104  ops/s\r\n```\r\n\r\nThe new `ScheduleFutureTaskDeadlineBenchmark` shows some performance degradation:\r\n\r\n```\r\nbefore:\r\nBenchmark                                             Mode  Cnt         Score        Error  Units\r\nScheduleFutureTaskDeadlineBenchmark.requestDeadline  thrpt   20  60726336.795 ± 280054.533  ops/s\r\nafter:\r\nBenchmark                                             Mode  Cnt         Score        Error  Units\r\nScheduleFutureTaskDeadlineBenchmark.requestDeadline  thrpt   20  56948231.480 ± 188264.092  ops/s\r\n```\r\n\r\nThe difference is small, but it's there, so I investigated this further using jitwatch. Looking at the generated assembly, the call to `getCurrentTimeNanos` is devirtualized and inlined in the absence of `EmbeddedEventLoop`, so the code is mostly identical. However there is the added getfield and checkcast for the executor, which probably explains the discrepancy.\r\n\r\nIn my opinion this is acceptable, because the performance impact is not severe, this use is likely the worst case (virtual call through `scheduledExecutorService()`), and it is never as hot as in this benchmark.\r\n\r\nNote that if an `EmbeddedEventLoop` is present in the application, the performance impact is likely substantially higher, because this would necessitate a virtual call. However this is not an issue for production applications, and the affected code is still not very hot.","reactions":{"url":"https://api.github.com/repos/netty/netty/issues/12459/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/12459/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":6793394751,"node_id":"CE_lADOABA-c85KqfxhzwAAAAGU6vo_","url":"https://api.github.com/repos/netty/netty/issues/events/6793394751","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2022-06-13T06:44:56Z","state_reason":null,"performed_via_github_app":null},{"id":6793396434,"node_id":"MIE_lADOABA-c85KqfxhzwAAAAGU6wDS","url":"https://api.github.com/repos/netty/netty/issues/events/6793396434","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2022-06-13T06:45:19Z","milestone":{"title":"4.1.78.Final"},"performed_via_github_app":null},{"id":6793396491,"node_id":"REFE_lADOABA-c85KqfxhzwAAAAGU6wEL","url":"https://api.github.com/repos/netty/netty/issues/events/6793396491","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"c18fc2bc68c08805b2553336a3bf02f0c8c50972","commit_url":"https://api.github.com/repos/netty/netty/commits/c18fc2bc68c08805b2553336a3bf02f0c8c50972","created_at":"2022-06-13T06:45:19Z","performed_via_github_app":null},{"id":6795927068,"node_id":"REFE_lADOABA-c85KqfxhzwAAAAGVEZ4c","url":"https://api.github.com/repos/netty/netty/issues/events/6795927068","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"3469393f5cb961d212be58722b4ff8682a74ba20","commit_url":"https://api.github.com/repos/netty/netty/commits/3469393f5cb961d212be58722b4ff8682a74ba20","created_at":"2022-06-13T13:02:37Z","performed_via_github_app":null},{"actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-06-13T13:02:59Z","updated_at":"2022-06-13T13:02:59Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/netty/netty/issues/12464","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/12464/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/12464/comments","events_url":"https://api.github.com/repos/netty/netty/issues/12464/events","html_url":"https://github.com/netty/netty/pull/12464","id":1269406042,"node_id":"PR_kwDOABA-c845j3h7","number":12464,"title":"Allow controlling time flow for EmbeddedEventLoop (#12459)","user":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-13T13:02:59Z","updated_at":"2022-06-13T17:51:19Z","closed_at":"2022-06-13T17:49:25Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":1064563,"node_id":"MDEwOlJlcG9zaXRvcnkxMDY0NTYz","name":"netty","full_name":"netty/netty","private":false,"owner":{"login":"netty","id":473791,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQ3Mzc5MQ==","avatar_url":"https://avatars.githubusercontent.com/u/473791?v=4","gravatar_id":"","url":"https://api.github.com/users/netty","html_url":"https://github.com/netty","followers_url":"https://api.github.com/users/netty/followers","following_url":"https://api.github.com/users/netty/following{/other_user}","gists_url":"https://api.github.com/users/netty/gists{/gist_id}","starred_url":"https://api.github.com/users/netty/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/netty/subscriptions","organizations_url":"https://api.github.com/users/netty/orgs","repos_url":"https://api.github.com/users/netty/repos","events_url":"https://api.github.com/users/netty/events{/privacy}","received_events_url":"https://api.github.com/users/netty/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/netty/netty","description":"Netty project - an event-driven asynchronous network application framework","fork":false,"url":"https://api.github.com/repos/netty/netty","forks_url":"https://api.github.com/repos/netty/netty/forks","keys_url":"https://api.github.com/repos/netty/netty/keys{/key_id}","collaborators_url":"https://api.github.com/repos/netty/netty/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/netty/netty/teams","hooks_url":"https://api.github.com/repos/netty/netty/hooks","issue_events_url":"https://api.github.com/repos/netty/netty/issues/events{/number}","events_url":"https://api.github.com/repos/netty/netty/events","assignees_url":"https://api.github.com/repos/netty/netty/assignees{/user}","branches_url":"https://api.github.com/repos/netty/netty/branches{/branch}","tags_url":"https://api.github.com/repos/netty/netty/tags","blobs_url":"https://api.github.com/repos/netty/netty/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/netty/netty/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/netty/netty/git/refs{/sha}","trees_url":"https://api.github.com/repos/netty/netty/git/trees{/sha}","statuses_url":"https://api.github.com/repos/netty/netty/statuses/{sha}","languages_url":"https://api.github.com/repos/netty/netty/languages","stargazers_url":"https://api.github.com/repos/netty/netty/stargazers","contributors_url":"https://api.github.com/repos/netty/netty/contributors","subscribers_url":"https://api.github.com/repos/netty/netty/subscribers","subscription_url":"https://api.github.com/repos/netty/netty/subscription","commits_url":"https://api.github.com/repos/netty/netty/commits{/sha}","git_commits_url":"https://api.github.com/repos/netty/netty/git/commits{/sha}","comments_url":"https://api.github.com/repos/netty/netty/comments{/number}","issue_comment_url":"https://api.github.com/repos/netty/netty/issues/comments{/number}","contents_url":"https://api.github.com/repos/netty/netty/contents/{+path}","compare_url":"https://api.github.com/repos/netty/netty/compare/{base}...{head}","merges_url":"https://api.github.com/repos/netty/netty/merges","archive_url":"https://api.github.com/repos/netty/netty/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/netty/netty/downloads","issues_url":"https://api.github.com/repos/netty/netty/issues{/number}","pulls_url":"https://api.github.com/repos/netty/netty/pulls{/number}","milestones_url":"https://api.github.com/repos/netty/netty/milestones{/number}","notifications_url":"https://api.github.com/repos/netty/netty/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/netty/netty/labels{/name}","releases_url":"https://api.github.com/repos/netty/netty/releases{/id}","deployments_url":"https://api.github.com/repos/netty/netty/deployments","created_at":"2010-11-09T09:22:21Z","updated_at":"2025-11-10T05:10:03Z","pushed_at":"2025-11-08T09:13:35Z","git_url":"git://github.com/netty/netty.git","ssh_url":"git@github.com:netty/netty.git","clone_url":"https://github.com/netty/netty.git","svn_url":"https://github.com/netty/netty","homepage":"http://netty.io","size":102527,"stargazers_count":34575,"watchers_count":34575,"language":"Java","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":16233,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":670,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":16233,"open_issues":670,"watchers":34575,"default_branch":"4.2","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/netty/netty/pulls/12464","html_url":"https://github.com/netty/netty/pull/12464","diff_url":"https://github.com/netty/netty/pull/12464.diff","patch_url":"https://github.com/netty/netty/pull/12464.patch","merged_at":"2022-06-13T17:49:25Z"},"body":"Motivation:\r\n\r\nTests using EmbeddedEventLoop can run faster if they can \"advance time\" so that scheduled tasks (e.g. timeouts) run earlier. Additionally, \"freeze time\" functionality can improve reliability of such tests.\r\n\r\nModification:\r\n\r\n- Introduce a protected method `AbstractScheduledEventExecutor.getCurrentTimeNanos` that replaces the previous static `nanoTime` method (now deprecated). Replace usages of `nanoTime` with the new method.\r\n- Override `getCurrentTimeNanos` with the new time control (freeze, unfreeze, advanceBy) features in `EmbeddedEventLoop`.\r\n- Add a microbenchmark that tests one of the sites that seemed most likely to see negative performance impact by the change (`ScheduledFutureTask.delayNanos`).\r\n\r\nResult:\r\n\r\nFixes  #12433.\r\n\r\nLocal runs of the `ScheduleFutureTaskBenchmark` microbenchmark shows no evidence for performance impact (within error bounds of each other):\r\n\r\n```\r\nbefore:\r\nBenchmark                                                   (num)   Mode  Cnt    Score    Error  Units\r\nScheduleFutureTaskBenchmark.scheduleCancelLotsOutsideLoop  100000  thrpt   20  132.437 ± 15.116  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLots                   100000  thrpt   20  694.475 ±  8.184  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLotsOutsideLoop        100000  thrpt   20   88.037 ±  4.013  ops/s\r\nafter:\r\nBenchmark                                                   (num)   Mode  Cnt    Score   Error  Units\r\nScheduleFutureTaskBenchmark.scheduleCancelLotsOutsideLoop  100000  thrpt   20  149.629 ± 7.514  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLots                   100000  thrpt   20  688.954 ± 7.831  ops/s\r\nScheduleFutureTaskBenchmark.scheduleLotsOutsideLoop        100000  thrpt   20   85.426 ± 1.104  ops/s\r\n```\r\n\r\nThe new `ScheduleFutureTaskDeadlineBenchmark` shows some performance degradation:\r\n\r\n```\r\nbefore:\r\nBenchmark                                             Mode  Cnt         Score        Error  Units\r\nScheduleFutureTaskDeadlineBenchmark.requestDeadline  thrpt   20  60726336.795 ± 280054.533  ops/s\r\nafter:\r\nBenchmark                                             Mode  Cnt         Score        Error  Units\r\nScheduleFutureTaskDeadlineBenchmark.requestDeadline  thrpt   20  56948231.480 ± 188264.092  ops/s\r\n```\r\n\r\nThe difference is small, but it's there, so I investigated this further using jitwatch. Looking at the generated assembly, the call to `getCurrentTimeNanos` is devirtualized and inlined in the absence of `EmbeddedEventLoop`, so the code is mostly identical. However there is the added getfield and checkcast for the executor, which probably explains the discrepancy.\r\n\r\nIn my opinion this is acceptable, because the performance impact is not severe, this use is likely the worst case (virtual call through `scheduledExecutorService()`), and it is never as hot as in this benchmark.\r\n\r\nNote that if an `EmbeddedEventLoop` is present in the application, the performance impact is likely substantially higher, because this would necessitate a virtual call. However this is not an issue for production applications, and the affected code is still not very hot.\r\n\r\nCo-authored-by: Norman Maurer <norman_maurer@apple.com>\r\n","reactions":{"url":"https://api.github.com/repos/netty/netty/issues/12464/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/12464/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":6796153745,"node_id":"REFE_lADOABA-c85KqfxhzwAAAAGVFROR","url":"https://api.github.com/repos/netty/netty/issues/events/6796153745","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"63e299095cdfe2ab160234a3e4892c8882405bef","commit_url":"https://api.github.com/repos/netty/netty/commits/63e299095cdfe2ab160234a3e4892c8882405bef","created_at":"2022-06-13T13:30:31Z","performed_via_github_app":null},{"id":6798083286,"node_id":"REFE_lADOABA-c85KqfxhzwAAAAGVMoTW","url":"https://api.github.com/repos/netty/netty/issues/events/6798083286","actor":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4a8bc5e2e019242c25d0b87424d91027f43e5240","commit_url":"https://api.github.com/repos/netty/netty/commits/4a8bc5e2e019242c25d0b87424d91027f43e5240","created_at":"2022-06-13T17:49:38Z","performed_via_github_app":null},{"id":6956558430,"node_id":"REFE_lADOABA-c85KqfxhzwAAAAGepKhe","url":"https://api.github.com/repos/netty/netty/issues/events/6956558430","actor":{"login":"raidyue","id":2962896,"node_id":"MDQ6VXNlcjI5NjI4OTY=","avatar_url":"https://avatars.githubusercontent.com/u/2962896?v=4","gravatar_id":"","url":"https://api.github.com/users/raidyue","html_url":"https://github.com/raidyue","followers_url":"https://api.github.com/users/raidyue/followers","following_url":"https://api.github.com/users/raidyue/following{/other_user}","gists_url":"https://api.github.com/users/raidyue/gists{/gist_id}","starred_url":"https://api.github.com/users/raidyue/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raidyue/subscriptions","organizations_url":"https://api.github.com/users/raidyue/orgs","repos_url":"https://api.github.com/users/raidyue/repos","events_url":"https://api.github.com/users/raidyue/events{/privacy}","received_events_url":"https://api.github.com/users/raidyue/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"bb9455bec22de1ca1634ac46ad2c8cba3d12fe67","commit_url":"https://api.github.com/repos/raidyue/netty/commits/bb9455bec22de1ca1634ac46ad2c8cba3d12fe67","created_at":"2022-07-08T01:59:14Z","performed_via_github_app":null},{"id":7228438493,"node_id":"REFE_lADOABA-c85KqfxhzwAAAAGu2Tfd","url":"https://api.github.com/repos/netty/netty/issues/events/7228438493","actor":{"login":"franz1981","id":13125299,"node_id":"MDQ6VXNlcjEzMTI1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/13125299?v=4","gravatar_id":"","url":"https://api.github.com/users/franz1981","html_url":"https://github.com/franz1981","followers_url":"https://api.github.com/users/franz1981/followers","following_url":"https://api.github.com/users/franz1981/following{/other_user}","gists_url":"https://api.github.com/users/franz1981/gists{/gist_id}","starred_url":"https://api.github.com/users/franz1981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/franz1981/subscriptions","organizations_url":"https://api.github.com/users/franz1981/orgs","repos_url":"https://api.github.com/users/franz1981/repos","events_url":"https://api.github.com/users/franz1981/events{/privacy}","received_events_url":"https://api.github.com/users/franz1981/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"46fece380a82d93c344ad30a75ac41a3d23a032c","commit_url":"https://api.github.com/repos/franz1981/netty/commits/46fece380a82d93c344ad30a75ac41a3d23a032c","created_at":"2022-08-22T00:33:11Z","performed_via_github_app":null}]