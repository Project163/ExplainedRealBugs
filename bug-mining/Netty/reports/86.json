{"url":"https://api.github.com/repos/netty/netty/issues/9131","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/9131/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/9131/comments","events_url":"https://api.github.com/repos/netty/netty/issues/9131/events","html_url":"https://github.com/netty/netty/issues/9131","id":441114946,"node_id":"MDU6SXNzdWU0NDExMTQ5NDY=","number":9131,"title":"ApplicationProtocolNegotiationHandler loses its place in the context too soon","user":{"login":"RoganDawes","id":159883,"node_id":"MDQ6VXNlcjE1OTg4Mw==","avatar_url":"https://avatars.githubusercontent.com/u/159883?v=4","gravatar_id":"","url":"https://api.github.com/users/RoganDawes","html_url":"https://github.com/RoganDawes","followers_url":"https://api.github.com/users/RoganDawes/followers","following_url":"https://api.github.com/users/RoganDawes/following{/other_user}","gists_url":"https://api.github.com/users/RoganDawes/gists{/gist_id}","starred_url":"https://api.github.com/users/RoganDawes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RoganDawes/subscriptions","organizations_url":"https://api.github.com/users/RoganDawes/orgs","repos_url":"https://api.github.com/users/RoganDawes/repos","events_url":"https://api.github.com/users/RoganDawes/events{/privacy}","received_events_url":"https://api.github.com/users/RoganDawes/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/210","html_url":"https://github.com/netty/netty/milestone/210","labels_url":"https://api.github.com/repos/netty/netty/milestones/210/labels","id":4274617,"node_id":"MDk6TWlsZXN0b25lNDI3NDYxNw==","number":210,"title":"4.1.37.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":102,"state":"closed","created_at":"2019-04-30T16:35:51Z","updated_at":"2019-06-28T09:58:22Z","due_on":null,"closed_at":"2019-06-28T09:58:22Z"},"comments":3,"created_at":"2019-05-07T08:50:59Z","updated_at":"2019-05-13T11:49:18Z","closed_at":"2019-05-13T11:49:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n```\r\n\t@Override\r\n\tprotected void configurePipeline(ChannelHandlerContext ctx, String protocol)\r\n\t\t\tthrows Exception {\r\n\t\tctx.pipeline().replace(this, null, initializer);\r\n\t\t// or\r\n\t\tctx.pipeline().addAfter(this, null, initializer);\r\n\t\t// or\r\n\t\tctx.pipeline().addBefore(this, null, initializer);\r\n\t}\r\n```\r\nshould work, similarly to how a ```ChannelInitializer``` works.\r\n\r\n### Actual behavior\r\nAn exception is thrown on all \"relative\" pipeline operations, because the ApplicationProtocolNegotiationHandler instance has already been removed from the pipeline BEFORE ```configurePipeline()``` is called:\r\n\r\n```ApplicationProtocolNegotiationHandler.java\r\n\r\n    @Override\r\n    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\r\n        if (evt instanceof SslHandshakeCompletionEvent) {\r\n            ctx.pipeline().remove(this); // <-- Removed before calling configurePipeline :-(\r\n\r\n            SslHandshakeCompletionEvent handshakeEvent = (SslHandshakeCompletionEvent) evt;\r\n            if (handshakeEvent.isSuccess()) {\r\n                SslHandler sslHandler = ctx.pipeline().get(SslHandler.class);\r\n                if (sslHandler == null) {\r\n                    throw new IllegalStateException(\"cannot find a SslHandler in the pipeline (requir\r\ned for \" +\r\n                                                    \"application-level protocol negotiation)\");\r\n                }\r\n                String protocol = sslHandler.applicationProtocol();\r\n                configurePipeline(ctx, protocol != null? protocol : fallbackProtocol);\r\n            } else {\r\n                handshakeFailure(ctx, handshakeEvent.cause());\r\n            }\r\n        }\r\n\r\n        ctx.fireUserEventTriggered(evt);\r\n    }\r\n```\r\n\r\nCompare that to Channelinitializer:\r\n\r\n```ChannelInitializer.java\r\n\r\n    @SuppressWarnings(\"unchecked\")\r\n    private boolean initChannel(ChannelHandlerContext ctx) throws Exception {\r\n        if (initMap.add(ctx)) { // Guard against re-entrance.\r\n            try {\r\n                initChannel((C) ctx.channel());\r\n            } catch (Throwable cause) {\r\n                // Explicitly call exceptionCaught(...) as we removed the handler before calling init\r\nChannel(...).\r\n                // We do so to prevent multiple calls to initChannel(...).\r\n                exceptionCaught(ctx, cause);\r\n            } finally {\r\n                ChannelPipeline pipeline = ctx.pipeline();\r\n                if (pipeline.context(this) != null) {\r\n                    pipeline.remove(this);\r\n                }\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n```\r\n\r\nNote that the comment regarding the handler already having been removed in ```Channelinitializer``` is incorrect. See the following excerpt from current code:\r\n\r\n```ChannelInitializer.java\r\n\r\n    /**\r\n     * {@inheritDoc} If override this method ensure you call super!\r\n     */\r\n    @Override\r\n    public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\r\n        if (ctx.channel().isRegistered()) {\r\n            // This should always be true with our current DefaultChannelPipeline implementation.\r\n            // The good thing about calling initChannel(...) in handlerAdded(...) is that there will be no ordering\r\n            // surprises if a ChannelInitializer will add another ChannelInitializer. This is as all handlers\r\n            // will be added in the expected order.\r\n            if (initChannel(ctx)) {\r\n\r\n                // We are done with init the Channel, removing the initializer now.\r\n                removeState(ctx);\r\n            }\r\n        }\r\n    }\r\n```\r\n### Steps to reproduce\r\nUse ```ctx.replace(...)``` in the ```configurePipeline()``` method.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\nNot available.\r\n\r\n### Netty version\r\nnetty-4.1.36.Final\r\n\r\n### JVM version (e.g. `java -version`)\r\njava version \"11.0.1\" 2018-10-16 LTS\r\nJava(TM) SE Runtime Environment 18.9 (build 11.0.1+13-LTS)\r\nJava HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.1+13-LTS, mixed mode)\r\n\r\n### OS version (e.g. `uname -a`)\r\nLinux nemesis 4.15.0-48-generic #51-Ubuntu SMP Wed Apr 3 08:28:49 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/9131/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/9131/timeline","performed_via_github_app":null,"state_reason":"completed"}