{"url":"https://api.github.com/repos/netty/netty/issues/7973","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7973/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7973/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7973/events","html_url":"https://github.com/netty/netty/issues/7973","id":326705108,"node_id":"MDU6SXNzdWUzMjY3MDUxMDg=","number":7973,"title":"WebsocketClientHandshaker can fail if multiple X-Websocket-Key headers are present on the upgrade request","user":{"login":"nicktrav","id":804457,"node_id":"MDQ6VXNlcjgwNDQ1Nw==","avatar_url":"https://avatars.githubusercontent.com/u/804457?v=4","gravatar_id":"","url":"https://api.github.com/users/nicktrav","html_url":"https://github.com/nicktrav","followers_url":"https://api.github.com/users/nicktrav/followers","following_url":"https://api.github.com/users/nicktrav/following{/other_user}","gists_url":"https://api.github.com/users/nicktrav/gists{/gist_id}","starred_url":"https://api.github.com/users/nicktrav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicktrav/subscriptions","organizations_url":"https://api.github.com/users/nicktrav/orgs","repos_url":"https://api.github.com/users/nicktrav/repos","events_url":"https://api.github.com/users/nicktrav/events{/privacy}","received_events_url":"https://api.github.com/users/nicktrav/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/188","html_url":"https://github.com/netty/netty/milestone/188","labels_url":"https://api.github.com/repos/netty/netty/milestones/188/labels","id":3343291,"node_id":"MDk6TWlsZXN0b25lMzM0MzI5MQ==","number":188,"title":"4.1.26.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-05-14T07:38:31Z","updated_at":"2018-07-10T10:23:05Z","due_on":null,"closed_at":"2018-07-10T10:23:05Z"},"comments":2,"created_at":"2018-05-26T03:10:45Z","updated_at":"2018-05-30T17:53:19Z","closed_at":"2018-05-30T17:52:41Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n\r\nA websockets handshake should not fail if a `X-Websockets-Key` header exists in the custom headers passed to the handshaker.\r\n\r\n### Actual behavior\r\n\r\nThe handshake fails if the server picks the incorrect key on which to compute its challenge response (as opposed to the key that is set by the `WebsocketsClientHandshaker`).\r\n\r\n### Steps to reproduce\r\n\r\nUse the `WebsocketsClientHandshaker` to send a request to a websockets server along with passing custom headers that also contain an `X-Websockets-Key` header.\r\n\r\nIf the server happens to pick the _last_ `X-Websockets-Key` in the request headers on which to compute the `X-Websockets-Accept` value, the client handshake will fail with the following, as the `X-Websockets-Accept` value it expects was calculated on the _first_ `X-Websockets-Key`:\r\n\r\n```\r\n20:04:35.727 [nioEventLoopGroup-3-1] WARN  i.n.channel.DefaultChannelPipeline - An exceptionCaught() event was fired, and it reached at the tail of the pipeline. It usually means the last handler in the pipeline did not handle the exception.\r\nio.netty.handler.codec.http.websocketx.WebSocketHandshakeException: Invalid challenge. Actual: w7cyq/iodDhF6MfTw9LCsDqUyBQ=. Expected: +RND8EYF2d5MkuthghnnAyg9DN0=\r\n\tat io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker13.verify(WebSocketClientHandshaker13.java:223)\r\n\tat io.netty.handler.codec.http.websocketx.WebSocketClientHandshaker.finishHandshake(WebSocketClientHandshaker.java:216)\r\n\tat io.netty.handler.codec.http.websocketx.WebSocketClientProtocolHandshakeHandler.channelRead(WebSocketClientProtocolHandshakeHandler.java:57)\r\n... snip ...\r\n```\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nReproducer [here](https://github.com/nicktrav/netty/commit/219d1dd5c00a2d2d92ef8224392f88a2a386668c).\r\n\r\n### Netty version\r\n\r\nHEAD of 4.1 branch, as of 8a8576150.\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\n```\r\n$ java -version\r\njava version \"1.8.0_162\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_162-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)\r\n```\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\n```\r\n$ uname -a\r\nDarwin nickt.local 17.3.0 Darwin Kernel Version 17.3.0: Thu Nov  9 18:09:22 PST 2017; root:xnu-4570.31.3~1/RELEASE_X86_64 x86_64\r\n```","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7973/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7973/timeline","performed_via_github_app":null,"state_reason":"completed"}