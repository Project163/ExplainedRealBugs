{"url":"https://api.github.com/repos/netty/netty/issues/7293","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7293/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7293/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7293/events","html_url":"https://github.com/netty/netty/issues/7293","id":264980534,"node_id":"MDU6SXNzdWUyNjQ5ODA1MzQ=","number":7293,"title":"HttpClientCodec cannot upgrade to TLS according to RFC2817","user":{"login":"pkolaczk","id":1352795,"node_id":"MDQ6VXNlcjEzNTI3OTU=","avatar_url":"https://avatars.githubusercontent.com/u/1352795?v=4","gravatar_id":"","url":"https://api.github.com/users/pkolaczk","html_url":"https://github.com/pkolaczk","followers_url":"https://api.github.com/users/pkolaczk/followers","following_url":"https://api.github.com/users/pkolaczk/following{/other_user}","gists_url":"https://api.github.com/users/pkolaczk/gists{/gist_id}","starred_url":"https://api.github.com/users/pkolaczk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkolaczk/subscriptions","organizations_url":"https://api.github.com/users/pkolaczk/orgs","repos_url":"https://api.github.com/users/pkolaczk/repos","events_url":"https://api.github.com/users/pkolaczk/events{/privacy}","received_events_url":"https://api.github.com/users/pkolaczk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/175","html_url":"https://github.com/netty/netty/milestone/175","labels_url":"https://api.github.com/repos/netty/netty/milestones/175/labels","id":2788859,"node_id":"MDk6TWlsZXN0b25lMjc4ODg1OQ==","number":175,"title":"4.0.53.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":48,"state":"closed","created_at":"2017-09-25T08:49:45Z","updated_at":"2017-11-10T15:07:35Z","due_on":null,"closed_at":"2017-11-09T01:29:43Z"},"comments":3,"created_at":"2017-10-12T15:14:41Z","updated_at":"2017-10-29T12:39:21Z","closed_at":"2017-10-29T12:22:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n1. Client sends an OPTION request with `Connection: Upgrade` and `Upgrade: TLS/1.2` headers. \r\n2. The server installs an `SslHandler`, responds with `HTTP 101 Switching Protocols` and is ready to handle TLS handshake. \r\n3. The client receives `HTTP 101`, installs `SslHandler` which initiates TLS handshake. \r\n4. TLS handshake completes. \r\n5. The server sends the remaining final HTTP 200 response to the client, per requirement 3.3 of RFC2817: \"Once the TLS handshake completes successfully, the server MUST continue with the response to the original request.\" \r\n6. `HttpClientCodec` on the client side receives this response, decodes it and passes it down the pipeline as `HttpResponse` object.\r\n\r\n### Actual behavior\r\nStep 6. is broken.\r\n6. `HttpClientCodec` on the client side receives the response content correctly (see log below), but does not decode it and passes it down the pipeline as a `DirectByteBuf` object. \r\n\r\n```\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,513 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583] CONNECT: localhost/127.0.0.1:6000\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,516 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] ACTIVE\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,516 c.d.b.f.r.c.StartTlsClientHandler (StartTlsClientHandler.scala:45) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] Requesting connection upgrade to TLS/1.2\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,520 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] REGISTERED\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,520 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] ACTIVE\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,533 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] WRITE, DefaultFullHttpRequest(decodeResult: success, version: HTTP/1.1, content: UnpooledByteBufAllocator$In\r\nstrumentedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 0, cap: 0))\r\nOPTIONS /info HTTP/1.1\r\nconnection: upgrade\r\nupgrade: TLS/1.2, 0B\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,535 i.n.u.Recycler (Slf4JLogger.java:76) -Dio.netty.recycler.maxCapacityPerThread: 32768\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,535 i.n.u.Recycler (Slf4JLogger.java:76) -Dio.netty.recycler.maxSharedCapacityFactor: 2\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,535 i.n.u.Recycler (Slf4JLogger.java:76) -Dio.netty.recycler.linkCapacity: 16\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,536 i.n.u.Recycler (Slf4JLogger.java:76) -Dio.netty.recycler.ratio: 8\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,545 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] FLUSH\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,547 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] READ: DefaultHttpRequest(decodeResult: success, version: HTTP/1.1)\r\nOPTIONS /info HTTP/1.1\r\nconnection: upgrade\r\nupgrade: TLS/1.2\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,567 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] READ, EmptyLastHttpContent, 0B\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,568 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] READ COMPLETE\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,568 c.d.b.f.r.s.StartTlsServerHandler (StartTlsServerHandler.scala:51) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] Requested to upgrade connection to TLS/1.2\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,592 i.n.h.s.OpenSsl (Slf4JLogger.java:71) netty-tcnative not in the classpath; OpenSslEngine will be unavailable.\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,655 i.n.h.s.JdkSslContext (Slf4JLogger.java:76) Default protocols (JDK): [TLSv1.2, TLSv1.1, TLSv1]\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,656 i.n.h.s.JdkSslContext (Slf4JLogger.java:76) Default cipher suites (JDK): [TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_GCM_SHA2\r\n56, TLS_RSA_WITH_AES_128_CBC_SHA]\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,657 c.d.b.f.r.s.StartTlsServerHandler (StartTlsServerHandler.scala:58) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] Upgrading connection to TLS/1.2\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,666 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] WRITE, DefaultFullHttpResponse(decodeResult: success, version: HTTP/1.1, content: UnpooledByteBufAllocator$Instrument\r\nedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 0, cap: 0))\r\nHTTP/1.1 101 Switching Protocols\r\nconnection: Upgrade\r\nupgrade: TLS/1.2, HTTP/1.1\r\ncontent-length: 0, 0B\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,668 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] FLUSH\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,670 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] READ: DefaultHttpResponse(decodeResult: success, version: HTTP/1.1)\r\nHTTP/1.1 101 Switching Protocols\r\nconnection: Upgrade\r\nupgrade: TLS/1.2, HTTP/1.1\r\ncontent-length: 0\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,670 c.d.b.f.r.c.StartTlsClientHandler (StartTlsClientHandler.scala:80) Client received: DefaultHttpResponse(decodeResult: success, version: HTTP/1.1)\r\nHTTP/1.1 101 Switching Protocols\r\nconnection: Upgrade\r\nupgrade: TLS/1.2, HTTP/1.1\r\ncontent-length: 0\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,671 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] READ, EmptyLastHttpContent, 0B\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,671 c.d.b.f.r.c.StartTlsClientHandler (StartTlsClientHandler.scala:80) Client received: EmptyLastHttpContent\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,672 c.d.b.f.r.c.StartTlsClientHandler (StartTlsClientHandler.scala:54) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] Upgrading connection to TLS/1.2\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,685 c.d.b.f.r.c.StartTlsClientHandler (StartTlsClientHandler.scala:60) ****** PIPELINE after adding SSL: DefaultChannelPipeline{(SslHandler#0 = io.netty.handler.ssl.SslHandler), (HttpClientCodec#0 = io.netty.handler.codec.h\r\nttp.HttpClientCodec), (LoggingHandler#0 = io.netty.handler.logging.LoggingHandler), (StartTlsClientHandler#0 = com.datastax.bdp.fs.rest.client.StartTlsClientHandler), (StartTlsHandlerSpec$HelloClient$HelloHandler#0 = com.datastax.bdp.fs.rest.StartTlsHandlerSpec$HelloClient$HelloH\r\nandler)}\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,685 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] READ COMPLETE\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,701 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] READ COMPLETE\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,773 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] READ COMPLETE\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,776 i.n.h.s.SslHandler (Slf4JLogger.java:81) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] HANDSHAKEN: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,778 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] USER_EVENT: SslHandshakeCompletionEvent(SUCCESS)\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,778 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] READ COMPLETE\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,778 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] WRITE, DefaultFullHttpResponse(decodeResult: success, version: HTTP/1.1, content: UnpooledByteBufAllocator$Instrument\r\nedUnpooledUnsafeHeapByteBuf(ridx: 0, widx: 0, cap: 0))\r\nHTTP/1.1 200 OK\r\ncontent-length: 0, 0B\r\nTEST   DEBUG  [dsefs-netty-worker-2] 2017-10-12 16:44:28,779 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xceec753c, L:/127.0.0.1:6000 - R:/127.0.0.1:47174] FLUSH\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,779 i.n.h.s.SslHandler (Slf4JLogger.java:81) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] HANDSHAKEN: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,779 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] USER_EVENT: SslHandshakeCompletionEvent(SUCCESS)\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,779 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] READ COMPLETE\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,780 i.n.h.l.LoggingHandler (Slf4JLogger.java:71) [id: 0xabe43583, L:/127.0.0.1:47174 - R:localhost/127.0.0.1:6000] READ: 38B\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 48 54 54 50 2f 31 2e 31 20 32 30 30 20 4f 4b 0d |HTTP/1.1 200 OK.|\r\n|00000010| 0a 63 6f 6e 74 65 6e 74 2d 6c 65 6e 67 74 68 3a |.content-length:|\r\n|00000020| 20 30 0d 0a 0d 0a                               | 0....          |\r\n+--------+-------------------------------------------------+----------------+\r\nTEST   DEBUG  [dsefs-netty-worker-1] 2017-10-12 16:44:28,780 c.d.b.f.r.c.StartTlsClientHandler (StartTlsClientHandler.scala:80) Client received: PooledUnsafeDirectByteBuf(ridx: 0, widx: 38, cap: 38)\r\nTEST    WARN  [dsefs-netty-worker-1] 2017-10-12 16:44:28,785 i.n.c.DefaultChannelPipeline (Slf4JLogger.java:151) An exceptionCaught() event was fired, and it reached at the tail of the pipeline. It usually means the last handler in the pipeline did not handle the exception.\r\njava.lang.IllegalStateException: Received unexpected PooledUnsafeDirectByteBuf(ridx: 0, widx: 38, cap: 38) in state com.datastax.bdp.fs.rest.client.StartTlsClientHandler$State$SwitchingProtocolFullyReceived$@430445ac\r\n        at com.datastax.bdp.fs.rest.client.StartTlsClientHandler.channelRead0(StartTlsClientHandler.scala:121) ~[main/:na]\r\n```\r\n\r\n### Steps to reproduce\r\nProbably requires most of the code I'm writing that is unfortunately closed source. Would have to get permission to post the test.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\n### Netty version\r\nOriginally found in 4.1.13, but the problem exists in recent 4.0.x and 4.1.17 as well.\r\n\r\n### JVM version (e.g. `java -version`)\r\n1.8.0_144\r\n\r\n### OS version (e.g. `uname -a`)\r\nLinux p5520 4.14.0-041400rc4-generic #201710100030 SMP Tue Oct 10 04:31:55 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\nPlease let me know if there is any workaround...","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7293/timeline","performed_via_github_app":null,"state_reason":"completed"}