{"url":"https://api.github.com/repos/netty/netty/issues/14247","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/14247/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/14247/comments","events_url":"https://api.github.com/repos/netty/netty/issues/14247/events","html_url":"https://github.com/netty/netty/issues/14247","id":2480592595,"node_id":"I_kwDOABA-c86T2tbT","number":14247,"title":"Buffer leak remains undetected even with paranoid leak detection","user":{"login":"yawkat","id":2395297,"node_id":"MDQ6VXNlcjIzOTUyOTc=","avatar_url":"https://avatars.githubusercontent.com/u/2395297?v=4","gravatar_id":"","url":"https://api.github.com/users/yawkat","html_url":"https://github.com/yawkat","followers_url":"https://api.github.com/users/yawkat/followers","following_url":"https://api.github.com/users/yawkat/following{/other_user}","gists_url":"https://api.github.com/users/yawkat/gists{/gist_id}","starred_url":"https://api.github.com/users/yawkat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yawkat/subscriptions","organizations_url":"https://api.github.com/users/yawkat/orgs","repos_url":"https://api.github.com/users/yawkat/repos","events_url":"https://api.github.com/users/yawkat/events{/privacy}","received_events_url":"https://api.github.com/users/yawkat/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/296","html_url":"https://github.com/netty/netty/milestone/296","labels_url":"https://api.github.com/repos/netty/netty/milestones/296/labels","id":11336379,"node_id":"MI_kwDOABA-c84ArPq7","number":296,"title":"4.1.113.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":19,"state":"closed","created_at":"2024-07-19T17:38:34Z","updated_at":"2024-09-04T15:11:00Z","due_on":null,"closed_at":"2024-09-04T15:11:00Z"},"comments":1,"created_at":"2024-08-22T11:51:55Z","updated_at":"2024-08-23T07:27:03Z","closed_at":"2024-08-23T07:26:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I am using paranoid leak detection for tests. We have [some code](https://github.com/micronaut-projects/micronaut-core/blob/4.6.x/http-server-netty/src/test/groovy/io/micronaut/http/server/netty/fuzzing/BufferLeakDetection.groovy#L57) to trigger GC and thus leak detection between each test. It is similar to the [code netty uses](https://github.com/netty/netty/blob/86603872776e3ff5a60dea3c104358e486eed588/common/src/test/java/io/netty/util/ResourceLeakDetectorTest.java) for this purpose, but with one key difference: The \"canary\" object that is intentionally leaked is a normal pooled ByteBuf in our code instead of a class made just for that purpose. Now, in some tests, it appears that this canary buffer leak is never detected, leading to timeouts.\r\n\r\nI've done some debugging, and the cause seems to be that netty actually retains internal references to the buffer:\r\n\r\n![image](https://github.com/user-attachments/assets/81af4bdc-6deb-4aeb-b5ff-17cb63ddbac1)\r\n\r\nYou can see that there is the usual reference through DefaultResourceLeak (which extends WeakReference so it's fine), but also a reference through Recycler.DefaultHandle.\r\n\r\nI believe that the canary buffer in question was created through `PooledUnsafeDirectByteBuf.RECYCLER`, but the recycler does not clean up its own references to the pool. I guess that the MPSC queue simply does not set the reference to null in its internal array.\r\n\r\nThis behavior is against the spirit of paranoid leak detection. It could prevent some buffer leaks from being detected. One solution would be to disable the recycler when leak detection is set to paranoid.\r\n\r\nHowever this could also be a problem for non-paranoid leak detection. It is conceivable that some leaks systematically only happen in places where the recycler retains a reference. Thus they could escape from random sampling even in the long term. For this reason I would prefer a solution that applies to all leak detection modes, probably by clearing the reference in the MPSC queue.\r\n\r\nI cannot provide a minimal reproducer, unfortunately. The test is [this one](https://github.com/micronaut-projects/micronaut-core/blob/4.6.x/http-server-netty/src/test/groovy/io/micronaut/http/server/netty/handler/Http2ServerHandlerSpec.groovy#L154). If you need me to debug this further, LMK.\r\n\r\n### Netty version\r\n\r\n4.1.111\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\nOpenJDK 17\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\nLinux","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/14247/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/14247/timeline","performed_via_github_app":null,"state_reason":"completed"}