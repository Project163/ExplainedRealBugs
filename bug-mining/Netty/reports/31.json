{"url":"https://api.github.com/repos/netty/netty/issues/7194","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7194/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7194/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7194/events","html_url":"https://github.com/netty/netty/issues/7194","id":256111307,"node_id":"MDU6SXNzdWUyNTYxMTEzMDc=","number":7194,"title":"useCacheForAllThreads no longer seems to work.","user":{"login":"carl-mastrangelo","id":8943572,"node_id":"MDQ6VXNlcjg5NDM1NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8943572?v=4","gravatar_id":"","url":"https://api.github.com/users/carl-mastrangelo","html_url":"https://github.com/carl-mastrangelo","followers_url":"https://api.github.com/users/carl-mastrangelo/followers","following_url":"https://api.github.com/users/carl-mastrangelo/following{/other_user}","gists_url":"https://api.github.com/users/carl-mastrangelo/gists{/gist_id}","starred_url":"https://api.github.com/users/carl-mastrangelo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/carl-mastrangelo/subscriptions","organizations_url":"https://api.github.com/users/carl-mastrangelo/orgs","repos_url":"https://api.github.com/users/carl-mastrangelo/repos","events_url":"https://api.github.com/users/carl-mastrangelo/events{/privacy}","received_events_url":"https://api.github.com/users/carl-mastrangelo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"carl-mastrangelo","id":8943572,"node_id":"MDQ6VXNlcjg5NDM1NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8943572?v=4","gravatar_id":"","url":"https://api.github.com/users/carl-mastrangelo","html_url":"https://github.com/carl-mastrangelo","followers_url":"https://api.github.com/users/carl-mastrangelo/followers","following_url":"https://api.github.com/users/carl-mastrangelo/following{/other_user}","gists_url":"https://api.github.com/users/carl-mastrangelo/gists{/gist_id}","starred_url":"https://api.github.com/users/carl-mastrangelo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/carl-mastrangelo/subscriptions","organizations_url":"https://api.github.com/users/carl-mastrangelo/orgs","repos_url":"https://api.github.com/users/carl-mastrangelo/repos","events_url":"https://api.github.com/users/carl-mastrangelo/events{/privacy}","received_events_url":"https://api.github.com/users/carl-mastrangelo/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/172","html_url":"https://github.com/netty/netty/milestone/172","labels_url":"https://api.github.com/repos/netty/netty/milestones/172/labels","id":2720452,"node_id":"MDk6TWlsZXN0b25lMjcyMDQ1Mg==","number":172,"title":"4.0.52.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":34,"state":"closed","created_at":"2017-08-24T09:04:52Z","updated_at":"2017-09-26T17:26:04Z","due_on":null,"closed_at":"2017-09-25T08:50:58Z"},"comments":1,"created_at":"2017-09-08T00:54:08Z","updated_at":"2017-09-08T08:22:14Z","closed_at":"2017-09-08T08:21:09Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While playing with jvm flags to control memory pooling, I noticed `io.netty.allocator.useCacheForAllThreads`.  From reading the source, it seems to control whether or not buffers are cached per thread.\r\n\r\nHowever, setting it to false and using the default allocator causes lots of exceptions to be thrown:\r\n\r\n```\r\n\r\njava.lang.IllegalArgumentException: freeSweepAllocationThreshold: 0 (expected: > 0)\r\n\tat io.netty.buffer.PoolThreadCache.<init>(PoolThreadCache.java:75)\r\n\tat io.netty.buffer.PooledByteBufAllocator$PoolThreadLocalCache.initialValue(PooledByteBufAllocator.java:430)\r\n\tat io.netty.buffer.PooledByteBufAllocator$PoolThreadLocalCache.initialValue(PooledByteBufAllocator.java:412)\r\n\tat io.netty.util.concurrent.FastThreadLocal.initialize(FastThreadLocal.java:155)\r\n\tat io.netty.util.concurrent.FastThreadLocal.get(FastThreadLocal.java:149)\r\n\tat io.netty.util.concurrent.FastThreadLocal.get(FastThreadLocal.java:135)\r\n\tat io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:319)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:181)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:172)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.buffer(AbstractByteBufAllocator.java:109)\r\n\t...\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\n\r\n```\r\n\r\n\r\n\r\n\r\nHere is the debug output for start up\r\n```\r\n\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.logging.InternalLoggerFactory newDefaultFactory\r\nFINE: Using java.util.logging as the default logging framework\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 explicitNoUnsafe0\r\nFINE: -Dio.netty.noUnsafe: false\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 javaVersion0\r\nFINE: Java version: 8\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: sun.misc.Unsafe.theUnsafe: available\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: sun.misc.Unsafe.copyMemory: available\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: java.nio.Buffer.address: available\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: direct buffer constructor: available\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: java.nio.Bits.unaligned: available, true\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: jdk.internal.misc.Unsafe.allocateUninitializedArray(int): unavailable prior to Java9\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent0 <clinit>\r\nFINE: java.nio.DirectByteBuffer.<init>(long, int): available\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent hasUnsafe0\r\nFINE: sun.misc.Unsafe: available\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent tmpdir0\r\nFINE: -Dio.netty.tmpdir: /tmp (java.io.tmpdir)\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent bitMode0\r\nFINE: -Dio.netty.bitMode: 64 (sun.arch.data.model)\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent <clinit>\r\nFINE: -Dio.netty.noPreferDirect: false\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent <clinit>\r\nFINE: -Dio.netty.maxDirectMemory: 8125284352 bytes\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent <clinit>\r\nFINE: -Dio.netty.uninitializedArrayAllocationThreshold: -1\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.CleanerJava6 <clinit>\r\nFINE: java.nio.ByteBuffer.cleaner(): available\r\nSep 07, 2017 5:45:48 PM io.netty.channel.MultithreadEventLoopGroup <clinit>\r\nFINE: -Dio.netty.eventLoopThreads: 24\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.NativeLibraryLoader <clinit>\r\nFINE: -Dio.netty.native.workdir: /tmp (io.netty.tmpdir)\r\nSep 07, 2017 5:45:48 PM io.netty.util.NetUtil <clinit>\r\nFINE: -Djava.net.preferIPv4Stack: false\r\nSep 07, 2017 5:45:48 PM io.netty.util.NetUtil <clinit>\r\nFINE: -Djava.net.preferIPv6Addresses: false\r\nSep 07, 2017 5:45:48 PM io.netty.util.NetUtil <clinit>\r\nFINE: Loopback interface: lo (lo, 0:0:0:0:0:0:0:1%lo)\r\nSep 07, 2017 5:45:48 PM io.netty.util.NetUtil$1 run\r\nFINE: /proc/sys/net/core/somaxconn: 128\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.NativeLibraryLoader load\r\nFINE: netty_transport_native_epoll was loaded from java.libary.path\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.PlatformDependent$Mpsc <clinit>\r\nFINE: org.jctools-core.MpscChunkedArrayQueue: available\r\nSep 07, 2017 5:45:48 PM io.netty.channel.DefaultChannelId <clinit>\r\nFINE: -Dio.netty.processId: 11488 (auto-detected)\r\nSep 07, 2017 5:45:48 PM io.netty.channel.DefaultChannelId <clinit>\r\nFINE: -Dio.netty.machineId: ec:b1:d7:ff:fe:2c:87:92 (auto-detected)\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.InternalThreadLocalMap <clinit>\r\nFINE: -Dio.netty.threadLocalMap.stringBuilder.initialSize: 1024\r\nSep 07, 2017 5:45:48 PM io.netty.util.internal.InternalThreadLocalMap <clinit>\r\nFINE: -Dio.netty.threadLocalMap.stringBuilder.maxSize: 4096\r\nSep 07, 2017 5:45:48 PM io.netty.util.ResourceLeakDetector <clinit>\r\nFINE: -Dio.netty.leakDetection.level: simple\r\nSep 07, 2017 5:45:48 PM io.netty.util.ResourceLeakDetector <clinit>\r\nFINE: -Dio.netty.leakDetection.maxRecords: 4\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.numHeapArenas: 24\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.numDirectArenas: 24\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.pageSize: 8192\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.maxOrder: 11\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.chunkSize: 16777216\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.tinyCacheSize: 512\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.smallCacheSize: 256\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.normalCacheSize: 64\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.maxCachedBufferCapacity: 32768\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.cacheTrimInterval: 8192\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.PooledByteBufAllocator <clinit>\r\nFINE: -Dio.netty.allocator.useCacheForAllThreads: false\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.ByteBufUtil <clinit>\r\nFINE: -Dio.netty.allocator.type: pooled\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.ByteBufUtil <clinit>\r\nFINE: -Dio.netty.threadLocalDirectBufferSize: 65536\r\nSep 07, 2017 5:45:48 PM io.netty.buffer.ByteBufUtil <clinit>\r\nFINE: -Dio.netty.maxThreadLocalCharBufferSize: 16384\r\n```\r\n\r\n### Netty version\r\n4.1.15\r\n\r\n### JVM version (e.g. `java -version`)\r\n1.8.0_112\r\n\r\n### OS version (e.g. `uname -a`)\r\n4.4.0-83-generic","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7194/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7194/timeline","performed_via_github_app":null,"state_reason":"completed"}