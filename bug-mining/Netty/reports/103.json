{"url":"https://api.github.com/repos/netty/netty/issues/9362","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/9362/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/9362/comments","events_url":"https://api.github.com/repos/netty/netty/issues/9362/events","html_url":"https://github.com/netty/netty/issues/9362","id":467665188,"node_id":"MDU6SXNzdWU0Njc2NjUxODg=","number":9362,"title":"Shutdown race in EpollEventLoop","user":{"login":"carl-mastrangelo","id":8943572,"node_id":"MDQ6VXNlcjg5NDM1NzI=","avatar_url":"https://avatars.githubusercontent.com/u/8943572?v=4","gravatar_id":"","url":"https://api.github.com/users/carl-mastrangelo","html_url":"https://github.com/carl-mastrangelo","followers_url":"https://api.github.com/users/carl-mastrangelo/followers","following_url":"https://api.github.com/users/carl-mastrangelo/following{/other_user}","gists_url":"https://api.github.com/users/carl-mastrangelo/gists{/gist_id}","starred_url":"https://api.github.com/users/carl-mastrangelo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/carl-mastrangelo/subscriptions","organizations_url":"https://api.github.com/users/carl-mastrangelo/orgs","repos_url":"https://api.github.com/users/carl-mastrangelo/repos","events_url":"https://api.github.com/users/carl-mastrangelo/events{/privacy}","received_events_url":"https://api.github.com/users/carl-mastrangelo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"njhill","id":16958488,"node_id":"MDQ6VXNlcjE2OTU4NDg4","avatar_url":"https://avatars.githubusercontent.com/u/16958488?v=4","gravatar_id":"","url":"https://api.github.com/users/njhill","html_url":"https://github.com/njhill","followers_url":"https://api.github.com/users/njhill/followers","following_url":"https://api.github.com/users/njhill/following{/other_user}","gists_url":"https://api.github.com/users/njhill/gists{/gist_id}","starred_url":"https://api.github.com/users/njhill/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/njhill/subscriptions","organizations_url":"https://api.github.com/users/njhill/orgs","repos_url":"https://api.github.com/users/njhill/repos","events_url":"https://api.github.com/users/njhill/events{/privacy}","received_events_url":"https://api.github.com/users/njhill/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"njhill","id":16958488,"node_id":"MDQ6VXNlcjE2OTU4NDg4","avatar_url":"https://avatars.githubusercontent.com/u/16958488?v=4","gravatar_id":"","url":"https://api.github.com/users/njhill","html_url":"https://github.com/njhill","followers_url":"https://api.github.com/users/njhill/followers","following_url":"https://api.github.com/users/njhill/following{/other_user}","gists_url":"https://api.github.com/users/njhill/gists{/gist_id}","starred_url":"https://api.github.com/users/njhill/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/njhill/subscriptions","organizations_url":"https://api.github.com/users/njhill/orgs","repos_url":"https://api.github.com/users/njhill/repos","events_url":"https://api.github.com/users/njhill/events{/privacy}","received_events_url":"https://api.github.com/users/njhill/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/216","html_url":"https://github.com/netty/netty/milestone/216","labels_url":"https://api.github.com/repos/netty/netty/milestones/216/labels","id":4653328,"node_id":"MDk6TWlsZXN0b25lNDY1MzMyOA==","number":216,"title":"4.1.42.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":25,"state":"closed","created_at":"2019-09-12T08:34:34Z","updated_at":"2019-09-25T12:01:43Z","due_on":null,"closed_at":"2019-09-25T12:01:43Z"},"comments":7,"created_at":"2019-07-13T03:43:14Z","updated_at":"2019-09-23T13:31:07Z","closed_at":"2019-09-05T06:56:26Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In 4.1.38, there is an fd race in EpollEventLoop.  The loop thread, while trying to shutdown, closes the eventFd.    The outside thread that calls shutdownGracefully, tries to wake up the loop to notice that it wants it to shutdown.   There is a race where the wakeup() call can write to an eventfd that has been closed already, resulting in the possibility of writing to the wrong fd.\r\n\r\nThe sequence of events loops like:\r\n\r\n1.  T1:  eventLoop.shutdownGracefully()\r\n2.  T1:  state = ST_SHUTDOWN\r\n2.  T2:  reads state == ST_SHUTDOWN\r\n2.  T1:  Enters  EpollEventLoop.wakeup()\r\n2.  T2:  Exits loop, enters EpollEventLoop.cleanup() \r\n2.  T2:  Closes eventFd.\r\n2.  T1: Wins race to by setting wakenUp to 1\r\n2.  T1: Calls Native.eventFdWrite(eventFd.intValue(), 1L);\r\n\r\n\r\n\r\n\r\nThe easiest way I can see to fix this race is to use a synchronized block in wakeup(), after the thread has won the wakenUp = 1 race:\r\n\r\n```java\r\n    @Override\r\n    protected void wakeup(boolean inEventLoop) {\r\n        if (!inEventLoop && WAKEN_UP_UPDATER.getAndIncrement(this) == 0) {\r\n            // write to the evfd which will then wake-up epoll_wait(...)\r\n            synchronized (eventFd) {\r\n                if (!isShutdown()) {\r\n                    Native.eventFdWrite(eventFd.intValue(), 1L);\r\n                }\r\n            }\r\n        }\r\n    }\r\n```\r\n\r\n Additionally, in EpollEventLoop.cleanup, acquire a lock before closing the eventFd, synchronize the close:\r\n\r\n```java\r\n            synchronized (eventFd) {\r\n                try {\r\n                    eventFd.close();\r\n                } catch (IOException e) {\r\n                    logger.warn(\"Failed to close the event fd.\", e);\r\n                }\r\n            }\r\n```\r\n\r\n\r\n\r\nThis is kind of unfortunate, but the race makes it possible that another FD is opened after closing the eventFd, and the wakeUp call writes to the wrong FD.  The main downside of my proposed patch is probably the risk of deadlocks (because I dont know what locks I hold), as well as some performance penalty.   \r\n\r\n\r\nIdeas on how to not pay this cost are welcome, but I think the danger is enough to merit fixing this.\r\n\r\ncc @ejona86 @normanmaurer ","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/9362/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/9362/timeline","performed_via_github_app":null,"state_reason":"completed"}