{"url":"https://api.github.com/repos/netty/netty/issues/8962","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/8962/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/8962/comments","events_url":"https://api.github.com/repos/netty/netty/issues/8962/events","html_url":"https://github.com/netty/netty/issues/8962","id":423518541,"node_id":"MDU6SXNzdWU0MjM1MTg1NDE=","number":8962,"title":"netty-resolver-dns \"Got bad packet: bad label type\"","user":{"login":"nzhenry","id":2903700,"node_id":"MDQ6VXNlcjI5MDM3MDA=","avatar_url":"https://avatars.githubusercontent.com/u/2903700?v=4","gravatar_id":"","url":"https://api.github.com/users/nzhenry","html_url":"https://github.com/nzhenry","followers_url":"https://api.github.com/users/nzhenry/followers","following_url":"https://api.github.com/users/nzhenry/following{/other_user}","gists_url":"https://api.github.com/users/nzhenry/gists{/gist_id}","starred_url":"https://api.github.com/users/nzhenry/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nzhenry/subscriptions","organizations_url":"https://api.github.com/users/nzhenry/orgs","repos_url":"https://api.github.com/users/nzhenry/repos","events_url":"https://api.github.com/users/nzhenry/events{/privacy}","received_events_url":"https://api.github.com/users/nzhenry/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/212","html_url":"https://github.com/netty/netty/milestone/212","labels_url":"https://api.github.com/repos/netty/netty/milestones/212/labels","id":4448236,"node_id":"MDk6TWlsZXN0b25lNDQ0ODIzNg==","number":212,"title":"4.1.38.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":54,"state":"closed","created_at":"2019-06-28T08:02:27Z","updated_at":"2019-07-24T19:09:13Z","due_on":null,"closed_at":"2019-07-24T17:15:23Z"},"comments":9,"created_at":"2019-03-20T23:37:47Z","updated_at":"2019-07-02T17:42:06Z","closed_at":"2019-07-02T17:38:51Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have built a simple DNS proxy server using the Netty DNS resolver library. [See the code here.](https://github.com/nzhenry/dns-proxy)\r\n\r\nIt works for most queries but not all. For example, when I try to query the A records for \"www.apple.com\" using nslookup or dig, it fails intermittently with this error:\r\n```;; Got bad packet: bad label type\r\n305 bytes\r\nca 20 80 00 00 01 00 04 00 00 00 01 03 77 77 77          .............www\r\n05 61 70 70 6c 65 03 63 6f 6d 00 00 01 00 01 03          .apple.com......\r\n77 77 77 05 61 70 70 6c 65 03 63 6f 6d 00 00 05          www.apple.com...\r\n00 01 00 00 00 37 00 1b 03 77 77 77 05 61 70 70          .....7...www.app\r\n6c 65 03 63 6f 6d 07 65 64 67 65 6b 65 79 03 6e          le.com.edgekey.n\r\n65 74 00 03 77 77 77 05 61 70 70 6c 65 03 63 6f          et..www.apple.co\r\n6d 07 65 64 67 65 6b 65 79 03 6e 65 74 00 00 05          m.edgekey.net...\r\n00 01 00 00 30 2b 00 2f 03 77 77 77 05 61 70 70          ....0+./.www.app\r\n6c 65 03 63 6f 6d 07 65 64 67 65 6b 65 79 03 6e          le.com.edgekey.n\r\n65 74 0b 67 6c 6f 62 61 6c 72 65 64 69 72 06 61          et.globalredir.a\r\n6b 61 64 6e 73 c0 41 03 77 77 77 05 61 70 70 6c          kadns.A.www.appl\r\n65 03 63 6f 6d 07 65 64 67 65 6b 65 79 03 6e 65          e.com.edgekey.ne\r\n74 0b 67 6c 6f 62 61 6c 72 65 64 69 72 06 61 6b          t.globalredir.ak\r\n61 64 6e 73 03 6e 65 74 00 00 05 00 01 00 00 0c          adns.net........\r\nb7 00 19 05 65 36 38 35 38 05 64 73 63 65 39 0a          ....e6858.dsce9.\r\n61 6b 61 6d 61 69 65 64 67 65 c0 41 05 65 36 38          akamaiedge.A.e68\r\n35 38 05 64 73 63 65 39 0a 61 6b 61 6d 61 69 65          58.dsce9.akamaie\r\n64 67 65 03 6e 65 74 00 00 01 00 01 00 00 00 11          dge.net.........\r\n00 04 68 5f a0 7e 00 00 29 10 00 00 00 00 00 00          ..h_....).......\r\n00                                                       .\r\n```\r\nWhen it fails the debug log looks like this:\r\n```DefaultDnsQuestion(www.apple.com. IN A)\r\nDefaultDnsRawRecord(www.apple.com. 885 IN CNAME 27B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net. 10239 IN CNAME 47B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net.globalredir.akadns.net. 441 IN CNAME 25B)\r\nDefaultDnsRawRecord(e6858.dsce9.akamaiedge.net. 9 IN A 4B)] RECEIVED: [[[id: 0xc9dafb10], 36804, /192.168.1.1:53, DatagramDnsResponse(from: /192.168.1.1:53, to: /0:0:0:0:0:0:0:0:51678, 36804, QUERY(0), NoError(0), RD RA)\r\nDefaultDnsQuestion(www.apple.com. IN A)\r\nDefaultDnsRawRecord(www.apple.com. 885 IN CNAME 27B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net. 10239 IN CNAME 47B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net.globalredir.akadns.net. 441 IN CNAME 25B)\r\nDefaultDnsRawRecord(e6858.dsce9.akamaiedge.net. 9 IN A 4B)]: {}], {}\r\n```\r\nWhen it succeeds the log looks like this:\r\n```DefaultDnsQuestion(www.apple.com. IN A)\r\nDefaultDnsRawRecord(www.apple.com. 881 IN CNAME 27B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net. 10235 IN CNAME 50B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net.globalredir.akadns.net. 437 IN CNAME 28B)\r\nDefaultDnsRawRecord(e6858.dsce9.akamaiedge.net. 5 IN A 4B)\r\nDefaultDnsRawRecord(OPT flags:0 udp:4096 0B)] RECEIVED: [[[id: 0xc9dafb10], 37086, /192.168.1.1:53, DatagramDnsResponse(from: /192.168.1.1:53, to: /0:0:0:0:0:0:0:0:51678, 37086, QUERY(0), NoError(0), RD RA)\r\nDefaultDnsQuestion(www.apple.com. IN A)\r\nDefaultDnsRawRecord(www.apple.com. 881 IN CNAME 27B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net. 10235 IN CNAME 50B)\r\nDefaultDnsRawRecord(www.apple.com.edgekey.net.globalredir.akadns.net. 437 IN CNAME 28B)\r\nDefaultDnsRawRecord(e6858.dsce9.akamaiedge.net. 5 IN A 4B)\r\nDefaultDnsRawRecord(OPT flags:0 udp:4096 0B)]: {}], {}\r\n```\r\nNotice the additional OPT record when it succeeds. This appears to be the key. I just don't know how I can fix the problem when it fails.\r\n\r\nI've discovered that if I remove the CNAME records from the response, then the query resolves with no errors. I would like to return a proper copy of the server response including the CNAME records. Any help would be greatly appreciated!","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/8962/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/8962/timeline","performed_via_github_app":null,"state_reason":"completed"}