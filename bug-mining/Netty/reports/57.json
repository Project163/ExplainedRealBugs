{"url":"https://api.github.com/repos/netty/netty/issues/7654","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7654/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7654/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7654/events","html_url":"https://github.com/netty/netty/issues/7654","id":292759422,"node_id":"MDU6SXNzdWUyOTI3NTk0MjI=","number":7654,"title":"Determination of MAX_DIRECT_MEMORY in io.netty.util.internal.PlatformDependent fails on z/OS","user":{"login":"jo-kin","id":24566761,"node_id":"MDQ6VXNlcjI0NTY2NzYx","avatar_url":"https://avatars.githubusercontent.com/u/24566761?v=4","gravatar_id":"","url":"https://api.github.com/users/jo-kin","html_url":"https://github.com/jo-kin","followers_url":"https://api.github.com/users/jo-kin/followers","following_url":"https://api.github.com/users/jo-kin/following{/other_user}","gists_url":"https://api.github.com/users/jo-kin/gists{/gist_id}","starred_url":"https://api.github.com/users/jo-kin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jo-kin/subscriptions","organizations_url":"https://api.github.com/users/jo-kin/orgs","repos_url":"https://api.github.com/users/jo-kin/repos","events_url":"https://api.github.com/users/jo-kin/events{/privacy}","received_events_url":"https://api.github.com/users/jo-kin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":185727,"node_id":"MDU6TGFiZWwxODU3Mjc=","url":"https://api.github.com/repos/netty/netty/labels/defect","name":"defect","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/188","html_url":"https://github.com/netty/netty/milestone/188","labels_url":"https://api.github.com/repos/netty/netty/milestones/188/labels","id":3343291,"node_id":"MDk6TWlsZXN0b25lMzM0MzI5MQ==","number":188,"title":"4.1.26.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":101,"state":"closed","created_at":"2018-05-14T07:38:31Z","updated_at":"2018-07-10T10:23:05Z","due_on":null,"closed_at":"2018-07-10T10:23:05Z"},"comments":14,"created_at":"2018-01-30T12:08:15Z","updated_at":"2018-05-25T12:35:33Z","closed_at":"2018-05-25T12:35:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n MAX_DIRECT_MEMORY, which controls later behaviour of Netty , should be initialized with correct value.\r\n\r\n### Actual behavior\r\nOn z/OS netty initializes this value with 64M, even the direct accessible memory is actually unbounded.\r\n\r\nReason is the way, how the IBM Java VM administrates direct memory. \r\nThe Windows- or Linux-based VMs report the correct final value asking the corresponding APIs , i.e. sun.misc.VM.maxDirectMemory(().\r\nBut the IBM JVM on z/OS returns here just the initial start value for accessible direct memory, 64MB, even this is not the final limit. (see [https://www.ibm.com/support/knowledgecenter/en/SSYKE2_8.0.0/com.ibm.java.zos.80.doc/diag/appendixes/cmdline/xxmaxdirectmemorysize.html](url)\r\nThe IBM JVM increments this value on demand in 32MB steps.\r\n\r\nNetty asks only once in a static initializer for this value and, for z/OS, erroneously assumes, that would be the final value. \r\nThe so unnecessarily bounded value of 64M leads finally to \r\n> io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 16921 byte(s) of direct \r\n memory (used: 67092277, max: 67108864)\r\n at io.netty.util.internal.PlatformDependent.incrementMemoryCounter(PlatformDependent.java:615)\r\n\r\nConclusion: on z/OS the used APIs offer not the desired correct value for available direct memory.\r\n\r\nSuggested solution:\r\nthe heuristic in io.netty.util.internal.PlatformDependent.maxDirectMemory0() has to consider the System.os. In case of z/OS the first try with sun.misc.VM.maxDirectMemory() is to skip. the following search for -XX:MaxDirectMemorySize or Runtime.maxMem() may offer the correct value.\r\n\r\nby the way: limit the available direct memory with -XX:MaxDirectMemorySize=512M helps as workarround. Adding this argument at start the IBM VM returns 512M as initial value which is quite the correct final value.\r\n\r\n### Steps to reproduce\r\nrun added code on z/OS\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\nThis code is a copy of  io.netty.util.internal.PlatformDependent.maxDirectMemory0(), \r\nneeded method added, Shortcuts removed, some System.out.println() added.\r\n\r\n```\r\nimport java.lang.reflect.Method;\r\nimport java.security.AccessController;\r\nimport java.security.PrivilegedAction;\r\nimport java.util.List;\r\nimport java.util.regex.Matcher;\r\nimport java.util.regex.Pattern;\r\n\r\npublic class JVMMaxDirectMemory\r\n{\r\n   private static final Pattern MAX_DIRECT_MEMORY_SIZE_ARG_PATTERN = Pattern.compile(\r\n      \"\\\\s*-XX:MaxDirectMemorySize\\\\s*=\\\\s*([0-9]+)\\\\s*([kKmMgG]?)\\\\s*$\");\r\n\r\n   public static void main(String[] args)\r\n   {\r\n      long mem = maxDirectMemory0();\r\n   }\r\n\r\n   private static long maxDirectMemory0()\r\n   {\r\n      ClassLoader systemClassLoader = null;\r\n      try\r\n      {\r\n         // Try to get from sun.misc.VM.maxDirectMemory() which should be most accurate.\r\n         systemClassLoader = getSystemClassLoader();\r\n         Class<?> vmClass = Class.forName(\"sun.misc.VM\", true, systemClassLoader);\r\n         Method m = vmClass.getDeclaredMethod(\"maxDirectMemory\");\r\n         long maxDirectMemory = ((Number) m.invoke(null)).longValue();\r\n         System.out.println(\"invoking sun.misc.VM.maxDirectMemory() offers: \" + maxDirectMemory);\r\n      }\r\n      catch (Throwable ignored)\r\n      {\r\n         System.out.println(\"invoking sun.misc.VM.maxDirectMemory() fails with: \" + ignored.toString());\r\n      }\r\n\r\n      try\r\n      {\r\n         // Now try to get the JVM option (-XX:MaxDirectMemorySize) and parse it.\r\n         // Note that we are using reflection because Android doesn't have these classes.\r\n         Class<?> mgmtFactoryClass = Class.forName(\r\n            \"java.lang.management.ManagementFactory\", true, systemClassLoader);\r\n         Class<?> runtimeClass = Class.forName(\r\n            \"java.lang.management.RuntimeMXBean\", true, systemClassLoader);\r\n\r\n         Object runtime = mgmtFactoryClass.getDeclaredMethod(\"getRuntimeMXBean\").invoke(null);   \r\n         List<String> vmArgs = (List<String>) runtimeClass.getDeclaredMethod(\"getInputArguments\").invoke(runtime);\r\n\r\n         for (int i = vmArgs.size() - 1; i >= 0; i--)\r\n         {\r\n            Matcher m = MAX_DIRECT_MEMORY_SIZE_ARG_PATTERN.matcher(vmArgs.get(i));\r\n            if (!m.matches())\r\n            {\r\n               continue;\r\n            }\r\n\r\n            long maxDirectMemory = Long.parseLong(m.group(1));\r\n            switch (m.group(2).charAt(0))\r\n            {\r\n               case 'k':\r\n               case 'K':\r\n                  maxDirectMemory *= 1024;\r\n                  break;\r\n               case 'm':\r\n               case 'M':\r\n                  maxDirectMemory *= 1024 * 1024;\r\n                  break;\r\n               case 'g':\r\n               case 'G':\r\n                  maxDirectMemory *= 1024 * 1024 * 1024;\r\n                  break;\r\n            }\r\n           System.out.println(\"invoking java.lang.management.RuntimeMXBean.getInputArguments() offers: \" + maxDirectMemory);\r\n            break;\r\n         }       \r\n      }\r\n      catch (Throwable ignored)\r\n      {\r\n         System.out.println(\"invoking java.lang.management.RuntimeMXBean.getInputArguments() fails with: \" + ignored.toString());\r\n      }\r\n\r\n      long maxDirectMemory = Runtime.getRuntime().maxMemory();\r\n      System.out.println(\"invoking Runtime.getRuntime().maxMemory() offers: \" + maxDirectMemory);\r\n\r\n      return maxDirectMemory;\r\n   }\r\n\r\n   static ClassLoader getSystemClassLoader()\r\n   {\r\n      if (System.getSecurityManager() == null)\r\n      {\r\n         return ClassLoader.getSystemClassLoader();\r\n      }\r\n      else\r\n      {\r\n         return AccessController.doPrivileged(new PrivilegedAction<ClassLoader>()\r\n         {\r\n            @Override\r\n            public ClassLoader run()\r\n            {\r\n               return ClassLoader.getSystemClassLoader();\r\n            }\r\n         });\r\n      }\r\n   }\r\n```\r\n\r\nOutput:\r\n\r\n> \r\n>  WINDOWS:\r\n> --------------\r\n> java -cp . JVMMaxDirectMemory\r\n> invoking sun.misc.VM.maxDirectMemory() offers: 1882718208\r\n> invoking java.lang.management.RuntimeMXBean.getInputArguments() offers: 1882718208\r\n> invoking Runtime.getRuntime().maxMemory() offers: 1882718208\r\n> \r\n> z/OS:\r\n> --------------\r\n> $ java -cp . JVMMaxDirectMemory\r\n> invoking sun.misc.VM.maxDirectMemory() offers: 67108864\r\n> invoking java.lang.management.RuntimeMXBean.getInputArguments() offers: 67108864\r\n> invoking Runtime.getRuntime().maxMemory() offers: 536870912\r\n> \r\n> z/OS plus -XX:MaxDirectMemorySize:\r\n> ---------------------------------\r\n> $ java -XX:MaxDirectMemorySize=250M -cp . JVMMaxDirectMemory\r\n> invoking sun.misc.VM.maxDirectMemory() offers: 262144000\r\n> invoking java.lang.management.RuntimeMXBean.getInputArguments() offers: 262144000\r\n> invoking Runtime.getRuntime().maxMemory() offers: 536870912\r\n\r\n### Netty version\r\noccured with 4.1.13, but involved code is unchanged until 4.1.20\r\n\r\n### JVM version (e.g. `java -version`)\r\n$ java -version\r\njava version \"1.7.0\"\r\nJava(TM) SE Runtime Environment (build pmz3170_27sr3fp40-20160422_01(SR3 FP40))\r\nIBM J9 VM (build 2.7, JRE 1.7.0 z/OS s390-31 20160406_298393 (JIT enabled, AOT enabled)\r\nJ9VM - R27_Java727_SR3_20160406_0942_B298393\r\nJIT  - tr.r13.java_20160328_114186\r\nGC   - R27_Java727_SR3_20160406_0942_B298393\r\nJ9CL - 20160406_298393)\r\nJCL - 20160421_01 based on Oracle jdk7u101-b14\r\n$\r\n\r\n\r\n### OS version (e.g. `uname -a`)\r\n - - - - - - - - - - - - - - - - - - - - - - - - - - -\r\n -    Welcome to  Unix System Services of z / O S    -\r\n -             Version 2 Release 2                   -\r\n - - - - - - - - - - - - - - - - - - - - - - - - - - -\r\n$ uname -a\r\nOS/390 ZOSU 25.00 04 2828\r\n$\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7654/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7654/timeline","performed_via_github_app":null,"state_reason":"completed"}