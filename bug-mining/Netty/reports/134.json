{"url":"https://api.github.com/repos/netty/netty/issues/10072","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/10072/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/10072/comments","events_url":"https://api.github.com/repos/netty/netty/issues/10072/events","html_url":"https://github.com/netty/netty/issues/10072","id":573569627,"node_id":"MDU6SXNzdWU1NzM1Njk2Mjc=","number":10072,"title":"AbstractHttp2StreamChannel fails to flush window update under certain read patterns","user":{"login":"bryce-anderson","id":2948506,"node_id":"MDQ6VXNlcjI5NDg1MDY=","avatar_url":"https://avatars.githubusercontent.com/u/2948506?v=4","gravatar_id":"","url":"https://api.github.com/users/bryce-anderson","html_url":"https://github.com/bryce-anderson","followers_url":"https://api.github.com/users/bryce-anderson/followers","following_url":"https://api.github.com/users/bryce-anderson/following{/other_user}","gists_url":"https://api.github.com/users/bryce-anderson/gists{/gist_id}","starred_url":"https://api.github.com/users/bryce-anderson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bryce-anderson/subscriptions","organizations_url":"https://api.github.com/users/bryce-anderson/orgs","repos_url":"https://api.github.com/users/bryce-anderson/repos","events_url":"https://api.github.com/users/bryce-anderson/events{/privacy}","received_events_url":"https://api.github.com/users/bryce-anderson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/222","html_url":"https://github.com/netty/netty/milestone/222","labels_url":"https://api.github.com/repos/netty/netty/milestones/222/labels","id":5149509,"node_id":"MDk6TWlsZXN0b25lNTE0OTUwOQ==","number":222,"title":"4.1.47.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":16,"state":"closed","created_at":"2020-02-28T09:48:43Z","updated_at":"2020-03-12T09:23:37Z","due_on":null,"closed_at":"2020-03-12T09:23:37Z"},"comments":3,"created_at":"2020-03-01T15:53:57Z","updated_at":"2020-03-04T09:51:05Z","closed_at":"2020-03-04T09:50:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n\r\nWindow updates get flushed by `AbstractHttp2StreamChannel`.\r\n\r\n### Actual behavior\r\n\r\nUnder certain conditions that doesn't happen.\r\n\r\n### Steps to reproduce\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\nI have a test case that is really ugly and should probably be condensed but it illustrates the issue. I've annotated it with values observed with a debugger during it's execution.\r\n```java\r\n    static ByteBuf bb(int size) {\r\n        ByteBuf buf = UnpooledByteBufAllocator.DEFAULT.buffer();\r\n        for (int i = 0; i < size; i++) {\r\n            buf.writeByte('a');\r\n        }\r\n        return buf;\r\n    }\r\n\r\n\r\n    class FlushSniffer extends ChannelOutboundHandlerAdapter {\r\n\r\n        private boolean didFlush;\r\n\r\n        public boolean checkFlush() {\r\n            boolean r = didFlush;\r\n            didFlush = false;\r\n            return r;\r\n        }\r\n\r\n        @Override\r\n        public void flush(ChannelHandlerContext ctx) throws Exception {\r\n            didFlush = true;\r\n            super.flush(ctx);\r\n        }\r\n    }\r\n\r\n    @Test\r\n    public void windowUpdatesAreFlushed() {\r\n        LastInboundHandler inboundHandler = new LastInboundHandler();\r\n        FlushSniffer flushSniffer = new FlushSniffer();\r\n        parentChannel.pipeline().addFirst(flushSniffer);\r\n\r\n        Http2StreamChannel childChannel = newInboundStream(3, false, inboundHandler);\r\n        assertTrue(childChannel.config().isAutoRead());\r\n        childChannel.config().setAutoRead(false);\r\n        assertFalse(childChannel.config().isAutoRead());\r\n\r\n        Http2HeadersFrame headersFrame = inboundHandler.readInbound();\r\n        assertNotNull(headersFrame);\r\n        // From the headers.\r\n        assertTrue(flushSniffer.checkFlush());\r\n\r\n        // childChannel.readState == IN_PROGRESS due to initial auto-read.\r\n        frameInboundWriter.writeInboundData(childChannel.stream().id(), bb(1), 0, false);\r\n        // readState == IDLE, flowControlledBytes = 1\r\n\r\n        frameInboundWriter.writeInboundData(childChannel.stream().id(), bb(1020), 0, false);\r\n        // readState == IDLE, flowControlledBytes = 1, 1 message(1020) buffered.\r\n        assertTrue(flushSniffer.checkFlush());\r\n\r\n        // This will trigger a read of the second message (1020 bytes).\r\n        childChannel.read();\r\n        assertTrue(flushSniffer.checkFlush()); // fails.\r\n        // This should have flushed the window update of 1\r\n        // flowControlledBytes = 1020\r\n\r\n        childChannel.read();\r\n        // triggered a flow control window updatte in DefaultHttp2LocalFlowCoontroller:465\r\n        // flowControlledBytes = 0 <- we wrote the window update but didn't flush!\r\n        assertTrue(flushSniffer.checkFlush()); // fails: no flush was called.\r\n\r\n        Http2DataFrame data = inboundHandler.blockingReadInbound();\r\n        release(data);\r\n    }\r\n```\r\n\r\nThere are a few problems that I see so far. \r\n\r\n* One is that on `beginRead()` we will write any flow bytes as an update frame and enter `doBeginRead()` but if there are no messages to be had we break out of the loop without flushing [here](https://github.com/netty/netty/blob/netty-4.1.43.Final/codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java#L805-L810).\r\n* A second problem is that when we do write the window update we check if the promise is complete and if it is, we assume it's been flushed [here](https://github.com/netty/netty/blob/netty-4.1.43.Final/codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java#L848-L853). However, the Http2FrameCodec intercepts these frames and always just sets the promise to done [here](https://github.com/netty/netty/blob/4.1/codec-http2/src/main/java/io/netty/handler/codec/http2/Http2FrameCodec.java#L313). This may cause an explicit `flush()` call to be ineffective as the stream channel attempts to be clever about it and elid unnecessary flushes [here](https://github.com/netty/netty/blob/netty-4.1.43.Final/codec-http2/src/main/java/io/netty/handler/codec/http2/AbstractHttp2StreamChannel.java#L1034).\r\n\r\n### Netty version\r\nbranch 4.1, SHA e0d73bca4dd36910c7cdbe3d577c51aeb8287cc6 (Fri Feb 28)","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/10072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/10072/timeline","performed_via_github_app":null,"state_reason":"completed"}