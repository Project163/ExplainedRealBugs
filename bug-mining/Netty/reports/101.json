{"url":"https://api.github.com/repos/netty/netty/issues/9495","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/9495/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/9495/comments","events_url":"https://api.github.com/repos/netty/netty/issues/9495/events","html_url":"https://github.com/netty/netty/issues/9495","id":483811695,"node_id":"MDU6SXNzdWU0ODM4MTE2OTU=","number":9495,"title":"NullPointerException during Client Side ClearText Upgrade with new Http2MultiplexHandler.java","user":{"login":"nizarm","id":389183,"node_id":"MDQ6VXNlcjM4OTE4Mw==","avatar_url":"https://avatars.githubusercontent.com/u/389183?v=4","gravatar_id":"","url":"https://api.github.com/users/nizarm","html_url":"https://github.com/nizarm","followers_url":"https://api.github.com/users/nizarm/followers","following_url":"https://api.github.com/users/nizarm/following{/other_user}","gists_url":"https://api.github.com/users/nizarm/gists{/gist_id}","starred_url":"https://api.github.com/users/nizarm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nizarm/subscriptions","organizations_url":"https://api.github.com/users/nizarm/orgs","repos_url":"https://api.github.com/users/nizarm/repos","events_url":"https://api.github.com/users/nizarm/events{/privacy}","received_events_url":"https://api.github.com/users/nizarm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-08-22T07:12:24Z","updated_at":"2019-08-23T16:52:13Z","closed_at":"2019-08-23T16:52:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When cleartext upgrade is implemented in client side using **HttpClientUpgradeHandler** there is no way to pass the newly created **Http2MultiplexHandler**. \r\n\r\nIt seems like we need a way to correctly add Http2MultiplexHandler to the pipeline before calling Http2FrameCodec.onHttpClientUpgrade(...). Since this special case is not handled in HttpClientUpgradeHandler (but seems like this case is correctly taken care in Http2ServerUpgradeCodec). This did lead to the situation that we did not correctly receive the event on the Http2MultiplexHandler and so did not correctly created the Http2StreamChannel for the upgrade stream. Because of this we ended up with an NPE if a frame was dispatched to the upgrade stream later on.\r\n\r\nFollowing is the exception I am receiving when I setup the Http2MultiplexHandler after the upgrade is taken place\r\n\r\nva.lang.NullPointerException\r\n        at io.netty.handler.codec.http2.AbstractHttp2StreamChannel$1.visit(AbstractHttp2StreamChannel.java:64) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.handler.codec.http2.Http2FrameCodec$2.visit(Http2FrameCodec.java:200) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.handler.codec.http2.DefaultHttp2Connection$ActiveStreams.forEachActiveStream(DefaultHttp2Connection.java:971) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.handler.codec.http2.DefaultHttp2Connection.forEachActiveStream(DefaultHttp2Connection.java:208) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.handler.codec.http2.Http2FrameCodec.forEachActiveStream(Http2FrameCodec.java:196) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.handler.codec.http2.Http2ChannelDuplexHandler.forEachActiveStream(Http2ChannelDuplexHandler.java:83) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.handler.codec.http2.Http2MultiplexHandler.channelWritabilityChanged(Http2MultiplexHandler.java:199) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelWritabilityChanged(AbstractChannelHandlerContext.java:436) ~[netty-all-4.1.39.Final.jar:4.1.39.Final]\r\n\r\nMy Code looks something like this\r\n```java\r\n    Http2ClientUpgradeCodec upgradeCodec = new Http2ClientUpgradeCodec(\r\n        \"Http2Codec\",\r\n        Http2FrameCodecBuilder\r\n        .forClient()\r\n        .initialSettings(createHttp2Settings())\r\n        .build()\r\n        );\r\n\r\n    channel.pipeline().addLast(sourceCodec);\r\n    channel.pipeline().addLast(new HttpClientUpgradeHandler(sourceCodec, upgradeCodec, _maxContentLength));\r\n    channel.pipeline().addLast(new Http2ProtocolUpgradeHandler(upgradePromise));\r\n```\r\nI add the Http2MultiplexHandler inside my Http2ProtocolUpgradeHandler during success of cleartext upgrade (as I dont have any other way to add it along with upgradecodec).\r\n\r\nNetty Version I used : 4.1.39\r\n\r\nWhen I follow the same approach to fix the serverside upgrade issue as mentioned in \r\nhttps://github.com/netty/netty/issues/9314 - it works perfectly form me.\r\n\r\n@normanmaurer , @trustin  - let me know if this is a known bug and we are good with my proposed fix. I can give a pull request !","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/9495/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/9495/timeline","performed_via_github_app":null,"state_reason":"completed"}