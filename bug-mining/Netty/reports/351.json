{"url":"https://api.github.com/repos/netty/netty/issues/12844","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/12844/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/12844/comments","events_url":"https://api.github.com/repos/netty/netty/issues/12844/events","html_url":"https://github.com/netty/netty/issues/12844","id":1388587999,"node_id":"I_kwDOABA-c85SxCvf","number":12844,"title":"`CompositeByteBuf.component()` returns ByteBuf duplicates without adjusting the indexes","user":{"login":"sergiitk","id":672669,"node_id":"MDQ6VXNlcjY3MjY2OQ==","avatar_url":"https://avatars.githubusercontent.com/u/672669?v=4","gravatar_id":"","url":"https://api.github.com/users/sergiitk","html_url":"https://github.com/sergiitk","followers_url":"https://api.github.com/users/sergiitk/followers","following_url":"https://api.github.com/users/sergiitk/following{/other_user}","gists_url":"https://api.github.com/users/sergiitk/gists{/gist_id}","starred_url":"https://api.github.com/users/sergiitk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergiitk/subscriptions","organizations_url":"https://api.github.com/users/sergiitk/orgs","repos_url":"https://api.github.com/users/sergiitk/repos","events_url":"https://api.github.com/users/sergiitk/events{/privacy}","received_events_url":"https://api.github.com/users/sergiitk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/318","html_url":"https://github.com/netty/netty/milestone/318","labels_url":"https://api.github.com/repos/netty/netty/milestones/318/labels","id":13267599,"node_id":"MI_kwDOABA-c84AynKP","number":318,"title":"4.2.4.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":29,"state":"closed","created_at":"2025-07-14T19:17:43Z","updated_at":"2025-08-13T12:31:06Z","due_on":null,"closed_at":"2025-08-13T12:31:06Z"},"comments":5,"created_at":"2022-09-28T01:26:55Z","updated_at":"2025-08-13T09:10:23Z","closed_at":"2025-07-30T17:37:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\nRemoving a component from a CompositeByteBuf, and adding it back to the same place does not change the content of the  CompositeByteBuf.\r\n\r\n### Actual behavior\r\nIn certain cases, removing a component from the CompositeByteBuf, and adding it back results in the CompositeByteBuf with the content different from before the removal. In such cases, `CompositeByteBuf.component()` returns a buffer with the reader index out-of-sync with the readable portion of the buffer contributing to the CompositeByteBuf.\r\n\r\n### Steps to reproduce\r\nThis corresponds to the code example in the next section.\r\n\r\n1. Create a new `CompositeByteBuf` with a single component, content: `---01234`; read first 3 bytes:\r\n\r\n```\r\n###### composite1\r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 2d 2d 2d 30 31 32 33 34                         |---01234        |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nCompositeByteBuf(ridx: 3, widx: 8, cap: 8, components=1)\r\n```\r\n\r\n2. Wrap it into another `CompositeByteBuf`:\r\n```\r\n###### composite2\r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nCompositeByteBuf(ridx: 0, widx: 5, cap: 5, components=1)\r\n```\r\n\r\nNote that now the full view of the buffer is the same as the readable portion, as `addFlattenedComponents` made the adjustments to exclude the bytes already read (`---`).\r\n\r\n3. Let's explore the result of `CompositeByteBuf.component(0)`:\r\n```\r\n###### component\r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 2d 2d 2d 30 31 32 33 34                         |---01234        |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 2d 2d 2d 30 31 32 33 34                         |---01234        |\r\n+--------+-------------------------------------------------+----------------+\r\nUnpooledDuplicatedByteBuf(ridx: 0, widx: 8, cap: 32, unwrapped: PooledUnsafeHeapByteBuf(ridx: 0, widx: 8, cap: 32))\r\n```\r\n\r\nNote that the component still contains the bytes discarded by the `CompositeByteBuf()`. This contradicts to what's returned by `internalComponent()`, which returns the `slice()` under the hood:\r\n\r\n```\r\n###### internalComponent\r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nUnpooledSlicedByteBuf(ridx: 0, widx: 5, cap: 5/5, unwrapped: PooledUnsafeHeapByteBuf(ridx: 0, widx: 8, cap: 32))\r\n```\r\n\r\nWhat's even more interesting, if we call `.duplicate()` on the slice, it'll return the full view of the buffer, and with correctly offset indexes!\r\n```\r\n###### internalComponentDup\r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 2d 2d 2d 30 31 32 33 34                         |---01234        |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nUnpooledDuplicatedByteBuf(ridx: 3, widx: 8, cap: 32, unwrapped: PooledUnsafeHeapByteBuf(ridx: 0, widx: 8, cap: 32))\r\n```\r\n\r\n5. Remove the component, then add it back to the composite buf. Results:\r\n**Actual**\r\n```\r\n###### Resulting composite \r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 2d 2d 2d 30 31 32 33 34                         |---01234        |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 2d 2d 2d 30 31 32 33 34                         |---01234        |\r\n+--------+-------------------------------------------------+----------------+\r\nCompositeByteBuf(ridx: 0, widx: 8, cap: 8, components=1)\r\n```\r\n\r\n**Expected**\r\n```\r\n###### Resulting composite \r\nFull:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nReadable:\r\n         +-------------------------------------------------+\r\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\r\n+--------+-------------------------------------------------+----------------+\r\n|00000000| 30 31 32 33 34                                  |01234           |\r\n+--------+-------------------------------------------------+----------------+\r\nCompositeByteBuf(ridx: 0, widx: 5, cap: 5, components=1)\r\n```\r\n\r\n### Minimal yet complete reproducer code \r\n```java\r\npackage io.grpc.netty;\r\n\r\nimport static com.google.common.truth.Truth.assertThat;\r\nimport static io.netty.util.CharsetUtil.US_ASCII;\r\n\r\nimport io.netty.buffer.ByteBuf;\r\nimport io.netty.buffer.ByteBufAllocator;\r\nimport io.netty.buffer.ByteBufUtil;\r\nimport io.netty.buffer.CompositeByteBuf;\r\nimport io.netty.buffer.PooledByteBufAllocator;\r\nimport org.junit.Test;\r\nimport org.junit.runner.RunWith;\r\nimport org.junit.runners.JUnit4;\r\n\r\n@RunWith(JUnit4.class)\r\npublic class CompositeByteBufTest {\r\n  @Test\r\n  public void compositeByteBuf_componentIndexes_demo() {\r\n    ByteBufAllocator alloc = new PooledByteBufAllocator();\r\n\r\n    // Create underlying buffer spacious enough for the test data.\r\n    ByteBuf buf = alloc.buffer(32).writeBytes(\"---01234\".getBytes(US_ASCII));\r\n\r\n    // Start with a regular cumulation and add the buf as the only component.\r\n    CompositeByteBuf composite1 = alloc.compositeBuffer(8).addFlattenedComponents(true, buf);\r\n    // Read composite1 buf to the beginning of the numbers.\r\n    assertThat(composite1.readCharSequence(3, US_ASCII).toString()).isEqualTo(\"---\");\r\n\r\n    printBufDebug(\"composite1\", composite1);\r\n\r\n    // Wrap composite1 into another CompositeByteBuf. This is similar to\r\n    // what NettyAdaptiveCumulator.cumulate() does in the case the cumulation has refCnt != 1.\r\n    CompositeByteBuf composite2 =\r\n        alloc.compositeBuffer(8).addFlattenedComponents(true, composite1);\r\n    assertThat(composite2.toString(US_ASCII)).isEqualTo(\"01234\");\r\n\r\n    printBufDebug(\"composite2\", composite2);\r\n\r\n    // The previous operation does not adjust the read indexes of the underlying buffers,\r\n    // only the internal Component offsets.\r\n\r\n    // Remove the last component from the cumulation, then add it back.\r\n    int tailComponentIndex = composite2.numComponents() - 1;\r\n    int tailStart = composite2.toByteIndex(tailComponentIndex);\r\n    ByteBuf component = composite2.component(tailComponentIndex);\r\n    printBufDebug(\"component\", component);\r\n\r\n    // internalComponent and internalComponentDup are for the demo purposes.\r\n    // ByteBuf internalComponent = composite2.internalComponent(tailComponentIndex);\r\n    // ByteBuf internalComponentDup = composite2.internalComponent(tailComponentIndex).duplicate();\r\n    // printBufDebug(\"internalComponent\", internalComponent);\r\n    // printBufDebug(\"internalComponentDup\", internalComponentDup);\r\n\r\n    // Take the ownership of the component.\r\n    component.retain();\r\n\r\n    // Remove the component from the composite buf.\r\n    composite2.removeComponent(tailComponentIndex).setIndex(0, tailStart);\r\n\r\n    // Add it back to the composite byte buf.\r\n    composite2.addFlattenedComponents(true, component);\r\n    printBufDebug(\"Resulting composite \", composite2);\r\n\r\n    assertThat(composite2.toString(US_ASCII)).isEqualTo(\"01234\");\r\n  }\r\n\r\n  private static void printBufDebug(String title, ByteBuf buf) {\r\n    String msg = \"###### \" + title + \"\\n\";\r\n    msg += \"Full:\\n\";\r\n    msg += ByteBufUtil.prettyHexDump(buf, 0, buf.readerIndex() + buf.readableBytes())  + \"\\n\";\r\n    msg += \"Readable:\\n\";\r\n    msg += ByteBufUtil.prettyHexDump(buf)  + \"\\n\";\r\n    msg += buf + \"\\n\";\r\n    System.out.println(msg);\r\n  }\r\n}\r\n```\r\n\r\n### Netty version\r\n4.x\r\n\r\n### JVM version (e.g. `java -version`)\r\nAny\r\n\r\n### OS version (e.g. `uname -a`)\r\nAny\r\n\r\n### Misc\r\nThis is the root cause for the initial rollback of NettyAdaptiveCumulator in gRPC (https://github.com/grpc/grpc-java/pull/7532).\r\nNow that we found the issue, we're bringing back the NettyAdaptiveCumulator in https://github.com/grpc/grpc-java/pull/9558, but using a hack with copying the indexes from the `internalComponent().duplicate()`. This issue is to track the fix in the upstream.\r\n\r\ncc @ejona86 @normanmaurer ","closed_by":{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/12844/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/12844/timeline","performed_via_github_app":null,"state_reason":"completed"}