{"url":"https://api.github.com/repos/netty/netty/issues/11668","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/11668/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/11668/comments","events_url":"https://api.github.com/repos/netty/netty/issues/11668/events","html_url":"https://github.com/netty/netty/issues/11668","id":991319175,"node_id":"MDU6SXNzdWU5OTEzMTkxNzU=","number":11668,"title":"Multipart upload splits CRLF across 2 chunks","user":{"login":"zentol","id":5725237,"node_id":"MDQ6VXNlcjU3MjUyMzc=","avatar_url":"https://avatars.githubusercontent.com/u/5725237?v=4","gravatar_id":"","url":"https://api.github.com/users/zentol","html_url":"https://github.com/zentol","followers_url":"https://api.github.com/users/zentol/followers","following_url":"https://api.github.com/users/zentol/following{/other_user}","gists_url":"https://api.github.com/users/zentol/gists{/gist_id}","starred_url":"https://api.github.com/users/zentol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zentol/subscriptions","organizations_url":"https://api.github.com/users/zentol/orgs","repos_url":"https://api.github.com/users/zentol/repos","events_url":"https://api.github.com/users/zentol/events{/privacy}","received_events_url":"https://api.github.com/users/zentol/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/netty/netty/milestones/244","html_url":"https://github.com/netty/netty/milestone/244","labels_url":"https://api.github.com/repos/netty/netty/milestones/244/labels","id":7137843,"node_id":"MI_kwDOABA-c84AbOoz","number":244,"title":"4.1.69.Final","description":"","creator":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":37,"state":"closed","created_at":"2021-09-09T13:21:10Z","updated_at":"2021-10-11T11:44:26Z","due_on":null,"closed_at":"2021-10-11T11:44:08Z"},"comments":7,"created_at":"2021-09-08T16:25:52Z","updated_at":"2021-10-04T07:53:35Z","closed_at":"2021-10-04T07:53:10Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n\r\nCLRF is always part of a single chunk.\r\n\r\n### Actual behavior\r\n\r\nCRLF _can_ be split across 2 chunks (in some super rare exotic circumstances), causing the first CR to be considered part of the multipart payload and being offered to the Decoder, causing\r\n\r\n```\r\nio.netty.handler.codec.http.multipart.HttpPostRequestDecoder$ErrorDataDecoderException: java.io.IOException: Out of size: 5043445 > 5043444\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.loadDataMultipartOptimized(HttpPostMultipartRequestDecoder.java:1190)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.getFileUpload(HttpPostMultipartRequestDecoder.java:926)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.decodeMultipart(HttpPostMultipartRequestDecoder.java:572)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.parseBodyMultipart(HttpPostMultipartRequestDecoder.java:463)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.parseBody(HttpPostMultipartRequestDecoder.java:432)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.offer(HttpPostMultipartRequestDecoder.java:347)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostMultipartRequestDecoder.offer(HttpPostMultipartRequestDecoder.java:54)\r\n\tat io.netty.handler.codec.http.multipart.HttpPostRequestDecoder.offer(HttpPostRequestDecoder.java:223)\r\n```\r\n\r\nThis is **very much** a _theory_. Any hints to figure out whether something else could cause this would be appreciated.\r\n\r\n### Steps to reproduce\r\n\r\nWe have a test in Apache Flink that uploads a multipart HTTP request containing a bit of JSON as a MemoryAttribute and a FileUpload.\r\nWhen the size of these attributes is just right (deviating by as much as 3 bytes hides the issue) the decoding of the request fails.\r\nIf it fails, then it is always with an off-by-one error as shown above, one more byte arriving than expected.\r\n\r\nWhile debugging I inspected the chunk that causes the error. The last readable byte in the chunk had the value '13', i.e., CR. This makes me to believe that it is somehow possible that the CRLF can be split across chunks.\r\n\r\nAccording to the the [4.1.49 decoder](https://github.com/netty/netty/blob/d0ec961cce19646519d6a0d59e7604b0eacd9bf2/codec-http/src/main/java/io/netty/handler/codec/http/multipart/HttpPostMultipartRequestDecoder.java#L1101) this should be impossible, but the explicit check was removed in 1529ef1794e0a6654fa4334fd979b769d6940e61.\r\n\r\nWe further consistently observe that the return value `HttpPostRequestEncoder#length()` after finalizing the request differs by _exactly 1_ between successful and failed runs, e.g., 5043832 (successful) vs 5043831 (failed).\r\nNot sure what to make of that, but it's too consistent to ignore.\r\n\r\nWe have only observed this error after upgrading from 4.1.49 to 4.1.65.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nStill working on that. I could provide a reproducer that relies on a few Apache Flink classes if that would be acceptable.\r\n\r\n### Netty version\r\n\r\n4.1.65.Final\r\n\r\n### JVM version (e.g. `java -version`)\r\n\r\nopenjdk version \"11\" 2018-09-25\r\nOpenJDK Runtime Environment 18.9 (build 11+28)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11+28, mixed mode)\r\n\r\n### OS version (e.g. `uname -a`)\r\n\r\nWindows 11, but we also observed it on Ubuntu 20.\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/11668/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/11668/timeline","performed_via_github_app":null,"state_reason":"completed"}