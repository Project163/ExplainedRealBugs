{"url":"https://api.github.com/repos/netty/netty/issues/14826","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/14826/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/14826/comments","events_url":"https://api.github.com/repos/netty/netty/issues/14826/events","html_url":"https://github.com/netty/netty/issues/14826","id":2857953020,"node_id":"I_kwDOABA-c86qWOb8","number":14826,"title":"Improve SSL context support using BouncyCastlePemReader in native images","user":{"login":"michalvavrik","id":43821672,"node_id":"MDQ6VXNlcjQzODIxNjcy","avatar_url":"https://avatars.githubusercontent.com/u/43821672?v=4","gravatar_id":"","url":"https://api.github.com/users/michalvavrik","html_url":"https://github.com/michalvavrik","followers_url":"https://api.github.com/users/michalvavrik/followers","following_url":"https://api.github.com/users/michalvavrik/following{/other_user}","gists_url":"https://api.github.com/users/michalvavrik/gists{/gist_id}","starred_url":"https://api.github.com/users/michalvavrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michalvavrik/subscriptions","organizations_url":"https://api.github.com/users/michalvavrik/orgs","repos_url":"https://api.github.com/users/michalvavrik/repos","events_url":"https://api.github.com/users/michalvavrik/events{/privacy}","received_events_url":"https://api.github.com/users/michalvavrik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-02-17T14:01:28Z","updated_at":"2025-02-24T21:31:09Z","closed_at":"2025-02-24T21:31:09Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"BC provider is instantiated in `BouncyCastlePemReader` even when it is registered as Security provider. When using JVM it doesn't make a difference whether Netty instantiates the provider itself or take the provider instance from `java.security.Security#getProvider`. However when debugging https://github.com/quarkusio/quarkus/issues/46279 I have mentioned that provider instantiated during at the build time has more services then the one created during the first `BouncyCastlePemReader` usage. Registering every required BC class for reflection can be difficult task. Would it be possible to try `Security.getProvider(\"BC\")` (`Security.getProvider(\"BCFIPS\")` respectively) before instantiating classes using reflection API? Alternatively maybe allow users to specify BC provider themselves?\n\nI'd appreciate any change that would allow me to use official Netty API rather than working around my issues. Thank you\n\n### Details\n\nI am using `4.1.118.Final`.\n\n### Steps to reproduce\n\nClone `git@github.com:michalvavrik/netty-ssl-context-bouncycastle-native-issue-reproducer.git`, run `mvn clean verify -Dnative`. My `SslContextBuilder.forClient().keyManager(certificate, privateKey).build()` works with JVM:\n\n```\n2025-02-16 15:28:15,409 DEBUG [io.net.han.ssl.BouncyCastlePemReader] (executor-thread-1) Bouncy Castle provider available\n2025-02-16 15:28:15,421 DEBUG [io.net.han.ssl.BouncyCastlePemReader] (executor-thread-1) Parsed PEM object of type org.bouncycastle.openssl.PEMKeyPair and assume key is not encrypted\n2025-02-16 15:28:15,490 DEBUG [io.net.han.ssl.OpenSsl] (executor-thread-1) netty-tcnative not in the classpath; OpenSslEngine will be unavailable.\n2025-02-16 15:28:15,510 DEBUG [io.net.han.ssl.JdkSslContext] (executor-thread-1) Default protocols (JDK): [TLSv1.3, TLSv1.2] \n2025-02-16 15:28:15,510 DEBUG [io.net.han.ssl.JdkSslContext] (executor-thread-1) Default cipher suites (JDK): [TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_AES_128_GCM_SHA256, TLS_AES_256_GCM_SHA384]\nSSL context for certificate java.io.ByteArrayInputStream@7e2e2176 is io.netty.handler.ssl.JdkSslClientContext@4b6addbd\n\n2025-02-16 15:28:15,634 DEBUG [io.net.han.ssl.BouncyCastlePemReader] (executor-thread-1) Parsed PEM object of type org.bouncycastle.asn1.pkcs.PrivateKeyInfo and assume key is not encrypted\n```\n but failing when using the native image:\n```\n2025-02-16 15:29:56,391 DEBUG [io.net.han.ssl.BouncyCastlePemReader] (executor-thread-1) Bouncy Castle provider available\n2025-02-16 15:29:56,391 DEBUG [io.net.han.ssl.BouncyCastlePemReader] (executor-thread-1) Parsed PEM object of type org.bouncycastle.openssl.PEMKeyPair and assume key is not encrypted\n2025-02-16 15:29:56,391 DEBUG [io.net.han.ssl.BouncyCastlePemReader] (executor-thread-1) Unable to extract private key: org.bouncycastle.openssl.PEMException: unable to convert key pair: no such algorithm: EC for provider BC\n\tat org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter.getKeyPair(Unknown Source)\n\tat io.netty.handler.ssl.BouncyCastlePemReader.getPrivateKey(BouncyCastlePemReader.java:177)\n\tat io.netty.handler.ssl.BouncyCastlePemReader.getPrivateKey(BouncyCastlePemReader.java:124)\n\tat io.netty.handler.ssl.SslContext.toPrivateKey(SslContext.java:1204)\n\tat io.netty.handler.ssl.SslContextBuilder.keyManager(SslContextBuilder.java:421)\n\tat io.netty.handler.ssl.SslContextBuilder.keyManager(SslContextBuilder.java:348)\n\tat org.acme.BouncyCastleEndpoint.pkcs1(BouncyCastleEndpoint.java:39)\n\tat org.acme.BouncyCastleEndpoint$quarkusrestinvoker$pkcs1_b8002ac5f80c85fa5587227252617383662986bc.invoke(Unknown Source)\n\tat org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\n\tat io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\n\tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\n\tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$15.runWith(VertxCoreRecorder.java:639)\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.doRunWith(EnhancedQueueExecutor.java:2675)\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2654)\n\tat org.jboss.threads.EnhancedQueueExecutor.runThreadBody(EnhancedQueueExecutor.java:1627)\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1594)\n\tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:11)\n\tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:11)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.base@21.0.6/java.lang.Thread.runWith(Thread.java:1596)\n\tat java.base@21.0.6/java.lang.Thread.run(Thread.java:1583)\n\tat org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:896)\n\tat org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:872)\nCaused by: java.security.NoSuchAlgorithmException: no such algorithm: EC for provider BC\n\tat java.base@21.0.6/sun.security.jca.GetInstance.getService(GetInstance.java:101)\n\tat java.base@21.0.6/sun.security.jca.GetInstance.getInstance(GetInstance.java:218)\n\tat java.base@21.0.6/java.security.KeyFactory.getInstance(KeyFactory.java:266)\n\tat org.bouncycastle.jcajce.util.ProviderJcaJceHelper.createKeyFactory(Unknown Source)\n\tat org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter.getKeyFactory(Unknown Source)\n\t... 23 more\n```\n\n### Workaround\n\nI have tried using `BC` provider registered as `Security` provider and it worked, but I don't want this to keep in place (Netty can easily change implementation):\n\n```\n@com.oracle.svm.core.annotate.TargetClass(className = \"io.netty.handler.ssl.BouncyCastlePemReader\", onlyWith = NettySslBountyCastleSupportRequired.class)\nfinal class Target_io_netty_handler_ssl_BouncyCastlePemReader {\n    @Alias\n    private static volatile Provider bcProvider;\n    @Alias\n    private static volatile boolean attemptedLoading;\n    @Alias\n    private static volatile Throwable unavailabilityCause;\n\n    @com.oracle.svm.core.annotate.Substitute\n    public static boolean isAvailable() {\n        if (!attemptedLoading) {\n            bcProvider = Security.getProvider(SecurityProviderUtils.BOUNCYCASTLE_PROVIDER_NAME);\n            if (bcProvider == null) {\n                bcProvider = Security.getProvider(SecurityProviderUtils.BOUNCYCASTLE_FIPS_PROVIDER_NAME);\n            }\n            if (bcProvider == null) {\n                tryLoading();\n            } else {\n                attemptedLoading = true;\n            }\n        }\n        return unavailabilityCause == null;\n    }\n\n    @Alias\n    private static void tryLoading() {\n\n    }\n}\n```","closed_by":{"login":"chrisvest","id":7993,"node_id":"MDQ6VXNlcjc5OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7993?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisvest","html_url":"https://github.com/chrisvest","followers_url":"https://api.github.com/users/chrisvest/followers","following_url":"https://api.github.com/users/chrisvest/following{/other_user}","gists_url":"https://api.github.com/users/chrisvest/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisvest/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisvest/subscriptions","organizations_url":"https://api.github.com/users/chrisvest/orgs","repos_url":"https://api.github.com/users/chrisvest/repos","events_url":"https://api.github.com/users/chrisvest/events{/privacy}","received_events_url":"https://api.github.com/users/chrisvest/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/14826/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/14826/timeline","performed_via_github_app":null,"state_reason":"completed"}