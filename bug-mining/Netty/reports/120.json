{"url":"https://api.github.com/repos/netty/netty/issues/7210","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/7210/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/7210/comments","events_url":"https://api.github.com/repos/netty/netty/issues/7210/events","html_url":"https://github.com/netty/netty/issues/7210","id":257601238,"node_id":"MDU6SXNzdWUyNTc2MDEyMzg=","number":7210,"title":"ServerCookieDecoder does not support duplicate cookies","user":{"login":"quidryan","id":360255,"node_id":"MDQ6VXNlcjM2MDI1NQ==","avatar_url":"https://avatars.githubusercontent.com/u/360255?v=4","gravatar_id":"","url":"https://api.github.com/users/quidryan","html_url":"https://github.com/quidryan","followers_url":"https://api.github.com/users/quidryan/followers","following_url":"https://api.github.com/users/quidryan/following{/other_user}","gists_url":"https://api.github.com/users/quidryan/gists{/gist_id}","starred_url":"https://api.github.com/users/quidryan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quidryan/subscriptions","organizations_url":"https://api.github.com/users/quidryan/orgs","repos_url":"https://api.github.com/users/quidryan/repos","events_url":"https://api.github.com/users/quidryan/events{/privacy}","received_events_url":"https://api.github.com/users/quidryan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-09-14T05:38:40Z","updated_at":"2019-12-10T10:32:45Z","closed_at":"2019-12-10T10:32:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\n\r\nAccording to [RFC-6265 (section 4.2.2)](https://tools.ietf.org/html/rfc6265#section-4.2.2), multiple cookie pairs with the same name are not explicitly excluded from happening. It is even hinted that it should be expected, \r\n\r\n   In particular, if the Cookie header contains two cookies with the same name (e.g.,\r\n   that were set with different Path or Domain attributes), servers SHOULD NOT rely \r\n   upon the order in which these cookies appear in the header. \r\n\r\nI would expect that ServerCookieDecoder (and the deprecated CookieDecoder) would return multiple cookies of the same name.\r\n\r\nThis is particularly important because a client might have multiple cookies for different paths or domains, and the client WILL send them all. It's unspecified if clients will send the duplicate cookies in a single Cookie header or multiple Cookie headers, but it is commonly seen in a single Cookie headers, which is why this an issue.\r\n\r\n### Actual behavior\r\n\r\nServerCookieDecoder will return a single cookie when provided with multiple cookies with identical names.\r\n\r\n[This happens because a TreeSet is used to collect the Cookies](https://github.com/quidryan/netty/blob/4.1/codec-http/src/main/java/io/netty/handler/codec/http/cookie/ServerCookieDecoder.java#L71) while the DefaultCookie class has a hashCode/equals/compareTo that doesn't take into account the value of the cookie.\r\n\r\n### Steps to reproduce\r\n\r\n```\r\n    @Test\r\n    public void testDecodingDuplicateCookies() {\r\n        String c1 = \"myCookie=myValue;\";\r\n        String c2 = \"myCookie=myValue2;\";\r\n        String c3 = \"myCookie=myValue3;\";\r\n\r\n        Set<Cookie> cookies = ServerCookieDecoder.STRICT.decode(c1 + c2 + c3);\r\n        assertEquals(3, cookies.size());\r\n        Iterator<Cookie> it = cookies.iterator();\r\n        Cookie cookie = it.next();\r\n        assertNotNull(cookie);\r\n        assertEquals(\"myValue\", cookie.value());\r\n        cookie = it.next();\r\n        assertNotNull(cookie);\r\n        assertEquals(\"myValue2\", cookie.value());\r\n        cookie = it.next();\r\n        assertNotNull(cookie);\r\n        assertEquals(\"myValue3\", cookie.value());\r\n    }\r\n```\r\n\r\nThe `assertEquals(3, cookies.size());` will fail, since only one cookie will be returned.\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nSee above.\r\n\r\n### Netty version\r\n\r\n4.1.11.FINAL\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/7210/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/7210/timeline","performed_via_github_app":null,"state_reason":"completed"}