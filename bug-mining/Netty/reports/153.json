{"url":"https://api.github.com/repos/netty/netty/issues/10434","repository_url":"https://api.github.com/repos/netty/netty","labels_url":"https://api.github.com/repos/netty/netty/issues/10434/labels{/name}","comments_url":"https://api.github.com/repos/netty/netty/issues/10434/comments","events_url":"https://api.github.com/repos/netty/netty/issues/10434/events","html_url":"https://github.com/netty/netty/issues/10434","id":668418913,"node_id":"MDU6SXNzdWU2Njg0MTg5MTM=","number":10434,"title":"OutOfDirectMemoryError causes CPU 100% and fd is full","user":{"login":"wuxiansen","id":6215311,"node_id":"MDQ6VXNlcjYyMTUzMTE=","avatar_url":"https://avatars.githubusercontent.com/u/6215311?v=4","gravatar_id":"","url":"https://api.github.com/users/wuxiansen","html_url":"https://github.com/wuxiansen","followers_url":"https://api.github.com/users/wuxiansen/followers","following_url":"https://api.github.com/users/wuxiansen/following{/other_user}","gists_url":"https://api.github.com/users/wuxiansen/gists{/gist_id}","starred_url":"https://api.github.com/users/wuxiansen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wuxiansen/subscriptions","organizations_url":"https://api.github.com/users/wuxiansen/orgs","repos_url":"https://api.github.com/users/wuxiansen/repos","events_url":"https://api.github.com/users/wuxiansen/events{/privacy}","received_events_url":"https://api.github.com/users/wuxiansen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-07-30T06:37:01Z","updated_at":"2020-08-13T08:14:22Z","closed_at":"2020-08-13T08:14:22Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Expected behavior\r\nRelease connection\r\n\r\n### Actual behavior\r\nAlways occupy the connection\r\n\r\n### Steps to reproduce\r\nsee [# 10424](https://github.com/netty/netty/issues/10424) OOM Exception , OOM  in netty 4.1.51.Final Fixï¼Œbut OOM problem  caused this problem.  Should need to be fixed, because the next OOM will appear again .\r\n\r\n### Minimal yet complete reproducer code (or URL to code)\r\n\r\nGave me some thoughts  in the code .\r\n\r\nin read event:\r\n```java\r\n@Override\r\n        public final void read() {\r\n            final ChannelConfig config = config();\r\n            if (shouldBreakReadReady(config)) {\r\n                clearReadPending();\r\n                return;\r\n            }\r\n            final ChannelPipeline pipeline = pipeline();\r\n            final ByteBufAllocator allocator = config.getAllocator();\r\n            final RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle();\r\n            allocHandle.reset(config);\r\n\r\n            ByteBuf byteBuf = null;\r\n            boolean close = false;\r\n            try {\r\n                do {\r\n\r\n                    // * If an oom exception occurs in its place,  oom will also be here  *\r\n                    byteBuf = allocHandle.allocate(allocator);\r\n\r\n                    allocHandle.lastBytesRead(doReadBytes(byteBuf));\r\n                    if (allocHandle.lastBytesRead() <= 0) {\r\n                        // nothing was read. release the buffer.\r\n                        byteBuf.release();\r\n                        byteBuf = null;\r\n                        close = allocHandle.lastBytesRead() < 0;\r\n                        if (close) {\r\n                            // There is nothing left to read as we received an EOF.\r\n                            readPending = false;\r\n                        }\r\n                        break;\r\n                    }\r\n\r\n                    allocHandle.incMessagesRead(1);\r\n                    readPending = false;\r\n                    pipeline.fireChannelRead(byteBuf);\r\n                    byteBuf = null;\r\n                } while (allocHandle.continueReading());\r\n\r\n                allocHandle.readComplete();\r\n                pipeline.fireChannelReadComplete();\r\n\r\n                if (close) {\r\n                    closeOnRead(pipeline);\r\n                }\r\n            } catch (Throwable t) {\r\n                //  there catch oom exceptin and handler it \r\n                handleReadException(pipeline, byteBuf, t, close, allocHandle);\r\n            } finally {\r\n                .....\r\n            }\r\n        }\r\n    }\r\n```\r\n\r\nhandleReadException method:\r\n```java\r\n\r\n  private void handleReadException(ChannelPipeline pipeline, ByteBuf byteBuf, Throwable cause, boolean close,\r\n                RecvByteBufAllocator.Handle allocHandle) {\r\n            if (byteBuf != null) {\r\n                if (byteBuf.isReadable()) {\r\n                    readPending = false;\r\n                    pipeline.fireChannelRead(byteBuf);\r\n                } else {\r\n                    byteBuf.release();\r\n                }\r\n            }\r\n            allocHandle.readComplete();\r\n            pipeline.fireChannelReadComplete();\r\n            pipeline.fireExceptionCaught(cause);\r\n\r\n           // If it is oom , clase value is false, no change, \r\n           //  and cause not instanceof IOException,  because instanceof OutOfMemoryError ,\r\n           // So event is not fire , event readPending always , If http server, request block always too.\r\n\r\n           // In high concurrency scenarios , this also explains why the socket is full and cpu full too\r\n           //  If oom maybe set close = ture, or condition `cause instanceof OutOfMemoryError`\r\n            if (close || cause instanceof IOException) {\r\n                closeOnRead(pipeline);\r\n            }\r\n        }\r\n\r\n\r\n```\r\n\r\n```shell\r\n[root@app ~]# ss -s\r\nTotal: 61569 (kernel 61731)\r\nTCP:   62328 (estab 49757, closed 9067, orphaned 3, synrecv 0, timewait 235/0), ports 411\r\n\r\nTransport Total     IP        IPv6\r\n*\t  61731     -         -        \r\nRAW\t  0         0         0        \r\nUDP\t  1         1         0        \r\nTCP\t  53261     6         53255    \r\nINET\t  53262     7         53255    \r\nFRAG\t  0         0         0    \r\n```\r\n\r\n### Netty version\r\n4.1.50.Final\r\n\r\n\r\n### JVM version (e.g. `java -version`)\r\njava version \"1.8.0_221\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_221-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.221-b11, mixed mode)\r\n\r\n\r\n### OS version (e.g. `uname -a`)\r\nWindows\r\nLinux\r\n","closed_by":{"login":"normanmaurer","id":439362,"node_id":"MDQ6VXNlcjQzOTM2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/439362?v=4","gravatar_id":"","url":"https://api.github.com/users/normanmaurer","html_url":"https://github.com/normanmaurer","followers_url":"https://api.github.com/users/normanmaurer/followers","following_url":"https://api.github.com/users/normanmaurer/following{/other_user}","gists_url":"https://api.github.com/users/normanmaurer/gists{/gist_id}","starred_url":"https://api.github.com/users/normanmaurer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/normanmaurer/subscriptions","organizations_url":"https://api.github.com/users/normanmaurer/orgs","repos_url":"https://api.github.com/users/normanmaurer/repos","events_url":"https://api.github.com/users/normanmaurer/events{/privacy}","received_events_url":"https://api.github.com/users/normanmaurer/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/netty/netty/issues/10434/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/netty/netty/issues/10434/timeline","performed_via_github_app":null,"state_reason":"completed"}