<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 19:57:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JENA-904] LPBRuleEngine leaks activeInterpreters</title>
                <link>https://issues.apache.org/jira/browse/JENA-904</link>
                <project id="12311220" key="JENA">Apache Jena</project>
                    <description>&lt;p&gt;I found that activeInterpreters in LPBRuleEngine leaks also if you don&apos;t iterate through to the end - calling .close() on the iterator is not enough. Clean-up seems to only happen when it.hasNext() is called and it returns false - so this could happen also in cases like where you return after getting the first hit.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNotLeakingActiveInterpreters() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		Graph data = Factory.createGraphMem();
		data.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Triple(a, ty, C1));
		data.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Triple(b, ty, C1));
		List&amp;lt;Rule&amp;gt; rules = Rule
				.parseRules(&lt;span class=&quot;code-quote&quot;&gt;&quot;[r1:  (?x p ?t) &amp;lt;- (?x rdf:type C1), makeInstance(?x, p, C2, ?t)]&quot;&lt;/span&gt;
						+ &lt;span class=&quot;code-quote&quot;&gt;&quot;[r2:  (?t rdf:type C2) &amp;lt;- (?x rdf:type C1), makeInstance(?x, p, C2, ?t)]&quot;&lt;/span&gt;);

		FBRuleInfGraph infgraph = (FBRuleInfGraph) createReasoner(rules).bind(
				data);

		LPBRuleEngine engine = getEngineForGraph(infgraph);
		assertEquals(0, engine.activeInterpreters.size());
		assertEquals(0, engine.tabledGoals.size());

		&lt;span class=&quot;code-comment&quot;&gt;// we ask &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a non-hit -- it works, but only because we call it.hasNext()
&lt;/span&gt;		ExtendedIterator&amp;lt;Triple&amp;gt; it = infgraph.find(nohit, ty, C1);
		assertFalse(it.hasNext());
		it.close();
		assertEquals(0, engine.activeInterpreters.size());

		&lt;span class=&quot;code-comment&quot;&gt;// and again.
&lt;/span&gt;		&lt;span class=&quot;code-comment&quot;&gt;// Ensure &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not cached by asking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a different triple pattern
&lt;/span&gt;		ExtendedIterator&amp;lt;Triple&amp;gt; it2 = infgraph.find(nohit, ty, C2);
		&lt;span class=&quot;code-comment&quot;&gt;// uuups, forgot to call it.hasNext(). But .close() should tidy
&lt;/span&gt;		it2.close();
		assertEquals(0, engine.activeInterpreters.size());

		
		&lt;span class=&quot;code-comment&quot;&gt;// OK, let&apos;s ask &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; something that is in the graph
&lt;/span&gt;		
		ExtendedIterator&amp;lt;Triple&amp;gt; it3 = infgraph.find(a, ty, C1);
		assertTrue(it3.hasNext());
		assertEquals(a, it3.next().getMatchSubject());
		
		&lt;span class=&quot;code-comment&quot;&gt;// .. and what &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we forget to call next() to consume b?
&lt;/span&gt;		&lt;span class=&quot;code-comment&quot;&gt;// (e.g. &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; from a method with the first hit)
&lt;/span&gt;		
		&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should be enough
&lt;/span&gt;		it3.close();
		&lt;span class=&quot;code-comment&quot;&gt;// without leaks of activeInterpreters
&lt;/span&gt;		assertEquals(0, engine.activeInterpreters.size());
	}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When investigating this, I got as far as seeing that the activeInterpreters is normally closed from hasNext() when it reaches the end here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/jena/blob/master/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/impl/Generator.java#L303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jena/blob/master/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/impl/Generator.java#L303&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;which is a zombie check.. but this doesn&apos;t work when hasNext() hasn&apos;t reach the end, even though it is also called from close() here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/jena/blob/master/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/impl/LPTopGoalIterator.java#L199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jena/blob/master/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/impl/LPTopGoalIterator.java#L199&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Moving the checkForCompletions further down and calling .close() on any nextToRun or lookAhead was not sufficient - there is always a secondary Generator in the list which is not removed - only the top-level one is removed normally.&lt;/p&gt;

&lt;p&gt;I was unable to investigate any further as I could not understand the classes that were creating the two Generators. &lt;/p&gt;

&lt;p&gt;The inner LPInterpreter 147 is first created from generatorFor() call from ConsumerChoicePointFrame constructor within LPInterpreter.setupTabledCall which is coming from the ruleEngine.find.&lt;/p&gt;

&lt;p&gt;This outer LPInterpreter is then added as part of the find().&lt;/p&gt;

&lt;p&gt;In &quot;normal operation&quot; the inner one is removed through the zombie clearing, while the outer one is removed through .close()&lt;/p&gt;

&lt;p&gt;If you don&apos;t iterate through to the end, the inner one is not removed.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12783814">JENA-904</key>
            <summary>LPBRuleEngine leaks activeInterpreters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andy">Andy Seaborne</assignee>
                                    <reporter username="soilandreyes">Stian Soiland-Reyes (old)</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 Mar 2015 01:29:13 +0000</created>
                <updated>Wed, 29 Jul 2015 14:52:33 +0000</updated>
                            <resolved>Fri, 1 May 2015 13:41:48 +0000</resolved>
                                                    <fixVersion>Jena 3.0.0</fixVersion>
                                    <component>Ontology API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14372460" author="githubbot" created="Sat, 21 Mar 2015 02:36:17 +0000"  >&lt;p&gt;GitHub user stain opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/jena/pull/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jena/pull/46&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt; Avoid activeInterpreters leak&lt;/p&gt;

&lt;p&gt;    Fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JENA-904&lt;/a&gt;) by closing the interpreter of the generator of /ConsumerChoicePointFrame - and making sure CCPF.close() is called through super.close() calls of its owners.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/stain/jena&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stain/jena&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt;-LPBRuleEngine-leak&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/jena/pull/46.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jena/pull/46.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #46&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 72a8d46419e1884d9969ba534992c88c98510a9d&lt;br/&gt;
Author: Stian Soiland-Reyes &amp;lt;stain@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-03-21T02:14:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt; test LPDRuleEngine leak of activeInterpreters&lt;/p&gt;

&lt;p&gt;commit 0d3def3a08c263f3bba8bfbeb45725f18b1aa5ac&lt;br/&gt;
Author: Stian Soiland-Reyes &amp;lt;stain@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-03-21T02:15:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt;: Propagate .close() to generator&lt;/p&gt;

&lt;p&gt;commit e8d8df84c0b7d23447b2cdd977d63da4e2a2b340&lt;br/&gt;
Author: Stian Soiland-Reyes &amp;lt;stain@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-03-21T02:18:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt; a bit more super.close()&lt;/p&gt;

&lt;p&gt;    safest to call child.close() before your own super.close&lt;/p&gt;

&lt;p&gt;commit 7761edcd4f4bee881f53f002e0a33d486cc43fc1&lt;br/&gt;
Author: Stian Soiland-Reyes &amp;lt;stain@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-03-21T02:30:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt;: close the generator.interpreter  only&lt;/p&gt;

&lt;p&gt;    .. so that it is removed from activeInterpreters&lt;/p&gt;

&lt;p&gt;    calling .setComplete() on the other hand broke&lt;br/&gt;
    other tests as it closes too much too early&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14372462" author="soilandreyes" created="Sat, 21 Mar 2015 02:36:52 +0000"  >&lt;p&gt;I fixed this by ensuring all .close() did call super.close() and for ConsumerChoicePointFrame calling generator.interpreter.close()&lt;/p&gt;

&lt;p&gt;See pull request #46 &lt;a href=&quot;https://github.com/apache/jena/pull/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jena/pull/46&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14523109" author="jira-bot" created="Fri, 1 May 2015 11:57:18 +0000"  >&lt;p&gt;Commit 4edc6d38613970894165565000f9d1f1a50a6e4c in jena&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andy.seaborne&quot; class=&quot;user-hover&quot; rel=&quot;andy.seaborne&quot;&gt;andy.seaborne&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=jena.git;h=4edc6d3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=jena.git;h=4edc6d3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt;: Fix for LPBRuleEngine leaking activeInterpreters&lt;/p&gt;</comment>
                            <comment id="14523110" author="jira-bot" created="Fri, 1 May 2015 11:57:19 +0000"  >&lt;p&gt;Commit 3573bd76d5ed31a9ad89b0d62f8c62d497b9c1fa in jena&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andy.seaborne&quot; class=&quot;user-hover&quot; rel=&quot;andy.seaborne&quot;&gt;andy.seaborne&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=jena.git;h=3573bd7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=jena.git;h=3573bd7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-904&quot; title=&quot;LPBRuleEngine leaks activeInterpreters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-904&quot;&gt;&lt;del&gt;JENA-904&lt;/del&gt;&lt;/a&gt;: This closes #46&lt;/p&gt;</comment>
                            <comment id="14523111" author="githubbot" created="Fri, 1 May 2015 11:57:26 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/jena/pull/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jena/pull/46&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14646169" author="andy.seaborne" created="Wed, 29 Jul 2015 14:52:33 +0000"  >&lt;p&gt;Jena 3.0.0 Release&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i272sf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>