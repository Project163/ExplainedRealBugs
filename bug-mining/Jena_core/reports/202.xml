<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 19:58:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JENA-5] IndexLARQ is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/JENA-5</link>
                <project id="12311220" key="JENA">Apache Jena</project>
                    <description>&lt;p&gt;Copying a previously sent email:&lt;/p&gt;

&lt;p&gt;I ran into a concurrency problem in LARQ.  When I try to run concurrent queries the Lucene query parser barfs.&lt;/p&gt;

&lt;p&gt;After a bit of digging, I think I understand what is going on.  I was creating  an IndexLARQ and setting that as the global index, then running my queries.  The IndexLARQ constructor constructs a Lucene QueryParser object which it uses for all queries.  Lucene QueryParser objects are not thread safe, so multiple concurrent queries cause the parser the barf.&lt;/p&gt;

&lt;p&gt;I have had a go at patching the HEAD from SVN.  Basically I make the QueryParser object in IndexLARQ ThreadLocal.&lt;/p&gt;

&lt;p&gt;The problem with this is that there is a constructor to IndexLARQ which takes an externally provided QueryParser object and QueryParser is not clonable.  I could replicate the query parser for each thread provided I know its a QueryParser and not a subclass of QueryParser.  If someone passed in a subclass of QueryParser I&apos;d go creating the wrong class of objects as a replica.&lt;/p&gt;

&lt;p&gt;Whilst this scenario is not very likely, since I think the constructor should be deprecated anyway, what I&apos;ve done is esentially left that constructor alone.  Creating an IndexLARQ with that contructor will continue to construct one that is not thread safe.  The other constructors will construct threadsafe instances.&lt;/p&gt;

&lt;p&gt;Attached are:&lt;/p&gt;

&lt;p&gt;a modified IndexLARQ.java that fixes the problem as I&apos;ve described.&lt;br/&gt;
TestLARQConcurrent.java - a test case&lt;br/&gt;
larqConcurrentPatch - a patch file that applies the changes&lt;/p&gt;

&lt;p&gt;Oops - Just noticed the license notice on the test case file - you will want to change that if you use this. &lt;/p&gt;

&lt;p&gt;hmmm - there doesn&apos;t seem to be a button here for attaching files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12492857">JENA-5</key>
            <summary>IndexLARQ is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="11">Done</resolution>
                                        <assignee username="andy">Andy Seaborne</assignee>
                                    <reporter username="bwm">Brian McBride</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Dec 2010 16:42:26 +0000</created>
                <updated>Sun, 1 Feb 2015 19:11:33 +0000</updated>
                            <resolved>Sun, 1 Feb 2015 19:11:33 +0000</resolved>
                                                    <fixVersion>Jena 2.11.0</fixVersion>
                                    <component>ARQ</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12969801" author="bwm" created="Thu, 9 Dec 2010 16:46:27 +0000"  >&lt;p&gt;A test case for problem.&lt;/p&gt;</comment>
                            <comment id="12969802" author="bwm" created="Thu, 9 Dec 2010 16:49:58 +0000"  >&lt;p&gt;This is a modified IndexLARQ that gets around the problem by making the query parser object thread local.  This was a fix that makes a minimal change to the structure of the original code but is probably not the best way to fix things.&lt;/p&gt;

&lt;p&gt;Note there are issues with the interface to IndexLARQ as its public methods and constructurs seem to expect there to be a single lucene query parser object.&lt;/p&gt;</comment>
                            <comment id="12969803" author="bwm" created="Thu, 9 Dec 2010 16:51:35 +0000"  >&lt;p&gt;A patch file that applies my fix to the code and creates a junit test to test it.&lt;/p&gt;</comment>
                            <comment id="12969804" author="andy.seaborne" created="Thu, 9 Dec 2010 16:54:06 +0000"  >&lt;p&gt;Brian has also said in previous email:&lt;/p&gt;

&lt;p&gt;&quot;&quot;&quot;&lt;br/&gt;
Thinking about this a bit more, I&apos;m not sure that the ThreadLocal approach is the best one.  It means keeping one parser per thread around for the lifetime of the index.  In my case that would around 150 for the lifetime of the application.  I presume there is not a lot of overhead in setting up a new parser when one is needed.  So maybe better to do that.&lt;/p&gt;

&lt;p&gt;And my test case just tests for the specific problem I had.  It needs more work to be a generic test of concurrent queries in LARQ. &lt;br/&gt;
&quot;&quot;&quot;&lt;/p&gt;</comment>
                            <comment id="12970617" author="andy.seaborne" created="Sun, 12 Dec 2010 17:09:47 +0000"  >&lt;p&gt;(At the moment, the Jena and ARQ source have not been brought into SVN in Apache)&lt;/p&gt;

&lt;p&gt;Fixed in ARQ in pre-Apache codebase by creating new parser each time (the patch file was not used due to copyright comment). &lt;/p&gt;

&lt;p&gt;This will give the necessary concurrent use - we will need to check that no performance issues arise but there is a new release being made of Jena and of ARQ so fix now is better than release unfixed.&lt;/p&gt;

</comment>
                            <comment id="14300531" author="andy.seaborne" created="Sun, 1 Feb 2015 19:06:26 +0000"  >&lt;p&gt;Reopen to set fix version.&lt;/p&gt;</comment>
                            <comment id="14300544" author="andy.seaborne" created="Sun, 1 Feb 2015 19:11:33 +0000"  >&lt;p&gt;Set fix version to clear up unmarked ones.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12465923" name="IndexLARQ.java" size="8386" author="bwm" created="Thu, 9 Dec 2010 16:49:58 +0000"/>
                            <attachment id="12465922" name="TestLARQConcurrent.java" size="3011" author="bwm" created="Thu, 9 Dec 2010 16:46:27 +0000"/>
                            <attachment id="12465924" name="larqConcurrentPatch" size="6131" author="bwm" created="Thu, 9 Dec 2010 16:51:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>144255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0xitb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>193685</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>