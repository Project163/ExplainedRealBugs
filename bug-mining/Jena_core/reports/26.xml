<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 19:57:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JENA-399] Concurrent execution of SPARQL CONSTRUCT statements against the same Inference Model leads to a ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/JENA-399</link>
                <project id="12311220" key="JENA">Apache Jena</project>
                    <description>&lt;p&gt;Read lock seems to be insufficient for a construct SPARQL query against a model in a multi-threaded situation. See the attached test case for details. &lt;/p&gt;

&lt;p&gt;The ConcurrentModificationException is thrown from: LPTopGoalIterator.checkClosed&lt;br/&gt;
 in com.hp.hpl.jena.reasoner.rulesys.impl.LPTopGoalIterator&lt;/p&gt;

&lt;p&gt;Here is a stack trace that shows a path from QueryExecutionBase.&lt;br/&gt;
execConstruct() to LPBRuleEngine.checkSafeToUpdate():&lt;/p&gt;

&lt;p&gt;LPBRuleEngine.checkSafeToUpdate() line: 223    &lt;br/&gt;
LPBRuleEngine.deleteAllRules() line: 155    &lt;br/&gt;
RDFSRuleInfGraph(FBRuleInfGraph).prepare() line: 460    &lt;br/&gt;
RDFSRuleInfGraph(FBRuleInfGraph).findWithContinuation(TriplePattern, Finder) line: 573    &lt;br/&gt;
RDFSRuleInfGraph(FBRuleInfGraph).graphBaseFind(Node, Node, Node) line: 605    &lt;br/&gt;
RDFSRuleInfGraph(GraphBase).find(Node, Node, Node) line: 287    &lt;br/&gt;
QueryIterTriplePattern$TripleMapper.&amp;lt;init&amp;gt;(Binding, Triple, ExecutionContext) line: 80    &lt;br/&gt;
QueryIterTriplePattern.nextStage(Binding) line: 53    &lt;br/&gt;
QueryIterTriplePattern(QueryIterRepeatApply).makeNextStage() line: 115    &lt;br/&gt;
QueryIterTriplePattern(QueryIterRepeatApply).hasNextBinding() line: 67    &lt;br/&gt;
QueryIterTriplePattern(QueryIteratorBase).hasNext() line: 113    &lt;br/&gt;
QueryIterBlockTriples.hasNextBinding() line: 64    &lt;br/&gt;
QueryIterBlockTriples(QueryIteratorBase).hasNext() line: 113    &lt;br/&gt;
QueryIterOptionalIndex(QueryIterRepeatApply).makeNextStage() line: 108    &lt;br/&gt;
QueryIterOptionalIndex(QueryIterRepeatApply).hasNextBinding() line: 67    &lt;br/&gt;
QueryIterOptionalIndex(QueryIteratorBase).hasNext() line: 113    &lt;br/&gt;
QueryIteratorCheck(QueryIteratorWrapper).hasNextBinding() line: 40    &lt;br/&gt;
QueryIteratorCheck(QueryIteratorBase).hasNext() line: 113    &lt;br/&gt;
QueryIteratorCloseable(QueryIteratorWrapper).hasNextBinding() line: 40    &lt;br/&gt;
QueryIteratorCloseable(QueryIteratorBase).hasNext() line: 113    &lt;br/&gt;
Iter$5.hasNext() line: 335    &lt;br/&gt;
QueryExecutionBase.execConstruct(Model) line: 225    &lt;br/&gt;
QueryExecutionBase.execConstruct() line: 201    &lt;/p&gt;

&lt;p&gt;This is a problem because LPBRuleEngine.checkSafeToUpdate() closes all LPTopGoalIterator iterators, some of which are in the middle of processing:&lt;/p&gt;

&lt;p&gt;    public void checkSafeToUpdate() {&lt;br/&gt;
        if (!activeInterpreters.isEmpty()) {&lt;br/&gt;
            ArrayList&amp;lt;LPInterpreterContext&amp;gt; toClose = new ArrayList&amp;lt;LPInterpreterContext&amp;gt;();&lt;br/&gt;
            for (Iterator&amp;lt;LPInterpreter&amp;gt; i = activeInterpreters.iterator(); i.hasNext(); ) {&lt;br/&gt;
                LPInterpreter interpreter = i.next();&lt;br/&gt;
                if (interpreter.getContext() instanceof LPTopGoalIterator) &lt;/p&gt;
{
                    toClose.add(interpreter.getContext());
                }
&lt;p&gt;            }&lt;br/&gt;
            for (Iterator&amp;lt;LPInterpreterContext&amp;gt; i = toClose.iterator(); i.hasNext(); ) &lt;/p&gt;
{
                ((LPTopGoalIterator)i.next()).close();
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12633488">JENA-399</key>
            <summary>Concurrent execution of SPARQL CONSTRUCT statements against the same Inference Model leads to a ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="11">Done</resolution>
                                        <assignee username="rvesse">Rob Vesse</assignee>
                                    <reporter username="stephen.owens">Stephen Owens</reporter>
                        <labels>
                            <label>InfModel</label>
                            <label>multi-threading</label>
                            <label>race-condition</label>
                    </labels>
                <created>Thu, 21 Feb 2013 22:46:31 +0000</created>
                <updated>Sun, 1 Feb 2015 19:11:54 +0000</updated>
                            <resolved>Sun, 1 Feb 2015 19:11:54 +0000</resolved>
                                    <version>Jena 2.10.0</version>
                                    <fixVersion>Jena 2.11.0</fixVersion>
                                    <component>ARQ</component>
                    <component>Reasoners</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13583726" author="rvesse" created="Fri, 22 Feb 2013 00:18:58 +0000"  >&lt;p&gt;This issue appears to relate specifically to InferenceModel so I have re-titled it as such.  I would suspect this this problem does not occur when using a simple Model though I haven&apos;t verified that yet&lt;/p&gt;</comment>
                            <comment id="13583795" author="rvesse" created="Fri, 22 Feb 2013 01:34:39 +0000"  >&lt;p&gt;The issue looks to be a race condition in the prepare() code for InferenceModel which means if multiple threads try to query the model multiple threads may call into prepare() at the same time resulting in the ConcurrentModificationException you experience and I have been able to reproduce.&lt;/p&gt;

&lt;p&gt;I am working on a fix for this and will likely have something that you can test against tomorrow&lt;/p&gt;</comment>
                            <comment id="13583845" author="hudson" created="Fri, 22 Feb 2013 02:46:48 +0000"  >&lt;p&gt;Integrated in Jena__Development_Test #514 (See &lt;a href=&quot;https://builds.apache.org/job/Jena__Development_Test/514/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Jena__Development_Test/514/&lt;/a&gt;)&lt;br/&gt;
    Fix a race condition that may occur when using InfModel in a multi-threaded environment, it was previously possible for multiple threads to try and call prepare() and hit ConcurrentModificationException&apos;s.&lt;/p&gt;

&lt;p&gt;This fix modifies the code for the underlying InfGraph() to make calls to prepare() synchronized and to ensure threads always see the current prepared state.  This should resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-399&quot; title=&quot;Concurrent execution of SPARQL CONSTRUCT statements against the same Inference Model leads to a ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-399&quot;&gt;&lt;del&gt;JENA-399&lt;/del&gt;&lt;/a&gt;, the previously failing tests are now enabled (Revision 1448883)&lt;br/&gt;
Refactor and expand the multi-threaded query tests to cover SELECT as well.  Determine that I can indeed reproduce the failures intermittently for &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-399&quot; title=&quot;Concurrent execution of SPARQL CONSTRUCT statements against the same Inference Model leads to a ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-399&quot;&gt;&lt;del&gt;JENA-399&lt;/del&gt;&lt;/a&gt;.  The tests that fail are currently @Ignore&apos;d until a workaround can be made (Revision 1448875)&lt;br/&gt;
Incorporated some multi-threaded query test cases from &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-399&quot; title=&quot;Concurrent execution of SPARQL CONSTRUCT statements against the same Inference Model leads to a ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-399&quot;&gt;&lt;del&gt;JENA-399&lt;/del&gt;&lt;/a&gt; (Revision 1448869)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
rvesse : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/jena/trunk/jena-arq/src/test/java/com/hp/hpl/jena/sparql/core/TestQueryEngineMultiThreaded.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/BaseInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/BasicForwardRuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/FBRuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/LPBackwardRuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/RETERuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/transitiveReasoner/TransitiveInfGraph.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;rvesse : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/jena/trunk/jena-arq/src/test/java/com/hp/hpl/jena/sparql/core/TestQueryEngineMultiThreaded.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;rvesse : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/jena/trunk/jena-arq/src/test/java/com/hp/hpl/jena/sparql/core/TestQueryEngineMultiThreaded.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13583877" author="stephen.owens" created="Fri, 22 Feb 2013 03:42:09 +0000"  >&lt;p&gt;Awesome Rob, and thanks! Let me know if you need anything from me to help. &lt;/p&gt;</comment>
                            <comment id="13584261" author="andy.seaborne" created="Fri, 22 Feb 2013 13:36:07 +0000"  >&lt;p&gt;Stephen - is that a &quot;I&apos;ve tested it and it runs OK&quot;?&lt;/p&gt;

&lt;p&gt;Rob - TestQueryEngineMultiThreaded &lt;/p&gt;

&lt;p&gt;I moved it to test package &quot;engine&quot; out of &quot;core&quot;.&lt;/p&gt;

&lt;p&gt;There &apos;s a small problem about running under Eclipse.  It&apos;s a general issue with the rules files, not specific to TestQueryEngineMultiThreaded.&lt;/p&gt;

&lt;p&gt;I&apos;ve raised this as &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-402&quot; title=&quot;Move etc/*.rules to src/main/resources/etc/*.rules&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-402&quot;&gt;&lt;del&gt;JENA-402&lt;/del&gt;&lt;/a&gt; and made a temporary fix by putting copies of the rules files in jena-arq/src/test/resources/etc.&lt;/p&gt;
</comment>
                            <comment id="13584298" author="stephen.owens" created="Fri, 22 Feb 2013 14:15:37 +0000"  >&lt;p&gt;No, just an expression of enthusiasm for the quick response. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The issue was still In Progress so I wasn&apos;t sure that Rob was done yet. If there&apos;s a snapshot you&apos;d like us to try let me know. &lt;/p&gt;

&lt;p&gt;The synchronize on that method does seem a bit heavy handed given that no changes are being made to the graph at any point during the query section of the test execution. I feel like the prepare shouldn&apos;t be necessary but obviously I don&apos;t know that code. Hopefully in this case the prepare becomes effectively a no-op so the synchronize is brief.  Rob is correct in pinpointing the inferencing model. &lt;/p&gt;</comment>
                            <comment id="13584394" author="andy.seaborne" created="Fri, 22 Feb 2013 16:23:34 +0000"  >&lt;p&gt;Marked &quot;resolved&quot; - will close when confirmed.&lt;/p&gt;

&lt;p&gt;There is a new snapshot build (2.10.1-SNAPSHOT) in &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/jena/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/jena/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13584659" author="rvesse" created="Fri, 22 Feb 2013 20:38:27 +0000"  >&lt;p&gt;I may still refactor the code slightly to provide a convenience method that can check the prepared state and call prepare() if necessary in a single step so I would prefer to leave reopen for the time being.&lt;/p&gt;

&lt;p&gt;prepare() needs to be synchronized because prepare() is the method that actually results in the underlying rule engines running and the inferences being produced.  Once prepare() has happened unless changes are made to the graph it should not be needed again i.e. it is an infrequent initialization step that gets called when the first query starts to run.&lt;/p&gt;</comment>
                            <comment id="13584910" author="hudson" created="Sat, 23 Feb 2013 01:00:14 +0000"  >&lt;p&gt;Integrated in Jena__Development_Test #516 (See &lt;a href=&quot;https://builds.apache.org/job/Jena__Development_Test/516/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Jena__Development_Test/516/&lt;/a&gt;)&lt;br/&gt;
    Refactor fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/JENA-399&quot; title=&quot;Concurrent execution of SPARQL CONSTRUCT statements against the same Inference Model leads to a ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JENA-399&quot;&gt;&lt;del&gt;JENA-399&lt;/del&gt;&lt;/a&gt; slightly to provide a single requiresPrepared() method which checks the prepared state and calls prepare() if necessary (Revision 1449212)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
rvesse : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/BaseInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/BasicForwardRuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/FBRuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/LPBackwardRuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/rulesys/RETERuleInfGraph.java&lt;/li&gt;
	&lt;li&gt;/jena/trunk/jena-core/src/main/java/com/hp/hpl/jena/reasoner/transitiveReasoner/TransitiveInfGraph.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13585373" author="andy.seaborne" created="Sun, 24 Feb 2013 14:01:27 +0000"  >&lt;p&gt;Is this resolved now?&lt;/p&gt;</comment>
                            <comment id="13585506" author="stephen.owens" created="Sun, 24 Feb 2013 21:57:32 +0000"  >&lt;p&gt;I tried it with 2.10.1-SNAPSHOT and the test now completes with no ConcurrentModificationException reported. Looks good to me.&lt;/p&gt;</comment>
                            <comment id="13585988" author="rvesse" created="Mon, 25 Feb 2013 16:59:45 +0000"  >&lt;p&gt;Confirmed as fixed by reporter and we now have unit tests covering any regressions here&lt;/p&gt;</comment>
                            <comment id="14300465" author="andy.seaborne" created="Sun, 1 Feb 2015 19:06:05 +0000"  >&lt;p&gt;Reopen to set fix version.&lt;/p&gt;</comment>
                            <comment id="14300611" author="andy.seaborne" created="Sun, 1 Feb 2015 19:11:54 +0000"  >&lt;p&gt;Set fix version to clear up unmarked ones.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570369" name="JenaReadLockFailureTest.java" size="7340" author="stephen.owens" created="Thu, 21 Feb 2013 22:47:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1i6lj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314328</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>