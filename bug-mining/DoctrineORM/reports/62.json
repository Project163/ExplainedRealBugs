{"url":"https://api.github.com/repos/doctrine/orm/issues/7545","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/7545/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/7545/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/7545/events","html_url":"https://github.com/doctrine/orm/issues/7545","id":394627946,"node_id":"MDU6SXNzdWUzOTQ2Mjc5NDY=","number":7545,"title":"Not throwing proper exception when in transaction","user":{"login":"simPod","id":327717,"node_id":"MDQ6VXNlcjMyNzcxNw==","avatar_url":"https://avatars.githubusercontent.com/u/327717?v=4","gravatar_id":"","url":"https://api.github.com/users/simPod","html_url":"https://github.com/simPod","followers_url":"https://api.github.com/users/simPod/followers","following_url":"https://api.github.com/users/simPod/following{/other_user}","gists_url":"https://api.github.com/users/simPod/gists{/gist_id}","starred_url":"https://api.github.com/users/simPod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simPod/subscriptions","organizations_url":"https://api.github.com/users/simPod/orgs","repos_url":"https://api.github.com/users/simPod/repos","events_url":"https://api.github.com/users/simPod/events{/privacy}","received_events_url":"https://api.github.com/users/simPod/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":296201252,"node_id":"MDU6TGFiZWwyOTYyMDEyNTI=","url":"https://api.github.com/repos/doctrine/orm/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2018-12-28T12:37:16Z","updated_at":"2024-10-10T13:24:51Z","closed_at":"2024-10-10T13:24:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| Version     | 2.6.3\r\n\r\n#### Summary\r\n\r\nEntityManager tries to rollback the transaction when exception is thrown during commit operation. The rollback is performed through DBAL Connection. The problem is that the transaction is no longer active and when DBAL Connection tries to rollback through `PDOConnection`, _There is no active transaction_ exception is thrown instead and the original exception is lost. So user has no easy way to know actual exception and gets _There is no active transaction_ instead.\r\n\r\n#### Current behavior\r\n\r\n1. `PDOException` _A_ `SQLSTATE[23505]: Unique violation: 7 ERROR:  duplicate key value violates unique constraint ...` occurs on commit in https://github.com/doctrine/doctrine2/blob/master/lib/Doctrine/ORM/EntityManager.php#L238\r\n2. Transaction is attempting to rollback https://github.com/doctrine/doctrine2/blob/master/lib/Doctrine/ORM/EntityManager.php#L243 before exception _A_ is thrown on https://github.com/doctrine/doctrine2/blob/master/lib/Doctrine/ORM/EntityManager.php#L245\r\n3. DBAL `Connection::rollback()` is called where `$this->_conn->rollBack();` is called. `_conn` is instance of `PDOConnection` that throws _There is no active transaction_ exception instead and the original exception is lost.\r\n\r\n#### Expected behavior\r\n\r\nThe original exception is properly thrown.\r\n\r\n","closed_by":{"login":"greg0ire","id":657779,"node_id":"MDQ6VXNlcjY1Nzc3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/657779?v=4","gravatar_id":"","url":"https://api.github.com/users/greg0ire","html_url":"https://github.com/greg0ire","followers_url":"https://api.github.com/users/greg0ire/followers","following_url":"https://api.github.com/users/greg0ire/following{/other_user}","gists_url":"https://api.github.com/users/greg0ire/gists{/gist_id}","starred_url":"https://api.github.com/users/greg0ire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/greg0ire/subscriptions","organizations_url":"https://api.github.com/users/greg0ire/orgs","repos_url":"https://api.github.com/users/greg0ire/repos","events_url":"https://api.github.com/users/greg0ire/events{/privacy}","received_events_url":"https://api.github.com/users/greg0ire/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/7545/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/7545/timeline","performed_via_github_app":null,"state_reason":"completed"}