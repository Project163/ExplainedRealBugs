{"url":"https://api.github.com/repos/doctrine/orm/issues/6464","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/6464/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/6464/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/6464/events","html_url":"https://github.com/doctrine/orm/issues/6464","id":230522917,"node_id":"MDU6SXNzdWUyMzA1MjI5MTc=","number":6464,"title":"Query builder yields invalid SQL with JOINED inheritance type on PostgreSQL","user":{"login":"stesie","id":113068,"node_id":"MDQ6VXNlcjExMzA2OA==","avatar_url":"https://avatars.githubusercontent.com/u/113068?v=4","gravatar_id":"","url":"https://api.github.com/users/stesie","html_url":"https://github.com/stesie","followers_url":"https://api.github.com/users/stesie/followers","following_url":"https://api.github.com/users/stesie/following{/other_user}","gists_url":"https://api.github.com/users/stesie/gists{/gist_id}","starred_url":"https://api.github.com/users/stesie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stesie/subscriptions","organizations_url":"https://api.github.com/users/stesie/orgs","repos_url":"https://api.github.com/users/stesie/repos","events_url":"https://api.github.com/users/stesie/events{/privacy}","received_events_url":"https://api.github.com/users/stesie/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":296201252,"node_id":"MDU6TGFiZWwyOTYyMDEyNTI=","url":"https://api.github.com/repos/doctrine/orm/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/doctrine/orm/milestones/58","html_url":"https://github.com/doctrine/orm/milestone/58","labels_url":"https://api.github.com/repos/doctrine/orm/milestones/58/labels","id":2205796,"node_id":"MDk6TWlsZXN0b25lMjIwNTc5Ng==","number":58,"title":"2.5.7","description":"","creator":{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":19,"state":"closed","created_at":"2016-12-19T20:48:13Z","updated_at":"2017-12-19T22:33:12Z","due_on":null,"closed_at":"2017-08-11T21:43:46Z"},"comments":2,"created_at":"2017-05-22T21:20:20Z","updated_at":"2017-11-15T10:51:02Z","closed_at":"2017-08-11T19:46:25Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Given a simple set of entities (adapted to a simpler domain here):\r\n\r\n* a `Post` belongs to an `Author` which derives from `User`\r\n* the inheritance is mapped by JOINED type\r\n* yet the relation between `Post` and `Author` is not mapped (for reasons, as the real case is less simple)\r\n\r\n```php\r\n<?php\r\nnamespace Entity;\r\n\r\n/**\r\n * @Entity @Table(name=\"posts\")\r\n */\r\nclass Post\r\n{\r\n    /** @Id @GeneratedValue @Column(type=\"integer\") */\r\n    public $id;\r\n\r\n    /** @Column(type=\"integer\") */\r\n    public $authorId;\r\n\r\n    /** @Column(length=100) */\r\n    public $title;\r\n\r\n    /** @Column(type=\"text\") */\r\n    public $text;\r\n}\r\n```\r\n\r\n```php\r\n<?php\r\nnamespace Entity;\r\n\r\n/**\r\n * @Entity @Table(name=\"authors\")\r\n */\r\nclass Author extends User\r\n{\r\n    /** @Column(length=50) */\r\n    public $displayName;\r\n}\r\n```\r\n\r\n```php\r\n<?php\r\nnamespace Entity;\r\n\r\n/**\r\n * @Entity @Table(name=\"users\")\r\n * @InheritanceType(\"JOINED\")\r\n * @DiscriminatorColumn(name=\"discr\", type=\"string\")\r\n * @DiscriminatorMap({\"author\" = \"Author\"})\r\n */\r\nabstract class User\r\n{\r\n    /** @Id @GeneratedValue @Column(type=\"integer\") */\r\n    public $id;\r\n\r\n    /** @Column(length=50) */\r\n    public $username;\r\n\r\n    /** @Column(length=100) */\r\n    public $password;\r\n}\r\n```\r\n\r\nIf I then instanciate and use a QueryBuilder like this:\r\n\r\n```php\r\n$qb = $entityManager->createQueryBuilder();\r\n\r\n$qb\r\n    ->select('p', 'a')\r\n    ->from('Entity\\\\Post', 'p')\r\n    ->innerJoin('Entity\\\\Author', 'a', 'WITH', 'p.authorId = a.id')\r\n    ;\r\n```\r\n\r\nit generates the following SQL\r\n\r\n```sql\r\nSELECT ... FROM posts p0_ INNER JOIN authors a2_ INNER JOIN users u1_ ON a2_.id = u1_.id AND (p0_.authorId = u1_.id)\r\n```\r\n\r\nWhich is valid for MySQL, however is *not* valid for PostgreSQL (tried with 9.6)\r\n\r\nPostgreSQL seems to require an `ON` clause with each and every `INNER JOIN` (interestingly as opposed to `LEFT JOIN`). This is, the following query works with it:\r\n\r\n```sql\r\nSELECT ... FROM posts p0_ INNER JOIN users u1_ ON (p0_.authorId = u1_.id) INNER JOIN authors a2_ ON (a2_.id = u1_.id) ;\r\n```\r\n\r\nPushing all conditions to `WHERE` also works on PostgreSQL:\r\n\r\n```sql\r\nSELECT ... FROM posts p0_ , authors a2_ , users u1_ WHERE (a2_.id = u1_.id)  AND  (p0_.authorId = u1_.id);\r\n```\r\n\r\nI haven't yet dug deeper, mainly as I never dived into Doctrine ORM code ... please let me know if you agree on this being a bug, ... I so far have no idea where it goes wrong, but let me know if I can support you, maybe by providing test code or start digging ...\r\n","closed_by":{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/6464/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/6464/timeline","performed_via_github_app":null,"state_reason":"completed"}