{"url":"https://api.github.com/repos/doctrine/orm/issues/9917","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/9917/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/9917/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/9917/events","html_url":"https://github.com/doctrine/orm/issues/9917","id":1309276436,"node_id":"I_kwDOAAkff85OCfkU","number":9917,"title":"OPCache wasted memory increases on each request","user":{"login":"icedevelopment","id":4964448,"node_id":"MDQ6VXNlcjQ5NjQ0NDg=","avatar_url":"https://avatars.githubusercontent.com/u/4964448?v=4","gravatar_id":"","url":"https://api.github.com/users/icedevelopment","html_url":"https://github.com/icedevelopment","followers_url":"https://api.github.com/users/icedevelopment/followers","following_url":"https://api.github.com/users/icedevelopment/following{/other_user}","gists_url":"https://api.github.com/users/icedevelopment/gists{/gist_id}","starred_url":"https://api.github.com/users/icedevelopment/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/icedevelopment/subscriptions","organizations_url":"https://api.github.com/users/icedevelopment/orgs","repos_url":"https://api.github.com/users/icedevelopment/repos","events_url":"https://api.github.com/users/icedevelopment/events{/privacy}","received_events_url":"https://api.github.com/users/icedevelopment/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-07-19T09:57:41Z","updated_at":"2023-01-23T12:14:48Z","closed_at":"2023-01-23T12:14:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\n<!-- Fill in the relevant information below to help triage your issue. -->\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | no\r\n| Version     | 2.12.3\r\n\r\n#### Summary\r\n\r\nThe OPCache wasted memory increases on each request if a paginator is used.\r\n\r\n#### Current behavior\r\n\r\nWhenever you make a request on a controller with a `Doctrine\\ORM\\Query` that uses [Doctrine\\ORM\\Tools\\Pagination\\Paginator#getIterator()](https://github.com/doctrine/orm/blob/c05e1709e9ffb9abe8d37260a78975cc816ee385/lib/Doctrine/ORM/Tools/Pagination/Paginator.php#L131), the DQL to SQL parser cache is redone each time.\r\nSeems that this is bad a side effect introduced in commit https://github.com/doctrine/orm/pull/7865/commits/023e94661a1956215a6ddf17cb1b8908274b0d01 which was merged in [2.6.5](https://github.com/doctrine/orm/releases/tag/v2.6.5) so every version between this and [2.12.3](https://github.com/doctrine/orm/releases/tag/2.12.3) should be impacted.\r\n\r\n\r\n#### How to reproduce\r\n\r\n1. Install a Symfony app with Doctrine with the following standard cache configuration:\r\n\r\n```yaml\r\n# config/packages/prod/doctrine.yaml\r\ndoctrine:\r\n    orm:\r\n        auto_generate_proxy_classes: false\r\n        metadata_cache_driver:\r\n            type: pool\r\n            pool: doctrine.system_cache_pool\r\n        query_cache_driver:\r\n            type: pool\r\n            pool: doctrine.system_cache_pool\r\n        result_cache_driver:\r\n            type: pool\r\n            pool: doctrine.result_cache_pool\r\n\r\nframework:\r\n    cache:\r\n        pools:\r\n            doctrine.result_cache_pool:\r\n                adapter: cache.app\r\n            doctrine.system_cache_pool:\r\n                adapter: cache.system\r\n\r\n```\r\n2. Create a controller that uses a `Doctrine\\ORM\\Query` with a paginator (i.e. [knplabs/knp-paginator-bundle](https://packagist.org/packages/knplabs/knp-paginator-bundle)).\r\n\r\n3. Set the environment to prod in .env (APP_ENV=prod and APP_DEBUG=0).\r\n\r\n4. Make requests on the controller and watch `opcache_get_status()['memory_usage']['wasted_memory']` increase each time until OPCache is full and resets itself.\r\n\r\n\r\nThe expireQueryCache flag is always set to true here:\r\n\r\nhttps://github.com/doctrine/orm/blob/c05e1709e9ffb9abe8d37260a78975cc816ee385/lib/Doctrine/ORM/Tools/Pagination/Paginator.php#L163\r\n\r\nThis makes Doctrine reparse the DQL each time:\r\n\r\nhttps://github.com/doctrine/orm/blob/c05e1709e9ffb9abe8d37260a78975cc816ee385/lib/Doctrine/ORM/Query.php#L261-L272\r\n\r\nThen Symfony will recreate the exact same file in its cache in `var/cache/prod/pools/`, invalidate and recompile it into OPCache:\r\nhttps://github.com/symfony/cache/blob/7d8415956df68c8dcbc9468e119945e39bacead1/Adapter/PhpFilesAdapter.php#L254-L259\r\n<!--\r\nProvide steps to reproduce the bug.\r\nIf possible, also add a code snippet with relevant configuration, entity mappings, DQL etc.\r\nAdding a failing Unit or Functional Test would help us a lot - you can submit one in a Pull Request separately, referencing this bug report.\r\n-->\r\n\r\n#### Expected behavior\r\n\r\nThe OPCache wasted_memory doesn't increase on each request.\r\n","closed_by":{"login":"derrabus","id":1506493,"node_id":"MDQ6VXNlcjE1MDY0OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1506493?v=4","gravatar_id":"","url":"https://api.github.com/users/derrabus","html_url":"https://github.com/derrabus","followers_url":"https://api.github.com/users/derrabus/followers","following_url":"https://api.github.com/users/derrabus/following{/other_user}","gists_url":"https://api.github.com/users/derrabus/gists{/gist_id}","starred_url":"https://api.github.com/users/derrabus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/derrabus/subscriptions","organizations_url":"https://api.github.com/users/derrabus/orgs","repos_url":"https://api.github.com/users/derrabus/repos","events_url":"https://api.github.com/users/derrabus/events{/privacy}","received_events_url":"https://api.github.com/users/derrabus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/9917/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/9917/timeline","performed_via_github_app":null,"state_reason":"completed"}