{"url":"https://api.github.com/repos/doctrine/orm/issues/6167","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/6167/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/6167/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/6167/events","html_url":"https://github.com/doctrine/orm/issues/6167","id":194690450,"node_id":"MDU6SXNzdWUxOTQ2OTA0NTA=","number":6167,"title":"Fails to insert to a PostgreSQL master-slave config due to SequenceGenerator(NEXTVAL) issues","user":{"login":"mkurzeja","id":1044032,"node_id":"MDQ6VXNlcjEwNDQwMzI=","avatar_url":"https://avatars.githubusercontent.com/u/1044032?v=4","gravatar_id":"","url":"https://api.github.com/users/mkurzeja","html_url":"https://github.com/mkurzeja","followers_url":"https://api.github.com/users/mkurzeja/followers","following_url":"https://api.github.com/users/mkurzeja/following{/other_user}","gists_url":"https://api.github.com/users/mkurzeja/gists{/gist_id}","starred_url":"https://api.github.com/users/mkurzeja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkurzeja/subscriptions","organizations_url":"https://api.github.com/users/mkurzeja/orgs","repos_url":"https://api.github.com/users/mkurzeja/repos","events_url":"https://api.github.com/users/mkurzeja/events{/privacy}","received_events_url":"https://api.github.com/users/mkurzeja/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":296201252,"node_id":"MDU6TGFiZWwyOTYyMDEyNTI=","url":"https://api.github.com/repos/doctrine/orm/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/doctrine/orm/milestones/66","html_url":"https://github.com/doctrine/orm/milestone/66","labels_url":"https://api.github.com/repos/doctrine/orm/milestones/66/labels","id":2934567,"node_id":"MDk6TWlsZXN0b25lMjkzNDU2Nw==","number":66,"title":"2.5.13","description":"ONLY Security/Regression fixes We no longer actively support 2.5.x, and need to get 2.6.0 out the door.","creator":{"login":"lcobucci","id":201963,"node_id":"MDQ6VXNlcjIwMTk2Mw==","avatar_url":"https://avatars.githubusercontent.com/u/201963?v=4","gravatar_id":"","url":"https://api.github.com/users/lcobucci","html_url":"https://github.com/lcobucci","followers_url":"https://api.github.com/users/lcobucci/followers","following_url":"https://api.github.com/users/lcobucci/following{/other_user}","gists_url":"https://api.github.com/users/lcobucci/gists{/gist_id}","starred_url":"https://api.github.com/users/lcobucci/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lcobucci/subscriptions","organizations_url":"https://api.github.com/users/lcobucci/orgs","repos_url":"https://api.github.com/users/lcobucci/repos","events_url":"https://api.github.com/users/lcobucci/events{/privacy}","received_events_url":"https://api.github.com/users/lcobucci/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":15,"state":"closed","created_at":"2017-11-24T01:45:37Z","updated_at":"2017-11-30T13:04:39Z","due_on":null,"closed_at":"2017-11-27T23:43:26Z"},"comments":1,"created_at":"2016-12-09T20:34:07Z","updated_at":"2017-11-27T16:17:10Z","closed_at":"2017-06-21T04:05:21Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Background: I have a master-slave connection and I'm using auto-generated id for my entity;\r\n\r\nDoctrine ORM fails to insert data because it tries to get the sequence NEXTVAL value from a slave.\r\n\r\n```php\r\npublic function generate(EntityManager $em, $entity)\r\n    {\r\n        if ($this->_maxValue === null || $this->_nextValue == $this->_maxValue) {\r\n            // Allocate new values\r\n            $conn = $em->getConnection();\r\n            $sql  = $conn->getDatabasePlatform()->getSequenceNextValSQL($this->_sequenceName);\r\n\r\n            $this->_nextValue = (int)$conn->fetchColumn($sql); //this line fails\r\n            $this->_maxValue  = $this->_nextValue + $this->_allocationSize;\r\n        }\r\n\r\n        return $this->_nextValue++;\r\n    }\r\n```\r\n\r\nPostgreSQL allows to fetch nextval only from a master server, and using fetchColumn runs the query using a slave connection.\r\n\r\nI could start a transaction before, but I assume this case should be handled by ORM.\r\n\r\nIn case someone tries to reproduce this issue, just start a PostgreSQL cluster (docker-compose and https://hub.docker.com/r/bitnami/postgresql/ might be helpful) and try to persist any entity with an auto-generated ID. ","closed_by":{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/6167/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/6167/timeline","performed_via_github_app":null,"state_reason":"completed"}