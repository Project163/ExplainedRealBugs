{"url":"https://api.github.com/repos/doctrine/orm/issues/8499","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/8499/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/8499/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/8499/events","html_url":"https://github.com/doctrine/orm/issues/8499","id":813413834,"node_id":"MDU6SXNzdWU4MTM0MTM4MzQ=","number":8499,"title":"Optimistic lock not working when used with DateTime objects.","user":{"login":"diego-ninja","id":78662279,"node_id":"MDQ6VXNlcjc4NjYyMjc5","avatar_url":"https://avatars.githubusercontent.com/u/78662279?v=4","gravatar_id":"","url":"https://api.github.com/users/diego-ninja","html_url":"https://github.com/diego-ninja","followers_url":"https://api.github.com/users/diego-ninja/followers","following_url":"https://api.github.com/users/diego-ninja/following{/other_user}","gists_url":"https://api.github.com/users/diego-ninja/gists{/gist_id}","starred_url":"https://api.github.com/users/diego-ninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diego-ninja/subscriptions","organizations_url":"https://api.github.com/users/diego-ninja/orgs","repos_url":"https://api.github.com/users/diego-ninja/repos","events_url":"https://api.github.com/users/diego-ninja/events{/privacy}","received_events_url":"https://api.github.com/users/diego-ninja/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-02-22T11:29:28Z","updated_at":"2021-02-27T17:40:49Z","closed_at":"2021-02-27T17:40:49Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I will try to be as concrete and specific as possible, I think there is a bug when comparing the DateTime objects used in the optimistic lock.\r\n\r\nIn the UnitOfWork (Line 2497) you are using a !== comparison that only resolves to true when the two instances of the compared object are the same.  This way it is totally impossible for $entityVersion and $lockVersion to be the same at any time since they are different objects. \r\n\r\n```php\r\n    if ($entityVersion !== $lockVersion) {\r\n        throw OptimisticLockException::lockFailedVersionMismatch($entity, $lockVersion, $entityVersion);\r\n    }\r\n```\r\nDebugging to that point I get the following pair of objects, that should pass the validation but they don't:\r\n\r\n[Debug variables](https://ibb.co/QXw6kvt)\r\n\r\nI have checked the tests that cover the lock functionality and the only thing that is checked is that the appropriate exceptions are thrown, which is always the case since the result of the comparison is always false. There is no test that covers the success of the lock operation.\r\n\r\nIn older versions of the code the comparison was performed using the != operator with which the functionality works as expected. \r\n\r\nPossible solutions could be to revert to using the != operator or to directly compare the timestamps of DateTime objects using the !== operator.\r\n\r\nI can send a PR with the proposed fix.\r\n\r\nThanks in advance.","closed_by":{"login":"beberlei","id":26936,"node_id":"MDQ6VXNlcjI2OTM2","avatar_url":"https://avatars.githubusercontent.com/u/26936?v=4","gravatar_id":"","url":"https://api.github.com/users/beberlei","html_url":"https://github.com/beberlei","followers_url":"https://api.github.com/users/beberlei/followers","following_url":"https://api.github.com/users/beberlei/following{/other_user}","gists_url":"https://api.github.com/users/beberlei/gists{/gist_id}","starred_url":"https://api.github.com/users/beberlei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/beberlei/subscriptions","organizations_url":"https://api.github.com/users/beberlei/orgs","repos_url":"https://api.github.com/users/beberlei/repos","events_url":"https://api.github.com/users/beberlei/events{/privacy}","received_events_url":"https://api.github.com/users/beberlei/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/8499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/8499/timeline","performed_via_github_app":null,"state_reason":"completed"}