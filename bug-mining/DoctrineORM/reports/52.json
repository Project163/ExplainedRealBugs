{"url":"https://api.github.com/repos/doctrine/orm/issues/7877","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/7877/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/7877/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/7877/events","html_url":"https://github.com/doctrine/orm/issues/7877","id":511444508,"node_id":"MDU6SXNzdWU1MTE0NDQ1MDg=","number":7877,"title":"Extra update for self-referencing Many-To-One with NONE generator strategy during persist","user":{"login":"sylfabre","id":3177556,"node_id":"MDQ6VXNlcjMxNzc1NTY=","avatar_url":"https://avatars.githubusercontent.com/u/3177556?v=4","gravatar_id":"","url":"https://api.github.com/users/sylfabre","html_url":"https://github.com/sylfabre","followers_url":"https://api.github.com/users/sylfabre/followers","following_url":"https://api.github.com/users/sylfabre/following{/other_user}","gists_url":"https://api.github.com/users/sylfabre/gists{/gist_id}","starred_url":"https://api.github.com/users/sylfabre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sylfabre/subscriptions","organizations_url":"https://api.github.com/users/sylfabre/orgs","repos_url":"https://api.github.com/users/sylfabre/repos","events_url":"https://api.github.com/users/sylfabre/events{/privacy}","received_events_url":"https://api.github.com/users/sylfabre/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":296201252,"node_id":"MDU6TGFiZWwyOTYyMDEyNTI=","url":"https://api.github.com/repos/doctrine/orm/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-10-23T16:39:38Z","updated_at":"2023-07-11T06:11:18Z","closed_at":"2023-07-11T06:11:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\n<!-- Fill in the relevant information below to help triage your issue. -->\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | no\r\n| Version     | 2.6.4\r\n\r\n#### Summary\r\n\r\nUsing a self-referencing entity with a Many-To-One relationship set during the `__construct()` call with a `NONE` strategy for id generation leads to two queries:\r\n- first an INSERT\r\n- then an UPDATE for the relationship\r\n\r\n#### Current behavior\r\n\r\n- this requires the relationship related column to accept `NULL` for the first `INSERT`\r\n\r\n`[2019-10-23 16:04:21] doctrine.DEBUG: INSERT INTO organization (id, legal_parent_id) VALUES (?, ?, ?, ?, ?, ?, ?) {\"1\":\"[object] (Ramsey\\\\Uuid\\\\Uuid: \\\"c68555b0-f5ae-11e9-914e-38baf82a0624\\\")\",\"2\":null} []`\r\n\r\n- this leads to a useless `UPDATE` query\r\n\r\n`[2019-10-23 16:04:21] doctrine.DEBUG: UPDATE organization SET legal_parent_id = ? WHERE id = ? [\"[object] (Ramsey\\\\Uuid\\\\Uuid: \\\"c68555b0-f5ae-11e9-914e-38baf82a0624\\\")\",\"[object] (Ramsey\\\\Uuid\\\\Uuid: \\\"c68555b0-f5ae-11e9-914e-38baf82a0624\\\")\"] []`\r\n\r\n#### How to reproduce\r\n\r\n```sql\r\n\r\nCREATE TABLE `organization` (\r\n  `id` binary(16) NOT NULL COMMENT '(DC2Type:uuid_binary_ordered_time)',\r\n  `legal_parent_id` BINARY(16) NOT NULL COMMENT '(DC2Type:uuid_binary_ordered_time)',\r\n  PRIMARY KEY (`id`),\r\n  CONSTRAINT FK_C1EE637C9EB3F521 FOREIGN KEY (legal_parent_id) REFERENCES organization (id)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\r\n\r\n```\r\n\r\n```php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace App\\Entity;\r\n\r\nuse Doctrine\\Common\\Collections\\ArrayCollection;\r\nuse Doctrine\\Common\\Collections\\Collection;\r\nuse Doctrine\\ORM\\Mapping as ORM;\r\n\r\n/**\r\n * An Organization\r\n * @ORM\\Entity(repositoryClass=\"App\\Repository\\OrganizationRepository\")\r\n */\r\nclass Organization\r\n{\r\n    public function __construct()\r\n    {\r\n        $factory = clone \\Ramsey\\Uuid\\Uuid::getFactory();\r\n        $codec = new \\Ramsey\\Uuid\\Codec\\OrderedTimeCodec(\r\n            $factory->getUuidBuilder()\r\n        );\r\n        $factory->setCodec($codec);\r\n\t\t$this->id = $factory->uuid1();\r\n        $this->legalParent = $this;\r\n        parent::__construct();\r\n    }\r\n\r\n    /**\r\n     * Unique ID of the entity\r\n     *\r\n     * @ORM\\Id()\r\n     * @ORM\\GeneratedValue(strategy=\"NONE\")\r\n     * @ORM\\Column(type=\"uuid_binary_ordered_time\", unique=true)\r\n     */\r\n    private $id;\r\n\r\n    public function getId(): ?string\r\n    {\r\n        return $this->id->__toString();\r\n    }\r\n\r\n    /**\r\n     * @var self\r\n     * @ORM\\ManyToOne(targetEntity=\"App\\Entity\\Organization\")\r\n     * @ORM\\JoinColumn(fieldName=\"legal_parent_id\", referencedColumnName=\"id\", nullable=false)\r\n     */\r\n    protected $legalParent;\r\n\r\n    public function getLegalParent(): self\r\n    {\r\n        return $this->legalParent;\r\n    }\r\n\r\n    public function setLegalParent(self $legalParent): self\r\n    {\r\n        $this->legalParent = $legalParent;\r\n\r\n        return $this;\r\n    }\r\n}\r\n\r\n```\r\n\r\n#### Expected behavior\r\n\r\n- Only the `INSERT` query with `legal_parent_id` not `NULL`\r\n\r\n`[2019-10-23 16:04:21] doctrine.DEBUG: INSERT INTO organization (id, legal_parent_id) VALUES (?, ?, ?, ?, ?, ?, ?) {\"1\":\"[object] (Ramsey\\\\Uuid\\\\Uuid: \\\"c68555b0-f5ae-11e9-914e-38baf82a0624\\\")\",\"2\":[object] (Ramsey\\\\Uuid\\\\Uuid: \\\"c68555b0-f5ae-11e9-914e-38baf82a0624\\\")} []`\r\n\r\n#### Possible solution\r\n\r\nThis comes from `vendor/doctrine/orm/lib/Doctrine/ORM/Persisters/Entity/BasicEntityPersister.php`\r\n\r\n![image](https://user-images.githubusercontent.com/3177556/67414724-f3400e00-f5c3-11e9-9d4b-abb4bc298bf0.png)\r\n\r\nWe could check if `spl_object_hash($newVal) === spl_object_hash($entity)` and if `ClassMetadataInfo::GENERATOR_TYPE_NONE === $this->class->generatorType`. If yes, then do not set `$newVal = null;` and do not schedule extra update.\r\n\r\nI can provide a PR if you want","closed_by":{"login":"sylfabre","id":3177556,"node_id":"MDQ6VXNlcjMxNzc1NTY=","avatar_url":"https://avatars.githubusercontent.com/u/3177556?v=4","gravatar_id":"","url":"https://api.github.com/users/sylfabre","html_url":"https://github.com/sylfabre","followers_url":"https://api.github.com/users/sylfabre/followers","following_url":"https://api.github.com/users/sylfabre/following{/other_user}","gists_url":"https://api.github.com/users/sylfabre/gists{/gist_id}","starred_url":"https://api.github.com/users/sylfabre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sylfabre/subscriptions","organizations_url":"https://api.github.com/users/sylfabre/orgs","repos_url":"https://api.github.com/users/sylfabre/repos","events_url":"https://api.github.com/users/sylfabre/events{/privacy}","received_events_url":"https://api.github.com/users/sylfabre/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/7877/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/7877/timeline","performed_via_github_app":null,"state_reason":"completed"}