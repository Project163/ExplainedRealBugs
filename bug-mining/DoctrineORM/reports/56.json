{"url":"https://api.github.com/repos/doctrine/orm/issues/11199","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/11199/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/11199/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/11199/events","html_url":"https://github.com/doctrine/orm/issues/11199","id":2109604635,"node_id":"I_kwDOAAkff859vgMb","number":11199,"title":"Discriminator column condition SQL contains empty string when inheritance tree contains an abstract class non-root entity","user":{"login":"DemoniacDeath","id":500550,"node_id":"MDQ6VXNlcjUwMDU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/500550?v=4","gravatar_id":"","url":"https://api.github.com/users/DemoniacDeath","html_url":"https://github.com/DemoniacDeath","followers_url":"https://api.github.com/users/DemoniacDeath/followers","following_url":"https://api.github.com/users/DemoniacDeath/following{/other_user}","gists_url":"https://api.github.com/users/DemoniacDeath/gists{/gist_id}","starred_url":"https://api.github.com/users/DemoniacDeath/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DemoniacDeath/subscriptions","organizations_url":"https://api.github.com/users/DemoniacDeath/orgs","repos_url":"https://api.github.com/users/DemoniacDeath/repos","events_url":"https://api.github.com/users/DemoniacDeath/events{/privacy}","received_events_url":"https://api.github.com/users/DemoniacDeath/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-01-31T09:00:00Z","updated_at":"2024-02-22T08:09:21Z","closed_at":"2024-02-03T23:13:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### BC Break Report\r\n\r\n<!-- Fill in the relevant information below to help triage your issue. -->\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | yes\r\n| Version     | 2.14.2\r\n\r\n#### Summary\r\n\r\nafter commit https://github.com/doctrine/orm/commit/4e8e3ef30b3d214640883aec5a17896afc006116 when `\\Doctrine\\ORM\\Query\\SqlWalker` generates dicsriminator column condition SQL (method `\\Doctrine\\ORM\\Query\\SqlWalker::generateDiscriminatorColumnConditionSQL`) it adds an empty string to the list of possible values if the inheritance hierarchy contains a non-root abstract class. when the discriminator column is implemented with a custom type in PostgreSQL (equivalent of Enum) the query fails because the type cannot have a value of an empty string. it boils down to the fact that `\\Doctrine\\ORM\\Mapping\\ClassMetadataInfo::$subClasses` contains an abstract class and in it's Metadata the value of `\\Doctrine\\ORM\\Mapping\\ClassMetadataInfo::$discriminatorValue` is `null`.\r\n\r\n#### Previous behavior\r\n\r\nIn version 2.14.1 `\\Doctrine\\ORM\\Mapping\\ClassMetadataInfo::$subClasses` does not contain an abstract class.\r\n\r\n#### Current behavior\r\n\r\nAs described in Summary\r\n\r\n#### How to reproduce\r\n\r\nHere are entity definitions necessary to reproduce the problem.\r\n```php\r\n/**\r\n * @ORM\\Entity()\r\n * @ORM\\Table(name=\"bug\")\r\n * @ORM\\InheritanceType(\"SINGLE_TABLE\")\r\n * @ORM\\DiscriminatorColumn(name=\"asset_type\", type=\"string\")\r\n * @ORM\\DiscriminatorMap({\r\n *     \"foo\" = \"\\Doctrine\\Tests\\ORM\\Functional\\Ticket\\BugFoo\",\r\n *     \"bar\" = \"\\Doctrine\\Tests\\ORM\\Functional\\Ticket\\BugBar\",\r\n *     \"baz\" = \"\\Doctrine\\Tests\\ORM\\Functional\\Ticket\\BugBaz\",\r\n * })\r\n */\r\nclass BugRoot\r\n{\r\n    /**\r\n     * @ORM\\Id\r\n     * @ORM\\GeneratedValue(strategy=\"IDENTITY\")\r\n     * @ORM\\Column(type=\"integer\")\r\n     *\r\n     * @var int|null\r\n     */\r\n    private $id = null;\r\n}\r\n\r\n/**\r\n * @ORM\\Entity()\r\n */\r\nabstract class BugParent extends BugRoot\r\n{\r\n}\r\n\r\n/**\r\n * @ORM\\Entity()\r\n */\r\nclass BugFoo extends BugParent\r\n{\r\n}\r\n\r\n/**\r\n * @ORM\\Entity()\r\n */\r\nclass BugBar extends BugParent\r\n{\r\n}\r\n\r\n/**\r\n * @ORM\\Entity()\r\n */\r\nclass BugBaz extends BugRoot\r\n{\r\n}\r\n\r\n```\r\n\r\nThe simplest way to reproduce the problem is\r\n```php\r\nclass BugTest extends OrmFunctionalTestCase\r\n{\r\n    protected function setUp(): void\r\n    {\r\n        parent::setUp();\r\n\r\n        $this->setUpEntitySchema([\r\n            BugRoot::class,\r\n            BugParent::class,\r\n            BugFoo::class,\r\n            BugBar::class,\r\n            BugBaz::class,\r\n        ]);\r\n    }\r\n\r\n    public function testBug(): void\r\n    {\r\n        $this->getEntityManager()->createQuery('SELECT e FROM ' . BugRoot::class . ' e')->getSQL();\r\n    }\r\n}\r\n```\r\nif run from tag 2.14.2 the execution fails with\r\n`PDO::quote(): Passing null to parameter #1 ($string) of type string is deprecated` which is caused by the issue described in Summary. If the deprecation is skipped, like it is in our production code, the empty string is added to discriminator column condition SQL.\r\n\r\nwhen I have time I'll try to create a reproducer which ties directly to method `generateDiscriminatorColumnConditionSQL`","closed_by":{"login":"mpdude","id":1202333,"node_id":"MDQ6VXNlcjEyMDIzMzM=","avatar_url":"https://avatars.githubusercontent.com/u/1202333?v=4","gravatar_id":"","url":"https://api.github.com/users/mpdude","html_url":"https://github.com/mpdude","followers_url":"https://api.github.com/users/mpdude/followers","following_url":"https://api.github.com/users/mpdude/following{/other_user}","gists_url":"https://api.github.com/users/mpdude/gists{/gist_id}","starred_url":"https://api.github.com/users/mpdude/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mpdude/subscriptions","organizations_url":"https://api.github.com/users/mpdude/orgs","repos_url":"https://api.github.com/users/mpdude/repos","events_url":"https://api.github.com/users/mpdude/events{/privacy}","received_events_url":"https://api.github.com/users/mpdude/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/11199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/11199/timeline","performed_via_github_app":null,"state_reason":"completed"}