{"url":"https://api.github.com/repos/doctrine/orm/issues/9027","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/9027/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/9027/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/9027/events","html_url":"https://github.com/doctrine/orm/issues/9027","id":1002517727,"node_id":"I_kwDOAAkff847wTTf","number":9027,"title":"PHP error thrown if a one-to-one relationship cannot be retrieved","user":{"login":"gregtyler","id":100852,"node_id":"MDQ6VXNlcjEwMDg1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/100852?v=4","gravatar_id":"","url":"https://api.github.com/users/gregtyler","html_url":"https://github.com/gregtyler","followers_url":"https://api.github.com/users/gregtyler/followers","following_url":"https://api.github.com/users/gregtyler/following{/other_user}","gists_url":"https://api.github.com/users/gregtyler/gists{/gist_id}","starred_url":"https://api.github.com/users/gregtyler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregtyler/subscriptions","organizations_url":"https://api.github.com/users/gregtyler/orgs","repos_url":"https://api.github.com/users/gregtyler/repos","events_url":"https://api.github.com/users/gregtyler/events{/privacy}","received_events_url":"https://api.github.com/users/gregtyler/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-09-21T13:45:06Z","updated_at":"2021-09-27T10:43:36Z","closed_at":"2021-09-27T10:43:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | Sorry, I don't know what this means\r\n| Version     | 2.9.3\r\n\r\n#### Summary\r\n\r\nPHP error thrown if a one-to-one relationship cannot be retrieved.\r\n\r\nI can't profess to understand this too much, but it has come up in live system due to a combination of Doctrine, JMSSerializer and the SoftDeleteable filter from doctrine-extensions. I've managed to narrow it down to the following:\r\n\r\n#### Current behavior\r\n\r\nWhen `UnitOfWork->createEntity` is called, it fetches related records to make them part of the object returned. For bidirectional one-to-one relationships, in certain circumstances, it uses `EntityManager->find` to do this, then calls `spl_object_hash()` and `ReflectionProperty->setValue()` with the result.\r\n\r\nIf `find` doesn't find an object then it will return `null`, which is an invalid argument to both of those functions. Hence one of the following errors occurs:\r\n\r\n```\r\nspl_object_hash(): Argument #1 ($object) must be of type object, null given\r\n```\r\n\r\n```\r\nException: [ReflectionProperty::setValue(): Argument #1 ($objectOrValue) must be of type object, null given]\r\n```\r\n\r\n(The first error is what happens when I recreate locally, the second is what we saw on our live system. This has only started happening since upgrading to PHP 8.)\r\n\r\nI believe the result of `Entitymanager->find` needs to be checked to ensure it is an object.\r\n\r\n#### How to reproduce\r\n\r\nSee #9028 for a failing test case and suggested fix.\r\n\r\n```php\r\n/** @Entity */\r\nclass Customer\r\n{\r\n    /**\r\n     * One Customer has One Cart.\r\n     * @OneToOne(targetEntity=\"Cart\", mappedBy=\"customer\")\r\n     */\r\n    private $cart;\r\n}\r\n\r\n/** @Entity */\r\nclass Cart\r\n{\r\n    /**\r\n     * One Cart has One Customer.\r\n     * @OneToOne(targetEntity=\"Customer\", inversedBy=\"cart\")\r\n     * @JoinColumn(name=\"customer_id\", referencedColumnName=\"id\")\r\n     */\r\n    private $customer;\r\n}\r\n\r\n$uow = new UnitOfWork($this->_em);\r\n$hints = ['fetchMode' => [Cart::class => ['customer' => ClassMetadata::FETCH_EAGER]]];\r\n$cart = $uow->createEntity(Cart::class, ['id' => 1, 'customer' => 24252], $hints);\r\n\r\n$this->assertEquals(null, $cart->customer);\r\n```\r\n\r\nThis throws:\r\n> spl_object_hash(): Argument #1 ($object) must be of type object, null given\r\n\r\n#### Expected behavior\r\n\r\nThe error shouldn't throw and `$cart->customer` should be null.","closed_by":{"login":"derrabus","id":1506493,"node_id":"MDQ6VXNlcjE1MDY0OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1506493?v=4","gravatar_id":"","url":"https://api.github.com/users/derrabus","html_url":"https://github.com/derrabus","followers_url":"https://api.github.com/users/derrabus/followers","following_url":"https://api.github.com/users/derrabus/following{/other_user}","gists_url":"https://api.github.com/users/derrabus/gists{/gist_id}","starred_url":"https://api.github.com/users/derrabus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/derrabus/subscriptions","organizations_url":"https://api.github.com/users/derrabus/orgs","repos_url":"https://api.github.com/users/derrabus/repos","events_url":"https://api.github.com/users/derrabus/events{/privacy}","received_events_url":"https://api.github.com/users/derrabus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/9027/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/9027/timeline","performed_via_github_app":null,"state_reason":"completed"}