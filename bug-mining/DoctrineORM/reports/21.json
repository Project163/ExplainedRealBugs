{"url":"https://api.github.com/repos/doctrine/orm/issues/8106","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/8106/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/8106/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/8106/events","html_url":"https://github.com/doctrine/orm/issues/8106","id":600431145,"node_id":"MDU6SXNzdWU2MDA0MzExNDU=","number":8106,"title":"QueryBuilder::setParameter() breaks if parameter name with ':' is set multiple times","user":{"login":"tom93","id":5887562,"node_id":"MDQ6VXNlcjU4ODc1NjI=","avatar_url":"https://avatars.githubusercontent.com/u/5887562?v=4","gravatar_id":"","url":"https://api.github.com/users/tom93","html_url":"https://github.com/tom93","followers_url":"https://api.github.com/users/tom93/followers","following_url":"https://api.github.com/users/tom93/following{/other_user}","gists_url":"https://api.github.com/users/tom93/gists{/gist_id}","starred_url":"https://api.github.com/users/tom93/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tom93/subscriptions","organizations_url":"https://api.github.com/users/tom93/orgs","repos_url":"https://api.github.com/users/tom93/repos","events_url":"https://api.github.com/users/tom93/events{/privacy}","received_events_url":"https://api.github.com/users/tom93/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-04-15T16:30:40Z","updated_at":"2024-07-26T16:02:16Z","closed_at":"2024-07-26T16:02:16Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Report\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | technically yes, broke in 2.3.0 commit [1635e0af4](https://github.com/doctrine/orm/commit/1635e0af4b06ef3015205563b59b505ae3fac69d#diff-6e1fe274092a9dc90ad2f6728df45c6aL358)\r\n| Version     | 2.3.0, v2.7.2, 2.8.x @ 3c91792dd, master @ 8c259ea5c\r\n\r\n#### Summary\r\n\r\n`QueryBuilder::setParameter()` breaks if a parameter name that starts with `:` is set multiple times.\r\n(Parameter names that don't start with a colon can be set multiple times without issues, and normally it is allowed to prefix a parameter name with a colon.)\r\n\r\n#### Current behavior\r\n\r\nAn exception is thrown when the query is executed:\r\n> Doctrine\\ORM\\Query\\QueryException: Too many parameters\r\n\r\n#### How to reproduce\r\n\r\n```php\r\n// without colon (succeeds)\r\n$qb = $em->createQueryBuilder();\r\n$qb\r\n    ->select('u')\r\n    ->from('User', 'u')\r\n    ->where('u.id = :id')\r\n    ->setParameter('id', 1)  // <--\r\n    ->setParameter('id', 1); // <--\r\ndump($qb->getQuery()->getResult());\r\n// success\r\n```\r\n\r\n```php\r\n// with colon (throws exception)\r\n$qb = $em->createQueryBuilder();\r\n$qb\r\n    ->select('u')\r\n    ->from('User', 'u')\r\n    ->where('u.id = :id')\r\n    ->setParameter(':id', 1)  // <--\r\n    ->setParameter(':id', 1); // <--\r\ndump($qb->getQuery()->getResult());\r\n// Doctrine\\ORM\\Query\\QueryException: Too many parameters: the query defines 1 parameters and you bound 2 in [...]\r\n```\r\n\r\n#### Expected behavior\r\n\r\nThe second snippet (with colon) should succeed and produce the same result as the first snippet.\r\n\r\n#### Cause\r\n\r\n`setParameter($key, ...)` checks if $key already exists using `getParameter($key)`, which compares $key to the names of the existing Query\\Parameter objects:\r\nhttps://github.com/doctrine/orm/blob/8c259ea5cb632dbb57001b2262048ae7fa52b102/lib/Doctrine/ORM/QueryBuilder.php#L606\r\n\r\nWhen $key starts with a colon, the comparison always fails because the names of the existing Query\\Parameter objects are trimmed of colons in the constructor:\r\nhttps://github.com/doctrine/orm/blob/8c259ea5cb632dbb57001b2262048ae7fa52b102/lib/Doctrine/ORM/Query/Parameter.php#L49\r\n\r\n#### Fix\r\n\r\n`getParameter()` should trim colons from $key to match the behaviour of the Query\\Parameter constructor.\r\nTo avoid code duplication, the existing trimming code could be moved to a separate function such as `Query\\Parameter::normalizeName()`.\r\n(Another approach is for `getParameter()` create a dummy instance of Query\\Parameter to normalize $key, but that's ugly and requires a dummy value and type.)\r\n\r\n#### Pull request\r\n\r\n#8107\r\n\r\n#### Background / original use case\r\n\r\n<details>\r\n\r\nWhen building complex queries with conditional parts, it can be useful to call `setParameter()` multiple times with the same parameter.\r\nHere is a contrived example that lists users, optionally filtered by a pattern. It can be configured to search for users by first name, last name, or both:\r\n\r\n```php\r\n$qb = $em->createQueryBuilder();\r\n$qb\r\n    ->select('u')\r\n    ->from('User', 'u');\r\nif ($searchFirstName) {\r\n    $qb\r\n        ->orWhere('u.first_name LIKE :pattern')\r\n        ->setParameter('pattern', $pattern);\r\n}\r\nif ($searchLastName) {\r\n    $qb\r\n        ->orWhere('u.last_name LIKE :pattern')\r\n        ->setParameter('pattern', $pattern);\r\n}\r\n```\r\n\r\nNote that the `setParameter()` calls cannot be combined and moved outside the `if` statements, because then when both conditions are false the parameter would be unused, resulting in the following error:\r\n```\r\nDoctrine\\ORM\\Query\\QueryException: Too many parameters: the query defines 0 parameters and you bound 1 in [...]\r\n```\r\n\r\nThe [QueryBuilder documentation](https://www.doctrine-project.org/projects/doctrine-orm/en/2.7/reference/query-builder.html) doesn't use leading colons in parameter names passed to `setParameter()`, but they are supported and are popular in some projects (maybe the practice has been adopted from [PDO](https://www.php.net/manual/en/pdostatement.bindparam.php)).\r\n\r\n</details>","closed_by":{"login":"tom93","id":5887562,"node_id":"MDQ6VXNlcjU4ODc1NjI=","avatar_url":"https://avatars.githubusercontent.com/u/5887562?v=4","gravatar_id":"","url":"https://api.github.com/users/tom93","html_url":"https://github.com/tom93","followers_url":"https://api.github.com/users/tom93/followers","following_url":"https://api.github.com/users/tom93/following{/other_user}","gists_url":"https://api.github.com/users/tom93/gists{/gist_id}","starred_url":"https://api.github.com/users/tom93/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tom93/subscriptions","organizations_url":"https://api.github.com/users/tom93/orgs","repos_url":"https://api.github.com/users/tom93/repos","events_url":"https://api.github.com/users/tom93/events{/privacy}","received_events_url":"https://api.github.com/users/tom93/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/8106/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/8106/timeline","performed_via_github_app":null,"state_reason":"completed"}