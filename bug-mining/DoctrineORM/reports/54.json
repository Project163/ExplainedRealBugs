{"url":"https://api.github.com/repos/doctrine/orm/issues/10927","repository_url":"https://api.github.com/repos/doctrine/orm","labels_url":"https://api.github.com/repos/doctrine/orm/issues/10927/labels{/name}","comments_url":"https://api.github.com/repos/doctrine/orm/issues/10927/comments","events_url":"https://api.github.com/repos/doctrine/orm/issues/10927/events","html_url":"https://github.com/doctrine/orm/issues/10927","id":1876942620,"node_id":"I_kwDOAAkff85v398c","number":10927,"title":"IDENTITY identifier strategy for PostgreSQL breaks when inherited from MappedSuperclass","user":{"login":"DemoniacDeath","id":500550,"node_id":"MDQ6VXNlcjUwMDU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/500550?v=4","gravatar_id":"","url":"https://api.github.com/users/DemoniacDeath","html_url":"https://github.com/DemoniacDeath","followers_url":"https://api.github.com/users/DemoniacDeath/followers","following_url":"https://api.github.com/users/DemoniacDeath/following{/other_user}","gists_url":"https://api.github.com/users/DemoniacDeath/gists{/gist_id}","starred_url":"https://api.github.com/users/DemoniacDeath/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DemoniacDeath/subscriptions","organizations_url":"https://api.github.com/users/DemoniacDeath/orgs","repos_url":"https://api.github.com/users/DemoniacDeath/repos","events_url":"https://api.github.com/users/DemoniacDeath/events{/privacy}","received_events_url":"https://api.github.com/users/DemoniacDeath/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":296201252,"node_id":"MDU6TGFiZWwyOTYyMDEyNTI=","url":"https://api.github.com/repos/doctrine/orm/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2023-09-01T07:58:39Z","updated_at":"2024-01-12T21:59:16Z","closed_at":"2024-01-12T21:59:15Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### BC Break Report\r\n\r\n|    Q        |   A\r\n|------------ | ------\r\n| BC Break    | yes\r\n| Version     | 2.16.0\r\n\r\n#### Summary\r\n\r\nPersisting an `@Entity` which has it's `@Id` defined in it's parent (`@MappedSuperclass`) with `IDENTITY` generator strategy on PostgreSQL platform.\r\nIt seems that the breaking change occured in this PR https://github.com/doctrine/orm/pull/10455, specifically changes in `ClassMetadataFactory` that removed the condtion of `$rootEntityFound` for calling `inheritIdGeneratorMapping()`\r\n\r\n#### Previous behavior\r\n\r\nIn version `2.15.5` the `IdentityGenerator` used to retrieve inserted id came from the Entity itself with `$sequenceName` matching the schema. So the value was retrieved from the correct sequence.\r\n\r\n#### Current behavior\r\n\r\nNow the `IdentityGenerator` used to retrieve inserted id comes from the parent `@MappedSuperclass` and `$sequenceName` is wrong (name of parent class + sequence suffix) and non-existent in schema, so a PostgreSQL error about relation not existing is thrown.\r\n\r\n#### How to reproduce\r\n\r\nE.g. (irrelevant code and domain-specific terminology is ommited):\r\n```php\r\n/**\r\n * @ORM\\MappedSuperclass\r\n */\r\nabstract class AbstractTaskOperatorHistoryRecord\r\n{\r\n    /**\r\n     * @ORM\\Id\r\n     * @ORM\\Column(type=\"integer\")\r\n     * @ORM\\GeneratedValue(strategy=\"IDENTITY\")\r\n     */\r\n    private ?int $id = null;\r\n}\r\n```\r\n\r\n```php\r\n/**\r\n * @ORM\\Entity()\r\n * @ORM\\Table(name=\"foo_bar_task_operator_history\")\r\n */\r\nclass FooBarTaskOperatorHistoryRecord extends AbstractTaskOperatorHistoryRecord\r\n{\r\n}\r\n```\r\n\r\n```php\r\n$this->_em->persist(new FooBarTaskOperatorHistoryRecord());\r\n$this->_em->flush();\r\n```\r\n\r\nThe PostgreSQL sequence used by `id` column in `foo_bar_task_operator_history` table is `foo_bar_task_operator_history_id_seq`.\r\nThe sequence used to retrieve inserted id was `foo_bar_task_operator_history_id_seq` before the breaking change. Now it is trying to get the value from `abstracttaskoperatorhistoryrecord_id_seq` which obviously does not and should not exist. The error thrown is\r\n```\r\nPDOException\r\n\r\nSQLSTATE[42P01]: Undefined table: 7 ERROR: relation \"abstracttaskoperatorhistoryrecord_id_seq\" does not exist\r\n```","closed_by":{"login":"mpdude","id":1202333,"node_id":"MDQ6VXNlcjEyMDIzMzM=","avatar_url":"https://avatars.githubusercontent.com/u/1202333?v=4","gravatar_id":"","url":"https://api.github.com/users/mpdude","html_url":"https://github.com/mpdude","followers_url":"https://api.github.com/users/mpdude/followers","following_url":"https://api.github.com/users/mpdude/following{/other_user}","gists_url":"https://api.github.com/users/mpdude/gists{/gist_id}","starred_url":"https://api.github.com/users/mpdude/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mpdude/subscriptions","organizations_url":"https://api.github.com/users/mpdude/orgs","repos_url":"https://api.github.com/users/mpdude/repos","events_url":"https://api.github.com/users/mpdude/events{/privacy}","received_events_url":"https://api.github.com/users/mpdude/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/doctrine/orm/issues/10927/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/doctrine/orm/issues/10927/timeline","performed_via_github_app":null,"state_reason":"completed"}