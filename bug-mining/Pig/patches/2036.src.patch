diff --git a/CHANGES.txt b/CHANGES.txt
index 506a4d21f..a99bb93db 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -167,6 +167,8 @@ OPTIMIZATIONS
  
 BUG FIXES
 
+PIG-5474: Casting error or empty output when as clause is used on a bag with schema not defined (rohini)
+
 PIG-5473: Fix issues found in release candidate (rohini)
 
 PIG-5458: Update metrics-core.version (knoguchi)
diff --git a/src/org/apache/pig/DefaultCaster.java b/src/org/apache/pig/DefaultCaster.java
new file mode 100644
index 000000000..c023e6af3
--- /dev/null
+++ b/src/org/apache/pig/DefaultCaster.java
@@ -0,0 +1,37 @@
+/* Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.pig;
+
+import org.apache.pig.builtin.Utf8StorageConverter;
+import org.apache.pig.classification.InterfaceAudience;
+
+import java.io.IOException;
+
+@InterfaceAudience.Private
+public class DefaultCaster {
+
+    /**
+     * This will be used for POCast added for as clauses (PIG-2315)
+     * when the CastLineageSetter cannot determine the LoadFunc/EvalFunc to use.
+     * @return the {@link LoadCaster}
+     * @throws IOException if there is an exception during LoadCaster
+     */
+    public LoadCaster getLoadCaster() throws IOException {
+        return new Utf8StorageConverter();
+    }
+
+}
diff --git a/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java b/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java
index 3ceedfc7f..9b031819e 100644
--- a/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java
+++ b/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java
@@ -28,6 +28,7 @@ import java.util.Map;
 
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
+import org.apache.pig.DefaultCaster;
 import org.apache.pig.EvalFunc;
 import org.apache.pig.FuncSpec;
 import org.apache.pig.LoadCaster;
@@ -92,6 +93,8 @@ public class POCast extends ExpressionOperator {
                 caster = ((StreamToPig)obj).getLoadCaster();
             } else if (obj instanceof EvalFunc) {
                 caster = ((EvalFunc)obj).getLoadCaster();
+            } else if (obj instanceof DefaultCaster) {
+                caster = ((DefaultCaster)obj).getLoadCaster();
             } else {
                 throw new IOException("Invalid class type "
                         + funcSpec.getClassName());
diff --git a/src/org/apache/pig/newplan/logical/expression/CastExpression.java b/src/org/apache/pig/newplan/logical/expression/CastExpression.java
index c34ea5aff..23755e0a9 100644
--- a/src/org/apache/pig/newplan/logical/expression/CastExpression.java
+++ b/src/org/apache/pig/newplan/logical/expression/CastExpression.java
@@ -29,11 +29,17 @@ import org.apache.pig.parser.SourceLocation;
 public class CastExpression extends UnaryExpression {
     private FuncSpec castFunc;
     private LogicalSchema.LogicalFieldSchema castSchema;
+    private boolean useDefaultCaster;
 
     public CastExpression(OperatorPlan plan, LogicalExpression exp, LogicalSchema.LogicalFieldSchema fs) {
+        this(plan, exp, fs, false);
+    }
+
+    public CastExpression(OperatorPlan plan, LogicalExpression exp, LogicalSchema.LogicalFieldSchema fs, boolean useDefaultCaster) {
         super("Cast", plan, exp);
         castSchema = fs.deepCopy();
         castSchema.resetUid();
+        this.useDefaultCaster = useDefaultCaster;
     }
 
     @Override
@@ -44,6 +50,10 @@ public class CastExpression extends UnaryExpression {
         ((LogicalExpressionVisitor)v).visit(this);
     }
 
+    public boolean isUseDefaultCaster() {
+        return useDefaultCaster;
+    }
+
     /**
      * Set the <code>FuncSpec</code> that performs the casting functionality
      * @param spec the <code>FuncSpec</code> that does the casting
diff --git a/src/org/apache/pig/newplan/logical/visitor/CastLineageSetter.java b/src/org/apache/pig/newplan/logical/visitor/CastLineageSetter.java
index 1a7117ef0..98ac73f8c 100644
--- a/src/org/apache/pig/newplan/logical/visitor/CastLineageSetter.java
+++ b/src/org/apache/pig/newplan/logical/visitor/CastLineageSetter.java
@@ -19,6 +19,7 @@ package org.apache.pig.newplan.logical.visitor;
 
 import java.util.Map;
 
+import org.apache.pig.DefaultCaster;
 import org.apache.pig.FuncSpec;
 import org.apache.pig.PigWarning;
 import org.apache.pig.data.DataType;
@@ -104,14 +105,14 @@ public class CastLineageSetter extends AllExpressionVisitor{
             if(containsByteArrayOrEmtpyInSchema(cast.getExpression().getFieldSchema())){
                 long inUid = cast.getExpression().getFieldSchema().uid;
                 FuncSpec inLoadFunc = uid2LoadFuncMap.get(inUid);
-                if(inLoadFunc == null){
+                if(inLoadFunc == null && !cast.isUseDefaultCaster()){
                     String msg = "Cannot resolve load function to use for casting from " + 
                                 DataType.findTypeName(inType) + " to " +
                                 DataType.findTypeName(outType) + " at " + cast.getLocation() ;
                     msgCollector.collect(msg, MessageType.Warning,
                            PigWarning.NO_LOAD_FUNCTION_FOR_CASTING_BYTEARRAY);
-                }else {
-                    cast.setFuncSpec(inLoadFunc);
+                } else {
+                    cast.setFuncSpec(inLoadFunc == null ? new FuncSpec(DefaultCaster.class.getName()) : inLoadFunc);
                 }
             }
         }
diff --git a/src/org/apache/pig/newplan/logical/visitor/ForEachUserSchemaVisitor.java b/src/org/apache/pig/newplan/logical/visitor/ForEachUserSchemaVisitor.java
index 304012cea..9e360e9fe 100644
--- a/src/org/apache/pig/newplan/logical/visitor/ForEachUserSchemaVisitor.java
+++ b/src/org/apache/pig/newplan/logical/visitor/ForEachUserSchemaVisitor.java
@@ -254,7 +254,7 @@ public class ForEachUserSchemaVisitor extends LogicalRelationalNodesVisitor {
         exp.add(prj);
 
         if (needCaster) {
-            CastExpression cast = new CastExpression(exp, prj, new LogicalSchema.LogicalFieldSchema(fs));
+            CastExpression cast = new CastExpression(exp, prj, new LogicalSchema.LogicalFieldSchema(fs), true);
             exp.add(cast);
         }
         exps.add(exp);
diff --git a/test/org/apache/pig/test/TestFlatten.java b/test/org/apache/pig/test/TestFlatten.java
index a1aeca13f..d617458a6 100644
--- a/test/org/apache/pig/test/TestFlatten.java
+++ b/test/org/apache/pig/test/TestFlatten.java
@@ -18,14 +18,19 @@ package org.apache.pig.test;
 import static org.junit.Assert.assertTrue;
 import static org.junit.Assert.assertEquals;
 
+import java.io.IOException;
 import java.util.List;
 import java.util.Map;
 
+import org.apache.pig.EvalFunc;
 import org.apache.pig.PigServer;
 import org.apache.pig.backend.executionengine.ExecJob;
 import org.apache.pig.builtin.mock.Storage;
 import org.apache.pig.data.DataBag;
+import org.apache.pig.data.DataByteArray;
+import org.apache.pig.data.DefaultDataBag;
 import org.apache.pig.data.Tuple;
+import org.apache.pig.data.TupleFactory;
 import org.apache.pig.impl.logicalLayer.schema.Schema;
 import org.apache.pig.impl.util.Utils;
 import org.junit.Before;
@@ -386,4 +391,161 @@ public class TestFlatten {
 
         Util.checkQueryOutputs(actualResults.iterator(), expectedResults);
     }
+
+    @Test
+    public void testFlattenOnUDFWithNoSchemaAndAsClauseCastError() throws Exception {
+        /*
+        This is a regression caused by PIG-2315.
+        The extra POCast added by ForEachUserSchemaVisitor when AS clause has schema, encounters below error
+        as CastLineageSetter was unable to determine and set a LoadFunc on it causing caster to be null
+
+        ERROR 1075: Received a bytearray from the UDF or Union from two different Loaders. Cannot determine how to convert the bytearray to string for [x1[-1,-1]]
+        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POCast.getNextString(POCast.java:1125)
+         */
+        Storage.Data data = Storage.resetData(pig);
+        data.set("input",
+                Storage.tuple(1, 1.1, "quick"),
+                Storage.tuple(2, 2.2, "brown"),
+                Storage.tuple(3, 3.3, "fox"),
+                Storage.tuple(4, 4.4, "jumps"),
+                Storage.tuple(5, null, "over"),
+                Storage.tuple(6, null, null)
+        );
+        data.set("input1",
+                Storage.tuple(1, new DataByteArray("the")),
+                Storage.tuple(2, new DataByteArray("lazy")),
+                Storage.tuple(3, new DataByteArray("dog")),
+                Storage.tuple(4, null));
+
+        pig.setBatchOn();
+        pig.registerQuery("A = load 'input' using mock.Storage() as (a0:int, a1:double, a2: chararray);");
+        // This FOREACH after LOAD is required to reproduce issue of CastLineageSetter not being able to resolve LoadFunc for casting
+        // Without that the issue is not reproducible
+        pig.registerQuery("A = FOREACH A GENERATE a0, a1, SUBSTRING(a2,0,4) as a2:chararray;");
+        pig.registerQuery("B = load 'input1' using mock.Storage() as (b0:int, b1:bytearray);");
+        pig.registerQuery("C = JOIN A BY a0 LEFT OUTER, B by b0;");
+        pig.registerQuery("D = FOREACH C GENERATE A::a0 as a0, A::a1 as a1, B::b1 as b1, TOTUPLE(a1, a2, b1) as tup1;");
+        pig.registerQuery("E = GROUP D BY (a0, a1, b1);");
+        pig.registerQuery("F = FOREACH E GENERATE group.$0 as a0, group.$1 as a1, group.$2 as b1, $1.tup1 as bag1;");
+        pig.registerQuery("G = FOREACH F GENERATE a0, org.apache.pig.test.TestFlatten$UDFWithNoOutputSchema(a0, a1, b1, bag1) as bag2;");
+        pig.registerQuery("H = FOREACH G GENERATE a0, FLATTEN(bag2) as (x1:chararray, x2:double, x3:chararray, x4:long);");
+        pig.registerQuery("STORE H INTO 'output' USING mock.Storage();");
+
+        List<ExecJob> execJobs = pig.executeBatch();
+        for( ExecJob execJob : execJobs ) {
+            assertTrue(execJob.getStatus() == ExecJob.JOB_STATUS.COMPLETED );
+        }
+        List<Tuple> actualResults = data.get("output");
+        List<Tuple> expectedResults = Util.getTuplesFromConstantTupleStrings(
+                new String[] {
+                        "(1, 'the', 1.1, 'the', 3L)",
+                        "(2, 'lazy', 2.2, 'lazy', 3L)",
+                        "(3, 'dog', 3.3, 'dog', 3L)",
+                        "(4, null, 4.4, null, 4L)",
+                        "(5, null, null, null, 5L)",
+                        "(6, null, null, null, 6L)"
+                });
+        Util.checkQueryOutputsAfterSort(actualResults.iterator(), expectedResults);
+    }
+
+    @Test
+    public void testFlattenOnUDFWithNoSchemaAndAsClauseWrongOutput() throws Exception {
+        /*
+            This is a regression caused by PIG-2315.
+            Casting fields of the bag returned by UDF with no outputSchema() throws error (Refer testFlattenOnUDFWithNoSchemaAndAsClauseCastError),
+            But when AS clause is defined directly on the bag returned by UDF, the bag output becomes empty.
+            This is because the whole bag is being casted using POCast.getNextDataBag compared to FLATTEN(bag) which casts
+            individual fields. It swallows the IOException for caster not being set and discards the row with the warning message
+            PigWarning.FIELD_DISCARDED_TYPE_CONVERSION_FAILED leading to empty output.
+
+                |   Cast[bag:{(chararray,double,chararray,long)}] - scope-84
+                |   |
+                |   |---Project[bag][1] - scope-83
+         */
+        Storage.Data data = Storage.resetData(pig);
+        data.set("input",
+                Storage.tuple(1, 1.1, "quick"),
+                Storage.tuple(2, 2.2, "brown"),
+                Storage.tuple(3, 3.3, "fox"),
+                Storage.tuple(4, 4.4, "jumps"),
+                Storage.tuple(5, null, "over"),
+                Storage.tuple(6, null, null)
+        );
+        data.set("input1",
+                Storage.tuple(1, new DataByteArray("the")),
+                Storage.tuple(2, new DataByteArray("lazy")),
+                Storage.tuple(3, new DataByteArray("dog")),
+                Storage.tuple(4, null));
+
+        pig.setBatchOn();
+        pig.registerQuery("A = load 'input' using mock.Storage() as (a0:int, a1:double, a2: chararray);");
+        pig.registerQuery("A = FOREACH A GENERATE a0, a1, SUBSTRING(a2,0,4) as a2:chararray;");
+        pig.registerQuery("B = load 'input1' using mock.Storage() as (b0:int, b1:bytearray);");
+        pig.registerQuery("C = JOIN A BY a0 LEFT OUTER, B by b0;");
+        pig.registerQuery("D = FOREACH C GENERATE A::a0 as a0, A::a1 as a1, B::b1 as b1, TOTUPLE(a1, a2, b1) as tup1;");
+        pig.registerQuery("E = GROUP D BY (a0, a1, b1);");
+        pig.registerQuery("F = FOREACH E GENERATE group.$0 as a0, group.$1 as a1, group.$2 as b1, $1.tup1 as bag1;");
+        // Below two lines differ from testFlattenOnUDFWithNoSchemaAndAsClauseCastError
+        // and is something users tried when they encountered cast error
+        pig.registerQuery("G = FOREACH F GENERATE a0, org.apache.pig.test.TestFlatten$UDFWithNoOutputSchema(a0, a1, b1, bag1) as " +
+                "bag2:{t:(a1:chararray, a2:double, a3:chararray, a4:long)};");
+        pig.registerQuery("H = FOREACH G GENERATE a0, FLATTEN(bag2);");
+        pig.registerQuery("STORE H INTO 'output' USING mock.Storage();");
+
+        List<ExecJob> execJobs = pig.executeBatch();
+        for( ExecJob execJob : execJobs ) {
+            assertTrue(execJob.getStatus() == ExecJob.JOB_STATUS.COMPLETED );
+        }
+        List<Tuple> actualResults = data.get("output");
+        List<Tuple> expectedResults = Util.getTuplesFromConstantTupleStrings(
+                new String[] {
+                        "(1, 'the', 1.1, 'the', 3L)",
+                        "(2, 'lazy', 2.2, 'lazy', 3L)",
+                        "(3, 'dog', 3.3, 'dog', 3L)",
+                        "(4, null, 4.4, null, 4L)",
+                        "(5, null, null, null, 5L)",
+                        "(6, null, null, null, 6L)"
+                });
+        Util.checkQueryOutputsAfterSort(actualResults.iterator(), expectedResults);
+    }
+
+    public static class UDFWithNoOutputSchema extends EvalFunc<DataBag> {
+
+        private final TupleFactory tupleFactory;
+
+        public UDFWithNoOutputSchema() {
+            tupleFactory = TupleFactory.getInstance();
+        }
+
+        public DataBag exec(Tuple input) throws IOException {
+            Integer f0 = (Integer)input.get(0);
+            DataBag f3 = (DataBag)input.get(3);
+
+            DataBag result = new DefaultDataBag();
+            Tuple tuple = tupleFactory.newTuple(4);
+            tuple.set(1, input.get(1));
+            tuple.set(2, input.get(2));
+            if(f3 == null || f3.size() == 0) {
+                tuple.set(0, null);
+                tuple.set(3, null);
+            } else {
+                int size_nullcount = 0;
+                for (Tuple t: f3) {
+                    Tuple inner = ((Tuple)t.get(0));
+                    tuple.set(0, inner.get(2));
+                    size_nullcount = inner.size();
+                    // System.out.println("input fields = " + f0 + "," + input.get(1) + "," + input.get(2) + "," + t + "," + inner.size());
+                    for (Object o: inner) {
+                        size_nullcount = size_nullcount + (o == null ? 1 : 0);
+                        // System.out.println ("size_nullcount =" + size_nullcount + ", o=" + o);
+                    }
+                    break;
+                }
+                tuple.set(3, size_nullcount);
+            }
+            result.add(tuple);
+            return result;
+        }
+    }
+
 }
