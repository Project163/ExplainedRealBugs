diff --git a/CHANGES.txt b/CHANGES.txt
index 7bfc6563c..944ccc39f 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -133,6 +133,8 @@ PIG-3882: Multiquery off mode execution is not done in batch and very inefficien
  
 BUG FIXES
 
+PIG-3940: NullPointerException writing .pig_header for field with null name in JsonMetadata.java (mrflip via cheolsoo)
+
 PIG-3944: PigNullableWritable toString method throws NPE on null value (mauzhang via cheolsoo)
 
 PIG-3936: DBStorage fails on storing nulls for non varchar columns (jeremykarn via cheolsoo) 
diff --git a/src/org/apache/pig/builtin/JsonMetadata.java b/src/org/apache/pig/builtin/JsonMetadata.java
index 7f41a64ae..08a6f5dfd 100644
--- a/src/org/apache/pig/builtin/JsonMetadata.java
+++ b/src/org/apache/pig/builtin/JsonMetadata.java
@@ -122,9 +122,7 @@ public class JsonMetadata implements LoadMetadata, StoreMetadata {
 
                     if (descriptor instanceof HFile) {
                         Path descriptorPath = ((HPath) descriptor).getPath();
-                        String fileName = descriptorPath.getName();
                         Path parent = descriptorPath.getParent();
-                        String parentName = parent.toString();
                         container = new HDirectory((HDataStorage)storage,parent);
                     } else { // descriptor instanceof HDirectory
                         container = (HDirectory)descriptor;
@@ -314,10 +312,11 @@ public class JsonMetadata implements LoadMetadata, StoreMetadata {
                 OutputStream os = headerFilePath.create();
                 try {
                     String[] names = schema.fieldNames();
-
+                    String fn;
                     for (int i=0; i < names.length; i++) {
-                        os.write(names[i].getBytes("UTF-8"));
-                        if (i <names.length-1) {
+                        fn = ( (names[i] == null) ? ("$"+i) : names[i] );
+                        os.write(fn.getBytes("UTF-8"));
+                        if (i < names.length-1) {
                             os.write(fieldDel);
                         } else {
                             os.write(recordDel);
diff --git a/test/org/apache/pig/test/TestPigStorage.java b/test/org/apache/pig/test/TestPigStorage.java
index b30fc00da..f958a5a07 100644
--- a/test/org/apache/pig/test/TestPigStorage.java
+++ b/test/org/apache/pig/test/TestPigStorage.java
@@ -438,9 +438,7 @@ public class TestPigStorage  {
         Iterator<Tuple> sessions = pig.openIterator("Sessions");
         while (sessions.hasNext()) {
             System.out.println(sessions.next());
-}
-
-
+        }
     }
 
     // See PIG-1993
@@ -471,6 +469,24 @@ public class TestPigStorage  {
         Assert.assertFalse(sessions.hasNext());
     }
 
+    @Test
+    public void testPigStorageSchemaHeader() throws Exception {
+        pigContext.connect();
+        String query = "a = LOAD '" + datadir + "originput' using PigStorage(',') " +
+                "as (foo:chararray, bar:int);";
+        pig.registerQuery(query);
+        pig.registerQuery("a2 = FOREACH a GENERATE *, 1;"); // adds a field with a null schema name
+        pig.registerQuery("STORE a2 into '" + datadir + "nout' using PigStorage('\\t', '-schema');");
+
+        String outPath = FileLocalizer.fullPath(datadir + "nout/.pig_header",
+                pig.getPigContext());
+        Assert.assertTrue(FileLocalizer.fileExists(outPath,
+                pig.getPigContext()));
+
+        String[] header = Util.readOutput(pig.getPigContext(), outPath);
+        Assert.assertArrayEquals("Headers are not the same.", new String[] {"foo\tbar\t$2"}, header);
+    }
+
     @Test
     public void testPigStorageSchemaHeaderDelimiter() throws Exception {
         pigContext.connect();
