diff --git a/CHANGES.txt b/CHANGES.txt
index 55c14b449..f31f6d85c 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -70,6 +70,8 @@ OPTIMIZATIONS
  
 BUG FIXES
 
+PIG-4171: Streaming UDF fails when direct fetch optimization is enabled (cheolsoo)
+
 PIG-4170: Multiquery with different type of key gives wrong result (daijy)
 
 PIG-4104: Accumulator UDF throws OOM in Tez (rohini)
diff --git a/src/org/apache/pig/backend/hadoop/executionengine/fetch/FetchOptimizer.java b/src/org/apache/pig/backend/hadoop/executionengine/fetch/FetchOptimizer.java
index 59a23459a..b5baa8496 100644
--- a/src/org/apache/pig/backend/hadoop/executionengine/fetch/FetchOptimizer.java
+++ b/src/org/apache/pig/backend/hadoop/executionengine/fetch/FetchOptimizer.java
@@ -57,6 +57,7 @@ import org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOpe
 import org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POStream;
 import org.apache.pig.backend.hadoop.executionengine.physicalLayer.util.PlanHelper;
 import org.apache.pig.impl.PigContext;
+import org.apache.pig.impl.PigImplConstants;
 import org.apache.pig.impl.builtin.SampleLoader;
 import org.apache.pig.impl.plan.DepthFirstWalker;
 import org.apache.pig.impl.plan.VisitorException;
@@ -102,8 +103,10 @@ public class FetchOptimizer {
             // entire input to the client. That can be dangerous.
             boolean isFetchable = fpv.isPlanFetchable() && 
                     PlanHelper.containsPhysicalOperator(pp, POLimit.class);
-            if (isFetchable)
+            if (isFetchable) {
+                pc.getProperties().setProperty(PigImplConstants.CONVERTED_TO_FETCH, "true");
                 init(pp);
+            }
             return isFetchable;
         }
         return false;
diff --git a/src/org/apache/pig/impl/PigImplConstants.java b/src/org/apache/pig/impl/PigImplConstants.java
index 90a3d7fcd..ed2b7a360 100644
--- a/src/org/apache/pig/impl/PigImplConstants.java
+++ b/src/org/apache/pig/impl/PigImplConstants.java
@@ -42,6 +42,11 @@ public class PigImplConstants {
      */
     public static final String CONVERTED_TO_LOCAL = "pig.job.converted.local";
 
+    /**
+     * Used by pig to indicate that current job has been converted to run in fetch mode
+     */
+    public static final String CONVERTED_TO_FETCH = "pig.job.converted.fetch";
+
     /**
      * Indicate the split index of the task. Used by merge cogroup
      */
diff --git a/src/org/apache/pig/scripting/ScriptingOutputCapturer.java b/src/org/apache/pig/scripting/ScriptingOutputCapturer.java
index 69e57823c..73e9eaf7c 100644
--- a/src/org/apache/pig/scripting/ScriptingOutputCapturer.java
+++ b/src/org/apache/pig/scripting/ScriptingOutputCapturer.java
@@ -32,6 +32,7 @@ import org.apache.commons.logging.LogFactory;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.pig.ExecType;
 import org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MRConfiguration;
+import org.apache.pig.impl.PigImplConstants;
 import org.apache.pig.impl.util.UDFContext;
 
 import com.google.common.base.Charsets;
@@ -100,7 +101,7 @@ public class ScriptingOutputCapturer {
         log.debug("TaskId: " + taskId);
         log.debug("hadoopLogDir: " + hadoopLogDir);
 
-        if (execType.isLocal()) {
+        if (execType.isLocal() || conf.getBoolean(PigImplConstants.CONVERTED_TO_FETCH, false)) {
             String logDir = System.getProperty("pig.udf.scripting.log.dir");
             if (logDir == null)
                 logDir = ".";
