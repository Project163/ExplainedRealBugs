diff --git a/CHANGES.txt b/CHANGES.txt
index 0bc404498..af9f35b4f 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -92,6 +92,8 @@ OPTIMIZATIONS
  
 BUG FIXES
 
+PIG-4215: Fix unit test failure TestParamSubPreproc and TestMacroExpansion (daijy)
+
 PIG-4175: PIG CROSS operation follow by STORE produces non-deterministic results each run (daijy)
 
 PIG-4202: Reset UDFContext state before OutputCommitter invocations in Tez (rohini)
diff --git a/src/org/apache/pig/tools/parameters/PreprocessorContext.java b/src/org/apache/pig/tools/parameters/PreprocessorContext.java
index 2e05c74bf..8cf8a40a7 100644
--- a/src/org/apache/pig/tools/parameters/PreprocessorContext.java
+++ b/src/org/apache/pig/tools/parameters/PreprocessorContext.java
@@ -124,9 +124,10 @@ public class PreprocessorContext {
      * @param val - string containing command to be executed
      */
     public  void processShellCmd(String key, String val, Boolean overwrite)  throws ParameterSubstitutionException, FrontendException {
-        Preconditions.checkState(pigContext != null);
-        BlackAndWhitelistFilter filter = new BlackAndWhitelistFilter(pigContext);
-        filter.validate(PigCommandFilter.Command.SH);
+        if (pigContext != null) {
+            BlackAndWhitelistFilter filter = new BlackAndWhitelistFilter(pigContext);
+            filter.validate(PigCommandFilter.Command.SH);
+        }
 
         if (param_val.containsKey(key)) {
             if (param_source.get(key).equals(val) || !overwrite) {
@@ -146,7 +147,9 @@ public class PreprocessorContext {
     }
 
     public void validate(String preprocessorCmd) throws FrontendException {
-        Preconditions.checkState(pigContext != null);
+        if (pigContext == null) {
+            return;
+        }
 
         final BlackAndWhitelistFilter filter = new BlackAndWhitelistFilter(pigContext);
         final String declareToken = "%declare";
