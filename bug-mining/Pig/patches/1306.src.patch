diff --git a/CHANGES.txt b/CHANGES.txt
index acab6ee1a..43d673877 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -54,6 +54,8 @@ OPTIMIZATIONS
  
 BUG FIXES
 
+PIG-3581: Incorrect scope resolution with nested foreach (aniket486)
+
 PIG-3285: Jobs using HBaseStorage fail to ship dependency jars (ndimiduk via cheolsoo)
 
 PIG-3582: Document SUM, MIN, MAX, and AVG functions for BigInteger and BigDecimal (harichinnan via cheolsoo)
diff --git a/src/org/apache/pig/parser/LogicalPlanGenerator.g b/src/org/apache/pig/parser/LogicalPlanGenerator.g
index 1e213d1f5..cf09ba80e 100644
--- a/src/org/apache/pig/parser/LogicalPlanGenerator.g
+++ b/src/org/apache/pig/parser/LogicalPlanGenerator.g
@@ -1759,15 +1759,17 @@ alias_col_ref[LogicalExpressionPlan plan] returns[LogicalExpression expr]
            throw new PlanGenerationFailureException( input, loc, e );
        }
 
-       Operator op = builder.lookupOperator( alias );
-       if( op != null && ( schema == null || schema.getFieldPosition( alias ) == -1 ) ) {
-           $expr = new ScalarExpression( plan, op,
-               inForeachPlan ? $foreach_clause::foreachOp : $GScope::currentOp );
-           $expr.setLocation( loc );
+       // PIG-3581
+       // check within foreach scope before looking at outer scope for scalar
+       if( inForeachPlan && ($foreach_plan::operators).containsKey(alias)) {
+           $expr = builder.buildProjectExpr( loc, $plan, $GScope::currentOp,
+               $foreach_plan::operators, $foreach_plan::exprPlans, alias, 0 );
        } else {
-           if( inForeachPlan ) {
-               $expr = builder.buildProjectExpr( loc, $plan, $GScope::currentOp,
-                    $foreach_plan::operators, $foreach_plan::exprPlans, alias, 0 );
+           Operator op = builder.lookupOperator( alias );
+           if( op != null && ( schema == null || schema.getFieldPosition( alias ) == -1 ) ) {
+               $expr = new ScalarExpression( plan, op,
+                   inForeachPlan ? $foreach_clause::foreachOp : $GScope::currentOp );
+               $expr.setLocation( loc );
            } else {
                $expr = builder.buildProjectExpr( loc, $plan, $GScope::currentOp,
                    $statement::inputIndex, alias, 0 );
diff --git a/test/org/apache/pig/test/TestPigServer.java b/test/org/apache/pig/test/TestPigServer.java
index 483fa48d4..4c8d25e0a 100644
--- a/test/org/apache/pig/test/TestPigServer.java
+++ b/test/org/apache/pig/test/TestPigServer.java
@@ -500,6 +500,34 @@ public class TestPigServer {
         assertEquals(expectedSchema, dumpedSchema);
     }
 
+    private void registerScalarScript(boolean useScalar, String expectedSchemaStr) throws IOException {
+        pig.registerQuery("A = load 'adata' AS (a: int, b: int);");
+        //scalar
+        pig.registerQuery("C = FOREACH A GENERATE *;");
+        String overrideScalar = useScalar ? "C = FILTER A BY b % 2 == 0; " : "";
+        pig.registerQuery("B = FOREACH (GROUP A BY a) { " +
+                overrideScalar +
+                "D = FILTER A BY b % 2 == 1;" +
+                "GENERATE group AS a, A.b AS every, C.b AS even, D.b AS odd;" +
+                "};");
+        Schema dumpedSchema = pig.dumpSchema("B");
+        Schema expectedSchema = Utils.getSchemaFromString(
+                expectedSchemaStr);
+        assertEquals(expectedSchema, dumpedSchema);
+    }
+
+    // PIG-3581
+    @Test
+    public void testScalarPrecedence() throws Throwable {
+        registerScalarScript(true, "a: int,every: {(b: int)},even: {(b: int)},odd: {(b: int)}");
+    }
+
+    // PIG-3581
+    @Test
+    public void testScalarResolution() throws Throwable {
+        registerScalarScript(false, "a: int,every: {(b: int)},even: int,odd: {(b: int)}");
+    }
+
     @Test
     public void testExplainXmlComplex() throws Throwable {
         pig.registerQuery("a = load 'a' as (site: chararray, count: int, itemCounts: bag { itemCountsTuple: tuple (type: chararray, typeCount: int, f: float, m: map[]) } ) ;") ;
