diff --git a/CHANGES.txt b/CHANGES.txt
index 624885009..5937a0674 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -66,6 +66,8 @@ PIG-1876: Typed map for Pig (daijy)
 
 IMPROVEMENTS
 
+PIG-2039: IndexOutOfBounException for a case (xuefu)
+
 PIG-2038: Pig fails to parse empty tuple/map/bag constant (xuefu)
 
 PIG-1775: Removal of old logical plan (xuefu)
diff --git a/src/org/apache/pig/newplan/logical/relational/LOForEach.java b/src/org/apache/pig/newplan/logical/relational/LOForEach.java
index 0a2ff517d..8c6b55c4e 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOForEach.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOForEach.java
@@ -19,6 +19,7 @@ package org.apache.pig.newplan.logical.relational;
 
 import java.util.ArrayList;
 import java.util.List;
+import java.util.Stack;
 
 import org.apache.pig.impl.logicalLayer.FrontendException;
 import org.apache.pig.newplan.Operator;
@@ -79,13 +80,33 @@ public class LOForEach extends LogicalRelationalOperator {
         List<LOInnerLoad> innerLoads = new ArrayList<LOInnerLoad>();
         for (Operator src:srcs) {
             if (src instanceof LOInnerLoad) {
-                Operator succ = src;
-                while (succ!=null) {
-                    if (succ==referred)
+            	if( src == referred ) {
+            		innerLoads.add( (LOInnerLoad)src );
+            		continue;
+            	}
+            	
+                Stack<Operator> stack = new Stack<Operator>();
+                List<Operator> succs = referred.getPlan().getSuccessors( src );
+                if( succs != null ) {
+                	for( Operator succ : succs ) {
+                		stack.push( succ );
+                	}
+                }
+                
+                while( !stack.isEmpty() ) {
+                	Operator op = stack.pop();
+                    if( op == referred ) {
                         innerLoads.add((LOInnerLoad)src);
-                    if (referred.getPlan().getSuccessors(succ)==null)
                         break;
-                    succ = referred.getPlan().getSuccessors(succ).get(0);
+                    }
+                    else {
+                    	List<Operator> ops = referred.getPlan().getSuccessors( op );
+                    	if( ops != null ) {
+                        	for( Operator o : ops ) {
+                        		stack.push( o );
+                        	}
+                    	}
+                    }
                 }
             }
         }
diff --git a/test/org/apache/pig/test/TestLogicalPlanBuilder.java b/test/org/apache/pig/test/TestLogicalPlanBuilder.java
index 29cc44346..5869d88c2 100644
--- a/test/org/apache/pig/test/TestLogicalPlanBuilder.java
+++ b/test/org/apache/pig/test/TestLogicalPlanBuilder.java
@@ -1984,7 +1984,6 @@ public class TestLogicalPlanBuilder {
         buildPlan("a = foreach (load 'b') generate (([],[])); store a into 'output';");
     }
     
-/** The following test is disabled due to PIG-2039
     @Test
     // See PIG-1024, shall not throw exception
     public void testLimitMultipleOutput() throws Exception {
@@ -1994,7 +1993,6 @@ public class TestLogicalPlanBuilder {
                        " store c into 'output';";
         buildPlan( query );
     }
-*/
 
     @Test
     public void testCogroupByStarFailure1() throws Exception {
