diff --git a/CHANGES.txt b/CHANGES.txt
index 1da3f8c0d..73f2597e0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -323,6 +323,9 @@ PIG-1165: Signature of loader does not set correctly for order by (daijy)
 
 PIG-761: ERROR 2086 on simple JOIN (daijy)
 
+PIG-1172: PushDownForeachFlatten shall not push ForEach below Join if the
+flattened fields is used in Join (daijy)
+
 Release 0.5.0
 
 INCOMPATIBLE CHANGES
diff --git a/src/org/apache/pig/impl/logicalLayer/LOForEach.java b/src/org/apache/pig/impl/logicalLayer/LOForEach.java
index 9b172abf7..37fff9eb4 100644
--- a/src/org/apache/pig/impl/logicalLayer/LOForEach.java
+++ b/src/org/apache/pig/impl/logicalLayer/LOForEach.java
@@ -795,11 +795,8 @@ public class LOForEach extends RelationalOperator {
         return new Pair<Boolean, List<Integer>>(hasFlatten, flattenedColumns);
     }
     
-    public LogicalPlan getRelevantPlan(int output, int column)
+    public LogicalPlan getRelevantPlan(int column)
     {
-        if (output!=0)
-            return null;
-
         if (column<0)
             return null;
 
@@ -814,6 +811,22 @@ public class LOForEach extends RelationalOperator {
         return mSchemaPlanMapping.get(column);
     }
     
+    public boolean isInputFlattened(int column) throws FrontendException {
+        LogicalPlan plan = getRelevantPlan(column);
+        if (plan==null) {
+            int errCode = 2195;
+            throw new FrontendException("Fail to get foreach plan for input column "+column,
+                    errCode, PigException.BUG);
+        }
+        int index = mForEachPlans.indexOf(plan);
+        if (index==-1) {
+            int errCode = 2195;
+            throw new FrontendException("Fail to get foreach plan for input column "+column,
+                    errCode, PigException.BUG);
+        }
+        return mFlatten.get(index);
+    }
+    
     @Override
     public List<RequiredFields> getRelevantInputs(int output, int column) throws FrontendException {
         if (!mIsSchemaComputed)
@@ -835,7 +848,7 @@ public class LOForEach extends RelationalOperator {
             return null;
         }
         
-        LogicalPlan plan = getRelevantPlan(output, column);
+        LogicalPlan plan = getRelevantPlan(column);
         
         TopLevelProjectFinder projectFinder = new TopLevelProjectFinder(
                 plan);
@@ -946,7 +959,7 @@ public class LOForEach extends RelationalOperator {
             int index = planToRemove.get(planToRemove.size()-1);
             if (mUserDefinedSchema!=null) {
                 for (int i=mUserDefinedSchema.size()-1;i>=0;i--) {
-                    if (getRelevantPlan(0, i)==mForEachPlans.get(index))
+                    if (getRelevantPlan(i)==mForEachPlans.get(index))
                         mUserDefinedSchema.remove(i);
                 }
             }
diff --git a/src/org/apache/pig/impl/logicalLayer/optimizer/PruneColumns.java b/src/org/apache/pig/impl/logicalLayer/optimizer/PruneColumns.java
index d9db3f006..adc3e677d 100644
--- a/src/org/apache/pig/impl/logicalLayer/optimizer/PruneColumns.java
+++ b/src/org/apache/pig/impl/logicalLayer/optimizer/PruneColumns.java
@@ -292,7 +292,7 @@ public class PruneColumns extends LogicalTransformer {
                     else if (rlo instanceof LOForEach)
                     {
                         // Relay map keys from output to input
-                        LogicalPlan forEachPlan = ((LOForEach)rlo).getRelevantPlan(requiredOutputField.first, requiredOutputField.second);
+                        LogicalPlan forEachPlan = ((LOForEach)rlo).getRelevantPlan(requiredOutputField.second);
                         if (relevantFields.getFields()!=null && relevantFields.getFields().size()!=0)
                         {
                             int index = ((LOForEach)rlo).getForEachPlans().indexOf(forEachPlan);
diff --git a/src/org/apache/pig/impl/logicalLayer/optimizer/PushDownForeachFlatten.java b/src/org/apache/pig/impl/logicalLayer/optimizer/PushDownForeachFlatten.java
index 00a7d5dcf..29cf92768 100644
--- a/src/org/apache/pig/impl/logicalLayer/optimizer/PushDownForeachFlatten.java
+++ b/src/org/apache/pig/impl/logicalLayer/optimizer/PushDownForeachFlatten.java
@@ -19,6 +19,7 @@
 package org.apache.pig.impl.logicalLayer.optimizer;
 
 import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.List;
@@ -41,6 +42,7 @@ import org.apache.pig.impl.plan.OperatorKey;
 import org.apache.pig.impl.plan.ProjectionMap;
 import org.apache.pig.impl.plan.RequiredFields;
 import org.apache.pig.impl.plan.OperatorPlan.IndexHelper;
+import org.apache.pig.impl.plan.ProjectionMap.Column;
 import org.apache.pig.impl.plan.optimizer.OptimizerException;
 import org.apache.pig.PigException;
 import org.apache.pig.impl.util.MultiMap;
@@ -283,6 +285,23 @@ public class PushDownForeachFlatten extends LogicalTransformer {
                     }
                 }
                 
+                // Check if flattened fields is required by LOJoin, if so, don't optimize
+                if (successor instanceof LOJoin) {
+                    List<RequiredFields> requiredFieldsList = ((LOJoin)successor).getRequiredFields();
+                    RequiredFields requiredFields = requiredFieldsList.get(foreachPosition.intValue());
+                    
+                    MultiMap<Integer, Column> foreachMappedFields = foreachProjectionMap.getMappedFields();
+                    
+                    for (Pair<Integer, Integer> pair : requiredFields.getFields()) {
+                        Collection<Column> columns = foreachMappedFields.get(pair.second);
+                        for (Column column : columns) {
+                            Pair<Integer, Integer> foreachInputColumn = column.getInputColumn();
+                            if (foreach.isInputFlattened(foreachInputColumn.second))
+                                return false;
+                        }
+                    }
+                }
+                
                 mInsertBetween = true;
                 return true;
             }
diff --git a/test/org/apache/pig/test/TestPushDownForeachFlatten.java b/test/org/apache/pig/test/TestPushDownForeachFlatten.java
index 386bf3210..e7c8e6a8e 100644
--- a/test/org/apache/pig/test/TestPushDownForeachFlatten.java
+++ b/test/org/apache/pig/test/TestPushDownForeachFlatten.java
@@ -977,5 +977,27 @@ public class TestPushDownForeachFlatten extends junit.framework.TestCase {
 
     }
 
+    // See PIG-1172
+    @Test
+    public void testForeachJoinRequiredField() throws Exception {
+        planTester.buildPlan("A = load 'myfile' as (bg:bag{t:tuple(a0,a1)});");
+        planTester.buildPlan("B = FOREACH A generate flatten($0);");
+        planTester.buildPlan("C = load '3.txt' AS (c0, c1);");
+        planTester.buildPlan("D = JOIN B by a1, C by c1;");
+        LogicalPlan lp = planTester.buildPlan("E = limit D 10;");
+        
+        planTester.setPlan(lp);
+        planTester.setProjectionMap(lp);
+        planTester.rebuildSchema(lp);
+        
+        PushDownForeachFlatten pushDownForeach = new PushDownForeachFlatten(lp);
+
+        LOLoad loada = (LOLoad) lp.getRoots().get(0);
+        
+        assertTrue(!pushDownForeach.check(lp.getSuccessors(loada)));
+        assertTrue(pushDownForeach.getSwap() == false);
+        assertTrue(pushDownForeach.getInsertBetween() == false);
+    }
+
 }
 
