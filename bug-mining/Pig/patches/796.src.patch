diff --git a/CHANGES.txt b/CHANGES.txt
index bddd75413..a82fca94d 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -99,6 +99,8 @@ PIG-2011: Speed up TestTypedMap.java (dvryaboy)
 
 BUG FIXES
 
+PIG-2170: NPE thrown during illustrate (thejas)
+
 PIG-2186: PigStorage new warnings about missing schema file 
  can be confusing (thejas)
 
diff --git a/shims/src/hadoop20/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/PigMapBase.java b/shims/src/hadoop20/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/PigMapBase.java
index 3c8cec11f..6c4e78e08 100644
--- a/shims/src/hadoop20/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/PigMapBase.java
+++ b/shims/src/hadoop20/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/PigMapBase.java
@@ -24,7 +24,10 @@ import java.util.List;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.io.Text;
 import org.apache.hadoop.io.Writable;
+import org.apache.hadoop.mapreduce.Counter;
+import org.apache.hadoop.mapred.Counters;
 import org.apache.hadoop.mapreduce.InputSplit;
+import org.apache.hadoop.mapreduce.StatusReporter;
 import org.apache.hadoop.mapreduce.TaskAttemptID;
 import org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigGenericMapBase;
 import org.apache.pig.data.DataBag;
@@ -34,7 +37,7 @@ import org.apache.pig.impl.util.Pair;
 
 abstract public class PigMapBase extends PigGenericMapBase {
     /**
-     * 
+     *  
      * Get mapper's illustrator context
      * 
      * @param conf  Configuration
@@ -52,6 +55,40 @@ abstract public class PigMapBase extends PigGenericMapBase {
         return new IllustratorContext(conf, input, output, split);
     }
     
+    
+
+    /**
+     * Dummy implementation of StatusReporter for illustrate mode
+     *
+     */
+    @SuppressWarnings("deprecation")
+    public static class IllustrateDummyReporter extends StatusReporter{
+
+
+        Counters countGen = new Counters();
+        
+        @Override
+        public Counter getCounter(Enum<?> arg0) {
+            return countGen.findCounter(arg0);
+        }
+
+        @Override
+        public Counter getCounter(String group, String name) {
+            return countGen.findCounter(group, name);
+        }
+
+        @Override
+        public void progress() {
+            //no-op
+        }
+
+        @Override
+        public void setStatus(String arg0) {
+            //no-op
+        }
+        
+    }
+    
     public class IllustratorContext extends Context {
         private DataBag input;
         List<Pair<PigNullableWritable, Writable>> output;
@@ -62,12 +99,12 @@ abstract public class PigMapBase extends PigGenericMapBase {
         public IllustratorContext(Configuration conf, DataBag input,
               List<Pair<PigNullableWritable, Writable>> output,
               InputSplit split) throws IOException, InterruptedException {
-              super(conf, new TaskAttemptID(), null, null, null, null, split);
-              if (output == null)
-                  throw new IOException("Null output can not be used");
-              this.input = input; this.output = output;
+            super(conf, new TaskAttemptID(), null, null, null, new IllustrateDummyReporter(), split);
+            if (output == null)
+                throw new IOException("Null output can not be used");
+            this.input = input; this.output = output;
         }
-        
+
         @Override
         public boolean nextKeyValue() throws IOException, InterruptedException {
             if (input == null) {
diff --git a/src/org/apache/pig/pen/IllustratorAttacher.java b/src/org/apache/pig/pen/IllustratorAttacher.java
index d67ecd416..63089f50b 100644
--- a/src/org/apache/pig/pen/IllustratorAttacher.java
+++ b/src/org/apache/pig/pen/IllustratorAttacher.java
@@ -283,56 +283,56 @@ public class IllustratorAttacher extends PhyPlanVisitor {
     @Override
     public void visitGreaterThan(GreaterThanExpr grt) throws VisitorException{
         setIllustrator(grt, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(grt.getIllustrator().getSubExpResult());
     }
     
     @Override
     public void visitLessThan(LessThanExpr lt) throws VisitorException{
         setIllustrator(lt, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(lt.getIllustrator().getSubExpResult());
     }
     
     @Override
     public void visitGTOrEqual(GTOrEqualToExpr gte) throws VisitorException{
         setIllustrator(gte, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(gte.getIllustrator().getSubExpResult());
     }
     
     @Override
     public void visitLTOrEqual(LTOrEqualToExpr lte) throws VisitorException{
         setIllustrator(lte, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(lte.getIllustrator().getSubExpResult());
     }
     
     @Override
     public void visitEqualTo(EqualToExpr eq) throws VisitorException{
         setIllustrator(eq, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(eq.getIllustrator().getSubExpResult());
     }
     
     @Override
     public void visitNotEqualTo(NotEqualToExpr eq) throws VisitorException{
         setIllustrator(eq, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(eq.getIllustrator().getSubExpResult());
     }
     
     @Override
     public void visitRegexp(PORegexp re) throws VisitorException{
         setIllustrator(re, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(re.getIllustrator().getSubExpResult());
     }
 
     @Override
     public void visitIsNull(POIsNull isNull) throws VisitorException {
         setIllustrator(isNull, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(isNull.getIllustrator().getSubExpResult());
     }
     
@@ -349,15 +349,13 @@ public class IllustratorAttacher extends PhyPlanVisitor {
     @Override
     public void visitNot(PONot not) throws VisitorException {
         setIllustrator(not, 0);
-        if (!revisit)
+        if (!revisit && subExpResults != null)
             subExpResults.add(not.getIllustrator().getSubExpResult());
     }
 
     @Override
     public void visitBinCond(POBinCond binCond) {
-        setIllustrator(binCond, 0);
-        if (!revisit)
-            subExpResults.add(binCond.getIllustrator().getSubExpResult());
+
     }
 
     @Override
diff --git a/test/org/apache/pig/test/TestExampleGenerator.java b/test/org/apache/pig/test/TestExampleGenerator.java
index 29882fb16..9a56344f2 100644
--- a/test/org/apache/pig/test/TestExampleGenerator.java
+++ b/test/org/apache/pig/test/TestExampleGenerator.java
@@ -18,14 +18,15 @@
 
 package org.apache.pig.test;
 
+import static org.junit.Assert.assertTrue;
+
 import java.io.File;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.util.Map;
+import java.util.Properties;
 import java.util.Random;
 
-import junit.framework.TestCase;
-
 import org.apache.pig.ExecType;
 import org.apache.pig.PigServer;
 import org.apache.pig.backend.executionengine.ExecException;
@@ -34,22 +35,20 @@ import org.apache.pig.impl.PigContext;
 import org.apache.pig.impl.io.FileLocalizer;
 import org.apache.pig.newplan.Operator;
 import org.junit.AfterClass;
-import org.junit.Before;
+import org.junit.BeforeClass;
 import org.junit.Test;
-import org.junit.runner.RunWith;
-import org.junit.runners.JUnit4;
 
-@RunWith(JUnit4.class)
-public class TestExampleGenerator extends TestCase {
 
-    static MiniCluster cluster = MiniCluster.buildCluster();
-    PigContext pigContext = new PigContext(ExecType.MAPREDUCE, cluster
-            .getProperties());
+public class TestExampleGenerator {
 
-    Random rand = new Random();
-    int MAX = 100;
-    String A, B;
+    
+    static PigContext pigContext = new PigContext(ExecType.LOCAL, new Properties());
 
+   
+    static int MAX = 100;
+    static String A, B;
+    static  File fileA, fileB;
+    
     {
         try {
             pigContext.connect();
@@ -59,32 +58,26 @@ public class TestExampleGenerator extends TestCase {
         }
     }
 
-    @Before
-    public void setUp() throws Exception {
-        File fileA, fileB;
+    @BeforeClass
+    public static void oneTimeSetup() throws Exception {
+       
 
         fileA = File.createTempFile("dataA", ".dat");
         fileB = File.createTempFile("dataB", ".dat");
 
         writeData(fileA);
         writeData(fileB);
+     
 
-        A = "'" + FileLocalizer.hadoopify(fileA.toString(), pigContext) + "'";
-        B = "'" + FileLocalizer.hadoopify(fileB.toString(), pigContext) + "'";
-        System.out.println("A : " + A + "\n" + "B : " + B);
-        System.out.println("Test data created.");
         fileA.deleteOnExit();
         fileB.deleteOnExit();
-          
-    }
-
-    
-    @AfterClass
-    public static void oneTimeTearDown() throws Exception {
-        cluster.shutDown();
+        A = "'" + fileA.getPath() + "'";
+        B = "'" + fileB.getPath() + "'";
+        System.out.println("A : " + A + "\n" + "B : " + B);
+        System.out.println("Test data created.");
     }
 
-    private void writeData(File dataFile) throws Exception {
+    private static void writeData(File dataFile) throws Exception {
         // File dataFile = File.createTempFile(name, ".dat");
         FileOutputStream dat = new FileOutputStream(dataFile);
 
@@ -176,6 +169,34 @@ public class TestExampleGenerator extends TestCase {
 
         assertTrue(derivedData != null);
     }
+    
+    //see PIG-2170
+    @Test
+    public void testForeachBinCondWithBooleanExp() throws ExecException, IOException {
+        PigServer pigServer = new PigServer(pigContext);
+
+        pigServer.registerQuery("A = load " + A
+                + " using PigStorage() as (x : int, y : int);");
+        pigServer.registerQuery("B = foreach A generate  (x + 1 > y ? 0 : 1);");
+
+        Map<Operator, DataBag> derivedData = pigServer.getExamples("B");
+
+        assertTrue(derivedData != null);
+    }
+    
+    @Test
+    public void testForeachWithTypeCastCounter() throws ExecException, IOException {
+        PigServer pigServer = new PigServer(pigContext);
+        //cast error results in counter being incremented and was resulting
+        // in a NPE exception in illustrate
+        pigServer.registerQuery("A = load " + A
+                + " using PigStorage() as (x : int, y : int);");
+        pigServer.registerQuery("B = foreach A generate x, (int)'InvalidInt';");
+
+        Map<Operator, DataBag> derivedData = pigServer.getExamples("B");
+
+        assertTrue(derivedData != null);
+    }
 
     @Test
     public void testJoin() throws IOException, ExecException {
