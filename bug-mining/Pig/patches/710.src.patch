diff --git a/CHANGES.txt b/CHANGES.txt
index 8acd8eb30..8954617ce 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -186,6 +186,8 @@ PIG-1696: Performance: Use System.arraycopy() instead of manually copying the by
 
 BUG FIXES
 
+PIG-2004: Incorrect input types passed on to eval function (thejas)
+
 PIG-1814: mapred.output.compress in SET statement does not work (daijy)
 
 PIG-1976: One more TwoLevelAccess to remove (daijy)
diff --git a/src/org/apache/pig/newplan/logical/expression/BinCondExpression.java b/src/org/apache/pig/newplan/logical/expression/BinCondExpression.java
index cab179e55..7994050cb 100644
--- a/src/org/apache/pig/newplan/logical/expression/BinCondExpression.java
+++ b/src/org/apache/pig/newplan/logical/expression/BinCondExpression.java
@@ -103,7 +103,7 @@ public class BinCondExpression extends LogicalExpression {
         //TypeCheckingExpVisitor will ensure that lhs and rhs have same schema
         LogicalFieldSchema argFs = getLhs().getFieldSchema();
         fieldSchema = argFs.deepCopy();
-        fieldSchema.uid = -1;
+        fieldSchema.resetUid();
         
         uidOnlyFieldSchema = fieldSchema.mergeUid(uidOnlyFieldSchema);
         return fieldSchema;
diff --git a/src/org/apache/pig/newplan/logical/expression/CastExpression.java b/src/org/apache/pig/newplan/logical/expression/CastExpression.java
index c55e2a8ba..c34ea5aff 100644
--- a/src/org/apache/pig/newplan/logical/expression/CastExpression.java
+++ b/src/org/apache/pig/newplan/logical/expression/CastExpression.java
@@ -32,7 +32,8 @@ public class CastExpression extends UnaryExpression {
 
     public CastExpression(OperatorPlan plan, LogicalExpression exp, LogicalSchema.LogicalFieldSchema fs) {
         super("Cast", plan, exp);
-        castSchema = fs;
+        castSchema = fs.deepCopy();
+        castSchema.resetUid();
     }
 
     @Override
diff --git a/src/org/apache/pig/newplan/logical/relational/LogicalSchema.java b/src/org/apache/pig/newplan/logical/relational/LogicalSchema.java
index e13ff9b71..6dd2478ec 100644
--- a/src/org/apache/pig/newplan/logical/relational/LogicalSchema.java
+++ b/src/org/apache/pig/newplan/logical/relational/LogicalSchema.java
@@ -138,7 +138,7 @@ public class LogicalSchema {
             if (uidOnlyFieldSchema==null)
                 return false;
             if (this.schema==null && uidOnlyFieldSchema.schema!=null ||
-                    this.schema!=null && uidOnlyFieldSchema==null)
+                    this.schema!=null && uidOnlyFieldSchema.schema==null)
                 return false;
             if (this.schema!=null) {
                 if (this.schema.size()!=uidOnlyFieldSchema.schema.size())
diff --git a/src/org/apache/pig/newplan/logical/visitor/TypeCheckingExpVisitor.java b/src/org/apache/pig/newplan/logical/visitor/TypeCheckingExpVisitor.java
index ef2929ef9..d6295d2fd 100644
--- a/src/org/apache/pig/newplan/logical/visitor/TypeCheckingExpVisitor.java
+++ b/src/org/apache/pig/newplan/logical/visitor/TypeCheckingExpVisitor.java
@@ -46,6 +46,7 @@ import org.apache.pig.newplan.OperatorPlan;
 import org.apache.pig.newplan.ReverseDependencyOrderWalker;
 import org.apache.pig.newplan.logical.Util;
 import org.apache.pig.newplan.logical.expression.AddExpression;
+import org.apache.pig.newplan.logical.expression.AllSameExpressionVisitor;
 import org.apache.pig.newplan.logical.expression.AndExpression;
 import org.apache.pig.newplan.logical.expression.BinCondExpression;
 import org.apache.pig.newplan.logical.expression.BinaryExpression;
@@ -93,12 +94,11 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
         super(expPlan, new ReverseDependencyOrderWalker(expPlan));
         this.msgCollector = msgCollector;
         this.currentRelOp = relOp;
-    }
+        //reset field schema of all expression operators because
+        // it needs to be re-evaluated after correct types are set
+        FieldSchemaResetter sr = new FieldSchemaResetter(expPlan);
+        sr.visit();
 
-    @Override
-    public void visit(ProjectExpression proj) throws FrontendException{
-        proj.resetFieldSchema();
-        proj.getFieldSchema();
     }
 
     @Override
@@ -172,8 +172,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
             throw new TypeCheckerException(binOp, msg, errCode, PigException.INPUT) ;
         }
 
-        binOp.resetFieldSchema();
-
     }
     
     @Override
@@ -214,7 +212,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
             msgCollector.collect(msg, MessageType.Error);
             throw new TypeCheckerException(binOp, msg, errCode, PigException.INPUT) ;
         }
-        binOp.resetFieldSchema();
     }
 
     private String generateIncompatibleTypesMessage(BinaryExpression binOp)
@@ -251,15 +248,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
             throw new TypeCheckerException(negExp, msg, errCode, PigException.INPUT) ;
         }
 
-        negExp.resetFieldSchema();
-        try {
-            negExp.getFieldSchema();
-        } catch (FrontendException fe) {
-            int errCode = 1040;
-            String msg = "Could not set Negative field schema";
-            msgCollector.collect(msg, MessageType.Error);
-            throw new TypeCheckerException(negExp, msg, errCode, PigException.INPUT, fe) ;
-        }
     }
     
     @Override
@@ -412,9 +400,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
         else {
             throwIncompatibleTypeError(binOp);
         }
-        //input types might have changed, regenerate field schema
-        binOp.resetFieldSchema();
-        binOp.getFieldSchema();
     }
 
     private void throwIncompatibleTypeError(BinaryExpression binOp)
@@ -526,7 +511,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
      */
     @Override
     public void visit(RegexExpression rg) throws FrontendException {
-        rg.resetFieldSchema();
         // We allow BYTEARRAY to be converted to CHARARRAY
         if (rg.getLhs().getType() == DataType.BYTEARRAY){
             insertCast(rg, DataType.CHARARRAY, rg.getLhs());
@@ -645,7 +629,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
             // return map
             insertCast(map, DataType.MAP, map.getMap());
         }
-        map.resetFieldSchema();
     }
     
     @Override
@@ -802,17 +785,6 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
             insertCastsForUDF(func, currentArgSchema, matchingSpec.getInputArgsSchema());
             
         }
-            
-        //Regenerate schema as there might be new additions
-        try {
-            func.resetFieldSchema();
-            func.getFieldSchema();
-        } catch (FrontendException fee) {
-            int errCode = 1040;
-            String msg = "Could not set UserFunc field schema";
-            msgCollector.collect(msg, MessageType.Error);
-            throw new TypeCheckerException(func, msg, errCode, PigException.INPUT, fee) ;
-        }
     }
     
     /**
@@ -1368,5 +1340,17 @@ public class TypeCheckingExpVisitor extends LogicalExpressionVisitor{
 
     
 
+    static class FieldSchemaResetter extends AllSameExpressionVisitor {
+
+        protected FieldSchemaResetter(OperatorPlan p) throws FrontendException {
+            super(p, new ReverseDependencyOrderWalker(p));
+        }
+
+        @Override
+        protected void execute(LogicalExpression op) throws FrontendException {
+            op.resetFieldSchema();
+        }
+
+    }
 
 }
diff --git a/test/org/apache/pig/test/TestTypeCheckingValidatorNewLP.java b/test/org/apache/pig/test/TestTypeCheckingValidatorNewLP.java
index 06855b52f..cd08d4604 100644
--- a/test/org/apache/pig/test/TestTypeCheckingValidatorNewLP.java
+++ b/test/org/apache/pig/test/TestTypeCheckingValidatorNewLP.java
@@ -43,6 +43,7 @@ import org.apache.pig.EvalFunc;
 import org.apache.pig.ExecType;
 import org.apache.pig.FuncSpec;
 import org.apache.pig.PigServer;
+import org.apache.pig.backend.executionengine.ExecException;
 import org.apache.pig.builtin.PigStorage;
 import org.apache.pig.data.DataBag;
 import org.apache.pig.data.DataByteArray;
@@ -52,6 +53,7 @@ import org.apache.pig.data.TupleFactory;
 import org.apache.pig.impl.PigContext;
 import org.apache.pig.impl.io.FileSpec;
 import org.apache.pig.impl.logicalLayer.FrontendException;
+import org.apache.pig.impl.logicalLayer.parser.ParseException;
 import org.apache.pig.impl.logicalLayer.schema.Schema;
 import org.apache.pig.impl.logicalLayer.schema.Schema.FieldSchema;
 import org.apache.pig.impl.logicalLayer.validators.TypeCheckerException;
@@ -4068,6 +4070,24 @@ public class TestTypeCheckingValidatorNewLP {
                         
         }
         
+        // See PIG-2004
+        @Test
+        public void testDereferenceTypeSet() throws IOException, ParseException {
+            String query = "a = load 'a' as (i : int, j : int) ;"
+            + " b = foreach a generate i, j/10.1 as jd;" 
+            + " c = group b by i;" 
+            + " d = foreach c generate MAX(b.jd) as mx;";
+            
+            PigServer pig = new PigServer(ExecType.LOCAL);
+            Util.registerMultiLineQuery(pig, query);
+            
+            Schema expectedSch = 
+                Util.getSchemaFromString("mx: double");
+            Schema sch = pig.dumpSchema("d");
+            assertEquals("Checking expected schema", expectedSch, sch);
+     
+        }
+       
         
         public static class TestUDFTupleNullInnerSchema extends EvalFunc<Tuple> {
             @Override
@@ -4085,5 +4105,5 @@ public class TestTypeCheckingValidatorNewLP {
         
             checkLastForeachCastLoadFunc(query, null, 0);
         }
-        
+
 }
