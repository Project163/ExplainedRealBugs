diff --git a/CHANGES.txt b/CHANGES.txt
index 4e4178111..d79657631 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -299,6 +299,8 @@ PIG-1309: Map-side Cogroup (ashutoshc)
 
 BUG FIXES
 
+PIG-1843: NPE in schema generation (daijy)
+
 PIG-1820: New logical plan: FilterLogicExpressionSimplifier fail to deal with UDF (daijy)
 
 PIG-1854: Pig returns exit code 0 for the failed Pig script (rding)
diff --git a/src/org/apache/pig/EvalFunc.java b/src/org/apache/pig/EvalFunc.java
index e55767f5c..13640657c 100644
--- a/src/org/apache/pig/EvalFunc.java
+++ b/src/org/apache/pig/EvalFunc.java
@@ -73,7 +73,7 @@ public abstract class EvalFunc<T>  {
     private static int nextSchemaId; // for assigning unique ids to UDF columns
     protected String getSchemaName(String name, Schema input) {
         String alias = name + "_";
-        if (input.getAliases().size() > 0){
+        if (input!=null && input.getAliases().size() > 0){
             alias += input.getAliases().iterator().next() + "_";
         }
 
diff --git a/test/org/apache/pig/test/TestEvalPipeline2.java b/test/org/apache/pig/test/TestEvalPipeline2.java
index baa87f7a1..9d285f949 100644
--- a/test/org/apache/pig/test/TestEvalPipeline2.java
+++ b/test/org/apache/pig/test/TestEvalPipeline2.java
@@ -973,13 +973,13 @@ public class TestEvalPipeline2 extends TestCase {
     
     // See PIG-1761
     @Test
-    public void testBagDereferenceInMiddle() throws Exception{
+    public void testBagDereferenceInMiddle1() throws Exception{
         String[] input1 = {
                 "foo@apache#44",
         };
         
-        Util.createInputFile(cluster, "table_testBagDereferenceInMiddle", input1);
-        pigServer.registerQuery("a = load 'table_testBagDereferenceInMiddle' as (a0:chararray);");
+        Util.createInputFile(cluster, "table_testBagDereferenceInMiddle1", input1);
+        pigServer.registerQuery("a = load 'table_testBagDereferenceInMiddle1' as (a0:chararray);");
         pigServer.registerQuery("b = foreach a generate UPPER(REGEX_EXTRACT_ALL(a0, '.*@(.*)#.*').$0);");
         
         Iterator<Tuple> iter = pigServer.openIterator("b");
@@ -988,6 +988,23 @@ public class TestEvalPipeline2 extends TestCase {
         assertTrue(t.get(0).equals("APACHE"));
     }
     
+    // See PIG-1843
+    @Test
+    public void testBagDereferenceInMiddle2() throws Exception{
+        String[] input1 = {
+                "foo apache",
+        };
+        
+        Util.createInputFile(cluster, "table_testBagDereferenceInMiddle2", input1);
+        pigServer.registerQuery("a = load 'table_testBagDereferenceInMiddle2' as (a0:chararray);");
+        pigServer.registerQuery("b = foreach a generate " + MapGenerate.class.getName() + " (STRSPLIT(a0).$0);");
+        
+        Iterator<Tuple> iter = pigServer.openIterator("b");
+        Tuple t = iter.next();
+        assertTrue(t.size()==1);
+        assertTrue(t.toString().equals("([key#1])"));
+    }
+    
     // See PIG-1766
     @Test
     public void testForEachSameOriginColumn1() throws Exception{
@@ -1048,7 +1065,7 @@ public class TestEvalPipeline2 extends TestCase {
         
         @Override
         public Schema outputSchema(Schema input) {
-            return new Schema(new Schema.FieldSchema(null, DataType.MAP));
+            return new Schema(new Schema.FieldSchema(getSchemaName("parselong", input), DataType.MAP));
         }
     }
     
