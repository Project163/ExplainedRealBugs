diff --git a/CHANGES.txt b/CHANGES.txt
index a136ed85d..e54655313 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -314,3 +314,5 @@ Trunk (unreleased changes)
     PIG-525: make sure cast for udf parameters works (olgan)
 
     PIG-512: Expressions in foreach lead to errors (sms via olgan)
+
+    PIG-528: use UDF return in schema computation (sms via olgan)
diff --git a/src/org/apache/pig/impl/logicalLayer/LOUserFunc.java b/src/org/apache/pig/impl/logicalLayer/LOUserFunc.java
index d15c4d203..5c0a8e430 100644
--- a/src/org/apache/pig/impl/logicalLayer/LOUserFunc.java
+++ b/src/org/apache/pig/impl/logicalLayer/LOUserFunc.java
@@ -99,11 +99,18 @@ public class LOUserFunc extends ExpressionOperator {
     
             EvalFunc<?> ef = (EvalFunc<?>) PigContext.instantiateFuncFromSpec(mFuncSpec);
             Schema udfSchema = ef.outputSchema(inputSchema);
-    
+            byte returnType = DataType.findType(ef.getReturnType());
+
             if (null != udfSchema) {
                 Schema.FieldSchema fs;
                 try {
-                    fs = new Schema.FieldSchema(udfSchema.getField(0));
+                    if(udfSchema.size() == 0) {
+                        fs = new Schema.FieldSchema(null, null, returnType);
+                    } else if(udfSchema.size() == 1) {
+                        fs = new Schema.FieldSchema(udfSchema.getField(0));
+                    } else {
+                        fs = new Schema.FieldSchema(null, udfSchema, DataType.TUPLE);
+                    }
                 } catch (ParseException pe) {
                     throw new FrontendException(pe.getMessage());
                 }
@@ -111,7 +118,6 @@ public class LOUserFunc extends ExpressionOperator {
                 mFieldSchema = fs;
                 mIsFieldSchemaComputed = true;
             } else {
-                byte returnType = DataType.findType(ef.getReturnType());
                 setType(returnType);
                 mFieldSchema = new Schema.FieldSchema(null, null, returnType);
                 mIsFieldSchemaComputed = true;
diff --git a/test/org/apache/pig/test/TestEvalPipeline.java b/test/org/apache/pig/test/TestEvalPipeline.java
index bc3333970..10b3df3a0 100644
--- a/test/org/apache/pig/test/TestEvalPipeline.java
+++ b/test/org/apache/pig/test/TestEvalPipeline.java
@@ -50,6 +50,7 @@ import org.apache.pig.impl.io.PigFile;
 import org.apache.pig.impl.logicalLayer.schema.Schema;
 import org.apache.pig.impl.logicalLayer.FrontendException;
 import org.apache.pig.impl.util.Pair;
+import org.apache.pig.test.util.Identity;
 
 import junit.framework.TestCase;
 
@@ -250,18 +251,6 @@ public class TestEvalPipeline extends TestCase {
         }
     }
 
-    
-    static public class Identity extends EvalFunc<Tuple> {
-        @Override
-        public Tuple exec(Tuple input) throws IOException {
-           return input; 
-        }
-
-        public Schema outputSchema(Schema input) {
-            return input;
-        }
-    }
-    
     static public class MapUDF extends EvalFunc<Map<Object, Object>> {
         @Override
         public Map<Object, Object> exec(Tuple input) throws IOException {
@@ -968,4 +957,42 @@ public class TestEvalPipeline extends TestCase {
 
         assertEquals((LOOP_COUNT * LOOP_COUNT)/2, numRows);
     }
+
+    @Test
+    public void testIdentity() throws Exception{
+        int LOOP_COUNT = 2;
+        File tmpFile = File.createTempFile("test", "txt");
+        PrintStream ps = new PrintStream(new FileOutputStream(tmpFile));
+        Random r = new Random();
+        for(int i = 0; i < LOOP_COUNT; i++) {
+            for(int j=0;j<LOOP_COUNT;j+=2){
+                ps.println(i+"\t"+j);
+                ps.println(i+"\t"+j);
+            }
+        }
+        ps.close();
+
+        String tmpOutputFile = FileLocalizer.getTemporaryPath(null, 
+        pigServer.getPigContext()).toString();
+        pigServer.registerQuery("A = LOAD '" + Util.generateURI(tmpFile.toString()) + "';");
+        pigServer.registerQuery("B = distinct A ;"); //the argument does not matter
+        pigServer.registerQuery("C = foreach B generate FLATTEN(" + Identity.class.getName() + "($0, $1));"); //the argument does not matter
+
+        Iterator<Tuple> iter = pigServer.openIterator("C");
+        if(!iter.hasNext()) fail("No output found");
+        int numRows = 0;
+        for(int i = 0; i < LOOP_COUNT; i++) {
+            for(int j = 0; j < LOOP_COUNT; j+=2){
+                Tuple t = null;
+                if(iter.hasNext()) t = iter.next();
+                assertEquals(2, t.size());
+                assertEquals(new Double(i), new Double(t.get(0).toString()), 0.01);
+                assertEquals(new Double(j), new Double(t.get(1).toString()), 0.01);
+                ++numRows;
+            }
+        }
+
+        assertEquals((LOOP_COUNT * LOOP_COUNT)/2, numRows);
+    }
+
 }
diff --git a/test/org/apache/pig/test/TestLogicalPlanBuilder.java b/test/org/apache/pig/test/TestLogicalPlanBuilder.java
index 8d04a066b..0f8953de2 100644
--- a/test/org/apache/pig/test/TestLogicalPlanBuilder.java
+++ b/test/org/apache/pig/test/TestLogicalPlanBuilder.java
@@ -54,6 +54,7 @@ import org.apache.pig.data.DataType;
 import org.apache.pig.impl.logicalLayer.parser.QueryParser ;
 import org.apache.pig.impl.logicalLayer.parser.ParseException ;
 import org.apache.pig.impl.util.MultiMap;
+import org.apache.pig.test.util.Identity;
 
 
 public class TestLogicalPlanBuilder extends junit.framework.TestCase {
@@ -1684,7 +1685,6 @@ public class TestLogicalPlanBuilder extends junit.framework.TestCase {
         foreach = (LOForEach) lp.getLeaves().get(0);
 
         for(LogicalPlan foreachPlan: foreach.getForEachPlans()) {
-            printPlan(foreachPlan);
             assertTrue(checkPlanForProjectStar(foreachPlan) == true);
         }
 
@@ -1716,6 +1716,84 @@ public class TestLogicalPlanBuilder extends junit.framework.TestCase {
 
     }
 
+    @Test
+    public void testQuery114()  throws FrontendException, ParseException {
+        LogicalPlan lp;
+        LOForEach foreach;
+        LOSort sort;
+
+        buildPlan("a = load 'one' as (name, age, gpa);");
+
+        lp = buildPlan("b = foreach a generate " + Identity.class.getName() + "(name, age);");
+        foreach = (LOForEach) lp.getLeaves().get(0);
+
+        Schema s = new Schema();
+        s.add(new Schema.FieldSchema("name", DataType.BYTEARRAY));
+        s.add(new Schema.FieldSchema("age", DataType.BYTEARRAY));
+        Schema.FieldSchema tupleFs = new Schema.FieldSchema(null, s, DataType.TUPLE);
+        Schema expectedSchema = new Schema(tupleFs);
+        assertTrue(Schema.equals(foreach.getSchema(), expectedSchema, false, true));
+
+    }
+
+    @Test
+    public void testQuery115()  throws FrontendException, ParseException {
+        LogicalPlan lp;
+        LOForEach foreach;
+        LOSort sort;
+
+        buildPlan("a = load 'one' as (name, age, gpa);");
+
+        lp = buildPlan("b = foreach a generate " + Identity.class.getName() + "(*);");
+        foreach = (LOForEach) lp.getLeaves().get(0);
+
+        Schema s = new Schema();
+        s.add(new Schema.FieldSchema("name", DataType.BYTEARRAY));
+        s.add(new Schema.FieldSchema("age", DataType.BYTEARRAY));
+        s.add(new Schema.FieldSchema("gpa", DataType.BYTEARRAY));
+        Schema.FieldSchema tupleFs = new Schema.FieldSchema(null, s, DataType.TUPLE);
+        Schema expectedSchema = new Schema(tupleFs);
+        assertTrue(Schema.equals(foreach.getSchema(), expectedSchema, false, true));
+
+    }
+
+    @Test
+    public void testQuery116()  throws FrontendException, ParseException {
+        LogicalPlan lp;
+        LOForEach foreach;
+        LOSort sort;
+
+        buildPlan("a = load 'one';");
+
+        lp = buildPlan("b = foreach a generate " + Identity.class.getName() + "($0, $1);");
+        foreach = (LOForEach) lp.getLeaves().get(0);
+
+        Schema s = new Schema();
+        s.add(new Schema.FieldSchema(null, DataType.BYTEARRAY));
+        s.add(new Schema.FieldSchema(null, DataType.BYTEARRAY));
+        Schema.FieldSchema tupleFs = new Schema.FieldSchema(null, s, DataType.TUPLE);
+        Schema expectedSchema = new Schema(tupleFs);
+        assertTrue(Schema.equals(foreach.getSchema(), expectedSchema, false, true));
+
+    }
+
+    @Test
+    public void testQuery117()  throws FrontendException, ParseException {
+        LogicalPlan lp;
+        LOForEach foreach;
+        LOSort sort;
+
+        buildPlan("a = load 'one';");
+
+        lp = buildPlan("b = foreach a generate " + Identity.class.getName() + "(*);");
+        foreach = (LOForEach) lp.getLeaves().get(0);
+
+        Schema.FieldSchema tupleFs = new Schema.FieldSchema(null, null, DataType.TUPLE);
+        Schema expectedSchema = new Schema(tupleFs);
+        assertTrue(Schema.equals(foreach.getSchema(), expectedSchema, false, true));
+
+    }
+
     private Schema getSchemaFromString(String schemaString) throws ParseException {
         return getSchemaFromString(schemaString, DataType.BYTEARRAY);
     }
