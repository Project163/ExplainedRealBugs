diff --git a/CHANGES.txt b/CHANGES.txt
index f63c60c67..105ac20dc 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -253,6 +253,8 @@ PIG-3013: BinInterSedes improve chararray sort performance (rohini)
 
 BUG FIXES
 
+PIG-3114: Duplicated macro name error when using pigunit (daijy)
+
 PIG-3370: Add New Reserved Keywords To The Pig Docs (cheolsoo)
 
 PIG-3487: Fix syntax errors in nightly.conf (arpitgupta via daijy)
diff --git a/test/data/pigunit/top_queries_macro.pig b/test/data/pigunit/top_queries_macro.pig
new file mode 100644
index 000000000..6c987f801
--- /dev/null
+++ b/test/data/pigunit/top_queries_macro.pig
@@ -0,0 +1,45 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+---------------------------------------------------------------------
+-- Top N Queries with Macro
+---------------------------------------------------------------------
+
+DEFINE my_macro_1 (QUERY, A) RETURNS C {
+    $C = FOREACH $QUERY GENERATE group AS query, SUM(data.$A) AS count;
+} ;
+
+data =
+    LOAD '$input'
+    AS (query:CHARARRAY, count:INT);
+
+queries_group = 
+    GROUP data 
+    BY query
+    PARALLEL $reducers;
+
+queries_sum = my_macro_1(queries_group, count);
+
+queries_ordered = 
+    ORDER queries_sum 
+    BY count DESC
+    PARALLEL $reducers;
+            
+queries_limit = LIMIT queries_ordered $n;
+
+STORE queries_limit INTO '$output';
diff --git a/test/org/apache/pig/pigunit/PigTest.java b/test/org/apache/pig/pigunit/PigTest.java
index 431214e54..39c0e61ab 100644
--- a/test/org/apache/pig/pigunit/PigTest.java
+++ b/test/org/apache/pig/pigunit/PigTest.java
@@ -192,6 +192,14 @@ public class PigTest {
     registerScript();
     return getPigServer().openIterator(alias);
   }
+  
+  /**
+   * Gets an iterator on the content of one alias of a cached script. The script itself
+   * must be already be registered with registerScript().
+   */
+  private Iterator<Tuple> getAliasFromCache(String alias) throws IOException, ParseException {
+    return getPigServer().openIterator(alias);
+  }
 
   /**
    * Gets an iterator on the content of the latest STORE alias of the script.
@@ -203,7 +211,7 @@ public class PigTest {
     registerScript();
     String alias = aliasOverrides.get("LAST_STORE_ALIAS");
 
-    return getAlias(alias);
+    return getAliasFromCache(alias);
   }
 
   /**
@@ -234,26 +242,26 @@ public class PigTest {
     registerScript();
     String alias = aliasOverrides.get("LAST_STORE_ALIAS");
 
-    assertEquals(StringUtils.join(expected, "\n"), StringUtils.join(getAlias(alias), "\n"));
+    assertEquals(StringUtils.join(expected, "\n"), StringUtils.join(getAliasFromCache(alias), "\n"));
   }
 
   public void assertOutput(String alias, String[] expected) throws IOException, ParseException {
     registerScript();
 
-    assertEquals(StringUtils.join(expected, "\n"), StringUtils.join(getAlias(alias), "\n"));
+    assertEquals(StringUtils.join(expected, "\n"), StringUtils.join(getAliasFromCache(alias), "\n"));
   }
 
   public void assertOutput(File expected) throws IOException, ParseException {
     registerScript();
     String alias = aliasOverrides.get("LAST_STORE_ALIAS");
 
-    assertEquals(readFile(expected).replaceAll("\r\n", "\n"), StringUtils.join(getAlias(alias), "\n"));
+    assertEquals(readFile(expected).replaceAll("\r\n", "\n"), StringUtils.join(getAliasFromCache(alias), "\n"));
   }
 
   public void assertOutput(String alias, File expected) throws IOException, ParseException {
     registerScript();
 
-    assertEquals(readFile(expected).replaceAll("\r\n", "\n"), StringUtils.join(getAlias(alias), "\n"));
+    assertEquals(readFile(expected).replaceAll("\r\n", "\n"), StringUtils.join(getAliasFromCache(alias), "\n"));
   }
 
   public void assertOutput(String aliasInput, String[] input, String alias, String[] expected)
diff --git a/test/org/apache/pig/test/pigunit/TestPigTest.java b/test/org/apache/pig/test/pigunit/TestPigTest.java
index 83de9549c..ef0835eaa 100644
--- a/test/org/apache/pig/test/pigunit/TestPigTest.java
+++ b/test/org/apache/pig/test/pigunit/TestPigTest.java
@@ -52,6 +52,7 @@ public class TestPigTest {
     private PigTest test;
     private static Cluster cluster;
     private static final String PIG_SCRIPT = "test/data/pigunit/top_queries.pig";
+    private static final String PIG_SCRIPT_MACRO = "test/data/pigunit/top_queries_macro.pig";
     private static final Log LOG = LogFactory.getLog(TestPigTest.class);
 
     @BeforeClass
@@ -324,6 +325,26 @@ public class TestPigTest {
 
         assertTrue(cluster.delete(new Path("top_3_queries")));
     }
+    
+    @Test
+    // Script should only be registered once, otherwise Pig will complain
+    // Macro defined twice. See PIG-3114
+    public void testMacro() throws ParseException, IOException {
+        String[] args = {
+                        "n=3",
+                        "reducers=1",
+                        "input=top_queries_input_data.txt",
+                        "output=top_3_queries",
+        };
+        test = new PigTest(PIG_SCRIPT_MACRO, args);
+
+        // By default PigUnit removes all the STORE and DUMP
+        test.unoverride("STORE");
+
+        test.runScript();
+
+        assertTrue(cluster.delete(new Path("top_3_queries")));
+    }
 
     @Ignore("Not ready yet")
     @Test
