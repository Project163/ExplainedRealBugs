diff --git a/CHANGES.txt b/CHANGES.txt
index 5b6b60fdd..9d9dd37ea 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -92,6 +92,8 @@ OPTIMIZATIONS
  
 BUG FIXES
 
+PIG-4196: Auto ship udf jar is broken (daijy)
+
 PIG-4214: Fix unit test fail TestMRJobStats (daijy)
 
 PIG-4217: Fix documentation in BuildBloom (praveenr019 via daijy)
diff --git a/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java b/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java
index b6a0117a9..8bbe1359c 100644
--- a/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java
+++ b/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java
@@ -597,6 +597,18 @@ public class JobControlCompiler{
                         }
                     }
 
+                    for (String udf : mro.UDFs) {
+                        Class clazz = pigContext.getClassForAlias(udf);
+                        if (clazz != null) {
+                            String jar = JarManager.findContainingJar(clazz);
+                            if (jar!=null) {
+                                URL jarURL = new File(jar).toURI().toURL();
+                                if (!allJars.contains(jarURL)) {
+                                    allJars.add(jarURL);
+                                }
+                        }
+                    }
+
                     for (String scriptJar : pigContext.scriptJars) {
                         URL jar = new File(scriptJar).toURI().toURL();
                         if (!allJars.contains(jar)) {
diff --git a/src/org/apache/pig/backend/hadoop/executionengine/tez/TezJobCompiler.java b/src/org/apache/pig/backend/hadoop/executionengine/tez/TezJobCompiler.java
index a656308ed..6d05fa4c0 100644
--- a/src/org/apache/pig/backend/hadoop/executionengine/tez/TezJobCompiler.java
+++ b/src/org/apache/pig/backend/hadoop/executionengine/tez/TezJobCompiler.java
@@ -103,6 +103,9 @@ public class TezJobCompiler {
                     TezResourceManager.getInstance().addTezResource(new Path(new URI(file.trim())).toUri());
                 }
             }
+            for (Map.Entry<String, LocalResource> entry : localResources.entrySet()) {
+                log.info("Local resource: " + entry.getKey());
+            }
             DAG tezDag = buildDAG(tezPlan, localResources);
             return new TezJob(tezConf, tezDag, localResources);
         } catch (Exception e) {
diff --git a/test/org/apache/pig/test/TestGrunt.java b/test/org/apache/pig/test/TestGrunt.java
index 7f31df158..24f1e4b53 100644
--- a/test/org/apache/pig/test/TestGrunt.java
+++ b/test/org/apache/pig/test/TestGrunt.java
@@ -50,6 +50,7 @@ import org.apache.pig.backend.executionengine.ExecJob.JOB_STATUS;
 import org.apache.pig.impl.PigContext;
 import org.apache.pig.impl.io.FileLocalizer;
 import org.apache.pig.impl.logicalLayer.FrontendException;
+import org.apache.pig.impl.util.JavaCompilerHelper;
 import org.apache.pig.test.Util.ProcessReturnInfo;
 import org.apache.pig.tools.grunt.Grunt;
 import org.apache.pig.tools.pigscript.parser.ParseException;
@@ -1445,4 +1446,62 @@ public class TestGrunt {
 
         assertEquals(Level.INFO.toString(),  pc.getLog4jProperties().getProperty("log4j.logger.org.apache.pig"));
     }
+
+    @Test
+    public void testAutoShipUDFContainingJar() throws Throwable {
+
+        String FILE_SEPARATOR = System.getProperty("file.separator");
+        File tmpDir = File.createTempFile("test", "");
+        tmpDir.delete();
+        tmpDir.mkdir();
+
+        File udfDir = new File(tmpDir.getAbsolutePath() + FILE_SEPARATOR + "com" + FILE_SEPARATOR
+                + "xxx" + FILE_SEPARATOR + "udf");
+        udfDir.mkdirs();
+
+        String udfSrc = new String("package com.xxx.udf;\n" +
+                "import java.io.IOException;\n" +
+                "import org.apache.pig.EvalFunc;\n" +
+                "import org.apache.pig.data.Tuple;\n" +
+                "public class TestUDF extends EvalFunc<Integer>{\n" +
+                "public Integer exec(Tuple input) throws IOException {\n" +
+                "return 1;}\n" +
+                "}");
+
+        // compile
+        JavaCompilerHelper javaCompilerHelper = new JavaCompilerHelper();
+        javaCompilerHelper.compile(tmpDir.getAbsolutePath(),
+                new JavaCompilerHelper.JavaSourceFromString("com.xxx.udf.TestUDF", udfSrc));
+        
+        String jarName = "TestUDFJar.jar";
+        String jarFile = tmpDir.getAbsolutePath() + FILE_SEPARATOR + jarName;
+        int status = Util.executeJavaCommand("jar -cf " + jarFile +
+                " -C " + tmpDir.getAbsolutePath() + " " + "com");
+        assertEquals(0, status);
+
+        Util.createInputFile(cluster, "table_testAutoShipUDFContainingJar", new String[] { "1" });
+        File scriptFile = Util.createFile(new String[] {
+                "a = load 'table_testAutoShipUDFContainingJar' as (a0:int);" +
+                "b = foreach a generate com.xxx.udf.TestUDF(a0);" +
+                "store b into 'output_testAutoShipUDFContainingJar';"
+                });
+        String scriptFileName = scriptFile.getAbsolutePath();
+        String execTypeOptions = "-x " + cluster.getExecType() + " ";
+        String cmd = "java -cp " + System.getProperty("java.class.path") + ":" + jarFile +
+                " org.apache.pig.Main " + execTypeOptions + scriptFileName;
+        ProcessReturnInfo  pri  = Util.executeJavaCommandAndReturnInfo(cmd);
+        assertEquals(pri.exitCode, 0);
+        String[] lines = pri.stderrContents.split(System.getProperty("line.separator"));
+        boolean found = false;
+        for (String line : lines) {
+            if (line.matches(".*Adding jar to DistributedCache.*" + jarName + ".*")) {
+                // MR mode
+                found = true;
+            } else if (line.matches(".*Local resource.*" + jarName + ".*")) {
+                // Tez mode
+                found = true;
+            }
+        }
+        assertTrue(found);
+    }
 }
