diff --git a/CHANGES.txt b/CHANGES.txt
index da3fbd075..dd45a038c 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -220,6 +220,8 @@ PIG-1309: Map-side Cogroup (ashutoshc)
 
 BUG FIXES
 
+PIG-1721: New logical plan: script fail when reuse foreach inner alias (daijy)
+
 PIG-1716: New logical plan: LogToPhyTranslationVisitor should translate the structure for regex optimization (daijy)
 
 PIG-1740: Fix SVN location in setup doc (chandec via olgan)
diff --git a/src/org/apache/pig/newplan/logical/LogicalExpPlanMigrationVistor.java b/src/org/apache/pig/newplan/logical/LogicalExpPlanMigrationVistor.java
index f0442b8be..5efed7cf0 100644
--- a/src/org/apache/pig/newplan/logical/LogicalExpPlanMigrationVistor.java
+++ b/src/org/apache/pig/newplan/logical/LogicalExpPlanMigrationVistor.java
@@ -54,7 +54,7 @@ import org.apache.pig.impl.logicalLayer.LOVisitor;
 import org.apache.pig.impl.logicalLayer.LogicalOperator;
 import org.apache.pig.impl.logicalLayer.LogicalPlan;
 import org.apache.pig.impl.logicalLayer.schema.Schema.FieldSchema;
-import org.apache.pig.impl.plan.DependencyOrderWalker;
+import org.apache.pig.impl.plan.DependencyOrderWalkerWOSeenChk;
 import org.apache.pig.impl.plan.VisitorException;
 import org.apache.pig.newplan.logical.expression.AddExpression;
 import org.apache.pig.newplan.logical.expression.AndExpression;
@@ -97,7 +97,7 @@ public class LogicalExpPlanMigrationVistor extends LOVisitor {
     public LogicalExpPlanMigrationVistor(LogicalPlan expressionPlan, LogicalOperator oldAttachedOperator,
             LogicalRelationalOperator attachedOperator, LogicalPlan outerPlan, 
             Map<LogicalOperator, LogicalRelationalOperator> outerOpsMap) {
-        super(expressionPlan, new DependencyOrderWalker<LogicalOperator, LogicalPlan>(expressionPlan));
+        super(expressionPlan, new DependencyOrderWalkerWOSeenChk<LogicalOperator, LogicalPlan>(expressionPlan));
         exprPlan = new org.apache.pig.newplan.logical.expression.LogicalExpressionPlan();
         exprOpsMap = new HashMap<LogicalOperator, LogicalExpression>();
         attachedRelationalOp = attachedOperator;
diff --git a/test/org/apache/pig/test/TestEvalPipeline2.java b/test/org/apache/pig/test/TestEvalPipeline2.java
index 40e976b58..db697eefc 100644
--- a/test/org/apache/pig/test/TestEvalPipeline2.java
+++ b/test/org/apache/pig/test/TestEvalPipeline2.java
@@ -819,4 +819,27 @@ public class TestEvalPipeline2 extends TestCase {
         t = it.next();
         assertTrue(t.get(0).equals("WORLD"));
     }
+    
+    // See PIG-1721
+    @Test
+    public void testDuplicateInnerAlias() throws Exception{
+        String[] input1 = {
+                "1\t[key1#5]", "1\t[key2#5]", "2\t[key1#3]"
+        };
+        
+        Util.createInputFile(cluster, "table_testDuplicateInnerAlias", input1);
+        pigServer.registerQuery("a = load 'table_testDuplicateInnerAlias' as (a0:int, a1:map[]);");
+        pigServer.registerQuery("b = filter a by a0==1;");
+        pigServer.registerQuery("c = foreach b { b0 = a1#'key1'; generate ((b0 is null or b0 == '')?1:0);};");
+        
+        Iterator<Tuple> iter = pigServer.openIterator("c");
+        
+        Tuple t = iter.next();
+        assertTrue((Integer)t.get(0)==0);
+        
+        t = iter.next();
+        assertTrue((Integer)t.get(0)==1);
+        
+        assertFalse(iter.hasNext());
+    }
 }
