diff --git a/CHANGES.txt b/CHANGES.txt
index 4e3bca2dc..1284bb6be 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -217,6 +217,8 @@ PIG-1309: Map-side Cogroup (ashutoshc)
 
 BUG FIXES
 
+PIG-1705: New logical plan: self-join fail for some queries (daijy)
+
 PIG-1704: Output Compression is not at work if the output path is absolute and there is a trailing / afte the compression suffix (yanz)
 
 PIG-1695: MergeForEach does not carry user defined schema if any one of the merged ForEach has user defined schema (daijy)
diff --git a/src/org/apache/pig/backend/hadoop/executionengine/HExecutionEngine.java b/src/org/apache/pig/backend/hadoop/executionengine/HExecutionEngine.java
index f53a235ca..5f3a3861d 100644
--- a/src/org/apache/pig/backend/hadoop/executionengine/HExecutionEngine.java
+++ b/src/org/apache/pig/backend/hadoop/executionengine/HExecutionEngine.java
@@ -69,6 +69,7 @@ import org.apache.pig.newplan.logical.LogicalPlanMigrationVistor;
 import org.apache.pig.newplan.logical.expression.ConstantExpression;
 import org.apache.pig.newplan.logical.expression.LogicalExpressionPlan;
 import org.apache.pig.newplan.logical.optimizer.SchemaResetter;
+import org.apache.pig.newplan.logical.optimizer.ProjectionPatcher.ProjectionFinder;
 import org.apache.pig.newplan.logical.relational.LOLimit;
 import org.apache.pig.newplan.logical.relational.LOSort;
 import org.apache.pig.newplan.logical.relational.LOSplit;
diff --git a/src/org/apache/pig/newplan/logical/expression/LogicalExpression.java b/src/org/apache/pig/newplan/logical/expression/LogicalExpression.java
index 9d7649707..77f2c5771 100644
--- a/src/org/apache/pig/newplan/logical/expression/LogicalExpression.java
+++ b/src/org/apache/pig/newplan/logical/expression/LogicalExpression.java
@@ -110,4 +110,12 @@ public abstract class LogicalExpression extends Operator {
      */
     abstract public LogicalExpression deepCopy(LogicalExpressionPlan lgExpPlan) throws FrontendException;
 
+    /**
+     * Erase all cached uid, regenerate uid when we regenerating schema.
+     * This process currently only used in ImplicitSplitInsert, which will
+     * insert split and invalidate some uids in plan
+     */
+    public void resetUid() {
+        uidOnlyFieldSchema = null;
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/optimizer/LogicalPlanOptimizer.java b/src/org/apache/pig/newplan/logical/optimizer/LogicalPlanOptimizer.java
index 47069b93c..5fcbacd8f 100644
--- a/src/org/apache/pig/newplan/logical/optimizer/LogicalPlanOptimizer.java
+++ b/src/org/apache/pig/newplan/logical/optimizer/LogicalPlanOptimizer.java
@@ -55,21 +55,21 @@ public class LogicalPlanOptimizer extends PlanOptimizer {
     protected List<Set<Rule>> buildRuleSets() {
         List<Set<Rule>> ls = new ArrayList<Set<Rule>>();	    
 
-        // Logical expression simplifier
-        Set<Rule> s = new HashSet<Rule>();
-        // add logical expression simplification rule
-        Rule r = new LogicalExpressionSimplifier("FilterLogicExpressionSimplifier");
-        checkAndAddRule(s, r);
-        ls.add(s);
-
         // ImplicitSplitInserter set
         // This set of rules Insert Foreach dedicated for casting after load
-        s = new HashSet<Rule>();
-        r = new ImplicitSplitInserter("ImplicitSplitInserter");
+        Set<Rule> s = new HashSet<Rule>();
+        Rule r = new ImplicitSplitInserter("ImplicitSplitInserter");
         checkAndAddRule(s, r);
         if (!s.isEmpty())
             ls.add(s);
-        
+
+        // Logical expression simplifier
+        s = new HashSet<Rule>();
+        // add logical expression simplification rule
+        r = new LogicalExpressionSimplifier("FilterLogicExpressionSimplifier");
+        checkAndAddRule(s, r);
+        ls.add(s);
+
         // TypeCastInserter set
         // This set of rules Insert Foreach dedicated for casting after load
         s = new HashSet<Rule>();
diff --git a/src/org/apache/pig/newplan/logical/optimizer/ProjectionPatcher.java b/src/org/apache/pig/newplan/logical/optimizer/ProjectionPatcher.java
index fff8183f8..1b14253b6 100644
--- a/src/org/apache/pig/newplan/logical/optimizer/ProjectionPatcher.java
+++ b/src/org/apache/pig/newplan/logical/optimizer/ProjectionPatcher.java
@@ -93,7 +93,7 @@ public class ProjectionPatcher implements PlanTransformListener {
         }        
     }
     
-    private static class ProjectionFinder extends AllExpressionVisitor {
+    public static class ProjectionFinder extends AllExpressionVisitor {
 
         public ProjectionFinder(OperatorPlan plan) throws FrontendException {
             super(plan, new DependencyOrderWalker(plan));
diff --git a/src/org/apache/pig/newplan/logical/optimizer/UidResetter.java b/src/org/apache/pig/newplan/logical/optimizer/UidResetter.java
new file mode 100644
index 000000000..59734a247
--- /dev/null
+++ b/src/org/apache/pig/newplan/logical/optimizer/UidResetter.java
@@ -0,0 +1,177 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.pig.newplan.logical.optimizer;
+
+import java.util.Collection;
+import java.util.List;
+
+import org.apache.pig.impl.logicalLayer.FrontendException;
+import org.apache.pig.impl.util.MultiMap;
+import org.apache.pig.newplan.DependencyOrderWalker;
+import org.apache.pig.newplan.OperatorPlan;
+import org.apache.pig.newplan.PlanWalker;
+import org.apache.pig.newplan.ReverseDependencyOrderWalker;
+import org.apache.pig.newplan.logical.expression.AllSameExpressionVisitor;
+import org.apache.pig.newplan.logical.expression.LogicalExpression;
+import org.apache.pig.newplan.logical.expression.LogicalExpressionPlan;
+import org.apache.pig.newplan.logical.relational.LOCogroup;
+import org.apache.pig.newplan.logical.relational.LOCross;
+import org.apache.pig.newplan.logical.relational.LODistinct;
+import org.apache.pig.newplan.logical.relational.LOFilter;
+import org.apache.pig.newplan.logical.relational.LOForEach;
+import org.apache.pig.newplan.logical.relational.LOGenerate;
+import org.apache.pig.newplan.logical.relational.LOInnerLoad;
+import org.apache.pig.newplan.logical.relational.LOJoin;
+import org.apache.pig.newplan.logical.relational.LOLimit;
+import org.apache.pig.newplan.logical.relational.LOLoad;
+import org.apache.pig.newplan.logical.relational.LOSort;
+import org.apache.pig.newplan.logical.relational.LOSplit;
+import org.apache.pig.newplan.logical.relational.LOSplitOutput;
+import org.apache.pig.newplan.logical.relational.LOStore;
+import org.apache.pig.newplan.logical.relational.LOStream;
+import org.apache.pig.newplan.logical.relational.LOUnion;
+import org.apache.pig.newplan.logical.relational.LogicalRelationalNodesVisitor;
+
+public class UidResetter extends LogicalRelationalNodesVisitor {
+
+    public UidResetter(OperatorPlan plan) throws FrontendException {
+        super(plan, new DependencyOrderWalker(plan));
+    }
+
+    @Override
+    public void visit(LOLoad load) throws FrontendException {
+        load.resetUid();
+    }
+
+    @Override
+    public void visit(LOFilter filter) throws FrontendException {
+        filter.resetUid();
+        ExpressionUidResetter uidResetter = new ExpressionUidResetter(filter.getFilterPlan());
+        uidResetter.visit();
+    }
+    
+    @Override
+    public void visit(LOStore store) throws FrontendException {
+        store.resetUid();
+    }
+    
+    @Override
+    public void visit(LOJoin join) throws FrontendException {
+        join.resetUid();
+        Collection<LogicalExpressionPlan> joinPlans = join.getExpressionPlanValues();
+        for (LogicalExpressionPlan joinPlan : joinPlans) {
+            ExpressionUidResetter fsResetter = new ExpressionUidResetter(joinPlan);
+            fsResetter.visit();
+        }
+    }
+    
+    @Override
+    public void visit(LOForEach foreach) throws FrontendException {
+        foreach.resetUid();
+        OperatorPlan innerPlan = foreach.getInnerPlan();
+        PlanWalker newWalker = currentWalker.spawnChildWalker(innerPlan);
+        pushWalker(newWalker);
+        currentWalker.walk(this);
+        popWalker();
+    }
+    
+    @Override
+    public void visit(LOGenerate gen) throws FrontendException {
+        gen.resetUid();
+        List<LogicalExpressionPlan> genPlans = gen.getOutputPlans();
+        for (LogicalExpressionPlan genPlan : genPlans) {
+            ExpressionUidResetter fsResetter = new ExpressionUidResetter(genPlan);
+            fsResetter.visit();
+        }
+    }
+    
+    @Override
+    public void visit(LOInnerLoad load) throws FrontendException {
+        load.resetUid();
+        load.getProjection().resetUid();
+    }
+
+    @Override
+    public void visit(LOCogroup loCogroup) throws FrontendException {
+        loCogroup.resetUid();
+        MultiMap<Integer, LogicalExpressionPlan> expPlans = loCogroup.getExpressionPlans();
+        for (LogicalExpressionPlan expPlan : expPlans.values()) {
+            ExpressionUidResetter uidResetter = new ExpressionUidResetter(expPlan);
+            uidResetter.visit();
+        }
+    }
+    
+    @Override
+    public void visit(LOSplit loSplit) throws FrontendException {
+        loSplit.resetUid();
+    }
+    
+    @Override
+    public void visit(LOSplitOutput loSplitOutput) throws FrontendException {
+        loSplitOutput.resetUid();
+        ExpressionUidResetter uidResetter = new ExpressionUidResetter(loSplitOutput.getFilterPlan());
+        uidResetter.visit();
+    }
+    
+    @Override
+    public void visit(LOUnion loUnion) throws FrontendException {
+        loUnion.resetUid();
+    }
+    
+    @Override
+    public void visit(LOSort loSort) throws FrontendException {
+        loSort.resetUid();
+        List<LogicalExpressionPlan> sortPlans = loSort.getSortColPlans();
+        for (LogicalExpressionPlan sortPlan : sortPlans) {
+            ExpressionUidResetter uidResetter = new ExpressionUidResetter(sortPlan);
+            uidResetter.visit();
+        }
+    }
+    
+    @Override
+    public void visit(LODistinct loDistinct) throws FrontendException {
+        loDistinct.resetUid();
+    }
+    
+    @Override
+    public void visit(LOLimit loLimit) throws FrontendException {
+        loLimit.resetUid();
+    }
+    
+    @Override
+    public void visit(LOCross loCross) throws FrontendException {
+        loCross.resetUid();
+    }
+    
+    @Override
+    public void visit(LOStream loStream) throws FrontendException {
+        loStream.resetUid();
+    }
+}
+
+class ExpressionUidResetter extends AllSameExpressionVisitor {
+    protected ExpressionUidResetter(OperatorPlan p) throws FrontendException {
+        super(p, new ReverseDependencyOrderWalker(p));
+    }
+
+    @Override
+    protected void execute(LogicalExpression op) throws FrontendException {
+        op.resetUid();
+    }
+}
diff --git a/src/org/apache/pig/newplan/logical/relational/LOCogroup.java b/src/org/apache/pig/newplan/logical/relational/LOCogroup.java
index 84b4033fa..09615e8be 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOCogroup.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOCogroup.java
@@ -283,4 +283,9 @@ public class LOCogroup extends LogicalRelationalOperator {
         return mIsInner;
     }
 
+    @Override
+    public void resetUid() {
+        groupKeyUidOnlySchema = null;
+        generatedInputUids = new HashMap<Integer,Long>();
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/relational/LOGenerate.java b/src/org/apache/pig/newplan/logical/relational/LOGenerate.java
index f178d774d..3bc6f6ba5 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOGenerate.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOGenerate.java
@@ -275,4 +275,9 @@ public class LOGenerate extends LogicalRelationalOperator {
     public void setUidOnlySchemas(List<LogicalSchema> uidOnlySchemas) {
         this.uidOnlySchemas = uidOnlySchemas;
     }
+    
+    @Override
+    public void resetUid() {
+        this.uidOnlySchemas = null;
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/relational/LOLoad.java b/src/org/apache/pig/newplan/logical/relational/LOLoad.java
index 52511c814..7aac64cd0 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOLoad.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOLoad.java
@@ -194,4 +194,9 @@ public class LOLoad extends LogicalRelationalOperator {
     public Configuration getConfiguration() {
         return conf;
     }
+    
+    @Override
+    public void resetUid() {
+        uidOnlySchema = null;
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/relational/LOSplitOutput.java b/src/org/apache/pig/newplan/logical/relational/LOSplitOutput.java
index c1d2a8239..f99252968 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOSplitOutput.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOSplitOutput.java
@@ -18,13 +18,22 @@
 
 package org.apache.pig.newplan.logical.relational;
 
+import java.util.HashMap;
+import java.util.HashSet;
+import java.util.Map;
+import java.util.Set;
+
 import org.apache.pig.impl.logicalLayer.FrontendException;
+import org.apache.pig.impl.util.Pair;
 import org.apache.pig.newplan.Operator;
 import org.apache.pig.newplan.PlanVisitor;
+import org.apache.pig.newplan.logical.expression.LogicalExpression;
 import org.apache.pig.newplan.logical.expression.LogicalExpressionPlan;
+import org.apache.pig.newplan.logical.relational.LogicalSchema.LogicalFieldSchema;
 
 public class LOSplitOutput extends LogicalRelationalOperator {
     private LogicalExpressionPlan filterPlan;
+    private Map<Long, Long> uidMapping = new HashMap<Long, Long>();
     public LOSplitOutput(LogicalPlan plan) {
         super("LOSplitOutput", plan);       
     }
@@ -50,7 +59,19 @@ public class LOSplitOutput extends LogicalRelationalOperator {
         LogicalRelationalOperator input = null;
         input = (LogicalRelationalOperator)plan.getPredecessors(this).get(0);
         
-        schema = input.getSchema();
+        if (input.getSchema()!=null) {
+            schema = input.getSchema().deepCopy();
+            for (LogicalFieldSchema fs : schema.getFields()) {
+                if (uidMapping.containsKey(fs.uid)) {
+                    fs.uid = uidMapping.get(fs.uid);
+                }
+                else {
+                    long predUid = fs.uid;
+                    fs.uid = LogicalExpression.getNextUid();
+                    uidMapping.put(predUid, fs.uid);
+                }
+            }
+        }
         return schema;
     }   
     
@@ -71,4 +92,17 @@ public class LOSplitOutput extends LogicalRelationalOperator {
             return false;
         }
     }
+    
+    @Override
+    public void resetUid() {
+        uidMapping = new HashMap<Long, Long>();
+    }
+    
+    public long getInputUids(long uid) {
+        for (Map.Entry<Long, Long> pair : uidMapping.entrySet()) {
+            if (pair.getValue()==uid)
+                return pair.getKey();
+        }
+        return -1;
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/relational/LOStream.java b/src/org/apache/pig/newplan/logical/relational/LOStream.java
index bb055db07..e1e487a4e 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOStream.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOStream.java
@@ -109,4 +109,8 @@ public class LOStream extends LogicalRelationalOperator {
         return castInserted;
     }
 
+    @Override
+    public void resetUid() {
+        uidOnlySchema = null;
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/relational/LOUnion.java b/src/org/apache/pig/newplan/logical/relational/LOUnion.java
index 1764275d4..f789840f3 100644
--- a/src/org/apache/pig/newplan/logical/relational/LOUnion.java
+++ b/src/org/apache/pig/newplan/logical/relational/LOUnion.java
@@ -120,4 +120,9 @@ public class LOUnion extends LogicalRelationalOperator {
         }
         return result;
     }
+    
+    @Override
+    public void resetUid() {
+        uidMapping = new ArrayList<Pair<Long, Long>>();
+    }
 }
diff --git a/src/org/apache/pig/newplan/logical/relational/LogicalRelationalOperator.java b/src/org/apache/pig/newplan/logical/relational/LogicalRelationalOperator.java
index b2c629ca1..b30fe1bfe 100644
--- a/src/org/apache/pig/newplan/logical/relational/LogicalRelationalOperator.java
+++ b/src/org/apache/pig/newplan/logical/relational/LogicalRelationalOperator.java
@@ -83,7 +83,14 @@ abstract public class LogicalRelationalOperator extends Operator {
     public void resetSchema() {
         schema = null;
     }
- 
+    
+    /**
+     * Erase all cached uid, regenerate uid when we regenerating schema.
+     * This process currently only used in ImplicitSplitInsert, which will
+     * insert split and invalidate some uids in plan
+     */
+    public void resetUid() {
+    }
 
     /**
      * Get the requestedParallelism for this operator.
diff --git a/src/org/apache/pig/newplan/logical/rules/ColumnPruneHelper.java b/src/org/apache/pig/newplan/logical/rules/ColumnPruneHelper.java
index 0e811db5d..1afd423d5 100644
--- a/src/org/apache/pig/newplan/logical/rules/ColumnPruneHelper.java
+++ b/src/org/apache/pig/newplan/logical/rules/ColumnPruneHelper.java
@@ -367,7 +367,11 @@ public class ColumnPruneHelper {
             
             // the input uids contains all the output uids and
             // projections in splitOutput conditions
-            Set<Long> input = new HashSet<Long>(output);
+            Set<Long> input = new HashSet<Long>();
+            
+            for (long uid : output) {
+                input.add(splitOutput.getInputUids(uid));
+            }
             
             LogicalExpressionPlan exp = splitOutput.getFilterPlan();
             collectUids(splitOutput, exp, input);
diff --git a/src/org/apache/pig/newplan/logical/rules/ImplicitSplitInserter.java b/src/org/apache/pig/newplan/logical/rules/ImplicitSplitInserter.java
index 0cab633e8..27772783f 100644
--- a/src/org/apache/pig/newplan/logical/rules/ImplicitSplitInserter.java
+++ b/src/org/apache/pig/newplan/logical/rules/ImplicitSplitInserter.java
@@ -26,6 +26,7 @@ import org.apache.pig.data.DataType;
 import org.apache.pig.impl.logicalLayer.FrontendException;
 import org.apache.pig.impl.util.Pair;
 import org.apache.pig.newplan.Operator;
+import org.apache.pig.newplan.logical.optimizer.UidResetter;
 import org.apache.pig.newplan.logical.relational.LogicalPlan;
 import org.apache.pig.newplan.OperatorPlan;
 import org.apache.pig.newplan.logical.expression.LogicalExpressionPlan;
@@ -127,6 +128,8 @@ public class ImplicitSplitInserter extends Rule {
           currentPlan.connect(splitOp, splitOutput);
           currentPlan.connect(splitOutput, pos.first, suc, pos.second);
         }
+        UidResetter uidResetter = new UidResetter(currentPlan);
+        uidResetter.visit();
       }
       
       @Override
diff --git a/test/org/apache/pig/test/TestPruneColumn.java b/test/org/apache/pig/test/TestPruneColumn.java
index eef6f6faa..f5f73f97e 100644
--- a/test/org/apache/pig/test/TestPruneColumn.java
+++ b/test/org/apache/pig/test/TestPruneColumn.java
@@ -59,6 +59,7 @@ public class TestPruneColumn extends TestCase {
     File tmpFile8;
     File tmpFile9;
     File tmpFile10;
+    File tmpFile11;
     File logFile;
 
     private static final String simpleEchoStreamingCommand;
@@ -149,6 +150,12 @@ public class TestPruneColumn extends TestCase {
         ps.println("1\t[1#1,2#1]\t2");
         ps.close();
 
+        tmpFile11 = File.createTempFile("prune", "txt");
+        ps = new PrintStream(new FileOutputStream(tmpFile11));
+        ps.println("1\t2\t3");
+        ps.println("1\t3\t2");
+        ps.println("2\t5\t2");
+        ps.close();
     }
     
     @After
@@ -1832,6 +1839,34 @@ public class TestPruneColumn extends TestCase {
 
         assertTrue(emptyLogFileMessage());
     }
+    
+    @Test
+    public void testSplit5() throws Exception {
+        pigServer.registerQuery("A = load '"+ Util.generateURI(tmpFile11.toString(), pigServer.getPigContext()) + "' AS (a0:int, a1:int, a2:int);");
+        pigServer.registerQuery("B = foreach A generate a0, a1;");
+        pigServer.registerQuery("C = join A by a0, B by a0;");
+        pigServer.registerQuery("D = filter C by A::a1>=B::a1;");
+        Iterator<Tuple> iter = pigServer.openIterator("D");
+
+        assertTrue(iter.hasNext());
+        Tuple t = iter.next();
+        assertTrue(t.toString().equals("(1,2,3,1,2)"));
+        
+        assertTrue(iter.hasNext());
+        t = iter.next();
+        assertTrue(t.toString().equals("(1,3,2,1,2)"));
+        
+        assertTrue(iter.hasNext());
+        t = iter.next();
+        assertTrue(t.toString().equals("(1,3,2,1,3)"));
+
+        assertTrue(iter.hasNext());
+        t = iter.next();
+        assertTrue(t.toString().equals("(2,5,2,2,5)"));
+        
+        assertTrue(emptyLogFileMessage());
+    }
+
 
     // See PIG-1493
     @Test
@@ -1889,6 +1924,4 @@ public class TestPruneColumn extends TestCase {
         reader1.close();
         reader2.close();
     }
-
-
 }
