diff --git a/CHANGES.txt b/CHANGES.txt
index c6b9774ea..bc50d2765 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -42,6 +42,8 @@ PIG-1876: Typed map for Pig (daijy)
 
 IMPROVEMENTS
 
+PIG-2007: Parsing error when map key referred directly from udf in nested foreach (xuefu)
+
 PIG-2000: Pig gives incorrect error message dealing with scalar projection (xuefu)
 
 PIG-2002: Regression: Pig gives error "Projection with nothing to reference!" for a valid query (xuefu)
diff --git a/src/org/apache/pig/parser/QueryParser.g b/src/org/apache/pig/parser/QueryParser.g
index a7fcd8039..22f305099 100644
--- a/src/org/apache/pig/parser/QueryParser.g
+++ b/src/org/apache/pig/parser/QueryParser.g
@@ -556,16 +556,15 @@ nested_command_list : ( nested_command SEMI_COLON )*
                     |
 ;
 
-nested_command : IDENTIFIER EQUAL func_eval
-              -> ^( NESTED_CMD_ASSI IDENTIFIER func_eval )
-               | IDENTIFIER EQUAL nested_op
-              -> ^( NESTED_CMD IDENTIFIER nested_op )
+nested_command : ( IDENTIFIER EQUAL col_ref PERIOD col_ref_list { input.LA( 1 ) == SEMI_COLON }? ) => ( IDENTIFIER EQUAL nested_proj )
+              -> ^( NESTED_CMD IDENTIFIER nested_proj )
                | IDENTIFIER EQUAL expr
               -> ^( NESTED_CMD_ASSI IDENTIFIER expr )
+               | IDENTIFIER EQUAL nested_op
+              -> ^( NESTED_CMD IDENTIFIER nested_op )
 ;
 
-nested_op : nested_proj
-          | nested_filter
+nested_op : nested_filter
           | nested_sort
           | nested_distinct
           | nested_limit
diff --git a/test/org/apache/pig/parser/TestLogicalPlanGenerator.java b/test/org/apache/pig/parser/TestLogicalPlanGenerator.java
index 804ef7023..7c2257d2d 100644
--- a/test/org/apache/pig/parser/TestLogicalPlanGenerator.java
+++ b/test/org/apache/pig/parser/TestLogicalPlanGenerator.java
@@ -237,6 +237,20 @@ public class TestLogicalPlanGenerator {
         generateLogicalPlan( query );
     }
     
+    @Test
+    public void test20() {
+        String query = "A = load 'x' using PigStorage() as (a:int,b:chararray);\n" +
+                       "B = foreach A { C = TOMAP()#'key1'; generate C as C; };";
+        generateLogicalPlan( query );
+    }
+    
+    @Test
+    public void test21() {
+        String query = "A = load 'x' as (u, v);\n" +
+                       "B = foreach A { S = u; T = org.apache.pig.builtin.TOMAP(); generate S, T;};";
+        generateLogicalPlan( query );
+    }
+    
     @Test
     public void testFilter() {
         String query = "A = load 'x' as ( u:int, v:long, w:bytearray); " + 
