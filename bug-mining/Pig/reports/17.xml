<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:48:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-114] store one alias/logicalPlan twice leads to instantiation of StoreFunc as LoadFunc</title>
                <link>https://issues.apache.org/jira/browse/PIG-114</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Calling PigServer#store() twice for an alias results in following exception :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: java.lang.ClassCastException: org.apache.pig.test.DummyStoreFunc cannot be cast to org.apache.pig.LoadFunc
	at org.apache.pig.backend.local.executionengine.POLoad.&amp;lt;init&amp;gt;(POLoad.java:59)
	at org.apache.pig.backend.local.executionengine.LocalExecutionEngine.doCompile(LocalExecutionEngine.java:167)
	at org.apache.pig.backend.local.executionengine.LocalExecutionEngine.doCompile(LocalExecutionEngine.java:184)
	at org.apache.pig.backend.local.executionengine.LocalExecutionEngine.doCompile(LocalExecutionEngine.java:184)
	at org.apache.pig.backend.local.executionengine.LocalExecutionEngine.compile(LocalExecutionEngine.java:111)
	at org.apache.pig.backend.local.executionengine.LocalExecutionEngine.compile(LocalExecutionEngine.java:90)
	at org.apache.pig.backend.local.executionengine.LocalExecutionEngine.compile(LocalExecutionEngine.java:1)
	at org.apache.pig.PigServer.store(PigServer.java:330)
	at org.apache.pig.PigServer.store(PigServer.java:317)
	at org.apache.pig.test.StoreTwiceTest.testIt(StoreTwiceTest.java:31)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:589)
	at junit.framework.TestCase.runTest(TestCase.java:164)
	at junit.framework.TestCase.runBare(TestCase.java:130)
	at junit.framework.TestResult$1.protect(TestResult.java:110)
	at junit.framework.TestResult.runProtected(TestResult.java:128)
	at junit.framework.TestResult.run(TestResult.java:113)
	at junit.framework.TestCase.run(TestCase.java:120)
	at junit.framework.TestSuite.runTest(TestSuite.java:228)
	at junit.framework.TestSuite.run(TestSuite.java:223)
	at org.junit.internal.runners.OldTestClassRunner.run(OldTestClassRunner.java:35)
	at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:45)
	at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)
	at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)
Caused by: java.lang.ClassCastException: org.apache.pig.test.DummyStoreFunc cannot be cast to org.apache.pig.LoadFunc
	at org.apache.pig.backend.local.executionengine.POLoad.&amp;lt;init&amp;gt;(POLoad.java:57)
	... 28 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will attach a patch with a test scenario for this. Basically the code is as follow:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;PigServer pig = new PigServer(ExecType.LOCAL);
        pig
                .registerQuery(&quot;A = LOAD &apos;test/org/apache/pig/test/StoreTwiceTest.java&apos; USING &quot;
                        + DummyLoadFunc.class.getName() + &quot;();&quot;);
        pig.registerQuery(&quot;B = FOREACH A GENERATE * ;&quot;);
        File outputFile = new File(&quot;/tmp/testPigOutput&quot;);
        outputFile.delete();
        pig.store(&quot;A&quot;, outputFile.getAbsolutePath(), DummyStoreFunc.class
                .getName()
                + &quot;()&quot;);
        outputFile.delete();
        pig.store(&quot;B&quot;, outputFile.getAbsolutePath(), DummyStoreFunc.class
                .getName()
                + &quot;()&quot;);
        outputFile.delete();
        assertEquals(2, _storedTuples.size());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12389173">PIG-114</key>
            <summary>store one alias/logicalPlan twice leads to instantiation of StoreFunc as LoadFunc</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pi_song">Pi Song</assignee>
                                    <reporter username="oae">Johannes Zillmann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Feb 2008 23:57:29 +0000</created>
                <updated>Wed, 24 Mar 2010 22:01:21 +0000</updated>
                            <resolved>Thu, 17 Apr 2008 15:44:42 +0000</resolved>
                                    <version>0.0.0</version>
                                    <fixVersion>0.1.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12571146" author="joa23" created="Thu, 21 Feb 2008 18:55:29 +0000"  >&lt;p&gt;for reference:&lt;br/&gt;
From a frist look into the code I guess this is what happens.&lt;br/&gt;
The data are stored successfully on disk the first time you call store. So PoStore adds an entry to materializedResults.&lt;br/&gt;
What is basically a hashmap that holds OperatorKey - just a name and LocalResult - a pointer to the file you just wrote.&lt;/p&gt;

&lt;p&gt;If you now trigger store again for the same alias, pig tries to optimize performance bt reusing the output file you just stored.&lt;br/&gt;
This happens by first check if there is already materializedResults entry.&lt;br/&gt;
What is the case - so in theory this could be reused just read and writte again to a new path.&lt;br/&gt;
Now there are a couple of problems. First in your testcase you delete the output file (/tmp/testPigOutput) but pig tries to read in this file again to write it out again. What means you read and write at the same time into the same file. Another problem in your test you delete this file between the store calls , so it can&apos;t be read back.&lt;/p&gt;

&lt;p&gt;Now a pig come in.  Pig tries to read back in this file with the same object you used for storing this file.&lt;br/&gt;
So the object need to implement LoadFunc und StoreFunc, what is not the case in your test you only implement storefunc, what makes sense from my pov. See POLoad, line 57,&lt;br/&gt;
lf = (LoadFunc) PigContext.instantiateFuncFromSpec(fileSpec.getFuncSpec()); // the return value can be a StoreFunc only as well.&lt;/p&gt;

&lt;p&gt;This worked so far since most of the StoreFunc and LoadFunc are implemented in one class, but not a good idea.&lt;/p&gt;

&lt;p&gt;So now the question to the pig developers, how we can solve that problem?&lt;br/&gt;
Only cache materialized files in case we do have a load and a store func available?&lt;br/&gt;
Re process all required plans in case we can not load a materialized result?&lt;/p&gt;
</comment>
                            <comment id="12571825" author="pi_song" created="Sun, 24 Feb 2008 01:56:18 +0000"  >&lt;p&gt;Even both StoreFunc and LoadFunc exist in the custom storage class, it doesn&apos;t guarantee that &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;LoadFunc (StoreFunc(x)) = x
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as this is left open to users to implement.&lt;/p&gt;

&lt;p&gt;As the definition of optimization (in this case where we are only interested in output) , the output regardless of doing optimization or not should be the same.&lt;/p&gt;

&lt;p&gt;Reading the output of &quot;Store Operator&quot; is therefore considered &quot;unsafe&quot; for optimization.&lt;/p&gt;

&lt;p&gt;My suggestions would be :-&lt;br/&gt;
1. By default go back to get intermediate result before &quot;Store&quot; as this will rely on StoreFunc and LoadFunc of PigStorage (Supposing that this is not merely load-and-then-store execution plan). Though this will incur some performance hit as the output of MapReduce run associated with &quot;Store operator&quot; cannot be reused.&lt;br/&gt;
2. Provide a way for users implementing  storage to tell the execution engine that  LoadFunc  is truly inverse of StoreFunc in the implementation so that the execution engine can take advantage of that and doesn&apos;t have to go to the intermediate result before &quot;Store&quot; .&lt;br/&gt;
3. All the built-in storage implementation should be truly reversible&lt;/p&gt;</comment>
                            <comment id="12572264" author="joa23" created="Mon, 25 Feb 2008 22:01:05 +0000"  >&lt;p&gt;Hi Pi, &lt;br/&gt;
from my point of view 2. would be the cleanest and best solution. We should add a interface named something like ReversibleStorage (please give me a better name). This interface extends from Load and StoreFunc - java doc clearly mentioned that this interface implementation has to guarantee  ruly reversibility. &lt;br/&gt;
Then we change all internal store and load function to implement this interface. Finally we check during materialization if we can reuse output based if this interface is implemented. &lt;br/&gt;
If people agree I would be happy to work on a patch asap - since this is kind of a blocker issue for our project.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="12573254" author="pi_song" created="Thu, 28 Feb 2008 12:46:15 +0000"  >&lt;p&gt;Stefan,&lt;br/&gt;
Sorry I should have used bullets instead of numbers. What I really meant was all have to go together. (2) and (3) will be easy to do but (1) will require a lot more work. In order to do that I want to listen to other people a bit more.&lt;/p&gt;</comment>
                            <comment id="12573878" author="alangates" created="Fri, 29 Feb 2008 18:24:43 +0000"  >&lt;p&gt;I&apos;m working on making changes to the load function interface as part of the types.  Based on your discussion, I was thinking of adding a method isReversable to the interface.  I think this would meet requirement two.  Sound reasonable?&lt;/p&gt;</comment>
                            <comment id="12574027" author="pi_song" created="Sat, 1 Mar 2008 00:23:51 +0000"  >&lt;p&gt;Alan, &lt;/p&gt;

&lt;p&gt;Personally, I prefer a new interface.&lt;/p&gt;

&lt;p&gt;So we can have something like&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;LoadFunc
StoreFunc
ReversibleLoadStoreFunc extends LoadFunc, StoreFunc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This gives better control as someone to implement Load and Store in a reversible way will be enforced to implement both Load and Store. If you just add isReversable  in existing interfaces, you cannot enforce this.&lt;/p&gt;

&lt;p&gt;Should we create a sub-issue to deal with (2), (3) first? I think (1) will take a lot more time for testing.&lt;/p&gt;</comment>
                            <comment id="12574993" author="pi_song" created="Tue, 4 Mar 2008 14:07:48 +0000"  >&lt;p&gt;Alan,&lt;/p&gt;

&lt;p&gt;Are you still working on this? If you don&apos;t, I may submit an initial patch for discussion tomorrow.&lt;/p&gt;</comment>
                            <comment id="12575716" author="pi_song" created="Thu, 6 Mar 2008 14:24:53 +0000"  >&lt;p&gt;Here is the implementation of what we&apos;ve discussed above.&lt;/p&gt;

&lt;p&gt;This patch is only for preview. Open for discussion about the approach.(&lt;b&gt;Not to be committed&lt;/b&gt;)&lt;br/&gt;
All the current unit tests passed.&lt;/p&gt;

&lt;p&gt;Known issues&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Unit test still have to be refactored plus more tests needed (Thanks Johannes for initial test code)&lt;/li&gt;
	&lt;li&gt;PigContext seems to know too much about class instantiation. It may require a refactor. Though let&apos;s create a new issue to do it later.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also want to mention the concept of using marker interfaces for optimization hints if operators have special properties. For example, in this issue, we might want to do instead:-&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;LoadStoreFunc extends LoadFunc, StoreFunc
PigStorage implements LoadStoreFunc, Reversible
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Reversible is a marker interface telling that the applied two-way function is reversible.&lt;/p&gt;</comment>
                            <comment id="12575719" author="breed" created="Thu, 6 Mar 2008 14:40:28 +0000"  >&lt;p&gt;I&apos;m not a big fan of marker interfaces. (That doesn&apos;t mean we shouldn&apos;t do it of course &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; If we do use a Reversible interface it should extend LoadFunc and StoreFunc since it would be silly to use a Reversible marker and not implement both interfaces.&lt;/p&gt;

&lt;p&gt;Alternatively we could add a method to StoreFunc:&lt;/p&gt;

&lt;p&gt;LoadFunc getReloader();&lt;/p&gt;

&lt;p&gt;that returns a LoadFunc to use to reload the data or null if it cannot be reloaded. This would remove the requirement that a reloadable StoreFunc also implement LoadFunc. &lt;/p&gt;</comment>
                            <comment id="12576168" author="pi_song" created="Fri, 7 Mar 2008 12:46:30 +0000"  >&lt;p&gt;Ben,&lt;/p&gt;

&lt;p&gt;Sorry that I led to a long story again. I think whether to do marker interfaces or not can be addressed when we implement optimization.&lt;br/&gt;
At this stage I just want to fix this bug which as discussed above will be fixed by&lt;br/&gt;
(1) Add a structure to identify reversible property of StoreFunc&lt;br/&gt;
(2) Fix optimization engine not to do reverse if it&apos;s not safe&lt;br/&gt;
(3) Unit testing&lt;/p&gt;

&lt;p&gt;I have implemented (1) using what I&apos;ve proposed before&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;LoadFunc
StoreFunc
ReversibleLoadStoreFunc extends LoadFunc, StoreFunc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you&apos;ve said&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Alternatively we could add a method to StoreFunc:&lt;br/&gt;
LoadFunc getReloader();&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We still cannot conclude your way or my way which way is better. But since I&apos;ve already implemented using my way. Let&apos;s use my one. ( Meritocrazy &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;

&lt;p&gt;For (2) I&apos;ve fixed optimization in both local and mapreduce engines&lt;/p&gt;

&lt;p&gt;For (3) This time I do an end-to-end test. I&apos;m sorry for that. I find it much more complex to do only plan compiler test (This involves both local and mapreduce engines and physical ops are different). Also a usual way to do optimization test is to compare actual output structure with expected output structure (deterministic optimization engine). We still don&apos;t have that framework yet. This should be done as a part of optimization work.&lt;/p&gt;

</comment>
                            <comment id="12576169" author="pi_song" created="Fri, 7 Mar 2008 12:48:34 +0000"  >&lt;p&gt;Here&apos;s the complete patch.&lt;/p&gt;

&lt;p&gt;Unit test included.&lt;br/&gt;
All tests passed.&lt;/p&gt;

&lt;p&gt;Ready to be committed&lt;/p&gt;</comment>
                            <comment id="12576170" author="pi_song" created="Fri, 7 Mar 2008 12:49:19 +0000"  >&lt;p&gt;The flow doesn&apos;t work. I have to do manual attach.&lt;/p&gt;</comment>
                            <comment id="12576350" author="breed" created="Fri, 7 Mar 2008 19:55:59 +0000"  >&lt;p&gt;+1 Good job. My main concern was that Reversible not just be a marker otherwise programmers could mark classes that could not possibly be reversible (by not implementing LoadFunc for example), so I&apos;m happy with extending LoadFunc and StoreFunc.&lt;/p&gt;</comment>
                            <comment id="12576399" author="pi_song" created="Fri, 7 Mar 2008 22:08:30 +0000"  >&lt;p&gt;That&apos;s right. This implementation doesn&apos;t rely on marker interface concept.&lt;/p&gt;

&lt;p&gt;However you still cannot make it 100%. There&apos;s still risk if someone implements ReversibleLoadStoreFunc without really having &quot;LoadFunc (StoreFunc( x )) = x&quot;. Therefore what we can do is just enforce the contract in documentation. In order to do optimization based on UDF, I think there is no 100% safe. (For example, in the current LoadFunc, you intention is to have the class reading data from filename supplied in bind() right? but people can still read from somewhere else. Someone might just open /etc/passwd and send it out )&lt;/p&gt;</comment>
                            <comment id="12576411" author="breed" created="Fri, 7 Mar 2008 22:21:48 +0000"  >&lt;p&gt;I completely agree, and you already have the contract documented in the ReversibleLoadStoreFunc interface.&lt;/p&gt;</comment>
                            <comment id="12579618" author="olgan" created="Mon, 17 Mar 2008 21:33:38 +0000"  >&lt;p&gt;Ben, is this patch ready to be committed?&lt;/p&gt;</comment>
                            <comment id="12579655" author="breed" created="Mon, 17 Mar 2008 22:50:17 +0000"  >&lt;p&gt;yes&lt;/p&gt;</comment>
                            <comment id="12586907" author="alangates" created="Tue, 8 Apr 2008 17:52:46 +0000"  >&lt;p&gt;Sorry for the way long delay, but I have a question on this code.  If I understand it correctly, it forces all load and store functions to be reversible since the engine currently (wrongly) makes that assumption.  Is that correct?  If so, that doesn&apos;t seem good.  We have loader functions that users are using that are not store functions.  We can&apos;t break them now just because internally we try to do the wrong thing.  We should fix the underlying problem.  I&apos;m not saying the Reversible interface is a bad idea, because that can allow the system to optimize better.  But we can&apos;t force all load functions to be reversible immediately.&lt;/p&gt;</comment>
                            <comment id="12586999" author="pi_song" created="Tue, 8 Apr 2008 23:10:20 +0000"  >&lt;p&gt;Alan,&lt;/p&gt;

&lt;p&gt;This code changes the semantic to not load from previous result by default unless the previous result was stored by a reversible load/store function. It has also changed internal storages (e.g. PigStorage) to implement reversible interface.&lt;/p&gt;</comment>
                            <comment id="12587007" author="alangates" created="Tue, 8 Apr 2008 23:31:22 +0000"  >&lt;p&gt;In MapReducePlanCompiler.java, &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (PigContext.instantiateFuncFromSpec(materializedResult.outFileSpec.getFuncSpec()) 
        &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ReversibleLoadStoreFunc) {
    POMapreduce pom = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; POMapreduce(logicalKey.getScope(),
                                      nodeIdGenerator.getNextNodeId(logicalKey.getScope()),
                                      execEngine.getPhysicalOpTable(),
                                      logicalKey,
                                      pigContext);
    pom.addInputFile(fileSpec);
    pom.mapParallelism = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(pom.mapParallelism, materializedResult.parallelismRequest);
                
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pom.getOperatorKey();      
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That looks to me like it won&apos;t allow map reduce to start unless the store func&lt;br/&gt;
is reversible.  Am I missing something?&lt;/p&gt;
</comment>
                            <comment id="12587169" author="pi_song" created="Wed, 9 Apr 2008 12:34:30 +0000"  >&lt;p&gt;Alan, &lt;/p&gt;

&lt;p&gt;That block is basically just a caching hook-up, if the function is not reversible then it will fall through to below which is actually compiling the operator and use it without reading the cached output. My opinion toward the new plan compilation is to move something like this to the optimization stage as an optional filter.&lt;/p&gt;

&lt;p&gt;Here is the block including its context:-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; OperatorKey compile(OperatorKey logicalKey, 
                               Map&amp;lt;OperatorKey, LogicalOperator&amp;gt; logicalOpTable, 
                               HExecutionEngine execEngine) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        
        &lt;span class=&quot;code-comment&quot;&gt;// check to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we have materialized results &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the logical tree to
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// compile, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; so, re-use them...
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;        Map&amp;lt;OperatorKey, MapRedResult&amp;gt; materializedResults = execEngine.getMaterializedResults();
        
        MapRedResult materializedResult = materializedResults.get(logicalKey);
        
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( (materializedResult != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &amp;amp;&amp;amp; 
             (PigContext.instantiateFuncFromSpec(materializedResult.outFileSpec.getFuncSpec()) 
                                                           &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ReversibleLoadStoreFunc)  )  {
            	POMapreduce pom = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; POMapreduce(logicalKey.getScope(),
                             	                 nodeIdGenerator.getNextNodeId(logicalKey.getScope()),
                                	              execEngine.getPhysicalOpTable(),
                                	              logicalKey,
                                	              pigContext);

           		pom.addInputFile(materializedResult.outFileSpec);
            	pom.mapParallelism = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(pom.mapParallelism, materializedResult.parallelismRequest);

            	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pom.getOperatorKey();           
        }
        
        &lt;span class=&quot;code-comment&quot;&gt;// first, compile inputs into MapReduce operators
&lt;/span&gt;        OperatorKey[] compiledInputs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OperatorKey[logicalOpTable.get(logicalKey).getInputs().size()];
        
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; logicalOpTable.get(logicalKey).getInputs().size(); i++)
            compiledInputs[i] = compile(logicalOpTable.get(logicalKey).getInputs().get(i),
                                        logicalOpTable,
                                        execEngine);
        
        &lt;span class=&quot;code-comment&quot;&gt;// then, compile &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; possible, merge with previous MapReduce
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; rather than introducing a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; one
&lt;/span&gt;        
        LogicalOperator lo = logicalOpTable.get(logicalKey);
        
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lo &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; LOEval) {
            POMapreduce pom = ((POMapreduce)execEngine.getPhysicalOpTable().get(compiledInputs[0]))
                                .copy(nodeIdGenerator.getNextNodeId(logicalKey.getScope())); &lt;span class=&quot;code-comment&quot;&gt;// make a copy of the previous
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// More and more and more plan compilation here&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12587171" author="pi_song" created="Wed, 9 Apr 2008 12:36:05 +0000"  >&lt;p&gt;BTW, this new patch is in sync with the current trunk.&lt;/p&gt;</comment>
                            <comment id="12587237" author="olgan" created="Wed, 9 Apr 2008 15:35:32 +0000"  >&lt;p&gt;Are we adding test cases with both reversable and non-reversable storage functions? I think this has to be part of this patch.&lt;/p&gt;</comment>
                            <comment id="12587396" author="pi_song" created="Wed, 9 Apr 2008 21:59:25 +0000"  >&lt;p&gt;Of course, I&apos;ve included the test cases.&lt;/p&gt;</comment>
                            <comment id="12590072" author="alangates" created="Thu, 17 Apr 2008 15:44:42 +0000"  >&lt;p&gt;Patch checked in at revision 649154.  Thanks Pi.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12377342" name="PIG114_FixOptimize1.patch" size="15488" author="pi_song" created="Fri, 7 Mar 2008 12:49:19 +0000"/>
                            <attachment id="12377258" name="PIG114_FixOptimize_Sample.patch" size="10294" author="pi_song" created="Thu, 6 Mar 2008 14:24:53 +0000"/>
                            <attachment id="12376073" name="pigPatch-storeTwice-620665.patch" size="3645" author="oae" created="Wed, 20 Feb 2008 23:58:22 +0000"/>
                            <attachment id="12379723" name="pig_114_optimize_fix_v2.patch" size="15291" author="pi_song" created="Wed, 9 Apr 2008 12:36:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163775</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gg9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94067</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>