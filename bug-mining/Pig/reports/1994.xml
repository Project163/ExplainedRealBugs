<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5370] Union onschema + columnprune dropping used fields </title>
                <link>https://issues.apache.org/jira/browse/PIG-5370</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-5312&quot; title=&quot;Uids not set in inner schemas after UNION ONSCHEMA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-5312&quot;&gt;&lt;del&gt;PIG-5312&lt;/del&gt;&lt;/a&gt;, below query started failing.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = load &lt;span class=&quot;code-quote&quot;&gt;&apos;input.txt&apos;&lt;/span&gt; as (a1:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, a2:chararray, a3:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
B = FOREACH (GROUP A by (a1,a2)) {
    A_FOREACH = FOREACH A GENERATE a2,a3;
    GENERATE A, FLATTEN(A_FOREACH) as (a2,a3);
}
C = load &lt;span class=&quot;code-quote&quot;&gt;&apos;input2.txt&apos;&lt;/span&gt; as (A:bag{tuple:(a1: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,a2: chararray,a3:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)},a2: chararray,a3:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);

D = UNION ONSCHEMA B, C;

dump D;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;input1.txt&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1       a       3
2       b       4
2       c       5
1       a       6
2       b       7
1       c       8
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;input2.txt&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{(10,a0,30),(20,b0,40)} zzz     222
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Expected output&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;({(10,a0,30),(20,b0,40)},zzz,222)
({(1,a,6),(1,a,3)},a,6)
({(1,a,6),(1,a,3)},a,3)
({(1,c,8)},c,8)
({(2,b,7),(2,b,4)},b,7)
({(2,b,7),(2,b,4)},b,4)
({(2,c,5)},c,5)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Actual (incorrect) output&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;({(10,a0,30),(20,b0,40)})    ****ONLY 1 Field ****
({(1,a,6),(1,a,3)},a,6)
({(1,a,6),(1,a,3)},a,3)
({(1,c,8)},c,8)
({(2,b,7),(2,b,4)},b,7)
({(2,b,7),(2,b,4)},b,4)
({(2,c,5)},c,5)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13199919">PIG-5370</key>
            <summary>Union onschema + columnprune dropping used fields </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Nov 2018 19:49:02 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:09 +0000</updated>
                            <resolved>Fri, 30 Nov 2018 21:12:09 +0000</resolved>
                                                    <fixVersion>0.18.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16695231" author="knoguchi" created="Wed, 21 Nov 2018 20:27:38 +0000"  >&lt;p&gt;Pig does create the correct result if we skip&#160;ColumnMapKeyPrune optimization.&lt;/p&gt;

&lt;p&gt;Calling &quot;explain D&quot; with &apos;-t ColumnMapKeyPrune&apos;, it shows&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;|---D: (Name: LOUnion Schema: A#40:bag{tuple#41:tuple(a1#42:int,a2#43:chararray,a3#44:int)},a2#43:chararray,a3#44:int)
    |
    |---B: (Name: LOForEach Schema: A#36:bag{#37:tuple(a1#9:int,a2#*10*:chararray,a3#*11*:int)},a2#*10*:chararray,a3#*11*:int)
    |
    |---C: (Name: LOForEach Schema: A#17:bag{tuple#49:tuple(a1#50:int,a2#51:chararray,a3#52:int)},a2#22:chararray,a3#23:int)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This issue only happen when we have a relation like B where inner schema contains a field with same uid as the one at the root level.  In the above example, uid &lt;tt&gt;&amp;#42;10&amp;#42;&lt;/tt&gt; and &lt;tt&gt;&amp;#42;11&amp;#42;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Before &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-5312&quot; title=&quot;Uids not set in inner schemas after UNION ONSCHEMA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-5312&quot;&gt;&lt;del&gt;PIG-5312&lt;/del&gt;&lt;/a&gt;, schema of the inner bag was set to null so we didn&apos;t have this issue.&lt;br/&gt;
With &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-5312&quot; title=&quot;Uids not set in inner schemas after UNION ONSCHEMA&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-5312&quot;&gt;&lt;del&gt;PIG-5312&lt;/del&gt;&lt;/a&gt;, and the way LOUnion determines the output UIDS based on input UIDs, two issues are happening.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;schema of LOUnion is using the same uid for inner bag and outside. (UID 43 &amp;amp; 44)&lt;/li&gt;
	&lt;li&gt;ColumnMapKeyPrune is (incorrectly) determining that a2#22 &amp;amp; a3#23 are not being used and dropping them.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Reading &lt;tt&gt;DuplicateForEachColumnRewriteVisitor.java&lt;/tt&gt;, &quot;relation B using the same uid&quot; is a correct behavior since they are not at the same level.  So I&apos;m guessing the required fix would be in the LOUnion.&lt;/p&gt;</comment>
                            <comment id="16701435" author="knoguchi" created="Wed, 28 Nov 2018 06:20:48 +0000"  >&lt;p&gt;I can think of two different approaches.&lt;/p&gt;

&lt;p&gt;&amp;#40;i) Even for overlapping uids on different nested level, do not allow them&#160;and&lt;br/&gt;
 force IdentityColumn. This way, all uids will be unique.&lt;/p&gt;

&lt;p&gt;(ii) Change LOUnion uidMapping logic from (output_uid, input_uid) lists to&lt;br/&gt;
 (output_uid, nested_uids).&lt;/p&gt;

&lt;p&gt;Attaching a patch that tries (ii). If possible, I&apos;d like to avoid &amp;#40;i) which is already&lt;br/&gt;
 creating more uids to keep track.&lt;/p&gt;

&lt;p&gt;Taking one relation as example,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;B: (Name: LOForEach Schema: A#36:bag{#37:tuple(a1#9:int,a2#*10*:chararray,a3#*11*:int)},a2#*10*:chararray,a3#*11*:int)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Before the patch, input_uid&lt;br/&gt;
 36,9,10,11,10,11&lt;br/&gt;
were used for uidMapping.&lt;/p&gt;

&lt;p&gt;After the patch, it&apos;ll use nested_uids,&lt;br/&gt;
 _36, _36_9, _36_10, _36_11, _10, _11&lt;/p&gt;

&lt;p&gt;This way, there won&apos;t be any incorrect list lookup.&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;, would this approach work? &lt;/p&gt;</comment>
                            <comment id="16702822" author="daijy" created="Thu, 29 Nov 2018 07:57:39 +0000"  >&lt;p&gt;+1, sounds good to me.&lt;/p&gt;</comment>
                            <comment id="16703539" author="knoguchi" created="Thu, 29 Nov 2018 17:29:40 +0000"  >&lt;p&gt;Sorry, somehow my last patch didn&apos;t include a unit-test.  Uploaded &lt;tt&gt;pig-5370-v2.patch&lt;/tt&gt; with a test.&lt;/p&gt;</comment>
                            <comment id="16705097" author="knoguchi" created="Fri, 30 Nov 2018 18:09:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sorry, somehow my last patch didn&apos;t include a unit-test. Uploaded pig-5370-v2.patch with a test.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;, sorry to bug you again on this.  Can you take a look at my v2 patch that added a unit test? &lt;/p&gt;</comment>
                            <comment id="16705272" author="daijy" created="Fri, 30 Nov 2018 20:58:45 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16705284" author="knoguchi" created="Fri, 30 Nov 2018 21:12:09 +0000"  >&lt;p&gt;Thanks for the review Daniel!!!&#160;&lt;/p&gt;

&lt;p&gt;&#160;Committed to trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13115706">PIG-5312</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12949796" name="pig-5370-v1.patch" size="5168" author="knoguchi" created="Wed, 28 Nov 2018 05:56:16 +0000"/>
                            <attachment id="12950047" name="pig-5370-v2.patch" size="7021" author="knoguchi" created="Thu, 29 Nov 2018 17:28:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00r2w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>