<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4916] Pig on Tez fail to remove temporary HDFS files in some cases</title>
                <link>https://issues.apache.org/jira/browse/PIG-4916</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;We saw the following stack trace when running Pig on S3:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-06-01 22:04:22,714 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19] INFO  org.apache.hadoop.service.AbstractService - Service org.apache.hadoop.yarn.client.api.impl.TimelineClientImpl failed in state STOPPED; cause: java.io.IOException: Filesystem closed
java.io.IOException: Filesystem closed
	at org.apache.hadoop.hdfs.DFSClient.checkOpen(DFSClient.java:808)
	at org.apache.hadoop.hdfs.DFSOutputStream.flushOrSync(DFSOutputStream.java:2034)
	at org.apache.hadoop.hdfs.DFSOutputStream.hflush(DFSOutputStream.java:1980)
	at org.apache.hadoop.fs.FSDataOutputStream.hflush(FSDataOutputStream.java:130)
	at org.apache.hadoop.yarn.client.api.impl.FileSystemTimelineWriter$LogFD.flush(FileSystemTimelineWriter.java:370)
	at org.apache.hadoop.yarn.client.api.impl.FileSystemTimelineWriter$LogFDsCache.flush(FileSystemTimelineWriter.java:485)
	at org.apache.hadoop.yarn.client.api.impl.FileSystemTimelineWriter.close(FileSystemTimelineWriter.java:271)
	at org.apache.hadoop.yarn.client.api.impl.TimelineClientImpl.serviceStop(TimelineClientImpl.java:326)
	at org.apache.hadoop.service.AbstractService.stop(AbstractService.java:221)
	at org.apache.tez.dag.history.ats.acls.ATSV15HistoryACLPolicyManager.close(ATSV15HistoryACLPolicyManager.java:259)
	at org.apache.tez.client.TezClient.stop(TezClient.java:582)
	at org.apache.pig.backend.hadoop.executionengine.tez.TezSessionManager.shutdown(TezSessionManager.java:308)
	at org.apache.pig.backend.hadoop.executionengine.tez.TezSessionManager$1.run(TezSessionManager.java:53)
2016-06-01 22:04:22,718 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19] ERROR org.apache.pig.backend.hadoop.executionengine.tez.TezSessionManager - Error shutting down Tez session org.apache.tez.client.TezClient@48bf833a
org.apache.hadoop.service.ServiceStateException: java.io.IOException: Filesystem closed
	at org.apache.hadoop.service.ServiceStateException.convert(ServiceStateException.java:59)
	at org.apache.hadoop.service.AbstractService.stop(AbstractService.java:225)
	at org.apache.tez.dag.history.ats.acls.ATSV15HistoryACLPolicyManager.close(ATSV15HistoryACLPolicyManager.java:259)
	at org.apache.tez.client.TezClient.stop(TezClient.java:582)
	at org.apache.pig.backend.hadoop.executionengine.tez.TezSessionManager.shutdown(TezSessionManager.java:308)
	at org.apache.pig.backend.hadoop.executionengine.tez.TezSessionManager$1.run(TezSessionManager.java:53)
Caused by: java.io.IOException: Filesystem closed
	at org.apache.hadoop.hdfs.DFSClient.checkOpen(DFSClient.java:808)
	at org.apache.hadoop.hdfs.DFSOutputStream.flushOrSync(DFSOutputStream.java:2034)
	at org.apache.hadoop.hdfs.DFSOutputStream.hflush(DFSOutputStream.java:1980)
	at org.apache.hadoop.fs.FSDataOutputStream.hflush(FSDataOutputStream.java:130)
	at org.apache.hadoop.yarn.client.api.impl.FileSystemTimelineWriter$LogFD.flush(FileSystemTimelineWriter.java:370)
	at org.apache.hadoop.yarn.client.api.impl.FileSystemTimelineWriter$LogFDsCache.flush(FileSystemTimelineWriter.java:485)
	at org.apache.hadoop.yarn.client.api.impl.FileSystemTimelineWriter.close(FileSystemTimelineWriter.java:271)
	at org.apache.hadoop.yarn.client.api.impl.TimelineClientImpl.serviceStop(TimelineClientImpl.java:326)
	at org.apache.hadoop.service.AbstractService.stop(AbstractService.java:221)
	... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The job run successfully, but the temporary hdfs files are not removed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; points out FileSystem also use shutdown hook to close FileSystem instances and it might run before Pig&apos;s shutdown hook in Main. By switching to Hadoop&apos;s ShutdownHookManager, we can put an order on shutdown hook.&lt;/p&gt;

&lt;p&gt;This has been verified by testing the following code in Main:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        ShutdownHookManager.get().addShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                FileLocalizer.deleteTempResourceFiles();
            }
        }, priority);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice FileSystem.SHUTDOWN_HOOK_PRIORITY=10. When priority=9, Pig fail. When priority=11, Pig success.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12974972">PIG-4916</key>
            <summary>Pig on Tez fail to remove temporary HDFS files in some cases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Jun 2016 23:27:29 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:29 +0000</updated>
                            <resolved>Mon, 6 Jun 2016 22:14:01 +0000</resolved>
                                                    <fixVersion>0.17.0</fixVersion>
                    <fixVersion>0.16.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15311355" author="daijy" created="Wed, 1 Jun 2016 23:30:33 +0000"  >&lt;p&gt;I don&apos;t see a way to write a test case since this is non-deterministic in nature.&lt;/p&gt;</comment>
                            <comment id="15311391" author="cnauroth" created="Wed, 1 Jun 2016 23:43:11 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;.  Thank you for the patch.  +1 (non-binding) from me.  I agree that it isn&apos;t feasible to write a unit test for this.  We have confirmation from your manual testing that it worked though.&lt;/p&gt;</comment>
                            <comment id="15317095" author="rohini" created="Mon, 6 Jun 2016 19:56:11 +0000"  >&lt;p&gt;Does it compile on Hadoop 1.x? I don&apos;t see any ShutdownHooManager class or FileSystem.SHUTDOWN_HOOK_PRIORITY in &lt;a href=&quot;https://github.com/apache/hadoop/blob/branch-1.2/src/core/org/apache/hadoop/fs/FileSystem.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/branch-1.2/src/core/org/apache/hadoop/fs/FileSystem.java&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Can you please create a HadoopShims method addShutdownHook(Runnable runnable, int priorityIncrease) ? Hadoop 1.x will have the older implementation. Where priorityIncrease is the increase from FileSystem.SHUTDOWN_HOOK_PRIORITY  and will be 1. Can you change all of our other shutdown hooks to use the same? Based on the stacktrace TezSessionManager.shutdown also failed and would have left orphaned apps.&lt;/p&gt;</comment>
                            <comment id="15317236" author="daijy" created="Mon, 6 Jun 2016 21:01:28 +0000"  >&lt;p&gt;Good catch on Hadoop 1 compilation failure. In that sense, I&apos;d only put the fix on 0.17 where we drop Hadoop 1.x support. I don&apos;t want to put a short lived code and make the process complex.&lt;/p&gt;

&lt;p&gt;TezSessionManager.shutdown failure is due to the FileSystem closure and should be fixed. What&apos;s the benefit to switch all shutdown hooks to use the same? Code consistency?&lt;/p&gt;</comment>
                            <comment id="15317238" author="rohini" created="Mon, 6 Jun 2016 21:04:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;TezSessionManager.shutdown failure is due to the FileSystem closure and should be fixed. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  It will not be fixed as only resource files deletion shutdown hook is run after FileSystem closure in the patch.&lt;/p&gt;</comment>
                            <comment id="15317352" author="rohini" created="Mon, 6 Jun 2016 22:01:33 +0000"  >&lt;p&gt;I can take care of that in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4921&quot; title=&quot;Kill running jobs on InterruptedException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4921&quot;&gt;&lt;del&gt;PIG-4921&lt;/del&gt;&lt;/a&gt; if you want. We can just go ahead and commit this.&lt;/p&gt;</comment>
                            <comment id="15317374" author="daijy" created="Mon, 6 Jun 2016 22:12:35 +0000"  >&lt;p&gt;Thanks Rohini. I will commit it shortly.&lt;/p&gt;</comment>
                            <comment id="15317378" author="daijy" created="Mon, 6 Jun 2016 22:14:01 +0000"  >&lt;p&gt;Patch committed to trunk. Thanks Rohini and Chris for review!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12807555" name="PIG-4916-1.patch" size="1187" author="daijy" created="Wed, 1 Jun 2016 23:29:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yuv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>