<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5311] POReservoirSample fails for more than Integer.MAX_VALUE records</title>
                <link>https://issues.apache.org/jira/browse/PIG-5311</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POReservoirSample.java#L128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POReservoirSample.java#L128&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The rowProcessed is a int. When it exceeds the int range it wraps around and becomes a negative number throwing below exception. It needs to be changed to long.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalArgumentException: bound must be positive
&#8195;&#8195;at java.util.Random.nextInt(Random.java:388)
&#8195;&#8195;at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POReservoirSample.getNextTuple(POReservoirSample.java:128)
&#8195;&#8195;at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:305)
&#8195;&#8195;at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POForEach.getNextTuple(POForEach.java:284)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13112680">PIG-5311</key>
            <summary>POReservoirSample fails for more than Integer.MAX_VALUE records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Oct 2017 21:00:42 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:08 +0000</updated>
                            <resolved>Sun, 31 Dec 2017 01:31:23 +0000</resolved>
                                                    <fixVersion>0.18.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16300712" author="rohini" created="Thu, 21 Dec 2017 23:14:26 +0000"  >&lt;p&gt; Keeping it as long, required typecasting at multiple places (array index and argument to random.nextInt method). So used both int and a long variable for the fix to avoid that.&lt;/p&gt;</comment>
                            <comment id="16304806" author="knoguchi" created="Wed, 27 Dec 2017 21:09:15 +0000"  >&lt;p&gt;First time looking at sampling.  &lt;br/&gt;
I need to test it myself but two questions.&lt;/p&gt;

&lt;p&gt;&amp;#40;i) Unrelated to this patch, but &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  118         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (res == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || res.returnStatus != POStatus.STATUS_EOP) {
  119             Random randGen = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do we need to set the seed like we did in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4819&quot; title=&quot;RANDOM() udf can lead to missing or redundant records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4819&quot;&gt;&lt;del&gt;PIG-4819&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;(ii) &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  182     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Result retrieveSample() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ExecException {
  183         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(nextSampleIdx &amp;lt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(rowProcessed, samples.length)){
...
  193         }
  194         &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;{
  195             samples = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// Free memory
&lt;/span&gt;  196             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; RESULT_EOP;
  197         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When rowProcessed is wrapped around to a negative number, wouldn&apos;t this always return null ?&lt;/p&gt;</comment>
                            <comment id="16304824" author="rohini" created="Wed, 27 Dec 2017 21:54:59 +0000"  >&lt;p&gt;Good catch. Fixed both.&lt;/p&gt;</comment>
                            <comment id="16305556" author="knoguchi" created="Thu, 28 Dec 2017 16:07:35 +0000"  >&lt;p&gt;Thanks Rohini.   &lt;br/&gt;
For readability, I&apos;m not sure if having &lt;br/&gt;
&amp;#8211; both rowProcessed and rowProcessedLong &lt;br/&gt;
is better than &lt;br/&gt;
&amp;#8211; having a single count and typecasting at multiple places.  &lt;br/&gt;
I think latter is better but no strong preference. &lt;/p&gt;

&lt;p&gt;Outside of that, found one critical issue.&lt;br/&gt;
Learning the &quot;Reservoir sampling&quot; from &lt;br/&gt;
&lt;a href=&quot;https://en.wikipedia.org/wiki/Reservoir_sampling&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://en.wikipedia.org/wiki/Reservoir_sampling&lt;/a&gt;&lt;br/&gt;
and looking at the following change,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rand = randGen.nextInt(rowProcessed + 1);
+                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rand = randGen.nextInt(getPositiveVal(rowProcessed));
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rand &amp;lt; numSamples) {
                     samples[rand] = res;
                 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this breaks the reservoir sampling algorithm (when count is larger than Integer.MAX_VALUE).  &lt;br/&gt;
Random number generated here has to be from 0...rowProcessedLong in order to preserve the feature of this algorithm: each item is kept with probability of &lt;tt&gt;numSamples / total&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="16305719" author="rohini" created="Thu, 28 Dec 2017 20:26:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;both rowProcessed and rowProcessedLong&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Was just the recent influence from writing bytecode &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;this breaks the reservoir sampling algorithm&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Switched form Random to RandomDataGenerator from commons-math3 (&lt;a href=&quot;http://commons.apache.org/proper/commons-math/javadocs/api-3.6.1/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/proper/commons-math/javadocs/api-3.6.1/index.html&lt;/a&gt;). Thanks for catching this and not letting me take a shortcut saying this is a very rare case.&lt;/p&gt;

&lt;p&gt;Other things that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt; suggested in our offline discussion were&lt;br/&gt;
1) &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadLocalRandom.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ThreadLocalRandom.html&lt;/a&gt;&lt;br/&gt;
Discarded this as it had nextLong but no option to provide seed.&lt;br/&gt;
2) &lt;a href=&quot;https://stackoverflow.com/questions/2546078/java-random-long-number-in-0-x-n-range&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/2546078/java-random-long-number-in-0-x-n-range&lt;/a&gt;&lt;br/&gt;
RandomDataGenerator and extending Random with nextLong() were two of the solutions I tried from this. The nextLong() produced some negative numbers. Did not spend time debugging that. Tried RandomDataGenerator with some ranges comparing it to Random. More or less similar. So went with that.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; taskIdHashCode = &lt;span class=&quot;code-quote&quot;&gt;&quot;task_1509095573435_5386881_1_04_000462&quot;&lt;/span&gt;.hashCode();
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; randomSeed = ((&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)taskIdHashCode &amp;lt;&amp;lt; 32) | (taskIdHashCode &amp;amp; 0xffffffffL);
        Random rand = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(randomSeed);
        BufferedWriter bo = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedWriter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileWriter(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;));
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;( &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1 ; i &amp;lt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE; i++) {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; val = rand.nextInt(i);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (val &amp;lt; 100) {
                bo.write(i + &lt;span class=&quot;code-quote&quot;&gt;&quot; = &quot;&lt;/span&gt; + val + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(i + &lt;span class=&quot;code-quote&quot;&gt;&quot; = &quot;&lt;/span&gt; + val);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i % 10000 == 0) {
                bo.flush();
            }
        }
        bo.close();

        RandomDataGenerator randGen = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomDataGenerator();
        randGen.reSeed(randomSeed);
        BufferedWriter bo1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedWriter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileWriter(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&quot;&lt;/span&gt;));
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;( &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; i = 1 ; i &amp;lt; 100000000000L; i++) { &lt;span class=&quot;code-comment&quot;&gt;//100 Billion
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; val = randGen.nextLong(0, i);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (val &amp;lt; 100) {
                bo1.write(i + &lt;span class=&quot;code-quote&quot;&gt;&quot; = &quot;&lt;/span&gt; + val + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(i + &lt;span class=&quot;code-quote&quot;&gt;&quot; = &quot;&lt;/span&gt; + val);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i % 10000 == 0) {
                bo.flush();
            }
        }
        bo1.close();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Done&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="16305912" author="knoguchi" created="Fri, 29 Dec 2017 02:24:20 +0000"  >&lt;p&gt;&lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-5311&quot; title=&quot;POReservoirSample fails for more than Integer.MAX_VALUE records&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-5311&quot;&gt;&lt;del&gt;PIG-5311&lt;/del&gt;&lt;/a&gt;-3.patch&lt;/tt&gt; looks good. +1&lt;br/&gt;
Thanks for being patient with me. &lt;/p&gt;</comment>
                            <comment id="16307026" author="rohini" created="Sun, 31 Dec 2017 01:31:23 +0000"  >&lt;p&gt;Committed to trunk. Thanks for the very thorough review Koji.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12903328" name="PIG-5311-1.patch" size="2812" author="rohini" created="Thu, 21 Dec 2017 23:12:17 +0000"/>
                            <attachment id="12903837" name="PIG-5311-2.patch" size="5280" author="rohini" created="Wed, 27 Dec 2017 21:54:52 +0000"/>
                            <attachment id="12903937" name="PIG-5311-3.patch" size="4673" author="rohini" created="Thu, 28 Dec 2017 20:18:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lt3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>