<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5277] Spark mode is writing nulls among tuples to the output </title>
                <link>https://issues.apache.org/jira/browse/PIG-5277</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;After committing &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3655&quot; title=&quot;BinStorage and InterStorage approach to record markers is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3655&quot;&gt;&lt;del&gt;PIG-3655&lt;/del&gt;&lt;/a&gt; a couple of Spark mode tests (e.g. org.apache.pig.test.TestEvalPipeline.testCogroupAfterDistinct) started failing on:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.Error: java.io.IOException: Corrupt data file, expected tuple type &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;, but seen 27
	at org.apache.pig.backend.hadoop.executionengine.HJob$1.hasNext(HJob.java:122)
	at org.apache.pig.test.TestEvalPipeline.testCogroupAfterDistinct(TestEvalPipeline.java:1052)
Caused by: java.io.IOException: Corrupt data file, expected tuple type &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;, but seen 27
	at org.apache.pig.impl.io.InterRecordReader.readDataOrEOF(InterRecordReader.java:158)
	at org.apache.pig.impl.io.InterRecordReader.nextKeyValue(InterRecordReader.java:194)
	at org.apache.pig.impl.io.InterStorage.getNext(InterStorage.java:79)
	at org.apache.pig.impl.io.ReadToEndLoader.getNextHelper(ReadToEndLoader.java:238)
	at org.apache.pig.impl.io.ReadToEndLoader.getNext(ReadToEndLoader.java:218)
	at org.apache.pig.backend.hadoop.executionengine.HJob$1.hasNext(HJob.java:115)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is because InterRecordReader became much stricter after &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3655&quot; title=&quot;BinStorage and InterStorage approach to record markers is broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3655&quot;&gt;&lt;del&gt;PIG-3655&lt;/del&gt;&lt;/a&gt;. Before it just simply skipped these bytes thinking that they are just garbage on the split beginning. Now when we expect a &lt;a href=&quot;https://github.com/apache/pig/blob/trunk/src/org/apache/pig/impl/io/InterRecordReader.java#L153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;proper tuple with a tuple type byte&lt;/a&gt; we see these nulls and throw an Exception.&lt;/p&gt;


&lt;p&gt;As I can see it this is happening because JoinGroupSparkConverter has to return something even when it shouldn&apos;t.&lt;br/&gt;
When the POPackage operator returns a &lt;a href=&quot;https://github.com/apache/pig/blob/trunk/src/org/apache/pig/backend/hadoop/executionengine/spark/converter/JoinGroupSparkConverter.java#L211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;POStatus.STATUS_NULL&lt;/a&gt;, the converter shouldn&apos;t return a thing, but it can&apos;t do better than returning a null. This then gets written out by Spark..&lt;/p&gt;</description>
                <environment></environment>
        <key id="13091166">PIG-5277</key>
            <summary>Spark mode is writing nulls among tuples to the output </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="3" iconUrl="https://issues.apache.org/jira/images/icons/statuses/inprogress.png" description="This issue is being actively worked on at the moment by the assignee.">In Progress</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="szita">&#193;d&#225;m Szita</assignee>
                                    <reporter username="szita">&#193;d&#225;m Szita</reporter>
                        <labels>
                    </labels>
                <created>Mon, 31 Jul 2017 11:28:51 +0000</created>
                <updated>Sun, 13 Aug 2017 16:20:19 +0000</updated>
                                                                            <component>spark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16107272" author="szita" created="Mon, 31 Jul 2017 12:48:09 +0000"  >&lt;p&gt;So far we have mentioned 3 proposals of solutions:&lt;br/&gt;
1, Alter InterRecordReader so that it skips the nulls produced by Spark (like before..)&lt;br/&gt;
2, JoinGroupSpark#GroupPkgFunction returns a special type of Tuple (NonWritableTuple) instead of null which we catch on the writing side and skip it from getting pushed to the output.&lt;br/&gt;
3, Skip as MR does and continue with next Tuple.&lt;br/&gt;
4, Apply rdd().filter() in the converter and skip the nulls coming from GroupPkgFunction. (this actually would implement proposal#3)&lt;/p&gt;

&lt;p&gt;The problems with these are:&lt;br/&gt;
1, it&apos;s not fixing the original problem&lt;br/&gt;
2, hacky&lt;br/&gt;
3, I don&apos;t see how this would be achievable as the &quot;skipping&quot; part would have to be in Spark code&lt;br/&gt;
4, Using a Filter is a problem because it results in other tests failing like: TestPruneColumn#testCoGroup1 reason:&lt;br/&gt;
A filter on an RDD is using filter iterator in Scala on which if we call hasNext() it has to evaluate next() on the wrapped iterator so that it can test the predicate. Because of this... inside OutputConsumerIterator the behaviour changes so that GroupPkgFunction is not called as a result of input.next() but rather due to calls of &lt;a href=&quot;https://github.com/apache/pig/blob/trunk/src/org/apache/pig/backend/hadoop/executionengine/spark/converter/OutputConsumerIterator.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;input.hasNext(). This is unfortunately called one more time before evaluating getNextResult().&lt;/a&gt;&lt;br/&gt;
This all results that some input tuples are getting shifted and a wrong result may be produced when for example we use Accumulative UDFs.&lt;/p&gt;

&lt;p&gt;All-in-all proposal#4 was most promising but I can&apos;t see a way to work around it properly. Any ideas?&lt;/p&gt;</comment>
                            <comment id="16112199" author="rohini" created="Thu, 3 Aug 2017 05:12:33 +0000"  >&lt;p&gt;Not a Spark expert. So do not have any suggestions. &lt;/p&gt;

&lt;p&gt;If 3 or 4 is not possible, I would rather prefer approach 2. It is better to avoid writing garbage into file than try and skip while reading.&lt;/p&gt;</comment>
                            <comment id="16113820" author="kellyzly" created="Fri, 4 Aug 2017 02:23:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szita&quot; class=&quot;user-hover&quot; rel=&quot;szita&quot;&gt;szita&lt;/a&gt;: give me some time to investigate #4. If also can not solve the problem you mention in #4 in the end of next Friday(2017-08-11), directly use #2 to solve the unit test failures.&lt;/p&gt;</comment>
                            <comment id="16123129" author="kellyzly" created="Fri, 11 Aug 2017 10:06:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szita&quot; class=&quot;user-hover&quot; rel=&quot;szita&quot;&gt;szita&lt;/a&gt;: use #2.  leave it to further investigation. first let all unit tests pass in spark mode.&lt;/p&gt;</comment>
                            <comment id="16124976" author="szita" created="Sun, 13 Aug 2017 16:20:19 +0000"  >&lt;p&gt;Thanks all for taking a look. &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12878809/PIG-3655.sparkNulls.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;PIG-3655.sparkNulls.2.patch&lt;/a&gt; is now committed to trunk as a workaround so that we have a green build.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep this jira &quot;in progress&quot; to indicate that this is preferably not a final solution.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12687778">PIG-3655</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 14 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3i77z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>