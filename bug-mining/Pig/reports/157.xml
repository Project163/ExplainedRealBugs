<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:49:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-560] UTFDataFormatException (encoded string too long) is thrown when storing strings &gt; 65536 bytes (in UTF8 form) using BinStorage()</title>
                <link>https://issues.apache.org/jira/browse/PIG-560</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;BinStorage() uses DataOutput.writeUTF() and DataInput.readUTF() Java API to write out Strings as UTF-8 bytes and to read them back. From the Javadoc - &quot;First, the total number of bytes needed to represent all the characters of s is calculated. If this number is larger than 65535, then a UTFDataFormatException  is thrown. &quot; (because the writeUTF() API uses 2 bytes to represent the number of bytes). A way to get around this would be to not use writeUTF()/ReadUTF() and instead hand convert the string to the corresponding UTF-8 byte[]  (using String.getBytes(&quot;UTF-8&quot;) and then write the length of the byte array as an int - this will allow a size of upto 2^32 (2 raised to 32).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12410514">PIG-560</key>
            <summary>UTFDataFormatException (encoded string too long) is thrown when storing strings &gt; 65536 bytes (in UTF8 form) using BinStorage()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sms">Santhosh Muthur Srinivasan</assignee>
                                    <reporter username="pkamath">Pradeep Kamath</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Dec 2008 19:17:55 +0000</created>
                <updated>Wed, 24 Mar 2010 22:04:14 +0000</updated>
                            <resolved>Sat, 31 Jan 2009 04:39:42 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12667918" author="laukik" created="Wed, 28 Jan 2009 02:31:05 +0000"  >&lt;p&gt;The patch uses the String object&apos;s getBytes(charsetname) method to convert the string to UTF bytes, instead of the writeUTF() function. Now, an int can be used for storing the length instead of the 2 bytes used by the writeUTF(). Also includes the corresponding change while reading in a CHARARRAY.&lt;/p&gt;</comment>
                            <comment id="12668682" author="alangates" created="Fri, 30 Jan 2009 00:41:28 +0000"  >&lt;p&gt;I&apos;m concerned here that we&apos;re adding 2 bytes to every string we store for a case which should be quite rare (how often to people have strings longer than 64K?)  Would it be better to have bin storage define a long string type that uses 4 bytes to encode it&apos;s length, and then test a string&apos;s length before writing it out and leave things as they are now for most strings and use the new long string for anything over 64K?&lt;/p&gt;</comment>
                            <comment id="12668688" author="laukik" created="Fri, 30 Jan 2009 01:06:17 +0000"  >&lt;p&gt;The writeUTF() method was adding 2 bytes per string; we would actually be adding an int (32 bits) with this solution.&lt;/p&gt;

&lt;p&gt;The new long string would then be required to be a new DataType, right? To make it transparent to the user, this DataType can just be used internally. Also, to keep things efficient, may be we can insert the string as this datatype only on getting the encoded-string-too-long  UTFDataFormatException.&lt;/p&gt;

&lt;p&gt;By the way, though it looks quite probable that the average length of a string used would be far less than 64k, do we have any statistic on the average length of (UTF converted) CHARARRAYs? This would also help us in determining how big an overhead the additional 16 bits actually is. &lt;/p&gt;</comment>
                            <comment id="12668710" author="olgan" created="Fri, 30 Jan 2009 02:03:22 +0000"  >&lt;p&gt;We know that since we put this changes into the production, only one other person complained so we are pretty certain it is a very rare case. I agree with Alan that we should only pay the penalty on long strings&lt;/p&gt;</comment>
                            <comment id="12669056" author="sms" created="Fri, 30 Jan 2009 22:22:10 +0000"  >&lt;p&gt;Attached patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-560&quot; title=&quot;UTFDataFormatException (encoded string too long) is thrown when storing strings &amp;gt; 65536 bytes (in UTF8 form) using BinStorage()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-560&quot;&gt;&lt;del&gt;PIG-560&lt;/del&gt;&lt;/a&gt;.patch) addresses the issue of storing strings larger than 65535 bytes in length using BinStorage. A new BIGCHARRAY type has been added to PIG. This type is used internally for storing and loading Strings that are bigger than 64K bytes. A new unit test case that tests this code path has been added and an existing test case has been modified.&lt;/p&gt;</comment>
                            <comment id="12669059" author="sms" created="Fri, 30 Jan 2009 22:27:36 +0000"  >&lt;p&gt;Changing the patch by deleting a commented out line.&lt;/p&gt;</comment>
                            <comment id="12669060" author="olgan" created="Fri, 30 Jan 2009 22:33:26 +0000"  >&lt;p&gt;I think the unit test was added for BinaryStorage not BinStorage.&lt;/p&gt;</comment>
                            <comment id="12669091" author="sms" created="Sat, 31 Jan 2009 00:09:23 +0000"  >&lt;p&gt;New patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-560&quot; title=&quot;UTFDataFormatException (encoded string too long) is thrown when storing strings &amp;gt; 65536 bytes (in UTF8 form) using BinStorage()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-560&quot;&gt;&lt;del&gt;PIG-560&lt;/del&gt;&lt;/a&gt;.patch) adds the test case in TestEvalPipeline.java. Fixes a bug in the previous patch.&lt;/p&gt;</comment>
                            <comment id="12669093" author="sms" created="Sat, 31 Jan 2009 00:13:00 +0000"  >&lt;p&gt;Final patch!&lt;/p&gt;</comment>
                            <comment id="12669097" author="laukik" created="Sat, 31 Jan 2009 00:26:24 +0000"  >&lt;p&gt;In the current patch, when the length is &amp;lt;65536, the string to UTF8 conversion is happening twice &amp;#8211; once with String::getBytes() and once with DataOutput::writeUTF()&lt;/p&gt;

&lt;p&gt;To avoid that, instead of writeUTF(), how about using writeShort() followed by writeBytes() since we would already have the length and the UTF8 bytes? &lt;/p&gt;</comment>
                            <comment id="12669098" author="olgan" created="Sat, 31 Jan 2009 00:26:43 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12669107" author="sms" created="Sat, 31 Jan 2009 00:59:24 +0000"  >&lt;p&gt;Incorporated comments from Laukik. Submitting a new patch and modified test case. Running the tests now.&lt;/p&gt;</comment>
                            <comment id="12669108" author="sms" created="Sat, 31 Jan 2009 01:01:44 +0000"  >&lt;p&gt;Uploading the right patch.&lt;/p&gt;</comment>
                            <comment id="12669147" author="sms" created="Sat, 31 Jan 2009 04:39:42 +0000"  >&lt;p&gt;Patch has been committed. Thanks Laukik for the initial patch and the review comments.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12399185" name="PIG-560.patch" size="8107" author="sms" created="Sat, 31 Jan 2009 00:13:00 +0000"/>
                            <attachment id="12399192" name="PIG-560_1.patch" size="8539" author="sms" created="Sat, 31 Jan 2009 01:01:44 +0000"/>
                            <attachment id="12398874" name="utf-limit-patch.diff" size="1026" author="laukik" created="Wed, 28 Jan 2009 02:31:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164156</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 43 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0glpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94947</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>