<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:48:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-364] Limit return incorrect records when we use multiple reducer</title>
                <link>https://issues.apache.org/jira/browse/PIG-364</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently we put Limit(k) operator in the reducer plan. However, in the case of n reducer, we will get up to n*k output. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12401845">PIG-364</key>
            <summary>Limit return incorrect records when we use multiple reducer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Aug 2008 00:35:43 +0000</created>
                <updated>Wed, 24 Mar 2010 22:04:06 +0000</updated>
                            <resolved>Fri, 19 Sep 2008 19:10:03 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12620799" author="daijy" created="Fri, 8 Aug 2008 00:58:30 +0000"  >&lt;p&gt;Seems no perfect solution. Here are three possible treatments:&lt;br/&gt;
1. If there is a limit in reducer, and number of reducer &amp;gt; 1, add another map-reduce after that with only 1 reducer&lt;br/&gt;
    Cons: extra-overhead&lt;br/&gt;
2. Instead of map-reduce, manupilate output file directly, keep top k in output file&lt;br/&gt;
    Cons: not orthodox, extra-overhead (but not as much as 1)&lt;br/&gt;
3. If there is a limit in reducer, change the parallel degree of the reducer to 1&lt;br/&gt;
    Cons: can not take advantage of parallel processing for reducer&lt;/p&gt;</comment>
                            <comment id="12630095" author="daijy" created="Thu, 11 Sep 2008 05:31:34 +0000"  >&lt;p&gt;This patch takes approach 1. It will add one additional map-reduce operator with 1 reducer if the requested parallelism &amp;gt; 1. Now the behavior of limit is:&lt;/p&gt;

&lt;p&gt;1. If the map plan is closed before POLimit operator, we put POLimit in reduce plan, grant requested parallelism, if requested parallelism &amp;gt; 1, close reduce plan, add one additional map-reduce operator with 1 reducer&lt;/p&gt;

&lt;p&gt;2. If the map plan is open before POLimit operator, we put POLimit in map plan, close map plan, add another POLimit to reduce plan, and set parallelism of this map-reduce operator 1. Although in this case, POLimit create a map-reduce boundary, we do not associate a parallel option with limit keyword. I believe provide a parallel option with limit will arouse confusion to the user, because it is relatively hard to explain to the user whether this parallel option will be granted or not&lt;/p&gt;

&lt;p&gt;3. In limited sort case, we will have POSort with limit&amp;lt;&amp;gt;-1. If the parallelism for POSort &amp;gt; 1, we add one additional map-reduce operator with 1 reducer&lt;/p&gt;</comment>
                            <comment id="12630331" author="olgan" created="Thu, 11 Sep 2008 19:47:37 +0000"  >&lt;p&gt;Shravan, could you please review this patch, thanks&lt;/p&gt;</comment>
                            <comment id="12630673" author="shravanmn" created="Fri, 12 Sep 2008 20:29:35 +0000"  >&lt;p&gt;The patch seems to follow the approach mentioned, but I think there is a problem with this approach. I tested it both with and without the patch. The problem exists in both cases. Consider the following script:&lt;/p&gt;

&lt;p&gt;A = load &apos;st10M&apos;;&lt;br/&gt;
B = limit A 10;&lt;br/&gt;
C = filter B by 2&amp;gt;1 parallel 10;&lt;br/&gt;
dump C;&lt;/p&gt;

&lt;p&gt;I would expect to see only 10 tuples here. But I see 40 tuples here. The reason is that there were 4 mappers that produced 40 tuples in all and there were 10 reducers asked by filter since limit crosses map-reduce boundary. There was no limiting action done by the limit on the reduce side as there is capacity to pass 10*10=100 tuples.&lt;/p&gt;

&lt;p&gt;The problem is that we cannot guarantee the parallelism by setting the requested parallelism to some value while visiting limit as it can get modified further down the line which is shown in the example. The same case happens even in the limter in the reducer case for the following script where I see 97 tuples instead of the expected 10. If everything went right (that is no tuples are clipped) this should have been 100 and the actual output is pretty close:&lt;/p&gt;

&lt;p&gt;A = load &apos;st10M&apos;;&lt;br/&gt;
B1 = group A by $0 parallel 10;&lt;br/&gt;
B = limit B1 10;&lt;br/&gt;
C = filter B by 2&amp;gt;1 parallel 10;&lt;br/&gt;
dump C;&lt;/p&gt;

&lt;p&gt;One way I could think of is to terminate the new reduce phase created with a store therby ensuring that the parallelism is ensured to be that set during limit. Then start a new MapReduceOper by loading this file. Another way is to disable further changes to the reduce parallelism by maintaining a flag which controls the changes to the parallelism of the map reduce operator. But this would mean that we disobey the user&apos;s request, which might be meaningless at some places. Also, the semantics of parallel will be distorted when the limit is in picture.&lt;/p&gt;</comment>
                            <comment id="12630686" author="olgan" created="Fri, 12 Sep 2008 21:30:20 +0000"  >&lt;p&gt;Would the following work:&lt;/p&gt;

&lt;p&gt;If a limit is present, always add an MR state with single reducer unless the whole plan is already terminated by a single reducer?&lt;/p&gt;</comment>
                            <comment id="12630727" author="daijy" created="Sat, 13 Sep 2008 02:24:51 +0000"  >&lt;p&gt;I see the problem. The largest requestedParallelism determine the number of reducers. I thought it was determined by the operator creating the map-reduce boundary. Then I have to do this check after complete compiling a map-reduce operator, if it contains a limit and requestedParallelism&amp;gt;1, then add a singler reducer after that. Thank you for pointing out.&lt;/p&gt;</comment>
                            <comment id="12630848" author="daijy" created="Sun, 14 Sep 2008 04:37:42 +0000"  >&lt;p&gt;The new patch add a MRPlan visitor after compiling. For each MapReduceOper, if it contains limit and requestedParallelism&amp;gt;1, insert a MapReduceOper after it with 1 reducer.&lt;/p&gt;</comment>
                            <comment id="12631554" author="shravanmn" created="Tue, 16 Sep 2008 21:15:01 +0000"  >&lt;p&gt;I see a couple of problems with the patch.&lt;br/&gt;
1) When you insert the new limitAdjustMROp MapReduceOper into the plan, the case where multiple successors might exist is not handled. For instance if there is a split after the limit, then you will only insert the limitMROp for the first outgoing edge.&lt;/p&gt;

&lt;p&gt;2) This is more of a semantic issue. By following the approach in the patch the semantics of limit do not hold. Consider the following:&lt;br/&gt;
A = load &apos;URLs&apos; as (url:string, pagerank:double);&lt;br/&gt;
B = order A by pagerank parallel 100;&lt;br/&gt;
C = limit B 10;&lt;br/&gt;
D = foreach C generate url, CRAWL(url);&lt;br/&gt;
store D into &apos;crawledpages&apos;;&lt;/p&gt;

&lt;p&gt;Here I would expect to crawl only the top 10 pages. However, with the current patch, I would probably crawl 1000 pages and trim my result to 10. This might not be what users want.&lt;/p&gt;

&lt;p&gt;3) If at all we decide to go with this approach afterx fixing 1, it is probably a good idea to introduce a limit operator into the map of limitAdjustMROp.&lt;/p&gt;</comment>
                            <comment id="12631880" author="olgan" created="Wed, 17 Sep 2008 19:00:38 +0000"  >&lt;p&gt;Lets fix (1) and leave (2) alone for now&lt;/p&gt;</comment>
                            <comment id="12632095" author="olgan" created="Thu, 18 Sep 2008 05:27:44 +0000"  >&lt;p&gt;updated patch is needed&lt;/p&gt;</comment>
                            <comment id="12632121" author="daijy" created="Thu, 18 Sep 2008 07:12:25 +0000"  >&lt;p&gt;For Shravan&apos;s comments&lt;br/&gt;
1) Can you give a script? I tested several split after limit cases, didn&apos;t get this error. &lt;br/&gt;
2) As discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-171&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;PIG-171&lt;/a&gt;, since it seems to be no simple solution, so we just leave it as it is for now&lt;br/&gt;
3) No problem if this looks better&lt;/p&gt;

&lt;p&gt;Thank you&lt;/p&gt;</comment>
                            <comment id="12632365" author="shravanmn" created="Thu, 18 Sep 2008 20:10:29 +0000"  >&lt;p&gt;Consider the following script:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;a = load &apos;file:/etc/passwd&apos;;
b = limit a 10;
c = filter b by 2&amp;gt;1 parallel 10;
split c into c1 if 2&amp;gt;1, c2 if 2&amp;gt;1;
d = group c1 by $0;
e = group c2 by $0;
f = group d by $0, e by $0;
dump f;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is a case where, multiple MROps are generated at the split as shown in the figure below, if what I understand from the code is right.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12390412/limitsplit.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Now when the job controller sees this graph of MROps, it first schedules the LD MROp. To remind you, the limitadjuster has now changed the output of this to some temporary file. At this point, the controller has an option to schedule both the Lim Adj Op and the free 2-LRs Op whose dependency has been just resolved. If at all the choice is to execute the 2-LRs oP it tries to read the original output of the split which doesn&apos;t exist since the Lim Adj Op hasn&apos;t run yet and will fail. However if it decides to choose the Lim Adj Op, things will go fine.&lt;/p&gt;

&lt;p&gt;In order to avoid this, we need to make sure to disconnect all the successors and make the Lim Adj Op their predecessor and connect Lim Adj Op to LD as indicated in the figure.&lt;/p&gt;

&lt;p&gt;Let me know if I my understanding is wrong.&lt;/p&gt;</comment>
                            <comment id="12632531" author="daijy" created="Fri, 19 Sep 2008 06:03:29 +0000"  >&lt;p&gt;Hi, Shravan,&lt;br/&gt;
Thank you for your detailed explanation. Here is the modified patch addressing your comment 1 and 3. I tested using the following script:&lt;/p&gt;

&lt;p&gt;a = load &apos;studenttab10k&apos;;&lt;br/&gt;
b = group a by $0 parallel 10;&lt;br/&gt;
c = limit b 10;&lt;br/&gt;
split c into c1 if $0 lt &apos;bob white&apos;, c2 if $0 gte &apos;bob white&apos;;&lt;br/&gt;
c12 = group c1 by $0;&lt;br/&gt;
c22 = group c2 by $0;&lt;br/&gt;
c4 = union c12, c22;&lt;br/&gt;
dump c4;&lt;/p&gt;</comment>
                            <comment id="12632730" author="shravanmn" created="Fri, 19 Sep 2008 15:40:40 +0000"  >&lt;p&gt;Looks good to me. Thanks Daniel for incorporating all the comments!&lt;/p&gt;</comment>
                            <comment id="12632778" author="olgan" created="Fri, 19 Sep 2008 19:10:03 +0000"  >&lt;p&gt;patch committed. thanks, daniel and shravan!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12390073" name="PIG-364-2.patch" size="12471" author="daijy" created="Sun, 14 Sep 2008 04:37:41 +0000"/>
                            <attachment id="12390457" name="PIG-364-3.patch" size="13250" author="daijy" created="Fri, 19 Sep 2008 06:03:29 +0000"/>
                            <attachment id="12389903" name="PIG-364.patch" size="9540" author="daijy" created="Thu, 11 Sep 2008 05:31:34 +0000"/>
                            <attachment id="12390412" name="limitsplit.png" size="31902" author="shravanmn" created="Thu, 18 Sep 2008 20:06:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163998</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gjbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94562</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>