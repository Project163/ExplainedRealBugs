<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5041] RoundRobinPartitioner is not deterministic when order of input records change</title>
                <link>https://issues.apache.org/jira/browse/PIG-5041</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Maps can be rerun due to shuffle fetch failures. Half of the reducers can end up successfully pulling partitions from first run of the map while other half could pull from the rerun after shuffle fetch failures. If the data is not partitioned by the Partitioner exactly the same way every time then it could lead to incorrect results (loss of records and duplicated records). &lt;/p&gt;

&lt;p&gt;There is a good probability of order of input records changing&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;With OrderedGroupedMergedKVInput (shuffle input), they keys are sorted but values can be in any order as the shuffle and merge depends on the order in which inputs are fetched. Anything involving FLATTEN can produce different order of output records.&lt;/li&gt;
	&lt;li&gt;With UnorderedKVInput, the records could be in any order depending on order of shuffle fetch.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;RoundRobinPartitioner can partition records differently everytime as order of input records change which is very bad. We need to get rid of RoundRobinPartitioner. Since the key is empty whenever we use  RoundRobinPartitioner we need to partitioning based on hashcode of values to produce consistent partitioning.&lt;/p&gt;

&lt;p&gt;Partitioning based on hashcode is required for correctness, but disadvantage is that it&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;adds a lot of performance overhead with hashcode computation&lt;/li&gt;
	&lt;li&gt;with the random distribution due to hashcode (as opposed to batched round robin) input records sorted on some column could get distributed to different reducers and if union is followed by a store, the output can have bad compression.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13011732">PIG-5041</key>
            <summary>RoundRobinPartitioner is not deterministic when order of input records change</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Oct 2016 17:19:52 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:28 +0000</updated>
                            <resolved>Mon, 17 Oct 2016 17:08:25 +0000</resolved>
                                                    <fixVersion>0.17.0</fixVersion>
                    <fixVersion>0.16.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15569348" author="rohini" created="Wed, 12 Oct 2016 17:33:48 +0000"  >&lt;p&gt;Currently UnorderedPartitionedKVOutput+UnorderedKVInput+RoundRobinPartitioner only comes into play only when union optimizer is turned off or union optimizer could not be applied due to some condition.   We hit the issue with a script that had two levels of union followed by replicate join which does not have union optimization with vertex groups due to  &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3856&quot; title=&quot;UnionOptimizer in Tez should optimize the case of replicated join&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3856&quot;&gt;PIG-3856&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;a = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input&apos;&lt;/span&gt; as (x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, y:chararray);
&lt;/span&gt;b = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input&apos;&lt;/span&gt; as (y:chararray, x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
&lt;/span&gt;c = union onschema a, b;&quot; +
d = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input1&apos;&lt;/span&gt; as (x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, z:chararray);
&lt;/span&gt;e = join c by x, d by x using &lt;span class=&quot;code-quote&quot;&gt;&apos;replicated&apos;&lt;/span&gt;;
f = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input&apos;&lt;/span&gt; as (y:chararray, x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
&lt;/span&gt;g = union onschema e, f;&quot; +
h = join g by y, d by y using &lt;span class=&quot;code-quote&quot;&gt;&apos;replicated&apos;&lt;/span&gt;;
i = group h by x;
store i into &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/pigoutput&apos;&lt;/span&gt;;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Vertex processing c,e had unorderedinput and produced unorderedoutput with RoundRobinPartitioner. Rerun of one of the tasks in this vertex due to shuffle fetch failure caused incorrect results to be sent to vertex processing g,h. This is because first run processed in the order of a,b and second run processed in the order of b,a based on whichever shuffle file was fetched first. Map output of vertices processing a and b could also run into the non-deterministic partitioning issue if they had any operation that changed order of records but in this case since they read records from input file and output in same order without any intermediate processing those will not have issue on rerun even with RoundRobinPartitioner.  &lt;/p&gt;</comment>
                            <comment id="15573080" author="knoguchi" created="Thu, 13 Oct 2016 20:29:41 +0000"  >&lt;p&gt;Rohini, you seem to have one debug statement in the patch.&lt;/p&gt;

&lt;p&gt;As for using hashcode, I&apos;m not sure if it&apos;ll work for Tuple with a bag.&lt;br/&gt;
Looking at DefaultAbstractBag, I see that hashcode is taken without sorting.&lt;br/&gt;
If same logic of non-determistic order of bag applies here, I&apos;m afraid hashcode may differ by retries.&lt;/p&gt;

&lt;p&gt;Outside of this jira, I&apos;m worried with the implementation of DefaultAbstractBag where taking hashcode does NOT sort but compareTo() does.&lt;/p&gt;</comment>
                            <comment id="15573417" author="rohini" created="Thu, 13 Oct 2016 22:31:34 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt; for catching it. Have changed it to compute hashcode for each field of the tuple ignoring bags and only taking size into account for maps. Some implementation of bags iterate through whole bag to get size and so did not add the bag size in hashcode.&lt;/p&gt;</comment>
                            <comment id="15573661" author="daijy" created="Fri, 14 Oct 2016 00:31:29 +0000"  >&lt;p&gt;Bag can also be a key. This is a problem more than HashValuePartitioner. I think that only happens when client/server running different jvm. But if that happens, I believe there will be more headache than non-deterministic partitioner.&lt;/p&gt;</comment>
                            <comment id="15574013" author="rohini" created="Fri, 14 Oct 2016 03:17:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Bag can also be a key. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  In distinct? That definitely is a possibility and I think we will have to try fix for that case. I don&apos;t see folks using it as a key in group by, order by or join. Will open a separate jira for that as that will involve changing hashcode implementation for bags. That is not a concern for this issue or partitioner implementation as we don&apos;t care where each records go as long as they go to same partitioner every time. Skipping bags and maps in hashcode will also provide speedup. In case of distinct, the identical bags have to go to same reducer and so hashcode of the bags are important in that case.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think that only happens when client/server running different jvm&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;   Mapreduce/Tez shuffle has no guarantee on the order of the values in a Key,List&amp;lt;Values&amp;gt; input to the reducer. It all depends on which map&apos;s shuffle output is fetched first during merge process. So the values in the bag can be of any order and it does not depend on the jvm.&lt;/p&gt;</comment>
                            <comment id="15574140" author="daijy" created="Fri, 14 Oct 2016 04:22:36 +0000"  >&lt;p&gt;I don&apos;t mean the fetch, I mean the order of bag.iterator&lt;/p&gt;</comment>
                            <comment id="15574144" author="daijy" created="Fri, 14 Oct 2016 04:24:52 +0000"  >&lt;p&gt;Anyway, the bag as the key is a different issue. Need to address separately. Maybe we can write a hashcode which is order independent.&lt;/p&gt;

&lt;p&gt;I am fine with the HashValuePartitioner fix for this Jira. +1 for &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-5041&quot; title=&quot;RoundRobinPartitioner is not deterministic when order of input records change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-5041&quot;&gt;&lt;del&gt;PIG-5041&lt;/del&gt;&lt;/a&gt;-2.patch.&lt;/p&gt;</comment>
                            <comment id="15582800" author="rohini" created="Mon, 17 Oct 2016 17:08:26 +0000"  >&lt;p&gt;Committed to branch-0.16 and trunk. Thanks for the review Daniel.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12833167" name="PIG-5041-1.patch" size="8598" author="rohini" created="Thu, 13 Oct 2016 17:58:05 +0000"/>
                            <attachment id="12833226" name="PIG-5041-2.patch" size="9928" author="rohini" created="Thu, 13 Oct 2016 22:31:34 +0000"/>
                            <attachment id="12833789" name="PIG-5041-branch0.16.patch" size="10169" author="rohini" created="Mon, 17 Oct 2016 19:12:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 5 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34sgv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>