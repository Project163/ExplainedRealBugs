<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5083] CombinerPackager and LitePackager should not materialize bags</title>
                <link>https://issues.apache.org/jira/browse/PIG-5083</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Before &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3591&quot; title=&quot;Refactor POPackage to separate MR specific code from packaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3591&quot;&gt;&lt;del&gt;PIG-3591&lt;/del&gt;&lt;/a&gt; and creation of CombinerPackager, POCombinerPackage directly read from the combiner/reducer input instead of materializing the bag.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.12/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POCombinerPackage.java#L140-L161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.12/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POCombinerPackage.java#L140-L161&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The unnecessary materialization leads to lot of spills and OOMs in some cases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13032687">PIG-5083</key>
            <summary>CombinerPackager and LitePackager should not materialize bags</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Jan 2017 21:34:47 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:22 +0000</updated>
                            <resolved>Wed, 18 Jan 2017 13:38:21 +0000</resolved>
                                                    <fixVersion>0.17.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15805867" author="rohini" created="Fri, 6 Jan 2017 21:46:37 +0000"  >&lt;p&gt;Found that &lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.12/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POPackageLite.java#L170-L180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.12/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POPackageLite.java#L170-L180&lt;/a&gt; also was not materializing bags earlier.&lt;/p&gt;</comment>
                            <comment id="15805903" author="rohini" created="Fri, 6 Jan 2017 21:58:16 +0000"  >&lt;p&gt;While analyzing the heapdump during OOM for the Combiner, found that while deserializing next value in NullableTuple &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mValue = bis.readTuple(in);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the previous value of mValue was still a strong reference and could not be garbage collected. In case of DISTINCT inside nested foreach and map.exec.PartAgg=true that could be a really big bag taking up lot of memory and can lead to OOM while the next tuple is being deserialized in bis.readTuple. That is also fixed in this patch.&lt;/p&gt;

&lt;p&gt;Just noticed that it could be applied to LitePackager as well and added that to the patch. So rerunning the full unit and e2e tests now. &lt;/p&gt;</comment>
                            <comment id="15818933" author="rohini" created="Wed, 11 Jan 2017 17:39:18 +0000"  >&lt;p&gt;Unit and e2e tests are good.&lt;/p&gt;</comment>
                            <comment id="15822747" author="daijy" created="Sat, 14 Jan 2017 08:15:42 +0000"  >&lt;p&gt;I didn&apos;t get what you mean by not materializing the bag in &lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.12/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POCombinerPackage.java#L140-L161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.12/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/POCombinerPackage.java#L140-L161&lt;/a&gt;. InternalCachedBag is created and tuples are taken from iterator and added to the bag in that code. On the other hand, I can see LitePackager is not given a ReadOnceBag in Tez and you do fix it in the patch.&lt;/p&gt;</comment>
                            <comment id="15822909" author="rohini" created="Sat, 14 Jan 2017 18:43:43 +0000"  >&lt;p&gt;If you look at &lt;a href=&quot;https://github.com/apache/pig/blob/trunk/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/Packager.java#L113-L129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/trunk/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/relationalOperators/Packager.java#L113-L129&lt;/a&gt; , in case of mapreduce where readOnce is true records are read from the PeekedBag (extends ReadOnceBag)  and put in a InternalCachedBag before being handed off to the CombinerPackager.getNext() which then creates different bags for the rest of the plan to work with. Since the bag is only iterated once, there is no need to materialize it into a InternalCachedBag. Iteration can be done on the ReadOnceBag.&lt;/p&gt;

&lt;p&gt; What this patch does is pass the PeekedBag directly to the CombinerPackager in case of mapreduce and pass TezReadOnceBag with tez.  Tez was always constructing a InternalCachedBag before and did not have concept of ReadOnceBag (readOnce was always false). It saves one copy and a lot of memory+GC.&lt;/p&gt;</comment>
                            <comment id="15827657" author="daijy" created="Wed, 18 Jan 2017 08:53:28 +0000"  >&lt;p&gt;I see. CombinerPackager.attachInput prevent materializing bag on the combiner. TezReadOnceBag prevent materializing bag on the vertex input if the vertex has combine or order by. Seems streaming the last input in join case will use TezReadOnceBag as well in the follow up fix.&lt;/p&gt;

&lt;p&gt;+1 for commit.&lt;/p&gt;</comment>
                            <comment id="15828057" author="rohini" created="Wed, 18 Jan 2017 13:38:21 +0000"  >&lt;p&gt;Committed to trunk. Thanks for the review Daniel.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12681618">PIG-3591</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12846099" name="PIG-5083-1.patch" size="13575" author="rohini" created="Fri, 6 Jan 2017 21:58:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38dmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>