<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4976] streaming job with store clause stuck if the script fail</title>
                <link>https://issues.apache.org/jira/browse/PIG-4976</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When investigating &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4972&quot; title=&quot;StreamingIO_1 fail on perl 5.22&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4972&quot;&gt;&lt;del&gt;PIG-4972&lt;/del&gt;&lt;/a&gt;, I also notice Pig job stuck when the perl script have syntax error. This happens if we have output clause in stream specification (means use a file as staging). The bug exist in both Tez and MR, and it is not a regression.&lt;/p&gt;

&lt;p&gt;Here is an example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;define CMD `perl kk.pl` output(&lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;) ship(&lt;span class=&quot;code-quote&quot;&gt;&apos;kk.pl&apos;&lt;/span&gt;);

A = load &lt;span class=&quot;code-quote&quot;&gt;&apos;studenttab10k&apos;&lt;/span&gt; as (name, age, gpa);
B = foreach A generate name;
C = stream B through CMD;
store C into &lt;span class=&quot;code-quote&quot;&gt;&apos;ooo&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;kk.pl is any perl script contain a syntax error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13001859">PIG-4976</key>
            <summary>streaming job with store clause stuck if the script fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daijy">Daniel Dai</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Aug 2016 23:57:02 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:11 +0000</updated>
                            <resolved>Tue, 4 Oct 2016 17:54:56 +0000</resolved>
                                                    <fixVersion>0.17.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15454501" author="daijy" created="Thu, 1 Sep 2016 06:41:25 +0000"  >&lt;p&gt;The reason is, when the process exit, the input/output stream closed. Pig continue write to/flush the process input stream and raise exception. The exception is not handled properly so that the script process is killed, but Pig is still waiting for binaryInputQueue.&lt;/p&gt;

&lt;p&gt;If the streaming command does not have store clause, Pig will use ProcessOutputThread to handle the process output, which can detect process exit and send signal to Pig&apos;s data pipeline. If there is store clause, Pig will not use ProcessOutputThread.&lt;/p&gt;</comment>
                            <comment id="15475180" author="knoguchi" created="Thu, 8 Sep 2016 22:13:33 +0000"  >&lt;p&gt;I don&apos;t think it&apos;s safe to ignore IOException from inputHandler.close(). &lt;br/&gt;
I&apos;m afraid of the possibility of task finishing with partial input for some cases.&lt;/p&gt;</comment>
                            <comment id="15477192" author="knoguchi" created="Fri, 9 Sep 2016 14:33:58 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;ExecutableManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;324                         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
325                             t = (Tuple) inp.result;
326                             inputHandler.putNext(t);
327                         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
328                             &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; input type is synchronous then it could
&lt;/span&gt;329                             &lt;span class=&quot;code-comment&quot;&gt;// be related to the process terminating
&lt;/span&gt;330                             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(inputHandler.getInputType() == InputType.SYNCHRONOUS) {
331                                 LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to write to stream binary&apos;s input&quot;&lt;/span&gt;, e);
332                                 &lt;span class=&quot;code-comment&quot;&gt;// could be because the process
&lt;/span&gt;333                                 &lt;span class=&quot;code-comment&quot;&gt;// died OR closed the input stream
&lt;/span&gt;334                                 &lt;span class=&quot;code-comment&quot;&gt;// we will only call close() here and not
&lt;/span&gt;335                                 &lt;span class=&quot;code-comment&quot;&gt;// worry about deducing whether the process died
&lt;/span&gt;336                                 &lt;span class=&quot;code-comment&quot;&gt;// normally or abnormally - &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; there was any real
&lt;/span&gt;337                                 &lt;span class=&quot;code-comment&quot;&gt;// issue the ProcessOutputThread should see
&lt;/span&gt;338                                 &lt;span class=&quot;code-comment&quot;&gt;// a non zero exit code from the process and send
&lt;/span&gt;339                                 &lt;span class=&quot;code-comment&quot;&gt;// a POStatus.STATUS_ERR back - what &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we got
&lt;/span&gt;340                                 &lt;span class=&quot;code-comment&quot;&gt;// an IOException because there was only an issue with
&lt;/span&gt;341                                 &lt;span class=&quot;code-comment&quot;&gt;// writing to input of the binary - hmm..hope that means
&lt;/span&gt;342                                 &lt;span class=&quot;code-comment&quot;&gt;// the process died abnormally!!
&lt;/span&gt;343                                 close();
344                                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
345                             } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
346                                 &lt;span class=&quot;code-comment&quot;&gt;// asynchronous &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; - then &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a real exception
&lt;/span&gt;347                                 LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to write to stream binary&apos;s input&quot;&lt;/span&gt;, e);
348                                 &lt;span class=&quot;code-comment&quot;&gt;// send POStatus.STATUS_ERR to POStream to signal the error
&lt;/span&gt;349                                 &lt;span class=&quot;code-comment&quot;&gt;// Generally the ProcessOutputThread would &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; but now
&lt;/span&gt;350                                 &lt;span class=&quot;code-comment&quot;&gt;// we should &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; it here since neither the process nor the
&lt;/span&gt;351                                 &lt;span class=&quot;code-comment&quot;&gt;// ProcessOutputThread will ever be spawned
&lt;/span&gt;352                                 Result res = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Result(POStatus.STATUS_ERR,
353                                         &lt;span class=&quot;code-quote&quot;&gt;&quot;Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to write to stream binary&apos;s input&quot;&lt;/span&gt; + e.getMessage());
354                                 sendOutput(poStream.getBinaryOutputQueue(), res);
355                                 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
356                             }
357                         }
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can we wrap &quot;close()&quot; with try-block at line 343 and send &lt;tt&gt;sendOutput(poStream.getBinaryOutputQueue(), res);&lt;/tt&gt; when catching any Throwable?&lt;/p&gt;

&lt;p&gt;btw,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The bug exist in both Tez and MR, and it is not a regression.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This bug does exist on both Tez and MR, but I believe it only hangs longer than default 10 mins timeout on Tez. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeagles&quot; class=&quot;user-hover&quot; rel=&quot;jeagles&quot;&gt;jeagles&lt;/a&gt; taught me that this is because tez.task.progress.stuck.interval-ms is not being set in Pig and we need &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-3317&quot; title=&quot;Speculative execution starts too early due to 0 progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-3317&quot;&gt;&lt;del&gt;TEZ-3317&lt;/del&gt;&lt;/a&gt; fixed first for that.&lt;/p&gt;</comment>
                            <comment id="15492692" author="daijy" created="Thu, 15 Sep 2016 07:58:49 +0000"  >&lt;p&gt;Yes, that&apos;s doable. At least we can signal error to the pipeline.&lt;/p&gt;</comment>
                            <comment id="15494157" author="knoguchi" created="Thu, 15 Sep 2016 18:28:28 +0000"  >&lt;p&gt;Thanks Daniel, but test still hung.  &lt;/p&gt;

&lt;p&gt;Looking back, I see that I was wrong.&lt;br/&gt;
My test reliably fail immediately only when the input was huge, but for small input, it threw the exception inside &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;ExecutableManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;308                     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inp != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; inp.returnStatus == POStatus.STATUS_EOP) {
309                         &lt;span class=&quot;code-comment&quot;&gt;// signal cleanup in ExecutableManager
&lt;/span&gt;310                         close();  &lt;span class=&quot;code-comment&quot;&gt;//***
&lt;/span&gt;311                         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
312                     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and the test still hung.&lt;/p&gt;

&lt;p&gt;At this point, wondering if we can signal an error at the outside catch block irrespective of how the ProcessOutputThread may or may not handle the error... &lt;/p&gt;

&lt;p&gt;Would something like this work?  Attaching a slightly different version on where to call sendOutput. &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-3.patch&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15494941" author="daijy" created="Fri, 16 Sep 2016 00:21:58 +0000"  >&lt;p&gt;TestStreamingLocal pass for me with &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-2.patch. You are using another test case?&lt;/p&gt;</comment>
                            <comment id="15496132" author="nkollar" created="Fri, 16 Sep 2016 12:03:38 +0000"  >&lt;p&gt;When I applied &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-2.patch I had the same problem as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt;, the test case hung. I noticed, that the test passed when I apply first &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-1.patch then &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-3.patch. I also noticed that when I apply just the first patch, the test hung, but not because of syntax error in Perl script, but because of NullPointerException while trying to close the OutputHandler:&lt;br/&gt;
Exception in thread &quot;Thread-31&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.pig.impl.streaming.OutputHandler.close(OutputHandler.java:178)&lt;br/&gt;
	at org.apache.pig.impl.streaming.ExecutableManager.killProcess(ExecutableManager.java:188)&lt;br/&gt;
	at org.apache.pig.impl.streaming.ExecutableManager.access$200(ExecutableManager.java:52)&lt;br/&gt;
	at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:372)&lt;br/&gt;
2016-09-16 13:53:03,784 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-31&amp;#93;&lt;/span&gt; streaming.ExecutableManager (ExecutableManager.java:run(369)) - Error while reading from POStream and passing it to the streaming process&lt;br/&gt;
java.io.FileNotFoundException: foo (No such file or directory)&lt;/p&gt;

&lt;p&gt;It looks like &apos;foo&apos; should exist before executing the test? For me, it looks like we have two similar issues here (two test case): syntax error in script and writing to a file that doesn&apos;t exist.&lt;/p&gt;</comment>
                            <comment id="15504729" author="knoguchi" created="Mon, 19 Sep 2016 21:20:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;TestStreamingLocal pass for me with &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-2.patch. You are using another test case?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry for my late response.  I was using TestStreamingLocal.testNegativeScriptSyntaxError with &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-2.patch. &lt;br/&gt;
As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkollar&quot; class=&quot;user-hover&quot; rel=&quot;nkollar&quot;&gt;nkollar&lt;/a&gt; pointed out, maybe the difference is you had &quot;foo&quot; file present from previous testing. (Thanks Nandor!) &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It looks like &apos;foo&apos; should exist before executing the test?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s the opposite.  &apos;foo&apos; should &lt;em&gt;not&lt;/em&gt; exist since we&apos;re testing a streaming script that is supposed to write to &apos;foo&apos; but fails with syntax error.&lt;/p&gt;</comment>
                            <comment id="15506435" author="nkollar" created="Tue, 20 Sep 2016 12:58:31 +0000"  >&lt;p&gt;Ok, so in this case it seems that the file is not getting created in FileOutputHandler:&lt;br/&gt;
        File file = new File(this.fileName);&lt;br/&gt;
        BufferedPositionedInputStream fileInStream = &lt;br/&gt;
            new BufferedPositionedInputStream(new FileInputStream(file)); &lt;br/&gt;
This won&apos;t create the file, I added a test to show this problem, created a patch based on &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-3.patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-4.patch) with an additional test for this case and changes FileOutputHandler to create the output file. I&apos;m not sure what we should do if the output file exist, should we just append to it, or we should throw an exception instead?&lt;/p&gt;</comment>
                            <comment id="15507822" author="knoguchi" created="Tue, 20 Sep 2016 21:19:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Ok, so in this case it seems that the file is not getting created in FileOutputHandler:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;File not created is expected.  Streaming process failed so I&apos;d rather keep it that way instead of risking getting a false positive by having an empty output file.&lt;/p&gt;


&lt;p&gt;Trying to sort out the issue.  So far, I&apos;ve only tested on my macbook.  &lt;/p&gt;

&lt;p&gt;Code path for the error I saw were two types.&lt;br/&gt;
(1) With small input (including the test from Daniel&apos;s patch), &lt;br/&gt;
It fails in close() at  &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;308                     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inp != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; inp.returnStatus == POStatus.STATUS_EOP) {
309                         &lt;span class=&quot;code-comment&quot;&gt;// signal cleanup in ExecutableManager
&lt;/span&gt;310                         close();
311                         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
312                     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which then calls &lt;br/&gt;
-&amp;gt; ExecutableManager.close():&lt;tt&gt;114         inputHandler.close(process);&lt;/tt&gt; somehow pass then&lt;br/&gt;
-&amp;gt;ExecutableManager.close():&lt;tt&gt;160             outputHandler.bindTo(&quot;&quot;, null, 0, -1);&lt;/tt&gt; fails with &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-09-20 16:59:42,425 [Thread-30] ERROR org.apache.pig.impl.streaming.ExecutableManager - Error while reading from POStream and passing it to thes
java.io.FileNotFoundException: foo (No such file or directory)
        at java.io.FileInputStream.open0(Native Method)
        at java.io.FileInputStream.open(FileInputStream.java:195)
        at java.io.FileInputStream.&amp;lt;init&amp;gt;(FileInputStream.java:138)
        at org.apache.pig.impl.streaming.FileOutputHandler.bindTo(FileOutputHandler.java:57)
        at org.apache.pig.impl.streaming.ExecutableManager.close(ExecutableManager.java:160)
        at org.apache.pig.backend.hadoop.streaming.HadoopExecutableManager.close(HadoopExecutableManager.java:131)
        at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:310)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then outer catch block call killprocess and also fails with &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;Thread-30&quot; java.lang.NullPointerException
        at org.apache.pig.impl.streaming.OutputHandler.close(OutputHandler.java:178)
        at org.apache.pig.impl.streaming.ExecutableManager.killProcess(ExecutableManager.java:184)
        at org.apache.pig.impl.streaming.ExecutableManager.access$200(ExecutableManager.java:52)
        at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:368)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(2) When input is large, &lt;tt&gt;326                             inputHandler.putNext(t);&lt;/tt&gt; threw Exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
324                         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
325                             t = (Tuple) inp.result;
326                             inputHandler.putNext(t);
327                         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
328                             &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; input type is synchronous then it could
&lt;/span&gt;329                             &lt;span class=&quot;code-comment&quot;&gt;// be related to the process terminating
&lt;/span&gt;330                             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(inputHandler.getInputType() == InputType.SYNCHRONOUS) {
331                                 LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to write to stream binary&apos;s input&quot;&lt;/span&gt;, e);
...
343                                 close();
344                                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-09-20 17:07:12,362 [Thread-30] WARN  org.apache.pig.impl.streaming.ExecutableManager - Exception while trying to write to stream binary&apos;s input
java.io.IOException: Stream closed
        at java.lang.ProcessBuilder$NullOutputStream.write(ProcessBuilder.java:433)
        at java.io.OutputStream.write(OutputStream.java:116)
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
        at java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
        at java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)
        at java.io.DataOutputStream.write(DataOutputStream.java:107)
        at org.apache.pig.impl.streaming.InputHandler.putNext(InputHandler.java:72)
        at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:326)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;then &lt;tt&gt;343                                 close();&lt;/tt&gt; call inside the catch block failed at &lt;tt&gt;:{{114         inputHandler.close(process);&lt;/tt&gt;}} with &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-09-20 17:07:12,365 [Thread-30] ERROR org.apache.pig.impl.streaming.ExecutableManager - Error while reading from POStream and passing it to thes
java.io.IOException: Stream closed
        at java.lang.ProcessBuilder$NullOutputStream.write(ProcessBuilder.java:433)
        at java.io.OutputStream.write(OutputStream.java:116)
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
        at java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)
        at java.io.DataOutputStream.flush(DataOutputStream.java:123)
        at org.apache.pig.impl.streaming.InputHandler.close(InputHandler.java:93)
        at org.apache.pig.impl.streaming.DefaultInputHandler.close(DefaultInputHandler.java:50)
        at org.apache.pig.impl.streaming.ExecutableManager.close(ExecutableManager.java:114)
        at org.apache.pig.backend.hadoop.streaming.HadoopExecutableManager.close(HadoopExecutableManager.java:131)
        at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:343)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then you would also see killprocess fails with NullPointerException just like in (1). &lt;/p&gt;


&lt;p&gt;Daniel&apos;s &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-1.patch&lt;/tt&gt; and &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-2.patch&lt;/tt&gt; both handles issue (2) at different level.  I am not sure why the provided testcase is hitting (1) in my environment but (2) in Daniel&apos;s environment. &lt;/p&gt;</comment>
                            <comment id="15507896" author="knoguchi" created="Tue, 20 Sep 2016 21:48:54 +0000"  >&lt;p&gt;(I) My previous patch &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-3.patch&lt;/tt&gt; handled both cases by relying on the exceptions thrown inside the close().  However, as Nandor pointed out, exception from (1) &lt;br/&gt;
&quot;Error while reading from POStream and passing it to thes&lt;br/&gt;
java.io.FileNotFoundException: foo (No such file or directory)&quot;&lt;br/&gt;
was misleading in that it&apos;s checking the output file &quot;foo&quot; AFTER it saw exitcode of 255.  We probably shouldn&apos;t be checking the output file in the first place.&lt;/p&gt;

&lt;p&gt;Here, I&apos;ve added a line to signal error when exitcode != 0 inside close() and skipped the checking of output file.&lt;br/&gt;
I still need the outer catch block to signal error for the case in (2). &lt;/p&gt;

&lt;p&gt;(II) As for NullPointerException from killProcess, we probably should get rid of it. &lt;/p&gt;

&lt;p&gt;Added extra null check for OutputHandler.java and also made killprocess to ignore any Exceptions for inputhandler.close() and outputhandler.close(). &lt;/p&gt;

&lt;p&gt;(III) Modified the test case to handle small and big inputs.  In my environment, they went through the two different paths, (1) and (2). &lt;/p&gt;

&lt;p&gt;For (1), it&apos;ll show &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-09-20 17:45:38,630 WARN  [Thread-263] mapred.LocalJobRunner (LocalJobRunner.java:run(560)) - job_local2000154943_0012
java.lang.Exception: org.apache.pig.backend.executionengine.ExecException: ERROR 2055: Received Error while processing the map plan: &apos;perl script212
937190666196237pl (stdin-org.apache.pig.builtin.PigStreaming/foo-org.apache.pig.builtin.PigStreaming())&apos; failed with exit status: 255
    at org.apache.hadoop.mapred.LocalJobRunner$Job.runTasks(LocalJobRunner.java:462)
    at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:522)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;whereas for (2), it&apos;ll only show&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-09-20 17:45:39,304 WARN  [Thread-320] streaming.ExecutableManager (ExecutableManager.java:run(340)) - Exception while trying to write to stream
 binary&apos;s input
java.io.IOException: Stream closed
    at java.lang.ProcessBuilder$NullOutputStream.write(ProcessBuilder.java:433)
    at java.io.OutputStream.write(OutputStream.java:116)
    at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
    at java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)
    at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
    at java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)
    at java.io.DataOutputStream.write(DataOutputStream.java:107)
    at org.apache.pig.impl.streaming.InputHandler.putNext(InputHandler.java:72)
    at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:335)
2016-09-20 17:45:39,305 ERROR [Thread-320] streaming.ExecutableManager (ExecutableManager.java:run(369)) - Error while reading from POStream and pas
sing it to the streaming process:
java.io.IOException: Stream closed
    at java.lang.ProcessBuilder$NullOutputStream.write(ProcessBuilder.java:433)
    at java.io.OutputStream.write(OutputStream.java:116)
    at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
    at java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)
    at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)
    at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)
    at java.io.DataOutputStream.flush(DataOutputStream.java:123)
    at org.apache.pig.impl.streaming.InputHandler.close(InputHandler.java:93)
    at org.apache.pig.impl.streaming.DefaultInputHandler.close(DefaultInputHandler.java:50)
    at org.apache.pig.impl.streaming.ExecutableManager.close(ExecutableManager.java:114)
    at org.apache.pig.backend.hadoop.streaming.HadoopExecutableManager.close(HadoopExecutableManager.java:131)
    at org.apache.pig.impl.streaming.ExecutableManager$ProcessInputThread.run(ExecutableManager.java:352)
2016-09-20 17:45:39,306 INFO  [Thread-293] mapred.LocalJobRunner (LocalJobRunner.java:runTasks(456)) - map task executor complete.
2016-09-20 17:45:39,309 WARN  [Thread-293] mapred.LocalJobRunner (LocalJobRunner.java:run(560)) - job_local331634717_0013
java.lang.Exception: org.apache.pig.backend.executionengine.ExecException: ERROR 2055: Received Error while processing the map plan: Error while rea
ding from POStream and passing it to the streaming process:Stream closed
    at org.apache.hadoop.mapred.LocalJobRunner$Job.runTasks(LocalJobRunner.java:462)
    at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:522)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In both cases, stderr will show the syntax errors.   &lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Can&apos;t locate object method &quot;syntax&quot; via package &quot;error&quot; (perhaps you forgot to load &quot;error&quot;?) at script4635494469399418013pl line 2.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15509610" author="nkollar" created="Wed, 21 Sep 2016 11:20:11 +0000"  >&lt;p&gt;&quot;File not created is expected.&quot; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt;, does this mean, that the file should already exist? If I&apos;d like to use &apos;/tmp/foo&apos; as an output (define CMD `perl kk.pl` output(&apos;/tmp/foo&apos;) ship(&apos;kk.pl&apos;)), then I have to create the file before I execute the Pig script? Otherwise, it will fail I guess.&lt;/p&gt;</comment>
                            <comment id="15510109" author="knoguchi" created="Wed, 21 Sep 2016 14:29:05 +0000"  >&lt;p&gt;Nandor, granted I&apos;ve never used this feature myself, but from &lt;br/&gt;
&lt;a href=&quot;http://pig.apache.org/docs/r0.16.0/basic.html#define-udfs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pig.apache.org/docs/r0.16.0/basic.html#define-udfs&lt;/a&gt;&lt;br/&gt;
I&apos;m guessing &lt;tt&gt;define CMD `perl kk.pl` output(&apos;foo&apos;)&lt;/tt&gt; means the streaming command (here, it would be perl) would write all its output to file &apos;foo&apos;.  Then PigStreaming would &apos;deserialize&apos; them into Tuple form and pass them to next call.&lt;/p&gt;

&lt;p&gt;It is responsibility of the streaming process to create the file.  I don&apos;t want the framework creating an empty output file and risk getting false positives.  (From the current code, it should still fail but why risk it.)&lt;/p&gt;</comment>
                            <comment id="15513257" author="nkollar" created="Thu, 22 Sep 2016 13:07:37 +0000"  >&lt;p&gt;Ok, thanks for the explanation, I agree, no need to create a new file in Pig like I would have done in patch #3. The only think I&apos;m wondering if we need two separate test cases: one for non-existing file and one for existing file but syntactically incorrect script, or the one we have is enough. What do you think?&lt;/p&gt;</comment>
                            <comment id="15513835" author="knoguchi" created="Thu, 22 Sep 2016 17:09:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;if we need two separate test cases: one for non-existing file and one for existing file but syntactically incorrect script, or the one we have is enough&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;When the script has syntax error, there won&apos;t be file created so I don&apos;t see the need for &lt;br/&gt;
&quot;existing file but syntactically incorrect script&quot; case.&lt;/p&gt;

&lt;p&gt;Note that last patch updated the test case with two input sizes which did test both (1) and (2) that I mentioned above.  (at least on my mac)&lt;/p&gt;

&lt;p&gt;We can create a new jira and discuss the meaning of non-existent or empty output file.&lt;br/&gt;
I haven&apos;t looked if we already have test cases for this. &lt;br/&gt;
To me, process successful but no-output file should fail the task whereas process successful with empty output file should proceed with empty input.&lt;/p&gt;</comment>
                            <comment id="15525748" author="nkollar" created="Tue, 27 Sep 2016 10:46:00 +0000"  >&lt;p&gt;Ok, &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4976&quot; title=&quot;streaming job with store clause stuck if the script fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4976&quot;&gt;&lt;del&gt;PIG-4976&lt;/del&gt;&lt;/a&gt;-5-knoguchi.patch LGTM, no test is hanging in TestStreamingLocal on my mac.&lt;/p&gt;</comment>
                            <comment id="15543280" author="daijy" created="Mon, 3 Oct 2016 20:09:43 +0000"  >&lt;p&gt;I do have a &quot;foo&quot; file in my test directory, that&apos;s why I hit (2) not (1) in my test. Patch looks good to me, and test include both (1) and (2). +1.&lt;/p&gt;</comment>
                            <comment id="15546131" author="knoguchi" created="Tue, 4 Oct 2016 17:54:56 +0000"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;

&lt;p&gt;Leaving the assignment to Daniel since I didn&apos;t understand the issue until I saw Daniel&apos;s initial patch and explanation.&lt;/p&gt;

&lt;p&gt;Thanks Daniel!&lt;/p&gt;

&lt;p&gt;Also, thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkollar&quot; class=&quot;user-hover&quot; rel=&quot;nkollar&quot;&gt;nkollar&lt;/a&gt; for all your feedback!  &lt;br/&gt;
I understood the issue better by answering your questions.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12826564" name="PIG-4976-1.patch" size="3567" author="daijy" created="Thu, 1 Sep 2016 06:43:00 +0000"/>
                            <attachment id="12828599" name="PIG-4976-2.patch" size="4000" author="daijy" created="Thu, 15 Sep 2016 07:58:49 +0000"/>
                            <attachment id="12828698" name="PIG-4976-3.patch" size="4739" author="knoguchi" created="Thu, 15 Sep 2016 18:28:28 +0000"/>
                            <attachment id="12829383" name="PIG-4976-4.patch" size="7236" author="nkollar" created="Tue, 20 Sep 2016 12:59:46 +0000"/>
                            <attachment id="12829457" name="PIG-4976-5-knoguchi.patch" size="8192" author="knoguchi" created="Tue, 20 Sep 2016 21:48:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i333nj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>