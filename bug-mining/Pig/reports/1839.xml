<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:01:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4883] MapKeyType of splitter was set wrongly in specific multiquery case</title>
                <link>https://issues.apache.org/jira/browse/PIG-4883</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The following code and data will raise an exception.&lt;br/&gt;
However, if I remove any of the four &quot;store&quot;s, the code will be fine.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;test.pig&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;r = load &lt;span class=&quot;code-quote&quot;&gt;&apos;test.txt&apos;&lt;/span&gt; as (id: chararray, val: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;);

t1 = filter r by val &amp;gt;= 12 and val &amp;lt; 20;
grpd = group t1 by val;
t1_cnt = foreach grpd generate group as name, COUNT(t1) as value;
t1_cnt = foreach t1_cnt generate (chararray)name, value;
grpd = group t1 all;
t1_cnt_total = foreach grpd generate &lt;span class=&quot;code-quote&quot;&gt;&apos;t1&apos;&lt;/span&gt; as name, COUNT(t1) as value; 

t2 = filter r by val &amp;gt;= 20 and val &amp;lt; 30;
grpd = group t2 by val;
t2_cnt = foreach grpd generate group as name, COUNT(t2) as value;
--t2_cnt = foreach t2_cnt generate (chararray)name, value;
grpd = group t2 all;
t2_cnt_total = foreach grpd generate &lt;span class=&quot;code-quote&quot;&gt;&apos;t2&apos;&lt;/span&gt; as name, COUNT(t2) as value;

store t1_cnt  into &lt;span class=&quot;code-quote&quot;&gt;&apos;outx/3&apos;&lt;/span&gt;;
store t2_cnt  into &lt;span class=&quot;code-quote&quot;&gt;&apos;outx/4&apos;&lt;/span&gt;;
store t1_cnt_total into &lt;span class=&quot;code-quote&quot;&gt;&apos;outx/5&apos;&lt;/span&gt;;
store t2_cnt_total into &lt;span class=&quot;code-quote&quot;&gt;&apos;outx/6&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;test.txt&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;c	12
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;will cause error:&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.pig.data.BinSedesTuple cannot be cast to java.lang.Long&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POCast.getNextString(POCast.java:1167)&lt;br/&gt;
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.getNext(PhysicalOperator.java:343)&lt;br/&gt;
        ... 14 more&lt;/p&gt;


&lt;p&gt;I don&apos;t know why the code need to cast a BinSedesTuple to Long.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12963590">PIG-4883</key>
            <summary>MapKeyType of splitter was set wrongly in specific multiquery case</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kellyzly">liyunzhang</assignee>
                                    <reporter username="licstar">swlai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Apr 2016 18:41:28 +0000</created>
                <updated>Fri, 13 May 2016 17:42:16 +0000</updated>
                            <resolved>Fri, 13 May 2016 17:42:15 +0000</resolved>
                                    <version>0.15.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15277804" author="kellyzly" created="Tue, 10 May 2016 08:37:02 +0000"  >&lt;p&gt;   the problem in the above case is because if the map key type of all splittees are not same, we just use Tuple to set the map key type of splitter.&lt;br/&gt;
   But it will meet problem in following case:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                      A        B                 C        D
                       \      /                   \     /
                     Splitter(E)                 Splitter(F)
                            \                       /
                                 Slitter(G)
                 If the mapKeyType of A and B are not same, mapKeyType of E will be Tuple
                 If the mapKeyType of C and D are not same, mapKeyType of F will be Tuple
                 we will consider G hasSameMapKeyType but actually not.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In above case, the value of splitter&apos;s hasSameMapKeyType is true. It causes the key is not unwrapped in MultiQueryPackager#getNext&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Result getNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ExecException {
        ....
        &lt;span class=&quot;code-comment&quot;&gt;// check to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we need to unwrap the key. The keys may be
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// wrapped inside a tuple by LocalRearrange &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; when jobs
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// with different map key types are merged
&lt;/span&gt;        PigNullableWritable curKey = keyWritable;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!sameMapKeyType &amp;amp;&amp;amp; !inCombiner &amp;amp;&amp;amp; isKeyWrapped.get(index)) {
            Tuple tup = (Tuple) keyWritable.getValueAsPigType();
            curKey = HDataType.getWritableComparableTypes(tup.get(0),
                    pkgr.getKeyType());
            curKey.setIndex(origIndex);
        }
.....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;: can you help review this patch?            &lt;/p&gt;</comment>
                            <comment id="15277808" author="kellyzly" created="Tue, 10 May 2016 08:42:26 +0000"  >&lt;p&gt;in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4883&quot; title=&quot;MapKeyType of splitter was set wrongly in specific multiquery case&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4883&quot;&gt;&lt;del&gt;PIG-4883&lt;/del&gt;&lt;/a&gt;.patch:&lt;br/&gt;
1. add an attribute &quot;mapKeyTypeForSplitter&quot; for MapReduceOperator to record the map key type of all splittees if have.&lt;br/&gt;
2.modify MultiQueryOptimizer#hasSameMapKeyType. If the splittees of the splitter are splitter before(like the case i mention in the patch), we just compare the mapKeyTypeForSplitter of all the splittees. If all the elements in the mapKeyTypeForSplitter  are same, then return true for function &quot;hasSameMapKeyType&quot;.&lt;/p&gt;</comment>
                            <comment id="15280986" author="rohini" created="Wed, 11 May 2016 23:28:29 +0000"  >&lt;p&gt;Can&apos;t we just do something like below to check if key type of splitter and splittee are same?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasSameMapKeyType(MapReduceOper splitter, List&amp;lt;MapReduceOper&amp;gt; splittees) {
        Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;&amp;gt; keyTypes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MapReduceOper splittee : splittees) {
            keyTypes.add(splittee.mapKeyType);
        }
         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; sameKeyType = keyTypes.size() == 1;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sameKeyType &amp;amp;&amp;amp; splitter.mapKeyType != DataType.UNKNOWN) {
            sameKeyType = splitter.mapKeyType == keyTypes.iterator().next().byteValue();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; sameKeyType;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15281096" author="kellyzly" created="Thu, 12 May 2016 01:43:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;: The problem is because  for multiquery case,  we will set the mapKeyType of splitter as DataType.Tuple(&lt;a href=&quot;https://github.com/apache/pig/blob/27b153dbd688d8328e00d2d4bead84f3c879b2ae/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/MultiQueryOptimizer.java#L1035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;detailed code&lt;/a&gt;) if the mapKeyType of splittees are not same. &lt;/p&gt;

&lt;p&gt;so I think your code can not resolve current problem.   Make an example to explain it:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                      A(int)        B(long)              C(int)              D(long)
                            \      /                                  \            /
                           Splitter(E)                           Splitter(F)
                                      \                                   /
                                                    Splitter(G)
                 the mapKeyType of A and B are not same, mapKeyType of E will be Tuple
                 the mapKeyType of C and D are not same, mapKeyType of F will be Tuple
                 the mapKeyType of E and F are both DataType.Tuple and are same.  Function &quot;hasSameMapKeyType&quot; returns true. 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In above case, we can not judge whether the mapKeyType of E and F are same if we don&apos;t save the mapType of splittees for splitter.  In &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4883&quot; title=&quot;MapKeyType of splitter was set wrongly in specific multiquery case&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4883&quot;&gt;&lt;del&gt;PIG-4883&lt;/del&gt;&lt;/a&gt;.patch: we create an attribute &quot;mapKeyTypeForSplitter&quot; in MapReduceOper to save the mapKeyType of all splittees:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                      A(int)        B(long)                     C(int)           D(long)
                            \      /                                           \     /
                           Splitter(E)                                  Splitter(F)
                                      \                                        /
                                                    Splitter(G)
                 the mapKeyType of A and B are not same,mapKeyTypeForSplitter of E will be [int,long]
                 the mapKeyType of C and D are not same, mapKeyTypeForSplitter of F will be [int,long]
                 if all the elements in E.mapKeyTypeForSplitter and F.mapKeyTypeForSplitter are same, function &quot;hasSameMapKeyType&quot; return true.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="15281936" author="rohini" created="Thu, 12 May 2016 19:22:57 +0000"  >&lt;p&gt;Got it. Thanks for the explanation. Few comments on the patch&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Please add a test case for this to TestMultiQuery&lt;/li&gt;
	&lt;li&gt;Rename mapKeyTypeForSplitter to mapKeyTypeOfSplittees&lt;/li&gt;
	&lt;li&gt;Main logic can be simplified to few lines.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasSameMapKeyType(List&amp;lt;MapReduceOper&amp;gt; splittees) {
        Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;&amp;gt; keyTypes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MapReduceOper splittee : splittees) {
            keyTypes.add(splittee.mapKeyType);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (splittee.mapKeyTypeOfSplittees != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; mapKeyTypeOfSplittees.length; i++) {
                keyTypes.add(mapKeyTypeOfSplittees[i]);
            }
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; keyTypes.size() == 1;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15282418" author="kellyzly" created="Fri, 13 May 2016 05:35:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;:Thanks for your review. Have submitted &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4883&quot; title=&quot;MapKeyType of splitter was set wrongly in specific multiquery case&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4883&quot;&gt;&lt;del&gt;PIG-4883&lt;/del&gt;&lt;/a&gt;_1.patch for your review.&lt;/p&gt;</comment>
                            <comment id="15282909" author="rohini" created="Fri, 13 May 2016 17:42:15 +0000"  >&lt;p&gt;+1. Committed to trunk. Thank Liyun for the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12803193" name="PIG-4883.patch" size="4730" author="kellyzly" created="Tue, 10 May 2016 08:42:26 +0000"/>
                            <attachment id="12803802" name="PIG-4883_1.patch" size="6499" author="kellyzly" created="Fri, 13 May 2016 05:35:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wx4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>