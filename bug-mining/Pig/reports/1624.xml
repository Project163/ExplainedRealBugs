<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:00:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4265] SUM functions returns different value in spark and mapreduce engine</title>
                <link>https://issues.apache.org/jira/browse/PIG-4265</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;$PIG_HOME/bin/pig -x local RubyUDFs_10.pig&lt;br/&gt;
#RubyUDFs_10.pig&lt;/p&gt;

&lt;p&gt;a = load &apos;studenttab10k&apos; using PigStorage() as (name, age:int, gpa:double);&lt;br/&gt;
b = group a by name;&lt;br/&gt;
c = foreach b generate group, SUM(a.age), SUM(a.gpa);&lt;br/&gt;
d = foreach c generate $0, $1, (double)((int)$2*100)/100;&lt;br/&gt;
store d into &apos;local.output/RubyUDFs_10_benchmark.out&apos;;&lt;/p&gt;

&lt;p&gt;the result in RubyUDFs_10.out/part&lt;br/&gt;
#grep &quot;david s&quot; RubyUDFs_10.out/part-r-00000 &lt;br/&gt;
david steinbeck	266	15.0&lt;/p&gt;

&lt;p&gt;#grep &quot;david s&quot; studenttab10k&lt;br/&gt;
david steinbeck	21	2.44&lt;br/&gt;
david steinbeck	33	1.17&lt;br/&gt;
david steinbeck	42	1.94&lt;br/&gt;
david steinbeck	42	1.35&lt;br/&gt;
david steinbeck	31	2.77&lt;br/&gt;
david steinbeck	40	2.42&lt;br/&gt;
david steinbeck	57	3.91&lt;/p&gt;


&lt;p&gt;when runing Ruby_UDFs.pig in spark, the sum(a.gpa) is 16.0 and (double)((int)$2*100)/100 will be &quot;david steinbeck	266	16.0&quot;.&lt;br/&gt;
when running Ruby_UDFs.pig in mapreduce mode, the sum(a.gpa) is 15.999999999999998 and (double)((int)$2*100)/100 will be &quot;david steinbeck	266	15.0&quot;.&lt;/p&gt;

&lt;p&gt;I don&apos;t know why the same code by different execution engines(spark and mapreduce) on the same os returns different results. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12752614">PIG-4265</key>
            <summary>SUM functions returns different value in spark and mapreduce engine</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kellyzly">liyunzhang</assignee>
                                    <reporter username="kellyzly">liyunzhang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Nov 2014 02:32:19 +0000</created>
                <updated>Sun, 7 Jun 2015 03:48:07 +0000</updated>
                            <resolved>Thu, 6 Nov 2014 16:10:34 +0000</resolved>
                                                    <fixVersion>0.15.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14195601" author="kellyzly" created="Tue, 4 Nov 2014 02:36:49 +0000"  >&lt;p&gt;The modification of this patch is:  Use BigDecimal to solve the problem&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;AlgebraicDoubleMathBase.java
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; doWork(&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; arg1, &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; arg2, KNOWN_OP op) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (arg1 == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; arg2;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (arg2 == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; arg1;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (op) {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; MAX: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(arg1, arg2);
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; MIN: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(arg1, arg2);
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; SUM: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;  BigDecimal.valueOf(arg1).add(BigDecimal.valueOf(arg2)).doubleValue();
            &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14196177" author="xuefuz" created="Tue, 4 Nov 2014 14:54:26 +0000"  >&lt;p&gt;I&apos;m not sure if this is a problem of the algebra. It&apos;s expected that a double value 16 is represented by a system as 15.99999999999 or 16.000000001. The problem seems to be the casting of the double value to int. Am I missing anything? If greater precision is needed, then decimal type is the alternative.&lt;/p&gt;</comment>
                            <comment id="14197754" author="kellyzly" created="Wed, 5 Nov 2014 07:24:04 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;&apos;s comment. I made some mistakes in previous bug description. After further investigation, i found the problem is not on &quot;Java double precision problems&quot; of AlgebraicDoubleMathBase.java&lt;br/&gt;
but on other issues maybe.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Ruby_UDFs.pig
a = load &lt;span class=&quot;code-quote&quot;&gt;&apos;studenttab10k&apos;&lt;/span&gt; using PigStorage() as (name, age:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, gpa:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;);
b = group a by name;
c = foreach b generate group, SUM(a.age), SUM(a.gpa);
d = foreach c generate $0, $1, (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)$2*100)/100;
store d into &lt;span class=&quot;code-quote&quot;&gt;&apos;RubyUDFs_10_benchmark.out&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;run Ruby_UDFs.pig in spark, the sum(a.gpa) is 16.0  and (double)((int)$2*100)/100  will be  &quot;david steinbeck	266	16.0&quot;.&lt;br/&gt;
run Ruby_UDFs.pig in mapreduce mode, the sum(a.gpa) is 15.999999999999998 and (double)((int)$2*100)/100 will  be &quot;david steinbeck	266	15.0&quot;.&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt; said &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; It&apos;s expected that a double value 16 is represented by a system as 15.99999999999 or 16.000000001. The problem seems to be the casting of the double value to int&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t know why the same code by different execution engines(spark and mapreduce) on the same os returns different results.  I will investigate more.&lt;br/&gt;
I will rename the bug title to SUM functions returns different value in spark and mapreduce engine.&lt;/p&gt;</comment>
                            <comment id="14198461" author="xuefuz" created="Wed, 5 Nov 2014 14:53:58 +0000"  >&lt;p&gt;The difference could be caused by different compilers, scala vs java. Here is a link to demo complier effect in dealing with double precision: &lt;a href=&quot;http://stackoverflow.com/questions/18840730/different-behaviours-for-double-precision-on-different-compiler&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/18840730/different-behaviours-for-double-precision-on-different-compiler&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Regardless, the value given by different compilers should be close. However, the problem here is that the casting happens before multiplication and division. The result might be different if you put casting last.&lt;/p&gt;

&lt;p&gt;Also, double value comparison is usually meaningless unless an error threshold is given. Thus, 15.9999999999998 and 16.0000000001 are equal if we compare them in double precision terms.&lt;/p&gt;</comment>
                            <comment id="14199664" author="kellyzly" created="Thu, 6 Nov 2014 02:33:54 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;&apos;s comment.&lt;br/&gt;
I agreed that 15.9999999999998 and 16.0000000001 are equal if we compare them in double precision terms.&lt;br/&gt;
The problem is on the casting:&lt;br/&gt;
when $2=15.9999999999998&lt;br/&gt;
(double)((int)$2*100)/100 = (double)((int)15.9999999999998*100)/100 = (double)(15*100)/100 = 1500.0/100=15.0&lt;/p&gt;

&lt;p&gt;when $2=16.0000000001&lt;br/&gt;
(double)((int)$2*100)/100 = (double)((int)16.0000000001*100)/100 = (double)(16*100)/100 = 1600.0/100 = 16.0&lt;/p&gt;

&lt;p&gt;so if casting method changes like following, i think double precision problem can be avoid:&lt;br/&gt;
(double)(ROUND($2*100))/100 &lt;br/&gt;
when $2 = 15.9999999999998&lt;br/&gt;
(double)(ROUND($2*100))/100 = (double)(ROUND(1599.99999999998))/100 = (double)(1600)/100 = 16.0&lt;br/&gt;
when $2 = 16.0000000001&lt;br/&gt;
(double)(ROUND($2*100))/100 = (double)(ROUND(1600.00000001))/100 = (double)(1600)/100 = 16.0&lt;/p&gt;

&lt;p&gt;The RubyUDFs_10.pig is generated by test/e2e/pig/tests/nightly.conf  Line 3776~3793&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;3776                   {
3777                     # test accumulator functions
3778                     &lt;span class=&quot;code-quote&quot;&gt;&apos;num&apos;&lt;/span&gt; =&amp;gt; 10,
3779                     &lt;span class=&quot;code-quote&quot;&gt;&apos;java_params&apos;&lt;/span&gt; =&amp;gt; [&lt;span class=&quot;code-quote&quot;&gt;&apos;-Dpig.accumulative.batchsize=5&apos;&lt;/span&gt;],
3780                     &lt;span class=&quot;code-quote&quot;&gt;&apos;pig&apos;&lt;/span&gt; =&amp;gt; q\
3781 register &lt;span class=&quot;code-quote&quot;&gt;&apos;:SCRIPTHOMEPATH:/ruby/scriptingudfs.rb&apos;&lt;/span&gt; using jruby as myfuncs;
3782 a = load &lt;span class=&quot;code-quote&quot;&gt;&apos;:INPATH:/singlefile/studenttab10k&apos;&lt;/span&gt; using PigStorage() as (name, age:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, gpa:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;);
3783 b = group a by name;
3784 c = foreach b generate group, myfuncs.Sum(a.age), myfuncs.Sum(a.gpa);
3785 d = foreach c generate $0, $1, (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)$2*100)/100;
3786 store d into &lt;span class=&quot;code-quote&quot;&gt;&apos;:OUTPATH:&apos;&lt;/span&gt;;\,
3787                                     &lt;span class=&quot;code-quote&quot;&gt;&apos;verify_pig_script&apos;&lt;/span&gt; =&amp;gt; q\
3788 a = load &lt;span class=&quot;code-quote&quot;&gt;&apos;:INPATH:/singlefile/studenttab10k&apos;&lt;/span&gt; using PigStorage() as (name, age:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, gpa:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;);
3789 b = group a by name;
3790 c = foreach b generate group, SUM(a.age), SUM(a.gpa);
3791 d = foreach c generate $0, $1,  (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)$2*100)/100 ;
3792 store d into &lt;span class=&quot;code-quote&quot;&gt;&apos;:OUTPATH:&apos;&lt;/span&gt;;\,
3793                     },
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now RubyUDFs_10.pig of e2e tests in  mapreduce mode successes while  in spark mode fails. &lt;br/&gt;
I find that if we change from &quot;d = foreach c generate $0, $1,  (double)((int)$2*100)/100&quot;&lt;br/&gt;
to &quot;d = foreach c generate $0, $1, (double)(ROUND($2*100))/100&quot;,problem can be avoided(patch available), Can you help review?&lt;/p&gt;</comment>
                            <comment id="14199703" author="xuefuz" created="Thu, 6 Nov 2014 03:20:37 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14199714" author="kellyzly" created="Thu, 6 Nov 2014 03:33:18 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuefuz&quot; class=&quot;user-hover&quot; rel=&quot;xuefuz&quot;&gt;xuefuz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14200371" author="xuefuz" created="Thu, 6 Nov 2014 16:10:34 +0000"  >&lt;p&gt;Committed to trunk. Thanks to Liyun for the contribution.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12679765" name="PIG-4265.patch" size="1027" author="kellyzly" created="Thu, 6 Nov 2014 02:34:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21xbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>