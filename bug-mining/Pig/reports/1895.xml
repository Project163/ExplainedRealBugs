<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5048] HiveUDTF fail if it is the first expression in projection</title>
                <link>https://issues.apache.org/jira/browse/PIG-5048</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The following script fail:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;define explode HiveUDTF(&lt;span class=&quot;code-quote&quot;&gt;&apos;explode&apos;&lt;/span&gt;);
A = load &lt;span class=&quot;code-quote&quot;&gt;&apos;bag.txt&apos;&lt;/span&gt; as (a0:{(b0:chararray)});
B = foreach A generate explode(a0);
dump B;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Message: Unimplemented at org.apache.pig.data.UnlimitedNullTuple.size(UnlimitedNullTuple.java:31)&lt;/p&gt;

&lt;p&gt;If it is not the first projection, the script pass:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;define explode HiveUDTF(&lt;span class=&quot;code-quote&quot;&gt;&apos;explode&apos;&lt;/span&gt;);
A = load &lt;span class=&quot;code-quote&quot;&gt;&apos;bag.txt&apos;&lt;/span&gt; as (a0:{(b0:chararray)});
B = foreach A generate a0, explode(a0);
dump B;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkollar&quot; class=&quot;user-hover&quot; rel=&quot;nkollar&quot;&gt;nkollar&lt;/a&gt; reporting it!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13014401">PIG-5048</key>
            <summary>HiveUDTF fail if it is the first expression in projection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkollar">N&#225;ndor Koll&#225;r</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Oct 2016 20:29:48 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:15 +0000</updated>
                            <resolved>Wed, 9 Nov 2016 18:02:22 +0000</resolved>
                                                    <fixVersion>0.17.0</fixVersion>
                    <fixVersion>0.16.1</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15602951" author="nkollar" created="Mon, 24 Oct 2016 19:25:49 +0000"  >&lt;p&gt;It seems that with this trivial modification in UnlimitedNullTuple&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the UDAF gives the (almost) correct result, though I&apos;m afraid this is not the best solution. I say almost, because I also noticed, that there is an extra empty tuple at the end (no idea why), but this is present even when the projection includes both a0 and explode(a0). Also, it would be nice to implement the other methods in this class, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; if you don&apos;t mind, can attach a patch.&lt;/p&gt;</comment>
                            <comment id="15603262" author="daijy" created="Mon, 24 Oct 2016 21:22:55 +0000"  >&lt;p&gt;Yes, it&apos;s on my plate.&lt;/p&gt;</comment>
                            <comment id="15604499" author="nkollar" created="Tue, 25 Oct 2016 07:30:05 +0000"  >&lt;p&gt;I just realized that I wanted to say I can attach a patch, but missed &apos;I&apos;.&lt;/p&gt;</comment>
                            <comment id="15609943" author="daijy" created="Wed, 26 Oct 2016 22:54:14 +0000"  >&lt;p&gt;Thanks for the patch. Several comments:&lt;br/&gt;
1. I&apos;d like to return Integer.MAX_VALUE in size(), as the name UnlimitedNullTuple suggests&lt;br/&gt;
2. I&apos;d rather not change other method if not causing problem&lt;br/&gt;
3. Can you add test case?&lt;/p&gt;</comment>
                            <comment id="15612202" author="nkollar" created="Thu, 27 Oct 2016 15:26:14 +0000"  >&lt;p&gt;Do we need this UnlimitedNullTuple class at all? The only place where it is used is in POForEach:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inp.returnStatus == POStatus.STATUS_EOP) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (parentPlan!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; parentPlan.endOfAllInput &amp;amp;&amp;amp; !endOfAllInputProcessed &amp;amp;&amp;amp; endOfAllInputProcessing) {
                        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; pull one more output
&lt;/span&gt;                        inp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Result(POStatus.STATUS_OK, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnlimitedNullTuple());
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; inp;
                    }
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As far as I understood, this is used to allow UDF to produce a last record in close, does close here mean the cleanup phase of map tasks? What if we use RESULT_EMPTY from PhysicalOperator instead of UnlimitedNullTuple with OK status? The description of STATUS_NULL tells &apos;This is represented as &apos;null&apos; with STATUS_OK&apos;, and it seems this is what we need instead of UnlimitedNullTuple. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; could you please review my second patch, and help me understand why UnlimitedNullTuple was required? I&apos;d like to add a test case where the UDF produces a last record in close to ensure that my patch doesn&apos;t brake it, but I don&apos;t know when this happens.&lt;/p&gt;</comment>
                            <comment id="15616752" author="daijy" created="Fri, 28 Oct 2016 22:14:10 +0000"  >&lt;p&gt;The following script will not generate correct result:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;define COUNT2 HiveUDTF(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.contrib.udtf.example.GenericUDTFCount2&apos;&lt;/span&gt;);
a = load &lt;span class=&quot;code-quote&quot;&gt;&apos;studenttab10k&apos;&lt;/span&gt; as (name, age, gpa);
b = foreach a generate flatten(COUNT2(name));
dump b;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Expected:&lt;br/&gt;
(10000)&lt;br/&gt;
(10000)&lt;/p&gt;

&lt;p&gt;The UDTF invokes forward inside close, UnlimitedNullTuple plays the trick here.&lt;/p&gt;

&lt;p&gt;This is a regression of Pig 0.16 (broken by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4862&quot; title=&quot;POProject slow by creating StackTrace repeatedly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4862&quot;&gt;&lt;del&gt;PIG-4862&lt;/del&gt;&lt;/a&gt;). We need to fix it in 0.16.1 and add a test case for this type of UDTF.&lt;/p&gt;</comment>
                            <comment id="15623004" author="knoguchi" created="Mon, 31 Oct 2016 18:41:44 +0000"  >&lt;blockquote&gt;
&lt;p&gt;This is a regression of Pig 0.16 (broken by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4862&quot; title=&quot;POProject slow by creating StackTrace repeatedly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4862&quot;&gt;&lt;del&gt;PIG-4862&lt;/del&gt;&lt;/a&gt;). We need to fix it in 0.16.1 and add a test case for this type of UDTF.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ouch. I wasn&apos;t aware that I introduced a regression.  Sorry about that.&lt;/p&gt;</comment>
                            <comment id="15632699" author="nkollar" created="Thu, 3 Nov 2016 13:21:07 +0000"  >&lt;p&gt;Attached a new version of my patch, it includes these changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;test cases for Hive UDFs UDTFs and UDAFs&lt;/li&gt;
	&lt;li&gt;extracted the UnlimitedNullTuple to a constant in POForEach&lt;/li&gt;
	&lt;li&gt;added Hive contrib package to the dependencies to be able to use GenericUDTFCount2 in the tests&lt;/li&gt;
	&lt;li&gt;UnlimitedNullTuple&apos;s size method doesn&apos;t throw an exception, but returns Integer.MAX_VALUE&lt;/li&gt;
	&lt;li&gt;In HiveUDTF class, the collector is reused in close and in normal process case, thus if init doesn&apos;t create a new bag, but just clears the current, the close() will erase the result of normal process.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;One thing I still don&apos;t really like is that it seems that if close doesn&apos;t produce any new tuple(s) because close is not implemented at all in the UDF, an empty tuple is still appended to the end of the output. I don&apos;t know how to handle this case, since we don&apos;t know if Hive UDF actually did something in close, but the result was empty (in this case I think we have to append the empty result to the output), or close was not even implemented (here I think it doesn&apos;t make sense to append an empty tuple). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; what do you think? Could you please help with the review?&lt;/p&gt;</comment>
                            <comment id="15645888" author="daijy" created="Tue, 8 Nov 2016 00:08:35 +0000"  >&lt;p&gt;Thanks for the patch. A few comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The only test case missing is UDTF with forward inside close (GenericUDTFCount2), all other test cases are in e2e tests HiveUDF&lt;/li&gt;
	&lt;li&gt;hive-contrib can be a test dependency rather than a compile dependency&lt;/li&gt;
	&lt;li&gt;Didn&apos;t get your last change, collector need to be cleared for every record, no matter normal process or endOfAllInput processing, clear is in favor as newDefaultBag is more costly&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The empty tuple only append to the result if the UDF require endOfAllInput. Only HiveUDTF use this flag.&lt;/p&gt;</comment>
                            <comment id="15647088" author="nkollar" created="Tue, 8 Nov 2016 09:54:38 +0000"  >&lt;p&gt;Thanks Daniel for the comments. I added these tests to the Junit test suite, because it was easier to execute and verify, should I delete those which are already covered in e2e tests, or it is fine? I&apos;ll change hive-contrib to test dependency.&lt;br/&gt;
As for the collector, the UDTF exec was called twice: first from the normal process, then for close, and I noticed that in the test, the output for the process case was cleared in the close call. I just realized that this is probably a test issue with mock Storage I used in the tests, putNext doesn&apos;t make a deep copy from the tuples:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void putNext(Tuple t) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
      mockRecordWriter.dataBeingWritten.add(TF.newTuple(t.getAll()));
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since in tests the tuple contains a bag, both the output bag of process and close will point to the same bag instance. Will figure out how to test this properly.&lt;/p&gt;</comment>
                            <comment id="15647550" author="nkollar" created="Tue, 8 Nov 2016 13:22:12 +0000"  >&lt;p&gt;Attached patch version 3, decided not to use mock Store in the tests and changed hive-contrib to test dependency.&lt;/p&gt;</comment>
                            <comment id="15648772" author="daijy" created="Tue, 8 Nov 2016 20:59:09 +0000"  >&lt;p&gt;Looks good. But let&apos;s remove duplicate tests, we are in the mission to cut down the total test runtime.&lt;/p&gt;</comment>
                            <comment id="15650405" author="nkollar" created="Wed, 9 Nov 2016 09:09:43 +0000"  >&lt;p&gt;Ok, deleted the UDF and UDAF tests, since those are covered in the e2e test suite. I think all UDTF tests are needed, there is one for the simple bag projection (this was case where the issue was discovered), one for two projections, and one for the GenericUDTFCount2 to verify UDTF close() is not broken.&lt;/p&gt;</comment>
                            <comment id="15651600" author="daijy" created="Wed, 9 Nov 2016 18:02:22 +0000"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;Patch committed to both trunk and branch-0.16. Thanks Nandor!&lt;/p&gt;</comment>
                            <comment id="15651841" author="nkollar" created="Wed, 9 Nov 2016 19:36:22 +0000"  >&lt;p&gt;Thank you Daniel for the review and for helping me learn more about how HiveUDFs work!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12835614" name="PIG-5048-1.patch" size="12748" author="nkollar" created="Thu, 27 Oct 2016 15:53:13 +0000"/>
                            <attachment id="12836788" name="PIG-5048-2.patch" size="14365" author="nkollar" created="Thu, 3 Nov 2016 13:05:09 +0000"/>
                            <attachment id="12837974" name="PIG-5048-3.patch" size="13478" author="nkollar" created="Tue, 8 Nov 2016 13:20:10 +0000"/>
                            <attachment id="12838137" name="PIG-5048-4.patch" size="7657" author="nkollar" created="Wed, 9 Nov 2016 09:04:49 +0000"/>
                            <attachment id="12835084" name="PIG-5048.patch" size="2098" author="nkollar" created="Tue, 25 Oct 2016 08:01:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i358tr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>