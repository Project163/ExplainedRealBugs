<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:00:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4326] AvroStorageSchemaConversionUtilities does not properly convert schema for maps of arrays of records</title>
                <link>https://issues.apache.org/jira/browse/PIG-4326</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;I tried to convert the avro schema of a map of arrays of records into the proper pig schema and got always empty map schemas in pig.&lt;/p&gt;

&lt;p&gt;The reason is that the AvroStorageSchemaConversionUtilities does only assume records or primitive types as content of the map. However, a map of arrays, or a map of map, could have a schema itself and requires recursive calling to derive the full schema.&lt;/p&gt;

&lt;p&gt;I wrote a unit test to test for maps of arrays of records which fails with every pig release since the AvroStorage was rewritten (I think this was in 0.12), and there have been no changes since then in the trunk. &lt;/p&gt;

&lt;p&gt;Further the attached patch contains the (rather simple) fix that makes the schema conversion utils succeed.&lt;/p&gt;

&lt;p&gt;Would appreciate further comments and if this can be included upstream.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12754760">PIG-4326</key>
            <summary>AvroStorageSchemaConversionUtilities does not properly convert schema for maps of arrays of records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mprim">Michael Prim</assignee>
                                    <reporter username="mprim">Michael Prim</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Nov 2014 14:07:12 +0000</created>
                <updated>Sun, 7 Jun 2015 03:48:30 +0000</updated>
                            <resolved>Mon, 8 Dec 2014 17:57:11 +0000</resolved>
                                    <version>0.12.0</version>
                    <version>0.13.0</version>
                                    <fixVersion>0.15.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14208064" author="mprim" created="Wed, 12 Nov 2014 14:09:05 +0000"  >&lt;p&gt;I attached the patch, including a (breaking) unit test on the current trunk, and the fix to make the test work.&lt;/p&gt;</comment>
                            <comment id="14211441" author="daijy" created="Thu, 13 Nov 2014 23:16:10 +0000"  >&lt;p&gt;It adds one more level to array:&lt;br/&gt;
parameters: map[array: (array: {innerRecord: (k: chararray,v: int)})&lt;/p&gt;

&lt;p&gt;Should be:&lt;br/&gt;
parameters: map[array: {innerRecord: (k: chararray,v: int)}]}&lt;/p&gt;

&lt;p&gt;The fix should look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; RECORD:
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; MAP:
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ARRAY:
        ResourceSchema innerResourceSchema =
            avroSchemaToResourceSchema(fieldSchema.getValueType(), schemasInStack,
            alreadyDefinedSchemas, allowRecursiveSchema);
        rf.setSchema(innerResourceSchema);
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14212115" author="mprim" created="Fri, 14 Nov 2014 10:59:18 +0000"  >&lt;p&gt;Thanks for the feedback, I realized that during development and was actually also a bit surprised. However removing this extra layer, breaks the already existing testLoadRecordsWithMapOfRecords test, and would be not backward compatible.&lt;/p&gt;

&lt;p&gt;Further, if you create a map&amp;lt;arrray&amp;lt;InnerRecord&amp;gt;&amp;gt; using avro avdl files, it is just syntactic sugar for actually having some map&amp;lt;WrapperRecord&amp;gt; where WrapperRecord has one field, namely an array of InnerRecord. As neither the WrapperRecord has an alias, nor the array of InnerRecords itself, it is a bit confusing that both get the &quot;array&quot; alias.&lt;/p&gt;

&lt;p&gt;So we could stick to the old behavior for records and drop the wrapping tuple only for maps and arrays, but then the resulting output will look different than the input I think.&lt;/p&gt;</comment>
                            <comment id="14212840" author="daijy" created="Fri, 14 Nov 2014 21:19:19 +0000"  >&lt;p&gt;I tried and seems testLoadRecordsWithMapOfRecords pass. I attached my change in AvroStorageSchemaConversionUtilities. &lt;/p&gt;

&lt;p&gt;If there is inconsistency between avro schema and Pig, we shall fill this gap. For example, if avro map always contain a record, we shall remove it when translating to Pig. Pig always has a tuple inside bag, when translating to avro, we shall remove the tuple. If we are not doing that, then it is a bug we shall fix.&lt;/p&gt;</comment>
                            <comment id="14214649" author="mprim" created="Mon, 17 Nov 2014 13:29:22 +0000"  >&lt;p&gt;Did include your previous comment wrongly, my mistake, your attached patch works with the test. Anyway, I still think we should not change the existing behavior for maps of records.&lt;/p&gt;

&lt;p&gt;Previously, for maps of records the AvroStorageSchemaConversionUtils did create:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;map[ MyRecord: (fielda: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ...., fieldz: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which I think is what we want as the record should be one tuple and you want to preserve a possible alias. Your fix removes this tuple and the schema looks like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;map[ fielda: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ...., fieldz: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So I uploaded a new proposal for a patch, which keeps the original behavior for maps of records, whereas for maps of maps and maps of arrays, it removes the additional nesting tuple, thus resulting in e.g.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;map[ array: { MyRecord: (fielda: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, ...., fieldz: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) } ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14223097" author="mprim" created="Mon, 24 Nov 2014 16:13:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; After pig 0.14 is out, can you comment on my updated patch? I need a solution for our production system and would really like to see it being an upstream solution instead of a potentially upstream-incompatible one &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14223581" author="daijy" created="Mon, 24 Nov 2014 21:49:53 +0000"  >&lt;p&gt;Sorry for the delay. Sure my patch get the wrong schema for map, &quot;map[ fielda: int, ...., fieldz: int ]&quot; is wrong, it should be &quot;map[ MyRecord: (fielda: int, ...., fieldz: int) ]&quot;. Your proposal is right, we shall fix the array case and keep map case. Are you saying you have uploaded a new patch? I didn&apos;t see it.&lt;/p&gt;</comment>
                            <comment id="14224242" author="mprim" created="Tue, 25 Nov 2014 08:47:29 +0000"  >&lt;p&gt;The supportForMapsOfArraysOfRecords.patch file is the updated one, should I delete the first attempts from the attached files? &lt;/p&gt;</comment>
                            <comment id="14232823" author="mprim" created="Wed, 3 Dec 2014 09:44:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; Did you have a chance to test the new patch? Would like to get this done and out of my scope &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14233544" author="daijy" created="Wed, 3 Dec 2014 21:24:42 +0000"  >&lt;p&gt;supportForMapsOfArraysOfRecords.patch looks good, both map and map of array schema look right to me. Will commit shortly.&lt;/p&gt;</comment>
                            <comment id="14238150" author="daijy" created="Mon, 8 Dec 2014 17:57:11 +0000"  >&lt;p&gt;supportForMapsOfArraysOfRecords.patch committed to trunk. Thanks Michael!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12681614" name="PIG-4326-0.patch" size="1976" author="daijy" created="Fri, 14 Nov 2014 21:19:19 +0000"/>
                            <attachment id="12681070" name="mapsOfArraysOfRecords.patch" size="5396" author="mprim" created="Wed, 12 Nov 2014 14:09:05 +0000"/>
                            <attachment id="12681894" name="supportForMapsOfArraysOfRecords.patch" size="6253" author="mprim" created="Mon, 17 Nov 2014 13:29:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 50 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22a5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>