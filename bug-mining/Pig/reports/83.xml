<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:48:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-342] Size of DistinctDataBag is calculated incorrectly if spill occurs and non-distinct elements are inserted</title>
                <link>https://issues.apache.org/jira/browse/PIG-342</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;If a spill occurs while elements are being inserted into a DistinctDataBag, it&apos;s possible that non-unique items will be added to the in-memory data structure, and the mSize counter will be incremented.  If the same elements also exist on disk, the count will be higher than it should be.&lt;/p&gt;

&lt;p&gt;The following is copied from an email exchange I had with Alan Gates:&lt;/p&gt;

&lt;p&gt;Alan,&lt;/p&gt;

&lt;p&gt;Thanks for your help.  I&apos;ve done a bit more experimentation and have discovered a couple more things.  I first looked at how COUNT was implemented.  It looks like COUNT calls size() on the bag, which will return mSize.  I thought that mSize might be calculated improperly so I added &quot;SUM(unique_ids) AS crazy_userid_sum&quot; to my GENERATE line and re-ran the pigfile:&lt;/p&gt;

&lt;p&gt;GENERATE FLATTEN(group), SUM(nice_data.duration) AS total_duration, COUNT(nice_data) AS channel_switches, COUNT(unique_ids) AS unique_users, SUM(unique_ids) AS crazy_userid_sum;&lt;/p&gt;

&lt;p&gt;It turns out that the SUM generates the correct result in all cases, while there are still occasional errors in the COUNT.  Since SUM requires an iteration over all the elements in the DistinctDataBag, this led me to believe that the uniqueness constraint is indeed operating correctly, but there is some error in the logic that calculates mSize.&lt;/p&gt;

&lt;p&gt;Then I started poking around in DistinctDataBag looking for anything that changes mSize that might be incorrect.  I noticed that on line 87 in addAll(), the size of the DataBag that is passed into the method is added to the mSize instance variable, and then during the iteration a few lines later mSize is being incremented when an element is successfully added to mContents.  I thought this might be the problem, since it seems like elements would be double counted if addAll() was called.  I commented out line 87, recompiled Pig, and ran it again, but there are still errors (though I do think line 87 might be incorrect anyways).&lt;/p&gt;

&lt;p&gt;Thanks to my coworker Marshall, I think we may have discovered what the actual problem is.  The scenario is as follows:  We&apos;re adding a bunch of stuff to the bag, and before we&apos;re finished a spill occurs.  mContents is cleared during the spill (line 157).  All add() does is check uniqueness against mContents.  So now we will get duplicates in mContents that are already on disk and an inflated mSize.  Now, the reason why SUM works is because the iterator is smart and enforces uniqueness as it reads the records back in. We think this occurs at the beginning of addToQueue, around line 363 - 369.  mMergeTree is a TreeSet, so it&apos;ll enforce uniqueness and the call to addToQueue is aborted if there&apos;s already a matching record in mMergeTree.&lt;/p&gt;

&lt;p&gt;Do you think our assessment is correct?  If so, it seems that the calculation of mSize needs to be significantly more complex than it is now.  It looks to me like the entire bag will need to be iterated in order to reliably calculate the size.  Do you have any ideas about how to implement this in a less expensive way?  I&apos;d be happy to take a stab at it, but I don&apos;t want to do anything particularly silly if you have a better idea.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12401075">PIG-342</key>
            <summary>Size of DistinctDataBag is calculated incorrectly if spill occurs and non-distinct elements are inserted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdimcheff">Brandon Dimcheff</assignee>
                                    <reporter username="bdimcheff">Brandon Dimcheff</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 Jul 2008 05:04:03 +0000</created>
                <updated>Wed, 24 Mar 2010 22:01:27 +0000</updated>
                            <resolved>Wed, 30 Jul 2008 19:46:42 +0000</resolved>
                                    <version>0.1.0</version>
                                    <fixVersion>0.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12617123" author="bdimcheff" created="Sat, 26 Jul 2008 05:05:20 +0000"  >&lt;p&gt;This is a patch that fixes the problem and adds a test to verify the correct behavior.&lt;/p&gt;</comment>
                            <comment id="12618382" author="alangates" created="Wed, 30 Jul 2008 15:19:14 +0000"  >&lt;p&gt;Patch looks good.  I&apos;ll run it through the tests and if all is well apply it.&lt;/p&gt;</comment>
                            <comment id="12618485" author="alangates" created="Wed, 30 Jul 2008 19:46:42 +0000"  >&lt;p&gt;Fix checked in at revision 681184.  Thanks Brandon for contributing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12386939" name="size.patch" size="1907" author="bdimcheff" created="Sat, 26 Jul 2008 05:05:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163978</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gj2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94519</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>