<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5372] SAMPLE/RANDOM(udf) before skewed join failing with NPE</title>
                <link>https://issues.apache.org/jira/browse/PIG-5372</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Sample short code like below&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = LOAD &lt;span class=&quot;code-quote&quot;&gt;&apos;input.txt&apos;&lt;/span&gt; AS (a1:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, a2:chararray, a3:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
B = LOAD &lt;span class=&quot;code-quote&quot;&gt;&apos;input.txt&apos;&lt;/span&gt; AS (b1:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b2:chararray, b3:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);

A2 = FOREACH A generate *, RANDOM() as randnum;

D = join A2 by a1, B by b1 using &lt;span class=&quot;code-quote&quot;&gt;&apos;skewed&apos;&lt;/span&gt; parallel 2;

store D into &lt;span class=&quot;code-quote&quot;&gt;&apos;$output&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fails with NPE. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-12-12 16:06:04,860 [Dispatcher thread: Central] INFO  org.apache.tez.dag.history.HistoryEventHandler - [HISTORY][DAG:dag_1544648742542_0001_1][Event:TASK_FINISHED]: vertexName=scope-55, taskId=task_1544648742542_0001_1_02_000000, startTime=1544648745036, finishTime=1544648764857, timeTaken=19821, status=KILLED, successfulAttemptID=null, diagnostics=TaskAttempt 0 failed, info=[Error: Failure while running task:org.apache.pig.backend.executionengine.ExecException: ERROR 0: Exception while executing (Name: Local Rearrange[tuple]{int}(false) - scope-29 -&amp;gt;       scope-58 Operator Key: scope-29): org.apache.pig.backend.executionengine.ExecException: ERROR 0: Exception while executing [POUserFunc (Name: POUserFunc(org.apache.pig.builtin.RANDOM)[double] - scope-40 Operator Key: scope-40) children: null at []]: java.lang.NullPointerException
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:315)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLocalRearrange.getNextTuple(POLocalRearrange.java:287)
        at org.apache.pig.backend.hadoop.executionengine.tez.plan.operator.POLocalRearrangeTez.getNextTuple(POLocalRearrangeTez.java:131)
        at org.apache.pig.backend.hadoop.executionengine.tez.runtime.PigProcessor.runPipeline(PigProcessor.java:420)
        at org.apache.pig.backend.hadoop.executionengine.tez.runtime.PigProcessor.run(PigProcessor.java:282)
        at org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:337)
        at org.apache.tez.runtime.task.TezTaskRunner$TaskRunnerCallable$1.run(TezTaskRunner.java:179)
        at org.apache.tez.runtime.task.TezTaskRunner$TaskRunnerCallable$1.run(TezTaskRunner.java:171)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:422)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1698)
        at org.apache.tez.runtime.task.TezTaskRunner$TaskRunnerCallable.callInternal(TezTaskRunner.java:171)
        at org.apache.tez.runtime.task.TezTaskRunner$TaskRunnerCallable.callInternal(TezTaskRunner.java:167)
        at org.apache.tez.common.CallableWithNdc.call(CallableWithNdc.java:36)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
Caused by: org.apache.pig.backend.executionengine.ExecException: ERROR 0: Exception while executing [POUserFunc (Name: POUserFunc(org.apache.pig.builtin.RANDOM)[double] - scope-40 Operator Key: scope-40) children: null at []]: java.lang.NullPointerException
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.getNext(PhysicalOperator.java:367)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POForEach.processPlan(POForEach.java:408)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POForEach.getNextTuple(POForEach.java:325)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:305)
        ... 17 more
Caused by: java.lang.NullPointerException
        at org.apache.pig.builtin.RANDOM.exec(RANDOM.java:51)
        at org.apache.pig.builtin.RANDOM.exec(RANDOM.java:37)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POUserFunc.getNext(POUserFunc.java:332)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POUserFunc.getNextDouble(POUserFunc.java:396)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.getNext(PhysicalOperator.java:343)
        ... 20 more
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13204098">PIG-5372</key>
            <summary>SAMPLE/RANDOM(udf) before skewed join failing with NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Dec 2018 21:07:59 +0000</created>
                <updated>Fri, 25 Jan 2019 21:53:15 +0000</updated>
                            <resolved>Fri, 25 Jan 2019 21:53:15 +0000</resolved>
                                    <version>0.16.0</version>
                                    <fixVersion>0.17.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16719445" author="knoguchi" created="Wed, 12 Dec 2018 21:20:27 +0000"  >&lt;p&gt;Same would happen for SAMPLE since it internally calls RANDOM.&lt;/p&gt;

&lt;p&gt;NPE happens at&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; jobidhash = PigMapReduce.sJobConfInternal.get().get(MRConfiguration.JOB_ID).hashCode();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when job_id returns null.&lt;/p&gt;

&lt;p&gt;This was happening when SkewedPartitioner.setConf was replacing a configuration dropping the original one with necessary job info. &lt;br/&gt;
Attaching a patch(&lt;tt&gt;pig-5372-v1.patch&lt;/tt&gt;) that would just add instead of replacing the conf.&lt;/p&gt;</comment>
                            <comment id="16724285" author="rohini" created="Tue, 18 Dec 2018 17:31:36 +0000"  >&lt;p&gt;I think it should be fine to remove the below lines instead. They seem to be not used&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PigMapReduce.sJobConfInternal.set(conf);
        PigMapReduce.sJobConf = conf;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16724307" author="knoguchi" created="Tue, 18 Dec 2018 17:59:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think it should be fine to remove the below lines instead. They seem to be not used&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the setting came from &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1467&quot; title=&quot;order by fail when set &amp;quot;fs.file.impl.disable.cache&amp;quot; to true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-1467&quot;&gt;&lt;del&gt;PIG-1467&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="16727017" author="rohini" created="Fri, 21 Dec 2018 19:50:19 +0000"  >&lt;p&gt;This failure is only with Tez or mapreduce as well? I am not able to tell exactly why Daniel is doing that in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1467&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PIG-1467&lt;/a&gt; as the description of jira does not have proper stacktrace.  In Tez, we read the quantile file from memory (broadcast edge) instead of local file (distributed cache) like in mapreduce. So we can override setConf() in SkewedPartitionerTez if this issue is specific to Tez.&lt;/p&gt;</comment>
                            <comment id="16728458" author="knoguchi" created="Mon, 24 Dec 2018 16:51:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;I am not able to tell exactly why Daniel is doing that in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-1467&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PIG-1467&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Me neither.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;, can you help us? &lt;/p&gt;

&lt;p&gt;Without fully understanding what&apos;s happening there, I would rather keep the current patch to avoid introducing unexpected regression.&lt;/p&gt;</comment>
                            <comment id="16732373" author="daijy" created="Wed, 2 Jan 2019 19:51:01 +0000"  >&lt;p&gt;Wow that&apos;s back in 2010 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I think SkewedPartitioner.setConf is passing conf to MapRedUtil.loadPartitionFileFromLocalCache via PigMapReduce.sJobConf. This is no longer necessary as MapRedUtil.loadPartitionFileFromLocalCache takes mapConf parameter (in a later patch). We can change MapRedUtil.loadPartitionFileFromLocalCache to retrieve fs.file.impl/fs.hdfs.impl from mapConf. Then we don&apos;t need overwrite PigMapReduce.sJobConf in SkewedPartitioner.setConf.&lt;/p&gt;</comment>
                            <comment id="16746528" author="knoguchi" created="Fri, 18 Jan 2019 17:50:43 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;!&#160;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;We can change MapRedUtil.loadPartitionFileFromLocalCache to retrieve fs.file.impl/fs.hdfs.impl from mapConf. Then we don&apos;t need overwrite PigMapReduce.sJobConf in SkewedPartitioner.setConf.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Attaching &lt;tt&gt;pig-5372-v2.patch&lt;/tt&gt; which does this.&lt;br/&gt;
Ideally we should have a test case for &quot;fs.file.impl/fs.hdfs.impl &quot; but I fail to see when we ever want to disable cache for fs.file&amp;amp;fs.hdfs in the first place.&lt;/p&gt;</comment>
                            <comment id="16751688" author="rohini" created="Thu, 24 Jan 2019 23:14:20 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16752712" author="knoguchi" created="Fri, 25 Jan 2019 21:53:15 +0000"  >&lt;p&gt;Thanks for the review Rohini, Daniel!!! &lt;/p&gt;

&lt;p&gt;Committed to trunk and branch-0.17.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12951558" name="pig-5372-v1.patch" size="6622" author="knoguchi" created="Wed, 12 Dec 2018 21:20:09 +0000"/>
                            <attachment id="12955444" name="pig-5372-v2.patch" size="7387" author="knoguchi" created="Fri, 18 Jan 2019 17:47:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s01gnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>