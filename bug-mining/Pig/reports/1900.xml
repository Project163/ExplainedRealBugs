<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-3891] FileBasedOutputSizeReader does not calculate size of files in sub-directories</title>
                <link>https://issues.apache.org/jira/browse/PIG-3891</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;FileBasedOutputSizeReader only includes files in the top level output directory. So if files are stored under subdirectories (For eg: MultiStorage), it does not have the bytes written correctly. &lt;/p&gt;

&lt;p&gt;0.11 shows the correct number of total bytes written and this is a regression. A quick look at the code shows that the JobStats.addOneOutputStats() in 0.11 also does not recursively iterate and code is same as  FileBasedOutputSizeReader. Need to investigate where the correct value comes from in 0.11 and fix it in 0.12.1/0.13.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12708343">PIG-3891</key>
            <summary>FileBasedOutputSizeReader does not calculate size of files in sub-directories</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkollar">N&#225;ndor Koll&#225;r</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Apr 2014 19:01:18 +0000</created>
                <updated>Fri, 2 Dec 2016 17:38:57 +0000</updated>
                            <resolved>Fri, 2 Dec 2016 17:28:06 +0000</resolved>
                                    <version>0.12.0</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13977698" author="chitnis" created="Wed, 23 Apr 2014 01:10:35 +0000"  >&lt;p&gt;Linking the original JIRA introducing this change. The issue is probably in reporting the counters as a whole as I&apos;m getting the following output for a sample pig test (map-reduce mode of course), even though its successful and produced output successfully.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Input(s):&lt;br/&gt;
Successfully read 0 records from: &quot;/user/pig/tests/data/pigmix/page_views&quot;&lt;/p&gt;

&lt;p&gt;Output(s):&lt;br/&gt;
Successfully stored 0 records in: &quot;/user/chitnis//L1out&quot;&lt;/p&gt;

&lt;p&gt;Counters:&lt;br/&gt;
Total records written : 0&lt;br/&gt;
Total bytes written : 0&lt;br/&gt;
Spillable Memory Manager spill count : 0&lt;br/&gt;
Total bags proactively spilled: 0&lt;br/&gt;
Total records proactively spilled: 0&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13978886" author="chitnis" created="Wed, 23 Apr 2014 20:56:06 +0000"  >&lt;p&gt;above observation was due to a misconfigured single-node cluster. Now able to reproduce that problem lies only in output records and bytes written&lt;/p&gt;</comment>
                            <comment id="13980106" author="rohini" created="Thu, 24 Apr 2014 19:04:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;0.11 shows the correct number of total bytes written and this is a regression. A quick look at the code shows that the JobStats.addOneOutputStats() in 0.11 also does not recursively iterate and code is same as FileBasedOutputSizeReader. Need to investigate where the correct value comes from in 0.11 and fix it in 0.12.1/0.13&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;  It is not a regression. I was checking case of single store (in 0.11) vs multi store (in trunk). Single store always uses the mapreduce counter to get the hdfs bytes written and does not use FileBasedOutputSizeReader. &lt;/p&gt;</comment>
                            <comment id="13980545" author="chitnis" created="Fri, 25 Apr 2014 00:29:36 +0000"  >&lt;p&gt;Attaching patch. End-to-end test done - using MultiStorage, split and both.&lt;br/&gt;
Example output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Output(s):
Successfully stored 4 records (94 bytes) in: &lt;span class=&quot;code-quote&quot;&gt;&quot;hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8020/user/chitnis/split1&quot;&lt;/span&gt;
&lt;/span&gt;Successfully stored 2 records (47 bytes) in: &lt;span class=&quot;code-quote&quot;&gt;&quot;hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8020/user/chitnis/split2&quot;&lt;/span&gt;
&lt;/span&gt;Successfully stored 3 records (60 bytes) in: &lt;span class=&quot;code-quote&quot;&gt;&quot;hdfs:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8020/user/chitnis/split3&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unit tests included in patch, but can go through minor tweaks&lt;/p&gt;</comment>
                            <comment id="13980546" author="chitnis" created="Fri, 25 Apr 2014 00:30:37 +0000"  >&lt;p&gt;Attaching fix for class JobStats.java (pig 0.11)&lt;/p&gt;</comment>
                            <comment id="14013015" author="rohini" created="Thu, 29 May 2014 22:24:28 +0000"  >&lt;p&gt;Few comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You can&apos;t refer to piggybank classes from pig.&lt;/li&gt;
	&lt;li&gt;getLeavesSize -&amp;gt; getPathSize&lt;/li&gt;
	&lt;li&gt;If the path is a file and not directory it will not get the filesize&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14013167" author="chitnis" created="Fri, 30 May 2014 00:53:10 +0000"  >&lt;p&gt;wouldnt this block take care of path being file  and adding its length directly?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status.isFile()) {
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status.getLen() &amp;gt; 0)
            bytes += status.getLen();
 }
 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;// recursively count nested leaves&apos; (files) sizes
&lt;/span&gt;      bytes += getPathSize(status.getPath(), fs);
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I moved the unit tests to piggybank&apos;s TestMultiStorage class then and cleaned up the i/o. Patch rebased to trunk&lt;/p&gt;</comment>
                            <comment id="14989172" author="egmont@c" created="Wed, 4 Nov 2015 09:14:03 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Friendly ping &#8211; any updates on this?&lt;/p&gt;</comment>
                            <comment id="15385858" author="nkollar" created="Wed, 20 Jul 2016 13:31:28 +0000"  >&lt;p&gt;The patch for FileBasedOutputSizeReader looks good for me, but I think a new test case is required in TestMRJobStats to test this case not just in piggybank. I attached a 3rd version of this patch with a new test case with and changed the MultiStore test case too: it seems that FileBasedOutputSizeReader is used when the script is executed in batch mode, and it stores the result in multiple stores (using MultiStores in subdirectories), and not just in one (for just one store command, the mapreduce counters are taken into account).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; wouldn&apos;t testGetOutputSizeUsingFileBasedStorage in TestMRJobStats test the filesize if it is a file and not a path? With the patch applied, this test is green.&lt;/p&gt;</comment>
                            <comment id="15387186" author="rohini" created="Thu, 21 Jul 2016 05:22:20 +0000"  >&lt;p&gt;Few comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Could you fix this to run in Tez mode as well? Did not realize this one was not fixed.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;pigServer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PigServer(cluster.getExecType(), cluster.getProperties());
     pigServerLocal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PigServer(ExecType.LOCAL);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;to &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;pigServer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PigServer(ExecType.MAPREDUCE, cluster.getProperties());
     pigServerLocal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PigServer(Util.getLocalTestMode());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; It would also involve changes to the test like MRJobStats-&amp;gt;JobStats, etc. You can test by running with ant test -Dhadoopversion=23 -Dexectype=tez -Dtestcase=TestMultiStorage&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Can you add asserts for getMultiStoreCounters() as well for the individual output bytes written&lt;/li&gt;
	&lt;li&gt;Test name is too verbose. Could you rename the test as just testOutputStats and add a comment in the beginning of the test saying&lt;br/&gt;
//Test if bytes written is correct with sub-directories and multiple MultiStorage statements.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Rest looks good.&lt;/p&gt;
</comment>
                            <comment id="15483786" author="nkollar" created="Mon, 12 Sep 2016 10:51:29 +0000"  >&lt;p&gt;Attached patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;executed TestMultiStorage in Tez mode, after minor adjustments it passed in Tez mode too. When I executed the tests, it seemed that in Tez mode the statistics written to the console are not collected via FileBasedOutputSizeReader, I could see the correct values there even without the fix, but in MR mode the console output was incorrect without the recursive traversal fix in FileBasedOutputSizeReader. I don&apos;t know what kind of changes I should do in MRJobStats, JobStats, those tests passed even in Tez and in MR mode.&lt;/li&gt;
	&lt;li&gt;in TestMultiStorage I added asserts for getMultiStoreCounters&lt;/li&gt;
	&lt;li&gt;renamed the method, added a comment&lt;/li&gt;
	&lt;li&gt;in addition, I fixed typos in methods in TestMRJobStats.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; could you please take a look at the latest patch?&lt;/p&gt;</comment>
                            <comment id="15636550" author="nkollar" created="Fri, 4 Nov 2016 14:50:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; could you please review my patch, and let me know if it needs some more adjustment?&lt;/p&gt;</comment>
                            <comment id="15708446" author="szita" created="Wed, 30 Nov 2016 12:25:04 +0000"  >&lt;p&gt;LGTM, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; can you please help &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkollar&quot; class=&quot;user-hover&quot; rel=&quot;nkollar&quot;&gt;nkollar&lt;/a&gt; by committing this?&lt;/p&gt;</comment>
                            <comment id="15712581" author="rohini" created="Thu, 1 Dec 2016 17:47:27 +0000"  >&lt;p&gt;Comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CHANGES.txt will be modified when committing. Need not make any changes to that as part of patch&lt;/li&gt;
	&lt;li&gt;Please revert changes to ExecType and TezMiniCluster. We can&apos;t have public static changed to package protected as it is already being used by users. Once &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4923&quot; title=&quot;Drop Hadoop 1.x support in Pig 0.17&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4923&quot;&gt;&lt;del&gt;PIG-4923&lt;/del&gt;&lt;/a&gt; goes in, we can add TEZ and SPARK there.&lt;/li&gt;
	&lt;li&gt;In TestMRJobStats, can you change &quot;The returned output size is expected to be the same as the file size&quot; to &quot;The returned output size is expected to be sum of file sizes in the sub-directories&quot;&lt;/li&gt;
	&lt;li&gt;We try to avoid if (Tez) else (MR) conditions as much as possible in tests. For testOutputStats test in TestMultiStorage, can we just do following asserts and put hardcoded values instead of getting values from MR and Tez counters. That way test is more solid.  Also please do add a FILTER statement for out2 to filter couple of records so that bytes and records are not same as out1.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; multiStoreCounters = dagStats.getMultiStoreCounters();
+        PigStats stats = job.getStatistics();
+        assertEquals(HardCodedValueHere, stats.getBytesWritten());
+        List&amp;lt;OutputStats&amp;gt; outputStats = SimplePigStats.get().getOutputStats();
+        assertEquals(2, outputStats.size()); &lt;span class=&quot;code-comment&quot;&gt;// 2 split conditions
&lt;/span&gt;+        assertEquals(HardCodedValueHere, outputStats.get(0).getBytes());
+        assertEquals(HardCodedValueHere, outputStats.get(1).getBytes());
+        assertEquals(HardCodedValueHere, outputStats.get(0).getRecords());
+        assertEquals(HardCodedValueHere, outputStats.get(1).getRecords());
+        assertEquals(9L, multiStoreCounters.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;Output records in _1_out2&quot;&lt;/span&gt;).longValue());
+        assertEquals(9L, multiStoreCounters.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;Output records in _0_out1&quot;&lt;/span&gt;).longValue());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15715158" author="nkollar" created="Fri, 2 Dec 2016 13:43:19 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; for your comments, I made the required adjustments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Reverted CHANGES.txt&lt;/li&gt;
	&lt;li&gt;Reverted the changes on ExecType and TezMiniCluster, but I think my patch didn&apos;t change the visibility of the exec types, since those were declared inside an interface.&lt;/li&gt;
	&lt;li&gt;Changed the assert message.&lt;/li&gt;
	&lt;li&gt;Rewrote the assert as you suggested, indeed, it looks better without the branch. Test passes both on Tez and MR mode.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Attached new version: &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3891&quot; title=&quot;FileBasedOutputSizeReader does not calculate size of files in sub-directories&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3891&quot;&gt;&lt;del&gt;PIG-3891&lt;/del&gt;&lt;/a&gt;-5.patch. Could you please have a look at it?&lt;/p&gt;</comment>
                            <comment id="15715741" author="rohini" created="Fri, 2 Dec 2016 17:28:06 +0000"  >&lt;p&gt;Thanks for the changes. Patch is perfect now. I missed that ExecType was an interface. So that change should not have been a problem.&lt;/p&gt;

&lt;p&gt;+1.  Committed to trunk. &lt;/p&gt;
</comment>
                            <comment id="15715771" author="nkollar" created="Fri, 2 Dec 2016 17:38:57 +0000"  >&lt;p&gt;Thanks Rohini for committing and reviewing my patch!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12608249">PIG-2924</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12641840" name="PIG-3891-1.patch" size="8675" author="chitnis" created="Fri, 25 Apr 2014 00:29:36 +0000"/>
                            <attachment id="12647500" name="PIG-3891-2.patch" size="9521" author="chitnis" created="Fri, 30 May 2014 00:53:10 +0000"/>
                            <attachment id="12819080" name="PIG-3891-3.patch" size="14143" author="nkollar" created="Wed, 20 Jul 2016 13:17:15 +0000"/>
                            <attachment id="12828019" name="PIG-3891-4.patch" size="20255" author="nkollar" created="Mon, 12 Sep 2016 10:33:41 +0000"/>
                            <attachment id="12841486" name="PIG-3891-5.patch" size="16156" author="nkollar" created="Fri, 2 Dec 2016 13:50:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386666</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ulzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386930</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>