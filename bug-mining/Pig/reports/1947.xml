<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4548] Records Lost With Specific Combination of Commands and Streaming Function</title>
                <link>https://issues.apache.org/jira/browse/PIG-4548</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The below is the bare minimum I was able to extract from my original&lt;br/&gt;
problem to in order to demonstrate the bug.  So, don&apos;t expect the following&lt;br/&gt;
code to serve any practical purpose.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;My input file (test_in) is two columns with a tab delimiter:&lt;/p&gt;

&lt;p&gt;1   F&lt;br/&gt;
2   F&lt;/p&gt;

&lt;p&gt;My streaming function (sf.py) ignores the actual input and simply generates&lt;br/&gt;
2 records:&lt;/p&gt;

&lt;p&gt;#!/usr/bin/python&lt;br/&gt;
if _&lt;em&gt;name&lt;/em&gt;_ == &apos;_&lt;em&gt;main&lt;/em&gt;_&apos;:&lt;br/&gt;
    print &apos;x&apos;&lt;br/&gt;
    print &apos;y&apos;&lt;/p&gt;

&lt;p&gt;(But I should mention that in my original problem the input to output was&lt;br/&gt;
one-to-one.  I just ignored the input here to get to the bare minimum&lt;br/&gt;
effect.)&lt;/p&gt;

&lt;p&gt;My pig script:&lt;/p&gt;

&lt;p&gt;MY_INPUT = load &apos;test_in&apos; as ( f1, f2);&lt;br/&gt;
split MY_INPUT into T if (f2 == &apos;T&apos;), F otherwise;&lt;br/&gt;
T2 = group T by f1;&lt;br/&gt;
store T2 into &apos;test_out/T2&apos;;&lt;br/&gt;
F2 = group F by f1;&lt;br/&gt;
store F2 into &apos;test_out/F2&apos;;  &amp;#8211; (this line is actually optional to demo&lt;br/&gt;
the bug)&lt;br/&gt;
F3 = stream F2 through `sf.py`;&lt;br/&gt;
store F3 into &apos;test_out/F3&apos;;&lt;/p&gt;

&lt;p&gt;My expected output for test/out/F3 is two records that come directly from&lt;br/&gt;
sf.py:&lt;/p&gt;

&lt;p&gt;x&lt;br/&gt;
y&lt;/p&gt;

&lt;p&gt;However, I only get:&lt;/p&gt;

&lt;p&gt;x&lt;/p&gt;

&lt;p&gt;I&apos;ve tried all of the following to get the expected behavior:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;upgraded Pig from 0.12.0 to 0.14.0&lt;/li&gt;
	&lt;li&gt;local vs. distributed mode&lt;/li&gt;
	&lt;li&gt;flush sys.stdout in the streaming function&lt;/li&gt;
	&lt;li&gt;replace sf.py with sf.sh which is a bash script that used &quot;echo x;&lt;br/&gt;
   echo y&quot; to do the same thing.  In this case, the final contents of&lt;br/&gt;
   test_out/F# would vary - sometimes I would get both x and y, and sometimes&lt;br/&gt;
   I would just get x.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Aside from removing the one Pig line that I&apos;ve marked optional, any other&lt;br/&gt;
attempts to simplify the Pig script or input file causes the bug to not&lt;br/&gt;
manifest.&lt;/p&gt;

&lt;p&gt;Log files can be found at &lt;a href=&quot;http://www.mail-archive.com/user@pig.apache.org/msg10195.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@pig.apache.org/msg10195.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Amazon EMR (Elastic Map-Reduce) AMI 3.3.1&lt;/p&gt;</environment>
        <key id="12829298">PIG-4548</key>
            <summary>Records Lost With Specific Combination of Commands and Streaming Function</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="brane2">Steve T</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 May 2015 19:14:59 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:09 +0000</updated>
                            <resolved>Mon, 26 Jun 2017 16:48:22 +0000</resolved>
                                    <version>0.12.0</version>
                    <version>0.14.0</version>
                                    <fixVersion>0.18.0</fixVersion>
                    <fixVersion>0.17.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16037540" author="knoguchi" created="Mon, 5 Jun 2017 20:33:28 +0000"  >&lt;p&gt;Noticed this jira during reflagging to 0.18.&lt;br/&gt;
Any incorrect results should be treated as priority.  I&apos;ve missed this one.&lt;/p&gt;

&lt;p&gt;Using the test-case attached on the description, I was able to reproduce the behavior on trunk but only for map-reduce mode and not tez.&lt;/p&gt;

&lt;p&gt;Tracing the issue, it seems like a bug in &lt;tt&gt;PODemux&lt;/tt&gt; when all input has been sent, PODemux assumes there&apos;s at most one output to be consumed in &lt;tt&gt;getStreamCloseResult()&lt;/tt&gt;.  &lt;br/&gt;
Attaching a patch that would continue to read till EOP.&lt;br/&gt;
PhysicalPlan is not my strength and PODemux.java hasn&apos;t been touched for years.  Appreciate if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; can take a look.&lt;/p&gt;</comment>
                            <comment id="16039063" author="brane2" created="Tue, 6 Jun 2017 15:16:15 +0000"  >&lt;p&gt;Thanks so much, Koji!  This bug has been a thorn in my side for al long time.  I appreciate any extra attention that it gets.  I have many Pig scripts in production where I have to use inefficient work-arounds like storing and reloading to avoid loosing data.  For the longest time I thought I was the only one who could see this problem.  Maybe no one else uses streaming functions as heavily as I do.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16056430" author="knoguchi" created="Tue, 20 Jun 2017 20:47:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;, when you have time, can you take a look at my patch? &lt;/p&gt;</comment>
                            <comment id="16061480" author="rohini" created="Fri, 23 Jun 2017 20:45:16 +0000"  >&lt;p&gt;+1. Patch looks good.  &lt;/p&gt;

&lt;p&gt;I noticed an inefficiency that we are attaching input to just one child plan based on record index but instead of just processing that plan, we are iterating through all child plans and processing them. Not so familiar with PODemux. So not suggest to optimize it now. Might break something like case of nested PODemux. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I was able to reproduce the behavior on trunk but only for map-reduce mode and not tez&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; PODemux is only used for multi-query. For eg: Combining multiple groupbys on same input into one hadoop job which is the case mentioned in the jira.  We do not use PODemux operator at all in Tez. Tez supports multiple outputs and inputs. So multi-query processing is very different with it. In this case, it will create three vertices. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;           V1 (Load) 
           /\
          /  \
         /    \
       V2     V3  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where V2 is the reducer for T2 groupby and V3 for F2 group by.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I have many Pig scripts in production where I have to use inefficient work-arounds like storing and reloading to avoid loosing data.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  That is bad. As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt; said, we always treat data loss as critical. Sorry we missed fixing this earlier. There will sure be others who are experiencing this, but must not have not noticed that records are lost. &lt;/p&gt;</comment>
                            <comment id="16063385" author="knoguchi" created="Mon, 26 Jun 2017 16:48:22 +0000"  >&lt;p&gt;Thanks for the review Rohini. &lt;br/&gt;
Committed to Trunk(0.18) and 0.17-branch. &lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brane2&quot; class=&quot;user-hover&quot; rel=&quot;brane2&quot;&gt;brane2&lt;/a&gt; for reporting this critical issue!!!&lt;br/&gt;
(and sorry again for missing this for such a long time.)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12871295" name="pig-4548-v1.patch" size="4269" author="knoguchi" created="Mon, 5 Jun 2017 20:33:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2emz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>