<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5335] Error message from range projection completely misleading</title>
                <link>https://issues.apache.org/jira/browse/PIG-5335</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
A = load &lt;span class=&quot;code-quote&quot;&gt;&apos;input.txt&apos;&lt;/span&gt; as (a0,a1,a2,a3);
B = FOREACH A GENERATE a0, a1, a2, a3;
store B into &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/deleteme&apos;&lt;/span&gt;;

C = FOREACH A GENERATE a0, b1, a2, a3;
D = FOREACH C GENERATE a0..a2;
(end of script, no store, nothing)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Error message&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;2018-04-10 10:22:33,360 [main] ERROR org.apache.pig.PigServer - exception during parsing: Error during parsing. Invalid field projection. Projected field [a0] does not exist in schema: a0:bytearray,a0:bytearray,a2:bytearray,a3:bytearray.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At least two issues.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Error should be about FOREACH for C referencing non-existing field &apos;b1&apos;.  But the error message is saying something about &apos;a0&apos;.&lt;/li&gt;
	&lt;li&gt;Script itself is not using relation C and D at all.  It&apos;s confusing to see errors coming out of unused relations.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13151400">PIG-5335</key>
            <summary>Error message from range projection completely misleading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Apr 2018 14:29:07 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:00 +0000</updated>
                            <resolved>Tue, 15 May 2018 04:21:58 +0000</resolved>
                                                    <fixVersion>0.18.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16432356" author="knoguchi" created="Tue, 10 Apr 2018 14:30:10 +0000"  >&lt;p&gt;Full trace.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-04-10 10:22:33,360 [main] ERROR org.apache.pig.PigServer - exception during parsing: Error during parsing. Invalid field projection. Projected field [a0] does not exist in schema: a0:bytearray,a0:bytearray,a2:bytearray,a3:bytearray.
Failed to parse: Pig script failed to parse: &amp;lt;file test.pig, line 6, column 4&amp;gt; pig script failed to validate: org.apache.pig.impl.plan.PlanValidationException: ERROR 1025: Invalid field projection. Projected field [a0] does not exist in schema: a0:bytearray,a0:bytearray,a2:bytearray,a3:bytearray.
        at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:199)
        at org.apache.pig.PigServer$Graph.parseQuery(PigServer.java:1824)
        at org.apache.pig.PigServer$Graph.access$000(PigServer.java:1532)
        at org.apache.pig.PigServer.parseAndBuild(PigServer.java:461)
        at org.apache.pig.PigServer.executeBatch(PigServer.java:486)
        at org.apache.pig.PigServer.executeBatch(PigServer.java:472)
        at org.apache.pig.tools.grunt.GruntParser.executeBatch(GruntParser.java:172)
        at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:235)
        at org.apache.pig.tools.grunt.GruntParser.parseStopOnError(GruntParser.java:206)
        at org.apache.pig.tools.grunt.Grunt.exec(Grunt.java:81)
        at org.apache.pig.Main.run(Main.java:630)
        at org.apache.pig.Main.main(Main.java:175)
Caused by: &amp;lt;file test.pig, line 6, column 4&amp;gt; pig script failed to validate: org.apache.pig.impl.plan.PlanValidationException: ERROR 1025: Invalid field projection. Projected field [a0] does not exist in schema: a0:bytearray,a0:bytearray,a2:bytearray,a3:bytearray.
        at org.apache.pig.parser.LogicalPlanBuilder.buildForeachOp(LogicalPlanBuilder.java:1066)
        at org.apache.pig.parser.LogicalPlanGenerator.foreach_clause(LogicalPlanGenerator.java:15896)
        at org.apache.pig.parser.LogicalPlanGenerator.op_clause(LogicalPlanGenerator.java:1933)
        at org.apache.pig.parser.LogicalPlanGenerator.general_statement(LogicalPlanGenerator.java:1102)
        at org.apache.pig.parser.LogicalPlanGenerator.statement(LogicalPlanGenerator.java:560)
        at org.apache.pig.parser.LogicalPlanGenerator.query(LogicalPlanGenerator.java:421)
        at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:191)
        ... 11 more
Caused by: org.apache.pig.impl.plan.PlanValidationException: ERROR 1025: Invalid field projection. Projected field [a0] does not exist in schema: a0:bytearray,a0:bytearray,a2:bytearray,a3:bytearray.
        at org.apache.pig.newplan.logical.expression.ProjectExpression.findColNum(ProjectExpression.java:191)
        at org.apache.pig.newplan.logical.expression.ProjectExpression.setColumnNumberFromAlias(ProjectExpression.java:154)
        at org.apache.pig.newplan.logical.visitor.ProjectStarExpander.visit(ProjectStarExpander.java:344)
        at org.apache.pig.parser.LogicalPlanBuilder.buildForeachOp(LogicalPlanBuilder.java:1062)
        ... 17 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16432406" author="knoguchi" created="Tue, 10 Apr 2018 14:56:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;2. Script itself is not using relation C and D at all. It&apos;s confusing to see errors coming out of unused relations.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is probably due to checks being done inside &lt;tt&gt;LogicalPlanBuilder&lt;/tt&gt; when the ForEach and others are  built.&lt;br/&gt;
Maybe a silly question but asking &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;. Can &lt;tt&gt;ProjectStarExpander&lt;/tt&gt; and &lt;tt&gt;ProjStarInUdfExpander&lt;/tt&gt; be moved from LogicalPlanBuilder to LogicalPlan.validate() ?&lt;/p&gt;</comment>
                            <comment id="16453471" author="knoguchi" created="Thu, 26 Apr 2018 04:11:41 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Maybe a silly question but asking Daniel Dai. Can ProjectStarExpander and ProjStarInUdfExpander be moved from LogicalPlanBuilder to LogicalPlan.validate() ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;First tried this but saw that many tests from LOCube and others started failing since these LogicalOperator depended on having these range expanded at creation time.   I could have tried to move most of  LogicalPlanBuilder  steps to LogicalPlan.validate() but that would be too much work for the minor jira with just error message fixing.&lt;/p&gt;</comment>
                            <comment id="16453484" author="knoguchi" created="Thu, 26 Apr 2018 04:29:08 +0000"  >&lt;p&gt;Looking at why ProjectStarExpander was seeing a completely random schema with redundant a0&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Projected field [a0] does not exist in schema: &lt;font color=&quot;red&quot;&gt;a0:bytearray,a0:bytearray&lt;/font&gt;,a2:bytearray,a3:bytearray&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It was coming from LogicalPlanBuilder.buildForeachOp --&amp;gt; ProjectExpression.getFieldSchema where ProjectExpression was always picking the first field (column 0) when provided alias was not found.&lt;br/&gt;
This random behavior worked because later in LogicalPlan.validate()-&amp;gt;ColumnAliasConversionVisitor, it did correctly identify the incorrect alias reference (&quot;b1&quot;).&lt;/p&gt;

&lt;p&gt;However, for this jira, before reaching to LogicalPlan.validate(), it is failing within LogicalPlanBuilder&apos;s phase where ProjectStarExpander looked up for range &quot;a0..a2&quot;, and LogicalSchema.getField(&quot;a0&quot;) didn&apos;t return due to &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;LogicalSchema.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 610          StringBuilder sb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder(&lt;span class=&quot;code-quote&quot;&gt;&quot;Found more than one match: &quot;&lt;/span&gt; + result.alias + &lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt; + fs.alias);
 611          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FrontendException(sb.toString(), 1025);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and that exception was swallowed and got replaced with the misleading error message shown in the description.&lt;/p&gt;
</comment>
                            <comment id="16453493" author="knoguchi" created="Thu, 26 Apr 2018 04:39:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;However, for this jira, before reaching to LogicalPlan.validate(), it is failing within LogicalPlanBuilder&apos;s phase where ProjectStarExpander looked up&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I tried moving ProjectStarExpander to later phase in  LogicalPlan.validate() but as I mentioned, some LogicalOperator depended on these projects range to be expanded at LogicalPlanBuilder time.&lt;/p&gt;

&lt;p&gt;So, in &lt;tt&gt;pig-5335-v01.patch&lt;/tt&gt;, focused on &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;ProjectExpression was always picking the first field (column 0) when provided alias was not found.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;and tried returning a new fieldschema with the invalid lookup fieldname. I believe this allowed the compilation to move forward and get the right error message inside LogicalPlan.validate()-&amp;gt;ColumnAliasConversionVisitor.&lt;/p&gt;

&lt;p&gt;Running tests.&lt;/p&gt;</comment>
                            <comment id="16472251" author="rohini" created="Fri, 11 May 2018 16:48:15 +0000"  >&lt;p&gt;The patch is setting LogicalExpression.getNextUid() instead of leaving it at default -1 unlike other cases. Can you provide the explanation for that here and also upload a patch with a comment giving link to your jira explanation?&lt;/p&gt;</comment>
                            <comment id="16472439" author="knoguchi" created="Fri, 11 May 2018 18:29:43 +0000"  >&lt;p&gt;Uploading a new patch with comment updated.&lt;br/&gt;
 Basically with uid left with -1, &lt;tt&gt;TestColumnAliasConversion.testInvalidNestedProjection&lt;/tt&gt; started failing at LogicalPlanBuilder time.&lt;/p&gt;

&lt;p&gt;Just to summarize.&lt;br/&gt;
 For these type of script errors, there are essentially two locations&#160;catching the errors.&lt;br/&gt;
 (check1) LogicalPlanBuilder.buildForeachOp&lt;br/&gt;
 (check2) LogicalPlan.validate&lt;/p&gt;

&lt;p&gt;Check1 is done at script reading time and errors out irrespective of if the corresponding relation is used or not. &lt;br/&gt;
Check2 is done much later and is only performed for relations that are part of Dump/Store.&#160;&lt;/p&gt;

&lt;p&gt;&#160;For this jira, I&apos;ve tried a couple of patterns.&lt;br/&gt;
 (a) Move ProjectStarExpander and ProjStarInUdfExpander from check1 to check2. &lt;br/&gt;
 This didn&apos;t work due to other part of the code depended upon these visitors within check1. &lt;br/&gt;
 (b) Throw exception when invalid field is referenced in ProjectExpression.java. &lt;br/&gt;
 This moved bunch of negative tests that used to fail in check2 to check1. (Meaning, user may start to see their pig scripts failing due to pig compiler catching errors in unused relations).&lt;br/&gt;
(c) Create invalid field with uid=-1. &lt;br/&gt;
This mostly worked but TestColumnAliasConversion.testInvalidNestedProjection &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TestColumnAliasConversion.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query = &lt;span class=&quot;code-quote&quot;&gt;&quot;A = load &lt;span class=&quot;code-quote&quot;&gt;&apos;x&apos;&lt;/span&gt; as (field);&quot;&lt;/span&gt; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;B = foreach A {&quot;&lt;/span&gt; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;  C = LIMIT invalidName 1;&quot;&lt;/span&gt; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;  generate C.foo;&quot;&lt;/span&gt; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;};&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;started to fail at check1 instead of check2 due to &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;line 1, column 28&amp;gt; pig script failed to validate: org.apache.pig.impl.plan.PlanValidationException: ERROR 2271: Logical plan invalid state: invalid uid -1 in schema : invalidName#-1:bytearray
	at org.apache.pig.parser.LogicalPlanBuilder.buildForeachOp(LogicalPlanBuilder.java:1066)
	at org.apache.pig.parser.LogicalPlanGenerator.foreach_clause(LogicalPlanGenerator.java:15896)
	at org.apache.pig.parser.LogicalPlanGenerator.op_clause(LogicalPlanGenerator.java:1933)
	at org.apache.pig.parser.LogicalPlanGenerator.general_statement(LogicalPlanGenerator.java:1102)
	at org.apache.pig.parser.LogicalPlanGenerator.statement(LogicalPlanGenerator.java:560)
	at org.apache.pig.parser.LogicalPlanGenerator.query(LogicalPlanGenerator.java:421)
	at org.apache.pig.parser.ParserTestingUtils.generateLogicalPlan(ParserTestingUtils.java:76)
	at org.apache.pig.parser.TestColumnAliasConversion.validate(TestColumnAliasConversion.java:179)
	at org.apache.pig.parser.TestColumnAliasConversion.testInvalidNestedProjection(TestColumnAliasConversion.java:170)
Caused by: org.apache.pig.impl.plan.PlanValidationException: ERROR 2271: Logical plan invalid state: invalid uid -1 in schema : invalidName#-1:bytearray
	at org.apache.pig.newplan.logical.optimizer.SchemaResetter.validate(SchemaResetter.java:243)
	at org.apache.pig.newplan.logical.optimizer.SchemaResetter.visit(SchemaResetter.java:195)
	at org.apache.pig.newplan.logical.relational.LOLimit.accept(LOLimit.java:79)
	at org.apache.pig.newplan.DependencyOrderWalker.walk(DependencyOrderWalker.java:75)
	at org.apache.pig.newplan.logical.optimizer.SchemaResetter.visit(SchemaResetter.java:114)
	at org.apache.pig.parser.LogicalPlanBuilder.buildForeachOp(LogicalPlanBuilder.java:1064)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(d) Then I gave a newuid for this fake field so that the above testcase would again fail at check2.&lt;/p&gt;

&lt;p&gt;(d) is my patch (both v1 and v2).&lt;/p&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16474671" author="rohini" created="Mon, 14 May 2018 19:13:58 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16475271" author="knoguchi" created="Tue, 15 May 2018 04:21:58 +0000"  >&lt;p&gt;Thanks for the review Rohini!&lt;br/&gt;
Committed to trunk.&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12920730" name="pig-5335-v01.patch" size="3708" author="knoguchi" created="Thu, 26 Apr 2018 04:34:22 +0000"/>
                            <attachment id="12923077" name="pig-5335-v02.patch" size="4124" author="knoguchi" created="Fri, 11 May 2018 18:29:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sdh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>