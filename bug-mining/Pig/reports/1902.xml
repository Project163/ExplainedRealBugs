<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-3417] Job fails when skewed join is done on tuple key</title>
                <link>https://issues.apache.org/jira/browse/PIG-3417</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;I&apos;ve attached a test case that fails, but should pass. The test case groups two relations separately, then full-outer joins them on the grouped columns. The test case passes if &quot;using &apos;skewed&apos;&quot; is removed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12663119">PIG-3417</key>
            <summary>Job fails when skewed join is done on tuple key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkollar">N&#225;ndor Koll&#225;r</assignee>
                                    <reporter username="njw45">Nick White</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Aug 2013 00:41:58 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:26 +0000</updated>
                            <resolved>Mon, 19 Dec 2016 20:18:19 +0000</resolved>
                                    <version>0.11.1</version>
                                    <fixVersion>0.17.0</fixVersion>
                    <fixVersion>0.16.1</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15741601" author="nkollar" created="Mon, 12 Dec 2016 10:46:52 +0000"  >&lt;p&gt;Investigated this issue, and it seems, that the problem is with the optimization of the sampling job. When the join key is a composite key, in the sampling job it is getting flattened, but since the secondary key optimizer expects composite keys to be wrapped into tuples, we get classcast exception (this also explains why the query didn&apos;t fail when secondary key optimizer is switched off). I think not flattening the tuples in the sampling job would solve the problem: PartitionSkewedKeys would work on ((key1, key2, ...), (tuple mem size, key count)) format for composite keys, and on (key, (tuple mem size, key count)) format for non-composite key. This way we can apply secondary key optimizer on the sampling job too. Attached a patch, tests in TestSkewedJoin (including Nick&apos;s test case) passed both on MR and on Tez mode, waiting for the result of the entire test suite to make sure it doesn&apos;t break other test cases.&lt;/p&gt;</comment>
                            <comment id="15750855" author="nkollar" created="Thu, 15 Dec 2016 09:13:21 +0000"  >&lt;p&gt;Looks like the patch didn&apos;t break any test, neither in Tez nor in MR mode. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt; what do you think? Could either of you please take a look at my patch? I am interested in your thoughts.&lt;/p&gt;</comment>
                            <comment id="15755776" author="rohini" created="Fri, 16 Dec 2016 23:23:08 +0000"  >&lt;p&gt;Comments:&lt;br/&gt;
   1) &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;PartitionSkewedKeys would work on ((key1, key2, ...), (tuple mem size, key count)) format for composite keys, and on (key, (tuple mem size, key count)) format for non-composite key.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Shouldn&apos;t it be ((key1, key2, ...), tuple mem size, key count) and (key, tuple mem size, key count). Don&apos;t see why we need to have tuple mem size and key count in a tuple. i.e Instead of going from New For Each(true,true)[tuple] to New For Each(false,false)[tuple], you can do New For Each(false,true)[tuple] so that the key is not flattened, but stats is flattened. This will avoid unnecessary increase in size of the sampling data. This will also reduce the number of changes needed in your patch.&lt;br/&gt;
 2) TestTezCompiler/TestMRCompiler which compare plans generated should be failing as the plan has changed. Golden files will have to be changed. You can modify generate = true in test class to easily change them. &lt;br/&gt;
  3) testSkewJoinWithTuples - Please assert the actual output and not just the size. Would be good to have a e2e test added as well for this case.&lt;/p&gt;</comment>
                            <comment id="15757043" author="nkollar" created="Sat, 17 Dec 2016 13:34:38 +0000"  >&lt;p&gt;Thanks Rohini for your comments, I&apos;ll upload a new patch soon.&lt;/p&gt;</comment>
                            <comment id="15759517" author="nkollar" created="Sun, 18 Dec 2016 21:28:03 +0000"  >&lt;p&gt;Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3417&quot; title=&quot;Job fails when skewed join is done on tuple key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3417&quot;&gt;&lt;del&gt;PIG-3417&lt;/del&gt;&lt;/a&gt;_2.patch with these changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;key tuple is not flattened, but statistics are&lt;/li&gt;
	&lt;li&gt;golden files changed accordingly. TestTezCompiler test passed with these changes, and no test failed in TestMRCompiler&lt;/li&gt;
	&lt;li&gt;added an assert for the output to testSkewJoinWithTuples and added an e2e test too&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We might not even need to have testSkewJoinWithTuples, since the e2e tests now cover this case. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt; could you please have have a look at the second version of my patch? &lt;/p&gt;</comment>
                            <comment id="15762008" author="rohini" created="Mon, 19 Dec 2016 19:03:48 +0000"  >&lt;p&gt;+1. Thanks for the changes. The patch is lot simpler with this. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We might not even need to have testSkewJoinWithTuples, since the e2e tests now cover this case. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Yes. That should be fine as it is kind of doing exactly what the e2e is doing even for verification. If it was local mode+ mock.Storage combo  it would have taken less time, but this one would take more than a minute. Considering that, will skip the unit test while checking in. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=njw45&quot; class=&quot;user-hover&quot; rel=&quot;njw45&quot;&gt;njw45&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;,&lt;br/&gt;
   Do you want this to go into 0.16.1 as well? &lt;/p&gt;</comment>
                            <comment id="15762054" author="nkollar" created="Mon, 19 Dec 2016 19:18:18 +0000"  >&lt;p&gt;Thanks Rohini, I agree, let&apos;s leave the unit test out, and commit just the e2e test. Also, &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-5069&quot; title=&quot;Skewed Join is crashing job&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-5069&quot;&gt;&lt;del&gt;PIG-5069&lt;/del&gt;&lt;/a&gt; seems to be the same issue, at least based on the provided information: it fails with classcastexception, the script does a skew join on tuple keys, and Carlos told that without skew join it was fine. Given this, do you think that we can close that item as duplicate of this Jira?&lt;/p&gt;</comment>
                            <comment id="15762062" author="rohini" created="Mon, 19 Dec 2016 19:21:11 +0000"  >&lt;p&gt;Done. I will also commit this into 0.16.1 considering that there are more users facing it.&lt;/p&gt;</comment>
                            <comment id="15762077" author="daijy" created="Mon, 19 Dec 2016 19:29:22 +0000"  >&lt;p&gt;Yes, bug fix is ok to backport.&lt;/p&gt;</comment>
                            <comment id="15762189" author="rohini" created="Mon, 19 Dec 2016 20:17:51 +0000"  >&lt;p&gt;+1. Committed to both branch-0.16 and trunk. Thanks Nandor for fixing this.&lt;/p&gt;

&lt;p&gt;Attached is the final patch that was committed. It has the unit test removed and also tabs changed to spaces in nightly.conf from the previous patch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13023590">PIG-5069</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12843943" name="PIG-3417-3.patch" size="10094" author="rohini" created="Mon, 19 Dec 2016 20:17:51 +0000"/>
                            <attachment id="12842779" name="PIG-3417.patch" size="9366" author="nkollar" created="Mon, 12 Dec 2016 10:47:27 +0000"/>
                            <attachment id="12843765" name="PIG-3417_2.patch" size="13174" author="nkollar" created="Sun, 18 Dec 2016 21:22:00 +0000"/>
                            <attachment id="12597391" name="TestSkewJoinWithTuples.java" size="2383" author="njw45" created="Mon, 12 Aug 2013 00:43:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343120</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 48 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n68n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343424</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>