<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:01:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4722] [Pig on Tez] NPE while running Combiner</title>
                <link>https://issues.apache.org/jira/browse/PIG-4722</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;DefaultSorter in Tez calls Combiner from two different threads - during spill in SpillThread and flush in the main thread. If both run the combiner, one ends up with NPE as Reporter is set on only one thread in initialization. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.getNext(PhysicalOperator.java:366)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.relationalOperators.POLocalRearrange.getNextTuple(POLocalRearrange.java:332)
        at org.apache.pig.backend.hadoop.executionengine.tez.plan.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.POLocalRearrangeTez.getNextTuple(POLocalRearrangeTez.java:128)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.processOnePackageOutput(PigCombiner.java:197)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.reduce(PigCombiner.java:175)
        at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigCombiner$Combine.reduce(PigCombiner.java:50)
        at org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:171)
        at org.apache.tez.mapreduce.combine.MRCombiner.runNewCombiner(MRCombiner.java:191)
        at org.apache.tez.mapreduce.combine.MRCombiner.combine(MRCombiner.java:115)
        at org.apache.tez.runtime.library.common.sort.impl.ExternalSorter.runCombineProcessor(ExternalSorter.java:279)
        at org.apache.tez.runtime.library.common.sort.impl.dflt.DefaultSorter.spill(DefaultSorter.java:854)
        at org.apache.tez.runtime.library.common.sort.impl.dflt.DefaultSorter.sortAndSpill(DefaultSorter.java:780)
        at org.apache.tez.runtime.library.common.sort.impl.dflt.DefaultSorter$SpillThread.run(DefaultSorter.java:708)
Caused by: java.lang.NullPointerException
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.processInput(PhysicalOperator.java:303)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POProject.getNextTuple(POProject.java:403)
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.PhysicalOperator.getNext(PhysicalOperator.java:361)
        ... 12 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12909375">PIG-4722</key>
            <summary>[Pig on Tez] NPE while running Combiner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Sat, 31 Oct 2015 02:00:35 +0000</created>
                <updated>Wed, 8 Jun 2016 20:48:19 +0000</updated>
                            <resolved>Fri, 13 Nov 2015 19:28:26 +0000</resolved>
                                                    <fixVersion>0.16.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14999082" author="rohini" created="Tue, 10 Nov 2015 18:33:44 +0000"  >&lt;p&gt;Actually my initial analysis was incorrect. Combiner  is called multiple times from SpillThread and also called from ExternalSorter.flush() which is a different thread. But setup(),reduce() and cleanup() is always called as a batch everytime, so there is no cross thread issue there with initialization or cleanup. The actual problem was PigProcessor.close() was being called when spill thread was still running combiner. So even though PhysicalOperator.java had a getReporter() != null check, it became null when calling getReporter().progress() as PigProcessor.close() was resetting it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getReporter() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                getReporter().progress();
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Need to ensure that PigProcessor.close does not cleanup static data when Combiner is running.&lt;/p&gt;</comment>
                            <comment id="15001340" author="rohini" created="Wed, 11 Nov 2015 23:39:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt; as discussed, can you check with the tez folks - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bikassaha&quot; class=&quot;user-hover&quot; rel=&quot;bikassaha&quot;&gt;bikassaha&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hitesh&quot; class=&quot;user-hover&quot; rel=&quot;hitesh&quot;&gt;hitesh&lt;/a&gt;, whether they can call processor.close() in LogicalIOProcessRunTimeTask.java at the very end after the inputs and outputs are done and closed.&lt;/p&gt;

&lt;p&gt;Meanwhile will go with a hacky patch to not do anything in Processor.close() if combiner is running at the time and do the cleanup in the combiner cleanup(). If we don&apos;t have Tez APIs to deal with cleanup at the very end, we need to think of cleaner solution and rethink the whole way we use ThreadLocal&apos;s to work with local mode.&lt;/p&gt;</comment>
                            <comment id="15004307" author="rohini" created="Fri, 13 Nov 2015 17:09:56 +0000"  >&lt;p&gt;Attached patch just fixes the NPE and avoids additional threadlocal call.  This is assuming that moving of PigProcessor.close() in &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-2937&quot; title=&quot;Can Processor.close() be called after closing inputs and outputs?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-2937&quot;&gt;&lt;del&gt;TEZ-2937&lt;/del&gt;&lt;/a&gt; will avoid cleanup being done when SpillThread is running combiner.  If &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-2937&quot; title=&quot;Can Processor.close() be called after closing inputs and outputs?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-2937&quot;&gt;&lt;del&gt;TEZ-2937&lt;/del&gt;&lt;/a&gt; introduces a new API then will have another patch depending on that.&lt;/p&gt;</comment>
                            <comment id="15004552" author="daijy" created="Fri, 13 Nov 2015 19:24:10 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15004564" author="rohini" created="Fri, 13 Nov 2015 19:28:26 +0000"  >&lt;p&gt;Committed to trunk. Thanks for the review Daniel.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12912356">TEZ-2937</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12772239" name="PIG-4722-1.patch" size="738" author="rohini" created="Fri, 13 Nov 2015 17:09:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nrsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>