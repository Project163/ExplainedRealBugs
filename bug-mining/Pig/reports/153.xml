<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:49:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-645] Streaming is broken with the latest trunk</title>
                <link>https://issues.apache.org/jira/browse/PIG-645</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Several tests we run are failing now&lt;/p&gt;</description>
                <environment></environment>
        <key id="12413506">PIG-645</key>
            <summary>Streaming is broken with the latest trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pkamath">Pradeep Kamath</assignee>
                                    <reporter username="olgan">Olga Natkovich</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Jan 2009 02:07:48 +0000</created>
                <updated>Wed, 24 Mar 2010 22:04:17 +0000</updated>
                            <resolved>Fri, 30 Jan 2009 02:14:28 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12668703" author="pkamath" created="Fri, 30 Jan 2009 01:47:05 +0000"  >&lt;p&gt;Attached patch to fix the issues with streaming. The root cause of the issue was the changes introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-629&quot; title=&quot;PERFORMANCE: Eliminate use of TargetedTuple for each input tuple in the map()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-629&quot;&gt;&lt;del&gt;PIG-629&lt;/del&gt;&lt;/a&gt; (PERFORMANCE: Eliminate use of TargetedTuple for each input tuple in the map()) caused a race condition on the input tuple in the map() between recordReader.next(Tuple value) and the streaming binary.&lt;/p&gt;

&lt;p&gt;BEFORE &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-629&quot; title=&quot;PERFORMANCE: Eliminate use of TargetedTuple for each input tuple in the map()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-629&quot;&gt;&lt;del&gt;PIG-629&lt;/del&gt;&lt;/a&gt;, the flow of a tuple from record reader to map was as follows:&lt;br/&gt;
The recordReader instance gets the &lt;b&gt;same&lt;/b&gt; TargetedTuple object reference in every next(TargetedTuple value) call (this is because Hadoop reuses the value object for each recordReader.next(value) call). The recordReader.next(value) call inturn calls PigSlice.next(Tuple value) which has the following implementation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; next(Tuple value) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        Tuple t = loader.getNext();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        value.reference(t);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here value.reference(t) calls the TargetedTuple.reference(Tuple) method which simply stores the supplied the tuple in its member Tuple variable &quot;t&quot;. &lt;/p&gt;

&lt;p&gt;In PigMapBase.map(), the toTuple() method on the input TargetedTuple is called which returns the above store tuple reference &quot;t&quot;. This reference is then attached to the roots of the map plan. &lt;/p&gt;

&lt;p&gt;The point to note is this final tuple reference which is used by the operators in the map plan is the reference to the tuple returned from the loader and not the reference to the TargetedTuple which we get from the recordReader and which is supplied as an argument to the map() call. The loader creates a new tuple reference on each getNext(). This guarantees that the operators in the map plan always work with a differnt tuple reference on each map() call though the TargetedTuple reference supplied in the map() is the same and reused by Hadoop.&lt;/p&gt;

&lt;p&gt;AFTER &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-629&quot; title=&quot;PERFORMANCE: Eliminate use of TargetedTuple for each input tuple in the map()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-629&quot;&gt;&lt;del&gt;PIG-629&lt;/del&gt;&lt;/a&gt;, the flow changed as follows:&lt;br/&gt;
TargetedTuple was removed and Tuple was used instead. The PigSlice.next(Tuple value) code remained intact. However DefaultTuple.reference(Tuple) call in it assigns the internal mFields arraylist to the arraylist of the supplied tuple. Note that here the internal member arraylist of the DefaultTuple is changed to &quot;refer&quot; to the internal arraylist of the Tuple the loader gives. &lt;br/&gt;
In map(), the tuple which is supplied as input argument to the map() call is attached directly to the roots. So in the case of streaming, this tuple is finally supplied to the binary by using a storage function (PigStorage by default). However this tuple refernce is the same as the one which gets reused by hadoop in the next recordReader.next(value) call. So while the storage function is in the process of writing the current Tuple&apos;s contents (the mFields arraylist), it can get changed underneath due to recordReader.next(value) call. So unless the storage functions writes to the binary&apos;s stdin BEFORE the next recordReader.next(value) call, the input sent to the Binary will be garbled.&lt;/p&gt;

&lt;p&gt;The fix is the following one line change:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;         for (PhysicalOperator root : roots) {
-            root.attachInput(inpTuple);
+            root.attachInput(tf.newTupleNoCopy(inpTuple.getAll()));
         }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In map(), instead of attaching the inpTuple directly to the roots of the plan, a new Tuple is created which refers to the same mFields arrayList as in inpTuple. With this change, all operators in the map plan, now work on a different Tuple reference from the one which is supplied in the map() argument (and which is reused by Hadoop). This reference will refer to the mFields of the Tuple returned from the loader which is guaranteed to be a new arraylist for each input tuple since the loader creates a new Tuple each time. &lt;/p&gt;</comment>
                            <comment id="12668707" author="olgan" created="Fri, 30 Jan 2009 01:55:28 +0000"  >&lt;p&gt;+1, please, commit&lt;/p&gt;</comment>
                            <comment id="12668712" author="pkamath" created="Fri, 30 Jan 2009 02:12:36 +0000"  >&lt;p&gt;Patch committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12399084" name="PIG-645.patch" size="615" author="pkamath" created="Fri, 30 Jan 2009 01:47:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164232</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gmo7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95103</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>