<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:48:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-285] custom compare functions is ignored</title>
                <link>https://issues.apache.org/jira/browse/PIG-285</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;The following query successfully runs but the results don&apos;t come in the correct order:&lt;/p&gt;

&lt;p&gt;a = load &apos;studenttab10k&apos;;&lt;br/&gt;
c = order a by $0 using org.apache.pig.test.udf.orderby.OrdDesc;&lt;br/&gt;
store c into ;out&apos;;&lt;/p&gt;

&lt;p&gt;results:&lt;/p&gt;

&lt;p&gt;alice allen     27      1.950&lt;br/&gt;
alice allen     42      2.460&lt;br/&gt;
alice allen     38      0.810&lt;br/&gt;
alice allen     68      3.390&lt;br/&gt;
alice allen     77      2.520&lt;br/&gt;
alice allen     36      2.270&lt;br/&gt;
.....&lt;/p&gt;

&lt;p&gt;expcted:&lt;/p&gt;

&lt;p&gt;zach zipper     66      2.670&lt;br/&gt;
zach zipper     47      2.920&lt;br/&gt;
zach zipper     19      1.910&lt;br/&gt;
zach zipper     23      1.120&lt;br/&gt;
zach zipper     40      2.030&lt;br/&gt;
zach zipper     59      2.530&lt;br/&gt;
.....&lt;/p&gt;</description>
                <environment></environment>
        <key id="12399476">PIG-285</key>
            <summary>custom compare functions is ignored</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sms">Santhosh Muthur Srinivasan</assignee>
                                    <reporter username="olgan">Olga Natkovich</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Jul 2008 20:36:11 +0000</created>
                <updated>Wed, 24 Mar 2010 22:04:02 +0000</updated>
                            <resolved>Wed, 30 Jul 2008 15:57:51 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12611340" author="shravanmn" created="Mon, 7 Jul 2008 20:48:42 +0000"  >&lt;p&gt;Can you provide the comparison function, org.apache.pig.test.udf.orderby.OrdDesc please?&lt;/p&gt;</comment>
                            <comment id="12611345" author="olgan" created="Mon, 7 Jul 2008 20:55:38 +0000"  >&lt;p&gt;package org.apache.pig.test.udf.orderby;&lt;/p&gt;

&lt;p&gt;import org.apache.pig.data.Tuple;&lt;br/&gt;
import org.apache.pig.ComparisonFunc;&lt;/p&gt;

&lt;p&gt;public class OrdDesc extends ComparisonFunc {&lt;br/&gt;
    // this is a simple example - more complex comparison will require&lt;br/&gt;
    //   breakout of the individual values. I suggest you&apos;ll have&lt;br/&gt;
    //   to convert &quot;catch(IOException e) to RuntimeException(&apos;msg&apos;, e)&quot;&lt;br/&gt;
    public int compare(Tuple t1, Tuple t2) &lt;/p&gt;
{
        return t2.compareTo(t1);
    }
&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="12611759" author="shravanmn" created="Tue, 8 Jul 2008 19:21:30 +0000"  >&lt;p&gt;I have found the issue. Before describing it let me give some background so that fixing other related issues is simpler:&lt;/p&gt;

&lt;p&gt;The Order by Clause is handled with Quantiles. So a job which has an order by occuring in the main plan is run as multiple jobs:&lt;br/&gt;
1. Store the output till the order by.&lt;br/&gt;
2. Run a quantile job to find the quantiles&lt;br/&gt;
3. Run the sort job.&lt;/p&gt;

&lt;p&gt;The following should be the pig-script version of getQuantileJob in MRCompiler&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A = load fSpec using RandomSampleLoader
B = foreach A generate flatten(col1), flatten(col2), ...
C = group all
D = foreach C {
	D1 = order $1 by *;
	generate requestedParallelism,D1;
}
E = foreach D generate FindQuantiles(*);
store E into quantFiles
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The getSortJob should look something like this&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A = load fSpec using BinStorage
B = group A by (col1,col2,...);
C = foreach B generate flatten(A);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;C should have the output of ORDER BY&lt;/p&gt;

&lt;p&gt;Also, the sort job should have some key things turned on in Hadoop for it to work:&lt;br/&gt;
1. Use the SortPartitioner as the key partitioner which internally uses the quantile file generated by the quantile job&lt;br/&gt;
2. Also supply any user defined comparator to hadoop as the output key comparator&lt;/p&gt;

&lt;p&gt;That is the ideal thing to do. The issue was the following:&lt;br/&gt;
Since the quantile job physical plan was hand crafted, it had the plan for the following instead of what it should have been:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A = load fSpec using RandomSampleLoader
B = foreach A generate flatten(col1), flatten(col2), ...
C = group all
D = foreach C {
	generate requestedParallelism,$1;
}
E = foreach D generate FindQuantiles(*);
store E into quantFiles;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hence instead of the sorted output, all we saw was the grouped output and probably some incorrect results as the quantiles might have got messed if a parallel statement was used along with the order by which is the cause for &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-292&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Pig-292&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The other part was that the user defined comparator was not being passed as the output key comparator which is the cause of the current bug. Another thing that led to us not finding the bug early was an error in the testSort test case which I have corrected in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-295&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Pig-295&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To resolve this issue, first corrected the quantile job to include the order by in the nested plan. However this caused issues with deserializing POUserComparisonFunc which extended from POUserFunc. The issue was because when POUserComparisonFunc was deserialized POUserFunc got deserialized first and tried to instantiate EvalFunc from a ComparisonFunc spec. To resolve this, I had to make POUserComparisonFunc independent of POUserFunc and here I have made the assumption that ComparisonFunc is used only in ORDER BY and not elsewhere. This corresponds to all the extraneous things in the patch.&lt;/p&gt;

&lt;p&gt;The next thing I did was to try to correct the missing supply of user defined comparator to Hadoop as the key comparator. However, this causes issues:&lt;br/&gt;
We assume that ComparisonFunc always compares Tuples. However, with the inclusion of types, we do not always wrap everything into a tuple and instead try to use the basic types wherever possible. The patch I am going to submit does not address this part. The patch will assume that issue with ComparisonFunc will be fixed and directly sets the user defined comparator as the output key comparator. This will for the time being cause all user defined comparisons to fail.&lt;/p&gt;

&lt;p&gt;Some hints on the ComparisonFunc issue:&lt;br/&gt;
1. The soln should take into consideration that sometimes ComparisonFunc are generic and need not know the schema of the input. Ex. OrdDesc&lt;br/&gt;
2. Many a times however, if its not a generic ComparisonFunc, we can assume that schema is known.&lt;br/&gt;
3. The ComparisonFunc will have to work with hadoop types and not pig types as it would be used in the boundary between LR &amp;amp; Pkg&lt;/p&gt;

&lt;p&gt;Currently, ComparisonFunc extends WritableComparator and gives a concrete implementation that delegates all compare(WritableComparable,WritableComparable) calls to compare(Tuple,Tuple). Instead if we leave the compare(WritableComparable,WritableComparable) abstract I feel it should solve the problem and users can provide an implementation of the compare for the type that they are expecting. Will attach a patch shortly.&lt;/p&gt;</comment>
                            <comment id="12612206" author="alangates" created="Wed, 9 Jul 2008 17:59:16 +0000"  >&lt;p&gt;Checked in the sortfin patch.  This addresses some of the sorting issues, but some order by queries still fail.&lt;/p&gt;</comment>
                            <comment id="12612332" author="olgan" created="Thu, 10 Jul 2008 00:21:39 +0000"  >&lt;p&gt;Has this issue been resolved? Can it be closed?&lt;/p&gt;</comment>
                            <comment id="12612606" author="alangates" created="Thu, 10 Jul 2008 18:45:25 +0000"  >&lt;p&gt;No.  Shravan&apos;s patch addressed some but not all of the issues.&lt;/p&gt;</comment>
                            <comment id="12617951" author="sms" created="Tue, 29 Jul 2008 20:56:45 +0000"  >&lt;p&gt;The patch (sort_using_udf.patch) fixes the issue with passing user defined comparators to Hadoop by replacing the Class.forname() call with PigContext.resolveClassName()&lt;/p&gt;

&lt;p&gt;Unit tests that still fail are:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.pig.test.TestBuiltin&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 23, Failures: 1, Errors: 1, Time elapsed: 14.66 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.pig.test.TestBuiltin FAILED&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.pig.test.TestFilterOpNumeric&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 8, Failures: 0, Errors: 1, Time elapsed: 57.662 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.pig.test.TestFilterOpNumeric FAILED&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.pig.test.TestStoreOld&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 3, Failures: 0, Errors: 2, Time elapsed: 39.853 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.pig.test.TestStoreOld FAILED&lt;/p&gt;</comment>
                            <comment id="12618022" author="alangates" created="Wed, 30 Jul 2008 00:45:01 +0000"  >&lt;p&gt;Committed sort_using_udf.patch.  This solved the issue of the script failing saying that it could not find the user provided comparator.  However, the hadoop sort still does not use the user provided comparator.  So I&apos;m returning this bug to the open state until that issue is resolved as well.&lt;/p&gt;</comment>
                            <comment id="12618026" author="sms" created="Wed, 30 Jul 2008 01:04:07 +0000"  >&lt;p&gt;This is what I see when I run it on grunt &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;grunt&amp;gt; ls
hdfs://wilbur20.labs.corp.sp1.yahoo.com:8020/user/sms/data      &amp;lt;dir&amp;gt;

grunt&amp;gt; a = load &apos;data&apos; as (name, age, gpa);

grunt&amp;gt; dump a;
22438 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 0% complete
25315 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 100% complete
27836 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - Completed Successfully
(Joe 20 3.5)
(Harry 20 3.2)
(John 19 3.8)
(Jack 19 3.1)
(Govinda 20 4.0)

grunt&amp;gt; register testudf.jar;

grunt&amp;gt; b = order a by * using org.apache.pig.test.udf.orderby.OrdDesc;

grunt&amp;gt; dump b;
113532 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 0% complete
117077 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 33% complete
121938 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 50% complete
126999 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 66% complete
132339 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 83% complete
137393 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - 100% complete
139418 [main] INFO  org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.MapReduceLauncher  - Completed Successfully
(John 19 3.8)
(Joe 20 3.5)
(Jack 19 3.1)
(Harry 20 3.2)
(Govinda 20 4.0)

grunt&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12618402" author="alangates" created="Wed, 30 Jul 2008 15:57:51 +0000"  >&lt;p&gt;My mistake.  The patch works.  I compared it against the incorrect benchmark.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12387133" name="sort_using_udf.patch" size="893" author="sms" created="Tue, 29 Jul 2008 20:56:45 +0000"/>
                            <attachment id="12385541" name="sortfin.patch" size="23288" author="shravanmn" created="Tue, 8 Jul 2008 21:46:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>38590</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gicv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94404</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>