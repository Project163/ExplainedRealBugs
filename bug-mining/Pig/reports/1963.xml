<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5290] User Cache upload contention can cause job failures</title>
                <link>https://issues.apache.org/jira/browse/PIG-5290</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;We recently enabled the User Cache (&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2672&quot; title=&quot;Optimize the use of DistributedCache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2672&quot;&gt;&lt;del&gt;PIG-2672&lt;/del&gt;&lt;/a&gt;) feature and found that occasionally jobs would fail because of contention when uploading JARs into the cache. Although the cache is designed to be fail-safe, i.e. to fall back to normal behavior if anything goes wrong by catching all &lt;tt&gt;IOException&lt;/tt&gt;, the portion of code which closes the output stream &lt;em&gt;is not&lt;/em&gt; wrapped within a &lt;tt&gt;try&lt;/tt&gt; statement and thus an exception during the closing of that stream causes the entire job to fail. If multiple jobs are attempting to upload the same JAR failure simultaneously, the contention can cause this close statement to fail.&lt;/p&gt;

&lt;p&gt;The current strategy also has two other flaws. First, consider the scenario where job A begins uploading jar X. Job B also needs jar X, sees that the file exists, and launches its tasks. Yet, job A has not yet finished uploading jar X (perhaps it is large). So, the tasks are localizing a half-completed version of jar X. Second, the original design allowed for the same JAR (identical contents) to be shared between jobs even if a different name was used. In &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3815&quot; title=&quot;Hadoop bug causes to pig to fail silently with jar cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3815&quot;&gt;&lt;del&gt;PIG-3815&lt;/del&gt;&lt;/a&gt;, however, this ability was removed, and now JARs are only shared if they have the same name.&lt;/p&gt;

&lt;p&gt;I propose we solve all of these issues simultaneously by returning to the listStatus based behavior (used prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3815&quot; title=&quot;Hadoop bug causes to pig to fail silently with jar cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3815&quot;&gt;&lt;del&gt;PIG-3815&lt;/del&gt;&lt;/a&gt;), but filter out entries ending in &lt;tt&gt;.tmp&lt;/tt&gt;. When uploading, upload to &lt;tt&gt;randomNumber.tmp&lt;/tt&gt;, then once the file is completed, do a rename to the original name of the JAR file. This ensures that incomplete files are never in a location that would be accessed by other jobs, and the only write operation accessing a shared path is a single rename operation.&lt;/p&gt;

&lt;p&gt;An alternative design is to use a single canonicalized name for all JAR files (they will still be unique since they are inside of directories based on their SHA1). Upload to a tmp file as previously described, then rename to the canonical name. This removes the need to do a listStatus call; however it will result in classpaths that are human unreadable since the name of the JAR file has been lost. I think it&apos;s worth it from a debugging standpoint to go with the first design.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13094128">PIG-5290</key>
            <summary>User Cache upload contention can cause job failures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xkrogen">Erik Krogen</assignee>
                                    <reporter username="xkrogen">Erik Krogen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Aug 2017 15:55:29 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:05 +0000</updated>
                            <resolved>Fri, 8 Sep 2017 23:06:05 +0000</resolved>
                                    <version>0.13.0</version>
                                    <fixVersion>0.18.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16123527" author="xkrogen" created="Fri, 11 Aug 2017 16:00:09 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt; from previous involvement with the two JIRAs mentioned in the description.&lt;/p&gt;</comment>
                            <comment id="16125911" author="rohini" created="Mon, 14 Aug 2017 16:20:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xkrogen&quot; class=&quot;user-hover&quot; rel=&quot;xkrogen&quot;&gt;xkrogen&lt;/a&gt;,&lt;br/&gt;
   Using randomNumber.tmp is simple and effective. +1 on the idea. Have added you to the contributors list. You can now assign the jira to yourself if you are going to work on the patch.&lt;/p&gt;</comment>
                            <comment id="16125912" author="xkrogen" created="Mon, 14 Aug 2017 16:22:04 +0000"  >&lt;p&gt;Will do, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16129631" author="xkrogen" created="Wed, 16 Aug 2017 23:47:28 +0000"  >&lt;p&gt;Attaching initial patch implementing the ideas I discussed in the JIRA. Uploads at a random file name, then moves it to the original filename. Uses listStatus to be able to share identical JAR files with nonidentical names. Makes an attempt at cleaning up hanging temp files if an issue occurs while uploading / renaming.&lt;/p&gt;

&lt;p&gt;I did not add any unit tests as it was not very clear to me how to do so / what the policy on that would be. Let me know if I should add some and if so, where they would go. I did manually test the patch on our Hadoop 2.6 cluster and it worked as expected, populating the cache when empty and reusing files when present (even at different names).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;, please let me know if you have a chance to review. Thanks!&lt;/p&gt;</comment>
                            <comment id="16156162" author="rohini" created="Wed, 6 Sep 2017 22:56:34 +0000"  >&lt;p&gt;Few comments:&lt;br/&gt;
  1) Can you compile the Pattern and reuse it instead of calling matches every time? That will be more cost effective.&lt;br/&gt;
  2) If there is still a collision during writing temp file due to random number collision (we have run into the rare scenario where different jobs had random numbers collide during temp dir creation) or renaming to final file name (more likely than first scenario) you will still end up with an error. First case is really rare and so we can skip for now. But we should handle the rename problem by checking for FileAlreadyExistsException in a separate try/catch block and verify there if the existing file size is same as the temp file and if not thrown an error.&lt;br/&gt;
  3) Regarding reverting to the listStatus behavior, I checked &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3815&quot; title=&quot;Hadoop bug causes to pig to fail silently with jar cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-3815&quot;&gt;&lt;del&gt;PIG-3815&lt;/del&gt;&lt;/a&gt;-3.patch and before the change looks like it still did check to see if filename matched.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/pig/blob/c2aedcc66486ddc721a32dc4984547f049aa5541/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java#L1638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/c2aedcc66486ddc721a32dc4984547f049aa5541/src/org/apache/pig/backend/hadoop/executionengine/mapReduceLayer/JobControlCompiler.java#L1638&lt;/a&gt;&lt;br/&gt;
     I don&apos;t think we should be doing the listStatus check you are doing and pick any non-tmp file in that directory. Might end up with wrong file in case of checksum collisions. Comment 1) would be not necessary if listStatus behavior is reverted.&lt;br/&gt;
  4) We generally expect unit tests to be added with every patch. But in this case simulating a race condition is hard, so I would say we can skip and rely on the older tests. But on checking realized that there is no actually no test for this feature. Can you add -Dpig.user.cache.enabled=true to java_params of UdfDistributedCache and MonitoredUDF tests in nightly.conf?&lt;/p&gt;</comment>
                            <comment id="16157592" author="xkrogen" created="Thu, 7 Sep 2017 20:30:15 +0000"  >&lt;p&gt;Thank you for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I see you are right about (3); I missed the line you linked. I can keep it at the old behavior.&lt;/p&gt;

&lt;p&gt;For (2), I agree that there is potential for collision during writing temp file, but figured that since it will fall back to default behavior if it had an error while uploading, this is not too much of an issue (just an extra JAR upload rather than using cache). I don&apos;t understand the &quot;renaming to final file name&quot; issue. Renames on HDFS overwrite, so if two users upload the same simultaneously, one of them will simply win (whoever comes second). Let me know if I am misunderstanding.&lt;/p&gt;

&lt;p&gt;Sounds good on (4), thanks for the pointer.&lt;/p&gt;

&lt;p&gt;Attaching v1 patch addressing your comments in (3), (4), comment in (1) is no longer relevant. Will wait on your response about (2).&lt;/p&gt;</comment>
                            <comment id="16157672" author="rohini" created="Thu, 7 Sep 2017 21:19:57 +0000"  >&lt;p&gt;+1. Looks good. Will run the e2e tests and commit later in the day.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Renames on HDFS overwrite, so if two users upload the same simultaneously, one of them will simply win (whoever comes second). Let me know if I am misunderstanding.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  It was a misunderstanding on my part. I could not exactly remember whether rename wins on overwrite or fails with FileAlreadyExistsException. To confirm, I ended up looking at the javadoc of new rename API which said rename fails if overwrite option is not passed and got mislead by that.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hadoop/blob/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java#L1417-L1451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java#L1417-L1451&lt;/a&gt;&lt;br/&gt;
  Verified that the old API (without the options) behavior is that last one wins and there are no failures on rename if file exists.&lt;/p&gt;</comment>
                            <comment id="16159497" author="rohini" created="Fri, 8 Sep 2017 23:06:05 +0000"  >&lt;p&gt;+1. e2e on both MR and Tez good and verified that files are being used from cache. &lt;/p&gt;

&lt;p&gt;Committed to trunk. Thanks for fixing this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xkrogen&quot; class=&quot;user-hover&quot; rel=&quot;xkrogen&quot;&gt;xkrogen&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16161375" author="xkrogen" created="Mon, 11 Sep 2017 14:44:53 +0000"  >&lt;p&gt;Fantastic, thank you Rohini!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12702048">PIG-3815</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12553182">PIG-2672</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12885902" name="PIG-5290-1.patch" size="5308" author="xkrogen" created="Thu, 7 Sep 2017 20:29:35 +0000"/>
                            <attachment id="12882234" name="PIG-5290.patch" size="5594" author="xkrogen" created="Wed, 16 Aug 2017 23:45:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 10 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ip6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>