<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:04:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5474] Casting error or empty output when as clause is used on a bag with schema not defined</title>
                <link>https://issues.apache.org/jira/browse/PIG-5474</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Ran into an issue with where script that worked with older version of Pig failed on Pig 0.17. It was a regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-2315&quot; title=&quot;Make as clause work in generate&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-2315&quot;&gt;&lt;del&gt;PIG-2315&lt;/del&gt;&lt;/a&gt; adding additional POCast operators when there is an AS clause.&lt;/p&gt;

&lt;p&gt;A script with below lines &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
G = FOREACH F GENERATE a0, org.apache.pig.test.TestFlatten$UDFWithNoOutputSchema(a0, a1, b1, bag1) as bag2;
H = FOREACH G GENERATE a0, FLATTEN(bag2) as (x1:chararray, x2:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;, x3:chararray, x4:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ran into this error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 1075: Received a bytearray from the UDF or Union from two different Loaders. Cannot determine how to convert the bytearray to string &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [x1[-1,-1]]
        at org.apache.pig.backend.hadoop.executionengine.physicalLayer.expressionOperators.POCast.getNextString(POCast.java:1125)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It was not easily reproducible with a simple script and required a sequence of steps for the CastLineageSetter to not be able to set the LoadFunc that will provide the caster on POCast - &lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/newplan/logical/visitor/CastLineageSetter.java#L108-L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/newplan/logical/visitor/CastLineageSetter.java#L108-L112&lt;/a&gt; causing the error in &lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java#L1123-L1125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java#L1123-L1125&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;User trying to rewrite the script by moving the as clause to the UDF statement instead of after FLATTEN, made the script pass. But all the bags produced were empty because casting of the bag ( &lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java#L1824-L1828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java#L1824-L1828&lt;/a&gt; ) swallowed the underlying exception and return null unlike the primitive fields which throw error.&lt;/p&gt;

 &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
G = FOREACH F GENERATE a0, org.apache.pig.test.TestFlatten$UDFWithNoOutputSchema(a0, a1, b1, bag1) as bag2:{t:(a1:chararray, a2:&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;, a3:chararray, a4:&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)};
H = FOREACH G GENERATE a0, FLATTEN(bag2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also realized that this additional POCast has made the processing inefficient in general as it tries to cast everything from bytearray to the type specified in the as clause. If the UDF returned the correct type, lets say Integer the code will still try to typecast to DataByteArray, hit a ClassCastException and then will cast based on the realType  &lt;a href=&quot;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java#L503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/pig/blob/branch-0.17/src/org/apache/pig/backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java#L503&lt;/a&gt;. This is going to add a lot of overhead to processing when there are millions of rows.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13628260">PIG-5474</key>
            <summary>Casting error or empty output when as clause is used on a bag with schema not defined</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="rohini">Rohini Palaniswamy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Sep 2025 22:25:16 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:00 +0000</updated>
                            <resolved>Mon, 8 Sep 2025 21:23:24 +0000</resolved>
                                                    <fixVersion>0.18.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18018516" author="rohini" created="Sat, 6 Sep 2025 00:28:16 +0000"  >&lt;p&gt;Took the safer approach of setting the caster using a DefaultCaster only for the POCast introduced by the ForEachUserSchemaVisitor. It took me a lot of time trying different combinations to get a smaller reproducible script for unit test trying to narrow it down from the lengthy production script which had multiple joins with different dimension tables and group bys before the UDF that returned the bag was used. So did not get much time to debug CastLineageSetter to see why it was not able to find the LoadFunc to use for the POCast and fixing that instead. Also wasn&apos;t that familiar with that portion of the code and did not want to break anything.&lt;/p&gt;</comment>
                            <comment id="18018527" author="rohini" created="Sat, 6 Sep 2025 03:20:16 +0000"  >&lt;p&gt;Attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13078269/13078269_PIG-5474-2.patch&quot; title=&quot;PIG-5474-2.patch attached to PIG-5474&quot;&gt;PIG-5474-2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. Contains change to compare output after sorting in unit tests as they fail in Spark mode with the order being different.&lt;/p&gt;</comment>
                            <comment id="18018876" author="daijy" created="Mon, 8 Sep 2025 17:19:39 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="18018903" author="rohini" created="Mon, 8 Sep 2025 21:23:24 +0000"  >&lt;p&gt;Thanks for the review Daniel. Committed to trunk and 0.18&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13078268" name="PIG-5474-1.patch" size="15839" author="rohini" created="Fri, 5 Sep 2025 22:31:21 +0000"/>
                            <attachment id="13078269" name="PIG-5474-2.patch" size="15857" author="rohini" created="Sat, 6 Sep 2025 03:18:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xkxk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>