<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:02:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5033] MultiQueryOptimizerTez creates bad plan with union, split and FRJoin</title>
                <link>https://issues.apache.org/jira/browse/PIG-5033</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;This script produces incorrect results:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;a = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input1&apos;&lt;/span&gt; as (x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, y:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
&lt;/span&gt;b = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input2&apos;&lt;/span&gt; as (x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, y:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
&lt;/span&gt;u = union a,b;
c = load &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input3&apos;&lt;/span&gt; as (x:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, y:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
&lt;/span&gt;e = filter c by y &amp;gt; 3;
f = filter c by y &amp;lt; 2;
g = join u by x left, e by x using &lt;span class=&quot;code-quote&quot;&gt;&apos;replicated&apos;&lt;/span&gt;;
h = join g by u::x left, f by x using &lt;span class=&quot;code-quote&quot;&gt;&apos;replicated&apos;&lt;/span&gt;;
store h into &lt;span class=&quot;code-quote&quot;&gt;&apos;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/pigoutput&apos;&lt;/span&gt;;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Without the union, or with opt.multiquery=false, or with non-replicated joins, it works as expected.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13006303">PIG-5033</key>
            <summary>MultiQueryOptimizerTez creates bad plan with union, split and FRJoin</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rohini">Rohini Palaniswamy</assignee>
                                    <reporter username="tmwoodruff">Travis Woodruff</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Sep 2016 20:39:54 +0000</created>
                <updated>Wed, 21 Jun 2017 09:15:36 +0000</updated>
                            <resolved>Mon, 31 Oct 2016 15:57:37 +0000</resolved>
                                    <version>0.16.0</version>
                                    <fixVersion>0.17.0</fixVersion>
                    <fixVersion>0.16.1</fixVersion>
                                    <component>tez</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15507768" author="tmwoodruff" created="Tue, 20 Sep 2016 20:55:45 +0000"  >&lt;p&gt;Here&apos;s the DAG plan. I&apos;ve only started testing Tez today, so I&apos;m not very familiar with how these should look, but the fact that both the joins use scope-61 seems a bit suspicious.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Tez vertex scope-55	-&amp;gt;	Tez vertex scope-57,
Tez vertex scope-56	-&amp;gt;	Tez vertex scope-57,
Tez vertex scope-61	-&amp;gt;	Tez vertex scope-57,
Tez vertex scope-57

Tez vertex scope-55
# Plan on vertex
POValueOutputTez - scope-59	-&amp;gt;	 [scope-57]
|
|---a: New For Each(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)[bag] - scope-7
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-2
    |   |
    |   |---Project[bytearray][0] - scope-1
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-5
    |   |
    |   |---Project[bytearray][1] - scope-4
    |
    |---a: Load(file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input1:org.apache.pig.builtin.PigStorage) - scope-0
&lt;/span&gt;Tez vertex scope-56
# Plan on vertex
POValueOutputTez - scope-60	-&amp;gt;	 [scope-57]
|
|---b: New For Each(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)[bag] - scope-15
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-10
    |   |
    |   |---Project[bytearray][0] - scope-9
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-13
    |   |
    |   |---Project[bytearray][1] - scope-12
    |
    |---b: Load(file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input2:org.apache.pig.builtin.PigStorage) - scope-8
&lt;/span&gt;Tez vertex scope-61
# Plan on vertex
c: Split - scope-67
|   |
|   Local Rearrange[tuple]{&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;}(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) - scope-37	-&amp;gt;	 scope-57
|   |   |
|   |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-33
|   |
|   |---e: Filter[bag] - scope-28
|       |   |
|       |   Greater Than[&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;] - scope-31
|       |   |
|       |   |---Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][1] - scope-29
|       |   |
|       |   |---Constant(3) - scope-30
|   |
|   Local Rearrange[tuple]{&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;}(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) - scope-51	-&amp;gt;	 scope-57
|   |   |
|   |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-47
|   |
|   |---f: Filter[bag] - scope-42
|       |   |
|       |   Less Than[&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;] - scope-45
|       |   |
|       |   |---Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][1] - scope-43
|       |   |
|       |   |---Constant(2) - scope-44
|
|---c: New For Each(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)[bag] - scope-24
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-19
    |   |
    |   |---Project[bytearray][0] - scope-18
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-22
    |   |
    |   |---Project[bytearray][1] - scope-21
    |
    |---c: Load(file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input3:org.apache.pig.builtin.PigStorage) - scope-17
&lt;/span&gt;Tez vertex scope-57
# Plan on vertex
h: Store(fakefile:org.apache.pig.builtin.PigStorage) - scope-54
|
|---h: FRJoin[tuple] - scope-48	&amp;lt;-	 scope-61
    |   |
    |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-46
    |   |
    |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-47
    |
    |---g: FRJoin[tuple] - scope-34	&amp;lt;-	 scope-61
        |   |
        |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-32
        |   |
        |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-33
        |
        |---POShuffledValueInputTez - scope-58	&amp;lt;-	 [scope-55, scope-56]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15507776" author="tmwoodruff" created="Tue, 20 Sep 2016 20:58:05 +0000"  >&lt;p&gt;And here&apos;s the plan when I remove the union (which gives correct results). The difference seems to be that it leaves one of the join right-side inputs in a separate vertex.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Tez vertex scope-47	-&amp;gt;	Tez vertex scope-46,Tez vertex scope-51,
Tez vertex scope-51	-&amp;gt;	Tez vertex scope-46,
Tez vertex scope-46

Tez vertex scope-47
# Plan on vertex
c: Split - scope-53
|   |
|   Local Rearrange[tuple]{&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;}(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) - scope-28	-&amp;gt;	 scope-46
|   |   |
|   |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-24
|   |
|   |---e: Filter[bag] - scope-19
|       |   |
|       |   Greater Than[&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;] - scope-22
|       |   |
|       |   |---Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][1] - scope-20
|       |   |
|       |   |---Constant(3) - scope-21
|   |
|   POValueOutputTez - scope-48	-&amp;gt;	 [scope-51]
|
|---c: New For Each(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)[bag] - scope-15
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-10
    |   |
    |   |---Project[bytearray][0] - scope-9
    |   |
    |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-13
    |   |
    |   |---Project[bytearray][1] - scope-12
    |
    |---c: Load(file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input3:org.apache.pig.builtin.PigStorage) - scope-8
&lt;/span&gt;Tez vertex scope-51
# Plan on vertex
Local Rearrange[tuple]{&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;}(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) - scope-42	-&amp;gt;	 scope-46
|   |
|   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-38
|
|---f: Filter[bag] - scope-33
    |   |
    |   Less Than[&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;] - scope-36
    |   |
    |   |---Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][1] - scope-34
    |   |
    |   |---Constant(2) - scope-35
    |
    |---POValueInputTez - scope-52	&amp;lt;-	 scope-47
Tez vertex scope-46
# Plan on vertex
h: Store(fakefile:org.apache.pig.builtin.PigStorage) - scope-45
|
|---h: FRJoin[tuple] - scope-39	&amp;lt;-	 scope-51
    |   |
    |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-37
    |   |
    |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-38
    |
    |---g: FRJoin[tuple] - scope-25	&amp;lt;-	 scope-47
        |   |
        |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-23
        |   |
        |   Project[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;][0] - scope-24
        |
        |---a: New For Each(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)[bag] - scope-7
            |   |
            |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-2
            |   |
            |   |---Project[bytearray][0] - scope-1
            |   |
            |   Cast[&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;] - scope-5
            |   |
            |   |---Project[bytearray][1] - scope-4
            |
            |---a: Load(file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/input1:org.apache.pig.builtin.PigStorage) - scope-0&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15507856" author="tmwoodruff" created="Tue, 20 Sep 2016 21:32:07 +0000"  >&lt;p&gt;Here&apos;s an attempt at a fix. I have no confidence that this is the best (or even right) way to fix.&lt;/p&gt;</comment>
                            <comment id="15543420" author="daijy" created="Mon, 3 Oct 2016 21:05:36 +0000"  >&lt;p&gt;scope-61 definitely cause the issue as we cannot have parallel edges between a pair of vertex. The patch prevent multiquery optimization once detecting replicated join. However, I think the proper fix should detect parallel edges. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rohini&quot; class=&quot;user-hover&quot; rel=&quot;rohini&quot;&gt;rohini&lt;/a&gt;, would you like to take a look?&lt;/p&gt;</comment>
                            <comment id="15582574" author="rohini" created="Mon, 17 Oct 2016 15:43:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tmwoodruff&quot; class=&quot;user-hover&quot; rel=&quot;tmwoodruff&quot;&gt;tmwoodruff&lt;/a&gt;,&lt;br/&gt;
   Sorry. Had to take over the patch as it required little more work. Hope that is fine with you.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daijy&quot; class=&quot;user-hover&quot; rel=&quot;daijy&quot;&gt;daijy&lt;/a&gt;,&lt;br/&gt;
Changes done&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Inside of the union block, was not checking if the output from predecessor was to a scalar or replicate join. It always assumed the input went to POShuffleValueInputTez.&lt;/li&gt;
	&lt;li&gt;Changed TezCompilerUtil.isNonPackageInput to return true only for POFRJoinTez.  We only care about scalars and replicate join and it was returning true for POShuffleValueInputTez (union) as well.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15589538" author="daijy" created="Wed, 19 Oct 2016 18:56:39 +0000"  >&lt;p&gt;Didn&apos;t reason about the code change but the plan looks right, and test cases are proper. +1.&lt;/p&gt;</comment>
                            <comment id="15622551" author="rohini" created="Mon, 31 Oct 2016 15:57:37 +0000"  >&lt;p&gt;Committed to branch-0.16 and trunk. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tmwoodruff&quot; class=&quot;user-hover&quot; rel=&quot;tmwoodruff&quot;&gt;tmwoodruff&lt;/a&gt; for tracking down the issue and the patch. Thanks Daniel for the review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12833753" name="PIG-5033-2.patch" size="20545" author="rohini" created="Mon, 17 Oct 2016 15:43:42 +0000"/>
                            <attachment id="12829456" name="PIG-5033.patch" size="12665" author="tmwoodruff" created="Tue, 20 Sep 2016 21:30:29 +0000"/>
                            <attachment id="12829453" name="input1" size="8" author="tmwoodruff" created="Tue, 20 Sep 2016 21:29:33 +0000"/>
                            <attachment id="12829454" name="input2" size="8" author="tmwoodruff" created="Tue, 20 Sep 2016 21:29:33 +0000"/>
                            <attachment id="12829455" name="input3" size="20" author="tmwoodruff" created="Tue, 20 Sep 2016 21:29:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33v1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>