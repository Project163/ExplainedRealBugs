<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:03:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-5328] expressionOperator Divide.equalsZero(DataType.BIGDECIMAL) is invalid</title>
                <link>https://issues.apache.org/jira/browse/PIG-5328</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Divide.equalsZero(DataType.BIGDECIMAL) is flawed in that it uses an invalid test for&#160;== ZERO&#160;in the case of BigDecimal.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;./physicalLayer/expressionOperators/Divide.java tests the divisor for zero in order to avoid DivideByZero.&lt;/p&gt;

&lt;p&gt;The test is performed using a method equalsZero(...)&lt;/p&gt;

&lt;p&gt;Divide.equalsZero() is given &apos;protected&apos; access, but I could not find other references ... should be &apos;private&apos;&lt;/p&gt;

&lt;p&gt;equalsZero() implementation dispatches on dataType to type-specific predicates ... the BigDecimal implementation is incorrect&#160;&lt;/p&gt;

&lt;p&gt;The method BigDecimal.equals(other) is intended to be used for object equality, not numerical equality. (Their justification is that equals() is used in hash-table lookups in java Collections.) BigDecimal numbers are not normalized and scale is an important attribute. Scale is included in BigDecimal.equals(). The values &quot;0&quot; and &quot;0.00&quot; have different scales and are not considered &quot;equals()&quot;&lt;/p&gt;

&lt;p&gt;Comparisons for numeric equality need to be done using compareTo()&lt;/p&gt;

&lt;p&gt;In the special case of comparing to zero, BigDecimal.signum() is the best.&#160;&lt;/p&gt;

&lt;p&gt;The current code is&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160; &#160; case DataType.BIGDECIMAL:&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; &#160; &#160; &#160; &#160; &#160; return BigDecimal.ZERO.equals((BigDecimal) a);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;needs to be changed to&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160; &#160; case DataType.BIGDECIMAL:&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; &#160; &#160; &#160; &#160; &#160; return ((BigDecimal) a).signum() == 0;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;pig source HEAD as of Jan 2018 ... probably goes all the way back to initial implementation of BigDecimal support&lt;/p&gt;</environment>
        <key id="13131669">PIG-5328</key>
            <summary>expressionOperator Divide.equalsZero(DataType.BIGDECIMAL) is invalid</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="michaelthoward">Michael Howard</assignee>
                                    <reporter username="michaelthoward">Michael Howard</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Jan 2018 19:21:19 +0000</created>
                <updated>Mon, 15 Sep 2025 11:29:01 +0000</updated>
                            <resolved>Sat, 27 Jan 2018 04:18:48 +0000</resolved>
                                    <version>0.16.0</version>
                    <version>0.17.0</version>
                                    <fixVersion>0.18.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="800"/>
                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="12" backgroundColor="#89afd7"/>
                                                    <row percentage="88" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="12" backgroundColor="#89afd7"/>
                                                    <row percentage="88" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="900">0.25h</timeoriginalestimate>
                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="16329483" author="michaelthoward" created="Wed, 17 Jan 2018 21:13:20 +0000"  >&lt;p&gt;Context/background:&lt;/p&gt;

&lt;p&gt;BigDecimal is difficult to work with.&lt;/p&gt;

&lt;p&gt;I did not see references in the pig documentation to how BigDecimal issues of precision, scale, and RoundingMode are handled for the pig &apos;bigdecimal&apos; data type. So I specifically went looking at the Divide code to see how the pig implementation addressed these issues. I observed that the divide operation is performed with a min of 6 digits of scale to the right of the decimal point and RoundingMode.HALF_UP. (Arguably, RoundingMode.HALF_EVEN would have been the preferred choice.)&lt;/p&gt;

&lt;p&gt;I stumbled on the equalsZero() code and got somewhat nervous when I saw that it used BigDecimal.equals(). The behavior of BigDecimal.equals() is pretty fundamental to the understanding and proper usage of the BigDecimal API. The fact that the equalsZero() code was written this way is a strong indication that the implementor had very little exposure/experience with the BigDecimal package.&#160;&lt;/p&gt;

&lt;p&gt;I am not familiar with the pig code, but I will try to help.&#160;&lt;/p&gt;</comment>
                            <comment id="16329496" author="michaelthoward" created="Wed, 17 Jan 2018 21:23:26 +0000"  >&lt;p&gt;same problem ... use of of BigDecimal.ZERO.equals(BigDecimal) also exists in&lt;/p&gt;

&lt;p&gt;expressionOperators/POCast.java - lines 471 &amp;amp; 1434&lt;/p&gt;

&lt;p&gt;data/DataType.java - line 665&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;$ find . -name &amp;#42;.java | xargs grep --line-number ZERO\.equals&amp;#40; | grep -i decimal&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;./backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java:471:&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; res.result = Boolean.valueOf(!BigDecimal.ZERO.equals((BigDecimal)res.result));&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;./backend/hadoop/executionengine/physicalLayer/expressionOperators/POCast.java:1434:&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; result = Boolean.valueOf(!BigDecimal.ZERO.equals((BigDecimal)obj));&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;./backend/hadoop/executionengine/physicalLayer/expressionOperators/Divide.java:113:&#160; &#160; &#160; &#160; &#160; &#160; return BigDecimal.ZERO.equals((BigDecimal) a);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;./data/DataType.java:665:&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; return Boolean.valueOf(!BigDecimal.ZERO.equals(((BigDecimal) o)));&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;{{$ }}&lt;/p&gt;</comment>
                            <comment id="16329527" author="michaelthoward" created="Wed, 17 Jan 2018 21:49:30 +0000"  >&lt;p&gt;References to RoundingMode in:&lt;/p&gt;

&lt;p&gt;./builtin/FloatRoundTo.java&lt;/p&gt;

&lt;p&gt;./builtIn/ROUND_TO.java&lt;/p&gt;

&lt;p&gt;/builtin/DoubleRoundTo.java&lt;/p&gt;

&lt;p&gt;all look OK to me.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Although ideally one would not convert back to a (binary float) double&#160; after generating a (decimal float) BigDecimal with specific scale.&amp;#93;&lt;/span&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16329551" author="knoguchi" created="Wed, 17 Jan 2018 22:04:25 +0000"  >&lt;p&gt;Thanks for your feedback&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michaelthoward&quot; class=&quot;user-hover&quot; rel=&quot;michaelthoward&quot;&gt;michaelthoward&lt;/a&gt;!&#160;&lt;/p&gt;

&lt;p&gt;Please let me know if you want to contribute here as a patch OR I can try to come up with a patch following your suggestion and you can tell me if I&apos;m doing it right.&#160;&lt;/p&gt;</comment>
                            <comment id="16329867" author="michaelthoward" created="Thu, 18 Jan 2018 01:41:07 +0000"  >&lt;p&gt;I have gone through all pig source files in the following:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;$ pwd&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;snip&amp;#93;&lt;/span&gt;/pig/src/org/apache/pig&lt;/tt&gt;&lt;tt&gt;$ find . -name &amp;#42;.java | xargs grep -l BigDecimal &amp;gt;foo&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I did not identify any other issues with BigDecimal other than the .equals() problem.&#160;&lt;/p&gt;</comment>
                            <comment id="16329904" author="knoguchi" created="Thu, 18 Jan 2018 02:42:39 +0000"  >&lt;p&gt;Thanks again Michael.  Assigning the jira to you.&lt;br/&gt;
Let us know if you need help in preparing a patch.&lt;/p&gt;</comment>
                            <comment id="16331038" author="michaelthoward" created="Thu, 18 Jan 2018 19:27:42 +0000"  >&lt;p&gt;&amp;gt;&#160;Let us know if you need help in preparing a patch.&lt;/p&gt;

&lt;p&gt;I may well need some help ... will be my first time submitting a patch in many years.&#160;&lt;/p&gt;

&lt;p&gt;Will advise if I get stuck.&#160;&lt;/p&gt;</comment>
                            <comment id="16338077" author="michaelthoward" created="Wed, 24 Jan 2018 19:03:34 +0000"  >&lt;p&gt;TestDivide unit test updated&lt;/p&gt;

&lt;p&gt;BigDecimal.signum() == 0 now used to test for values numerically equal to zero.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16340497" author="knoguchi" created="Fri, 26 Jan 2018 02:51:32 +0000"  >&lt;p&gt;Thanks Michael!  +1 on the patch.&lt;br/&gt;
Confirmed your testcase for divide-0 fails without your changes and works after the change.&lt;/p&gt;

&lt;p&gt;Also, I see that &lt;tt&gt;TestPOCast.java&lt;/tt&gt; is missing &lt;tt&gt;testBigDecimalToOther&lt;/tt&gt; test method which would have been a good place to add the testing for typecasting BigDecimal to boolean.  I can create a new jira for that.&lt;/p&gt;

&lt;p&gt;I&apos;ll commit your patch tomorrow.&lt;/p&gt;</comment>
                            <comment id="16341940" author="knoguchi" created="Sat, 27 Jan 2018 04:18:48 +0000"  >&lt;p&gt;Committed to trunk (0.18).  &lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michaelthoward&quot; class=&quot;user-hover&quot; rel=&quot;michaelthoward&quot;&gt;michaelthoward&lt;/a&gt; for your contribution! &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12907541" name="patchPig5328-take01.patch" size="3789" author="michaelthoward" created="Wed, 24 Jan 2018 19:04:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p107:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>the division operator checks for a zero denominator to prevent a divide-by-zero exception. Unlike other numeric types, BigDecimal has multiple representations of zero with different scales ... 0, 0.0, 0.00, etc. Previous versions of pig were were not properly detecting zero values with non-zero scales when performing denominator check prior to division. </customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>