<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:49:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-350] PERFORMANCE: Join optimization for pipeline rework</title>
                <link>https://issues.apache.org/jira/browse/PIG-350</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;Currently, joins in pig are done as groupings where each input is grouped on the join key.  In the reduce phase, records from each input are collected into a bag for each key, and then a cross product done on these bags.  This can be optimized by selecting one (hopefully the largest) input and streaming through it rather than placing the results in a bag.  This will result in better memory usage, less spills to disk due to bag overflow, and better performance.  Ideally, the system would intelligently select which input to stream, based on a histogram of value distributions for the keys.  Pig does not have that kind of metadata.  So for now it is best to always pick the same input (first or last) so that the user can select which input to stream.&lt;/p&gt;

&lt;p&gt;Similarly, order by in pig is done in this same way, with the grouping keys being the ordering keys, and only one input.  In this case pig still currently collects all the records for a key into a bag, and then flattens the bag.  This is a total waste, and in some cases causes significant performance degradation.  The same optimization listed above can address this case, where the last bag (in this case the only bag) is streamed rather than collected.&lt;/p&gt;

&lt;p&gt;To do these operations, a new POJoinPackage will be needed.  It will replace POPackage and the following POForEach in these types of scripts, handling pulling the records from hadoop and streaming them into the pig pipeline.  A visitor will need to be added in the map reduce compilation phase that detects this case and combines the POPackage with POForeach into this new POJoinPackage.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12401432">PIG-350</key>
            <summary>PERFORMANCE: Join optimization for pipeline rework</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pkamath">Pradeep Kamath</assignee>
                                    <reporter username="gates">Alan Gates</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Jul 2008 18:51:22 +0000</created>
                <updated>Wed, 24 Mar 2010 22:04:05 +0000</updated>
                            <resolved>Tue, 4 Nov 2008 01:46:23 +0000</resolved>
                                    <version>0.2.0</version>
                                    <fixVersion>0.2.0</fixVersion>
                                    <component>impl</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12620448" author="daijy" created="Wed, 6 Aug 2008 22:01:41 +0000"  >&lt;p&gt;Here are some notes for this patch:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The criteria for join optimization&lt;br/&gt;
   a. POPackage-&amp;gt;POForEach is the root of reduce plan&lt;br/&gt;
   b. POUnion is the leaf of map plan (so that we exclude distinct, sort...)&lt;br/&gt;
   c. No combiner plan&lt;br/&gt;
   d. POForEach nested plan only contains POProject in any depth&lt;br/&gt;
   e. Inside POForEach, all occurrences of the first input are flattened&lt;/li&gt;
	&lt;li&gt;If the MR plan is not eligible for optimization, everything stay the same&lt;/li&gt;
	&lt;li&gt;The first alias in cogroup statement is the one we are going to stream.&lt;/li&gt;
	&lt;li&gt;In optimization case, we will change the output key format for map-reduce, originally it is (key, IndexedTuple), now it is ((old_key, index), IndexedTuple)&lt;/li&gt;
	&lt;li&gt;Here is the layout for patitioner, comparator for new key
	&lt;ul&gt;
		&lt;li&gt;Partition key: (old_key, index)&lt;/li&gt;
		&lt;li&gt;OutputKeyComparator: by old_key + reverse index&lt;/li&gt;
		&lt;li&gt;OutputValueGroupingComparator: by old_key&lt;br/&gt;
   With this layout, we get&lt;/li&gt;
	&lt;/ul&gt;
	&lt;ol&gt;
		&lt;li&gt;If two inputs share the same old_key, they go to the same reducer&lt;/li&gt;
		&lt;li&gt;For every old_key, reduce function is called once&lt;/li&gt;
		&lt;li&gt;Values iterator are sorted on reverse index order, so that we can materialize n-1 inputs, then stream the first input&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Implementation detail for POJoinPackage:&lt;br/&gt;
   a. For every tuple in the first input, combine it with materialized n-1 inputs, feed to delegated ForEach operator&lt;br/&gt;
   b. Call getNext on ForEach until nothing available, then feed the next tuple&lt;br/&gt;
   c. Maintain internal status, since we feed POJoinPackage once, and then call getNext multiple times&lt;/li&gt;
	&lt;li&gt;For performance reason, I use a byte level comparator for OutputKeyComparator, there is no byte level comparator for partitioner and OutputValueGroupingComparator in hadoop probably because OutputKeyComparator is more critical than others. While OutputValueGroupingComparator and partitioner is called one tuple a time, OutputKeyComparator is called more frequently&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;Possible improvement:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;User is able to give a hint for which alias to use for stream, we can change OutputKeyComparator to implement it easily&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="12620469" author="alangates" created="Wed, 6 Aug 2008 22:56:40 +0000"  >&lt;p&gt;Comments:&lt;/p&gt;

&lt;p&gt;1. In PigTupleReverseOrderWritableComarator and PigTupleReverseOrderWritableGroupComarator it looks to me like you&apos;re assuming that tuples from a cogroup only have one field from each.  But that may not be the case if there are multiple columns in the cogroup statement, such as:&lt;/p&gt;

&lt;p&gt;C = cogroup A by ($0, $1), B by ($1, $2)&lt;/p&gt;

&lt;p&gt;2. In JoinOptimizationVisitor where you remove the POPackage and POForeach and replace it with POJoinPackage, you should use OperatorPlan.replace to remove the POForeach and add the POJoinPackage.  This will preserve any ordering in the graph that might be lost otherwise.&lt;/p&gt;</comment>
                            <comment id="12620487" author="daijy" created="Thu, 7 Aug 2008 00:28:41 +0000"  >&lt;p&gt;In response to Alan&apos;s comments:&lt;br/&gt;
1. Tested with multiple key cases, works fine&lt;br/&gt;
2. Changed the patch to use OperatorPlan.replace instead of remove and then add&lt;/p&gt;</comment>
                            <comment id="12620670" author="olgan" created="Thu, 7 Aug 2008 16:51:29 +0000"  >&lt;p&gt;the patch looks good to me&lt;/p&gt;</comment>
                            <comment id="12620728" author="alangates" created="Thu, 7 Aug 2008 19:44:41 +0000"  >&lt;p&gt;Cogroups that use inner return wrong results.  Scripts like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;e = cogroup c by $0, d by $0;
f = foreach e generate flatten (c), flatten(d); 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;do fine but scripts like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;c = filter a by age &amp;lt; 20;
e = cogroup c by (name, age), b by (name, age) &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;return wrong results.&lt;/p&gt;</comment>
                            <comment id="12620745" author="daijy" created="Thu, 7 Aug 2008 21:07:27 +0000"  >&lt;p&gt;Try join3.patch&lt;/p&gt;</comment>
                            <comment id="12622127" author="daijy" created="Wed, 13 Aug 2008 07:59:50 +0000"  >&lt;p&gt;Make several changes for performance optimization. &lt;/p&gt;</comment>
                            <comment id="12623490" author="olgan" created="Mon, 18 Aug 2008 23:24:00 +0000"  >&lt;p&gt;Daniel run a large test but the optimized code is still significantly slower. The spill time was about 5 minutes on the old code. He did not measure the read/parse time.&lt;/p&gt;

&lt;p&gt;Without patch: 6:36:0&lt;br/&gt;
With patch: 6:55:25&lt;/p&gt;</comment>
                            <comment id="12624440" author="olgan" created="Thu, 21 Aug 2008 18:06:25 +0000"  >&lt;p&gt;reducing priority since so far we have not been able to figure a way to make this code run efficiently. will revisit later&lt;/p&gt;</comment>
                            <comment id="12625203" author="olgan" created="Sun, 24 Aug 2008 18:05:51 +0000"  >&lt;p&gt;the patch still has performance issues; can&apos;t be applied as is&lt;/p&gt;</comment>
                            <comment id="12641460" author="pkamath" created="Tue, 21 Oct 2008 17:51:09 +0000"  >&lt;p&gt;Submitted patch with modification to Join4.patch&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The last input is now streamed instead of the first input. This is because we now have tuples arriving in package in the order of the index starting from input 0 upto input n. All tuples for a given index (input) arrive before any tuple for the next index.&lt;/li&gt;
	&lt;li&gt;The last input is now sent as a tuple at a time to foreach rather than as a bag containing one tuple at a time&lt;/li&gt;
	&lt;li&gt;A new optimized foreach has been introduced which assumes its input has already been &quot;attached&quot; (which will be the case in the join optimization)&lt;/li&gt;
	&lt;li&gt;In POForeach all data structures (arrays) are now created statically and reused in each getNext() call rather than being re-created on each getNext() call. Likewise the datastructures in POJoinPackage are also created once up front and reused.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12642256" author="daijy" created="Thu, 23 Oct 2008 20:12:05 +0000"  >&lt;p&gt;Glad to see this issue is moving forward. This patch is logically good, and also include several optimization trick. Expect to see performance data. Thanks Pradeep!&lt;/p&gt;</comment>
                            <comment id="12644377" author="pkamath" created="Fri, 31 Oct 2008 17:52:20 +0000"  >&lt;p&gt;Attached new version of the patch with following changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added optimizations in POForeach to store isToBeFlattened arraylist of Booleans to a static array of booleans - this saves on get() calls and on conversions from Boolean to boolean in all the checks for flatten for an input&lt;/li&gt;
	&lt;li&gt;POJoinPackage now sends the last inputs in chunk sizes (default of 1000) which can be changed by the system property &quot;join.biggest.input.chunksize&quot;&lt;/li&gt;
	&lt;li&gt;Rolled back changes in previous patch to reuse data structures (arrays) in POForeach - runs with big data showed that this caused GC overhead issues - the possible explanation for this is that these arrays on reuse go into the old generation of the heap causing the GC more problems to reclaim space&lt;/li&gt;
	&lt;li&gt;tightened the code a little more in POJoinPackage&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12644420" author="alangates" created="Fri, 31 Oct 2008 20:22:07 +0000"  >&lt;p&gt;In general, looks very good.  One question.&lt;/p&gt;

&lt;p&gt;In POForEach you added arrays isToBeFlattenedArray and planLeafOps, which look like copies of the lists isToBeFlattened and planLeaves respectively.  In the comment on isToBeFlattenedArray you say you&apos;re doing this for performance.  I think that&apos;s fine, but why do you still have the lists?  Having two copies of the data seems dangerous, as you&apos;re likely to get out of sync.&lt;/p&gt;</comment>
                            <comment id="12644476" author="pkamath" created="Sat, 1 Nov 2008 00:55:38 +0000"  >&lt;p&gt;New version with above review comment incorporated - now we only have array and no arraylist for the data structures mentioned in the comment.&lt;/p&gt;</comment>
                            <comment id="12644873" author="alangates" created="Tue, 4 Nov 2008 01:46:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-350&quot; title=&quot;PERFORMANCE: Join optimization for pipeline rework&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-350&quot;&gt;&lt;del&gt;PIG-350&lt;/del&gt;&lt;/a&gt;-3.patch checked in.  Thanks to Pradeep and Daniel for all your work on this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12393168" name="PIG-350-2.patch" size="48554" author="pkamath" created="Fri, 31 Oct 2008 17:52:20 +0000"/>
                            <attachment id="12393184" name="PIG-350-3.patch" size="52159" author="pkamath" created="Sat, 1 Nov 2008 00:55:38 +0000"/>
                            <attachment id="12392591" name="PIG-350.patch" size="52320" author="pkamath" created="Tue, 21 Oct 2008 17:42:09 +0000"/>
                            <attachment id="12387686" name="join.patch" size="35883" author="daijy" created="Wed, 6 Aug 2008 22:01:41 +0000"/>
                            <attachment id="12387695" name="join2.patch" size="35795" author="daijy" created="Thu, 7 Aug 2008 00:28:41 +0000"/>
                            <attachment id="12387768" name="join3.patch" size="35833" author="daijy" created="Thu, 7 Aug 2008 21:07:27 +0000"/>
                            <attachment id="12388109" name="join4.patch" size="36115" author="daijy" created="Wed, 13 Aug 2008 07:59:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>163986</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gj5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94535</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>