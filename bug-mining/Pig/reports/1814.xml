<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:01:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4819] RANDOM() udf can lead to missing or redundant records</title>
                <link>https://issues.apache.org/jira/browse/PIG-4819</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;When RANDOM() value is used for grouping/distinct/etc, it breaks the mapreduce rule and can lead to redundant or missing records. &lt;/p&gt;

&lt;p&gt;Some discussion can be found in &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-3257?focusedCommentId=13669195#comment-13669195&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/PIG-3257?focusedCommentId=13669195#comment-13669195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We should make RANDOM less random so that it&apos;ll produce the same sequence of random values from the task retries.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12945934">PIG-4819</key>
            <summary>RANDOM() udf can lead to missing or redundant records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Mar 2016 20:18:43 +0000</created>
                <updated>Wed, 8 Jun 2016 20:48:44 +0000</updated>
                            <resolved>Thu, 3 Mar 2016 20:58:32 +0000</resolved>
                                                    <fixVersion>0.16.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15174358" author="knoguchi" created="Tue, 1 Mar 2016 20:24:52 +0000"  >&lt;p&gt;Attaching a patch that &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Use jobid and taskid as the seed.&lt;/li&gt;
	&lt;li&gt;A test case to make sure attempts from the same task would produce a same random sequence&lt;/li&gt;
	&lt;li&gt;(Unrelated, but) fixing a minor bug in testUniqueID where results weren&apos;t checked properly.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I only changed &lt;tt&gt;./src/org/apache/pig/builtin/RANDOM.java&lt;/tt&gt; but not &lt;tt&gt;./contrib/piggybank/java/src/main/java/org/apache/pig/piggybank/evaluation/math/RANDOM.java&lt;/tt&gt;.  Let me know if I should make the same change.&lt;/p&gt;</comment>
                            <comment id="15174466" author="rohini" created="Tue, 1 Mar 2016 21:44:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Let me know if I should make the same change.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;  Yes. That would be good.&lt;/p&gt;

&lt;p&gt;Other comments on the patch&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tab spacing should be 4 spaces and not two in exec() method.&lt;/li&gt;
	&lt;li&gt;Can we remove System.err.println(tmpresult&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;);  or use debug logging?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15175775" author="knoguchi" created="Wed, 2 Mar 2016 15:23:03 +0000"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Let me know if I should make the same change.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. That would be good.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Made the same change there.&lt;br/&gt;
But should I simply extend &lt;tt&gt;org.apache.pig.builtin.RANDOM&lt;/tt&gt; from &lt;br/&gt;
&lt;tt&gt;org.apache.pig.piggybank.evaluation.math.RANDOM&lt;/tt&gt; ?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Tab spacing should be 4 spaces and not two in exec() method.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did have 4 spaces for the lines I touched.  Assuming you&apos;re talking about the existing code having actual tab in the code, replaced them with 4 spaces.  &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can we remove System.err.println(tmpresult&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;); or use debug logging?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Forgot to delete that.  Thanks for catching it.&lt;br/&gt;
Since the output gave me assurance that I am getting some random values, I replaced it with logging(info).&lt;/p&gt;</comment>
                            <comment id="15176100" author="rohini" created="Wed, 2 Mar 2016 17:58:41 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But should I simply extend org.apache.pig.builtin.RANDOM from  org.apache.pig.piggybank.evaluation.math.RANDOM&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;   Would be ideal, but if they use newer piggybank jar with older version of pig it will break. So I think duplicating code is better for now.&lt;/p&gt;</comment>
                            <comment id="15176315" author="knoguchi" created="Wed, 2 Mar 2016 19:37:44 +0000"  >&lt;p&gt;Thanks for the review Rohini!  Committed to trunk.&lt;/p&gt;</comment>
                            <comment id="15177101" author="knoguchi" created="Thu, 3 Mar 2016 03:45:52 +0000"  >&lt;p&gt;Sorry for reopening but my unit test &lt;tt&gt;testRANDOMWithJob&lt;/tt&gt; was failing indicating that random isn&apos;t random enough.&lt;/p&gt;

&lt;p&gt;Trying with a real cluster with small inputs, saw a very similar random values produced with high probability.  Obviously long &quot;seed&quot; was too close. Changing how I&apos;m setting the seed.&lt;/p&gt;</comment>
                            <comment id="15177230" author="knoguchi" created="Thu, 3 Mar 2016 05:38:39 +0000"  >&lt;p&gt;Wasn&apos;t sure if I should rollback the change and attach a complete new patch or attach a diff from the last commit. &lt;br/&gt;
This one does the latter.&lt;/p&gt;

&lt;p&gt;Two major changes.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Given two consecutive seeds seem to result in close random values (at least for some initial ones), now creating a seed(type:long) with task_number and job_id.hascode() connected instead of other ways.  Given only the first 48 bits is used from the passed seed, leaving 28 bits for the task id.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;To add more randomness across jobs, adding submit time with XOR.  (Ideally it would be better if this was nano-seconds, but I think this is good enough with milli-seconds.)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ll do some more testing tomorrow.&lt;/p&gt;</comment>
                            <comment id="15178323" author="knoguchi" created="Thu, 3 Mar 2016 18:32:33 +0000"  >&lt;p&gt;Discussing with Rohini, simplified a call by creating a long by connecting two jobid-hash and xor-ing with a task number.  Also, added a logic so that if RANDOM is called for more than once in the script, they would return a different value.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;B = FOREACH A generate RANDOM(), RANDOM();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;To add more randomness across jobs, adding submit time with XOR.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This didn&apos;t work with Tez.  It wasn&apos;t transferring &quot;pig.job.submitted.timestamp&quot;.  For now, taking it out but it would be nice to have this.  (Even better with nanosecond).&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;But should I simply extend org.apache.pig.builtin.RANDOM from org.apache.pig.piggybank.evaluation.math.RANDOM&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Would be ideal, but if they use newer piggybank jar with older version of pig it will break. So I think duplicating code is better for now.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Given the not so obvious changes I&apos;ve made to original RANDOM, I wasn&apos;t comfortable with copy and pasting.  I simply went with extending option.&lt;br/&gt;
My understanding is, worst case would be piggybank.RANDOM referencing the original builtin.RANDOM without my changes but it won&apos;t fail.&lt;/p&gt;</comment>
                            <comment id="15178400" author="knoguchi" created="Thu, 3 Mar 2016 19:13:03 +0000"  >&lt;p&gt;Rohini pointed out that I would need to re-initialize the static variables for Tez jvm reuse.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://pig.apache.org/docs/r0.15.0/udf.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pig.apache.org/docs/r0.15.0/udf.html&lt;/a&gt;&lt;br/&gt;
&lt;em&gt;Clean up static variable in Tez&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added.  But still trying to see if I can get rid of the static variable dependency.&lt;/p&gt;</comment>
                            <comment id="15178505" author="knoguchi" created="Thu, 3 Mar 2016 19:51:42 +0000"  >&lt;p&gt;&lt;tt&gt;import org.apache.pig.StaticDataCleanup;&lt;/tt&gt; was missed when adding the cleanup method.&lt;/p&gt;</comment>
                            <comment id="15178558" author="knoguchi" created="Thu, 3 Mar 2016 20:23:36 +0000"  >&lt;p&gt;Hopefully this is close to the final one.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Added comment on why I came up with that seed formula.&lt;/li&gt;
	&lt;li&gt;Renaming &lt;tt&gt;staticDataCleanup&lt;/tt&gt; to &lt;tt&gt;resetSeedUniquifier&lt;/tt&gt; and using that to initialize from test.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15178561" author="rohini" created="Thu, 3 Mar 2016 20:24:57 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15178595" author="knoguchi" created="Thu, 3 Mar 2016 20:49:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;+1&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks Rohini.&lt;br/&gt;
Uploading another for a minor typo in my comment. &lt;br/&gt;
&quot;48 bytes&quot; should be &quot;48 bits&quot;.  &lt;/p&gt;

&lt;p&gt;Also took out unnecessary lines from TestBuiltin.java that were no longer necessary after calling &lt;tt&gt;RANDOM.resetSeedUniquifier&lt;/tt&gt; directly.&lt;/p&gt;</comment>
                            <comment id="15178597" author="rohini" created="Thu, 3 Mar 2016 20:51:19 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15178616" author="knoguchi" created="Thu, 3 Mar 2016 20:58:32 +0000"  >&lt;p&gt;In addition to previous pig-4819-v02.patch, applied the fix with pig-4819-v02_fix_v06.patch.&lt;/p&gt;</comment>
                            <comment id="15179448" author="rohini" created="Fri, 4 Mar 2016 06:46:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knoguchi&quot; class=&quot;user-hover&quot; rel=&quot;knoguchi&quot;&gt;knoguchi&lt;/a&gt;,&lt;br/&gt;
    TestBuiltin.testURIWithCurlyBrace is failing after addition of testRandomJob with -Dhadoopversion=23 -Dexectype=tez. Possible to take a look at it? Also would be good to put this in Pig 0.15.1 as well.&lt;/p&gt;</comment>
                            <comment id="15187597" author="knoguchi" created="Wed, 9 Mar 2016 18:34:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;TestBuiltin.testURIWithCurlyBrace is failing after addition of testRandomJob with -Dhadoopversion=23 -Dexectype=tez. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/PIG-4833&quot; title=&quot;TestBuiltin.testURIWithCurlyBrace in TEZ failing after PIG-4819&quot; class=&quot;issue-link&quot; data-issue-key=&quot;PIG-4833&quot;&gt;&lt;del&gt;PIG-4833&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also would be good to put this in Pig 0.15.1 as well.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not sure.   I do like my change but still afraid of how it&apos;ll perform for our users.  &lt;br/&gt;
For now, I prefer to keep it only in trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12790781" name="pig-4819-v01.patch" size="7680" author="knoguchi" created="Tue, 1 Mar 2016 20:24:52 +0000"/>
                            <attachment id="12790947" name="pig-4819-v02.patch" size="9864" author="knoguchi" created="Wed, 2 Mar 2016 15:23:03 +0000"/>
                            <attachment id="12791101" name="pig-4819-v02_fix_v01.patch" size="7306" author="knoguchi" created="Thu, 3 Mar 2016 05:38:39 +0000"/>
                            <attachment id="12791214" name="pig-4819-v02_fix_v02.patch" size="7597" author="knoguchi" created="Thu, 3 Mar 2016 18:32:33 +0000"/>
                            <attachment id="12791228" name="pig-4819-v02_fix_v03.patch" size="7208" author="knoguchi" created="Thu, 3 Mar 2016 19:13:03 +0000"/>
                            <attachment id="12791241" name="pig-4819-v02_fix_v04.patch" size="7634" author="knoguchi" created="Thu, 3 Mar 2016 19:51:42 +0000"/>
                            <attachment id="12791247" name="pig-4819-v02_fix_v05.patch" size="8627" author="knoguchi" created="Thu, 3 Mar 2016 20:23:36 +0000"/>
                            <attachment id="12791250" name="pig-4819-v02_fix_v06.patch" size="8137" author="knoguchi" created="Thu, 3 Mar 2016 20:49:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2tzrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>