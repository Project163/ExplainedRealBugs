<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 20:01:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[PIG-4880] Overlapping of parameter substitution names inside&amp;outside a macro fails with NPE</title>
                <link>https://issues.apache.org/jira/browse/PIG-4880</link>
                <project id="12310730" key="PIG">Pig</project>
                    <description>&lt;p&gt;With &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;macro.pig&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEFINE mygroupby(REL, key) RETURNS G {
   %declare number 333;
   $G = GROUP $REL by $key parallel $number;
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;test.pig&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-- equivalent of -param number=111
%declare number 111;

IMPORT &lt;span class=&quot;code-quote&quot;&gt;&apos;macro.pig&apos;&lt;/span&gt;;
data = LOAD &lt;span class=&quot;code-quote&quot;&gt;&apos;1234.txt&apos;&lt;/span&gt; USING PigStorage() AS (i: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
result = mygroupby(data, i);
STORE result INTO &lt;span class=&quot;code-quote&quot;&gt;&apos;test.out&apos;&lt;/span&gt; USING PigStorage();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fails with &lt;br/&gt;
&lt;tt&gt;error msg: &amp;lt;file myscript.pig, line 4&amp;gt; Macro inline failed for macro &apos;mygroupby&apos;. Reason: null&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Similarly, when macro param and command-line param overlap, it fails with &lt;br/&gt;
&lt;tt&gt;Macro inline failed for macro &apos;mygroupby&apos;. Reason: Macro contains argument or return value number which conflicts with a Pig parameter of the same name.&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12962406">PIG-4880</key>
            <summary>Overlapping of parameter substitution names inside&amp;outside a macro fails with NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knoguchi">Koji Noguchi</assignee>
                                    <reporter username="knoguchi">Koji Noguchi</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Apr 2016 21:55:07 +0000</created>
                <updated>Wed, 8 Jun 2016 20:48:33 +0000</updated>
                            <resolved>Thu, 12 May 2016 16:49:58 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.16.0</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15257141" author="knoguchi" created="Mon, 25 Apr 2016 22:07:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;error msg: &amp;lt;file myscript.pig, line 4&amp;gt; Macro inline failed for macro &apos;mygroupby&apos;. Reason: null&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;By making it dump the stack trace in a testcase, it showed &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
    at org.apache.pig.tools.parameters.PreprocessorContext.processOrdLine(PreprocessorContext.java:179)
    at org.apache.pig.tools.parameters.PigFileParser.param_value(PigFileParser.java:117)
    at org.apache.pig.tools.parameters.PigFileParser.input(PigFileParser.java:57)
    at org.apache.pig.tools.parameters.PigFileParser.Parse(PigFileParser.java:43)
    at org.apache.pig.tools.parameters.ParameterSubstitutionPreprocessor.parsePigFile(ParameterSubstitutionPreprocessor.java:95)
    at org.apache.pig.tools.parameters.ParameterSubstitutionPreprocessor.genSubstitutedFile(ParameterSubstitutionPreprocessor.java:76)
    at org.apache.pig.parser.PigMacro.substituteParams(PigMacro.java:182)
    at org.apache.pig.parser.PigMacro.inline(PigMacro.java:96)
    at org.apache.pig.parser.PigMacro.macroInline(PigMacro.java:489)
    at org.apache.pig.parser.QueryParserDriver.inlineMacro(QueryParserDriver.java:301)
    at org.apache.pig.parser.QueryParserDriver.expandMacro(QueryParserDriver.java:290)
    at org.apache.pig.parser.QueryParserDriver.parse(QueryParserDriver.java:183)
    at org.apache.pig.PigServer$Graph.validateQuery(PigServer.java:1729)
    at org.apache.pig.PigServer$Graph.registerQuery(PigServer.java:1702)
    at org.apache.pig.PigServer.registerQuery(PigServer.java:645)
    at org.apache.pig.tools.grunt.GruntParser.processPig(GruntParser.java:1075)
    at org.apache.pig.tools.pigscript.parser.PigScriptParser.parse(PigScriptParser.java:505)
    at org.apache.pig.tools.grunt.GruntParser.loadScript(GruntParser.java:557)
    at org.apache.pig.tools.grunt.GruntParser.processExplain(GruntParser.java:370)
    at org.apache.pig.tools.grunt.Grunt.checkScript(Grunt.java:95)
    at org.apache.pig.Main.run(Main.java:629)
    at org.apache.pig.PigRunner.run(PigRunner.java:49)
    at org.apache.pig.test.TestMacroExpansion.verify(TestMacroExpansion.java:2410)
    at org.apache.pig.test.TestMacroExpansion.testParamOverLap4(TestMacroExpansion.java:2357)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:497)
    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
    at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
    at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)
    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)
    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)
    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)
    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)
    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)
    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)
    at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
    at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
    at org.junit.runners.ParentRunner.run(ParentRunner.java:309)
    at junit.framework.JUnit4TestAdapter.run(JUnit4TestAdapter.java:38)
    at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:535)
    at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:1182)
    at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:1033)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Corresponding code at &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;PreprocessorContext.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;176     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt;  void processOrdLine(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; val, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; overwrite)  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ParameterSubstitutionException {
177
178         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (param_val.containsKey(key)) {
179             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (param_source.get(key).equals(val) || !overwrite) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and this showed the case when &lt;tt&gt;param_val&lt;/tt&gt; and &lt;tt&gt;param_source&lt;/tt&gt; became inconsistent in terms of list of keys. As a result, &lt;tt&gt;param_source.get(key)&lt;/tt&gt; returned null.  &lt;/p&gt;

&lt;p&gt;Tracing the code, inconsistency was introduced at &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;PigMacro.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;165         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
166             PreprocessorContext pc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PreprocessorContext(50);
167             pc.loadParamVal(Arrays.asList(args), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
168
169             Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; paramVal = pc.getParamVal();
170             &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; e : pigContext.getParamVal().entrySet()) {
171                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (paramVal.containsKey(e.getKey())) {
172                     &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParserException(
173                         &lt;span class=&quot;code-quote&quot;&gt;&quot;Macro contains argument or &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value &quot;&lt;/span&gt; + e.getKey() + &lt;span class=&quot;code-quote&quot;&gt;&quot; which conflicts &quot;&lt;/span&gt; +
174                         &lt;span class=&quot;code-quote&quot;&gt;&quot;with a Pig parameter of the same name.&quot;&lt;/span&gt;
175                     );
176                 } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
177                     paramVal.put(e.getKey(), e.getValue());
178                 }
179             }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where PigMacro updates the &lt;tt&gt;param_val&lt;/tt&gt; but not &lt;tt&gt;param_source&lt;/tt&gt; for  global param substitutions.&lt;/p&gt;</comment>
                            <comment id="15257145" author="knoguchi" created="Mon, 25 Apr 2016 22:09:39 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Similarly, when macro param and command-line param overlap, it fails with &lt;br/&gt;
&lt;tt&gt;Macro inline failed for macro &apos;mygroupby&apos;. Reason: Macro contains argument or return value number which conflicts with a Pig parameter of the same name.&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sample code.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;macro.pig&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEFINE mygroupby(REL, key, number) RETURNS G {
   $G = GROUP $REL by $key parallel $number;
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;test.pig&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-- equivalent of -param number=111
%declare number 111;

IMPORT &lt;span class=&quot;code-quote&quot;&gt;&apos;macro.pig&apos;&lt;/span&gt;;
data = LOAD &lt;span class=&quot;code-quote&quot;&gt;&apos;1234.txt&apos;&lt;/span&gt; USING PigStorage() AS (i: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
result = mygroupby(data, i, 222);
STORE result INTO &lt;span class=&quot;code-quote&quot;&gt;&apos;test.out&apos;&lt;/span&gt; USING PigStorage();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think we can allow this by simply taking the macro parameter value.&lt;/p&gt;</comment>
                            <comment id="15257150" author="knoguchi" created="Mon, 25 Apr 2016 22:14:06 +0000"  >&lt;p&gt;Attaching a patch that would allow &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Overlapping of macro-param and command-line param names by taking the macro-param for this case.&lt;br/&gt;
and &lt;/li&gt;
	&lt;li&gt;Overlapping of param substitution on both inside and outside the macro by following the default/declare definition.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15280511" author="daijy" created="Wed, 11 May 2016 17:51:17 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15281739" author="knoguchi" created="Thu, 12 May 2016 16:49:58 +0000"  >&lt;p&gt;Thanks for the review Daniel!  Committed to trunk.&lt;/p&gt;</comment>
                            <comment id="15296909" author="knoguchi" created="Mon, 23 May 2016 19:16:12 +0000"  >&lt;p&gt;Just realized I should have updated the document for the changes I&apos;ve made for this jira.  &lt;/p&gt;

&lt;p&gt;Please let me know if I should open a new jira. &lt;br/&gt;
Also, if I can commit the change to 0.16 branch (as well as trunk).  Thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12654011">PIG-3359</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12800650" name="pig-4880-v01.patch" size="6762" author="knoguchi" created="Mon, 25 Apr 2016 22:14:06 +0000"/>
                            <attachment id="12805720" name="pig-4880-v01_documentudpate.patch" size="1100" author="knoguchi" created="Mon, 23 May 2016 19:16:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wpvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Now, macro argument/return names can overlap with parameter substitution names.  Former value is taken for these cases.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>