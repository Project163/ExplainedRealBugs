<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:47:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7639] NPE when using safe traversal operator with CompileStatic</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7639</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;In the code below, the &quot;if&quot; condition throws a NPE when it reaches the &quot;p3&quot; object. If I remove the @CompileStatic from the &quot;SomeOther&quot; class it works.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Person {
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name
  OtherInfo otherInfo
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;OtherInfo {
  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; favoriteNumber
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SomeOther {
  SomeOther() {
    Person p1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Person(name: &lt;span class=&quot;code-quote&quot;&gt;&apos;Ben&apos;&lt;/span&gt;, otherInfo: &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OtherInfo(favoriteNumber: 1))
    Person p2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Person(name: &lt;span class=&quot;code-quote&quot;&gt;&apos;Aaron&apos;&lt;/span&gt;, otherInfo: &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OtherInfo())
    Person p3 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Person(name: &lt;span class=&quot;code-quote&quot;&gt;&apos;Fred&apos;&lt;/span&gt;)
    [p1,p2,p3].each { Person p -&amp;gt;
      println &lt;span class=&quot;code-quote&quot;&gt;&quot;checking: ${p.name}&quot;&lt;/span&gt;
      println p?.otherInfo?.favoriteNumber
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(p?.otherInfo?.favoriteNumber == 7){
        println &lt;span class=&quot;code-quote&quot;&gt;&quot;luckiest number!&quot;&lt;/span&gt;
      }
    }
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SomeOther()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12905979">GROOVY-7639</key>
            <summary>NPE when using safe traversal operator with CompileStatic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shils">Shil Sinha</assignee>
                                    <reporter username="podollb">Ben Podoll</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Oct 2015 16:41:03 +0000</created>
                <updated>Mon, 22 Feb 2016 20:48:42 +0000</updated>
                            <resolved>Mon, 2 Nov 2015 20:55:25 +0000</resolved>
                                    <version>2.4.5</version>
                                    <fixVersion>2.4.6</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14967386" author="shils" created="Wed, 21 Oct 2015 16:18:46 +0000"  >&lt;p&gt;This occurs because a primitive compare is performed for &lt;tt&gt;p?.otherInfo?.favoriteNumber == 7&lt;/tt&gt;, since the inferred type of the lhs is int instead of Integer. The obvious fix would be to store the inferred type of null safe property expressions as the wrapper type in case of primitives (as is done with null safe method call expressions), but this would break the tests put in place for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="14968678" author="blackdrag" created="Thu, 22 Oct 2015 07:16:36 +0000"  >&lt;p&gt;do you mean with &quot;as is done with null safe method call expressions&quot; something like foo?.bar(), where foo is a priimitive?&lt;/p&gt;</comment>
                            <comment id="14969355" author="shils" created="Thu, 22 Oct 2015 16:01:13 +0000"  >&lt;p&gt;I mean things like foo?.doBar() where doBar() returns a primitive type. Example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Foo {
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bar

    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; doBar() {
        bar
    }
}

@groovy.transform.CompileStatic
void test() {
    Foo foo = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !(foo?.doBar() == 7) &lt;span class=&quot;code-comment&quot;&gt;// passes
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !(foo?.bar == 7) &lt;span class=&quot;code-comment&quot;&gt;// NPE
&lt;/span&gt;}
test()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When storing the type for safe method call expressions (via StaticTypeCheckingVisitor.storeType), wrapper types are stored in place of primitives, resulting in ScriptBytecodeAdapter.compareEqual comparisons for things like foo?.doBar() == 7. There&apos;s no such guard for safe property expressions, so the inferred type of foo?.x is int and a primitive comparison is performed instead.&lt;/p&gt;

&lt;p&gt;Though it would be possible to handle this during class generation, it seems logical to me that the inferred return type for a safe expression, method call or property, should not be a primitive type. However, the tests in &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt; explicitly test for the opposite in the case of property expressions. &lt;/p&gt;</comment>
                            <comment id="14970635" author="blackdrag" created="Fri, 23 Oct 2015 08:19:25 +0000"  >&lt;p&gt;Frankly I think &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt; has been solved in the wrong way. 0 is not null. &lt;/p&gt;</comment>
                            <comment id="14971021" author="shils" created="Fri, 23 Oct 2015 13:57:30 +0000"  >&lt;p&gt;Perhaps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=melix&quot; class=&quot;user-hover&quot; rel=&quot;melix&quot;&gt;melix&lt;/a&gt; can comment?&lt;/p&gt;</comment>
                            <comment id="14971048" author="melix" created="Fri, 23 Oct 2015 14:13:26 +0000"  >&lt;p&gt;Yes, I think the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt; is wrong. The inferred type for a?.foo should be a boxed type, because it can be either &lt;tt&gt;null&lt;/tt&gt; or a primitive type, so the least upper bound is &lt;tt&gt;Object&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14971099" author="shils" created="Fri, 23 Oct 2015 14:48:31 +0000"  >&lt;p&gt;In that case, my proposed fix for this issue should be ok, but we&apos;ll need new tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14972500" author="blackdrag" created="Sat, 24 Oct 2015 09:30:28 +0000"  >&lt;p&gt;I suggest you change the tests to check for the boxed variant as part of this fix. If there will be more tests failing as a result of this, we can discuss further&lt;/p&gt;</comment>
                            <comment id="14977490" author="shils" created="Wed, 28 Oct 2015 00:47:01 +0000"  >&lt;p&gt;You mean change the tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt;? They are the only 3 tests that fail when my fix is applied.&lt;/p&gt;</comment>
                            <comment id="14977851" author="blackdrag" created="Wed, 28 Oct 2015 06:33:59 +0000"  >&lt;p&gt;yes&lt;/p&gt;</comment>
                            <comment id="14979764" author="githubbot" created="Thu, 29 Oct 2015 04:00:19 +0000"  >&lt;p&gt;GitHub user shils opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7639&quot; title=&quot;NPE when using safe traversal operator with CompileStatic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7639&quot;&gt;&lt;del&gt;GROOVY-7639&lt;/del&gt;&lt;/a&gt; Comparing primitive to null safe primitive property expre&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;ssion should not throw NPE&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Correct assertions in tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/shils/incubator-groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/shils/incubator-groovy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7639&quot; title=&quot;NPE when using safe traversal operator with CompileStatic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7639&quot;&gt;&lt;del&gt;GROOVY-7639&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/167.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/167.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #167&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a6e380e3f96e61749f2dea5cec636a7c4bc28ca4&lt;br/&gt;
Author: Shil Sinha &amp;lt;shils@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-10-29T03:58:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7639&quot; title=&quot;NPE when using safe traversal operator with CompileStatic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7639&quot;&gt;&lt;del&gt;GROOVY-7639&lt;/del&gt;&lt;/a&gt; Comparing primitive to null safe primitive property expression should not throw NPE&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Correct assertions in tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5613&quot; title=&quot;@CompileStatic - Caught: java.lang.VerifyError - Inconsistent stack height 1 != 2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5613&quot;&gt;&lt;del&gt;GROOVY-5613&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;</comment>
                            <comment id="14984427" author="githubbot" created="Sun, 1 Nov 2015 15:48:42 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/167&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14985886" author="shils" created="Mon, 2 Nov 2015 19:43:44 +0000"  >&lt;p&gt;I don&apos;t seem to have the jira rights to resolve this, but it should be fixed.&lt;/p&gt;</comment>
                            <comment id="14986018" author="blackdrag" created="Mon, 2 Nov 2015 20:55:25 +0000"  >&lt;p&gt;I resolve the issue for you.... I added some permissions for you, so you should be able to do it yourself next time&lt;/p&gt;</comment>
                            <comment id="14986404" author="shils" created="Tue, 3 Nov 2015 00:54:21 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2n71z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>