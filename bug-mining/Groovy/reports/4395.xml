<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:18:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10553] Regression: Annotation on trait field is illegally duplicated</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10553</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have the following types:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
trait ShipmentRelated {
  @NotBlank
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; shipmentId
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ShipmentLocationRequest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Base &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ShipmentRelated {}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In Groovy 3, this compiles correctly:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; com_example_logistics_ShipmentRelated__shipmentId;
&#160;&#160;&#160; descriptor: Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;
&#160;&#160;&#160; flags: (0x0002) ACC_PRIVATE
&#160;&#160;&#160; RuntimeVisibleAnnotations:
&#160;&#160;&#160;&#160;&#160; 0: #17()&#160;&#160;&#160;&#160;&#160;&#160;&#160; javax.validation.constraints.NotBlank
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In Groovy 4 with identical source, I get duplicate annotations (annotation sections?):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; com_example_logistics_ShipmentRelated__shipmentId;
&#160;&#160;&#160; descriptor: Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;
&#160;&#160;&#160; flags: (0x0002) ACC_PRIVATE
&#160;&#160;&#160; RuntimeVisibleAnnotations:
&#160;&#160;&#160;&#160;&#160; 0: #17()&#160;&#160;&#160;&#160;&#160;&#160;&#160; javax.validation.constraints.NotBlank
&#160;&#160;&#160; RuntimeVisibleTypeAnnotations:
&#160;&#160;&#160;&#160;&#160; 0: #17(): FIELD&#160;&#160;&#160;&#160;&#160;&#160;&#160; javax.validation.constraints.NotBlank
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This causes an &lt;tt&gt;AnnotationFormatError&lt;/tt&gt; at runtime.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13436236">GROOVY-10553</key>
            <summary>Regression: Annotation on trait field is illegally duplicated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="chrylis">Christopher Smith</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Mar 2022 18:55:43 +0000</created>
                <updated>Sat, 23 Jul 2022 16:26:22 +0000</updated>
                            <resolved>Wed, 30 Mar 2022 14:55:02 +0000</resolved>
                                    <version>4.0.1</version>
                                    <fixVersion>4.0.2</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17513648" author="emilles" created="Mon, 28 Mar 2022 21:05:25 +0000"  >&lt;p&gt;This is the second half of &lt;tt&gt;TraitAstTransformation#processField&lt;/tt&gt;, which creates two fields explicitly: &lt;a href=&quot;https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/transform/trait/TraitASTTransformation.java#L533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/transform/trait/TraitASTTransformation.java#L533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ExtendedVerifier is where TYPE_USE annotations are transferred.&lt;/p&gt;</comment>
                            <comment id="17513707" author="emilles" created="Mon, 28 Mar 2022 23:06:39 +0000"  >&lt;p&gt;Can you try with the latest snapshot and see if the &lt;tt&gt;AnnotationFormatError&lt;/tt&gt; is gone?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/b8bfccaf6a13edc6094e3e91d29d54eebebf2b03&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/b8bfccaf6a13edc6094e3e91d29d54eebebf2b03&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As for annotation &lt;tt&gt;NotBlank&lt;/tt&gt; ending up on field and field type, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt; may need to weigh in on that.  I don&apos;t know how the &lt;tt&gt;TYPE_USE&lt;/tt&gt; transfer logic is designed.&lt;/p&gt;</comment>
                            <comment id="17513720" author="chrylis" created="Mon, 28 Mar 2022 23:38:00 +0000"  >&lt;p&gt;Is the snapshot in Central Snapshots?&lt;/p&gt;

</comment>
                            <comment id="17513728" author="emilles" created="Tue, 29 Mar 2022 00:03:59 +0000"  >&lt;p&gt;There should be one at &lt;a href=&quot;https://groovy.jfrog.io/artifactory/libs-snapshot-local/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groovy.jfrog.io/artifactory/libs-snapshot-local/&lt;/a&gt; shortly.  You can pick it up as 4.0.2-SNAPSHOT&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&amp;lt;pluginRepositories&amp;gt;
		&amp;lt;pluginRepository&amp;gt;
			&amp;lt;id&amp;gt;groovy-plugins-release&amp;lt;/id&amp;gt;
			&amp;lt;url&amp;gt;https:&lt;span class=&quot;code-comment&quot;&gt;//groovy.jfrog.io/artifactory/libs-snapshot&amp;lt;/url&amp;gt;
&lt;/span&gt;		&amp;lt;/pluginRepository&amp;gt;
	&amp;lt;/pluginRepositories&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17513873" author="paulk" created="Tue, 29 Mar 2022 07:32:21 +0000"  >&lt;p&gt;Snapshot info is available here (the above is applicable up to Groovy 3):&lt;br/&gt;
&lt;a href=&quot;https://groovy.apache.org/snapshots.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groovy.apache.org/snapshots.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17513946" author="paulk" created="Tue, 29 Mar 2022 09:15:33 +0000"  >&lt;p&gt;What you have in the bytecode for Groovy 4 looks like what I&apos;d expect (at least if there was no trait involved).&lt;br/&gt;
There should be entries for both the runtime visible annotation on the field and the type use annotation entry.&lt;/p&gt;

&lt;p&gt;I tried this trait:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; jakarta.validation.constraints.NotBlank

trait ShipmentTraitG {
    @NotBlank &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; shipmentId
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And the following main:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MainG &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ShipmentTraitG {
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(args) {
        println &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MainG(shipmentId: &lt;span class=&quot;code-quote&quot;&gt;&apos;my shipment #1&apos;&lt;/span&gt;).shipmentId
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It compiles and runs successfully with 4.0.1 but there are a few strange aspects.&lt;/p&gt;

&lt;p&gt;There does appear to be duplicate type use annotations in the field helper class:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Classfile ShipmentTraitG$Trait$FieldHelper.class
...
public static final java.lang.String $0x0002ShipmentTraitG__shipmentId;
  descriptor: Ljava/lang/String;
  flags: (0x1019) ACC_PUBLIC, ACC_STATIC, ACC_FINAL, ACC_SYNTHETIC
  RuntimeVisibleAnnotations:
    0: #11()
      jakarta.validation.constraints.NotBlank
  RuntimeVisibleTypeAnnotations:
    0: #11(): FIELD
      jakarta.validation.constraints.NotBlank
    1: #11(): FIELD
      jakarta.validation.constraints.NotBlank  // DUPLICATE
...
public abstract java.lang.String ShipmentTraitG__shipmentId$set(java.lang.String);
  descriptor: (Ljava/lang/String;)Ljava/lang/String;
  flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
  RuntimeVisibleTypeAnnotations:
    0: #11(): METHOD_RETURN
      jakarta.validation.constraints.NotBlank
    1: #11(): METHOD_RETURN
      jakarta.validation.constraints.NotBlank  // DUPLICATE
    2: #11(): METHOD_FORMAL_PARAMETER, param_index=0
      jakarta.validation.constraints.NotBlank
    3: #11(): METHOD_FORMAL_PARAMETER, param_index=0
      jakarta.validation.constraints.NotBlank  // DUPLICATE
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Over and above that, there are some other things which are a little strange. For MainG, there are no annotations on the relevant getter/setter (nor the backing field) but there are type use annotations on the backing implementation method. It probably does no harm but I am fairly sure no-one is expecting them in the places they are appearing:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Classfile MainG.class
...
  public java.lang.String getShipmentId();
    ...
    // only GENERATE and &quot;trait bridge&quot; annotations.
...
  public java.lang.String ShipmentTraitG__shipmentId$get();
    ...
    RuntimeVisibleTypeAnnotations:
      0: #14(): METHOD_RETURN
        jakarta.validation.constraints.NotBlank
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17513948" author="chrylis" created="Tue, 29 Mar 2022 09:19:00 +0000"  >&lt;p&gt;&quot;Runs&quot; may not be the relevant criterion. I&apos;m not seeing the JVM error&lt;br/&gt;
until Hibernate Validator reads the annotation at runtime.&lt;/p&gt;

</comment>
                            <comment id="17513990" author="paulk" created="Tue, 29 Mar 2022 10:34:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; The two fields aspect shouldn&apos;t be relevant (though turns out it was accidentally). One is a legacy version of the other - we should probably remove the legacy one for Groovy 5. It &quot;just&quot; provides cross Groovy version support for traits, e.g. traits compiled under one version of Groovy but used with another - common when using plugins for e.g. with Grails.&lt;/p&gt;

&lt;p&gt;The problem appears to be that we don&apos;t call getPlainNodeReference() for the field type on those fields.&lt;/p&gt;</comment>
                            <comment id="17513992" author="paulk" created="Tue, 29 Mar 2022 10:41:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chrylis&quot; class=&quot;user-hover&quot; rel=&quot;chrylis&quot;&gt;chrylis&lt;/a&gt; I made a further change (snapshot version pending). The annotations in the class files should be much cleaner now with no duplicates. As to whether they are appearing in places that Hibernate Validator is expecting them, that I don&apos;t know. It possibly falls into the area of outside what traits were designed to support but let us know how you go.&lt;/p&gt;</comment>
                            <comment id="17514150" author="chrylis" created="Tue, 29 Mar 2022 15:23:00 +0000"  >&lt;p&gt;To clarify (I don&apos;t think I included a stack trace but can), I&apos;m getting a&lt;br/&gt;
JVM Error-free subclass indicating an illegal duplication of an annotation&lt;br/&gt;
(i.e., not rolled up into a container annotation) on invocation of a&lt;br/&gt;
built-in reflection method. It&apos;s merely that this isn&apos;t inspected until HV&lt;br/&gt;
queries it.&lt;/p&gt;

</comment>
                            <comment id="17514289" author="chrylis" created="Tue, 29 Mar 2022 19:21:13 +0000"  >&lt;p&gt;I created a failing unit test that replicates the problem by using HV. Interesting findings:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The failure occurs when HV scans the metadata for &lt;tt&gt;ShipmentRelated$Trait$FieldHelper&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;The offending method is &lt;tt&gt;com_example_logistics_ShipmentRelated__shipmentId$get&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;That method &lt;em&gt;is not synthetic&lt;/em&gt; or it would have been skipped anyway. Since the bytecode triggers an &lt;tt&gt;Error&lt;/tt&gt;, it&apos;s a bug, but shouldn&apos;t the trait proxy method be synthetic?&lt;/li&gt;
	&lt;li&gt;The JVM error can be triggered by calling &lt;tt&gt;Method#getAnnotatedReturnType()&lt;/tt&gt; on that method, obtained via {{ShipmentLocationRequest.methods.find 
{ it.name.endsWith &apos;ShipmentRelated__shipmentId$get&apos; }
&lt;p&gt; }}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Inspecting the bytecode for the &lt;tt&gt;FieldHelper&lt;/tt&gt;, it appears that the class is declared as an interface but that it also has two fields declared? Surprised (1) that any fields are declared on an interface and (2) that there are duplicates. Names are &lt;tt&gt;$0x0002com_example_logistics_ShipmentRelated_&lt;em&gt;shipmentId&lt;/tt&gt; and &lt;tt&gt;$ins$1com_example_logistics_ShipmentRelated&lt;/em&gt;_shipmentId&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;4.0.1 most certainly duplicates the annotation:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; com_example_logistics_ShipmentRelated__shipmentId$get();
    descriptor: ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;
    flags: (0x0401) ACC_PUBLIC, ACC_ABSTRACT
    RuntimeVisibleTypeAnnotations:
      0: #11(): METHOD_RETURN
        javax.validation.constraints.NotBlank
      1: #11(): METHOD_RETURN
        javax.validation.constraints.NotBlank
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;groovy-4.0.2-20220329.103403-35&lt;/tt&gt; appears to solve the problem.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17514345" author="paulk" created="Tue, 29 Mar 2022 22:20:13 +0000"  >&lt;p&gt;The fields are there mostly as a store for FIELD annotations for pre-compiled traits. Otherwise we&apos;d need to serialize that info some other way. One has a legacy name for compatibility with older versions of Groovy.&lt;/p&gt;</comment>
                            <comment id="17514732" author="paulk" created="Wed, 30 Mar 2022 14:17:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chrylis&quot; class=&quot;user-hover&quot; rel=&quot;chrylis&quot;&gt;chrylis&lt;/a&gt; So we can resolve this from your point of view?&lt;/p&gt;</comment>
                            <comment id="17514735" author="chrylis" created="Wed, 30 Mar 2022 14:20:09 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt;, this does appear to be FIXED as of the current head. Fortunately, the problem was occurring in a small internal library, so I&apos;ll have that one on the snapshot, and the downstream consumers have no problems on the release 4.0.1.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10weg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>