<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:32:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-6068] Thread safety issue in AntBuilder leads to major memory leak</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-6068</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The code in &lt;tt&gt;AntBuilder&lt;/tt&gt; which manipulates the standard input and output stream is not thread safe: &lt;a href=&quot;https://github.com/groovy/groovy-core/blob/GROOVY_2_0_7/subprojects/groovy-ant/src/main/java/groovy/util/AntBuilder.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/GROOVY_2_0_7/subprojects/groovy-ant/src/main/java/groovy/util/AntBuilder.java#L207&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If 2 or more threads are using &lt;tt&gt;AntBuilder&lt;/tt&gt; at the same time then you end up with System.out or System.err holding a reference to a &lt;tt&gt;DemuxOutputStream&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Unfortunately this class (&lt;tt&gt;DemuxOutputStream&lt;/tt&gt;) ends up (via a long chain of objects) to hold references to &lt;tt&gt;AntTypeDefinitions&lt;/tt&gt; classes which are then never garbage collected.&lt;/p&gt;

&lt;p&gt;After I ran my code for a long time, I used JProfiler and generated the attached screenshot. I had over 180,000 instances of &lt;tt&gt;AntTypeDefinitions&lt;/tt&gt; (and growing...)&lt;/p&gt;

&lt;p&gt;I just checked the trunk on github for &lt;tt&gt;groovy-core&lt;/tt&gt; and can see it is the same code since 2.0.7. So I am assuming it is the same issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12816867">GROOVY-6068</key>
            <summary>Thread safety issue in AntBuilder leads to major memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="frenchyan">frenchyan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Mar 2013 19:48:45 +0000</created>
                <updated>Fri, 12 Apr 2013 16:55:14 +0000</updated>
                            <resolved>Fri, 29 Mar 2013 23:36:50 +0000</resolved>
                                    <version>2.0.7</version>
                                    <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.0-beta-1</fixVersion>
                                    <component>Ant integration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14480240" author="paulk" created="Tue, 26 Mar 2013 23:59:10 +0000"  >&lt;p&gt;Possibly a duplicate of (or related to) &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3488&quot; title=&quot;Groovy ant task memory leak (re-opened GROOVY-891)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3488&quot;&gt;&lt;del&gt;GROOVY-3488&lt;/del&gt;&lt;/a&gt;. Not sure I would consider it a blocker - it is likely this issue has been around for numerous years with people working around it by various means. Obviously we would still want to fix it. Patches welcome. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14474318" author="frenchyan" created="Thu, 28 Mar 2013 16:17:00 +0000"  >&lt;p&gt;Of course I cannot judge the level of priority of a bug and I think the final decision definitely needs to be made by the owners/maintainers of the project. The way I look at it is that groovy is a language used by many people and frameworks (ex: grails). As such, having a bug that leads to a memory leak is definitely bad. This is why I think it is pretty important to fix it (note that I am pointing out exactly where the bug is, not &quot;there is a memory leak, I don&apos;t know where it is&quot;).&lt;/p&gt;

&lt;p&gt;In regards to the bug itself, I have done some more thinking about it and really (besides not being thread safe), the big issue is manipulating &lt;tt&gt;System.xxx&lt;/tt&gt; during the life of the application. I checked the apache ant (1.8.2) source code and the &lt;b&gt;only&lt;/b&gt; place where the &lt;tt&gt;DemuxOutputStream&lt;/tt&gt; class is used and assigned to &lt;tt&gt;System.xxx&lt;/tt&gt; seems to be when &lt;tt&gt;ant&lt;/tt&gt; is invoked on the command line which does make sense. Manipulating &lt;tt&gt;System.xxx&lt;/tt&gt; during the life of the application does not make sense. If any other thread (even without triggering the thread safety bug I mentioned), issue a &lt;tt&gt;System.out.println(...)&lt;/tt&gt;, it will be funneled to the &lt;tt&gt;DemuxOutputStream&lt;/tt&gt; which does not make sense.&lt;/p&gt;

&lt;p&gt;I am no expert in apache ant, so I cannot speak to why this is done. From my quick understanding, it seems that the main purpose is so that if any (ant) task ends up using &lt;tt&gt;System.xxx&lt;/tt&gt; instead of the log associated to the task, it still gets funneled into the log associated to the task. This would require somebody familiar with the ant code base to chime in...&lt;/p&gt;

&lt;p&gt;On my end, I &quot;hacked&quot; around by entirely copying/pasting the &lt;tt&gt;AntBuilder&lt;/tt&gt; class into a &lt;tt&gt;AntBuilder6068&lt;/tt&gt; class and simply commenting out the use of &lt;tt&gt;System.xxx&lt;/tt&gt;. All my test and my program seems to work fine (the memory leak is gone). I do not know if this is the proper fix and what are the exact consequences of doing it. But it is clear that tweaking &lt;tt&gt;System.xxx&lt;/tt&gt; is just wrong.&lt;/p&gt;</comment>
                            <comment id="14480190" author="paulk" created="Thu, 28 Mar 2013 17:34:03 +0000"  >&lt;p&gt;Adjusting priority down - agree that it is important but blocker would mean we don&apos;t ever release again under any circumstances until this is fixed. I will put together a solution to hopefully make it thread-safe and allow stream &quot;saving&quot; to be disabled. If you could test it, that would be great. I will add a subsequent comment when it is ready.&lt;/p&gt;</comment>
                            <comment id="14474236" author="frenchyan" created="Thu, 28 Mar 2013 19:18:30 +0000"  >&lt;p&gt;Here is a small test (attached) demonstrating the issue. Simply run it with &lt;tt&gt;groovy Groovy6068&lt;/tt&gt; and you will (sooner or later) get an exception like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caught: java.lang.Exception: detected issue: org.apache.tools.ant.DemuxInputStream
java.lang.Exception: detected issue: org.apache.tools.ant.DemuxInputStream
	at Groovy6068$_run_closure1_closure4.doCall(Groovy6068.groovy:27)
	at Groovy6068$_run_closure1.doCall(Groovy6068.groovy:23)
	at Groovy6068.run(Groovy6068.groovy:8)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you change &lt;tt&gt;nbThreads&lt;/tt&gt; to &lt;tt&gt;1&lt;/tt&gt; the problem does not manifest itself&lt;/p&gt;</comment>
                            <comment id="14474292" author="frenchyan" created="Thu, 28 Mar 2013 19:19:23 +0000"  >&lt;p&gt;@Paul: I will gladly review the code change if you want me to...&lt;/p&gt;</comment>
                            <comment id="14480227" author="paulk" created="Thu, 28 Mar 2013 22:11:20 +0000"  >&lt;p&gt;If you can try the snapshot jar that would be great. All version (if that is what you are using) is here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://snapshots.repository.codehaus.org/org/codehaus/groovy/groovy-all/2.2.0-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://snapshots.repository.codehaus.org/org/codehaus/groovy/groovy-all/2.2.0-SNAPSHOT/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Look for the latest timestamped jar.&lt;/p&gt;

&lt;p&gt;Thanks, Paul.&lt;/p&gt;</comment>
                            <comment id="14474261" author="frenchyan" created="Fri, 29 Mar 2013 18:52:42 +0000"  >&lt;p&gt;I am not sure how to use the jar file. When I try it like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java -jar groovy-all-2.2.0-20130329.082238-105.jar Groovy6068.groovy
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I get exceptions:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.lang.ClassNotFoundException: org.apache.tools.ant.BuildException
	at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:306)
	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:247)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What is the proper way to test it out?&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Yan&lt;/p&gt;</comment>
                            <comment id="14480198" author="paulk" created="Fri, 29 Mar 2013 19:55:50 +0000"  >&lt;p&gt;The all jar doesn&apos;t bundle ant. Just add the appropriate ant jar(s) to your classpath. Alternatively, it will probably be good enough to rename to groovy-all-2.1.2.jar (or whatever version you are using) and drop it into your current distribution (back up the original might be useful). Note you might need the non-all jar depending on how you have things set up (e.g. using groovy from the commandline). Also, see here:&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/12391985/when-running-groovy-scripts-using-the-groovy-all-jar-how-do-you-specify-a-class&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/12391985/when-running-groovy-scripts-using-the-groovy-all-jar-how-do-you-specify-a-class&lt;/a&gt;&lt;br/&gt;
about calling via GroovyMain if you use the approach of adding jars to your Java classpath.&lt;/p&gt;</comment>
                            <comment id="14474238" author="frenchyan" created="Fri, 29 Mar 2013 23:05:35 +0000"  >&lt;p&gt;I just tried with &lt;tt&gt;groovy-all-2.2.0-20130329.082238-105.jar&lt;/tt&gt; and the problem is indeed gone. I left a couple of comments on github in regards to the change: on one end the thread safety issue is definitely addressed which means the memory leak won&apos;t happen again which is really good, but on the other end I am not sure what the right approach really is to handle what &lt;tt&gt;ant&lt;/tt&gt; is trying to achieve exactly. I guess again, the good news is that in that regard it is not worse than how it was prior to this change &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14480255" author="paulk" created="Fri, 29 Mar 2013 23:36:51 +0000"  >&lt;p&gt;Thanks for raising the issue and your testing of the solution.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12723124" name="Groovy6068.groovy" size="792" author="frenchyan" created="Thu, 28 Mar 2013 19:18:30 +0000"/>
                            <attachment id="12722936" name="Screen Shot 2013-03-26 at 1.58.54 PM.png" size="45412" author="frenchyan" created="Tue, 26 Mar 2013 19:48:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bz7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>