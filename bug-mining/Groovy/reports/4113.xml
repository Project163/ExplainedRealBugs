<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:12:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10075] Static compiler incorrectly typechecks extension modules</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10075</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I think I found a bug in static typechecking of extension modules.&lt;/p&gt;

&lt;p&gt;I tested two variants:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fixed generic: &lt;em&gt;static void getTestString(List&amp;lt;String&amp;gt; self)&lt;/em&gt;
	&lt;ol&gt;
		&lt;li&gt;In this case the bug affects both method calls and property access e.g. &lt;em&gt;integerList.getTestString()&lt;/em&gt; and &lt;em&gt;integerList&lt;/em&gt;&lt;em&gt;.testString&lt;/em&gt; both compile&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;With generic constraint: &lt;em&gt;static &amp;lt;S extends String&amp;gt; void getTestStringOrSubclass(List&amp;lt;S&amp;gt; self)&lt;/em&gt;&#160;
	&lt;ol&gt;
		&lt;li&gt;In this case the bug only affects property access e.g. &lt;em&gt;integerList.&lt;/em&gt;&lt;em&gt;getTestStringOrSubclass&lt;/em&gt;&lt;em&gt;()&lt;/em&gt; doesn&apos;t compile but &lt;em&gt;integerList.testStringOrSubclass&lt;/em&gt; compiles&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I prepared an example project here: &lt;a href=&quot;https://github.com/felixscheinost/test-groovy-static-extensions&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/felixscheinost/test-groovy-static-extensions&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please have a look at &lt;a href=&quot;https://github.com/felixscheinost/test-groovy-static-extensions/blob/master/src/main/groovy/org/example/App.groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/felixscheinost/test-groovy-static-extensions/blob/master/src/main/groovy/org/example/App.groovy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment>macOS 10.15.7&lt;br/&gt;
OpenJDK Zulu 11.0.3&lt;br/&gt;
Groovy 3.0.8&lt;br/&gt;
Gradle 6.8</environment>
        <key id="13377275">GROOVY-10075</key>
            <summary>Static compiler incorrectly typechecks extension modules</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="fesc">Felix Scheinost</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 May 2021 16:15:18 +0000</created>
                <updated>Wed, 9 Nov 2022 14:41:21 +0000</updated>
                            <resolved>Fri, 7 May 2021 20:38:01 +0000</resolved>
                                    <version>2.4.15</version>
                    <version>3.0.8</version>
                                    <fixVersion>4.0.0-beta-1</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>2.5.16</fixVersion>
                                    <component>Static compilation</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17340918" author="emilles" created="Fri, 7 May 2021 16:22:21 +0000"  >&lt;p&gt;Have you tried using 4.0a3?  There have been a lot of generics fixes made since Groovy 3.&lt;/p&gt;</comment>
                            <comment id="17340932" author="fesc" created="Fri, 7 May 2021 16:40:08 +0000"  >&lt;p&gt;I could reproduce the issue with &lt;em&gt;&apos;org.apache.groovy:groovy:4.0.0-alpha-3&apos;&lt;/em&gt; . I pushed a commit to the repo with the upgraded Groovy version.&lt;/p&gt;</comment>
                            <comment id="17340957" author="emilles" created="Fri, 7 May 2021 17:34:33 +0000"  >&lt;p&gt;Thanks for checking.  I&apos;ll have a look.&lt;/p&gt;</comment>
                            <comment id="17340982" author="emilles" created="Fri, 7 May 2021 18:09:32 +0000"  >&lt;p&gt;After looking up your extension methods, the static type checker uses assignment semantics to test the receiver, aka object expression, aka self argument against the declared parameter type of &quot;self&quot;.  In your case, &lt;tt&gt;List&lt;/tt&gt; is a match and then it checks the generic types.  You have &lt;tt&gt;String&lt;/tt&gt; for the type, which Groovy considers a universal assignment target.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep digging...&lt;/p&gt;

&lt;p&gt;Note: I changed your sample extension to use a generics bound which is non-final and added non-void return types for property recognition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; dgm;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Category10075 {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getString(List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; self) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &quot;&quot;;
  }
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;CS &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CharSequence&amp;gt; CharSequence getSequence(List&amp;lt;CS&amp;gt; self) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &quot;&quot;;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@groovy.transform.TypeChecked
void test() {
  List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; strings = []
  List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; numbers = []

  strings.getString()
  strings.string
  strings.getSequence()
  strings.sequence

  &lt;span class=&quot;code-comment&quot;&gt;// NOT OK: Compiles, but shouldn&apos;t compile
&lt;/span&gt;  numbers.getString()

  &lt;span class=&quot;code-comment&quot;&gt;// NOT OK: Compiles, but shouldn&apos;t compile
&lt;/span&gt;  numbers.string

  &lt;span class=&quot;code-comment&quot;&gt;// OK: Doesn&lt;span class=&quot;code-quote&quot;&gt;&apos;t compile, shouldn&apos;&lt;/span&gt;t compile
&lt;/span&gt;  numbers.getSequence()

  &lt;span class=&quot;code-comment&quot;&gt;// NOT OK: Compiles, but shouldn&apos;t compile
&lt;/span&gt;  numbers.sequence
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17340989" author="emilles" created="Fri, 7 May 2021 18:17:39 +0000"  >&lt;p&gt;Okay, because the method does not declare its own generic types, the lower path is used here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; typeCheckMethodsWithGenerics(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode receiver, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode[] argumentTypes, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MethodNode candidateMethod) {
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isExtensionMethod = candidateMethod &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ExtensionMethodNode;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isExtensionMethod
                &amp;amp;&amp;amp; receiver.isUsingGenerics()
                &amp;amp;&amp;amp; receiver.equals(CLASS_Type)
                &amp;amp;&amp;amp; !candidateMethod.getDeclaringClass().equals(CLASS_Type)) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; typeCheckMethodsWithGenerics(receiver.getGenericsTypes()[0].getType(), argumentTypes, candidateMethod);
        }
        &lt;span class=&quot;code-comment&quot;&gt;// both candidate method and receiver have &lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt; information so a check is possible
&lt;/span&gt;        GenericsType[] genericsTypes = candidateMethod.getGenericsTypes();
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; methodUsesGenerics = (genericsTypes != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; genericsTypes.length &amp;gt; 0);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isExtensionMethod &amp;amp;&amp;amp; methodUsesGenerics) {
            ClassNode[] dgmArgs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassNode[argumentTypes.length + 1];
            dgmArgs[0] = receiver;
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(argumentTypes, 0, dgmArgs, 1, argumentTypes.length);
            MethodNode extensionMethodNode = ((ExtensionMethodNode) candidateMethod).getExtensionMethodNode();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; typeCheckMethodsWithGenerics(extensionMethodNode.getDeclaringClass(), dgmArgs, extensionMethodNode, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; typeCheckMethodsWithGenerics(receiver, argumentTypes, candidateMethod, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And that means the receiver type is not properly checked against the &quot;self&quot; parameter type.&lt;/p&gt;</comment>
                            <comment id="17340993" author="emilles" created="Fri, 7 May 2021 18:32:58 +0000"  >&lt;p&gt;If I add generics (simulating fixing the bug in &lt;tt&gt;StaticTypeCheckingSupport#typeCheckMethodsWithGenerics&lt;/tt&gt;), I get the expected STC error for &quot;numbers.getString()&quot;:&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13025170/13025170_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17341005" author="emilles" created="Fri, 7 May 2021 18:54:39 +0000"  >&lt;p&gt;The code that satisfies property expressions with extension methods does not check the compatibility of the receiver type:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-comment&quot;&gt;// GROOVY-5568: the property may be defined by DGM
&lt;/span&gt;            List&amp;lt;ClassNode&amp;gt; dgmReceivers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(2);
            dgmReceivers.add(receiverType);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isPrimitiveType(receiverType))
                dgmReceivers.add(getWrapper(receiverType));
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ClassNode dgmReceiver : dgmReceivers) {
                List&amp;lt;MethodNode&amp;gt; methods = findDGMMethodsByNameAndArguments(getSourceUnit().getClassLoader(), dgmReceiver, &lt;span class=&quot;code-quote&quot;&gt;&quot;get&quot;&lt;/span&gt; + capName, ClassNode.EMPTY_ARRAY);
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MethodNode method : findDGMMethodsByNameAndArguments(getSourceUnit().getClassLoader(), dgmReceiver, &lt;span class=&quot;code-quote&quot;&gt;&quot;is&quot;&lt;/span&gt; + capName, ClassNode.EMPTY_ARRAY)) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Boolean_TYPE.equals(getWrapper(method.getReturnType()))) methods.add(method);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!methods.isEmpty()) {
                    List&amp;lt;MethodNode&amp;gt; bestMethods = chooseBestMethod(dgmReceiver, methods, ClassNode.EMPTY_ARRAY);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bestMethods.size() == 1) {
                        MethodNode getter = bestMethods.get(0);
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (visitor != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            visitor.visitMethod(getter);
                        }
                        ClassNode returnType = inferReturnTypeGenerics(dgmReceiver, getter, ArgumentListExpression.EMPTY_ARGUMENTS);
                        storeInferredTypeForPropertyExpression(pexp, returnType);
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (readMode) storeTargetMethod(pexp, getter);
                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                    }
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17341008" author="emilles" created="Fri, 7 May 2021 19:03:51 +0000"  >&lt;p&gt;Bingo!&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13025171/13025171_screenshot-2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17341024" author="emilles" created="Fri, 7 May 2021 20:38:01 +0000"  >&lt;p&gt;Beware when using property syntax and static compilation with lists.&#160; &quot;strings.name&quot; is being interpreted as &quot;strings*.name&quot;.&#160; It works as expected for STC.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13498517">GROOVY-10815</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13025170" name="screenshot-1.png" size="57641" author="emilles" created="Fri, 7 May 2021 18:32:41 +0000"/>
                            <attachment id="13025171" name="screenshot-2.png" size="63999" author="emilles" created="Fri, 7 May 2021 19:03:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qty8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>