<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:20:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10772] Possible memory leak, CacheableCallSite retains objects across invocations</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10772</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;We&apos;re seeing this in a test with Gradle + Groovy 4, so it&apos;s hard to reproduce exactly what we&apos;re seeing in pure Groovy.&lt;/p&gt;

&lt;p&gt;In Gradle, we run a build with a 150MB byte array (&quot;memory hog&quot;) added as a property to a Project object.&lt;br/&gt;
&lt;a href=&quot;https://github.com/gradle/gradle/blob/5c4e492a9dc1665e9a80235cc0fe9292ead88434/subprojects/workers/src/integTest/groovy/org/gradle/workers/internal/WorkerExecutorIntegrationTest.groovy#L228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gradle/gradle/blob/5c4e492a9dc1665e9a80235cc0fe9292ead88434/subprojects/workers/src/integTest/groovy/org/gradle/workers/internal/WorkerExecutorIntegrationTest.groovy#L228&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We then run a second build and third build to show that this doesn&apos;t cause the daemon to OOM by retaining old Project references.&lt;/p&gt;

&lt;p&gt;With Groovy 3, this test passes. With Groovy 3 + indy jars + indy compilation, this test passes.&lt;/p&gt;

&lt;p&gt;With Groovy 4 (4.0.5), this test fails with a OOM. &lt;br/&gt;
&lt;a href=&quot;https://ge.gradle.org/s/xywk2kx7iqdna/tests/:workers:embeddedIntegTest/org.gradle.workers.internal.WorkerExecutorIntegrationTest/does%20not%20leak%20project%20state%20across%20multiple%20builds?top-execution=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ge.gradle.org/s/xywk2kx7iqdna/tests/:workers:embeddedIntegTest/org.gradle.workers.internal.WorkerExecutorIntegrationTest/does%20not%20leak%20project%20state%20across%20multiple%20builds?top-execution=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve seen failures with Java 8 and 11, but it &lt;em&gt;seems&lt;/em&gt; like the real problem is easier to reproduce with Java 8. &lt;/p&gt;

&lt;p&gt;Looking at the heap dump, we can see `CacheableCallSite` is involved somehow with hanging on to the byte array. To make it easier to identified which generation the byte array came from, I set the first byte to 1, 2, 3... In the real failure, the OOM happens on the second invocation with the first generation byte array held by `CacheableCallSite`.&lt;/p&gt;

&lt;p&gt;This script produces a OOM with a similar looking GC-path:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Project {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] memoryHog = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[150*1024*1024]
}

def func = { 
   def project = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Project()   
   project.memoryHog[0] = 1
   println &lt;span class=&quot;code-quote&quot;&gt;&quot;hello $it &quot;&lt;/span&gt; + project
   project = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
}
func(1)

func = { 
   def project = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Project()   
   project.memoryHog[0] = 2
   println &lt;span class=&quot;code-quote&quot;&gt;&quot;hello $it &quot;&lt;/span&gt; + project
   project = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
}

func(2)

func = { 
   def project = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Project()   
   project.memoryHog[0] = 3
   println &lt;span class=&quot;code-quote&quot;&gt;&quot;hello $it &quot;&lt;/span&gt; + project
   project = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
}
func(3)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I&apos;m running this with:&lt;br/&gt;
&amp;gt; JAVA_OPTS=&quot;-Xmx512m -Xms256m -XX:+HeapDumpOnOutOfMemoryError&quot; groovy memoryhog.groovy&lt;/p&gt;

&lt;p&gt;This script runs with Groovy 3.0.12 with and without indy. This fails with Groovy 4.0.4.&lt;/p&gt;

&lt;p&gt;Would anything else be useful for diagnosing this?&lt;/p&gt;

&lt;p&gt;Maybe related to &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-10232&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-10232&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13483553">GROOVY-10772</key>
            <summary>Possible memory leak, CacheableCallSite retains objects across invocations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="big-guy">Sterling Greene</reporter>
                        <labels>
                            <label>breaking</label>
                    </labels>
                <created>Tue, 27 Sep 2022 23:55:35 +0000</created>
                <updated>Mon, 13 Oct 2025 15:35:45 +0000</updated>
                            <resolved>Thu, 22 Dec 2022 03:11:42 +0000</resolved>
                                    <version>4.0.3</version>
                    <version>4.0.4</version>
                    <version>4.0.5</version>
                                    <fixVersion>4.0.7</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17610303" author="big-guy" created="Wed, 28 Sep 2022 00:09:39 +0000"  >&lt;p&gt;I tried my reproducer with 4.0.0-4.0.5.&lt;/p&gt;

&lt;p&gt;4.0.0, 4.0.1, 4.0.2 do not fail with OOM.&lt;br/&gt;
4.0.3, 4.0.4, 4.0.5 fail with OOM.&lt;/p&gt;</comment>
                            <comment id="17610318" author="emilles" created="Wed, 28 Sep 2022 01:49:59 +0000"  >&lt;p&gt;I think the threshold for call site cache was lowered. There should be a system property for it. Away from my PC at the moment so I can&#8217;t search for it easily. &lt;/p&gt;</comment>
                            <comment id="17610329" author="dpukyle" created="Wed, 28 Sep 2022 02:44:55 +0000"  >&lt;p&gt;We can see that the value of sysprop &lt;tt&gt;groovy.indy.callsite.cache.size&lt;/tt&gt; was lowered to 4 from 16 in this &lt;a href=&quot;https://github.com/apache/groovy/commit/0752959ac5752282eea4f12e68659e9ac66a7c0e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;However, that lower value exists in &lt;a href=&quot;https://github.com/apache/groovy/blob/GROOVY_4_0_0/src/main/java/org/codehaus/groovy/vmplugin/v8/CacheableCallSite.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/groovy/blob/GROOVY_4_0_1/src/main/java/org/codehaus/groovy/vmplugin/v8/CacheableCallSite.java#L37&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0.1&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/groovy/blob/GROOVY_4_0_2/src/main/java/org/codehaus/groovy/vmplugin/v8/CacheableCallSite.java#L37&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0.2&lt;/a&gt;, all of which do not fail with OOM. I suspect this is not the only cause.&lt;/p&gt;</comment>
                            <comment id="17611282" author="dpukyle" created="Thu, 29 Sep 2022 23:25:51 +0000"  >&lt;p&gt;I ran a git-bisect operation between tags &lt;tt&gt;GROOVY_4_0_3&lt;/tt&gt; and &lt;tt&gt;GROOVY_4_0_2&lt;/tt&gt; and invoking the provided reproducer script, and came up with this commit as the cause:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;b9b340db4007af127a566cac8ba450e829dacf1f is the first bad commit
commit b9b340db4007af127a566cac8ba450e829dacf1f
Author: Daniel Sun &amp;lt;sunlan@apache.org&amp;gt;
Date:   Sat May 14 13:33:23 2022 +0800

    Tweak guards for receiver and parameters
    
    (cherry picked from commit 9dbd2406e2b3eb99ef7353f7945456d79bcda3ac)

 .../v8/IndyGuardsFiltersAndSignatures.java         | 21 +++++++++++++++-
 .../org/codehaus/groovy/vmplugin/v8/Selector.java  | 29 ++++------------------
 2 files changed, 25 insertions(+), 25 deletions(-)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17611334" author="dpukyle" created="Fri, 30 Sep 2022 03:31:09 +0000"  >&lt;p&gt;Looking at changes to &lt;tt&gt;o.c.g.v.v8.Selector&lt;/tt&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=big-guy&quot; class=&quot;user-hover&quot; rel=&quot;big-guy&quot;&gt;big-guy&lt;/a&gt; and I came up with this patch: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13049957/13049957_GROOVY-10772-4_0_3.patch&quot; title=&quot;GROOVY-10772-4_0_3.patch attached to GROOVY-10772&quot;&gt;GROOVY-10772-4_0_3.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This patch applies cleanly to both the &lt;tt&gt;GROOVY_4_0_3&lt;/tt&gt; tag and to HEAD of the &lt;tt&gt;GROOVY_4_0_X&lt;/tt&gt; branch, and in both cases &lt;tt&gt;$./gradlew test&lt;/tt&gt; succeeds with no broken tests.&lt;/p&gt;

&lt;p&gt;Having said all of this, I&apos;m outside of my depth and am not sure how to test the side-effects of this and how this might cause the closures in the example to prevent the large array from being gc&apos;d.&lt;/p&gt;</comment>
                            <comment id="17611466" author="blackdrag" created="Fri, 30 Sep 2022 09:30:21 +0000"  >&lt;p&gt;So basically the fix is not to use&lt;/p&gt;

&lt;p&gt;                MethodHandle test = SAME_CLASSES.bindTo(args)&lt;br/&gt;
                        .asCollector(Object[].class, pt.length)&lt;br/&gt;
                        .asType(MethodType.methodType(boolean.class, pt));&lt;/p&gt;

&lt;p&gt;which adds &lt;b&gt;args&lt;/b&gt; to the handle through the bind in SAME_CLASSES and instead use SAME_CLASS. Something like SAME_CLASSES could still be used, just that it should bind the argument classes, not the arguments.&lt;/p&gt;</comment>
                            <comment id="17634820" author="paulk" created="Wed, 16 Nov 2022 12:48:07 +0000"  >&lt;p&gt;I have merged your patch after further testing. I don&apos;t have a test added to the test suite as yet but my manual testing seemed to work well. If you have a chance to try the 4.0.7-SNAPSHOT version of Groovy, let me know if you have any problems. I am attempting to include a test and incorporate Jochen&apos;s suggestion but wanted to give folks at least a better baseline for independent testing.&lt;/p&gt;</comment>
                            <comment id="17635799" author="paulk" created="Fri, 18 Nov 2022 10:32:49 +0000"  >&lt;p&gt;I have made the amendments, so this is ready for further testing. This is only in the GROOVY_4_0_X branch not master at present.&lt;/p&gt;</comment>
                            <comment id="17649145" author="paulk" created="Mon, 19 Dec 2022 05:11:23 +0000"  >&lt;p&gt;This is a binary incompatible (breaking) change for an internal class. We don&apos;t anticipate any knock-on ramifications but we should monitor any feedback carefully.&lt;/p&gt;</comment>
                            <comment id="17649279" author="daniel_sun" created="Mon, 19 Dec 2022 11:29:23 +0000"  >&lt;blockquote&gt;
&lt;p&gt;This is a binary incompatible (breaking) change for an internal class. We don&apos;t anticipate any knock-on ramifications but we should monitor any feedback carefully.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We can add a new method and deprecate the old one &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13631191">GROOVY-11782</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13483886">GROOVY-10773</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13049957" name="GROOVY-10772-4_0_3.patch" size="3643" author="DPUkyle" created="Fri, 30 Sep 2022 03:26:01 +0000"/>
                            <attachment id="13049838" name="real-problem-gc-paths.png" size="203548" author="big-guy" created="Tue, 27 Sep 2022 23:55:14 +0000"/>
                            <attachment id="13049839" name="reproducer-gc-paths.png" size="148804" author="big-guy" created="Tue, 27 Sep 2022 23:55:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>groovy</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 47 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18wg0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>