<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:21:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10918] Memory leak: local variable values are not discarded</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10918</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When I run the code below with 3 statements with closures inside the method the local var (parameter) values (all 4 of them) are staying in memory.&lt;br/&gt;
I don&apos;t see the same problem if I run corresponding Java code with lambdas.&lt;/p&gt;

&lt;p&gt;Run TestOOM.groovy with &lt;br/&gt;
-Xmx600M -XX:+HeapDumpOnOutOfMemoryError&lt;/p&gt;

&lt;p&gt;Notice groovy fails:&lt;br/&gt;
Y&lt;br/&gt;
Z&lt;br/&gt;
java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
Dumping heap to java_pid147612.hprof ...&lt;br/&gt;
Heap dump file created &lt;span class=&quot;error&quot;&gt;&amp;#91;497819587 bytes in 0.136 secs&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caught: java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
&#160; &#160; at test.TestOOM.test(TestOOM.groovy:31)&lt;br/&gt;
&#160; &#160; at test.TestOOM.run(TestOOM.groovy:41)&lt;/p&gt;

&lt;p&gt;But Java version does not.&lt;/p&gt;

&lt;p&gt;It looks like all the values of s are still in memory (see screenshot), even though previous values should be discarded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13521641">GROOVY-10918</key>
            <summary>Memory leak: local variable values are not discarded</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="arysin">Andriy Rysin</reporter>
                        <labels>
                            <label>MemoryLeak</label>
                    </labels>
                <created>Thu, 26 Jan 2023 17:38:55 +0000</created>
                <updated>Mon, 13 Mar 2023 12:14:13 +0000</updated>
                            <resolved>Thu, 16 Feb 2023 15:04:40 +0000</resolved>
                                    <version>4.0.9</version>
                                    <fixVersion>2.5.22</fixVersion>
                    <fixVersion>3.0.16</fixVersion>
                    <fixVersion>4.0.10</fixVersion>
                                    <component>bytecode</component>
                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17684323" author="arysin" created="Sun, 5 Feb 2023 16:46:13 +0000"  >&lt;p&gt;Here&apos;s another example: TestOOMIcj.java - uses internal class.&lt;/p&gt;

&lt;p&gt;Works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
JAVA_TOOL_OPTIONS=&lt;span class=&quot;code-quote&quot;&gt;&quot;-Xmx600M&quot;&lt;/span&gt; java TestOOMIcj.java&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Throws OOM:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cp TestOOMIcj.java TestOOMIcj.groovy
JAVA_TOOL_OPTIONS=&lt;span class=&quot;code-quote&quot;&gt;&quot;-Xmx600M&quot;&lt;/span&gt; groovy TestOOMIcj.groovy
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17687464" author="arysin" created="Sat, 11 Feb 2023 16:57:16 +0000"  >&lt;p&gt;Interestingly if I don&apos;t reuse the same local var and reset intermediate ones to null the script works (TestOOM_works.groovy)&lt;/p&gt;</comment>
                            <comment id="17687466" author="arysin" created="Sat, 11 Feb 2023 17:39:23 +0000"  >&lt;p&gt;Possibly related to &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7886&quot; title=&quot;Memory leak when variable is assigned multiple times within the same scope&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7886&quot;&gt;&lt;del&gt;GROOVY-7886&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="17687622" author="emilles" created="Sun, 12 Feb 2023 20:10:36 +0000"  >&lt;p&gt;What kind of behavior do you get with lambdas?  They should match java and do not require creation of Integer parameter and Closure object.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.stream.Collectors

test(&lt;span class=&quot;code-quote&quot;&gt;&quot;W&quot;&lt;/span&gt;*(100*1024*1024))
@groovy.transform.CompileStatic
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s) {
  s = s.chars().mapToObj(ch -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;X&quot;&lt;/span&gt;).collect(Collectors.joining())
  println s.charAt(0)
  s = s.chars().mapToObj(ch -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;Y&quot;&lt;/span&gt;).collect(Collectors.joining())
  println s.charAt(0)
  s = s.chars().mapToObj(ch -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;Z&quot;&lt;/span&gt;).collect(Collectors.joining())
  println s.charAt(0)
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; s
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17687627" author="arysin" created="Sun, 12 Feb 2023 20:31:51 +0000"  >&lt;p&gt;So initially I thought it was related to closures, but then I used inner class instead, and it has the same problem - see comment above with TestOOMIcj.java - same code runs in Java but gets OOM in groovy.&lt;/p&gt;

&lt;p&gt;It looks like a problem with local output variables not being cleaned up. Reusing &apos;s&apos; leads to OOM even though previous values should be discarded, if I create new var for each transformation (and set previous ones to null) - this works.&lt;/p&gt;

&lt;p&gt;Java seems to be able to drop intermediate values but groovy does not.&lt;/p&gt;</comment>
                            <comment id="17689340" author="emilles" created="Wed, 15 Feb 2023 21:11:40 +0000"  >&lt;p&gt;Given your example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@groovy.transform.CompileStatic &lt;span class=&quot;code-comment&quot;&gt;// line 1
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s) {
  s = s.chars().mapToObj{&lt;span class=&quot;code-quote&quot;&gt;&quot;X&quot;&lt;/span&gt;}.collect(Collectors.joining())
  println s.charAt(0)
  s = s.chars().mapToObj{&lt;span class=&quot;code-quote&quot;&gt;&quot;Y&quot;&lt;/span&gt;}.collect(Collectors.joining())
  println s.charAt(0)
  s = s.chars().mapToObj{&lt;span class=&quot;code-quote&quot;&gt;&quot;Z&quot;&lt;/span&gt;}.collect(Collectors.joining())
  println s.charAt(0)
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; s
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The bytecode for the method looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test(java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s);
      0  aload_1 [s]
      1  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.chars() : java.util.stream.IntStream [92]
      4  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scratch$_test_closure1 [94]
      7  dup
      8  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
      9  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     10  invokespecial Scratch$_test_closure1(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) [97]
     13  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(groovy.lang.Closure) : java.util.function.IntFunction [100]
     18  invokeinterface java.util.stream.IntStream.mapToObj(java.util.function.IntFunction) : java.util.stream.Stream [106] [nargs: 2]
     23  invokestatic java.util.stream.Collectors.joining() : java.util.stream.Collector [112]
     26  invokeinterface java.util.stream.Stream.collect(java.util.stream.Collector) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [118] [nargs: 2]
     31  astore_2
     32  aload_2
     33  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [61]
     38  astore_1 [s]
     39  aload_2
     40  pop
     41  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     42  aload_1 [s]
     43  iconst_0
     44  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.charAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; [122]
     47  invokestatic java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt; [128]
     50  invokevirtual Scratch.println(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : void [131]
     53  aconst_null
     54  pop
     55  aload_1 [s]
     56  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.chars() : java.util.stream.IntStream [92]
     59  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scratch$_test_closure2 [133]
     62  dup
     63  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     64  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     65  invokespecial Scratch$_test_closure2(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) [134]
     68  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(groovy.lang.Closure) : java.util.function.IntFunction [100]
     73  invokeinterface java.util.stream.IntStream.mapToObj(java.util.function.IntFunction) : java.util.stream.Stream [106] [nargs: 2]
     78  invokestatic java.util.stream.Collectors.joining() : java.util.stream.Collector [112]
     81  invokeinterface java.util.stream.Stream.collect(java.util.stream.Collector) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [118] [nargs: 2]
     86  astore_3
     87  aload_3
     88  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [61]
     93  astore_1 [s]
     94  aload_3
     95  pop
     96  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     97  aload_1 [s]
     98  iconst_0
     99  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.charAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; [122]
    102  invokestatic java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt; [128]
    105  invokevirtual Scratch.println(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : void [131]
    108  aconst_null
    109  pop
    110  aload_1 [s]
    111  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.chars() : java.util.stream.IntStream [92]
    114  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scratch$_test_closure3 [136]
    117  dup
    118  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    119  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    120  invokespecial Scratch$_test_closure3(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) [137]
    123  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(groovy.lang.Closure) : java.util.function.IntFunction [100]
    128  invokeinterface java.util.stream.IntStream.mapToObj(java.util.function.IntFunction) : java.util.stream.Stream [106] [nargs: 2]
    133  invokestatic java.util.stream.Collectors.joining() : java.util.stream.Collector [112]
    136  invokeinterface java.util.stream.Stream.collect(java.util.stream.Collector) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [118] [nargs: 2]
    141  astore 4
    143  aload 4
    145  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [61]
    150  astore_1 [s]
    151  aload 4
    153  pop
    154  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    155  aload_1 [s]
    156  iconst_0
    157  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.charAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; [122]
    160  invokestatic java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt; [128]
    163  invokevirtual Scratch.println(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : void [131]
    166  aconst_null
    167  pop
    168  aload_1 [s]
    169  areturn
      Line numbers:
        [pc: 0, line: 3]
        [pc: 41, line: 4]
        [pc: 55, line: 5]
        [pc: 96, line: 6]
        [pc: 110, line: 7]
        [pc: 154, line: 8]
        [pc: 168, line: 9]
      Local variable table:
        [pc: 0, pc: 170] local: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index: 0 type: Scratch
        [pc: 0, pc: 170] local: s index: 1 type: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it appears to be using local variable slots 2, 3 and 4 to save intermediate results before assigning back to &quot;s&quot; (slot 1).&lt;/p&gt;</comment>
                            <comment id="17689345" author="emilles" created="Wed, 15 Feb 2023 21:22:58 +0000"  >&lt;p&gt;&lt;tt&gt;BinaryExpressionHelper&lt;/tt&gt; accounts for chain assignment &quot;x = y = z&quot; when processing &quot;y = z&quot; as well as assignment expression being the last in a method, which makes it the return value.  So, it saves the value to a temporary variable:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
rhsValueId = compileStack.defineTemporaryVariable(&lt;span class=&quot;code-quote&quot;&gt;&quot;$rhs&quot;&lt;/span&gt;, rhsType, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;br/&gt;
If you use &quot;direct assignment&quot;, that is declaring a variable like &quot;String s1 = ...&quot; it does not do this.  This is what your &lt;tt&gt;TestOOM_works.groovy&lt;/tt&gt; demonstrates.&lt;/p&gt;</comment>
                            <comment id="17689380" author="arysin" created="Wed, 15 Feb 2023 22:44:00 +0000"  >&lt;p&gt;Thank you for looking into this! So:&lt;/p&gt;

&lt;p&gt;1) if I reassign the var 10 times in the method I use 10x or memory?&lt;/p&gt;

&lt;p&gt;2) is it different behavior than in Java (I don&apos;t see the same code to do OOM with java)&lt;/p&gt;</comment>
                            <comment id="17689394" author="emilles" created="Wed, 15 Feb 2023 23:07:32 +0000"  >&lt;p&gt;I would guess that javac handles variable assignment without a temporary.  For groovyc, a left side variable expression could refer to a dynamic variable, local variable, field, setter method or something dynamic.  In order to deal with all this, classgen tries to provide a unified approach for multiple options.  &lt;a href=&quot;https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/classgen/asm/BinaryExpressionHelper.java#L380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/classgen/asm/BinaryExpressionHelper.java#L380&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I do think I can skip the temp when the target is a local variable (like a parameter in this case). &lt;br/&gt;
 I&apos;m trying that out right now.  My experiment produces this, in case you want to compare to the previous bytecode output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test(java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s);
      0  aload_1 [s]
      1  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.chars() : java.util.stream.IntStream [92]
      4  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scratch$_test_closure1 [94]
      7  dup
      8  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
      9  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     10  invokespecial Scratch$_test_closure1(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) [97]
     13  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(groovy.lang.Closure) : java.util.function.IntFunction [100]
     18  invokeinterface java.util.stream.IntStream.mapToObj(java.util.function.IntFunction) : java.util.stream.Stream [106] [nargs: 2]
     23  invokestatic java.util.stream.Collectors.joining() : java.util.stream.Collector [112]
     26  invokeinterface java.util.stream.Stream.collect(java.util.stream.Collector) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [118] [nargs: 2]
     31  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [61]
     36  astore_1 [s]
     37  aload_1 [s]
     38  pop
     39  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     40  aload_1 [s]
     41  iconst_0
     42  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.charAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; [122]
     45  invokestatic java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt; [128]
     48  invokevirtual Scratch.println(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : void [131]
     51  aconst_null
     52  pop
     53  aload_1 [s]
     54  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.chars() : java.util.stream.IntStream [92]
     57  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scratch$_test_closure2 [133]
     60  dup
     61  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     62  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     63  invokespecial Scratch$_test_closure2(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) [134]
     66  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(groovy.lang.Closure) : java.util.function.IntFunction [100]
     71  invokeinterface java.util.stream.IntStream.mapToObj(java.util.function.IntFunction) : java.util.stream.Stream [106] [nargs: 2]
     76  invokestatic java.util.stream.Collectors.joining() : java.util.stream.Collector [112]
     79  invokeinterface java.util.stream.Stream.collect(java.util.stream.Collector) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [118] [nargs: 2]
     84  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [61]
     89  astore_1 [s]
     90  aload_1 [s]
     91  pop
     92  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
     93  aload_1 [s]
     94  iconst_0
     95  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.charAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; [122]
     98  invokestatic java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt; [128]
    101  invokevirtual Scratch.println(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : void [131]
    104  aconst_null
    105  pop
    106  aload_1 [s]
    107  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.chars() : java.util.stream.IntStream [92]
    110  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Scratch$_test_closure3 [136]
    113  dup
    114  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    115  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    116  invokespecial Scratch$_test_closure3(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) [137]
    119  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(groovy.lang.Closure) : java.util.function.IntFunction [100]
    124  invokeinterface java.util.stream.IntStream.mapToObj(java.util.function.IntFunction) : java.util.stream.Stream [106] [nargs: 2]
    129  invokestatic java.util.stream.Collectors.joining() : java.util.stream.Collector [112]
    132  invokeinterface java.util.stream.Stream.collect(java.util.stream.Collector) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; [118] [nargs: 2]
    137  invokedynamic 2 &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; [61]
    142  astore_1 [s]
    143  aload_1 [s]
    144  pop
    145  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    146  aload_1 [s]
    147  iconst_0
    148  invokevirtual java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.charAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; [122]
    151  invokestatic java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) : java.lang.&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt; [128]
    154  invokevirtual Scratch.println(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : void [131]
    157  aconst_null
    158  pop
    159  aload_1 [s]
    160  areturn
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17689399" author="emilles" created="Wed, 15 Feb 2023 23:39:13 +0000"  >&lt;p&gt;In addition to declaring a new variable for each string, you could refactor to have each large computation as a separate method.  At the end of each method frame, the locals (including temporary) are discarded.&lt;/p&gt;</comment>
                            <comment id="17689441" author="arysin" created="Thu, 16 Feb 2023 01:51:01 +0000"  >&lt;p&gt;Thank you, so my original script had several dozen of String.replaceAll() (it&apos;s for cleaning up texts for NLP, and it grew over several years).&lt;/p&gt;

&lt;p&gt;In general it was:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
text = text.replaceAll(...)
text = text.replaceAll(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It was all good until somebody said they need to run my script on 300MB text file and it choke.&lt;/p&gt;

&lt;p&gt;So I&apos;ve split the code into dozen of methods but I still have 2-5 replacements in each, and if text is 300MB then each replacement still multiply the memory requirement.&lt;/p&gt;

&lt;p&gt;I&apos;ve also started using different var names, but it complicates the logic:&lt;/p&gt;

&lt;p&gt;a) I have to make sure in each next replaceAll I don&apos;t forget to use the right var (which is if you reorder/refactor may be non-trivial)&lt;/p&gt;

&lt;p&gt;b) it gets worse if you have conditional replacements - then just introducing new var does not work, e.g.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def t10 = ...
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( t10.contains(&lt;span class=&quot;code-quote&quot;&gt;&apos;\u2028&apos;&lt;/span&gt;) ) {
    def t11 = t10.replaceAll(/\u2028\n?/, &lt;span class=&quot;code-quote&quot;&gt;&apos;\n&apos;&lt;/span&gt;)
t10 = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// shall I force it here?
&lt;/span&gt;    t10 = t11
t11 = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// shall I force it here?
&lt;/span&gt;}

def t12 = t10.replaceAll(...)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17689800" author="emilles" created="Thu, 16 Feb 2023 15:04:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/fc7a4f875ce9109be284ce8459a560192d35f86e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/fc7a4f875ce9109be284ce8459a560192d35f86e&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13054825" name="TestOOM.groovy" size="500" author="arysin" created="Thu, 26 Jan 2023 17:33:27 +0000"/>
                            <attachment id="13055163" name="TestOOMIcj.java" size="901" author="arysin" created="Sun, 5 Feb 2023 16:43:14 +0000"/>
                            <attachment id="13054824" name="TestOOMJ.java" size="662" author="arysin" created="Thu, 26 Jan 2023 17:33:32 +0000"/>
                            <attachment id="13055363" name="TestOOM_works.groovy" size="583" author="arysin" created="Sat, 11 Feb 2023 16:56:15 +0000"/>
                            <attachment id="13054823" name="groovy_oom.png" size="79253" author="arysin" created="Thu, 26 Jan 2023 17:37:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1fer4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>