<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:21:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4832] when two java classes extend a groovy class, both subclasses have a metaClass for whichever subclass was loaded first</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4832</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;&lt;b&gt;Original problem:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I have an abstract groovy class, and two (or more) concrete java subclasses extend it.  The superclass has an abstract method, which each concrete subclass overrides (of course).&lt;/p&gt;

&lt;p&gt;When I use just one subclass, everything works fine: I call a superclass method that calls the abstract method, and I get the behavior I expect.  But when the other subclass has already been loaded, things are different.  Then, I get an IllegalArgumentException: object is not an instance of declaring class.&lt;/p&gt;

&lt;p&gt;This problem corresponds to testGenericSubclassWithBafflingSymptom() in the attached junit tests.  See that test for additional details.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Simpler case that illustrates the likely underlying problem (and does not involve generics):&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I have an abstract groovy class, and two concrete java subclasses extend it.  If I have an instance of just one of the subclasses, then instance.metaClass.theClass returns exactly what I expect.  But if I&apos;ve already loaded the other subclass, then the metaClass on an instance of &lt;b&gt;either&lt;/b&gt; subclass is for the class that was used first!&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// snippet of the groovy version of testSubclass(), also attached
&lt;/span&gt;      OtherConcreteJavaSubclass unrelatedInstance = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OtherConcreteJavaSubclass();
      ConcreteJavaSubclass instance = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcreteJavaSubclass();
      assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; one works&quot;&lt;/span&gt;, OtherConcreteJavaSubclass, unrelatedInstance.metaClass.theClass)
      assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;but &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; one is wrong&quot;&lt;/span&gt;, ConcreteJavaSubclass, instance.metaClass.theClass)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;This mixture of groovy and java may sound a little odd, but we actually ran into it when converting an existing class from java to groovy, and it stumped us for quite a while.&lt;/p&gt;</description>
                <environment>WinXP</environment>
        <key id="12818087">GROOVY-4832</key>
            <summary>when two java classes extend a groovy class, both subclasses have a metaClass for whichever subclass was loaded first</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="lgdean">Laura Dean</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 May 2011 15:34:05 +0000</created>
                <updated>Sun, 4 Sep 2011 15:00:03 +0000</updated>
                            <resolved>Sun, 4 Sep 2011 15:00:03 +0000</resolved>
                                    <version>1.7.10</version>
                    <version>1.8.0</version>
                                    <fixVersion>1.8.2</fixVersion>
                    <fixVersion>1.9-beta-3</fixVersion>
                    <fixVersion>1.7.11</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14479644" author="alex.heneveld" created="Wed, 13 Jul 2011 18:37:04 +0000"  >&lt;p&gt;This bit us as well--as it manifests subtly, because unit tests pass when run in isolation but once both classes are loaded the same code will throw the exception mentioned above:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalArgumentException: object is not an instance of declaring class
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.codehaus.groovy.runtime.callsite.PogoMetaMethodSite$PogoCachedMethodSite.invoke(PogoMetaMethodSite.java:226)
	at org.codehaus.groovy.runtime.callsite.PogoMetaMethodSite.callCurrent(PogoMetaMethodSite.java:52)
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.callCurrent(AbstractCallSite.java:145)
	at instance.methodFromGroovySuperclass
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Suggest high priority as this takes a long time to track down and mixing Java and Groovy will be common in a large team.&lt;/p&gt;

&lt;p&gt;The simple &lt;b&gt;workaround&lt;/b&gt; we use is to put the following in the groovy superclass constructor (getting the metaclass of the java subclass, curiously, seems to work):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;setMetaClass(DefaultGroovyMethods.getMetaClass(getClass()))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14471554" author="blackdrag" created="Mon, 18 Jul 2011 17:43:19 +0000"  >&lt;p&gt;closed wrong issue&lt;/p&gt;</comment>
                            <comment id="14471717" author="blackdrag" created="Fri, 2 Sep 2011 17:35:35 +0000"  >&lt;p&gt;when I wrote the only place it could be going wrong, the method $getStaticMetaClass from bytecode to Java, I came up with this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; MetaClass $getStaticMetaClass() {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass()!=A.class) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ScriptBytecodeAdapter.initMetaClass(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    ClassInfo ci = A.$staticClassInfo
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ci==&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      ci = ClassInfo.getClassInfo(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass())
      A.$staticClassInfo = ci
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ci.getMetaClass()
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;compiling this to bytecode and comparing it with the actual bytecode revealed, that my translation to Java is wrong. In the byteocde&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; $getStaticMetaClass()Lgroovy/lang/MetaClass;
     ALOAD 0
     INVOKEVIRTUAL java/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.getClass ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;;
     INVOKESTATIC A.$get$$&lt;span class=&quot;code-keyword&quot;&gt;class$&lt;/span&gt;A ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;;
     IF_ACMPNE L0
     ALOAD 0
     INVOKESTATIC org/codehaus/groovy/runtime/ScriptBytecodeAdapter.initMetaClass (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Lgroovy/lang/MetaClass;
     ARETURN
    L0
     GETSTATIC A.$staticClassInfo : Lorg/codehaus/groovy/reflection/ClassInfo;
     ASTORE 1
     ALOAD 1
     IFNONNULL L1
     ALOAD 0
     INVOKEVIRTUAL java/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.getClass ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;;
     INVOKESTATIC org/codehaus/groovy/reflection/ClassInfo.getClassInfo (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;;)Lorg/codehaus/groovy/reflection/ClassInfo;
     DUP
     ASTORE 1
     PUTSTATIC A.$staticClassInfo : Lorg/codehaus/groovy/reflection/ClassInfo;
    L1
     ALOAD 1
     INVOKEVIRTUAL org/codehaus/groovy/reflection/ClassInfo.getMetaClass ()Lgroovy/lang/MetaClass;
     ARETURN
     MAXSTACK = 2
     MAXLOCALS = 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the IF_ACMPNE should be a IF_ACMPEQ. Doing this change makes the tests in the attached project pass, while it does not without. IF_ACMPNE means we don&apos;t do this.getClass()!=A.class, we do this.getClass()==A.class and then it becomes clear that the code above makes no sense like this.&lt;/p&gt;</comment>
                            <comment id="14471660" author="blackdrag" created="Sun, 4 Sep 2011 15:00:03 +0000"  >&lt;p&gt;I corrected the coe as stated before, would be nice if people could test this&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722881" name="groovy-subclass-project.zip" size="224158" author="lgdean" created="Wed, 18 May 2011 15:34:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2clrr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12312220" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Testcase included</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="11060"><![CDATA[Yes]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>