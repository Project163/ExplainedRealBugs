<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:55:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8163] Groovy scripts can disable java security manager and escape sandbox</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8163</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Consider following test&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovytest;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.util.Eval;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.*;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.net.URL;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.security.AccessController;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.security.PrivilegedAction;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroovySecurityTest {

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RESTRICTED_PERMISSIONS_FOR_SCRIPT_ONLY_POLICY = &lt;span class=&quot;code-quote&quot;&gt;&quot;/restrictedPermissionsForScriptOnlyPolicy.txt&quot;&lt;/span&gt;;

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; POLICY = RESTRICTED_PERMISSIONS_FOR_SCRIPT_ONLY_POLICY;

	@BeforeClass
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void setPolicy() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; dirTest = GroovySecurityTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getProtectionDomain().getCodeSource().getLocation().toString();
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; dirGroovy = Eval.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getProtectionDomain().getCodeSource().getLocation().toString();
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;dir.test&quot;&lt;/span&gt;,dirTest + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;dir.groovy&quot;&lt;/span&gt;,dirGroovy);
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; URL policy = GroovySecurityTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getResource(POLICY);
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.security.policy&quot;&lt;/span&gt;, policy.toString());
	}
	
	
	@Before
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setSecurityManager() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setSecurityManager(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt;());
	}

	@After
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeSecurityManager() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		AccessController.doPrivileged(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;() {
			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; run() {
				&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setSecurityManager(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
			}
		});
	}

	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void doesNotChangeScriptPermissionsUsungPrivateFieldAccess() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			AccessController.doPrivileged(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;() {

                @Override
                &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; run() {
                    Eval.me(&lt;span class=&quot;code-quote&quot;&gt;&quot;getClass().protectionDomain0.hasAllPerm = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;&quot;&lt;/span&gt;
                                    + &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setSecurityManager(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);&quot;&lt;/span&gt;
                                    + &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;);
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                }
            });
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
		}

		Assert.assertNotNull(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getSecurityManager());
	}

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with following policy file restrictedPermissionsForScriptOnlyPolicy.txt&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grant codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.test}&quot;&lt;/span&gt; {
	permission java.security.AllPermission;
};

grant codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.groovy}&quot;&lt;/span&gt; {
	permission java.security.AllPermission;
};

grant {
};

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails: security manager is not set any more when the test assertion is checked.&lt;br/&gt;
It happens because CachedField from org.codehaus.groovy.reflection is created withing trusted code base (groovy jar) and gives access to the field to untrusted scripts without any security checks. The same problem relates to CachedMethod which would allow any script to access protected method java.lang.ClassLoader#defineClass(java.lang.String, byte[], int, int, java.security.ProtectionDomain) that can be misused to manipulate code sources of classes loaded from script to give them all permissions.&lt;/p&gt;

&lt;p&gt;It also appears that if I remove permissions from groovy.jar using more restrictive policy using following policy file restrictedPermissionsPolicy.txt&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grant  codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.test}&quot;&lt;/span&gt; {
    permission java.lang.RuntimePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
    permission java.security.SecurityPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
     permission java.io.FilePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;&amp;lt;ALL FILES&amp;gt;&amp;gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
    permission java.util.PropertyPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
    permission groovy.security.GroovyCodeSourcePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
};

grant  codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.groovy}&quot;&lt;/span&gt; {
    permission java.lang.RuntimePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
    permission java.security.SecurityPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
    permission java.io.FilePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;&amp;lt;ALL FILES&amp;gt;&amp;gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
    permission java.util.PropertyPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
    permission groovy.security.GroovyCodeSourcePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
};

grant {
    permission java.lang.RuntimePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;accessDeclaredMembers&quot;&lt;/span&gt;;
};

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;it has a consequence that groovy can not access even some public methods on bean properties as shown in the following test&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovytest;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.util.Eval;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.*;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.net.URL;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.security.AccessController;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.security.PrivilegedAction;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroovyBeanTest {

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RESTRICTED_PERMISSIONS_POLICY = &lt;span class=&quot;code-quote&quot;&gt;&quot;/restrictedPermissionsPolicy.txt&quot;&lt;/span&gt;;

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; POLICY = RESTRICTED_PERMISSIONS_POLICY;

	@BeforeClass
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void setPolicy() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; dirTest = GroovyBeanTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getProtectionDomain().getCodeSource().getLocation().toString();
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; dirGroovy = Eval.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getProtectionDomain().getCodeSource().getLocation().toString();
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;dir.test&quot;&lt;/span&gt;,dirTest + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;dir.groovy&quot;&lt;/span&gt;,dirGroovy);
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; URL policy = GroovyBeanTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getResource(POLICY);
		&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.security.policy&quot;&lt;/span&gt;, policy.toString());
	}
	
	
	@Before
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setSecurityManager() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setSecurityManager(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt;());
	}

	@After
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeSecurityManager() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		AccessController.doPrivileged(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;() {
			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; run() {
				&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setSecurityManager(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
			}
		});
	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; BeanInterface{
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getName();
	}

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Bean &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; BeanInterface{
		&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; _name = &lt;span class=&quot;code-quote&quot;&gt;&quot;bean&quot;&lt;/span&gt;;
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getName(){
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; _name;
		}

	}

	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void returnsBeanPropertyValue() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		AccessController.doPrivileged(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;() {

			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; run() {
				Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;bean&quot;&lt;/span&gt;, Eval.x(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Bean(), &lt;span class=&quot;code-quote&quot;&gt;&quot;x.name&quot;&lt;/span&gt;));
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
			}
		});
	}


	&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BeanClass {
		&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = &lt;span class=&quot;code-quote&quot;&gt;&quot;bean&quot;&lt;/span&gt;;
	}

	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void returnsBeanClassName() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		AccessController.doPrivileged(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;() {

			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; run() {
				Assert.assertEquals(BeanClass.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName(), Eval.x(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BeanClass(), &lt;span class=&quot;code-quote&quot;&gt;&quot;x.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;name&quot;&lt;/span&gt;));
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
			}
		});
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The both tests fail as the bean properties can not be found by groovy.&lt;br/&gt;
It turned out that I can not run the both tests in one process, make sure you run them separately.&lt;/p&gt;

&lt;p&gt;In order to fix this issue for my open source project Freeplane I have to patch groovy code. It turned out to be possible. &lt;br/&gt;
So I want to share the fix with you and ask you to integrate it.&lt;/p&gt;

&lt;p&gt;The fix is based on groovy version 2.4.9 and I think that it can be applied to any Groovy version.&lt;/p&gt;

&lt;p&gt;You only need to check for access permissions at the relevant places to make sure that they are not leaked from groovy (which needs them to work properly) to the untrusted script&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.codehaus.groovy.reflection;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.reflect.Field;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.reflect.Method;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.reflect.Modifier;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.reflect.ReflectPermission;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.lang.GroovyObject;

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;AccessPermissionChecker {

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ReflectPermission REFLECT_PERMISSION = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReflectPermission(&lt;span class=&quot;code-quote&quot;&gt;&quot;suppressAccessChecks&quot;&lt;/span&gt;);

	&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void checkAccessPermission(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; declaringClass, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; modifiers, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isAccessible) {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt; securityManager = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getSecurityManager();
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isAccessible &amp;amp;&amp;amp; securityManager != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((modifiers &amp;amp; (Modifier.PUBLIC | Modifier.PROTECTED)) == 0
						&amp;amp;&amp;amp; !GroovyObject.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;isAssignableFrom(declaringClass)) {
                        securityManager.checkPermission(REFLECT_PERMISSION);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((modifiers &amp;amp; (Modifier.PUBLIC)) == 0
					&amp;amp;&amp;amp; declaringClass.equals(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.class)){
					securityManager.checkCreateClassLoader();
				}
		}
	}

	&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkAccessPermission(Method method) {
		checkAccessPermission(method.getDeclaringClass(), method.getModifiers(), method.isAccessible()
		);
	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void checkAccessPermission(Field field) {
		checkAccessPermission(field.getDeclaringClass(), field.getModifiers(), field.isAccessible()
		);
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;patching your classes as follows:&lt;/p&gt;

&lt;p&gt;CachedField.java:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the property of the given object
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; RuntimeException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the property could not be evaluated
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; getProperty(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; object) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            AccessPermissionChecker.checkAccessPermission(field);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AccessControlException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Illegal access to field&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + field.getName());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; field.get(object);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyRuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot get the property &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt;.&quot;&lt;/span&gt;, e);
        }
    }

    /**
     * Sets the property on the given object to the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; value
     *
     * @param object on which to set the property
     * @param newValue the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; value of the property
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; RuntimeException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the property could not be set
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setProperty(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; object, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; newValue) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            AccessPermissionChecker.checkAccessPermission(field);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AccessControlException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Illegal access to field&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + field.getName());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; goalValue = DefaultTypeTransformation.castToType(newValue, field.getType());

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFinal()) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyRuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot set the property &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt; because the backing field is &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;.&quot;&lt;/span&gt;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            field.set(object, goalValue);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyRuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot set the property &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt;.&quot;&lt;/span&gt;, ex);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;CachedMethod.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; object, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] arguments) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            AccessPermissionChecker.checkAccessPermission(cachedMethod);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AccessControlException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvokerInvocationException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Illegal access to method&quot;&lt;/span&gt; + cachedMethod.getName()));
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cachedMethod.invoke(object, arguments);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalArgumentException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvokerInvocationException(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvokerInvocationException(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InvocationTargetException e) {
            Throwable cause = e.getCause();
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (cause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RuntimeException &amp;amp;&amp;amp; !(cause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; MissingMethodException)) ?
                    (RuntimeException) cause : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvokerInvocationException(e);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Method setAccessible() {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            AccessPermissionChecker.checkAccessPermission(cachedMethod);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AccessControlException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Illegal access to method&quot;&lt;/span&gt; + cachedMethod.getName());
        }
&lt;span class=&quot;code-comment&quot;&gt;//        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (queuedToCompile.compareAndSet(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCompilable())
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//              CompileThread.addMethod(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//        }
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cachedMethod;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Method getCachedMethod() {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            AccessPermissionChecker.checkAccessPermission(cachedMethod);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AccessControlException ex) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Illegal access to method&quot;&lt;/span&gt; + cachedMethod.getName());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cachedMethod;
    }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In order to apply the patch in Freeplane I created a separate project &lt;a href=&quot;https://github.com/dpolivaev/securegroovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dpolivaev/securegroovy&lt;/a&gt; which generates the patch at runtime using bytebuddy. &lt;/p&gt;

&lt;p&gt;I would appreciate if you could integrate the patch in groovy code.&lt;/p&gt;

&lt;p&gt;There is one subtle issue with AccessPermissionChecker: as you see it allows access to all protected methods except for ClassLoader without any further checks.&lt;br/&gt;
But for the protected methods from ClassLoader is makes one additional check: Otherwise a script could access a class loader by getClass().getClassLoader() and misuse its defineClass method to let malicious code appear trusted. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13066149">GROOVY-8163</key>
            <summary>Groovy scripts can disable java security manager and escape sandbox</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwagenleitner">John Wagenleitner</assignee>
                                    <reporter username="dpolivaev">Dimitry Polivaev</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Apr 2017 09:54:08 +0000</created>
                <updated>Tue, 6 Mar 2018 23:25:31 +0000</updated>
                            <resolved>Tue, 6 Jun 2017 15:12:06 +0000</resolved>
                                    <version>2.5.0-alpha-1</version>
                    <version>2.4.9</version>
                    <version>2.4.10</version>
                                    <fixVersion>2.5.0-beta-2</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15980352" author="glaforge" created="Sun, 23 Apr 2017 10:17:00 +0000"  >&lt;p&gt;Can you give a bit more details? Steps to reproduce?&lt;/p&gt;</comment>
                            <comment id="15980354" author="dpolivaev" created="Sun, 23 Apr 2017 10:34:02 +0000"  >&lt;p&gt;I have added full description now.&lt;/p&gt;</comment>
                            <comment id="15980358" author="glaforge" created="Sun, 23 Apr 2017 10:52:33 +0000"  >&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="15990693" author="dpolivaev" created="Mon, 1 May 2017 09:15:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=glaforge&quot; class=&quot;user-hover&quot; rel=&quot;glaforge&quot;&gt;glaforge&lt;/a&gt; Hello Guillaume,&lt;/p&gt;

&lt;p&gt;because I have got no response, I want to describe why I consider this issue to be urgent. &lt;/p&gt;

&lt;p&gt;We develop mind map editor Freeplane ( &lt;a href=&quot;https://en.wikipedia.org/wiki/Freeplane&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://en.wikipedia.org/wiki/Freeplane&lt;/a&gt; ) which  allows to use of scripts embedded into mind maps.&lt;br/&gt;
The scripts are used as formulas. They are evaluated automatically when the map is opened.&lt;/p&gt;

&lt;p&gt;Because the formulas need to use bounded variables which require use of CachedField and CachedMethod , because of the reported issue malicious maps could disable java security manager and do whatever they wanted. As I showed in the report if I disallow use of ReflectPermission(&quot;suppressAccessChecks&quot;) by groovy itself, groovy can not properly find some public class methods. And if I allow Groovy to use this permission there is no way to put the scripts in a sandbox safely.&lt;/p&gt;

&lt;p&gt;Although I do not think that patching other people software is generally a good solution I had to patch groovy so solve this issue. &lt;br/&gt;
Groovy is general use scripting language I think that also any software allowing users to embed groovy scripts must have the same problem.&lt;/p&gt;

&lt;p&gt;Could you or somebody else from the Groovy developers respond to this issue?&lt;br/&gt;
If you have any questions or tips or can suggest me another approach to solve this issue please let me know.&lt;/p&gt;

&lt;p&gt;Kind regards,&lt;br/&gt;
Dimitry Polivaev&lt;br/&gt;
Freeplane project lead&lt;/p&gt;</comment>
                            <comment id="15990743" author="blackdrag" created="Mon, 1 May 2017 11:48:15 +0000"  >&lt;p&gt;I think the idea of the patch is good and we should think about integrating it. Since it won&#180;t do anything without a security manager being set it should be not causing trouble for example for testing code. But I also think the patch will not solve all the attack vectors. For example if a subclass of ClassLoader overwrites defineClass, your patch will not catch that. Your code will also catch a lot less if invokedynamic is enabled.&lt;/p&gt;

&lt;p&gt;But anyway, I still think this would be a good start..&lt;/p&gt;

&lt;p&gt;btw Dimitry, it would be even better if you provided this as pull request on github&lt;/p&gt;</comment>
                            <comment id="15991518" author="githubbot" created="Mon, 1 May 2017 20:59:17 +0000"  >&lt;p&gt;GitHub user dpolivaev opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/532&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Prevent CachedField and CachedMethod from leaking access permissions &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;to scripts&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-8163&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dpolivaev/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dpolivaev/groovy&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/532.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/532.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #532&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 20741fe4f61940a2e5ab56c67d0710a17ac5583f&lt;br/&gt;
Author: Dimitry Polivaev &amp;lt;dpolivaev@gmx.de&amp;gt;&lt;br/&gt;
Date:   2017-05-01T20:58:12Z&lt;/p&gt;

&lt;p&gt;    Prevent CachedField and CachedMethod from leaking access permissions to scripts&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-8163&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15991521" author="dpolivaev" created="Mon, 1 May 2017 21:04:34 +0000"  >&lt;p&gt;Protected class loader methods can be accessed by scripts only if scripts have permission to create class loaders. Obviously they shouldn&apos;t get it.&lt;/p&gt;

&lt;p&gt;I have improved my proposal by better handling of package private methods: I allow access to such methods for all classes with names not starting with &quot;java.&quot; because adding classes to packages is generally allowed and therefore there is no additional security risk.&lt;/p&gt;

&lt;p&gt;I have not considered &quot;invokedynamic enabled&quot; case as I do not know which additional risks result from it. &lt;br/&gt;
How can I as a groovy user control if invokedynamic is enabled?&lt;/p&gt;</comment>
                            <comment id="16009353" author="dpolivaev" created="Sat, 13 May 2017 14:13:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; I would appreciate any feedback about the patch I submitted.&lt;/p&gt;</comment>
                            <comment id="16009412" author="blackdrag" created="Sat, 13 May 2017 16:42:08 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16009515" author="jwagenleitner" created="Sat, 13 May 2017 21:48:53 +0000"  >&lt;p&gt;By wrapping the &lt;tt&gt;Eval&lt;/tt&gt; in the &lt;tt&gt;doPrivileged&lt;/tt&gt; block doesn&apos;t that effectively grant the script &lt;tt&gt;AllPermission&lt;/tt&gt;.  If you remove the &lt;tt&gt;doPrivileged&lt;/tt&gt; and use the following policy &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;restrictedPermissionsForScriptOnlyPolicy.txt&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grant codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.test}&quot;&lt;/span&gt; {
	permission java.security.AllPermission;
};

grant codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.groovy}&quot;&lt;/span&gt; {
	permission java.security.AllPermission;
};

grant {
    permission groovy.security.GroovyCodeSourcePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;/groovy/shell&quot;&lt;/span&gt;;
    permission java.lang.RuntimePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;accessDeclaredMembers&quot;&lt;/span&gt;;

    permission java.util.PropertyPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;it should result in &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.security.AccessControlException: access denied (&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.RuntimePermission&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;setSecurityManager&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Though this still doesn&apos;t enforce the access checks which is what the PR seems to address.  But I think that is because Groovy uses &lt;tt&gt;doPrivileged&lt;/tt&gt; blocks for the access and the policy grants permission to the Groovy codebase.  The following change (no explicit or implied &quot;supressAccessChecks&quot; permission):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grant codeBase &lt;span class=&quot;code-quote&quot;&gt;&quot;${dir.groovy}&quot;&lt;/span&gt; {
        permission java.lang.RuntimePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
        permission java.security.SecurityPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
        permission java.io.FilePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;&amp;lt;ALL FILES&amp;gt;&amp;gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
        permission java.util.PropertyPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
        permission groovy.security.GroovyCodeSourcePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;;
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;results in &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalAccessException: &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; org.codehaus.groovy.reflection.CachedMethod can not access a member of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; with modifiers &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second example with &lt;tt&gt;GroovyBeanTest&lt;/tt&gt; works in 2.4.11 and 2_5_X, believe the problem was related to a bug that was fixed that affected version 2.4.8-10.  It will also pass in 2.4.11 if the &lt;tt&gt;doPrivileged&lt;/tt&gt; is removed and the following grant for the scripts is changed to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grant {
    permission java.lang.RuntimePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;accessDeclaredMembers&quot;&lt;/span&gt;;
    permission groovy.security.GroovyCodeSourcePermission &lt;span class=&quot;code-quote&quot;&gt;&quot;/groovy/shell&quot;&lt;/span&gt;;

    permission java.util.PropertyPermission &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;read&quot;&lt;/span&gt;;
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16009694" author="dpolivaev" created="Sun, 14 May 2017 11:55:15 +0000"  >&lt;p&gt;&lt;tt&gt;doPrivileged&lt;/tt&gt; blocks in the test are needed to ignore any access checks for JUnit Runner which belong to different protection domains and depend on how the test execution is started (by gradle or by IDE) . They do not influence checks for called groovy scripts.&lt;/p&gt;

&lt;p&gt;After I updated my test project to Version 2.4.11 the &lt;tt&gt;GroovyBeanTest&lt;/tt&gt; still fails with MissingPropertyException.&lt;/p&gt;</comment>
                            <comment id="16009695" author="dpolivaev" created="Sun, 14 May 2017 11:55:52 +0000"  >&lt;p&gt;Need for patching &lt;tt&gt;MetaClassImpl&lt;/tt&gt; if &lt;tt&gt;GroovyRuntimeException&lt;/tt&gt; is thrown instead of &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; as suggested in the review is demonstrated by the following test added to &lt;tt&gt;GroovySecurityTest&lt;/tt&gt; : &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@Test
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void returnsLoggerClassName() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
		AccessController.doPrivileged(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PrivilegedAction&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt;() {

			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; run() {
				Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.util.logging.Logger&quot;&lt;/span&gt;, Eval.x(Logger.getGlobal(), &lt;span class=&quot;code-quote&quot;&gt;&quot;x.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;name&quot;&lt;/span&gt;));
				&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
			}
		});
	}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16014586" author="jwagenleitner" created="Wed, 17 May 2017 18:41:46 +0000"  >&lt;p&gt;My hunch is that a &lt;tt&gt;GroovyRuntimeException&lt;/tt&gt; should probably not be caught at that point.  I would have assumed an &lt;tt&gt;AccessControlException&lt;/tt&gt; from &lt;tt&gt;CachedField.getProperty&lt;/tt&gt; would be treated similar to the &lt;tt&gt;IllegalAccessException&lt;/tt&gt; in the same method (wrapped in GRE and not caught at that point).&lt;/p&gt;</comment>
                            <comment id="16014645" author="githubbot" created="Wed, 17 May 2017 19:18:09 +0000"  >&lt;p&gt;Github user dpolivaev commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/532#discussion_r117087531&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/532#discussion_r117087531&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/groovy/lang/MetaClassImpl.java &amp;#8212;&lt;br/&gt;
    @@ -1832,6 +1832,9 @@ public Object getProperty(Class sender, Object object, String name, boolean useS&lt;br/&gt;
                 } catch (IllegalArgumentException e) &lt;/p&gt;
{
                     // can&apos;t access the field directly but there may be a getter
                     mp = null;
    +            }
&lt;p&gt; catch (GroovyRuntimeException e) {&lt;br/&gt;
    +                // can&apos;t access the field directly but there may be a getter&lt;br/&gt;
    +                mp = null;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I do not have unit test to explain this catch block. I do have the integration test &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8163?focusedCommentId=16009695&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16009695&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-8163?focusedCommentId=16009695&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16009695&lt;/a&gt;. The problem is that for some classes C with private member called &quot;name&quot; class property C.class.name which corresponds to java calls C.class.getName() does not work unless this catch block is added. &lt;/p&gt;</comment>
                            <comment id="16014646" author="dpolivaev" created="Wed, 17 May 2017 19:19:00 +0000"  >&lt;p&gt;The catch is needed to make the above test &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8163?focusedCommentId=16009695&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16009695&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-8163?focusedCommentId=16009695&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16009695&lt;/a&gt; pass.&lt;/p&gt;</comment>
                            <comment id="16027609" author="dpolivaev" created="Sat, 27 May 2017 21:07:08 +0000"  >&lt;p&gt;Could you please check the changes I implemented after the review?&lt;/p&gt;</comment>
                            <comment id="16036421" author="githubbot" created="Sun, 4 Jun 2017 23:16:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/532&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16039057" author="jwagenleitner" created="Tue, 6 Jun 2017 15:12:06 +0000"  >&lt;p&gt;Thanks for reporting and the PR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dz5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>