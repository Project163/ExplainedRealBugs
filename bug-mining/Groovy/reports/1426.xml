<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:18:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4529] GroovyClassLoader script caching not working properly if scripts not in root dir</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4529</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;GroovyClassLoader caches class files compiled from scripts not in root dir under keys not matching original name.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;GroovyClassLoader loader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader();
loader.addURL(myScriptRoot);

&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class1&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;class2&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;class1&lt;/span&gt; = loader.loadClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;test/script1&quot;&lt;/span&gt;);
  &lt;span class=&quot;code-keyword&quot;&gt;class2&lt;/span&gt; = loader.loadClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;test/script1&quot;&lt;/span&gt;);
  assertSame(&lt;span class=&quot;code-keyword&quot;&gt;class1&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;class2&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; fails
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ClassNotFoundException e) {
  fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; node found!&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If I write as above, class is cached by GroovyClassLoader under key &quot;test.script1&quot; so looking it up under &quot;test/script1&quot; fails. If I try with loader.loadClass(&quot;test.script1&quot;) it will be cached under &quot;test.test&quot; which seems even worse.&lt;/p&gt;

&lt;p&gt;Is there any workaround other than creating my own cache for compiled classes?&lt;/p&gt;

&lt;p&gt;As a fix in the groovy code, we could move the line &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; className = name.replace(&lt;span class=&quot;code-quote&quot;&gt;&apos;/&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;.&apos;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to the beginning of the loadClass(String, boolean, boolean, boolean) method and using it instead of name in the entire method. GroovyResourceLoader will handle dots fine and className will be proper cache key then.&lt;/p&gt;

&lt;p&gt;This would fix looking up scripts with &apos;/&apos; as package separator. It is quite possible this is not recommended way of loading scripts anyway. To fix it for dot separated script paths the problem lies I believe here (GroovyClassLoader):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; recompile(URL source, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; className, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; oldClass) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CompilationFailedException, IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (source != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// found a source, compile it &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; newer
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((oldClass != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; isSourceNewer(source, oldClass)) || (oldClass == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)) {
                sourceCache.remove(className);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; parseClass(source.openStream(), className);
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; oldClass;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;parseClass second argument is fileName and we pass dot-separated className here. I would change it to &lt;br/&gt;
return parseClass(source.openStream(), className.replace(&apos;.&apos;,&apos;/&apos;));&lt;/p&gt;</description>
                <environment>Windows Vista</environment>
        <key id="12812607">GROOVY-4529</key>
            <summary>GroovyClassLoader script caching not working properly if scripts not in root dir</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guillaume">Guillaume Sauthier</assignee>
                                    <reporter username="mrembisz">Michal Rembiszewski</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Nov 2010 09:53:55 +0000</created>
                <updated>Fri, 14 Oct 2011 00:28:05 +0000</updated>
                            <resolved>Wed, 12 Oct 2011 10:04:22 +0000</resolved>
                                    <version>1.7.1</version>
                                    <fixVersion>1.9-beta-4</fixVersion>
                    <fixVersion>1.8.4</fixVersion>
                                    <component>class generator</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14470363" author="mrembisz" created="Wed, 24 Nov 2010 09:56:45 +0000"  >&lt;p&gt;Ops, sorry for not formatting source properly, I don&apos;t use Jira usually.&lt;/p&gt;</comment>
                            <comment id="14470601" author="blackdrag" created="Tue, 14 Dec 2010 15:14:40 +0000"  >&lt;p&gt;the normal contract for a ClassLoader is that you give to loadClass a class name. In your case you give a path. But the path is supposed to be added as root in addURL and then you would have had to call loadClass(&quot;script1&quot;) instead. What laodClass does is seeing the &quot;/&quot; as part of classname, but later interpreting it as path. This is surely not the best way, but since the method was used wrong form the beginning strange results are not really surprising. &lt;/p&gt;

&lt;p&gt;If you want that, I suggest you use your own subclass of GroovyClassLoader with the path corrected to your liking.&lt;/p&gt;</comment>
                            <comment id="14470594" author="mrembisz" created="Tue, 14 Dec 2010 15:23:11 +0000"  >&lt;p&gt;Thanks for your comment. So trying to load script through loadClass(&quot;package.script1&quot;) where &quot;package&quot; is dir under script root is also wrong? I have tried it and included such case in my report. It resulted in class with name &quot;package.script1&quot; being cached under name &quot;package.package&quot;.&lt;/p&gt;</comment>
                            <comment id="14470623" author="blackdrag" created="Tue, 14 Dec 2010 15:31:24 +0000"  >&lt;p&gt;if the script has a package statement defining it is in a package called &quot;package&quot;, then it should have been right to load it through &quot;package.script1&quot;, assuming there is a script1.groovy in a folder package, that is under one of the root folders. &quot;package.package&quot; is of course wrong. ive me afew minutes to verify that&lt;/p&gt;</comment>
                            <comment id="14470559" author="mrembisz" created="Tue, 14 Dec 2010 15:33:52 +0000"  >&lt;p&gt;I attach the test case so it&apos;s less confusing, sorry for misleading example in the first place:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;GroovyClassLoader loader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader();
loader.addURL(myScriptRoot);

&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class1&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;class2&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;class1&lt;/span&gt; = loader.loadClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;test.script1&quot;&lt;/span&gt;);
  &lt;span class=&quot;code-keyword&quot;&gt;class2&lt;/span&gt; = loader.loadClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;test.script1&quot;&lt;/span&gt;);
  assertSame(&lt;span class=&quot;code-keyword&quot;&gt;class1&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;class2&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; also fails
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ClassNotFoundException e) {
  fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; not found!&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second fix in my original post should take care of that I believe. Intentional deny of package prefix when calling scripts would be a pity.&lt;/p&gt;</comment>
                            <comment id="14470641" author="blackdrag" created="Tue, 14 Dec 2010 15:44:19 +0000"  >&lt;p&gt;may test showed, that if I put a script named script1 with the package foo into a folder foo in script1.groovy, add the parent of foo to the root urls and then load the script via loadClass(&quot;foo.script1&quot;), then the class is loaded and cached correctly, as the second loading returns the same class.&lt;/p&gt;</comment>
                            <comment id="14470655" author="blackdrag" created="Tue, 14 Dec 2010 15:45:26 +0000"  >&lt;p&gt;in other words your test passes for me on trunk&lt;/p&gt;</comment>
                            <comment id="14470577" author="blackdrag" created="Tue, 14 Dec 2010 15:46:35 +0000"  >&lt;p&gt;ah wait, there might be a classpath problem and I may have executed the wrong test&lt;/p&gt;</comment>
                            <comment id="14470522" author="blackdrag" created="Tue, 14 Dec 2010 15:50:03 +0000"  >&lt;p&gt;nope, all fine&lt;/p&gt;</comment>
                            <comment id="14470671" author="mrembisz" created="Tue, 14 Dec 2010 16:08:18 +0000"  >&lt;p&gt;Thank you very much for your time, I&apos;ll do some more investigation with trunk. This test passes for me when I do it for a class but fails in case of a script on versions 1.7.1-1.7.5. If it comes up with trunk, I&apos;ll prepare and attach proper test case.&lt;/p&gt;</comment>
                            <comment id="14470602" author="blackdrag" created="Tue, 14 Dec 2010 16:49:31 +0000"  >&lt;p&gt;ok, just tested with a script and then it fails, so I now can confirm the problem&lt;/p&gt;</comment>
                            <comment id="14470538" author="mrembisz" created="Wed, 15 Dec 2010 02:51:01 +0000"  >&lt;p&gt;Reopening the issue then, thanks again. The second part of the original post contains suggested solution.&lt;/p&gt;</comment>
                            <comment id="14470595" author="blackdrag" created="Wed, 15 Dec 2010 04:16:59 +0000"  >&lt;p&gt;actually I am going to do a bit more. If the URL is a file I will use parseClass(File) and in case of the text I will add a dummy &quot;.groovy&quot; at the end.&lt;/p&gt;</comment>
                            <comment id="14470624" author="blackdrag" created="Wed, 15 Dec 2010 04:26:38 +0000"  >&lt;p&gt;I attached the fix as patch&lt;/p&gt;</comment>
                            <comment id="14470560" author="blackdrag" created="Wed, 15 Dec 2010 09:18:42 +0000"  >&lt;p&gt;sadly the patch does fix the issue at hand, but does break other code. It seems generating that file name is causing a problem here for GroovyScriptEngine&lt;/p&gt;</comment>
                            <comment id="14471996" author="mrembisz" created="Tue, 11 Oct 2011 10:45:17 +0000"  >&lt;p&gt;Contains a fix passing all tests and two tests demonstrating the issue. Both problems are related and appear only for scripts (not classes) having non-empty packages. First one affects performance since such scripts are compiled every time they are called. The second one makes using log4j etc annoying since script classes have misleading names.&lt;/p&gt;</comment>
                            <comment id="14471903" author="mrembisz" created="Tue, 11 Oct 2011 10:47:10 +0000"  >&lt;p&gt;Patch is against trunk, made today (11 Oct 2011).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722768" name="gcl.patch" size="1335" author="blackdrag" created="Wed, 15 Dec 2010 04:26:38 +0000"/>
                            <attachment id="12722525" name="test_case_and_fix_for_GROOVY-4529.patch" size="2894" author="mrembisz" created="Tue, 11 Oct 2011 10:45:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bw0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>