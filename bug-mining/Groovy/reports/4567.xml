<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:20:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10108] Tuple constructor fails for an @Immutable class having a single Map property</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10108</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;For an&#160;&lt;tt&gt;@Immutable&lt;/tt&gt;&#160;class having a single &lt;tt&gt;Map&lt;/tt&gt; property, trying to use the generated tuple constructor generally results in an exception being thrown from &lt;tt&gt;ImmutableASTTransformation.checkPropNames()&lt;/tt&gt;.  This did not happen in Groovy 2.4.&lt;/p&gt;

&lt;p&gt;For example, given a class like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@Immutable
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LookupTable {
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; data
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this usage of that class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; data = [(1L): &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;, (2L): &lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;]
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LookupTable(data)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The constructor invocation throws:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ClassCastException: java.lang.Long cannot be cast to java.lang.String
	at org.codehaus.groovy.transform.ImmutableASTTransformation.checkPropNames(ImmutableASTTransformation.java:423)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The documentation for &lt;tt&gt;@Immutable&lt;/tt&gt; does mention there are limitations when there is a single property of type &lt;tt&gt;Map&lt;/tt&gt;, but the wording there doesn&apos;t sound like it&apos;s talking about the tuple constructor:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Groovy&apos;s normal map-style naming conventions will not be available if the first property has type &lt;tt&gt;LinkedHashMap&lt;/tt&gt; or if there is a single &lt;tt&gt;Map&lt;/tt&gt;, &lt;tt&gt;AbstractMap&lt;/tt&gt; or &lt;tt&gt;HashMap&lt;/tt&gt; property.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In fact that wording makes it sound as if it&apos;s the map-based constructor that won&apos;t be available, when in fact using the map-based constructor does work in this case (and thus seems to be a viable workaround).&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/douglyuckling/groovy-2.5-immutable-with-map-bug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/douglyuckling/groovy-2.5-immutable-with-map-bug&lt;/a&gt; for a minimal reproduction of the problem.&lt;/p&gt;</description>
                <environment>N/A</environment>
        <key id="13380366">GROOVY-10108</key>
            <summary>Tuple constructor fails for an @Immutable class having a single Map property</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="douglyuckling">Douglas Paul</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 May 2021 14:55:47 +0000</created>
                <updated>Fri, 10 Feb 2023 21:40:09 +0000</updated>
                            <resolved>Mon, 21 Nov 2022 23:11:52 +0000</resolved>
                                    <version>2.5.0</version>
                    <version>2.5.14</version>
                    <version>3.0.8</version>
                                    <fixVersion>4.0.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17351175" author="douglyuckling" created="Tue, 25 May 2021 16:17:09 +0000"  >&lt;p&gt;By the way, I&apos;m aware this case is inherently tricky to handle. There can of course only be one constructor that takes a single &lt;tt&gt;Map&lt;/tt&gt; parameter, and within that constructor it&apos;s ambiguous as to whether an invocation is intended to be map-based construction or tuple-based construction.&lt;/p&gt;

&lt;p&gt;However, I felt it was worth filing an issue since it did work in Groovy 2.4 and I didn&apos;t see any documentation about support for this use case being intentionally dropped.&lt;/p&gt;</comment>
                            <comment id="17351229" author="douglyuckling" created="Tue, 25 May 2021 17:30:58 +0000"  >&lt;p&gt;A few more things to note...&lt;/p&gt;

&lt;p&gt;As I&apos;m digging around more in the Groovy 2.5 code, I see that &lt;tt&gt;@MapConstructor&lt;/tt&gt; has an option called &lt;tt&gt;specialNamedArgHandling&lt;/tt&gt; that looks like it&apos;s meant to help with similar cases. So that&apos;s nice, but it doesn&apos;t help in this case where I want to be able to pass in a &lt;tt&gt;LinkedHashMap&lt;/tt&gt; and not have that interpreted as map-based construction.&lt;/p&gt;

&lt;p&gt;I see that since &lt;tt&gt;@Immutable&lt;/tt&gt; is now an annotation collector, I can avoid this problem by replacing my use of &lt;tt&gt;@Immutable&lt;/tt&gt; with all of the lower-level annotations it collects except for &lt;tt&gt;@MapConstructor&lt;/tt&gt;, and then I just don&apos;t get a map-based constructor and thus don&apos;t have this problem. But that&apos;s cumbersome and awkward, even if I use &lt;tt&gt;@Canonical&lt;/tt&gt; in place of some of those things.&lt;/p&gt;

&lt;p&gt;What would be awesome is if &lt;tt&gt;@MapConstructor&lt;/tt&gt; had an &lt;tt&gt;enabled&lt;/tt&gt; option (or something like that) that could be set to &lt;tt&gt;false&lt;/tt&gt; to disable generation of the map-based constructor even when the annotation is present. Then I could simply do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@Immutable
@MapConstructor(enabled = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LookupTable {
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; data
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17351405" author="paulk" created="Tue, 25 May 2021 23:38:04 +0000"  >&lt;p&gt;It is a tricky case and the wording tries not to be too tricky but perhaps needs improving.&lt;/p&gt;

&lt;p&gt;It seems like you have already spotted that named args works in your case using:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LookupTable(data: data)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another way to make it work without change is to use an explicit non-&lt;tt&gt;LinkedHashMap&lt;/tt&gt; type, e.g.:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def data = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap(1L: &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;, 2L: &lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// [1L: &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;, 2L: &lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;] would yield LinkedHashMap&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is needed because the tuple constructor parameter has type &lt;tt&gt;Map&lt;/tt&gt; and the map constructor parameter has type &lt;tt&gt;LinkedHashMap&lt;/tt&gt; and the more specific one will be chosen.&lt;/p&gt;

&lt;p&gt;Another alternative might be to change the type of your property to &lt;tt&gt;LinkedHashMap&lt;/tt&gt; and use the &lt;tt&gt;specialNamedArgHandling&lt;/tt&gt; flag:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Immutable(specialNamedArgHandling=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LookupTable {
    LinkedHashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; data
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This would flip the types of the map and tuple constructors from what was mentioned earlier.&lt;/p&gt;

&lt;p&gt;Then the tuple constructor would work as you were expecting:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LookupTable(data)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but you&apos;d need a similar trick to above to make use of named args:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LookupTable(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap(data: data))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A good way to see what the various options provide is to look at the AST browser of the Groovy Console, which you might already be doing, but I&apos;ll add here as a comment in case other folks stumble across this issue in the future. In the Groovy Console, select Script -&amp;gt; Inspect AST to enable the browser.&lt;/p&gt;

&lt;p&gt;We have considered something like an enabled flag in the past but have resisted adding that complexity (so far) since there are already other approaches that work, such as folks making their own &lt;tt&gt;MyImmutable&lt;/tt&gt; annotation collector without &lt;tt&gt;MapConstructor&lt;/tt&gt; if they wanted.&lt;/p&gt;</comment>
                            <comment id="17636923" author="emilles" created="Mon, 21 Nov 2022 23:11:52 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@Immutable(specialNamedArgHandling=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LookupTable {
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; data
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/b8fd0cd22dd417b86050c71d1561c97d14f46c6f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/b8fd0cd22dd417b86050c71d1561c97d14f46c6f&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13124997">GROOVY-8416</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rd08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>