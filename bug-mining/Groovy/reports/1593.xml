<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:22:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5049] File.getText() should close the streams</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5049</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Performing a lot of system calls causes Groovy to die on Linux with an IOException for &quot;Too many open files&quot;. The cause is streams which are left open by system calls:&lt;/p&gt;

&lt;p&gt;(1..n).each &lt;/p&gt;
{ &quot;ls&quot;.execute().text }

&lt;p&gt;This method should be changed to close all streams after it gets the text from them.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12815711">GROOVY-5049</key>
            <summary>File.getText() should close the streams</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="balor123">Uri Moszkowicz</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Sep 2011 09:20:43 +0000</created>
                <updated>Fri, 14 Oct 2011 00:28:05 +0000</updated>
                            <resolved>Fri, 30 Sep 2011 21:21:31 +0000</resolved>
                                                    <fixVersion>1.9-beta-4</fixVersion>
                    <fixVersion>1.8.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14471805" author="balor123" created="Tue, 27 Sep 2011 09:58:20 +0000"  >&lt;p&gt;Discussed here:&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/7570353/why-do-i-get-too-many-open-files-errors&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/7570353/why-do-i-get-too-many-open-files-errors&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14471865" author="blackdrag" created="Tue, 27 Sep 2011 10:16:52 +0000"  >&lt;p&gt;Uri, what version of Groovy are you talking about? File.text will use BuffereReader.text and the code for that looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getText(BufferedReader reader) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        StringBuilder answer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
        &lt;span class=&quot;code-comment&quot;&gt;// reading the content of the file within a &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; buffer
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// allow to keep the correct line endings
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] charBuffer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[8192];
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nbCharRead &lt;span class=&quot;code-comment&quot;&gt;/* = 0*/&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((nbCharRead = reader.read(charBuffer)) != -1) {
                &lt;span class=&quot;code-comment&quot;&gt;// appends buffer
&lt;/span&gt;                answer.append(charBuffer, 0, nbCharRead);
            }
            Reader temp = reader;
            reader = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            temp.close();
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            closeWithWarning(reader);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I know we had problems with that kind of thing quite some time back, but these are supposed to be solved. And the code above does close the Reader.&lt;/p&gt;</comment>
                            <comment id="14471888" author="balor123" created="Tue, 27 Sep 2011 10:19:22 +0000"  >&lt;p&gt;Groovy Version: 1.8.0 JVM: 1.6.0_14&lt;/p&gt;</comment>
                            <comment id="14471913" author="blackdrag" created="Tue, 27 Sep 2011 10:26:13 +0000"  >&lt;p&gt;have you a program showing that problem?&lt;/p&gt;</comment>
                            <comment id="14471933" author="balor123" created="Tue, 27 Sep 2011 10:48:11 +0000"  >&lt;p&gt;Yes please see the snippet in the stackoverflow thread linked above. I think the input, output, and error streams need to be closed.&lt;/p&gt;</comment>
                            <comment id="14471807" author="blackdrag" created="Tue, 27 Sep 2011 11:36:02 +0000"  >&lt;p&gt;Ok, so the problem is on Process, not on File. I haven&apos;t seen that, sorry. Process#getText closes the InputStream. The question is if it makes sense to also close error and output streams through this method. I guess that is something we can do, but we would potentially break some code. Also if we go this route we have to think of the case of process error and/or process input stream buffers being full and thus blocking the process from finnishing what it had to tell us. &lt;/p&gt;</comment>
                            <comment id="14471963" author="blackdrag" created="Tue, 27 Sep 2011 11:36:29 +0000"  >&lt;p&gt;Paul, isn&apos;t that something for you?&lt;/p&gt;</comment>
                            <comment id="14471897" author="balor123" created="Tue, 27 Sep 2011 11:42:56 +0000"  >&lt;p&gt;Hmm yeah maybe it should just close the STDOUT stream. It will break some legacy code but in those cases the stream would have been empty anyway. If my proposal for new mergedText and close methods are accepted, then we&apos;ll be able to concicesly close all the streams in all cases. We&apos;ll just need to write some notes documenting the pitfalls of executing commands and how to avoid them using the new methods.&lt;/p&gt;</comment>
                            <comment id="14479699" author="paulk" created="Tue, 27 Sep 2011 15:20:05 +0000"  >&lt;p&gt;I see a stacktrace on stackoverflow but no code. Perhaps I am missing something. Do you have some code which illustrates the problem you are talking about? Thanks.&lt;/p&gt;</comment>
                            <comment id="14471866" author="balor123" created="Tue, 27 Sep 2011 15:28:57 +0000"  >&lt;p&gt;Attached file to bug report. You can uncomment the &quot;No error&quot; code to see that closing the streams does fix the error.&lt;/p&gt;</comment>
                            <comment id="14471887" author="balor123" created="Tue, 27 Sep 2011 15:48:11 +0000"  >&lt;p&gt;...&lt;br/&gt;
&amp;lt;removed dir&amp;gt;&lt;br/&gt;
&amp;lt;removed dir&amp;gt;&lt;br/&gt;
&amp;lt;removed dir&amp;gt;&lt;br/&gt;
Caught: java.util.concurrent.ExecutionException: org.codehaus.groovy.runtime.InvokerInvocationException: java.io.IOException: Cannot run program &quot;ls&quot;: java.io.IOException: error=24, Too many open files&lt;br/&gt;
	at groovyx.gpars.GParsPool.runForkJoin(GParsPool.groovy:305)&lt;br/&gt;
	at UsageAnalyzer2$_run_closure2_closure6.doCall(UsageAnalyzer2.groovy:36)&lt;br/&gt;
	at groovyx.gpars.GParsPool$_withExistingPool_closure1.doCall(GParsPool.groovy:170)&lt;br/&gt;
	at groovyx.gpars.GParsPool$_withExistingPool_closure1.doCall(GParsPool.groovy)&lt;br/&gt;
	at groovyx.gpars.GParsPool.withExistingPool(GParsPool.groovy:169)&lt;br/&gt;
	at groovyx.gpars.GParsPool.withPool(GParsPool.groovy:141)&lt;br/&gt;
	at groovyx.gpars.GParsPool.withPool(GParsPool.groovy:117)&lt;br/&gt;
	at UsageAnalyzer2$_run_closure2.doCall(UsageAnalyzer2.groovy:35)&lt;/p&gt;</comment>
                            <comment id="14471945" author="blackdrag" created="Tue, 27 Sep 2011 17:57:42 +0000"  >&lt;p&gt;@Paul, the example basically is (1..n).each &lt;/p&gt;
{ &quot;ls&quot;.execute().text }
&lt;p&gt;@Uri, getText does close STDOUT. Since you are not happy with that, it is obviously not enough.&lt;/p&gt;</comment>
                            <comment id="14471854" author="balor123" created="Tue, 27 Sep 2011 18:41:19 +0000"  >&lt;p&gt;It seems that the output stream can be closed safely once the process has exited. It makes sense that text would only close STDOUT since it only reads STDOUT. What&apos;s missing is the ability to read both STDOUT and STDERR and close both concisely.&lt;/p&gt;</comment>
                            <comment id="14479710" author="paulk" created="Wed, 28 Sep 2011 04:17:05 +0000"  >&lt;p&gt;Changing the behavior of the DGM process methods is certainly a possibility. However, the current &quot;design&quot; of many of these methods is very much a mix and match toolkit style. The &lt;tt&gt;getText()&lt;/tt&gt; method has never been designed to be an all-in-one solution, rather a light-weight layer over the existing process methods to make them a little bit nicer.&lt;/p&gt;

&lt;p&gt;A common existing usage pattern is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;p = &lt;span class=&quot;code-quote&quot;&gt;&quot;ls = build.gradle&quot;&lt;/span&gt;.execute()
p.waitFor()
println &lt;span class=&quot;code-quote&quot;&gt;&quot;O: &quot;&lt;/span&gt; + p.text      &lt;span class=&quot;code-comment&quot;&gt;// O: build.gradle
&lt;/span&gt;println &lt;span class=&quot;code-quote&quot;&gt;&quot;E: &quot;&lt;/span&gt; + p.err.text  &lt;span class=&quot;code-comment&quot;&gt;// E: ls: =: No such file or directory&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If &lt;tt&gt;getText()&lt;/tt&gt; closed all the streams, then obviously the second println above would fail.&lt;/p&gt;

&lt;p&gt;The existing methods allow closing of the error stream directly if desired:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def p = &lt;span class=&quot;code-quote&quot;&gt;&quot;ls = build.gradle&quot;&lt;/span&gt;.execute()
p.waitFor()
p.err.close()
println &lt;span class=&quot;code-quote&quot;&gt;&quot;O:\n&quot;&lt;/span&gt; + p.text
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Trying to change the existing methods is possible but might not be what people expect given the current mix and match style.&lt;/p&gt;

&lt;p&gt;At the moment, the closest we have to an all in one solution is the &lt;tt&gt;waitForProcessOutput()&lt;/tt&gt; methods. At the moment, they don&apos;t close the output and error streams but probably should. In the first instance, that is what I am going to fix. That will then allow the following solutions to the above problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;p = &lt;span class=&quot;code-quote&quot;&gt;&quot;ls = build.gradle&quot;&lt;/span&gt;.execute()
def sout = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder()
def serr = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder()
p.waitForProcessOutput(sout, serr)
println &lt;span class=&quot;code-quote&quot;&gt;&quot;O:\n&quot;&lt;/span&gt; + sout
println &lt;span class=&quot;code-quote&quot;&gt;&quot;E:\n&quot;&lt;/span&gt; + serr
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Or if merging of the streams is desired:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;p = &lt;span class=&quot;code-quote&quot;&gt;&quot;ls = build.gradle&quot;&lt;/span&gt;.execute()
def sb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;StringBuffer&lt;/span&gt;()
p.waitForProcessOutput(sb, sb)
println &lt;span class=&quot;code-quote&quot;&gt;&quot;OE:\n&quot;&lt;/span&gt; + sb
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This should stop the &quot;Too many open files&quot; error albeit not in as compact a syntax as might be desired.&lt;/p&gt;

&lt;p&gt;I think a more compact solution needs further discussion. It might need to be separate from the existing solutions or we might have to bite the bullet and do some wrapping of Process objects.&lt;/p&gt;</comment>
                            <comment id="14479708" author="paulk" created="Wed, 28 Sep 2011 07:04:14 +0000"  >&lt;p&gt;OK, change made. If you are in a position to test your example with a snapshot jar and alter your code to use the slightly longer version usign &lt;tt&gt;waitForProcessOutput()&lt;/tt&gt;, that would be great. It would be interesting to ensure that the errors go away. At present I am not closing the input stream as none should be in use but it would be useful to see what results you get.&lt;/p&gt;</comment>
                            <comment id="14471964" author="balor123" created="Wed, 28 Sep 2011 08:20:16 +0000"  >&lt;p&gt;Sure I could test it. Just send me the file and instructions on how to install it.&lt;/p&gt;</comment>
                            <comment id="14471886" author="balor123" created="Wed, 28 Sep 2011 08:34:00 +0000"  >&lt;p&gt;It might be useful to have an example for evaluating proposals. I&apos;ll suggest the following snippet, written in Perl:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;if (`ls *.ext1` =~ /\S+/) {
  ...
} elsif (`ls *.ext2` =~ /\S+/) {
  ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Right now, it would look like this.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def sb1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;StringBuffer&lt;/span&gt;()
def process1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;ls *.ext1&quot;&lt;/span&gt;.execute()
process1.waitForProcessOutput(sb1, sb1)

def sb2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;StringBuffer&lt;/span&gt;()
def process2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;ls *.ext2&quot;&lt;/span&gt;.execute()
process2.waitForProcessOutput(sb2, sb2)

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sb1 =~ /\S+/) {
  ...
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sb2 =~ /\S+/) {
  ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14479704" author="paulk" created="Wed, 28 Sep 2011 15:03:48 +0000"  >&lt;p&gt;If you grab a snapshot jar from our CI server and just replace your existing groovy or groovy-all jar.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;http://snapshots.repository.codehaus.org/org/codehaus/groovy/
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You should grab the one closest to your current versions, pick groovy/groovy-all and pick the latest 1.7.x or 1.8.x jar depending on what you are currently using.&lt;/p&gt;</comment>
                            <comment id="14471806" author="balor123" created="Thu, 29 Sep 2011 11:35:53 +0000"  >&lt;p&gt;I grabbed groovy-all-1.8.3-SNAPSHOT.jar and placed it into my groovy embeddable directory and renamed it to groovy-all-1.8.2.jar. I then changed the script to use waitForProcessOutput() and ran it in the case showing the error and it still occurs. Did I test it right?&lt;/p&gt;</comment>
                            <comment id="14479711" author="paulk" created="Thu, 29 Sep 2011 14:34:21 +0000"  >&lt;p&gt;It depends on how your are running groovy. If you are referencing the groovy-all jar directly (e.g. in an IDE) then you have done the correct steps. If you are using groovy from the commandline or groovyConsole in is likely using the non-all jar in the lib directory.&lt;/p&gt;</comment>
                            <comment id="14471948" author="balor123" created="Fri, 30 Sep 2011 10:18:39 +0000"  >&lt;p&gt;The change seems to prevent the exception now.&lt;/p&gt;</comment>
                            <comment id="14479718" author="paulk" created="Fri, 30 Sep 2011 19:01:16 +0000"  >&lt;p&gt;Cool. Thanks for trying that out. Next we&apos;ll have to think about further shorthands! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Though perhaps that could be a separate issue given the title of this issue?&lt;/p&gt;</comment>
                            <comment id="14479700" author="paulk" created="Fri, 30 Sep 2011 21:21:31 +0000"  >&lt;p&gt;ok, closing this issue but see &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5058&quot; title=&quot;Improved process execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5058&quot;&gt;GROOVY-5058&lt;/a&gt; for future enhancements&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12816084">GROOVY-5058</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12722356" name="UsageAnalyzer2.groovy" size="3300" author="balor123" created="Tue, 27 Sep 2011 16:06:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c0un:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>