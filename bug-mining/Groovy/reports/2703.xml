<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:42:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-6836] ClassCastException in map argument constructor when Immutable and CompileStatic are used</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-6836</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I&apos;m working on an unit test for Grails and it fails with a ClassCastException.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ClassCastException: grails.test.runtime.TestPluginUsage cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to java.util.Map
	at java.util.HashMap.hash(HashMap.java:366)
	at java.util.HashMap.put(HashMap.java:496)
	at java.util.HashSet.add(HashSet.java:217)
	at java.util.AbstractCollection.addAll(AbstractCollection.java:342)
	at grails.test.runtime.TestRuntimeFactory.getRuntimeForTestClass_closure1(TestRuntimeFactory.groovy:72)
	at groovy.lang.Closure.call(Closure.java:423)
	at groovy.lang.Closure.call(Closure.java:439)
	at grails.test.runtime.TestRuntimeFactory.getRuntimeForTestClass(TestRuntimeFactory.groovy:63)
	at grails.test.runtime.TestRuntimeFactorySpec.should instantiate correct plugins and features &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; #testClass.simpleName(TestRuntimeFactorySpec.groovy:20)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With a debugger I can see that the object has a reference to a wrong metaclass .&lt;/p&gt;

&lt;p&gt;I tried to isolate the problem without success. I&apos;ll push the code to a separate branch in Grails so that you can reproduce the problem and connect a debugger to the failing test.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12817578">GROOVY-6836</key>
            <summary>ClassCastException in map argument constructor when Immutable and CompileStatic are used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="melix">C&#233;dric Champeau</assignee>
                                    <reporter username="lhotari">Lari Hotari</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 May 2014 03:25:37 +0000</created>
                <updated>Sat, 26 Jul 2014 01:44:21 +0000</updated>
                            <resolved>Wed, 23 Jul 2014 03:54:26 +0000</resolved>
                                    <version>2.3.2</version>
                                    <fixVersion>2.3.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14476049" author="lhotari" created="Thu, 29 May 2014 03:28:42 +0000"  >&lt;p&gt;reproducing the problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git clone https:&lt;span class=&quot;code-comment&quot;&gt;//github.com/grails/grails-core
&lt;/span&gt;cd grails-core
git checkout GROOVY-6836-ClassCastException
cd grails-plugin-testing
../gradlew test
../gradlew -Ddebug.tests=1 test    # starts a debugger listening at port 5005 when tests get run , add breakpoint &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ClassCastException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14476036" author="lhotari" created="Thu, 29 May 2014 04:57:29 +0000"  >&lt;p&gt;decompiling the class using @Immutable and @CompileStatic has some strange logic in it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    MetaClass localMetaClass1;
    MetaClass localMetaClass2;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((DefaultGroovyMethods.getMetaClass(args) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? 1 : 0) != 0)
    {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (($getStaticMetaClass() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? 1 : 0) != 0)
      {
        localMetaClass1 = $getStaticMetaClass();
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = localMetaClass1;
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
    {
      localMetaClass2 = DefaultGroovyMethods.getMetaClass(args);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = localMetaClass2;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14475964" author="lhotari" created="Thu, 29 May 2014 05:19:51 +0000"  >&lt;p&gt;when you pass a map object to constructor, the map object&apos;s metaclass gets cached as the metaclass of the object that&apos;s getting instantiated&lt;/p&gt;</comment>
                            <comment id="14476055" author="lhotari" created="Thu, 29 May 2014 05:43:04 +0000"  >&lt;p&gt;problem in initialValueExpression of the metaClass field?&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/transform/ImmutableASTTransformation.java#L357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/transform/ImmutableASTTransformation.java#L357&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/ast/tools/GeneralUtils.java#L247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/ast/tools/GeneralUtils.java#L247&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;perhaps the field is shared?&lt;/p&gt;</comment>
                            <comment id="14476013" author="lhotari" created="Thu, 29 May 2014 05:47:04 +0000"  >&lt;p&gt;It looks like the metaClass field is added here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/classgen/Verifier.java#L108-L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/classgen/Verifier.java#L108-L120&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14475985" author="lhotari" created="Thu, 29 May 2014 07:19:28 +0000"  >&lt;p&gt;It looks like &quot;metaClass&quot; field should be skipped in &lt;a href=&quot;https://github.com/groovy/groovy-core/blob/e9ed3ff/src/main/org/codehaus/groovy/transform/ImmutableASTTransformation.java#L348-L360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ImmutableASTTransformation.createConstructorMapCommon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14476026" author="lhotari" created="Thu, 29 May 2014 07:31:50 +0000"  >&lt;p&gt;it looks like the problem exists even when @CompileStatic is removed, but for some reason the problem doesn&apos;t show up.&lt;/p&gt;

&lt;p&gt;decompiled code from constructor:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; localObject15;
    &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; localObject16;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((!BytecodeInterface8.isOrigZ()) || (BytecodeInterface8.disabledStandardMetaClass()))
    {
      MetaClass localMetaClass1;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ScriptBytecodeAdapter.compareEqual(arrayOfCallSite[115].callGetProperty(args), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
      {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ScriptBytecodeAdapter.compareNotEqual($getStaticMetaClass(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
        {
          localMetaClass1 = $getStaticMetaClass();
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = ((MetaClass)ScriptBytecodeAdapter.castToType(localMetaClass1, MetaClass.class));
        }
      }
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
      {
        localObject15 = arrayOfCallSite[116].callGetProperty(args);
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = ((MetaClass)ScriptBytecodeAdapter.castToType(localObject15, MetaClass.class));
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
    {
      MetaClass localMetaClass2;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ScriptBytecodeAdapter.compareEqual(arrayOfCallSite[117].callGetProperty(args), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
      {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ScriptBytecodeAdapter.compareNotEqual($getStaticMetaClass(), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
        {
          localMetaClass2 = $getStaticMetaClass();
          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = ((MetaClass)ScriptBytecodeAdapter.castToType(localMetaClass2, MetaClass.class));
        }
      }
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
      {
        localObject16 = arrayOfCallSite[118].callGetProperty(args);
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = ((MetaClass)ScriptBytecodeAdapter.castToType(localObject16, MetaClass.class));
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14480667" author="paulk" created="Fri, 4 Jul 2014 04:46:49 +0000"  >&lt;p&gt;Lari, I just tweaked @Immutable to clean up some warnings that were being reported by static compile debug mode. I didn&apos;t touch anything to do with the metaClass field but if you get a chance to try a recent snapshot, that would at least narrow down some searching. Thanks.&lt;/p&gt;</comment>
                            <comment id="14476217" author="melix" created="Mon, 21 Jul 2014 08:14:04 +0000"  >&lt;p&gt;Any update on this one?&lt;/p&gt;</comment>
                            <comment id="14476268" author="lhotari" created="Mon, 21 Jul 2014 08:24:44 +0000"  >&lt;p&gt;It still fails with Groovy 2.3.4 so it&apos;s not fixed.&lt;/p&gt;

&lt;p&gt;quick way to reproduce&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git clone --depth 10 -b GROOVY-6836-ClassCastException https:&lt;span class=&quot;code-comment&quot;&gt;//github.com/grails/grails-core
&lt;/span&gt;cd grails-core/grails-plugin-testing
../gradlew test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;debugging problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;../gradlew -Ddebug.tests=1 test    # starts a debugger listening at port 5005 when tests get run , add breakpoint &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ClassCastException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14476165" author="lhotari" created="Mon, 21 Jul 2014 08:35:39 +0000"  >&lt;p&gt;stacktrace of ClassCastException (debugger break point for ClassCastException shows this)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; [Test worker] (Suspended (exception ClassCastException))	
	ExpandoMetaClass(MetaClassImpl).getProperty(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) line: 1643	
	ExpandoMetaClass.getProperty(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) line: 1140	
	ExpandoMetaClass(MetaClassImpl).getProperty(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 3458	
	ExpandoMetaClass.getProperty(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 1152	
	HandleMetaClass(DelegatingMetaClass).getProperty(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 128	
	TestPluginUsage.getProperty(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: not available	
	InvokerHelper.getProperty(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 168	
	TestPluginUsage.hashCode() line: not available	
	LinkedHashMap&amp;lt;K,V&amp;gt;(HashMap&amp;lt;K,V&amp;gt;).hash(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 362	
	LinkedHashMap&amp;lt;K,V&amp;gt;(HashMap&amp;lt;K,V&amp;gt;).put(K, V) line: 492	
	LinkedHashSet&amp;lt;E&amp;gt;(HashSet&amp;lt;E&amp;gt;).add(E) line: 217	
	LinkedHashSet&amp;lt;E&amp;gt;(AbstractCollection&amp;lt;E&amp;gt;).addAll(Collection&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; E&amp;gt;) line: 342	
	TestRuntimeFactory$_getRuntimeForTestClass_closure1.doCall(Field) line: 71	
	GeneratedMethodAccessor4.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	CachedMethod.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 90	
	CachedMethod(MetaMethod).doMethodInvoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 233	
	ExpandoMetaClass(MetaClassImpl).invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) line: 1085	
	ExpandoMetaClass.invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) line: 1110	
	ExpandoMetaClass(MetaClassImpl).invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 909	
	TestRuntimeFactory$_getRuntimeForTestClass_closure1(Closure&amp;lt;V&amp;gt;).call(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 423	
	TestRuntimeFactory$_getRuntimeForTestClass_closure1(Closure&amp;lt;V&amp;gt;).call(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 439	
	DefaultGroovyMethods.each(Iterator&amp;lt;T&amp;gt;, Closure) line: 1379	
	DefaultGroovyMethods.each(T, Closure) line: 1310	
	TestRuntimeFactory.getRuntimeForTestClass(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt;) line: 62	
	TestRuntimeFactory$getRuntimeForTestClass.call(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: not available	
	TestRuntimeFactorySpec.$spock_feature_0_0(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 20	
	NativeMethodAccessorImpl.invoke0(Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available [&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method]	
	NativeMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 57	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	ReflectionUtil.invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 138	
	ParameterizedSpecRunner(BaseSpecRunner).invokeRaw(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 330	
	ParameterizedSpecRunner(BaseSpecRunner).invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 311	
	ParameterizedSpecRunner(BaseSpecRunner).invokeFeatureMethod() line: 285	
	ParameterizedSpecRunner(BaseSpecRunner).doRunIteration() line: 256	
	GeneratedMethodAccessor34.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	ReflectionUtil.invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 138	
	ParameterizedSpecRunner(BaseSpecRunner).invokeRaw(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 330	
	ParameterizedSpecRunner(BaseSpecRunner).invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 311	
	ParameterizedSpecRunner(BaseSpecRunner).runIteration(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) line: 223	
	ParameterizedSpecRunner(BaseSpecRunner).initializeAndRunIteration(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) line: 214	
	ParameterizedSpecRunner.runIterations(Iterator[], &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) line: 119	
	ParameterizedSpecRunner.runParameterizedFeature() line: 43	
	ParameterizedSpecRunner(BaseSpecRunner).doRunFeature() line: 198	
	NativeMethodAccessorImpl.invoke0(Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available [&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method]	
	NativeMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 57	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	ReflectionUtil.invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 138	
	ParameterizedSpecRunner(BaseSpecRunner).invokeRaw(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 330	
	ParameterizedSpecRunner(BaseSpecRunner).invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 311	
	ParameterizedSpecRunner(BaseSpecRunner).runFeature() line: 175	
	ParameterizedSpecRunner(BaseSpecRunner).runFeatures() line: 152	
	ParameterizedSpecRunner(BaseSpecRunner).doRunSpec() line: 112	
	NativeMethodAccessorImpl.invoke0(Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available [&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method]	
	NativeMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 57	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	ReflectionUtil.invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 138	
	ParameterizedSpecRunner(BaseSpecRunner).invokeRaw(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 330	
	ParameterizedSpecRunner(BaseSpecRunner).invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, MethodInfo, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 311	
	ParameterizedSpecRunner(BaseSpecRunner).runSpec() line: 91	
	ParameterizedSpecRunner(BaseSpecRunner).run() line: 82	
	Sputnik.run(RunNotifier) line: 63	
	JUnitTestClassExecuter.runTestClass(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 86	
	JUnitTestClassExecuter.execute(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) line: 49	
	JUnitTestClassProcessor.processTestClass(TestClassRunInfo) line: 69	
	WorkerTestClassProcessor(SuiteTestClassProcessor).processTestClass(TestClassRunInfo) line: 48	
	NativeMethodAccessorImpl.invoke0(Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available [&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method]	
	NativeMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 57	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	ReflectionDispatch.dispatch(MethodInvocation) line: 35	
	ReflectionDispatch.dispatch(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 24	
	ContextClassLoaderDispatch&amp;lt;T&amp;gt;.dispatch(T) line: 32	
	ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 93	
	$Proxy2.processTestClass(TestClassRunInfo) line: not available	
	TestWorker.processTestClass(TestClassRunInfo) line: 105	
	NativeMethodAccessorImpl.invoke0(Method, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: not available [&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method]	
	NativeMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 57	
	DelegatingMethodAccessorImpl.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) line: 43	
	Method.invoke(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;...) line: 606	
	ReflectionDispatch.dispatch(MethodInvocation) line: 35	
	ReflectionDispatch.dispatch(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) line: 24	
	MessageHub$Handler.run() line: 355	
	DefaultExecutorFactory$StoppableExecutorImpl$1.run() line: 64	
	ThreadPoolExecutor.runWorker(ThreadPoolExecutor$Worker) line: 1145	
	ThreadPoolExecutor$Worker.run() line: 615	
	&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run() line: 745	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14476180" author="lhotari" created="Mon, 21 Jul 2014 08:38:46 +0000"  >&lt;p&gt;take a look at the build/classes/main/grails/test/runtime/TestPluginUsage.class bytecode (I use jd-cli for decompiling) . It shows that the metaClass of TestPluginUsage is set to the metaClass from HashMap in the constructor which hasn&apos;t been fixed yet.&lt;/p&gt;</comment>
                            <comment id="14476300" author="melix" created="Mon, 21 Jul 2014 10:38:29 +0000"  >&lt;p&gt;So I didn&apos;t manage to reproduce the bug with your instructions, but only with this one:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;git clone -b GROOVY-6836-ClassCastException https://github.com/grails/grails-core
cd grails-core
./gradlew clean grails-plugin-testing:test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I try to compile directly from the subproject, I get tons of errors, and not always the same ones, depending on the number of times I try to run again... Weird. In anycase, the bytecode for the class that has Immutable on it looks curious. There are lots of copies of the same logic for one field:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        26: ldc           #39                 // class java/util/Collection
        28: invokestatic  #45                 // Method org/codehaus/groovy/runtime/ScriptBytecodeAdapter.castToType:(Ljava/lang/Object;Ljava/lang/Class;)Ljava/lang/Object;
        31: checkcast     #39                 // class java/util/Collection
        34: aload_0       
        35: swap          
        36: putfield      #47                 // Field pluginClasses:Ljava/util/Collection;
        39: aload_2       
        40: pop           
        41: goto          763
        44: aload_1       
        45: ldc           #31                 // String pluginClasses
        47: invokeinterface #37,  2           // InterfaceMethod java/util/Map.get:(Ljava/lang/Object;)Ljava/lang/Object;
        52: instanceof    #49                 // class java/lang/Cloneable
        55: ifeq          544
        58: aload_1       
        59: ldc           #31                 // String pluginClasses
        61: invokeinterface #37,  2           // InterfaceMethod java/util/Map.get:(Ljava/lang/Object;)Ljava/lang/Object;
        66: ldc           #51                 // String clone
        68: iconst_0      
        69: anewarray     #53                 // class &quot;[Ljava/lang/Object;&quot;
        72: ldc           #53                 // class &quot;[Ljava/lang/Object;&quot;
        74: invokestatic  #45                 // Method org/codehaus/groovy/runtime/ScriptBytecodeAdapter.castToType:(Ljava/lang/Object;Ljava/lang/Class;)Ljava/lang/Object;
        77: checkcast     #53                 // class &quot;[Ljava/lang/Object;&quot;
        80: invokestatic  #59                 // Method org/codehaus/groovy/runtime/ReflectionMethodInvoker.invoke:(Ljava/lang/Object;Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/Object;
        83: ldc           #39                 // class java/util/Collection
        85: invokestatic  #45                 // Method org/codehaus/groovy/runtime/ScriptBytecodeAdapter.castToType:(Ljava/lang/Object;Ljava/lang/Class;)Ljava/lang/Object;
        88: checkcast     #39                 // class java/util/Collection
        91: instanceof    #61                 // class java/util/SortedSet
        94: ifeq          144
        97: aload_1       
        98: ldc           #31                 // String pluginClasses
       100: invokeinterface #37,  2           // InterfaceMethod java/util/Map.get:(Ljava/lang/Object;)Ljava/lang/Object;
       105: ldc           #51                 // String clone
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe this is just ok and a consequence of an &quot;instanceof&quot; chain, looks inefficient, but in any case, I can&apos;t reproduce outside of Grails.&lt;/p&gt;</comment>
                            <comment id="14476250" author="lhotari" created="Tue, 22 Jul 2014 20:10:52 +0000"  >&lt;p&gt;PR sent &lt;a href=&quot;https://github.com/groovy/groovy-core/pull/492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/pull/492&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14476340" author="melix" created="Wed, 23 Jul 2014 03:54:26 +0000"  >&lt;p&gt;The problem was related to joint compilation, which adds synthetic fields to class nodes before they normally appear in the compilation cycle. See &lt;a href=&quot;https://github.com/groovy/groovy-core/commit/64106f9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/commit/64106f9&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722675" name="TestPluginUsage.groovy.decompiled.java" size="16370" author="lhotari" created="Thu, 29 May 2014 05:15:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ccdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>