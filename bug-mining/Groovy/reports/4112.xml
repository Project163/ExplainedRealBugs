<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:12:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8409] Static compilation with generic function wrapping BiFunction causes GroovyCastException</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8409</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have a statically compiled class with a method that declares Generic type T as it&apos;s return type and accepts a parameter of type java.util.function.BiFunction also with return type T. It makes a call to the passed in BiFunction and assigns the the result to a variable of type T.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; T actionWrapperT(BiFunction&amp;lt;Date, URL, T&amp;gt; action) {
        T result = action.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.example.com&apos;&lt;/span&gt;))
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; here
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When actionWrapperT is called with runtime type T as something other than Date (e.g. XXX), it causes a GroovyCastException.&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;org.codehaus.groovy.runtime.typehandling.GroovyCastException: Cannot cast object &apos;XXX@71b1176b&apos; with class &apos;XXX&apos; to class &apos;java.util.Date&apos;&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;because it incorrectly tries to cast result type to Date rather than to XXX.&lt;/p&gt;

&lt;p&gt;It appears to me that the compiler is conflating generic type T as declared for the generic method with generic type T as declared by BiFunction&amp;lt;T,U,R&amp;gt; because if I change the name of the generic type of the generic method to R (to match the return type name of BiFunction) or to some other name not used by BiFunction, then it works correctly, but if I change it to U to match the second parameter of the BiFunction then it fails trying to cast to the BiFunction generic type U instead of the method generic type U.&lt;/p&gt;

&lt;p&gt;Problem does not happen under normal compilation or with only type checking enabled.&lt;/p&gt;

&lt;p&gt;Attached file Bug.groovy reproduces the problem.&lt;/p&gt;</description>
                <environment>MacOS Sierra 10.12.6</environment>
        <key id="13123925">GROOVY-8409</key>
            <summary>Static compilation with generic function wrapping BiFunction causes GroovyCastException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="svella">Shon Vella</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Dec 2017 16:55:07 +0000</created>
                <updated>Fri, 2 Sep 2022 23:54:42 +0000</updated>
                            <resolved>Fri, 7 May 2021 15:18:22 +0000</resolved>
                                    <version>2.4.8</version>
                    <version>2.4.13</version>
                                    <fixVersion>4.0.0-beta-1</fixVersion>
                    <fixVersion>2.5.17</fixVersion>
                    <fixVersion>3.0.11</fixVersion>
                                    <component>Static compilation</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16297491" author="svella" created="Tue, 19 Dec 2017 21:53:45 +0000"  >&lt;p&gt;Since reporting this issue 10 days ago I have run into this same general problem several times, which is probably best described as the generic type names from the call site scope getting conflated with the generic type names from declaration when CompileStatic is enabled. I&apos;ve seen it both manifest itself at run time as described in the original bug because of an erroneous call to castTo() and at compile time where it either erroneously flags a type mismatch or can&apos;t resolve a property or method because it&apos;s trying to do so with the wrong type.&lt;/p&gt;</comment>
                            <comment id="16584731" author="daniel_sun" created="Sat, 18 Aug 2018 10:01:36 +0000"  >&lt;p&gt;The content of&#160;resolvedPlaceholders is shown as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{R=T, T=java.util.Date, U=java.net.URL}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note: the `T` of `R=T` is defined by user, but the `T` of `T=java.util.Date` is defined in `BiFunction`. As a result, R -&amp;gt; T -&amp;gt; Date&lt;/p&gt;

&lt;p&gt;We should not just use generics name whose type is `String`.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The relevant code is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java#L4954-L4957
&lt;/span&gt;
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, GenericsType&amp;gt; resolvedPlaceholders = resolvePlaceHoldersFromDeclaration(receiver, getDeclaringClass(method, arguments), method, method.isStatic());
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!receiver.isGenericsPlaceHolder()) {
            GenericsUtils.extractPlaceholders(receiver, resolvedPlaceholders);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16585137" author="daniel_sun" created="Sun, 19 Aug 2018 12:30:02 +0000"  >&lt;p&gt;Since `GenericsType` does not have&#160;declaring class, so it will cost more time to fix the issue... &lt;br/&gt;
You can workaround the issue as follows(rename the generics parameter to other name, e.g. `X`)&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic
        &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.function.BiFunction
        @CompileStatic
        &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Groovy8409Bug {
        
            &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;X&amp;gt; X actionWrapperT(BiFunction&amp;lt;Date, URL, X&amp;gt; action) {
                X result = action.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.example.com&apos;&lt;/span&gt;))
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; here
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result
            }
        
            &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
                Groovy8409Bug t = actionWrapperT { Date date, URL url -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Groovy8409Bug() }
            }
        
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16585151" author="daniel_sun" created="Sun, 19 Aug 2018 14:02:05 +0000"  >&lt;p&gt;See `GenericsTypeName` &lt;a href=&quot;https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/ast/GenericsType.java#L502-L514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/master/src/main/java/org/codehaus/groovy/ast/GenericsType.java#L502-L514&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16592739" author="paulk" created="Sun, 26 Aug 2018 01:44:51 +0000"  >&lt;p&gt;Standalone example for testing showing two failing cases and two working cases (R workaround since that matches the third generic type in BiFunction and V since that avoids all existing types):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.function.BiFunction
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic

&lt;span class=&quot;code-comment&quot;&gt;//@CompileStatic (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; uncommented: GroovyCastException: Cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; object &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt; with class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&apos;&lt;/span&gt; to class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.util.Date&apos;&lt;/span&gt;)
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T&amp;gt; T actionWrapperT(BiFunction&amp;lt;Date, URL, T&amp;gt; action) {
    T result = action.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.example.com&apos;&lt;/span&gt;))
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; here
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result
}

&lt;span class=&quot;code-comment&quot;&gt;//@CompileStatic (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; uncommented: GroovyCastException: Cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; object &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt; with class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&apos;&lt;/span&gt; to class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.net.URL&apos;&lt;/span&gt;)
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;U&amp;gt; U actionWrapperU(BiFunction&amp;lt;Date, URL, U&amp;gt; action) {
    U result = action.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.example.com&apos;&lt;/span&gt;))
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; here
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;R&amp;gt; R actionWrapperR(BiFunction&amp;lt;Date, URL, R&amp;gt; action) {
    R result = action.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.example.com&apos;&lt;/span&gt;))
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; here
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;V&amp;gt; V actionWrapperV(BiFunction&amp;lt;Date, URL, V&amp;gt; action) {
    V result = action.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(&lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//www.example.com&apos;&lt;/span&gt;))
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; here
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result
}

actionWrapperT{ Date d, URL u -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; }
actionWrapperU{ Date d, URL u -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; }
actionWrapperR{ Date d, URL u -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; }
actionWrapperV{ Date d, URL u -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will raise the priority of this too.&lt;/p&gt;</comment>
                            <comment id="16640944" author="kenzierocks" created="Sun, 7 Oct 2018 00:53:08 +0000"  >&lt;p&gt;This is a pretty big blocker for &lt;tt&gt;@CompileStatic&lt;/tt&gt; usage in Gradle, as with 5.0 &lt;tt&gt;PluginContainer#getPlugin(Class)&lt;/tt&gt; can no longer return the type of the passed class according to the type checker. I&apos;m willing to take a look into adding the required scoping information to &lt;tt&gt;GenericsTypeName&lt;/tt&gt; if no one else is already doing so.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;See also: (1) from &lt;a href=&quot;https://github.com/gradle/gradle/issues/7048&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gradle/gradle/issues/7048&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16640952" author="daniel_sun" created="Sun, 7 Oct 2018 02:08:56 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenzierocks&quot; class=&quot;user-hover&quot; rel=&quot;kenzierocks&quot;&gt;kenzierocks&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I tried to fix the issue, but time was not allowed(completed some refactoring to extract GenericsTypeName), so I&apos;m very glad to know you are willing to investigate the issue. As you found, the core problem is how to add scope information(e.g. declaring class, enclosing generics type, etc.) to&#160;GenericsTypeName.&lt;/p&gt;

&lt;p&gt;&#160;As a note side, the following two &lt;tt&gt;L&lt;/tt&gt;(1st -&amp;gt; String, 2nd -&amp;gt; GString) and two&#160;&lt;tt&gt;R&lt;/tt&gt; (1st -&amp;gt; Integer, 2nd -&amp;gt; Long) should be distinguished too, so only declaring class is not enough, maybe we need enclosing generics type too.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Pair&amp;lt;L, R&amp;gt; {}

           L       R              L        R
Pair&amp;lt;Pair&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;, Pair&amp;lt;GString, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Daniel.Sun&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13260525">GROOVY-9267</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13479900">GROOVY-10745</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12901363" name="Bug.groovy" size="1182" author="svella" created="Sat, 9 Dec 2017 16:54:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nq9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>