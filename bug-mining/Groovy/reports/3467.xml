<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:59:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8337] STC: instanceof in ternary expression not propagating type info to true expression</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8337</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Static {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; n
  BigDecimal meth() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; n == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || n &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; BigDecimal ? n : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BigDecimal(n.toString())
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;StaticTypeCheckingVisitor is missing the temporary type of the true expression part of the ternary expression because it pops before accessing the type.  One possible solution:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void visitTernaryExpression(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TernaryExpression expression) {
        Map&amp;lt;VariableExpression, List&amp;lt;ClassNode&amp;gt;&amp;gt; oldTracker = pushAssignmentTracking();
        &lt;span class=&quot;code-comment&quot;&gt;// create a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; temporary element in the &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;-then-&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; type info
&lt;/span&gt;        typeCheckingContext.pushTemporaryTypeInfo();
        expression.getBooleanExpression().visit(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        Expression trueExpression = expression.getTrueExpression();
        Expression falseExpression = expression.getFalseExpression();
        trueExpression.visit(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;// GRECLIPSE add
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode typeOfTrue = findCurrentInstanceOfClass(trueExpression, getType(trueExpression));
        &lt;span class=&quot;code-comment&quot;&gt;// GRECLIPSE end
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// pop &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;-then-&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; temporary type info
&lt;/span&gt;        typeCheckingContext.popTemporaryTypeInfo();
        falseExpression.visit(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        ClassNode resultType;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isNullConstant(trueExpression) || isNullConstant(falseExpression)) {
            BinaryExpression enclosingBinaryExpression = typeCheckingContext.getEnclosingBinaryExpression();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (enclosingBinaryExpression != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; enclosingBinaryExpression.getRightExpression()==expression) {
                resultType = getType(enclosingBinaryExpression.getLeftExpression());
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isNullConstant(trueExpression) &amp;amp;&amp;amp; isNullConstant(falseExpression)) {
                resultType = OBJECT_TYPE;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isNullConstant(trueExpression)) {
                resultType = wrapTypeIfNecessary(getType(falseExpression));
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                resultType = wrapTypeIfNecessary(getType(trueExpression));
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// store type information
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// GRECLIPSE edit
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode typeOfTrue = getType(trueExpression);
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// GRECLIPSE end
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode typeOfFalse = getType(falseExpression);
            resultType = lowestUpperBound(typeOfTrue, typeOfFalse);
        }
        storeType(expression, resultType);
        popAssignmentTracking(oldTracker);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13106320">GROOVY-8337</key>
            <summary>STC: instanceof in ternary expression not propagating type info to true expression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="emilles">Eric Milles</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Oct 2017 01:00:28 +0000</created>
                <updated>Thu, 13 Dec 2018 10:05:31 +0000</updated>
                            <resolved>Sun, 26 Aug 2018 02:08:35 +0000</resolved>
                                                    <fixVersion>3.0.0-alpha-4</fixVersion>
                    <fixVersion>2.5.3</fixVersion>
                                    <component>Static Type Checker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16187633" author="paulk" created="Mon, 2 Oct 2017 02:03:35 +0000"  >&lt;p&gt;Eric, what Groovy version are you using? Unless I am missing something, your example seems to run fine on 2.4.12, 2.5.0-beta-1, 2.6.0-alpha-1 and master.&lt;/p&gt;</comment>
                            <comment id="16188291" author="emilles" created="Mon, 2 Oct 2017 15:10:48 +0000"  >&lt;p&gt;I am using 2.4.12.  I agree, on command line and in groovy console it executes.  But I can&apos;t seem to figure out why when it failes within Groovy-Eclipse, which runs the same visitor to process the source for static compilation.  As you can see from the snippet, I needed to patch on my end.  But it looked like a probable improvement for the platform, so I opened this issue and shared my patch.&lt;/p&gt;</comment>
                            <comment id="16188992" author="paulk" created="Mon, 2 Oct 2017 22:47:44 +0000"  >&lt;p&gt;As part of &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8336&quot; title=&quot;Static compilation requires casting inside instanceof check (additional cases)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8336&quot;&gt;&lt;del&gt;GROOVY-8336&lt;/del&gt;&lt;/a&gt; different but similar changes were made. Do they help in your scenario?&lt;/p&gt;</comment>
                            <comment id="16189915" author="emilles" created="Tue, 3 Oct 2017 16:12:35 +0000"  >&lt;p&gt;It may be helpful, it was not available in 2.4.13 snapshot at the time I was looking into the issue.  Also, it has a limitation of no enclosing closure.  Could that restriction be lifted?&lt;/p&gt;</comment>
                            <comment id="16189960" author="emilles" created="Tue, 3 Oct 2017 16:55:41 +0000"  >&lt;p&gt;Paul,&lt;br/&gt;
I can confirm that the changes for Groovy-8336 don&apos;t address my issue.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12890187/12890187_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16592749" author="daniel_sun" created="Sun, 26 Aug 2018 02:08:35 +0000"  >&lt;p&gt;It is fixed now.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/commit/e82bd2654536675c7abcf51f250921f44b5c44f1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/e82bd2654536675c7abcf51f250921f44b5c44f1&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12890187" name="screenshot-1.png" size="36921" author="emilles" created="Tue, 3 Oct 2017 16:56:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3krfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>