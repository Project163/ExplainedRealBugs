<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:13:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3669] Can&apos;t use several times the same JSR-223 ScriptContext for differents groovy script</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3669</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;My use case is that i want to use the same ScriptContext for several scripts which are supposed to shared the same script context but are different script and different output (see &lt;a href=&quot;http://code.xwiki.org/xwiki/bin/view/Macros/ScriptMacro&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://code.xwiki.org/xwiki/bin/view/Macros/ScriptMacro&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;In more details the problem is that GroovyScriptEngineImpl trait the script as something supposed to be used only once and as soon as it set some variables for its internal need it does not take into account anymore provided writer for example. So I can&apos;t use the same ScriptContext for two different scripts.&lt;/p&gt;

&lt;p&gt;Also I think when i finished executing the script i should not find a &quot;out&quot; binding in my ScriptContext since it&apos;s internal groovy use. &quot;context&quot; is a reserved JSR 223 binding but it&apos;s not i should not find it either in the ScriptContext after the execution IMO.&lt;/p&gt;

&lt;p&gt;Right now i have to clean the ScriptContext to be able to properly reuse it with a new writer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12817179">GROOVY-3669</key>
            <summary>Can&apos;t use several times the same JSR-223 ScriptContext for differents groovy script</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guillaume">Guillaume Sauthier</assignee>
                                    <reporter username="tmortagne">Thomas Mortagne</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Aug 2009 09:51:44 +0000</created>
                <updated>Thu, 1 Oct 2009 09:47:37 +0000</updated>
                            <resolved>Wed, 30 Sep 2009 16:06:24 +0000</resolved>
                                    <version>1.6</version>
                                    <fixVersion>1.6.5</fixVersion>
                    <fixVersion>1.7-beta-2</fixVersion>
                                    <component>JSR / TCK / GLS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14467428" author="paulk" created="Thu, 13 Aug 2009 07:41:25 +0000"  >&lt;p&gt;I have a vague idea about what you want but am not sure of the specifics. Can what you are asking for be expressed in a simple Groovy script calling back into Groovy via JSR-223 or is it tightly coupled to xwiki?&lt;/p&gt;

&lt;p&gt;To see if I am slightly on track, can you take a look here:&lt;br/&gt;
&lt;a href=&quot;http://webtest.canoo.com/webtest/manual/scriptStep.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://webtest.canoo.com/webtest/manual/scriptStep.html&lt;/a&gt;&lt;br/&gt;
at the &apos;keep&apos; attribute and its use in the &apos;GroovyTrafficLightWithKeepTest&apos; test.&lt;br/&gt;
Is this the kind of thing you want but for JSR-223 not BSF? Basically a shared binding or is that not what you want?&lt;/p&gt;</comment>
                            <comment id="14478647" author="tmortagne" created="Thu, 13 Aug 2009 09:07:32 +0000"  >&lt;p&gt;No it&apos;s not specific to XWiki but i don&apos;t know groovy very well. To reproduce the use cas i have in XWiki simply in java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// The script context is shared between all engines called in the same request so it&apos;s created &lt;span class=&quot;code-quote&quot;&gt;&quot;by hand&quot;&lt;/span&gt; and not asked to one specific engine
&lt;/span&gt;ScriptContext scriptContext = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleScriptContext();

ScriptEngineManager sem = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ScriptEngineManager();

ScriptEngine engine1 = sem.getEngineByName(&lt;span class=&quot;code-quote&quot;&gt;&quot;groovy&quot;&lt;/span&gt;);
StringWriter stringWriter1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter();
scriptContext.setWriter(stringWriter1);
engine.eval(&lt;span class=&quot;code-quote&quot;&gt;&quot;print \&quot;&lt;/span&gt;world1\&quot;&quot;, scriptContext)
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.print(stringWriter1.toString())

ScriptEngine engine2 = sem.getEngineByName(&lt;span class=&quot;code-quote&quot;&gt;&quot;groovy&quot;&lt;/span&gt;);
StringWriter stringWriter2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter();
scriptContext.setWriter(stringWriter1);
engine.eval(&lt;span class=&quot;code-quote&quot;&gt;&quot;print \&quot;&lt;/span&gt;word2\&quot;&quot;, scriptContext)
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.print(stringWriter2.toString())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This print only word1 because in the second call the engine does not take into account what is configured in the ScriptContext.&lt;/p&gt;

&lt;p&gt;This is what append in XWiki when the script macro is called twice like in:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;{{script language=&lt;span class=&quot;code-quote&quot;&gt;&quot;groovy&quot;&lt;/span&gt;}}
print &lt;span class=&quot;code-quote&quot;&gt;&quot;word1&quot;&lt;/span&gt;
{{/script}}
{{script language=&lt;span class=&quot;code-quote&quot;&gt;&quot;groovy&quot;&lt;/span&gt;}}
print &lt;span class=&quot;code-quote&quot;&gt;&quot;word1&quot;&lt;/span&gt;
{{/script}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;Basically a shared binding or is that not what you want?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes something like that, i want to use the same ScriptContext binding for several different script and engines.&lt;/p&gt;</comment>
                            <comment id="14478644" author="tmortagne" created="Thu, 13 Aug 2009 09:32:41 +0000"  >&lt;p&gt;(Seems i can&apos;t edit my comment)&lt;br/&gt;
I made a mistake: it&apos;s scriptContext.setWriter(stringWriter2); and not scriptContext.setWriter(stringWriter1); the second time&lt;/p&gt;</comment>
                            <comment id="14478646" author="paulk" created="Thu, 13 Aug 2009 10:31:36 +0000"  >&lt;p&gt;So, to restate your comments - to make sure I am clear - the script below produces &apos;world1&apos; but you would also like &apos;world2&apos;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.script.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; javax.script.ScriptContext.ENGINE_SCOPE

def context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleScriptContext()
def sem = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ScriptEngineManager()

def engine1 = sem.getEngineByName(&lt;span class=&quot;code-quote&quot;&gt;&quot;groovy&quot;&lt;/span&gt;)
def sw1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter()
context.writer = sw1
engine1.eval(&lt;span class=&quot;code-quote&quot;&gt;&quot;print &lt;span class=&quot;code-quote&quot;&gt;&apos;world1&apos;&lt;/span&gt;&quot;&lt;/span&gt;, context)
println sw1.toString()

def engine2 = sem.getEngineByName(&lt;span class=&quot;code-quote&quot;&gt;&quot;groovy&quot;&lt;/span&gt;)
def sw2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter()
context.writer = sw2
&lt;span class=&quot;code-comment&quot;&gt;//context.setAttribute(&lt;span class=&quot;code-quote&quot;&gt;&quot;out&quot;&lt;/span&gt;, sw2, ENGINE_SCOPE)
&lt;/span&gt;engine2.eval(&lt;span class=&quot;code-quote&quot;&gt;&quot;print &lt;span class=&quot;code-quote&quot;&gt;&apos;world2&apos;&lt;/span&gt;&quot;&lt;/span&gt;, context)
println sw2.toString()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You don&apos;t want to uncomment the commented out line as that looks to be an internal thing.&lt;br/&gt;
Also, I presume that using sw2 is being forced upon you? You can&apos;t just keep using sw1. Is that correct? Otherwise I see no problem.&lt;/p&gt;

&lt;p&gt;Now my remaining question is how to fix for your case but still leave variables in place normally. The idea being if you don&apos;t change the context, any binding variable set in the first snippet would be available in the second.&lt;/p&gt;</comment>
                            <comment id="14478630" author="tmortagne" created="Thu, 13 Aug 2009 10:53:33 +0000"  >&lt;p&gt;Yes that&apos;s it. No i can&apos;t use the same writer all the time since it&apos;s some local variable use for one script execution and having to reuse the same writer is just another hack like context.setAttribute(&quot;out&quot;, sw2, ENGINE_SCOPE).&lt;/p&gt;

&lt;p&gt;IMO the engine can store things in the ScriptContext (even better if it does not, none of &quot;context&quot; or &quot;out&quot; value really need to be in the ScriptContext IMO) for internal use but it should clean it before return from eval() method. It does not put internal thing in the ScriptContext and it fix the issue since there is no &quot;context&quot; and &quot;out&quot; binding anymore.&lt;/p&gt;</comment>
                            <comment id="14467463" author="paulk" created="Thu, 13 Aug 2009 23:49:13 +0000"  >&lt;p&gt;Again as a workaround, what about just adding this line before the second eval:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;context.removeAttribute(&lt;span class=&quot;code-quote&quot;&gt;&quot;context&quot;&lt;/span&gt;, ENGINE_SCOPE)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I don&apos;t think we want to remove &apos;out&apos; or &apos;context&apos; as they provide fairly standard hooks back to the output stream and engine respectively - while the script is running.&lt;br/&gt;
E.g. your script might use &apos;&lt;tt&gt;out &amp;lt;&amp;lt; &apos;hello&apos;&lt;/tt&gt;&apos; or you might use the context to set a attribute or something.&lt;/p&gt;

&lt;p&gt;Perhaps the fix for Groovy is to include that as the last line inside the eval method. Perhaps &apos;out&apos; also. They will both be added back in if needed with a very small performance hit.&lt;/p&gt;</comment>
                            <comment id="14478639" author="tmortagne" created="Fri, 14 Aug 2009 02:26:24 +0000"  >&lt;p&gt;context.removeAttribute(&quot;context&quot;, ENGINE_SCOPE) is what i do currently for groovy but it&apos;s a hack, i should not have to do it. Removing a binding that should not be there to make sure the configuration is taken into account does not makes sense to me.&lt;/p&gt;

&lt;p&gt;Be able to use &apos;out &amp;lt;&amp;lt; &apos;hello&apos; in a groovy script mean that it has to be in the internal groovy binding not in the ScriptContext. Also even if out is useful it&apos;s not a common JSR-223 reserved keyword so if anyone want to use this binding for something else it will not work even it should. IMO JSR-223 implementation should set as less binding as possible and let JSR-223 API user set needed bindings.&lt;/p&gt;</comment>
                            <comment id="14467938" author="guillaume" created="Wed, 30 Sep 2009 16:06:24 +0000"  >&lt;p&gt;The script context is cleaned up (no more &apos;context&apos; and &apos;out&apos;) and setting the writer on the script context is now taken into account.&lt;/p&gt;</comment>
                            <comment id="14467824" author="tmortagne" created="Thu, 1 Oct 2009 03:24:58 +0000"  >&lt;p&gt;Great, thanks !&lt;/p&gt;</comment>
                            <comment id="14467956" author="guillaume" created="Thu, 1 Oct 2009 09:47:37 +0000"  >&lt;p&gt;You&apos;re welcome Thomas!&lt;br/&gt;
We&apos;ll be releasing Groovy 1.6.5 tomorrow, so you&apos;ll be able to use that fix soon &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cj3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>