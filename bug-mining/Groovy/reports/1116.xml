<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:14:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3861] AST transforms of spock do not take effect when the library is loaded using @Grab</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3861</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Try the following script in groovy console&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; spock.lang.*

@Grab(group=&lt;span class=&quot;code-quote&quot;&gt;&apos;org.spockframework&apos;&lt;/span&gt;, module=&lt;span class=&quot;code-quote&quot;&gt;&apos;spock-core&apos;&lt;/span&gt;, version=&lt;span class=&quot;code-quote&quot;&gt;&apos;0.2&apos;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;HelloSpock &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Specification {
 def &lt;span class=&quot;code-quote&quot;&gt;&quot;can you figure out what I&apos;m up to?&quot;&lt;/span&gt;() {
   expect:
   name.size() == length

   where:
   ignored = println (&lt;span class=&quot;code-quote&quot;&gt;&quot;where: \n p0=$p0\n p1=$p1&quot;&lt;/span&gt;)
   name &amp;lt;&amp;lt; [&lt;span class=&quot;code-quote&quot;&gt;&quot;Kirk&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Spock&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Scotty&quot;&lt;/span&gt;]
   length &amp;lt;&amp;lt; [4, 5, 6]
 }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Output:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;JUnit 4 Runner, Tests: 1, Failures: 1, Time: 0
Test Failure: initializationError(HelloSpock)
org.spockframework.runtime.InvalidSpeckError: Class &apos;HelloSpock&apos; is not a Speck, or has not been compiled properly
	at org.spockframework.runtime.SpeckInfoBuilder.getSpeckMetadata(SpeckInfoBuilder.java:66)
	at org.spockframework.runtime.SpeckInfoBuilder.build(SpeckInfoBuilder.java:46)
	at spock.lang.Sputnik.&amp;lt;init&amp;gt;(Sputnik.java:38)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is happening because spock works by ASTTransformation and before @Grab(spock) has brought spock jar on groovy classpath, groovy does not see its AST transforms and hence the class does not undergo spock related AST transformation and does not run as a spock test.&lt;/p&gt;

&lt;p&gt;However, from the 2nd run onwards, it runs from the same console because in the 2nd run, when groovy scans for AST transforms, it finds spock jar also on the classpath and its AST transformation happens and the class runs as a spock test.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12811722">GROOVY-3861</key>
            <summary>AST transforms of spock do not take effect when the library is loaded using @Grab</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="roshandawrani">Roshan Dawrani</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Oct 2009 15:58:02 +0000</created>
                <updated>Wed, 9 Dec 2009 18:16:41 +0000</updated>
                            <resolved>Thu, 12 Nov 2009 12:51:04 +0000</resolved>
                                    <version>1.6.3</version>
                                    <fixVersion>1.6.6</fixVersion>
                    <fixVersion>1.7-rc-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14468162" author="roshandawrani" created="Sat, 31 Oct 2009 06:52:32 +0000"  >&lt;p&gt;I was trying a way to fix this issue but I have hit a little stumbling block. The issue is related to adding new phase operations in the list that is being iterated.&lt;/p&gt;

&lt;p&gt;So Grab annotation gets processed in phase CONVERSION and spock has this transform called EarlyTransform, which is also to be added in the phase CONVERSION. &lt;/p&gt;

&lt;p&gt;Now the list that contains phase operations of CONVERSION is getting iterated when it calls GrabAnnotationTransformation, which then results in addition of new spock transform EarlyTransform to the same list causing ConcurrentModificationException.&lt;/p&gt;

&lt;p&gt;Any suggestions there?&lt;/p&gt;</comment>
                            <comment id="14468015" author="roshandawrani" created="Sat, 31 Oct 2009 07:53:52 +0000"  >&lt;p&gt;Jochen, I am attaching the patch here for review.&lt;/p&gt;

&lt;p&gt;Here is some information about the patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;ASTTransformationVisitor is modified to support multiple rounds of scanning for AST transforms.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;While the first round of transforms scanning is triggered usually, 2nd one is invoked by GrabAnnotationTransformation after it has successfully fetched dependencies.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;CompilationUnit has been modified to support a parallel list of phase operations that the new AST transforms (introduced by newly grabbed dependencies) could add phase operations to. And then after doing the standard phase operations, this extended set of phase operations are also processed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Do you see any issues with the solution being introduced?&lt;/p&gt;</comment>
                            <comment id="14468163" author="roshandawrani" created="Sun, 1 Nov 2009 11:16:57 +0000"  >&lt;p&gt;Comments?&lt;/p&gt;</comment>
                            <comment id="14468045" author="blackdrag" created="Mon, 2 Nov 2009 10:17:00 +0000"  >&lt;p&gt;hmm... let me think about this a bit...&lt;/p&gt;

&lt;p&gt;You need the new phases because else you get those nasty concurrent modififaction exceptions. If, by chance, a newly added transform would like to add another one, then we get the problem again. &lt;/p&gt;

&lt;p&gt;I don&apos;t know, I don&apos;t like the design, but I have problems comming up with a better solution. Maybe I would solve that with a kind of stack... the same style as new sources are handled. That means using the normal API you can add phases, but the new phases are kept in a stack. Once the phase ends we process the stack and add the transforms to the correct pahse. If a transform is added ot the same phase, then we have to process the remaining ones from the stack. If we have not started processing yet, then we can add the phases directly. If processing started already, then adding a transform to an operation before that should cause an exception. Well, in case of a global transform it should probably be ignored.&lt;/p&gt;

&lt;p&gt;Instead of having an add after grab method I think we should provide a method that can add global transforms and let the grab annotation call it. It is then the responsibility of the annotation to add global transforms. That should remove all the firstScan logic. &lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="14468001" author="roshandawrani" created="Mon, 2 Nov 2009 11:23:55 +0000"  >&lt;p&gt;I am not sure if I understood your stack suggestion fully.&lt;/p&gt;

&lt;p&gt;Are you saying that even the standard (current) phase operations we need to start maintaining in a stack?&lt;/p&gt;

&lt;p&gt;Or you are saying that existing operations should be as-is but the newly added ones should go and sit in the stack? If yes, then how can that be done using the existing API for adding phase operations? We will need to add a different method that will store in stack, right?&lt;/p&gt;

&lt;p&gt;Also I am not sure how will a newly added transform add another one? I know that will create issues with the data structures as used right now but I can&apos;t think how will that happen? We are talking about new ast transforms that are coming in only due to @Grab, right? @Grab will not fetch scripts, right? (which will undergo groovy compilation again on the fly?) Those will be pre-compiled jars, right? Which means that they will not undergo on-the-fly groovy compilation? So how will the cyclic addition of transforms happen?&lt;/p&gt;

&lt;p&gt;I might be missing something basic. It&apos;s always possible with me. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14468086" author="roshandawrani" created="Mon, 2 Nov 2009 11:33:19 +0000"  >&lt;p&gt;I also did not understand the suggestion about letting GrabAnnotationTransformation have a method that will add global transforms. The logic for finding out and adding global transforms is already present in ASTTransformationVisitor, so I was trying to reuse that instead of implementing it again in GrabAnnotationTransformation. &lt;/p&gt;

&lt;p&gt;It also had the advantage that check for duplicates could be done by remembering the transforms added in firstScan. That way 2nd scan onwards only the new transforms get added as phase operations (by doing a comparison with transforms successfully added in previous scans).&lt;/p&gt;</comment>
                            <comment id="14468142" author="roshandawrani" created="Wed, 4 Nov 2009 10:48:42 +0000"  >&lt;p&gt;Jochen, attaching patch V2. The change is that I have made it stack based now. So, if there are cyclic additions of AST transforms, it won&apos;t run into concurrent modification errors anymore.&lt;/p&gt;

&lt;p&gt;As I mentioned earlier, I didn&apos;t understand your suggestion about removing the firstScan logic. As far as I see it at this point, it is all required.&lt;/p&gt;

&lt;p&gt;Waiting for comments V2.&lt;/p&gt;</comment>
                            <comment id="14468179" author="roshandawrani" created="Sun, 8 Nov 2009 20:06:55 +0000"  >&lt;p&gt;Jochen, this newer patch is working fine but because I am not getting any feedback, I am not able to proceed.&lt;/p&gt;

&lt;p&gt;If no critical review comment is remaining from earlier, shall I go ahead applying it?&lt;/p&gt;</comment>
                            <comment id="14468202" author="roshandawrani" created="Thu, 12 Nov 2009 12:51:04 +0000"  >&lt;p&gt;Fixed. Confirmation of the fix sought from Peter against original issue &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3851&quot; title=&quot;@Grapes does not work (at least not in Groovy Console)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3851&quot;&gt;&lt;del&gt;GROOVY-3851&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310260">
                    <name>Related</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12814939">GROOVY-3851</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12722234" name="3861_v16x.txt" size="12409" author="roshandawrani" created="Sat, 31 Oct 2009 07:53:52 +0000"/>
                            <attachment id="12722474" name="3861_v16x_V2.txt" size="13789" author="roshandawrani" created="Wed, 4 Nov 2009 10:48:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c2gn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>