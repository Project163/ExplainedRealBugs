<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:48:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4698] Possible memory leak in Tomcat</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4698</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Using Groovy 1.7.8 Groovlets on Tomcat 6.0.28 yields the following in the log files:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;The web application [...] created a ThreadLocal with key of type [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;] (value [groovy.util.GroovyScriptEngine$2@68aed52c]) and a value of type [org.codehaus.groovy.tools.gse.StringSetMap] (value [{}]) but failed to remove it when the web application was stopped. This is very likely to create a memory leak.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Groovy 1.7.8, Tomcat 6.0.28</environment>
        <key id="12815499">GROOVY-4698</key>
            <summary>Possible memory leak in Tomcat</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwagenleitner">John Wagenleitner</assignee>
                                    <reporter username="fxg">Fran&#231;ois-Xavier Guillemette</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Feb 2011 15:39:26 +0000</created>
                <updated>Mon, 22 Feb 2016 20:48:31 +0000</updated>
                            <resolved>Sun, 24 Jan 2016 15:14:33 +0000</resolved>
                                    <version>1.7.8</version>
                                    <fixVersion>2.4.6</fixVersion>
                                    <component>groovy-runtime</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14473768" author="guyr" created="Sat, 29 Dec 2012 03:24:55 +0000"  >&lt;p&gt;I am getting a similar error on 2.0.6 on Tomcat 7.0.25, with just a basic hello.groovy groovlet:&lt;/p&gt;

&lt;p&gt;SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/groovy&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.codehaus.groovy.reflection.ClassInfo.ThreadLocalMapHandler&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.codehaus.groovy.reflection.ClassInfo$ThreadLocalMapHandler@35a3ae73&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ref.SoftReference&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ref.SoftReference@d121b88&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.&lt;/p&gt;

&lt;p&gt;Fortunately, with this version of Groovy, I can continue.  With 1.8.7, Tomcat would not or could not remove the exploded WAR directory.  So the only way to deploy a new version of the groovlet WAR file was to stop Tomcat and restart it.&lt;/p&gt;
</comment>
                            <comment id="15107852" author="githubbot" created="Wed, 20 Jan 2016 02:29:43 +0000"  >&lt;p&gt;GitHub user jwagenleitner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/245&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/245&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-4698&quot; title=&quot;Possible memory leak in Tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-4698&quot;&gt;&lt;del&gt;GROOVY-4698&lt;/del&gt;&lt;/a&gt; - Possible memory leak in Tomcat (GroovyScriptEngine ThreadLocal)&lt;/p&gt;

&lt;p&gt;    Recommend reviewing each commit separately.  The first commit I think is fairly safe and addresses the issue reported.  The others I&apos;m a little less sure about.&lt;/p&gt;

&lt;p&gt;    863247f - main fix is ensuring that `localTh.remove()` (changed from `localTh.set(null)`) is always called even if an exception occurs.  Did some refactoring by pulling out the code used to update dependencies and the script cache.  Even though some changes have been made to the ThreadLocal&apos;s in this class since that JIRA, the problem remains because `set(null)` will not be called if `super.parseClass` throws.  I think this is a fairly safe change.&lt;/p&gt;

&lt;p&gt;    dbfa026- If we always clean up the ThreadLocal by calling remove, I think things can be simplified by removing the `WeakReference` holder and synchronized `getLocalData` method.&lt;/p&gt;

&lt;p&gt;    c32722a- Since `super.parseClass` is synchronized and the other code in that method just updates thread confined (ThreadLocal) data and ConcurrentHashMap scriptCache, it seemed like that could be done outside of synchronization.  I don&apos;t know if there might be a potential problem with ordering of the `scriptCache.put` calls.  However, if it is supposed to be synchronized, then I&apos;m not sure a ThreadLocal is needed since that would mean all access to the ThreadLocal is synchronized.  In that case why not just have a `private LocalData localData;` field and set it with a `new LocalData()` each time `parseClass` is called?&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;UNIT TEST NOTE&lt;/b&gt;*: I&apos;m not sure how good the added test methods are.  They were helpful in showing the issue before the changes (commit 863247f).  However, they might be brittle since they rely on poking into package-private/private members.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jwagenleitner/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jwagenleitner/groovy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-4698&quot; title=&quot;Possible memory leak in Tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-4698&quot;&gt;&lt;del&gt;GROOVY-4698&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/245.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/245.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #245&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 863247f25b4092d99c8e0fcc85d573f11647cd90&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-01-20T01:55:25Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-4698&quot; title=&quot;Possible memory leak in Tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-4698&quot;&gt;&lt;del&gt;GROOVY-4698&lt;/del&gt;&lt;/a&gt; - Possible memory leak in Tomcat (GroovyScriptEngine ThreadLocal)&lt;/p&gt;

&lt;p&gt;    GSE uses a ThreadLocal to temporarily cache data so it can be used in the compilation phase.  Once the script is compiled the cache data is no longer necessary.  ThreadLocal.set(null) was used which leaves the ThreadLocal as a key in the Thread&apos;s ThreadLocalMap entries.  In addition, if any exceptions were thrown before that call it would leave a ThreadLocal entry with a LocalData value in the thread&apos;s ThreadLocalMap tables.  This change tries to ensure that the ThreadLocal is removed when no longer needed.&lt;/p&gt;

&lt;p&gt;commit dbfa0266e256910a27dfa6acbcc0fabd2fcc8270&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-01-20T01:56:00Z&lt;/p&gt;

&lt;p&gt;    Rework ThreadLocal caching&lt;/p&gt;

&lt;p&gt;commit c32722a990d743dfc30151f719599df2a8b729e1&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-01-20T01:56:22Z&lt;/p&gt;

&lt;p&gt;    Remove synchronized block&lt;/p&gt;

&lt;p&gt;    The call to super.parseClass(GroovyCodeSource,boolean) is synchronized.  Updating local dependency cache and script cache is performed on thread confined (ThreadLocal) and scriptCache ConcurrentHashMap.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15114331" author="githubbot" created="Sun, 24 Jan 2016 14:52:53 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/245&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/245&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310260">
                    <name>Related</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12811922">GROOVY-4177</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c6fr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>