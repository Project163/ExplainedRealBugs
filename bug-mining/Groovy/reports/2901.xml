<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:46:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7448] AbstractConcurrentMap performing rehash() on every insert</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7448</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The problem happens in inner class org.codehaus.groovy.util.AbstractConcurrentMap.Segment.put() method (line 105):&lt;/p&gt;

&lt;p&gt;When the current count is greater then map&apos;s threshold a rehash() happens. Now the tricky part is, that the Map holds soft references to objects and rehash() validates those references. So when GC discards soft references (e.isValid() == false), the resulting segment doesn&apos;t expand (as it is assumed in the put() method).&lt;/p&gt;

&lt;p&gt;in the last line of rehash() the Segmen&apos;t internal counter is updated count = newCount (which is the number of undiscarded (e.isValid() == true) references and can be smaller than previous count as described above)&lt;/p&gt;

&lt;p&gt;after rehash() is done, the put() method continues, however the buggy part is, that it disregards the previous setting of the internal count and it sets the previous count+1 value in every case on lines 124, 143 and 159 of AbstractConcurrentMapBase class.&lt;br/&gt;
Since the rehash() is called only from put() method, the internal counter is not synchronized with real elements count contained in underlying array and rehash() is called on all subsequent calls of put() method.&lt;/p&gt;

&lt;p&gt;The following steps are happening:&lt;/p&gt;

&lt;p&gt;1) Map state: threshold = 786432; count=786432&lt;br/&gt;
2) New element is inserted into the map: count = 786433; threshold = 786432&lt;br/&gt;
3) since new count would be greater than threshold rehash() happens&lt;br/&gt;
rehash() finds out, that most of the objects were garbage collected, thus it doesn&apos;t increase the size of the Segment, however anyway it copies all the objects from one table to another (System.arrayCopy()). (question: why this is done, in this case the old array with repaired invalid elements whould be sufficient ...? )&lt;br/&gt;
4) rehash() sets the internal count to new value, which is smaller, because many objects were garbage collected (soft references), lets say: count = 486 000&lt;br/&gt;
5) The put() continues, disregards the count = 486 000 and sets the count to count = 786433&lt;br/&gt;
6) When another element is inserted, the count is still greater than threshold so the rehash happens again&lt;br/&gt;
From now on every element added to map will trigger a rehash(), which has a huge performance impact.&lt;/p&gt;

&lt;p&gt;When this happens in multithreaded environment, all the other threads are waiting (parked) for lock() until the rehash() and put() is done (and then the next one is doing the rehash() again and so on). You can imagine what performance impact this is.&lt;/p&gt;

&lt;p&gt;Proposed solution:&lt;/p&gt;

&lt;p&gt;Update the c variable after rehash is done. Between lines 105 and 106 of org.codehaus.groovy.util.AbstractConcurrentMap  add:&lt;br/&gt;
104: if (c++ &amp;gt; threshold) &lt;/p&gt;
{

105:                rehash();

106:                c = count + 1

107:}</description>
                <environment></environment>
        <key id="12834553">GROOVY-7448</key>
            <summary>AbstractConcurrentMap performing rehash() on every insert</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="glaforge">Guillaume Laforge</assignee>
                                    <reporter username="barti">Tomas Bartalos</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Jun 2015 11:39:47 +0000</created>
                <updated>Mon, 19 Oct 2015 16:12:09 +0000</updated>
                            <resolved>Tue, 9 Jun 2015 18:28:47 +0000</resolved>
                                    <version>2.1.2</version>
                    <version>2.4.3</version>
                                    <fixVersion>2.4.4</fixVersion>
                                    <component>groovy-jdk</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14569077" author="blackdrag" created="Tue, 2 Jun 2015 13:17:48 +0000"  >&lt;p&gt;congrats, a good find you made there! (and a nice bug report as well)&lt;/p&gt;

&lt;p&gt;If you want to make a pull request for this and get your name into the codebase you are very welcome to do so. If not, then tell me and I do the change with setting c to count+1.&lt;/p&gt;

&lt;p&gt;As for &quot;question: why this is done, in this case the old array with repaired invalid elements whould be sufficient ...? &quot;&lt;br/&gt;
That is a good question... looking at AbstractConcurrentMapBase#rehash, I actually see two loops that invalidate entries. The first one mutates the old table. The second loop will validate the entries again, before copying them into the new table. Those two together don&apos;t make sense to me. I could have said, that without mutating the old table, avoiding side effects for the get method was the goal... though I don&apos;t see those. In my opinion, the second loop can be skipped, if entries haven been invalidated, just as you said. But also the second loop does not need to do a revalidation.&lt;/p&gt;</comment>
                            <comment id="14569269" author="barti" created="Tue, 2 Jun 2015 15:29:00 +0000"  >&lt;p&gt;Thx, I&apos;ve described my original problem &lt;a href=&quot;http://stackoverflow.com/questions/30598302/huge-performance-drop-in-cassandra-orm-after-million-records&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. There is a dirty workaround howto invoke rehash() on its own. I&apos;ll be glad to make the pull request.&lt;/p&gt;</comment>
                            <comment id="14572735" author="githubbot" created="Thu, 4 Jun 2015 13:16:38 +0000"  >&lt;p&gt;GitHub user tomasbartalos opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/33&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7448&quot; title=&quot;AbstractConcurrentMap performing rehash() on every insert&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7448&quot;&gt;&lt;del&gt;GROOVY-7448&lt;/del&gt;&lt;/a&gt; fixed bug for permanent rehashing of AbstractConcurrentMap&lt;/p&gt;

&lt;p&gt;    fixed bug &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7448&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-7448&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tomasbartalos/incubator-groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tomasbartalos/incubator-groovy&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/33.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/33.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #33&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a7e205694dc50e37720d87299fe211b5402ecdce&lt;br/&gt;
Author: tomasbartalos &amp;lt;tomas.bartalos+github@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-06-04T13:10:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7448&quot; title=&quot;AbstractConcurrentMap performing rehash() on every insert&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7448&quot;&gt;&lt;del&gt;GROOVY-7448&lt;/del&gt;&lt;/a&gt; fixed bug for permanent rehashing of AbstractConcurrentMap&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14579357" author="githubbot" created="Tue, 9 Jun 2015 18:26:51 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/33&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[http://stackoverflow.com/questions/30593191/bug-in-groovy-abstractconcurrentmap?noredirect=1]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fia7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>