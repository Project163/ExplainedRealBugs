<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:55:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8229] nested try-catch-finally handling inside Closures generates wrong bytecode</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8229</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Since version 2.4.10 groovy generates the wrong bytecode instructions for try-catch-finally inside closures. This is most likely caused by one of these two changes: &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8085&quot; title=&quot;Exception in &amp;quot;finally&amp;quot; not caught by outer &amp;quot;try&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8085&quot;&gt;&lt;del&gt;GROOVY-8085&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7248&quot; title=&quot;MissingPropertyException: No such property in finally block&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7248&quot;&gt;&lt;del&gt;GROOVY-7248&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This was discovered with the generated code for Spocks &lt;tt&gt;verifyAll&lt;/tt&gt; feature, here is the corresponding issue &lt;a href=&quot;https://github.com/spockframework/spock/issues/709&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/spockframework/spock/issues/709&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem can be observed without Spock in this scenario (&lt;tt&gt;@CompileStatic&lt;/tt&gt; is only used to generate better readable decompiled code, the problem is the same with dynamic code).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Assert
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.runners.model.MultipleFailureException

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TryCatchProblem {

  @Test
  void &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;() {
    def cl = {
      ErrorCollector collector = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ErrorCollector()
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
          collector.collect(e)
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
          collector.collect(e)
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
          collector.collect(e)
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        collector.check()
      }
    }
    cl()
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ErrorCollector {
  List&amp;lt;Throwable&amp;gt; errors = []
  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ctr = 0

  void collect(Throwable t) {
    errors.add(t)
  }

  void check() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!errors.empty) {
      List&amp;lt;Throwable&amp;gt; x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(errors)
      x &amp;lt;&amp;lt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ctr ${++ctr}&quot;&lt;/span&gt;)
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MultipleFailureException(x)
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The different results can be seen here: &lt;a href=&quot;https://gist.github.com/leonard84/23f072b2c434b27e851a3e513570acf1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/leonard84/23f072b2c434b27e851a3e513570acf1&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Result-2.4.9&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;java.lang.AssertionError: a&lt;br/&gt;
java.lang.AssertionError: b&lt;br/&gt;
java.lang.RuntimeException: ctr 1&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Result-2.4.10&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;java.lang.AssertionError: a&lt;br/&gt;
java.lang.AssertionError: b&lt;br/&gt;
java.lang.AssertionError: a&lt;br/&gt;
java.lang.AssertionError: b&lt;br/&gt;
java.lang.RuntimeException: ctr 1&lt;br/&gt;
java.lang.RuntimeException: ctr 3&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the decompiled code can be seen here: &lt;a href=&quot;https://gist.github.com/leonard84/1c91f8aebd0b8af599a6925404e5a11c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/leonard84/1c91f8aebd0b8af599a6925404e5a11c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The relevant part is here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;2.4.9&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                collector.check();
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e3) {
                collector.collect(e3);
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o2 = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                collector.check();
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o2;
            }
            collector.check();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            collector.check();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;vs.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;2.4.10&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                o = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ErrorCollector errorCollector = collector;
                    errorCollector.check();
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o;
                }
                &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e3) {
                    collector.collect(e3);
                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o3 = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    collector.check();
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o3;
                }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {}
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ErrorCollector errorCollector = collector;
                errorCollector.check();
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {}
            collector.check();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            collector.check();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In both cases too many calls to &lt;tt&gt;collector.check()&lt;/tt&gt; are generated, however since the finally block was not executed in &amp;lt;groovy-2.4.10 it was not really an issue. In the 2.4.10 code the generated code is definitely wrong. Somehow a call to &lt;tt&gt;collector.check()&lt;/tt&gt; was put in its own try-catch, which throws the first exception which is then catched, appended and thrown inside a new exception with the call to &lt;tt&gt;collector.check()&lt;/tt&gt; inside the catch. This Exception is then overridden by the call to &lt;tt&gt;collector.check()&lt;/tt&gt; in the finally block, as you can see by the &lt;tt&gt;ctr 3&lt;/tt&gt; instead of &lt;tt&gt;ctr 2&lt;/tt&gt; inside the second RuntimeException.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13079532">GROOVY-8229</key>
            <summary>nested try-catch-finally handling inside Closures generates wrong bytecode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="leonard84">Leonard Br&#252;nings</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Jun 2017 16:35:17 +0000</created>
                <updated>Tue, 11 Jul 2017 00:23:46 +0000</updated>
                            <resolved>Thu, 15 Jun 2017 15:06:17 +0000</resolved>
                                    <version>2.4.10</version>
                    <version>2.4.11</version>
                                    <fixVersion>2.4.12</fixVersion>
                                    <component>bytecode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16048708" author="daniel_sun" created="Wed, 14 Jun 2017 04:57:06 +0000"  >&lt;p&gt;Hi  Leonard,&lt;/p&gt;

&lt;p&gt;     I verified the similiar code with 2.5.0-beta-1, failed to reproduce the try-catch-finally issue. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        println 1
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
        println 2
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        println 3
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
        println 4
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        println 5
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
        println 6
    }
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    println 7
}

/* yield
1
3
5
7

*/
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def c = {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            println 1
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
            println 2
        }
        
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            println 3
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
            println 4
        }
        
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            println 5
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
            println 6
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        println 7
    }
}

c()

/* yield
1
3
5
7

*/
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16048721" author="daniel_sun" created="Wed, 14 Jun 2017 05:22:32 +0000"  >&lt;p&gt;I guess it may be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7248&quot; title=&quot;MissingPropertyException: No such property in finally block&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7248&quot;&gt;&lt;del&gt;GROOVY-7248&lt;/del&gt;&lt;/a&gt; after I completed another experiment:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  void collect(Throwable t) {
    errors.add(t)    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the code is modified as the following, the issue is gone:      [].add(t)
&lt;/span&gt;  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Complete code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Assert
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.runners.model.MultipleFailureException

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TryCatchProblem {

  @Test
  void &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;() {
    def cl = {
      ErrorCollector collector = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ErrorCollector()
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
          collector.collect(e)
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
          collector.collect(e)
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
          collector.collect(e)
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        collector.check()
      }
    }
    cl()
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ErrorCollector {
  List&amp;lt;Throwable&amp;gt; errors = []
  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ctr = 0

  void collect(Throwable t) {
    errors.add(t)    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the code is modified as the following, the issue is gone:      [].add(t)
&lt;/span&gt;  }

  void check() {
    println &lt;span class=&quot;code-quote&quot;&gt;&apos;########################################################################&apos;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!errors.empty) {
      List&amp;lt;Throwable&amp;gt; x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(errors)
      x &amp;lt;&amp;lt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ctr ${++ctr}&quot;&lt;/span&gt;)
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MultipleFailureException(x)
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16049234" author="jwagenleitner" created="Wed, 14 Jun 2017 14:33:51 +0000"  >&lt;p&gt;When running the test case provided in the description I first see the change in output (duplicate errors and incorrect count) starting at &lt;a href=&quot;https://github.com/apache/groovy/commit/b549062485cbd82dfde5537a16ddee126cc7fcfc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit b549062485c&lt;/a&gt; for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8085&quot; title=&quot;Exception in &amp;quot;finally&amp;quot; not caught by outer &amp;quot;try&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8085&quot;&gt;&lt;del&gt;GROOVY-8085&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="16049645" author="leonard84" created="Wed, 14 Jun 2017 20:47:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daniel_sun&quot; class=&quot;user-hover&quot; rel=&quot;daniel_sun&quot;&gt;daniel_sun&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;regarding your statement:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  void collect(Throwable t) {
    errors.add(t)    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the code is modified as the following, the issue is gone:      [].add(t)
&lt;/span&gt;  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;



&lt;p&gt;Just so that I understand you correctly do you mean this?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ErrorCollector {
  List&amp;lt;Throwable&amp;gt; errors = []
  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ctr = 0

  void collect(Throwable t) {
    [].add(t)
  }

  void check() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!errors.empty) {
      List&amp;lt;Throwable&amp;gt; x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(errors)
      x &amp;lt;&amp;lt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ctr ${++ctr}&quot;&lt;/span&gt;)
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MultipleFailureException(x)
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16049881" author="daniel_sun" created="Thu, 15 Jun 2017 01:14:27 +0000"  >&lt;p&gt;Leonard, I&apos;ve reproduce the issue via the simplifed code. If code throws exception in the finally block, the code will execute multi times...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        println 1
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
    }
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    check()
}

def check() {
    println 7
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;check failed...&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16050518" author="leonard84" created="Thu, 15 Jun 2017 13:53:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danielsun1106&quot; class=&quot;user-hover&quot; rel=&quot;danielsun1106&quot;&gt;danielsun1106&lt;/a&gt; I could reproduce the behavior if either a closure or a non-void method is used. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  void tooManyChecks() {
    def cl = {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          println 1
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        check()
      }
    }
    cl()
  }

  def tooManyChecks2() {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        println 1
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      check()
    }
  }

  void thisWorksAsIntended() {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          println 1
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        check()
      }    
  }

  def check() {
    println 7
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;check failed...&quot;&lt;/span&gt;);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;tooManyChecks:&lt;br/&gt;
1&lt;br/&gt;
7&lt;br/&gt;
7&lt;br/&gt;
7&lt;/p&gt;

&lt;p&gt;tooManyChecks2:&lt;br/&gt;
1&lt;br/&gt;
7&lt;br/&gt;
7&lt;br/&gt;
7&lt;/p&gt;

&lt;p&gt;thisWorksAsIntended:&lt;br/&gt;
1&lt;br/&gt;
7&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think that the return handling in conjunction to the finally changes produces this weird behavior. &lt;/p&gt;</comment>
                            <comment id="16050550" author="jwagenleitner" created="Thu, 15 Jun 2017 14:22:42 +0000"  >&lt;p&gt;Here&apos;s a test case I used, note that if you add a return after the &lt;tt&gt;check()&lt;/tt&gt; call it succeeds.  The finally blocks are being replayed by the recorder twice, even though &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8085&quot; title=&quot;Exception in &amp;quot;finally&amp;quot; not caught by outer &amp;quot;try&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8085&quot;&gt;&lt;del&gt;GROOVY-8085&lt;/del&gt;&lt;/a&gt; may have triggered the issue it may be due to some implicit return handling/closures somewhere else.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Groovy8229Bug &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; GroovyTestCase {

    void testFinallyBlockInClosureCalledOnce() {
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; shouldFail(
            &apos;&apos;&apos;
                &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TryCatchProblem {
                    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0
                    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(args) {
                        def cl = {
                            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                                    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; count == 0
                                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) { }
                            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                                check()
                            }
                        }
                        cl()
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void check() {
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsupportedOperationException(&lt;span class=&quot;code-quote&quot;&gt;&quot;check call count: ${++count}&quot;&lt;/span&gt;)
                    }
                }
            &apos;&apos;&apos;
        ) == &lt;span class=&quot;code-quote&quot;&gt;&apos;check call count: 1&apos;&lt;/span&gt;
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7248&quot; title=&quot;MissingPropertyException: No such property in finally block&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7248&quot;&gt;&lt;del&gt;GROOVY-7248&lt;/del&gt;&lt;/a&gt; doesn&apos;t seem to be a cause or related, I&apos;m removing it from the breaks link.  If any disagrees please add it back.&lt;/p&gt;</comment>
                            <comment id="16050552" author="daniel_sun" created="Thu, 15 Jun 2017 14:26:13 +0000"  >&lt;p&gt;John, I agree with you that the issue is not related with &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7249&quot; title=&quot;primopts failing to optimize in if condition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7249&quot;&gt;GROOVY-7249&lt;/a&gt;. I&apos;m trying to fix it.&lt;/p&gt;</comment>
                            <comment id="16050589" author="daniel_sun" created="Thu, 15 Jun 2017 15:06:17 +0000"  >&lt;p&gt;Fixed by &lt;a href=&quot;https://github.com/apache/groovy/commit/0406787a5c29704800132dfde79f9a9018b3e27f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/0406787a5c29704800132dfde79f9a9018b3e27f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16050603" author="leonard84" created="Thu, 15 Jun 2017 15:15:00 +0000"  >&lt;p&gt;Thanks for the quick fix, will there be a fix in 2.4.x for this as well?&lt;/p&gt;</comment>
                            <comment id="16050669" author="daniel_sun" created="Thu, 15 Jun 2017 15:59:10 +0000"  >&lt;p&gt;My pleasure &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Sure, the fix will be merged into 2.x.x.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13041554">GROOVY-8085</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g81b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>