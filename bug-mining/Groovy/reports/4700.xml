<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:22:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-11126] Null-safe Dereference fails after time</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-11126</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have a server-side app that works perfectly for a long time (18-24h) then suddenly starts throwing &quot;impossible&quot; errors.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.NullPointerException: Cannot invoke &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.CharSequence.length()&quot;&lt;/span&gt; because &lt;span class=&quot;code-quote&quot;&gt;&quot;self&quot;&lt;/span&gt; is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;	
        at org.codehaus.groovy.runtime.StringGroovyMethods.size(StringGroovyMethods.java:2693)	at org.codehaus.groovy.runtime.dgm$1323.doMethodInvoke(Unknown Source)
	at com.hatchbaby.model.ColorParser.isOneByteFormat(ColorParser.groovy:74)
	at com.hatchbaby.model.ColorParser.getRed(ColorParser.groovy:13)
	at com.hatchbaby.domain.Content.getRed(Content.groovy:173)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The line of code at ColorParser:74 is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size = color?.size() ?: 0 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The variable `color` is a String. The null-safe dereference operator has ceased to short-circuit.&lt;/p&gt;

&lt;p&gt;This code is years old and has run flawlessly. Since the upgrade from Spring Boot 2.7.4 to Boot 3.1.1, it runs fine for 18-24h, then it starts throwing NullPointerExceptions.&#160; This is happening at a couple of other places in the code, all on null-safe dereferences that don&apos;t short-circuit. The above code is hit 9,000+ times/day. We have a cluster of servers and they seem to develop the problem within a couple hours of each other.&lt;/p&gt;

&lt;p&gt;The server is running with Spring Boot 3.1.1 (hence Groovy 4.0.12) running on Java 17.0.7 (Azul Zulu) on Amazon Linux 2023. The project is joint Java and Groovy code that is compiled with the GMavenPlus 3.0.0 Maven plugin (maven 3.9.1)&lt;/p&gt;

&lt;p&gt;I have tried to reproduce the error by running a tiny program that mimics the error, but so far after running 1.4 million invocations over 24h with no errors (as you might expect).&lt;/p&gt;</description>
                <environment>Zulu Java 17.0.7, Amazon Linux 2023, Spring Boot 3.1.1</environment>
        <key id="13543668">GROOVY-11126</key>
            <summary>Null-safe Dereference fails after time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="kenwdelong">Kenneth W DeLong</reporter>
                        <labels>
                    </labels>
                <created>Sun, 16 Jul 2023 01:55:35 +0000</created>
                <updated>Mon, 13 Oct 2025 15:36:11 +0000</updated>
                            <resolved>Thu, 20 Jul 2023 12:58:42 +0000</resolved>
                                    <version>4.0.11</version>
                    <version>4.0.12</version>
                                    <fixVersion>4.0.14</fixVersion>
                                    <component>bytecode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17743511" author="blackdrag" created="Sun, 16 Jul 2023 10:47:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenwdelong&quot; class=&quot;user-hover&quot; rel=&quot;kenwdelong&quot;&gt;kenwdelong&lt;/a&gt; This is very odd. The trace does not help so much because then it is already too late. Would it be possible for you to attach the compiled ColorParser class? It would be enough to run &quot;javap -v&quot; on the class and attach that output or only attach the print out for the code of the method. I am asking because I am wondering if the version you compile Groovy with is really the Spring Boot version. And since  the Null-safe dereference is almost completely bytecode I would like to be sure I look at the right output.&lt;/p&gt;</comment>
                            <comment id="17743555" author="kenwdelong" created="Sun, 16 Jul 2023 17:16:44 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13061353/13061353_javapOutput.txt&quot; title=&quot;javapOutput.txt attached to GROOVY-11126&quot;&gt;javapOutput.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Here is the javap output.&#160; I downloaded the binary from that server and used it to make sure we got the correct one.&lt;/p&gt;</comment>
                            <comment id="17743982" author="blackdrag" created="Mon, 17 Jul 2023 21:29:06 +0000"  >&lt;p&gt;Quite surprisingly this is not giving me the expected result. The javap output does not contain the method, even though I see calls to it there... ah wait, I may have forgotten a flag to javap. I assume the method is private therefore it needs to be &quot;javap -p -v&quot; on the class. Could you attach the output of that? Sorry for the inconvenience. &lt;/p&gt;</comment>
                            <comment id="17743984" author="kenwdelong" created="Mon, 17 Jul 2023 21:46:44 +0000"  >&lt;p&gt;Oops, sorry, I didn&apos;t pay attention.&#160; I ran `javap -v -p &apos;jar:&lt;a href=&quot;file:///home/ken/work/downloads/hatch-api.jar!/BOOT-INF/classes/com/hatchbaby/model/ColorParser.class&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:///home/ken/work/downloads/hatch-api.jar!/BOOT-INF/classes/com/hatchbaby/model/ColorParser.class&lt;/a&gt;&apos; &amp;gt; javapOutput2.txt `&#160; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13061376/13061376_javapOutput2.txt&quot; title=&quot;javapOutput2.txt attached to GROOVY-11126&quot;&gt;javapOutput2.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17744302" author="blackdrag" created="Tue, 18 Jul 2023 17:06:33 +0000"  >&lt;p&gt;ok, looks like safe navigation is now handled in the invokedynamic part. Since this works in the beginning I assume that something changes over time. Best candidate for this is imho the cache we use. To verify  this would it be possible for you to set the system property groovy.indy.callsite.cache.size to 0? My expectation is that then the error will either not happen or a lot earlier.&lt;/p&gt;</comment>
                            <comment id="17744381" author="kenwdelong" created="Tue, 18 Jul 2023 23:55:25 +0000"  >&lt;p&gt;We rolled out the code with that system property set.&#160; The rollout was much harsher than usual on the servers; CPU and load average spiked up much higher than usual.&#160; It seems to be settling down.&#160; No errors yet!&#160; Will let you know how it&apos;s going tomorrow.&lt;/p&gt;</comment>
                            <comment id="17744701" author="kenwdelong" created="Wed, 19 Jul 2023 16:20:27 +0000"  >&lt;p&gt;So far, no errors, after about 18 hours, we will continue to monitor.&lt;/p&gt;

&lt;p&gt;However, this option has severely impacted the performance of the servers.&#160; Load average and CPU are about 2X what they were before.&#160; The particular affected URL has gone from an average response time of 70ms to 900ms.&#160; So I&apos;m not sure that this is a viable long-term solution.&lt;/p&gt;</comment>
                            <comment id="17744898" author="daniel_sun" created="Thu, 20 Jul 2023 06:01:50 +0000"  >&lt;p&gt;We can bypass the PIC for safe invocation, but I still can not understand why NPE will happen in your code sometimes... Could you reproduce the issue?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;See also,&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/blob/732a204a6439bfadece45b222758c1138cce3292/src/main/java/org/codehaus/groovy/vmplugin/v8/IndyInterface.java#L329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/732a204a6439bfadece45b222758c1138cce3292/src/main/java/org/codehaus/groovy/vmplugin/v8/IndyInterface.java#L329&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17744972" author="blackdrag" created="Thu, 20 Jul 2023 08:45:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daniel_sun&quot; class=&quot;user-hover&quot; rel=&quot;daniel_sun&quot;&gt;daniel_sun&lt;/a&gt;it is not a spread call, it is a safeNavigation call. For me things point to the caching, but why exactly no idea. I could imagine that there is a point where the SoftReference is cleared or the cache emptied. And then somehow the safe navigation flag is lost.... I have found no pointers in the code that would back this though. I guess we would need to experiment where we manually clear the cache or the reference to try to reproduce the problem.&lt;/p&gt;</comment>
                            <comment id="17745035" author="emilles" created="Thu, 20 Jul 2023 10:58:55 +0000"  >&lt;p&gt;Do we have any idea what &quot;org.codehaus.groovy.runtime.dgm$1323&quot; looks like?&lt;/p&gt;

&lt;p&gt;I&apos;m wondering if the switch to &quot;dgm$1323.doInvokeMethod(color)&quot; has the safe check in the wrong position.&lt;/p&gt;

&lt;p&gt;This script throws NPE as described:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; test(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; string) {
  string?.size()
}
10000.times {
  test(&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;)
  test(&apos;&apos;)
}
test()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17745059" author="blackdrag" created="Thu, 20 Jul 2023 12:07:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt;Those dgm methods are just basically proxies for calls to methods in DefaultGroovyMethods and such. They exist only for groovy itself. And have no logic for safe navigation. I wonder if we really still need those actually. They had their use in the old callsite caching, but in Groovy 4? Anyway, it is very good you found an example!&lt;/p&gt;</comment>
                            <comment id="17745063" author="emilles" created="Thu, 20 Jul 2023 12:16:37 +0000"  >&lt;p&gt;The indy guards are skipped if no arguments (aka color) are null and all parameter types (aka String) are final.  So there is no guard added for a swtitch from String to null.&lt;/p&gt;</comment>
                            <comment id="17745080" author="emilles" created="Thu, 20 Jul 2023 12:58:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/44897fe49894591079d8d3b99f6ade55e7d4a05f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/44897fe49894591079d8d3b99f6ade55e7d4a05f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17745127" author="blackdrag" created="Thu, 20 Jul 2023 15:17:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt;I think that needs a bit rework. First of all I would change the test to not do the times loop, it is not required for the issue, and if it is, then the there is another problem hidden by your solution. So I suggest using:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
           def test(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; string) {
                string?.size()
            }

            test(&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;)
            test(&apos;&apos;)
            test()
            test(&lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;that is especially to cover the case NotNull-&amp;gt;Null and Null-&amp;gt;NotNull. &lt;/p&gt;

&lt;p&gt;New line 943 does the null case, and applies guards IS_NULL and optionally SAME_CLASS. 964 is the elseif to that, so here the receiver is not null. It adds here the SAME_CLASS check if the arguments can change class. Your new code in 970 is then another elseif and only called if the receiver is not null and the arguments cannnot change class. Which means it will not be added in the following case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
           def test(string) {
                string?.size()
            }

            test(&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;)
            test(&apos;&apos;)
            test()
            test(&lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;Therefore your if-block should be inside the first elseif.&lt;/p&gt;

&lt;p&gt;Unless I did misread the code again of course.&lt;/p&gt;</comment>
                            <comment id="17745158" author="emilles" created="Thu, 20 Jul 2023 16:14:04 +0000"  >&lt;p&gt;A call with non-null receiver like &quot;color=&apos;&apos;; color?.size()&quot; will fall to the new block which adds a guard so that null will have the call site go to fallback.&#160; Then if you come through with a call with null receiver like &quot;color = null; color?.size()&quot; the first set of guards will be added (the IS_NULL path).&lt;/p&gt;

&lt;p&gt;If you have a test that demonstrates a problem, please share.&lt;/p&gt;</comment>
                            <comment id="17745296" author="kenwdelong" created="Thu, 20 Jul 2023 22:38:31 +0000"  >&lt;p&gt;Thank you all for the quick work! You are all rock stars.&lt;/p&gt;</comment>
                            <comment id="17745553" author="blackdrag" created="Fri, 21 Jul 2023 11:42:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; So if you use def test(string) your newly added block will still be visited? then I misunderstood something in the code. The diff is not always ideal for such things.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenwdelong&quot; class=&quot;user-hover&quot; rel=&quot;kenwdelong&quot;&gt;kenwdelong&lt;/a&gt;You still have the version with the environment variable set running? And the problem did not appear again?&lt;/p&gt;</comment>
                            <comment id="17745673" author="kenwdelong" created="Fri, 21 Jul 2023 17:05:48 +0000"  >&lt;p&gt;We let that run for about 36 hours with no errors, but we have since reverted it due to the load on the servers (and due to what appears to be a fix!)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17745833" author="emilles" created="Fri, 21 Jul 2023 21:46:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt;  I was referring to the path through MethodSelector#chooseMeta&lt;/p&gt;</comment>
                            <comment id="17745920" author="blackdrag" created="Sat, 22 Jul 2023 10:51:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; But the code in that method imho expects the args&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; to be the original receiver.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13631191">GROOVY-11782</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13061353" name="javapOutput.txt" size="55683" author="kenwdelong" created="Sun, 16 Jul 2023 17:16:13 +0000"/>
                            <attachment id="13061376" name="javapOutput2.txt" size="61528" author="kenwdelong" created="Mon, 17 Jul 2023 21:46:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>groovy</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1j628:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>