<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:04:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8298] Slow Performance Caused by Invoke Dynamic</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8298</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have been researching a problem my application is having where performance seems to be much slower than I would expect. After a lot of research I found &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-6583&quot; title=&quot;Performance issue when using Groovy pow syntax with InvokeDynamic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-6583&quot;&gt;&lt;del&gt;GROOVY-6583&lt;/del&gt;&lt;/a&gt; which seems to have the same symptoms (though not caused by the same method calls). After more research I found someone who reported a similar issue and created a &lt;a href=&quot;https://github.com/dwclark/deopt-storm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sample application&lt;/a&gt; which reproduces the issue. I am seeing the same behavior he discusses which is that using the JIT probe I&apos;m able to see that our production application is constantly uses a large amount of CPU on JIT activities for days on end, it never gets better. &lt;/p&gt;

&lt;p&gt;When doing a thread dump of our application we often see 20-50 threads all stuck on this same stack trace:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;&quot;qtp2078714399-360525&quot;: running, holding [771bcf60]
	at java.lang.invoke.MethodHandleNatives.setCallSiteTargetNormal(Native Method)
	at java.lang.invoke.CallSite.setTargetNormal(CallSite.java:258)
	at java.lang.invoke.MutableCallSite.setTarget(MutableCallSite.java:154)
	at org.codehaus.groovy.vmplugin.v7.Selector$MethodSelector.doCallSiteTargetSet(Selector.java:909)
	at org.codehaus.groovy.vmplugin.v7.Selector$MethodSelector.setCallSiteTarget(Selector.java:969)
	at org.codehaus.groovy.vmplugin.v7.IndyInterface.selectMethod(IndyInterface.java:228)
	at java.lang.invoke.LambdaForm$DMH/1665404403.invokeStatic_L3IL5_L(LambdaForm$DMH)
	at java.lang.invoke.LambdaForm$BMH/1828868503.reinvoke(LambdaForm$BMH)
	at java.lang.invoke.LambdaForm$reinvoker/1917025677.dontInline(LambdaForm$reinvoker)
	at java.lang.invoke.LambdaForm$MH/462773420.guard(LambdaForm$MH)
	at java.lang.invoke.LambdaForm$MH/1947020920.linkToCallSite(LambdaForm$MH)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;No matter how long the application runs it will continue to show this behavior. From what I&apos;ve read I think our code causes this problem because we run code that looks like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// List of objects will consistent of 2-20 instances of classes 
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// which all implement the same &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; which defines the runMethod. 
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// Each concrete implementation will have it&apos;s own unique behavior
&lt;/span&gt;def resultList = listOfObjects*.runMethod()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Turning off invoke dynamic compilation and using the regular groovy-all jar seems to eliminate the issue and result it overall better performance.&lt;/p&gt;

&lt;p&gt;It would be nice if Groovy could at least identify this situation and prevent itself from getting in to the de-opt storm.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13097661">GROOVY-8298</key>
            <summary>Slow Performance Caused by Invoke Dynamic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="jjathman">Joseph Athman</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Aug 2017 17:51:12 +0000</created>
                <updated>Thu, 1 May 2025 14:26:28 +0000</updated>
                            <resolved>Sat, 11 Jan 2020 18:12:37 +0000</resolved>
                                    <version>2.4.12</version>
                                    <fixVersion>3.0.0-rc-3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="21000">5h 50m</timespent>
                                <comments>
                            <comment id="16142908" author="jwagenleitner" created="Sat, 26 Aug 2017 19:53:10 +0000"  >&lt;p&gt;I have seen the problem and have recently added a &lt;a href=&quot;https://github.com/apache/groovy/blob/482e8d3699e5593a60cc8db5523895fbf7235367/subprojects/performance/src/jmh/java/org/apache/groovy/bench/dispatch/CallsiteBench.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;callsite benchmark test&lt;/a&gt; that shows indy&apos;s performance issue with poly and mega morphic calls.  Currently each time a new receiver is found at a callsite it is relinked.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It would be nice if Groovy could at least identify this situation and prevent itself from getting in to the de-opt storm.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think a PIC is needed in order to improve performance in this situation.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; might be able to correct me if I&apos;m wrong about Groovy currently having a single inline cache.&lt;/p&gt;</comment>
                            <comment id="16408494" author="jjathman" created="Wed, 21 Mar 2018 20:04:24 +0000"  >&lt;p&gt;Any thoughts on this one? It makes me nervous that just turning on invoke dynamic causes this severe of a problem, especially since it is so difficult to troubleshoot.&lt;/p&gt;</comment>
                            <comment id="16767503" author="jjathman" created="Wed, 13 Feb 2019 19:38:23 +0000"  >&lt;p&gt;I was just reading how Groovy 3 will default to use invoke dynamic support. I think this issue is still a problem. I&#8217;m concerned many more people will run in to this issue after the conversion.&#160;&lt;/p&gt;</comment>
                            <comment id="16770323" author="daniel_sun" created="Sun, 17 Feb 2019 07:59:39 +0000"  >&lt;p&gt;FYI. &lt;br/&gt;
Jochen discussed the performance issue of indy in the JVM Language group, but no one gave the final solution...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://groups.google.com/forum/m/#!topic/jvm-languages/aXH7RwoLIqQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groups.google.com/forum/m/#!topic/jvm-languages/aXH7RwoLIqQ&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16770327" author="daniel_sun" created="Sun, 17 Feb 2019 08:04:59 +0000"  >&lt;p&gt;Here is a bug report related to the performance issue:&lt;br/&gt;
&lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8151981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8151981&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe we have to find a solution to workaround the bug, e.g. avoid invoking &lt;tt&gt;MethodHandleNatives.setCallSiteTargetNormal&lt;/tt&gt; as possible as we can(even if intermediate invoking)...&lt;/p&gt;</comment>
                            <comment id="16833085" author="daniel_sun" created="Sat, 4 May 2019 15:33:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/29812958/execution-of-bubble-sort-is-5-times-slower-with-indy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/29812958/execution-of-bubble-sort-is-5-times-slower-with-indy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; said:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The answer is easy actually quite easy, Groovy does not have a PIC yet.&lt;/p&gt;

&lt;p&gt;... or you can say that we usually have an inline cache of size 1. This means every time you change the list array type, it will invalidate all caches that did exist before and the cached version is thrown away. That is for normal Groovy almost the same as for indy, only that normal Groovy uses runtime generated classes and indy uses invokedynamic/lambda forms. But lambda forms are initially slower, while peak performance is better. Basically what you do is let hotspot start from scratch for most of the method calls, preventing it to apply the optimizations all the time. Of course that is not your fault, but the fault of Groovy for not having a PIC yet. and just to make this very clear... this is no problem of the language, it is simply something I did not yet get to implement.&lt;/p&gt;

&lt;p&gt;JRuby on the other hand has a PIC and thus has not to suffer from the overhead of creating new method handles all the time.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17007729" author="daniel_sun" created="Fri, 3 Jan 2020 20:01:39 +0000"  >&lt;p&gt;Here is the PR to implement inline cache for Indy callsite: &lt;a href=&quot;https://github.com/apache/groovy/pull/1135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/1135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I tested the performance against the PR by simply running the following code, and got the time consumed:&lt;/p&gt;

&lt;p&gt;Legacy callsite cache: 2s&lt;br/&gt;
Indy callsite: 6s&lt;br/&gt;
Indy callsite with inline cache: 2s&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100000; i++) {
                [1, 1.0f, &lt;span class=&quot;code-quote&quot;&gt;&apos;1.0&apos;&lt;/span&gt;].each { it.toString() }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;P.S. I will try to run the performance tests created by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jwagenleitner&quot; class=&quot;user-hover&quot; rel=&quot;jwagenleitner&quot;&gt;jwagenleitner&lt;/a&gt; later.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13434705">GROOVY-10535</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13441637">GROOVY-10596</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13036090">GROOVY-8057</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13616475">GROOVY-11640</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jasf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>