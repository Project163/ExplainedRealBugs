<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:11:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9397] CLONE - Closures are maybe not Threadsafe</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9397</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I just upgraded our Gradle build from 1.12 (including Groovy 1.8.6) to 3.5 (including Groovy 2.4.10).&lt;br/&gt;
Now I get a very strange behavior for stuff that is there for years already and it looks to me as if this is a Groovy bug, maybe a non-threadsafeness of Closures.&lt;/p&gt;

&lt;p&gt;I have a custom task that contains the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      def sourceFilesSize = getSourceFiles().files.size()
      def poolSize = &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.runtime.availableProcessors()
      def executor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadPoolExecutor(poolSize, poolSize, 0, SECONDS, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayBlockingQueue&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;&amp;gt;([sourceFilesSize, 1].max()))
      def tasks = []
      inputs.outOfDate { toTransform -&amp;gt;
         tasks.add executor.submit {
            project.exec {
               &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (gscPath) { &lt;span class=&quot;code-comment&quot;&gt;// here starts com.empic.build.tasks.Ghostscript$_exec_closure8$_closure11
&lt;/span&gt;                  environment &lt;span class=&quot;code-quote&quot;&gt;&apos;GSC&apos;&lt;/span&gt;, gscPath
                  def tempDir = &lt;span class=&quot;code-quote&quot;&gt;&quot;$temporaryDir/${&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().name}&quot;&lt;/span&gt;
                  project.file(tempDir).mkdirs()
                  environment &lt;span class=&quot;code-quote&quot;&gt;&apos;TEMP&apos;&lt;/span&gt;, tempDir
               }
               executable executablePath

               def arguments = [toTransform.file.absolutePath]
               &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((sourceFilesSize == 1) &amp;amp;&amp;amp; getDestinationFile()) {
                  arguments &amp;lt;&amp;lt; getDestinationFile().absolutePath
               } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (destinationDirectory) {
                  arguments &amp;lt;&amp;lt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(destinationDirectory, fileNameMapping(toTransform.file.name)).absolutePath
               } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                  arguments &amp;lt;&amp;lt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(toTransform.file.parentFile, fileNameMapping(toTransform.file.name)).absolutePath
               }
               args arguments &lt;span class=&quot;code-comment&quot;&gt;// here ends com.empic.build.tasks.Ghostscript$_exec_closure8$_closure11
&lt;/span&gt;            }
         }
      }
      executor.shutdown()
      executor.awaitTermination 1, HOURS
      tasks*.get() &lt;span class=&quot;code-comment&quot;&gt;// here is line 137&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When this task is executed e. g. with five source files, sometimes all works fine, sometime the build fails with&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
Caused by: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: initialize must be called for meta class of class com.empic.build.tasks.Ghostscript$_exec_closure8$_closure11(class org.codehaus.groovy.runtime.metaclass.ClosureMetaClass) to complete initialisation process before any invocation or field/property access can be done
        at com.empic.build.tasks.Ghostscript.exec(Ghostscript.groovy:137)
        at org.gradle.internal.reflect.JavaMethod.invoke(JavaMethod.java:73)
        ... 80 more
Caused by: java.lang.IllegalStateException: initialize must be called for meta class of class com.empic.build.tasks.Ghostscript$_exec_closure8$_closure11(class org.codehaus.groovy.runtime.metaclass.ClosureMetaClass) to complete initialisation process before any invocation or field/property access can be done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Actually I was not able to reproduce the problem locally, but if I run the build on our CI server and attach a debugger, I indeed was able to reproduce the problem with a relatively high reproduction rate. (as in every second to third build approximately, opposed to once every 100 builds)&lt;/p&gt;

&lt;p&gt;I logged the current thread when the &lt;tt&gt;initialized&lt;/tt&gt; property is set to &lt;tt&gt;true&lt;/tt&gt; and when it is requested with non-suspending breakpoints, but this seems to have caused the timing to change enough already that I was not able to reproduce the error within approximately the first two dozens of tries.&lt;/p&gt;

&lt;p&gt;I was able to successfully break at the throwing of the &lt;tt&gt;IllegalStateException&lt;/tt&gt; though. This happens in &lt;tt&gt;groovy.lang.MetaClassImpl.checkInitalised&lt;/tt&gt;.&lt;br/&gt;
The stacktrace at this point is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;pool-2-thread-3@10709&quot; prio=5 tid=0x47 nid=NA runnable
  java.lang.Thread.State: RUNNABLE
	  at groovy.lang.MetaClassImpl.checkInitalised(MetaClassImpl.java:1647)
	  at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:257)
	  at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1027)
	  at groovy.lang.Closure.call(Closure.java:414)
	  at groovy.lang.Closure.call(Closure.java:408)
	  at groovy.lang.Closure.run(Closure.java:495)
	  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	  at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	  at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with the closure for which we are at the &lt;tt&gt;ClosureMetaClass&lt;/tt&gt; in the topmost frame being the mentioned &lt;tt&gt;com.empic.build.tasks.Ghostscript$_exec_closure8$_closure11&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment>Gradle 3.5</environment>
        <key id="13284949">GROOVY-9397</key>
            <summary>CLONE - Closures are maybe not Threadsafe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="vampire">Bj&#246;rn Kautler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Feb 2020 01:13:40 +0000</created>
                <updated>Sun, 2 May 2021 09:16:16 +0000</updated>
                            <resolved>Thu, 8 Apr 2021 09:19:08 +0000</resolved>
                                    <version>2.4.10</version>
                                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>4.0.0-alpha-3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17035836" author="paulk" created="Thu, 13 Feb 2020 01:15:56 +0000"  >&lt;p&gt;I cloned the issue and will close the original. It will make it easier to understand existing commits in the codebase that use the old issue number. We still need to do further investigation. That should happen using this new issue.&lt;/p&gt;</comment>
                            <comment id="17294500" author="broe" created="Wed, 3 Mar 2021 12:24:50 +0000"  >&lt;p&gt;In case this is useful to anyone, I can reproduce this issue with this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.Executors
def executor = Executors.newCachedThreadPool()
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Closure action = { -&amp;gt; }
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
  executor.execute(action)
  executor.execute(() -&amp;gt; action.respondsTo(&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;))
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looking at ClosureMetaClass I suspect the problem is in the way loadMetaInfo() resets the initialized state of the object with no locking to prevent other threads seeing the Closure as temporarily uninitialized. I&apos;m unsure of the safest/most performant way of fixing the problem. I tested with &quot;Groovy Version: 3.0.7 JVM: 11.0.7 Vendor: AdoptOpenJDK OS: Mac OS X&quot;&lt;/p&gt;</comment>
                            <comment id="17317014" author="daniel_sun" created="Thu, 8 Apr 2021 09:19:10 +0000"  >&lt;p&gt;The proposed PR has been merged. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="13076497">GROOVY-8213</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bfow:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>