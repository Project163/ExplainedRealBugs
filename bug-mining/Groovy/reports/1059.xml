<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:13:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3275] Process.consumeProcessOutput leads to a race condition</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3275</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Groovy provides convenience methods in Process like consumeProcessOutput that spawns off threads to handle an external process&apos; I/O. Unfortunately, these threads are sort of dumped on the floor, leaving the user with no way to manage race conditions where threads finish at different times. For example, the following code tries to capture stdout into a compressed file:&lt;/p&gt;

&lt;p&gt;        Process p = &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;mysqldump&amp;#39;, &amp;#39;big_database&amp;#39;&amp;#93;&lt;/span&gt;.execute()&lt;br/&gt;
        def os = new GZIPOutputStream(new File(&apos;dbdump.sql.gz&apos;).newOutputStream())&lt;br/&gt;
        p.consumeProcessOutput os, System.err&lt;br/&gt;
        p.waitFor()&lt;br/&gt;
        os.close()&lt;/p&gt;

&lt;p&gt;This can result in the following exception. This is because while the process itself may terminate after Process.waitFor(), the thread writing the corresponding output stream may not be finished writing yet. So if I call OutputStream.close() immediately after Process.waitFor(), there is a chance that the gzip stream may not be fully written yet, so the consumer thread tries to write to an output stream that has already been closed. The trouble is, there is no way for me to tell when the consumer threads are done processing.&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;Thread-27&quot; groovy.lang.GroovyRuntimeException: exception while dumping process stream&lt;br/&gt;
        at org.codehaus.groovy.runtime.DefaultGroovyMethods$ByteDumper.run(DefaultGroovyMethods.java:10063)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
Caused by: java.io.IOException: write beyond end of stream&lt;br/&gt;
        at java.util.zip.DeflaterOutputStream.write(DeflaterOutputStream.java:104)&lt;br/&gt;
        at java.util.zip.GZIPOutputStream.write(GZIPOutputStream.java:72)&lt;br/&gt;
        at org.codehaus.groovy.runtime.DefaultGroovyMethods$ByteDumper.run(DefaultGroovyMethods.java:10060)&lt;br/&gt;
        ... 1 more&lt;/p&gt;

&lt;p&gt;There are two possible solutions to this:&lt;br/&gt;
1. Process.waitFor should also wait for the consumer threads to finish.&lt;br/&gt;
2. Find a way to expose the consumer thread objects so the user can call Thread.join() on them.&lt;/p&gt;
</description>
                <environment>Linux (RHEL) x64, JDK 1.5</environment>
        <key id="12817975">GROOVY-3275</key>
            <summary>Process.consumeProcessOutput leads to a race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="cwong15">Christopher Wong</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Jan 2009 20:38:12 +0000</created>
                <updated>Thu, 15 Oct 2009 17:15:30 +0000</updated>
                            <resolved>Sat, 19 Sep 2009 06:50:07 +0000</resolved>
                                    <version>1.5.6</version>
                                    <fixVersion>1.6.5</fixVersion>
                    <fixVersion>1.7-beta-2</fixVersion>
                                    <component>groovy-jdk</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14478442" author="paulk" created="Thu, 22 Jan 2009 21:47:52 +0000"  >&lt;p&gt;I am thinking a reasonable step forward here is to make the individual consumeProcessXXX methods return the created thread.&lt;/p&gt;

&lt;p&gt;It means that you can&apos;t use the all in one shorthand if you want this level of control. For your example above it would become:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;def t = p.consumeProcessOutputStream(os)
p.consumeProcessErrorStream &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err
p.waitFor()
t.join()
os.close()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14467742" author="jimjag" created="Fri, 18 Sep 2009 13:02:56 +0000"  >&lt;p&gt;Heres a patch that addresses this and another race condition that&apos;s been bugging me as well.&lt;/p&gt;

&lt;p&gt;Note the when using each ind stream, we provide more control. If using consumeProcessOutput(), then the assumption is that we want to wait until the threads complete... Plus, it was MUCH easier this way &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Passes all tests.&lt;/p&gt;</comment>
                            <comment id="14467726" author="jimjag" created="Fri, 18 Sep 2009 14:35:16 +0000"  >&lt;p&gt;Note the consumeProcessOutput() does change current behavior, which is likely not good long term. Maybe consumeProcessOutputWaitFor() would be better so we could keep consumeProcessOutput() behavior as is, allow for Thread control for consumeProcessError/OutputStream, and add a new consumeProcessOutputWaitFor() which forces the threads to join (and, of course, does not immediately return).&lt;/p&gt;</comment>
                            <comment id="14467663" author="jimjag" created="Fri, 18 Sep 2009 14:48:59 +0000"  >&lt;p&gt;Add in joined versions and update the docs...&lt;/p&gt;</comment>
                            <comment id="14478666" author="paulk" created="Sat, 19 Sep 2009 06:50:07 +0000"  >&lt;p&gt;Patch added. Thanks Christopher!&lt;/p&gt;</comment>
                            <comment id="14467768" author="guillaume" created="Sat, 19 Sep 2009 06:58:59 +0000"  >&lt;p&gt;Thanks Jim for the patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14478703" author="paulk" created="Sat, 19 Sep 2009 08:06:08 +0000"  >&lt;p&gt;Oops, sorry about that, I meant thanks Jim for the patch and thanks Christopher for raising the issue!&lt;/p&gt;</comment>
                            <comment id="14467791" author="jimjag" created="Sat, 19 Sep 2009 08:19:40 +0000"  >&lt;p&gt;Np... is there any way you could change the patched @author tag... I know, I know, it&apos;s a nit-pick &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14478691" author="paulk" created="Sat, 19 Sep 2009 08:30:11 +0000"  >&lt;p&gt;Already done! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14467696" author="guillaume" created="Sat, 19 Sep 2009 08:45:04 +0000"  >&lt;p&gt;Jim was suggesting to me earlier that we could perhaps use waitFor instead of wait as suffix, so that it&apos;s more aligned with the waitFor method we already have on Process.&lt;br/&gt;
What do you think?&lt;/p&gt;</comment>
                            <comment id="14467744" author="jimjag" created="Sat, 19 Sep 2009 08:52:44 +0000"  >&lt;p&gt;I was thinking (yeah, I know, dangerous &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ), to be consistent which naming, and Process.waitFor and Process.waitForOrKill, the method should really be called consumeProcessOutputWaitFor(), doncha think?&lt;/p&gt;

&lt;p&gt;Here&apos; s trivial patch to make that change.&lt;/p&gt;</comment>
                            <comment id="14478696" author="paulk" created="Sat, 19 Sep 2009 10:24:58 +0000"  >&lt;p&gt;I am happy for a rename (now is the time to do it!). Wondering whether &lt;tt&gt;waitForProcessOutput&lt;/tt&gt; is better than &lt;tt&gt;consumeProcessOutputWaitFor&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14467804" author="guillaume" created="Sat, 19 Sep 2009 10:44:19 +0000"  >&lt;p&gt;Sounds like better English, indeed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12721391" name="gvy.patch" size="1769" author="jimjag" created="Sat, 19 Sep 2009 08:52:44 +0000"/>
                            <attachment id="12722057" name="gvy.patch" size="6232" author="jimjag" created="Fri, 18 Sep 2009 14:48:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bvhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>