<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:22:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3495] LinkageError when obtaining a Cipher instance in a multithreaded environment</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3495</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When obtaining a Cipher instance the Groovy rootLoader can throw a LinkageError in relation to the provider implementation classes if multiple threads try get such a Cipher instance.&lt;/p&gt;

&lt;p&gt;No unit test as I can&apos;t reliably reproduce the effect...&lt;br/&gt;
An example script to illustrate the issue (may need to run multiple times):&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;import javax.crypto.Cipher&lt;br/&gt;
import org.bouncycastle.jce.provider.BouncyCastleProvider&lt;br/&gt;
import java.security.Security&lt;/p&gt;

&lt;p&gt;Security.addProvider(new org.bouncycastle.jce.provider.BouncyCastleProvider())&lt;/p&gt;

&lt;p&gt;def getCipherInstance = {Cipher.getInstance(&quot;Blowfish/ECB/PKCS5Padding&quot;, BouncyCastleProvider.PROVIDER_NAME)}&lt;/p&gt;

&lt;p&gt;new Thread(getCipherInstance).start()&lt;br/&gt;
new Thread(getCipherInstance).start()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And the exception:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Exception in thread &quot;Thread-2&quot; org.codehaus.groovy.runtime.InvokerInvocationException: java.lang.LinkageError: loader (instance of  org/codehaus/groovy/tools/RootLoader): attempted  duplicate class definition for name: &quot;org/bouncycastle/jce/provider/JCEBlockCipher$Blowfish&quot;&lt;br/&gt;
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:92)&lt;br/&gt;
	at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:234)&lt;br/&gt;
	at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:272)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:893)&lt;br/&gt;
	at groovy.lang.Closure.call(Closure.java:279)&lt;br/&gt;
	at groovy.lang.Closure.call(Closure.java:274)&lt;br/&gt;
	at groovy.lang.Closure.run(Closure.java:355)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.lang.LinkageError: loader (instance of  org/codehaus/groovy/tools/RootLoader): attempted  duplicate class definition for name: &quot;org/bouncycastle/jce/provider/JCEBlockCipher$Blowfish&quot;&lt;br/&gt;
	at java.lang.ClassLoader.defineClass1(Native Method)&lt;br/&gt;
	at java.lang.ClassLoader.defineClass(ClassLoader.java:621)&lt;br/&gt;
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:124)&lt;br/&gt;
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:260)&lt;br/&gt;
	at java.net.URLClassLoader.access$000(URLClassLoader.java:56)&lt;br/&gt;
	at java.net.URLClassLoader$1.run(URLClassLoader.java:195)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at java.net.URLClassLoader.findClass(URLClassLoader.java:188)&lt;br/&gt;
	at org.codehaus.groovy.tools.RootLoader.oldFindClass(RootLoader.java:152)&lt;br/&gt;
	at org.codehaus.groovy.tools.RootLoader.loadClass(RootLoader.java:124)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:252)&lt;br/&gt;
	at java.security.Provider$Service.getImplClass(Provider.java:1262)&lt;br/&gt;
	at java.security.Provider$Service.newInstance(Provider.java:1220)&lt;br/&gt;
	at javax.crypto.Cipher.getInstance(DashoA13*..)&lt;br/&gt;
	at javax.crypto.Cipher.getInstance(DashoA13*..)&lt;br/&gt;
	at javax.crypto.Cipher$getInstance$0.call(Unknown Source)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCall(CallSiteArray.java:43)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:117)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:129)&lt;br/&gt;
	at CipherTest$_run_closure1.doCall(CipherTest.groovy:7)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:86)&lt;br/&gt;
	at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:234)&lt;br/&gt;
	at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:272)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:893)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.PogoMetaClassSite.callCurrent(PogoMetaClassSite.java:66)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.callCurrent(AbstractCallSite.java:151)&lt;br/&gt;
	at CipherTest$_run_closure1.doCall(CipherTest.groovy)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:86)&lt;br/&gt;
	... 7 more&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment>Using BouncyCastle as security provider</environment>
        <key id="12814672">GROOVY-3495</key>
            <summary>LinkageError when obtaining a Cipher instance in a multithreaded environment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="sgo">Sebastian Gozin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Apr 2009 06:46:58 +0000</created>
                <updated>Sun, 4 Sep 2011 14:36:17 +0000</updated>
                            <resolved>Sun, 4 Sep 2011 14:36:16 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.8.2</fixVersion>
                    <fixVersion>1.9-beta-3</fixVersion>
                    <fixVersion>1.7.11</fixVersion>
                                        <due></due>
                            <votes>4</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14469564" author="rdfrederiksen" created="Mon, 7 Jun 2010 15:36:44 +0000"  >&lt;p&gt;I have a very similar problem when using groovy 1.7.0 on Sun JDK 1.6.0_18 when I try to use XStream. It happens only very rarely.&lt;/p&gt;

&lt;p&gt;java.lang.LinkageError: loader (instance of  org/codehaus/groovy/tools/RootLoader): attempted  duplicate class definition for name: &quot;com/thoughtworks/xstream/converters/extended/SubjectConverter&quot;&lt;br/&gt;
	at java.lang.ClassLoader.defineClass1(Native Method)&lt;br/&gt;
	at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632)&lt;br/&gt;
	at java.lang.ClassLoader.defineClass(ClassLoader.java:616)&lt;br/&gt;
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:141)&lt;br/&gt;
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:283)&lt;br/&gt;
	at java.net.URLClassLoader.access$000(URLClassLoader.java:58)&lt;br/&gt;
	at java.net.URLClassLoader$1.run(URLClassLoader.java:197)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)&lt;br/&gt;
	at org.codehaus.groovy.tools.RootLoader.oldFindClass(RootLoader.java:152)&lt;br/&gt;
	at org.codehaus.groovy.tools.RootLoader.loadClass(RootLoader.java:124)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
	at com.thoughtworks.xstream.core.util.CompositeClassLoader.loadClass(CompositeClassLoader.java:69)&lt;br/&gt;
	at java.lang.Class.forName0(Native Method)&lt;br/&gt;
	at java.lang.Class.forName(Class.java:247)&lt;br/&gt;
	at com.thoughtworks.xstream.XStream.dynamicallyRegisterConverter(XStream.java:723)&lt;br/&gt;
	at com.thoughtworks.xstream.XStream.setupConverters(XStream.java:672)&lt;br/&gt;
	at com.thoughtworks.xstream.XStream.&amp;lt;init&amp;gt;(XStream.java:445)&lt;br/&gt;
	at com.thoughtworks.xstream.XStream.&amp;lt;init&amp;gt;(XStream.java:385)&lt;br/&gt;
	at com.thoughtworks.xstream.XStream.&amp;lt;init&amp;gt;(XStream.java:323)&lt;/p&gt;</comment>
                            <comment id="14469608" author="blackdrag" created="Mon, 7 Jun 2010 15:41:48 +0000"  >&lt;p&gt;the most easy solution for this kind of problem is to remove the offending jar delivered by Groovy and located in the lib directory of the distribution. RootLoader does normally not load other jars. Checking the loader configuration would help to verify that RootLoader is not instructed to do so of course. &lt;/p&gt;</comment>
                            <comment id="14469586" author="rdfrederiksen" created="Wed, 16 Jun 2010 13:25:51 +0000"  >&lt;p&gt;Thanks Jochen, I gave this a try and it didn&apos;t appear to work. Looking at a few other class loaders it appears that their &quot;loadClass&quot; methods are typically synchronized while org.codehaus.groovy.tools.RootLoader&apos;s isn&apos;t (at least in 1.7.0). I&apos;m wondering if this might be the problem. I&apos;ve got few threads that might be trying to load a new class nearly simultaneously. Looking at the call stack it might also be a problem with XStream class loader.&lt;/p&gt;</comment>
                            <comment id="14469655" author="blackdrag" created="Thu, 17 Jun 2010 10:26:22 +0000"  >&lt;p&gt;if all calls are like the one you have shown, then there cannot be a synchronization problem, since java.lang.ClassLoader.loadClass(ClassLoader.java:248) uses synchronization. We may hvae to rethink the usage of RootLoader a bit, because in java7 ClassLoader#loadClass is by default no longer synchronized. Anyway... I suggested having the jar removed from the lib directory, because that is what is usually laoded by RootLoader and if there is no such class, RootLoader will not load it, thus avoiding to load it. Now the question is, where is that class coming from? It doesn&apos;t have to be a synchronization issue in general. It is just that RootLoader is essentially breaking some class loader constraints and that sometimes causes problems. Anyway, there must be a JCE Blowfish provider class in the class path of RootLoader othererwise it couldn&apos;t load it. Could you executed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;println &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;rootLoader.getURLs()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and tell me the output? One of the jars listed there must contain the blowfish provider class and needs to be removed from the classpath&lt;/p&gt;</comment>
                            <comment id="14469987" author="mrsqueezles" created="Thu, 19 Aug 2010 09:58:34 +0000"  >&lt;p&gt;I&apos;m experiencing this problem and it does appear to be thread-related even if it isn&apos;t a synchronization issue.  I&apos;m running an multi-threaded app.  Two threads cause the same class to be loaded.  About 30% of the time, one thread fails.  About 30% of the time, the other fails.  About 30% of the time, everything works (doesn&apos;t add up to 100, I know &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;

&lt;p&gt;This is the error.&lt;/p&gt;

&lt;p&gt;java.lang.LinkageError: loader (instance of  org/codehaus/groovy/tools/RootLoader): attempted  duplicate class definition for name: &quot;org/mozilla/javascript/optimizer/OptRuntime&quot;&lt;/p&gt;

&lt;p&gt;println this.class.rootLoader.getURLs() says that rootLoader is not a property.&lt;/p&gt;</comment>
                            <comment id="14470046" author="mrsqueezles" created="Thu, 19 Aug 2010 10:03:23 +0000"  >&lt;p&gt;OK.  This is not a solution to my problem, but I added this at the very beginning of my app and it works reliably now.  The class is there and can be loaded, but something in RootLoader doesn&apos;t seem to like when multiple threads try to load it at once.&lt;/p&gt;

&lt;p&gt;Class.forName(&quot;org.mozilla.javascript.optimizer.OptRuntime&quot;)&lt;/p&gt;</comment>
                            <comment id="14470161" author="bob.swift" created="Sat, 25 Sep 2010 11:34:32 +0000"  >&lt;p&gt;I get similar errors occasionally when kicking off multiple threads each of which does the same thing (with different parameters). In my case each threads is using a unique instance of a class that creates and accessing classes from jars brought in using grapes with @GrabConfig(systemClassLoader=true) in the main script. &lt;b&gt;Groovy Version: 1.7.1 JVM: 1.6.0_20&lt;/b&gt; &lt;/p&gt;</comment>
                            <comment id="14470305" author="dgalichet" created="Mon, 22 Nov 2010 11:41:27 +0000"  >&lt;p&gt;I&apos;ve got a similar error using HttpBuilder in a multithreaded environment.&lt;br/&gt;
HttpBuilder dependency is resolved using Grapes and the LinkageError appears with LogFactoryImpl probably because HttpBuilder have a transitive dependency on commons-logging that is also available in the lib directory of groovy.&lt;br/&gt;
If I remove the commons-logging jar from groovy install directory, the problem doesn&apos;t appear anymore.&lt;br/&gt;
I don&apos;t know if it could help : the script that I&apos;ve written create a thread pool that performs some http request on my server. The LinkageError appear systematically at the end of the script irrespective of the number of request that I process (10 or 10000 will make the problem appear during the few last requests)&lt;/p&gt;</comment>
                            <comment id="14471693" author="ddimitrop" created="Mon, 22 Aug 2011 19:07:04 +0000"  >&lt;p&gt;I am also getting this regularly.&lt;/p&gt;

&lt;p&gt;The following small script gives this error about 20 - 30% when I am running it with&lt;/p&gt;

&lt;p&gt;groovy-1.8.1 and JVM Java HotSpot &quot;1.6.0_21&quot;&lt;/p&gt;


&lt;p&gt;List&amp;lt;Thread&amp;gt; threads=[];&lt;br/&gt;
int jobs=300;&lt;br/&gt;
String url = &quot;This is ${who}&quot;&lt;br/&gt;
Map who=&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;who&amp;#39;:&amp;#39;me&amp;#39;&amp;#93;&lt;/span&gt;;&lt;/p&gt;

&lt;p&gt;for(int i in 0..&amp;lt;jobs) {&lt;br/&gt;
      threads.add(new Thread(&lt;/p&gt;
{
           new SimpleTemplateEngine().createTemplate(url).make(who).toString()
      }
&lt;p&gt;));&lt;br/&gt;
     threads&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start()&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;for(int i in 0..&amp;lt;jobs) {&lt;br/&gt;
     try &lt;/p&gt;
{
            threads[i].join(1000*60*10);
     }
&lt;p&gt; catch (InterruptedException e) {}&lt;br/&gt;
}&lt;/p&gt;




&lt;p&gt;Exception in thread &quot;Thread-7&quot; org.codehaus.groovy.runtime.InvokerInvocationException: java.lang.LinkageError: loader (instance of  org/codehaus/groovy/tools/RootLoader): attempted  duplicate class definition for name: &quot;org/codehaus/groovy/runtime/GStringImpl&quot;&lt;br/&gt;
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:97)&lt;br/&gt;
	at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:233)&lt;br/&gt;
	at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:272)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:883)&lt;br/&gt;
	at groovy.lang.Closure.call(Closure.java:410)&lt;br/&gt;
	at groovy.lang.Closure.call(Closure.java:404)&lt;br/&gt;
	at groovy.lang.Closure.run(Closure.java:488)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.lang.LinkageError: loader (instance of  org/codehaus/groovy/tools/RootLoader): attempted  duplicate class definition for name: &quot;org/codehaus/groovy/runtime/GStringImpl&quot;&lt;br/&gt;
	at java.lang.ClassLoader.defineClass1(Native Method)&lt;br/&gt;
	at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632)&lt;br/&gt;
	at java.lang.ClassLoader.defineClass(ClassLoader.java:616)&lt;br/&gt;
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:141)&lt;br/&gt;
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:283)&lt;br/&gt;
	at java.net.URLClassLoader.access$000(URLClassLoader.java:58)&lt;br/&gt;
	at java.net.URLClassLoader$1.run(URLClassLoader.java:197)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)&lt;br/&gt;
	at org.codehaus.groovy.tools.RootLoader.oldFindClass(RootLoader.java:152)&lt;br/&gt;
	at org.codehaus.groovy.tools.RootLoader.loadClass(RootLoader.java:124)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:296)&lt;br/&gt;
	at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:696)&lt;br/&gt;
	at groovy.lang.GroovyClassLoader$InnerLoader.loadClass(GroovyClassLoader.java:449)&lt;br/&gt;
	at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:793)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:248)&lt;br/&gt;
	at SimpleTemplateScript16.run(SimpleTemplateScript16.groovy:2)&lt;br/&gt;
	at groovy.text.SimpleTemplateEngine$SimpleTemplate$1.writeTo(SimpleTemplateEngine.java:165)&lt;br/&gt;
	at groovy.text.SimpleTemplateEngine$SimpleTemplate$1.toString(SimpleTemplateEngine.java:177)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.PojoMetaMethodSite$PojoCachedMethodSiteNoUnwrapNoCoerce.invoke(PojoMetaMethodSite.java:230)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.PojoMetaMethodSite.call(PojoMetaMethodSite.java:53)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.CallSiteArray.defaultCall(CallSiteArray.java:42)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:108)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:112)&lt;br/&gt;
	at linkErrorExample$_run_closure1.doCall(linkErrorExample.groovy:10)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:90)&lt;br/&gt;
	at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:233)&lt;br/&gt;
	at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:272)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:883)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.PogoMetaClassSite.callCurrent(PogoMetaClassSite.java:66)&lt;br/&gt;
	at org.codehaus.groovy.runtime.callsite.AbstractCallSite.callCurrent(AbstractCallSite.java:141)&lt;br/&gt;
	at linkErrorExample$_run_closure1.doCall(linkErrorExample.groovy)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:90)&lt;br/&gt;
	... 7 more&lt;/p&gt;
</comment>
                            <comment id="14471753" author="ddimitrop" created="Wed, 31 Aug 2011 02:57:24 +0000"  >&lt;p&gt;Perhaps I am missing something but I had a look at the code and the jdk6 implementations of ClassLoader and URLClassLoader and &lt;br/&gt;
I believe that Rich is right.&lt;/p&gt;

&lt;p&gt;URLClassLoader.findClass (called by oldFindClass) is not syncrhonized and I guess the assumption is that it should be called only from&lt;br/&gt;
inside a synchronized context (ClassLoader.loadClass).&lt;/p&gt;

&lt;p&gt;If you look at the stacks, it is the RootLoader.oldFindClass -&amp;gt; URLClassLoader.findClass that blows up.&lt;/p&gt;

&lt;p&gt;Two threads that would try to load the same class at almost the same time, since RootLoader.loadClass is not syncronized,&lt;br/&gt;
could both get null if they reached  RootLoader.java line 119 &lt;br/&gt;
        Class c = this.findLoadedClass(name);&lt;/p&gt;

&lt;p&gt;at almost the same time (before one of them had managed to run the oldFindClass or loadClass below)&lt;/p&gt;

&lt;p&gt;and both get inside -  RootLoader.oldFindClass -&amp;gt; URLClassLoader.findClass -&amp;gt; ... -&amp;gt; JVM defineClass1 for the same&lt;br/&gt;
class.&lt;br/&gt;
I guess this throws the LinkageError.&lt;/p&gt;

&lt;p&gt;Am I missing something?&lt;/p&gt;

&lt;p&gt;I would add syncrhonized in RootLoader.loadClass but I don&apos;t know if this would cause more deadlocks since as far as I understand groovy&lt;br/&gt;
uses a non-traditional class loading mechanism.&lt;/p&gt;

&lt;p&gt;For convenience:&lt;br/&gt;
&lt;a href=&quot;http://www.java2s.com/Open-Source/Java-Document/6.0-JDK-Core/lang/java/lang/ClassLoader.java.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.java2s.com/Open-Source/Java-Document/6.0-JDK-Core/lang/java/lang/ClassLoader.java.htm&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://www.java2s.com/Open-Source/Java-Document/6.0-JDK-Core/net/java/net/URLClassLoader.java.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.java2s.com/Open-Source/Java-Document/6.0-JDK-Core/net/java/net/URLClassLoader.java.htm&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://git.codehaus.org/gitweb.cgi?p=groovy-git.git;a=blob;f=src/main/org/codehaus/groovy/tools/RootLoader.java;h=ec391c06dc05adba66384842eb6fbad455eb186a;hb=master&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git.codehaus.org/gitweb.cgi?p=groovy-git.git;a=blob;f=src/main/org/codehaus/groovy/tools/RootLoader.java;h=ec391c06dc05adba66384842eb6fbad455eb186a;hb=master&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14471659" author="blackdrag" created="Wed, 31 Aug 2011 05:17:15 +0000"  >&lt;p&gt;could you try putting a synchronized on loadClass and confirm it solves the issue... I fully expect so, but I would like to have confirmation if possible&lt;/p&gt;</comment>
                            <comment id="14471645" author="ddimitrop" created="Thu, 1 Sep 2011 17:10:59 +0000"  >&lt;p&gt;Yes I can confirm that making RootLoader.loadClass syncrhonized seems to solve the issue.&lt;/p&gt;

&lt;p&gt;Of course its a non-deterministic issue but:&lt;/p&gt;

&lt;p&gt;I run the script above without the &quot;synchronized&quot; 50 times and I was getting LinkageError&apos;s in 5-10 of the runs.&lt;/p&gt;

&lt;p&gt;I made the method synchronized, recompiled and I am not getting any errors (when I did the same 50 runs a couple of times).&lt;/p&gt;

&lt;p&gt;I switched back (removed the synchronized) and recompiled and I am getting the errors again in the same rate.&lt;/p&gt;


&lt;p&gt;What I don&apos;t know is, if this change will make deadlocking during class-loading more common, (I believe I have seen this &lt;br/&gt;
happening too, even with groovy 1.8.2)&lt;/p&gt;

&lt;p&gt;Anyway I will try to investigate deadlocking further, if I see it again.&lt;/p&gt;

&lt;p&gt;There is a relevant change in java 7 and I was wondering if it applies to the groovy class loader.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://download.oracle.com/javase/7/docs/technotes/guides/lang/cl-mt.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://download.oracle.com/javase/7/docs/technotes/guides/lang/cl-mt.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14471695" author="blackdrag" created="Thu, 1 Sep 2011 17:28:06 +0000"  >&lt;p&gt;your link more or less describes why there are sometimes deadlocks in the interplay between GroovyClassLoader and InnerLoader. But while RootLoader is also not following the usual classloading patterns, it does not interact with a parallel loader, it is hierarchical, only it checks for classes first by its own. I can&apos;t be fully sure that there won&apos;t be a deadlock problem, but I think it the risk is low. I will make the change tomorrow&lt;/p&gt;</comment>
                            <comment id="14471732" author="blackdrag" created="Sun, 4 Sep 2011 14:36:17 +0000"  >&lt;p&gt;I made the change as suggested here: a6515c5cd89f064b66d683e03258651c3cad586a&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 12 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cf67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>