<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:17:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4492] Bug in groovy.util.GroovyScriptEngine isSourceNewer() results in gratuitous recompilations and lost of static state in groovlets</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4492</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;isSourceNewer() method in groovy.util.GroovyScriptEngine does evaluate script sources for recompilation (it will return true) in cases where &apos;nextPossibleRecompilationTime &amp;gt;= lastMod&apos;. This is wrong and results in gratuitous recompilations of scripts.&lt;/p&gt;

&lt;p&gt;An ugly side effect of this bug is, that groovlet state (static objects kept in a static class) is being lost between incoming requests, due to gratuitous recompilation and subsequent restart of groovlets.&lt;/p&gt;

&lt;p&gt;The attached patch fixes the issue.&lt;/p&gt;</description>
                <environment>Bug is independent of OS and JVM. I&amp;#39;m running Ubuntu 10.10 with OpenJDK 1.6.0_18.</environment>
        <key id="12812602">GROOVY-4492</key>
            <summary>Bug in groovy.util.GroovyScriptEngine isSourceNewer() results in gratuitous recompilations and lost of static state in groovlets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guillaume">Guillaume Sauthier</assignee>
                                    <reporter username="timur">Timur Tleukenov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Oct 2010 07:33:58 +0000</created>
                <updated>Wed, 15 Dec 2010 16:57:01 +0000</updated>
                            <resolved>Fri, 29 Oct 2010 01:47:48 +0000</resolved>
                                    <version>1.7.5</version>
                                    <fixVersion>1.7.6</fixVersion>
                    <fixVersion>1.8-beta-3</fixVersion>
                                    <component>Groovlet / GSP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14470388" author="guillaume" created="Thu, 28 Oct 2010 10:46:56 +0000"  >&lt;p&gt;Running the two related GroovyScriptEngine (GSE for short) tests make one fail.&lt;br/&gt;
You can try running them with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ant -DtestCase=groovy.util.GroovyScriptEngineTest test
ant -DtestCase=groovy.util.GroovyScriptEngineReloadingTest test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That&apos;s GroovyScriptEngineTest which is failing here with your patch.&lt;br/&gt;
Any idea why the test is failing?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    [junit] Testcase: testReloadingInterval(groovy.util.GroovyScriptEngineTest):	FAILED
    [junit] &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; gse.run(scriptName, binding) == 12
    [junit]        |   |   |           |        |
    [junit]        |   1   |           |        &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
    [junit]        |       |           groovy.lang.Binding@23b17d49
    [junit]        |       gse4241425475617288650.groovy
    [junit]        groovy.util.GroovyScriptEngine@599855ed
    [junit] junit.framework.AssertionFailedError: &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; gse.run(scriptName, binding) == 12
    [junit]        |   |   |           |        |
    [junit]        |   1   |           |        &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
    [junit]        |       |           groovy.lang.Binding@23b17d49
    [junit]        |       gse4241425475617288650.groovy
    [junit]        groovy.util.GroovyScriptEngine@599855ed
    [junit] 	at org.codehaus.groovy.runtime.InvokerHelper.assertFailed(InvokerHelper.java:386)
    [junit] 	at org.codehaus.groovy.runtime.ScriptBytecodeAdapter.assertFailed(ScriptBytecodeAdapter.java:658)
    [junit] 	at groovy.util.GroovyScriptEngineTest.testReloadingInterval(GroovyScriptEngineTest.groovy:245)
    [junit] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Perhaps in some cases the logic was reloading the class too often... but in this case, the reloading should have happened, but has not with the patch applied.&lt;/p&gt;</comment>
                            <comment id="14470332" author="timur" created="Thu, 28 Oct 2010 15:53:19 +0000"  >&lt;p&gt;Well well well.. this is a completely different bug. The issue here is that URLConnection.getLastModified() truncates up to 999 ms from the time value when the file was originally modified. This is how it works: &lt;/p&gt;

&lt;p&gt;  Date.parse(getHeaderField(&quot;last-modified&quot;));&lt;/p&gt;

&lt;p&gt;In other words: getLastModified() works based on seconds, not ms. &lt;/p&gt;

&lt;p&gt;What the test case is falling over: Because of the issue with getLastModified(), the value of lastMod may appear up to 999 ms OLDER than it really is. And so, it may look as if nextPossibleRecompilationTime is not yet due. While in reallity it is! &lt;/p&gt;

&lt;p&gt;To fix this, I propose to adjust the value of lastMod in the following way:&lt;/p&gt;

&lt;p&gt;            lastMod = ((lastMod /1000)+1)*1000-1;&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a 2nd patch relative to my other patch.&lt;/p&gt;</comment>
                            <comment id="14470264" author="timur" created="Thu, 28 Oct 2010 18:50:02 +0000"  >&lt;p&gt;You will notice that there is still an issue with the code. This is really a separate problem, that is preventing patchfile1 + patchfile2 from working in some cases.&lt;/p&gt;

&lt;p&gt;This remaining 3rd issue is that we want to accept re-compilation of a script only&lt;/p&gt;

&lt;p&gt;if(depEntry.lastModified &amp;lt; lastMod)&lt;/p&gt;

&lt;p&gt;(that is: if the cached version is older than the script in the filesystem)&lt;/p&gt;

&lt;p&gt;and not&lt;/p&gt;

&lt;p&gt;if(nextPossibleRecompilationTime &amp;lt; lastMod)&lt;/p&gt;

&lt;p&gt;I am attaching patchfile3.txt to solve this. I&apos;m also attaching a combined patchfile-all3.txt.&lt;br/&gt;
Thank you.&lt;/p&gt;</comment>
                            <comment id="14470400" author="guillaume" created="Fri, 29 Oct 2010 01:30:05 +0000"  >&lt;p&gt;Well spotted for the last modified stuff! I&apos;ve spent a moment on the logic of this method, but never really thought about how the last modification was really computed, which makes the granularity up to a second. Interesting.&lt;br/&gt;
The &quot;all&quot; patch works fine for me, thanks a lot.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722748" name="patchfile-all3.txt" size="967" author="timur" created="Thu, 28 Oct 2010 18:50:02 +0000"/>
                            <attachment id="12722696" name="patchfile.txt" size="497" author="timur" created="Thu, 28 Oct 2010 07:33:59 +0000"/>
                            <attachment id="12722459" name="patchfile2.txt" size="566" author="timur" created="Thu, 28 Oct 2010 15:54:19 +0000"/>
                            <attachment id="12722747" name="patchfile3.txt" size="603" author="timur" created="Thu, 28 Oct 2010 18:50:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cp4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>