<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:15:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4051] Power assert doesn&apos;t pretty-print groovy.lang.Reference content inside a closure inside an anonymous class</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4051</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def y = [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;]
def o = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;() {
  def foo() {
    def c = {
      &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; y[0]
    }
    c()
  }
}
o.foo()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;gives&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caught: Assertion failed: 

&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; y[0]
       ||
       |&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
       groovy.lang.Reference@99d12cc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12815045">GROOVY-4051</key>
            <summary>Power assert doesn&apos;t pretty-print groovy.lang.Reference content inside a closure inside an anonymous class</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="gromopetr">Peter Gromov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Feb 2010 13:29:39 +0000</created>
                <updated>Wed, 17 Feb 2010 12:04:14 +0000</updated>
                            <resolved>Wed, 17 Feb 2010 12:04:13 +0000</resolved>
                                    <version>1.7.0</version>
                                    <fixVersion>1.7.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14468927" author="roshandawrani" created="Fri, 12 Feb 2010 14:13:00 +0000"  >&lt;p&gt;I think it has nothing to do with power assert feature&apos;s implementation as such. The issue is there because of the way closure classes are rendered when they are defined inside inner classes, as in the reported case.&lt;/p&gt;

&lt;p&gt;Unlike regular closures, in such closure classes, Reference fields are not being defined. In a normal closure, &quot;y&quot; would be a reference field and loading that field at runtime ensures that if it is a holder (Reference ) field, it calls get() on it to return the value it is holding.&lt;/p&gt;

&lt;p&gt;In the erroneous closure classes, since &quot;y&quot; is not defined as a holder field, the call at run time goes through CallSite.callGroovyObjectGetProperty(), and here it is not checked whether the value returned is a holder or not, so it simply returns the Reference object, resulting in the error reported.&lt;/p&gt;</comment>
                            <comment id="14468810" author="roshandawrani" created="Fri, 12 Feb 2010 14:50:13 +0000"  >&lt;p&gt;Put another way, the provided code becomes equivalent to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Script {
    List y
    &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;AIC {
        Reference y
        &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Closure$n {
            def doCall() {
                &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; y[0] &lt;span class=&quot;code-comment&quot;&gt;// getProperty(y) = owner.y == AIC.y (Reference)
&lt;/span&gt;            }
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where getProperty() logic does not do the holder/Reference check, so simply returns the Reference field from AIC class.&lt;/p&gt;</comment>
                            <comment id="14468911" author="pniederw" created="Fri, 12 Feb 2010 15:20:08 +0000"  >&lt;p&gt;Are you saying that this is a bug in the Groovy compiler? Otherwise, Reference will need special handling when rendering power assertions (provided we want to fix this issue). It&apos;s just one line of code.&lt;/p&gt;</comment>
                            <comment id="14468753" author="roshandawrani" created="Fri, 12 Feb 2010 15:34:46 +0000"  >&lt;p&gt;Yes, I think it is a bug in the groovy compiler - in handling getProperty() in cases such as the one reported here&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def y = [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;]
def o = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;() {
  def foo() {
    def c = {
      println y &lt;span class=&quot;code-comment&quot;&gt;/* prints groovy.lang.Reference@.... */&lt;/span&gt;
    }
    c()
  }
}
o.foo()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The use of Reference is supposed to be behind-the-scenes in closures, but the output above shows that it is spilling out unhandled.&lt;/p&gt;

&lt;p&gt;When the above is corrected, power-assert-pretty-print issue will go away too.&lt;/p&gt;</comment>
                            <comment id="14468895" author="pniederw" created="Fri, 12 Feb 2010 15:38:18 +0000"  >&lt;p&gt;OK, so I won&apos;t make any changes to power assert code. Where are we going to track the compiler bug?&lt;/p&gt;</comment>
                            <comment id="14468883" author="roshandawrani" created="Fri, 12 Feb 2010 15:39:47 +0000"  >&lt;p&gt;And I don&apos;t think 1-line forced-handling of Reference values(in ValueRecorder?) will be correct.&lt;/p&gt;

&lt;p&gt;What if I then explicitly wrote&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Reference ref = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Reference(&lt;span class=&quot;code-quote&quot;&gt;&quot;xx&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; ref == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead of correctly getting&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caught: Assertion failed: 

assert ref == null
       |   |
       |   false
       groovy.lang.Reference@19bfb30
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will start getting&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caught: Assertion failed: 

assert ref == null
       |   |
       |   false
       &quot;xx&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Right?&lt;/p&gt;</comment>
                            <comment id="14468852" author="roshandawrani" created="Fri, 12 Feb 2010 15:42:53 +0000"  >&lt;p&gt;I think tracing through that bug in compiler code will need some guidance from Jochen. I will need, at least. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I am waiting for his comments to get some hint on where to start looking.&lt;/p&gt;</comment>
                            <comment id="14468868" author="pniederw" created="Fri, 12 Feb 2010 15:46:06 +0000"  >&lt;p&gt;&amp;gt; in ValueRecorder?&lt;br/&gt;
I had planned to add that line to AssertionRenderer.valueToString().&lt;/p&gt;

&lt;p&gt;&amp;gt; Right?&lt;br/&gt;
Yeah but I think this would have been acceptable because such a test is very unlikely to exist outside the Groovy code base.&lt;/p&gt;</comment>
                            <comment id="14468853" author="roshandawrani" created="Fri, 12 Feb 2010 15:49:32 +0000"  >&lt;p&gt;&amp;gt;&amp;gt; Right?&lt;br/&gt;
  &amp;gt; Yeah but I think this would have been acceptable because such a test is very unlikely to exist outside the Groovy code base.&lt;/p&gt;

&lt;p&gt;It&apos;s your choice. Because there is bigger issue involved there (property access in such scenarios), I didn&apos;t want to shortcut the fix into power assert code.&lt;/p&gt;</comment>
                            <comment id="14468897" author="pniederw" created="Fri, 12 Feb 2010 15:52:39 +0000"  >&lt;p&gt;I&apos;m all for fixing the real cause, so I won&apos;t make a change to the power assert code for now. Are you going to create a separate issue for the compiler bug?&lt;/p&gt;</comment>
                            <comment id="14468754" author="roshandawrani" created="Fri, 12 Feb 2010 16:00:32 +0000"  >&lt;p&gt;Since there is only 1 underlying issue here anyway, I had not planned to create another issue. &lt;/p&gt;

&lt;p&gt;You think it is better to get the pretty-print issue out of the way now with that 1-line fix and then handle the compiler bug separately?&lt;/p&gt;

&lt;p&gt;I am in pause mode actually till I hear from Jochen about this. May be he can clearly see where the issue is and then we can rightaway go away for the real fix instead of assert code workaround in the meantime &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14468796" author="pniederw" created="Fri, 12 Feb 2010 16:03:20 +0000"  >&lt;p&gt;We should wait until Jochen weighs in. I don&apos;t consider the assert issue high priority.&lt;/p&gt;</comment>
                            <comment id="14468945" author="blackdrag" created="Fri, 12 Feb 2010 18:28:23 +0000"  >&lt;p&gt;The implementation idea in ACG for power asserts was that when ever we get a value and we are in an assert, we save that value in the value recorder. &lt;/p&gt;

&lt;p&gt;Now I thought I did handle the Reference stuff there already, but it seems I am wrong. Of course we need to save the referenced value, not the reference itself... &lt;/p&gt;

&lt;p&gt;Now in case of a VariableExpression the code I have should work alright. The y in the y&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; should be one... I modified the code to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def y = 1
def o = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;() {
  def foo() {
    def c = {
      &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; y == 1
      1
    }
    c()
  }
}
o.foo()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This assert should not fail, but it does! A &quot;println y&quot; shows that it prints a Reference. So I think the problem is actually not in ValueRecorder, or the power assert integration. I think it is a general compiler bug with annonymous inner classes. Probably the VariableExpression should have been marked for using a Reference but does not get marked. I am sure if we fix that, then the power assert will give the right message text automatically. What makes me wonder is that y&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; still seems to print null in the original example. This implies the marking is there... but somehow lost or ignored.&lt;/p&gt;

&lt;p&gt;Does this help you a little Roshan?&lt;/p&gt;</comment>
                            <comment id="14468811" author="blackdrag" created="Fri, 12 Feb 2010 18:29:28 +0000"  >&lt;p&gt;Ah yes... since this internal Reference usage should not be visible we should maybe consider this being a blocker for 1.7.1&lt;/p&gt;</comment>
                            <comment id="14468881" author="roshandawrani" created="Sat, 13 Feb 2010 00:16:37 +0000"  >&lt;p&gt;Raising the priority to Blocker for 1.7.1.&lt;/p&gt;</comment>
                            <comment id="14468932" author="blackdrag" created="Wed, 17 Feb 2010 12:04:14 +0000"  >&lt;p&gt;fixed now&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bznb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>