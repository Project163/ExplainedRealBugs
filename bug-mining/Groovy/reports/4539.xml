<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:20:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10763] ClassNode setSuperClass and setInterfaces should update usingGenerics</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10763</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have an annotation that, if an annotated class has no &lt;tt&gt;extends&lt;/tt&gt;, should make it extend &lt;tt&gt;Resource&amp;lt;A&amp;gt;&lt;/tt&gt;, where &lt;tt&gt;A&lt;/tt&gt; is determined by Logic. I attempted to create the &lt;tt&gt;ClassNode&lt;/tt&gt; representing the intended base class and assign it as the derived class&apos;s &lt;tt&gt;superClass&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
println resource.superClass  &lt;span class=&quot;code-comment&quot;&gt;// java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; sc = makeClassSafeWithGenerics(TYPE_RESOURCE, attr)
println sc  &lt;span class=&quot;code-comment&quot;&gt;// Resource&amp;lt;com.example.Derived$Attributes&amp;gt; -&amp;gt; Resource&amp;lt;A&amp;gt;
&lt;/span&gt;println sc.genericsTypes  &lt;span class=&quot;code-comment&quot;&gt;// [com.example.Derived$Attributes]
&lt;/span&gt;cn.superClass = sc

&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; sc2 = cn.superClass
println sc2            &lt;span class=&quot;code-comment&quot;&gt;// Resource&amp;lt;A&amp;gt;
&lt;/span&gt;println cn.@superClass &lt;span class=&quot;code-comment&quot;&gt;// Resource&amp;lt;com.example.Derived$Attributes&amp;gt; -&amp;gt; Resource&amp;lt;A&amp;gt;
&lt;/span&gt;println sc2 == sc  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, but compares only the erasure
&lt;/span&gt;println sc2 === sc &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The compiler then proceeds to write out a &lt;tt&gt;.class&lt;/tt&gt; file extending the raw &lt;tt&gt;Resource&lt;/tt&gt; type. The compiler writes the correct &lt;tt&gt;Resource&amp;lt;Attributes&amp;gt;&lt;/tt&gt; if it is typed out inline in the input file.&lt;/p&gt;

&lt;p&gt;I&apos;ve confirmed that the &lt;tt&gt;ClassNode TYPE_RESOURCE&lt;/tt&gt; is not a redirect or a genericsPlaceholder, so the &lt;tt&gt;superClass&lt;/tt&gt; assignment appears to be a direct field assignment (once &lt;tt&gt;redirect()&lt;/tt&gt; returns &lt;tt&gt;this&lt;/tt&gt;), and &lt;tt&gt;getUnresolvedSuperClass&lt;/tt&gt; appears to read the field directly (&lt;tt&gt;lazyInitDone&lt;/tt&gt; is already true), but using &lt;tt&gt;.@superClass&lt;/tt&gt; returns the generic copy and &lt;tt&gt;.superClass&lt;/tt&gt; (which is used by the rest of the compilation process) the raw copy.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Update&lt;/b&gt;: &lt;tt&gt;cn.@superClass.redirectNode&lt;/tt&gt; is true, and &lt;tt&gt;getSuperClass&lt;/tt&gt; unwraps redirects (&lt;tt&gt;ClassNode:1040&lt;/tt&gt; in 4.0.5). This appears to be a logic error precisely because of this discard-generics-on-read effect.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Update 2&lt;/b&gt;: I see the same &quot;superclass is a redirect, and &lt;tt&gt;getSuperClass&lt;/tt&gt; returns a raw type&quot; on a class where the generics are specified in Groovy source code, but this class has the correct generics written into the bytecode where the ASTT-modified class does not. I cannot find any way to distinguish between the &lt;tt&gt;ClassNode&lt;/tt&gt;s for the superclasses in these cases, but the output differs. (In case it&apos;s relevant at all, constructing a node for an interface type that has generic parameters and adding it to a class writes the type parameters into the bytecode; it&apos;s only the superclass that gets erased.)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Update 3&lt;/b&gt;: In the case of a resource subclass that has type parameters defined in Groovy source, the field &lt;tt&gt;usesGenerics&lt;/tt&gt; is set to true, presumably via the check at &lt;tt&gt;ClassNode:345&lt;/tt&gt;. I have tried manually setting &lt;tt&gt;cn.usingGenerics = true&lt;/tt&gt;, but that&apos;s triggering a (spurious?) &quot;transform used a generics containing... directly&quot; error downstream. It seems like a bug that the constructor sets &lt;tt&gt;usesGenerics&lt;/tt&gt; if the superclass uses generics but that &lt;tt&gt;setSuperClass&lt;/tt&gt; does not.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Update 4&lt;/b&gt;: Adding the explicit &lt;tt&gt;cn.usingGenerics = true&lt;/tt&gt; fixes the missing type parameters in the bytecode, at the cost of having to make spurious calls to &lt;tt&gt;.plainNodeReference&lt;/tt&gt; later. It appears that the compiler is checking &lt;tt&gt;usingGenerics&lt;/tt&gt; on class nodes when writing the &lt;tt&gt;extends&lt;/tt&gt; part of the bytecode but not &lt;tt&gt;implements&lt;/tt&gt;. There seem to be two logical bugs here: If the superclass has generic types, it shouldn&apos;t matter what the flag is on the subclass (write the type parameters as for interfaces), and creating a &lt;tt&gt;ClassNode&lt;/tt&gt; that extends a generic superclass but does not itself have type parameters (e.g., &lt;tt&gt;StringMap extends HashMap&amp;lt;String, String&amp;gt;&lt;/tt&gt;) should not trigger the &quot;you must copy this node to refer to it&quot; check.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13482434">GROOVY-10763</key>
            <summary>ClassNode setSuperClass and setInterfaces should update usingGenerics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="chrylis">Christopher Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Sep 2022 17:15:39 +0000</created>
                <updated>Wed, 23 Aug 2023 09:11:19 +0000</updated>
                            <resolved>Mon, 26 Sep 2022 15:38:52 +0000</resolved>
                                    <version>4.0.5</version>
                                    <fixVersion>5.0.0-alpha-1</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17607380" author="emilles" created="Tue, 20 Sep 2022 19:54:05 +0000"  >&lt;p&gt;ClassNode#isUsingGenerics is used as a quick check to prevent doing expensive AST visitation looking for generics.  If you are updating a primary class node, that is one you intend to create a class file from, you should setUsingGenerics(true) if you add super class, interface, field, method, etc. that makes uses of generics.&lt;/p&gt;

&lt;p&gt;getSuperClass() and getUnresolvedSuperClass() are for accessing the declared superclass and the resolved superclass respectively.  For example &quot;class C extends Optional&amp;lt;String&amp;gt;&quot; will return &quot;Optional&amp;lt;String&amp;gt;&quot; for unresolvedSuperClass and &quot;Optional&amp;lt;T&amp;gt;&quot; (the way Optional is declared) for superClass.&lt;/p&gt;</comment>
                            <comment id="17607383" author="chrylis" created="Tue, 20 Sep 2022 20:08:53 +0000"  >&lt;p&gt;The results of &quot;pass superclass X to the constructor&quot; and &quot;call setSuperClass(X)&quot; should be the same; if the field needs to be updated, then &lt;tt&gt;setSuperClass&lt;/tt&gt; should include the update as part of its logic.&lt;/p&gt;

&lt;p&gt;The documentation and even source code of these methods communicate that the difference in usage is related to compilation stages. I read through them, and nothing suggested to me that the distinction was (or just includes?) &quot;erased and reified&quot;. Is this the &lt;em&gt;intended&lt;/em&gt; distinction between them, or just a historical consequence of how the compiler operates?&lt;/p&gt;</comment>
                            <comment id="17609546" author="emilles" created="Mon, 26 Sep 2022 15:38:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/c5b3a4f7badb6cef592c935bb05f60ad9243f95f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/c5b3a4f7badb6cef592c935bb05f60ad9243f95f&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18pn4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>