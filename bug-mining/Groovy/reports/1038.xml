<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:13:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3711] NPE when using JSR223 implementation under some conditions</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3711</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import java.lang.*
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This causes:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
Caused by: javax.script.ScriptException
	at org.codehaus.groovy.jsr223.GroovyScriptEngineImpl.eval(GroovyScriptEngineImpl.java:306)
	at org.codehaus.groovy.jsr223.GroovyScriptEngineImpl.eval(GroovyScriptEngineImpl.java:113)
	... 92 more
Caused by: java.lang.NullPointerException
	at org.codehaus.groovy.jsr223.GroovyScriptEngineImpl.eval(GroovyScriptEngineImpl.java:253)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reason is that GroovyScriptEngineImpl.getScriptClass() returns null in this case (I tried to understand why but couldn&apos;t).&lt;br/&gt;
Since it&apos;s null the eval() method fails at line 253.&lt;/p&gt;

&lt;p&gt;Note that there was another error hiding this error, this time caused by livetribe, which is now fixed in livetribe 2.0.6. You can see more information here:&lt;br/&gt;
&lt;a href=&quot;http://jira.xwiki.org/jira/browse/XWIKI-4246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jira.xwiki.org/jira/browse/XWIKI-4246&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</description>
                <environment></environment>
        <key id="12814834">GROOVY-3711</key>
            <summary>NPE when using JSR223 implementation under some conditions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="vmassol">Vincent Massol</reporter>
                        <labels>
                    </labels>
                <created>Sat, 29 Aug 2009 02:50:01 +0000</created>
                <updated>Thu, 15 Oct 2009 17:15:32 +0000</updated>
                            <resolved>Sun, 30 Aug 2009 20:13:04 +0000</resolved>
                                    <version>1.6.4</version>
                                    <fixVersion>1.6.5</fixVersion>
                    <fixVersion>1.7-beta-2</fixVersion>
                                    <component>JSR / TCK / GLS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14467563" author="roshandawrani" created="Sat, 29 Aug 2009 04:08:50 +0000"  >&lt;p&gt;I would like to work on it, but I need one clarification:&lt;/p&gt;

&lt;p&gt;NPE can easily be avoided by a check that if GroovyClassLoader.parseClass() returned null, then GroovyScriptEngineImpl can throw javax.script.ScriptException(&quot;script class is null&quot;) or with a more appropriate message.&lt;/p&gt;

&lt;p&gt;My question is whether GroovyClassLoader should fail to generate a class for the script string&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.*
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in the first place. I thought that it would generate a script class even in this case&lt;/p&gt;</comment>
                            <comment id="14467453" author="roshandawrani" created="Sat, 29 Aug 2009 04:16:55 +0000"  >&lt;p&gt;So, unrelated to JSR223, the underlying issue here is that, the following code does not go through&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader().parseClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.*&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If this behavior of GroovyClassLoader is considered correct, then the issue reported can just be solved by putting a null check.&lt;/p&gt;

&lt;p&gt;But if this behavior of GroovyClassLoader is considered incorrect, then there are 2 issues 2 solve here - one with GroovyClassLoader and other the null check in GroovyScriptEngineImpl (for some additional safety).&lt;/p&gt;</comment>
                            <comment id="14467544" author="vmassol" created="Sat, 29 Aug 2009 04:23:06 +0000"  >&lt;p&gt;Roshan,&lt;/p&gt;

&lt;p&gt;Thanks for looking into this. I was also very surprised that the following would not work and I don&apos;t understand why:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;assert new GroovyClassLoader().parseClass(&quot;import java.lang.*&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My take is that this should work just fine but then I&apos;m not a Groovy expert (far from it).&lt;/p&gt;

&lt;p&gt;I pinged Guillaume Laforge to see what he says about it but he&apos;s currently on holiday I believe. &lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

</comment>
                            <comment id="14467604" author="roshandawrani" created="Sat, 29 Aug 2009 04:30:43 +0000"  >&lt;p&gt;Yes, my guess too would have been that groovy compiler would generate a script class in this case.&lt;/p&gt;

&lt;p&gt;I am sure Jochen will soon clarify whether this behavior of GroovyClassLoader is correct or not .&lt;/p&gt;

&lt;p&gt;In the meanwhile I am debugging the groovy compiler to understand the current behavior and see at which point, it is deciding to not generate any class in this scenario.&lt;/p&gt;

&lt;p&gt;Just for my curiosity - even if groovy starts generating a class here, how will it help you? Trying to understand your usage scenario a bit.&lt;/p&gt;</comment>
                            <comment id="14467592" author="vmassol" created="Sat, 29 Aug 2009 04:43:10 +0000"  >&lt;p&gt;This is for the XWiki groovy macro. The user can put anything in it, including stuff that don&apos;t do anything (like just an import for ex). I&apos;d rather that it doesn&apos;t do anything instead of generating an error which will be hard to understand for the user.&lt;/p&gt;

&lt;p&gt;I discovered the pb when trying to debug a groovy script I had in xwiki and I was commenting out code in order to find where the pb was coming from, till for some reason I had only some import left and I got the pb.&lt;/p&gt;

&lt;p&gt;I also have the same problem if there&apos;s only a class definition: The following fails;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;class MyClass
{
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this works:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;class MyClass
{
}

def foo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The error in this case is different:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
Caused by: javax.script.ScriptException: No signature of method: MyClass.main() is applicable for argument types: ([Ljava.lang.String;) values: [[]]
	at org.codehaus.groovy.jsr223.GroovyScriptEngineImpl.eval(GroovyScriptEngineImpl.java:306)
	at org.codehaus.groovy.jsr223.GroovyScriptEngineImpl.eval(GroovyScriptEngineImpl.java:113)
	... 92 more
Caused by: org.codehaus.groovy.runtime.metaclass.MissingMethodExceptionNoStack: No signature of method: MyClass.main() is applicable for argument types: ([Ljava.lang.String;) values: [[]]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14467579" author="roshandawrani" created="Sat, 29 Aug 2009 05:08:18 +0000"  >&lt;p&gt;To understand why&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass {}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;fails to run and &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass {}
def foo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;goes through, you should try to run them separately with groovy first. The error you will get in 1st case will make it much clearer why it failing.&lt;/p&gt;

&lt;p&gt;GroovyScriptEngineImpl().eval() - compiles the script, creates an object of it and tries to run it. &lt;br/&gt;
To run the script, it remains consistent with groovy behavior - it invokes the script object&apos;s run(), which can do 2 things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If script is just a class - as in your 1st case - run method tries to invoke the main() method of the class - this can be seen in your case 1 exception.&lt;/li&gt;
	&lt;li&gt;If script is a just a script(some script statements/methods) or (some classes + some script statements/methods) -&lt;br/&gt;
  then script statements/methods become part of the script class, which gets the run() method, which gets invoked. &lt;br/&gt;
  Any additional class {} result in their own classes but they are not executed by groovy engine.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, your first case is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass {
&lt;span class=&quot;code-comment&quot;&gt;// no main() here, so groovy engine&apos;s run() fails to invoke it.
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and your 2nd case is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass {
}
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Groovy_Generate_Script_Class {
....
def run() { &lt;span class=&quot;code-comment&quot;&gt;// not groovy engine is fine because it gets &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; run() on script object.
&lt;/span&gt;def foo &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; comes from the statements you have outside your class {} blocks in the script you pass
&lt;/span&gt;}
....
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Incidentally, &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3707&quot; title=&quot;I wish i could parse a class using eval function of JSR223&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3707&quot;&gt;&lt;del&gt;GROOVY-3707&lt;/del&gt;&lt;/a&gt; is discussing such things currently. But the discussion there has gone in the loop of how groovy engine &quot;should&quot; behave.&lt;/p&gt;

&lt;p&gt;I am trying to cover here what is happening &quot;currently&quot;.&lt;/p&gt;</comment>
                            <comment id="14467620" author="roshandawrani" created="Sat, 29 Aug 2009 05:45:52 +0000"  >&lt;p&gt;Attaching a patch that allows creation of a class even if just import statements / import package statements are provided in the script.&lt;/p&gt;

&lt;p&gt;The idea here to to find out whether we want to go ahead and allow the generation of classes in such scenarios or not. If we are going ahead with it, static imports (of classes, fields, methods) can also be added. &lt;/p&gt;

&lt;p&gt;I mean, if &quot;import java.lang.*&quot; generates a class, then so should &quot;import static foo.Bar&quot; / &quot;import static foo.Bar.field1&quot; / import static &quot;foo.method1&quot;, right?&lt;/p&gt;</comment>
                            <comment id="14467524" author="vmassol" created="Sat, 29 Aug 2009 06:45:57 +0000"  >&lt;p&gt;Thanks for the explanations Roshan.&lt;/p&gt;
</comment>
                            <comment id="14467636" author="blackdrag" created="Sat, 29 Aug 2009 11:53:44 +0000"  >&lt;p&gt;I think a script with just imports should return null. But I think the patch goes into a wrong direction. I have not looked into it yet, but what if APP would add a &quot;null&quot; as statement if there had been no class and the script body is empty. The advantage of this approach is, that the code in ModuleNode needs no change. und you still get a script. If you don&apos;t do that here, other parts may get a problem with this overspecialized rules in ModuleNode.&lt;/p&gt;</comment>
                            <comment id="14467564" author="roshandawrani" created="Sat, 29 Aug 2009 12:01:55 +0000"  >&lt;p&gt;I can try doing it through APP too - first attempt was to quickly try to fix it where it was deciding not to generate a class with just imports.&lt;/p&gt;

&lt;p&gt;So, what is the call? A script with just imports should generate a class or not?&lt;/p&gt;

&lt;p&gt;Or, do we need a dev-list discussion on it?&lt;/p&gt;</comment>
                            <comment id="14467493" author="roshandawrani" created="Sat, 29 Aug 2009 16:50:17 +0000"  >&lt;p&gt;Not sure if it can be done in APP as there it&apos;s more like streaming of tokens and our special &quot;null&quot; statement add needs to be done after whole of AST has been formed and still no statements / methods / classes have been found in the passed script. I didn&apos;t see anything in APP that would mark the end of processing of all tokens - I could have done it there if it was there.&lt;/p&gt;

&lt;p&gt;So, here is a revised patch, that is, hopefully, not too over specialized:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: src/main/org/codehaus/groovy/ast/ModuleNode.java
===================================================================
--- src/main/org/codehaus/groovy/ast/ModuleNode.java	(revision 17476)
+++ src/main/org/codehaus/groovy/ast/ModuleNode.java	(working copy)
@@ -21,7 +21,9 @@
+import org.codehaus.groovy.ast.stmt.EmptyStatement;
@@ -73,6 +75,9 @@
     }
 
     public List&amp;lt;ClassNode&amp;gt; getClasses() {
+    	if(statementBlock.isEmpty() &amp;amp;&amp;amp; methods.isEmpty() &amp;amp;&amp;amp; classes.isEmpty()) {
+    		statementBlock.addStatement(EmptyStatement.INSTANCE);
+    	}
         if (createClassForStatements &amp;amp;&amp;amp; (!statementBlock.isEmpty() || !methods.isEmpty() || isPackageInfo())) {
             ClassNode mainClass = createStatementsClass();
             createClassForStatements = false;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14467525" author="blackdrag" created="Sat, 29 Aug 2009 18:49:32 +0000"  >&lt;p&gt;what I did mean is that a script&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import x.y.*&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;should be equal to a script&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import x.y.*
null
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So that means that if no classes are generated and the statementBlock is empty A&#220;&#220; will add the ConstantExpression into the StatementBlock. At last that is my idea. ModuleNode#getClasses will then not need a change, because the statementBlock won&apos;t be empty then.&lt;/p&gt;</comment>
                            <comment id="14467606" author="roshandawrani" created="Sun, 30 Aug 2009 01:04:58 +0000"  >&lt;p&gt;I know what change you asked for in &quot;import java.lang.*&quot; script. Even ModuleNode#getClasses() change was achieving the same thing. First call to get classes from the module would have effected that script change.&lt;/p&gt;

&lt;p&gt;Although, now that I have made that very change in APP, I can see that it is better place for it.&lt;/p&gt;

&lt;p&gt;Attaching the APP based patch. 2 tests also needed to be fixed, because compilation of &quot;import static foo.Bar.mooky&quot; / &quot;import static foo.Bar.*&quot; now results in a valid script class node and the GCL should be able to resolve foo.Bar to parse this new class node.&lt;/p&gt;</comment>
                            <comment id="14467637" author="blackdrag" created="Sun, 30 Aug 2009 11:12:38 +0000"  >&lt;p&gt;good that we agree now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I think the patch is ok... maybe the static import tests should be moved to the gls package instead, but that is not urgent.&lt;/p&gt;</comment>
                            <comment id="14467622" author="roshandawrani" created="Sun, 30 Aug 2009 20:13:04 +0000"  >&lt;p&gt;Fixed.&lt;/p&gt;</comment>
                            <comment id="14467589" author="vmassol" created="Mon, 31 Aug 2009 02:10:50 +0000"  >&lt;p&gt;Thanks a lot Roshan&lt;/p&gt;</comment>
                            <comment id="14467456" author="roshandawrani" created="Mon, 31 Aug 2009 02:13:34 +0000"  >&lt;p&gt;My pleasure.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12721388" name="17x_Patch.txt" size="2604" author="roshandawrani" created="Sun, 30 Aug 2009 01:04:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2crrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>