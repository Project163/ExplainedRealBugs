<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:18:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10535] IF condition on empty Collection has different behavior than null Collection</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10535</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I believe this code should print &quot;something&quot; but doesn&apos;t work:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;NotWorkingExample {
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; values = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i in 0..&amp;lt;200_000) {
      printSomethingIfNotEmpty(values)
    }

    &lt;span class=&quot;code-comment&quot;&gt;//never printed but it should
&lt;/span&gt;    values = [&lt;span class=&quot;code-quote&quot;&gt;&apos;A&apos;&lt;/span&gt;]
    printSomethingIfNotEmpty(values)
  }

  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; printSomethingIfNotEmpty(Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; values) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(values) {
      println &lt;span class=&quot;code-quote&quot;&gt;&apos;something&apos;&lt;/span&gt;
    }
  }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This one does print &quot;something&quot; because we pass an empty collection [] instead of null:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ItWorks {
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
      Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; values = []
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i in 0..&amp;lt;200_000) {
        printSomethingIfNotEmpty(values)
      }

    &lt;span class=&quot;code-comment&quot;&gt;//it works because [] was passed in the previous 200k calls
&lt;/span&gt;    values = [&lt;span class=&quot;code-quote&quot;&gt;&apos;A&apos;&lt;/span&gt;]
    printSomethingIfNotEmpty(values)
  }

  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; printSomethingIfNotEmpty(Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; values) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(values) {
      println &lt;span class=&quot;code-quote&quot;&gt;&apos;something&apos;&lt;/span&gt;
    }
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Some optimization is done differently when the condition is skipped too many times. Both classes should output &quot;something&quot; on the last method call.&lt;/p&gt;


&lt;p&gt;Thank you for the support.&lt;/p&gt;</description>
                <environment>Groovy 3.0.10/OpenJDK 17.0.2 - Ubuntu 21.10</environment>
        <key id="13434705">GROOVY-10535</key>
            <summary>IF condition on empty Collection has different behavior than null Collection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="rodolfo.yanke">Rodolfo Yanke</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Mar 2022 00:12:40 +0000</created>
                <updated>Mon, 13 Oct 2025 15:35:33 +0000</updated>
                            <resolved>Tue, 3 May 2022 16:08:51 +0000</resolved>
                                    <version>3.0.10</version>
                                    <fixVersion>3.0.11</fixVersion>
                    <fixVersion>4.0.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17509367" author="paulk" created="Sun, 20 Mar 2022 03:56:45 +0000"  >&lt;p&gt;The first one prints &quot;something&quot; for me when I run it directly in the GroovyConsole.&lt;/p&gt;</comment>
                            <comment id="17509405" author="rodolfo.yanke" created="Sun, 20 Mar 2022 09:16:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt; I&apos;m gonna run few more tests and I get back to you. We got this behavior when running a gradle project directly on intellij and also in a kubernetes pod running on openjdk:17.0.2-jdk. Maybe something with our dependencies &#129300;.&lt;/p&gt;</comment>
                            <comment id="17509406" author="rodolfo.yanke" created="Sun, 20 Mar 2022 09:35:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt; I think now I found what the issue is.&lt;br/&gt;
We have a gradle project with this configuration in our build.gradle file:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
compileGroovy {
    groovyOptions.optimizationOptions.indy = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which leads to this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(values.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;&amp;lt;invokedynamic&amp;gt;(values)) { ..print something } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;If we remove the indy = true from build.gradle we endup with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(DefaultTypeTransformation.booleanUnbox(values)) { ..print something } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;DefaultTypeTransformation.booleanUnbox() works fine.&lt;/p&gt;</comment>
                            <comment id="17530896" author="emilles" created="Mon, 2 May 2022 18:43:55 +0000"  >&lt;p&gt;I am able to recreate with Java 8/11 and Groovy 3.0.10.  Groovy 2.5.16 ran as expected for 200,000 and 500,000 iterations.&lt;/p&gt;

&lt;p&gt;Update: If I set system property &quot;groovy.indy.optimize.threshold&quot; higher than the iteration count, the script performs as expected.&lt;/p&gt;

&lt;p&gt;Here is the most recent change to these settings: &lt;a href=&quot;https://github.com/apache/groovy/commit/4f27d367dbc4fc506aa06883f4020ac2b2f744a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/4f27d367dbc4fc506aa06883f4020ac2b2f744a2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17530934" author="emilles" created="Mon, 2 May 2022 20:22:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daniel_sun&quot; class=&quot;user-hover&quot; rel=&quot;daniel_sun&quot;&gt;daniel_sun&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt;&lt;br/&gt;
Here is my idea for creating a method handle that is null-safe and survives call site caching.  The commented-out statement is today&apos;s logic.  Instead of an argument-sensitive solution, I&apos;m creating a method handle that checks for null and produces &lt;tt&gt;false&lt;/tt&gt; or &lt;tt&gt;null&lt;/tt&gt; (depending on the target type of boolean or Boolean).  And for non-null, &lt;tt&gt;asBoolean&lt;/tt&gt; is invoked, which handles boolean and Boolean as well.  Basically, Boolean#valueOf is no longer leveraged.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void handleBoolean() {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (handle != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;-&amp;gt;&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;-&amp;gt;&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;-&amp;gt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; are handled by the compiler
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// which leaves (T)Z and (T)&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;, where T is the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; type but runtime type of T might be &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; primitive = (staticTargetType == &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;.class);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!primitive &amp;amp;&amp;amp; staticTargetType != &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.class) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            /*
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (args[0] == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (primitive) {
                    handle = MethodHandles.constant(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;.class, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.FALSE);
                    handle = MethodHandles.dropArguments(handle, 0, staticSourceType);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    handle = BOOLEAN_IDENTITY; &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; of type &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;
&lt;/span&gt;                }
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (args[0] &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;) {
                handle = BOOLEAN_IDENTITY;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-comment&quot;&gt;// call asBoolean
&lt;/span&gt;                name = &lt;span class=&quot;code-quote&quot;&gt;&quot;asBoolean&quot;&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.setCallSiteTarget();
            }
            */
            name = &lt;span class=&quot;code-quote&quot;&gt;&quot;asBoolean&quot;&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.setCallSiteTarget();
            MethodHandle ifNull = IS_NULL.asType(MethodType.methodType(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;.class, staticSourceType));
            MethodHandle thenWhat, elseCallAsBoolean = handle;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (primitive) { &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/span&gt;                thenWhat = MethodHandles.dropArguments(MethodHandles.constant(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;.class, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.FALSE), 0, staticSourceType);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;// (&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;                thenWhat = MethodHandles.identity(staticSourceType).asType(MethodType.methodType(&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.class, staticSourceType));
            }

            handle = MethodHandles.guardWithTest(ifNull, thenWhat, elseCallAsBoolean);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not too familiar with all this &lt;tt&gt;MethodHandle&lt;/tt&gt; stuff, so forgive me if I went down a strange path.&lt;/p&gt;</comment>
                            <comment id="17531047" author="daniel_sun" created="Tue, 3 May 2022 05:29:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; LGTM&lt;/p&gt;</comment>
                            <comment id="17531274" author="emilles" created="Tue, 3 May 2022 16:08:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17531278" author="emilles" created="Tue, 3 May 2022 16:14:46 +0000"  >&lt;p&gt;In order to avoid MetaClass and NullObject for the current argument, I replaced &quot;super.setCallSiteTarget();&quot; with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INVOKE_METHOD = LOOKUP.findStatic(InvokerHelper.class, &lt;span class=&quot;code-quote&quot;&gt;&quot;invokeMethod&quot;&lt;/span&gt;, MethodType.methodType(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class));
elseCallAsBoolean = MethodHandles.insertArguments(INVOKE_METHOD, 1, &lt;span class=&quot;code-quote&quot;&gt;&quot;asBoolean&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).asType(targetType);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This makes the call site immediately cacheable, if that&apos;s any consolation.&lt;/p&gt;</comment>
                            <comment id="17531288" author="emilles" created="Tue, 3 May 2022 16:43:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daniel_sun&quot; class=&quot;user-hover&quot; rel=&quot;daniel_sun&quot;&gt;daniel_sun&lt;/a&gt; Can something be added to &lt;a href=&quot;https://groovy-lang.org/indy.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groovy-lang.org/indy.html&lt;/a&gt; to explain the caching strategy of indy mode and the various system properties that influence it?  I don&apos;t fully understand the cache scheme and my intuition says that the Selector logic that constructs method handles should be run for each new set of arguments if the handle depends on the characteristics of the argument type(s).&lt;/p&gt;</comment>
                            <comment id="17531375" author="blackdrag" created="Tue, 3 May 2022 19:27:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; your first change looked pretty good to me. Why did you decide to change it to use InvokerHelper#invokeMethod? The idea of binding to asBoolean is, to select and call that method &quot;directly&quot;. The handle later gains guards to deal with a changing runtime type (at least that was how I did it back then)&lt;/p&gt;</comment>
                            <comment id="17531378" author="emilles" created="Tue, 3 May 2022 19:39:22 +0000"  >&lt;p&gt;I was tracing through &lt;tt&gt;setCallSiteTarget()&lt;/tt&gt; and it was looking at the argument and choosing the meta class and the method based on that.  I wanted a solution that does not bind to NullObject or select the method from the MetaClass of the static source type.  With call site caching implemented since 3.0 there is a chance to get &amp;gt;10000 non-null instances and then a null comes in and the MethodHandle is bound for non-null.  Summary: I wanted to create a method handle that is independent of the runtime argument type.&lt;/p&gt;</comment>
                            <comment id="17531689" author="blackdrag" created="Wed, 4 May 2022 11:49:25 +0000"  >&lt;p&gt;Now I have to double check the code before I further comment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
This is about CastSelector, which is still a MethodSelector.. ok, as it used to be. setCallSiteTarget sets the core handle, but not the final handle, there is also setGuards. In &lt;a href=&quot;https://github.com/apache/groovy/blob/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b/src/main/java/org/codehaus/groovy/vmplugin/v8/Selector.java#L924&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b/src/main/java/org/codehaus/groovy/vmplugin/v8/Selector.java#L924&lt;/a&gt; it adds guards for the receiver as well as for the parameters of the call. This is only correct if args contains the receiver, which could be the case. As you see there is already a check for this. If there is a bug if a null receiver, then it should be somewhere there&lt;/p&gt;</comment>
                            <comment id="17531760" author="emilles" created="Wed, 4 May 2022 14:49:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; Are you saying &lt;tt&gt;setGuards()&lt;/tt&gt; should have been applied to the &lt;tt&gt;handle&lt;/tt&gt; that was returned for the null and identity cases in the old logic?  I have a pull request coming to take it back to direct call of &lt;tt&gt;asBoolean()&lt;/tt&gt;.  It seems to work fine; I&apos;m just not sure why.&lt;/p&gt;</comment>
                            <comment id="17531769" author="githubbot" created="Wed, 4 May 2022 14:54:41 +0000"  >&lt;p&gt;eric-milles opened a new pull request, #1720:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/1720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/1720&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   @blackdrag  Here is the half-step back to drop `invokeMethod` and call `asBoolean` directly.&lt;/p&gt;

</comment>
                            <comment id="17531808" author="blackdrag" created="Wed, 4 May 2022 16:17:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; yes that is right. &lt;/p&gt;</comment>
                            <comment id="17531812" author="emilles" created="Wed, 4 May 2022 16:20:31 +0000"  >&lt;p&gt;I tried that out and indeed the test case passes.  Can you explain the guards and the fallback?  I see a method handle made that checks for null or class change in the cast target.  But when a change in null state of class type occurs, what happens exactly?&lt;/p&gt;</comment>
                            <comment id="17531849" author="blackdrag" created="Wed, 4 May 2022 17:09:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt;The line &lt;a href=&quot;https://github.com/apache/groovy/blob/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b/src/main/java/org/codehaus/groovy/vmplugin/v8/Selector.java#L930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b/src/main/java/org/codehaus/groovy/vmplugin/v8/Selector.java#L930&lt;/a&gt; should add the test for the null case, 945 then builds it together. It really is just a null check there and if it succeeds it will continue with &quot;handle&quot;, if not it will continue with &quot;fallback&quot;. fallback is the general/slow path, that should also reset the callsite. So what if it was not null and becomes null. SAME_CLASS simply calls &lt;a href=&quot;https://github.com/apache/groovy/blob/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b/src/main/java/org/codehaus/groovy/vmplugin/v8/IndyGuardsFiltersAndSignatures.java#L196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/6b6a3e8a6fec2826f13cc0e6a52dcf1f25b4d74b/src/main/java/org/codehaus/groovy/vmplugin/v8/IndyGuardsFiltersAndSignatures.java#L196&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (o == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; o.getClass() == c;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You then have the null check here instead of a special null-check-methodhandle. Of course this could be expressed with more  method handles (maybe not the ==, but I am not sure). So for example the code in theory could be simplified by using the null-guard always and have the class equality check on it own.&lt;/p&gt;

&lt;p&gt;Maybe in case it is not clear.... image a guardWithTest as a composition of 3 handles, on condition handle, one true-case handle and one handle for the false-case. All of them operate on the given arguments. condition must fit the input arguments and return boolean, true and false cases must have a signature fitting to required input and output. You can very well have the true/false cases as guards as well, allowing you to build a tree structure - a bit like a decision tree. For Groovy it is more like a list, where the false-case is the slow path and the true-case is whatever we want to test further or execute.&lt;/p&gt;</comment>
                            <comment id="17532280" author="githubbot" created="Thu, 5 May 2022 14:46:25 +0000"  >&lt;p&gt;eric-milles merged PR #1720:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/1720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/1720&lt;/a&gt;&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13097661">GROOVY-8298</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13631191">GROOVY-11782</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13441637">GROOVY-10596</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13443722">GROOVY-10618</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>groovy</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10n00:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>