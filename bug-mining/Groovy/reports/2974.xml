<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:47:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7673] Remove synchronized methods of groovy.sql.Sql and document it as not thread-safe</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7673</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I am using groovy.sql.Sql with a commons dbcp2 BasicDataSource and am encountering a stacktrace as in [2] below.  I do create many identical closures with different data, and I pass them all at once to ExecutorService.invokeAll.  The closures are all using the same Sql instance.&lt;/p&gt;

&lt;p&gt;I believe this is a race condition because it happens only when the database is over a network, and not when the database is local.&lt;/p&gt;

&lt;p&gt;To work around I can set Sql.cacheNamedQueries = false.  Problem is reliably gone in this case.  So I guess the culprit is in [1], with my sql already being cached in namedParamSqlCache, but not yet in namedParamIndexPropCache?&lt;/p&gt;

&lt;p&gt;[1] the line in the source code&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/incubator-groovy/blob/GROOVY_2_4_X/subprojects/groovy-sql/src/main/java/groovy/sql/Sql.java#L4407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/blob/GROOVY_2_4_X/subprojects/groovy-sql/src/main/java/groovy/sql/Sql.java#L4407&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;[2] the stacktrace&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt; java.lang.NullPointerException
&amp;gt;       at java.util.ArrayList.&amp;lt;init&amp;gt;(ArrayList.java:168) ~[?:1.8.0]
&amp;gt;       at groovy.sql.Sql.buildSqlWithIndexedProps(Sql.java:4422) ~[groovy-all-2.4.5.jar:2.4.5]
&amp;gt;       at groovy.sql.Sql.checkForNamedParams(Sql.java:4369) ~[groovy-all-2.4.5.jar:2.4.5]
&amp;gt;       at groovy.sql.Sql.getPreparedStatement(Sql.java:4360) ~[groovy-all-2.4.5.jar:2.4.5]
&amp;gt;       at groovy.sql.Sql.getPreparedStatement(Sql.java:4439) ~[groovy-all-2.4.5.jar:2.4.5]
&amp;gt;       at groovy.sql.Sql.execute(Sql.java:2366) ~[groovy-all-2.4.5.jar:2.4.5]
&amp;gt;       at groovy.sql.Sql.execute(Sql.java:2438) ~[groovy-all-2.4.5.jar:2.4.5]
&amp;gt;       at groovy.sql.Sql$execute$1.call(Unknown Source) ~[?:?]
&amp;gt;       at es.acefael.BaseMigration.execute(BaseMigration.groovy:2017) ~[es-acefael-dostuff-SNAPSHOT.jar:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12913101">GROOVY-7673</key>
            <summary>Remove synchronized methods of groovy.sql.Sql and document it as not thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pascalschumacher">Pascal Schumacher</assignee>
                                    <reporter username="acefael">acefael</reporter>
                        <labels>
                            <label>breaking</label>
                    </labels>
                <created>Sat, 14 Nov 2015 19:53:37 +0000</created>
                <updated>Tue, 2 May 2017 02:03:06 +0000</updated>
                            <resolved>Mon, 4 Jan 2016 18:05:12 +0000</resolved>
                                    <version>2.4.5</version>
                                    <fixVersion>2.5.0-alpha-1</fixVersion>
                                    <component>SQL processing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15005588" author="acefael" created="Sat, 14 Nov 2015 20:04:59 +0000"  >&lt;p&gt;to reproduce a code block like below could be used:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def sql = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; groovy.sql.Sql( dataSource() )
def vals = []
200000.times { i -&amp;gt; vals.add( { i -&amp;gt; sql.execute( [ key: i ] , &lt;span class=&quot;code-quote&quot;&gt;&apos;insert into tbl(col)values(:key)&apos;&lt;/span&gt; ) }.curry(i) }
def pool = java.util.concurrent.Executors.newFixedThreadPool( 10 )
pool.invokeAll(vals)
pool.shutdown()
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;){pool.awaitTermination(5,TimeUnit.SECONDS)}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15018923" author="jwagenleitner" created="Fri, 20 Nov 2015 22:24:55 +0000"  >&lt;p&gt;Besides the &lt;a href=&quot;https://github.com/apache/incubator-groovy/blob/22c749fea5c41fdb89d4739ec9a2249d97de58cc/subprojects/groovy-sql/src/main/java/groovy/sql/Sql.java#L4407-L4409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;non thread-safe map access&lt;/a&gt; that is causing this particular NPE, another definite problem seems to be with the instance variable &lt;a href=&quot;https://github.com/apache/incubator-groovy/blob/22c749fea5c41fdb89d4739ec9a2249d97de58cc/subprojects/groovy-sql/src/main/java/groovy/sql/Sql.java#L249-L250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updateCount&lt;/a&gt;.  It&apos;s used in several methods and could cause an incorrect count to be returned if the methods are called by multiple threads (&lt;a href=&quot;https://github.com/apache/incubator-groovy/blob/22c749fea5c41fdb89d4739ec9a2249d97de58cc/subprojects/groovy-sql/src/main/java/groovy/sql/Sql.java#L2839-L2840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;see here&lt;/a&gt;).  While most might avoid &lt;tt&gt;cacheConnection&lt;/tt&gt; or &lt;tt&gt;cacheStatement&lt;/tt&gt; settings if they were using in a multi-threaded way, the updateCount would cause a problem.&lt;/p&gt;

&lt;p&gt;Hard to tell if these and the issues &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; pointed on the dev list should be addressed or if maybe the docs just need to be clear that the class is not thread-safe.&lt;/p&gt;</comment>
                            <comment id="15020425" author="acefael" created="Sat, 21 Nov 2015 12:27:09 +0000"  >&lt;p&gt;marking the class non thread-safe would limit its utility quite a lot, to me.&lt;br/&gt;
in a threaded environment one would have to resort to creating and discarding Sql instances a lot,&lt;br/&gt;
which in turn casts doubt on the built in caching mechanisms.&lt;/p&gt;

&lt;p&gt;I understand that, in a multithreaded environment, and when using Sql with a data source, any implicit state ought to be avoided, including the updateCount and prepared statements.  There&apos;s a performance penalty through that, which cannot be avoided.&lt;/p&gt;

&lt;p&gt;When using the Sql with a j.s.Connection it can cache all it wants and be therefore non thread-safe.&lt;/p&gt;

&lt;p&gt;Perhaps that&apos;s the distinction?  Thread safe with a DataSource, non thread-safe with a Connection?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/incubator-groovy/blob/22c749fea5c41fdb89d4739ec9a2249d97de58cc/subprojects/groovy-sql/src/main/java/groovy/sql/Sql.java#L268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;keyColumnNames&lt;/a&gt; appears to me another candidate for concurrency issues.&lt;/p&gt;</comment>
                            <comment id="15021142" author="jwagenleitner" created="Sun, 22 Nov 2015 19:14:46 +0000"  >&lt;p&gt;I took a shot at addressing some of the threading issues, split into separate commits to hopefully make review easier for those that are interested.  As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=acefael&quot; class=&quot;user-hover&quot; rel=&quot;acefael&quot;&gt;acefael&lt;/a&gt; suggested, it seemed reasonable to make the assumption that Connection-backed instances would be used by a single thread and DataSource-backed instances would more than likely be used by multiple threads.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/incubator-groovy/compare/master...jwagenleitner:GROOVY-7673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/compare/master...jwagenleitner:GROOVY-7673&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All tests pass.  The &lt;a href=&quot;https://github.com/apache/incubator-groovy/commit/ebc0e525d4e54c44bfa2a240f84bf8f8077b5b9e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;last commit to address &lt;tt&gt;cacheConnection/cacheStatements&lt;/tt&gt;&lt;/a&gt; is the biggest change and most likely to be problematic.  I&apos;d still need to do some real world testing of the changes, but thought before I did that I would seek some review of the changes.  Would especially be interested in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt;&apos;s thoughts.&lt;/p&gt;</comment>
                            <comment id="15021681" author="blackdrag" created="Mon, 23 Nov 2015 07:35:46 +0000"  >&lt;p&gt; What exactly would we want to share between threads? &lt;/p&gt;</comment>
                            <comment id="15024700" author="blackdrag" created="Tue, 24 Nov 2015 15:42:29 +0000"  >&lt;p&gt;If there is not really anything we want to share between threads, why not just document the class as not being threadsafe? If you want to use parallel processing using groovy.sql.Sql , you need then to either synchronize yourself properly, or use different instances. What speaks against that?&lt;/p&gt;</comment>
                            <comment id="15024950" author="pascalschumacher" created="Tue, 24 Nov 2015 17:47:19 +0000"  >&lt;p&gt;I guess the problem is that groovy.sql.Sql already has some synchronized methods, so people think it is thread-safe. Maybe we should remove the synchronized modifiers (which can be done without breaking binary compatibility &lt;a href=&quot;https://docs.oracle.com/javase/specs/jls/se7/html/jls-13.html#jls-13.4.20&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/specs/jls/se7/html/jls-13.html#jls-13.4.20&lt;/a&gt;) and document the class as not thread-safe?&lt;/p&gt;</comment>
                            <comment id="15026701" author="acefael" created="Wed, 25 Nov 2015 12:34:39 +0000"  >&lt;p&gt;I&apos;d be content with that.&lt;/p&gt;</comment>
                            <comment id="15034350" author="pascalschumacher" created="Tue, 1 Dec 2015 18:53:46 +0000"  >&lt;p&gt;I changed the title to reflect the discussion results.&lt;/p&gt;</comment>
                            <comment id="15035429" author="paulk" created="Wed, 2 Dec 2015 07:56:04 +0000"  >&lt;p&gt;I am not sure it is good practice to have such a breaking change in a point release. Perhaps just keep it in master?&lt;/p&gt;</comment>
                            <comment id="15080766" author="paulk" created="Mon, 4 Jan 2016 07:04:41 +0000"  >&lt;p&gt;I&apos;ll reopen until we revert in 2.4.x&lt;/p&gt;</comment>
                            <comment id="15081494" author="pascalschumacher" created="Mon, 4 Jan 2016 18:05:12 +0000"  >&lt;p&gt;Hi Paul,&lt;/p&gt;

&lt;p&gt;I already reverted the change in 2_4_X &lt;a href=&quot;https://github.com/apache/groovy/commit/55933a30e478e8793fea21e1b1f569fdefae1eef&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/55933a30e478e8793fea21e1b1f569fdefae1eef&lt;/a&gt; and removed the 2.4.6 fix version weeks ago.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Pascal&lt;/p&gt;</comment>
                            <comment id="15082035" author="paulk" created="Mon, 4 Jan 2016 23:47:43 +0000"  >&lt;p&gt;Yes, I see that now. Sorry for the noise - I thought I had pulled but apparently not for that branch until after I commented.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 46 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oen3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>