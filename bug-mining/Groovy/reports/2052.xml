<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:30:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5856] Annotation causes @CompileStatic to fail</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5856</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;If I add @CompileStatic to a class that already has an @Entity gaelyk annotation. I get a compilation error. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;:compileGroovy
startup failed:
General error during class generation: size==0

java.lang.ArrayIndexOutOfBoundsException: size==0
	at org.codehaus.groovy.classgen.asm.OperandStack.doConvertAndCast(OperandStack.java:312)
	at org.codehaus.groovy.classgen.asm.OperandStack.doGroovyCast(OperandStack.java:296)
	at org.codehaus.groovy.classgen.asm.StatementWriter.writeReturn(StatementWriter.java:592)
	at org.codehaus.groovy.classgen.AsmClassGenerator.visitReturnStatement(AsmClassGenerator.java:505)
	at org.codehaus.groovy.ast.stmt.ReturnStatement.visit(ReturnStatement.java:47)
	at org.codehaus.groovy.classgen.asm.StatementWriter.writeBlockStatement(StatementWriter.java:81)
	at org.codehaus.groovy.classgen.asm.sc.StaticTypesStatementWriter.writeBlockStatement(StaticTypesStatementWriter.java:49)
	at org.codehaus.groovy.classgen.AsmClassGenerator.visitBlockStatement(AsmClassGenerator.java:455)
	at org.codehaus.groovy.ast.stmt.BlockStatement.visit(BlockStatement.java:69)
	at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitClassCodeContainer(ClassCodeVisitorSupport.java:101)
	at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitConstructorOrMethod(ClassCodeVisitorSupport.java:112)
	at org.codehaus.groovy.classgen.AsmClassGenerator.visitStdMethod(AsmClassGenerator.java:319)


the EntityTransformation#visit(nodes, source) method runs well but StaticCompileTransformation#visit(nodes, source) fails
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Groovy 2.0.6 SNAPSHOT </environment>
        <key id="12818208">GROOVY-5856</key>
            <summary>Annotation causes @CompileStatic to fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="melix">C&#233;dric Champeau</assignee>
                                    <reporter username="sdmurphy">Scott Murphy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Dec 2012 23:04:32 +0000</created>
                <updated>Sat, 22 Dec 2012 01:10:50 +0000</updated>
                            <resolved>Wed, 19 Dec 2012 09:49:15 +0000</resolved>
                                    <version>2.0.6</version>
                    <version>2.1.0-beta-1</version>
                                    <fixVersion>2.0.6</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14473581" author="sdmurphy" created="Tue, 18 Dec 2012 23:06:24 +0000"  >&lt;p&gt;Gradle project to replicate problem&lt;/p&gt;

&lt;p&gt;Using:&lt;br/&gt;
Gradle 1.3&lt;/p&gt;</comment>
                            <comment id="14473673" author="musketyr" created="Wed, 19 Dec 2012 01:08:43 +0000"  >&lt;p&gt;code for @Entity transformation can be f&#237;nd here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/gaelyk/gaelyk/blob/groovy2/core/src/main/groovyx/gaelyk/datastore/EntityTransformation.groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gaelyk/gaelyk/blob/groovy2/core/src/main/groovyx/gaelyk/datastore/EntityTransformation.groovy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;the transformation is called prior the @CompileStatic.&lt;/p&gt;
</comment>
                            <comment id="14473640" author="melix" created="Wed, 19 Dec 2012 01:22:54 +0000"  >&lt;p&gt;I&apos;m not 100% sure, but this might be related to this part of the transform:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;block.addStatement(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReturnStatement(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MethodCallExpression(
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassExpression(helper), name,
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArgumentListExpression(
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassExpression(parent),
                        * parameters.collect { &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; n, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; cls -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VariableExpression(n)}
                ))))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see, a new &lt;tt&gt;VariableExpression&lt;/tt&gt; is created, but it&apos;s both untyped (should be ok) and has no target variable associated (this one is in general problematic). For a &lt;tt&gt;VariableExpression&lt;/tt&gt;, we should always set the accessed variable to the origin variable it comes from. Here, the code generates a block then a method and the variables correspond to method arguments, so accessed variables should refer to the parameters of the method. I suggest to try to change the transform code so that it generates the parameters first, then the variables and set the accessed variables accordingly:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def methodParams = parameters.collect { &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; n, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; cls -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Parameter(ClassHelper.makeWithoutCaching(cls).plainNodeReference, n)}
def variables = methodParams.collect { 
   def v = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VariableExpression(it.type, it.name)
   v.accessedVariable = it
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14473576" author="sdmurphy" created="Wed, 19 Dec 2012 01:40:51 +0000"  >&lt;p&gt;Shouldn&apos;t the compiler give a bit better of an error message though?  rather than size==0?&lt;/p&gt;</comment>
                            <comment id="14473560" author="blackdrag" created="Wed, 19 Dec 2012 01:45:23 +0000"  >&lt;p&gt;It means you tried to cast something that is not there. That error message wouldn&apos;t have helped you too. Doing the transformations right is the responsibility of the creator of the transformation. If you make a transformation that makes new variables, after VariableScopeVisitor is done, it is your responsibility to do it right and enter the variables in the scope as well as link the VariableExpressions to their origin.&lt;/p&gt;</comment>
                            <comment id="14473604" author="melix" created="Wed, 19 Dec 2012 01:46:08 +0000"  >&lt;p&gt;It&apos;s more complicated than it seems. There are a lot of possible reasons for this to happen, but I agree that the error message is a bit cryptic. However, would it be better if it was &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Compiler expected an operand on stack but the stack is empty&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;? I&apos;m not convinced. The underlying reasons for this to happen can be very tricky to discover, and finding them is just about experience with the compiler: code consuming more operands than it should, code not generated at all, ...&lt;/p&gt;</comment>
                            <comment id="14473511" author="musketyr" created="Wed, 19 Dec 2012 01:59:51 +0000"  >&lt;p&gt;would be nice if VariableExpression has more docs. How should I had known that origin is required since there is not single line in groovydoc about it?&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ve updated the code for parameters list but the problem is still there. How should I create proper variable expression for &lt;tt&gt;this&lt;/tt&gt; object? I suppose &lt;tt&gt;new VariableExpression(&apos;this&apos;)&lt;/tt&gt; might not be sufficient too, am I right?&lt;/p&gt;

&lt;p&gt;Any chance that more context could be attached to the exception?&lt;/p&gt;
</comment>
                            <comment id="14473656" author="melix" created="Wed, 19 Dec 2012 02:02:11 +0000"  >&lt;p&gt;Hi Vladimir, &quot;this&quot; as well as &quot;super&quot; are special, you don&apos;t need to refer to another class. Can you paste the code of the modified transform somewhere? Maybe I will see something else that might trigger such an error...&lt;/p&gt;</comment>
                            <comment id="14473589" author="blackdrag" created="Wed, 19 Dec 2012 02:04:52 +0000"  >&lt;p&gt;please use VariableExpression.THIS_EXPRESSION. without setting any lines or origins&lt;/p&gt;</comment>
                            <comment id="14473625" author="musketyr" created="Wed, 19 Dec 2012 02:05:26 +0000"  >&lt;p&gt;I&apos;ve already pushed the change to the github&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/gaelyk/gaelyk/commit/38372f9f24233fcc7e3bb821ae3076988115a61a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/gaelyk/gaelyk/commit/38372f9f24233fcc7e3bb821ae3076988115a61a&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14473492" author="musketyr" created="Wed, 19 Dec 2012 02:13:57 +0000"  >&lt;p&gt;thx! but I still got the same error.&lt;/p&gt;</comment>
                            <comment id="14473577" author="melix" created="Wed, 19 Dec 2012 02:22:39 +0000"  >&lt;p&gt;Err, Jochen, people should &lt;b&gt;never&lt;/b&gt; use &lt;tt&gt;VariableExpression.THIS_EXPRESSION&lt;/tt&gt; directly, and especially not in AST transforms. Using internal constants causes a lot of troubles so it&apos;s definitely an error to do so. Using &lt;tt&gt;new VariableExpression(&quot;this&quot;)&lt;/tt&gt; is the way to go, and then you should use, if you need to &lt;tt&gt;ve.isThisExpression()&lt;/tt&gt; instead of an equality test. Not doing so leads to very difficult to find bugs, especially when the build behaves differently on Bamboo &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14473578" author="melix" created="Wed, 19 Dec 2012 09:15:11 +0000"  >&lt;p&gt;So there are two bugs here: one in the type checker because it doesn&apos;t try to find a method on &lt;tt&gt;GroovyObject&lt;/tt&gt; if a receiver is a class node being compiled, and another one in Gaelyk.&lt;/p&gt;

&lt;p&gt;For reference, I used the &apos;666&apos; trick to find the problem. You must be aware that for various reasons, errors thrown by the type checker on generated code are silent. The way the type checker finds that it&apos;s generated code is to check the line number and column number. If it&apos;s &amp;lt;0, then it&apos;s considered as generated code. So you can make the type checker verbose again just by ensuring, in your AST transform, that generated method calls, for example, have a line number and column number &amp;gt;0. In those cases, I use a dummy, easily recognizable number: 666 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722542" name="static-compile-fail.zip" size="366589" author="sdmurphy" created="Tue, 18 Dec 2012 23:06:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bmtz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>