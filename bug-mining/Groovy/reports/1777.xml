<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:26:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5371] Sql DataSet fails to work with non-literals in queries (fix error message/doco)</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5371</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;All the examples of using &lt;em&gt;findAll&lt;/em&gt; in the &lt;em&gt;Sql&lt;/em&gt; &lt;em&gt;DataSet&lt;/em&gt; class use literals for the search values of queries. Using free variables causes failure as Groovy does not implement lexical closure automatically.  However this can be realized using the Closure delegate field. I therefore believe that the following example fails because the &lt;em&gt;Sql.SqlWhereVisitor&lt;/em&gt; fails to lookup variables but assumes that all query values are literals.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.sql.DataSet
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.sql.Sql

@Grapes ( [    
            @Grab ( &lt;span class=&quot;code-quote&quot;&gt;&apos;org.xerial:sqlite-jdbc:3.7.2&apos;&lt;/span&gt; ),
            @GrabConfig ( systemClassLoader = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; )
          ] )
def database
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; words = [ ]
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  database = Sql.newInstance ( &lt;span class=&quot;code-quote&quot;&gt;&apos;jdbc:sqlite:database.db&apos;&lt;/span&gt; , &lt;span class=&quot;code-quote&quot;&gt;&apos;org.sqlite.JDBC&apos;&lt;/span&gt;)
  &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; wordsTable = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataSet ( database , &lt;span class=&quot;code-quote&quot;&gt;&apos;words&apos;&lt;/span&gt; )
  ( 0 ..&amp;lt; 4 ).each { i -&amp;gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; query = { item -&amp;gt; item.id == i }
    query.delegate = { i : i }
    query.resolveStrategy = Closure.DELEGATE_FIRST 
    words &amp;lt;&amp;lt; wordsTable.findAll ( query ).firstRow ( ).word
  }
}
&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
  database?.close ( )
}
println words.join ( &apos;&apos; )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12818154">GROOVY-5371</key>
            <summary>Sql DataSet fails to work with non-literals in queries (fix error message/doco)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="russel">Dr. Russel Winder</reporter>
                        <labels>
                    </labels>
                <created>Sat, 17 Mar 2012 06:24:05 +0000</created>
                <updated>Fri, 23 Mar 2012 02:47:59 +0000</updated>
                            <resolved>Mon, 19 Mar 2012 18:19:10 +0000</resolved>
                                    <version>2.0-beta-3</version>
                                    <fixVersion>2.0-beta-3</fixVersion>
                    <fixVersion>1.8.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14479854" author="paulk" created="Sun, 18 Mar 2012 00:33:10 +0000"  >&lt;p&gt;Just a small aside: You don&apos;t need the @Grapes annotation in your example above - just the @Grab and @GrabConfig should suffice.&lt;/p&gt;</comment>
                            <comment id="14479887" author="paulk" created="Sun, 18 Mar 2012 01:13:56 +0000"  >&lt;p&gt;I think this issue conflates two aspects. It seems to me that I can &quot;resolve&quot; the issue by detecting when non-literals are used in the right-hand side of DataSet findAll statements and generate an appropriate warning indicating that such expressions aren&apos;t supported. If you are trying to solve the bigger issue about Closures, then I would rename the issue and give other simpler examples which illustrate the point. Given that DataSet has limitations, it doesn&apos;t really help much as an example in this discussion.&lt;/p&gt;</comment>
                            <comment id="14472543" author="russel" created="Sun, 18 Mar 2012 09:07:18 +0000"  >&lt;p&gt;So when is @Grapes needed?&lt;/p&gt;</comment>
                            <comment id="14472618" author="russel" created="Sun, 18 Mar 2012 09:10:57 +0000"  >&lt;p&gt;I am not sure right-hand and left-hand is important here &amp;#8211;  &quot;it.id == x&quot; and &quot;x == it.id&quot; should behave the same.&lt;/p&gt;

&lt;p&gt;I think the above example is independent of the general Closure debate, since it provides a delegate that should resolve the &quot;free variable&quot;.  I think the point here is that the findAll evaluator doesn&apos;t do resolution at all, it assumes that the value is a literal.  Isn&apos;t this just wrong? &lt;/p&gt;</comment>
                            <comment id="14479864" author="paulk" created="Mon, 19 Mar 2012 07:40:07 +0000"  >&lt;p&gt;Re: &quot;&lt;tt&gt;@Grapes&lt;/tt&gt;&quot;: I would like to say &lt;tt&gt;@Grapes&lt;/tt&gt; is never needed now but that isn&apos;t quite true. There are two reasons for its existence.&lt;/p&gt;

&lt;p&gt;One is to do with JVM limitations regarding having multiple Grab annotations of the same name, e.g. in &lt;tt&gt;java.lang.Class#getAnnotation(Class)&lt;/tt&gt; a single annotation is returned. We have worked around that limitation for now.&lt;/p&gt;

&lt;p&gt;The second reason is to do with eventually supporting fine-grained control over &lt;tt&gt;Grab&lt;/tt&gt; settings, e.g. you might want &lt;tt&gt;GrabResolver&lt;/tt&gt; or &lt;tt&gt;GrabConfig&lt;/tt&gt; to apply to just one of your &lt;tt&gt;Grab&lt;/tt&gt;&apos;s not all of them. This is where &lt;tt&gt;Grapes&lt;/tt&gt; would come in, however at the moment, all of those settings are global across all &lt;tt&gt;Grab&lt;/tt&gt;&apos;s.&lt;/p&gt;</comment>
                            <comment id="14472592" author="blackdrag" created="Mon, 19 Mar 2012 08:19:35 +0000"  >&lt;p&gt;As for the query. Russel, how we construct this atm is by getting the AST from source for this, evaluate the ast to a sql query and execute that query. This translation cannot and will probably never handle complex expressions. The case at hand here though is about a local variable being used. And such a case should be supported. But that doesn&apos;t make this a critical bug, but a RFE. If anything here is a bug, than that unhandled cases are silently accepted. imho that should cause an exception.&lt;/p&gt;</comment>
                            <comment id="14479900" author="paulk" created="Mon, 19 Mar 2012 08:30:25 +0000"  >&lt;p&gt;&lt;em&gt;Re: &quot;right-hand vs left-hand&quot;:&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;You are correct, it shouldn&apos;t be important though the current implementation makes a distinction - don&apos;t have time to try it tonight - I suspect it may just produce an expression with an unneeded set of brackets in one case.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Re: &quot;I think the point here is that the findAll evaluator doesn&apos;t do resolution at all, it assumes that the value is a literal. Isn&apos;t this just wrong?&quot;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I guess I am just saying &quot;wrong&quot; is in the eye of the beholder. Groovy can provide a limited functionality DataSet if it wants. It will probably still cover many of the typical queries that people do but obviously not all. What we currently have though is a limited functionality mechanism with some secondary issues (poor error messages and inadequate documentation). I tend to agree with you that we do want to fix this properly but am reminding myself that perhaps removing the secondary issues in the meantime might also be a useful step forward.&lt;/p&gt;</comment>
                            <comment id="14479846" author="paulk" created="Mon, 19 Mar 2012 16:47:30 +0000"  >&lt;p&gt;OK, just confirmed my suspicions, there is a slight different treatment of left- and right-hand sided literals but it makes no practical difference. Here is an example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def found1 = projects.findAll{ it.id &amp;lt; 35 &amp;amp;&amp;amp; it.id &amp;gt; 15 }
println found1.sql &lt;span class=&quot;code-comment&quot;&gt;// =&amp;gt; select * from project where (id &amp;lt; ? and id &amp;gt; ?)
&lt;/span&gt;def found2 = projects.findAll{ 35 &amp;gt; it.id &amp;amp;&amp;amp; it.id &amp;gt; 15 }
println found2.sql &lt;span class=&quot;code-comment&quot;&gt;// =&amp;gt; select * from project where ((? &amp;gt; id) and id &amp;gt; ?)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So we can remove this difference in treatment if we want.&lt;/p&gt;</comment>
                            <comment id="14479837" author="paulk" created="Mon, 19 Mar 2012 18:07:07 +0000"  >&lt;p&gt;Issue cloned and split out into &quot;fix current error message/doco&quot; and &quot;do the enhancement&quot;.&lt;/p&gt;</comment>
                            <comment id="14479886" author="paulk" created="Mon, 19 Mar 2012 18:17:35 +0000"  >&lt;p&gt;Currently, DataSet produces invalid Sql and silently continues on resulting in the user getting a strange error message at some point in the future. If we currently don&apos;t support particular expressions which cause such behaviour, we should produce a suitable error message at the point where the unsupported expression is discovered.&lt;/p&gt;</comment>
                            <comment id="14479866" author="paulk" created="Mon, 19 Mar 2012 18:19:10 +0000"  >&lt;p&gt;Error message added and doco tweaked. Please continue discussions about the desired DataSet enhancement on &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5373&quot; title=&quot;Sql DataSet fails to work with non-literals in queries (enhancement required)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5373&quot;&gt;GROOVY-5373&lt;/a&gt;. Thanks.&lt;/p&gt;</comment>
                            <comment id="14472573" author="russel" created="Tue, 20 Mar 2012 07:46:36 +0000"  >&lt;p&gt;The error message works for me.&lt;/p&gt;</comment>
                            <comment id="14472647" author="russel" created="Fri, 23 Mar 2012 02:47:59 +0000"  >&lt;p&gt;Seems to work as anticipated.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310260">
                    <name>Related</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12816101">GROOVY-5373</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cg1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>