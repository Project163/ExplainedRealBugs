<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:11:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3339] Calling a method that takes a closure containing a list or number (and maybe others) constant throws a weird exception</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3339</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;This script:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(myVal in evaluate(&lt;span class=&quot;code-quote&quot;&gt;&apos;[10,11,12]&apos;&lt;/span&gt;, 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;) { [10,11,12] }) { 
 println myVal
}

def evaluate(text, num, thing, closure) {
   closure.call()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Produces:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception thrown: $&lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;$1

java.lang.NoSuchFieldError: $&lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt;$1
       at ConsoleScript1$_run_closure1.doCall(ConsoleScript1:1)
       at ConsoleScript1$_run_closure1.doCall(ConsoleScript1)
       at ConsoleScript1.evaluate(ConsoleScript1:6)
       at ConsoleScript1$evaluate.callCurrent(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Whilst this one that has a String inside the closure works fine:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(myVal in evaluate(&lt;span class=&quot;code-quote&quot;&gt;&apos;[10,11,12]&apos;&lt;/span&gt;, 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;) { &lt;span class=&quot;code-quote&quot;&gt;&quot;one&quot;&lt;/span&gt; }) { 
 println myVal
}

def evaluate(text, num, thing, closure) {
   closure.call()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12814544">GROOVY-3339</key>
            <summary>Calling a method that takes a closure containing a list or number (and maybe others) constant throws a weird exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="graemerocher">Graeme Rocher</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Feb 2009 09:55:13 +0000</created>
                <updated>Tue, 7 Apr 2009 23:33:12 +0000</updated>
                            <resolved>Fri, 6 Feb 2009 22:38:23 +0000</resolved>
                                    <version>1.6-rc-1</version>
                    <version>1.6-rc-2</version>
                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.7-beta-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14466443" author="roshandawrani" created="Thu, 5 Feb 2009 11:40:12 +0000"  >&lt;p&gt;Trimming down the code even further (to make debugging easier), the following piece fails too:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;//---------TestScript.groovy---------
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(myVal in evaluate({[10]})) {
	println myVal
}

def evaluate(closure) {
   closure.call()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue is related to the constants that are added for raw numbers by OptimizeVisitor. In this piece of code, the synthetic field that is being defined for value 10 is being defined in the outer class TestScript.class and not in the class that gets generated for closure. So the field is defined and initialized in one class but used in closure class. It fails in TestScript_run_closure1-&amp;gt;doCall() where it tries to create the list with cached constant $const$0.&lt;/p&gt;</comment>
                            <comment id="14466372" author="roshandawrani" created="Thu, 5 Feb 2009 12:09:03 +0000"  >&lt;p&gt;The following piece of code has no issues in running in Java. The inner class is comfortably able to access the constant that is defined in the enclosing class.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Try 
{
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; a = 10;
	&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TryInner
	{
	    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void doCall()
	    {
	      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(a);
	    }
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does it mean that the inner class generated for closure is not able to see the constant ($const$0) defined in the enclosing class because it is synthetic? That is the only difference I can see in groovy classes and java classes above.&lt;/p&gt;</comment>
                            <comment id="14466471" author="blackdrag" created="Thu, 5 Feb 2009 18:03:17 +0000"  >&lt;p&gt;evaluate doesn&apos;t even need a list, the number itself is already enough.&lt;/p&gt;

&lt;p&gt;generated closures instances do in general not access the fields defined in the outer class. That does not prevent a normal closure to use constants, because in that case the closure class itself will have these constants in its fields. But the code that ensures the field is added seems to fail here for some reason. I have no real idea where it fails yet.&lt;/p&gt;</comment>
                            <comment id="14466442" author="roshandawrani" created="Fri, 6 Feb 2009 11:56:41 +0000"  >&lt;p&gt;If I say &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def cl = {
		1000.times{
			def i = 10
			println i
		}
}
println cl()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t see any cached constants being used for 10 and 1000 in inner classes written for closures. So, looks like the current implementation does not cover optimization in such inner classes through synthetic constant fields.&lt;/p&gt;

&lt;p&gt;So, what should be fixed in the raised JIRA is that inner class is trying to use the constant, right? Because that, it seems, is not something that the current implementation is designed for.&lt;/p&gt;

&lt;p&gt;Also covering even the closure inner classes may be a much bigger effort. I am not sure.&lt;/p&gt;</comment>
                            <comment id="14466373" author="roshandawrani" created="Fri, 6 Feb 2009 14:40:14 +0000"  >&lt;p&gt;I was trying to see if even in some other expressions this issue was there and found some more cases like below where it fails (same basic issue though):&lt;/p&gt;

&lt;p&gt;while(evaluate(&lt;/p&gt;
{10})){}&lt;br/&gt;
or&lt;br/&gt;
synchronized(evaluate({10}
&lt;p&gt;)){}&lt;/p&gt;

&lt;p&gt;Continuing from the previous message in JIRA thread, if the constant caching is not implemented for closure classes yet and if that is ok for now and this issue is to be fixed, then the attach patch is fixing it.&lt;/p&gt;

&lt;p&gt;Is it ok?&lt;/p&gt;</comment>
                            <comment id="14466483" author="blackdrag" created="Fri, 6 Feb 2009 15:12:39 +0000"  >&lt;p&gt;you are right, the closure classes do not get their constants cached. I think it would be a good idea to add that, but that can be a new JIRA entry. Let us here concentrate on fixing the error itself. I suggest you write a testcase and if your patch does fix the problem you can commit it... form a first look the patch makes sense to me.&lt;/p&gt;</comment>
                            <comment id="14466391" author="roshandawrani" created="Fri, 6 Feb 2009 22:38:23 +0000"  >&lt;p&gt;Fixed on 1.6.x (not on 1.6.0) and trunk.&lt;/p&gt;

&lt;p&gt;Modified the OptimizerVisitor so that it does not visit ClosureExpression anymore - to avoid cached constants from mistakenly being referred to in the closure classes.&lt;/p&gt;</comment>
                            <comment id="14466507" author="roshandawrani" created="Sat, 7 Feb 2009 00:50:51 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3342&quot; title=&quot;Optimization done by groovy compiler by caching number constants does not cover closure classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3342&quot;&gt;&lt;del&gt;GROOVY-3342&lt;/del&gt;&lt;/a&gt; to raise the optimization requirement for closure classes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12814600">GROOVY-3368</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12722156" name="Patch.txt" size="995" author="roshandawrani" created="Fri, 6 Feb 2009 14:40:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2crfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>