<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:09:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3069] Closure does not have scope precedent over local method</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3069</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Looking at this SSCCE, the local method selectSql gets called rather than the closure, when the closure should have scope preference. Please find below reference to the discussion about this issue on the groovy-user mailing-list. &lt;/p&gt;

&lt;p&gt;public class Tester {&lt;br/&gt;
   private String selectSql() &lt;/p&gt;
{return &apos;local method&apos;}

&lt;p&gt;   public String returnSql(Closure selectSql) &lt;/p&gt;
{
        return selectSql()
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Tester t = new Tester()&lt;br/&gt;
println t.returnSql() &lt;/p&gt;
{ &apos;date,name,value&apos; }

&lt;p&gt;Reference: &lt;a href=&quot;http://www.nabble.com/Closure-does-not-have-scope-precedent-over-local-method--td19724860.html#a19724860&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.nabble.com/Closure-does-not-have-scope-precedent-over-local-method--td19724860.html#a19724860&lt;/a&gt;&lt;/p&gt;</description>
                <environment>Microsoft Windows XP [Version 5.1.2600]&lt;br/&gt;
Java(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_04-b05)&lt;br/&gt;
Groovy Version: 1.5.6 JVM: 1.5.0_04-b05</environment>
        <key id="12814335">GROOVY-3069</key>
            <summary>Closure does not have scope precedent over local method</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="roshandawrani">Roshan Dawrani</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Oct 2008 12:58:07 +0000</created>
                <updated>Fri, 18 Jul 2025 14:59:39 +0000</updated>
                            <resolved>Tue, 16 Dec 2008 07:19:07 +0000</resolved>
                                    <version>1.5.6</version>
                                    <fixVersion>1.6-rc-1</fixVersion>
                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>1.7-beta-1</fixVersion>
                                    <component>syntax</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14465754" author="roshandawrani" created="Sun, 30 Nov 2008 13:36:43 +0000"  >&lt;p&gt;The issue found in all 1.5.8, 1.6-RC-1, and 1.7-beta-1 branches.&lt;/p&gt;

&lt;p&gt;Please find attached the fix for all 3 versions.&lt;/p&gt;

&lt;p&gt;The modification has been made to AsmClassGenerator -&amp;gt; visitMethodCallExpression().&lt;/p&gt;

&lt;p&gt;If it now sees a closure variable on the compile stack (an argument or a local variable) of the same name as a method on the class, the closure is given precedence over the method on the class.&lt;/p&gt;

&lt;p&gt;Hope it helps.&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465782" author="roshandawrani" created="Sun, 30 Nov 2008 13:37:35 +0000"  >&lt;p&gt;Attaching the test case for the issue. It didn&apos;t allow more than 3 attachments last time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14465764" author="roshandawrani" created="Mon, 1 Dec 2008 02:12:21 +0000"  >&lt;p&gt;Simplified the &quot;if&quot; conditions that are used to identify this scenario when a local closure variable needs higher predecence. re-attached the re-tested patches.&lt;/p&gt;</comment>
                            <comment id="14465718" author="blackdrag" created="Mon, 1 Dec 2008 08:06:54 +0000"  >&lt;p&gt;I would remove the &quot;&amp;amp;&amp;amp; compileStack.getVariable(methodName).getType().equals(ClassHelper.CLOSURE_TYPE)&quot;, because we do not depend on the type of the variable, since an untyped variable may still be a closure. Let us simply assume that it is allowed. And another small thing about code style.. please use &quot;} else &lt;/p&gt;
{&quot; and &quot;}
&lt;p&gt; else if&quot;. I know we are not really consistent with keeping that style, but we should try &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14465801" author="roshandawrani" created="Mon, 1 Dec 2008 11:18:17 +0000"  >&lt;p&gt;Attaching version 2 of the patches and the test case incorporating the review comments.&lt;/p&gt;

&lt;p&gt;The patches now allow a local closure variable to take predence over class methods even without the Closure type explicitly specified on the local variable.&lt;/p&gt;

&lt;p&gt;There were 2 places in the existing code base which were impacted because of the change in semantics being introduced by this fix. They have also been modified. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def create(select) {
    ....
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (select) {
        &lt;span class=&quot;code-comment&quot;&gt;// after the fix, the following call would consider &lt;span class=&quot;code-quote&quot;&gt;&quot;select&quot;&lt;/span&gt; as a closure and &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a invokeClosure
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// but in some existing cases in groovy code base, even though the same variable name
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// is being used, value passed is a &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; or string and following select(..) call
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// is intended to call an instance method. At these 2 impacted places, I have changed
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// the parameter name to avoid conflict.
&lt;/span&gt;
        select(i)
    }
    ....
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14465828" author="roshandawrani" created="Mon, 1 Dec 2008 11:37:21 +0000"  >&lt;p&gt;I think instead of ignoring the type check completely in ACG, it may be better if we use the type if provided (local variable type != Object).&lt;/p&gt;

&lt;p&gt;That way, in code like below, &quot;select&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&quot; won&apos;t be mapped as a invokeClosure call on the &quot;boolean&quot; variable &quot;select&quot;, which will be the case of type is totally removed from the new ACG check conditions for this fix.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def create(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; select) {
    ....
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (select) {
        select(i)
    }
    ....
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14465830" author="blackdrag" created="Wed, 3 Dec 2008 07:54:36 +0000"  >&lt;p&gt;no, we should keep consistency and a boolean is there no different from Object or Closure. Also the user may have used a category to add a call method to Boolean, which would cause select&amp;#40;i) to be executed successfully. (Note: select is boolean, not Boolean, but that does not matter for the category)&lt;/p&gt;</comment>
                            <comment id="14465870" author="blackdrag" created="Wed, 3 Dec 2008 08:04:11 +0000"  >&lt;p&gt;when looking at the patch, then we have &quot;call.isImplicitThis() &amp;amp;&amp;amp; isThisExpression &amp;amp;&amp;amp; compileStack.containsVariable(methodName)&quot; and we have in the if before &quot;methodName != null &amp;amp;&amp;amp; isThisExpression &amp;amp;&amp;amp; isFieldOrVariable(methodName) &amp;amp;&amp;amp; !classNode.hasPossibleMethod(methodName, arguments))&quot;, also the body is nearly the same... so I think those two should be merged.. the equal parts are &quot;methodName != null &amp;amp;&amp;amp; isThisExpression&quot;, then I suggest to add &quot;&amp;amp;&amp;amp; (compileStack.containsVariable(name) || (classNode.getDeclaredField(name) != null; &amp;amp;&amp;amp; !classNode.hasPossibleMethod(methodName, arguments)))&quot; I would also suggest to then remove isFieldOrVariable because the method is no longer used then... and since the if part becomes so long I would also suggest to put that whole thing in its own method&lt;/p&gt;</comment>
                            <comment id="14465885" author="roshandawrani" created="Wed, 3 Dec 2008 10:03:43 +0000"  >&lt;p&gt;Actually I also thought of merging the conditions like that but there is one more patch I had worked on (for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3156&quot; title=&quot;Within a nested closure, &amp;quot;this.method()&amp;quot; works incorrectly if parent closure and outermost class have closures/methods of the same name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3156&quot;&gt;&lt;del&gt;GROOVY-3156&lt;/del&gt;&lt;/a&gt;) and that also added 2 conditions to the same if condition in visitMethodCallExpression (to see if method call is not an explicit this call inside a closure), making it an even longer list of conditions. &lt;/p&gt;

&lt;p&gt;I am not sure fully but &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3156&quot; title=&quot;Within a nested closure, &amp;quot;this.method()&amp;quot; works incorrectly if parent closure and outermost class have closures/methods of the same name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3156&quot;&gt;&lt;del&gt;GROOVY-3156&lt;/del&gt;&lt;/a&gt; may still need isFieldOrVariable() to be there. At least the patch had worked with it present.&lt;/p&gt;

&lt;p&gt;If you can look at &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3156&quot; title=&quot;Within a nested closure, &amp;quot;this.method()&amp;quot; works incorrectly if parent closure and outermost class have closures/methods of the same name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3156&quot;&gt;&lt;del&gt;GROOVY-3156&lt;/del&gt;&lt;/a&gt; (it is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-2849&quot; title=&quot;A property name in a nested closure interferes with a class property when refering with &amp;quot;this.prop&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-2849&quot;&gt;&lt;del&gt;GROOVY-2849&lt;/del&gt;&lt;/a&gt;, whose fix has been discussed on JIRA), may be fix for these 2 issues can be looked at/tested together and then whatever conditions are still applicable in that long list, can be moved to their own method.&lt;/p&gt;</comment>
                            <comment id="14465768" author="blackdrag" created="Wed, 3 Dec 2008 12:18:48 +0000"  >&lt;p&gt;I come more and more to the conclusion that ACG is not the right place to do that. ACG should concentrate on the bytecode generation part and should ideally do only minimal other things. Finding if a method call is actually a call() method on a variable is not really part of that business.Things like these should be done in VariableScopeVisitor instead. Meaning the MethodCallExpression should have been transformed there to use the call method and a VariableExpression. And msot important the VariableExpression should have been linked to the defining Variable&lt;/p&gt;</comment>
                            <comment id="14465848" author="roshandawrani" created="Fri, 5 Dec 2008 13:23:07 +0000"  >&lt;p&gt;I think it is a good idea to not clutter ACG with too many things and move some of it back to VariableScopeVaisitor.&lt;/p&gt;

&lt;p&gt;However, there are 4 issues right now with patches that are tested but are ACG based (visitMethodCallExpression() / visitAttributeOrProperty()), so I just wanted to bring up a suggestion.&lt;/p&gt;

&lt;p&gt;How about going ahead with the current patches to fix the functional issues raised in these 4 bugs and open another JIRA to do the internal re-organization to move things out of ACG to wherever it makes more sense. That way, the ACG clean-up can be done in isolation and if there are more such places in ACG that require such clean-up, they can be taken up too (done in isolation, it will be free of the context of all these 4 issues)&lt;/p&gt;

&lt;p&gt;Either way, I am fine with ACG being simplified and would like to give it a try but I wanted to check if it makes sense to you that we first get rid of these 4 bugs functionally and then do the re-organization internally in isolation.&lt;/p&gt;</comment>
                            <comment id="14465930" author="blackdrag" created="Tue, 16 Dec 2008 07:19:07 +0000"  >&lt;p&gt;I merged your fix to 1.5.8 and made also some modification... I moved part of the fix to VariableScopeVisitor, which will now generate the method call for local variables. As a result ACG will no longer have to check if we are in a closure or if should do call() on a local variable.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13619108">GROOVY-11677</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12721356" name="3069_v15x.diff" size="1422" author="roshandawrani" created="Mon, 1 Dec 2008 02:12:21 +0000"/>
                            <attachment id="12722092" name="3069_v16x.diff" size="1423" author="roshandawrani" created="Mon, 1 Dec 2008 02:12:21 +0000"/>
                            <attachment id="12722018" name="3069_v17x.diff" size="1423" author="roshandawrani" created="Mon, 1 Dec 2008 02:12:21 +0000"/>
                            <attachment id="12721491" name="Groovy3069Bug.groovy" size="595" author="roshandawrani" created="Sun, 30 Nov 2008 13:37:35 +0000"/>
                            <attachment id="12721352" name="Ver2_3069Patches.zip" size="3377" author="roshandawrani" created="Mon, 1 Dec 2008 11:18:17 +0000"/>
                            <attachment id="12721982" name="Ver2_Groovy3069Bug.groovy" size="1277" author="roshandawrani" created="Mon, 1 Dec 2008 11:18:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2crjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>