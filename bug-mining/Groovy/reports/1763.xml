<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:25:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5316] @Lazy (LazyASTTransformation) not multi-thread safe</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5316</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I checked out the latest code from git on the master branch, and looking at LazyASTTransformation, it doesn&apos;t appear to be multi-thread safe in the case of an &lt;b&gt;instance&lt;/b&gt; variable annotated with @Lazy.&lt;br/&gt;
specifically:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void create(FieldNode fieldNode, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Expression initExpr) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BlockStatement body = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BlockStatement();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fieldNode.isStatic()) {
            addHolderClassIdiomBody(body, fieldNode, initExpr);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isVolatile(fieldNode)) {
            addNonThreadSafeBody(body, fieldNode, initExpr);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            addDoubleCheckedLockingBody(body, fieldNode, initExpr);
        }
        ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But the JMM makes DCL-locking work &lt;b&gt;with volatile&lt;/b&gt;, i.e. it doesn&apos;t obviate the need for DCL in the case of volatile instance variables.  As written now, it seems the resulting code isn&apos;t multi-thread safe in either case (the source declares the field volatile or not)&lt;br/&gt;
Interestingly enough, @Singleton(&quot;lazy&quot;) (SingletonASTTransformation) does this correctly, by declaring a volatile variable (named &quot;instance&quot;, although static) and then applying the DCL idiom (see #&lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-4782&quot; title=&quot;@Singleton(lazy=true) does not perform the correct double checked locking for Java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-4782&quot;&gt;&lt;del&gt;GROOVY-4782&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;So it looks like the issue is understood but somehow isn&apos;t in @Lazy.&lt;br/&gt;
The fix seems rather straightforward:&lt;br/&gt;
modify the @Lazy FieldNode to always be volatile (whether declared volatile or not in the source)&lt;br/&gt;
and then create becomes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void create(FieldNode fieldNode, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Expression initExpr) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BlockStatement body = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BlockStatement();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fieldNode.isStatic()) {
            addHolderClassIdiomBody(body, fieldNode, initExpr);
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            addDoubleCheckedLockingBody(body, fieldNode, initExpr);
        ...        
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12818153">GROOVY-5316</key>
            <summary>@Lazy (LazyASTTransformation) not multi-thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="thurston">thurston n</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Feb 2012 12:08:21 +0000</created>
                <updated>Sun, 13 May 2012 03:30:05 +0000</updated>
                            <resolved>Sun, 19 Feb 2012 05:14:26 +0000</resolved>
                                    <version>2.0-beta-2</version>
                                    <fixVersion>2.0-beta-3</fixVersion>
                    <fixVersion>1.8.7</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14479816" author="paulk" created="Sun, 19 Feb 2012 05:14:26 +0000"  >&lt;p&gt;Hi, the code is as designed - the &quot;isVolatile&quot; method has the wrong name by accident - it functions correctly but should have exactly the opposite name (ouch!). I have renamed it to &quot;notVolatile&quot; which is what it does. Thanks for noticing this ugly &quot;typo&quot;.&lt;/p&gt;

&lt;p&gt;If you leave out &quot;volatile&quot; you will indeed get a non-thread safe lazy implementation by design for those use cases where you want the simplest possible lazy instantation of your field and know that it won&apos;t be used in a multi-threaded environment. Always use volatile when you want the thread-safe version.&lt;/p&gt;</comment>
                            <comment id="14472538" author="thurston" created="Wed, 22 Feb 2012 04:15:46 +0000"  >&lt;p&gt;My bad.  I did look at isVolatile and obviously it didn&apos;t register.&lt;br/&gt;
It does point out that FieldNode should be refactored to be more OO; isVolatile(), isFinal(), etc. should be added directly to the FieldNode class itself (modifiers can still be left exposed of course).  Not doing so just invites a proliferation of little is(Not)Volatile methods, and all the attendant trouble &lt;/p&gt;

&lt;p&gt;And although the choice you made about interpreting the source&apos;s use of &lt;b&gt;volatile&lt;/b&gt; is certainly reasonable, it might be helpful to add that explicitly to the JavaDoc; I&apos;m just thinking about all the dead bytes that have been spent on explaining DCL.  It&apos;s probably asking too much to expect users to look at the bytecode (I did and look where it got me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;</comment>
                            <comment id="14472577" author="blackdrag" created="Wed, 22 Feb 2012 04:22:03 +0000"  >&lt;p&gt;normally there is no need for an extra isVolatile method, since the Java class Modifier provides methods for that. We use exactly the same modifiers as Java does, so it is no problem to reuse that class&lt;/p&gt;</comment>
                            <comment id="14479819" author="paulk" created="Wed, 22 Feb 2012 06:25:04 +0000"  >&lt;p&gt;This issue is already closed, so just a Post-Mortem comment. FieldNode already has isFinal() - and now in 2.0 has isVolatile() - as a general rule though, given that Modifier#isVolatile() already exists, we tend to only push such functionality into classes like FieldNode if it is widely enough used that the shortcut adds a lot to code clarity - in this instance I think it is only marginally clearer - but it certainly is a little more consistent.&lt;/p&gt;</comment>
                            <comment id="14472598" author="thurston" created="Wed, 22 Feb 2012 08:58:28 +0000"  >&lt;p&gt;Sorry, I tried posting this to groovy-dev mailing list but it got rejected (even though I successfully subscribed via xircles):&lt;/p&gt;

&lt;p&gt;As part of a @Lazy thread-safety discussion, it got me to thinking, &quot;how would you test this?&quot;.&lt;br/&gt;
As far as I can tell, the tests of ASTTransformations rely on shell.evaluate(&quot;&quot;&quot;source&quot;&quot;&quot;), but that&apos;s not going to cut it in the case of the above issue.&lt;br/&gt;
I&apos;m assuming at some point you can access the entire AST before it gets &quot;written&quot; and then you could walk the AST tree, but it sure seems like that would lead to some very brittle tests (you wouldn&apos;t want every compiler optimization to produce a slew of test failures).  &lt;br/&gt;
So how ideally would you go about testing similar issues?&lt;/p&gt;

&lt;p&gt;In a somewhat related vein, apropos of Jochen&apos;s work on invokedynamic support, how is that planning to be integrated in a common codebase that needs to support &amp;lt; 1.7?  Will it be an argument to groovyc?  or will groovyc rely on runtime detection of java.version?  I&apos;m assuming that the bytecode itself will not do runtime detection (on initial thought that would be a nightmare) &lt;/p&gt;</comment>
                            <comment id="14472529" author="blackdrag" created="Wed, 22 Feb 2012 09:10:51 +0000"  >&lt;p&gt;We intend to make two distributions, one which has support for indy, the other not. But basically you will have an option &quot;useIndy&quot; for this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c5hz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>