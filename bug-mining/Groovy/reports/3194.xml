<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:54:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7402] Compiler NPE Related To AST Transformations And Traits</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7402</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Related to &lt;a href=&quot;https://github.com/grails/grails-core/issues/663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grails/grails-core/issues/663&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The attached traitannotation.zip includes the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;src/main/groovy/demo/SomeTrait.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; demo

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.*

@Immutable
trait SomeTrait {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;src/main/groovy/demo/SomeClass.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; demo

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SomeClass &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; SomeTrait {}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Compilation raises an NPE:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ./gradlew clean cG
:clean
:compileJava UP-TO-DATE
:compileGroovy FAILED

FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task &apos;:compileGroovy&apos;.
&amp;gt; BUG! exception in phase &apos;instruction selection&apos; in source unit &apos;/Users/jeff/traitannotation/src/main/groovy/demo/SomeTrait.groovy&apos; unexpected NullpointerException

* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.

BUILD FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12823965">GROOVY-7402</key>
            <summary>Compiler NPE Related To AST Transformations And Traits</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="jeffscottbrown">Jeff Scott Brown</reporter>
                        <labels>
                    </labels>
                <created>Sat, 25 Apr 2015 06:08:50 +0000</created>
                <updated>Sat, 18 Mar 2017 09:56:53 +0000</updated>
                            <resolved>Wed, 1 Mar 2017 13:14:31 +0000</resolved>
                                    <version>2.4.3</version>
                                    <fixVersion>2.4.10</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14567015" author="graemerocher1" created="Mon, 1 Jun 2015 07:29:18 +0000"  >&lt;p&gt;For some reason via Gradle it is not possible to get the root cause stack trace, I attached a debugger to the Gradle process and was able to get a reference to the original exception and trace which is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.lang.NullPointerException
	at org.codehaus.groovy.transform.trait.TraitASTTransformation$PostTypeCheckingExpressionReplacer.transform(TraitASTTransformation.java:554)
	at org.codehaus.groovy.ast.ClassCodeExpressionTransformer.visitField(ClassCodeExpressionTransformer.java:65)
	at org.codehaus.groovy.ast.ClassNode.visitContents(ClassNode.java:1075)
	at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitClass(ClassCodeVisitorSupport.java:50)
	at org.codehaus.groovy.transform.trait.TraitASTTransformation$1.call(TraitASTTransformation.java:264)
	at org.codehaus.groovy.control.CompilationUnit.applyToPrimaryClassNodes(CompilationUnit.java:1052)
	... 84 more

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14567018" author="melix" created="Mon, 1 Jun 2015 07:33:25 +0000"  >&lt;p&gt;Is is still not recommended to use AST xforms in combination with traits, unless they are explicitly listed as compatible (like &lt;tt&gt;@CompileStatic&lt;/tt&gt;. There are several reasons for this, both technical and logical: would an AST xform be applied on the trait itself, or on the class which implements the trait? Should the annotation still be visible? ... There are lots of unanswered questions here which are not so easy to answer.&lt;/p&gt;</comment>
                            <comment id="14567026" author="graemerocher1" created="Mon, 1 Jun 2015 07:39:38 +0000"  >&lt;p&gt;Understood, I guess the confusion here from the user perspective is it works in a previous version of Groovy. If it isn&apos;t going to be allowed I would suggest a better compilation error&lt;/p&gt;</comment>
                            <comment id="14567031" author="melix" created="Mon, 1 Jun 2015 07:42:53 +0000"  >&lt;p&gt;It&apos;s interesting to know it worked in a previous version of Groovy. I&apos;m not sure we can improve the error message in a short timeframe (because errors thrown from AST xforms are hard to catch), but if it used to work, there&apos;s certainly something we can do.&lt;/p&gt;</comment>
                            <comment id="15827527" author="digitarts" created="Wed, 18 Jan 2017 07:17:31 +0000"  >&lt;p&gt;Hi, guys, after upgrading from 2.4.7 to 2.4.8, I got an NPE during gradle compilation.&lt;/p&gt;

&lt;p&gt;The most important is I did not use AST xforms on the trait, so I think it should be a new bug but similar to this one.&lt;/p&gt;

&lt;p&gt;Please see my &lt;a href=&quot;https://github.com/zhanghuabin/groovy248-npe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sample project&lt;/a&gt; to reproduce the problem.&lt;/p&gt;</comment>
                            <comment id="15829693" author="paulk" created="Thu, 19 Jan 2017 10:32:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=digitarts&quot; class=&quot;user-hover&quot; rel=&quot;digitarts&quot;&gt;digitarts&lt;/a&gt;, I haven&apos;t yet investigated your sample project but please raise a new issue. If you look at the Trait documentation, it says, &quot;Traits only support public and private methods. Neither protected nor package private scopes are supported.&quot; I guess we should clarify what that means for the protected property that you have used. I suspect that 2.4.7 and 2.4.8 might have slightly different assumptions in that case. It might end up being a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8048&quot; title=&quot;final fields for pre-compiled traits aren&amp;#39;t processed correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8048&quot;&gt;&lt;del&gt;GROOVY-8048&lt;/del&gt;&lt;/a&gt; but I think it is worth investigating separately.&lt;/p&gt;</comment>
                            <comment id="15829762" author="digitarts" created="Thu, 19 Jan 2017 11:44:21 +0000"  >&lt;p&gt;Thanks, Paul, your solution works well: change protected to public.&lt;/p&gt;</comment>
                            <comment id="15840877" author="paulk" created="Fri, 27 Jan 2017 03:02:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=digitarts&quot; class=&quot;user-hover&quot; rel=&quot;digitarts&quot;&gt;digitarts&lt;/a&gt; I created this issue to track producing a better error message for protected fields: &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8066&quot; title=&quot;protected fields should be disallowed in traits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8066&quot;&gt;&lt;del&gt;GROOVY-8066&lt;/del&gt;&lt;/a&gt;. Previously, they weren&apos;t really supported but the modifier was being ignored and treated as private. Whereas protected methods gave the correct error message.&lt;/p&gt;</comment>
                            <comment id="15871641" author="paulk" created="Fri, 17 Feb 2017 10:44:46 +0000"  >&lt;p&gt;This turns out to be separate from &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8066&quot; title=&quot;protected fields should be disallowed in traits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8066&quot;&gt;&lt;del&gt;GROOVY-8066&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8048&quot; title=&quot;final fields for pre-compiled traits aren&amp;#39;t processed correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8048&quot;&gt;&lt;del&gt;GROOVY-8048&lt;/del&gt;&lt;/a&gt;. It is triggered by having @Immutable on the trait and we don&apos;t support most AST transforms (including @Immutable) in conjunction with traits. We can step around the NPE fairly easily but then the current behavior for annotations on traits kicks in which is to copy any annotations from the trait to the trait helper class. The issue then is that in this case, the abstract helper class is made final by @Immutable and a class can&apos;t be both abstract and final. The compiler has checks for such illegal modifier combinations but they aren&apos;t currently run on generated classes.&lt;/p&gt;

&lt;p&gt;We could re-jig the annotation copying behavior to make this case work but it would probably break other cases.&lt;/p&gt;

&lt;p&gt;We can in the short-term catch some of these errors and produce compiler warnings.&lt;/p&gt;

&lt;p&gt;A more general solution would be to have a mechanism to specify where annotations on the trait might be targeted: on the trait itself, a class implementing a trait, the helper or field helper etc. but that is a bigger piece of work.&lt;/p&gt;</comment>
                            <comment id="15873017" author="githubbot" created="Sat, 18 Feb 2017 06:35:48 +0000"  >&lt;p&gt;GitHub user paulk-asert opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/499&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7402&quot; title=&quot;Compiler NPE Related To AST Transformations And Traits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7402&quot;&gt;&lt;del&gt;GROOVY-7402&lt;/del&gt;&lt;/a&gt;: Compiler NPE Related To AST Transformations And Traits&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/paulk-asert/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/paulk-asert/groovy&lt;/a&gt; groovy7402&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/499.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/499.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #499&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9851c82a2b3cb2ae4d914daa523b9adc11faff0c&lt;br/&gt;
Author: paulk &amp;lt;paulk@asert.com.au&amp;gt;&lt;br/&gt;
Date:   2017-02-18T06:17:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7402&quot; title=&quot;Compiler NPE Related To AST Transformations And Traits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7402&quot;&gt;&lt;del&gt;GROOVY-7402&lt;/del&gt;&lt;/a&gt;: Compiler NPE Related To AST Transformations And Traits&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15873018" author="paulk" created="Sat, 18 Feb 2017 06:42:45 +0000"  >&lt;p&gt;I checked Groovy 2.3.0, the first release to contain traits, and combining @Immutable and traits (using the above example) resulted in the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ClassFormatError: Illegal &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;modifiers in &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SomeTrait: 0x1419
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The problem is the &lt;tt&gt;SomeTrait$Trait$Helper&lt;/tt&gt; inner class within &lt;tt&gt;SomeTrait&lt;/tt&gt; is both abstract and final.&lt;/p&gt;

&lt;p&gt;The proposed PR removes the NPE and changes the above error to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Error during @Immutable processing: annotation found on inappropriate &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SomeTrait$Trait$Helper
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I guess this could be improved a bit further but I think is an incremental improvement over what we have had in the past.&lt;/p&gt;</comment>
                            <comment id="15890120" author="githubbot" created="Wed, 1 Mar 2017 13:07:28 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/499&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15890137" author="paulk" created="Wed, 1 Mar 2017 13:14:31 +0000"  >&lt;p&gt;Proposed PR merged. Instead of a ClassFormatError or NPE in earlier versions of Groovy, there is now at least an error message. As we continue to  look at ways to better support combining traits and AST transformations, we can work out the semantics would be for @Immutable or improve the error message. I&apos;ll mark as resolved for now. Please reopen if you disagree.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12728134" name="traitannotation.zip" size="50754" author="jeffscottbrown" created="Sat, 25 Apr 2015 06:11:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dr53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>