<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:20:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9541] Compiling statically using GroovyClassLoader does not always respect the configured parent ClassLoader</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9541</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When using&#160;GroovyClassLoader to parse a groovy script annotated with @CompileStatic, the static type checker does not seem to use the configured parent class loader. Instead it uses the thread context ClassLoader. This sometimes causes compilation failures (especially when Closures are present) in environments like OSGi, where the thread context ClassLoader is definitely not the desired ClassLoader.&lt;br/&gt;
 For example this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (GroovyClassLoader classLoader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader(bundleClassLoader,
                compilerConfiguration))
{
    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; scriptClass = classLoader.parseClass(scriptContent, scriptName);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;can fail like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: java.lang.NoClassDefFoundError: groovy/lang/GroovyObject
        at org.codehaus.groovy.control.CompilationUnit$IPrimaryClassNodeOperation.doPhaseOperation(CompilationUnit.java:955)
        at org.codehaus.groovy.control.CompilationUnit.processPhaseOperations(CompilationUnit.java:650)
        at org.codehaus.groovy.control.CompilationUnit.compile(CompilationUnit.java:627)
        at groovy.lang.GroovyClassLoader.doParseClass(GroovyClassLoader.java:389)
        at groovy.lang.GroovyClassLoader.lambda$parseClass$3(GroovyClassLoader.java:332)
        at org.codehaus.groovy.runtime.memoize.StampedCommonCache.compute(StampedCommonCache.java:163)
        at org.codehaus.groovy.runtime.memoize.StampedCommonCache.getAndPut(StampedCommonCache.java:154)
        at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:330)
        at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:314)
        at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:257)
        ....
Caused by: java.lang.NoClassDefFoundError: groovy/lang/GroovyObject
        at java.lang.ClassLoader.defineClass1(Native Method)
        at java.lang.ClassLoader.defineClass(ClassLoader.java:757)
        at java.lang.ClassLoader.defineClass(ClassLoader.java:636)
        at groovy.lang.GroovyClassLoader.defineClass(GroovyClassLoader.java:733)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingSupport.evaluateExpression(StaticTypeCheckingSupport.java:2176)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.checkClosureWithDelegatesTo(StaticTypeCheckingVisitor.java:3101)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitMethodCallArguments(StaticTypeCheckingVisitor.java:2645)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitMethodCallExpression(StaticTypeCheckingVisitor.java:3482)
        at org.codehaus.groovy.transform.sc.StaticCompilationVisitor.visitMethodCallExpression(StaticCompilationVisitor.java:409)
        at org.codehaus.groovy.ast.expr.MethodCallExpression.visit(MethodCallExpression.java:76)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitBinaryExpression(StaticTypeCheckingVisitor.java:770)
        at org.codehaus.groovy.ast.CodeVisitorSupport.visitDeclarationExpression(CodeVisitorSupport.java:335)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitDeclarationExpression(ClassCodeVisitorSupport.java:150)
        at org.codehaus.groovy.ast.expr.DeclarationExpression.visit(DeclarationExpression.java:89)
        at org.codehaus.groovy.ast.CodeVisitorSupport.visitExpressionStatement(CodeVisitorSupport.java:117)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitExpressionStatement(ClassCodeVisitorSupport.java:200)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitExpressionStatement(StaticTypeCheckingVisitor.java:2120)
        at org.codehaus.groovy.ast.stmt.ExpressionStatement.visit(ExpressionStatement.java:40)
        at org.codehaus.groovy.ast.CodeVisitorSupport.visitBlockStatement(CodeVisitorSupport.java:86)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitBlockStatement(ClassCodeVisitorSupport.java:164)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitBlockStatement(StaticTypeCheckingVisitor.java:3825)
        at org.codehaus.groovy.ast.stmt.BlockStatement.visit(BlockStatement.java:69)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitClassCodeContainer(ClassCodeVisitorSupport.java:138)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitConstructorOrMethod(ClassCodeVisitorSupport.java:111)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitConstructorOrMethod(StaticTypeCheckingVisitor.java:2109)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitMethod(ClassCodeVisitorSupport.java:106)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.startMethodInference(StaticTypeCheckingVisitor.java:2477)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitMethod(StaticTypeCheckingVisitor.java:2435)
        at org.codehaus.groovy.transform.sc.StaticCompilationVisitor.visitMethod(StaticCompilationVisitor.java:235)
        at org.codehaus.groovy.ast.ClassNode.visitMethods(ClassNode.java:1100)
        at org.codehaus.groovy.ast.ClassNode.visitContents(ClassNode.java:1093)
        at org.codehaus.groovy.ast.ClassCodeVisitorSupport.visitClass(ClassCodeVisitorSupport.java:52)
        at org.codehaus.groovy.transform.stc.StaticTypeCheckingVisitor.visitClass(StaticTypeCheckingVisitor.java:405)
        at org.codehaus.groovy.transform.sc.StaticCompilationVisitor.visitClass(StaticCompilationVisitor.java:193)
        at org.codehaus.groovy.transform.sc.StaticCompileTransformation.visit(StaticCompileTransformation.java:65)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at org.codehaus.groovy.runtime.callsite.PlainObjectMetaMethodSite.doInvoke(PlainObjectMetaMethodSite.java:43)
        at org.codehaus.groovy.runtime.callsite.PojoMetaMethodSite$PojoCachedMethodSite.invoke(PojoMetaMethodSite.java:191)
        at org.codehaus.groovy.runtime.callsite.PojoMetaMethodSite.call(PojoMetaMethodSite.java:56)
        at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:148)
        at org.codehaus.groovy.control.customizers.ASTTransformationCustomizer.call(ASTTransformationCustomizer.groovy:297)
        at org.codehaus.groovy.control.CompilationUnit$IPrimaryClassNodeOperation.doPhaseOperation(CompilationUnit.java:921)
        ... 30 more
Caused by: java.lang.ClassNotFoundException: groovy.lang.GroovyObject
        at java.net.URLClassLoader.findClass(URLClassLoader.java:382)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:419)
        at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:869)
        at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:979)
        at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:967)
        ... 75 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This can happen if the compilation has been triggered by a thread started by another OSGi bundle that does not import groovy packages, even though the GroovyClassLoader has been explicitly created with the correct parent ClassLoader that can indeed access those packages.&lt;/p&gt;

&lt;p&gt;So far I have tracked the issue to &lt;tt&gt;org.codehaus.groovy.transform.stc.StaticTypeCheckingSupport#evaluateExpression(final Expression, final CompilerConfiguration)&lt;/tt&gt;&lt;br/&gt;
 where it creates a CompilationUnit without giving it a ClassLoader, which results in the CompilationUnit creating a default GroovyClassLoader with parent set to the thread context ClassLoader. I think that&#160;StaticTypeCheckingSupport should be able to pass the parent ClassLoader that the original GroovyClassLoader was configured with in order to avoid unexpected results.&lt;/p&gt;

&lt;p&gt;I don&apos;t know whether there are more places during static type checking where the issue could occur.&lt;/p&gt;

&lt;p&gt;The current workaround for this issue is to temporarily change the thread&apos;s context ClassLoader to the one that is given to the GroovyClassLoader before compiling a script, and then restoring the original context ClassLoader. This is, however, probably not possible in all environments.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13302863">GROOVY-9541</key>
            <summary>Compiling statically using GroovyClassLoader does not always respect the configured parent ClassLoader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="latanasov">Lyuben Atanasov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 May 2020 12:45:19 +0000</created>
                <updated>Fri, 10 Feb 2023 21:40:01 +0000</updated>
                            <resolved>Tue, 8 Nov 2022 15:05:16 +0000</resolved>
                                    <version>3.0.3</version>
                                    <fixVersion>3.0.14</fixVersion>
                    <fixVersion>4.0.7</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17621275" author="jonnybot" created="Thu, 20 Oct 2022 17:26:52 +0000"  >&lt;p&gt;I have encountered this issue as well. Specifically, scripts importing classes in my app that use the &lt;tt&gt;@Canonical&lt;/tt&gt; or &lt;tt&gt;@Immutable&lt;/tt&gt; annotations will fail to compile in certain contexts. This seems to be because those annotations set the &lt;tt&gt;mode&lt;/tt&gt; parameter on &lt;tt&gt;AnnotationCollector&lt;/tt&gt;. Doing that triggers a call to &lt;tt&gt;StaticTypeCheckingSupport.evaluateExpression&lt;/tt&gt; from the &lt;tt&gt;ASTTransformationCollectorCodeVisitor#findCollectedAnnotations&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;In many circumstances, this works fine, but some contexts it won&apos;t, resulting in the above NoClassDefFoundError. We&apos;ve had to work around this bug in other places by temporarily changing the thread&apos;s context classloader, as noted.&lt;/p&gt;</comment>
                            <comment id="17621386" author="emilles" created="Thu, 20 Oct 2022 22:22:43 +0000"  >&lt;p&gt;evaluateExpression is a static method and no ClassLoader is available through its parameters. &lt;/p&gt;</comment>
                            <comment id="17623240" author="erdi" created="Mon, 24 Oct 2022 15:11:15 +0000"  >&lt;p&gt;But maybe it should take a class loader as one of its params, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt;? Maybe rather than just take the compiler configuration it should also take a class loader which would be whatever the class loader on the &lt;tt&gt;SourceUnit&lt;/tt&gt; at the call site is (this method is always called with the result of &lt;tt&gt;SourceUnit.getConfiguration()&lt;/tt&gt; from what I can tell) and pass it to the constructor of &lt;tt&gt;CompilationUnit&lt;/tt&gt;? This method is always called in the context of a compilation from what I can tell with a compilation class loader already specified on the &lt;tt&gt;SourceUnit&lt;/tt&gt; so why ignore that and use a context classloader or, if not set, the class loader that loaded &lt;tt&gt;ProcessingUnit&lt;/tt&gt; which is what &lt;tt&gt;org.codehaus.groovy.control.ProcessingUnit.setClassLoader()&lt;/tt&gt; does?&lt;/p&gt;</comment>
                            <comment id="17623246" author="erdi" created="Mon, 24 Oct 2022 15:23:22 +0000"  >&lt;p&gt;Would a PR with what I wrote in my previous comment have a chance of being considered?&lt;/p&gt;</comment>
                            <comment id="17623456" author="emilles" created="Mon, 24 Oct 2022 23:23:43 +0000"  >&lt;p&gt;I&#8217;m not sure I understand what you are proposing. I don&#8217;t think evaluateExpression was intended to be used outside of ClosureParams and DekegatesTo checks. I have seen issues with its use in the fork-join pool, which does not have context class loader that is useful to groovy. &lt;/p&gt;</comment>
                            <comment id="17623668" author="erdi" created="Tue, 25 Oct 2022 08:47:53 +0000"  >&lt;p&gt;I get that &lt;tt&gt;evaluateExpression&lt;/tt&gt; was not intended to be used outside of &lt;tt&gt;ClosureParams&lt;/tt&gt; and &lt;tt&gt;DelegatesTo&lt;/tt&gt; checks. All I&apos;m saying is that where it is being used in Groovy&apos;s codebase (and I know it&apos;s a public method on a public class so there is a backwards compatibility concern) there is always a compilation class loader available that can be obtained from the &lt;tt&gt;SourceUnit&lt;/tt&gt; instance which is in scope and I&apos;m surprised that it is not being used and a context class loader is being used instead.&lt;/p&gt;

&lt;p&gt;Anyway, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonnybot&quot; class=&quot;user-hover&quot; rel=&quot;jonnybot&quot;&gt;jonnybot&lt;/a&gt; is already working on a PR for this so it will probably be clearer what we mean when that&apos;s open and we can discuss there. Thanks Eric.&lt;/p&gt;</comment>
                            <comment id="17623826" author="emilles" created="Tue, 25 Oct 2022 13:23:06 +0000"  >&lt;p&gt;Each location that it is used must be considered carefully. The transform loader may or may not be the proper choice versus the project loader. &lt;/p&gt;</comment>
                            <comment id="17624051" author="jonnybot" created="Tue, 25 Oct 2022 21:24:40 +0000"  >&lt;p&gt;I&apos;ve opened a PR at &lt;a href=&quot;https://github.com/apache/groovy/pull/1814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/1814&lt;/a&gt; to try &amp;amp; address this. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; is quite right about considering each case. I had to do some jiggery pokery to get &lt;tt&gt;org.codehaus.groovy.transform.ASTTransformationCollectorCodeVisitor#findCollectedAnnotations&lt;/tt&gt; to work with the source unit&apos;s classloader. I &lt;em&gt;do&lt;/em&gt; think using the source unit&apos;s classloader is the correct choice there. However, my workaround for the resulting compilation issue may not be ideal. I figured a PR might be a better spot for this discussion at this point. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17630479" author="emilles" created="Tue, 8 Nov 2022 15:05:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/bf405f70bc8b2ff24150f8d5249023a29da224ed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/bf405f70bc8b2ff24150f8d5249023a29da224ed&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/commit/bc0a240bc801f31833e80ed01d9c1a27d25fe984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/bc0a240bc801f31833e80ed01d9c1a27d25fe984&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ee48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>