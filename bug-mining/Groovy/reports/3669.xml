<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:04:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8562] Wrong Closure delegation for property access when using @CompileStatic and DELEGATE_FIRST / DELEGATE_ONLY</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8562</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Closures resolve to owner property although `DELEGATE_FIRST` or `DELEGATE_ONLY` are set as `resolveStrategy`.&lt;br/&gt;
 This only happens when `@CompileStatic` is used.&lt;br/&gt;
 This does not apply to method calls.&lt;br/&gt;
 For Groovy 2.3.11 this only affects read operations.&lt;/p&gt;

&lt;p&gt;Only the versions 2.5.0-rc-1, 2.4.15, 2.3.11 have been tested yet.&lt;br/&gt;
 I will add tests for newer versions, but this requires a different test framework than Spock.&lt;/p&gt;

&lt;p&gt;I have created a demo project at &lt;a href=&quot;https://github.com/MeneDev/groovy-bugreport-closure-strategy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MeneDev/groovy-bugreport-closure-strategy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ADelegate {
    def x = &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;AClass {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &amp;lt;T&amp;gt; T closureExecuter(
            ADelegate d,
            @DelegatesTo(value = ADelegate, strategy = DELEGATE_ONLY) Closure&amp;lt;T&amp;gt; c) {
        c.resolveStrategy = DELEGATE_ONLY
        c.delegate = d
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; c()
    }

    def x = &lt;span class=&quot;code-quote&quot;&gt;&quot;owner&quot;&lt;/span&gt;
    
    def test() {
        def theDelegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ADelegate()
        def res = closureExecuter(theDelegate) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; x
        }
        
        &lt;span class=&quot;code-comment&quot;&gt;// is &lt;span class=&quot;code-quote&quot;&gt;&quot;owner&quot;&lt;/span&gt; instead of &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; res
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13155729">GROOVY-8562</key>
            <summary>Wrong Closure delegation for property access when using @CompileStatic and DELEGATE_FIRST / DELEGATE_ONLY</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="Mene">Michael Arndt</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Apr 2018 15:16:21 +0000</created>
                <updated>Thu, 26 Jul 2018 04:38:57 +0000</updated>
                            <resolved>Thu, 24 May 2018 14:11:08 +0000</resolved>
                                    <version>2.3.11</version>
                    <version>2.6.0-alpha-3</version>
                    <version>3.0.0-alpha-2</version>
                    <version>2.5.0-rc-1</version>
                    <version>2.4.15</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>Static compilation</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16467885" author="mene" created="Tue, 8 May 2018 19:55:21 +0000"  >&lt;p&gt;I have&#160;changed the test project to jUnit to test latest 2.6.x / 3.0.x, also affected&lt;/p&gt;</comment>
                            <comment id="16467956" author="paulk" created="Tue, 8 May 2018 20:56:17 +0000"  >&lt;p&gt;Doesn&apos;t matter now but the 1.2-groovy-2.4-SNAPSHOT version of Spock (from &lt;a href=&quot;http://oss.sonatype.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://oss.sonatype.org/content/repositories/snapshots/&lt;/a&gt;) works with Groovy 2.6/3.0.&lt;/p&gt;</comment>
                            <comment id="16477872" author="mene" created="Wed, 16 May 2018 18:30:15 +0000"  >&lt;p&gt;Good to know! Working without Spock&#160;for&#160;data-driven makes you appreciate it even more &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16477880" author="mene" created="Wed, 16 May 2018 18:33:08 +0000"  >&lt;p&gt;Looked into it. I fixed the first case, but it breaks 28 other tests. But I have gained a basic understanding of the problem:&lt;/p&gt;

&lt;p&gt;For&#160;StaticTypeCheckingVisitor the VariableExpression&#160;is a&#160;FieldNode and the&#160;IMPLICIT_RECEIVER is never set.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/MeneDev/groovy/commit/0a47728777a15bfa986b89da7495c858396e737f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MeneDev/groovy/commit/0a47728777a15bfa986b89da7495c858396e737f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16479448" author="mene" created="Thu, 17 May 2018 17:46:22 +0000"  >&lt;p&gt;Reading properties is fixed, writing still bogous:&#160;&lt;a href=&quot;https://github.com/MeneDev/groovy/commit/5b73488561641cc5b94b4642f126c216675e2040&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MeneDev/groovy/commit/5b73488561641cc5b94b4642f126c216675e2040&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16487160" author="mene" created="Wed, 23 May 2018 12:22:25 +0000"  >&lt;p&gt;PR is open &lt;a href=&quot;https://github.com/apache/groovy/pull/717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/717&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16487831" author="githubbot" created="Wed, 23 May 2018 18:45:15 +0000"  >&lt;p&gt;Github user danielsun1106 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/717#discussion_r190359237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/717#discussion_r190359237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java &amp;#8212;&lt;br/&gt;
    @@ -596,6 +597,26 @@ public void visitVariableExpression(VariableExpression vexp) {&lt;br/&gt;
             } else if (accessedVariable instanceof FieldNode) {&lt;br/&gt;
                 FieldNode fieldNode = (FieldNode) accessedVariable;&lt;/p&gt;

&lt;p&gt;    +            TypeCheckingContext.EnclosingClosure enclosingClosure = typeCheckingContext.getEnclosingClosure();&lt;br/&gt;
    +            if (enclosingClosure != null) {&lt;br/&gt;
    +                // &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8562&quot; title=&quot;Wrong Closure delegation for property access when using @CompileStatic and DELEGATE_FIRST / DELEGATE_ONLY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8562&quot;&gt;&lt;del&gt;GROOVY-8562&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +                // when vexp has the same name as a property of the owner,&lt;br/&gt;
    +                // the IMPLICIT_RECEIVER must be set in case it&apos;s the delegate&lt;br/&gt;
    +                if (tryVariableExpressionAsProperty(vexp, vexp.getName())) {&lt;br/&gt;
    +                    // IMPLICIT_RECEIVER is handled elsewhere&lt;br/&gt;
    +                    // however other access needs to be fixed for private access&lt;br/&gt;
    +                    if (vexp.getNodeMetaData(StaticTypesMarker.IMPLICIT_RECEIVER) == null) {&lt;br/&gt;
    +                        boolean lhsOfEnclosingAssignment = isLHSOfEnclosingAssignment(vexp);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `lhsOfEnclosingAssignment` seems to be able to inline&lt;/p&gt;</comment>
                            <comment id="16487836" author="githubbot" created="Wed, 23 May 2018 18:46:54 +0000"  >&lt;p&gt;Github user danielsun1106 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/717#discussion_r190359768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/717#discussion_r190359768&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java &amp;#8212;&lt;br/&gt;
    @@ -596,6 +597,26 @@ public void visitVariableExpression(VariableExpression vexp) {&lt;br/&gt;
             } else if (accessedVariable instanceof FieldNode) {&lt;br/&gt;
                 FieldNode fieldNode = (FieldNode) accessedVariable;&lt;/p&gt;

&lt;p&gt;    +            TypeCheckingContext.EnclosingClosure enclosingClosure = typeCheckingContext.getEnclosingClosure();&lt;br/&gt;
    +            if (enclosingClosure != null) {&lt;br/&gt;
    +                // &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8562&quot; title=&quot;Wrong Closure delegation for property access when using @CompileStatic and DELEGATE_FIRST / DELEGATE_ONLY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8562&quot;&gt;&lt;del&gt;GROOVY-8562&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +                // when vexp has the same name as a property of the owner,&lt;br/&gt;
    +                // the IMPLICIT_RECEIVER must be set in case it&apos;s the delegate&lt;br/&gt;
    +                if (tryVariableExpressionAsProperty(vexp, vexp.getName())) {&lt;br/&gt;
    +                    // IMPLICIT_RECEIVER is handled elsewhere&lt;br/&gt;
    +                    // however other access needs to be fixed for private access&lt;br/&gt;
    +                    if (vexp.getNodeMetaData(StaticTypesMarker.IMPLICIT_RECEIVER) == null) {&lt;br/&gt;
    +                        boolean lhsOfEnclosingAssignment = isLHSOfEnclosingAssignment(vexp);&lt;br/&gt;
    +                        ClassNode owner = (ClassNode) vexp.getNodeMetaData(StaticCompilationMetadataKeys.PROPERTY_OWNER);&lt;br/&gt;
    +                        if (owner != null) {&lt;br/&gt;
    +                            fieldNode = owner.getField(vexp.getName());&lt;br/&gt;
    +                            vexp.setAccessedVariable(fieldNode);&lt;br/&gt;
    +                            checkOrMarkPrivateAccess(vexp, fieldNode, lhsOfEnclosingAssignment);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `lhsOfEnclosingAssignment` is only used here(in the `if` block)&lt;/p&gt;</comment>
                            <comment id="16489075" author="paulk" created="Thu, 24 May 2018 14:11:08 +0000"  >&lt;p&gt;Proposed PR merged. Thanks!&lt;/p&gt;</comment>
                            <comment id="16489211" author="mene" created="Thu, 24 May 2018 15:27:32 +0000"  >&lt;p&gt;Cool, thanks for the quick merge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3t3yv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>