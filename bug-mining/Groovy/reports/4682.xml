<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:22:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-11079] GroovyCastException on closure implementing Consumer</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-11079</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I&apos;m having trouble making a minimal repro for this one, but here&apos;s the actual code. Libraries are PDFBox (PDDocument) and Vavr. The bytecode problem seems to be that although 31 pushes &lt;tt&gt;null&lt;/tt&gt; onto the stack, it&apos;s popped before being cast to &lt;tt&gt;Void&lt;/tt&gt;, leaving the &lt;tt&gt;String&lt;/tt&gt; on top. Shouldn&apos;t these be reversed?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
loadOriginal(ep.payload)
  .onSuccess { sps.envelope.filename = it._1 }  &lt;span class=&quot;code-comment&quot;&gt;// exception thrown at the end of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; closure
&lt;/span&gt;  .&amp;lt;PDDocument&amp;gt; map(Tuple2::_2)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.codehaus.groovy.runtime.typehandling.GroovyCastException: Cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; object &lt;span class=&quot;code-quote&quot;&gt;&apos;dummy.pdf&apos;&lt;/span&gt; with class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&apos;&lt;/span&gt; to class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&apos;&lt;/span&gt;
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.continueCastOnSAM(DefaultTypeTransformation.java:424)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.continueCastOnNumber(DefaultTypeTransformation.java:335)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.castToType(DefaultTypeTransformation.java:255)
	at org.codehaus.groovy.vmplugin.v8.IndyInterface.fromCache(IndyInterface.java:321)
	at com.example.EsignFinisherImpl$_notifySignatureApplied_closure2$_closure11.doCall(EsignFinisherImpl.groovy:70)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt; doCall(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;);
    descriptor: (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;;
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=3, locals=3, args_size=2
         0: aload_1
         1: checkcast     #35                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;io/vavr/Tuple2
&lt;/span&gt;         4: getfield      #38                 &lt;span class=&quot;code-comment&quot;&gt;// Field io/vavr/Tuple2._1:Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;         7: dup
         8: astore_2
         9: aload_0
        10: getfield      #27                 &lt;span class=&quot;code-comment&quot;&gt;// Field sps:Lgroovy/lang/Reference;
&lt;/span&gt;        13: invokevirtual #44                 &lt;span class=&quot;code-comment&quot;&gt;// Method groovy/lang/Reference.get:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;        16: checkcast     #46                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SignaturePageSpec
&lt;/span&gt;        19: invokevirtual #50                 &lt;span class=&quot;code-comment&quot;&gt;// Method SignaturePageSpec.getEnvelope:()LSignaturePageSpec$Envelope;
&lt;/span&gt;        22: aload_2
        23: invokedynamic #64,  0             &lt;span class=&quot;code-comment&quot;&gt;// InvokeDynamic #0:&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;:(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;
&lt;/span&gt;        28: invokevirtual #70                 &lt;span class=&quot;code-comment&quot;&gt;// Method SignaturePageSpec$Envelope.setFilename:(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;)V
&lt;/span&gt;        31: aconst_null
        32: pop
        33: invokedynamic #72,  0             &lt;span class=&quot;code-comment&quot;&gt;// InvokeDynamic #0:&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;:(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;;
&lt;/span&gt;        38: areturn
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13538650">GROOVY-11079</key>
            <summary>GroovyCastException on closure implementing Consumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="chrylis">Christopher Smith</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Jun 2023 21:00:15 +0000</created>
                <updated>Wed, 23 Aug 2023 09:05:47 +0000</updated>
                            <resolved>Tue, 6 Jun 2023 02:29:42 +0000</resolved>
                                    <version>4.0.12</version>
                                    <fixVersion>4.0.13</fixVersion>
                                    <component>Static compilation</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17728867" author="chrylis" created="Fri, 2 Jun 2023 21:08:34 +0000"  >&lt;p&gt;Update: This entire section is inside a &lt;tt&gt;forEach&lt;/tt&gt;, which expects a &lt;tt&gt;Consumer&lt;/tt&gt; (closure2), and I think perhaps the outside closure&apos;s void return may be &quot;pulling inside&quot; and leading to the compiler trying really hard to get a &lt;tt&gt;Void&lt;/tt&gt; out of the nested closure.&lt;/p&gt;</comment>
                            <comment id="17728990" author="emilles" created="Sat, 3 Jun 2023 16:01:08 +0000"  >&lt;p&gt;Can you show your whole test method up to the closure(s)?  It is hard to guess the structure from your description.&lt;/p&gt;

&lt;p&gt;I have this, but all I get is another &lt;tt&gt;VerifyError&lt;/tt&gt; case if I remove the type from &quot;doc&quot;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.pdfbox:pdfbox:2.0.28&apos;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.pdfbox.pdmodel.*
@Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;io.vavr:vavr:0.10.4&apos;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; io.vavr.control.Try

Try&amp;lt;Iterable&amp;lt;PDPage&amp;gt;&amp;gt; extraPages() {
  Try.success([&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPage()])
}

@CompileStatic
void test(List&amp;lt;PDDocument&amp;gt; docs) {
  docs.forEach { PDDocument doc -&amp;gt;
    extraPages().onSuccess {
      it.forEach(doc::addPage)
      doc.documentId = 1L
    }
  }
}

test([&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDDocument()])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17728996" author="emilles" created="Sat, 3 Jun 2023 17:09:13 +0000"  >&lt;p&gt;In general, what is going on with &quot;tryVar.onSuccess { sps.envelope.filename = it._1 }&quot; is that the value of &quot;it._1&quot; is the result of the whole assignment expression.  This is done via a transformation to &lt;tt&gt;PoppingMethodCallExpression&lt;/tt&gt;, which is why you are seeing a pop for the null value that the void-return setter produces.  After that, the closure&apos;s &quot;doCall&quot; method casts the top operand to the inferred closure return type.  I am getting &lt;tt&gt;java.lang.Long&lt;/tt&gt; but you have &lt;tt&gt;java.lang.Void&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In case of &lt;tt&gt;Void&lt;/tt&gt; it should probably just pop the top operand and push &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17729000" author="emilles" created="Sat, 3 Jun 2023 17:39:59 +0000"  >&lt;p&gt;What is the return type of your &quot;loadOriginal&quot; method?  As far as I can figure it&apos;s &quot;io.vavr.control.Try&amp;lt;io.vavr.Tuple2&amp;lt;java.lang.String, org.apache.pdfbox.pdmodel.PDDocument&amp;gt;&amp;gt;&quot;.  You are adding a type argument in &quot;.&amp;lt;PDDocument&amp;gt;.map(Tuple2::_2)&quot; which should not be necessary unless your tuple type is underspecified.&lt;/p&gt;

&lt;p&gt;Not sure if it is confused by &quot;it._1&quot; vs &quot;it._1()&quot;.  And where is &quot;filename&quot; or &quot;setFilename&quot; declared?&lt;/p&gt;</comment>
                            <comment id="17729466" author="emilles" created="Mon, 5 Jun 2023 20:33:29 +0000"  >&lt;p&gt;Thanks for sending the extra information.  I am able to recreate like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;io.vavr:vavr:0.10.4&apos;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; io.vavr.control.Try
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; io.vavr.Tuple2

Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; getSpec() { [:] }

Try&amp;lt;Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;&amp;gt; tuple() {
  Try.success( &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Tuple2(&quot;&quot;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) )
}

@CompileStatic &lt;span class=&quot;code-comment&quot;&gt;// GROOVY-11079
&lt;/span&gt;void test(List list) {
  list.forEach {
    &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; map = getSpec()
    tuple().onSuccess {
      map.foo = it._1
    }
  &lt;span class=&quot;code-comment&quot;&gt;//.map(Tuple2::_2)
&lt;/span&gt;  }
}

test( [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;] )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17729479" author="emilles" created="Mon, 5 Jun 2023 21:21:27 +0000"  >&lt;p&gt;The closure shared variable &quot;sps&quot; in your example or &quot;map&quot; in mine cause a revisit, which is where the return type gets overwritten.  &lt;a href=&quot;https://github.com/apache/groovy/blob/cfc22e46ce02ffde86fbd8401ba2b71e9dc71a48/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java#L2432&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/cfc22e46ce02ffde86fbd8401ba2b71e9dc71a48/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java#L2432&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And here is where the re-visit return value is dropped: &lt;a href=&quot;https://github.com/apache/groovy/blob/cfc22e46ce02ffde86fbd8401ba2b71e9dc71a48/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java#L2249&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/cfc22e46ce02ffde86fbd8401ba2b71e9dc71a48/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java#L2249&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17729553" author="emilles" created="Tue, 6 Jun 2023 02:29:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/commit/8d2fe6889c8773f35e44c494a2fec91e7e696cb0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/8d2fe6889c8773f35e44c494a2fec91e7e696cb0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/commit/97ea854cf0ddd051060fc72edcaf1cbb37d19543&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/97ea854cf0ddd051060fc72edcaf1cbb37d19543&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13537373">GROOVY-11068</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ib7s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>