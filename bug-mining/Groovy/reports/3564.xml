<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:01:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9086] @CompileStatic of closure calls with OWNER_FIRST fail at runtime with ClassCastException</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9086</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The attached script fails with a ClassCastException, when method m2 is annotated with&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
strategy = Closure.OWNER_FIRST
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;but work with&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
strategy = Closure.DELEGATE_FIRST
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;The expected system-out should be&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
c1Method called&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;in both cases. The generated bytecode for closure&#160;Test$_test_closure1$_closure2.class contains a call to getDelegate() instead of getOwner() in case of Closure.OWNER_FIRST. But correctly generates code getOwner() in case of Closure.DELEGATE_FIRST.&lt;/p&gt;

&lt;p&gt;The resulting ClassCastException at runtime is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassCastException: Test$C2 cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to groovy.lang.Closure
at Test$_test_closure1$_closure2.doCall(TestScript.groovy:28)
at Test$_test_closure1$_closure2.doCall(TestScript.groovy)
at Test.m2(TestScript.groovy:20)
at Test$_test_closure1.doCall(TestScript.groovy:26)
at Test$_test_closure1.doCall(TestScript.groovy)
at Test.m1(TestScript.groovy:8)
at Test.test(TestScript.groovy:25)
at Test$test.call(Unknown Source)
at TestScript.run(TestScript.groovy:42)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The wrong bytecode for case&#160;Closure.OWNER_FIRST:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; doCall(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;);
descriptor: (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
flags: ACC_PUBLIC
Code:
stack=1, locals=2, args_size=2
0: aload_0
1: checkcast #2 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test$_test_closure1$_closure2
&lt;/span&gt;4: invokevirtual #29 &lt;span class=&quot;code-comment&quot;&gt;// Method getDelegate:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;7: checkcast #4 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;groovy/lang/Closure
&lt;/span&gt;10: invokevirtual #30 &lt;span class=&quot;code-comment&quot;&gt;// Method groovy/lang/Closure.getDelegate:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;13: checkcast #32 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test$C1
&lt;/span&gt;16: invokevirtual #36 &lt;span class=&quot;code-comment&quot;&gt;// Method Test$C1.c1Method:()V
&lt;/span&gt;19: aconst_null
20: areturn
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The correct bytecode for case&#160;Closure.DELEGATE_FIRST:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; doCall(java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;);
descriptor: (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
flags: ACC_PUBLIC
Code:
stack=1, locals=2, args_size=2
0: aload_0
1: checkcast #2 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test$_test_closure1$_closure2
&lt;/span&gt;4: invokevirtual #29 &lt;span class=&quot;code-comment&quot;&gt;// Method getOwner:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;7: checkcast #4 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;groovy/lang/Closure
&lt;/span&gt;10: invokevirtual #32 &lt;span class=&quot;code-comment&quot;&gt;// Method groovy/lang/Closure.getDelegate:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;13: checkcast #34 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test$C1
&lt;/span&gt;16: invokevirtual #38 &lt;span class=&quot;code-comment&quot;&gt;// Method Test$C1.c1Method:()V
&lt;/span&gt;19: aconst_null
20: areturn
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>WIndows7, Groovy 2.5.6, Java 8 + 11</environment>
        <key id="13228256">GROOVY-9086</key>
            <summary>@CompileStatic of closure calls with OWNER_FIRST fail at runtime with ClassCastException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="AndreasTu">Andreas Turban</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Apr 2019 06:45:34 +0000</created>
                <updated>Mon, 20 May 2019 07:31:37 +0000</updated>
                            <resolved>Wed, 1 May 2019 13:36:25 +0000</resolved>
                                    <version>2.5.6</version>
                                    <fixVersion>3.0.0-beta-1</fixVersion>
                    <fixVersion>2.5.7</fixVersion>
                                    <component>Static compilation</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16819543" author="emilles" created="Tue, 16 Apr 2019 22:07:58 +0000"  >&lt;p&gt;When the compiler gets to &lt;tt&gt;StaticInvocationWriter.tryImplicitReceiver&lt;/tt&gt;, it has determined that the implicit receiver is &quot;delegate.delegate&quot;.  That is your script is interpreted as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
@CompileStatic
void test() {
  m1 {
    m2 {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.delegate.delegate.c1Method()
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It then converts to &lt;tt&gt;((C1) ((Closure) ((Test$_test_closure1$_closure2) this).getDelegate()).getDelegate()).c1Method()&lt;/tt&gt;.  As you stated, the leftmost &quot;getDelegate&quot; should be &quot;getOwner&quot;.  An instance of &lt;tt&gt;C2&lt;/tt&gt; is the return value of this first call, which cannot be cast to &lt;tt&gt;Closure&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16819556" author="emilles" created="Tue, 16 Apr 2019 22:35:29 +0000"  >&lt;p&gt;The &lt;tt&gt;DelegationMetadata&lt;/tt&gt; is deciphered by this method in &lt;tt&gt;StaticTypeCheckingVisitor&lt;/tt&gt; to produce &quot;Receiver{type=Test.C1, data=delegate.delegate}&quot;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void addReceivers(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; receivers,
                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Collection&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; owners,
                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; implicitThis) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (typeCheckingContext.delegationMetadata == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !implicitThis) {
            receivers.addAll(owners);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }

        DelegationMetadata dmd = typeCheckingContext.delegationMetadata;
        StringBuilder path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (dmd != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; strategy = dmd.getStrategy();
            ClassNode delegate = dmd.getType();
            dmd = dmd.getParent();
            &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (strategy) {
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.OWNER_FIRST:
                    receivers.addAll(owners);
                    path.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;);
                    doAddDelegateReceiver(receivers, path, delegate);
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.DELEGATE_FIRST:
                    path.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;);
                    doAddDelegateReceiver(receivers, path, delegate);
                    receivers.addAll(owners);
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.OWNER_ONLY:
                    receivers.addAll(owners);
                    dmd = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.DELEGATE_ONLY:
                    path.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;);
                    doAddDelegateReceiver(receivers, path, delegate);
                    dmd = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            }
            path.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;.&apos;&lt;/span&gt;);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It starts from the innermost scope and moves outwards.  It seems that &quot;owner&quot; should be appended for each parent so that the path correctly refers to outer scopes.&lt;/p&gt;

&lt;p&gt;Here is what I am trying out:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void addReceivers(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; receivers,
                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Collection&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; owners,
                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; implicitThis) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (typeCheckingContext.delegationMetadata == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !implicitThis) {
            receivers.addAll(owners);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }

        DelegationMetadata dmd = typeCheckingContext.delegationMetadata;
        StringBuilder path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (dmd != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; strategy = dmd.getStrategy();
            ClassNode delegate = dmd.getType();
            dmd = dmd.getParent();
            &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (strategy) {
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.OWNER_FIRST:
                    receivers.addAll(owners);
                    addDelegateReceiver(receivers, delegate, path);
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.DELEGATE_FIRST:
                    addDelegateReceiver(receivers, delegate, path);
                    receivers.addAll(owners);
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.OWNER_ONLY:
                    receivers.addAll(owners);
                    dmd = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.DELEGATE_ONLY:
                    addDelegateReceiver(receivers, delegate, path);
                    dmd = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            }
            path.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;owner.&quot;&lt;/span&gt;);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void addDelegateReceiver(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; receivers, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode delegate, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CharSequence path) {
        receivers.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(delegate, path.toString() + &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;));
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isTraitHelper(delegate)) {
            receivers.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(delegate.getOuterClass(), path.toString() + &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;));
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16820164" author="emilles" created="Wed, 17 Apr 2019 15:00:36 +0000"  >&lt;p&gt;I think this change replaces the &lt;tt&gt;StaticTypeCheckingVisitor.adjustData&lt;/tt&gt; method which was added between Groovy 2.4 and 2.5 for cases like this.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested each variation of DELEGATE_FIRST/OWNER_FIRST for the two methods in the test script.  I&apos;ve also tested against the use case in &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8873&quot; title=&quot;Fails at runtime with @CompileStatic and two nested with&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8873&quot;&gt;&lt;del&gt;GROOVY-8873&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16820257" author="emilles" created="Wed, 17 Apr 2019 16:16:19 +0000"  >&lt;p&gt;I also tried a case where the resolve strategy is important.  This test case prints &quot;outer delegate outer delegate&quot; for dynamic Groovy (as expected) but &quot;outer delegate inner delegate&quot; for statically-compiled Groovy.  It is broken for the current Groovy 2.5 as well as with the suggested change above.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C1 {
  void m() {
    print &lt;span class=&quot;code-quote&quot;&gt;&apos;outer delegate&apos;&lt;/span&gt;
  }
}
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C2 {
  void m() {
    print &lt;span class=&quot;code-quote&quot;&gt;&apos;inner delegate&apos;&lt;/span&gt;
  }
}
void outer(@DelegatesTo(value = C1, strategy = Closure.OWNER_FIRST) Closure block) {
  block.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; C1()
  block.call()
}
void inner(@DelegatesTo(value = C2, strategy = Closure.OWNER_FIRST) Closure block) {
  block.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; C2()
  block.call()
}

@groovy.transform.CompileStatic
void test() {
  outer {
    m()
    print &lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;
    inner {
      m()
    }
  }
}

test()
&#8203;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16820283" author="emilles" created="Wed, 17 Apr 2019 16:38:55 +0000"  >&lt;p&gt;Also, the &quot;owner&quot; qualifier does not seem to work right for nested closures under &lt;tt&gt;@CompileStatic&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C1 {
  void m() {
    print &lt;span class=&quot;code-quote&quot;&gt;&apos;outer delegate&apos;&lt;/span&gt;
  }
}
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C2 {
  void m() {
    print &lt;span class=&quot;code-quote&quot;&gt;&apos;inner delegate&apos;&lt;/span&gt;
  }
}
void outer(@DelegatesTo(value = C1) Closure block) {
  block.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; C1()
  block()
}
void inner(@DelegatesTo(value = C2) Closure block) {
  block.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; C2()
  block()
}

@groovy.transform.CompileStatic &lt;span class=&quot;code-comment&quot;&gt;// comment out and script prints &lt;span class=&quot;code-quote&quot;&gt;&quot;outer delegate&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; expected
&lt;/span&gt;void test() {
  outer {
    inner {
      owner.m() &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot find matching method Script#m(). Please check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the declared type is right and &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the method exists.&quot;&lt;/span&gt;
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// replace &lt;span class=&quot;code-quote&quot;&gt;&quot;owner&quot;&lt;/span&gt; with &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt; and CompileStatic has no error and prints &lt;span class=&quot;code-quote&quot;&gt;&quot;inner delegate&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; expected
&lt;/span&gt;    }
  }
}

test()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Submitted as &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-9089&quot; title=&quot;STC: owner qualifier produces error for nested closures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-9089&quot;&gt;&lt;del&gt;GROOVY-9089&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16820378" author="emilles" created="Wed, 17 Apr 2019 18:10:34 +0000"  >&lt;p&gt;This version of &lt;tt&gt;addReceivers&lt;/tt&gt; should properly add all owner receivers before the delegate in the case of &lt;tt&gt;OWNER_FIRST&lt;/tt&gt;.  And &lt;tt&gt;OWNER_ONLY&lt;/tt&gt; gets receivers from outer scopes in case of nesting.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void addReceivers(List&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; receivers, Collection&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; owners, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; implicitThis) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!implicitThis || typeCheckingContext.delegationMetadata == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            receivers.addAll(owners);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            addReceivers(receivers, owners, typeCheckingContext.delegationMetadata, &quot;&quot;);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void addReceivers(List&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; receivers, Collection&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; owners, DelegationMetadata dmd, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path) {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; strategy = dmd.getStrategy();
        &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (strategy) {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.DELEGATE_ONLY:
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.DELEGATE_FIRST:
                addDelegateReceiver(receivers, dmd.getType(), path + &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (strategy == Closure.DELEGATE_FIRST) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dmd.getParent() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                        receivers.addAll(owners);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        receivers.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(CLOSURE_TYPE, path + &lt;span class=&quot;code-quote&quot;&gt;&quot;owner&quot;&lt;/span&gt;));
                        addReceivers(receivers, owners, dmd.getParent(), path + &lt;span class=&quot;code-quote&quot;&gt;&quot;owner.&quot;&lt;/span&gt;);
                    }
                }
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.OWNER_ONLY:
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Closure.OWNER_FIRST:
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dmd.getParent() == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    receivers.addAll(owners);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    receivers.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(CLOSURE_TYPE, path + &lt;span class=&quot;code-quote&quot;&gt;&quot;owner&quot;&lt;/span&gt;));
                    addReceivers(receivers, owners, dmd.getParent(), path + &lt;span class=&quot;code-quote&quot;&gt;&quot;owner.&quot;&lt;/span&gt;);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (strategy == Closure.OWNER_FIRST) {
                    addDelegateReceiver(receivers, dmd.getType(), path + &lt;span class=&quot;code-quote&quot;&gt;&quot;delegate&quot;&lt;/span&gt;);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void addDelegateReceiver(List&amp;lt;Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; receivers, ClassNode delegate, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path) {
        receivers.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(delegate, path));
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Traits.isTrait(delegate.getOuterClass())) {
            receivers.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Receiver&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(delegate.getOuterClass(), path));
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not sure if the addition of the &lt;tt&gt;CLOSURE_TYPE&lt;/tt&gt; receivers are necessary.&lt;/p&gt;</comment>
                            <comment id="16831002" author="paulk" created="Wed, 1 May 2019 13:36:07 +0000"  >&lt;p&gt;Proposed PR based on Eric&apos;s suggestions applied:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/pull/917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/917&lt;/a&gt;&lt;br/&gt;
I removed the CLOSURE_TYPE receivers since they broke some JSON tests.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12966283" name="StaticTypeCheckingVisitor.java" size="298854" author="emilles" created="Wed, 17 Apr 2019 20:29:50 +0000"/>
                            <attachment id="12966039" name="TestScript.groovy" size="975" author="AndreasTu" created="Tue, 16 Apr 2019 06:10:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01tm8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>