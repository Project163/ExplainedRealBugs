<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:16:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4304] OptimizerVisitor may run twice, corrupting constants</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4304</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The issue came up when Paul King showed me a Spock spec behaving in strange ways:&lt;/p&gt;

&lt;p&gt;TestSpock.groovy:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.spockframework:spock-core:0.4-groovy-1.7&apos;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestSpock &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; spock.lang.Specification {
  def convert = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Converter()

  def &lt;span class=&quot;code-quote&quot;&gt;&apos;important scenarios&apos;&lt;/span&gt;() {
    expect:
    c == convert.toCelsius(f)

    where:
    c   | f   | scenario
    0   | 32  | &lt;span class=&quot;code-quote&quot;&gt;&apos;Freezing&apos;&lt;/span&gt;
    20  | 68  | &lt;span class=&quot;code-quote&quot;&gt;&apos;Garden party conditions&apos;&lt;/span&gt;
    35  | 95  | &lt;span class=&quot;code-quote&quot;&gt;&apos;Beach conditions&apos;&lt;/span&gt;
    100 | 212 | &lt;span class=&quot;code-quote&quot;&gt;&apos;Boiling&apos;&lt;/span&gt;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Converter.groovy:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Converter {
  def toCelsius (fahrenheit) { (fahrenheit - 32) * 5 / 9 }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you run this with &apos;groovy TestSpock.groovy&apos;, you will notice that the values for &apos;c&apos; and &apos;f&apos; get mixed up. After debugging groovyc, I came to the following conclusion:&lt;/p&gt;

&lt;p&gt;Compilation of SpockTest advances until end of phase &quot;semantic analysis&quot;, then CompilationUnit.dequeued() sets the phase back to &quot;initialization&quot;. On the second pass, SourceUnitOperation&apos;s that have already run are skipped due to this check in CompilationUnit.applyToSourceUnits():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((source.phase &amp;lt; phase) || (source.phase == phase &amp;amp;&amp;amp;
!source.phaseComplete)) ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, Compilation.applyToPrimaryClassNodes() has a slightly different check:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (context == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || context.phase &amp;lt;= phase) ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;source.phaseComplete is not checked here, hence OptimizerVisitor (among others) runs a second time. This leads to wrong results, at least in the case where an AST transform has added additional constants. The TODO in OptimizerVisitor.setConstField() is on the spot.&lt;/p&gt;

&lt;p&gt;Adding the source.phaseComplete check to Compilation.applyToPrimaryClassNodes() seemed to solve the problem for Paul. I haven&apos;t investigated further if this is the correct approach.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12818054">GROOVY-4304</key>
            <summary>OptimizerVisitor may run twice, corrupting constants</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="pniederw">Peter Niederwieser</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Jul 2010 10:15:24 +0000</created>
                <updated>Thu, 22 Jul 2010 17:32:25 +0000</updated>
                            <resolved>Thu, 22 Jul 2010 07:32:48 +0000</resolved>
                                    <version>1.7.3</version>
                                    <fixVersion>1.7.4</fixVersion>
                    <fixVersion>1.8-beta-1</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14479269" author="paulk" created="Wed, 14 Jul 2010 22:16:39 +0000"  >&lt;p&gt;Patch applied to trunk (changeset 20443) and the 1_7_X branch (changeset 20444). I don&apos;t have time at present to write an appropriate test, so leaving open. At least we can test downstream in the meantime.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bzb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>