<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:13:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8638] CompileStatic fails with Guava Multimap#asMap</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8638</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When using CompileStatic and groovy 2.5.0, type checking appears wrong with &lt;a href=&quot;https://google.github.io/guava/releases/25.1-jre/api/docs/com/google/common/collect/ListMultimap.html#asMap--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Guava&apos;s Multimap.asMap &lt;/a&gt; method.&#160; Return type from that method is Map&amp;lt;K, Collection&amp;lt;V&amp;gt;&amp;gt;, but attempting to assign to a variable of that type results in the error message:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Incompatible generic argument types. Cannot assign java.util.Map &amp;lt;K, V&amp;gt; to: java.util.Map &amp;lt;K, Collection&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This previously worked fine with Groovy 2.4.15. Adding an explicit cast to the asMap() call appears to work around the error.&lt;/p&gt;

&lt;p&gt;Here is a small script demonstrating the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Grab(&lt;span class=&quot;code-quote&quot;&gt;&apos;com.google.guava:guava:25.1-jre&apos;&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.collect.ArrayListMultimap
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.collect.ListMultimap
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {

    void test() {
        ListMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; mmap = ArrayListMultimap.create()
        &lt;span class=&quot;code-comment&quot;&gt;// This extra &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; fixes all the errors...
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//ListMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; mmap = ArrayListMultimap.create() as ListMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;
&lt;/span&gt;        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt; map = mmap.asMap()
        
        Set&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt; entrySet = map.entrySet()
        Iterator&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt; iter = entrySet.iterator()
        
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext()) {
            Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt; group = iter.next()
            Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; values = group.value
        }
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;... args) {
        Test test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Test()
        test.test()
    }
    
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And the full error output:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;5 compilation errors:

[Static type checking] - Incompatible generic argument types. Cannot assign java.util.Map &amp;lt;java.lang.String, java.lang.Integer&amp;gt; to: java.util.Map &amp;lt;String, Collection&amp;gt;
 at line: 14, column: 48

[Static type checking] - Incompatible generic argument types. Cannot assign java.util.Set &amp;lt;java.util.Map$Entry&amp;gt; to: java.util.Set &amp;lt;Map.Entry&amp;gt;
 at line: 16, column: 64

[Static type checking] - Incompatible generic argument types. Cannot assign java.util.Iterator &amp;lt;java.util.Map$Entry&amp;gt; to: java.util.Iterator &amp;lt;Map.Entry&amp;gt;
 at line: 17, column: 65

[Static type checking] - Incompatible generic argument types. Cannot assign java.util.Map$Entry &amp;lt;java.lang.String, java.lang.Integer&amp;gt; to: java.util.Map$Entry &amp;lt;String, Collection&amp;gt;
 at line: 20, column: 60

[Static type checking] - Cannot assign value of type java.lang.Integer to variable of type java.util.Collection &amp;lt;Integer&amp;gt;
 at line: 21, column: 42
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13164816">GROOVY-8638</key>
            <summary>CompileStatic fails with Guava Multimap#asMap</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="zman0900">Dan Ziemba</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jun 2018 22:47:03 +0000</created>
                <updated>Sun, 30 Apr 2023 14:31:28 +0000</updated>
                            <resolved>Tue, 1 Jun 2021 16:12:13 +0000</resolved>
                                    <version>2.5.0</version>
                    <version>3.0.5</version>
                                    <fixVersion>4.0.0-beta-1</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>2.5.16</fixVersion>
                                    <component>Static Type Checker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16505580" author="zman0900" created="Fri, 8 Jun 2018 01:04:09 +0000"  >&lt;p&gt;This problem also happens with the latest 3.0.0-alpha-2.&lt;/p&gt;</comment>
                            <comment id="17166449" author="emilles" created="Tue, 28 Jul 2020 14:12:03 +0000"  >&lt;p&gt;Have you tried &lt;tt&gt;Map&amp;lt;String, ? extends Collection&amp;lt;Integer&amp;gt;&amp;gt; map = mmap.asMap()&lt;/tt&gt;?  There is a common misconception about how covariance works.  Map is covariant in the declaration but its type arguments/parameters are not.&lt;/p&gt;</comment>
                            <comment id="17166587" author="zman0900" created="Tue, 28 Jul 2020 17:42:47 +0000"  >&lt;p&gt;The signature of Guava&apos;s &lt;a href=&quot;https://guava.dev/releases/25.0-jre/api/docs/com/google/common/collect/ListMultimap.html#asMap--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;asMap()&lt;/a&gt; method is actually &lt;tt&gt;Map&amp;lt;K,Collection&amp;lt;V&amp;gt;&amp;gt; asMap()&lt;/tt&gt;, so I don&apos;t think extends can even work there. The error seems to me like Groovy has somehow decided that asMap() actually returns &lt;tt&gt;Map&amp;lt;K,V&amp;gt;&lt;/tt&gt; instead of &lt;tt&gt;Map&amp;lt;K,Collection&amp;lt;V&amp;gt;&amp;gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have re-tested with latest Groovy 3.0.5 and Guava 29, and issue remains.&#160;&lt;/p&gt;</comment>
                            <comment id="17347172" author="emilles" created="Tue, 18 May 2021 21:23:30 +0000"  >&lt;p&gt;The class file for &lt;tt&gt;ArrayListMultimap&lt;/tt&gt; has a bridge method for &lt;tt&gt;asMap&lt;/tt&gt; that lacks the generics signature necessary for proper generics inference.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-comment&quot;&gt;// Method descriptor #124 ()Ljava/util/Map;
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// Stack: 1, Locals: 1
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; bridge synthetic java.util.Map asMap();
    0  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    1  invokespecial com.google.common.collect.ArrayListMultimapGwtSerializationDependencies.asMap() : java.util.Map [30]
    4  areturn
      Line numbers:
        [pc: 0, line: 61]
      Local variable table:
        [pc: 0, pc: 5] local: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index: 0 type: com.google.common.collect.ArrayListMultimap
      Local variable type table:
        [pc: 0, pc: 5] local: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index: 0 type: com.google.common.collect.ArrayListMultimap&amp;lt;K,V&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the same method from &lt;tt&gt;AbstractMapBasedMultimap&lt;/tt&gt; for comparison:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-comment&quot;&gt;// Method descriptor #77 ()Ljava/util/Map;
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// Signature: ()Ljava/util/Map&amp;lt;TK;Ljava/util/Collection&amp;lt;TV;&amp;gt;;&amp;gt;;
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// Stack: 1, Locals: 1
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.util.Map asMap();
    0  aload_0 [&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;]
    1  invokespecial com.google.common.collect.AbstractMapBasedMultimap.asMap() : java.util.Map [10]
    4  areturn
      Line numbers:
        [pc: 0, line: 126]
      Local variable table:
        [pc: 0, pc: 5] local: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index: 0 type: com.google.common.collect.AbstractListMultimap
      Local variable type table:
        [pc: 0, pc: 5] local: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; index: 0 type: com.google.common.collect.AbstractListMultimap&amp;lt;K,V&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;DecompiledClassNode&lt;/tt&gt; maybe shouldn&apos;t be populated with bridge methods or maybe the searching algorithm should be ignoring them.&lt;/p&gt;</comment>
                            <comment id="17347174" author="emilles" created="Tue, 18 May 2021 21:31:15 +0000"  >&lt;p&gt;Eclipse IDE only keeps bridge methods for JDK &amp;lt; 1.5:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Create method bindings &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; binary type, filtering out &amp;lt;clinit&amp;gt; and synthetics
 * As some iMethods may be ignored in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; process we &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the matching array of those
 * iMethods &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; which MethodBindings have been created; indices match those in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.methods.
 */
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; IBinaryMethod[] createMethods(IBinaryMethod[] iMethods, IBinaryType binaryType, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sourceLevel, &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[][][] missingTypeNames) {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isPrototype()) &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException();
	&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; save = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.environment.mayTolerateMissingType;
	&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.environment.mayTolerateMissingType = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
	&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; total = 0, initialTotal = 0, iClinit = -1;
		&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] toSkip = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iMethods != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
			total = initialTotal = iMethods.length;
			&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; keepBridgeMethods = sourceLevel &amp;lt; ClassFileConstants.JDK1_5; &lt;span class=&quot;code-comment&quot;&gt;// https://bugs.eclipse.org/bugs/show_bug.cgi?id=330347
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = total; --i &amp;gt;= 0;) {
				IBinaryMethod method = iMethods[i];
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((method.getModifiers() &amp;amp; ClassFileConstants.AccSynthetic) != 0) {
					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (keepBridgeMethods &amp;amp;&amp;amp; (method.getModifiers() &amp;amp; ClassFileConstants.AccBridge) != 0)
						&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// want to see bridge methods as real methods
&lt;/span&gt;					&lt;span class=&quot;code-comment&quot;&gt;// discard synthetics methods
&lt;/span&gt;					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (toSkip == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) toSkip = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[iMethods.length];
					toSkip[i] = -1;
					total--;
				} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iClinit == -1) {
					&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] methodName = method.getSelector();
					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (methodName.length == 8 &amp;amp;&amp;amp; methodName[0] == Util.C_GENERIC_START) {
						&lt;span class=&quot;code-comment&quot;&gt;// discard &amp;lt;clinit&amp;gt;
&lt;/span&gt;						iClinit = i;
						total--;
					}
				}
			}
		}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17347178" author="emilles" created="Tue, 18 May 2021 21:39:41 +0000"  >&lt;p&gt;You should be able to work around this issue with a typecast:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; mmap = (ListMultimap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;) ArrayListMultimap.create()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13381493">GROOVY-10120</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13532538">GROOVY-11012</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13534426">GROOVY-11035</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3un3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>