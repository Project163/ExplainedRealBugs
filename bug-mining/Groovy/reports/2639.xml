<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:41:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3971] adding method to class in ASTBuilder not working</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3971</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The following code produces class MyClass OK, but running the class produces error:&lt;br/&gt;
&lt;b&gt;Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: main&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s the ASTBuilder code I used:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import static org.objectweb.asm.Opcodes.ACC_PUBLIC
import static org.objectweb.asm.Opcodes.ACC_STATIC
import org.codehaus.groovy.ast.builder.AstBuilder
import org.codehaus.groovy.control.CompilerConfiguration
import org.codehaus.groovy.control.CompilationUnit

def classes= new AstBuilder().buildFromSpec{
  classNode &apos;MyClass&apos;, ACC_PUBLIC, {
    classNode Object //superclass
    interfaces{
      classNode GroovyObject
    }
    mixins{}
    genericsTypes{}
    method(&apos;main&apos;, ACC_PUBLIC &amp;amp; ACC_STATIC, Void.class) {
      parameters{
        parameter &apos;args&apos;: String[].class
      }
      exceptions{}
      block{
        methodCall {
          variable &quot;this&quot;
          constant &quot;println&quot;
          argumentList {
            constant &quot;Hello, world!&quot;
          }
        }
      }
    }
  }
}

def gcl= new GroovyClassLoader()
def sec= null
def ccfg= CompilerConfiguration.DEFAULT
def cu= new CompilationUnit(ccfg, sec, gcl)
cu.addClassNode(classes[0])
cu.compile() 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also tried this but same result:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import static org.objectweb.asm.Opcodes.ACC_PUBLIC
import static org.objectweb.asm.Opcodes.ACC_STATIC
import org.codehaus.groovy.ast.*
import java.security.CodeSource
import org.codehaus.groovy.ast.builder.AstBuilder
import org.codehaus.groovy.control.CompilerConfiguration
import org.codehaus.groovy.control.CompilationUnit
import org.codehaus.groovy.control.CompilePhase

def classes= new AstBuilder().buildFromString(CompilePhase.CONVERSION, &quot;&quot;&quot;\
public class MyClass{
  public static void main(String[] args){
    println &quot;Hello, world!&quot;
  }
}
&quot;&quot;&quot;)

def gcl= new GroovyClassLoader()
def sec= null //new CodeSource()
def ccfg= CompilerConfiguration.DEFAULT
def cu= new CompilationUnit(ccfg, sec, gcl)
cu.addClassNode(classes[1])
cu.compile()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Groovy 1.7-RC-2 on jre1.6.0_04 on Windows Vista SP2</environment>
        <key id="12815032">GROOVY-3971</key>
            <summary>adding method to class in ASTBuilder not working</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="gavingrover">Gavin Grover</reporter>
                        <labels>
                    </labels>
                <created>Sun, 3 Jan 2010 21:22:49 +0000</created>
                <updated>Wed, 11 Jun 2014 14:25:23 +0000</updated>
                            <resolved>Mon, 9 Jun 2014 02:09:04 +0000</resolved>
                                    <version>1.7-rc-2</version>
                                    <fixVersion>2.4.0-beta-1</fixVersion>
                                    <component>ast builder</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14468491" author="gavingrover" created="Sun, 3 Jan 2010 21:44:50 +0000"  >&lt;p&gt;javap output of class:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public class MyClass extends java.lang.Object implements groovy.lang.GroovyObject{
    public static java.lang.Long __timeStamp;
    public static java.lang.Long __timeStamp__239_neverHappen1262576568013;
    public MyClass();
    public java.lang.Object this$dist$invoke$2(java.lang.String, java.lang.Object);
    public void this$dist$set$2(java.lang.String, java.lang.Object);
    public java.lang.Object this$dist$get$2(java.lang.String);
    protected groovy.lang.MetaClass $getStaticMetaClass();
    public groovy.lang.MetaClass getMetaClass();
    public void setMetaClass(groovy.lang.MetaClass);
    public java.lang.Object invokeMethod(java.lang.String, java.lang.Object);
    public java.lang.Object getProperty(java.lang.String);
    public void setProperty(java.lang.String, java.lang.Object);
    static {};
    public void super$1$wait();
    public java.lang.String super$1$toString();
    public void super$1$wait(long);
    public void super$1$wait(long, int);
    public void super$1$notify();
    public void super$1$notifyAll();
    public java.lang.Class super$1$getClass();
    public boolean super$1$equals(java.lang.Object);
    public java.lang.Object super$1$clone();
    public int super$1$hashCode();
    public void super$1$finalize();
    static java.lang.Class class$(java.lang.String);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14468618" author="roshandawrani" created="Tue, 5 Jan 2010 13:30:47 +0000"  >&lt;p&gt;For the 2nd example (AstBuilder#buildFromString()), here is the working code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.objectweb.asm.Opcodes.ACC_PUBLIC
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.objectweb.asm.Opcodes.ACC_STATIC
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.security.CodeSource
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.builder.AstBuilder
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilerConfiguration
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilationUnit
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilePhase

def classes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromString(CompilePhase.CONVERSION, &quot;&quot;&quot;\
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass{
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args){
    println &lt;span class=&quot;code-quote&quot;&gt;&quot;Roshan here!&quot;&lt;/span&gt;
  }
}
&quot;&quot;&quot;)
def su = classes[1].module.context
def gcl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader()
def sec = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CodeSource()
&lt;/span&gt;def ccfg = CompilerConfiguration.DEFAULT
def cu = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompilationUnit(ccfg, sec, gcl)
cu.addClassNode(classes[1])
cu.addSource(su)
cu.compile()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14468506" author="roshandawrani" created="Tue, 5 Jan 2010 14:19:05 +0000"  >&lt;p&gt;Regarding 1st example, the MethodNode (main) is not even getting added to ClassNode (MyClass)&apos;s methods, so no wonder it is not coming in compiled class and then not able to run.&lt;/p&gt;</comment>
                            <comment id="14478836" author="paulk" created="Tue, 5 Jan 2010 16:59:38 +0000"  >&lt;p&gt;Slightly tweaked version of Roshan&apos;s example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.builder.AstBuilder
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilationUnit
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.codehaus.groovy.control.CompilerConfiguration.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.codehaus.groovy.control.CompilePhase.*

def classes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromString(CONVERSION, &quot;&quot;&quot;\
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass {
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args){
    println &lt;span class=&quot;code-quote&quot;&gt;&quot;Roshan here!&quot;&lt;/span&gt;
  }
}
&quot;&quot;&quot;)
def su = classes[1].module.context
def gcl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader()
def cu = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompilationUnit(DEFAULT, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, gcl)
cu.addClassNode(classes[1])
cu.addSource(su)
cu.compile()
MyClass.main()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14468539" author="roshandawrani" created="Wed, 6 Jan 2010 00:11:46 +0000"  >&lt;p&gt;I should have mentioned here for documentation sake what was the change introduced for the 2nd example.&lt;/p&gt;

&lt;p&gt;The issue was that because there was no SourceUnit attached to the CompilationUnit, it was skipping all SourceUnitOperation(s) in the compilation phases - &quot;resolve&quot; being one such skipped operation.&lt;/p&gt;

&lt;p&gt;Because &quot;resolve&quot; was not happening, main method was remaining as &quot;main(LString;)V&quot; instead of &quot;main(Ljava.lang.String;)V&quot; and that&apos;s why it was not being recognized as the standard main method.&lt;/p&gt;</comment>
                            <comment id="14468637" author="hamletdrc" created="Wed, 6 Jan 2010 01:33:21 +0000"  >&lt;p&gt;I don&apos;t think there is any issue with the AST Builder. I wrote a Transformation called &quot;Main&quot; that adds main methods to classes and it works fine. There are two errors in the posted script: &lt;br/&gt;
  1: You must use ACC_PUBLIC | ACC_STATIC for the correct modifiers. The &amp;amp; is not correct. &lt;br/&gt;
  2: You must use Void.TYPE for the return type, Void.class is not the same. &lt;/p&gt;

&lt;p&gt;I would commit this patch to the Groovy Example directory... what do you think? &lt;/p&gt;</comment>
                            <comment id="14468602" author="roshandawrani" created="Wed, 6 Jan 2010 01:45:15 +0000"  >&lt;p&gt;Hamlet, isn&apos;t the transformation solution different from what is asked for in the example 1 - where classNode and method both are defined in AstBuilder?&lt;/p&gt;

&lt;p&gt;It was noticed that methods defined under AstBuilder (in buildFromSpec) don&apos;t get added to the defining ClassNode. Since that has not been addressed, wanted to check if AstBuilder is not supposed to support that.&lt;/p&gt;</comment>
                            <comment id="14468526" author="hamletdrc" created="Wed, 6 Jan 2010 01:55:44 +0000"  >&lt;p&gt;Yes, this solution is slightly different because I wanted to make something a little more useful. However, it did work in my testing. The problems were in the pipe character, the return type, and all that CompilationUnit/SourceUnit stuff, not in the AST builder. Maybe I should retest it after work though. &lt;/p&gt;</comment>
                            <comment id="14468619" author="roshandawrani" created="Wed, 6 Jan 2010 02:02:03 +0000"  >&lt;p&gt;No, no, you missed my point. All other things you say are fine (modifier, return type, CompilationUnit/SourceUnit association, etc), except one.&lt;/p&gt;

&lt;p&gt;This example is different from the issue #1 raised here because it is also doing the work of adding the MethodNode to the ClassNode - isn&apos;t that something that AstBuilder should also be able to do in its buildFromSpec()? &lt;/p&gt;

&lt;p&gt;Does AstBuilder not support the following (because right now, methods from the builder don&apos;t get associated with ClassNode)?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def classes= &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromSpec{
  classNode &lt;span class=&quot;code-quote&quot;&gt;&apos;MyClass&apos;&lt;/span&gt;, ACC_PUBLIC, {
    ....
    method(&lt;span class=&quot;code-quote&quot;&gt;&apos;main&apos;&lt;/span&gt;, ACC_PUBLIC &amp;amp; ACC_STATIC, &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;.class) {
        ....
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14478811" author="paulk" created="Wed, 6 Jan 2010 02:41:54 +0000"  >&lt;p&gt;Following on from Roshan&apos;s comments, currently, I can only solve the original problem using something like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.objectweb.asm.Opcodes.ACC_PUBLIC
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.objectweb.asm.Opcodes.ACC_STATIC
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.codehaus.groovy.control.CompilerConfiguration.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.builder.AstBuilder
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilationUnit

def classes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromSpec {
  classNode &lt;span class=&quot;code-quote&quot;&gt;&apos;HelloClass&apos;&lt;/span&gt;, ACC_PUBLIC, {
    classNode &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;//superclass
&lt;/span&gt;    interfaces {
      classNode GroovyObject
    }
    mixins {}
  }
}

def methods = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromSpec {
  method(&lt;span class=&quot;code-quote&quot;&gt;&apos;main&apos;&lt;/span&gt;, ACC_PUBLIC | ACC_STATIC, &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;.TYPE) {
    parameters {
      parameter &lt;span class=&quot;code-quote&quot;&gt;&apos;args&apos;&lt;/span&gt;: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[].class
    }
    exceptions{}
    block{
      expression {
        methodCall {
          variable &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;
          constant &lt;span class=&quot;code-quote&quot;&gt;&quot;println&quot;&lt;/span&gt;
          argumentList {
            constant &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello, world!&quot;&lt;/span&gt;
          }
        }
      }
    }
  }
}
def helloClass = classes[0]
def mainMethod = methods[0]
helloClass.addMethod(mainMethod)
def gcl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader()
def cu = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompilationUnit(DEFAULT, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, gcl)
cu.addClassNode(helloClass)
cu.compile()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It would be nice to have something like a {{methods&lt;/p&gt;
{...}
&lt;p&gt;}} node which allowed the two to be combined.&lt;/p&gt;</comment>
                            <comment id="14468653" author="roshandawrani" created="Wed, 6 Jan 2010 02:58:38 +0000"  >&lt;p&gt;And even on this, without a SourceUnit, all SourceUnitOperation(s) of the compilation are not happening - so no &quot;resolve&quot; is happening - all types have to be explicitly resolved, as in &quot;parameter &apos;args&apos;: String[].class&quot;&lt;/p&gt;

&lt;p&gt;Not sure whether such compile scenarios are supported by AstBuilder or not - once it goes beyond vanilla examples, differences from what compiler does normally may start coming in the way very fast - like ClassNodes not wrapped in a ModuleNode, no association with a SourceUnit, all SourceUnitOperation(s) getting skipped, etc.&lt;/p&gt;</comment>
                            <comment id="14468540" author="hamletdrc" created="Wed, 6 Jan 2010 04:19:56 +0000"  >&lt;p&gt;In my opinion, using the &quot;buildFromSpecification&quot; requires the user to know the details of the ASTNode subtypes to use effectively. Similarly, using the SwingBuilder requires the user to know about the concrete Swing types as well. The builders are a nice convenience syntactically, but are not an abstraction hiding the details. Since this is the case, I would recommend &lt;em&gt;not&lt;/em&gt; adding convenience methods to the builder. Instead, add the convenience methods to the ASTNode subtypes directly and then add the support for these to the builder. I think the builder should remain a syntatic shortcut over the ASTNodes and not start adding too much Api to it. &lt;/p&gt;</comment>
                            <comment id="14468588" author="hamletdrc" created="Wed, 6 Jan 2010 04:25:12 +0000"  >&lt;p&gt;@Roshan&lt;/p&gt;

&lt;p&gt;Your example should work fine with the AstBuilder. I guess I will have to look into it more. However, I&apos;m still not convinced there is a bug in the AstBuilder. I think the error will come down to not using the API correctly. &lt;/p&gt;

&lt;p&gt;For instance, use the same example and replace all the AstBuilder with direct ASTNode constructors... I will bet that it doesn&apos;t work that way either. &lt;/p&gt;

&lt;p&gt;The test case for this needs to be an expected result created from ASTNode subclasses and an actual result created from AstBuilder... then compare the expected ASTNode to the actual ASTNode... all this wiring together and writing a class file is immaterial to the proper functioning of the builder. &lt;/p&gt;</comment>
                            <comment id="14468569" author="roshandawrani" created="Wed, 6 Jan 2010 04:50:02 +0000"  >&lt;p&gt;Well, if I replace all AstBuilder with direct ASTNode constructors, then apart from creating ClassNode and MethodNode using their constructors, I will also have to do ClassNode.addMethod(MethodNode) manually - for the ClassNode to compile into a class that has that method.&lt;/p&gt;

&lt;p&gt;That&apos;s the question - is AstBuilder supposed to do that internally or is that the responsibility of the AstBuilder user (as in Paul&apos;s example).&lt;/p&gt;

&lt;p&gt;If it is supposed to be AstBuilder&apos;s responsibility, then it is a bug in AstBuilder curently. If it is not, then that means the following is not supported:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromSpec{
  classNode &lt;span class=&quot;code-quote&quot;&gt;&apos;MyClass&apos;&lt;/span&gt;, ACC_PUBLIC, {
    ....
    method(&lt;span class=&quot;code-quote&quot;&gt;&apos;main&apos;&lt;/span&gt;, ACC_PUBLIC &amp;amp; ACC_STATIC, &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;.class) {
        ....
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Just trying to understand how much AstBuilder supports out-of-the-box.&lt;/p&gt;</comment>
                            <comment id="14468554" author="hamletdrc" created="Wed, 6 Jan 2010 05:08:03 +0000"  >&lt;p&gt;@Roshan&lt;/p&gt;

&lt;p&gt;OK, I understand now. &lt;/p&gt;

&lt;p&gt;My reaction is that AstBuilder should not do this. But I could be convinced either way. How many edge cases like this are there, I wonder? How far in this direction do we go? &lt;/p&gt;</comment>
                            <comment id="14468636" author="roshandawrani" created="Wed, 6 Jan 2010 05:23:45 +0000"  >&lt;p&gt;I am not really sure that these are edge cases. To start with, there are FieldNode (which need the owner ClassNode in their constructor and also need to be added to ClassNode with addField()). Similarly for PropertyNodes (owner ClassNode + addProperty).&lt;/p&gt;

&lt;p&gt;First question to ask is about the purpose of AstSpecificationCompiler - whether it even wants to support the compile scenario as in this JIRA.&lt;/p&gt;

&lt;p&gt;If AstSpecificationCompiler wants to give out ClassNodes that are compilable, then I don&apos;t think it can avoid the API - it will have to setup of hierarchy of ASTNodes as the compiler expects.&lt;/p&gt;</comment>
                            <comment id="14468603" author="hamletdrc" created="Wed, 6 Jan 2010 05:35:03 +0000"  >&lt;p&gt;Yes, I see the point. Perhaps that would be a good improvement. &lt;/p&gt;</comment>
                            <comment id="14468528" author="guillaume" created="Wed, 6 Jan 2010 06:40:34 +0000"  >&lt;p&gt;I agree here that the various edge case nodes have to be &quot;added&quot; to their respective parents, like method nodes, field nodes, property nodes to their class node parent.&lt;br/&gt;
(are we missing other nodes that need to be attached to their parent?)&lt;/p&gt;</comment>
                            <comment id="14468507" author="hamletdrc" created="Wed, 6 Jan 2010 10:59:09 +0000"  >&lt;p&gt;so, to summarize: &lt;br/&gt;
we do want to auto-add these types to the parent. And this should be a minor improvement/enhancement that is part of a point release (7.1 most likely)&lt;/p&gt;</comment>
                            <comment id="14468541" author="roshandawrani" created="Wed, 6 Jan 2010 11:10:56 +0000"  >&lt;p&gt;Auto-wrapping expressions into statements may also be considered (like wrapping a MethodCallExpression into an ExpressionStatement).&lt;/p&gt;

&lt;p&gt;Currently, it has to be done manually as below&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;block{
      expression { &lt;span class=&quot;code-comment&quot;&gt;// we should see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; can be avoided at user level.
&lt;/span&gt;        methodCall {
         ....
        }
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14468654" author="guillaume" created="Wed, 6 Jan 2010 12:05:17 +0000"  >&lt;p&gt;@Hamlet, yes, a must-have minor improvement/enhancement, good for a point release in a month or so &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
@Roshan, we not necessarily mandatory, but if there are some places / cases like these ones we can help further simplify, why not!&lt;/p&gt;</comment>
                            <comment id="14468621" author="hamletdrc" created="Thu, 7 Jan 2010 06:40:05 +0000"  >&lt;p&gt;@Guillaume &lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; If there are some places / cases like these ones we can help further simplify, why not!&lt;/p&gt;

&lt;p&gt;I am a little worried about where this leads. Currently, the best documentation for the buildFromSpec is the ASTNode javadoc. This is good, as it is backed by something thoroughly unit tested and is executable in some sense. If we diverge from a a simple wrapper then we need to add some sort of documentation or risk leaving users confused. But re-document the buildFromSpec then it is a big task and duplicates much of what is there. For me, I would not make these simplifications. &lt;/p&gt;</comment>
                            <comment id="14468673" author="guillaume" created="Thu, 7 Jan 2010 16:02:36 +0000"  >&lt;p&gt;@Hamlet, yes, you&apos;re certainly right, I guess it may be a bit confusing if the builder doesn&apos;t closely follow the AST Groovy generates. So let&apos;s not do such shortcuts, and keep the structure the same in the builder and in the ASTNodes.&lt;/p&gt;</comment>
                            <comment id="14468607" author="roshandawrani" created="Thu, 7 Jan 2010 20:49:41 +0000"  >&lt;p&gt;Lost the thread a bit in the last couple of comments.&lt;/p&gt;

&lt;p&gt;We are talking about avoiding convenience short-cuts like auto-wrapping methodCall{} in expression {} and sticking 1:1 between build and AST API as far as possible, but we are still good to go on the improvement suggested to add methods/fields/properties, etc and setup the hierarchy of ASTNodes appropriately to make the ClassNode coming out of &quot;buildFromSpec&quot; compilable, right?&lt;/p&gt;</comment>
                            <comment id="14468572" author="hamletdrc" created="Fri, 8 Jan 2010 01:35:38 +0000"  >&lt;p&gt;@Roshan&lt;/p&gt;

&lt;p&gt;That is correct. &lt;/p&gt;

&lt;p&gt;&quot;We are talking about avoiding convenience short-cuts like auto-wrapping methodCall{} in expression {} and sticking 1:1 between build and AST API as far as possible, but we are still good to go on the improvement suggested to add methods/fields/properties, etc and setup the hierarchy of ASTNodes appropriately to make the ClassNode coming out of &quot;buildFromSpec&quot; compilable.&quot;&lt;/p&gt;</comment>
                            <comment id="14480573" author="paulk" created="Sun, 8 Jun 2014 05:27:16 +0000"  >&lt;p&gt;See possible solution: &lt;a href=&quot;https://github.com/groovy/groovy-core/pull/439&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/pull/439&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Current status: Allows method, constructor, property and field nodes to be embedded directly within a classNode spec currently without a wrapper helper method, e.g. &quot;methods &lt;/p&gt;
{...}
&lt;p&gt;&quot;. This makes creating classes much easier but violates the consistency of the spec in that creating every other node type involves just filling in the information from the constructor arguments. This deviates from that pattern. So, we should consider whether we want that before proceeding.&lt;/p&gt;</comment>
                            <comment id="14480539" author="paulk" created="Sun, 8 Jun 2014 14:51:57 +0000"  >&lt;p&gt;I note that annotations aren&apos;t in the constructor and are checked for and added using addAnnotations (though for methods only). So, I&apos;ll adapt the proposed solution to work like that for other cases.&lt;/p&gt;

&lt;p&gt;I also note that annotations can&apos;t be processed without a SourceUnit (leads to NPEs), so the above fragments don&apos;t support adding annotations in any case.&lt;/p&gt;</comment>
                            <comment id="14480599" author="paulk" created="Mon, 9 Jun 2014 02:09:04 +0000"  >&lt;p&gt;I&apos;ll mark as resolved since the example below now runs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// groovyjarjarasm &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; reflects using the embedded Groovy packaged asm jar
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; groovyjarjarasm.asm.Opcodes.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.builder.AstBuilder
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilerConfiguration
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.CompilationUnit

def classes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromSpec{
  classNode &lt;span class=&quot;code-quote&quot;&gt;&apos;MyClass&apos;&lt;/span&gt;, ACC_PUBLIC, {
    classNode &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;//superclass
&lt;/span&gt;    interfaces {
      classNode GroovyObject
    }
    mixins{}
    genericsTypes{}
    methods {
      method(&lt;span class=&quot;code-quote&quot;&gt;&apos;main&apos;&lt;/span&gt;, ACC_PUBLIC | ACC_STATIC, &lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;.TYPE) {
        parameters {
          parameter &lt;span class=&quot;code-quote&quot;&gt;&apos;args&apos;&lt;/span&gt;: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[].class
        }
        exceptions{}
        block {
          expression {
            methodCall {
              variable &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;
              constant &lt;span class=&quot;code-quote&quot;&gt;&quot;println&quot;&lt;/span&gt;
              argumentList {
                constant &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello, world!&quot;&lt;/span&gt;
              }
            }
          }
        }
      }
    }
  }
}

def gcl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader()
def sec = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
def ccfg = CompilerConfiguration.DEFAULT
def cu = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompilationUnit(ccfg, sec, gcl)
cu.addClassNode(classes[0])
cu.compile()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please reopen if you disagree.&lt;/p&gt;

&lt;p&gt;I&apos;ll also note that if you add annotations into the example that it will no longer compile due to a missing source unit. I&apos;m unsure how to get that working. I&apos;ll create another issue unless another developer can enlighten me as to how that would work.&lt;/p&gt;

&lt;p&gt;I&apos;ll also note that I haven&apos;t used Hamlet&apos;s patch which has an integration test. Someone wanting to add such a test is welcome to harvest the relevant section of that patch.&lt;/p&gt;</comment>
                            <comment id="14480540" author="paulk" created="Mon, 9 Jun 2014 05:46:20 +0000"  >&lt;p&gt;Just a followup to the previous comment. Setting a source unit seems to do the trick:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; groovyjarjarasm.asm.Opcodes.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.builder.AstBuilder
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.codehaus.groovy.control.CompilerConfiguration.DEFAULT
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.control.*

def classes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder().buildFromSpec{
  classNode &lt;span class=&quot;code-quote&quot;&gt;&apos;MyClass&apos;&lt;/span&gt;, ACC_PUBLIC, {
    classNode &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;
    interfaces{ classNode GroovyObject }
    mixins{}
    annotations{ annotation Deprecated }
  }
}

def gcl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader()
def cu = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompilationUnit(DEFAULT, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, gcl)
def su = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SourceUnit(&lt;span class=&quot;code-quote&quot;&gt;&quot;dummyName&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummySource&quot;&lt;/span&gt;, DEFAULT, gcl, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
ModuleNode module = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ModuleNode(su)
module.addClass(classes[0])
cu.AST.addModule(module)
cu.compile()
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyShell().evaluate &apos;&apos;&apos;
  &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&quot;MyClass&quot;&lt;/span&gt;).annotations[0].toString() == &lt;span class=&quot;code-quote&quot;&gt;&apos;@java.lang.Deprecated()&apos;&lt;/span&gt;
&apos;&apos;&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722303" name="astbuilder_example.patch" size="7570" author="hamletdrc" created="Wed, 6 Jan 2010 01:33:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bra7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>