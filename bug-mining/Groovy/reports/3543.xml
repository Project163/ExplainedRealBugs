<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:01:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7856] Adding CompileStatic via compiler config script to class with eachWithIndex results in exception in instruction selection phase</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7856</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have run into an issue when adding the CompileStatic AST transformation to a class via the Groovy compiler configscript argument.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Demo.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Demo {
    void test() {
        [&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;].eachWithIndex {&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i -&amp;gt; println &lt;span class=&quot;code-quote&quot;&gt;&quot;$i: $s&quot;&lt;/span&gt;}
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;config.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.ast.ClassNode

withConfig(configuration) {
    source(classValidator: {ClassNode classNode -&amp;gt; classNode.nameWithoutPackage == &lt;span class=&quot;code-quote&quot;&gt;&apos;Demo&apos;&lt;/span&gt;}) {
        ast(CompileStatic)
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Compile using --configscript&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ groovyc --configscript config.groovy Demo.groovy
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Output (abbreviated)&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;gt;&amp;gt;&amp;gt; a serious error occurred: BUG! exception in phase &lt;span class=&quot;code-quote&quot;&gt;&apos;instruction selection&apos;&lt;/span&gt; in source unit &lt;span class=&quot;code-quote&quot;&gt;&apos;Demo.groovy&apos;&lt;/span&gt; unexpected NullpointerException
&amp;gt;&amp;gt;&amp;gt; stacktrace:
BUG! exception in phase &lt;span class=&quot;code-quote&quot;&gt;&apos;instruction selection&apos;&lt;/span&gt; in source unit &lt;span class=&quot;code-quote&quot;&gt;&apos;Demo.groovy&apos;&lt;/span&gt; unexpected NullpointerException
    at org.codehaus.groovy.control.CompilationUnit.applyToPrimaryClassNodes(CompilationUnit.java:1058)
    at org.codehaus.groovy.control.CompilationUnit.doPhaseOperation(CompilationUnit.java:591)
    at org.codehaus.groovy.control.CompilationUnit.processPhaseOperations(CompilationUnit.java:569)
    ...
Caused by: java.lang.NullPointerException
    at org.codehaus.groovy.control.ClassNodeResolver.tryAsLoaderClassOrScript(ClassNodeResolver.java:180)
    at org.codehaus.groovy.control.ClassNodeResolver.findClassNode(ClassNodeResolver.java:170)
    at org.codehaus.groovy.control.ClassNodeResolver.resolveName(ClassNodeResolver.java:126)
  ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Notes&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Groovy &amp;amp; JVM versions: &lt;tt&gt;Groovy Version: 2.4.7 JVM: 1.8.0_92 Vendor: Oracle Corporation OS: Linux&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;Have tried Groovy versions going back to 2.4.3 and Oracle JVM 1.7.0_79&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Changing any of the following will result in no compilation error:
	&lt;ul&gt;
		&lt;li&gt;Remove the &lt;tt&gt;source(classValidator: ...)&lt;/tt&gt; code around &lt;tt&gt;ast&lt;/tt&gt;, leaving &lt;tt&gt;ast(CompileStatic)&lt;/tt&gt;, in the compiler config script&lt;/li&gt;
		&lt;li&gt;Replace the &lt;tt&gt;eachWithIndex&lt;/tt&gt; call in Demo with &lt;tt&gt;each&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;Annotate &lt;tt&gt;Demo&lt;/tt&gt; with &lt;tt&gt;@CompileStatic&lt;/tt&gt; and compile without &lt;tt&gt;--configscript&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I have detailed and demoed the bug &lt;a href=&quot;https://github.com/rvenutolo/compilestatic-compiler-config&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; with some code you can clone and run.&lt;/p&gt;</description>
                <environment>Groovy Version: 2.4.7 JVM: 1.8.0_92 Vendor: Oracle Corporation OS: Linux</environment>
        <key id="12977236">GROOVY-7856</key>
            <summary>Adding CompileStatic via compiler config script to class with eachWithIndex results in exception in instruction selection phase</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="rvenutolo">Rick Venutolo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Jun 2016 13:55:13 +0000</created>
                <updated>Mon, 20 May 2019 07:31:39 +0000</updated>
                            <resolved>Sat, 16 Mar 2019 10:40:44 +0000</resolved>
                                    <version>2.4.7</version>
                                    <fixVersion>3.0.0-beta-1</fixVersion>
                    <fixVersion>2.5.7</fixVersion>
                                    <component>Compiler</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15381618" author="paulk" created="Mon, 18 Jul 2016 01:39:21 +0000"  >&lt;p&gt;I have a temporary fix in the master branch. Basically the static compiler is trying to find the class &lt;tt&gt;Integer&lt;/tt&gt; (no package). This is taken directly from the &lt;tt&gt;@ClosureParams&lt;/tt&gt; options attribute hint. I haven&apos;t had enough time yet to work out why using &lt;tt&gt;configscript&lt;/tt&gt; doesn&apos;t do the same package name resolving as seems to occur normally (without &lt;tt&gt;configscript&lt;/tt&gt;). So for now I have &lt;tt&gt;java.lang.Integer&lt;/tt&gt; in the hint. We should really understand why this is occurring and also I haven&apos;t created a test case yet, so I&apos;ll leave the issue open for now. But any feedback in the meantime on whether this fixes things for you would be appreciated.&lt;/p&gt;</comment>
                            <comment id="15382406" author="rvenutolo" created="Mon, 18 Jul 2016 15:01:40 +0000"  >&lt;p&gt;Your temporary fix in the master branch does appear to fix this issue. This wasn&apos;t anything critical for me, so I worked around it when I encountered the issue. I am very curious to see what you find as I was only able to hit the bug under very particular circumstances, as detailed above.&lt;/p&gt;

&lt;p&gt;Thanks and good luck.&lt;/p&gt;</comment>
                            <comment id="16793929" author="emilles" created="Fri, 15 Mar 2019 20:36:50 +0000"  >&lt;p&gt;It appears that&#160;&lt;tt&gt;SourceAwareCustomizer&lt;/tt&gt; is not &lt;tt&gt;CompilationUnitAware&lt;/tt&gt;...and when its delegate is, it fails to pass along a compilation unit reference that would normally be set by &lt;tt&gt;org.codehaus.groovy.control.CompilationUnit.applyCompilationCustomizers(CompilerConfiguration)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16793935" author="emilles" created="Fri, 15 Mar 2019 20:48:51 +0000"  >&lt;p&gt;This should take care of it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.codehaus.groovy.control.customizers;
...
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DelegatingCustomizer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CompilationCustomizer &lt;span class=&quot;code-comment&quot;&gt;/*GRECLIPSE add*/&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; CompilationUnitAware&lt;span class=&quot;code-comment&quot;&gt;/*GRECLIPSE end*/&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CompilationCustomizer delegate;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DelegatingCustomizer(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CompilationCustomizer delegate) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(delegate.getPhase());
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.delegate = delegate;
    }

    &lt;span class=&quot;code-comment&quot;&gt;// GRECLIPSE add
&lt;/span&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setCompilationUnit(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CompilationUnit compilationUnit) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delegate &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CompilationUnitAware) {
            ((CompilationUnitAware) delegate).setCompilationUnit(compilationUnit);
        }
    }
    &lt;span class=&quot;code-comment&quot;&gt;// GRECLIPSE end
&lt;/span&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void call(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SourceUnit source, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; GeneratorContext context, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode classNode) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CompilationFailedException {
        delegate.call(source, context, classNode);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16794209" author="paulk" created="Sat, 16 Mar 2019 10:40:44 +0000"  >&lt;p&gt;Fix from Eric merged.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 35 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z833:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>