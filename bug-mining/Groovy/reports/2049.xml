<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:30:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5786] methods defined by one eval are &apos;lost&apos; over time</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5786</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Don&apos;t suppose it&apos;s possible that a bug has been inadvertently introduced by the fix provided in &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5187&quot; title=&quot;Groovy Script Engine creates new classes for each script and doesn&amp;#39;t get garbage collected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5187&quot;&gt;&lt;del&gt;GROOVY-5187&lt;/del&gt;&lt;/a&gt; (which GC&apos;s script classes)?&lt;/p&gt;

&lt;p&gt;Have a scenario where an eval is done, creating some classes (basically akin to including code from a separate script).  A second eval is done which depends on classes created in the first (same execution engine, obviously).  A bunch of work is done in this second eval, using lots of memory, undoubtedly invoking GC.  At a later point a method that was supposedly created by the first eval is called and is not found:&lt;/p&gt;

&lt;p&gt;MissingMethodException: No signature of method: org.codehaus.groovy.jsr223.GroovyScriptEngineImpl.getTRTimedParm()&lt;/p&gt;

&lt;p&gt;Note that it isn&apos;t even trying to associate it with a script class as it should, but with the engine itself.&lt;/p&gt;

&lt;p&gt;We were previously at version 2.0.1 which did not seem to have this problem, but I can&apos;t say for certain without going back to that version and trying this particular test case.&lt;/p&gt;

&lt;p&gt;We are working around the problem by re-evaling the first script right before the use of the &apos;missing&apos; method, which is obviously not ideal.&lt;/p&gt;

&lt;p&gt;Is there a way to tell the engine to GC on demand?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment>64 bit IBM java 1.6 jre on AIX</environment>
        <key id="12816619">GROOVY-5786</key>
            <summary>methods defined by one eval are &apos;lost&apos; over time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="danno">Dan Nimick</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Nov 2012 10:40:08 +0000</created>
                <updated>Fri, 28 Dec 2012 15:25:09 +0000</updated>
                            <resolved>Mon, 17 Dec 2012 08:56:08 +0000</resolved>
                                    <version>2.0.5</version>
                                    <fixVersion>2.0.6</fixVersion>
                    <fixVersion>1.8.9</fixVersion>
                                    <component>GroovyScriptEngine</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14473429" author="danno" created="Thu, 8 Nov 2012 05:37:48 +0000"  >&lt;p&gt;Some additional info.  &lt;/p&gt;

&lt;p&gt;If I intentionally mess up the signature of the method on first invocation the error is:&lt;/p&gt;

&lt;p&gt;MissingMethodException: No signature of method: Script5.getTRTimedParm() is applicable for argument types: (java.lang.String, java.lang.String) values: &lt;span class=&quot;error&quot;&gt;&amp;#91;abc, q&amp;#93;&lt;/span&gt;&lt;br/&gt;
Possible solutions: getTRTimedParm(java.util.Map)&lt;/p&gt;

&lt;p&gt;&apos;Proving&apos; that the method did get appropriately assigned to a script class when first evaluated.&lt;/p&gt;

&lt;p&gt;And we have confirmed that the problem does not exist in 2.0.1.&lt;/p&gt;</comment>
                            <comment id="14473466" author="blackdrag" created="Thu, 8 Nov 2012 07:26:48 +0000"  >&lt;p&gt;You are right, &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5187&quot; title=&quot;Groovy Script Engine creates new classes for each script and doesn&amp;#39;t get garbage collected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5187&quot;&gt;&lt;del&gt;GROOVY-5187&lt;/del&gt;&lt;/a&gt; and this issue are conflicting. If I go and make every method available, then the class behind that won&apos;t be collected. The whole trouble with jsr223 is, that it does not provide you with means to configure the script engine. One case suitable for one person is evil for another. So if I am going to keep the functions, I am going to keep the classes, I am going to keep the classloader that defines the class, and all classes that have been compiled along with the class the method originates from. And even if I use only stubs to have the method still there as such, but not filled, I would get a problem with your use case. We could think of using a LRU list, maybe leading to a memory problem or maybe not. If we do, we have to define a number for this. I mean I already use SoftReferences, so it is not like they are collected without need of memory.&lt;/p&gt;

&lt;p&gt;Any suggestions?&lt;/p&gt;</comment>
                            <comment id="14473618" author="markyo" created="Mon, 10 Dec 2012 17:29:42 +0000"  >&lt;p&gt;Any status update on this one? I have built a framework around the feature of loaded methods sticking around, and I too had to roll back to v2.0.1 after (painfully) discovering that the cause of my problems was that described in this jira. Until this is addressed, I&apos;m stuck on v2.0.1 indefinitely...which isn&apos;t a happy situation.&lt;/p&gt;

&lt;p&gt;As for suggestions, could we possibly pass a special flag or option into the global context?&lt;/p&gt;</comment>
                            <comment id="14473583" author="blackdrag" created="Tue, 11 Dec 2012 02:01:38 +0000"  >&lt;p&gt;I asked for suggestions and got none so far, so there has been no progress. If you tell me how to pass a special flag or option into the global context, then I will do that.&lt;/p&gt;</comment>
                            <comment id="14473543" author="markyo" created="Tue, 11 Dec 2012 10:11:26 +0000"  >&lt;p&gt;I appreciate the quick response. Well, I was thinking along the lines of setting a global attribute with an agreed-on special meaning, like:&lt;/p&gt;

&lt;p&gt;groovyEngine.getContext().setAttribute(theFlagName, theFlagValue, ScriptContext.GLOBAL_SCOPE);&lt;/p&gt;

&lt;p&gt;Or perhaps we just set it at the script manager level like so:&lt;/p&gt;

&lt;p&gt;ScriptEngineManager manager = new ScriptEngineManager();&lt;/p&gt;

&lt;p&gt;manager.put(theFlagName, theFlagValue);&lt;/p&gt;

&lt;p&gt;So if the engine sees this special flag, it will read the value and configure accordingly. Would something like that not work?&lt;/p&gt;

&lt;p&gt;Maybe another way would be to pass in a groovy script to be evaluated-&lt;del&gt;like any other script&lt;/del&gt;-except that it would be a special configuration script with options/flags like this one (but can accommodate other configuration options as well). We&apos;d just have to figure out (agree on) a way to differentiate this &quot;meta&quot; script from other application-specific scripts.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a deep enough knowledge of the jsr spec and the internals of the implementation, so please, you tell me if what I&apos;m suggesting is even workable.&lt;/p&gt;</comment>
                            <comment id="14473507" author="danno" created="Tue, 11 Dec 2012 10:25:47 +0000"  >&lt;p&gt;Blackdrag, Sorry for the lack of suggestions.  I&apos;m in the same camp as Mark, not knowing what the spec allows.  The &apos;obvious&apos; to me is that:&lt;/p&gt;

&lt;p&gt;1) The behavior in 2.0.1 and prior was X&lt;br/&gt;
2) The behavior after that is Y&lt;br/&gt;
3) Therefore you have control over the behavior&lt;br/&gt;
4) So add a method to GroovyScriptEngineImpl that lets the user pick&lt;/p&gt;

&lt;p&gt;Perhaps something like setCollectionStrategy, which at present might have two options - NONE for the old behavior, and EAGER for the current behavior.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Dan&lt;/p&gt;</comment>
                            <comment id="14473620" author="markyo" created="Tue, 11 Dec 2012 10:32:30 +0000"  >&lt;p&gt;Agreed with Dan, if the jsr 223 interface doesn&apos;t allow for such configurability, and what I&apos;m suggesting is not workable or desirable, then we should be able to at least configure the implementation (e.g., special property on GroovyScriptEngineImpl) to get us back to the desired behavior. It&apos;s not ideal, but still way better than being stuck on v2.0.1 indefinitely.&lt;/p&gt;</comment>
                            <comment id="14473490" author="danno" created="Tue, 11 Dec 2012 10:36:08 +0000"  >&lt;p&gt;Mark,&lt;/p&gt;

&lt;p&gt;Our problem with this only manifested itself on methods added to the base script via a secondary eval.  We have not seen it on any methods in the base script itself.  I.e. if there is only a single ScriptX class created it seems to be fine, but if there are additional classes created by other evals, it&apos;s those that go missing over time.&lt;/p&gt;

&lt;p&gt;We have worked around it by creating our own references to those ScriptX objects, thereby keeping them from being garbage collected.  This is done by returning &apos;this&apos; as the last statement in the secondary script being eval&apos;d, and then using that reference in calls to methods in that object.&lt;/p&gt;

&lt;p&gt;For example,&lt;/p&gt;

&lt;p&gt;secondary script {&lt;br/&gt;
...&lt;br/&gt;
String ABC(String thing) {&lt;br/&gt;
do stuff&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;return this&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;main script {&lt;br/&gt;
...&lt;br/&gt;
secondScript = eval(secondary script)&lt;br/&gt;
...&lt;br/&gt;
newThing = secondScript.ABC(oldThing)&lt;br/&gt;
...&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;There&apos;s a bit more to it in our implementation as the eval&apos;s are actually being done by calls from Java, but hopefully that gives you the idea.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Dan&lt;/p&gt;</comment>
                            <comment id="14473582" author="blackdrag" created="Tue, 11 Dec 2012 14:07:50 +0000"  >&lt;p&gt;If there were no conflict with &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5187&quot; title=&quot;Groovy Script Engine creates new classes for each script and doesn&amp;#39;t get garbage collected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5187&quot;&gt;&lt;del&gt;GROOVY-5187&lt;/del&gt;&lt;/a&gt; I would simply revert the change and resolve the issue. But since that issue is there I have conflicting goals to handle. That is my problem. The JSR223 of course doesn&apos;t make things more easy here. ScriptContext attributes or Bindings are imho not intended to be used like this, also not through ScriptManager. Anything you put in there becomes available by the script you run. Thus the intentions is imho to interact with the script, not to configure the engine. A method on GroovyScriptEngineImpl also won&apos;t do it in Java world. To actually call the method you would then need GroovyScriptEngineImpl, not javax.script.ScriptEngine. Having a meta like script is an interesting idea. The engine provides a ScriptContext, which we could extend to aid.&lt;/p&gt;


&lt;p&gt;Anyway... that makes three paths:&lt;br/&gt;
(1) provide a method on GroovyScriptEngineImpl&lt;br/&gt;
Pro: simple to implement&lt;br/&gt;
Con: invisible to Java, since you will require a cast to GroovyScriptEngineImpl. And if you have to do that, why would you not use something else in Groovy instead?&lt;br/&gt;
(2) use an attribute&lt;br/&gt;
Pro: simple to implement, simple to use&lt;br/&gt;
Con: these are not to be used for configuration and there is a low danger of conflicts with values for scripts&lt;br/&gt;
(3) use a configuration script&lt;br/&gt;
Pro: is independent of that JSR&lt;br/&gt;
Con: requires more changes plus a special &quot;setup&quot; script&lt;/p&gt;

&lt;p&gt;Right now I see 2 as a misuse of the JSR, but at the same time for the best bet. Imho the conflict potential is not zero, but should be fairly low. What do others think?&lt;/p&gt;</comment>
                            <comment id="14473619" author="markyo" created="Tue, 11 Dec 2012 14:38:53 +0000"  >&lt;p&gt;I agree that option #2 may be our best bet. As for the possibility of conflicts, I think if we pass in a key that is not a legal identifier name, that would help reduce or eliminate that. For example, scriptManager.put(&quot;#optionName&quot;, &quot;optionValue&quot;), or whatever prefix that would make the key an illegal identifier (I just chose &apos;#&apos; as an example). There may be other configuration options in addition to this one, and they can all be prefixed in the same, agreed upon way. What do you think?&lt;/p&gt;</comment>
                            <comment id="14473572" author="guillaume" created="Tue, 11 Dec 2012 14:46:03 +0000"  >&lt;p&gt;The lack of configurability has always bugged me with that JSR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I think option 2) is our best bet.&lt;br/&gt;
If we do use some very specific attribute names like &quot;groovy.jsr233.foo&quot; or with some special characters, we won&apos;t risk any conflicts.&lt;br/&gt;
I just hope that people don&apos;t really rely on the number of attributes present, or something like that.&lt;/p&gt;</comment>
                            <comment id="14473443" author="markyo" created="Tue, 11 Dec 2012 14:47:08 +0000"  >&lt;p&gt;Dan, thank you for sharing your workaround. I don&apos;t think it&apos;ll work well in my case, since what I do is load a bunch of library (which contain the various utility methods--what you&apos;re calling the secondary scripts) and configuration scripts (contain configuration options) associated with some script context (not jsr223 context, but one defined in my own object model), and only then do I run my application script (what you&apos;re calling the base script). This is how my framework is designed, and so it heavily depends on being able to load such &quot;library&quot; scripts each time before running the actual application script.&lt;/p&gt;</comment>
                            <comment id="14473544" author="danno" created="Tue, 11 Dec 2012 15:40:29 +0000"  >&lt;p&gt;I don&apos;t follow why option 1 is &quot;invisible to Java, ... why would you not use something else in Groovy instead?&quot;&lt;/p&gt;

&lt;p&gt;I agree if you don&apos;t know what kind of ScriptEngine was instantiated you&apos;re kind of out of luck (but even then you can determine what the real class is), but in our case we&apos;re doing this:&lt;/p&gt;

&lt;p&gt;  protected ScriptEngine createScriptEngine() &lt;/p&gt;
{
    ScriptEngine eng = scriptEngineManager.getEngineByName(&quot;groovy&quot;);
    GroovyScriptEngineImpl engine = (GroovyScriptEngineImpl)eng;
    engine.setClassLoader(createGroovyClassLoader());
    return engine;
  }

&lt;p&gt;So we do, in fact, know with certainty what kind of ScriptEngine we have.&lt;/p&gt;

&lt;p&gt;What is the &quot;something else&quot; we should be doing in Groovy instead?&lt;/p&gt;

&lt;p&gt;That said, I have no particular preference for option 1 vs 2 (given some relatively obscure name of the attribute to avoid conflicts as has already been suggested).&lt;/p&gt;</comment>
                            <comment id="14473509" author="danno" created="Tue, 11 Dec 2012 15:48:50 +0000"  >&lt;p&gt;Mark, Agreed that our solution is difficult to manage on a large number of application and library scripts (we use exactly that same method in what I called base and secondary as you surmised).  We were able to &apos;install&apos; this change relatively easily because&lt;/p&gt;

&lt;p&gt;a) All our application scripts are stored in a database, so simple matter of doing a query to find all of them that include use of a library script (our base library provides a specific syntax for loading library scripts), and in most cases just a straight sql REPLACE to cause the script to use the new syntax&lt;br/&gt;
b) We have less than 10 library scripts that needed to be modified to &apos;return this&apos;&lt;br/&gt;
c) User&apos;s complain quickly and loudly when the script gets a missing method exception, so didn&apos;t take long to find places we missed in a).&lt;/p&gt;

&lt;p&gt;Just FWIW...&lt;/p&gt;</comment>
                            <comment id="14473574" author="blackdrag" created="Wed, 12 Dec 2012 04:14:46 +0000"  >&lt;p&gt;The something else I was thinking of is the other GroovyScriptEngine, or even GroovyShell. On the other hand you still depend on the API I guess and the other two don&apos;t make the methods visible like requested here. So maybe I am wrong and they are not really options after all.&lt;/p&gt;

&lt;p&gt;Anyway... since most agree fully I guess we go with option 2&lt;/p&gt;</comment>
                            <comment id="14473621" author="markyo" created="Wed, 12 Dec 2012 06:23:01 +0000"  >&lt;p&gt;Blackdrag and Guillaume, thank you so much for the quick response to our needs. Your work is greatly appreciated, and I have to say that the more I work with Groovy the more I fall in love with how empowering it is to the Java programmer. In just a few years even it has come a long way for sure, and being able to embed scripts within our Java programs is just amazing.&lt;/p&gt;

&lt;p&gt;I&apos;ve never been involved in an open source project, though I&apos;ve been feeling the urge to contribute. I&apos;m pretty good at generic programming and tend to write more frameworks and libraries at my jobs with applications layered on top. So if there&apos;s a need somewhere in the Groovy community please let me know how I may join up and contribute.&lt;/p&gt;</comment>
                            <comment id="14473558" author="blackdrag" created="Mon, 17 Dec 2012 08:45:05 +0000"  >&lt;p&gt;Mark, if you want to contribute, just take anything you don&apos;t like, maybe tell us on the dev list and then have fun fixing. We are always happy to have people contribute.&lt;/p&gt;

&lt;p&gt;Back to the issue.. I added a &quot;#jsr223.groovy.engine.keep.globals&quot; key that is queried for before an eval in the script context. &lt;a href=&quot;http://groovy.codehaus.org/JSR+223+Scripting+with+Groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://groovy.codehaus.org/JSR+223+Scripting+with+Groovy&lt;/a&gt; explains what is supported. I decided the default should be hard references, since that is what has been there before. So the people having issues here will not have to change their code and it should just work. Though testing would be nice &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14473623" author="blackdrag" created="Mon, 17 Dec 2012 08:56:08 +0000"  >&lt;p&gt;the issue should be resolved now, testing is appreciated&lt;/p&gt;</comment>
                            <comment id="14473661" author="markyo" created="Fri, 28 Dec 2012 15:25:09 +0000"  >&lt;p&gt;That&apos;s great, thank you. I&apos;m going to switch to 2.0.6 now and will let you know within a few days whether I encounter the issue again.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cnw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>