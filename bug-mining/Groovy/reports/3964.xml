<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:09:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9662] Groovy 3.0.5: Closure delegate is not working properly</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9662</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;In Grails Views, we are using closures to generate JSON using &lt;tt&gt;StreamingJsonBuilder&lt;/tt&gt;. The HAL implementation for an entity now generates an incorrect JSON after updating to Groovy 3.&lt;/p&gt;

&lt;p&gt;Here is the problem code snipped from &lt;tt&gt;grails.plugin.json.view.api.internal.DefaultHalViewHelper#links&lt;/tt&gt;:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jsonDelegate.call(LINKS_ATTRIBUTE) {
    call(SELF_ATTRIBUTE) {
        call HREF_ATTRIBUTE, viewHelper.link(resource: object, method: HttpMethod.GET, absolute: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        call HREFLANG_ATTRIBUTE, locale.toString()

        call TYPE_ATTRIBUTE, contentType
    }

    Set&amp;lt;Link&amp;gt; links = getLinks(object)
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (link in links) {
        call(link.rel) {
            call HREF_ATTRIBUTE, link.href
            call HREFLANG_ATTRIBUTE, link.hreflang?.toString() ?: locale.toString()
            def linkType = link.contentType
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (linkType) {
                call TYPE_ATTRIBUTE, linkType
            }
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Although the `resolveStatergy` for the closures is `DELEGATE_FIRST` but I believe that is not working correctly because it works if I change the above to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
delegate.call (...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To reproduce the issue please checkout&#160;&lt;a href=&quot;https://github.com/grails/grails-views/commits/bugs/groovy-9962&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grails/grails-views/commits/bugs/groovy-9962&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13319551">GROOVY-9662</key>
            <summary>Groovy 3.0.5: Closure delegate is not working properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="behlp">Puneet Behl</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Jul 2020 13:36:20 +0000</created>
                <updated>Mon, 15 Aug 2022 15:49:38 +0000</updated>
                            <resolved>Thu, 24 Dec 2020 17:48:31 +0000</resolved>
                                    <version>3.0.2</version>
                    <version>3.0.3</version>
                    <version>3.0.4</version>
                    <version>3.0.5</version>
                    <version>2.5.14</version>
                                    <fixVersion>2.5.15</fixVersion>
                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>4.0.0-alpha-3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17165812" author="emilles" created="Mon, 27 Jul 2020 16:02:50 +0000"  >&lt;p&gt;Am I correct in understanding that &lt;tt&gt;call (...) ...&lt;/tt&gt; is expected to be resolving &quot;call&quot; against the delegate?  There was a change to give Closure&apos;s methods like &quot;getDelegate()&quot;, &quot;getResolveStrategy()&quot;, etc. a higher priority so that any delegate that implements methodMissing would not trap them.  &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-9604&quot; title=&quot;STC: method or property missing errors for Closure&amp;#39;s getResolveStrategy(), etc.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-9604&quot;&gt;&lt;del&gt;GROOVY-9604&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/groovy/commit/f60285ec072821502f33d7a999b5574bee53b6e2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/f60285ec072821502f33d7a999b5574bee53b6e2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17165822" author="behlp" created="Mon, 27 Jul 2020 16:19:44 +0000"  >&lt;p&gt;Yes, it should be calling the delegate. It works when I change the code as in the commit&#160;&lt;a href=&quot;https://github.com/grails/grails-views/commit/d706f1b4011bdb8f9040a59557bde9fc11dfbe66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dfbe66&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17165856" author="emilles" created="Mon, 27 Jul 2020 17:11:10 +0000"  >&lt;p&gt;It is this bit that finds &quot;call&quot; and other methods of Closure.&#160; &lt;tt&gt;if (mn.isEmpty() &amp;amp;&amp;amp; call.isImplicitThis() &amp;amp;&amp;amp; isThisExpression(objectExpression) &amp;amp;&amp;amp; typeCheckingContext.getEnclosingClosure() != null) mn = CLOSURE_TYPE.getDeclaredMethods(name);&lt;/tt&gt; in StaticTypeCheckingVisitor#visitMethodCallExpression.  Guarding against &quot;call&quot; would probably do the trick.&lt;/p&gt;

&lt;p&gt;When the same code is not static compiled, does &quot;call&quot; refer to your delegate method or the method on Closure?&lt;/p&gt;</comment>
                            <comment id="17165862" author="emilles" created="Mon, 27 Jul 2020 17:20:10 +0000"  >&lt;p&gt;When I try this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;D {
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; call(... args) {
    println &lt;span class=&quot;code-quote&quot;&gt;&quot;D.call(${args})&quot;&lt;/span&gt;
    args[1].call(args[0])
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C {
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; test() {
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; D().with { ... args -&amp;gt;
      println &lt;span class=&quot;code-quote&quot;&gt;&quot;C.test.with&quot;&lt;/span&gt;
      call (123) {
        println &lt;span class=&quot;code-quote&quot;&gt;&quot;C.test.with.call&quot;&lt;/span&gt;
      }
    }
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; C().test()&#8203;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I get a stack overflow for &quot;call&quot; in dynamic mode, so the runtime is resolving &quot;call&quot; against the Closure instance and not the delegate.  Thus, I&apos;m hesitant to change the SC precedence of Closure methods.  Adding a &quot;delegate.&quot; qualifier is a safer long-term bet that is also cross-compatible with pre-3.0.5 Groovy.&lt;/p&gt;</comment>
                            <comment id="17201514" author="paulk" created="Thu, 24 Sep 2020 13:12:42 +0000"  >&lt;p&gt;For any method name apart from &lt;tt&gt;call&lt;/tt&gt; and &lt;tt&gt;doCall&lt;/tt&gt;, dynamic Groovy will call the delegate. There is special logic for those names. Static Groovy has had different behavior for those methods.&lt;/p&gt;</comment>
                            <comment id="17202930" author="emilles" created="Sun, 27 Sep 2020 22:01:18 +0000"  >&lt;p&gt;ClosureMetaClass checks the closure for any method right after the call/doCall block.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; invokeMethod(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; sender, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; object, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; methodName, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] originalArguments, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCallToSuper, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fromInsideClass) {
        ...
        MetaMethod method = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Closure closure = (Closure) object;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (CLOSURE_DO_CALL_METHOD.equals(methodName) || CLOSURE_CALL_METHOD.equals(methodName)) {
            ...
        }
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; shouldDefer = closure.getResolveStrategy() == Closure.DELEGATE_ONLY &amp;amp;&amp;amp; isInternalMethod(methodName);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (method == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !shouldDefer) {
            method = CLOSURE_METACLASS.pickMethod(methodName, argClasses); &lt;span class=&quot;code-comment&quot;&gt;// HERE!
&lt;/span&gt;        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (method != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; method.doMethodInvoke(object, arguments);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is a quick demonstration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;D {
  void run() { println &lt;span class=&quot;code-quote&quot;&gt;&apos;D.run()&apos;&lt;/span&gt; }
}
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C {
  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; times = 5
  void test() {
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; D().with {
      println &lt;span class=&quot;code-quote&quot;&gt;&quot;C.test.with $times&quot;&lt;/span&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (--times) run() &lt;span class=&quot;code-comment&quot;&gt;// Closure.run() or D.run()?
&lt;/span&gt;    }
  }
}
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; C().test()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17202939" author="blackdrag" created="Mon, 28 Sep 2020 00:40:35 +0000"  >&lt;p&gt;The problem with that runtime meta class is, that we actually have to know if we do &quot;someClosure()&quot;/&quot;someClosure.call()&quot; or something like &quot;x.foo { call() }&quot;. The first I name a call from outside, the second a call from inside. So if everything would be wired correctly you would use the &quot;sender&quot; information in that invokeMethod up there to determine if the call is from inside or not. My last information in this area was, that the sender information is in general not reliable - that is for example because of the optional invokeMethod path. Maybe it is for reliable enough for open blocks like in &quot;x.foo { call() }&quot; and worth implementing in ClosureMetaClass. Of course that comes with another problem... assuming we do want recursive call invocations, but have that new logic implemented, then how would you do it? And for that matter... how do I do it now in static compiled code if the delegation mechanism is set? And maybe it is sometimes better to say, that you cannot do that then. Meaning no calls on the closure implementing the block from inside the block itself.&lt;/p&gt;</comment>
                            <comment id="17202963" author="emilles" created="Mon, 28 Sep 2020 02:17:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=behlp&quot; class=&quot;user-hover&quot; rel=&quot;behlp&quot;&gt;behlp&lt;/a&gt; It looks like there are JSON builder tests just like the one above: &lt;a href=&quot;https://github.com/apache/groovy/blob/master/subprojects/groovy-json/src/test/groovy/groovy/json/StreamingJsonBuilderTest.groovy#L27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/master/subprojects/groovy-json/src/test/groovy/groovy/json/StreamingJsonBuilderTest.groovy#L27&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Can you describe what is the expected JSON from your example?  Can you provide a self-contained example?&lt;/p&gt;</comment>
                            <comment id="17202987" author="paulk" created="Mon, 28 Sep 2020 03:56:47 +0000"  >&lt;p&gt;From the log when I run tests in the grails-views/views-json subproject:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;result.jsonText == &apos;{&quot;_links&quot;:{&quot;self&quot;:{&quot;href&quot;:&quot;http://localhost:8080/player&quot;,&quot;hreflang&quot;:&quot;en&quot;,&quot;type&quot;:&quot;application/hal+json&quot;}},&quot;name&quot;:&quot;Cantona&quot;}&apos;
    |      |        |
    |      |        false
    |      |        1 difference (99% similarity)
    |      |        {&quot;_links&quot;:{&quot;self&quot;:{(,)&quot;href&quot;:&quot;http://localhost:8080/player&quot;,&quot;hreflang&quot;:&quot;en&quot;,&quot;type&quot;:&quot;application/hal+json&quot;}},&quot;name&quot;:&quot;Cantona&quot;}
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Each level during json rendering has its own closure with a delegate having a boolean property &lt;tt&gt;first&lt;/tt&gt; which is checked to avoid a comma before the first element at that level. Here, &lt;tt&gt;first&lt;/tt&gt; from an outer level (where it is already set to false) is returned, hence the extra comma one level down. I haven&apos;t yet had time to produce a standalone example.&lt;/p&gt;</comment>
                            <comment id="17209668" author="emilles" created="Wed, 7 Oct 2020 16:40:08 +0000"  >&lt;p&gt;The difference in behavior comes from the static compiler using more of the declared delegation metadata.&#160; &lt;tt&gt;grails.plugin.json.builder.StreamingJsonBuilder.StreamingJsonDelegate #cloneDelegateAndGetContent&lt;/tt&gt; and &lt;tt&gt;#curryDelegateAndGetContent&lt;/tt&gt; uses &lt;tt&gt;groovy.lang.DelegatesTo&lt;/tt&gt; to indicate the type of the closure&apos;s delegate, but does not correctly indicate the resolve strategy.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;strategy = Closure.DELEGATE_FIRST&quot;&lt;/span&gt; was added to match how the closure is actually invoked
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void curryDelegateAndGetContent(Writer w, @DelegatesTo(value = StreamingJsonDelegate.class, strategy = Closure.DELEGATE_FIRST) Closure c, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; first, JsonGenerator generator) {
            StreamingJsonDelegate delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamingJsonDelegate(w, first, generator);
            Closure curried = c.curry(o);
            curried.setDelegate(delegate);
            curried.setResolveStrategy(Closure.DELEGATE_FIRST);
            curried.call();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If I propagate the resolve strategy to all callers of this method (in &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13013201/13013201_StreamingJsonBuilder.java&quot; title=&quot;StreamingJsonBuilder.java attached to GROOVY-9662&quot;&gt;StreamingJsonBuilder.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13013206/13013206_JsonViewWritableScript.groovy&quot; title=&quot;JsonViewWritableScript.groovy attached to GROOVY-9662&quot;&gt;JsonViewWritableScript.groovy&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, JsonView, etc.) the test case works as expected.&lt;/p&gt;</comment>
                            <comment id="17209709" author="emilles" created="Wed, 7 Oct 2020 17:21:07 +0000"  >&lt;p&gt;Also, the call methods in StreamingJsonBuilder/StreamingJsonDelegate that take iterable or collection could be enhanced with &lt;tt&gt;@ClosureParams&lt;/tt&gt; metadata so the calling closure would gain type inference on its parameter.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;public &amp;lt;T&amp;gt; void call(String name, Iterable&amp;lt;T&amp;gt; coll, @ClosureParams(value = SecondParam.FirstGenericsType.class) @DelegatesTo(value = StreamingJsonDelegate.class, strategy = Closure.DELEGATE_FIRST) Closure c)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17251769" author="behlp" created="Fri, 18 Dec 2020 13:45:59 +0000"  >&lt;p&gt;This is also happening with Grails Framework after updating to Groovy 2.5.14, the following code does not behave the same with `CompileStatic`:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.json.JsonOutput
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.json.StreamingJsonBuilder
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.springframework.http.HttpMethod
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.springframework.validation.ObjectError

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;VndErrorJsonRenderer {

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LOGREF_ATTRIBUTE = &lt;span class=&quot;code-quote&quot;&gt;&apos;logref&apos;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; MESSAGE_ATTRIBUTE = &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; PATH_ATTRIBUTE = &lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RESOURCE_ATTRIBUTE = &lt;span class=&quot;code-quote&quot;&gt;&quot;resource&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; HREF_ATTRIBUTE = &lt;span class=&quot;code-quote&quot;&gt;&quot;href&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LINKS_ATTRIBUTE = &lt;span class=&quot;code-quote&quot;&gt;&quot;_links&quot;&lt;/span&gt;

    Writer targetWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter()

    void render() {

        StreamingJsonBuilder writer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamingJsonBuilder(targetWriter)

        writer.call { ObjectError oe-&amp;gt;
                writer
                call(LOGREF_ATTRIBUTE, &lt;span class=&quot;code-quote&quot;&gt;&quot;logref&quot;&lt;/span&gt;)
                call(MESSAGE_ATTRIBUTE, &lt;span class=&quot;code-quote&quot;&gt;&quot;msg&quot;&lt;/span&gt;)
                call(PATH_ATTRIBUTE, &lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080&quot;&lt;/span&gt;)
&lt;/span&gt;                call(LINKS_ATTRIBUTE) {
                    call(RESOURCE_ATTRIBUTE) {
                        call(HREF_ATTRIBUTE, &lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;)
                    }
                }

        }
        targetWriter.flush()
    }
}

def vndErrorJsonRenderer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VndErrorJsonRenderer()
vndErrorJsonRenderer.render()

JsonOutput.prettyPrint(vndErrorJsonRenderer.targetWriter.toString())

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17251852" author="jeffscottbrown" created="Fri, 18 Dec 2020 16:34:48 +0000"  >&lt;p&gt;The project at &lt;a href=&quot;https://github.com/jeffbrown/groovy9662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffbrown/groovy9662&lt;/a&gt; represents one of the scenarios we have had trouble with.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/main/groovy/groovy9662/MyCustomDelegate.groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/main/groovy/groovy9662/MyCustomDelegate.groovy&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;lib/src/main/groovy/groovy9662/MyCustomDelegate.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovy9662

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyCustomDelegate {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getMessage() {
        &lt;span class=&quot;code-quote&quot;&gt;&apos;Message From Closure Delegate&apos;&lt;/span&gt;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/main/groovy/groovy9662/Library.groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/main/groovy/groovy9662/Library.groovy&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;lib/src/main/groovy/groovy9662/Library.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovy9662

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Library {

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; invokeClosure(@DelegatesTo(value = MyCustomDelegate) Closure c) {
        c.resolveStrategy = Closure.DELEGATE_FIRST
        c.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyCustomDelegate()
        c()
    }

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; doSomeWork() {
        invokeClosure {
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will be dispatched to the delegate
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// as expected because of the code above
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// inside of the invokeClosure method
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// which is setting the strategy to DELEGATE_FIRST
&lt;/span&gt;            getMessage()
        }
    }

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getMessage() {
        &lt;span class=&quot;code-quote&quot;&gt;&apos;Message From Closure Owner (Library)&apos;&lt;/span&gt;
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/main/groovy/groovy9662/LibraryCompileStatic.groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/main/groovy/groovy9662/LibraryCompileStatic.groovy&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;lib/src/main/groovy/groovy9662/LibraryCompileStatic.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovy9662

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LibraryCompileStatic {

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; invokeClosure(@DelegatesTo(value = MyCustomDelegate) Closure c) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; resolve strategy does not have an affect
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// because the closure has been statically
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// compiled to delegate to the owner, possibly
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// because that is the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; value of the strategy
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// attribute in @DelegatesTo.
&lt;/span&gt;        c.resolveStrategy = Closure.DELEGATE_FIRST
        c.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyCustomDelegate()
        c()
    }

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; doSomeWork() {
        invokeClosure {
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will be dispatched to the owner even
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// thou the invokeClosure method is setting
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// strategy to DELEGATE_FIRST.
&lt;/span&gt;            getMessage()
        }
    }

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getMessage() {
        &lt;span class=&quot;code-quote&quot;&gt;&apos;Message From Closure Owner (Library)&apos;&lt;/span&gt;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/test/groovy/groovy9662/LibraryTest.groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffbrown/groovy9662/blob/f823bec082aa59fc1e6166fc2bf71390c0a025a5/lib/src/test/groovy/groovy9662/LibraryTest.groovy&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;lib/src/test/groovy/groovy9662/LibraryTest.groovy&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovy9662

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; spock.lang.Specification

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LibraryTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Specification {

    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; test passes
&lt;/span&gt;    def &lt;span class=&quot;code-quote&quot;&gt;&quot;test dynamically dispatched library&quot;&lt;/span&gt;() {
        expect:
        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Library().doSomeWork() == &lt;span class=&quot;code-quote&quot;&gt;&apos;Message From Closure Delegate&apos;&lt;/span&gt;
    }

    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; test fails
&lt;/span&gt;    def &lt;span class=&quot;code-quote&quot;&gt;&quot;test statically  dispatched library&quot;&lt;/span&gt;() {
        expect:
        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LibraryCompileStatic().doSomeWork() == &lt;span class=&quot;code-quote&quot;&gt;&apos;Message From Closure Delegate&apos;&lt;/span&gt;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17251862" author="emilles" created="Fri, 18 Dec 2020 16:47:36 +0000"  >&lt;p&gt;This is a common case where the delegation metadata does not match the runtime resolve strategy.  &lt;tt&gt;DelegatesTo&lt;/tt&gt; has a default resolve strategy of &lt;tt&gt;OWNER_FIRST&lt;/tt&gt; (as does &lt;tt&gt;Closure&lt;/tt&gt;).  So by not specifying &lt;tt&gt;strategy&lt;/tt&gt; attribute, the compiler gets the default.  Static compilation must choose a resolve strategy and it relies on the annotation metadata to do so.  &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8394&quot; title=&quot;@CompileStatic doesn&amp;#39;t respect resolve strategy on closures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8394&quot;&gt;&lt;del&gt;GROOVY-8394&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-9283&quot; title=&quot;Nested closures run on wrong delegate&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-9283&quot;&gt;&lt;del&gt;GROOVY-9283&lt;/del&gt;&lt;/a&gt; discuss this further.  I think &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-9086&quot; title=&quot;@CompileStatic of closure calls with OWNER_FIRST fail at runtime with ClassCastException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-9086&quot;&gt;&lt;del&gt;GROOVY-9086&lt;/del&gt;&lt;/a&gt; is where the change comes from.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
void test(@DelegatesTo(value=Type) block) {
  block.resolveStrategy = Closure.DELEGATE_FIRST
  block.delegate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Type()
  block.call()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17252210" author="emilles" created="Sat, 19 Dec 2020 16:06:01 +0000"  >&lt;p&gt;Fix made for Groovy&apos;s version of &lt;tt&gt;StreamingJsonBuilder&lt;/tt&gt; in Groovy 2.5+.  You can make same or similar changes to Grails Views&apos; copy (see attachments) or switch to using Groovy&apos;s &lt;tt&gt;StreamingJsonBuilder&lt;/tt&gt;.  These changes are cross-compatible with earlier Groovy versions, since the old behavior was to check the delegate first.&lt;/p&gt;

&lt;p&gt;Is a fix for the JSON builders sufficient for this ticket?  The closure resolve strategy handling is working as intended to fix other issues.  The breaking change was unintended/unanticipated.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13262468">GROOVY-9279</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13013206" name="JsonViewWritableScript.groovy" size="5761" author="emilles" created="Wed, 7 Oct 2020 17:37:20 +0000"/>
                            <attachment id="13013201" name="StreamingJsonBuilder.java" size="30399" author="emilles" created="Wed, 7 Oct 2020 16:39:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 47 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0h8ew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>