<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:31:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5980] Finally executes twice on NPE while casting method result</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5980</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Follwing scriplet prints &apos;in finally&apos; twice:&lt;/p&gt;

&lt;p&gt;f();&lt;/p&gt;

&lt;p&gt;int f() {&lt;/p&gt;

&lt;p&gt;	try &lt;/p&gt;
{
		return null
	}
&lt;p&gt; finally &lt;/p&gt;
{
		println &apos;in finally&apos;
	}
&lt;p&gt;}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12816764">GROOVY-5980</key>
            <summary>Finally executes twice on NPE while casting method result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="asteingress">Andre Steingress</assignee>
                                    <reporter username="salaev">Sergey Alaev</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Feb 2013 07:54:03 +0000</created>
                <updated>Sat, 16 Feb 2013 00:47:28 +0000</updated>
                            <resolved>Tue, 12 Feb 2013 09:28:36 +0000</resolved>
                                    <version>1.8.8</version>
                    <version>2.0.6</version>
                    <version>2.1.0</version>
                                    <fixVersion>1.8.9</fixVersion>
                    <fixVersion>2.0.7</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0-beta-1</fixVersion>
                                    <component>bytecode</component>
                    <component>Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14474144" author="asteingress" created="Mon, 11 Feb 2013 16:20:48 +0000"  >&lt;p&gt;Be aware that this fix patches the symptom only: &lt;a href=&quot;https://github.com/groovy/groovy-core/pull/139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/pull/139&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; f() {
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; { println &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; }
}
f()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;causes the finally block to be executed two times. When having a look at the bytecode, you can see that loading and storing the const and unboxing it to an integer is indeed separated into two code blocks by the block recorder mechanism in StatementWriter#writeReturm/#writeTryCatchFinally.&lt;/p&gt;

&lt;p&gt;In StatementWriter#writeReturn the finally block is embedded right after loading the first code block (loading and storing the null constant):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; f();
    flags: ACC_PUBLIC
    Code:
      stack=3, locals=4, args_size=1
         0: invokestatic  #20                 &lt;span class=&quot;code-comment&quot;&gt;// Method $getCallSiteArray:()[Lorg/codehaus/groovy/runtime/callsite/CallSite;
&lt;/span&gt;         3: astore_1      
         4: aconst_null   
         5: astore_2      
         6: nop           
         7: aload_1       
         8: ldc           #74                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; 2
&lt;/span&gt;        10: aaload        
        11: aload_0       
        12: ldc           #76                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test
&lt;/span&gt;        14: invokeinterface #79,  3           &lt;span class=&quot;code-comment&quot;&gt;// InterfaceMethod org/codehaus/groovy/runtime/callsite/CallSite.callCurrent:(Lgroovy/lang/GroovyObject;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;        19: pop           
        20: nop           
        21: aload_2       
        22: invokestatic  #85                 &lt;span class=&quot;code-comment&quot;&gt;// Method org/codehaus/groovy/runtime/typehandling/DefaultTypeTransformation.intUnbox:(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)I
&lt;/span&gt;        25: ireturn       
        26: &lt;span class=&quot;code-keyword&quot;&gt;goto&lt;/span&gt;       
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is the DefaultTypeTransformation is failing to convert null to int. As a consequence, the catchAny block - filled with the finally statement code - is executed again.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;6: &lt;span class=&quot;code-keyword&quot;&gt;goto&lt;/span&gt;          29
        29: aload_1       
        30: ldc           #86                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; 3
&lt;/span&gt;        32: aaload        
        33: aload_0       
        34: ldc           #76                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test
&lt;/span&gt;        36: invokeinterface #79,  3           &lt;span class=&quot;code-comment&quot;&gt;// InterfaceMethod org/codehaus/groovy/runtime/callsite/CallSite.callCurrent:(Lgroovy/lang/GroovyObject;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;        41: pop           
        42: nop           
        43: &lt;span class=&quot;code-keyword&quot;&gt;goto&lt;/span&gt;          62
        46: astore_3      
        47: aload_1       
        48: ldc           #87                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; 4
&lt;/span&gt;        50: aaload        
        51: aload_0       
        52: ldc           #76                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test
&lt;/span&gt;        54: invokeinterface #79,  3           &lt;span class=&quot;code-comment&quot;&gt;// InterfaceMethod org/codehaus/groovy/runtime/callsite/CallSite.callCurrent:(Lgroovy/lang/GroovyObject;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;        59: pop           
        60: aload_3       
        61: athrow        
        62: ldc           #38                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; 0
&lt;/span&gt;        64: ireturn       
      Exception table:
         from    to  target type
             4     7    46   any
            21    29    46   any
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
               0      62     0  &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;   Lbla;
      LineNumberTable:
        line 2: 4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This patch simply moves the type cast into the first block. If the cast fails, the catchAny block is executed and thus the finally code run only once.&lt;/p&gt;</comment>
                            <comment id="14474164" author="blackdrag" created="Tue, 12 Feb 2013 00:38:40 +0000"  >&lt;p&gt;I think we need to find an alternative solution to this. The recorder should have the uncast value&lt;/p&gt;

&lt;p&gt;As for the issue itself... offset 4-6 should be the try block, offset 7-25/26 the inlined finally block, offset 29-36 another finally block and offset 46-61 the normal finally block. The exception table has an entry for 4-7 to jump to 46. That looks imho right. What is totally wrong here imho is this second finally block plus the second catch entry.&lt;/p&gt;</comment>
                            <comment id="14474127" author="asteingress" created="Tue, 12 Feb 2013 01:33:51 +0000"  >&lt;p&gt;No, offset 7-20 is the inlined finally block, 21-25 is the cast + return statement. And that&apos;s the crux: when unboxing fails this exception is catched by the second any catch and the finally block is executed again (after being already executed after 4-6).&lt;/p&gt;

&lt;p&gt;And that&apos;s what looks wrong to me too. Why is the finally block inlined after 4-6? Shouldn&apos;t the call to DefaultTypeTransformation come before? In fact this is what the patch does.&lt;/p&gt;
</comment>
                            <comment id="14474115" author="asteingress" created="Tue, 12 Feb 2013 01:46:48 +0000"  >&lt;p&gt;Just for the record. Here is the Java code for a similar example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(f());
}

&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; f() {

&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o = &lt;span class=&quot;code-quote&quot;&gt;&quot;Test&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) o;
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
   &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Test&quot;&lt;/span&gt;);

}
}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; f();
    flags: ACC_STATIC
    Code:
      stack=2, locals=3, args_size=0
         0: ldc           #5                  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; Test
&lt;/span&gt;         2: astore_0      
         3: aload_0       
         4: checkcast     #6                  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java/lang/&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;
&lt;/span&gt;         7: invokevirtual #7                  &lt;span class=&quot;code-comment&quot;&gt;// Method java/lang/&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.intValue:()I
&lt;/span&gt;        10: istore_1      
        11: getstatic     #2                  &lt;span class=&quot;code-comment&quot;&gt;// Field java/lang/&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out:Ljava/io/PrintStream;
&lt;/span&gt;        14: ldc           #5                  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; Test
&lt;/span&gt;        16: invokevirtual #8                  &lt;span class=&quot;code-comment&quot;&gt;// Method java/io/PrintStream.println:(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;)V
&lt;/span&gt;        19: iload_1       
        20: ireturn       
        21: astore_2      
        22: getstatic     #2                  &lt;span class=&quot;code-comment&quot;&gt;// Field java/lang/&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out:Ljava/io/PrintStream;
&lt;/span&gt;        25: ldc           #5                  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; Test
&lt;/span&gt;        27: invokevirtual #8                  &lt;span class=&quot;code-comment&quot;&gt;// Method java/io/PrintStream.println:(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;)V
&lt;/span&gt;        30: aload_2       
        31: athrow        
      Exception table:
         from    to  target type
             0    11    21   any
            21    22    21   any
      LineNumberTable:
        line 10: 0
        line 11: 3
        line 13: 11
      StackMapTable: number_of_entries = 1
           frame_type = 85 &lt;span class=&quot;code-comment&quot;&gt;/* same_locals_1_stack_item */&lt;/span&gt;
          stack = [ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java/lang/Throwable ]


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It has two entries in the exception table too. Although the second entry looks a bit weird.&lt;/p&gt;</comment>
                            <comment id="14474049" author="blackdrag" created="Tue, 12 Feb 2013 03:09:57 +0000"  >&lt;p&gt;Andres, I am sorry, I mixed up some things. Of course your patch is ok. Now I see why I wrote the code like this, and why I misunderstood in the beginning. I was mixing up value recorder and block recorder. The former is for asserts, the later one for handling finally blocks. Actually the comment &quot;// value is always saved in boxed form, so no need to have a special load routine here&quot; is also wrong. Since Groovy 1.8 we don&apos;t always box. type should be replaced by returnType.&lt;/p&gt;

&lt;p&gt;Where the additional finally block comes from is also an issue though, but maybe a separate issue.&lt;/p&gt;

&lt;p&gt;So I change to +1 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14474029" author="asteingress" created="Tue, 12 Feb 2013 03:43:38 +0000"  >&lt;p&gt;Andr&#233; - that&apos;s me! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Okay, I will remove the comment and change the type to returnType in the pull request.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2btlr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>