<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:54:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8067] Possible deadlock when creating new ClassInfo entries in the cache</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8067</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When running Groovy without &lt;tt&gt;-Dgroovy.use.classvalue=true&lt;/tt&gt; the ClassInfo instances are cached in a &lt;tt&gt;ManagedConcurrentMap&lt;/tt&gt; (MCM).  New values are computed on demand and computation involves both a lock on a segment within the MCM and a lock on the &lt;tt&gt;GlobalClassSet&lt;/tt&gt; (GCS) which is backed by a &lt;tt&gt;ManagedLinkedList&lt;/tt&gt;.  The problem is that both the ManagedConcurrentMap and the GlobalClassSet share the same ReferenceQueue.&lt;/p&gt;

&lt;p&gt;Assume there is an enqueued &lt;tt&gt;ClassInfo&lt;/tt&gt; value that is stored in Segment2 of the MCM.  Now assume that Thread1 and Thread2 both request &lt;tt&gt;ClassInfo.getClassInfo(..)&lt;/tt&gt; for two different classes that do not currently exist in the cache.  Assume that based on hashing Thread1 gets a lock on Segment1 and Thread2 gets a lock on Segment2.  Assume that Thread1 is the first to call computeValue which in turn calls &lt;tt&gt;GlobalClassSet.add(..)&lt;/tt&gt;.  This call adds a new value to a &lt;tt&gt;ManagedLinkedList&lt;/tt&gt;, and since it&apos;s managed the add operation will process the ReferenceQueue. So Thread1 will attempt to dequeue the ClassInfo and the finalizeReference method on it&apos;s entry will attempt to remove it from Segment2. Thread2 holds the lock for Segment2 and Thread2 is blocked and can&apos;t progress it&apos;s waiting on the the lock Thread1 holds the lock for the GlobalClassSet, so deadlock occurs.&lt;/p&gt;

&lt;p&gt;The attached test case includes a thread dump at the bottom.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13038776">GROOVY-8067</key>
            <summary>Possible deadlock when creating new ClassInfo entries in the cache</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwagenleitner">John Wagenleitner</assignee>
                                    <reporter username="jwagenleitner">John Wagenleitner</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 Jan 2017 17:21:06 +0000</created>
                <updated>Sat, 15 Jul 2017 19:13:25 +0000</updated>
                            <resolved>Sun, 12 Feb 2017 19:28:05 +0000</resolved>
                                    <version>2.4.8</version>
                                    <fixVersion>2.4.9</fixVersion>
                                    <component>groovy-runtime</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15844576" author="jwagenleitner" created="Sun, 29 Jan 2017 17:59:37 +0000"  >&lt;p&gt;This should only affect Groovy 2.4.8 and a possible workaround if using Java 7+ would be to run with &lt;tt&gt;-Dgroovy.use.classvalue=true&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15844620" author="githubbot" created="Sun, 29 Jan 2017 19:47:39 +0000"  >&lt;p&gt;GitHub user jwagenleitner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/484&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8067&quot; title=&quot;Possible deadlock when creating new ClassInfo entries in the cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8067&quot;&gt;&lt;del&gt;GROOVY-8067&lt;/del&gt;&lt;/a&gt;: Possible deadlock when creating new ClassInfo entries in the cache&lt;/p&gt;

&lt;p&gt;    While I have been able to replicate the deadlock between `GroovyClassValuePreJava7$Segment` and the `GlobalClassSet#add`, I have not directly observed one between the `modifiedExpandos` and the `GlobalClassSet`, but think that it would be good to isolate their reference processing too since both lock in their operations.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jwagenleitner/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jwagenleitner/groovy&lt;/a&gt; groovy8067&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/484.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/484.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #484&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 78f5aa0b5977919ba05dcad9fe8a7ee496abf2e8&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-29T18:26:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8067&quot; title=&quot;Possible deadlock when creating new ClassInfo entries in the cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8067&quot;&gt;&lt;del&gt;GROOVY-8067&lt;/del&gt;&lt;/a&gt;: test for demo only (DO NOT COMMIT)&lt;/p&gt;

&lt;p&gt;commit 58a27e7b1c437d436636658a5de9537fda5560d6&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-01-29T19:34:55Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8067&quot; title=&quot;Possible deadlock when creating new ClassInfo entries in the cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8067&quot;&gt;&lt;del&gt;GROOVY-8067&lt;/del&gt;&lt;/a&gt;: Possible deadlock when creating new ClassInfo entries in the cache&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15853145" author="githubbot" created="Sun, 5 Feb 2017 07:05:08 +0000"  >&lt;p&gt;GitHub user jwagenleitner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/489&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8067&quot; title=&quot;Possible deadlock when creating new ClassInfo entries in the cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8067&quot;&gt;&lt;del&gt;GROOVY-8067&lt;/del&gt;&lt;/a&gt;: Possible deadlock when creating new ClassInfo entries in the cache&lt;/p&gt;

&lt;p&gt;    As suggested in PR #484 removed the locking on the `ManagedLinkedList` by creating a new `ManagedConcurrentLinkedQueue`.&lt;/p&gt;

&lt;p&gt;    Also added a `stress` subproject for tests that employ many threads, need GC, or just in general try to break things and take a long time.  These require a special property to be set in order to run, otherwise they will be skipped.  I tried to work it out in the `performance` subproject, but that seems to be very specialized for the compiler tests.  Open to suggestions on a better way to handle these types of tests.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jwagenleitner/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jwagenleitner/groovy&lt;/a&gt; groovy8067-mclq&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/489.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/489.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #489&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bb2464a919a3655f36707fa72fb30080c92a7288&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-02-05T06:13:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8067&quot; title=&quot;Possible deadlock when creating new ClassInfo entries in the cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8067&quot;&gt;&lt;del&gt;GROOVY-8067&lt;/del&gt;&lt;/a&gt;: Possible deadlock when creating new ClassInfo entries in the cache&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15853146" author="githubbot" created="Sun, 5 Feb 2017 07:07:36 +0000"  >&lt;p&gt;Github user jwagenleitner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/489#discussion_r99482851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/489#discussion_r99482851&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/org/codehaus/groovy/reflection/ClassInfo.java &amp;#8212;&lt;br/&gt;
    @@ -186,30 +185,20 @@ public void setStrongMetaClass(MetaClass answer) {&lt;br/&gt;
             MetaClass strongRef = strongMetaClass;&lt;/p&gt;

&lt;p&gt;             if (strongRef instanceof ExpandoMetaClass) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;((ExpandoMetaClass)strongRef).inRegistry = false;&lt;/li&gt;
	&lt;li&gt;synchronized(modifiedExpandos){&lt;/li&gt;
	&lt;li&gt;for (Iterator&amp;lt;ClassInfo&amp;gt; it = modifiedExpandos.iterator(); it.hasNext(); ) {&lt;/li&gt;
	&lt;li&gt;ClassInfo info = it.next();&lt;/li&gt;
	&lt;li&gt;if(info == this)
{
    -                it.remove();
    -              }
&lt;p&gt;    +            ((ExpandoMetaClass)strongRef).inRegistry = false;&lt;br/&gt;
    +            for (Iterator&amp;lt;ClassInfo&amp;gt; itr = modifiedExpandos.iterator(); itr.hasNext(); ) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +                ClassInfo info = itr.next();    +                if(info == this) {
    +                    itr.remove();
    +                }                 }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
             }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             strongMetaClass = answer;&lt;/p&gt;

&lt;p&gt;             if (answer instanceof ExpandoMetaClass) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;((ExpandoMetaClass)answer).inRegistry = true;&lt;/li&gt;
	&lt;li&gt;synchronized(modifiedExpandos){&lt;/li&gt;
	&lt;li&gt;for (Iterator&amp;lt;ClassInfo&amp;gt; it = modifiedExpandos.iterator(); it.hasNext(); ) {&lt;/li&gt;
	&lt;li&gt;ClassInfo info = it.next();&lt;/li&gt;
	&lt;li&gt;if(info == this)
{
    -                  it.remove();
    -                }&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;modifiedExpandos.add(this);&lt;/li&gt;
	&lt;li&gt;}
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Removed because it appeared to be a duplicate of the logic above.  Only if the previous previous `strongMetaClass` value was an expando would it have been added to the map, so the iteration/removal above should have taken care to remove this `ClassInfo` from the `modifiedExpandos` and there&apos;s no reason to iterate again.&lt;/p&gt;</comment>
                            <comment id="15856744" author="githubbot" created="Tue, 7 Feb 2017 20:42:18 +0000"  >&lt;p&gt;Github user jwagenleitner closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/484&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15858505" author="githubbot" created="Wed, 8 Feb 2017 20:35:19 +0000"  >&lt;p&gt;Github user jwagenleitner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/489#discussion_r100162935&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/489#discussion_r100162935&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: subprojects/stress/src/test/java/org/codehaus/groovy/reflection/ClassInfoDeadlockStressTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,140 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + *  Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + *  or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + *  distributed with this work for additional information&lt;br/&gt;
    + *  regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + *  to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + *  &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + *  with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + *  Unless required by applicable law or agreed to in writing,&lt;br/&gt;
    + *  software distributed under the License is distributed on an&lt;br/&gt;
    + *  &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
    + *  KIND, either express or implied.  See the License for the&lt;br/&gt;
    + *  specific language governing permissions and limitations&lt;br/&gt;
    + *  under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.codehaus.groovy.reflection;&lt;br/&gt;
    +&lt;br/&gt;
    +import groovy.lang.GroovyClassLoader;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.concurrent.CountDownLatch;&lt;br/&gt;
    +import java.util.concurrent.TimeUnit;&lt;br/&gt;
    +import java.util.concurrent.atomic.AtomicInteger;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.groovy.stress.util.GCUtils;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +import static org.junit.Assert.*;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Tests for deadlocks in the ClassInfo caching.&lt;br/&gt;
    + *&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ClassInfoDeadlockStressTest {&lt;br/&gt;
    +&lt;br/&gt;
    +    private static final int DEADLOCK_TRIES = 8;&lt;br/&gt;
    +    private static final int THREAD_COUNT = 8;&lt;br/&gt;
    +&lt;br/&gt;
    +    private final CountDownLatch startLatch = new CountDownLatch(1);&lt;br/&gt;
    +    private final CountDownLatch completeLatch = new CountDownLatch(THREAD_COUNT);&lt;br/&gt;
    +    private final GroovyClassLoader gcl = new GroovyClassLoader();&lt;br/&gt;
    +    private final AtomicInteger counter = new AtomicInteger();&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * We first generate a large number of ClassInfo instances for classes&lt;br/&gt;
    +     * that are no longer reachable.  Then queue up threads to all request&lt;br/&gt;
    +     * ClassInfo instances for new classes simultaneously to ensure that&lt;br/&gt;
    +     * clearing the old references wont deadlock the creation of new&lt;br/&gt;
    +     * instances.&lt;br/&gt;
    +     * &amp;lt;p&amp;gt;&lt;br/&gt;
    +     * &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8067&quot; title=&quot;Possible deadlock when creating new ClassInfo entries in the cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8067&quot;&gt;&lt;del&gt;GROOVY-8067&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test&lt;br/&gt;
    +    public void testDeadlock() throws Exception {&lt;br/&gt;
    +        for (int i = 1; i &amp;lt;= DEADLOCK_TRIES; i++) &lt;/p&gt;
{
    +            System.out.println(&quot;Test Number: &quot; + i);
    +            generateGarbage();
    +            GCUtils.gc();
    +            attemptDeadlock(null);
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test&lt;br/&gt;
    +    public void testRequestsForSameClassInfo() throws Exception {&lt;br/&gt;
    +        Class&amp;lt;?&amp;gt; newClass = createRandomClass();&lt;br/&gt;
    +        for (int i = 1; i &amp;lt;= DEADLOCK_TRIES; i++) &lt;/p&gt;
{
    +            System.out.println(&quot;Test Number: &quot; + i);
    +            generateGarbage();
    +            GCUtils.gc();
    +            attemptDeadlock(newClass);
    +        }
&lt;p&gt;    +        ClassInfo newClassInfo = ClassInfo.getClassInfo(newClass);&lt;br/&gt;
    +        for (ClassInfo ci : ClassInfo.getAllClassInfo()) {&lt;br/&gt;
    +            if (ci.getTheClass() == newClass &amp;amp;&amp;amp; ci != newClassInfo) &lt;/p&gt;
{
    +                fail(&quot;Found multiple ClassInfo instances for class&quot;);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private void attemptDeadlock(final Class&amp;lt;?&amp;gt; cls) throws Exception {&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; THREAD_COUNT; i++) {&lt;br/&gt;
    +            Runnable runnable = new Runnable() {&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                public void run() {&lt;br/&gt;
    +                    Class&amp;lt;?&amp;gt; newClass = (cls == null) ? createRandomClass() : cls;&lt;br/&gt;
    +                    try &lt;/p&gt;
{
    +                        startLatch.await();
    +                    }
&lt;p&gt; catch (InterruptedException ie) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    can use `ThreadUtils.awaite()`&lt;/p&gt;</comment>
                            <comment id="15858506" author="githubbot" created="Wed, 8 Feb 2017 20:35:19 +0000"  >&lt;p&gt;Github user jwagenleitner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/489#discussion_r100162813&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/489#discussion_r100162813&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/org/codehaus/groovy/util/ManagedConcurrentLinkedQueue.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,187 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + *  Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + *  or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + *  distributed with this work for additional information&lt;br/&gt;
    + *  regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + *  to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + *  &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + *  with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + *  Unless required by applicable law or agreed to in writing,&lt;br/&gt;
    + *  software distributed under the License is distributed on an&lt;br/&gt;
    + *  &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
    + *  KIND, either express or implied.  See the License for the&lt;br/&gt;
    + *  specific language governing permissions and limitations&lt;br/&gt;
    + *  under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.codehaus.groovy.util;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +import java.util.Iterator;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.NoSuchElementException;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentLinkedQueue;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * A queue that stores the values wrapped in a Reference, the type of which is&lt;br/&gt;
    + * determined by the provided &lt;/p&gt;
{@link ReferenceBundle}
&lt;p&gt;.  Values stored in this queue&lt;br/&gt;
    + * that are put on the &lt;/p&gt;
{@code ReferenceQueue} will be removed from the list when&lt;br/&gt;
    + * reference processing for the {@code ReferenceQueue}
&lt;p&gt; is done.&lt;br/&gt;
    + *&lt;br/&gt;
    + * This queue is backed by a &lt;/p&gt;
{@link ConcurrentLinkedQueue} and is thread safe.  The&lt;br/&gt;
    + * iterator will only return non-null values (reachable) and is based on the&lt;br/&gt;
    + * &quot;weakly consistent&quot; iterator of the underlying {@link ConcurrentLinkedQueue}
&lt;p&gt;.&lt;br/&gt;
    + *&lt;br/&gt;
    + * @param &amp;lt;T&amp;gt; the type of values to store&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ManagedConcurrentLinkedQueue&amp;lt;T&amp;gt; implements Iterable&amp;lt;T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +    private final ReferenceBundle bundle;&lt;br/&gt;
    +    private final ConcurrentLinkedQueue&amp;lt;Element&amp;lt;T&amp;gt;&amp;gt; queue;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Creates an empty ManagedConcurrentLinkedQueue that will use the given&lt;br/&gt;
    +     * &lt;/p&gt;
{@code ReferenceBundle}
&lt;p&gt; to store values as the given Reference&lt;br/&gt;
    +     * type.&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @param bundle used to create the appropriate Reference type&lt;br/&gt;
    +     *               for the values stored&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public ManagedConcurrentLinkedQueue(ReferenceBundle bundle) &lt;/p&gt;
{
    +        this.bundle = bundle;
    +        this.queue = new ConcurrentLinkedQueue&amp;lt;Element&amp;lt;T&amp;gt;&amp;gt;();
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Adds the specified value to the queue.&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @param value the value to add&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public void add(T value) &lt;/p&gt;
{
    +        Element&amp;lt;T&amp;gt; e = new Element&amp;lt;T&amp;gt;(value);
    +        queue.offer(e);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Returns &lt;/p&gt;
{@code true}
&lt;p&gt; if this queue contains no elements.&lt;br/&gt;
    +     * &amp;lt;p&amp;gt;&lt;br/&gt;
    +     * This method does not check the elements to verify they contain&lt;br/&gt;
    +     * non-null reference values.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public boolean isEmpty() &lt;/p&gt;
{
    +        return queue.isEmpty();
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Returns an array containing all values from this queue in the sequence they&lt;br/&gt;
    +     * were added.&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @param tArray the array to populate if big enough, else a new array with&lt;br/&gt;
    +     *               the same runtime type&lt;br/&gt;
    +     * @return an array containing all non-null values in this queue&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public T[] toArray(T[] tArray) &lt;/p&gt;
{
    +        return values().toArray(tArray);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Returns an unmodifiable list containing all values from this queue in the&lt;br/&gt;
    +     * sequence they were added.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public List&amp;lt;T&amp;gt; values() {&lt;br/&gt;
    +        Iterator&amp;lt;T&amp;gt; itr = iterator();&lt;br/&gt;
    +        if (!itr.hasNext()) &lt;/p&gt;
{
    +            return Collections.emptyList();
    +        }
&lt;p&gt;    +        List&amp;lt;T&amp;gt; result = new ArrayList&amp;lt;T&amp;gt;(100);&lt;br/&gt;
    +        result.add(itr.next());&lt;br/&gt;
    +        while (itr.hasNext()) &lt;/p&gt;
{
    +            result.add(itr.next());
    +        }
&lt;p&gt;    +        return Collections.unmodifiableList(result);&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Returns an iterator over all non-null values in this queue.  The values should be&lt;br/&gt;
    +     * returned in the order they were added.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Override&lt;br/&gt;
    +    public Iterator&amp;lt;T&amp;gt; iterator() &lt;/p&gt;
{
    +        return new Iter(queue.iterator());
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private final class Element&amp;lt;V&amp;gt; extends ManagedReference&amp;lt;V&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +        Element(V value) &lt;/p&gt;
{
    +            super(bundle, value);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public void finalizeReference() &lt;/p&gt;
{
    +            queue.remove(this);
    +            super.finalizeReference();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private final class Iter implements Iterator&amp;lt;T&amp;gt; {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    think this can be made a static nested class&lt;/p&gt;</comment>
                            <comment id="15862449" author="githubbot" created="Sat, 11 Feb 2017 17:00:34 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/489&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16084794" author="paulk" created="Wed, 12 Jul 2017 21:55:45 +0000"  >&lt;p&gt;Git bisect points to the respective commit for this issue for the below Grails plugin issue:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/grails/grails-core/issues/10715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grails/grails-core/issues/10715&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I haven&apos;t fully investigated and don&apos;t have a standalone reproducer yet. I&apos;ll raise a separate issue when I find something conclusive.&lt;/p&gt;</comment>
                            <comment id="16088680" author="jwagenleitner" created="Sat, 15 Jul 2017 17:42:43 +0000"  >&lt;p&gt;It looks like the issue might be related to the &lt;tt&gt;ManagedLinkedList&lt;/tt&gt; (MLL) iterator vs the &lt;tt&gt;ManagedConcurrentLinkedQueue&lt;/tt&gt; (MCLQ) iterator.  The MLL &lt;tt&gt;iterator#remove&lt;/tt&gt; method seems to not correctly relink the list (head, tail).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.util.*

mml = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ManagedLinkedList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(ReferenceBundle.getHardBundle())
&lt;span class=&quot;code-comment&quot;&gt;//mml = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ManagedConcurrentLinkedQueue&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;(ReferenceBundle.getHardBundle())
&lt;/span&gt;mml.add(&lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt;)
mml.add(&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;)
mml.add(&lt;span class=&quot;code-quote&quot;&gt;&apos;baz&apos;&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; itr = mml.iterator(); itr.hasNext(); ) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = itr.next()
    println s
    itr.remove()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Output from MLL:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;foo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Output from MCLQ:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;foo
bar
baz
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So with the old code using MLL any calls to &lt;tt&gt;clearModifiedExpandos&lt;/tt&gt; would always only remove the first one.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://github.com/javamelody/grails-melody-plugin/blob/4da5c1e7092f7841e6133fd790baa0419340a6ad/src/main/groovy/grails/melody/plugin/MelodyInterceptorEnhancer.groovy#L32&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;call to ExpandoMetaClass.enableGlobally in the grails-melody-plugin&lt;/a&gt; triggers a call to &lt;tt&gt;clearModifiedExpandos&lt;/tt&gt;.  By this time Grails core has already added the &lt;tt&gt;encode&lt;/tt&gt; methods.  The old code just by luck would not remove the modified expandos (and more importantly is the call to &lt;tt&gt;setStrongMetaClass(null)&lt;/tt&gt;) but the new MCLQ really does clear all modified expandos.&lt;/p&gt;

&lt;p&gt;Assuming that&apos;s the problem, not sure what&apos;s the appropriate fix.  It seems to me like the old MLL is broken, it doesn&apos;t look like this would have been the intended behavior.  So guess the question would be whether the responsibility lies with the caller of &lt;tt&gt;ExpandoMetaClass#enableGlobally&lt;/tt&gt; to check first to see if already enabled or whether that method should not clear if already enabled.&lt;/p&gt;</comment>
                            <comment id="16088706" author="jwagenleitner" created="Sat, 15 Jul 2017 19:13:25 +0000"  >&lt;blockquote&gt;
&lt;p&gt;So guess the question would be whether the responsibility lies with the caller of &lt;tt&gt;ExpandoMetaClass#enableGlobally&lt;/tt&gt; to check first to see if already enabled or whether that method should not clear if already enabled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The enableGlobally call does already check and only clears if the &lt;tt&gt;ExpandoMetaClassCreationHandle&lt;/tt&gt; is not the current handle.  In tracing the calls to clearModifiedExpandos when running the sample project grails-javamelody-issue the plugin triggers 2 calls to clearModifiedExpandos, first call in &lt;tt&gt;ExpandoMetaClassCreationHandle#create&lt;/tt&gt; (via &lt;tt&gt;ExpandoMetaClass.enableGlobally&lt;/tt&gt;) and second one in &lt;tt&gt;MetaClassRegistryImpl#setMetaClassCreationHandle&lt;/tt&gt; (via the before mentioned create call).  So even with the old &lt;tt&gt;ManagedLinkedList&lt;/tt&gt; (in Groovy 2.4.8) the plugin would have removed 2 modified expandos, those for &lt;tt&gt;org.grails.plugins.codecs.URLCodec&lt;/tt&gt; and &lt;tt&gt;org.grails.encoder.impl.JavaScriptCodec&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13044508">GROOVY-8092</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12849880" name="ClassInfoDeadlockTest.java" size="20428" author="jwagenleitner" created="Sun, 29 Jan 2017 17:21:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 18 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39cjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>