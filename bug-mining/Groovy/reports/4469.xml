<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:19:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7971] @CS flow typing incorrectly casting to map at runtime</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7971</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.json.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.*

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Bar {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Writable renderTemplate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o, Map args) {
    
    }
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSimpleType(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; type) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; type == &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;
    }
    def foo(Map map, Map arguments) {
    
        def writable = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Writable() {
            @Override
            Writer writeTo(Writer out) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(entry in map.entrySet()) {
                   def value = entry.value
                   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(isSimpleType(value.getClass()) || (value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Map)) {
                        out.append(JsonOutput.toJson(value))
                    }
                }
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; out
            }
        }
    }
}

writable = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Bar().foo([one:&lt;span class=&quot;code-quote&quot;&gt;&apos;two&apos;&lt;/span&gt;],[foo:&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;])

sw = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter()
writable.writeTo(sw)
println sw
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fails with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.codehaus.groovy.runtime.typehandling.GroovyCastException: Cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; object &lt;span class=&quot;code-quote&quot;&gt;&apos;two&apos;&lt;/span&gt; with class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&apos;&lt;/span&gt; to class &lt;span class=&quot;code-quote&quot;&gt;&apos;java.util.Map&apos;&lt;/span&gt;
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.continueCastOnSAM(DefaultTypeTransformation.java:405)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.continueCastOnNumber(DefaultTypeTransformation.java:319)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.castToType(DefaultTypeTransformation.java:232)
	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For some reason Groovy is attempting to cast value to Map when it isn&apos;t one.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13012278">GROOVY-7971</key>
            <summary>@CS flow typing incorrectly casting to map at runtime</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="3" iconUrl="https://issues.apache.org/jira/images/icons/statuses/inprogress.png" description="This issue is being actively worked on at the moment by the assignee.">In Progress</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="graemerocher1">Graeme Rocher</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Oct 2016 08:00:58 +0000</created>
                <updated>Sun, 17 Dec 2023 15:22:44 +0000</updated>
                                            <version>2.4.7</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15000">4h 10m</timespent>
                                <comments>
                            <comment id="15575793" author="blackdrag" created="Fri, 14 Oct 2016 16:34:00 +0000"  >&lt;p&gt;I assume that the compiler only check for &quot;instanceof Map&quot; and fails to see, that it is not the only condition here&lt;/p&gt;</comment>
                            <comment id="15580208" author="shils" created="Sun, 16 Oct 2016 16:32:17 +0000"  >&lt;p&gt;This only seems to happen for calls to type-overloaded methods e.g. JsonOutput#toJson.&lt;/p&gt;</comment>
                            <comment id="15865311" author="paulk" created="Tue, 14 Feb 2017 07:56:50 +0000"  >&lt;p&gt;@blackdrag correct - the fact that &lt;tt&gt;value instanceof Map&lt;/tt&gt; has been seen is recorded in &lt;tt&gt;typeCheckingContext.temporaryIfBranchTypeInformation&lt;/tt&gt; regardless of the altering &lt;tt&gt;||&lt;/tt&gt; expression&lt;/p&gt;</comment>
                            <comment id="16439303" author="paulk" created="Mon, 16 Apr 2018 11:27:12 +0000"  >&lt;p&gt;A slightly simpler example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.json.*
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.*

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Bar {
    def meth(value) {
        Writer out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringWriter()
        def isString = value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;//        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isString || value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Map) { // (1)
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; || value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Map) { &lt;span class=&quot;code-comment&quot;&gt;// (2)
&lt;/span&gt;            out.append(JsonOutput.toJson(value))
        }
        out
    }
}

def writer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Bar().meth(&lt;span class=&quot;code-quote&quot;&gt;&apos;two&apos;&lt;/span&gt;)
println writer.toString()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here (2) works but (1) fails. And it&apos;s not just that the instanceof String isn&apos;t detected but that Map is selected even though the &lt;tt&gt;||&lt;/tt&gt; binary expression exists.&lt;/p&gt;</comment>
                            <comment id="16439919" author="blackdrag" created="Mon, 16 Apr 2018 19:28:29 +0000"  >&lt;p&gt;I think it is ok to support only if the instanceof is used as part o the condition directly. Otherwise you will soon require to run the program to compile the program&lt;/p&gt;</comment>
                            <comment id="16440025" author="paulk" created="Mon, 16 Apr 2018 21:03:47 +0000"  >&lt;p&gt;Giving a compiler STC error would be better - treating it as a Map we need to fix.&lt;/p&gt;</comment>
                            <comment id="17566336" author="githubbot" created="Wed, 13 Jul 2022 14:19:02 +0000"  >&lt;p&gt;eric-milles closed pull request #1269: &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7971&quot; title=&quot;@CS flow typing incorrectly casting to map at runtime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7971&quot;&gt;GROOVY-7971&lt;/a&gt;: do not save instanceof types under logical or&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/1269&lt;/a&gt;&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13468523">GROOVY-10668</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13379237">GROOVY-10096</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13483204">GROOVY-10769</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13532092">GROOVY-11008</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13518336">GROOVY-10903</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13210965">GROOVY-8965</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13562092">GROOVY-11250</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13545385">GROOVY-11137</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34vu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>