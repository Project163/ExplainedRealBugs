<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:37:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-6191] Memory leak in GroovyScriptEngineImpl</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-6191</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Previously evaluation of the same script (but different String instances) led to reading script class from cache, now if different String instances are used for script text, the value is not found in cache, so that script engine compiles the same script again and adds new Class instance to the classMap.&lt;/p&gt;

&lt;p&gt;This leads to inefficient caching, and also may cause memory leak.&lt;/p&gt;

&lt;p&gt;Please consider the following code sample:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  e = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.codehaus.groovy.jsr223.GroovyScriptEngineImpl()
  println e.eval(&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass())&apos;&lt;/span&gt;)
  println e.eval(&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass())&apos;&lt;/span&gt;)
  println e.eval(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass())&apos;&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In groovy 1.7 it produced 3 identical lines in output.&lt;br/&gt;
In groovy 2.1.3 the third line differs from previous two.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12817019">GROOVY-6191</key>
            <summary>Memory leak in GroovyScriptEngineImpl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="enterit">Sergey Bondarenko</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 May 2013 09:54:04 +0000</created>
                <updated>Thu, 15 Oct 2015 18:20:02 +0000</updated>
                            <resolved>Mon, 18 Nov 2013 06:57:40 +0000</resolved>
                                    <version>2.1.3</version>
                                    <fixVersion>2.2.1</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14475099" author="pschumacher" created="Fri, 11 Oct 2013 12:42:10 +0000"  >&lt;p&gt;@blackdrag: Maybe you can comment on this issue?&lt;/p&gt;</comment>
                            <comment id="14475158" author="milindvijayshah" created="Thu, 14 Nov 2013 12:40:26 +0000"  >&lt;p&gt;Hi, We are facing out of memeory issue on production server. when we analyze the heapdump we found that ManagedConcurrentMap occupied 45% heap and while looking into this issue, we found that its due to hard refereneces inside the ManagedConcurrentMap. can you please let us know in which version we can have fix for this issue. we need to restart the production server on weekly basis becuase of this.&lt;/p&gt;

&lt;p&gt;you can found more details on this bugs at below location : &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://groovy.329449.n5.nabble.com/memory-leak-in-GroovyScriptEngineImpl-td5715613.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://groovy.329449.n5.nabble.com/memory-leak-in-GroovyScriptEngineImpl-td5715613.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14480379" author="huxi" created="Thu, 14 Nov 2013 13:18:40 +0000"  >&lt;p&gt;Shouldn&apos;t this be fixable by simple replacing &lt;tt&gt;int h = System.identityHashCode(key);&lt;/tt&gt; at &lt;a href=&quot;https://github.com/groovy/groovy-core/blob/master/src/main/org/codehaus/groovy/util/AbstractConcurrentMapBase.java#L54&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/master/src/main/org/codehaus/groovy/util/AbstractConcurrentMapBase.java#L54&lt;/a&gt; with &lt;tt&gt;int h = key == null? 0 : key.hashCode();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;It must be more complex than that...&lt;/p&gt;</comment>
                            <comment id="14474958" author="blackdrag" created="Thu, 14 Nov 2013 16:59:30 +0000"  >&lt;p&gt;Joern... I looked at that line... and I can not tell anymore why Alex made that change back then. He had key.hashCode() before. Could it really be that easy?&lt;/p&gt;</comment>
                            <comment id="14480402" author="huxi" created="Thu, 14 Nov 2013 17:17:54 +0000"  >&lt;p&gt;I don&apos;t know where else that class is used. Maybe it was some kind of performance enhancement &lt;tt&gt;String.hashCode()&lt;/tt&gt; is likely slower than &lt;tt&gt;System.identityHashCode(..)&lt;/tt&gt;, at least during first call on big Strings.&lt;/p&gt;

&lt;p&gt;I wanted to suggest extending &lt;tt&gt;ManagedConcurrentMap&lt;/tt&gt; for this use case (just to avoid side effects) and overriding hash(K key) - but it&apos;s static. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Using &lt;tt&gt;identityHashCode&lt;/tt&gt; seems highly counter-intuitive to me... and this gives me even more &quot;there must be a good reason&quot; vibes. But it&apos;s definitely wrong in this case.&lt;/p&gt;</comment>
                            <comment id="14475127" author="blackdrag" created="Fri, 15 Nov 2013 06:05:34 +0000"  >&lt;p&gt;I guess performance was the reason indeed. One reason I did no change so far is also that this data structure is not so easy to extend.&lt;/p&gt;

&lt;p&gt;I wonder if I should not change the map in &lt;a href=&quot;https://github.com/groovy/groovy-core/blob/master/subprojects/groovy-jsr223/src/main/java/org/codehaus/groovy/jsr223/GroovyScriptEngineImpl.java#L96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/master/subprojects/groovy-jsr223/src/main/java/org/codehaus/groovy/jsr223/GroovyScriptEngineImpl.java#L96&lt;/a&gt; to a ManagedConcurrentValueMap, like in line 99, but with softreferences of course.&lt;/p&gt;</comment>
                            <comment id="14475159" author="blackdrag" created="Fri, 15 Nov 2013 06:06:22 +0000"  >&lt;p&gt;As for ManagedConcurrentMap... the meta class structure is using this map, so I think simply changing that line is not good enough&lt;/p&gt;</comment>
                            <comment id="14475141" author="blackdrag" created="Fri, 15 Nov 2013 09:49:17 +0000"  >&lt;p&gt;I checked a bit the history and it seems this bug is at lest no regression. There are actually two maps in this, one for &quot;global&quot; closures, the other the class cache. &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5706&quot; title=&quot;JSR 223 invokeFunction broken in 2.0.2 - regression&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5706&quot;&gt;&lt;del&gt;GROOVY-5706&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5786&quot; title=&quot;methods defined by one eval are &amp;#39;lost&amp;#39; over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5786&quot;&gt;&lt;del&gt;GROOVY-5786&lt;/del&gt;&lt;/a&gt; have been made to change that map. And now it is the other. &lt;/p&gt;</comment>
                            <comment id="14475233" author="blackdrag" created="Mon, 18 Nov 2013 06:57:40 +0000"  >&lt;p&gt;I changed the map type&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c1fj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>