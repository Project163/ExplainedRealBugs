<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:48:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7709] NPE with ConvertedClosure</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7709</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; Y &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; GroovyObject {}
def cl = {println 1} as Y
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; cl &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; GroovyObject
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cl) println &lt;span class=&quot;code-quote&quot;&gt;&quot;!cl&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the code above will cause the execution of the method getMetaClass in the boolean part of the &quot;if&quot;. It looks like this code path now produces a NPE&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
	at org.codehaus.groovy.runtime.InvokerHelper.invokePogoMethod(InvokerHelper.java:919)
	at org.codehaus.groovy.runtime.InvokerHelper.invokeMethod(InvokerHelper.java:902)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.castToBoolean(DefaultTypeTransformation.java:185)
	at org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation.booleanUnbox(DefaultTypeTransformation.java:74)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12921044">GROOVY-7709</key>
            <summary>NPE with ConvertedClosure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="blackdrag">Jochen Theodorou</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Dec 2015 12:12:06 +0000</created>
                <updated>Mon, 22 Feb 2016 20:48:41 +0000</updated>
                            <resolved>Fri, 15 Jan 2016 16:22:36 +0000</resolved>
                                    <version>2.4.5</version>
                                    <fixVersion>2.4.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15052678" author="blackdrag" created="Fri, 11 Dec 2015 12:12:35 +0000"  >&lt;p&gt;not tested against master&lt;/p&gt;</comment>
                            <comment id="15052935" author="jwagenleitner" created="Fri, 11 Dec 2015 16:03:33 +0000"  >&lt;p&gt;NPE occurs in master.  Testing each point release from 2.4.5 back, last release this worked as expected was 1.6.9.&lt;/p&gt;</comment>
                            <comment id="15054596" author="blackdrag" created="Sat, 12 Dec 2015 20:00:57 +0000"  >&lt;p&gt;1.6.9, really? I thought 2.3.6 was working as well&lt;/p&gt;</comment>
                            <comment id="15054619" author="jwagenleitner" created="Sat, 12 Dec 2015 20:25:09 +0000"  >&lt;p&gt;Just tried with 2.3.6 (before I mostly tested with 2.X.0 point releases) and confirmed that it throws the NPE. &lt;/p&gt;</comment>
                            <comment id="15070093" author="shils" created="Wed, 23 Dec 2015 19:43:00 +0000"  >&lt;p&gt;The closure itself also appears to be executed twice as a side effect of the &lt;tt&gt;cl.getMetaClass()&lt;/tt&gt; call.&lt;/p&gt;</comment>
                            <comment id="15071438" author="blackdrag" created="Fri, 25 Dec 2015 09:14:04 +0000"  >&lt;p&gt;The question is what the right behaviour is. In case of &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;inteface Foo { def x(); def y()}
def cl = [x:{1},y:{2}]
def object = cl as Foo
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; object &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Foo
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; object.x() == 1
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; object.y() == 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We have the map taking care of what method is supposed to be used for a specific method. But we do also allow this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;inteface Foo { def x(); def y()}
def cl = {1}
def object = cl as Foo
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; object &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Foo
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; object.x() == 1
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; object.y() == 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and here the Closure object is taken for everything. So according to that, it is not really wrong if the closure reacts to getMetaClass or asBoolean. but calling getMetaClass twice... hmm... I can&apos;t tell for sure if that is wrong or not.&lt;/p&gt;

&lt;p&gt;As for the NPE... I have had no time to properly look at this, but could it be that it happens, because the returned meta class is null?&lt;/p&gt;</comment>
                            <comment id="15072013" author="shils" created="Sat, 26 Dec 2015 23:41:36 +0000"  >&lt;p&gt;Yes, the meta class used to create the PogoMetaClassSite (in CallSiteArray#createPogoSite) is the value returned by the closure, which in this case will be null. If the closure is changed to { 1 } for example, the test will instead fail with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ClassCastException: java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to groovy.lang.MetaClass
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15072024" author="githubbot" created="Sun, 27 Dec 2015 03:31:13 +0000"  >&lt;p&gt;GitHub user jwagenleitner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7709&quot; title=&quot;NPE with ConvertedClosure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7709&quot;&gt;&lt;del&gt;GROOVY-7709&lt;/del&gt;&lt;/a&gt; - ConvertedClosure/ConvertedMap do not work with interface extending GroovyObject&lt;/p&gt;

&lt;p&gt;    Just posting for discussion and acknowledge that there is probably a better fix and lots here is not being addressed other the immediate issue.  For this fix I borrowed from what was done in `GroovyResultSetProxy`.&lt;/p&gt;

&lt;p&gt;    Assuming this is even somewhat close to the right way to address it, it might make sense for the `ConvertedMap` to handle the metaClass in case the map has a `getMetaClass` key.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jwagenleitner/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jwagenleitner/groovy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7709&quot; title=&quot;NPE with ConvertedClosure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7709&quot;&gt;&lt;del&gt;GROOVY-7709&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/226.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/226.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #226&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 584840327d484e9a24fd69a3cfc8a8c97fa55e86&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-12-27T03:17:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7709&quot; title=&quot;NPE with ConvertedClosure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7709&quot;&gt;&lt;del&gt;GROOVY-7709&lt;/del&gt;&lt;/a&gt; - ConvertedClosure/ConvertedMap do not work with interface extending GroovyObject&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15072027" author="jwagenleitner" created="Sun, 27 Dec 2015 03:39:07 +0000"  >&lt;p&gt;The same issue exists for ConvertedMap.  I posted a PR, pretty sure I&apos;m way off base but thought I might as well post it and maybe it&apos;ll be worth something.  I tried various ways of delegating the &lt;tt&gt;GroovyObject&lt;/tt&gt; calls to the &lt;tt&gt;ConvertedClosure&lt;/tt&gt; delegate but since the object/receiver is a &lt;tt&gt;java.lang.reflection.Proxy&lt;/tt&gt; and not really a closure it failed in the &lt;tt&gt;ClosureMetaclass&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15072030" author="githubbot" created="Sun, 27 Dec 2015 03:45:57 +0000"  >&lt;p&gt;Github user jwagenleitner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/226#discussion_r48451502&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/226#discussion_r48451502&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/org/codehaus/groovy/runtime/ConversionHandler.java &amp;#8212;&lt;br/&gt;
    @@ -189,4 +202,15 @@ public static boolean isCoreObjectMethod(Method method) &lt;/p&gt;
{
             return Object.class.equals(method.getDeclaringClass());
         }

&lt;p&gt;    +    private MetaClass setMetaClass(MetaClass mc) &lt;/p&gt;
{
    +        metaClass = mc;
    +        return mc;
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private MetaClass getMetaClass(Object proxy) {&lt;br/&gt;
    +        if (metaClass == null) {&lt;br/&gt;
    +            metaClass = ((MetaClassRegistryImpl) GroovySystem.getMetaClassRegistry()).getMetaClass(proxy);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Not sure if this is the right way to get the `metaClass` for the `Proxy` object.&lt;/p&gt;</comment>
                            <comment id="15076187" author="githubbot" created="Thu, 31 Dec 2015 23:27:32 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/226&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15090856" author="githubbot" created="Sun, 10 Jan 2016 01:54:52 +0000"  >&lt;p&gt;GitHub user jwagenleitner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Safely publish MetaClass so threads wont see a partially constructed instance&lt;/p&gt;

&lt;p&gt;    Added final where appropriate and limited plugin variable scope in invoke method.&lt;/p&gt;

&lt;p&gt;    Related to PR #226 (&lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7709&quot; title=&quot;NPE with ConvertedClosure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7709&quot;&gt;&lt;del&gt;GROOVY-7709&lt;/del&gt;&lt;/a&gt;), while full synchronization may not be required the lazily initialized `metaClass` should probably be `volatile`.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jwagenleitner/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jwagenleitner/groovy&lt;/a&gt; ConversionHandler&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/237.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/237.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #237&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f33df09674728a5d919770ac941873d7f3606826&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-01-10T01:11:57Z&lt;/p&gt;

&lt;p&gt;    Safely publish MetaClass so threads wont see a partially constructed instance.&lt;/p&gt;

&lt;p&gt;    Added final where appropriate and limited plugin variable scope in invoke method.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15093056" author="githubbot" created="Tue, 12 Jan 2016 01:12:12 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/237&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15093512" author="blackdrag" created="Tue, 12 Jan 2016 08:14:44 +0000"  >&lt;p&gt;the issue was not fixed by PR 237, was it?&lt;/p&gt;</comment>
                            <comment id="15093988" author="jwagenleitner" created="Tue, 12 Jan 2016 14:47:54 +0000"  >&lt;p&gt;No, because I referenced this in that PR I guess the asfgitbot picked it up.  I didn&apos;t think it would pick it up unless it was mentioned in the PR title.&lt;/p&gt;</comment>
                            <comment id="15094105" author="jwagenleitner" created="Tue, 12 Jan 2016 15:46:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/groovy/pull/226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #226&lt;/a&gt; was the PR that was supposed to resolve this and was merged into 2_4_X and master.  I noticed this was reopened, did you find a problem?&lt;/p&gt;</comment>
                            <comment id="15102004" author="blackdrag" created="Fri, 15 Jan 2016 16:22:36 +0000"  >&lt;p&gt;ah sorry, my mistake&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2prl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>