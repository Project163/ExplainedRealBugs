<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:58:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8546] Parrot Parser: multiple Reader instances opened from SourceUnit; many left open</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8546</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;&lt;tt&gt;Antlr4ParserPlugin&lt;/tt&gt; makes very inefficient use of &lt;tt&gt;ReaderSource&lt;/tt&gt;/&lt;tt&gt;SourceUnit&lt;/tt&gt;.  &lt;tt&gt;parseCST&lt;/tt&gt; is passed a &lt;tt&gt;Reader&lt;/tt&gt; with the idea that it is the source of character data &amp;#8211; and this reader is closed from outside.  It ignores this and mines the passed &lt;tt&gt;SourceUnit&lt;/tt&gt;, which seems unnecessary since the same reference is passed again in &lt;tt&gt;buildAST&lt;/tt&gt;.  Both &lt;tt&gt;parseCST&lt;/tt&gt; and &lt;tt&gt;buildAST&lt;/tt&gt; call &lt;tt&gt;getReader&lt;/tt&gt;, which opens a buffered reader on the source unit file and never closes them.  Lastly, &lt;tt&gt;AstBuilder&lt;/tt&gt; calls &lt;tt&gt;getReader&lt;/tt&gt; as well to create a &lt;tt&gt;CharStream&lt;/tt&gt; and never closes this reader.&lt;/p&gt;

&lt;p&gt;Doing this in a long-running process (like an IDE) is causing numerous problems due to open file handles.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Antlr4ParserPlugin &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ParserPlugin {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ReaderSource readerSource;

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Reduction parseCST(SourceUnit sourceUnit, java.io.Reader reader) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CompilationFailedException {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            ReaderSource readerSource = sourceUnit.getSource();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != readerSource &amp;amp;&amp;amp; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != readerSource.getReader()) {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.readerSource = readerSource;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.readerSource = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReaderSource(IOGroovyMethods.getText(reader), sourceUnit.getConfiguration());
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyBugError(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to create StringReaderSource instance&quot;&lt;/span&gt;, e);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ModuleNode buildAST(SourceUnit sourceUnit, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; classLoader, Reduction cst) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ParserException {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            ReaderSource readerSource = sourceUnit.getSource();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == readerSource || &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == readerSource.getReader()) {
                sourceUnit.setSource(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.readerSource);
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            sourceUnit.setSource(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.readerSource);
        }

        AstBuilder builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AstBuilder(sourceUnit);

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; builder.buildAST();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13152580">GROOVY-8546</key>
            <summary>Parrot Parser: multiple Reader instances opened from SourceUnit; many left open</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="emilles">Eric Milles</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Apr 2018 00:21:13 +0000</created>
                <updated>Thu, 26 Jul 2018 04:46:12 +0000</updated>
                            <resolved>Tue, 17 Apr 2018 06:01:03 +0000</resolved>
                                    <version>2.6.0-alpha-3</version>
                    <version>3.0.0-alpha-2</version>
                                    <fixVersion>2.6.0-alpha-4</fixVersion>
                    <fixVersion>3.0.0-alpha-3</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16438915" author="daniel_sun" created="Mon, 16 Apr 2018 01:39:41 +0000"  >&lt;p&gt;&lt;tt&gt;CharStream&lt;/tt&gt; of antlr4 is not a IO stream, so we need not close it.&lt;/p&gt;</comment>
                            <comment id="16438916" author="daniel_sun" created="Mon, 16 Apr 2018 01:45:11 +0000"  >&lt;p&gt;&lt;tt&gt;CharStreams.fromReader&lt;/tt&gt; in the &lt;tt&gt;AstBuilder.createCharStream&lt;/tt&gt; method will close the reader held by &lt;tt&gt;sourceUnit, please see the source code of antlr4&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CharStream createCharStream(SourceUnit sourceUnit) {
        CharStream charStream;

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            charStream = CharStreams.fromReader(
                    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedReader(sourceUnit.getSource().getReader()),
                    sourceUnit.getName());
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error occurred when reading source code.&quot;&lt;/span&gt;, e);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; charStream;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16439816" author="emilles" created="Mon, 16 Apr 2018 18:20:17 +0000"  >&lt;p&gt;It would help if you linked to the relevant source code since the groovy-all sources jar does not carry the Antlr source.  Even if the reader used in AstBuilder is closed properly, there are at least 2 opened readers in Antlr4ParserPlugin that are not closed.  And there is a reader opened outside Antlr4ParserPlugin and not used, which is inefficient.&lt;/p&gt;</comment>
                            <comment id="16439820" author="emilles" created="Mon, 16 Apr 2018 18:23:00 +0000"  >&lt;p&gt;Issue was never resolved.  It would be nice if you gave the submitter a chance to evaluate before deciding to close.&lt;/p&gt;</comment>
                            <comment id="16440281" author="daniel_sun" created="Tue, 17 Apr 2018 02:30:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;It would help if you linked to the relevant source code since the groovy-all sources jar does not carry the Antlr source.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Here is the source code of antlr4&apos;s &lt;tt&gt;fromReader&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	/**
	 * Creates a {@link CharStream} given a {@link Reader} and its
	 * source name. Closes the reader before returning.
	 */
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; CodePointCharStream fromReader(Reader r, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sourceName) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			CodePointBuffer.Builder codePointBufferBuilder = CodePointBuffer.builder(DEFAULT_BUFFER_SIZE);
			CharBuffer charBuffer = CharBuffer.allocate(DEFAULT_BUFFER_SIZE);
			&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((r.read(charBuffer)) != -1) {
				charBuffer.flip();
				codePointBufferBuilder.append(charBuffer);
				charBuffer.compact();
			}
			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; CodePointCharStream.fromBuffer(codePointBufferBuilder.build(), sourceName);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
			r.close();
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;I verified that &lt;b&gt;only the reader created by `getReader` method in &lt;tt&gt;Antlr4ParserPlugin&lt;/tt&gt;&#160;is not closed&lt;/b&gt;, here is the commit to fix it: &lt;a href=&quot;https://github.com/apache/groovy/commit/e19a93242dcc204cd94e034242a348c113cc1130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/e19a93242dcc204cd94e034242a348c113cc1130&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As for other Reader/Stream instances, they have been closed, you have to investigate the&#160;relevant&#160; code to check.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16440438" author="daniel_sun" created="Tue, 17 Apr 2018 06:01:03 +0000"  >&lt;p&gt;Fixed by:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/commit/e19a93242dcc204cd94e034242a348c113cc1130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/e19a93242dcc204cd94e034242a348c113cc1130&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/commit/4840d1fce2ccea5efaf30e30b8e569a833257023&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/4840d1fce2ccea5efaf30e30b8e569a833257023&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3skpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>