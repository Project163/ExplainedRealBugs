<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:15:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4069] Custom constructors added via metaclass are sometimes not cleaned up</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4069</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;There seems to be an issue with constructors added via metaclass and cleanup:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MetaClassMagicTests &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; GroovyTestCase {
    void testIt() {
        ExpandoMetaClass.enableGlobally()
        
        &lt;span class=&quot;code-comment&quot;&gt;// Child.metaClass // uncomment and everything works
&lt;/span&gt;        
        &lt;span class=&quot;code-comment&quot;&gt;// Save the old meta class
&lt;/span&gt;        def oldMetaClass = Parent.metaClass
        
        &lt;span class=&quot;code-comment&quot;&gt;// Install a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; one
&lt;/span&gt;        def emc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExpandoMetaClass(Parent, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        emc.initialize()
        GroovySystem.metaClassRegistry.setMetaClass(Parent, emc)
        
        &lt;span class=&quot;code-comment&quot;&gt;// Install a map based constructor
&lt;/span&gt;        emc.constructor = { Map m -&amp;gt; Parent.newInstance() }
        
        &lt;span class=&quot;code-comment&quot;&gt;// Parent constructor is used, all good
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child([:]) &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Parent
        
        &lt;span class=&quot;code-comment&quot;&gt;// Reinstate the old meta class
&lt;/span&gt;        GroovySystem.metaClassRegistry.removeMetaClass(Parent) 
        GroovySystem.metaClassRegistry.setMetaClass(Parent, oldMetaClass)

        &lt;span class=&quot;code-comment&quot;&gt;// This fails, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; calls the custom constructor from above and returns an instance of Parent
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child([:]) &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Child
    }
    
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Parent { def a }
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Child &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Parent { def b }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12815060">GROOVY-4069</key>
            <summary>Custom constructors added via metaclass are sometimes not cleaned up</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="ldaley">Luke Daley</reporter>
                        <labels>
                    </labels>
                <created>Sat, 20 Feb 2010 18:49:13 +0000</created>
                <updated>Wed, 7 Apr 2010 23:45:10 +0000</updated>
                            <resolved>Tue, 2 Mar 2010 20:36:58 +0000</resolved>
                                    <version>1.7.1</version>
                                    <fixVersion>1.7.2</fixVersion>
                    <fixVersion>1.8-beta-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14469024" author="roshandawrani" created="Tue, 23 Feb 2010 09:39:41 +0000"  >&lt;p&gt;Isn&apos;t it the Child metaClass that you should be manipulating instead of Parent&apos;s? &lt;/p&gt;

&lt;p&gt;The following code goes through:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MetaClassMagicTests &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; GroovyTestCase {
    void testIt() {
        ExpandoMetaClass.enableGlobally()
        
        def oldMetaClass = Child.metaClass
        
        def emc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExpandoMetaClass(Child, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        emc.initialize()
        GroovySystem.metaClassRegistry.setMetaClass(Child, emc)
        
        emc.constructor = { Map m -&amp;gt; Child.newInstance() }
        
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child([:]) &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Parent
        
        GroovySystem.metaClassRegistry.removeMetaClass(Child) 
        GroovySystem.metaClassRegistry.setMetaClass(Child, oldMetaClass)

        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child([:]) &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Child
    }
    
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Parent { def a }
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Child &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Parent { def b }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14468982" author="ldaley" created="Tue, 23 Feb 2010 17:00:45 +0000"  >&lt;p&gt;No, the point is that after I have removed the constructor from the parent&apos;s metaclass, it is still called when constructing the child. This is definitely unexpected.&lt;/p&gt;

&lt;p&gt;Note the...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Child.metaClass // uncomment and everything works&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;line. If that get&apos;s executed then everything works, which &lt;em&gt;seems&lt;/em&gt; like that if the Child metaClass is initialised before diddling with the Parent&apos;s metaClass you get the right behaviour.&lt;/p&gt;</comment>
                            <comment id="14469014" author="roshandawrani" created="Sun, 28 Feb 2010 07:50:23 +0000"  >&lt;p&gt;While your point about inconsistency is right, I think your asserts convey the wrong expectations (as far as I understand metaClass thing). I think when you add a constructor through Parent EMC, &quot;new Child()&quot; should not get that constructor.&lt;/p&gt;

&lt;p&gt;So, the following should be the behavior:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ExpandoMetaClass.enableGlobally()

def oldMetaClass = Parent.metaClass

def emc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExpandoMetaClass(Parent, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
emc.initialize()
GroovySystem.metaClassRegistry.setMetaClass(Parent, emc)

emc.constructor = { Map m -&amp;gt; Parent.newInstance() }

&lt;span class=&quot;code-comment&quot;&gt;/* here also you should get a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child because you have manipulated Parent MC */&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child([:]) &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Child

GroovySystem.metaClassRegistry.removeMetaClass(Parent) 
GroovySystem.metaClassRegistry.setMetaClass(Parent, oldMetaClass)

&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Child([:]) &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Child

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Parent { def a }
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Child &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Parent { def b }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the behavior that you are trying, you should manipulate Child MC.&lt;/p&gt;

&lt;p&gt;Can someone please verify the behavior - one way or another? Thanks.&lt;/p&gt;</comment>
                            <comment id="14469029" author="roshandawrani" created="Sun, 28 Feb 2010 09:00:55 +0000"  >&lt;p&gt;Attaching a patch for review based on my understanding of the behavior in this scenario.&lt;/p&gt;

&lt;p&gt;Basically the change made in the patch is that EMC should not create a constructor site if the type &amp;lt;init&amp;gt; has been invoked on does not match the type it finds &amp;lt;init&amp;gt; on at runtime. That way when &quot;Parent&quot; defines a new constructor through EMC, &quot;new Child()&quot; will not match it.&lt;/p&gt;

&lt;p&gt;Tests are added to verify the behavior when you manipulate the MC of Parent and of Child and variations &quot;ChildX.metaClass&quot; commented/uncommented that lead to the inconsistent behavior.&lt;/p&gt;</comment>
                            <comment id="14468967" author="blackdrag" created="Tue, 2 Mar 2010 10:01:49 +0000"  >&lt;p&gt;hmm... is the type parameter really needed? I assume the declaring class of a method for a method added by closure will always not be the same as the current class. So I wonder if it wouldn&apos;t be enough to change&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(type == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) || (method.getDeclaringClass().getTheClass().equals(type)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;method.getDeclaringClass().getTheClass().equals(getTheClass())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As I understand it, this will always false if the method is added through a closure... or is getTheType() returning something else than what &quot;type&quot; would get?&lt;/p&gt;</comment>
                            <comment id="14469028" author="roshandawrani" created="Tue, 2 Mar 2010 10:46:17 +0000"  >&lt;p&gt;Thanks for the feedback, Jochen. I didn&apos;t notice that I could get the type from MC#getTheClass() as well. &lt;/p&gt;

&lt;p&gt;I have made that change and I am attaching V2 of the patch here.&lt;/p&gt;

&lt;p&gt;Please let me know if you see any other issue.&lt;/p&gt;</comment>
                            <comment id="14469041" author="roshandawrani" created="Tue, 2 Mar 2010 20:36:58 +0000"  >&lt;p&gt;Fixed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722502" name="4069_v18x_Patch.txt" size="8108" author="roshandawrani" created="Sun, 28 Feb 2010 09:00:55 +0000"/>
                            <attachment id="12722617" name="V2_4069_v18x_Patch.txt" size="5788" author="roshandawrani" created="Tue, 2 Mar 2010 10:46:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ctjb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12312220" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Testcase included</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="11060"><![CDATA[Yes]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>