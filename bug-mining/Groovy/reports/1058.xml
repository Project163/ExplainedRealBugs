<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:13:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3705] Sql rows() methods access ResultSet after Connection closed</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3705</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Change 17279 introduced a Command Pattern (PreparedQueryCommand, QueryCommand) for executing the rows() methods.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this works in general, because the methods now attempt to access the ResultSet after containing resources have been closed.  E.g. in rows(String, Closure):&lt;/p&gt;

&lt;p&gt;		ResultSet rs = executeQuery(sql);&lt;br/&gt;
		if (metaClosure != null) metaClosure.call(rs.getMetaData());&lt;br/&gt;
		return asList(sql, rs);&lt;/p&gt;

&lt;p&gt;The executeQuery() method:&lt;/p&gt;

&lt;p&gt;        return new QueryCommand(sql).execute();&lt;/p&gt;

&lt;p&gt;And AbstractQueryCommand.execute() calls:&lt;/p&gt;

&lt;p&gt;        closeResources(connection, statement, null);&lt;/p&gt;

&lt;p&gt;Unfortunately the standard test suite does not expose the problem &amp;#8211; I think because HSQLDB is over-tolerant. I changed the test suite to use MySQL and it fails.&lt;/p&gt;

&lt;p&gt;I must admit I don&apos;t completely understand all of the resource handling paths in the Sql class, with regard to cached connections and what-not. My standard usage pattern in scripts is:&lt;/p&gt;

&lt;p&gt;Sql db = new Sql(dataSource)&lt;br/&gt;
// do stuff.&lt;/p&gt;

&lt;p&gt;With this pattern, and databases other than HSQLDB, I find the rows() and firstRow() methods fail with trunk.&lt;/p&gt;

&lt;p&gt;I attach a patch that restores some of the earlier code. I don&apos;t like my patch though, because the new code is nicer, but we better figure out something that works I guess!&lt;/p&gt;

&lt;p&gt;John Hurst&lt;/p&gt;</description>
                <environment></environment>
        <key id="12813636">GROOVY-3705</key>
            <summary>Sql rows() methods access ResultSet after Connection closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="john.b.hurst">John Hurst</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Aug 2009 22:52:26 +0000</created>
                <updated>Sun, 5 Apr 2015 14:44:06 +0000</updated>
                            <resolved>Tue, 15 Sep 2009 22:24:45 +0000</resolved>
                                    <version>1.7-beta-1</version>
                                    <fixVersion>1.6.5</fixVersion>
                    <fixVersion>1.7-beta-2</fixVersion>
                                    <component>SQL processing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14467450" author="john.b.hurst" created="Thu, 27 Aug 2009 15:21:42 +0000"  >&lt;p&gt;Another problem with my patch is it doesn&apos;t address the requirement that drove the change in 17279, i.e. &lt;/p&gt;</comment>
                            <comment id="14467581" author="john.b.hurst" created="Thu, 27 Aug 2009 15:23:23 +0000"  >&lt;p&gt;Another problem with my patch is it doesn&apos;t address the requirement that drove the change in 17279, i.e. &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3665&quot; title=&quot;Allow subclasses of groovy.sql.Sql to get ResultSet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3665&quot;&gt;&lt;del&gt;GROOVY-3665&lt;/del&gt;&lt;/a&gt; Allow subclasses of groovy.sql.Sql to get ResultSet.&lt;/p&gt;

&lt;p&gt;BTW I noticed that trunk also fails with Oracle. It does work with the rows() changed reverted as in my patch.&lt;/p&gt;</comment>
                            <comment id="14467690" author="jwb" created="Tue, 8 Sep 2009 01:36:26 +0000"  >&lt;p&gt;I&apos;m getting organized to try running the unit tests against Oracle 11.1.  It may be the end of the week before I reach a conclusion - the Oracle instance is a but unstable at the moment.&lt;/p&gt;

&lt;p&gt;Would it be desirable to make the unit tests configurable to run against different DBMSs?  If so, if there&apos;s already a preferred approach to configuration, please point me at the relevant details.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
John&lt;/p&gt;</comment>
                            <comment id="14467629" author="john.b.hurst" created="Tue, 8 Sep 2009 02:25:24 +0000"  >&lt;p&gt;If you are having trouble getting your Oracle working, I could also reproduce the problem with MySQL. (I&apos;m primarily using Oracle, also PostgreSQL a little.)&lt;/p&gt;

&lt;p&gt;I think it would be really good if the groovy.sql.Sql tests could be run against a broader set of databases &amp;#8211; this case shows that HSQLDB is not really up to scratch for testing, since it allowed such a fundamental issue to be missed.&lt;/p&gt;

&lt;p&gt;I was able to get some of the tests working against MySQL, although it was rather more awkward than I had hoped. Here are some of the problems:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MySQL itself is awkward, because it is case-sensitive by default, unlike most SQL-based databases. Thus, tests that aren&apos;t very careful about consistent case of column/property names don&apos;t work without changes.&lt;/li&gt;
	&lt;li&gt;The current test code has a feature for creating a new in-memory schema per test case, and populating it. This doesn&apos;t work directly with MySQL or other conventional (i.e. persistent) databases.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If people would like I could have a crack at amending the test suite to be configurable to run on different databases. My development environment currently has Oracle, PostgreSQL, MySQL and Firebird, for testing purposes.&lt;/p&gt;

&lt;p&gt;I would also be interested in expanding the SQL tests to cover a bit more, because I think a number of features are not covered.&lt;/p&gt;

&lt;p&gt;As I mentioned on the dev list, I would like to submit a couple of further patches concerning eachRow(), rows() and also withBatch(), but I would like to straighten out the rows() issue first.&lt;/p&gt;

&lt;p&gt;JH&lt;/p&gt;</comment>
                            <comment id="14467655" author="jwb" created="Tue, 8 Sep 2009 04:07:37 +0000"  >&lt;p&gt;It certainly seems to me that having tests that one can run against any selected  DBMS is an important improvement. If there&apos;s an issue opened for allowing the tests to be configured to target a DBMS, please let me know - I&apos;ll watch it and try to help out.&lt;/p&gt;

&lt;p&gt;I can&apos;t really try MySQL right now, since part of what I have to get done this week is stabilizing our development Oracle instance. If I could get a patch or two which will make the tests run more portably, I&apos;d definitely take a shot at running them once I get past the troubles with Oracle here. &lt;/p&gt;

&lt;p&gt;First thing after I get the Oracle troubles behind me will be to propose a patch for this issue so that we have rows() working properly and you have a basis for the enhancements you&apos;re proposing.&lt;/p&gt;</comment>
                            <comment id="14467634" author="jwb" created="Sun, 13 Sep 2009 13:42:46 +0000"  >&lt;p&gt;Just want to let you folks know I&apos;m working on this, but my Cygwin SVN is broken, so I&apos;m off on tangent trying to fix that at the moment. (It appears that the svn.codehaus.org server is OK.  If there&apos;s something wrong with that, it would be nice to know.)&lt;/p&gt;</comment>
                            <comment id="14467723" author="jwb" created="Mon, 14 Sep 2009 11:10:46 +0000"  >&lt;p&gt;Patch for groovy.sql.Sql refactoring the rows(.&lt;b&gt;) and execute.*Query(.&lt;/b&gt;) methods so that there&apos;s still more shared code (and it&apos;s pretty DRY), but it now closes the Connection only after the rows operation is done building the result List.&lt;/p&gt;</comment>
                            <comment id="14467778" author="jwb" created="Mon, 14 Sep 2009 11:15:14 +0000"  >&lt;p&gt;I&apos;ve attached an alternative patch that preserves the most of the code sharing between the rows(.&lt;b&gt;) methods and the execute.*Query(.&lt;/b&gt;) methods.  It includes some additional assertions in the SqlTest.testSubClass() method to assure that the connection is open in the resultSetMetaData closure. I&apos;m pretty sure all the relevant unit tests pass (definitely SqlTest &amp;amp; SqlRowsTest), but I have problems trying to run the full suite.  (Pretty sure it&apos;s due to my environment and not problems in the Groovy build or the changes I&apos;m proposing.)&lt;/p&gt;</comment>
                            <comment id="14467740" author="blackdrag" created="Mon, 14 Sep 2009 18:44:31 +0000"  >&lt;p&gt;two quick questions.... putting the finally blokc to close the ressources into execution or a final method that calls it makes no sense? in the patch is a SQLSubClass for a test... doesn&apos;t it need to call super in setInternalConnection?  If the answer is &quot;no, because it is not tested&quot;, then it looks to me like a missing test.&lt;/p&gt;</comment>
                            <comment id="14467790" author="jwb" created="Mon, 14 Sep 2009 23:59:30 +0000"  >&lt;p&gt;Thanks for the code review!  I&apos;m afraid I&apos;m not sure how to address the comments.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;putting the finally blokc to close the ressources into execution or a final method that calls it makes no sense?&lt;br/&gt;
All the finally blocks that I modified/added in this patch are calling a closeResources method on an AbstractQueryCommand.  Are you concerned that making the closeResources final prevents subclasses from effectively adding their own resources?  I was thinking about keeping the QueryCommand classes private.  Perhaps that&apos;s a better decision until the need is more clear.&lt;/li&gt;
	&lt;li&gt;in the patch is a SQLSubClass for a test... doesn&apos;t it need to call super in setInternalConnection?&lt;br/&gt;
The setInternalConnection method was only added in order to be able to write a test that determines that the connection is available during the execution of the metaData closure.  It is tested by the assert sub.connection in SqlTest.testSubClass.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m sorry I don&apos;t know immediately the best changes to make in order to resolve your concerns.  I can certainly add a comment in SqlTest.testSubClass.   I&apos;ll think over the visibility of the QueryCommand classes and submit another patch or comment shortly.&lt;/p&gt;</comment>
                            <comment id="14467619" author="jwb" created="Tue, 15 Sep 2009 02:25:56 +0000"  >&lt;p&gt;I&apos;d like to know folks&apos; view of extension points: is it preferred to offer them in anticipation or withhold them until a need is expressed?&lt;/p&gt;

&lt;p&gt;We could either make the QueryCommand factories and all the classes private or make them all protected. Making them private has the advantage that the API of the Sql class is smaller. Making them protected gives freedom to subclasses. I might let it sit for a day to see if I come up with any compelling use case for subclassing a QueryCommand.&lt;/p&gt;

&lt;p&gt;Please let your preference be known.&lt;/p&gt;</comment>
                            <comment id="14478664" author="paulk" created="Tue, 15 Sep 2009 04:24:01 +0000"  >&lt;p&gt;Much of the codebase has a slight leaning towards making things protected rather than private where it makes sense; however, ideas on industry best practice has probably moved on since some of the codebase was written - I am inclined to leave it as private initially and it is relatively straightforward to make it more public later if we find a use. So, with that said, I am thinking of committing the patch as is shortly - I am reasonably happy with it. We can make slight amendments or comments (e.g. to address Jochen&apos;s concerns later).&lt;/p&gt;</comment>
                            <comment id="14467725" author="jwb" created="Tue, 15 Sep 2009 04:39:35 +0000"  >&lt;p&gt;Alrighty, then &amp;#8211; I&apos;ll wait to see the updated trunk.  If blackdrag clarifies his comments, I&apos;ll be happy to put some more improvements in.&lt;/p&gt;</comment>
                            <comment id="14478681" author="paulk" created="Tue, 15 Sep 2009 09:20:15 +0000"  >&lt;p&gt;Added to trunk in current form. Knock yourself out with any improvements you can think of.&lt;/p&gt;

&lt;p&gt;I also added some tweaks to the build file to help make it easier to test other databases.&lt;br/&gt;
The theory is you add to the ant command line something like:&lt;br/&gt;
&lt;tt&gt;-Dgroovy.testdb.props=oracle.props&lt;/tt&gt;&lt;br/&gt;
Then in the &lt;tt&gt;oracle.props&lt;/tt&gt; (or other database) file have something like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;groovy.testdb.url=jdbc:oracle:thin:@localhost:1521:xe
groovy.testdb.driver=oracle.jdbc.driver.OracleDriver
groovy.testdb.username=username
groovy.testdb.password=password
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You need to either manually or through the pom or via hacked ant steps get the database driver into the &lt;tt&gt;target/lib/test&lt;/tt&gt; directory.&lt;br/&gt;
It still needs some work (e.g. it currently only works for tests which extend &lt;tt&gt;groovy.sql.TestHelper&lt;/tt&gt; and hasn&apos;t been tweaked to make it robust against many databases yet) but might be a useful start for testing with other databases.&lt;/p&gt;</comment>
                            <comment id="14467694" author="john.b.hurst" created="Tue, 15 Sep 2009 18:08:26 +0000"  >&lt;p&gt;Just to let you know, the rows() methods are all working fine for me using Groovy trunk with Oracle now.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;I hope to have some other (very trivial) patches to submit soonish. Also I may get a chance to work on the groovy.sql.Sql tests later this week.&lt;/p&gt;

&lt;p&gt;JH&lt;/p&gt;</comment>
                            <comment id="14478653" author="paulk" created="Tue, 15 Sep 2009 22:24:45 +0000"  >&lt;p&gt;Resolving for now. We can create new issues if need be for future enhancements/fixes.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12721383" name="rows_broken_with_command_pattern.patch" size="2231" author="john.b.hurst" created="Wed, 26 Aug 2009 22:52:26 +0000"/>
                            <attachment id="12721384" name="sql_17615.patch" size="8583" author="jwb" created="Mon, 14 Sep 2009 11:10:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c6qf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>