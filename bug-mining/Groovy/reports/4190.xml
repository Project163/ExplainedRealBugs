<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:14:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-10049] STC fails when calling a generic method from another generic method</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-10049</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The static type checker fails to properly determine the return type of a generic method when that method is called from another generic method. Here&apos;s an example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; Set&amp;lt;T&amp;gt; generateNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		&lt;span class=&quot;code-comment&quot;&gt;// mock &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value, needed to demonstrate the issue
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.emptySet();
	}

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; void printNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		generateNumbers(numberType).stream()
			.filter(num -&amp;gt; num.doubleValue() &amp;gt; 0)
			.forEach(num -&amp;gt; println &lt;span class=&quot;code-quote&quot;&gt;&quot;$num&quot;&lt;/span&gt;);
	}
	
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With static type checking enabled, compilation of this class fails:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Script_bbf0c00c9b2872d2a3528c2d80bbaa49.groovy: 10: [Static type checking] - Cannot find matching method java.lang.Object#doubleValue(). Please check if the declared type is correct and if the method exists.
 @ line 10, column 19.
   			.filter(num -&amp;gt; num.doubleValue() &amp;gt; 0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we call the &lt;tt&gt;generateNumbers()&lt;/tt&gt; method with a specific class, everything works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; Set&amp;lt;T&amp;gt; generateNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.emptySet();
	}

	void printNumbers() {
		generateNumbers(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;).stream()
			.filter(num -&amp;gt; num.doubleValue() &amp;gt; 0)
			.forEach(num -&amp;gt; println &lt;span class=&quot;code-quote&quot;&gt;&quot;$num&quot;&lt;/span&gt;);
	}
	
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like the static type checker does not properly take into account the generic types of the surrounding method and thus fails to determine the type of the returned value.&lt;/p&gt;</description>
                <environment>OpenJDK 8</environment>
        <key id="13374113">GROOVY-10049</key>
            <summary>STC fails when calling a generic method from another generic method</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="latanasov">Lyuben Atanasov</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Apr 2021 11:16:23 +0000</created>
                <updated>Sat, 4 Jun 2022 15:14:15 +0000</updated>
                            <resolved>Fri, 17 Sep 2021 13:35:24 +0000</resolved>
                                    <version>3.0.8</version>
                    <version>4.0.0-alpha-3</version>
                    <version>4.0.0-beta-1</version>
                                    <fixVersion>4.0.0-beta-2</fixVersion>
                    <fixVersion>3.0.12</fixVersion>
                                    <component>Static Type Checker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17326780" author="latanasov" created="Wed, 21 Apr 2021 18:08:55 +0000"  >&lt;p&gt;Upon debugging the static type checker, I&apos;ve found out that the return value of the &lt;tt&gt;stream()&lt;/tt&gt; method is actually correct. What doesn&apos;t work is type inference for the lambda/closure arguments. For some reason the generic type for the SAM parameter is resolved to &lt;tt&gt;T -&amp;gt; java.lang.Object&lt;/tt&gt; instead of &lt;tt&gt;T -&amp;gt; java.lang.Number&lt;/tt&gt;. I have narrowed it down to an issue somewhere in &lt;tt&gt;StaticTypeCheckingVisitor.inferSAMType()&lt;/tt&gt; where it is supposed to infer closure parameter types.&lt;/p&gt;</comment>
                            <comment id="17326785" author="emilles" created="Wed, 21 Apr 2021 18:19:09 +0000"  >&lt;p&gt;It should be able to connect all the way to Integer.  I have seen some other problem scenarios where &quot;def &amp;lt;T&amp;gt; T m(Class&amp;lt;T&amp;gt; c)&quot; fails to infer the type of T properly.  I had just put some on the back burner when looking into &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-9033&quot; title=&quot;Bad code green: empty list literal with each method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-9033&quot;&gt;&lt;del&gt;GROOVY-9033&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17326802" author="emilles" created="Wed, 21 Apr 2021 18:33:20 +0000"  >&lt;p&gt;If you replace &quot;generateNumbers(Integer)&quot; with &quot;this.&amp;lt;Integer&amp;gt;generateNumbers(Integer)&quot; does it work out all the rest?&lt;/p&gt;</comment>
                            <comment id="17326805" author="latanasov" created="Wed, 21 Apr 2021 18:35:49 +0000"  >&lt;p&gt;The &lt;tt&gt;generateNumbers(Integer)&lt;/tt&gt; example works without issue. I only added it to show that in the simplest case, type resolution works as expected. The first example is the problematic one - calling the &lt;tt&gt;generateNumbers()&lt;/tt&gt; method from another generic method.&lt;/p&gt;</comment>
                            <comment id="17326810" author="emilles" created="Wed, 21 Apr 2021 18:39:32 +0000"  >&lt;p&gt;If you supply an explicit type argument, the return value inference takes a different path.  What is the inferred type of &quot;num&quot; if you make this substitution?&lt;/p&gt;</comment>
                            <comment id="17326823" author="emilles" created="Wed, 21 Apr 2021 18:46:45 +0000"  >&lt;p&gt;See, it all comes down to the return type inference of &quot;generateNumbers&quot;:&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13024408/13024408_screenshot-2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13024407/13024407_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17326826" author="emilles" created="Wed, 21 Apr 2021 18:55:49 +0000"  >&lt;p&gt;Oh I see, you are passing in the parameterized type via &quot;numberType&quot;, so there is no concrete type to infer.&lt;/p&gt;</comment>
                            <comment id="17326833" author="latanasov" created="Wed, 21 Apr 2021 18:59:32 +0000"  >&lt;p&gt;Indeed, I was about to explain that I might have made this example over-simplified. Here&apos;s a revised scenario that better demonstrates the intent of the code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; Set&amp;lt;T&amp;gt; generateNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		&lt;span class=&quot;code-comment&quot;&gt;// mock &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value, needed to demonstrate the issue
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.emptySet();
	}

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; void printNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		generateNumbers(numberType).stream()
			.filter(num -&amp;gt; num.doubleValue() &amp;gt; 0)
			.forEach(num -&amp;gt; println &lt;span class=&quot;code-quote&quot;&gt;&quot;$num&quot;&lt;/span&gt;);
	}
	
}

def test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Test();
test.printNumbers(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This still fails during static type checking.&lt;/p&gt;</comment>
                            <comment id="17326851" author="emilles" created="Wed, 21 Apr 2021 19:22:35 +0000"  >&lt;p&gt;This part of inferSAMType is dropping the type info because &quot;Steam&amp;lt;T extends Number&amp;gt;&quot; has unresolved generics.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void inferSAMType(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Parameter param, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClassNode receiver, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MethodNode methodWithSAMParameter, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ArgumentListExpression originalMethodCallArguments, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ClosureExpression openBlock) {
        &lt;span class=&quot;code-comment&quot;&gt;// first we &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get as much information about the declaration &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;through the receiver
&lt;/span&gt;        Map&amp;lt;GenericsTypeName, GenericsType&amp;gt; targetMethodConnections = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ClassNode face : receiver.getAllInterfaces()) {
            extractGenericsConnections(targetMethodConnections, getCorrectedClassNode(receiver, face, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;), face.redirect());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!receiver.isInterface()) {
            extractGenericsConnections(targetMethodConnections, receiver, receiver.redirect());
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Typically we use &lt;tt&gt;GenericsUtils.parameterizeType&lt;/tt&gt; to pass generics from the receiver to its interfaces.  You can see an example of this in: &lt;tt&gt;org.codehaus.groovy.transform.trait.Traits.collectAllInterfacesReverseOrder(ClassNode, LinkedHashSet&amp;lt;ClassNode&amp;gt;)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17326866" author="emilles" created="Wed, 21 Apr 2021 19:41:25 +0000"  >&lt;p&gt;The super-quick fix is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
extractGenericsConnections(targetMethodConnections, &lt;span class=&quot;code-comment&quot;&gt;/**/&lt;/span&gt;face == receiver ? receiver :&lt;span class=&quot;code-comment&quot;&gt;/**/&lt;/span&gt; getCorrectedClassNode(receiver, face, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;), face.redirect());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17326977" author="emilles" created="Wed, 21 Apr 2021 22:35:12 +0000"  >&lt;p&gt;Fix is available on master:&#160;&lt;a href=&quot;https://github.com/apache/groovy/commit/e07f0112c5eff8d9c6828bd0ddb69e4b7f7cc1d6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/e07f0112c5eff8d9c6828bd0ddb69e4b7f7cc1d6&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17415488" author="latanasov" created="Wed, 15 Sep 2021 12:31:42 +0000"  >&lt;p&gt;Although the issue is marked as fixed for 4.0.0-beta-1, a regression seems to have been introduced since the fix. The code still fails to compile when using the released 4.0.0-beta-1. &lt;br/&gt;
There is an additional regression related to the parser - the line&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.forEach(num -&amp;gt; println &lt;span class=&quot;code-quote&quot;&gt;&quot;$num&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is reported as unexpected input, but that is a separate issue.&lt;/p&gt;</comment>
                            <comment id="17415661" author="emilles" created="Wed, 15 Sep 2021 17:45:56 +0000"  >&lt;p&gt;Is the regression the parser error?  If you replace &apos;&lt;tt&gt;println &quot;$num&quot;&lt;/tt&gt;&apos; with &apos;&lt;tt&gt;println(&quot;$num&quot;)&lt;/tt&gt;&apos; is the STC error still present?&lt;/p&gt;</comment>
                            <comment id="17415663" author="latanasov" created="Wed, 15 Sep 2021 17:51:22 +0000"  >&lt;p&gt;The regression is not the parser error. I have reported it separately here: &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-10236&quot; title=&quot;Parser fails to parse a single-statement lambda when omitting parentheses for method call &quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-10236&quot;&gt;&lt;del&gt;GROOVY-10236&lt;/del&gt;&lt;/a&gt;. I had to work around the parser error the way you describe to even reach the static type checker.&lt;br/&gt;
The problem is that the original fix which was done between 4.0.0-alpha-3 and 4.0.0-beta-1 was working, i.e. this code compiled successfully after the fix was applied:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; Set&amp;lt;T&amp;gt; generateNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		&lt;span class=&quot;code-comment&quot;&gt;// mock &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value, needed to demonstrate the issue
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.emptySet();
	}

	&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt;&amp;gt; void printNumbers(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; numberType) {
		generateNumbers(numberType).stream()
			.filter(num -&amp;gt; num.doubleValue() &amp;gt; 0)
			.forEach(num -&amp;gt; println &lt;span class=&quot;code-quote&quot;&gt;&quot;$num&quot;&lt;/span&gt;);
	}
	
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Now, after the release of 4.0.0-beta-1, it fails again. So something must have happened in the mean-time.&lt;/p&gt;</comment>
                            <comment id="17415759" author="emilles" created="Wed, 15 Sep 2021 21:03:24 +0000"  >&lt;p&gt;I will take a look.&#160; If you use a different type parameter name for printNumbers it looks like there is no error.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13448385">GROOVY-10648</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13024407" name="screenshot-1.png" size="41648" author="emilles" created="Wed, 21 Apr 2021 18:44:27 +0000"/>
                            <attachment id="13024408" name="screenshot-2.png" size="40470" author="emilles" created="Wed, 21 Apr 2021 18:45:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qahc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>