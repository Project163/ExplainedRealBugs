<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:14:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4029] putAt and  put behave different on Maps</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4029</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>
&lt;p&gt;Map m = &lt;span class=&quot;error&quot;&gt;&amp;#91;:&amp;#93;&lt;/span&gt;&lt;br/&gt;
//this is ok as LinkedHashMap supports null as key and value&lt;br/&gt;
m.put(null, null)&lt;/p&gt;

&lt;p&gt;//this will throw an exception&lt;br/&gt;
m&lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; = null&lt;/p&gt;</description>
                <environment></environment>
        <key id="12815072">GROOVY-4029</key>
            <summary>putAt and  put behave different on Maps</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="kmuntau">Kristian Muntau</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Feb 2010 02:00:26 +0000</created>
                <updated>Wed, 7 Apr 2010 23:46:48 +0000</updated>
                            <resolved>Tue, 9 Feb 2010 11:40:09 +0000</resolved>
                                    <version>1.7.0</version>
                                    <fixVersion>1.6.8</fixVersion>
                    <fixVersion>1.7.1</fixVersion>
                    <fixVersion>1.8-beta-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14468877" author="kmuntau" created="Tue, 2 Feb 2010 02:07:50 +0000"  >&lt;p&gt;this was found while porting an application from groovy version 1.6.3 to 1.7.0&lt;/p&gt;</comment>
                            <comment id="14468861" author="roshandawrani" created="Tue, 2 Feb 2010 03:46:16 +0000"  >&lt;p&gt;I looked a bit into it. &lt;/p&gt;

&lt;p&gt;m&lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; = null selects DGM#putAt(Object, String, Object) over DGM#putAt(Map, Object, Object) because key in the subscript operator is supposed to be String. Because of that DGM selection, it goes to MetaClassImpl#setProperty(), which tries to use the key&apos;s hashcode in meta-property look-up in MethodIndex maps. Since the key is null, it results in NPE.&lt;/p&gt;

&lt;p&gt;So,&lt;br/&gt;
Option 1) Specially handle key = null and MC.isMap = true in the beginning of MetaClassImpl#setProperty() and delegate it to Map.put(key, value)&lt;/p&gt;

&lt;p&gt;Option 2) Introduce DGM#putAt(Map, String, Object) so that it gets selected over DGM#putAt(Object, String, Object).&lt;/p&gt;

&lt;p&gt;Which way looks better?&lt;/p&gt;</comment>
                            <comment id="14468807" author="roshandawrani" created="Tue, 2 Feb 2010 05:00:56 +0000"  >&lt;p&gt;Attaching both the potential patches for review.&lt;/p&gt;</comment>
                            <comment id="14468791" author="blackdrag" created="Tue, 2 Feb 2010 05:12:34 +0000"  >&lt;p&gt;for null the most general class should be selected, and that is Object, not String. So if String is used, it is wrong here. That sounds like a method selection bug&lt;/p&gt;</comment>
                            <comment id="14468876" author="blackdrag" created="Tue, 2 Feb 2010 05:16:32 +0000"  >&lt;p&gt;And indeed.... while&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def foo(Map x, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p) {1}
def foo(Map x, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p) {2}
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; foo([:],&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)==1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;works, this fails&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def foo(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p) {1}
def foo(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p) {2}
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; foo(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)==1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The later case is what is used to select the DGM method. So we have definitely a method selection bug here&lt;/p&gt;</comment>
                            <comment id="14468847" author="roshandawrani" created="Tue, 2 Feb 2010 05:35:20 +0000"  >&lt;p&gt;Yes, method selection is the problem overall. I had first looked at the method selection area itself.&lt;/p&gt;

&lt;p&gt;When MetaClassImpl#calculateParameterDistance() looks at both &lt;br/&gt;
DGM(Map, Object, Object) and &lt;br/&gt;
DGM(Object, String, Object), it first calculates the distance for DGM(Object, String, Object), finds the distance 0, and simply selects that method. &lt;/p&gt;

&lt;p&gt;It doesn&apos;t even calculate the distance for DGM(Map, Object, Object). That&apos;s where the error is coming from.&lt;/p&gt;</comment>
                            <comment id="14468780" author="roshandawrani" created="Tue, 2 Feb 2010 08:43:06 +0000"  >&lt;p&gt;Jochen, here is another proposed patch, which fixes the method selection.&lt;/p&gt;

&lt;p&gt;It now looks at parameter distances of all candidate methods and chooses the most specific one - instead of jumping out pre-maturely on seeing a distance of 0.&lt;/p&gt;</comment>
                            <comment id="14468808" author="roshandawrani" created="Wed, 3 Feb 2010 09:17:00 +0000"  >&lt;p&gt;Jochen, do you see any issue with the parameter distance patch? Or shall I go ahead with it?&lt;/p&gt;</comment>
                            <comment id="14468879" author="blackdrag" created="Thu, 4 Feb 2010 07:05:16 +0000"  >&lt;p&gt;Does it really fix the issue? Because distance 0 means a direct match, meaning there should be no other method which does fit it better. But I wonder why the distance is 0. It is just wrong that null causes a zero distance. Well, ok, if we say that null causes a zero distance, then of course there oculd be multiple methods with distance 0... but then the method selection would result in a method selection error. So for me the error here is not jumping out prematurely, it is that this should not give the distance 0 for mathching String agains null. Probably the method selection process needs a refinement here in using the distance to Object as distance element for this. not of the argument class as usal, but of the parameter class. Then String is less fitting than Object and the Object version should be selected&lt;/p&gt;</comment>
                            <comment id="14468884" author="roshandawrani" created="Thu, 4 Feb 2010 07:22:17 +0000"  >&lt;p&gt;It seems to fix the issue. Didn&apos;t break any existing test and fixes the issue here. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;But you know better about the parameter distance calculations.&lt;/p&gt;

&lt;p&gt;I can tell you where the distance 0 is coming from. Let&apos;s see if it helps.&lt;/p&gt;

&lt;p&gt;When it calculates the distance for (null, null) against (String, Object), &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;it starts with objectDistance-- (dist = -1) and then adds 1 * 2 (dist = 1) (because String is 1 level away from Object). Dist offset for first parameter 1 &amp;lt;&amp;lt; 23&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;it then looks at next parameter (Object) - does objectDistance-- (dist = -1), nothing else gets added because parameter type Object is 0 level away from Object. Distance offset for this parameter -1 &amp;lt;&amp;lt; 23.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Now overall for both the parameters, distance becomes 1 &amp;lt;&amp;lt; 23 + -1 &amp;lt;&amp;lt; 23 = 0, making it the perfect match, because of which it prematurely exits not even looking at other candidates.&lt;/p&gt;</comment>
                            <comment id="14468806" author="roshandawrani" created="Thu, 4 Feb 2010 07:29:44 +0000"  >&lt;p&gt;It is already using the distance to Object as a distance element for this. And it is not looking at the argument as usual, but of the parameter class - because arguments are null.&lt;/p&gt;

&lt;p&gt;I don&apos;t know why it first does that (objectDistance &amp;#8211; ) in the beginning when the argument is null. If it doesn&apos;t do that, then we won&apos;t have this (+x) + (-x) situation choosing wrong perfect matches. But I don&apos;t have the background of that objectDistance --.&lt;/p&gt;</comment>
                            <comment id="14468751" author="blackdrag" created="Thu, 4 Feb 2010 08:07:40 +0000"  >&lt;p&gt;if any partial distance lower than 0 is returned, then this is absolutely wrong. So the distance calculation for null is wrong. 1 is right for String, but for object it should return 0, not -1. &lt;/p&gt;

&lt;p&gt;As of why there is objectDistance -.... no idea, maybe a relict from a refactoring... and it made sense back then.&lt;/p&gt;</comment>
                            <comment id="14468863" author="roshandawrani" created="Thu, 4 Feb 2010 08:33:55 +0000"  >&lt;p&gt;The partial distance of -1 &amp;lt;&amp;lt; 23 is coming due that objectDistance --, which makes it -1 to being with when it deals with nulls.&lt;/p&gt;

&lt;p&gt;If you also suspect that it may not make sense now, may be I will try removing that to attempt the 4th patch. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14468793" author="blackdrag" created="Thu, 4 Feb 2010 09:45:36 +0000"  >&lt;p&gt;yes, please &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14468827" author="roshandawrani" created="Thu, 4 Feb 2010 11:40:35 +0000"  >&lt;p&gt;I removed objectDistance--. Now there is no partial &amp;lt; 0 distance and it fixes the issue.&lt;/p&gt;

&lt;p&gt;Below is the patch - 4th time lucky?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/main/org/codehaus/groovy/runtime/MetaClassHelper.java
===================================================================
--- src/main/org/codehaus/groovy/runtime/MetaClassHelper.java	(revision 19174)
+++ src/main/org/codehaus/groovy/runtime/MetaClassHelper.java	(working copy)
@@ -303,8 +303,6 @@
             &lt;span class=&quot;code-comment&quot;&gt;// choose the distance to &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a parameter is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will mean that &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; is preferred over a more
&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// specific type
&lt;/span&gt;-            &lt;span class=&quot;code-comment&quot;&gt;// remove one to dist to be sure &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; is preferred
&lt;/span&gt;-            objectDistance--;
             &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; clazz = parameter.getTheClass();
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clazz.isPrimitive()) {
                 objectDistance += 2;
Index: src/test/groovy/bugs/Groovy4029Bug.groovy
===================================================================
--- src/test/groovy/bugs/Groovy4029Bug.groovy	(revision 0)
+++ src/test/groovy/bugs/Groovy4029Bug.groovy	(revision 0)
@@ -0,0 +1,9 @@
+&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; groovy.bugs
+
+&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Groovy4029Bug &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; GroovyTestCase {
+    void testAddNullKeyEntryInMapUsingSubscriptNotation() {
+        Map m = [:]
+        m[&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;] = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
+        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; m.size() == 1
+    }
+}
\ No newline at end of file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14468766" author="roshandawrani" created="Fri, 5 Feb 2010 14:42:30 +0000"  >&lt;p&gt;Hi Jochen. &lt;/p&gt;

&lt;p&gt;Shall I apply this last patch (not doing objectDistance-- to not have any -ive partial distances)?&lt;/p&gt;</comment>
                            <comment id="14468864" author="roshandawrani" created="Tue, 9 Feb 2010 05:01:50 +0000"  >&lt;p&gt;4 patches and more than that requests for final review. &lt;/p&gt;

&lt;p&gt;This JIRA should really be closed by now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14468794" author="blackdrag" created="Tue, 9 Feb 2010 05:07:22 +0000"  >&lt;p&gt;sorry, yes, zhe patch is fine&lt;/p&gt;</comment>
                            <comment id="14468839" author="roshandawrani" created="Tue, 9 Feb 2010 11:40:09 +0000"  >&lt;p&gt;Fixed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722255" name="v17x_DGM_New_Map_Method_Patch.txt" size="1116" author="roshandawrani" created="Tue, 2 Feb 2010 05:00:56 +0000"/>
                            <attachment id="12722496" name="v17x_MC_setProperty_Patch.txt" size="1151" author="roshandawrani" created="Tue, 2 Feb 2010 05:00:56 +0000"/>
                            <attachment id="12722257" name="v17x_Method_Selection_Patch.txt" size="1086" author="roshandawrani" created="Tue, 2 Feb 2010 08:43:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cljb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>