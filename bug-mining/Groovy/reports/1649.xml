<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:23:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5166] Static type checker should handle closure shared variables properly</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5166</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;See discussion at &lt;a href=&quot;http://groovy.329449.n5.nabble.com/Closure-shared-variables-and-flow-typing-tp5041259p5041259.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://groovy.329449.n5.nabble.com/Closure-shared-variables-and-flow-typing-tp5041259p5041259.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Copy of original post:&lt;/p&gt;


&lt;p&gt;Yesterday, Guillaume &amp;amp; I had a face-to-face working session in Paris. One of our discussion subjects was centered on static type checking, and especially a corner case with closure shared variables. In this email, I will expose the problem and the solutions we had in mind. Let&apos;s start with a sample code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The current implementation of the static type checked is totally wrong in that case (this is a bug I know about for long). Especially, it complains with the following error message:&lt;/p&gt;

&lt;p&gt;Cannot find matching method java.util.Date#toInteger()&lt;/p&gt;

&lt;p&gt;This is because the closure is visited before the call to x.toInteger() so the inferred type of x is changed although the closure is &lt;b&gt;not&lt;/b&gt; called. This example illustrates the case of a closure shared variable, &quot;x&quot;, and flow typing. In flow typing, we want this not to throw an error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date()
x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
x.toInteger() &lt;span class=&quot;code-comment&quot;&gt;// should work because the compiler can infer that x is of string type at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, when &quot;x&quot; is closure shared, we are facing a dangerous situation. Back to our first example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The workaround seems to be easy: &quot;hey, we don&apos;t call the closure, you must know that x is still a string at line 3!&quot;. If we do that, then we must also keep track of closure calls which may alter the shared variable:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
cl()
x.toInteger() &lt;span class=&quot;code-comment&quot;&gt;// now, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; must &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an error because x has changed type !&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In that case, this is a very problematic issue. Tracking shared variables is doable, but tracking closure calls depends on runtime execution and seems impossible. For example, we could have nastier code like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { foo -&amp;gt; x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
def cl2 = cl.curry(&lt;span class=&quot;code-quote&quot;&gt;&apos;If you ever visit Nantes, we could have a talk&apos;&lt;/span&gt;)
cl2()
x.toInteger() &lt;span class=&quot;code-comment&quot;&gt;// now, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; must &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an error because x has changed type !&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or even more problematic :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;A {
   Closure action
   def foo() { action() }
}

def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
def a = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; A(action:cl)
a.foo()
x.toInteger() &lt;span class=&quot;code-comment&quot;&gt;// now, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; must &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an error because x has changed type !&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Basically, the latter example shows it is rather impossible to track closure calls implying shared variables at compile time. The first solution is to disable flow typing. We don&apos;t really like that idea, as it is definitely not in the &quot;Groovy&quot; spirit. Though flow typing may be seen as bad style, we still think things like this are groovier:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;A {}
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;B &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; A { void foo() {} }

A a = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; B()
a.foo() &lt;span class=&quot;code-comment&quot;&gt;// should be allowed in &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; mode&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first option, then, is not the one we want to promote. The second option is to go &quot;Java style&quot;, and disallow closure shared variables, meaning each variable used in a closure should be final. The code you saw would therefore be invalid. But we don&apos;t like this idea because it would remove a large part of the interest of using &quot;lightweight&quot; closures.&lt;/p&gt;

&lt;p&gt;The 3rd solution, first suggested by Guillaume, was to ignore tracking of closure execution, and let the program fail at runtime. For example, this would fail with a class cast exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
cl()
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But it would fail &lt;b&gt;at runtime&lt;/b&gt;. Dynamic groovy would fail with a &quot;No signature of method Date#toInteger&quot;. I don&apos;t really like this option for two reasons:&lt;br/&gt;
    1. it beats the concept of static type checking, which is IMHO interesting if errors are found at compile time rather than runtime&lt;br/&gt;
    2. it is conceptually wrong&lt;/p&gt;

&lt;p&gt;After a short brainstorming session, where we discussed about possible warnings or disallowing assignments of shared variables in closures, I suggested an alternative option, which requires some trickery in the type checker, but seems conceptually correct: throwing an error on &quot;x.toInteger()&quot;, knowing that if you assign a shared variable in a closure with an &quot;incompatible&quot; type, this is not bad style, but very bad style. The question is how can we throw an error here, without throwing an error when the variable is &lt;b&gt;not&lt;/b&gt; closure shared (that is to say in the classical flow typing mode). My idea is to use the &quot;lowest upper bound&quot; algorithm to compute, for closure shared variables, the lowest common type of all assignments of a closure shared variables. Direct method calls (I mean, without explicit casts), in that case, should only be allowed on methods belonging to that common super type. This means that in that case:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
cl()
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We know that &apos;x&apos; is assigned a string and a date. We compute the LUB of those types. Then method calls on &apos;x&apos; would be checked against this type. Here, the LUB is an Object implementing Serializable. Serializable doesn&apos;t have a &quot;toInteger&quot; method, so &quot;toInteger&quot; would fail here. Guillaume, then, came with another example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
cl()
x = &lt;span class=&quot;code-quote&quot;&gt;&apos;456&apos;&lt;/span&gt;
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using our algorithm, &apos;x.toInteger()&apos; would throw a compilation error, so Guillaume said this would violate the principle of least surprise. At first, I thought we could be smarter, letting this pass if no method call was made between an assignment and the method call on the shared variable. For example, this would pass:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
cl()
x = &lt;span class=&quot;code-quote&quot;&gt;&apos;456&apos;&lt;/span&gt;
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this would not:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
def cl = { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
cl()
x = &lt;span class=&quot;code-quote&quot;&gt;&apos;456&apos;&lt;/span&gt;
logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&apos;info&apos;&lt;/span&gt;)
x.toInteger() &lt;span class=&quot;code-comment&quot;&gt;// would fail, because we don&apos;t know what logger.debug does. Potentially, it could lead to using the &lt;span class=&quot;code-quote&quot;&gt;&quot;cl&quot;&lt;/span&gt; closure. If you as a human know that it would not, the compiler cannot know, so it must invalidate the call&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, Guillaume came with an excellent counter-example. What if &quot;x&quot; is used in another thread? For example :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start { x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date() }
x = &lt;span class=&quot;code-quote&quot;&gt;&apos;456&apos;&lt;/span&gt;
x.toInteger()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is absolutely no guarantee that when &quot;x.toInteger()&quot; will be called, &quot;x&quot; will be of type &apos;String&apos;. There are chances that it will be of type Date, depending on when the assignement is executed... We all agree that using a shared variable in this use case is a very, ugly, fool code style, but it demonstrates that at compile time, we cannot make any better hint that &quot;x&quot; would be of the LUB type.&lt;/p&gt;

&lt;p&gt;This is why I think the solution of throwing an error systematically when such a method call is found is the right way to go. This would allow the classical &quot;flow typing&quot; to work. This would also encourage good style because using a shared variable to store whatever you want is not a good idea.&lt;/p&gt;

&lt;p&gt;Eventually, we must think about this use case :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def x = 1
def cl = { x.toInteger() }
x = &lt;span class=&quot;code-quote&quot;&gt;&apos;123&apos;&lt;/span&gt;
cl()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is a similar problem. Here, to be able to statically check the closure, we must know the type of the shared variable. There is no assignment in the closure, but still, we can statically check it if we use the very same algorithm. A call to &quot;.toInteger()&quot; would only be allowed if we know that this method belongs to all types that have been assigned to x. This won&apos;t be fun to implement, but I still think this is the most promising way to do this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12815981">GROOVY-5166</key>
            <summary>Static type checker should handle closure shared variables properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="melix">C&#233;dric Champeau</assignee>
                                    <reporter username="melix">C&#233;dric Champeau</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Dec 2011 06:54:29 +0000</created>
                <updated>Thu, 21 Jul 2022 21:23:59 +0000</updated>
                            <resolved>Mon, 5 Dec 2011 10:55:09 +0000</resolved>
                                    <version>2.0-beta-1</version>
                                    <fixVersion>2.0-beta-2</fixVersion>
                                    <component>Static Type Checker</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14472107" author="melix" created="Mon, 5 Dec 2011 07:20:12 +0000"  >&lt;p&gt;Fixed on &lt;tt&gt;grumpy&lt;/tt&gt; branch, for tests before merge.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13472768">GROOVY-10700</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c4pr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>