<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:56:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-649] Seriously Large Memory Leak (reproducable)</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-649</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;We have a server process that routinely evaluates thousands of simple grovvy expressions daily.   Our server process consistently needs to be restarted every two days due to an out of memory error.  &lt;/p&gt;

&lt;p&gt;We&apos;ve tracked this down to a leak in groovy.  (we&apos;ve proven this by removing groovy from our application and hard coded the expression results)&lt;/p&gt;

&lt;p&gt;If you execute the following piece of code, groovy will cause an out-of-memory error.  It consumes over 100mb of heap space, just to evaluated 3 + 4 ten thousand times!&lt;/p&gt;

&lt;p&gt;Assuming this is correct, I suggest no one uses groovy in production systems until this is resolved.  (I&apos;ll have a crack at it myself in the next few days)&lt;/p&gt;

&lt;p&gt;//--------------------------&lt;/p&gt;

&lt;p&gt;import groovy.lang.GroovyShell;&lt;/p&gt;

&lt;p&gt;public class Main {&lt;/p&gt;

&lt;p&gt;	public static void main(String[] args) throws Exception {&lt;/p&gt;

&lt;p&gt;        GroovyShell groovyShell = new GroovyShell();&lt;/p&gt;

&lt;p&gt;        for (int i = 1; i &amp;lt; 10000; i++) &lt;/p&gt;
{
        	Object groovyResult = groovyShell.evaluate(&quot;return 3 + 4;&quot;);
        	
        	if (i % 100 == 0)
        		System.out.print(&quot;.&quot;);
        }
&lt;p&gt;	} &lt;br/&gt;
}&lt;/p&gt;</description>
                <environment>Windows XP SP2, Linux 9.0, 1GB Ram, JDK 1.4.2-4 (server or client), Eclipse 3.0.1</environment>
        <key id="12816163">GROOVY-649</key>
            <summary>Seriously Large Memory Leak (reproducable)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="bdube">Brian Dube</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Oct 2004 05:34:11 +0000</created>
                <updated>Thu, 19 May 2005 13:06:33 +0000</updated>
                            <resolved>Mon, 28 Feb 2005 16:54:37 +0000</resolved>
                                    <version>1.0-beta-6</version>
                    <version>1.0-beta-7</version>
                                    <fixVersion>1.0-beta-10</fixVersion>
                                    <component>groovy-jdk</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                    <progress percentage="33">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="33" backgroundColor="#51a825"/>
                                                    <row percentage="67" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="33">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="33" backgroundColor="#51a825"/>
                                                    <row percentage="67" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="14400">4h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="14460507" author="cpoirier" created="Tue, 12 Oct 2004 12:00:17 +0000"  >&lt;p&gt;Hi Brian,&lt;/p&gt;

&lt;p&gt;This is just a guess and very possibly wrong (I haven&apos;t looked at the code in a while), but it might be a class loader issue.  Groovy compiles each of those &quot;statements&quot; into a Java class before running it, and it is my understanding from other people that classes aren&apos;t garbage collected until the class loader that owns it is collectable.  I think you can create and pass a class loader to GroovyShell, and passing it a single-use class loader may solve the problem.&lt;/p&gt;

&lt;p&gt;Once again, this is just a guess.  Your mileage may vary.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Later,&lt;br/&gt;
   Chris.&lt;/p&gt;</comment>
                            <comment id="14460595" author="jez" created="Tue, 12 Oct 2004 18:51:05 +0000"  >&lt;p&gt;I&apos;ve had a quick peek at this, and put my notes up so far at  &lt;a href=&quot;http://biscuit.javanicus.com:5909/GroovyMemoryUsageDuringEvaluations&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://biscuit.javanicus.com:5909/GroovyMemoryUsageDuringEvaluations&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="14460627" author="jez" created="Wed, 13 Oct 2004 03:46:43 +0000"  >&lt;p&gt;Sent to groovy dev list @ 13 Oct 2004&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;br/&gt;
In reference to Brian Oliver&apos;s issue (&lt;br/&gt;
&lt;a href=&quot;http://jira.codehaus.org/browse/GROOVY-649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jira.codehaus.org/browse/GROOVY-649&lt;/a&gt; ), I&apos;ve been having a quick&lt;br/&gt;
peek around the consequences of evaluating groovy expressions.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I&apos;ve done some empirical tests, varying the test case given,&lt;br/&gt;
observing timings and memory usage.&lt;/li&gt;
	&lt;li&gt;and using the YourKit Java Profiler ( &lt;a href=&quot;http://www.yourkit.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.yourkit.com&lt;/a&gt; ), I&apos;ve&lt;br/&gt;
had a look at what is hogging the most time and memory.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;jez&apos;s notes: ( &lt;a href=&quot;http://biscuit.javanicus.com:5909/GroovyMemoryUsageDuringEvaluations&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://biscuit.javanicus.com:5909/GroovyMemoryUsageDuringEvaluations&lt;/a&gt;&lt;br/&gt;
)&lt;/p&gt;

&lt;p&gt;From this my observations, the thing that strikes me most is the&lt;br/&gt;
static property &apos;singleton&apos; of type Invoker on InvokerHelper.&lt;/p&gt;

&lt;p&gt;My understanding of the issue is...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The Invoker instance holds a reference to a MetaClassRegistry, which&lt;br/&gt;
in turn holds a synchronized HashMap of MetaClass instances called&lt;br/&gt;
&apos;metaClasses&apos;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&apos;metaClasses&apos; is an expensive object in terms of object size, and as&lt;br/&gt;
there is one per JVM, it will end up with a reference to all MetaClass&lt;br/&gt;
instances.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It is my understanding that as the &apos;singleton&apos; is statically&lt;br/&gt;
initialised with a new instance, then the expensive &apos;metaClasses&apos;&lt;br/&gt;
object will indirectly be held by the main ClassLoader holding the&lt;br/&gt;
InvokerHelper Class reference.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Solutions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;refactor the &apos;singleton&apos; instance into GroovyClassLoader, so that&lt;br/&gt;
the &apos;metaClasses&apos; object gets GC&apos;d when the GCL does.&lt;/li&gt;
	&lt;li&gt;Make &apos;singleton&apos; on InvokerHelper into a WeakReference&lt;/li&gt;
	&lt;li&gt;Make &apos;metaClasses&apos; into a WeakReference&lt;/li&gt;
	&lt;li&gt;Refactor every method that uses &apos;singleton&apos; in InvokerHelper, so&lt;br/&gt;
that you pass an Invoker instance as a method parameter&lt;/li&gt;
	&lt;li&gt;Other suggestions welcomed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My feeling is towards the first at the moment, as it would keep the&lt;br/&gt;
heavy object references in the same lifecycle as the&lt;br/&gt;
GroovyClassLoader.&lt;/p&gt;

&lt;p&gt;Also I have a general distrust of static properties and static&lt;br/&gt;
initialisers, and would like to move this toward a picocontainer style&lt;br/&gt;
dependancy injection if possible&lt;/p&gt;

&lt;p&gt;Thoughts, comments, flames...&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
&lt;a href=&quot;http://javanicus.com/blog2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://javanicus.com/blog2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14460947" author="henrik_kjallbring@g1.com" created="Thu, 19 May 2005 13:06:32 +0000"  >&lt;p&gt;The original memory leak has been fixed, but there is a different scenario that still leaks:&lt;/p&gt;

&lt;p&gt;When you create a Script, and then call run() on that Script, it is important to remove any entries created in the MetaClassRegistry after you are done. This is done by calling InvokerHelper.removeClass(script.getClass()). If you do not, the MetaClassRegistry will keep growing until you run out of memory. &lt;/p&gt;

&lt;p&gt;Secondly, make sure that the GroovyShell is non-static, i.e. garbage collectable. Otherwise the GroovyClassLoader associated with the GroovyShell will hold on the all the classes (scripts) ever created.&lt;/p&gt;

&lt;p&gt;It took a while to figure all this out, but a working solution is shown below:&lt;/p&gt;

&lt;p&gt;import groovy.lang.*;&lt;br/&gt;
import org.codehaus.groovy.runtime.InvokerHelper;&lt;/p&gt;

&lt;p&gt;public class MemoryLeak&lt;br/&gt;
{&lt;br/&gt;
  //  Using a static GroovyShell causes a memory leak, &lt;br/&gt;
  // since the GroovyClassLoader is never gc:ed&lt;br/&gt;
//  static GroovyShell groovyShell = new GroovyShell();&lt;/p&gt;

&lt;p&gt;  public static void main(String[] args) throws Exception&lt;br/&gt;
  {&lt;br/&gt;
    int numJobs = 50;&lt;br/&gt;
    int numTransforms = 10;&lt;br/&gt;
    long numRecords = 5;&lt;/p&gt;

&lt;p&gt;    long start = System.currentTimeMillis();&lt;br/&gt;
    for (int currentJob = 0; currentJob &amp;lt; numJobs; currentJob++)&lt;br/&gt;
    {&lt;br/&gt;
      GroovyShell groovyShell = new GroovyShell();&lt;br/&gt;
      Script[] scripts = new Script&lt;span class=&quot;error&quot;&gt;&amp;#91;numTransforms&amp;#93;&lt;/span&gt;;&lt;br/&gt;
      for (int x = 0; x &amp;lt; scripts.length; x++)&lt;/p&gt;
      {
        scripts[x] = groovyShell.parse(&quot;return value + &quot; + x + &quot;;&quot;);
      }
&lt;p&gt;      for (int i = 1; i &amp;lt; numRecords; i++)&lt;br/&gt;
      {&lt;br/&gt;
        for (int x = 0; x &amp;lt; scripts.length; x++)&lt;/p&gt;
        {
          Binding binding = scripts[x].getBinding();
          binding.setVariable(&quot;value&quot;, &quot;3&quot;);
          scripts[x].setBinding(binding);
          Object groovyResult = scripts[x].run();
    
          if (i % 5000 == 0) System.out.print(&quot;.&quot;);
        }
&lt;p&gt;      }&lt;br/&gt;
      // Clean up necessary for removing new classes (scripts) from the MetaClassRegistry&lt;br/&gt;
      // If it is not done, you will have a memory leak.&lt;br/&gt;
      for(int x = 0; x &amp;lt; scripts.length; x++)&lt;/p&gt;
      {
        InvokerHelper.removeClass(scripts[x].getClass());
      }
&lt;p&gt;      System.out.println(&quot;End Job &quot; + currentJob);&lt;br/&gt;
    }&lt;br/&gt;
    System.out.println();&lt;br/&gt;
    long end = System.currentTimeMillis();&lt;br/&gt;
    System.out.println(&quot;Multiple Script/Shell Outside Loop Elapsed Time=&quot; + (end - start));&lt;/p&gt;

&lt;p&gt;  }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Henrik&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            20 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c813:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>