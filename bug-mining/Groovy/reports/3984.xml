<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:10:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9902] Generic typecheck in @DelegatesTo doesn&apos;t work</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9902</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I found an edge case where @CompileStatic doesn&apos;t raise an error when calling a method with incompatible types.&lt;/p&gt;

&lt;p&gt;Example code that reproduces the problem:&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://groovyconsole.appspot.com/script/5098548152500224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groovyconsole.appspot.com/script/5098548152500224&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.CompileStatic

/**
 * For the bug to be visible &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;has to have a &lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt; type
 * Even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the &lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt; seems pointless.
 */
@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Holder&amp;lt;D&amp;gt; {
  TypedProperty&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, D&amp;gt; stringProperty = prop(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)
  TypedProperty&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, D&amp;gt; longProperty = prop(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;)

  def &amp;lt;T&amp;gt; TypedProperty&amp;lt;T, D&amp;gt; prop(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TypedProperty&amp;lt;T, D&amp;gt;(clazz: clazz)
  }

  /**
   * This method is also necessary to trigger the bug.
   * Seems like because of the missing &amp;lt;D&amp;gt; in the @DelegatesTo the typechecker is tripped up?
   * In the original method in our codebase the signature contains &amp;lt;D&amp;gt; as well.
   */
  def &amp;lt;T&amp;gt; T of(@DelegatesTo(value = Holder, strategy = Closure.DELEGATE_FIRST) Closure&amp;lt;T&amp;gt; c) {
    c.delegate = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
    c.resolveStrategy = Closure.DELEGATE_FIRST
    c()
  }
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TypedProperty&amp;lt;T, D&amp;gt; {
  &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz

  void eq(T t) {
    &lt;span class=&quot;code-comment&quot;&gt;// The code fails here, expected &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; but got GString
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// This should have been catched by the typechecker
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// And/Or the typechecker should have automatically converted GString to &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; t.class == clazz, &lt;span class=&quot;code-quote&quot;&gt;&quot;t.&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;is ${t.class} not ${clazz}&quot;&lt;/span&gt;
  }
}

@CompileStatic
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void test() {
    Holder&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; q = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Holder&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;()
    &lt;span class=&quot;code-comment&quot;&gt;// Works:
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Typechecker catches &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;: Cannot call TypedProperty &amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;#eq(java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) with arguments [groovy.lang.GString]
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// q.stringProperty.eq(&lt;span class=&quot;code-quote&quot;&gt;&quot;${0}&quot;&lt;/span&gt;)
&lt;/span&gt;    
    &lt;span class=&quot;code-comment&quot;&gt;// Doesn&apos;t work because of delegation
&lt;/span&gt;    q.of {
      &lt;span class=&quot;code-comment&quot;&gt;// Typechecker should be able to &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; as well
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// But instead it yields a runtime problem because TypedProperty is called with GString and &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; fails
&lt;/span&gt;      stringProperty.eq(&lt;span class=&quot;code-quote&quot;&gt;&quot;${0}&quot;&lt;/span&gt;)
      
      &lt;span class=&quot;code-comment&quot;&gt;// Doesn&apos;t get catched by the typecherk as well - completely different types &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; and &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;
&lt;/span&gt;      longProperty.eq(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;)
    }
  }
}

Test.test()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13353562">GROOVY-9902</key>
            <summary>Generic typecheck in @DelegatesTo doesn&apos;t work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="fesc">Felix Scheinost</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Jan 2021 15:48:02 +0000</created>
                <updated>Tue, 1 Mar 2022 20:05:12 +0000</updated>
                            <resolved>Tue, 2 Mar 2021 15:14:59 +0000</resolved>
                                    <version>2.5.6</version>
                    <version>3.0.7</version>
                                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>4.0.0-alpha-3</fixVersion>
                    <fixVersion>2.5.16</fixVersion>
                                    <component>Static compilation</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17268806" author="emilles" created="Wed, 20 Jan 2021 19:11:28 +0000"  >&lt;p&gt;As noted in your comment for &quot;of&quot;, &lt;tt&gt;@DelegatesTo(value=Holder&lt;/tt&gt; is missing the generics necessary for the type checker to give you the warnings you are looking for.  In your case, the delegate is the implicit parameter &quot;this&quot; and there is not a good way to indicate that fact in the annotation metadata.&lt;/p&gt;

&lt;p&gt;Not sure what &quot;of&quot; does in your real code, but in this case, using the DGM &quot;tap&quot; or &quot;with&quot; instead will carry forward the generics since the &quot;self&quot; parameter is explicit in the extension method declarations.&lt;/p&gt;</comment>
                            <comment id="17268830" author="fesc" created="Wed, 20 Jan 2021 19:54:10 +0000"  >&lt;p&gt;Hmm, ideally the signature of &quot;of&quot; should look like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SomeOtherType&amp;lt;D&amp;gt; of(@DelegatesTo(value = Holder&amp;lt;D&amp;gt;, strategy = Closure.DELEGATE_FIRST) Closure&amp;lt;SomeOtherType&amp;lt;T&amp;gt;&amp;gt; c) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But Holder&amp;lt;D&amp;gt; is not possible with @DelegatesTo, right?&lt;/p&gt;

&lt;p&gt;I agree that the code isn&apos;t ideal.&lt;/p&gt;

&lt;p&gt;But still I think that the typechecker should catch that because even if &quot;D&quot; is unknown T is safely known to be String/Long in TypedProperty. So the typechecker should be able to infer that the method call is always wrong, irrespective of the value of D.&lt;/p&gt;

&lt;p&gt;I personally place a lot of trust on pieces of code annotated with &quot;@CompileStatic&quot; and I think that a typechecker that is too strict is preferably over a too lax one. In this case I was surprised with a runtime error when I thought that would be prevented by the typechecker.&lt;/p&gt;</comment>
                            <comment id="17268836" author="fesc" created="Wed, 20 Jan 2021 19:59:28 +0000"  >&lt;p&gt;Would something like &quot;@DelegatesTo.Self&quot; be possible?&lt;/p&gt;

&lt;p&gt;So an annotation that would describe a delegation to &quot;this&quot; including all generics of the instance that it is called on?&lt;/p&gt;</comment>
                            <comment id="17268899" author="emilles" created="Wed, 20 Jan 2021 22:34:34 +0000"  >&lt;p&gt;With regards to &quot;I think that the typechecker should catch that because even if &lt;tt&gt;D&lt;/tt&gt; is unknown &lt;tt&gt;T&lt;/tt&gt; is safely known...&quot;, the current checking stops right at the start if any of the type parameters are incomplete:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; typeCheckMethodsWithGenerics(ClassNode receiver, ClassNode[] arguments, MethodNode candidateMethod) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isUsingUncheckedGenerics(receiver)) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
        ...
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would need some change in &lt;tt&gt;StaticTypeCheckingSupport&lt;/tt&gt; to account for partial information.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mt7c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>