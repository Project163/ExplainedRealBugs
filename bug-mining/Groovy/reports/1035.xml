<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:13:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3679] ClassCastException writing entry to map via [] when key matches private field name</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3679</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The convenient [] syntax for Map usage fails with a ClassCastException if the key happens to match the name of a private field in the map implementation.&lt;br/&gt;
So for HashMap an easy one to accidentally hit this with is &quot;table&quot;.  So the following code:&lt;/p&gt;

&lt;p&gt;def map = new HashMap()&lt;br/&gt;
map&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;table&amp;quot;&amp;#93;&lt;/span&gt; = &quot;SOME_TABLE&quot;&lt;/p&gt;

&lt;p&gt;Leads to:&lt;br/&gt;
Caught: org.codehaus.groovy.runtime.typehandling.GroovyCastException: Cannot cast object &apos;S&apos; with class &apos;java.lang.String&apos; to class &apos;java.util.HashMap$Entry&apos;&lt;/p&gt;

&lt;p&gt;Using &lt;span class=&quot;error&quot;&gt;&amp;#91;:&amp;#93;&lt;/span&gt; to create the map is fine though as that creates a LinkedHashMap which doesn&apos;t have a &quot;table&quot; property.&lt;br/&gt;
It does have a header field though so we can trigger the same with this:&lt;/p&gt;

&lt;p&gt;def map = &lt;span class=&quot;error&quot;&gt;&amp;#91;:&amp;#93;&lt;/span&gt;&lt;br/&gt;
map&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;header&amp;quot;&amp;#93;&lt;/span&gt; = &quot;Some text&quot;&lt;/p&gt;

&lt;p&gt;This used to work in Groovy 1.5.6.  I haven&apos;t tried any version between that and 1.6.4.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12814827">GROOVY-3679</key>
            <summary>ClassCastException writing entry to map via [] when key matches private field name</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="ssowerby">Steve Sowerby</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Aug 2009 11:29:35 +0000</created>
                <updated>Thu, 15 Oct 2009 17:15:31 +0000</updated>
                            <resolved>Wed, 26 Aug 2009 20:04:33 +0000</resolved>
                                    <version>1.6.4</version>
                                    <fixVersion>1.6.5</fixVersion>
                    <fixVersion>1.7-beta-2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14467434" author="roshandawrani" created="Mon, 17 Aug 2009 14:40:55 +0000"  >&lt;p&gt;I think this is no bug but by design that it is happening. Design is to give preference to class fields and properties over map entries - in that order.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyMap &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; HashMap {
	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; p1
	def setP2(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; x) {}
}
def map = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyMap()

setVal(map, &lt;span class=&quot;code-quote&quot;&gt;&apos;p1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;str1&apos;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// fails because p1 is a field on the class
&lt;/span&gt;setVal(map, &lt;span class=&quot;code-quote&quot;&gt;&apos;p2&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;str2&apos;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// fails because p2 is a property on the class
&lt;/span&gt;setVal(map, &lt;span class=&quot;code-quote&quot;&gt;&apos;p3&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;str3&apos;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// goes through because p3 is no field or property on the &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;and hence it becomes a map entry
&lt;/span&gt;
println map

def setVal(map, key, val) {
	&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
	    map[key] = val
	}&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ex) {
		println ex
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14467526" author="ssowerby" created="Mon, 17 Aug 2009 16:22:12 +0000"  >&lt;p&gt;I agree that the above use case makes sense but surely the private fields of some of the standard map classes should not win over string keys in the map?&lt;/p&gt;

&lt;p&gt;Should a developer have to know that  &lt;span class=&quot;error&quot;&gt;&amp;#91;:&amp;#93;&lt;/span&gt; creates a LinkedHashMap and then it&apos;s not safe to use a key called header?&lt;br/&gt;
That just seems wrong to me.  I&apos;d certainly say it breaks the rule of least surprise.&lt;/p&gt;

&lt;p&gt;Not sure what the correct solution is though.&lt;br/&gt;
As I said in the oriignal report it did used to work in Groovy 1.5.6 so I&apos;m not sure exactly how the &quot;rules&quot; have changed here.&lt;/p&gt;

&lt;p&gt;I&apos;d prefer it that private map fields would not be settable by default although perhaps that behaviour could be switched, maybe by switching in a custom metaclass for the map impl class.  Perhaps that&apos;s just me though?&lt;/p&gt;</comment>
                            <comment id="14467443" author="roshandawrani" created="Mon, 17 Aug 2009 21:57:57 +0000"  >&lt;p&gt;I am not sure that if it started happening the other way around (map entries started winning over class fields and properties), then when would the fields/properties ever get a chance to be set.&lt;/p&gt;

&lt;p&gt;In the code below, if you really wanted to set the field or the property but if map.p1 = &apos;a&apos;/map&lt;span class=&quot;error&quot;&gt;&amp;#91;p1&amp;#93;&lt;/span&gt; = &apos;a&apos;/map.put(&apos;p1&apos;,&apos;a&apos;) started putting entries into the map, then how do you ever set them?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyMap &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; HashMap {
	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; p1
	def setP2(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; x) {}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the meanwhile, I will try to see if I can get when the behavior from 1.5.6 changed and why.&lt;/p&gt;</comment>
                            <comment id="14467513" author="ssowerby" created="Tue, 18 Aug 2009 02:51:51 +0000"  >&lt;p&gt;I&apos;m only proposing that map entries win over &lt;b&gt;private&lt;/b&gt; fields.  All existing behaviour should stay as is .&lt;br/&gt;
So public fields and properties should win over map entries but private fields should not be settable without first doing something explicit to allow it.&lt;/p&gt;

&lt;p&gt;Surely with the code &lt;/p&gt;

&lt;p&gt;def map = &lt;span class=&quot;error&quot;&gt;&amp;#91;:&amp;#93;&lt;/span&gt;&lt;br/&gt;
map&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;header&amp;#39;&amp;#93;&lt;/span&gt;= &quot;text&quot; &lt;/p&gt;

&lt;p&gt;most people would not expect it to try and set a private field on map and then fail.&lt;/p&gt;


&lt;p&gt;The actual use I had was where the keys were unknown to me and I was actually copying one map to another but converting the key values such as:&lt;/p&gt;

&lt;p&gt;map1.each&lt;/p&gt;
{ key,value -&amp;gt; map2[converttKey(key)] = value }

&lt;p&gt;Obviously the fix here is just to use the put method instead of [] notation.&lt;br/&gt;
However it  very much surpirsed me when I upgraded from Groovy 1.5.6 and lots of my project&apos;s tests failed because they all called initialisation code similar to the above.&lt;/p&gt;



</comment>
                            <comment id="14467527" author="roshandawrani" created="Tue, 18 Aug 2009 03:01:57 +0000"  >&lt;p&gt;I don&apos;t think at the moment groovy differentiates in its behavior based on whether the field is private or public. The private-ness is not respected as of now, as far as I know. The change you are asking for will make sense when groovy starts respecting &quot;private&quot; visibility more than it does now. I think there is already a larger enhancement for the &quot;private&quot; visibility requirements. May be, this JIRA should become part of that.&lt;/p&gt;

&lt;p&gt;For now, the code below just goes through:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Test {
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; p1
}

def t1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Test()
t1.p1 = 10 &lt;span class=&quot;code-comment&quot;&gt;// set a &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; field
&lt;/span&gt;println t1.dump()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14467539" author="john.b.hurst" created="Mon, 24 Aug 2009 21:28:52 +0000"  >&lt;p&gt;For what it&apos;s worth, I also noticed this change (it broke my code) when switching from Groovy 1.6.0 to 1.6.4.&lt;/p&gt;

&lt;p&gt;I had a Map initialized like this: &lt;/p&gt;

&lt;p&gt;  cachedCellStyles = &lt;span class=&quot;error&quot;&gt;&amp;#91;:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Then I try to add an entry:&lt;/p&gt;

&lt;p&gt;  cachedCellStyles&lt;span class=&quot;error&quot;&gt;&amp;#91;name&amp;#93;&lt;/span&gt; = cellStyle&lt;/p&gt;

&lt;p&gt;This fails when name == &quot;header&quot;. &lt;/p&gt;

&lt;p&gt;It was very good to find this ticket with the explanation! Otherwise I might not have figured it out. It&apos;s an easy fix in my case, because the key &quot;header&quot; is my own choice. But I am inclined to agree that private fields ought not to win over map key names ... but I can see the issue from both sides ... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;John Hurst&lt;br/&gt;
Wellington, New Zealand&lt;/p&gt;</comment>
                            <comment id="14467531" author="blackdrag" created="Tue, 25 Aug 2009 09:23:25 +0000"  >&lt;p&gt;hmm.... can&apos;t we exclude private access in case of []?&lt;/p&gt;</comment>
                            <comment id="14467533" author="roshandawrani" created="Tue, 25 Aug 2009 11:50:37 +0000"  >&lt;p&gt;The 2 examples reported in this JIRA are related to private as well as package-private fields (package-private field &quot;table&quot; for HashMap and private field &quot;header&quot; &lt;br/&gt;
for LinkedHashMap.&lt;/p&gt;

&lt;p&gt;If we are comfortable handling private/package-private fields for Maps as a special case in MetaClassImpl#setProperty(), then the following patch is helping with both the reported cases. Ok to proceed with such an approach?&lt;/p&gt;

&lt;p&gt;Index: src/main/groovy/lang/MetaClassImpl.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; src/main/groovy/lang/MetaClassImpl.java	(revision 17432)&lt;br/&gt;
+++ src/main/groovy/lang/MetaClassImpl.java	(working copy)&lt;br/&gt;
@@ -2337,8 +2337,11 @@&lt;br/&gt;
             if (Modifier.isFinal(field.getModifiers())) &lt;/p&gt;
{
                 throw new ReadOnlyPropertyException(name, theClass);
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;field.setProperty(object, newValue);&lt;/li&gt;
	&lt;li&gt;return;&lt;br/&gt;
+            //&lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3679&quot; title=&quot;ClassCastException writing entry to map via [] when key matches private field name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3679&quot;&gt;&lt;del&gt;GROOVY-3679&lt;/del&gt;&lt;/a&gt;: private fields of maps should not win over map entries.&lt;br/&gt;
+            if(!(this.isMap &amp;amp;&amp;amp; isPrivateOrPkgPrivate(field.getModifiers()))) 
{
+                field.setProperty(object, newValue);
+                return;
+            }
&lt;p&gt;         }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         //----------------------------------------------------------------------&lt;br/&gt;
@@ -2396,6 +2399,11 @@&lt;/p&gt;

&lt;p&gt;         invokeMissingProperty(object, name, newValue, false);&lt;br/&gt;
     }&lt;br/&gt;
+    &lt;br/&gt;
+    private boolean isPrivateOrPkgPrivate(int mod) &lt;/p&gt;
{
+    	boolean pkgPrivate = !(Modifier.isPublic(mod) || Modifier.isProtected(mod) || Modifier.isPrivate(mod));
+    	return Modifier.isPrivate(mod) || pkgPrivate;
+    }

&lt;p&gt;     private MetaProperty getMetaProperty(Class _clazz, String name, boolean useSuper, boolean useStatic) {&lt;br/&gt;
         if (_clazz == theClass)&lt;/p&gt;</comment>
                            <comment id="14467560" author="blackdrag" created="Tue, 25 Aug 2009 12:00:43 +0000"  >&lt;p&gt;Testing !public &amp;amp;&amp;amp; !protected is enough, no need to ask for private two times. Anyway... the test for map looks a bit bad. I worry that this will kick us later in another case... for example when you use .@ to set the variable. From within the class it should be no problem, since the compiler will create direct field access, unless it is done via this.&quot;$x&quot;. &lt;/p&gt;</comment>
                            <comment id="14467482" author="roshandawrani" created="Tue, 25 Aug 2009 12:07:48 +0000"  >&lt;p&gt;I will change the modifiers to remove duplication - that was just a quick and dirty try to see if any of the existing tests were breaking.&lt;/p&gt;

&lt;p&gt;What to do about Map check? Any specific things you want me to try or we respond when we get kicked? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;I ran the tests and nothing broke. Don&apos;t we already have tests that do .@ and this.&quot;$x&quot; kind of assignments? If they exist and nothing broke, then it may not be so bad.&lt;/p&gt;</comment>
                            <comment id="14467520" author="blackdrag" created="Tue, 25 Aug 2009 12:53:32 +0000"  >&lt;p&gt;Mabye something like this: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;X &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; HashMap {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; foo
  def setSomething(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; x,y) {&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.@&lt;span class=&quot;code-quote&quot;&gt;&quot;$x&quot;&lt;/span&gt; = y}
  def getAFoo() {&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; foo}
}
def x = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; X()
x.setSomething(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;,2)
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; x.getAFoo() == 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14467575" author="roshandawrani" created="Tue, 25 Aug 2009 19:44:59 +0000"  >&lt;p&gt;The test you have given is working fine. Nothing broke there too.&lt;/p&gt;

&lt;p&gt;this.@&quot;$x&quot; = y is going through MetaClassImpl#setAttribute() and is not getting affected by change I tried MetaClassImpl#setProperty().&lt;/p&gt;</comment>
                            <comment id="14467473" author="blackdrag" created="Wed, 26 Aug 2009 08:50:23 +0000"  >&lt;p&gt;lookslike the change is then mostly safe&lt;/p&gt;</comment>
                            <comment id="14467534" author="roshandawrani" created="Wed, 26 Aug 2009 20:04:33 +0000"  >&lt;p&gt;Fixed as discussed here.&lt;/p&gt;

&lt;p&gt;Now the map entries win over private / package-private fields of Map classes.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722346" name="Test.groovy" size="418" author="ssowerby" created="Mon, 17 Aug 2009 11:29:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c66v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12312220" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Testcase included</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="11060"><![CDATA[Yes]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>