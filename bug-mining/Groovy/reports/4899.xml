<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:25:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7407] Compilation not thread safe if Grape / Ivy is used in Groovy scripts</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7407</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;If Groovy scripts that import the same libraries via Grape are compiled in separate threads, compilation may fail due to race conditions.&lt;/p&gt;

&lt;p&gt;This does not happen if several threads use the &lt;b&gt;same&lt;/b&gt; instance of GroovyClassLoader (GCL), because parseClass() uses synchronization.&lt;/p&gt;

&lt;p&gt;But as soon as different GCLs are used in separate threads or if the compiler is used directly (CompilationUnit.compile()), the issue occurs and compilation can fail.&lt;/p&gt;

&lt;p&gt;Two Java unit tests have be attached, which reproduce the issue, although this cannot be guaranteed with 100% certainty, because there is a race condition.&lt;/p&gt;

&lt;p&gt;Two different stacktraces have been observed for each unit test (with origins in Grape and in Ivy), which have also been attached (plus in a different environment (Tomcat webapp CentOS) once a an exception down in Ivy had been observed that seemed to be related to unzipping a JAR file, but no precise record of that exists any more).&lt;/p&gt;</description>
                <environment>Essentially independent of the environment, as long as Groovy scripts use Grape; also this bug seems to be present since at least Groovy 1.7.5.</environment>
        <key id="12826086">GROOVY-7407</key>
            <summary>Compilation not thread safe if Grape / Ivy is used in Groovy scripts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="jexler">Jex Jexler</reporter>
                        <labels>
                            <label>Compile</label>
                            <label>Grape</label>
                            <label>Groovy</label>
                            <label>Ivy</label>
                    </labels>
                <created>Wed, 29 Apr 2015 19:59:22 +0000</created>
                <updated>Mon, 27 Jan 2025 23:32:16 +0000</updated>
                            <resolved>Sat, 18 Jan 2025 11:23:47 +0000</resolved>
                                    <version>2.4.3</version>
                                    <fixVersion>5.0.0-alpha-12</fixVersion>
                    <fixVersion>4.0.25</fixVersion>
                    <fixVersion>3.0.24</fixVersion>
                                    <component>Compiler</component>
                    <component>Grape</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="14520127" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"  >&lt;p&gt;Two Java unit tests, one on the level compiler, one on the level GroovyShell and the observed stacktraces.&lt;/p&gt;</comment>
                            <comment id="14520143" author="jexler" created="Wed, 29 Apr 2015 20:23:51 +0000"  >&lt;p&gt;Ivy version was 2.4.0 in my tests.&lt;/p&gt;</comment>
                            <comment id="14522986" author="jexler" created="Fri, 1 May 2015 09:32:30 +0000"  >&lt;p&gt;Problems can even arise if compilation is synchronized between e.g. GroovyClassLoader instances if scripts with Grape imports are &lt;b&gt;run&lt;/b&gt; while compilations are in progress: A script might grab Apache httplclient and import a few classes from there. When the script is run, it creates instances of these classes, which depend on classes in Apache httpcore, which is then loaded with the help of Grape/Ivy, but not synchronized (with the same lock as compilation), so things may fail again (failures experimentally observed).&lt;/p&gt;

&lt;p&gt;I tried a last-resort workaround by retrying compilation after a failure a couple of times, but at least once even that did not help and might even have gotten Ivy into a broken state, see stacktrace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NoClassDefFoundError: Could not initialize &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.ivy.Ivy
	at org.apache.ivy.util.url.AbstractURLHandler.getUserAgent(AbstractURLHandler.java:69)
	at org.apache.ivy.util.url.BasicURLHandler.openStream(BasicURLHandler.java:162)
	at org.apache.ivy.core.settings.XmlSettingsParser.doParse(XmlSettingsParser.java:157)
	at org.apache.ivy.core.settings.XmlSettingsParser.parse(XmlSettingsParser.java:150)
	at org.apache.ivy.core.settings.IvySettings.load(IvySettings.java:417)
	at org.apache.ivy.core.settings.IvySettings$load.call(Unknown Source)
	at groovy.grape.GrapeIvy.&amp;lt;init&amp;gt;(GrapeIvy.groovy:96)
	at sun.reflect.GeneratedConstructorAccessor19.newInstance(Unknown Source)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:526)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.newInstance(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:374)
	at groovy.grape.Grape.getInstance(Grape.java:117)
	at groovy.grape.Grape.grab(Grape.java:155)
	at groovy.grape.GrabAnnotationTransformation.visit(GrabAnnotationTransformation.java:358)
	at org.codehaus.groovy.transform.ASTTransformationVisitor$3.call(ASTTransformationVisitor.java:319)
	at org.codehaus.groovy.control.CompilationUnit.applyToSourceUnits(CompilationUnit.java:928)
	at org.codehaus.groovy.control.CompilationUnit.doPhaseOperation(CompilationUnit.java:590)
	at org.codehaus.groovy.control.CompilationUnit.processPhaseOperations(CompilationUnit.java:566)
	at org.codehaus.groovy.control.CompilationUnit.compile(CompilationUnit.java:543)
	at groovy.lang.GroovyClassLoader.doParseClass(GroovyClassLoader.java:297)
	at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:267)
	at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:253)
	at groovy.lang.GroovyClassLoader.parseClass(GroovyClassLoader.java:194)
	[...]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14525142" author="jexler" created="Sat, 2 May 2015 09:20:13 +0000"  >&lt;p&gt;Side remark, resp. idea for a possible alternative to Ivy - in case some issues should be &quot;too hairy&quot; to tackle:&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Enable Grape to use &lt;b&gt;Gradle&lt;/b&gt;&apos;s dependency resolution?&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Originally, Gradle&apos;s dependency resolution was based on Ivy, until Gradle 1.0:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;http://gradle.org/docs/1.0/release-notes&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://gradle.org/docs/1.0/release-notes&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In Gradle 1.0 we&apos;ve moved away from using Ivy for dependency resolution. The dependency resolution engine has been rebuilt from the ground up; it is now faster, more accurate and more flexible. &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Fast, accurate and reliable dependency cache&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In Gradle 1.0 we&apos;ve replaced the ivy artifact cache with our own implementation, targetting performance, consistency and reliability. Our new cache has advanced features that help avoid subtle (and not so subtle) problems permitted by other cache implementations, where a build that runs correctly on one machine fails on another.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;More specifically, the idea could be a &lt;tt&gt;class groovy.grape.GrapeGradle extends groovy.grape.GrapeEngine&lt;/tt&gt;, plus a way to select the engine (system property?).&lt;/p&gt;</comment>
                            <comment id="14525170" author="pascalschumacher" created="Sat, 2 May 2015 10:38:27 +0000"  >&lt;p&gt;The Gradle team mentioned extracting the dependency management parts into separate library, but this was not done.&lt;/p&gt;

&lt;p&gt;There was some discussions about replacing Ivy with Eclipse Aether. I tried to do a prototype based on Spring Boots AetherGrapeEngine &lt;a href=&quot;https://github.com/spring-projects/spring-boot/blob/3048f44a964ab2390dff26f0818c941ba40bdc56/spring-boot-cli/src/main/java/org/springframework/boot/cli/compiler/grape/AetherGrapeEngine.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/spring-projects/spring-boot/blob/3048f44a964ab2390dff26f0818c941ba40bdc56/spring-boot-cli/src/main/java/org/springframework/boot/cli/compiler/grape/AetherGrapeEngine.java&lt;/a&gt; but I did not get very far.&lt;/p&gt;</comment>
                            <comment id="14525448" author="jexler" created="Sat, 2 May 2015 20:09:32 +0000"  >&lt;p&gt;I wrote a workaround that may be useful in some situations, the Java source is attached in &lt;tt&gt;WorkaroundGroovy7407WrappingGrapeEngine.java&lt;/tt&gt;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
 * A GrapeEngine that wraps the current GrapeEngine with a wrapper where all calls
 * of the GrapeEngine API are &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; with a configurable lock, and allows to
 * set &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; engine in the Grape class.
 *
 * Works at least in basic situations with Groovy 2.4.3 where the wrapped GrapeEngine
 * is always a GrapeIvy instance (not all &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; methods have been tested).
 *
 * But note that &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; a &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; GrapeEngine call is in progress (which may take
 * a &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; time to complete, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; e.g. downloading a JAR file from a maven repo),
 * all other threads that want to pull Grape dependencies must wait...
 *
 * Several things are not so nice about &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; approach:
 * - This is using a &lt;span class=&quot;code-quote&quot;&gt;&quot;trick&quot;&lt;/span&gt; to set the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; GrapeEngine instance in Grape;
 *   although nominally &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; variables are part of the &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; API (and in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;
 *   is shown in the online JavaDoc of the Grape class).
 * - The &lt;span class=&quot;code-quote&quot;&gt;&quot;magic&quot;&lt;/span&gt; with &lt;span class=&quot;code-quote&quot;&gt;&quot;calleeDepth&quot;&lt;/span&gt; is based on exact knowledge of what GrapeIvy
 *   does (which, by the way, appears even inconsistent internally(?)), so &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
 *   workaround is not guaranteed to be robust &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; GroovyIvy implementation changes.
 * - I refrained from referring to the GrapeIvy &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;in the source, because it is
 *   not publicly documented in the online JavaDoc of groovy-core.
 */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To use the workaround, call &lt;tt&gt;WorkaroundGroovy7407WrappingGrapeEngine.createAndSet();&lt;/tt&gt; somewhere early. The two previously attached unit tests pass if this is done.&lt;/p&gt;</comment>
                            <comment id="15895555" author="jexler" created="Sat, 4 Mar 2017 07:20:19 +0000"  >&lt;p&gt;Grengine 1.2.0 (&quot;@Grab(&apos;ch.grengine:grengine:1.2.0&apos;)&quot;, &lt;a href=&quot;https://www.grengine.ch/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.grengine.ch/&lt;/a&gt;) now includes a convenient way to apply the workaround, simply call Grengine.Grape.activate() or Grengine.Grape.activate(lockOfYourChoice) to wrap the GrapeEngine in the Grape.class with one that locks and call Grengine.Grape.deactivate() to unwrap.&lt;/p&gt;

&lt;p&gt;More details in the Grengine user manual in the section &quot;Grengine and Grape&quot;, &lt;a href=&quot;https://www.grengine.ch/manual.html#grengine-and-grape&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.grengine.ch/manual.html#grengine-and-grape&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15896623" author="paulk" created="Mon, 6 Mar 2017 00:24:45 +0000"  >&lt;p&gt;Do you think the feature discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8097&quot; title=&quot;Add an argument to set the resolution cache path in @Grab&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8097&quot;&gt;GROOVY-8097&lt;/a&gt; would help?&lt;/p&gt;</comment>
                            <comment id="15898201" author="jexler" created="Mon, 6 Mar 2017 21:44:38 +0000"  >&lt;p&gt;Not in an initial test with a modified GroovyCompileConcurrencyTest.java and I would rather expect that not, see comment at &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8097&quot; title=&quot;Add an argument to set the resolution cache path in @Grab&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8097&quot;&gt;GROOVY-8097&lt;/a&gt;, but I am not 100% sure, yet.&lt;/p&gt;</comment>
                            <comment id="15898664" author="paulk" created="Tue, 7 Mar 2017 03:15:01 +0000"  >&lt;p&gt;Sure, no problem. I haven&apos;t had much time to devote to investigating this yet either.&lt;/p&gt;</comment>
                            <comment id="15923810" author="jexler" created="Tue, 14 Mar 2017 08:54:07 +0000"  >&lt;p&gt;The ConcurrentModificationException of stacktrace-GrapeAndGroovyShellConcurrencyTest-1.txt is because Ivy&apos;s MessageLoggerHelper is not thread-safe, it iterates over lists that can be modified during iteration by other threads, in the test cases iteration was over lists in MessageLoggerEngine. After wrapping the 3 member lists of MessageLoggerEngine with Collections.synchronizedList(...) and making copies before iterating over the lists in MessageLoggerHelper I get the following behavior: Both test cases log many messages &quot;unknown resolver null&quot; (which can a priori come from different places in Ivy) and the GroovyCompileConcurrencyTest so far always fails with the stacktrace-GroovyCompileConcurrencyTest-1.txt, i.e. it cannot resolve Guava&apos;s Ascii class, presumably because something else is not thread-safe. (After my changes I cannot reproduce exceptions in the other test, GrapeAndGroovyShellConcurrencyTest.java, anymore so far, so it appears as if the logged errors are not fatal.&lt;/p&gt;</comment>
                            <comment id="15923918" author="jexler" created="Tue, 14 Mar 2017 10:09:54 +0000"  >&lt;p&gt;The message &quot;unknown resolver null&quot; is logged from IvySettings.getResolver(), but this appears not to be the reason for the MultipleCompilationErrorsException of GroovyCompileConcurrencyTest, because (a) I got the exception once without any &quot;unknown resolver null&quot; messages (debug breakpoint) and (b) because once I stepped beyond the place where the message is created and in the calling method, a resolver was successfully obtained in another way. This may also explain why GrapeAndGroovyShellConcurrencyTest apparently never fails any more after fixing the logging issue in Ivy.&lt;/p&gt;</comment>
                            <comment id="15923957" author="jexler" created="Tue, 14 Mar 2017 10:40:26 +0000"  >&lt;p&gt;Actual stacktrace that causes the compilation error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.codehaus.groovy.syntax.SyntaxException: unable to resolve class com.google.common.base.Ascii
 @ line 1, column 1.
	at org.codehaus.groovy.ast.ClassCodeVisitorSupport.addError(ClassCodeVisitorSupport.java:150)
	at org.codehaus.groovy.control.ResolveVisitor.visitClass(ResolveVisitor.java:1241)
	at org.codehaus.groovy.control.ResolveVisitor.startResolving(ResolveVisitor.java:176)
	at org.codehaus.groovy.control.CompilationUnit$12.call(CompilationUnit.java:663)
	at org.codehaus.groovy.control.CompilationUnit.applyToSourceUnits(CompilationUnit.java:943)
	at org.codehaus.groovy.control.CompilationUnit.doPhaseOperation(CompilationUnit.java:605)
	at org.codehaus.groovy.control.CompilationUnit.compile(CompilationUnit.java:554)
	at GroovyCompileConcurrencyTest$1.run(GroovyCompileConcurrencyTest.java:42)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15924058" author="jexler" created="Tue, 14 Mar 2017 11:57:20 +0000"  >&lt;p&gt;I tried to see if locking &quot;per artifact&quot; (group:module:version) could be a solution, using the following code in GrapeIvy to lock on grab() and resolve():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; lockMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;()
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; getLock(Map... dependencies) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; group
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; module
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; version
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map dep : dependencies) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dep.group != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                group = dep.group
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dep.module != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                module = dep.module
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dep.version != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                version = dep.version
            }
        }
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = &lt;span class=&quot;code-quote&quot;&gt;&quot;$group:$module:$version&quot;&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lockMap) {
            &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj = lockMap.get(key)
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (obj == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                obj = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;()
                lockMap.put(key, obj)
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; obj
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; grab(Map args, Map... dependencies) {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (getLock(dependencies)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but this did not help with a modified version of GroovyCompileConcurrencyTest in which one in 10 compilation units used guava versions 10,11,12, ...19.&lt;br/&gt;
So whatever the issue is, locking on the GrapeEngine interface level per artifact would apparently not to be a viable approach.&lt;/p&gt;</comment>
                            <comment id="15925660" author="jexler" created="Wed, 15 Mar 2017 07:19:12 +0000"  >&lt;p&gt;I have looked at what GroovyCompileConcurrencyTest calls from GrapeEngine/GrapeIvy. It is always only grab(args, dependencies), with arguments always like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;grab, args [disableChecksums:false, classLoader:groovy.lang.GroovyClassLoader@a7474bc, autoDownload:true], dependencies [module:guava, version:18.0, group:com.google.guava]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, I wrote a test that only does such grabs in parallel (and does not use the compiler) and then tries to load the Guava class com.google.common.base.Ascii from the GroovyClassLoader, see the newly attached GrabConcurrencyTest.java. Initialization of args and dependencies in the new test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; args = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;();
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; dependencies = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;();

args.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;disableChecksums&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;//args.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;classLoader&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader());
&lt;/span&gt;args.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;autoDownload&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);

dependencies.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;group&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;com.google.guava&quot;&lt;/span&gt;);
dependencies.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;module&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;guava&quot;&lt;/span&gt;);
dependencies.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; + (j % 10) + &lt;span class=&quot;code-quote&quot;&gt;&quot;.0&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And what each thread does in the new test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;GroovyClassLoader loader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroovyClassLoader();
args.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;classLoader&quot;&lt;/span&gt;, loader);
&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj = Grape.getInstance().grab(args, dependencies);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (obj != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;grab returned: &quot;&lt;/span&gt; + obj;
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(msg);
}
loader.loadClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.google.common.base.Ascii&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This fails reproducibly in the following way: No grabs ever fail and they always return null, but loading the class eventually fails with a stacktrace that I would interpret so far as that the grab simply and silently did not add a File URL for Guava to the GroovyClassLoader:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ClassNotFoundException: com.google.common.base.Ascii
	at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
	at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
	at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:677)
	at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:787)
	at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:775)
	at GrabConcurrencyTest$1.run(GrabConcurrencyTest.java:56)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Edited to add:&lt;/b&gt; Note that you may not be able to reproduce this exactly, unless you also fix the Ivy MessageLoggerHelper concurrency issue mentioned earlier, at least this would also be a possible way for this new test to fail.&lt;/p&gt;</comment>
                            <comment id="15925678" author="jexler" created="Wed, 15 Mar 2017 07:33:28 +0000"  >&lt;p&gt;Fixed the new GrabConcurrencyTest such that it creates args and dependencies for each run of each thread; the result remains the same.&lt;/p&gt;</comment>
                            <comment id="15927533" author="jexler" created="Thu, 16 Mar 2017 05:47:32 +0000"  >&lt;p&gt;Narrowing in: GrapeIvy&apos;s grab(...) calls &lt;tt&gt;URI [] resolve(ClassLoader loader, Map args, List depsInfo, Map... dependencies)&lt;/tt&gt; and this returns an empty array of URI when the test fails, instead of an array containing a file URI pointing to one of the Guava JARs. Parameters given to resolve(...) are OK, the GroovyClassLoader is correctly obtained.&lt;/p&gt;</comment>
                            <comment id="15927585" author="jexler" created="Thu, 16 Mar 2017 06:52:16 +0000"  >&lt;p&gt;&lt;b&gt;Side remark:&lt;/b&gt; GrapeIvy seems not to be designed for use by separate threads; grab(..) and resolve(..) and other public methods modify instance variables like (unsynchronized) lists etc. This has not caused any problems in my tests (so far still looks like the origin would rather be in Ivy than in Groovy/Grape), but currently I would generally recommend to synchronize calls to GrapeIvy if you want to be safe (see the attached Workaround*.java or use Grengine.Grape.activate(..), which are both also viable workarounds for this issue, with the drawback that other threads have to wait when an artifact is downloaded).&lt;/p&gt;</comment>
                            <comment id="15927609" author="jexler" created="Thu, 16 Mar 2017 07:21:59 +0000"  >&lt;p&gt;I will most likely still try to find the issue in Ivy, but since Ivy is not really actively developed any more and since making GrapeIvy sort of reliably thread-safe seems rather a complex matter (both in Groovy/Grape and Ivy), how about at least also adding a system property to Groovy that would allow to optionally synchronize calls to GrapeIvy?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;groovy.grape.synchronize&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Possible values:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;false&lt;/tt&gt; (default): No synchronization, same as now&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;true&lt;/tt&gt;: Lock on groovy.grape.GrapeIvy.class&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;&amp;lt;class name&amp;gt;&lt;/tt&gt;: Load the indicated class by name and use it as the lock&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16255646" author="jglick@netbeans.org" created="Thu, 16 Nov 2017 17:28:54 +0000"  >&lt;p&gt;FTR attaching the tail of a Jenkins Pipeline build log which includes a similar-looking exception. Pipeline embeds Groovy (currently 2.4.11) and Ivy (currently 2.4.0) and allows Grape to be used from trusted libraries, so there would quite likely be multiple compilations running concurrently in the JVM. This is the first time I have seen such an error so I guess it is uncommon; cannot find any record of a Jenkins bug being filed with this either.&lt;/p&gt;</comment>
                            <comment id="16493641" author="krismulica" created="Tue, 29 May 2018 14:54:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jglick%40netbeans.org&quot; class=&quot;user-hover&quot; rel=&quot;jglick@netbeans.org&quot;&gt;jglick@netbeans.org&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.jenkins-ci.org/browse/JENKINS-48974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.jenkins-ci.org/browse/JENKINS-48974&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have also seen this in our jenkins pipelines&lt;/p&gt;</comment>
                            <comment id="16494600" author="blackdrag" created="Wed, 30 May 2018 02:34:14 +0000"  >&lt;p&gt;since nobody is picking this up for such a long time... if somebody would implement  the suggestion by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jexler&quot; class=&quot;user-hover&quot; rel=&quot;jexler&quot;&gt;jexler&lt;/a&gt; I would support that.&lt;/p&gt;</comment>
                            <comment id="17693680" author="jexler" created="Sun, 26 Feb 2023 17:27:21 +0000"  >&lt;p&gt;FYI, I noticed a few days ago that the workaround as it stands here does not work any more with Groovy 3 and 4, see the class &lt;a href=&quot;https://gitlab.com/jexler/grengine/-/blob/bf357c24278a15e28854b6db2c3ac9c8acd34b8c/src/main/java/ch/artecat/grengine/code/groovy/DefaultGroovyCompiler.java#L487&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;DefaultGroovyCompiler.GrengineGrapeEngine&lt;/tt&gt; in Grengine&lt;/a&gt;&#160;where I implement it the new way, or you can use &lt;tt&gt;Grengine.Grape.activate(...)&lt;/tt&gt; with Grengine 3.0.2 or later to apply it (independently of otherwise using Grengine for anything).&lt;/p&gt;

&lt;p&gt;To me the proposed System Property &lt;tt&gt;groovy.grape.synchronize&lt;/tt&gt; would still make sense, maybe I would just implement it at some point in a fork (at least for Groovy 4, I guess) and propose to eventually merge it (and maybe forget about the option with indicating a class name for the lock, as the class would be loaded via the GraveIvy class anyways, so maybe just a flag to synchronize calls if the System Property exists at all would be good enough?)...&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17913089" author="basil" created="Tue, 14 Jan 2025 22:38:11 +0000"  >&lt;p&gt;The tested workaround delivered to Jenkins users in &lt;a href=&quot;https://github.com/jenkinsci/pipeline-groovy-lib-plugin/pull/148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jenkinsci/pipeline-groovy-lib-plugin/pull/148&lt;/a&gt; can be fixed properly upstream by adding &lt;tt&gt;&amp;lt;caches lockStrategy=&quot;artifact-lock-nio&quot; /&amp;gt;&lt;/tt&gt; below &lt;a href=&quot;https://github.com/apache/groovy/blob/de5ff81e020b25289c2eba8f245d46118e3c799f/src/resources/groovy/grape/defaultGrapeConfig.xml#L22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/de5ff81e020b25289c2eba8f245d46118e3c799f/src/resources/groovy/grape/defaultGrapeConfig.xml#L22&lt;/a&gt; in Groovy&apos;s &lt;tt&gt;defaultGrapeConfig.xml&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17913096" author="githubbot" created="Tue, 14 Jan 2025 23:02:03 +0000"  >&lt;p&gt;basil opened a new pull request, #2142:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/2142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/2142&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   See &lt;span class=&quot;error&quot;&gt;&amp;#91;GROOVY-7407 (comment)&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7407?focusedCommentId=17913089&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17913089&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-7407?focusedCommentId=17913089&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17913089&lt;/a&gt;). Implements the same high-level solution used in the workaround tested and delivered to Jenkins users in &lt;a href=&quot;https://github.com/jenkinsci/pipeline-groovy-lib-plugin/pull/148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jenkinsci/pipeline-groovy-lib-plugin/pull/148&lt;/a&gt;. Not tested directly, but the high-level solution was tested indirectly via &lt;span class=&quot;error&quot;&gt;&amp;#91;JENKINS-72050 (comment)&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.jenkins.io/browse/JENKINS-72050?focusedId=451809&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-451809&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.jenkins.io/browse/JENKINS-72050?focusedId=451809&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-451809&lt;/a&gt;) and &lt;a href=&quot;https://github.com/jenkinsci/pipeline-groovy-lib-plugin/pull/148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jenkinsci/pipeline-groovy-lib-plugin/pull/148&lt;/a&gt; by two separate people.&lt;/p&gt;

</comment>
                            <comment id="17913116" author="githubbot" created="Wed, 15 Jan 2025 00:50:43 +0000"  >&lt;p&gt;codecov-commenter commented on PR #2142:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/2142#issuecomment-2591404849&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/2142#issuecomment-2591404849&lt;/a&gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Codecov&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://app.codecov.io/gh/apache/groovy/pull/2142?dropdown=coverage&amp;amp;src=pr&amp;amp;el=h1&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.codecov.io/gh/apache/groovy/pull/2142?dropdown=coverage&amp;amp;src=pr&amp;amp;el=h1&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&lt;/a&gt;) Report&lt;br/&gt;
   All modified and coverable lines are covered by tests :white_check_mark:&lt;br/&gt;
   &amp;gt; Project coverage is 68.8290%. Comparing base &lt;span class=&quot;error&quot;&gt;&amp;#91;(`de5ff81`)&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://app.codecov.io/gh/apache/groovy/commit/de5ff81e020b25289c2eba8f245d46118e3c799f?dropdown=coverage&amp;amp;el=desc&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.codecov.io/gh/apache/groovy/commit/de5ff81e020b25289c2eba8f245d46118e3c799f?dropdown=coverage&amp;amp;el=desc&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&lt;/a&gt;) to head &lt;span class=&quot;error&quot;&gt;&amp;#91;(`be537f3`)&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://app.codecov.io/gh/apache/groovy/commit/be537f3adc8505edb46dab472ef2823a9543c5b5?dropdown=coverage&amp;amp;el=desc&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.codecov.io/gh/apache/groovy/commit/be537f3adc8505edb46dab472ef2823a9543c5b5?dropdown=coverage&amp;amp;el=desc&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&lt;/a&gt;).&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   &amp;lt;details&amp;gt;&amp;lt;summary&amp;gt;Additional details and impacted files&amp;lt;/summary&amp;gt;&lt;/p&gt;


&lt;p&gt;   [!&lt;span class=&quot;error&quot;&gt;&amp;#91;Impacted file tree graph&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://app.codecov.io/gh/apache/groovy/pull/2142/graphs/tree.svg?width=650&amp;amp;height=150&amp;amp;src=pr&amp;amp;token=1r45138NfQ&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache)](https://app.codecov.io/gh/apache/groovy/pull/2142?src=pr&amp;amp;el=tree&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.codecov.io/gh/apache/groovy/pull/2142/graphs/tree.svg?width=650&amp;amp;height=150&amp;amp;src=pr&amp;amp;token=1r45138NfQ&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache)](https://app.codecov.io/gh/apache/groovy/pull/2142?src=pr&amp;amp;el=tree&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   ```diff&lt;br/&gt;
   @@                Coverage Diff                 @@&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;master      #2142        +/-   ##&lt;br/&gt;
   ==================================================&lt;br/&gt;
   + Coverage     68.8220%   68.8290%   +0.0071%     &lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Complexity      29434      29435         +1&lt;br/&gt;
   ==================================================&lt;br/&gt;
     Files            1420       1420                &lt;br/&gt;
     Lines          113147     113147                &lt;br/&gt;
     Branches        19544      19544                &lt;br/&gt;
   ==================================================&lt;br/&gt;
   + Hits            77870      77878         +8     &lt;br/&gt;
   + Misses          28738      28732         -6     &lt;br/&gt;
   + Partials         6539       6537         -2     &lt;br/&gt;
   ```&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;see 3 files with indirect coverage changes&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://app.codecov.io/gh/apache/groovy/pull/2142/indirect-changes?src=pr&amp;amp;el=tree-more&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.codecov.io/gh/apache/groovy/pull/2142/indirect-changes?src=pr&amp;amp;el=tree-more&amp;amp;utm_medium=referral&amp;amp;utm_source=github&amp;amp;utm_content=comment&amp;amp;utm_campaign=pr+comments&amp;amp;utm_term=apache&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   &amp;lt;/details&amp;gt;&lt;/p&gt;

</comment>
                            <comment id="17913884" author="githubbot" created="Thu, 16 Jan 2025 23:53:50 +0000"  >&lt;p&gt;daniellansun merged PR #2142:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/2142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/2142&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="17913885" author="githubbot" created="Thu, 16 Jan 2025 23:54:11 +0000"  >&lt;p&gt;daniellansun commented on PR #2142:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/groovy/pull/2142#issuecomment-2597144123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/2142#issuecomment-2597144123&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Merged. Thanks!&lt;/p&gt;

</comment>
                            <comment id="17913982" author="jexler" created="Fri, 17 Jan 2025 07:44:20 +0000"  >&lt;p&gt;I can probably take a look sometime the coming weeks, was a long time ago that I created that issue here.&lt;/p&gt;

&lt;p&gt;To me a machine-wide lock on files (even though per artifact) seems not ideal as default setting for Groovy, if a process/thread keeps the lock, other processes/threads cannot download the artifact, unless there would be a timeout. (Documenting instead how to make the Ivy setting more prominently might be a viable alternative, that could then be done by Jenkins, too.)&lt;/p&gt;

&lt;p&gt;In a first experiment (with slightly modified GrabConcurrencyTest.java), the setting helps somewhat, but with parallel threads downloading the same artifacts I could still consistently get states where downloads were only partial and even grabs for getting artifcats that had been successfully downloaded were apparently hanging, so far unclear if that was rather something due to Ivy and/or Groovy Grape.&lt;/p&gt;</comment>
                            <comment id="17914326" author="daniel_sun" created="Sat, 18 Jan 2025 11:23:47 +0000"  >&lt;p&gt;The proposed PR has been merged. Thanks!&lt;/p&gt;</comment>
                            <comment id="17914353" author="jexler" created="Sat, 18 Jan 2025 17:36:53 +0000"  >&lt;p&gt;I have tested a bit...&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Summary&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Appears that Ivy&apos;s&#160;&lt;tt&gt;artifact-lock-nio&lt;/tt&gt;&#160;locking is buggy:&#160;It works to some degree,&#160;but can still lead to problems in practice.&lt;/p&gt;

&lt;p&gt;(I remember that I had already tried this setting a few years ago&#160;in a container&#160;(&lt;a href=&quot;https://grengine.ch/jexler/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Jexler&lt;/a&gt;)&#160;that would start several grabbing)&#160;Groovy scripts&#160;each in their own threads when starting,&#160;and I still had issues then,&#160;i.e.&#160;I know of at least one practical&#160;example where using&#160;&lt;tt&gt;artifact-lock-nio&lt;/tt&gt;&#160;is not good enough.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Details&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/alainstalder/GROOVY-7407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/alainstalder/GROOVY-7407&lt;/a&gt; for details, especially &lt;a href=&quot;https://github.com/alainstalder/GROOVY-7407/blob/main/RESULTS-2025-01-18.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RESULTS-2025-01-18.md&lt;/a&gt; there.&lt;/p&gt;

&lt;p&gt;Also attaching that repo here as &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13074138/13074138_GROOVY-7407-main.zip&quot; title=&quot;GROOVY-7407-main.zip attached to GROOVY-7407&quot;&gt;GROOVY-7407-main.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12898020" name="GROOVY-7407-Jenkins-Pipeline.txt" size="62307" author="jglick@netbeans.org" created="Thu, 16 Nov 2017 17:19:41 +0000"/>
                            <attachment id="13074138" name="GROOVY-7407-main.zip" size="78330" author="jexler" created="Sat, 18 Jan 2025 17:36:04 +0000"/>
                            <attachment id="12858844" name="GrabConcurrencyTest.java" size="3524" author="jexler" created="Wed, 15 Mar 2017 07:33:28 +0000"/>
                            <attachment id="12729284" name="GrapeAndGroovyShellConcurrencyTest.java" size="2928" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"/>
                            <attachment id="12729283" name="GroovyCompileConcurrencyTest.java" size="1926" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"/>
                            <attachment id="12729974" name="WorkaroundGroovy7407WrappingGrapeEngine.java" size="4925" author="jexler" created="Sat, 2 May 2015 20:09:32 +0000"/>
                            <attachment id="12729287" name="stacktrace-GrapeAndGroovyShellConcurrencyTest-1.txt" size="4448" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"/>
                            <attachment id="12729288" name="stacktrace-GrapeAndGroovyShellConcurrencyTest-2.txt" size="2459" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"/>
                            <attachment id="12729285" name="stacktrace-GroovyCompileConcurrencyTest-1.txt" size="691" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"/>
                            <attachment id="12729286" name="stacktrace-GroovyCompileConcurrencyTest-2.txt" size="4771" author="jexler" created="Wed, 29 Apr 2015 20:13:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2e3rb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>