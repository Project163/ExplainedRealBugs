<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:55:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7535] Groovy category throwing MissingMethodException and MissingPropertyException when using multiple threads</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7535</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When using groovy use block, we randomly get groovy.lang.MissingPropertyException when trying to access a property off a category.  (Attached is an example)&lt;/p&gt;



&lt;blockquote&gt;
&lt;p&gt;index 76&lt;br/&gt;
Exception in thread &quot;Thread-77&quot; groovy.lang.MissingPropertyException: No such property: millisecond for class: java.lang.Integer&lt;br/&gt;
		at org.codehaus.groovy.runtime.ScriptBytecodeAdapter.unwrap(ScriptBytecodeAdapter.java:51)&lt;br/&gt;
		at org.codehaus.groovy.runtime.callsite.PojoMetaClassGetPropertySite.callGetProperty(PojoMetaClassGetPropertySite.java:43)&lt;br/&gt;
		at TimeCategoryTest$__spock_initializeFields_closure1$_closure4$_closure5.doCall(TimeCategoryTest.groovy:23)&lt;br/&gt;
		at TimeCategoryTest$__spock_initializeFields_closure1$_closure4$_closure5.doCall(TimeCategoryTest.groovy)&lt;br/&gt;
		at sun.reflect.GeneratedMethodAccessor12.invoke(Unknown Source)&lt;br/&gt;
		at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
		at java.lang.reflect.Method.invoke(Method.java:497)&lt;br/&gt;
		at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:90)&lt;br/&gt;
		at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:324)&lt;br/&gt;
		at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:292)&lt;br/&gt;
		at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1016)&lt;br/&gt;
		at groovy.lang.Closure.call(Closure.java:423)&lt;br/&gt;
		at groovy.lang.Closure.call(Closure.java:417)&lt;br/&gt;
		at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.use(GroovyCategorySupport.java:109)&lt;br/&gt;
		at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.access$400(GroovyCategorySupport.java:65)&lt;br/&gt;
		at org.codehaus.groovy.runtime.GroovyCategorySupport.use(GroovyCategorySupport.java:249)&lt;br/&gt;
		at org.codehaus.groovy.runtime.DefaultGroovyMethods.use(DefaultGroovyMethods.java:403)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;or groovy.lang.MissingMethodException when trying to access a method from a category.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;index 82&lt;br/&gt;
Exception in thread &quot;Thread-207&quot; groovy.lang.MissingMethodException: No signature of method: java.lang.String.test() is applicable for argument types: (java.lang.String) values: [ bar]&lt;br/&gt;
Possible solutions: next(), toSet(), getAt(java.lang.String), wait(). trim(), toList()&lt;br/&gt;
		at org.codehaus.groovy.runtime.ScriptBytecodeAdapter.unwrap(ScriptBytecodeAdapter.java:56)&lt;br/&gt;
		at org.codehaus.groovy.runtime.callsite.PojoMetaClassSite.call(PojoMetaClassSite.java:46)&lt;br/&gt;
		at org.codehaus.groovy.runtime.callsite.AbstractCallSite.call(AbstractCallSite.java:122)&lt;br/&gt;
		at CategoryTest$__spock_initializeFields_closure1$_closure5.doCall(CategoryTest.groovy:24)&lt;br/&gt;
		at CategoryTest$__spock_initializeFields_closure1$_closure5.doCall(CategoryTest.groovy)&lt;br/&gt;
		at sun.reflect.GeneratedMethodAccessor12.invoke(Unknown Source)&lt;br/&gt;
		at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
		at java.lang.reflect.Method.invoke(Method.java:497)&lt;br/&gt;
		at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:90)&lt;br/&gt;
		at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:324)&lt;br/&gt;
		at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:292)&lt;br/&gt;
		at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1016)&lt;br/&gt;
		at groovy.lang.Closure.call(Closure.java:423)&lt;br/&gt;
		at groovy.lang.Closure.call(Closure.java:417)&lt;br/&gt;
		at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.use(GroovyCategorySupport.java:109)&lt;br/&gt;
		at org.codehaus.groovy.runtime.GroovyCategorySupport$ThreadCategoryInfo.access$400(GroovyCategorySupport.java:65)&lt;br/&gt;
		at org.codehaus.groovy.runtime.GroovyCategorySupport.use(GroovyCategorySupport.java:249)&lt;br/&gt;
		at org.codehaus.groovy.runtime.DefaultGroovyMethods.use(DefaultGroovyMethods.java:403)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;On the server, either one of these exceptions to appear every few days or weeks.&lt;/p&gt;

&lt;p&gt;I found a similar issue &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-2105&quot; title=&quot;Groovy category support is broken in multi-threaded environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-2105&quot;&gt;&lt;del&gt;GROOVY-2105&lt;/del&gt;&lt;/a&gt; which contains a test that reproduces this problem on Linux.  Looking back the fix that was implemented for this ticket was to add synchronized to 3 methods.  These changes were late removed in a refactor of GroovyCategorySupport.&lt;/p&gt;

&lt;p&gt;I have attached 3 test cases that reproduce the threading issue.  &lt;/p&gt;

&lt;p&gt;NOTE: problem does not happen 100% of the time as it is a threading and timing issue, so you may have to play with the number of threads to generate the exception.  What I have attached generates the exception on my linux box most of the time.&lt;/p&gt;</description>
                <environment>I have been able to reproduce this issue on a Cent O/S version 6.4 with Java 64 Bit JDK 1.8 and groovy 2.4.4.&lt;br/&gt;
</environment>
        <key id="12850632">GROOVY-7535</key>
            <summary>Groovy category throwing MissingMethodException and MissingPropertyException when using multiple threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwagenleitner">John Wagenleitner</assignee>
                                    <reporter username="joswald">James Oswald</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Jul 2015 15:55:49 +0000</created>
                <updated>Tue, 6 Mar 2018 23:14:47 +0000</updated>
                            <resolved>Fri, 26 May 2017 00:07:33 +0000</resolved>
                                    <version>2.3.11</version>
                    <version>2.4.4</version>
                                    <fixVersion>2.4.12</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14977232" author="joswald" created="Tue, 27 Oct 2015 21:49:16 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-2105&quot; title=&quot;Groovy category support is broken in multi-threaded environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-2105&quot;&gt;&lt;del&gt;GROOVY-2105&lt;/del&gt;&lt;/a&gt;: &lt;br/&gt;
The methods in question are org.codehaus.groovy.runtime.GroovyCategorySupport#newScope, org.codehaus.groovy.runtime.GroovyCategorySupport#endScope and org.codehaus.groovy.runtime.GroovyCategorySupport#hasCategoryInAnyThread&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/groovy/groovy-core/blob/master/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java#L82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/groovy/groovy-core/blob/master/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java#L82&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14979046" author="pascalschumacher" created="Wed, 28 Oct 2015 19:05:44 +0000"  >&lt;p&gt;Hi James,&lt;/p&gt;

&lt;p&gt;thanks for reporting this. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Sadly I could not replicate the problem with groovy 2.4.5 (on windows) and your testcase (tried different times and different amounts of threads).&lt;/p&gt;

&lt;p&gt;I guess that&apos;s just caused by platform differences as I do not remember any changes in 2.4.5 related to this problem and &lt;a href=&quot;https://github.com/apache/incubator-groovy/blob/d3bc07e5c2af7f5fbd344a961d549772de0680c7/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GroovyCategorySupport.java&lt;/a&gt; looks like it could have concurrency issues.&lt;/p&gt;</comment>
                            <comment id="14979967" author="blackdrag" created="Thu, 29 Oct 2015 07:18:18 +0000"  >&lt;p&gt;sorry, first had answered on dev, because I thought it was a normal thread &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; What kind of cpu are you using James?&lt;/p&gt;

&lt;p&gt;As for the change, the explicit synchronization was removed by a logic using an AtomicInteger and an int to allow unsychronized checks for category usage. The idea is the following: A category is only visible in the same thread that it is used, so updates to categoriesInUse from the same thread are visible and hasCategoryInCurrentThread will return true. For the actual counting of the number of active categories overall we use the AtomicInteger atomicCategoryUsageCounter, which will also be used to update categoriesInUse. hasCategoryInAnyThread should always return true if any category is active. The actual building of the category methods list happens in a thread local and is read in a thread local. I would love to learn where this all fails.&lt;/p&gt;</comment>
                            <comment id="14980425" author="joswald" created="Thu, 29 Oct 2015 13:34:18 +0000"  >&lt;p&gt;My dev box has 4 Xeon(R) CPU E5-1607 0 @ 3.00GHz with 16Gigs of ram.  &lt;br/&gt;
(Not sure if its cores or separate CPUs.  Linux reports them to me as 4 CPUs.)&lt;/p&gt;

&lt;p&gt;The servers I&apos;ve seen this on were VMs with 8 Cores and 16 Gigs of Ram. &lt;/p&gt;

&lt;p&gt;Both systems were running Cent O/S.&lt;/p&gt;</comment>
                            <comment id="14984125" author="githubbot" created="Sat, 31 Oct 2015 19:39:57 +0000"  >&lt;p&gt;GitHub user ksuderman opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/169&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Non-atomic use of atomicCategoryUsageCounter&lt;/p&gt;

&lt;p&gt;    The atomicCategoryUsageCounter was Incremented/decremented on one line and and then read on the next line leaving a small window for race conditions to happen.  This is a possible fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7535&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-7535&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ksuderman/incubator-groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ksuderman/incubator-groovy&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/169.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/169.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #169&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 919e90a15bd2ec6de2e015eee8e2e77a8f5f1bd5&lt;br/&gt;
Author: Keith Suderman &amp;lt;suderman@cs.vassar.edu&amp;gt;&lt;br/&gt;
Date:   2015-10-31T19:11:33Z&lt;/p&gt;

&lt;p&gt;    Fixed non-atomic use of atomicCategoryUsageCounter.&lt;/p&gt;

&lt;p&gt;commit 3025ed2cd7a80cf49403fe1205f22cb815f5f78b&lt;br/&gt;
Author: Keith Suderman &amp;lt;suderman@cs.vassar.edu&amp;gt;&lt;br/&gt;
Date:   2015-10-31T19:14:16Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of &lt;a href=&quot;https://github.com/apache/incubator-groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14984188" author="githubbot" created="Sat, 31 Oct 2015 22:12:32 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/169&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14984217" author="pascalschumacher" created="Sat, 31 Oct 2015 23:22:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joswald&quot; class=&quot;user-hover&quot; rel=&quot;joswald&quot;&gt;joswald&lt;/a&gt; I merged the pull request. It would be nice if you could use a snapshoot version (e.g. &lt;a href=&quot;http://ci.groovy-lang.org/repository/download/Groovy_Jdk7Build/29066:id/target/distributions/apache-groovy-binary-2.5.0-SNAPSHOT.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ci.groovy-lang.org/repository/download/Groovy_Jdk7Build/29066:id/target/distributions/apache-groovy-binary-2.5.0-SNAPSHOT.zip&lt;/a&gt;) to test if this fixes the issue. Thanks!&lt;/p&gt;</comment>
                            <comment id="14984402" author="pascalschumacher" created="Sun, 1 Nov 2015 13:40:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joswald&quot; class=&quot;user-hover&quot; rel=&quot;joswald&quot;&gt;joswald&lt;/a&gt; I&apos;m resolving this for now. Please reopen if the fix does not solve the issue completely. Thanks!&lt;/p&gt;</comment>
                            <comment id="16006519" author="jkemnade" created="Thu, 11 May 2017 14:30:58 +0000"  >&lt;p&gt;I can actually reproduce this issue with Groovy 2.4.11 on Debian with OpenJDK Runtime Environment (build 1.8.0_131-8u131-b11-1-b11). I&apos;m using&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestCategory {
    def &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; self, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; foo) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; self + foo
    }
}

def test = {
    1000000.times {
        sleep(10)
        use(TestCategory) {
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;.test(&lt;span class=&quot;code-quote&quot;&gt;&apos; bar&apos;&lt;/span&gt;) == &lt;span class=&quot;code-quote&quot;&gt;&apos;foo bar&apos;&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;.test(&lt;span class=&quot;code-quote&quot;&gt;&apos; bar&apos;&lt;/span&gt;) == &lt;span class=&quot;code-quote&quot;&gt;&apos;foo bar&apos;&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;.test(&lt;span class=&quot;code-quote&quot;&gt;&apos; bar&apos;&lt;/span&gt;) == &lt;span class=&quot;code-quote&quot;&gt;&apos;foo bar&apos;&lt;/span&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;.test(&lt;span class=&quot;code-quote&quot;&gt;&apos; bar&apos;&lt;/span&gt;) == &lt;span class=&quot;code-quote&quot;&gt;&apos;foo bar&apos;&lt;/span&gt;
        }
        sleep(50)
        
    }
}


1000.times {
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start test
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16006530" author="jkemnade" created="Thu, 11 May 2017 14:36:13 +0000"  >&lt;p&gt;I can also reproduce it with 2.5.0-alpha-1. Can we please reopen this?&lt;/p&gt;</comment>
                            <comment id="16006630" author="paulk" created="Thu, 11 May 2017 15:22:47 +0000"  >&lt;p&gt;I haven&apos;t had time to explore this issue, but just a meta-comment. Do we believe the applied PR fixed something or nothing? If nothing, I&apos;d re-open and remove the fix version; otherwise, I&apos;d leave this one as is so that the fix version for whatever was fixed is tracked and I&apos;d clone the issue and describe what remains to be fixed (if not exactly as per the current description).&lt;/p&gt;</comment>
                            <comment id="16007737" author="jkemnade" created="Fri, 12 May 2017 07:28:26 +0000"  >&lt;p&gt;The first part of the PR should not have changed anything. &lt;tt&gt;categoriesInUse&lt;/tt&gt; is merely used as a flag, so if another thread increments the value to n+1, it will still be &lt;tt&gt;!=0&lt;/tt&gt; in &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt;.&lt;br/&gt;
I&apos;m unsure about the second part, but I think it didn&apos;t have any effect either for about the same reason as above. The error happens when &lt;tt&gt;categoriesInUse&lt;/tt&gt; is &lt;tt&gt;0&lt;/tt&gt;. This can only happen if there is only 1 thread running, so there is no race condition. I might be overlooking something here though.&lt;br/&gt;
However, I think the race condition happens somewhere else:&lt;br/&gt;
&lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed(false)&lt;/tt&gt; is called in &lt;tt&gt;endScope&lt;/tt&gt; if &lt;tt&gt;atomicCategoryUsageCounter&lt;/tt&gt; was &lt;tt&gt;0&lt;/tt&gt; further above. But another thread might have entered &lt;tt&gt;newScope&lt;/tt&gt; in between, incrementing &lt;tt&gt;atomicCategoryUsageCounter&lt;/tt&gt; again. So I think, we need some synchronization around &lt;tt&gt;atomicCategoryUsageCounter.get&lt;/tt&gt; and &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed(false)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16007761" author="jkemnade" created="Fri, 12 May 2017 07:51:57 +0000"  >&lt;p&gt;Patch attached, I&apos;m currently testing it.&lt;/p&gt;</comment>
                            <comment id="16007780" author="jkemnade" created="Fri, 12 May 2017 08:13:51 +0000"  >&lt;p&gt;Unfortunately, the patch doesn&apos;t fix it.&lt;/p&gt;</comment>
                            <comment id="16007826" author="blackdrag" created="Fri, 12 May 2017 09:01:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkemnade&quot; class=&quot;user-hover&quot; rel=&quot;jkemnade&quot;&gt;jkemnade&lt;/a&gt; your change synchronizes the categoriesInUse == 0 case, but with what? you need to also synchronize the increment place&lt;/p&gt;</comment>
                            <comment id="16007836" author="jkemnade" created="Fri, 12 May 2017 09:14:33 +0000"  >&lt;p&gt;I don&apos;t think so. I&apos;m not synchronizing the decrement but the call of the &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed(false)&lt;/tt&gt;. I thought that the bug (or MME) is caused by the state in &lt;tt&gt;DefaultMetaClassInfo&lt;/tt&gt;, but apparently that isn&apos;t the case. Even if i remove &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed(false)&lt;/tt&gt; altogether, the issue persists.&lt;/p&gt;</comment>
                            <comment id="16007920" author="blackdrag" created="Fri, 12 May 2017 10:24:42 +0000"  >&lt;p&gt;Since the removal of setting it to false did not do it, it is probably a different issue, yes.&lt;/p&gt;</comment>
                            <comment id="16008020" author="jkemnade" created="Fri, 12 May 2017 12:03:36 +0000"  >&lt;p&gt;I can reproduce the error with 1.8.0 but not with 1.7.x (so far). I tried to do a bisect earlier, but those old versions are pretty hard to build.&lt;/p&gt;</comment>
                            <comment id="16008042" author="jkemnade" created="Fri, 12 May 2017 12:27:44 +0000"  >&lt;p&gt;Alright, I can reproduce it with 1.8.0-beta-3 but not with 1.8.0-beta-2. Could it be &lt;a href=&quot;https://github.com/apache/groovy/commit/8e489ce9da4ebf21b6717b656e2ffff225244ca6?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/8e489ce9da4ebf21b6717b656e2ffff225244ca6?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16008077" author="jkemnade" created="Fri, 12 May 2017 12:53:38 +0000"  >&lt;p&gt;A quick git bisect session also leads to that commit.&lt;/p&gt;</comment>
                            <comment id="16009598" author="githubbot" created="Sun, 14 May 2017 05:15:12 +0000"  >&lt;p&gt;GitHub user jwagenleitner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/540&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7535&quot; title=&quot;Groovy category throwing MissingMethodException and MissingPropertyException when using multiple threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7535&quot;&gt;&lt;del&gt;GROOVY-7535&lt;/del&gt;&lt;/a&gt;: Groovy category throwing MissingMethodException and Miss&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;ingPropertyException when using multiple threads&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jwagenleitner/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jwagenleitner/groovy&lt;/a&gt; groovy7535&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/540.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/540.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #540&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1c2ca41491fd919ddc1c543ec92a8ab7ca3b860b&lt;br/&gt;
Author: John Wagenleitner &amp;lt;jwagenleitner@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-14T01:51:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7535&quot; title=&quot;Groovy category throwing MissingMethodException and MissingPropertyException when using multiple threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7535&quot;&gt;&lt;del&gt;GROOVY-7535&lt;/del&gt;&lt;/a&gt;: Groovy category throwing MissingMethodException and MissingPropertyException when using multiple threads&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16010041" author="jkemnade" created="Mon, 15 May 2017 06:52:49 +0000"  >&lt;p&gt;Oh, the race condition occurs between the modification of the &lt;tt&gt;AtomicInteger&lt;/tt&gt; and the assignment of the return value to the &lt;tt&gt;int&lt;/tt&gt; field.&lt;br/&gt;
I created a minimalistic patch that fixes it. But the PR LGTM too.&lt;/p&gt;</comment>
                            <comment id="16010043" author="jkemnade" created="Mon, 15 May 2017 06:55:25 +0000"  >&lt;p&gt;I think that this issue should be reopened as it seems to affect all versions since 1.8.0.&lt;/p&gt;</comment>
                            <comment id="16010661" author="jwagenleitner" created="Mon, 15 May 2017 15:07:55 +0000"  >&lt;p&gt;The updated patch looks good, though it does seem to me that if the counters are going to be synchronized that the &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed&lt;/tt&gt; calls should be included in the block as well.  Otherwise it could be called with &lt;tt&gt;false&lt;/tt&gt; just after another thread got done calling with &lt;tt&gt;true&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The updated attached patch keeps the two counters, it seems like the &lt;tt&gt;int&lt;/tt&gt; counter was kept for performance for the method &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt; since that&apos;s called frequently from the callsite logic.&lt;/p&gt;</comment>
                            <comment id="16011047" author="blackdrag" created="Mon, 15 May 2017 18:25:54 +0000"  >&lt;p&gt;I don&#180;t get the patch... isn&#180;t the sole purpose of AtomicInteger to make those operations like incrementAndGet and decrementAndGet atomic enough to share it between threads? Isn&#180;t it likely the race condition is actually something else and if this fixes the problem it does so by chance (maybe piggybacking synchronization)?&lt;/p&gt;</comment>
                            <comment id="16011335" author="jwagenleitner" created="Mon, 15 May 2017 21:11:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; - as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkemnade&quot; class=&quot;user-hover&quot; rel=&quot;jkemnade&quot;&gt;jkemnade&lt;/a&gt; pointed out, there is a race condition between threads when writing to the &lt;tt&gt;private static int categoriesInUse&lt;/tt&gt; counter as there is no guarantee that the values returned from calls to the Atomic will be written in the same order.  The scenario is:&lt;/p&gt;

&lt;p&gt;1.  T1 in &lt;tt&gt;endScope&lt;/tt&gt; calls &lt;tt&gt;atomicCategoryUsageCounter.decrementAndGet()&lt;/tt&gt; and receives &lt;tt&gt;0&lt;/tt&gt;&lt;br/&gt;
2.  T2 in &lt;tt&gt;newScope&lt;/tt&gt; calls &lt;tt&gt;atomicCategoryUsageCounter.incrementAndGet()&lt;/tt&gt; and receives &lt;tt&gt;1&lt;/tt&gt;&lt;br/&gt;
3.  T2 assigns &lt;tt&gt;categoriesInUse&lt;/tt&gt; a value of &lt;tt&gt;1&lt;/tt&gt;&lt;br/&gt;
4.  T1 assigns &lt;tt&gt;categoriesInUse&lt;/tt&gt; a value of &lt;tt&gt;0&lt;/tt&gt;&lt;br/&gt;
5.  Callsite called from T2 calls &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt; and return is &lt;tt&gt;false&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The patch and PR both fix this by introducing ordering to the &lt;tt&gt;atomicCategoryUsageCounter&lt;/tt&gt; return value and the write to &lt;tt&gt;categoriesInUse&lt;/tt&gt;.  Another way to fix without synchronizing would be to remove the int counter and just use the AtomicInteger.  However, my hunch is that the int counter was retained because &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt; is probably called frequently so there might have been some performance concern over requiring a method call and a volatile read that the AtomicInteger would incur in order to implement the quick exit check for that method &lt;tt&gt;if (categoriesInUse == 0) return false&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;There is also a race between scopes in calls to &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed&lt;/tt&gt;, so I think it would also be good to add those calls to the synchronized blocks if they are added.&lt;/p&gt;</comment>
                            <comment id="16011829" author="jkemnade" created="Tue, 16 May 2017 06:43:23 +0000"  >&lt;p&gt;Great explanation John. It took me a while to figure that out. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
By the way, since the PR synchronizes the modification of &lt;tt&gt;categoriesInUse&lt;/tt&gt;, the &lt;tt&gt;AtomicInteger&lt;/tt&gt; could be removed altogether.&lt;/p&gt;</comment>
                            <comment id="16011951" author="blackdrag" created="Tue, 16 May 2017 08:09:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jwagenleitner&quot; class=&quot;user-hover&quot; rel=&quot;jwagenleitner&quot;&gt;jwagenleitner&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkemnade&quot; class=&quot;user-hover&quot; rel=&quot;jkemnade&quot;&gt;jkemnade&lt;/a&gt; maybe I am now looking stupid, but I still do not get it. If categoriesInUse is the problem, then why do you not have to synchronize all reads and writes to it? I am especially thinking here about hasCategoryInCurrentThread. Even if endScope and newScope are synchronized, since hasCategoryInCurrentThread is not, it can lead to T1 and T2 still having different values for it. &lt;/p&gt;

&lt;p&gt;The reason categoriesInUse even exists is for performance. reaplace it by directly using the AtomicInteger and see what happens. Or by synchronizing the read in hasCategoryInCurrentThread. And do not forget, that is a cost we basically pay on each method invocation during callsite caching. Indy is using the dEfaultMetaClassInfo logic, but I assume it has the same synchronizationn problem&lt;/p&gt;</comment>
                            <comment id="16011996" author="jkemnade" created="Tue, 16 May 2017 08:38:54 +0000"  >&lt;p&gt;With the PR, all writes are synchronized. Here&apos;s why I think that the reads are fine without synchronization/&lt;tt&gt;volatile&lt;/tt&gt; (correct me if I&apos;m wrong):&lt;br/&gt;
Even if each thread uses its working copy of the &lt;tt&gt;categoriesInUse&lt;/tt&gt; field , the copy may have the wrong value, but it can not be &quot;significantly wrong&quot;.&lt;br/&gt;
The other thread may have incremented the value, but not from 0 to 1 as the current thread will already have set it to a value &lt;tt&gt;&amp;gt;0&lt;/tt&gt;, so it won&apos;t change the value of &lt;tt&gt;categoriesInUse == 0&lt;/tt&gt;, which is the only thing that matters for the early exit in &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt;.&lt;br/&gt;
The other thread may also have decremented the value, but it cannot have set it to 0 if the current thread incremented it in &lt;tt&gt;newScope&lt;/tt&gt;, so it would not have effected &lt;tt&gt;categoriesInUse == 0&lt;/tt&gt; either.&lt;/p&gt;</comment>
                            <comment id="16012018" author="jkemnade" created="Tue, 16 May 2017 08:56:03 +0000"  >&lt;p&gt;Why don&apos;t we just use a &lt;tt&gt;ThreadLocal&amp;lt;Boolean&amp;gt;&lt;/tt&gt; for &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt;?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void newScope () {
            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
                categoriesInUse++;
                DefaultMetaClassInfo.setCategoryUsed(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            }
            hasCategoryInCurrentThread.set(&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE);
            VMPluginFactory.getPlugin().invalidateCallSites();
            level++;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void endScope () {
            ...
            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (lock) {
                categoriesInUse--;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (categoriesInUse == 0) {
                    DefaultMetaClassInfo.setCategoryUsed(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
                }
                hasCategoryInCurrentThread.remove();
            }
           ...
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasCategoryInCurrentThread() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasCategoryInCurrentThread.get() != &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        ThreadCategoryInfo infoNullable = THREAD_INFO.getInfoNullable();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; infoNullable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; infoNullable.level != 0;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16012479" author="blackdrag" created="Tue, 16 May 2017 14:30:56 +0000"  >&lt;p&gt;You said &quot;The other thread may have incremented the value, but not from 0 to 1 as the current thread will already have set it to a value &amp;gt;0&quot;. Why is that not the case for the AtomicInteger alone and without synchronized? For me that should have been the same. Explain me this difference and I may be able to understand why it is a solution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;As for The ThreadLocal... well.. try it out. The speed was horrible last time I tried&lt;/p&gt;
</comment>
                            <comment id="16012499" author="jwagenleitner" created="Tue, 16 May 2017 14:46:09 +0000"  >&lt;p&gt;I agree that synchronizing the read in &lt;tt&gt;hasCategoryInCurrentThread()&lt;/tt&gt; is not required because of the nature of how it&apos;s used.  At worst stale non-zero values will cause it to fall back to checking the ThreadLocal with will result in the correct return value.  And when in a Category the same thread would have incremented the counter so whatever version of the value it sees should be non-zero.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;By the way, since the PR synchronizes the modification of categoriesInUse, the AtomicInteger could be removed altogether.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If that were done then &lt;tt&gt;hasCategoryInAnyThread()&lt;/tt&gt; would need to synchronize on the same lock when reading the value of the counter.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why don&apos;t we just use a ThreadLocal&amp;lt;Boolean&amp;gt; for hasCategoryInCurrentThread&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the &lt;tt&gt;THREAD_INFO.getInfoNullable()&lt;/tt&gt; retrieves a ThreadLocal value if within a category and so that alone should be enough (i.e., no reason to add another ThreadLocal).  The int counter is a performance optimization to quicky exit since this method is called from each callsite.&lt;/p&gt;

</comment>
                            <comment id="16012546" author="jkemnade" created="Tue, 16 May 2017 15:07:59 +0000"  >&lt;p&gt;It&apos;s the other case that makes the difference and that leads to the error, the one where the other thread sets the value to 0 even though the current thread is still using a category.&lt;br/&gt;
I think John&apos;s explanation shows the problem pretty well, so I&apos;ll rather show you another possible way to fix the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java b/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java
index 4c36935df..42533a5f7 100644
--- a/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java
+++ b/src/main/org/codehaus/groovy/runtime/GroovyCategorySupport.java
@@ -72,7 +72,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroovyCategorySupport {
         &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; propertySetterMap;
 
         &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void newScope () {
+            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(atomicCategoryUsageCounter){
               categoriesInUse = atomicCategoryUsageCounter.incrementAndGet();
+            }
             DefaultMetaClassInfo.setCategoryUsed(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
             VMPluginFactory.getPlugin().invalidateCallSites();
             level++;
@@ -95,7 +97,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroovyCategorySupport {
                 }
             }
             level--;
+            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(atomicCategoryUsageCounter){
               categoriesInUse = atomicCategoryUsageCounter.decrementAndGet();
+            }
             VMPluginFactory.getPlugin().invalidateCallSites();
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (categoriesInUse==0) DefaultMetaClassInfo.setCategoryUsed(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (level == 0) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This would also fix the problem that the modification of the &lt;tt&gt;AtomicInteger&lt;/tt&gt; and the assignment of its current value to the &lt;tt&gt;int&lt;/tt&gt; field are two separate steps.&lt;br/&gt;
The problem is not that the other thread will have changed the &lt;tt&gt;AtomicInteger&lt;/tt&gt; incorrectly but that it will have assigned an outdated value to the &lt;tt&gt;int&lt;/tt&gt; field.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;As for The ThreadLocal... well.. try it out. The speed was horrible last time I tried&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes, I guessed so. Well, if we remove the &lt;tt&gt;AtomicInteger&lt;/tt&gt; from the PR version, the code will effectively have the same semantics as if we were using a &lt;tt&gt;ThreadLocal&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16012559" author="jkemnade" created="Tue, 16 May 2017 15:12:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;If that were done then hasCategoryInAnyThread() would need to synchronize on the same lock when reading the value of the counter.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we can do that without causing much trouble, &lt;tt&gt;hasCategoryInAnyThread()&lt;/tt&gt; is unused anyway.&lt;/p&gt;</comment>
                            <comment id="16012565" author="jkemnade" created="Tue, 16 May 2017 15:17:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;At worst stale non-zero values will cause it to fall back to checking the ThreadLocal with will result in the correct return value.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t think that we will get relevant stale values. That&apos;s what I meant with &quot;significantly wrong&quot;. A stale value would only lead to different behavior if it was 0 where the real value was != 0 or vice versa. And AFAICT, neither of that can happen.&lt;/p&gt;</comment>
                            <comment id="16015265" author="jkemnade" created="Thu, 18 May 2017 06:13:39 +0000"  >&lt;p&gt;The updated PR looks good to me.&lt;/p&gt;</comment>
                            <comment id="16016347" author="blackdrag" created="Thu, 18 May 2017 19:47:46 +0000"  >&lt;p&gt;ok, let me propose an alternative fix... remove categoriesInUse and use atomicCategoryUsageCounter directly instead&lt;/p&gt;</comment>
                            <comment id="16016405" author="jwagenleitner" created="Thu, 18 May 2017 20:22:51 +0000"  >&lt;p&gt;I updated the PR, my assumption still being that it is important that &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed(true)&lt;/tt&gt; is set any time a thread is in a Category so that is why there is still a need to synchronize the atomic increment/decrement and the calls to &lt;tt&gt;DefaultMetaClassInfo.setCategoryUsed&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16016429" author="blackdrag" created="Thu, 18 May 2017 20:38:11 +0000"  >&lt;p&gt;John, I thought this information is not used in the test&lt;/p&gt;</comment>
                            <comment id="16016441" author="jwagenleitner" created="Thu, 18 May 2017 20:45:34 +0000"  >&lt;p&gt;That is true, I have not been able to find a problem that is caused by the race condition if the flags set by &lt;tt&gt;setCategoryUsed&lt;/tt&gt; called with &lt;tt&gt;false&lt;/tt&gt; when another thread enters a Category.  But without the sync it&apos;s very possible for one thread to set it to false just after another thread set it to true.&lt;/p&gt;</comment>
                            <comment id="16016499" author="blackdrag" created="Thu, 18 May 2017 21:37:13 +0000"  >&lt;p&gt;I think I am ok with the change in total now. &lt;/p&gt;</comment>
                            <comment id="16016984" author="jkemnade" created="Fri, 19 May 2017 06:52:09 +0000"  >&lt;p&gt;I actually liked the previous version better. Synchronizing the write access to the AtomicInteger feels awkward. It shouldn&apos;t have a negative effect on the performance though, because the lock inside the AtomicInteger should always be available right away.&lt;br/&gt;
But using an AtomicInteger instead of an int in hasCategoryInCurrentThread will add the potential for a lock congestion where no locking is actually required.&lt;br/&gt;
I&apos;ll try to perform some benchmarks and try out another version that uses a ReentrantReadWriteLock.&lt;/p&gt;</comment>
                            <comment id="16017012" author="jkemnade" created="Fri, 19 May 2017 07:24:40 +0000"  >&lt;p&gt;It doesn&apos;t make much of a difference. Pretty much all of the locking happens in &lt;tt&gt;IndyInterface.invalidateSwitchPoints&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16017035" author="jkemnade" created="Fri, 19 May 2017 08:02:33 +0000"  >&lt;p&gt;Oh, that&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7811&quot; title=&quot;Block frequently occurs Groovy multithreading capabilities of mixin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7811&quot;&gt;GROOVY-7811&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16017549" author="jwagenleitner" created="Fri, 19 May 2017 15:34:31 +0000"  >&lt;p&gt;The &lt;tt&gt;AtomicInteger#get&lt;/tt&gt; shouldn&apos;t lock but would be a &lt;tt&gt;volatile&lt;/tt&gt; read (and other methods use CAS and not locks).  While I don&apos;t think having that volatile read in &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt; will cause too much of a performance issue, I do agree that it&apos;s awkward to be using the &lt;tt&gt;AtomicInteger&lt;/tt&gt; in the synchronized blocks.  Given that there is only a need to observe 0 or non-Zero for &lt;tt&gt;categoriesInUse&lt;/tt&gt; and a precise number does not matter, except when decrementing which is synchronized. I also think the &lt;tt&gt;int&lt;/tt&gt; counter version is better as long as there&apos;s a &lt;a href=&quot;https://github.com/apache/groovy/pull/540/commits/6fddddb2a39741d68358701230a929728338e7aa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some comment&lt;/a&gt; to explain why there is no synchronized read in &lt;tt&gt;hasCategoryInCurrentThread&lt;/tt&gt;.  In either case, I think one additional change should be to deprecate the &lt;tt&gt;hasCategoryInAnyThread&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;I think the original fix that was put into 2.4.6 did not fix the issue and may have just reduced the number of instructions that the threads could interleave on in order to reproduce.  I&apos;d like to see what others think, if in agreement then as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulk&quot; class=&quot;user-hover&quot; rel=&quot;paulk&quot;&gt;paulk&lt;/a&gt; mentioned this should be re-opened.&lt;/p&gt;</comment>
                            <comment id="16017957" author="blackdrag" created="Fri, 19 May 2017 20:14:14 +0000"  >&lt;p&gt;In that case my suggestion would be to do the synchronization as is, but use int instead of AtomicInteger&lt;/p&gt;</comment>
                            <comment id="16020962" author="jkemnade" created="Tue, 23 May 2017 09:47:06 +0000"  >&lt;p&gt;Agreed. The current PR looks good to me again/still.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the original fix that was put into 2.4.6 did not fix the issue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Also agreed. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16025564" author="githubbot" created="Thu, 25 May 2017 23:38:34 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/540&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16025579" author="jwagenleitner" created="Fri, 26 May 2017 00:05:21 +0000"  >&lt;p&gt;Since there is agreement that the original fix &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR 169&lt;/a&gt; did not resolve the issue, re-opening in order to update the fix version to 2.4.12.&lt;/p&gt;</comment>
                            <comment id="16025580" author="jwagenleitner" created="Fri, 26 May 2017 00:07:33 +0000"  >&lt;p&gt;Thanks for reporting the issue and thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkemnade&quot; class=&quot;user-hover&quot; rel=&quot;jkemnade&quot;&gt;jkemnade&lt;/a&gt; for investigating the fix and patch.&lt;/p&gt;</comment>
                            <comment id="16025584" author="paulk" created="Fri, 26 May 2017 00:13:42 +0000"  >&lt;p&gt;Nice work everyone!&lt;/p&gt;</comment>
                            <comment id="16025888" author="jkemnade" created="Fri, 26 May 2017 06:43:51 +0000"  >&lt;p&gt;Thanks guys, I learned some interesting things from this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12868010" name="0001-GROOVY-7535-fix-race-condition-between-the-modificat.patch" size="1813" author="jkemnade" created="Mon, 15 May 2017 06:53:04 +0000"/>
                            <attachment id="12748190" name="CategoryTest.groovy" size="1316" author="joswald" created="Fri, 31 Jul 2015 15:56:27 +0000"/>
                            <attachment id="12748193" name="Test.groovy" size="313" author="joswald" created="Fri, 31 Jul 2015 15:56:27 +0000"/>
                            <attachment id="12748194" name="TimeCategoryTest.groovy" size="1201" author="joswald" created="Fri, 31 Jul 2015 15:56:27 +0000"/>
                            <attachment id="12748191" name="exceptionForCategoryTest.txt" size="1783" author="joswald" created="Fri, 31 Jul 2015 15:56:27 +0000"/>
                            <attachment id="12748192" name="exceptionForTimeCategoryTest.txt" size="1616" author="joswald" created="Fri, 31 Jul 2015 15:56:27 +0000"/>
                            <attachment id="12868898" name="locking.png" size="119432" author="jkemnade" created="Fri, 19 May 2017 07:32:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i6qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>