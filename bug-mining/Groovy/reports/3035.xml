<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:49:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7841] Assert fails when accessing particular primitive values with @CompileStatic</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7841</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;The following assert for a non-zero long value fails when annotated with CompileStatic. For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def foo() {
  &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value = 17179869184 
  &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; value, &lt;span class=&quot;code-quote&quot;&gt;&quot;Foo is OK&quot;&lt;/span&gt;
}

@groovy.transform.CompileStatic
def bar() {
  &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value = 17179869184 
  &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; value, &lt;span class=&quot;code-quote&quot;&gt;&quot;Bar failed&quot;&lt;/span&gt;
}

foo()
bar()


java.lang.AssertionError: Bar failed. Expression: value. Values: value = 17179869184
	at ConsoleScript31.bar(ConsoleScript31:10)
	at ConsoleScript31.run(ConsoleScript31:14)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12971634">GROOVY-7841</key>
            <summary>Assert fails when accessing particular primitive values with @CompileStatic</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulk">Paul King</assignee>
                                    <reporter username="pablo72">paolo di tommaso</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 May 2016 19:30:39 +0000</created>
                <updated>Sun, 12 Jun 2016 08:45:10 +0000</updated>
                            <resolved>Wed, 25 May 2016 10:45:01 +0000</resolved>
                                    <version>2.4.5</version>
                                    <fixVersion>2.4.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15296863" author="sbalachandran" created="Mon, 23 May 2016 18:46:54 +0000"  >&lt;p&gt;This seems to happen only with that specific number (17179869184). It is working fine for other values that I checked randomly. That specific number exactly is 16 GB (16 * 1024 * 1024* 1024). I am not sure why it fails exactly for that.&lt;/p&gt;</comment>
                            <comment id="15297567" author="paulk" created="Tue, 24 May 2016 02:54:41 +0000"  >&lt;p&gt;Any multiple of 4294967296 will have the same result. Looking at the bytecode, there is an L2I inserted for the @CompileStatic case which just keeps the lowest 32 bits. Workaround is to use the longhand equivalent &lt;tt&gt;assert value != 0&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;My suspicion is we are applying this optimization a bit too aggressively:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/groovy/blob/master/src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java#L137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/blob/master/src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java#L137&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15297654" author="blackdrag" created="Tue, 24 May 2016 04:27:52 +0000"  >&lt;p&gt;The usages of F2I and D2I look wrong too.&lt;/p&gt;</comment>
                            <comment id="15298050" author="paulk" created="Tue, 24 May 2016 10:58:32 +0000"  >&lt;p&gt;Indeed, both &lt;tt&gt;assert 0.1f&lt;/tt&gt; and &lt;tt&gt;assert 0.1d&lt;/tt&gt; also fail (within @CompileStatic) but should succeed.&lt;/p&gt;</comment>
                            <comment id="15298071" author="githubbot" created="Tue, 24 May 2016 11:53:16 +0000"  >&lt;p&gt;GitHub user paulk-asert opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/338&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7841&quot; title=&quot;Assert fails when accessing particular primitive values with @CompileStatic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7841&quot;&gt;&lt;del&gt;GROOVY-7841&lt;/del&gt;&lt;/a&gt;: Assert fails when accessing particular primitive values &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;with @CompileStatic&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/paulk-asert/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/paulk-asert/groovy&lt;/a&gt; groovy7841&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/338.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/338.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #338&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c7d106315226667248dca01af793bb24b96d8d97&lt;br/&gt;
Author: paulk &amp;lt;paulk@asert.com.au&amp;gt;&lt;br/&gt;
Date:   2016-05-24T11:52:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7841&quot; title=&quot;Assert fails when accessing particular primitive values with @CompileStatic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7841&quot;&gt;&lt;del&gt;GROOVY-7841&lt;/del&gt;&lt;/a&gt;: Assert fails when accessing particular primitive values with @CompileStatic&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15299119" author="githubbot" created="Tue, 24 May 2016 23:05:04 +0000"  >&lt;p&gt;Github user shils commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/338#discussion_r64490605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/338#discussion_r64490605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java &amp;#8212;&lt;br/&gt;
    @@ -134,15 +134,19 @@ public void visit(final GroovyCodeVisitor visitor) &lt;/p&gt;
{
                                 // int on stack
                             }
&lt;p&gt; else if (top.equals(ClassHelper.long_TYPE)) &lt;/p&gt;
{
                                 MethodVisitor mv = controller.getMethodVisitor();
    -                            mv.visitInsn(L2I);
    +                            mv.visitInsn(LCONST_0);
    +                            mv.visitInsn(LCMP);
                                 controller.getOperandStack().replace(ClassHelper.boolean_TYPE);
                             }
&lt;p&gt; else if (top.equals(ClassHelper.float_TYPE)) {&lt;br/&gt;
                                 MethodVisitor mv = controller.getMethodVisitor();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;mv.visitInsn(F2I);&lt;br/&gt;
    +                            mv.visitInsn(F2D);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why not use a compare float operation here?&lt;/p&gt;</comment>
                            <comment id="15299816" author="githubbot" created="Wed, 25 May 2016 10:22:51 +0000"  >&lt;p&gt;Github user paulk-asert commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/338#discussion_r64549052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/338#discussion_r64549052&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java &amp;#8212;&lt;br/&gt;
    @@ -134,15 +134,19 @@ public void visit(final GroovyCodeVisitor visitor) &lt;/p&gt;
{
                                 // int on stack
                             }
&lt;p&gt; else if (top.equals(ClassHelper.long_TYPE)) &lt;/p&gt;
{
                                 MethodVisitor mv = controller.getMethodVisitor();
    -                            mv.visitInsn(L2I);
    +                            mv.visitInsn(LCONST_0);
    +                            mv.visitInsn(LCMP);
                                 controller.getOperandStack().replace(ClassHelper.boolean_TYPE);
                             }
&lt;p&gt; else if (top.equals(ClassHelper.float_TYPE)) {&lt;br/&gt;
                                 MethodVisitor mv = controller.getMethodVisitor();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;mv.visitInsn(F2I);&lt;br/&gt;
    +                            mv.visitInsn(F2D);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We probably could. In general, comparisons with floats are notoriously ugly, e.g. see:&lt;br/&gt;
    &lt;a href=&quot;https://randomascii.wordpress.com/2012/02/25/comparing-floating-point-numbers-2012-edition/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://randomascii.wordpress.com/2012/02/25/comparing-floating-point-numbers-2012-edition/&lt;/a&gt;&lt;br/&gt;
    But given we are comparing against 0.0, it is probably an edge case that isn&apos;t as bad as the general case (but see &apos;Infernal zero&apos; in the aforementioned link). A general recommendation is to use doubles instead of floats but I don&apos;t really know for sure whether it does in this case. My rationale was to look at what bytecode was produced from `assert floatValue != 0.0f` and then replicating that - which is where the `F2D` and `DCMPG` came from.&lt;/p&gt;</comment>
                            <comment id="15299848" author="githubbot" created="Wed, 25 May 2016 10:44:05 +0000"  >&lt;p&gt;Github user paulk-asert closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/338&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15299850" author="paulk" created="Wed, 25 May 2016 10:45:01 +0000"  >&lt;p&gt;PR merged&lt;/p&gt;</comment>
                            <comment id="15299962" author="githubbot" created="Wed, 25 May 2016 12:17:09 +0000"  >&lt;p&gt;Github user shils commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/338#discussion_r64561363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/338#discussion_r64561363&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java &amp;#8212;&lt;br/&gt;
    @@ -134,15 +134,19 @@ public void visit(final GroovyCodeVisitor visitor) &lt;/p&gt;
{
                                 // int on stack
                             }
&lt;p&gt; else if (top.equals(ClassHelper.long_TYPE)) &lt;/p&gt;
{
                                 MethodVisitor mv = controller.getMethodVisitor();
    -                            mv.visitInsn(L2I);
    +                            mv.visitInsn(LCONST_0);
    +                            mv.visitInsn(LCMP);
                                 controller.getOperandStack().replace(ClassHelper.boolean_TYPE);
                             }
&lt;p&gt; else if (top.equals(ClassHelper.float_TYPE)) {&lt;br/&gt;
                                 MethodVisitor mv = controller.getMethodVisitor();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;mv.visitInsn(F2I);&lt;br/&gt;
    +                            mv.visitInsn(F2D);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Thanks for the explanation.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yanb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>