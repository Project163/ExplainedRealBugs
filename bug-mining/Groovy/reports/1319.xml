<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:16:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4272] Constant integer and double expressions in AstBuilder.buildFromCode { } cause NoSuchFieldErrors at runtime</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4272</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;the following blocks of code cause a NoSuchFieldError at runtime in the transformed class due to failure to look up a constant:&lt;/p&gt;

&lt;p&gt;new AstBuilder.buildFromCode&lt;/p&gt;
{ return 1 }
&lt;p&gt;new AstBuilder.buildFromCode&lt;/p&gt;
{ return 1.0 }
&lt;p&gt;new AstBuilder.buildFromString(&quot;return 1&quot;)&lt;/p&gt;

&lt;p&gt;I&apos;ve attached an example and the test that shows the failure.&lt;/p&gt;

&lt;p&gt;The current workaround is to use the String constructor of their java.lang.Number equivalents:&lt;/p&gt;

&lt;p&gt;new AstBuilder.buildFromCode&lt;/p&gt;
{ return new Integer(&quot;1&quot;) }
&lt;p&gt;new AstBuilder.buildFromCode&lt;/p&gt;
{ return new Double(&quot;1.0&quot;) }

&lt;p&gt;My suspicion is that the compiler is optimizing the inline constants away, but that the reference to those constants are in some intermediary generated class which is thrown away later instead of the intended target classes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12815242">GROOVY-4272</key>
            <summary>Constant integer and double expressions in AstBuilder.buildFromCode { } cause NoSuchFieldErrors at runtime</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="bcarr">Brian M. Carr</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Jun 2010 12:42:19 +0000</created>
                <updated>Thu, 22 Jul 2010 17:32:27 +0000</updated>
                            <resolved>Thu, 1 Jul 2010 12:50:24 +0000</resolved>
                                    <version>1.7.3</version>
                                    <fixVersion>1.7.4</fixVersion>
                    <fixVersion>1.8-beta-1</fixVersion>
                                    <component>ast builder</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14469792" author="roshandawrani" created="Wed, 30 Jun 2010 23:18:11 +0000"  >&lt;p&gt;The issue is there because local annotations processing and OptimizerVisitor processing both happen in SEMANTIC_ANALYSIS phase.&lt;/p&gt;

&lt;p&gt;Since the transformation in the given example creates some methods in CANONICALIZATION phase, OptimizerVisitor does not get a chance to add const$ fields and hence the NoSuchFieldError.&lt;/p&gt;

&lt;p&gt;Should we close this as &quot;Won&apos;t fix&quot; - as it is always possible to shoot yourself in the foot by introducing nodes late in the compilation cycle for which some of the normal compilation (previous phases) are skipped?&lt;/p&gt;</comment>
                            <comment id="14469778" author="roshandawrani" created="Wed, 30 Jun 2010 23:57:48 +0000"  >&lt;p&gt;A slightly more specific reason is that when we do AstBuilder.buildFromCode(), the code passed to it goes through all phases and also OptimizerVisitor and that&apos;s why return new Integer(&quot;1&quot;) becomes return $const$0 but the constant pool is added to the temporary script class that the string passed to AstBuilder.buildFromCode() becomes a part of.&lt;/p&gt;

&lt;p&gt;Later on when the return statement gets attached to another ClassNode, that other classnode does not have any constant pool attached to it, because OptimizerVisitor did not visit it.&lt;/p&gt;

&lt;p&gt;That&apos;s where the issue comes from - the statement refers to $const$0 but the class does not have it - this never happens when a class normally gets compiled by the compiler.&lt;/p&gt;</comment>
                            <comment id="14469741" author="roshandawrani" created="Thu, 1 Jul 2010 00:57:31 +0000"  >&lt;p&gt;Attaching a patch for review.&lt;/p&gt;

&lt;p&gt;Earlier OptimizerVisitor was clubbed with StaticImportVisitor and did its thing in staticImport operation in SEMANTIC_ANALYSIS phase. &lt;/p&gt;

&lt;p&gt;The patch now moves OptimizerVisitor to a separate operation &apos;optimize&apos; in CANONICALIZATION phase.&lt;/p&gt;

&lt;p&gt;With this patch, if MyConstantsASTTransformation is modified to be executed in SEMANTIC_ANALYSIS phase, then the sequence of events becomes:&lt;/p&gt;

&lt;p&gt;1)  AstBuilder.buildFromCode() compiles the given expression which has $const$0 reference.&lt;/p&gt;

&lt;p&gt;2)  MyConstantsASTTransformation attaches the method having the above expression to a new classnode.&lt;/p&gt;

&lt;p&gt;3)  Since the MyConstantsASTTransformation is now in SEMANTIC_ANALYSIS phase and OptimizerVisitor comes later in CANONICALIZATION phase (its new position in compilation cycle), OptimizerVisitor now processes the new ClassNode and creates the constant pool correctly.&lt;/p&gt;

&lt;p&gt;The only thing I am not sure of is whether moving OptimizerVisitor to later in compilation cycle will have any impact on deeply-integrating frameworks like Groovy++ or Spock, etc. I guess, it won&apos;t, but I am not sure.&lt;/p&gt;</comment>
                            <comment id="14469836" author="roshandawrani" created="Thu, 1 Jul 2010 12:50:24 +0000"  >&lt;p&gt;Fixed. OptimizerVisitor moved to classgen now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722442" name="4272_v17x.patch" size="1379" author="roshandawrani" created="Thu, 1 Jul 2010 00:57:31 +0000"/>
                            <attachment id="12722682" name="MyConstants.java" size="416" author="bcarr" created="Wed, 30 Jun 2010 12:42:19 +0000"/>
                            <attachment id="12722567" name="MyConstantsASTTransformation.groovy" size="1714" author="bcarr" created="Wed, 30 Jun 2010 12:42:19 +0000"/>
                            <attachment id="12722515" name="MyConstantsTest.groovy" size="305" author="bcarr" created="Wed, 30 Jun 2010 12:42:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c5f3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12312220" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Testcase included</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="11060"><![CDATA[Yes]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>