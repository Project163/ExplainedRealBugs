<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:13:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3623] A call to MetaClassRegistry.removeMetaClass() can unexpectedly cause other live entries to be removed</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3623</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;Due to a bug in the &lt;tt&gt;MemoryAwareConcurrentReadMap&lt;/tt&gt; implementation, a call to remove entries from the &lt;tt&gt;MetaClassRegistry&lt;/tt&gt; can result in other entries becoming inaccessible.&lt;/p&gt;

&lt;p&gt;This can cause very unpredictable behavior/failures when relying on dynamic modifications to a Class&apos; &lt;tt&gt;ExpandoMetaClass&lt;/tt&gt;.  For example, this bug is responsible for the behavior described in &lt;a href=&quot;http://jira.codehaus.org/browse/GRAILS-3666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GRAILS-3666&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The failure occurs when a hash table entry that is not at the head of its bucket is removed.  The mechanism to recreate the bucket&apos;s linked list after removal does not dereference the &lt;tt&gt;SoftReference&lt;/tt&gt; objects for entries following the removal.  As a result, any entries in the list after the removed entry will no longer be accessible by their original key.&lt;/p&gt;

&lt;p&gt;A simple patch for the problem has been attached.  Note that the fix is not necessary for the &lt;tt&gt;sremove()&lt;/tt&gt; method, as proper dereferencing is used there.&lt;/p&gt;

&lt;p&gt;The failure case can be easily demonstrated with the following test code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.runtime.metaclass.*;

def initalCapacity = 4
def loadFactor = 1000 &lt;span class=&quot;code-comment&quot;&gt;// keep number of buckets low to increase entries per bucket
&lt;/span&gt;def keysToInsert = 2000

def map = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryAwareConcurrentReadMap(initalCapacity, loadFactor)

def keys = []
keysToInsert.times
{
    def random = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.random()
    map.put(random, random) &lt;span class=&quot;code-comment&quot;&gt;// insert random key
&lt;/span&gt;    keys &amp;lt;&amp;lt; random &lt;span class=&quot;code-comment&quot;&gt;// keep track of keys so we can test reachability
&lt;/span&gt;}
println &lt;span class=&quot;code-quote&quot;&gt;&quot;Inserted $keysToInsert random keys&quot;&lt;/span&gt;

&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0
keys.each
{
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (map.get(it)) count++
}
println &lt;span class=&quot;code-quote&quot;&gt;&quot;Keys in map: $count&quot;&lt;/span&gt;

def removeMe = map.get(keys[0]) &lt;span class=&quot;code-comment&quot;&gt;// just remove any key
&lt;/span&gt;map.remove(removeMe)
println &lt;span class=&quot;code-quote&quot;&gt;&quot;Removed one key&quot;&lt;/span&gt;

count = 0
keys.each
{
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (map.get(it)) count++
}
println &lt;span class=&quot;code-quote&quot;&gt;&quot;Keys in map: $count&quot;&lt;/span&gt;

&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; count == keysToInsert - 1 &lt;span class=&quot;code-comment&quot;&gt;//we expect our count to be decreased by one
&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the example above, the load factor has been increased to an impracticable level to ensure failure will occur.  The assertion will still fail with the default load factor, but not as consistently.   &lt;/p&gt;







</description>
                <environment></environment>
        <key id="12814456">GROOVY-3623</key>
            <summary>A call to MetaClassRegistry.removeMetaClass() can unexpectedly cause other live entries to be removed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="stedog">Stephen Mucher</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Jul 2009 14:55:35 +0000</created>
                <updated>Sun, 5 Apr 2015 14:44:07 +0000</updated>
                            <resolved>Fri, 31 Jul 2009 08:42:46 +0000</resolved>
                                    <version>1.6.3</version>
                                    <fixVersion>1.6.4</fixVersion>
                    <fixVersion>1.7-beta-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14467234" author="blackdrag" created="Wed, 15 Jul 2009 15:34:05 +0000"  >&lt;p&gt;this looks like a copy&amp;amp;paste error. Looking at the loop in the patch this class has 3 loops that look almost the same, but should do all the same. &lt;br/&gt;
expungeStallEntries is doing: head = new Entry(p.hash, p.key, p.value, head);&lt;br/&gt;
remove is doing: head = new Entry(p.hash, p.key, p.value, head, queue);&lt;br/&gt;
sremove is doing: head = new Entry(p.hash, p.getKey(), p.getValue(), head, queue);&lt;/p&gt;

&lt;p&gt;I think they should all do the same, and I think they should all do it like expungeStallEntries, whcih avoids creating new SoftReferences for each key and value. &lt;/p&gt;</comment>
                            <comment id="14467341" author="stedog" created="Wed, 15 Jul 2009 16:23:53 +0000"  >&lt;p&gt;The Copy &amp;amp; Paste is from &lt;tt&gt;ConcurrentReaderHashMap&lt;/tt&gt;, which didn&apos;t need to handle &lt;tt&gt;SoftReferences&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;MemoryAwareConcurrentReadMap&lt;/tt&gt;, &lt;tt&gt;p.key()&lt;/tt&gt; and &lt;tt&gt;p.value()&lt;/tt&gt; are &lt;tt&gt;SoftRef&lt;/tt&gt; objects, not &lt;tt&gt;Classes&lt;/tt&gt; / &lt;tt&gt;MetaClasses&lt;/tt&gt;.  If you don&apos;t dereference them, you will end up with key -&amp;gt; &lt;tt&gt;SoftRef&lt;/tt&gt; -&amp;gt; &lt;tt&gt;SoftRef&lt;/tt&gt; -&amp;gt; &lt;tt&gt;Class&lt;/tt&gt;.  If you use &lt;tt&gt;Entry(int hash, SoftRef key, Reference value, Entry next)&lt;/tt&gt; like &lt;tt&gt;expungeStallEntries()&lt;/tt&gt;, the &lt;tt&gt;value&lt;/tt&gt; property will be a dummy reference.  (See constructor for &lt;tt&gt;Entry&lt;/tt&gt;)&lt;/p&gt;

&lt;p&gt;Thanks for the quick response, btw!&lt;/p&gt;</comment>
                            <comment id="14467325" author="blackdrag" created="Wed, 15 Jul 2009 16:46:10 +0000"  >&lt;p&gt;for reference:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Entry(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; hash, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; key, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; value, Entry next, ReferenceQueue queue) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.hash = hash;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SoftRef(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;,key,queue);
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.next = next;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.value = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SoftRef(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;,value,queue);
        }

        Entry(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; hash, SoftRef key, Reference value, Entry next) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.hash = hash;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key = key;
            key.entry = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.next = next;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.value = DUMMY_REF;
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.setValue(value);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That means  the version with the queue will create new  references, while the version without the queue will not. But the seond constructor is not wrong, since this.key is a reference. So what expunge does is right and what sremove does is right, but what remove is doing is just plain wrong.&lt;/p&gt;
</comment>
                            <comment id="14467275" author="stedog" created="Wed, 15 Jul 2009 17:04:53 +0000"  >&lt;p&gt;Whoops &amp;#8211; yeah, it looks like the second constructor should work too, and avoids needing to create new references.  I got thrown off by the &lt;tt&gt;DUMMY_REF&lt;/tt&gt; value and missed the &lt;tt&gt;this.setValue(value)&lt;/tt&gt;.  I presume &lt;tt&gt;this.setValue(value)&lt;/tt&gt; is being called instead of setting the &lt;tt&gt;value&lt;/tt&gt; property directly to handle the &lt;tt&gt;null&lt;/tt&gt; value case.&lt;/p&gt;</comment>
                            <comment id="14467362" author="blackdrag" created="Fri, 31 Jul 2009 08:42:46 +0000"  >&lt;p&gt;fixed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12721509" name="MemoryAwareConcurrentReadMap.patch" size="821" author="stedog" created="Wed, 15 Jul 2009 14:55:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cosf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12312220" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Testcase included</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="11060"><![CDATA[Yes]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>