<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:08:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-2849] A property name in a nested closure interferes with a class property when refering with &quot;this.prop&quot;</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-2849</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I guess this may be a parser bug (I&apos;m not sure).&lt;/p&gt;

&lt;p&gt;This class is working fine:&lt;/p&gt;

&lt;p&gt;private class TestClosure {&lt;br/&gt;
    def test = 1   &lt;br/&gt;
    def c1 = {&lt;br/&gt;
        def test = 2&lt;br/&gt;
        def c2 = &lt;/p&gt;
{
            println this.test
            this.test+=10
            println this.test
        }
&lt;p&gt;        c2()&lt;br/&gt;
    }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;new TestClosure().c1()&lt;/p&gt;

&lt;p&gt;But when we change:&lt;/p&gt;

&lt;p&gt;        def c2 = &lt;/p&gt;
{
            println this.test
            this.test+=10
            println this.test
            test = 3
        }

&lt;p&gt;then thing is screwed up.&lt;br/&gt;
&apos;this.test&apos; is resolved to be &apos;test&apos; of the c1 closure, which is not correct.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12814254">GROOVY-2849</key>
            <summary>A property name in a nested closure interferes with a class property when refering with &quot;this.prop&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="chanwit">Chanwit Kaewkasi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 May 2008 03:20:21 +0000</created>
                <updated>Tue, 23 Dec 2008 05:58:06 +0000</updated>
                            <resolved>Wed, 10 Dec 2008 23:47:50 +0000</resolved>
                                    <version>1.6-beta-1</version>
                                    <fixVersion>1.6-rc-1</fixVersion>
                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>1.7-beta-1</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14464815" author="chanwit" created="Wed, 21 May 2008 03:27:07 +0000"  >&lt;p&gt;A proper test case.&lt;/p&gt;</comment>
                            <comment id="14464831" author="blackdrag" created="Wed, 21 May 2008 06:12:03 +0000"  >&lt;p&gt;The &quot;implicit this&quot; is set to true for &quot;this.test&quot;, that must not happen. This error seems to be an old one. I confirmed it in 1.0, 1.5.4 and 1.5.x as well as 1.6 trunk&lt;/p&gt;</comment>
                            <comment id="14465647" author="roshandawrani" created="Sun, 16 Nov 2008 03:00:52 +0000"  >&lt;p&gt;The issue is found in all 1.5.8, 1.6-RC-1, and 1.7-beta-1 versions. I am attaching patches that fix the issue in all these 3 versions.&lt;/p&gt;

&lt;p&gt;It is an error found in the class-generator (AsmClassGenerator) and not in the parser.&lt;/p&gt;

&lt;p&gt;When the class bytecode is generated, for properties accessed as this.&amp;lt;prop&amp;gt;, if a class level declared field exists, it gets used. It is not correct for closure inner classes because inside a closure, if a property is explicitly accessed as this.&amp;lt;prop&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;implicitThis = true&amp;#93;&lt;/span&gt;, we don&apos;t want closure class level declared field to be used. In this scenario, we want the property access to be done on the outermost class.&lt;/p&gt;

&lt;p&gt;Modified org/codehaus/groovy/classgen/AsmClassGenerator.java with following 2 changes:&lt;br/&gt;
1)  visitAttributeOrProperty - Before using class level field, added a check if it was happening within a closure with implicitThis = true for the property.&lt;/p&gt;

&lt;p&gt;2)  isExplicitThisInClosure() - Helper method for the new check.&lt;/p&gt;</comment>
                            <comment id="14465601" author="blackdrag" created="Sun, 16 Nov 2008 07:33:08 +0000"  >&lt;p&gt;I didn&apos;t say it is a bug in the parser. One of the phases in between is setting the &quot;implicitThis&quot; to true. But &quot;this.foo&quot; is with an explicit this, therefor &quot;implicitThis&quot; must be false. Your patch may fix the problem in ACG, but it is only a workaround. The implicitThis must be set correctly, as other phases may use that. You do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;isThisExpression(expression) &amp;amp;&amp;amp; isInClosure() &amp;amp;&amp;amp; !implicitThis;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You said if we have in a closure this.prop, then implicitThis will be true. First, as you can clearly see, that is no situation with an implicit this. If the user had written: &quot;prop&quot;, then it might have been changed to &quot;this.prop&quot;, but with implicitThis set to true. If implicitThis is always set to true for &quot;this.prop&quot; and &quot;prop&quot;, then your fix should do nothing, especially not fixing the problem.&lt;/p&gt;

&lt;p&gt;Then you removed the always executed field = classNode.getDeclaredField(name);... won&apos;t that affect direct field access in normal classes?&lt;/p&gt;

&lt;p&gt;And there is one additional problem. Is it even legal to directly access the field from the closure? That&apos;s a non trivial question to answer, because till now this.prop would go through getProperty of the enclosing class. After your change it might get through getAttribute in MetaClass. If we have this.foo in a normal class and foo is a field, then we generate a direct field access, that does not go through the MetaClass at all. So going through getAttribute would still mean a difference to normal classes. It would bypass most parts of the MOP. But it would not be equal to a direct field access. If we want to have that in the same way as for normal classes, then it would have to be a direct field access (maybe by using a helper method which is called directly).The discussion if it is legal to bypass the MOP for the closure is still open and postponed to 2.0... In fact that means this issue is targeting the wrong release, it should be&lt;br/&gt;
a part of &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-2503&quot; title=&quot;MOP 2.0 design inflluencing issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-2503&quot;&gt;GROOVY-2503&lt;/a&gt;. in fact this is maybe even to be seen as duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-1569&quot; title=&quot;correct closure property access to field access the same way it is done this.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-1569&quot;&gt;GROOVY-1569&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;The bug to fix as I see it, is to correct the handling of the implicitThis for now. That should also avoid the interference described. Setting the correct value for implicitThis is I think work of AntlrParserPlugin. Resolving a variable to the correct referent is task of the VariablesScopeVisitor. First APP needs to be fixed to set that value right, then VariableScopevisitor probably needs to be fixed to not to resolve to the local variable... but I think the later is not needed, because the implicitThis should be the reason VariableScopeVisitor has problems with evaluating the correct variable.&lt;/p&gt;</comment>
                            <comment id="14465666" author="roshandawrani" created="Sun, 16 Nov 2008 08:08:41 +0000"  >&lt;p&gt;First of all, sorry about 2 typing errors in my first comment. &lt;/p&gt;

&lt;p&gt;In the both the cases, I meant to write (implicitThis = false) and not (implicitThis=true). I wanted to correct the mistake much sooner but there was no electricity for last one hour at this bloody place &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;When the inner closure c2&apos;s code is generated, implicitThis is set correctly for both &quot;test&quot; (implicitThis = true) and &quot;this.test&quot; (implicitThis = false) property expressions.&lt;/p&gt;

&lt;p&gt;What I am doing is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!isExplicitThisInClosure(expression.getObjectExpression(), expression.isImplicitThis())){
    field = classNode.getDeclaredField(name);
}

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isExplicitThisInClosure(Expression expression, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; implicitThis) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isThisExpression(expression) &amp;amp;&amp;amp; isInClosure() &amp;amp;&amp;amp; !implicitThis;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;isExplicitThisInClosure() returns true only when property is explicitly qualified by &quot;this&quot;, it is happening within the closure and implicitThis is false (which happens for this.test and not for &apos;test&apos;).&lt;/p&gt;

&lt;p&gt;The method isExplicitThisInClosure() returns false if&lt;br/&gt;
a) this.&amp;lt;prop&amp;gt; is not happening within the closure, or&lt;br/&gt;
b) it is happening within the closure but prop is not qualified by &quot;this&quot;&lt;br/&gt;
So, in all other cases except (this.test within a closure), &quot;field = classNode.getDeclaredField(name);&quot; always gets executed.&lt;/p&gt;

&lt;p&gt;I have tested the fix with all the tests that are these plus the test attached to this JIRA and I think the fix is correct (If it is not legal to directly access the field from the closure, it is a different thing altogether).&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465655" author="roshandawrani" created="Sun, 16 Nov 2008 08:41:56 +0000"  >&lt;p&gt;Before the fix, in 1.5.8, if c2 only &quot;this.test += 10&quot; and not an interfering expression like &quot;test = 3&quot;, then &quot;this.test += 10&quot; gets written as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; tmp120_117 = ScriptBytecodeAdapter.invokeMethodN(
  &lt;span class=&quot;code-keyword&quot;&gt;class$&lt;/span&gt;Groovy2849Property,
  ScriptBytecodeAdapter.getGroovyObjectProperty(
    &lt;span class=&quot;code-keyword&quot;&gt;class$&lt;/span&gt;Groovy2849Property, &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.getThisObject(), &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;
  ), 
  &lt;span class=&quot;code-quote&quot;&gt;&quot;plus&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] { &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;(10) }
); 
ScriptBytecodeAdapter.setGroovyObjectProperty(
  tmp120_117, 
  Groovy2849Property.class, &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.getThisObject(), &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;
); 
tmp120_117;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After the fix, in c2 that has both &quot;this.test += 10&quot; and &quot;test = 3&quot;, &quot;this.test += 10&quot; still gets written exactly same as above - absolutely no difference at all in what gets written in the class bytecode for &quot;this.test += 10&quot;. You can verify it in the decompiled class before and after the fix.&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465613" author="roshandawrani" created="Sun, 16 Nov 2008 09:03:21 +0000"  >&lt;p&gt;The issue has been found in method calls too. Exactly same scenario as described in this bug for property access.&lt;/p&gt;

&lt;p&gt;I am attaching an updated testcase that covers the reported issue for both property access and method call.&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465625" author="roshandawrani" created="Sun, 16 Nov 2008 09:40:18 +0000"  >&lt;p&gt;I&apos;ll add one last point for now and then you can decide if the fix is any use.&lt;/p&gt;

&lt;p&gt;When I say that implicitThis is correctly set inside c2 for &quot;this.test = 10&quot; as well as &quot;test = 3&quot;, it is by the time expressions come to AsmClassGenerator for class writing.&lt;/p&gt;

&lt;p&gt;I didn&apos;t know which was the earliest phase implicitThis is correctly expected to be set so that it useful for all the relevant phases. Without that knowledge, I looked into the issue and made sure in the fix that classes get written fine and runtime behavior is as fixed for the issue and nothing else is broken.&lt;/p&gt;

&lt;p&gt;If implicitThis is supposed to be set correctly soon after AntlrParserPlugin has generated the AST, then obviously the fix is at the wrong place. But I couldn&apos;t be sure of that earlier with the AST modification responsibilities distributed all across visitors used in compilation. &lt;/p&gt;

&lt;p&gt;Well, at least an improved test case (property access as well as method call) will come out of it all &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465547" author="blackdrag" created="Sun, 16 Nov 2008 11:26:01 +0000"  >&lt;p&gt;I edited the generated code example, because the page width was totally broken&lt;/p&gt;</comment>
                            <comment id="14465648" author="blackdrag" created="Sun, 16 Nov 2008 12:23:13 +0000"  >&lt;p&gt;I did probably now explain well enough... in the original test in &quot;this.test+=10&quot; the &quot;this.test&quot; was a PropertyExpression, which is correct, but the implicitThis was set to false... that is the first thing that needs to be fixed here. I confirmed that that bug is still present by using the debugger. &lt;/p&gt;

&lt;p&gt;What I did oversee before is that you don&apos;t do isExplicitThisInClosure, but !isExplicitThisInClosure. When you do isThisExpression(expression) &amp;amp;&amp;amp; isInClosure() &amp;amp;&amp;amp; !implicitThis and for this.test in a closure we have a this-expression, with implicitThis set to false, then it matches exactly that case and could be seen as a fix in some way. But what you are testing here is a condition that is already wrong.&lt;/p&gt;

&lt;p&gt;At last part of the fix has to be to set the implicitThis right, or else it might cause problems elsewhere. I am also positive that further changes to ACG are not required then anymore.&lt;/p&gt;</comment>
                            <comment id="14465626" author="roshandawrani" created="Sun, 16 Nov 2008 23:35:17 +0000"  >&lt;p&gt;I looked at it a bit more and there are a few things. I apologize for the longish mail but couldn&apos;t cut down much.:&lt;/p&gt;

&lt;p&gt;1)  I don&apos;t see the bug that you see in setting of &quot;implicitThis&quot; for &quot;this.test+=10&quot;.&lt;br/&gt;
    I have attached the generated AST xml for the original test case and here is how the c2 statements come up:&lt;br/&gt;
    a)  this.test+=10   =&amp;gt; BinaryExp [PropertyExp&lt;/p&gt;
{implicitThis = false}, ConstantExp] - Correct because for explicit this, implicitThis should be false.&lt;br/&gt;
    b)  test = 3        =&amp;gt; BinaryExp &lt;span class=&quot;error&quot;&gt;&amp;#91;VariableExp, ConstantExp&amp;#93;&lt;/span&gt; - Correct. VariableExp does not carry implicitThis information. Anyway, it can be a local variable too and not necessarily this.var or super.var.&lt;br/&gt;
    c)  return this.test=&amp;gt; PropertyExp{implicitThis = false}
&lt;p&gt; - Correct because of explicit this.&lt;/p&gt;

&lt;p&gt;    You said &quot;in the original test in &quot;this.test+=10&quot; the &quot;this.test&quot; was a PropertyExpression, which is correct, but the implicitThis was set to false... that is the first thing that needs to be fixed here.&quot; - Why is it implicitThis=false wrong for &quot;this.test += 10&quot;, and why does not it need to be fixed?&lt;/p&gt;

&lt;p&gt;2)  The phase where &quot;PropertyExp.isImplcitThis = true&quot; comes from -&amp;gt;&lt;/p&gt;

&lt;p&gt;    Currently it happens in classgen phase and in ACG(visitVariableExpression()). When ACG visits VariableExp, if the variable is not defined on stack, it maps VariableExp to a PropertyExp&lt;span class=&quot;error&quot;&gt;&amp;#91;implicitThis = true&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;You say that phases earlier than &quot;classgen&quot; may need the &quot;implicitThis = true&quot; information. It may be correct to move &quot;mapping of VariableExp to PropertyExp&lt;span class=&quot;error&quot;&gt;&amp;#91;implicitThis = true&amp;#93;&lt;/span&gt;&quot; to a phase earier than classgen so that other phases can utilize this information but that is a design change that is not related to/needed by current bug (because current bug has nothing to do with wrong/late (in terms of phases) setting of implicitThis). If it should be moved to an earlier phase, it should probably be taken as a different exercise.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;3)  So, as far as I see and understand, there is no issue with value of implicitThis for any c2 statement. If that is correct, ACG will need a change because it can not generate bytecode for &quot;this.&amp;lt;prop&amp;gt;&quot; to always access a class(or parent) level declared field. It can not do it if &quot;this.&amp;lt;prop&amp;gt;&quot; is happening within a closure with implicitThis = false (in this case, it should access outermost class that contains the closures), which is exactly what I have fixed. So, I think ACG will need a change to differentiate between &quot;closure&lt;span class=&quot;error&quot;&gt;&amp;#91;implicitThis = false&amp;#93;&lt;/span&gt;&quot; and &quot;all other cases&quot;. But let us wait and see.&lt;/p&gt;

&lt;p&gt;Let&apos;s first get it out of the way if implicitThis value setting has any problem or not. Everything related to current bug and fix dependes on this assumption.&lt;/p&gt;</comment>
                            <comment id="14465677" author="blackdrag" created="Mon, 17 Nov 2008 05:27:39 +0000"  >&lt;p&gt;true, the xml shows that the implicitThis is set correctly.. but I assure you, that once ACG is reached, the implicitThis is changed! I confirmed that multiple times using the debugger. Your patch would not work if it where different. The AST is transformed multiple times and I think what you get in the XML is only the initial AST. For example the VariableExpression variables do not refer to a defined variable originating from a Parameter or DeclarationExpression.&lt;/p&gt;

&lt;p&gt;If in your code you write &quot;this.test&quot;, then the implicitThis field has to be set to true. That is because we wrote &quot;this&quot;, so the &quot;this&quot; is explicit and not implicit. Transformations may produce the same thing, but with an implicitThis set to true, which has a different semantic. With an explicit &quot;this&quot; we want to access the surrounding class, not the closure, with the implicit &quot;this&quot; we have to go through the lookup mechanisms at runtime, unless we reference a local variable.&lt;/p&gt;

&lt;p&gt;Now you say ACG is doing that transformation.. that&apos;s 2898... oh my... now I have to look why it was added in this way... hmm... rev 4287.. frankly I think that is just wrong. We are trying to process a class variable, so using the implicit this is quite questionable... I think that line should probably set the implicit this to false..&lt;/p&gt;

&lt;p&gt;I think now, that the whole usage of implicitThis in PropertyExpression should be... well, ignored in 1.5, deprecated in 1.6 and removed in 1.7.. that is if ignoring the implicit this in ACG does solve the issue.&lt;/p&gt;
</comment>
                            <comment id="14465649" author="roshandawrani" created="Mon, 17 Nov 2008 05:51:18 +0000"  >&lt;p&gt;I am sorry but I think you are understanding the implicitThis in just the opposite and that is causing all the confusion. Once that is in sync, all other things will fall in place and it&apos;ll be clear that issue has 0% relation to implicitThis value being set incorrectly. And then it should look like a simple bug that can be fixed in all versions easily &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;You are saying &quot;If in your code you write &quot;this.test&quot;, then the implicitThis field has to be set to true. That is because we wrote &quot;this&quot;, so the &quot;this&quot; is explicit and not implicit.&quot; &lt;br/&gt;
    -&amp;gt; Because we wrote &quot;this&quot;, this is explicit, and not implicit, that is why implicitThis should be false.&lt;/p&gt;

&lt;p&gt;For &quot;this.test = 10&quot; -&amp;gt; implicitThis should never be true - whether in initial AST or after all the transformations. It is never becoming true - neither in initial AST, nor in any transformation of AST.&lt;/p&gt;

&lt;p&gt;For &quot;test = 10&quot;, initial AST does not have any implicitThis information (as it is a VariableExpression). ACG (in classgen phase) sets implicitThis to true by mapping the VariableExpression to PropertyExpression (unless it is a reference to a local variable). ACG must write implicitThis to true here and not false (because it is processing &quot;test = 10&quot;). Making it implicitThis=true makes ACG access class level variable.&lt;/p&gt;

&lt;p&gt;The only mistake in the whole thing is in ACG when it is writing the bytecode for &quot;this.test = 10&quot;. It is not checking whether it is doing it within a closure or not. It&apos;s an issue as simple as this.&lt;/p&gt;</comment>
                            <comment id="14465668" author="blackdrag" created="Mon, 17 Nov 2008 06:31:17 +0000"  >&lt;p&gt;I feel as if I told you kind of rubbish most of the time. Sorry for that.&lt;/p&gt;

&lt;p&gt;Still I don&apos;t feel good about the implicitThis. Normally if we do &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;class {
  void foo() {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.x
    y
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; then this.x should be a property expression with the implicitThis set to false... which it is. Now the problem is, that y is not a PropertyExpression, so it can not have the implicitThis. Since y is no local variable in the compileStack, it will produce a PropertyExpression with &quot;this.y&quot; where implicitThis is true. And well, that is totally correct! so there is really no bug with the implciitThis. I guess I got confused by the fact, that we are not in a normal class, but in a closure, where local variables referenced from the outside are actually fields of the current class. I mean I mostly wrote that by myself, still I forgot.&lt;/p&gt;

&lt;p&gt;So from the view of c2 which was &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;c2 = {

            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.test+=10

            test = 3

            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.test

}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; we actually have something like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;c2 {
  Reference test
  call() {
    Groovy2849Bug_instance.test+=10 &lt;span class=&quot;code-comment&quot;&gt;//setProperty+getProperty logic
&lt;/span&gt;    test = 3
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Groovy2849Bug_instance.test &lt;span class=&quot;code-comment&quot;&gt;//getProperty logic
&lt;/span&gt;  }  
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; So using implciitThis==true for &quot;test=3&quot; is ok. The implicitThis is in fact needed to make a difference between simply &quot;test&quot; and &quot;this.test&quot;, because the names are equal.... ah well, so be it.&lt;/p&gt;

&lt;p&gt;Still I would change the patch... first remove the negation in the if, better build the negation into the method we call... so isNotExplipicitThisInClosure... next is... we already have checked with isThisOrSuper that we are on a this or super. In case of super the implicit this is of course false, so checking for &quot;this&quot; is needed, no change here... but maybe we could change the order a bit. Let us first check the implicitThis, then the Closure and then this, because in that order the checks are less expensive for many cases.... isNotExplipicitThisInClosure would then be: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isNotExplipicitThisInClosure(Expression expression, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; implicitThis) {
   	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; implicitThis || !isInClosure || !isThisExpression(expression);
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And maybe I should add some comments to give me a hint what happens here, so I won&apos;t fall into the same trap again next time!&lt;/p&gt;</comment>
                            <comment id="14465549" author="roshandawrani" created="Mon, 17 Nov 2008 08:49:07 +0000"  >&lt;p&gt;Thank you.&lt;/p&gt;

&lt;p&gt;With so much on your plate, I am sure it is only natural to forget some details as their origin moves farther into past.&lt;/p&gt;

&lt;p&gt;I am glad that I&apos;ll probably now have a tiny fingerprint on ACG. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I will make the negation related changes, test it with all 3 versions (1.5.8, 1.6, and 1.7) and re-attach the patches.&lt;/p&gt;

&lt;p&gt;Shall I also now include the fix for this same issue for method calls (ACG -&amp;gt; visitMethodCallExpression())?&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465615" author="blackdrag" created="Mon, 17 Nov 2008 10:05:28 +0000"  >&lt;p&gt;Since the fix for this does not fix the other issue automatically we should probably split both issues and make a new one for the method call problem. We may also need further discussion on the fix... depends on the fix, so having a new fix should make things a bit more easy and allows us to close this issue here without thinking about the other issue.&lt;/p&gt;</comment>
                            <comment id="14465603" author="roshandawrani" created="Mon, 17 Nov 2008 11:55:21 +0000"  >&lt;p&gt;I have re-attached the fix patches for this issue as per the latest discussions till this point - moving the condition negation inside the helper method and reversing the order of conditions.&lt;/p&gt;

&lt;p&gt;I have tested the fix with all 1.5.8, 1.6-RC1 and 1.7-beta-1 versions.&lt;/p&gt;

&lt;p&gt;Also, from isNotExplicitThisInClosure(), I have removed the use of isThisExpression() as this condition is already met in visitAttributeOrProperty().&lt;/p&gt;

&lt;p&gt;Also, as suggested, for the similar issue found with method calls, I have opened a separate bug (&lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-3156&quot; title=&quot;Within a nested closure, &amp;quot;this.method()&amp;quot; works incorrectly if parent closure and outermost class have closures/methods of the same name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-3156&quot;&gt;&lt;del&gt;GROOVY-3156&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465669" author="roshandawrani" created="Mon, 17 Nov 2008 12:05:27 +0000"  >&lt;p&gt;Re-attaching the test case too - removed the testing of method call interference from it as it has its JIRA item now. Moved that test in its JIRA.&lt;/p&gt;</comment>
                            <comment id="14465892" author="roshandawrani" created="Wed, 10 Dec 2008 23:47:50 +0000"  >&lt;p&gt;Fixed by correcting the issue related to property resolution inside a nested closure.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12814455">GROOVY-3156</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12721974" name="2849Patch_v2.zip" size="1636" author="roshandawrani" created="Mon, 17 Nov 2008 11:55:21 +0000"/>
                            <attachment id="12721795" name="Groovy2849Bug.groovy" size="264" author="chanwit" created="Wed, 21 May 2008 03:27:07 +0000"/>
                            <attachment id="12720979" name="Groovy2849BugAST.groovy.xml" size="43905" author="roshandawrani" created="Sun, 16 Nov 2008 23:35:17 +0000"/>
                            <attachment id="12721712" name="Groovy2849Bug_v2.groovy" size="823" author="roshandawrani" created="Mon, 17 Nov 2008 12:05:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2cro7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12312220" key="com.atlassian.jira.plugin.system.customfieldtypes:radiobuttons">
                        <customfieldname>Testcase included</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="11060"><![CDATA[Yes]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>