<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:26:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5428] Performance problem: ClassCastExceptions are created in normal execution flow which kills performance</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5428</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;This problem is a major performance bottleneck in Grails 2.0 applications. &lt;br/&gt;
Currently this problem shows up when resources plugin has been installed and used in a Grails app. (see attached screenshot)&lt;/p&gt;

&lt;p&gt;Exceptions are relatively heavy weight in Java. Filling the stacktrace takes most of the time. Normal execution flow should never throw exceptions.&lt;br/&gt;
(it is possible to disable filling the stacktrace like has been done for MissingMethodExceptionNoStack, in that case the performance overhead is usually acceptable.)&lt;/p&gt;

&lt;p&gt;The problem shows up whenever there is 2 classes sharing the same base class and when the other class is a Java class and the other one is a Groovy class (GroovyObject). &lt;/p&gt;

&lt;p&gt;I was able to reproduce the problem with this code. Run this code in a debugger and make a breakpoint for the construction of ClassCastException.&lt;br/&gt;
In this example the base class is java.util.Map , the Java class is LinkedHashMap and the Groovy class is MyMap (extends LinkedHashMap).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ClassCastProblem {
    def doCalls() {
        def m1=[abc:&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;]
        def m2=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyMap()
        doSomething(m1)
        doSomething(m2)
        doSomething(m1)
        doSomething(m2)
        doSomething(m1)
    }
    
    void doSomething(m) {
        m.remove(&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;)
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        def ccp=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassCastProblem()
        ccp.doCalls()
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyMap &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; LinkedHashMap {
    
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In a Grails app the 2 different java.util.Map implementations usually triggering this problem are LinkedHashMap and GrailsParameterMap (GroovyObject).&lt;/p&gt;

&lt;p&gt;In Grails core I&apos;ve worked around some of the problem with this type of hack:&lt;br/&gt;
&lt;a href=&quot;https://github.com/grails/grails-core/commit/62626921ebd80e3cdeb9776fd79be7eb92f88763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grails/grails-core/commit/62626921ebd80e3cdeb9776fd79be7eb92f88763&lt;/a&gt;&lt;br/&gt;
At that time I didn&apos;t have time to investigate the reason that caused the problem and just made some changes until the problem went away.&lt;/p&gt;
</description>
                <environment>Grails 2.0.3 + Groovy 1.8.6</environment>
        <key id="12816228">GROOVY-5428</key>
            <summary>Performance problem: ClassCastExceptions are created in normal execution flow which kills performance</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="lhotari">Lari Hotari</reporter>
                        <labels>
                    </labels>
                <created>Sat, 28 Apr 2012 00:55:29 +0000</created>
                <updated>Fri, 4 May 2012 10:47:14 +0000</updated>
                            <resolved>Fri, 4 May 2012 10:47:14 +0000</resolved>
                                    <version>1.8.6</version>
                                    <fixVersion>2.0-beta-3</fixVersion>
                    <fixVersion>1.8.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14472655" author="lhotari" created="Sat, 28 Apr 2012 03:43:36 +0000"  >&lt;p&gt;Example with Lists &amp;amp; find:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ClassCastProblem2 {
    def doCalls() {
        def l1=[&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;c&apos;&lt;/span&gt;]
        def l2=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyList()
        doSomething(l1)
        doSomething(l2)
        doSomething(l1)
        doSomething(l2)
        doSomething(l1)
    }
    
    void doSomething(l) {
        l.find { 
            it
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        def ccp=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassCastProblem2()
        ccp.doCalls()
        println(&lt;span class=&quot;code-quote&quot;&gt;&apos;done&apos;&lt;/span&gt;)
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyList &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ArrayList {
    
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem shows up also with DGM methods.&lt;/p&gt;</comment>
                            <comment id="14472739" author="blackdrag" created="Mon, 30 Apr 2012 07:56:09 +0000"  >&lt;p&gt;The code in the checkCall method more or less is that:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; usage.get() == 0
               &amp;amp;&amp;amp; ((GroovyObject)receiver).getMetaClass() == metaClass &lt;span class=&quot;code-comment&quot;&gt;// metaClass still be valid
&lt;/span&gt;               &amp;amp;&amp;amp; MetaClassHelper.sameClasses(params, args); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If that is causing a ClassCastException, then because receiver is no longer a GroovyObject. In cases in which the receiver does not change all the time from Groovy class to Java class and back, this code is surely better than having and additional instanceof in there. With a more sophisticated caching we could recognize this case and add such a check only in the all so often changing case, maybe even keeping the old callsite and switching between those two. That would surely improve performance. But the caching does not give that kind of logic. If we include the check all method invocations based on GroovyObject will be slower, but that is not all. Even with the check your program has a problem, since it will cause the creation of a new call site every time. What I am trying to tell you is, that even if we add that check the performance of that program will stay bad. The Call site generation takes much more time than the ClassCastException.&lt;/p&gt;</comment>
                            <comment id="14472697" author="lhotari" created="Mon, 30 Apr 2012 10:16:33 +0000"  >&lt;p&gt;I&apos;ve previously provided 2 code examples where the receiver changes from Groovy class to Java class and back.&lt;/p&gt;

&lt;p&gt;This happens very often in Grails applications. Usually it happens in Grails with java.util.Map methods (Map implementations LinkedHashMap, GroovyPageAttributes and GrailsParameterMap). The popular Grails resources plugin reproduces this problem too.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The Call site generation takes much more time than the ClassCastException.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So the call site generation might be even a larger bottleneck? I hope this issue gets fixed asap since it affects all Grails 2.0 applications that use the resources plugin.&lt;/p&gt;</comment>
                            <comment id="14472741" author="blackdrag" created="Wed, 2 May 2012 18:08:17 +0000"  >&lt;p&gt;call site generation means a certain overhead, if you do it all the time, then it becomes a performance problem. The problem is, there is no fast fix for this issue.&lt;/p&gt;</comment>
                            <comment id="14472767" author="lhotari" created="Thu, 3 May 2012 00:34:26 +0000"  >&lt;p&gt;I think we could eliminate the ClassCastException. That&apos;s causing the overhead in this case and that could be fixed. The call site generation is only instantiating a pre-generated call site class and I don&apos;t believe that&apos;s expensive. The old call site instance gets replaced also when one of the parameter class changes so that&apos;s business as usual. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;d replace &quot;((GroovyObject)receiver).getMetaClass() == metaClass&quot; with &quot;receiver.getClass() == metaClass.getTheClass()&quot; (used in PojoMetaMethodSite). Do you think that&apos;s ok?&lt;/p&gt;


</comment>
                            <comment id="14472839" author="lhotari" created="Thu, 3 May 2012 12:57:39 +0000"  >&lt;p&gt;This isn&apos;t a major performance issue. I did some benchmarking.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ClassCastProblem {
    def doCalls() {
        def m1=[abc:&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;]
        def m2=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyMap()

	println &lt;span class=&quot;code-quote&quot;&gt;&quot;Warmup...&quot;&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i &amp;lt; 100000;i++) {	
           doSomething(m1)
           doSomething(m2)
	}
	println &lt;span class=&quot;code-quote&quot;&gt;&quot;Starting...&quot;&lt;/span&gt;
	&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; start=&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()
	&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i &amp;lt; 10000000;i++) {
           doSomething(m1)
           doSomething(m2)
	   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(i%1000==0) print &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt;
        }
	&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; duration=&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()-start
	println &lt;span class=&quot;code-quote&quot;&gt;&quot;Duration ${duration} ms&quot;&lt;/span&gt;
    }
    
    void doSomething(m) {
        m.remove(&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;)
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        def ccp=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassCastProblem()
        ccp.doCalls()
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyMap &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; LinkedHashMap {
    
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14472810" author="blackdrag" created="Thu, 3 May 2012 18:36:36 +0000"  >&lt;p&gt;the generated call site is kept? I forgot that... and it does not go through method selection anymore then? Lari, as for your test... with what do you compare these numbers?&lt;/p&gt;

&lt;p&gt;Then about comparing the class instead of the meta class. The call site becomes invalid if the receiver meta class is not what we expect. GroovyObject means per instance meta classes are supported and that can mean any receiver can have a different meta class, even the same receiver at a later point. That&apos;s why ensuring the meta class is the same is a requirement. &lt;/p&gt;</comment>
                            <comment id="14472742" author="lhotari" created="Thu, 3 May 2012 22:51:27 +0000"  >&lt;p&gt;Yes, it&apos;s kept in CachedMethod:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; SoftReference&amp;lt;Constructor&amp;gt; pogoCallSiteConstructor, pojoCallSiteConstructor, staticCallSiteConstructor;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I benchmarked against a version of checkCall where I added &quot;receiver.getClass() == metaClass.getTheClass()&quot; to prevent the ClassCastException:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;              &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !GroovyCategorySupport.hasCategoryInCurrentThread()
+               &amp;amp;&amp;amp; receiver.getClass() == metaClass.getTheClass()
                &amp;amp;&amp;amp; ((GroovyObject)receiver).getMetaClass() == metaClass &lt;span class=&quot;code-comment&quot;&gt;// metaClass still be valid
&lt;/span&gt;                &amp;amp;&amp;amp; MetaClassHelper.sameClasses(params, args);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The timings were 6500ms (1.8.6) compared to 5250ms (patched) so this is not a performance bottleneck . That&apos;s with 10 million iterations. It will improve performance, but it&apos;s not a big change.&lt;/p&gt;

&lt;p&gt;I&apos;ll also attach a patch if anyone wants to apply it.&lt;/p&gt;</comment>
                            <comment id="14472792" author="lhotari" created="Thu, 3 May 2012 22:56:18 +0000"  >&lt;p&gt;The generated call sites can get GCed since it&apos;s a SoftReference in CachedMethod that keeps the reference of a generated call site. That might be a problem under memory pressure.&lt;/p&gt;
</comment>
                            <comment id="14472768" author="blackdrag" created="Fri, 4 May 2012 05:01:35 +0000"  >&lt;p&gt;The performance improvement will be much less if you replace the cast with an instanceof and cast, followed by getting the metaclass, instead of calling the intrinsic getClass() method.&lt;/p&gt;

&lt;p&gt;Even if the methods are cached, there is still the issue with having to go through method selecton every time. I was asking what you compare with, because the reference should be the case with cached method calls (ie only m2 and no m1). And there I expect like half the time needed, if not less.&lt;/p&gt;</comment>
                            <comment id="14472658" author="blackdrag" created="Fri, 4 May 2012 06:18:28 +0000"  >&lt;p&gt;Lari, I added the instanceof check for now. Should we close the issue with that?&lt;/p&gt;</comment>
                            <comment id="14472734" author="lhotari" created="Fri, 4 May 2012 07:00:07 +0000"  >&lt;p&gt;Yes it&apos;s ok to close this one.&lt;/p&gt;

&lt;p&gt;btw. I wonder if the SoftReference pogoCallSiteConstructor and pojoCallSiteConstructor fields of CachedMethod could get GCed under memory pressure and that would cause CachedMethod to generate a new callsite class (bytecode) for the same method (if the callsite gets swapped). I&apos;ve never seen that happen but that possible problem came into mind.&lt;/p&gt;


</comment>
                            <comment id="14472749" author="blackdrag" created="Fri, 4 May 2012 10:46:36 +0000"  >&lt;p&gt;can they be GCed? well.... in a test like yours unlikely, because there is no or almost no object creation between the method calls and during the method call it surely will not happen, since the object is &quot;in use&quot;. But after a while, or after lots of memory usage this can happen, yes. And yes, the swapped out call site is even more likely to be collected. But without the SoftReference the ChachedClass object would just become bigger and then we would not only have to create the call site again, we would also have to create the cached class again.&lt;/p&gt;</comment>
                            <comment id="14472793" author="blackdrag" created="Fri, 4 May 2012 10:47:14 +0000"  >&lt;p&gt;fixed with the instanceof check only&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722650" name="0001-Fix-for-GROOVY-5428-Eliminate-ClassCastExceptions.patch" size="3670" author="lhotari" created="Thu, 3 May 2012 22:51:50 +0000"/>
                            <attachment id="12722993" name="Debug - org.codehaus.groovy.runtime.callsite.CallSiteArray - SpringSource Tool Suite - -home-lari-workspace-grails _030.jpg" size="424871" author="lhotari" created="Sat, 28 Apr 2012 00:55:29 +0000"/>
                            <attachment id="12723023" name="IsolatedTomcat-2012-04-27-shutdown.snapshot [-home-lari-Snapshots] - YourKit Java Profiler 9.0.9_027.jpg" size="270286" author="lhotari" created="Sat, 28 Apr 2012 00:55:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c3cf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>