<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:56:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-8288] [Sql] withBatch fails when batchSize == number of addBatch call</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-8288</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;&lt;tt&gt;Sql.withBatch(batchSize, ..)&lt;/tt&gt; calls &lt;tt&gt;delegate.executeBatch()&lt;/tt&gt; both when batchCount reaches batchSize, and at the end of the method (after the call to the &quot;batch statement&quot; closure).&lt;/p&gt;

&lt;p&gt;Thus, if the number of &lt;tt&gt;addBatch()&lt;/tt&gt; calls in the closure is exactly the same as, or a multiple of &lt;tt&gt;batchSize&lt;/tt&gt;, one too much call to &lt;tt&gt;executeBatch()&lt;/tt&gt; is made : nothing has been added to the batch.&lt;br/&gt;
Which, at least with HSQLDB 2.4.0, leads to a SQLException on that very last call.&lt;/p&gt;

&lt;p&gt;Test to reproduce (compliant with SqlBatchTest)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;void testWithBatchSizeHavingSizeSameSizeAsStatements() {
    def numRows = sql.rows(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM PERSON&quot;&lt;/span&gt;).size()
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; numRows == 3
    def myOthers = [&lt;span class=&quot;code-quote&quot;&gt;&apos;f4&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;l4&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;f5&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;l5&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;f6&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;l6&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;f7&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;l7&apos;&lt;/span&gt;]
    def result = sql.withBatch(myOthers.size(), &lt;span class=&quot;code-quote&quot;&gt;&quot;insert into PERSON (id, firstname, lastname) values (?, ?, ?)&quot;&lt;/span&gt;) { ps -&amp;gt;
        myOthers.eachWithIndex { k, v, index -&amp;gt;
            def id = index + numRows + 1
            ps.addBatch(id, k, v)
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; result == [1] * myOthers.size()
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; sql.rows(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM PERSON&quot;&lt;/span&gt;).size() == numRows + myOthers.size()
    &lt;span class=&quot;code-comment&quot;&gt;// end result the same as &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no batching was in place but logging should show:
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// FINE: Successfully executed batch with 4 command(s)
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13094538">GROOVY-8288</key>
            <summary>[Sql] withBatch fails when batchSize == number of addBatch call</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="akapps">Antoine Kapps</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Aug 2017 17:19:28 +0000</created>
                <updated>Fri, 15 Sep 2017 16:45:58 +0000</updated>
                            <resolved>Fri, 15 Sep 2017 16:45:57 +0000</resolved>
                                    <version>2.5.0-beta-1</version>
                    <version>2.4.12</version>
                                    <fixVersion>3.0.0-alpha-1</fixVersion>
                    <fixVersion>2.5.0-beta-2</fixVersion>
                    <fixVersion>2.4.13</fixVersion>
                    <fixVersion>2.6.0-alpha-2</fixVersion>
                                    <component>SQL processing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16126903" author="githubbot" created="Tue, 15 Aug 2017 07:51:49 +0000"  >&lt;p&gt;GitHub user akapps opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/586&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8288&quot; title=&quot;[Sql] withBatch fails when batchSize == number of addBatch call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8288&quot;&gt;&lt;del&gt;GROOVY-8288&lt;/del&gt;&lt;/a&gt; executeBatch() should not be called with batchCount == 0&lt;/p&gt;

&lt;p&gt;    This is a first proposition of resolution for &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8288&quot; title=&quot;[Sql] withBatch fails when batchSize == number of addBatch call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8288&quot;&gt;&lt;del&gt;GROOVY-8288&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8288&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-8288&lt;/a&gt;).&lt;br/&gt;
    There still are open questions (see my comments on changes).&lt;/p&gt;

&lt;p&gt;    Thank you for your feedback.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/akapps/groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/akapps/groovy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8288&quot; title=&quot;[Sql] withBatch fails when batchSize == number of addBatch call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8288&quot;&gt;&lt;del&gt;GROOVY-8288&lt;/del&gt;&lt;/a&gt;-execute-batch&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/586.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/586.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #586&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7af055833f82606b12db5d66834ff1a4beaace2a&lt;br/&gt;
Author: Antoine Kapps &amp;lt;antoine.kapps@orange.fr&amp;gt;&lt;br/&gt;
Date:   2017-08-15T07:42:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-8288&quot; title=&quot;[Sql] withBatch fails when batchSize == number of addBatch call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-8288&quot;&gt;&lt;del&gt;GROOVY-8288&lt;/del&gt;&lt;/a&gt; executeBatch() should not be called with batchCount == 0&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16126906" author="githubbot" created="Tue, 15 Aug 2017 07:54:48 +0000"  >&lt;p&gt;Github user akapps commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/586#discussion_r133134481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/586#discussion_r133134481&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: subprojects/groovy-sql/src/main/java/groovy/sql/BatchingStatementWrapper.java &amp;#8212;&lt;br/&gt;
    @@ -83,8 +83,15 @@ public void clearBatch() throws SQLException {&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         public int[] executeBatch() throws SQLException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;int[] lastResult = delegate.executeBatch();&lt;/li&gt;
	&lt;li&gt;processResult(lastResult);&lt;br/&gt;
    +        if (batchCount &amp;gt; 0) 
{
    +            int[] lastResult = delegate.executeBatch();
    +            processResult(lastResult);
    +        }
&lt;p&gt;    +        else if (results.isEmpty()) &lt;/p&gt;
{
    +            log.warning(&quot;Nothing has been added to batch&quot;);
    +            // we let the JDBC provider decide how to handle an empty batch execution
    +            return delegate.executeBatch();
    +        }
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This &quot;else if&quot; is not really elegant for such a particular case...&lt;br/&gt;
    I could have done `if (batchCount &amp;gt; 0 || results.isEmpty())` in the first condition, but I thought it made the intention unreadable.&lt;/p&gt;</comment>
                            <comment id="16126910" author="githubbot" created="Tue, 15 Aug 2017 07:59:36 +0000"  >&lt;p&gt;Github user akapps commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/586#discussion_r133135254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/586#discussion_r133135254&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: subprojects/groovy-sql/src/test/groovy/groovy/sql/SqlBatchTest.groovy &amp;#8212;&lt;br/&gt;
    @@ -119,6 +121,44 @@ class SqlBatchTest extends GroovyTestCase &lt;/p&gt;
{
             // FINE: Successfully executed batch with 1 command(s)
         }

&lt;p&gt;    +    void testWithBatchHavingSizeSameSizeAsStatements() {&lt;br/&gt;
    +        def numRows = sql.rows(&quot;SELECT * FROM PERSON&quot;).size()&lt;br/&gt;
    +        assert numRows == 3&lt;br/&gt;
    +        def myOthers = &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;f4&amp;#39;:&amp;#39;l4&amp;#39;,&amp;#39;f5&amp;#39;:&amp;#39;l5&amp;#39;,&amp;#39;f6&amp;#39;:&amp;#39;l6&amp;#39;,&amp;#39;f7&amp;#39;:&amp;#39;l7&amp;#39;&amp;#93;&lt;/span&gt;&lt;br/&gt;
    +        def result = sql.withBatch(myOthers.size(), &quot;insert into PERSON (id, firstname, lastname) values (?, ?, ?)&quot;) { ps -&amp;gt;&lt;br/&gt;
    +            myOthers.eachWithIndex &lt;/p&gt;
{ k, v, index -&amp;gt;
    +                def id = index + numRows + 1
    +                ps.addBatch(id, k, v)
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        assert result == &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; * myOthers.size()&lt;br/&gt;
    +        assert sql.rows(&quot;SELECT * FROM PERSON&quot;).size() == numRows + myOthers.size()&lt;br/&gt;
    +        // end result the same as if no batching was in place but logging should show:&lt;br/&gt;
    +        // FINE: Successfully executed batch with 4 command(s)&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    void testWithBatchNothingSpecified() {&lt;br/&gt;
    +        def numRows = sql.rows(&quot;SELECT * FROM PERSON&quot;).size()&lt;br/&gt;
    +        assert numRows == 3&lt;br/&gt;
    +&lt;br/&gt;
    +        def msg = GroovyAssert.shouldFail {&lt;br/&gt;
    +            sql.withBatch(3, &quot;insert into PERSON (id, firstname, lastname) values (?, ?, ?)&quot;) &lt;/p&gt;
{ ps -&amp;gt;
    +                // Do nothing - not a good practice at all...
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        System.err.println(msg)&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    void testWithBatchNoPreparedStatementNothingSpecified() {&lt;br/&gt;
    +        def numRows = sql.rows(&quot;SELECT * FROM PERSON&quot;).size()&lt;br/&gt;
    +        assert numRows == 3&lt;br/&gt;
    +&lt;br/&gt;
    +        def result = sql.withBatch &lt;/p&gt;
{ ps -&amp;gt;
    +            // Do nothing - not a good practice at all...
    +        }
&lt;p&gt;    +        assert result == [] as int[]&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It is quite surprising at first sight that HSQL driver behaves differently if `executeBatch()` is called with nothing added to the batch, whether a preparedStatement is used or not.&lt;/p&gt;

&lt;p&gt;    I felt like it&apos;s not Groovy responsibility to &quot;suppress&quot; the exception for the preparedStatement case, and I wanted to test-specify those 2 behaviours as they are the current ones.&lt;/p&gt;</comment>
                            <comment id="16168156" author="githubbot" created="Fri, 15 Sep 2017 16:41:30 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/groovy/pull/586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/pull/586&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16168162" author="daniel_sun" created="Fri, 15 Sep 2017 16:45:58 +0000"  >&lt;p&gt;Thanks for your patch!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3irpb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>