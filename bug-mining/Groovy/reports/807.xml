<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:08:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-3135] Incorrect array type created when calling vararg method</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-3135</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have a constructor:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Foo( &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; foo, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; bar, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;... values )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in groovy, i am calling it with a String, a Long, and an Integer.&lt;/p&gt;

&lt;p&gt;ParameterTypes.fitToVarArgs correctly determines that the array is a Double.&lt;/p&gt;

&lt;p&gt;however, when MetaClassHelper.makeArray is called, it does:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; baseClass = secondary;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (obj != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            baseClass = obj.getClass();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which overrides the Double.class that is secondary, with Integer.class from the incoming value.&lt;/p&gt;

&lt;p&gt;The constructor invocation then fails since the correct type was not passed.&lt;/p&gt;</description>
                <environment>using groovy via gmaven-runtime-default 1.0-rc-3</environment>
        <key id="12814438">GROOVY-3135</key>
            <summary>Incorrect array type created when calling vararg method</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshandawrani">Roshan Dawrani</assignee>
                                    <reporter username="proyal">Peter A Royal Jr.</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Nov 2008 23:28:19 +0000</created>
                <updated>Tue, 23 Dec 2008 05:58:07 +0000</updated>
                            <resolved>Sat, 6 Dec 2008 07:55:23 +0000</resolved>
                                    <version>1.5.6</version>
                                    <fixVersion>1.6-rc-1</fixVersion>
                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>1.7-beta-1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="14465515" author="roshandawrani" created="Mon, 10 Nov 2008 12:53:21 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
Attaching patches for the affected groovy versions and a test case.&lt;/p&gt;

&lt;p&gt;The fix is basically to make coercing of double-type arguments consistent between DoubleCachedClass and ArrayCachedClass. &lt;/p&gt;

&lt;p&gt;DoubleCachedClass allows all subclasses of java.lang.Number to be coerced into double type but ArrayCachedClass for varargs of double type allowed coercing only from float/double/BigDecimal types and not from other Number sub-classes and failed with &quot;argument type mismatch&quot; error.&lt;/p&gt;

&lt;p&gt;rgds,&lt;br/&gt;
Roshan&lt;/p&gt;</comment>
                            <comment id="14465749" author="blackdrag" created="Wed, 26 Nov 2008 09:03:54 +0000"  >&lt;p&gt;hmm... your fix does fix the problem, no doubt. But your test case made me think... 56.0 is a BigDecimal, no double. So a call with an array containing that should not succeed, because the BigDecimals might be bigger than the double. If you have mixed numbers in the arguments, then the array class will be Number... that is bad. It is bad, because with Number we don&apos;t know anything about if we should allow the number or not. If you give a BigDecimal into a double array, then this should cause an exception. I am aware, that if the array contains only BigDecimals, that then we will currently convert the array to a double array, but I come to think, that this is wrong.&lt;/p&gt;

&lt;p&gt;So fixing this issue might require a bit more than just this patch&lt;/p&gt;</comment>
                            <comment id="14465788" author="roshandawrani" created="Wed, 26 Nov 2008 11:41:40 +0000"  >&lt;p&gt;I think when I worked on it, I tried that it is on the similar lines as coercing of a argument to a double (as it happens in DoubleCachedClass.coerceArgument()). I thought if coercing for double array and a single double both are consistent, it should be ok.&lt;/p&gt;

&lt;p&gt;Coming to coercing of a argument to a double (DoubleCachedClass) - it does not simply reject the argument based on its type (if it is BigDecimal, let&apos;s say).&lt;/p&gt;

&lt;p&gt;Currently, what it does is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (argument &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; BigDecimal &amp;amp;&amp;amp; res.isInfinite()) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.class + &lt;span class=&quot;code-quote&quot;&gt;&quot; out of range &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; converting from BigDecimal&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you think, ArrayCachedClass, when handling coercing an array, which has mixed types of numbers, can be on the same lines - allowing an array element to be BigDecimal but rejecting it if it is infinitely large?&lt;/p&gt;

&lt;p&gt;If you can define how coercing to a double array should be done when a mixed types of numbers is passed, I can re-look into it.&lt;/p&gt;</comment>
                            <comment id="14465642" author="blackdrag" created="Wed, 26 Nov 2008 11:48:51 +0000"  >&lt;p&gt;The method to coerce a single double may do too much, but that s no problem if the method is not even selected. I think that maybe the idea to find a base class for all arguments is maybe  not good enough&lt;/p&gt;</comment>
                            <comment id="14465727" author="blackdrag" created="Thu, 27 Nov 2008 05:38:11 +0000"  >&lt;p&gt;after having a bit thought about it I think we should do the following:&lt;/p&gt;

&lt;p&gt;if the array component type we convert from is Number, then we know that got a mixed st of umbers that require coercion. This is a case special from the other cases so we can handle that different from all other cases. We could get the CachedClass for the goal component type and then call coerceArgument for each element of the argument array. I think we should not try restricting any conversion in this phase. The other advantage of this is, that we keep the coercion logic in the right Cached Class and do not spread conversions all over the place. &lt;/p&gt;

&lt;p&gt;Then there are other cases  as well... the argument array might be a Integer[], Long[], Byte[], Short[], Char[] or Float[].. and not to forget BigDecimal[] and BigInteger[]. But does it matter? I think the same logic applies then as if the array is a Number[]... again a per element conversion is needed. The method selection should have selected only elements we can convert from so extensive type checks before the conversion are not needed. &lt;/p&gt;

&lt;p&gt;Now... even though we have a CachedClass for for example double we use nearly the same logic as in Double, meaning coerceArgument will return a Double instead of a double. We unbox that right away, so first boxing and then unboxing again looks really like a waste of time. that&apos;s why we use the methods in DefaultTypeTransformation instead.&lt;/p&gt;

&lt;p&gt;The double conversion from BigDecimal there lacks the precision test, I think we should add that.&lt;/p&gt;

&lt;p&gt;ArrayCachedClass has code in the form &quot;if (paramComponent == boolean.class &amp;amp;&amp;amp; argumentClass == Boolean[].class) {&quot; and I think we can simply remove the &amp;amp;&amp;amp; part to fix the problem.&lt;/p&gt;

&lt;p&gt;Roshan, what do you think? I did no test run yet, it is just an idea&lt;/p&gt;</comment>
                            <comment id="14465793" author="roshandawrani" created="Sat, 6 Dec 2008 07:55:23 +0000"  >&lt;p&gt;Fixed by re-using the existing conversion logic in DefaultTypeTransformation for var-args of primitive types.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722011" name="3135Patch.zip" size="1700" author="roshandawrani" created="Mon, 10 Nov 2008 12:53:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 51 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c847:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>