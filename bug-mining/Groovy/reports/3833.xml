<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:07:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9588] groovyCompile 6x slower in 3.0.4 than 2.5.6</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9588</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;&lt;em&gt;It was suggested I open an issue here as well. I am a user of groovy so do not know a lot of the details that could help diagnose. I would be happy to gather them if told what was required.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/grails/grails-core/issues/11571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grails/grails-core/issues/11571&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We are upgrading a large Grails app with 400+ controllers, 550+ services, 350 domains, 4000 files with 950k loc to Grails 4.1.0.M1 + Gradle 5.6.4.&lt;/p&gt;

&lt;p&gt;Using Gradle 5.6.4 with Java 8 &amp;amp; Grails 4.0.3(Groovy 2.5) a clean/groovyCompile took approximately 5 minutes.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Using Gradle 5.6.4 with Java 11 &amp;amp; Grails 4.1.0.M1(Groovy 3.0.4) a &lt;tt&gt;clean&lt;/tt&gt;/&lt;tt&gt;groovyCompile&lt;/tt&gt; takes 33 minutes on a 2019 MBP w/ 2.4 GHz 8-Core Intel Core i9 &amp;amp; 64gb of RAM.&lt;/p&gt;

&lt;p&gt;I have tried giving the groovyCompile task 16/32gb of ram, with no noticeable change. I&apos;ve also tried -Dgroovy.antlr4=false - but this gave other compile time errors I did not see with it set to true (so was unable to have a full successful compile)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311159">GROOVY-9588</key>
            <summary>groovyCompile 6x slower in 3.0.4 than 2.5.6</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel_sun">Daniel Sun</assignee>
                                    <reporter username="erichelgeson">Eric Helgeson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jun 2020 15:38:38 +0000</created>
                <updated>Mon, 28 Feb 2022 15:20:44 +0000</updated>
                            <resolved>Thu, 25 Jun 2020 09:07:45 +0000</resolved>
                                    <version>3.0.4</version>
                                    <fixVersion>4.0.0-alpha-1</fixVersion>
                    <fixVersion>3.0.5</fixVersion>
                                    <component>parser-antlr4</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17144619" author="daniel_sun" created="Thu, 25 Jun 2020 03:35:58 +0000"  >&lt;p&gt;Antlr4 relies on DFA cache heavily for better parsing performance, but DFA cache is a global cache and may cause OOME if JVM heap is not enough, so we have an option to clear it if the threshold reaches: &lt;tt&gt;-Dgroovy.antlr4.cache.threshold=64&lt;/tt&gt;, the default threshold is &lt;tt&gt;64&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If you have set much JVM heap size, you could increase the threshold to greater value, e.g. &lt;tt&gt;-Dgroovy.antlr4.cache.threshold=50000&lt;/tt&gt;, which is much greater than the count of your groovy source files. That means the DFA cache will not be cleared during compiling.&lt;/p&gt;

&lt;p&gt;I wish the above suggestion could help you.&lt;/p&gt;</comment>
                            <comment id="17144626" author="daniel_sun" created="Thu, 25 Jun 2020 03:44:38 +0000"  >&lt;p&gt;See also &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-9589&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/GROOVY-9589&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17144627" author="daniel_sun" created="Thu, 25 Jun 2020 03:53:54 +0000"  >&lt;p&gt;After 3.0.5 released, you could try:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;-Dgroovy.parallel.parse=true&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;-Dgroovy.antlr4.cache.threshold=50000&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Before 3.0.5 released, you could try:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;-Dgroovy.antlr4.cache.threshold=50000&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17144773" author="daniel_sun" created="Thu, 25 Jun 2020 09:07:45 +0000"  >&lt;p&gt;Fixed by&#160;&lt;a href=&quot;https://github.com/apache/groovy/commit/9b46553475829800fb88d12088e53491c8d9b184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/groovy/commit/9b46553475829800fb88d12088e53491c8d9b184&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17144778" author="daniel_sun" created="Thu, 25 Jun 2020 09:11:20 +0000"  >&lt;p&gt;The above fix improve the parsing performance, but it change the fact that antlr4 relies on DFA cache(default threshold is &lt;tt&gt;64&lt;/tt&gt;). so after 3.0.5 released, you also could try:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;-Dgroovy.parallel.parse=true&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;-Dgroovy.antlr4.cache.threshold=50000&lt;/tt&gt; &lt;b&gt;OR&lt;/b&gt; &lt;tt&gt;-Dgroovy.antlr4.cache.threshold=0&lt;/tt&gt; (Note: &lt;tt&gt;0&lt;/tt&gt; means DFA cache will never be cleared)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Make sure your JVM heap size is big enough.&lt;/p&gt;</comment>
                            <comment id="17150306" author="erichelgeson" created="Thu, 2 Jul 2020 13:56:12 +0000"  >&lt;p&gt;It is much faster with a high threshold. 6 minutes vs 30+. Though the compile did us 10g of heap.&lt;/p&gt;

&lt;p&gt;Do you think the default of 64 is a bit low? I would think that would be hit by every project except the smallest.&lt;/p&gt;</comment>
                            <comment id="17150404" author="blackdrag" created="Thu, 2 Jul 2020 15:52:58 +0000"  >&lt;p&gt;My suggestion would be &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;number of files * 15
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But 50G heap? We must find a way to reduce that.&lt;/p&gt;
</comment>
                            <comment id="17151330" author="davydotcom" created="Sat, 4 Jul 2020 13:42:53 +0000"  >&lt;p&gt;Might I suggest we change the status of this jira as it&#8217;s not quite fully resolved yet. Needs probably some good defaults put in and possibly a review of heap usage. Thanks guys for focusing on compiler performance! Groovy is used is sooo many dynamic runtimes where quick compiles are critical&lt;/p&gt;</comment>
                            <comment id="17151365" author="daniel_sun" created="Sat, 4 Jul 2020 16:46:12 +0000"  >&lt;p&gt;Let me clarify the rationale of option &lt;tt&gt;groovy.antlr4.cache.threshold&lt;/tt&gt; as follows.&lt;/p&gt;

&lt;p&gt;For example: if the threshold is 200, DFA cache will be cleared when 200 groovy source files are parsed. Then the DFA cache will go on growing when more groovy source files are parsed. again, DFA cache will cleared when 200 groovy source files are parsed. &lt;b&gt;It is like a loop&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;So if heap size is enough, set &lt;tt&gt;-Dgroovy.antlr4.cache.threshold=0&lt;/tt&gt; (means never clearing DFA cache), or set &lt;tt&gt;-Dgroovy.antlr4.cache.threshold=&amp;lt;greater number&amp;gt;&lt;/tt&gt; if your machine do not have much memory, e.g. &lt;tt&gt;-Dgroovy.antlr4.cache.threshold=200&lt;/tt&gt;, then DFA cache will be cleared when threshold reaches. Note: The default threshold is &lt;tt&gt;64&lt;/tt&gt;&lt;/p&gt;
</comment>
                            <comment id="17151367" author="daniel_sun" created="Sat, 4 Jul 2020 16:54:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blackdrag&quot; class=&quot;user-hover&quot; rel=&quot;blackdrag&quot;&gt;blackdrag&lt;/a&gt; It&apos;s better that the threshold is set to less than the count of the groovy source files to parse, otherwise it is equal to setting to 0(never clearing DFA) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17151373" author="daniel_sun" created="Sat, 4 Jul 2020 17:06:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erichelgeson&quot; class=&quot;user-hover&quot; rel=&quot;erichelgeson&quot;&gt;erichelgeson&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davydotcom&quot; class=&quot;user-hover&quot; rel=&quot;davydotcom&quot;&gt;davydotcom&lt;/a&gt;&#160;We have been trying to improve the performance of the new Parrot parser, but there is no workaround for the DFA cache, which is the design of antlr4.&lt;/p&gt;

&lt;p&gt;Some years ago, I discussed with Sam Harwell(co-author of antlr4) about the issue that the DFA cache may cause OOME and I suggested to adjust the algorithm of caching, e.g. LRU, but the suggestion was evaluated as not feasible eventually. ( See also &lt;a href=&quot;https://github.com/antlr/antlr4/issues/499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/antlr/antlr4/issues/499&lt;/a&gt;&#160;)&lt;/p&gt;</comment>
                            <comment id="17151376" author="davydotcom" created="Sat, 4 Jul 2020 17:20:15 +0000"  >&lt;p&gt;That makes sense but we should have some sensible defaults such that we dont regress into a slower compile time if possible. I wonder if there are also other areas that could be optimized to further reduce overhead in compile time. I do know we actually had a slow down going from groovy 2.4 to 2.5 as well.&lt;/p&gt;</comment>
                            <comment id="17151678" author="daniel_sun" created="Sun, 5 Jul 2020 23:25:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davydotcom&quot; class=&quot;user-hover&quot; rel=&quot;davydotcom&quot;&gt;davydotcom&lt;/a&gt;&#160;See also&#160;&lt;a href=&quot;https://twitter.com/daniel_sun/status/1276625557615071232?s=20&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://twitter.com/daniel_sun/status/1276625557615071232?s=20&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17154631" author="emilles" created="Thu, 9 Jul 2020 14:36:16 +0000"  >&lt;p&gt;&amp;gt; &lt;a href=&quot;https://twitter.com/daniel_sun/status/1276625557615071232?s=20&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://twitter.com/daniel_sun/status/1276625557615071232?s=20&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is there a comparison of Groovy 3.0.5 with these suggested settings and Groovy 3.0.5 with the antlr2 parser?  Parallel parse is not specific to antlr4, so I would not consider it a part of closing the gap between the two parsers.  Optimizations in other parts of the compiler are a good thing, but I am skeptical about the practice of attributing to the parser any optimization made since the introduction of antlr4.&lt;/p&gt;</comment>
                            <comment id="17498959" author="JIRAUSER285899" created="Mon, 28 Feb 2022 15:20:44 +0000"  >&lt;p&gt;I experienced this issue with Groovy 3.0.9. is there any solution?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fswg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>