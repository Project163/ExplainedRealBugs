<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:47:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-7597] Static Compiler tries to cast delegate to target type of property accessor</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-7597</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I&apos;ve been able to finally isolate a static compiler issue with accessing properties on delegates that occur within our projects:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Calculation {
  &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isValid() { &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Entity {
  Calculation getCalculation(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) { &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Calculation() }
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Feature &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Entity {
}

void DoWithFeature(@DelegatesTo(Feature) Closure c) {
  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Feature().with(c)
}

@groovy.transform.CompileStatic
void doIt() {
  DoWithFeature() {
    println getCalculation(&lt;span class=&quot;code-quote&quot;&gt;&quot;whatever&quot;&lt;/span&gt;).valid
  }
}

doIt()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result is &lt;tt&gt;java.lang.ClassCastException: Feature cannot be cast to Calculation&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Workarounds:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;change the property access into a method access &quot;valid&quot; -&amp;gt; &quot;isValid()&quot;&lt;/li&gt;
	&lt;li&gt;Remove CompileStatic annotation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As seen in the following bytecode, the static compiler tries to cast the delegate to Calculation (which always fails), then tries to call ScriptBytecodeAdapter.castToType to try to cast the &quot;Calculation&quot; back to an Entity to properly call getCalculation(&quot;&quot;).isValid() on it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-comment&quot;&gt;// access flags 0x1
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; doCall(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
   L0
    LINENUMBER 19 L0
    ALOAD 0
    CHECKCAST script1442861431462$_doIt_closure1
    INVOKEVIRTUAL script1442861431462$_doIt_closure1.getThisObject ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
    LDC Lgroovy/lang/Script;.class
    INVOKESTATIC org/codehaus/groovy/runtime/ScriptBytecodeAdapter.castToType (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
    CHECKCAST groovy/lang/Script
    ALOAD 0
    CHECKCAST script1442861431462$_doIt_closure1
    INVOKEVIRTUAL script1442861431462$_doIt_closure1.getDelegate ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
    CHECKCAST Calculation
    LDC LEntity;.class
    INVOKESTATIC org/codehaus/groovy/runtime/ScriptBytecodeAdapter.castToType (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;;)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
    CHECKCAST Entity
    LDC &lt;span class=&quot;code-quote&quot;&gt;&quot;whatever&quot;&lt;/span&gt;
    INVOKEVIRTUAL Entity.getCalculation (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;)LCalculation;
    INVOKEVIRTUAL Calculation.isValid ()Z
    INVOKESTATIC java/lang/&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.valueOf (Z)Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;;
    INVOKEVIRTUAL groovy/lang/Script.println (Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)V
    ACONST_NULL
    ARETURN
   L1
    ACONST_NULL
    ARETURN
    LOCALVARIABLE &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; Lscript1442861431462$_doIt_closure1; L0 L1 0
    LOCALVARIABLE it Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;; L0 L1 1
    MAXSTACK = 3
    MAXLOCALS = 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12895218">GROOVY-7597</key>
            <summary>Static Compiler tries to cast delegate to target type of property accessor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="melix">C&#233;dric Champeau</assignee>
                                    <reporter username="gillius">Jason Winnebeck</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Sep 2015 18:54:11 +0000</created>
                <updated>Mon, 22 Feb 2016 20:48:35 +0000</updated>
                            <resolved>Wed, 7 Oct 2015 19:23:13 +0000</resolved>
                                    <version>2.4.3</version>
                    <version>2.4.4</version>
                                    <fixVersion>2.4.6</fixVersion>
                                    <component>Static compilation</component>
                    <component>Static Type Checker</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14942525" author="tkent" created="Sun, 4 Oct 2015 01:24:23 +0000"  >&lt;p&gt;We just got hit with this bug moving a project from groovy 2.3.8 to 2.4.5. I think this ought to be a critical issue since it only shows up at runtime and the workarounds are not practical in many cases. &lt;/p&gt;

&lt;p&gt;Searching through Jira, it appears that both &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7558&quot; title=&quot;Error when referencing private member variables from within a closure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7558&quot;&gt;&lt;del&gt;GROOVY-7558&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7376&quot; title=&quot;ClassCastException when searching for a property inside a with closure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7376&quot;&gt;&lt;del&gt;GROOVY-7376&lt;/del&gt;&lt;/a&gt; are duplicate reports of this. Since the title of this issue covers the problem very succinctly, I vote for this being the reference issue.&lt;/p&gt;

&lt;p&gt;If there is any interest in a unit test being added, I have one and I&apos;m happy to send a pull request.&lt;/p&gt;</comment>
                            <comment id="14942548" author="shils" created="Sun, 4 Oct 2015 04:24:08 +0000"  >&lt;p&gt;The problem seems to be in StaticInvocationWriter.tryImplicitReceiver, where the receiver of the &lt;tt&gt;getCalculation(&quot;whatever&quot;)&lt;/tt&gt; call, implicitly &lt;tt&gt;this.delegate&lt;/tt&gt;, has its INFERRED_TYPE metadata set to the PROPERTY_OWNER metadata of the getCalculation call. However, that metadata is set to &lt;tt&gt;Calculation&lt;/tt&gt; earlier in StaticCompilationVisitor.existsProperty while visiting the .valid property expression. &lt;/p&gt;

&lt;p&gt;None of this causes the direct method call target to change, so the only strangeness that appears in the bytecode is the checkcast Calculation and the runtime cast to Entity (which should really be Feature) as you mentioned.&lt;/p&gt;

&lt;p&gt;Another temporary workaround is to explicitly call delegate.getCalculation, in which case the checkcasts are for Feature and there are no runtime casts.&lt;/p&gt;</comment>
                            <comment id="14942816" author="githubbot" created="Sun, 4 Oct 2015 21:16:36 +0000"  >&lt;p&gt;GitHub user shils opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/126&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7597&quot; title=&quot;Static Compiler tries to cast delegate to target type of property accessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7597&quot;&gt;&lt;del&gt;GROOVY-7597&lt;/del&gt;&lt;/a&gt; Static compiler tries to cast delegate to target type of &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;property accessor&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Remove setting of INFERRED_TYPE metadata on synthetic property expression for implicit receiver&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/shils/incubator-groovy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/shils/incubator-groovy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7597&quot; title=&quot;Static Compiler tries to cast delegate to target type of property accessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7597&quot;&gt;&lt;del&gt;GROOVY-7597&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/126.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/126.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #126&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8fed562b40c71881f2e0b145aa5a611c0fd37b9b&lt;br/&gt;
Author: Shil S &amp;lt;shil.sinha@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-10-04T19:11:40Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-7597&quot; title=&quot;Static Compiler tries to cast delegate to target type of property accessor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-7597&quot;&gt;&lt;del&gt;GROOVY-7597&lt;/del&gt;&lt;/a&gt; Static compiler tries to cast delegate to target type of property accessor&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Remove setting of INFERRED_TYPE metadata on synthetic property expression for implicit receiver&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;</comment>
                            <comment id="14947412" author="githubbot" created="Wed, 7 Oct 2015 19:17:09 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-groovy/pull/126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-groovy/pull/126&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14947453" author="tkent" created="Wed, 7 Oct 2015 19:39:53 +0000"  >&lt;p&gt;That&apos;s fantastic, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12811564">GROOVY-7376</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ld1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>