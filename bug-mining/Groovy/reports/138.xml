<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:56:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-660] Multi-threaded groovy: get java.lang.LinkageError: duplicate class definition</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-660</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I just switched to groovy, which is great BTW.&lt;/p&gt;

&lt;p&gt;I have an example which I can&apos;t get to work when I execute it in parallel in two threads within the same VM. &lt;/p&gt;

&lt;p&gt;It&apos;s about this type of code:&lt;/p&gt;

&lt;p&gt;Binding context = new Binding();&lt;br/&gt;
GroovyShell shell = new GroovyShell();&lt;br/&gt;
Script script = shell.parse(&quot;println &apos;foo&apos;&quot;);&lt;br/&gt;
script.setBinding(context);&lt;br/&gt;
Object result = script.run();&lt;/p&gt;

&lt;p&gt;I always get an exception during the multi-threaded execution:&lt;br/&gt;
java.lang.LinkageError: duplicate class definition: gjdk/groovy/lang/GroovyObjectSupport_GroovyReflector&lt;br/&gt;
	at java.lang.ClassLoader.defineClass1(Native Method)&lt;br/&gt;
	at java.lang.ClassLoader.defineClass(ClassLoader.java:620)&lt;br/&gt;
	at groovy.lang.GroovyClassLoader.defineClass(GroovyClassLoader.java:478)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry$2.run(MetaClassRegistry.java:153)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry.loadClass(MetaClassRegistry.java:151)&lt;br/&gt;
	at groovy.lang.MetaClass.loadReflectorClass(MetaClass.java:2250)&lt;br/&gt;
	at groovy.lang.MetaClass.loadReflector(MetaClass.java:2232)&lt;br/&gt;
	at groovy.lang.MetaClass.generateReflector(MetaClass.java:2182)&lt;br/&gt;
	at groovy.lang.MetaClass.checkInitialised(MetaClass.java:2129)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry.getMetaClass(MetaClassRegistry.java:121)&lt;br/&gt;
	at groovy.lang.MetaClass.addNewStaticMethodsFrom(MetaClass.java:1281)&lt;br/&gt;
	at groovy.lang.MetaClass.addInheritedMethods(MetaClass.java:212)&lt;br/&gt;
	at groovy.lang.MetaClass.checkInitialised(MetaClass.java:2126)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry.getMetaClass(MetaClassRegistry.java:121)&lt;br/&gt;
	at org.codehaus.groovy.runtime.Invoker.getMetaClass(Invoker.java:99)&lt;br/&gt;
	at org.codehaus.groovy.runtime.InvokerHelper.getMetaClass(InvokerHelper.java:94)&lt;br/&gt;
	at groovy.lang.GroovyObjectSupport.&amp;lt;init&amp;gt;(GroovyObjectSupport.java:61)&lt;br/&gt;
	at groovy.lang.Binding.&amp;lt;init&amp;gt;(Binding.java:62)&lt;/p&gt;

&lt;p&gt;When I run this code single-threaded, it works fine. Seems like a &apos;sometimes-per-thread, sometimes-global&apos; thing to me.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Andre&lt;/p&gt;</description>
                <environment>eclipse 3.1M1, Sun JDK1.5.0</environment>
        <key id="12816176">GROOVY-660</key>
            <summary>Multi-threaded groovy: get java.lang.LinkageError: duplicate class definition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="spullara">Sam Pullara</assignee>
                                    <reporter username="pareis">Andre R. Pareis</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Nov 2004 18:22:00 +0000</created>
                <updated>Fri, 24 Mar 2006 06:23:04 +0000</updated>
                            <resolved>Sun, 2 Jan 2005 18:33:06 +0000</resolved>
                                    <version>1.0-beta-8</version>
                                    <fixVersion>1.0-beta-9</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14460526" author="pareis" created="Thu, 4 Nov 2004 19:07:49 +0000"  >&lt;p&gt;So I tested it again on a Sun Solaris 2 CPU machine and had the same problem like on my Windows XP box with Intel Hyperthreading CPU. All tests done with same Sun jdk1.5.0.&lt;/p&gt;

&lt;p&gt;If there&apos;s only one thread accessing the Groovy meta system then it works fine, but as soon as there a two threads it comes up with the error.&lt;/p&gt;</comment>
                            <comment id="14460567" author="guillaume" created="Fri, 5 Nov 2004 03:53:18 +0000"  >&lt;p&gt;Andre, Groovy&apos;s has some problems with JDK 1.5 for the moment. We&apos;ve only tested it on 1.4 JDKs. If you have some time, could you please try the same multithreaded test under 1.4 JDKs? It&apos;ll help us see if the problem comes from the fact it&apos;s a 1.5 JDK or a real multithreading issue. Thanks in advance.&lt;/p&gt;</comment>
                            <comment id="14460679" author="esarbu" created="Fri, 5 Nov 2004 09:30:36 +0000"  >&lt;p&gt;We&apos;re seeing this problem in Sun JDK 1.4.2_05 and Jrockit 8.1.SP2. It doesn&apos;t happen if we synchronize the calls.&lt;/p&gt;

&lt;p&gt;In Sun&apos;s JDK the exception is:&lt;br/&gt;
java.lang.LinkageError: duplicate class definition: gjdk/com/lb/base/util/DataRecord_GroovyReflector&lt;/p&gt;

&lt;p&gt;or in Jrockit:&lt;br/&gt;
java.lang.LinkageError: gjdk.java.io.FilterOutputStream_GroovyReflector&lt;br/&gt;
        at java.lang.ClassLoader.defineClass(Ljava.lang.String;[BIILjava.security.ProtectionDomain;)Ljava.lang.Class;(Unknown Source)&lt;br/&gt;
        at groovy.lang.GroovyClassLoader.defineClass(Ljava.lang.String;[BLjava.security.ProtectionDomain;)Ljava.lang.Class;(GroovyClassLoader.java:478)&lt;br/&gt;
        at groovy.lang.MetaClassRegistry$2.run()Ljava.lang.Object;(MetaClassRegistry.java:153)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Ljava.security.PrivilegedAction;)Ljava.lang.Object;(Native Method)&lt;br/&gt;
        at groovy.lang.MetaClassRegistry.loadClass(Ljava.lang.String;[B)Ljava.lang.Class;(MetaClassRegistry.java:151)&lt;br/&gt;
        at groovy.lang.MetaClass.loadReflectorClass(Ljava.lang.String;[B)Ljava.lang.Class;(MetaClass.java:2212)&lt;br/&gt;
        at groovy.lang.MetaClass.loadReflector(Ljava.util.List;)Lorg.codehaus.groovy.runtime.Reflector;(MetaClass.java:2194)&lt;br/&gt;
        at groovy.lang.MetaClass.generateReflector()V(MetaClass.java:2144)&lt;br/&gt;
        at groovy.lang.MetaClass.checkInitialised()V(MetaClass.java:2091)&lt;br/&gt;
        at groovy.lang.MetaClassRegistry.getMetaClass(Ljava.lang.Class;)Lgroovy.lang.MetaClass;(MetaClassRegistry.java:121)&lt;br/&gt;
        at groovy.lang.MetaClass.addNewStaticMethodsFrom(Ljava.lang.Class;)V(MetaClass.java:1255)&lt;br/&gt;
        at groovy.lang.MetaClass.addInheritedMethods(Ljava.lang.Class;)V(MetaClass.java:209)&lt;br/&gt;
        at groovy.lang.MetaClass.checkInitialised()V(MetaClass.java:2088)&lt;br/&gt;
        at groovy.lang.MetaClassRegistry.getMetaClass(Ljava.lang.Class;)Lgroovy.lang.MetaClass;(MetaClassRegistry.java:121)&lt;br/&gt;
        at org.codehaus.groovy.runtime.Invoker.invokeMethod(Ljava.lang.Object;Ljava.lang.String;Ljava.lang.Object;)Ljava.lang.Object;(Invoker.java:142)&lt;br/&gt;
        at org.codehaus.groovy.runtime.InvokerHelper.invokeMethod(Ljava.lang.Object;Ljava.lang.String;Ljava.lang.Object;)Ljava.lang.Object;(InvokerHelper.java&lt;br/&gt;
:106)&lt;br/&gt;
        at Test.run(Lcom.lb.base.util.DataRecord;Lcom.lb.base.util.DataRecord;Lcom.lb.equities.oms.entitlements.AttributeProvider;)Z(script1099532924638.groov&lt;br/&gt;
y:12)&lt;br/&gt;
        at com.lb.equities.oms.firstus.rulesengine.RulesEngine.runRule(Lcom.lb.equities.oms.firstus.rulesengine.Rule;Lcom.lb.base.util.DataRecord;Lcom.lb.base&lt;br/&gt;
.util.DataRecord;Lcom.lb.equities.oms.entitlements.AttributeProvider;)Z(RulesEngine.java:145)&lt;/p&gt;</comment>
                            <comment id="14460450" author="pareis" created="Fri, 5 Nov 2004 12:58:08 +0000"  >&lt;p&gt;I can confirm Eugen&apos;s comment. I did another test where I synchronized all groovy related calls and it worked perfectly.&lt;/p&gt;

&lt;p&gt;Regards&lt;br/&gt;
Andre&lt;/p&gt;</comment>
                            <comment id="14460474" author="dukejeffrie" created="Fri, 12 Nov 2004 09:08:12 +0000"  >&lt;p&gt;I believe the problem is in MetaClassRegistry.getMetaClass(Class).&lt;/p&gt;

&lt;p&gt;when the metaClasses map has no entry, the following code executes:&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;answer = new MetaClass(this, theClass);&lt;br/&gt;
answer.checkInitialised();&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;checkInitialized() is synchronized, but if I come from two threads, I have two instances, and it ends up calling defineClass twice.&lt;/p&gt;

&lt;p&gt;The solution is to prevent that another thread creates a MetaClass instance when one is already at work.&lt;/p&gt;

&lt;p&gt;I have patched my version synchronizing on the whole method, but I believe there are more efficient solutions.&lt;/p&gt;</comment>
                            <comment id="14460687" author="guillaume" created="Thu, 9 Dec 2004 07:41:18 +0000"  >&lt;p&gt;Sam, perhaps you could have a look at this one since you&apos;re working on those kind of stuff atm?&lt;/p&gt;</comment>
                            <comment id="14460682" author="spullara" created="Sun, 2 Jan 2005 18:33:06 +0000"  >&lt;p&gt;We now sychronize on the class before findOrCreating a reflector for it.&lt;/p&gt;</comment>
                            <comment id="14461894" author="trungsi" created="Fri, 24 Mar 2006 04:28:46 +0000"  >&lt;p&gt;i still have this bug :&lt;/p&gt;

&lt;p&gt;java.lang.LinkageError: duplicate class definition: gjdk/org/codehaus/groovy/runtime/InvokerHelper$1_GroovyReflector&lt;br/&gt;
	at java.lang.ClassLoader.defineClass1(Native Method)&lt;br/&gt;
	at java.lang.ClassLoader.defineClass(ClassLoader.java:620)&lt;br/&gt;
	at groovy.lang.GroovyClassLoader.defineClass(GroovyClassLoader.java:529)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry$3.run(MetaClassRegistry.java:185)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry.loadClass(MetaClassRegistry.java:183)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.loadReflectorClass(MetaClassImpl.java:1740)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.loadReflector(MetaClassImpl.java:1699)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.generateReflector(MetaClassImpl.java:1650)&lt;br/&gt;
	at groovy.lang.MetaClassImpl.checkInitialised(MetaClassImpl.java:1567)&lt;br/&gt;
	at groovy.lang.MetaClassRegistry.getMetaClass(MetaClassRegistry.java:145)&lt;br/&gt;
	at org.codehaus.groovy.runtime.Invoker.getMetaClass(Invoker.java:104)&lt;br/&gt;
	at org.codehaus.groovy.runtime.InvokerHelper.getMetaClass(InvokerHelper.java:87)&lt;br/&gt;
	at groovy.lang.GroovyObjectSupport.&amp;lt;init&amp;gt;(GroovyObjectSupport.java:61)&lt;br/&gt;
	at groovy.lang.Script.&amp;lt;init&amp;gt;(Script.java:65)&lt;br/&gt;
	at org.codehaus.groovy.runtime.InvokerHelper$1.&amp;lt;init&amp;gt;(InvokerHelper.java:523)&lt;br/&gt;
	at org.codehaus.groovy.runtime.InvokerHelper.createScript(InvokerHelper.java:522)&lt;br/&gt;
	at groovy.lang.GroovyShell.parse(GroovyShell.java:548)&lt;br/&gt;
	at groovy.lang.GroovyShell.parse(GroovyShell.java:527)&lt;br/&gt;
	at groovy.lang.GroovyShell.evaluate(GroovyShell.java:505)&lt;br/&gt;
	at groovy.lang.GroovyShell.evaluate(GroovyShell.java:484)&lt;/p&gt;

&lt;p&gt;I use groovy-all-1.0-jsr-04 on eclipse 3.1, jdk1.5, and tomcat 5.5.14.&lt;/p&gt;</comment>
                            <comment id="14461855" author="trungsi" created="Fri, 24 Mar 2006 06:23:04 +0000"  >&lt;p&gt;I&apos;ve just found the cause. it&apos;s because  I&apos;ve run blank script (shell.evaluate(&quot;   &quot;)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; more than once. Is it illegal in Groovy? If yes, i think it should have other exception.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2co93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>