<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 01:04:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-9183] Issue using @MapConstructor and @NamedVariant</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-9183</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;I have a static method marked with &lt;tt&gt;@NamedVariant&lt;/tt&gt;, that takes a &quot;Configuration&quot; object as a parameter, which is marked with &lt;tt&gt;@NamedDelegate&lt;/tt&gt;. The &quot;Configuration&quot; object is defined as a static inner class marked with &lt;tt&gt;@Immutable&lt;/tt&gt;.&lt;br/&gt;
&#160;&lt;br/&gt;
My Class:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;class CsvRowMapper {&lt;br/&gt;
&#160; &#160; private final Settings settings&lt;br/&gt;
&#160; &#160; @NamedVariant&lt;br/&gt;
&#160; &#160; CsvRowMapper(Settings settings) {&lt;br/&gt;
&#160; &#160; &#160; &#160; this.settings = settings&lt;br/&gt;
&#160; &#160; }&lt;br/&gt;
&#160; &#160; &lt;b&gt;@NamedVariant&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &lt;b&gt;static CsvRowMapper parse(@NamedDelegate Settings settings, Reader reader) {&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &#160; &#160; &lt;b&gt;new CsvRowMapper(settings).parse(reader)&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &lt;b&gt;}&lt;/b&gt;&lt;br/&gt;
&#160; &#160; CsvRowMapper parse(Reader source) {&lt;br/&gt;
&#160; &#160; &#160; &#160; // do work here&lt;br/&gt;
&#160; &#160; &#160; &#160; return this&lt;br/&gt;
&#160; &#160; }&lt;br/&gt;
&#160; &#160; &lt;b&gt;@Immutable&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &lt;b&gt;static class Settings {&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &#160; &#160; &lt;b&gt;String separator = &apos;,&apos;&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &#160; &#160; &lt;b&gt;boolean headers = true&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &#160; &#160; &lt;b&gt;int headersRow = 0&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &#160; &#160; &lt;b&gt;int firstDataRow = 1&lt;/b&gt;&lt;br/&gt;
&#160; &#160; &lt;b&gt;}&lt;/b&gt;&lt;br/&gt;
}&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
I&apos;ve highlighted the important parts. The issue is when I use this class like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CsvRowMapper.parse(*separator: &lt;span class=&quot;code-quote&quot;&gt;&apos;\t&apos;&lt;/span&gt;*, tsvFileReader)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
I get an &lt;tt&gt;GroovyCastException&lt;/tt&gt; because it&apos;s trying to set &lt;tt&gt;headersRow&lt;/tt&gt; or &lt;tt&gt;firstDataRow&lt;/tt&gt; to &lt;tt&gt;null&lt;/tt&gt;:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.codehaus.groovy.runtime.typehandling.GroovyCastException: Cannot cast object &apos;\{separator= , headers=null, headersRow=null, firstDataRow=null}&apos;
  with class &apos;java.util.LinkedHashMap&apos; to class &apos;CsvRowMapper$Settings&apos;
  due to: org.codehaus.groovy.runtime.typehandling.GroovyCastException:
    Cannot cast object &apos;null&apos; with class &apos;null&apos; to class &apos;int&apos;. Try &apos;java.lang.Integer&apos; instead
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Even though there are default values for each setting.&lt;br/&gt;
&#160;&lt;br/&gt;
I loaded up this into GroovyConsole, and I think the issue is that the &lt;tt&gt;@NameVariant&lt;/tt&gt; version of the `parse` method is creating a map with ALL keys for the &lt;tt&gt;@NamedDelegate&lt;/tt&gt; &lt;tt&gt;Settings&lt;/tt&gt; class (See NamedVariant.png).&lt;br/&gt;
&#160;&lt;br/&gt;
Furthermore the &lt;tt&gt;@Immutable&lt;/tt&gt; annotation adds &lt;tt&gt;@MapConstructor&lt;/tt&gt; to my &lt;tt&gt;Settings&lt;/tt&gt; class, which only checks if the given map contains the &lt;b&gt;`key`&lt;/b&gt;, not also if it has a `value` (See MapConstructor.png).&lt;br/&gt;
&#160;&lt;br/&gt;
The &lt;tt&gt;@NamedVariant&lt;/tt&gt; passes a map containing null values for all keys not supplied during method execution, and &lt;tt&gt;@MapConstructor&lt;/tt&gt; only checks if the given map has the key, not a value.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13242593">GROOVY-9183</key>
            <summary>Issue using @MapConstructor and @NamedVariant</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="emilles">Eric Milles</assignee>
                                    <reporter username="townsfolk">Eric Berry</reporter>
                        <labels>
                            <label>named-parameters</label>
                    </labels>
                <created>Mon, 1 Jul 2019 20:02:02 +0000</created>
                <updated>Wed, 16 Feb 2022 22:58:36 +0000</updated>
                            <resolved>Mon, 2 Dec 2019 01:48:23 +0000</resolved>
                                    <version>2.5.7</version>
                                    <fixVersion>3.0.0-rc-2</fixVersion>
                    <fixVersion>2.5.16</fixVersion>
                                    <component>groovy-runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16904861" author="paulk" created="Mon, 12 Aug 2019 05:45:01 +0000"  >&lt;p&gt;So, if you use &lt;tt&gt;Boolean&lt;/tt&gt; instead of &lt;tt&gt;boolean&lt;/tt&gt; and &lt;tt&gt;Integer&lt;/tt&gt; instead of &lt;tt&gt;int&lt;/tt&gt;, does it work?&lt;/p&gt;</comment>
                            <comment id="16905418" author="townsfolk" created="Mon, 12 Aug 2019 17:36:43 +0000"  >&lt;p&gt;Yes, switching the properties of my &lt;tt&gt;Settings&lt;/tt&gt; object does get rid of the error, but the defaults still don&apos;t work.&lt;/p&gt;

&lt;p&gt;New full example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.transform.*

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CsvRowMapper {
	final Settings settings
	@NamedVariant
	CsvRowMapper(Settings settings) {
		&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.settings = settings
	}
	@NamedVariant
	static CsvRowMapper parse(@NamedDelegate Settings settings, Reader reader) {
		&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CsvRowMapper(settings).parse(reader)
	}
	CsvRowMapper parse(Reader source) {
		&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; work here
&lt;/span&gt;		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
	}
	@Immutable
	static &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Settings {
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; separator = &lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;
		&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; headers = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
		&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; headersRow = 0
		&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; firstDataRow = 1
	}
}

&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; mapper = CsvRowMapper.parse(separator: &lt;span class=&quot;code-quote&quot;&gt;&apos;\t&apos;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(&quot;&quot;))

&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; mapper.settings.headers == &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; mapper.settings.headersRow == 0
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; mapper.settings.firstDataRow == 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All the assertions at the bottom fail, comparing against null.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Assertion failed: 

&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; mapper.settings.headers == &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
       |      |        |       |
       |      |        &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
       |      CsvRowMapper$Settings(	, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
       CsvRowMapper@a0fc023
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16984671" author="emilles" created="Thu, 28 Nov 2019 23:01:14 +0000"  >&lt;p&gt;The AST transform creates a method that has essentially this form:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-groovy&quot;&gt;
public static CsvRowMapper parse(Map namedArgs, Reader reader) {
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.parse((Settings) [separator: namedArgs.separator, headers: namedArgs.headers, ...], reader)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since your properties have initialization expressions, I think it would be better to write each map entry expression this way:&lt;br/&gt;
&lt;tt&gt;headers: namedArgs.getOrDefault(&apos;headers&apos;, prop.getInitialExpression())&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16984691" author="paulk" created="Fri, 29 Nov 2019 00:25:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilles&quot; class=&quot;user-hover&quot; rel=&quot;emilles&quot;&gt;emilles&lt;/a&gt; getOrDefault is JDK 1.8, so a good proposal for Groovy 3+.&lt;/p&gt;</comment>
                            <comment id="16985426" author="emilles" created="Sat, 30 Nov 2019 20:12:54 +0000"  >&lt;p&gt;Right.  The PR will work for master and Groovy 3.  If you want the fix in Groovy 2.5, it will require a more complicated sequence.&lt;/p&gt;</comment>
                            <comment id="16985745" author="paulk" created="Mon, 2 Dec 2019 01:48:23 +0000"  >&lt;p&gt;Proposed PR applied. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12973357" name="MapConstructor.png" size="161089" author="townsfolk" created="Mon, 1 Jul 2019 19:56:21 +0000"/>
                            <attachment id="12973356" name="NamedVariant.png" size="94435" author="townsfolk" created="Mon, 1 Jul 2019 19:56:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z049u8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>