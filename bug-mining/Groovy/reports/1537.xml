<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:21:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-4934] incorrect signature attributes in class files for inner class generics</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-4934</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;When an inner type shares state with its outer type, and that shared state is generic, the signature attributes generated inside the inner class are not correct.  This is not normally a problem because once created they are rarely processed again, however, Eclipse checks these things and discovers the inconsistencies, reporting an &apos;inconsistent class file&apos; error when it sees a type variable referenced that is not in scope.&lt;/p&gt;

&lt;p&gt;Here is a simple groovy program:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.lang.Closure

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.Serializable
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Map

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GormInstanceApi&amp;lt;D&amp;gt; {

	void delete(D instance) {
		&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VoidSessionCallback() {
			void doInSession() {
				print instance
			}
		}
	}

}

&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; VoidSessionCallback {
	void doInSession();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When this gets compiled, a field of type Reference is created in the inner type (in the InnerClassVisitor.visitConstructorCallExpression()) code, and this is added to the constructor.  The signature attribute for the new field and the constructor of the inner type encodes a generic reference that isn&apos;t quite right - it refers to a type variable that isn&apos;t in scope.  Here is the generic signature attribute for the constructor:&lt;/p&gt;

&lt;p&gt; (LGormInstanceApi&amp;lt;TD;&amp;gt;;Lgroovy/lang/Reference&amp;lt;TT;&amp;gt;;)V;&lt;/p&gt;

&lt;p&gt;The first bit is OK, the &apos;D&apos; referred to is defined by the declaring type and so visible from the inner.  However the &apos;T&apos; is not visible - I would have expected a reference to the raw type there:&lt;/p&gt;

&lt;p&gt;(LGormInstanceApi&amp;lt;TD;&amp;gt;;Lgroovy/lang/Reference;)V;&lt;/p&gt;

&lt;p&gt;Or, if it was being used in parameterized form:&lt;/p&gt;

&lt;p&gt;(LGormInstanceApi&amp;lt;TD;&amp;gt;;Lgroovy/lang/Reference&amp;lt;Ljava/lang/Object;&amp;gt;;)V;&lt;/p&gt;

&lt;p&gt;Similarly it is wrong for the field:&lt;/p&gt;

&lt;p&gt; Lgroovy/lang/Reference&amp;lt;TT;&amp;gt;;;&lt;/p&gt;

&lt;p&gt;T is not in scope (not declared by this type or a surrounding type).&lt;/p&gt;

&lt;p&gt;To see this problem in Eclipse, define a project containing that code above and then create a pure java project that depends upon it.  Add this file to the java project:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Simple&amp;lt;D&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; GormInstanceApi&amp;lt;D&amp;gt; {
	 
	void foo() {	 
		&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VoidSessionCallback() {
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void doInSession() {
			}  
		} ;
	}    
}  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This code is enough to force JDT to load in the GormInstanceApi inner class and discover the inconsistency in signatures:&lt;/p&gt;

&lt;p&gt;Inconsistent classfile encountered: The undefined type parameter T is referenced from within GormInstanceApi&amp;lt;D&amp;gt;.1	&lt;/p&gt;

&lt;p&gt;I&apos;d propose the type of the newly created field is set to the raw type for groovy.lang.Reference, but I don&apos;t know how to create a raw ClassNode.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12816512">GROOVY-4934</key>
            <summary>incorrect signature attributes in class files for inner class generics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="aclement">Andy Clement</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Jul 2011 19:53:28 +0000</created>
                <updated>Wed, 1 Feb 2012 12:47:55 +0000</updated>
                            <resolved>Wed, 1 Feb 2012 12:47:55 +0000</resolved>
                                    <version>1.8.0</version>
                                    <fixVersion>1.8.6</fixVersion>
                    <fixVersion>2.0-beta-3</fixVersion>
                    <fixVersion>1.7.11</fixVersion>
                                    <component>bytecode</component>
                    <component>class generator</component>
                        <due></due>
                            <votes>7</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14471477" author="aclement" created="Tue, 19 Jul 2011 22:14:22 +0000"  >&lt;p&gt;Ah, I see, you call them plain references.  Please find a patch attached that uses the raw (plain) type reference for the new fields created inside these inner types.  I&apos;m afraid I haven&apos;t run it against your test suite, but it fixes the inconsistent class issue that eclipse finds.&lt;/p&gt;</comment>
                            <comment id="14471546" author="blackdrag" created="Wed, 20 Jul 2011 04:45:52 +0000"  >&lt;p&gt;the patch works for 1.8 and 1.9, but in 1.7 not.I committed the patch to 1.8/1.9 then.&lt;/p&gt;</comment>
                            <comment id="14471561" author="aclement" created="Tue, 26 Jul 2011 10:11:16 +0000"  >&lt;p&gt;My users were hitting this with groovy 1.7 so I applied the same change there, this does not work by itself.  It looks like it fails because getPlainNodeReference doesn&apos;t set the interfaces, only the superclass (and so the users were seeing an NPE when attempting to work with the interfaces for the plain node).  So I had to make the additional change in getPlainNodeReference to pass getInterfaces() alongside getSuperclass() when building the new ClassNode.&lt;/p&gt;</comment>
                            <comment id="14471605" author="aclement" created="Fri, 5 Aug 2011 12:35:35 +0000"  >&lt;p&gt;This is the variant of the patch for 1.7.10 - which in addition to using a plain node reference ensures the interfaces are set for the node ref.&lt;/p&gt;</comment>
                            <comment id="14471617" author="blackdrag" created="Mon, 8 Aug 2011 09:30:43 +0000"  >&lt;p&gt;Andy, with this patch I still get a failing test:&lt;br/&gt;
  &lt;span class=&quot;error&quot;&gt;&amp;#91;groovyc&amp;#93;&lt;/span&gt; BUG! exception in phase &apos;class generation&apos; in source unit &apos;/home/blackdrag/coding/GROOVY_1_7_X/src/test/groovy/lang/ReferenceSerializationTest.groovy&apos; ClassNode#getTypeClass for groovy.lang.Reference is called before the type class is set &lt;/p&gt;</comment>
                            <comment id="14471681" author="aclement" created="Mon, 8 Aug 2011 10:12:36 +0000"  >&lt;p&gt;ok Jochen, I&apos;ll take a look when I get some time.&lt;/p&gt;</comment>
                            <comment id="14471671" author="aclement" created="Thu, 18 Aug 2011 12:31:51 +0000"  >&lt;p&gt;New version of the patch which copies the clazz across when creating a plain node reference.  Seems to pass all the groovy tests.&lt;/p&gt;</comment>
                            <comment id="14471848" author="blackdrag" created="Thu, 22 Sep 2011 06:18:03 +0000"  >&lt;p&gt;Andy sorry it took so long... there are some things in the patch that make me wonder if the usage is really correct. A plain node reference is supposed to be a ClassNode that redirects to another one and contains itself no generics information. &lt;/p&gt;

&lt;p&gt;As such setting clazz makes no sense. Normally a redirecting ClassNode should never have clazz set. I can only assume that eclipse is using that API differently here. But this has future conflict potential.&lt;/p&gt;

&lt;p&gt;Next tihng is the interfaces. A redirecting node will ask the node it redirects to for the the interfaces. Therefore it makes no sense to store them directly on the redirecting node as well.&lt;/p&gt;

&lt;p&gt;The part of InnerClassVisitor is already in the repo&lt;/p&gt;</comment>
                            <comment id="14471849" author="aclement" created="Thu, 22 Sep 2011 10:09:01 +0000"  >&lt;p&gt;Hey.  Been a while since I look at this, but I think I only did the &apos;extra stuff&apos; to keep some of the groovy infrastructure happy, not eclipse, I was making minor changes and that running the groovy tests.  So I found if the clazz or interfaces werent set, groovy tests were failing - if I recall correctly.&lt;/p&gt;</comment>
                            <comment id="14472305" author="blackdrag" created="Wed, 1 Feb 2012 12:47:55 +0000"  >&lt;p&gt;the fix versions for 1.8 and 2.0 are not really right, but we missed to add those, so I use the current one. I finally managed to apply your patch. I actually tried to not use some of the parts you use, like not setting the interfaces, but didn&apos;t work. While not perfect, I think it is ok for 1.7, so I simply applied it&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12722961" name="version3.patch" size="1953" author="aclement" created="Thu, 18 Aug 2011 12:31:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2btnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>