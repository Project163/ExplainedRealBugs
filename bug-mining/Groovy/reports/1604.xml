<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 00:22:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[GROOVY-5089] Unnecessary unboxing and casting in boolean handling in generated bytecode</title>
                <link>https://issues.apache.org/jira/browse/GROOVY-5089</link>
                <project id="12318123" key="GROOVY">Groovy</project>
                    <description>&lt;p&gt;This sample code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroovyBooleanTest {
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; someCall() {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void somecode() {
		&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; val = someCall()
		println val
	}

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;produces very redundant bytecode (decompiled with jd-gui):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.lang.GroovyObject;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; groovy.lang.MetaClass;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.runtime.BytecodeInterface8;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.runtime.ScriptBytecodeAdapter;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.runtime.callsite.CallSite;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.codehaus.groovy.runtime.typehandling.DefaultTypeTransformation;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GroovyBooleanTest &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; GroovyObject {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GroovyBooleanTest()
  {
    GroovyBooleanTest &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
    CallSite[] arrayOfCallSite = $getCallSiteArray();
    MetaClass localMetaClass = $getStaticMetaClass();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metaClass = localMetaClass;
  }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; someCall() {
        CallSite[] arrayOfCallSite = $getCallSiteArray();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DefaultTypeTransformation.booleanUnbox(&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DefaultTypeTransformation.booleanUnbox((&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;)DefaultTypeTransformation.box(0));
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void somecode() {
        CallSite[] arrayOfCallSite = $getCallSiteArray();
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; val = 0;
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; localObject;
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; bool1;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((!BytecodeInterface8.isOrigZ()) || (__$stMC) || (BytecodeInterface8.disabledStandardMetaClass())) {
            localObject = arrayOfCallSite[0].callCurrent(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
            val = DefaultTypeTransformation.booleanUnbox((&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)ScriptBytecodeAdapter.castToType(localObject,
                    $get$$&lt;span class=&quot;code-keyword&quot;&gt;class$&lt;/span&gt;java$lang$&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;()));
        }
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            bool1 = someCall();
            val = DefaultTypeTransformation.booleanUnbox((&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)ScriptBytecodeAdapter.castToType(
                    (&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)DefaultTypeTransformation.box(bool1), $get$$&lt;span class=&quot;code-keyword&quot;&gt;class$&lt;/span&gt;java$lang$&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;()));
        }
        arrayOfCallSite[1].callCurrent(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, (&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)DefaultTypeTransformation.box(val));
    }

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
        __$swapInit();
        &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; localLong1 = (&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;)DefaultTypeTransformation.box(0L);
        __timeStamp__239_neverHappen1319001147656 = DefaultTypeTransformation.longUnbox(localLong1);
        &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; localLong2 = (&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;)DefaultTypeTransformation.box(1319001147656L);
        __timeStamp = DefaultTypeTransformation.longUnbox(localLong2);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;This part of the bytecode is interesting:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            bool1 = someCall();
            val = DefaultTypeTransformation.booleanUnbox((&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)ScriptBytecodeAdapter.castToType(
                    (&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)DefaultTypeTransformation.box(bool1), $get$$&lt;span class=&quot;code-keyword&quot;&gt;class$&lt;/span&gt;java$lang$&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;bool1 and val are both already booleans. It goes through many unnecessary layers before assigning val to bool1.&lt;/p&gt;
</description>
                <environment>Groovy 1.8.3 + Java 1.6.0_27 on Ubuntu Linux 10.04.3</environment>
        <key id="12818088">GROOVY-5089</key>
            <summary>Unnecessary unboxing and casting in boolean handling in generated bytecode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blackdrag">Jochen Theodorou</assignee>
                                    <reporter username="lhotari">Lari Hotari</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Oct 2011 00:20:36 +0000</created>
                <updated>Wed, 9 Nov 2011 10:17:00 +0000</updated>
                            <resolved>Wed, 9 Nov 2011 10:17:00 +0000</resolved>
                                    <version>1.8.3</version>
                                    <fixVersion>1.8.4</fixVersion>
                    <fixVersion>2.0-beta-1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="14471987" author="lhotari" created="Wed, 19 Oct 2011 00:29:09 +0000"  >&lt;p&gt;What is also quite interesting is that the someCall method has 2 return statements in the bytecode&lt;/p&gt;

&lt;p&gt;(output produced by Eclipse Bytecode outline plugin: &lt;a href=&quot;http://andrei.gmxhome.de/bytecode/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://andrei.gmxhome.de/bytecode/&lt;/a&gt;)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; someCall() : &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;
   L0
    INVOKESTATIC GroovyBooleanTest.$getCallSiteArray() : CallSite[]
    ASTORE 1
   L1
    LINENUMBER 4 L1
    GETSTATIC &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE : &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;
    INVOKESTATIC DefaultTypeTransformation.booleanUnbox(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;
    IRETURN
   L2
    LDC 0
    INVOKESTATIC DefaultTypeTransformation.box(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;
    CHECKCAST &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;
    INVOKESTATIC DefaultTypeTransformation.booleanUnbox(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;) : &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;
    IRETURN
    LOCALVARIABLE &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; GroovyBooleanTest L0 L2 0
    MAXSTACK = 1
    MAXLOCALS = 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;decompiled with JD-Gui:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; someCall() {
        CallSite[] arrayOfCallSite = $getCallSiteArray();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DefaultTypeTransformation.booleanUnbox(&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DefaultTypeTransformation.booleanUnbox((&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;)DefaultTypeTransformation.box(0));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This must be a bug.&lt;/p&gt;</comment>
                            <comment id="14472042" author="lhotari" created="Wed, 19 Oct 2011 00:52:47 +0000"  >&lt;p&gt;What is this code generated in so many places:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((!BytecodeInterface8.isOrigZ()) || (__$stMC) || (BytecodeInterface8.disabledStandardMetaClass())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If that&apos;s really necessary, please &quot;cache&quot; the value of &quot;(!BytecodeInterface8.isOrigZ()) || (__$stMC) || (BytecodeInterface8.disabledStandardMetaClass())&quot; .&lt;/p&gt;</comment>
                            <comment id="14471974" author="blackdrag" created="Wed, 19 Oct 2011 07:53:45 +0000"  >&lt;p&gt;this is not really a critical issue. As for the second return, it is dead code, it won&apos;t have any reasonable effect. The big IF you are wondering about, is the guard for the primitive optimization code, and it cannot be cached, unless you habe a suggestion. A better strategy would be to not to issue the optimization in this case. I have not yet added code that tests if the optimizations make sense in that case at all. Just returning a constant is maybe not a case in which we should do this kind of thing.&lt;/p&gt;

&lt;p&gt;Part of the optimizations I added is to gradually change values from being always boxed to be used native as they are. This is currently implemented only for int and double, but not for boolean. That is why you see the unboxing.&lt;/p&gt;</comment>
                            <comment id="14471957" author="lhotari" created="Wed, 19 Oct 2011 08:01:55 +0000"  >&lt;p&gt;Thanks for the answer. It would be cool to get the boolean optimizations too. Groovy doesn&apos;t look very clean when you go to the bytecode level without fixing this issue. Please schedule the change so that it gets fixed some time in the near future (1.8.4 / 1.8.5 ?).&lt;/p&gt;

&lt;p&gt;A more critical issue is &lt;a href=&quot;https://issues.apache.org/jira/browse/GROOVY-5090&quot; title=&quot;Groovy compiler generates invalid byte code for local boolean variables that later on are referenced in a closure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;GROOVY-5090&quot;&gt;&lt;del&gt;GROOVY-5090&lt;/del&gt;&lt;/a&gt; . I was actually hunting for that one (debugger showed &quot;false&quot; for a boolean value dispite the real value) when I noticed this unboxing/boxing redundancy.&lt;/p&gt;</comment>
                            <comment id="14471908" author="blackdrag" created="Thu, 27 Oct 2011 10:48:24 +0000"  >&lt;p&gt;fixed&lt;/p&gt;</comment>
                            <comment id="14472059" author="pred" created="Thu, 27 Oct 2011 10:52:40 +0000"  >&lt;p&gt;Aleluia &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thx thx thx thx&lt;/p&gt;</comment>
                            <comment id="14471982" author="nikolaj49a" created="Wed, 2 Nov 2011 04:35:05 +0000"  >&lt;p&gt;Is it possible to add code to test if the optimizations make sense in order to remove unecessary if statements:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if ((!BytecodeInterface8.isOrigZ()) || (__$stMC) || (BytecodeInterface8.disabledStandardMetaClass())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;I see this in situations where I do simple String assignments.&lt;br/&gt;
Also it confuses Cobertura to think that the assignment is actually a branch condition.&lt;/p&gt;</comment>
                            <comment id="14472029" author="blackdrag" created="Wed, 2 Nov 2011 05:08:43 +0000"  >&lt;p&gt;We have now tests that test that check the generated bytecode, so we can surely write tests. More important is to get a list of situations in which thee should be no optimization guard. String assignments normally don&apos;t trigger that.&lt;/p&gt;

&lt;p&gt;Maybe I should introduce some kind of optimization weight and a threshold, so that I optimize only if the weight is higher than the threshold. But even then I first need to know when it does not make sense.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2c833:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>