diff --git a/src/main/groovy/xml/StreamingMarkupBuilder.groovy b/src/main/groovy/xml/StreamingMarkupBuilder.groovy
index eaa31514cd..a7b0d7c061 100644
--- a/src/main/groovy/xml/StreamingMarkupBuilder.groovy
+++ b/src/main/groovy/xml/StreamingMarkupBuilder.groovy
@@ -20,6 +20,8 @@ import groovy.xml.streamingmarkupsupport.StreamingMarkupWriter
 import groovy.xml.streamingmarkupsupport.BaseMarkupBuilder
 
 class StreamingMarkupBuilder extends AbstractStreamingBuilder {
+    def omitNullAttributes = false
+    def omitEmptyAttributes = false
     def pendingStack = []
     def commentClosure = {doc, pendingNamespaces, namespaces, namespaceSpecificTags, prefix, attrs, body, out ->
         out.unescaped() << "<!--"
@@ -78,21 +80,26 @@ class StreamingMarkupBuilder extends AbstractStreamingBuilder {
         out = out.unescaped() << "<${tag}"
 
         attrs.each {key, value ->
-            if (key.contains('$')) {
-                def parts = key.tokenize('$')
-
-                if (namespaces.containsKey(parts[0]) || pendingNamespaces.containsKey(parts[0])) {
-                    key = parts[0] + ":" + parts[1]
-                } else {
-                    throw new GroovyRuntimeException("bad attribute namespace tag: ${parts[0]} in ${key}")
+            boolean skipNull = value == null && omitNullAttributes;
+            boolean skipEmpty = value != null && omitEmptyAttributes &&
+                    value.toString().length() == 0;
+            if (!skipNull && !skipEmpty) {
+                if (key.contains('$')) {
+                    def parts = key.tokenize('$')
+
+                    if (namespaces.containsKey(parts[0]) || pendingNamespaces.containsKey(parts[0])) {
+                        key = parts[0] + ":" + parts[1]
+                    } else {
+                        throw new GroovyRuntimeException("bad attribute namespace tag: ${parts[0]} in ${key}")
+                    }
                 }
-            }
 
-            out << " ${key}='"
-            out.writingAttribute = true
-            "${value}".build(doc)
-            out.writingAttribute = false
-            out << "'"
+                out << " ${key}='"
+                out.writingAttribute = true
+                "${value}".build(doc)
+                out.writingAttribute = false
+                out << "'"
+            }
         }
 
         def hiddenNamespaces = [:]
diff --git a/src/test/groovy/xml/MarkupBuilderTest.groovy b/src/test/groovy/xml/MarkupBuilderTest.groovy
index ffcfb6019c..0c6991a099 100644
--- a/src/test/groovy/xml/MarkupBuilderTest.groovy
+++ b/src/test/groovy/xml/MarkupBuilderTest.groovy
@@ -124,7 +124,7 @@ class MarkupBuilderTest extends GroovyTestCase {
   <elem1>hello1</elem1>
   <elem2>hello2</elem2>
   <nestedElem x='abc' y='def'>
-    <child z='def' />
+    <child z='def' nulltest=''/>
     <child2 />
   </nestedElem>
   <nestedElem2 z='zzz'>
@@ -174,7 +174,7 @@ class MarkupBuilderTest extends GroovyTestCase {
   <greaterthan>&gt;</greaterthan>
   <emptyElement />
   <null />
-  <nullAttribute />
+  <nullAttribute t1='' />
   <emptyWithAttributes attr1='set' />
   <emptyAttribute t1='' />
   <parent key='value'>
@@ -315,19 +315,18 @@ require escaping. The other characters consist of:
       assertExpectedXml '<p><em>call to outside</em></p>'
     }
 
-    void testOmitAttributeSettingsOmitNullKeepEmptyDefaultCase() {
+    void testOmitAttributeSettingsKeepBothDefaultCase() {
         xml.element(att1:null, att2:'')
-        assertExpectedXml "<element att2='' />"
+        assertExpectedXml "<element att1='' att2='' />"
     }
 
-    void testOmitAttributeSettingsKeepBoth() {
-        xml.omitNullAttributes = false
+    void testOmitAttributeSettingsOmitNullKeepEmpty() {
+        xml.omitNullAttributes = true
         xml.element(att1:null, att2:'')
-        assertExpectedXml "<element att1='' att2='' />"
+        assertExpectedXml "<element att2='' />"
     }
 
     void testOmitAttributeSettingsKeepNullOmitEmpty() {
-        xml.omitNullAttributes = false
         xml.omitEmptyAttributes = true
         xml.element(att1:null, att2:'')
         assertExpectedXml "<element att1='' />"
@@ -335,6 +334,7 @@ require escaping. The other characters consist of:
 
     void testOmitAttributeSettingsOmitBoth() {
         xml.omitEmptyAttributes = true
+        xml.omitNullAttributes = true
         xml.element(att1:null, att2:'')
         assertExpectedXml "<element />"
     }
diff --git a/src/test/groovy/xml/StreamingMarkupBuilderTest.groovy b/src/test/groovy/xml/StreamingMarkupBuilderTest.groovy
index 29cc14a666..a534451a17 100644
--- a/src/test/groovy/xml/StreamingMarkupBuilderTest.groovy
+++ b/src/test/groovy/xml/StreamingMarkupBuilderTest.groovy
@@ -22,11 +22,20 @@ import org.custommonkey.xmlunit.*
  * textual markup (XML or HTML) using GroovyMarkup
  */
 class StreamingMarkupBuilderTest extends TestXmlSupport {
-    
-    void testSmallTree() {
-        def b = new StreamingMarkupBuilder()
+
+    private assertExpectedXml(Closure markup, String expectedXml) {
+        assertExpectedXml new StreamingMarkupBuilder(), markup, expectedXml
+    }
+
+    private assertExpectedXml(StreamingMarkupBuilder builder, Closure markup, String expectedXml) {
         def writer = new StringWriter()
-        
+        writer << builder.bind(markup)
+        XMLUnit.ignoreWhitespace = true
+        def xmlDiff = new Diff(expectedXml, writer.toString())
+        assert xmlDiff.similar(), xmlDiff.toString()
+    }
+
+    void testSmallTree() {
         def m = {
             mkp.pi("xml-stylesheet":[href:"mystyle.css", type:"text/css"])
             root1(a:5, b:7) {
@@ -35,24 +44,16 @@ class StreamingMarkupBuilderTest extends TestXmlSupport {
                 elem3(x:7)
             }
         }
-
-        def expectedXml = '''\
+        assertExpectedXml m, '''\
 <?xml-stylesheet href="mystyle.css" type="text/css"?>
 <root1 a='5' b='7'>
   <elem1>hello1</elem1>
   <elem2>hello2</elem2>
   <elem3 x='7'/>
 </root1>'''
-        writer << b.bind(m)
-        XMLUnit.ignoreWhitespace = true
-        def xmlDiff = new Diff(expectedXml, writer.toString())
-        assert xmlDiff.similar(), xmlDiff.toString()
     }
 
     void testTree() {
-        def b = new StreamingMarkupBuilder()
-        def writer = new StringWriter()
-
         def m = {
             root2(a:5, b:7) {
                 elem1('hello1')
@@ -69,7 +70,7 @@ class StreamingMarkupBuilderTest extends TestXmlSupport {
             }
         }
 
-        def expectedXml = '''\
+        assertExpectedXml m, '''\
 <root2 a='5' b='7'>
   <elem1>hello1</elem1>
   <elem2>hello2</elem2>
@@ -82,11 +83,6 @@ class StreamingMarkupBuilderTest extends TestXmlSupport {
     <child2>hello</child2>
   </nestedElem2>
 </root2>'''
-
-        writer << b.bind(m)
-        XMLUnit.ignoreWhitespace = true
-        def xmlDiff = new Diff(expectedXml, writer.toString())
-        assert xmlDiff.similar(), xmlDiff.toString()
     }
 
     void testObjectOperationsInMarkup() {
@@ -101,9 +97,6 @@ class StreamingMarkupBuilderTest extends TestXmlSupport {
     }
 
     void testMixedMarkup() {
-        def b = new StreamingMarkupBuilder()
-        def writer = new StringWriter()
-
         def m = {
 // uncomment if you want entities like &nbsp; (and add to expected too)
 //            mkp.yieldUnescaped '''<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
@@ -119,16 +112,40 @@ class StreamingMarkupBuilderTest extends TestXmlSupport {
             }
         }
 
-        def expectedXml = '''\
+        assertExpectedXml m, '''\
 <html>
   <body>
     <p>The <i>quick</i> brown fox jumped over the <b>lazy</b> dog &amp; sleepy cat</p>
   </body>
 </html>'''
+    }
 
-        writer << b.bind(m)
-        XMLUnit.ignoreWhitespace = true
-        def xmlDiff = new Diff(expectedXml, writer.toString())
-        assert xmlDiff.similar(), xmlDiff.toString()
+    void testOmitAttributeSettingsKeepBothDefaultCase() {
+        def b = new StreamingMarkupBuilder()
+        def m = { element(att1:null, att2:'') }
+        assertExpectedXml b, m, "<element att1='' att2='' />"
     }
+
+    void testOmitAttributeSettingsOmitNull() {
+        def b = new StreamingMarkupBuilder()
+        b.omitNullAttributes = true
+        def m = { element(att1:null, att2:'') }
+        assertExpectedXml b, m, "<element att2='' />"
+    }
+
+    void testOmitAttributeSettingsOmitEmpty() {
+        def b = new StreamingMarkupBuilder()
+        b.omitEmptyAttributes = true
+        def m = { element(att1:null, att2:'') }
+        assertExpectedXml b, m, "<element att1='' />"
+    }
+
+    void testOmitAttributeSettingsOmitBoth() {
+        def b = new StreamingMarkupBuilder()
+        b.omitEmptyAttributes = true
+        b.omitNullAttributes = true
+        def m = { element(att1:null, att2:'') }
+        assertExpectedXml b, m, "<element />"
+    }
+
 }
\ No newline at end of file
