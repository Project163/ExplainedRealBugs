diff --git a/build.gradle b/build.gradle
index d78e9ce4f9..de4604f4ed 100644
--- a/build.gradle
+++ b/build.gradle
@@ -17,35 +17,6 @@ allprojects {
         mavenCentral()
     }
 
-    // todo: when we get rid of the Ant build, it will be much cleaner to use
-    // the conventional "resources" directory for classpath resources
-    task(copyResources, type: Copy) {
-        destinationDir = file("$buildDir/classes")
-        // text files requiring filtering
-        into("main") {
-            from('src/main/groovy')
-            from('src/main/java')
-            include('**/*.txt', '**/*.xml', '**/*.properties', '**/*.html')
-            filter(rootProject.propertiesFilter, org.apache.tools.ant.filters.ReplaceTokens)
-        }
-        // other resources
-        into("main") {
-            from 'src/main/groovy'
-            from 'src/main/java'
-            include('**/*.png', '**/*.gif', '**/*.ico', '**/*.css')
-        }
-    }
-
-    compileJava.dependsOn(copyResources)
-
-    task(copyTestResources, type: Copy)
-            .from('src/test/groovy')
-            .from('src/test/java')
-            .into("$buildDir/classes/test")
-            .include('**/*.txt', '**/*.xml', '**/*.properties', '**/*.png', '**/*.html', '**/*.gif', '**/*.ico', '**/*.css')
-
-    compileTestJava.dependsOn(copyTestResources)
-
     task sourceJar(type: Jar) {
         classifier = 'sources'
         from sourceSets.main.allSource
@@ -109,6 +80,55 @@ allprojects {
 
 }
 
+// todo: use the conventional "resources" directory for classpath resources
+task(copyResources, type: Copy) {
+    destinationDir = file("$buildDir/classes")
+    // text files requiring filtering
+    into("main") {
+        from('src/main')
+        include('**/*.txt', '**/*.xml', '**/*.properties', '**/*.html')
+        filter(rootProject.propertiesFilter, org.apache.tools.ant.filters.ReplaceTokens)
+    }
+    // other resources
+    into("main") {
+        from 'src/main'
+        include('**/*.png', '**/*.gif', '**/*.ico', '**/*.css')
+    }
+}
+compileJava.dependsOn(copyResources)
+task(copyTestResources, type: Copy)
+        .from('src/test')
+        .into("$buildDir/classes/test")
+        .include('**/*.txt', '**/*.xml', '**/*.properties', '**/*.png', '**/*.html', '**/*.gif', '**/*.ico', '**/*.css')
+compileTestJava.dependsOn(copyTestResources)
+
+subprojects {
+    // todo: use the conventional "resources" directory for classpath resources
+    task(copyResources, type: Copy) {
+        destinationDir = file("$buildDir/classes")
+        // text files requiring filtering
+        into("main") {
+            from('src/main/groovy')
+            from('src/main/java')
+            include('**/*.txt', '**/*.xml', '**/*.properties', '**/*.html')
+            filter(rootProject.propertiesFilter, org.apache.tools.ant.filters.ReplaceTokens)
+        }
+        // other resources
+        into("main") {
+            from 'src/main/groovy'
+            from 'src/main/java'
+            include('**/*.png', '**/*.gif', '**/*.ico', '**/*.css')
+        }
+    }
+    compileJava.dependsOn(copyResources)
+    task(copyTestResources, type: Copy)
+            .from('src/test/groovy')
+            .from('src/test/java')
+            .into("$buildDir/classes/test")
+            .include('**/*.txt', '**/*.xml', '**/*.properties', '**/*.png', '**/*.html', '**/*.gif', '**/*.ico', '**/*.css')
+    compileTestJava.dependsOn(copyTestResources)
+}
+
 repositories {
     // todo Some repos are needed only for some configs. Declare them just for the configuration once Gradle allows this.
 //    mavenCentral() // default, tools
@@ -281,7 +301,6 @@ sourceSets {
                     "org/codehaus/groovy/tools/groovydoc/gstringTemplates/**/*.*",
                     "org/codehaus/groovy/tools/groovy.ico"
         }
-        output.classesDir = "$buildDir/classes" as File
     }
     test {
         groovy {
@@ -379,27 +398,28 @@ ext.modules = this.&modules()
 
 task dgmConverter(type: JavaExec, dependsOn: 'classes') {
     description = 'Generates DGM info file required for faster startup.'
-    classpath = files(file('target/classes')) + configurations.compile
+    ext.classesDir = sourceSets.main.output.classesDir
+    classpath = files(classesDir) + configurations.compile
     main = 'org.codehaus.groovy.tools.DgmConverter'
-    args = ['--info']
+    args = ['--info', classesDir.absolutePath]
     doFirst {
-        file('target/classes/META-INF').mkdirs()
+        file("$classesDir/META-INF").mkdirs()
     }
     inputs.files fileTree(dir: projectDir, includes: ['src/**/*GroovyMethods.java'])
-    outputs.file file('target/classes/META-INF/dgminfo')
+    outputs.file file("$classesDir/META-INF/dgminfo")
 }
 
 task compilerDgmConverter(type: JavaExec) {
     description = 'Generates DGM info file for the bootstrap compiler'
-    classpath = files(file('target/classes/compiler')) + configurations.compilerCompile
+    ext.compilerClassesDir = sourceSets.compiler.output.classesDir
+    classpath = files(compilerClassesDir) + configurations.compilerCompile
     main = 'org.codehaus.groovy.tools.DgmConverter'
-    ext.compilerDirPath = file('target/classes/compiler').absolutePath
-    args = ['--info', compilerDirPath]
+    args = ['--info', compilerClassesDir.absolutePath]
     doFirst {
-        file('target/classes/compiler/META-INF').mkdirs()
+        file("$compilerClassesDir/META-INF").mkdirs()
     }
     inputs.files fileTree(dir: projectDir, includes: ['src/**/*GroovyMethods.java'])
-    outputs.file file('target/classes/compiler/META-INF/dgminfo')
+    outputs.file file("$compilerClassesDir/META-INF/dgminfo")
 }
 
 compileCompilerJava {
diff --git a/gradle/assemble.gradle b/gradle/assemble.gradle
index a15cb4889e..ccae7b076c 100644
--- a/gradle/assemble.gradle
+++ b/gradle/assemble.gradle
@@ -95,7 +95,7 @@ jar {
         }
         manifest groovyOsgiManifest
     }
-    exclude '**/package-info.class', 'compiler', 'META-INF/groovy-release-info.properties', 'main'
+    exclude '**/package-info.class', 'META-INF/groovy-release-info.properties'
 }
 
 subprojects {
@@ -113,7 +113,7 @@ subprojects {
             }
             manifest subprojectOsgiManifest
         }
-        exclude '**/package-info.class', 'compiler', 'META-INF/groovy-release-info.properties', 'main'
+        exclude '**/package-info.class', 'META-INF/groovy-release-info.properties'
     }
 }
 
diff --git a/src/test/org/codehaus/groovy/runtime/m12n/ExtensionModuleTest.groovy b/src/test/org/codehaus/groovy/runtime/m12n/ExtensionModuleTest.groovy
index 7ed2aa1585..63a51e273d 100644
--- a/src/test/org/codehaus/groovy/runtime/m12n/ExtensionModuleTest.groovy
+++ b/src/test/org/codehaus/groovy/runtime/m12n/ExtensionModuleTest.groovy
@@ -1,6 +1,5 @@
 package org.codehaus.groovy.runtime.m12n
 
-import org.codehaus.groovy.runtime.metaclass.MetaClassRegistryImpl
 import java.lang.reflect.Modifier
 
 /**
@@ -8,15 +7,22 @@ import java.lang.reflect.Modifier
  */
 class ExtensionModuleTest extends GroovyTestCase {
 
+    private List<ExtensionModule> savedModules
+
     @Override
     protected void setUp() {
         super.setUp()
+        // save modules here to clean up after ourselves
+        savedModules = GroovySystem.metaClassRegistry.moduleRegistry.modules
+    }
 
-        // in order to test the @Grab behaviour, we need to replace the registry between each test
-        GroovySystem.getDeclaredField('META_CLASS_REGISTRY').with {
+    @Override
+    protected void tearDown() {
+        super.tearDown()
+        GroovySystem.metaClassRegistry.moduleRegistry.class.getDeclaredField('modules').with {
             accessible = true
             modifiers = modifiers & ~Modifier.FINAL
-            set(null, new MetaClassRegistryImpl())
+            set(GroovySystem.metaClassRegistry.moduleRegistry, savedModules)
         }
     }
 
@@ -35,7 +41,7 @@ class ExtensionModuleTest extends GroovyTestCase {
     void testThatModuleCanBeLoadedWithGrab() {
         ExtensionModuleRegistry registry = GroovySystem.metaClassRegistry.moduleRegistry
         // ensure that the module isn't loaded
-        assert registry.modules.any { it.name == 'Test module for Grab' && it.version == '1.2-test' } == false
+        assert !registry.modules.any { it.name == 'Test module for Grab' && it.version == '1.2-test' }
 
         // find jar resource
         def jarURL = this.class.getResource("/jars")
@@ -43,28 +49,29 @@ class ExtensionModuleTest extends GroovyTestCase {
 
         def resolver = "@GrabResolver(name='local',root='$jarURL')"
 
-        assertScript resolver+'''
+        assertScript resolver + '''
         @Grab('module-test:module-test:1.2-test')
         import org.codehaus.groovy.runtime.m12n.*
 
+        // ensure that the module is now loaded
         ExtensionModuleRegistry registry = GroovySystem.metaClassRegistry.moduleRegistry
-        registry.modules.each { println "Found module ${it.name}" }
-
-        // ensure that the module isn't loaded
         assert registry.modules.any { it.name == 'Test module for Grab' && it.version == '1.2-test' }
 
         // the following methods are added by the Grab test module
         def str = 'This is a string'
         assert str.reverseToUpperCase2() == str.toUpperCase().reverse()
         assert String.answer2() == 42
-
         '''
+
+        // it should still be available
+        assert registry.modules.any { it.name == 'Test module for Grab' && it.version == '1.2-test' }
     }
 
     void testExtensionModuleUsingGrabAndMap() {
+        println "ExtensionModuleTest.testExtensionModuleUsingGrabAndMap"
         ExtensionModuleRegistry registry = GroovySystem.metaClassRegistry.moduleRegistry
         // ensure that the module isn't loaded
-        assert registry.modules.any { it.name == 'Test module for Grab' && it.version == '1.2-test' } == false
+        assert !registry.modules.any { it.name == 'Test module for Grab' && it.version == '1.2-test' }
 
         // find jar resource
         def jarURL = this.class.getResource("/jars")
@@ -72,14 +79,13 @@ class ExtensionModuleTest extends GroovyTestCase {
 
         def resolver = "@GrabResolver(name='local',root='$jarURL')"
 
-        assertScript resolver+'''
+        assertScript resolver + '''
         @Grab('module-test:module-test:1.2-test')
         import org.codehaus.groovy.runtime.m12n.*
 
         def map = [:]
         assert 'foo'.taille() == 3
         assert map.taille() == 0
-
         '''
     }
 }
