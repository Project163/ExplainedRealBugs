diff --git a/src/main/java/org/codehaus/groovy/classgen/asm/sc/StaticInvocationWriter.java b/src/main/java/org/codehaus/groovy/classgen/asm/sc/StaticInvocationWriter.java
index d3d439a822..bd0f364ea8 100644
--- a/src/main/java/org/codehaus/groovy/classgen/asm/sc/StaticInvocationWriter.java
+++ b/src/main/java/org/codehaus/groovy/classgen/asm/sc/StaticInvocationWriter.java
@@ -381,7 +381,7 @@ public class StaticInvocationWriter extends InvocationWriter {
                     ClassNode current = classNode.getOuterClass();
                     fixedReceiver = new VariableExpression("thisObject", current);
                     // adjust for multiple levels of nesting if needed
-                    while (current instanceof InnerClassNode && !classNode.equals(current)) {
+                    while (current instanceof InnerClassNode && !target.getDeclaringClass().equals(current)) {
                         FieldNode thisField = current.getField("this$0");
                         current = current.getOuterClass();
                         if (thisField != null) {
diff --git a/src/test/groovy/bugs/Groovy8764Bug.groovy b/src/test/groovy/bugs/Groovy8764Bug.groovy
index 72486677be..a092574d23 100644
--- a/src/test/groovy/bugs/Groovy8764Bug.groovy
+++ b/src/test/groovy/bugs/Groovy8764Bug.groovy
@@ -19,7 +19,7 @@
 package groovy.bugs
 
 class Groovy8764Bug extends GroovyTestCase {
-    void testDgmMethodInClosureInInnerClass() {
+    void testDgmMethodInClosureInAnonymousInnerClass() {
         assertScript '''
             import groovy.transform.*
 
@@ -41,4 +41,28 @@ class Groovy8764Bug extends GroovyTestCase {
             assert gt.hasMeta
         '''
     }
+
+    void testDgmMethodInClosureInInnerClass() {
+        assertScript '''
+        import groovy.transform.*
+        import java.util.function.Function
+
+            @CompileStatic
+            class Outer {
+                static class Inner {
+                    List<Optional<String>> pets = [Optional.of('goldfish'), Optional.of('cat')]
+                    Optional<Integer> test(int index) {
+                        pets[index].flatMap({ String s ->
+                            // sprintf is a DGM method on Object
+                            sprintf('%s', s).size() == 3 ? Optional.of(index) : Optional.empty()
+                        } as Function<String, Optional<Integer>>)
+                    }
+                }
+            }
+
+            def oi = new Outer.Inner()
+            assert !oi.test(0)
+            assert oi.test(1).value == 1
+        '''
+    }
 }
