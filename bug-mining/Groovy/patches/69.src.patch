diff --git a/src/main/groovy/lang/MetaClass.java b/src/main/groovy/lang/MetaClass.java
index 6608b817cc..20c69c5c4a 100644
--- a/src/main/groovy/lang/MetaClass.java
+++ b/src/main/groovy/lang/MetaClass.java
@@ -1,36 +1,47 @@
 /*
- * $Id$
- *
- * Copyright 2003 (C) James Strachan and Bob Mcwhirter. All Rights Reserved.
- *
- * Redistribution and use of this software and associated documentation
- * ("Software"), with or without modification, are permitted provided that the
- * following conditions are met:
- *  1. Redistributions of source code must retain copyright statements and
- * notices. Redistributions must also contain a copy of this document.
- *  2. Redistributions in binary form must reproduce the above copyright
- * notice, this list of conditions and the following disclaimer in the
- * documentation and/or other materials provided with the distribution.
- *  3. The name "groovy" must not be used to endorse or promote products
- * derived from this Software without prior written permission of The Codehaus.
- * For written permission, please contact info@codehaus.org.
- *  4. Products derived from this Software may not be called "groovy" nor may
- * "groovy" appear in their names without prior written permission of The
- * Codehaus. "groovy" is a registered trademark of The Codehaus.
- *  5. Due credit should be given to The Codehaus - http://groovy.codehaus.org/
- *
- * THIS SOFTWARE IS PROVIDED BY THE CODEHAUS AND CONTRIBUTORS ``AS IS'' AND ANY
- * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
- * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
- * DISCLAIMED. IN NO EVENT SHALL THE CODEHAUS OR ITS CONTRIBUTORS BE LIABLE FOR
- * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
- * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
- * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
- * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
- * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
- * DAMAGE.
- *
+ $Id$
+
+ Copyright 2003 (C) James Strachan and Bob Mcwhirter. All Rights Reserved.
+
+ Redistribution and use of this software and associated documentation
+ ("Software"), with or without modification, are permitted provided
+ that the following conditions are met:
+
+ 1. Redistributions of source code must retain copyright
+    statements and notices.  Redistributions must also contain a
+    copy of this document.
+
+ 2. Redistributions in binary form must reproduce the
+    above copyright notice, this list of conditions and the
+    following disclaimer in the documentation and/or other
+    materials provided with the distribution.
+
+ 3. The name "groovy" must not be used to endorse or promote
+    products derived from this Software without prior written
+    permission of The Codehaus.  For written permission,
+    please contact info@codehaus.org.
+
+ 4. Products derived from this Software may not be called "groovy"
+    nor may "groovy" appear in their names without prior written
+    permission of The Codehaus. "groovy" is a registered
+    trademark of The Codehaus.
+
+ 5. Due credit should be given to The Codehaus -
+    http://groovy.codehaus.org/
+
+ THIS SOFTWARE IS PROVIDED BY THE CODEHAUS AND CONTRIBUTORS
+ ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
+ NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
+ FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
+ THE CODEHAUS OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
+ SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ OF THE POSSIBILITY OF SUCH DAMAGE.
+
  */
 package groovy.lang;
 
diff --git a/src/main/org/codehaus/groovy/ast/Parameter.java b/src/main/org/codehaus/groovy/ast/Parameter.java
index 51290b5d78..72828a4490 100644
--- a/src/main/org/codehaus/groovy/ast/Parameter.java
+++ b/src/main/org/codehaus/groovy/ast/Parameter.java
@@ -45,6 +45,8 @@
  */
 package org.codehaus.groovy.ast;
 
+import groovy.lang.Reference;
+
 import org.codehaus.groovy.ast.expr.*;
 
 /**
@@ -63,6 +65,7 @@ public class Parameter {
     private String name;
     private boolean dynamicType;
     private Expression defaultValue;
+    private String realType;
 
     public Parameter(String name) {
         this("java.lang.Object", name);
@@ -109,4 +112,18 @@ public class Parameter {
     public Expression getDefaultValue() {
         return defaultValue;
     }
+
+    public void makeReference() {
+        realType = type;
+        type = Reference.class.getName();
+    }
+    
+    /**
+     * @return the real logical type if a dereference is being made 
+     * (e.g. to share variables across closure scopes)
+     */
+    public String getRealType() {
+        return realType;
+    }
+
 }
diff --git a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
index f31161a82a..d3155aa014 100644
--- a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
+++ b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
@@ -1054,8 +1054,12 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
         }
 
         passingClosureParams = true;
-        Parameter[] localVariableParams = getClosureSharedVariables(expression);
-        for (int i = 0; i < localVariableParams.length; i++) {
+        List constructors = innerClass.getConstructors();
+        ConstructorNode node = (ConstructorNode) constructors.get(0);
+        Parameter[] localVariableParams = node.getParameters();
+        
+        //Parameter[] localVariableParams = getClosureSharedVariables(expression);
+        for (int i = 2; i < localVariableParams.length; i++) {
             Parameter param = localVariableParams[i];
             String name = param.getName();
 
@@ -1106,7 +1110,7 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
         String prototype = "(L" + helper.getClassInternalName(ownerTypeName) + ";Ljava/lang/Object;";
 
         // now lets load the various parameters we're passing
-        for (int i = 0; i < localVariableParams.length; i++) {
+        for (int i = 2; i < localVariableParams.length; i++) {
             Parameter param = localVariableParams[i];
             String name = param.getName();
 
@@ -1994,13 +1998,14 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
             if (holder) {
                 initialValue = new VariableExpression(paramName);
                 type = Reference.class.getName();
+                param.makeReference();
             }
 
             FieldNode paramField = null;
             if (holder) {
                 paramField = answer.addField(paramName, ACC_PRIVATE, type, initialValue);
                 paramField.setHolder(true);
-                String realType = param.getType();
+                String realType = param.getRealType();
                 String methodName = Verifier.capitalize(paramName);
 
                 // lets add a getter & setter
diff --git a/src/main/org/codehaus/groovy/classgen/Verifier.java b/src/main/org/codehaus/groovy/classgen/Verifier.java
index 329a0cd589..f1f5fc00c8 100644
--- a/src/main/org/codehaus/groovy/classgen/Verifier.java
+++ b/src/main/org/codehaus/groovy/classgen/Verifier.java
@@ -105,6 +105,8 @@ public class Verifier implements GroovyClassVisitor, Constants {
     public void visitClass(ClassNode node) {
         this.classNode = node;
 
+        addDefaultParameterMethods(node);
+        
         if (!node.isDerivedFromGroovyObject()) {
             node.addInterface(GroovyObject.class.getName());
 
@@ -318,7 +320,32 @@ public class Verifier implements GroovyClassVisitor, Constants {
     }
 
     // Implementation methods
+    //-------------------------------------------------------------------------
+    
+    protected void addDefaultParameterMethods(ClassNode node) {
+        /*
+        for (Iterator iter = node.getMethods().iterator(); iter.hasNext(); ) {
+            MethodNode method = (MethodNode) iter.next();
+            Parameter[] parameters = method.getParameters();
+            int size = parameters.length;
+            for (int i = 0; i < size; i++ ) {
+                Parameter parameter = parameters[i];
+                Expression exp = parameter.getDefaultValue();
+                if (exp != null) {
+                    // lets create a method using this expression
+                    Parameter[] newParams = new Parameter[i];
+                    System.arraycopy(parameters, 0, newParams, 0, i);
+                    
+                    MethodCallExpression expression = new MethodCallExpression(VariableExpression.THIS_EXPRESSION, method.getName()), )
+                    node.addMethod(method.getName(), method.getReturnType(), newParams, )
+                    System.out.println("Creating defaultParam method for param: " + parameter);
+                }
+            }
+        }
+        */
+    }
 
+    
     protected void addClosureCode(InnerClassNode node) {
         // add a new invoke
     }
diff --git a/src/test/groovy/DefaultParamTest.groovy b/src/test/groovy/DefaultParamTest.groovy
new file mode 100644
index 0000000000..cebb69c096
--- /dev/null
+++ b/src/test/groovy/DefaultParamTest.groovy
@@ -0,0 +1,22 @@
+class DefaultParamTest extends GroovyTestCase {
+
+    void testDefaultParameters() {
+    	value = doSomething("X", "Y", "Z")
+    	assert value == "X-Y-Z"
+    	
+    	/*
+    	value = doSomething("X", "Y")
+    	assert value == "X-Y-defC"
+    	
+    	value = doSomething("X")
+    	assert value == "X-defB-defC"
+    	*/
+    	
+    	shouldFail { doSomething() }
+    }
+
+
+	doSomething(a, b = 'defB', c = 'defC') {
+		return a + "-" + b + "-" + c
+	}
+}
\ No newline at end of file
diff --git a/src/test/groovy/bugs/ClosureTypedVariableBug.groovy b/src/test/groovy/bugs/ClosureTypedVariableBug.groovy
new file mode 100644
index 0000000000..b1b129d91a
--- /dev/null
+++ b/src/test/groovy/bugs/ClosureTypedVariableBug.groovy
@@ -0,0 +1,34 @@
+/**
+ * @version $Revision$
+ */
+class ClosureTypedVariableBug extends GroovyTestCase {
+    
+    void testBug2() {
+   		
+        Integer count = 0
+        closure = { count = it }
+        closure(1)
+        assert count == 1
+    }
+    
+    void testBug() {
+   		count = makeClosure(0)
+        assert count == 1
+    }
+
+/** @todo can't turn a parameter into a reference
+
+    makeClosure(Number count) {
+    	closure = { count = it }
+    	closure(1)
+    	return count
+    }
+*/
+
+    makeClosure(Number c) {
+    	count = c
+    	closure = { count = it }
+    	closure(1)
+    	return count
+    }
+}
\ No newline at end of file
diff --git a/src/test/groovy/sql/SqlWithTypedResultsTest.groovy b/src/test/groovy/sql/SqlWithTypedResultsTest.groovy
new file mode 100644
index 0000000000..a574408c37
--- /dev/null
+++ b/src/test/groovy/sql/SqlWithTypedResultsTest.groovy
@@ -0,0 +1,37 @@
+package groovy.sql
+
+import groovy.xml.MarkupBuilder 
+
+/** @todo bug - should not need this line */
+import groovy.sql.TestHelper
+
+/**
+ * @author Thomas Heller
+ * @version $Revision$
+ */
+class SqlWithTypedResultsTest extends TestHelper {
+
+    void testSqlQuery() {
+         sql = createEmptySql()
+         
+         sql.execute("create table groovytest ( anint integer, astring varchar )");
+
+         groovytest = sql.dataSet("groovytest")
+         groovytest.add( anint:1, astring:"Groovy" )
+         groovytest.add( anint:2, astring:"rocks" )
+
+         // this line messes up things:
+         Integer id = 0
+		 
+         sql.eachRow("SELECT * FROM groovytest ORDER BY anint") { 
+         	println "found ${it.astring} for id ${it.anint}"
+         	
+         	id = it.anint 
+         }
+
+         assert id == 2
+        
+         sql.close()
+    }
+}
+
diff --git a/src/test/groovy/sql/TestHelper.groovy b/src/test/groovy/sql/TestHelper.groovy
index c4c73870f0..acb8c65b53 100644
--- a/src/test/groovy/sql/TestHelper.groovy
+++ b/src/test/groovy/sql/TestHelper.groovy
@@ -11,6 +11,11 @@ class TestHelper extends GroovyTestCase {
         return foo.createSql()
     }
     
+    
+    protected createEmptySql() {
+        return newSql(getURI())
+    }
+    
     protected createSql() {
         sql = newSql(getURI())
         
diff --git a/src/test/org/codehaus/groovy/classgen/RunBugsTest.java b/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
index 638b318744..8aaae7e3ea 100644
--- a/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
+++ b/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
@@ -110,10 +110,17 @@ public class RunBugsTest extends TestSupport {
         GroovyObject object = compile("src/test/groovy/bugs/StaticMarkupBug.groovy");
         object.invokeMethod("testBug", null);
     }
-    */
     public void testOverloadInvokeMethodBug() throws Exception {
         GroovyObject object = compile("src/test/groovy/bugs/OverloadInvokeMethodBug.groovy");
         object.invokeMethod("testBug", null);
     }
+    */
+    
+    
+    
+    public void testClosureTypedVariableBug() throws Exception {
+        GroovyObject object = compile("src/test/groovy/bugs/ClosureTypedVariableBug.groovy");
+        object.invokeMethod("testBug", null);
+    }
         
    }
