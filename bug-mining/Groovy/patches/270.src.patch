diff --git a/src/main/groovy/xml/MarkupBuilder.java b/src/main/groovy/xml/MarkupBuilder.java
index 07bad8d501..aae5439e31 100644
--- a/src/main/groovy/xml/MarkupBuilder.java
+++ b/src/main/groovy/xml/MarkupBuilder.java
@@ -62,7 +62,6 @@ import java.util.Map;
  * @version $Revision$
  */
 public class MarkupBuilder extends BuilderSupport {
-
     private IndentPrinter out;
     private boolean nospace;
     private int state;
@@ -105,6 +104,7 @@ public class MarkupBuilder extends BuilderSupport {
     */
 
     protected Object createNode(Object name) {
+        this.nodeIsEmpty = true;
         toState(1, name);
         return name;
     }
@@ -169,6 +169,8 @@ public class MarkupBuilder extends BuilderSupport {
      * 
      * @param value to be searched and replaced for XML special characters.
      * @return value with XML characters escaped
+     * @deprecated
+     * @see #escapeXmlValue(String, boolean)
      */
     protected String transformValue(String value) {
         // & has to be checked and replaced before others
@@ -232,24 +234,59 @@ public class MarkupBuilder extends BuilderSupport {
      * have been replaced with the corresponding XML entities.
      */
     private String escapeXmlValue(String value, boolean isAttrValue){
-        // & has to be checked and replaced before others
-        if (value.matches(".*&.*")) {
-            value = value.replaceAll("&", "&amp;");
-        }
-        if (value.matches(".*<.*")) {
-            value = value.replaceAll("<", "&lt;");
-        }
-        if (value.matches(".*>.*")) {
-            value = value.replaceAll(">", "&gt;");
-        }
-        if (isAttrValue){
-            // The apostrophe is only escaped if the value is for an
-            // attribute, as opposed to element content.
-            if (value.matches(".*\\'.*")) {
-                value = value.replaceAll("\\'", "&apos;");
+        StringBuffer buffer = new StringBuffer(value);
+        for (int i = 0, n = buffer.length(); i < n; i++){
+            switch (buffer.charAt(i)){
+            case '&':
+                buffer.replace(i, i + 1, "&amp;");
+
+                // We're replacing a single character by a string of
+                // length 5, so we need to update the index variable
+                // and the total length.
+                i += 4;
+                n += 4;
+                break;
+
+            case '<':
+                buffer.replace(i, i + 1, "&lt;");
+
+                // We're replacing a single character by a string of
+                // length 4, so we need to update the index variable
+                // and the total length.
+                i += 3;
+                n += 3;
+                break;
+
+            case '>':
+                buffer.replace(i, i + 1, "&gt;");
+
+                // We're replacing a single character by a string of
+                // length 4, so we need to update the index variable
+                // and the total length.
+                i += 3;
+                n += 3;
+                break;
+
+            case '\'':
+                // The apostrophe is only escaped if the value is for an
+                // attribute, as opposed to element content.
+                if (isAttrValue){
+                    buffer.replace(i, i + 1, "&apos;");
+
+                    // We're replacing a single character by a string of
+                    // length 6, so we need to update the index variable
+                    // and the total length.
+                    i += 5;
+                    n += 5;
+                }
+                break;
+
+            default:
+                break;
             }
         }
-        return value;
+
+        return buffer.toString();
     }
 
     private void toState(int next, Object name) {
diff --git a/src/test/groovy/xml/MarkupBuilderTest.groovy b/src/test/groovy/xml/MarkupBuilderTest.groovy
new file mode 100644
index 0000000000..42c50cf49c
--- /dev/null
+++ b/src/test/groovy/xml/MarkupBuilderTest.groovy
@@ -0,0 +1,81 @@
+package groovy.xml;
+
+import groovy.util.GroovyTestCase
+
+/** 
+ * Tests that special XML chars are entitized by MarkupBuilder.
+ *
+ * @author <a href="mailto:scottstirling@rcn.com">Scott Stirling</a>
+ *
+ * @version $Revision: 1.4 $
+ *
+ *   Fix the cr lf handling of multiline stringon both of linux and Windows XP.
+ *   This test should success on Windows XP.
+ *
+ *   @author Pilho Kim
+ */
+class MarkupBuilderTest extends GroovyTestCase {
+ 
+    StringWriter writer = new StringWriter()
+    MarkupBuilder chars = new MarkupBuilder(writer)
+    XmlParser parser = new XmlParser()
+
+    void testBuilder() {
+        String expectedXml = 
+"""<chars>
+  <ampersand a='&amp;'>&amp;</ampersand>
+  <quote attr='"'>"</quote>
+  <apostrophe attr='&apos;'>'</apostrophe>
+  <lessthan attr='value'>chars: &amp; &lt; &gt; '</lessthan>
+  <element attr='value 1 &amp; 2'>chars: &amp; &lt; &gt; " in middle</element>
+  <greaterthan>&gt;</greaterthan>
+  <emptyElement />
+</chars>"""
+
+        // Generate the markup.
+        chars.chars {
+            ampersand(a: "&", "&")
+            quote(attr: "\"", "\"")
+            apostrophe(attr: "'", "'")
+            lessthan(attr: "value", "chars: & < > '") 
+            element(attr: "value 1 & 2", "chars: & < > \" in middle")
+            greaterthan(">")
+            emptyElement()
+        }
+
+        // Compare the MarkupBuilder generated XML with the 'expectedXml'
+        // string.
+        def outputValue = writer.toString()
+        if (expectedXml.indexOf("\r\n") >= 0)  expectedXml = expectedXml.replaceAll("\r\n", "\n");
+        if (outputValue.indexOf("\r\n") >= 0)  outputValue = outputValue.replaceAll("\r\n", "\n");
+        assertEquals(expectedXml, outputValue)
+    }
+
+    /**
+     * Tests that MarkupBuilder escapes element content correctly, even
+     * when the content contains line-endings.
+     */
+    void testEscapingMultiLineContent() {
+        def expectedXml = 
+"""<element>This is multi-line content with characters, such as &lt;, that
+require escaping. The other characters consist of:
+
+    * &gt; - greater than
+    * &amp; - ampersand
+</element>"""
+
+        // Generate the markup.
+        chars.element("""This is multi-line content with characters, such as <, that
+require escaping. The other characters consist of:
+
+    * > - greater than
+    * & - ampersand
+""")
+
+        // Compare the generated markup with the 'expectedXml' string.
+        def outputValue = writer.toString()
+        if (expectedXml.indexOf("\r\n") >= 0)  expectedXml = expectedXml.replaceAll("\r\n", "\n");
+        if (outputValue.indexOf("\r\n") >= 0)  outputValue = outputValue.replaceAll("\r\n", "\n");
+        assertEquals(expectedXml, outputValue)
+    }
+}
