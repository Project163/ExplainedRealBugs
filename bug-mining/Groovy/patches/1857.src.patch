diff --git a/src/main/org/codehaus/groovy/ast/ClassNode.java b/src/main/org/codehaus/groovy/ast/ClassNode.java
index d1f671bfa1..1182c6cfc5 100644
--- a/src/main/org/codehaus/groovy/ast/ClassNode.java
+++ b/src/main/org/codehaus/groovy/ast/ClassNode.java
@@ -1371,7 +1371,7 @@ public class ClassNode extends AnnotatedNode implements Opcodes {
 
     public ClassNode getPlainNodeReference() {
         if (ClassHelper.isPrimitiveType(this)) return this;
-        ClassNode n = new ClassNode(getName(),getModifiers(),getSuperClass(),null,null);
+        ClassNode n = new ClassNode(name, modifiers, superClass,null,null);
         n.isPrimaryNode = false;
         n.setRedirect(redirect());
         n.componentType = redirect().getComponentType();
diff --git a/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesCallSiteWriter.java b/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesCallSiteWriter.java
index 0b60b389fe..fca8aa23d2 100644
--- a/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesCallSiteWriter.java
+++ b/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesCallSiteWriter.java
@@ -546,6 +546,7 @@ public class StaticTypesCallSiteWriter extends CallSiteWriter implements Opcodes
         prepareSiteAndReceiver(receiver, message, false, controller.getCompileStack().isLHS());
         controller.getOperandStack().doGroovyCast(ClassHelper.Number_TYPE);
         visitBoxedArgument(arguments);
+        controller.getOperandStack().doGroovyCast(ClassHelper.Number_TYPE);
         int m2 = operandStack.getStackLength();
         MethodVisitor mv = controller.getMethodVisitor();
         mv.visitMethodInsn(INVOKESTATIC,
diff --git a/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java b/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java
index 8eb7aecc2a..546dce422d 100644
--- a/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java
+++ b/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java
@@ -17,6 +17,7 @@ package org.codehaus.groovy.classgen.asm.sc;
 
 import org.codehaus.groovy.ast.ClassHelper;
 import org.codehaus.groovy.ast.ClassNode;
+import org.codehaus.groovy.ast.MethodNode;
 import org.codehaus.groovy.ast.expr.Expression;
 import org.codehaus.groovy.ast.expr.VariableExpression;
 import org.codehaus.groovy.classgen.asm.StatementMetaTypeChooser;
diff --git a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
index 98daa4e6c6..bb89b6ee37 100644
--- a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
+++ b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
@@ -186,9 +186,10 @@ public abstract class StaticTypeCheckingSupport {
         // we already know the lengths are equal
         for (int i = 0; i < params.length; i++) {
             ClassNode paramType = params[i].getType();
-            if (!isAssignableTo(args[i], paramType)) return -1;
+            ClassNode argType = args[i];
+            if (!isAssignableTo(argType, paramType)) return -1;
             else {
-                if (!paramType.equals(args[i])) dist+=getDistance(args[i], paramType);
+                if (!paramType.equals(argType)) dist+=getDistance(argType, paramType);
             }
         }
         return dist;
diff --git a/src/main/org/codehaus/groovy/vmplugin/v5/Java5.java b/src/main/org/codehaus/groovy/vmplugin/v5/Java5.java
index 21d213e8e6..e98917e385 100644
--- a/src/main/org/codehaus/groovy/vmplugin/v5/Java5.java
+++ b/src/main/org/codehaus/groovy/vmplugin/v5/Java5.java
@@ -21,6 +21,7 @@ import org.codehaus.groovy.ast.*;
 import org.codehaus.groovy.ast.expr.*;
 import org.codehaus.groovy.ast.stmt.ReturnStatement;
 import org.codehaus.groovy.vmplugin.VMPlugin;
+import sun.reflect.generics.scope.ClassScope;
 
 import java.lang.annotation.*;
 import java.lang.reflect.*;
@@ -385,7 +386,7 @@ public class Java5 implements VMPlugin {
             front.setRedirect(back);
             return front;
         }
-        return back;
+        return back.getPlainNodeReference();
     }
 
     private Parameter[] makeParameters(CompileUnit cu, Type[] types, Class[] cls, Annotation[][] parameterAnnotations) {
diff --git a/src/test/groovy/transform/stc/DefaultGroovyMethodsSTCTest.groovy b/src/test/groovy/transform/stc/DefaultGroovyMethodsSTCTest.groovy
index f5af3f06f3..28b1c3a0af 100644
--- a/src/test/groovy/transform/stc/DefaultGroovyMethodsSTCTest.groovy
+++ b/src/test/groovy/transform/stc/DefaultGroovyMethodsSTCTest.groovy
@@ -85,5 +85,23 @@ class DefaultGroovyMethodsSTCTest extends StaticTypeCheckingTestCase {
             assert foo(text) == 'foo'
         '''
     }
+
+    // GROOVY-5584
+    void testEachOnMap() {
+        assertScript '''import org.codehaus.groovy.transform.stc.ExtensionMethodNode
+            import org.codehaus.groovy.runtime.DefaultGroovyMethods
+
+            @ASTTest(phase=INSTRUCTION_SELECTION, value= {
+                def mn = node.rightExpression.getNodeMetaData(DIRECT_METHOD_CALL_TARGET)
+                assert mn
+                assert mn instanceof ExtensionMethodNode
+                assert mn.declaringClass == MAP_TYPE
+                def en = mn.extensionMethodNode
+                assert en.declaringClass == make(DefaultGroovyMethods)
+                assert en.parameters[0].type == MAP_TYPE
+            })
+            def x = [a:1, b:3].each { k, v -> "$k$v" }
+        '''
+    }
 }
 
diff --git a/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy b/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy
new file mode 100644
index 0000000000..1ec8228f14
--- /dev/null
+++ b/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy
@@ -0,0 +1,46 @@
+/*
+ * Copyright 2003-2012 the original author or authors.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.codehaus.groovy.classgen.asm.sc
+
+import groovy.transform.stc.ClosuresSTCTest
+
+/**
+ * Unit tests for static compilation: closures.
+ *
+ * @author Cedric Champeau
+ */
+@Mixin(StaticCompilationTestSupport)
+class ClosuresStaticCompileTest extends ClosuresSTCTest {
+
+    @Override
+    protected void setUp() {
+        super.setUp()
+        extraSetup()
+    }
+
+    // GROOVY-5584
+    void testEachOnMapClosure() {
+        assertScript '''
+                def test() {
+                    def result = ""
+                    [a:1, b:3].each { key, value -> result += "$key$value" }
+                    assert result == "a1b3"
+                }
+                test()'''
+    }
+
+}
+
