diff --git a/src/main/org/codehaus/groovy/antlr/groovy.g b/src/main/org/codehaus/groovy/antlr/groovy.g
index 83138dd0bd..b2ad7c137c 100644
--- a/src/main/org/codehaus/groovy/antlr/groovy.g
+++ b/src/main/org/codehaus/groovy/antlr/groovy.g
@@ -9,6 +9,7 @@ import antlr.InputBuffer;
 import antlr.LexerSharedInputState;
 import antlr.CommonToken;
 import org.codehaus.groovy.GroovyBugError;
+import antlr.TokenStreamRecognitionException;
 }
 
 /** JSR-241 Groovy Recognizer
@@ -327,11 +328,22 @@ tokens {
     public void requireFailed(String problem, String solution) throws SemanticException {
         // TODO: Needs more work.
         Token lt = null;
-        try { lt = LT(1); }
-        catch (TokenStreamException ee) { }
-        if (lt == null)  lt = Token.badToken;
+        int lineNum = Token.badToken.getLine(), colNum = Token.badToken.getColumn();
+        try { 
+            lt = LT(1);
+            if(lt != null) {
+                lineNum = lt.getLine();
+                colNum = lt.getColumn();
+            }
+        }
+        catch (TokenStreamException ee) {
+            if(ee instanceof TokenStreamRecognitionException) {
+                lineNum = ((TokenStreamRecognitionException) ee).recog.getLine();
+                colNum = ((TokenStreamRecognitionException) ee).recog.getColumn();
+            }
+        }
         throw new SemanticException(problem + ";\n   solution: " + solution,
-                                    getFilename(), lt.getLine(), lt.getColumn());
+                                    getFilename(), lineNum, colNum);
     }
 
     public void addWarning(String warning, String solution) {
diff --git a/src/main/org/codehaus/groovy/runtime/typehandling/DefaultTypeTransformation.java b/src/main/org/codehaus/groovy/runtime/typehandling/DefaultTypeTransformation.java
index 71978852f8..65e3f3b93f 100644
--- a/src/main/org/codehaus/groovy/runtime/typehandling/DefaultTypeTransformation.java
+++ b/src/main/org/codehaus/groovy/runtime/typehandling/DefaultTypeTransformation.java
@@ -662,16 +662,13 @@ public class DefaultTypeTransformation {
         boolean[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[Z")) {
+        if (a instanceof boolean[]) {
             ans = (boolean[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new boolean[ia.length];
             for (int i = 0; i < ia.length; i++) {
-                if (ia[i] == null) {
-                    continue;
-                }
+                if (ia[i] == null) continue;
                 ans[i] = ((Boolean) ia[i]).booleanValue();
             }
         }
@@ -682,10 +679,9 @@ public class DefaultTypeTransformation {
         byte[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[B")) {
+        if (a instanceof byte[]) {
             ans = (byte[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new byte[ia.length];
             for (int i = 0; i < ia.length; i++) {
@@ -701,10 +697,9 @@ public class DefaultTypeTransformation {
         short[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[S")) {
+        if (a instanceof short[]) {
             ans = (short[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new short[ia.length];
             for (int i = 0; i < ia.length; i++) {
@@ -718,10 +713,9 @@ public class DefaultTypeTransformation {
         char[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[C")) {
+        if (a instanceof char[]) {
             ans = (char[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new char[ia.length];
             for (int i = 0; i < ia.length; i++) {
@@ -738,10 +732,9 @@ public class DefaultTypeTransformation {
         long[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[J")) {
+        if (a instanceof long[]) {
             ans = (long[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new long[ia.length];
             for (int i = 0; i < ia.length; i++) {
@@ -758,10 +751,9 @@ public class DefaultTypeTransformation {
         float[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[F")) {
+        if (a instanceof float[]) {
             ans = (float[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new float[ia.length];
             for (int i = 0; i < ia.length; i++) {
@@ -778,10 +770,9 @@ public class DefaultTypeTransformation {
         double[] ans = null;
 
         // conservative coding
-        if (a.getClass().getName().equals("[D")) {
+        if (a instanceof double[]) {
             ans = (double[]) a;
-        }
-        else {
+        } else {
             Object[] ia = (Object[]) a;
             ans = new double[ia.length];
             for (int i = 0; i < ia.length; i++) {
diff --git a/src/test/org/codehaus/groovy/antlr/GStringEndTest.groovy b/src/test/org/codehaus/groovy/antlr/GStringEndTest.groovy
new file mode 100644
index 0000000000..2a72035c5e
--- /dev/null
+++ b/src/test/org/codehaus/groovy/antlr/GStringEndTest.groovy
@@ -0,0 +1,14 @@
+import org.codehaus.groovy.control.*
+
+class GStringEndTest extends GroovyTestCase {
+    void testInvalidEndContainsLineNumber(){
+        try {
+            assertScript '''
+                def Target = "releases$"
+            '''
+        } catch (MultipleCompilationErrorsException mcee) {
+            def text = mcee.toString();
+            assert text.contains("line 2, column 41")
+        }
+  }
+}
\ No newline at end of file
