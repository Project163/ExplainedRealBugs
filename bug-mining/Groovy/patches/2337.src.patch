diff --git a/src/main/org/codehaus/groovy/classgen/ExtendedVerifier.java b/src/main/org/codehaus/groovy/classgen/ExtendedVerifier.java
index 5395c5451d..586e911188 100644
--- a/src/main/org/codehaus/groovy/classgen/ExtendedVerifier.java
+++ b/src/main/org/codehaus/groovy/classgen/ExtendedVerifier.java
@@ -16,7 +16,9 @@
 package org.codehaus.groovy.classgen;
 
 import org.codehaus.groovy.ast.*;
+import org.codehaus.groovy.ast.expr.DeclarationExpression;
 import org.codehaus.groovy.ast.stmt.ReturnStatement;
+import org.codehaus.groovy.ast.stmt.Statement;
 import org.codehaus.groovy.control.AnnotationConstantsVisitor;
 import org.codehaus.groovy.control.CompilerConfiguration;
 import org.codehaus.groovy.control.ErrorCollector;
@@ -34,7 +36,7 @@ import org.objectweb.asm.Opcodes;
  *
  * @author <a href='mailto:the[dot]mindstorm[at]gmail[dot]com'>Alex Popescu</a>
  */
-public class ExtendedVerifier implements GroovyClassVisitor {
+public class ExtendedVerifier extends ClassCodeVisitorSupport implements GroovyClassVisitor {
     public static final String JVM_ERROR_MESSAGE = "Please make sure you are running on a JVM >= 1.5";
 
     private SourceUnit source;
@@ -64,6 +66,11 @@ public class ExtendedVerifier implements GroovyClassVisitor {
         visitAnnotations(node, AnnotationNode.FIELD_TARGET);
     }
 
+    @Override
+    public void visitDeclarationExpression(DeclarationExpression expression) {
+        visitAnnotations(expression, AnnotationNode.LOCAL_VARIABLE_TARGET);
+    }
+
     public void visitConstructor(ConstructorNode node) {
         visitConstructorOrMethod(node, AnnotationNode.CONSTRUCTOR_TARGET);
     }
@@ -97,6 +104,11 @@ public class ExtendedVerifier implements GroovyClassVisitor {
             }
             this.source.getErrorCollector().addCollectorContents(errorCollector);
         }
+        Statement code = node.getCode();
+        if (code != null) {
+            code.visit(this);
+        }
+
     }
 
     public void visitProperty(PropertyNode node) {
@@ -204,6 +216,11 @@ public class ExtendedVerifier implements GroovyClassVisitor {
         );
     }
 
+    @Override
+    protected SourceUnit getSourceUnit() {
+        return source;
+    }
+
     // TODO use it or lose it
     public void visitGenericType(GenericsType genericsType) {
 
diff --git a/src/main/org/codehaus/groovy/transform/ASTTestTransformation.groovy b/src/main/org/codehaus/groovy/transform/ASTTestTransformation.groovy
index dec29146bd..a4ace9aaaa 100644
--- a/src/main/org/codehaus/groovy/transform/ASTTestTransformation.groovy
+++ b/src/main/org/codehaus/groovy/transform/ASTTestTransformation.groovy
@@ -1,6 +1,8 @@
 package org.codehaus.groovy.transform
 
 import org.codehaus.groovy.ast.AnnotationNode
+import org.codehaus.groovy.ast.ClassHelper
+import org.codehaus.groovy.ast.expr.ClassExpression
 import org.codehaus.groovy.ast.expr.ClosureExpression
 import org.codehaus.groovy.ast.expr.PropertyExpression
 import org.codehaus.groovy.ast.expr.VariableExpression
@@ -30,6 +32,7 @@ class ASTTestTransformation extends AbstractASTTransformation implements Compila
             } else if (member instanceof PropertyExpression) {
                 phase = CompilePhase.valueOf(member.propertyAsString)
             }
+            annotationNode.setMember('phase', new PropertyExpression(new ClassExpression(ClassHelper.make(CompilePhase)), phase.toString()))
         }
         member = annotationNode.getMember('value')
         if (member && !(member instanceof ClosureExpression)) {
