diff --git a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
index ef33820f75..98daa4e6c6 100644
--- a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
+++ b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
@@ -724,13 +724,17 @@ public abstract class StaticTypeCheckingSupport {
             dist += 256;
         }
 
-        ClassNode ref = compare;
+        if (receiver == UNKNOWN_PARAMETER_TYPE) {
+            return dist;
+        }
+
+        ClassNode ref = receiver;
         while (ref!=null) {
-            if (receiver.equals(ref) || receiver == UNKNOWN_PARAMETER_TYPE) {
+            if (compare.equals(ref)) {
                 break;
             }
-            if (ref.isInterface() && receiver.implementsInterface(ref)) {
-                dist += getMaximumInterfaceDistance(receiver, ref);
+            if (compare.isInterface() && ref.implementsInterface(compare)) {
+                dist += getMaximumInterfaceDistance(ref, compare);
                 break;
             }
             ref = ref.getSuperClass();
diff --git a/src/test/groovy/transform/stc/MethodCallsSTCTest.groovy b/src/test/groovy/transform/stc/MethodCallsSTCTest.groovy
index 256df0cb52..1d8a2fd3f4 100644
--- a/src/test/groovy/transform/stc/MethodCallsSTCTest.groovy
+++ b/src/test/groovy/transform/stc/MethodCallsSTCTest.groovy
@@ -635,6 +635,23 @@ class MethodCallsSTCTest extends StaticTypeCheckingTestCase {
         '''
     }
 
+    // GROOVY-5540
+    void testChoosePublicMethodInHierarchy() {
+        assertScript '''import groovy.transform.stc.MethodCallsSTCTest.Child2
+            class A {
+                int delegate() {
+                    @ASTTest(phase=INSTRUCTION_SELECTION, value={
+                        def md = node.rightExpression.getNodeMetaData(DIRECT_METHOD_CALL_TARGET)
+                        assert md.declaringClass.nameWithoutPackage == 'MethodCallsSTCTest$ChildWithPublic'
+                    })
+                    int res = new Child2().m()
+                    res
+                }
+            }
+            assert new A().delegate() == 2
+        '''
+    }
+
     static class MyMethodCallTestClass {
 
         static int mul(int... args) { args.toList().inject(1) { x,y -> x*y } }
@@ -658,4 +675,15 @@ class MethodCallsSTCTest extends StaticTypeCheckingTestCase {
         public final void printHtmlPart(final int partNumber) {}
         public final void createTagBody(int bodyClosureIndex, Closure<?> bodyClosure) {}
     }
+
+    public static class BaseWithProtected {
+        protected int m() { 1 }
+    }
+
+    public static class ChildWithPublic extends BaseWithProtected {
+        public int m() { 2 }
+    }
+
+    public static class Child2 extends ChildWithPublic {
+    }
 }
