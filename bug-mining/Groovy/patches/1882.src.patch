diff --git a/gradle/idea.gradle b/gradle/idea.gradle
index f982b650b6..27f6dac842 100644
--- a/gradle/idea.gradle
+++ b/gradle/idea.gradle
@@ -4,20 +4,42 @@
  * Inspired from the Gradle build.
  */
 
+def appendNode(node, text) {
+    node.append(new XmlParser().parseText(text))
+}
+
 allprojects {
     apply plugin: 'idea'
+
+    idea {
+        module.iml.withXml { provider ->
+            def node = provider.asNode()
+
+            // remove target classes from libraries
+            def moduleRoot = node.component.find { it.'@name' == 'NewModuleRootManager' }
+            def entries = moduleRoot.orderEntry.findAll { oe ->
+                oe.library.CLASSES.root.'@url' =~ /target/
+            }
+            if (entries) {
+                entries.each { moduleRoot.remove(it) }
+            }
+        }
+    }
 }
 
 idea {
 
     project {
-        jdkName = '1.6'
-        languageLevel = '1.6'
 
         ipr {
             withXml { provider ->
                 def node = provider.asNode()
 
+                // jdk, language level fix
+                def pRoot = node.component.find { it.'@name' == 'ProjectRootManager' }
+                pRoot.'@languageLevel' = 'JDK_1_5'
+                pRoot.'@project-jdk-name' = '1.7'
+
                 // Use git
                 def vcsConfig = node.component.find { it.'@name' == 'VcsDirectoryMappings' }
                 vcsConfig.mapping[0].'@vcs' = 'Git'
@@ -27,7 +49,7 @@ idea {
                 copyrightManager.@default = "ASL2"
                 def aslCopyright = copyrightManager.copyright.find { it.option.find { it.@name == "myName" }?.@value == "ASL2" }
                 if (aslCopyright == null) {
-                    copyrightManager.append(new XmlParser().parseText('''
+                    appendNode(copyrightManager, '''
                       <copyright>
                           <option name="notice" value="Copyright 2003-$today.year the original author or authors.&#10;&#10;Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);&#10;you may not use this file except in compliance with the License.&#10;You may obtain a copy of the License at&#10;&#10;     http://www.apache.org/licenses/LICENSE-2.0&#10;&#10;Unless required by applicable law or agreed to in writing, software&#10;distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&#10;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&#10;See the License for the specific language governing permissions and&#10;limitations under the License." />
                           <option name="keyword" value="Copyright" />
@@ -35,7 +57,14 @@ idea {
                           <option name="myName" value="ASL2" />
                           <option name="myLocal" value="true" />
                       </copyright>
-                '''))
+                ''')
+                }
+
+                def compilerConfig = node.component.find { it.@name == 'CompilerConfiguration' }
+                ['/groovy/inspect/swingui/AstBrowserProperties.groovy',
+                '/**/org.codehaus.groovy.runtime.ExtensionModule',
+                '*.jar'].each {
+                    appendNode(compilerConfig.wildcardResourcePatterns[0], "<entry name=\"$it\" />")
                 }
             }
         }
@@ -63,6 +92,79 @@ idea {
                         excludeNode.append(new XmlParser().parseText("<file url=\"$url\" />"))
                     }
                 }
+
+                // add sample configurations
+                def runmanager = node.component.find { it.'@name' == 'RunManager' }
+                appendNode(runmanager, '''<configuration default="false" name="Console" type="Application" factoryName="Application">
+      <extension name="coverage" enabled="false" merge="false" runner="idea">
+        <pattern>
+          <option name="PATTERN" value="groovy.ui.*" />
+          <option name="ENABLED" value="true" />
+        </pattern>
+      </extension>
+      <option name="MAIN_CLASS_NAME" value="groovy.ui.Console" />
+      <option name="VM_PARAMETERS" />
+      <option name="PROGRAM_PARAMETERS" />
+      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
+      <option name="ALTERNATIVE_JRE_PATH_ENABLED" value="false" />
+      <option name="ALTERNATIVE_JRE_PATH" />
+      <option name="ENABLE_SWING_INSPECTOR" value="false" />
+      <option name="ENV_VARIABLES" />
+      <option name="PASS_PARENT_ENVS" value="true" />
+      <module name="groovy-console" />
+      <envs />
+      <RunnerSettings RunnerId="Debug">
+        <option name="DEBUG_PORT" value="" />
+        <option name="TRANSPORT" value="0" />
+        <option name="LOCAL" value="true" />
+      </RunnerSettings>
+      <RunnerSettings RunnerId="Profile ">
+        <option name="myExternalizedOptions" />
+      </RunnerSettings>
+      <RunnerSettings RunnerId="Run" />
+      <ConfigurationWrapper RunnerId="Debug" />
+      <ConfigurationWrapper RunnerId="Run" />
+      <method />
+    </configuration>
+''')
+                appendNode(runmanager,'''<configuration default="false" name="groovy.transform.stc in groovy" type="JUnit" factoryName="JUnit">
+      <extension name="coverage" enabled="false" merge="false" runner="idea">
+        <pattern>
+          <option name="PATTERN" value="groovy.transform.stc.*" />
+          <option name="ENABLED" value="true" />
+        </pattern>
+      </extension>
+      <module name="groovy" />
+      <option name="ALTERNATIVE_JRE_PATH_ENABLED" value="false" />
+      <option name="ALTERNATIVE_JRE_PATH" />
+      <option name="PACKAGE_NAME" value="groovy.transform.stc" />
+      <option name="MAIN_CLASS_NAME" />
+      <option name="METHOD_NAME" />
+      <option name="TEST_OBJECT" value="package" />
+      <option name="VM_PARAMETERS" />
+      <option name="PARAMETERS" />
+      <option name="WORKING_DIRECTORY" value="$PROJECT_DIR$" />
+      <option name="ENV_VARIABLES" />
+      <option name="PASS_PARENT_ENVS" value="true" />
+      <option name="TEST_SEARCH_SCOPE">
+        <value defaultName="moduleWithDependencies" />
+      </option>
+      <envs />
+      <patterns />
+      <RunnerSettings RunnerId="Debug">
+        <option name="DEBUG_PORT" value="" />
+        <option name="TRANSPORT" value="0" />
+        <option name="LOCAL" value="true" />
+      </RunnerSettings>
+      <RunnerSettings RunnerId="Profile ">
+        <option name="myExternalizedOptions" />
+      </RunnerSettings>
+      <RunnerSettings RunnerId="Run" />
+      <ConfigurationWrapper RunnerId="Debug" />
+      <ConfigurationWrapper RunnerId="Run" />
+      <method />
+    </configuration>
+''')
             }
         }
     }
@@ -70,25 +172,28 @@ idea {
     module.iml.withXml { provider ->
         def node = provider.asNode()
 
-        // replace groovy-1.8.6.jar in libraries with the one generated in target
-        def entry = node.component.find { it.'@name' == 'NewModuleRootManager' }.orderEntry.find { oe ->
-            oe.library.CLASSES.root.'@url' =~ /groovy-(all-)?[0-9]\.[0-9]\.[0-9](-SNAPSHOT)?\.jar/
+        // remove compiler classes from libraries
+        def moduleRoot = node.component.find { it.'@name' == 'NewModuleRootManager' }
+        def entry = moduleRoot.orderEntry.find { oe ->
+            oe.library.CLASSES.root.'@url' =~ /classes\/compiler/
         }
         if (entry) {
-            //entry.library.CLASSES.root[0].'@url' = "jar://\$MODULE_DIR\$/target/libs/groovy-all-${groovyVersion}.jar!/"
-            entry.library.CLASSES.root[0].'@url' = "jar://\$MODULE_DIR\$/target/libs/groovy-${groovyVersion}.jar!/"
+            moduleRoot.remove(entry)
         }
-    }
 
-}
+        // add an entry for groovy jar
+        appendNode(moduleRoot, """
+            <orderEntry type="module-library" exported="">
+              <library>
+                <CLASSES>
+                  <root url="jar://${rootProject.jar.archivePath}!/"/>
+                </CLASSES>
+              </library>
+            </orderEntry>
+        """)
+    }
 
-tasks.withType(GenerateIdeaProject).all {
-    it.doLast {
-        println """
---------------------------------------------------------------------------------
- Project has been created, but it is recommended that you run the 'jarAll' task
- in order to provide IntelliJ IDEA a groovy jar that it can use for compilation
---------------------------------------------------------------------------------
-"""
+    tasks.withType(GenerateIdeaProject).all {
+        it.dependsOn(jar)
     }
 }
\ No newline at end of file
diff --git a/subprojects/groovy-console/build.gradle b/subprojects/groovy-console/build.gradle
index 41b929e43e..7750bcb9b9 100644
--- a/subprojects/groovy-console/build.gradle
+++ b/subprojects/groovy-console/build.gradle
@@ -4,6 +4,7 @@ dependencies {
     compile project(':')
     groovy project(':')
     compile project(':groovy-swing')
+    runtime project(':groovy-templates')
     testCompile project(':groovy-swing').sourceSets.test.runtimeClasspath
 }
 
diff --git a/subprojects/groovy-swing/build.gradle b/subprojects/groovy-swing/build.gradle
index d05cd7276b..7ed0dfc717 100644
--- a/subprojects/groovy-swing/build.gradle
+++ b/subprojects/groovy-swing/build.gradle
@@ -5,6 +5,7 @@ dependencies {
     compile project(':')
     groovy project(':')
     testCompile project(':').sourceSets.test.runtimeClasspath
+    testCompile project(':groovy-test')
 }
 task moduleDescriptor(type: org.codehaus.groovy.gradle.WriteExtensionDescriptorTask) {
     extensionClasses = 'org.codehaus.groovy.runtime.SwingGroovyMethods'
