diff --git a/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java b/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java
index 3e612e7dfd..4c2cdf6235 100644
--- a/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java
+++ b/src/main/java/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java
@@ -177,10 +177,33 @@ import static org.codehaus.groovy.ast.ClassHelper.getNextSuperClass;
 import static org.codehaus.groovy.ast.ClassHelper.getUnwrapper;
 import static org.codehaus.groovy.ast.ClassHelper.getWrapper;
 import static org.codehaus.groovy.ast.ClassHelper.int_TYPE;
+import static org.codehaus.groovy.ast.ClassHelper.isBigDecimalType;
+import static org.codehaus.groovy.ast.ClassHelper.isBigIntegerType;
+import static org.codehaus.groovy.ast.ClassHelper.isClassType;
+import static org.codehaus.groovy.ast.ClassHelper.isDynamicTyped;
 import static org.codehaus.groovy.ast.ClassHelper.isFunctionalInterface;
+import static org.codehaus.groovy.ast.ClassHelper.isGStringType;
 import static org.codehaus.groovy.ast.ClassHelper.isNumberType;
+import static org.codehaus.groovy.ast.ClassHelper.isObjectType;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveBoolean;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveByte;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveChar;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveDouble;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveFloat;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveInt;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveLong;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveShort;
 import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveType;
+import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveVoid;
 import static org.codehaus.groovy.ast.ClassHelper.isSAMType;
+import static org.codehaus.groovy.ast.ClassHelper.isStringType;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperByte;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperCharacter;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperDouble;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperFloat;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperInteger;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperLong;
+import static org.codehaus.groovy.ast.ClassHelper.isWrapperShort;
 import static org.codehaus.groovy.ast.ClassHelper.long_TYPE;
 import static org.codehaus.groovy.ast.ClassHelper.short_TYPE;
 import static org.codehaus.groovy.ast.tools.ClosureUtils.getParametersSafe;
@@ -209,29 +232,6 @@ import static org.codehaus.groovy.ast.tools.WideningCategories.isLongCategory;
 import static org.codehaus.groovy.ast.tools.WideningCategories.isNumberCategory;
 import static org.codehaus.groovy.ast.tools.WideningCategories.lowestUpperBound;
 import static org.codehaus.groovy.classgen.AsmClassGenerator.MINIMUM_BYTECODE_VERSION;
-import static org.codehaus.groovy.ast.ClassHelper.isBigDecimalType;
-import static org.codehaus.groovy.ast.ClassHelper.isBigIntegerType;
-import static org.codehaus.groovy.ast.ClassHelper.isClassType;
-import static org.codehaus.groovy.ast.ClassHelper.isDynamicTyped;
-import static org.codehaus.groovy.ast.ClassHelper.isGStringType;
-import static org.codehaus.groovy.ast.ClassHelper.isObjectType;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveBoolean;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveByte;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveChar;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveDouble;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveFloat;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveInt;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveLong;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveShort;
-import static org.codehaus.groovy.ast.ClassHelper.isPrimitiveVoid;
-import static org.codehaus.groovy.ast.ClassHelper.isStringType;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperByte;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperCharacter;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperDouble;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperFloat;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperInteger;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperLong;
-import static org.codehaus.groovy.ast.ClassHelper.isWrapperShort;
 import static org.codehaus.groovy.syntax.Types.ASSIGN;
 import static org.codehaus.groovy.syntax.Types.COMPARE_EQUAL;
 import static org.codehaus.groovy.syntax.Types.COMPARE_NOT_EQUAL;
@@ -2512,19 +2512,20 @@ public class StaticTypeCheckingVisitor extends ClassCodeVisitorSupport {
 
     protected void restoreVariableExpressionMetadata(final Map<VariableExpression, Map<StaticTypesMarker, Object>> typesBeforeVisit) {
         if (typesBeforeVisit != null) {
-            for (Map.Entry<VariableExpression, Map<StaticTypesMarker, Object>> entry : typesBeforeVisit.entrySet()) {
+            typesBeforeVisit.forEach((var, map) -> {
                 for (StaticTypesMarker marker : StaticTypesMarker.values()) {
-                    // GROOVY-9344, GROOVY-9516
+                    // GROOVY-9344, GROOVY-9516: keep type
                     if (marker == INFERRED_TYPE) continue;
 
-                    Object value = entry.getValue().get(marker);
+                    Object value = map.get(marker);
                     if (value == null) {
-                        entry.getKey().removeNodeMetaData(marker);
+                        var.removeNodeMetaData(marker);
                     } else {
-                        entry.getKey().putNodeMetaData(marker, value);
+                        var.putNodeMetaData(marker, value);
                     }
                 }
-            }
+                var.removeNodeMetaData(DECLARATION_INFERRED_TYPE); // GROOVY-8946
+            });
         }
     }
 
diff --git a/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy b/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy
index ce7a420b91..b2057a1225 100644
--- a/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy
+++ b/src/test/org/codehaus/groovy/classgen/asm/sc/ClosuresStaticCompileTest.groovy
@@ -28,12 +28,13 @@ class ClosuresStaticCompileTest extends ClosuresSTCTest implements StaticCompila
     // GROOVY-5584
     void testEachOnMapClosure() {
         assertScript '''
-                def test() {
-                    def result = ""
-                    [a:1, b:3].each { key, value -> result += "$key$value" }
-                    assert result == "a1b3"
-                }
-                test()'''
+            def test() {
+                def result = ""
+                [a:1, b:3].each { key, value -> result += "$key$value" }
+                assert result == "a1b3"
+            }
+            test()
+        '''
     }
 
     // GROOVY-5811
@@ -65,48 +66,44 @@ class ClosuresStaticCompileTest extends ClosuresSTCTest implements StaticCompila
     // GROOVY-6522
     void testShouldCallClosure() {
         assertScript '''
-class Sample {
-
-    Closure formatFirstName
-    Closure formatLastName
-
-    void doStuff (String fname, String lname, Closure callback) {
-        formatFirstName(fname) { String fnameError, String formattedFname ->
-            formatLastName(lname) { String lnameError, String formattedLname ->
-                String errors = "${fnameError ? "${fnameError}, " : ''}${lnameError ?: ''}"
-                callback(errors, formattedFname, formattedLname)
+            class Sample {
+                Closure formatFirstName, formatLastName
+
+                void doStuff (String fname, String lname, Closure callback) {
+                    formatFirstName(fname) { String fnameError, String formattedFname ->
+                        formatLastName(lname) { String lnameError, String formattedLname ->
+                            String errors = "${fnameError ? "${fnameError}, " : ''}${lnameError ?: ''}"
+                            callback(errors, formattedFname, formattedLname)
+                        }
+                    }
+                }
             }
-        }
-    }
-
-}
 
-Closure ffn = { String fname, Closure callback ->
-    String firstInitial = fname?.substring(0,1)
-
-    if (!firstInitial)
-        callback('invalid first name', null)
-    else
-        callback(null, firstInitial.toLowerCase())
-}
-
-Closure fln = { String lname, Closure callback ->
-    String lastPrefix = lname?.size() > 2 ? lname.substring(0,3) : null
+            Closure ffn = { String fname, Closure callback ->
+                String firstInitial = fname?.substring(0,1)
+                if (!firstInitial)
+                    callback('invalid first name', null)
+                else
+                    callback(null, firstInitial.toLowerCase())
+            }
 
-    if (!lastPrefix)
-        callback('invalid last name', null)
-    else
-        callback(null, lastPrefix.toLowerCase())
-}
+            Closure fln = { String lname, Closure callback ->
+                String lastPrefix = lname?.size() > 2 ? lname.substring(0,3) : null
+                if (!lastPrefix)
+                    callback('invalid last name', null)
+                else
+                    callback(null, lastPrefix.toLowerCase())
+            }
 
-Sample sample = new Sample(formatFirstName: ffn, formatLastName: fln)
+            Sample sample = new Sample(formatFirstName: ffn, formatLastName: fln)
 
-sample.doStuff('John', 'Doe') { String errors, String formattedFname, String formattedLname ->
-    if (errors)
-        println errors
-    else
-        println "${formattedFname}.${formattedLname}"
-}'''
+            sample.doStuff('John', 'Doe') { String errors, String formattedFname, String formattedLname ->
+                if (errors)
+                    println errors
+                else
+                    println "${formattedFname}.${formattedLname}"
+            }
+        '''
     }
 
     void testMethodVersusPropertyOnCompoundAssignmentTarget() {
diff --git a/src/test/org/codehaus/groovy/classgen/asm/sc/StaticCompileFlowTypingTest.groovy b/src/test/org/codehaus/groovy/classgen/asm/sc/StaticCompileFlowTypingTest.groovy
index 4b48fe48c4..76ad1b42a1 100644
--- a/src/test/org/codehaus/groovy/classgen/asm/sc/StaticCompileFlowTypingTest.groovy
+++ b/src/test/org/codehaus/groovy/classgen/asm/sc/StaticCompileFlowTypingTest.groovy
@@ -80,6 +80,43 @@ final class StaticCompileFlowTypingTest {
         '''
     }
 
+    // GROOVY-8946
+    void testFlowTyping4() {
+        assertScript '''
+            /*@GrabResolver(name='grails', root='https://repo.grails.org/grails/core')
+            @Grapes([
+                @Grab('javax.servlet:javax.servlet-api:3.0.1'),
+                @Grab('org.grails.plugins:converters:3.3.+'),
+                @Grab('org.grails:grails-web:3.3.+'),
+                @Grab('org.slf4j:slf4j-nop:1.7.30')
+            ])
+            @GrabExclude('org.codehaus.groovy:*')
+            import static grails.converters.JSON.parse
+            */
+            class JSONElement {
+                def getProperty(String name) {
+                    if (name == 'k') return [1,2]
+                }
+            }
+            JSONElement parse(String json) {
+                new JSONElement()
+            }
+
+            @groovy.transform.CompileStatic
+            def test() {
+                def json = parse('[{"k":1},{"k":2}]')
+                def vals = json['k']
+                assert vals == [1,2]
+                boolean result = 'k'.tokenize('.').every { token -> // 'k' represents a path like 'a.b.c.d'
+                    json = json[token]
+                }
+                assert result
+                return json // Cannot cast object '[1, 2]' with class 'java.util.ArrayList' to class 'org.grails.web.json.JSONElement'
+            }
+            test()
+        '''
+    }
+
     @Test
     void testInstanceOf() {
         assertScript '''
