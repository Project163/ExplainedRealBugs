diff --git a/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java b/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java
index 8f9a9c87a1..8e3e86bd7f 100644
--- a/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java
+++ b/src/main/org/codehaus/groovy/classgen/asm/sc/StaticTypesTypeChooser.java
@@ -15,8 +15,10 @@
  */
 package org.codehaus.groovy.classgen.asm.sc;
 
+import org.codehaus.groovy.ast.ASTNode;
 import org.codehaus.groovy.ast.ClassHelper;
 import org.codehaus.groovy.ast.ClassNode;
+import org.codehaus.groovy.ast.Parameter;
 import org.codehaus.groovy.ast.expr.Expression;
 import org.codehaus.groovy.ast.expr.VariableExpression;
 import org.codehaus.groovy.classgen.asm.StatementMetaTypeChooser;
@@ -31,10 +33,14 @@ import org.codehaus.groovy.transform.stc.StaticTypesMarker;
 public class StaticTypesTypeChooser extends StatementMetaTypeChooser {
     @Override
     public ClassNode resolveType(final Expression exp, final ClassNode current) {
-        Expression target = exp instanceof VariableExpression ? getTarget((VariableExpression) exp) : exp;
+        ASTNode target = exp instanceof VariableExpression ? getTarget((VariableExpression) exp) : exp;
         ClassNode inferredType = (ClassNode) target.getNodeMetaData(StaticTypesMarker.DECLARATION_INFERRED_TYPE);
         if (inferredType == null) {
             inferredType = (ClassNode) target.getNodeMetaData(StaticTypesMarker.INFERRED_TYPE);
+            if (inferredType == null && target instanceof VariableExpression && ((VariableExpression) target).getAccessedVariable() instanceof Parameter) {
+                target = (Parameter) ((VariableExpression) target).getAccessedVariable();
+                inferredType = ((Parameter) target).getOriginType();
+            }
         }
         if (inferredType != null) {
             if (ClassHelper.VOID_TYPE == inferredType) {
diff --git a/src/main/org/codehaus/groovy/transform/sc/StaticCompilationVisitor.java b/src/main/org/codehaus/groovy/transform/sc/StaticCompilationVisitor.java
index c2536e21b6..473fea3609 100644
--- a/src/main/org/codehaus/groovy/transform/sc/StaticCompilationVisitor.java
+++ b/src/main/org/codehaus/groovy/transform/sc/StaticCompilationVisitor.java
@@ -256,6 +256,7 @@ public class StaticCompilationVisitor extends StaticTypeCheckingVisitor {
             final ClassNode collectionType = getType(forLoop.getCollectionExpression());
             ClassNode componentType = inferLoopElementType(collectionType);
             forLoop.getVariable().setType(componentType);
+            forLoop.getVariable().setOriginType(componentType);
         }
     }
 
diff --git a/src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java b/src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java
index 224f7f512f..314a51cda7 100644
--- a/src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java
+++ b/src/main/org/codehaus/groovy/transform/sc/transformers/BooleanExpressionTransformer.java
@@ -73,7 +73,8 @@ public class BooleanExpressionTransformer {
         public OptimizingBooleanExpression(final Expression expression, final ClassNode type) {
             super(expression);
             this.expression = expression;
-            this.type = type;
+            // we must use the redirect node, otherwise InnerClassNode would not have the "correct" type
+            this.type = type.redirect();
         }
 
         @Override
@@ -89,12 +90,12 @@ public class BooleanExpressionTransformer {
             if (visitor instanceof AsmClassGenerator) {
                 AsmClassGenerator acg = (AsmClassGenerator) visitor;
                 WriterController controller = acg.getController();
-                if (type == ClassHelper.boolean_TYPE) {
+                if (type.equals(ClassHelper.boolean_TYPE)) {
                     expression.visit(visitor);
                     controller.getOperandStack().doGroovyCast(ClassHelper.boolean_TYPE);
                     return;
                 }
-                if (type == ClassHelper.Boolean_TYPE) {
+                if (type.equals(ClassHelper.Boolean_TYPE)) {
                     expression.visit(visitor);
                     // unbox
                     MethodVisitor mv = controller.getMethodVisitor();
@@ -102,24 +103,24 @@ public class BooleanExpressionTransformer {
                     controller.getOperandStack().replace(ClassHelper.boolean_TYPE);
                     return;
                 }
-                if (type == ClassHelper.int_TYPE || type == ClassHelper.byte_TYPE
-                        || type == ClassHelper.short_TYPE || type == ClassHelper.char_TYPE) {
+                if (type.equals(ClassHelper.int_TYPE) || type.equals(ClassHelper.byte_TYPE)
+                        || type.equals(ClassHelper.short_TYPE) || type.equals(ClassHelper.char_TYPE)) {
                     // int on stack
                     expression.visit(visitor);
                     return;
-                } else if (type == ClassHelper.long_TYPE) {
+                } else if (type.equals(ClassHelper.long_TYPE)) {
                     expression.visit(visitor);
                     MethodVisitor mv = controller.getMethodVisitor();
                     mv.visitInsn(L2I);
                     controller.getOperandStack().replace(ClassHelper.boolean_TYPE);
                     return;
-                } else if (type == ClassHelper.float_TYPE) {
+                } else if (type.equals(ClassHelper.float_TYPE)) {
                     expression.visit(visitor);
                     MethodVisitor mv = controller.getMethodVisitor();
                     mv.visitInsn(F2I);
                     controller.getOperandStack().replace(ClassHelper.boolean_TYPE);
                     return;
-                } else if (type == ClassHelper.double_TYPE) {
+                } else if (type.equals(ClassHelper.double_TYPE)) {
                     expression.visit(visitor);
                     MethodVisitor mv = controller.getMethodVisitor();
                     mv.visitInsn(D2I);
diff --git a/src/test/groovy/transform/stc/LoopsSTCTest.groovy b/src/test/groovy/transform/stc/LoopsSTCTest.groovy
index d0dc656052..b413c3e8e7 100644
--- a/src/test/groovy/transform/stc/LoopsSTCTest.groovy
+++ b/src/test/groovy/transform/stc/LoopsSTCTest.groovy
@@ -201,5 +201,24 @@ class LoopsSTCTest extends StaticTypeCheckingTestCase {
 
         '''
     }
+
+    // GROOVY-5641
+    void testShouldInferLoopElementTypeWithUndeclaredType() {
+        assertScript '''import org.codehaus.groovy.ast.stmt.ForStatement
+        @ASTTest(phase=INSTRUCTION_SELECTION, value= {
+            def forStmt = lookup('loop')[0]
+            assert forStmt instanceof ForStatement
+            def collectionType = forStmt.collectionExpression.getNodeMetaData(INFERRED_TYPE)
+            assert collectionType == make(IntRange)
+        })
+        void foo() {
+            int[] perm = new int[10]
+            loop:
+            for (i in 0..<10) {
+              assert perm[i-0] == 0
+            }
+        }
+        '''
+    }
 }
 
