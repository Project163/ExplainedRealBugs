diff --git a/src/main/org/codehaus/groovy/classgen/VariableScopeCodeVisitor.java b/src/main/org/codehaus/groovy/classgen/VariableScopeCodeVisitor.java
index 8272379220..56b551ca24 100644
--- a/src/main/org/codehaus/groovy/classgen/VariableScopeCodeVisitor.java
+++ b/src/main/org/codehaus/groovy/classgen/VariableScopeCodeVisitor.java
@@ -57,6 +57,7 @@ import org.codehaus.groovy.ast.expr.MethodCallExpression;
 import org.codehaus.groovy.ast.expr.PostfixExpression;
 import org.codehaus.groovy.ast.expr.PrefixExpression;
 import org.codehaus.groovy.ast.expr.VariableExpression;
+import org.codehaus.groovy.ast.stmt.ForStatement;
 
 /**
  * A visitor which figures out which variables are in scope
@@ -104,6 +105,12 @@ public class VariableScopeCodeVisitor extends CodeVisitorSupport {
         expression.getRightExpression().visit(this);
     }
 
+    public void visitForLoop(ForStatement forLoop) {
+        declareVariable(forLoop.getVariable());
+
+        super.visitForLoop(forLoop);
+    }
+
     public void visitClosureExpression(ClosureExpression expression) {
         getClosureVisitor().setParameters(expression.getParameters());
         expression.getCode().visit(getClosureVisitor());
@@ -156,6 +163,10 @@ public class VariableScopeCodeVisitor extends CodeVisitorSupport {
 
     protected void declareVariable(VariableExpression varExp) {
         String variable = varExp.getVariable();
+        declareVariable(variable);
+    }
+
+    protected void declareVariable(String variable) {
         /*
         if (!parameterSet.contains(variable)) {
             declaredVariables.add(variable);
diff --git a/src/test/groovy/bugs/ForAndSqlBug.groovy b/src/test/groovy/bugs/ForAndSqlBug.groovy
new file mode 100644
index 0000000000..d3ba01f480
--- /dev/null
+++ b/src/test/groovy/bugs/ForAndSqlBug.groovy
@@ -0,0 +1,38 @@
+import groovy.sql.TestHelper
+
+/**
+ * @author Jonathan Carlson
+ * @version $Revision$
+ */
+class ForAndSqlBug extends GroovyTestCase {
+    
+    void testBugInNormalMethod() {
+        sql = TestHelper.makeSql()
+        
+        li = ["a", "b"]
+        for (x in li) {
+            sql.queryEach("SELECT count(*) FROM FOOD") { e |
+            println " ${x}"
+            
+            assert x != null
+            }
+        }
+    }
+    
+    void testBugInsideScript() {
+        assertScript( <<<EOF
+import groovy.sql.TestHelper
+sql = TestHelper.makeSql()
+
+li = ["a", "b"]
+for (x in li) {
+    sql.queryEach("SELECT count(*) FROM FOOD") { e |
+    	println " $${x}"
+    	
+    	assert x != null
+    }
+}
+EOF)        
+	}
+
+}
\ No newline at end of file
