diff --git a/src/main/java/org/codehaus/groovy/classgen/AsmClassGenerator.java b/src/main/java/org/codehaus/groovy/classgen/AsmClassGenerator.java
index cd2f69db0f..1d04b1de22 100644
--- a/src/main/java/org/codehaus/groovy/classgen/AsmClassGenerator.java
+++ b/src/main/java/org/codehaus/groovy/classgen/AsmClassGenerator.java
@@ -258,20 +258,18 @@ public class AsmClassGenerator extends ClassGenerator {
     @Override
     public void visitClass(final ClassNode classNode) {
         referencedClasses.clear();
+
         WriterControllerFactory factory = classNode.getNodeMetaData(WriterControllerFactory.class);
-        WriterController normalController = new WriterController();
+        controller = new WriterController();
         if (factory != null) {
-            this.controller = factory.makeController(normalController);
-        } else {
-            this.controller = normalController;
+            controller = factory.makeController(controller);
         }
-        this.controller.init(this, context, classVisitor, classNode);
-        this.classVisitor = this.controller.getClassVisitor();
-
+        controller.init(this, context, classVisitor, classNode);
         if (controller.shouldOptimizeForInt() || factory != null) {
-            OptimizingStatementWriter.setNodeMeta(controller.getTypeChooser(),classNode);
+            OptimizingStatementWriter.setNodeMeta(controller.getTypeChooser(), classNode);
         }
 
+        classVisitor = controller.getClassVisitor();
         try {
             int bytecodeVersion = controller.getBytecodeVersion();
             Object min = classNode.getNodeMetaData(MINIMUM_BYTECODE_VERSION);
@@ -291,11 +289,14 @@ public class AsmClassGenerator extends ClassGenerator {
             );
             classVisitor.visitSource(sourceFile, null);
             if (classNode instanceof InnerClassNode) {
-                InnerClassNode innerClass = (InnerClassNode) classNode;
-                MethodNode enclosingMethod = innerClass.getEnclosingMethod();
+                makeInnerClassEntry(classNode.getOuterClass()); // GROOVY-9842
+                makeInnerClassEntry(classNode); // GROOVY-4649, et al.
+
+                MethodNode enclosingMethod = classNode.getEnclosingMethod();
                 if (enclosingMethod != null) {
-                    String outerClassName = BytecodeHelper.getClassInternalName(innerClass.getOuterClass().getName());
-                    classVisitor.visitOuterClass(outerClassName, enclosingMethod.getName(), BytecodeHelper.getMethodDescriptor(enclosingMethod));
+                    classVisitor.visitOuterClass(
+                            BytecodeHelper.getClassInternalName(classNode.getOuterClass().getName()),
+                            enclosingMethod.getName(), BytecodeHelper.getMethodDescriptor(enclosingMethod));
                 }
             }
             if (classNode.getName().endsWith("package-info")) {
@@ -307,16 +308,15 @@ public class AsmClassGenerator extends ClassGenerator {
             } else {
                 visitAnnotations(classNode, classVisitor);
                 if (classNode.isInterface()) {
-                    ClassNode owner = classNode;
-                    if (owner instanceof InnerClassNode) {
-                        owner = owner.getOuterClass();
-                    }
                     String outerClassName = classNode.getName();
                     String name = outerClassName + "$" + context.getNextInnerClassIdx();
                     controller.setInterfaceClassLoadingClass(
-                            new InterfaceHelperClassNode (
-                                    owner, name, ACC_SUPER | ACC_SYNTHETIC | ACC_STATIC, ClassHelper.OBJECT_TYPE,
-                                    controller.getCallSiteWriter().getCallSites()));
+                            new InterfaceHelperClassNode(
+                                    Optional.ofNullable(classNode.getOuterClass()).orElse(classNode),
+                                    name, ACC_SUPER | ACC_STATIC | ACC_SYNTHETIC, ClassHelper.OBJECT_TYPE,
+                                    controller.getCallSiteWriter().getCallSites()
+                            )
+                    );
                     super.visitClass(classNode);
                     createInterfaceSyntheticStaticFields();
                 } else {
@@ -332,21 +332,20 @@ public class AsmClassGenerator extends ClassGenerator {
                 }
             }
 
-            // GROOVY-6750 and GROOVY-6808
-            for (Iterator<InnerClassNode> iter = classNode.getInnerClasses(); iter.hasNext();) {
-                InnerClassNode innerClass = iter.next();
-                makeInnerClassEntry(innerClass);
+            // GROOVY-4649, GROOVY-6750, GROOVY-6808
+            for (Iterator<InnerClassNode> it = classNode.getInnerClasses(); it.hasNext(); ) {
+                makeInnerClassEntry(it.next());
             }
-            makeInnerClassEntry(classNode);
 
             classVisitor.visitEnd();
         } catch (GroovyRuntimeException e) {
             e.setModule(classNode.getModule());
             throw e;
-        } catch (NegativeArraySizeException nase) {
-            throw new GroovyRuntimeException("NegativeArraySizeException while processing " + sourceFile, nase);
-        } catch (NullPointerException npe) {
-            throw new GroovyRuntimeException("NPE while processing " + sourceFile, npe);
+        } catch (NullPointerException | NegativeArraySizeException e) {
+            String m = e.getClass().getSimpleName() + " while processing " + sourceFile;
+            GroovyRuntimeException gre = new GroovyRuntimeException(m, e);
+            gre.setModule(classNode.getModule());
+            throw gre;
         }
     }
 
diff --git a/src/test/groovy/bugs/Groovy6808.groovy b/src/test/groovy/bugs/Groovy6808.groovy
new file mode 100644
index 0000000000..c10e980244
--- /dev/null
+++ b/src/test/groovy/bugs/Groovy6808.groovy
@@ -0,0 +1,73 @@
+/*
+ *  Licensed to the Apache Software Foundation (ASF) under one
+ *  or more contributor license agreements.  See the NOTICE file
+ *  distributed with this work for additional information
+ *  regarding copyright ownership.  The ASF licenses this file
+ *  to you under the Apache License, Version 2.0 (the
+ *  "License"); you may not use this file except in compliance
+ *  with the License.  You may obtain a copy of the License at
+ *
+ *    http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing,
+ *  software distributed under the License is distributed on an
+ *  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ *  KIND, either express or implied.  See the License for the
+ *  specific language governing permissions and limitations
+ *  under the License.
+ */
+package groovy.bugs
+
+import org.junit.Test
+
+import static groovy.test.GroovyAssert.assertScript
+
+final class Groovy6808 {
+
+    @Test // GROOVY-6808
+    void testInnerClassTable1() {
+        assertScript '''
+            class Foo {
+                Closure cl = { println 'foo' }
+            }
+
+            final Class c = Class.forName('Foo$_closure1')
+            assert !c.isAnonymousClass()
+            assert  c.isMemberClass()
+            assert !c.isLocalClass()
+        '''
+    }
+
+    @Test // GROOVY-9842
+    void testInnerClassTable2() {
+        assertScript '''
+            class Foo {
+                static class Bar {
+                    static class Baz {
+                    }
+                }
+            }
+
+            final Class foo = Class.forName('Foo')
+            assert foo.getEnclosingClass() == null
+            assert foo.getModifiers() == 1
+            assert !foo.isAnonymousClass()
+            assert !foo.isMemberClass()
+            assert !foo.isLocalClass()
+
+            final Class bar = Class.forName('Foo$Bar')
+            assert bar.getEnclosingClass() == foo
+            assert bar.getModifiers() == 9
+            assert !bar.isAnonymousClass()
+            assert bar.isMemberClass()
+            assert !bar.isLocalClass()
+
+            final Class baz = Class.forName('Foo$Bar$Baz')
+            assert baz.getEnclosingClass() == bar
+            assert baz.getModifiers() == 9
+            assert !baz.isAnonymousClass()
+            assert baz.isMemberClass()
+            assert !baz.isLocalClass()
+        '''
+    }
+}
diff --git a/src/test/groovy/bugs/Groovy6808Bug.groovy b/src/test/groovy/bugs/Groovy6808Bug.groovy
deleted file mode 100644
index 15efcc7c8a..0000000000
--- a/src/test/groovy/bugs/Groovy6808Bug.groovy
+++ /dev/null
@@ -1,33 +0,0 @@
-/*
- *  Licensed to the Apache Software Foundation (ASF) under one
- *  or more contributor license agreements.  See the NOTICE file
- *  distributed with this work for additional information
- *  regarding copyright ownership.  The ASF licenses this file
- *  to you under the Apache License, Version 2.0 (the
- *  "License"); you may not use this file except in compliance
- *  with the License.  You may obtain a copy of the License at
- *
- *    http://www.apache.org/licenses/LICENSE-2.0
- *
- *  Unless required by applicable law or agreed to in writing,
- *  software distributed under the License is distributed on an
- *  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
- *  KIND, either express or implied.  See the License for the
- *  specific language governing permissions and limitations
- *  under the License.
- */
-package groovy.bugs
-
-import groovy.test.GroovyTestCase
-
-class Groovy6808Bug extends GroovyTestCase {
-    void testThatInnerClassTableIsNotCorrupt() {
-        assertScript """
-class Foo {
-   Closure cl = { println 'foo' }
-}
-Class c = Class.forName('Foo\$_closure1')
-c.isAnonymousClass()
-        """
-    }
-}
\ No newline at end of file
