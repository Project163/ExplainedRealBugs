diff --git a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
index 490e082c4a..634a007c55 100644
--- a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
+++ b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingSupport.java
@@ -1,11 +1,11 @@
 /*
- * Copyright 2003-2010 the original author or authors.
+ * Copyright 2003-2013 the original author or authors.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
- *     http://www.apache.org/licenses/LICENSE-2.0
+ *      http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
@@ -539,6 +539,10 @@ public abstract class StaticTypeCheckingSupport {
     }
 
     public static boolean checkCompatibleAssignmentTypes(ClassNode left, ClassNode right, Expression rightExpression) {
+        return checkCompatibleAssignmentTypes(left, right, rightExpression, true);
+    }
+
+    public static boolean checkCompatibleAssignmentTypes(ClassNode left, ClassNode right, Expression rightExpression, boolean allowConstructorCoercion) {
         ClassNode leftRedirect = left.redirect();
         ClassNode rightRedirect = right.redirect();
 
@@ -588,11 +592,11 @@ public abstract class StaticTypeCheckingSupport {
 
         // if right is array, map or collection we try invoking the
         // constructor
-        if (rightRedirect.implementsInterface(MAP_TYPE) ||
+        if (allowConstructorCoercion && (rightRedirect.implementsInterface(MAP_TYPE) ||
                 rightRedirect.implementsInterface(Collection_TYPE) ||
                 rightRedirect.equals(MAP_TYPE) ||
                 rightRedirect.equals(Collection_TYPE) ||
-                rightRedirect.isArray()) {
+                rightRedirect.isArray())) {
             //TODO: in case of the array we could maybe make a partial check
             if (leftRedirect.isArray() && rightRedirect.isArray()) {
                 return checkCompatibleAssignmentTypes(leftRedirect.getComponentType(), rightRedirect.getComponentType());
diff --git a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java
index 8d0e2d65b9..ef267d7833 100644
--- a/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java
+++ b/src/main/org/codehaus/groovy/transform/stc/StaticTypeCheckingVisitor.java
@@ -1346,7 +1346,7 @@ public class StaticTypeCheckingVisitor extends ClassCodeVisitorSupport {
             if (!enclosingMethod.isVoidMethod()
                     && !type.equals(void_WRAPPER_TYPE)
                     && !type.equals(VOID_TYPE)
-                    && !checkCompatibleAssignmentTypes(enclosingMethod.getReturnType(), type)
+                    && !checkCompatibleAssignmentTypes(enclosingMethod.getReturnType(), type, null, false)
                     && !(isNullConstant(expression))) {
                 addStaticTypeError("Cannot return value of type " + type.toString(false) + " on method returning type " + enclosingMethod.getReturnType().toString(false), expression);
             } else if (!enclosingMethod.isVoidMethod()) {
@@ -3107,7 +3107,7 @@ public class StaticTypeCheckingVisitor extends ClassCodeVisitorSupport {
                             resolvedPlaceholders.put(key, new GenericsType(actualType.isArray() ? actualType.getComponentType() : actualType));
                         }
                     } else {
-                        while (!actualType.equals(type)) {
+                        while (actualType!=null && !actualType.equals(type)) {
                             Set<ClassNode> interfaces = actualType.getAllInterfaces();
                             boolean intf = false;
                             for (ClassNode anInterface : interfaces) {
@@ -3119,13 +3119,15 @@ public class StaticTypeCheckingVisitor extends ClassCodeVisitorSupport {
                             }
                             if (!intf) actualType = actualType.getUnresolvedSuperClass();
                         }
-                        Map<String, GenericsType> actualTypePlaceholders = GenericsUtils.extractPlaceholders(actualType);
-                        for (Map.Entry<String, GenericsType> typeEntry : actualTypePlaceholders.entrySet()) {
-                            String key = typeEntry.getKey();
-                            GenericsType value = typeEntry.getValue();
-                            GenericsType alias = typePlaceholders.get(key);
-                            if (alias != null && alias.isPlaceholder()) {
-                                resolvedPlaceholders.put(alias.getName(), value);
+                        if (actualType!=null) {
+                            Map<String, GenericsType> actualTypePlaceholders = GenericsUtils.extractPlaceholders(actualType);
+                            for (Map.Entry<String, GenericsType> typeEntry : actualTypePlaceholders.entrySet()) {
+                                String key = typeEntry.getKey();
+                                GenericsType value = typeEntry.getValue();
+                                GenericsType alias = typePlaceholders.get(key);
+                                if (alias != null && alias.isPlaceholder()) {
+                                    resolvedPlaceholders.put(alias.getName(), value);
+                                }
                             }
                         }
                     }
diff --git a/src/test/groovy/transform/stc/GenericsSTCTest.groovy b/src/test/groovy/transform/stc/GenericsSTCTest.groovy
index dab00db3e2..eea93a61cb 100644
--- a/src/test/groovy/transform/stc/GenericsSTCTest.groovy
+++ b/src/test/groovy/transform/stc/GenericsSTCTest.groovy
@@ -1,11 +1,11 @@
 /*
- * Copyright 2003-2012 the original author or authors.
+ * Copyright 2003-2013 the original author or authors.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
- *     http://www.apache.org/licenses/LICENSE-2.0
+ *      http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
@@ -1063,6 +1063,29 @@ class GenericsSTCTest extends StaticTypeCheckingTestCase {
         '''
     }
 
+    // GROOVY-6051
+    void testGenericsReturnTypeInferenceShouldNotThrowNPE() {
+        assertScript '''
+        class Bar {
+          public static List<Date> bar(List<Date> dummy) {}
+        }
+        class Foo extends Bar {
+            static public Date genericItem() {
+                @ASTTest(phase=INSTRUCTION_SELECTION, value={
+                    def inft = node.getNodeMetaData(INFERRED_TYPE)
+                    assert inft == make(List)
+                    assert inft.genericsTypes[0].type == make(Date)
+                })
+                def res = bar(null)
+
+                res[0]
+            }
+        }
+        new Foo()
+        '''
+    }
+
+
     static class MyList extends LinkedList<String> {}
 
     public static class ClassA<T> {
diff --git a/src/test/groovy/transform/stc/WithSTCTest.groovy b/src/test/groovy/transform/stc/WithSTCTest.groovy
index 18466f7a7a..b419faf1fe 100644
--- a/src/test/groovy/transform/stc/WithSTCTest.groovy
+++ b/src/test/groovy/transform/stc/WithSTCTest.groovy
@@ -13,6 +13,8 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
+
+
 package groovy.transform.stc
 
 /**
@@ -27,7 +29,7 @@ class WithSTCTest extends StaticTypeCheckingTestCase {
         assertScript '''
             class Test {
               static List<String> a( String s ) {
-                s.with { String it -> [ "$it" ] }
+                s.with { String it -> [ "$it".toString() ] }
               }
             }
 
