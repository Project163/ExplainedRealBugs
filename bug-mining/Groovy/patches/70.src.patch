diff --git a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
index d3155aa014..3b53448ec2 100644
--- a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
+++ b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
@@ -307,10 +307,10 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
         cv = cw.visitMethod(node.getModifiers(), node.getName(), methodType, null, null);
         helper = new BytecodeHelper(cv);
 
-        resetVariableStack(node.getParameters());
-
         findMutableVariables(node);
 
+        resetVariableStack(node.getParameters());
+
         outputReturn = false;
 
         node.getCode().visit(this);
@@ -1057,7 +1057,7 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
         List constructors = innerClass.getConstructors();
         ConstructorNode node = (ConstructorNode) constructors.get(0);
         Parameter[] localVariableParams = node.getParameters();
-        
+
         //Parameter[] localVariableParams = getClosureSharedVariables(expression);
         for (int i = 2; i < localVariableParams.length; i++) {
             Parameter param = localVariableParams[i];
@@ -2639,23 +2639,34 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
                 answer.setHolder(true);
             }
             variableStack.put(name, answer);
-            if (define && !definingParameters) {
-                // using new variable inside a comparison expression
-                // so lets initialize it too
-                if (answer.isHolder()) {
-                    //cv.visitVarInsn(ASTORE, idx + 1);
-
-                    cv.visitTypeInsn(NEW, "groovy/lang/Reference");
-                    cv.visitInsn(DUP);
-                    cv.visitMethodInsn(INVOKESPECIAL, "groovy/lang/Reference", "<init>", "()V");
-
-                    cv.visitVarInsn(ASTORE, idx);
-                    //cv.visitVarInsn(ALOAD, idx + 1);
+            if (define) {
+                if (definingParameters) {
+                    if (answer.isHolder()) {
+                        cv.visitTypeInsn(NEW, "groovy/lang/Reference");
+                        cv.visitInsn(DUP);
+                        cv.visitVarInsn(ALOAD, idx);
+                        cv.visitMethodInsn(INVOKESPECIAL, "groovy/lang/Reference", "<init>", "(Ljava/lang/Object;)V");
+                        cv.visitVarInsn(ASTORE, idx);
+                    }
                 }
                 else {
-                    if (!leftHandExpression) {
-                        cv.visitInsn(ACONST_NULL);
+                    // using new variable inside a comparison expression
+                    // so lets initialize it too
+                    if (answer.isHolder()) {
+                        //cv.visitVarInsn(ASTORE, idx + 1);
+
+                        cv.visitTypeInsn(NEW, "groovy/lang/Reference");
+                        cv.visitInsn(DUP);
+                        cv.visitMethodInsn(INVOKESPECIAL, "groovy/lang/Reference", "<init>", "()V");
+
                         cv.visitVarInsn(ASTORE, idx);
+                        //cv.visitVarInsn(ALOAD, idx + 1);
+                    }
+                    else {
+                        if (!leftHandExpression) {
+                            cv.visitInsn(ACONST_NULL);
+                            cv.visitVarInsn(ASTORE, idx);
+                        }
                     }
                 }
             }
diff --git a/src/test/groovy/bugs/ClosureTypedVariableBug.groovy b/src/test/groovy/bugs/ClosureTypedVariableBug.groovy
index b1b129d91a..0219c69cf1 100644
--- a/src/test/groovy/bugs/ClosureTypedVariableBug.groovy
+++ b/src/test/groovy/bugs/ClosureTypedVariableBug.groovy
@@ -4,31 +4,49 @@
 class ClosureTypedVariableBug extends GroovyTestCase {
     
     void testBug2() {
-   		
-        Integer count = 0
-        closure = { count = it }
-        closure(1)
-        assert count == 1
-    }
-    
-    void testBug() {
    		count = makeClosure(0)
+        assert count == 1
+        
+   		count = makeClosure2(0)
         assert count == 1
     }
 
-/** @todo can't turn a parameter into a reference
 
     makeClosure(Number count) {
     	closure = { count = it }
     	closure(1)
     	return count
     }
-*/
 
-    makeClosure(Number c) {
+    makeClosure2(Number c) {
     	count = c
     	closure = { count = it }
     	closure(1)
     	return count
     }
+
+    void testBug() {
+        Integer count = 0
+        closure = { count = it }
+        closure(1)
+        assert count == 1
+    }
+    
+    void testBug3() {
+    	closure = getElementClosure("p")
+    	answer = closure("b")
+    	value = answer("c")
+    	println "returned : ${value}"
+    }
+    
+    Closure getElementClosure(tag) {
+		return { body |
+			if (true) {
+				return {"${body}"}
+			} 
+			else {
+				body = null
+			}
+		}
+	} 
 }
\ No newline at end of file
diff --git a/src/test/groovy/bugs/ClosureVariableBug.groovy b/src/test/groovy/bugs/ClosureVariableBug.groovy
index 2d627066a9..4cdbd88ac9 100644
--- a/src/test/groovy/bugs/ClosureVariableBug.groovy
+++ b/src/test/groovy/bugs/ClosureVariableBug.groovy
@@ -24,4 +24,18 @@ class ClosureVariableBug extends GroovyTestCase {
     	value = foo.a()
     	assert value == 123
     }
+    
+    void testPassingInUndefinedVariable() {
+    	value = callClosure([1, 2])
+    	assert value == 2
+    }
+    
+    protected Integer callClosure(collection) {
+    	/** @todo
+    	Integer x
+    	*/
+    	Integer x = 0
+    	collection.each { x = it }
+    	return x
+    }
 }
\ No newline at end of file
diff --git a/src/test/org/codehaus/groovy/classgen/DumpClass4.java b/src/test/org/codehaus/groovy/classgen/DumpClass4.java
index 0db6144909..9170712e25 100644
--- a/src/test/org/codehaus/groovy/classgen/DumpClass4.java
+++ b/src/test/org/codehaus/groovy/classgen/DumpClass4.java
@@ -148,4 +148,8 @@ public class DumpClass4 {
     public String testSuperCall() {
         return super.toString();
     }
+    
+    public Object createReference(Object foo) {
+        return new Reference(foo);
+    }
 }
