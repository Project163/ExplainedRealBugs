diff --git a/src/main/org/codehaus/groovy/ast/expr/ArgumentListExpression.java b/src/main/org/codehaus/groovy/ast/expr/ArgumentListExpression.java
index 726dba6d19..b2ffa79e95 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ArgumentListExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ArgumentListExpression.java
@@ -57,11 +57,12 @@ import org.codehaus.groovy.ast.Parameter;
  */
 public class ArgumentListExpression extends TupleExpression {
 
-    public static final Object[] EMPTY_ARRAY = {};
-    
+    public static final Object[] EMPTY_ARRAY = {
+    };
+
     public ArgumentListExpression() {
     }
-    
+
     public ArgumentListExpression(List expressions) {
         super(expressions);
     }
@@ -76,4 +77,8 @@ public class ArgumentListExpression extends TupleExpression {
             addExpression(new VariableExpression(parameter.getName()));
         }
     }
+
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new ArgumentListExpression(transformExpressions(getExpressions(), transformer));
+    }
 }
diff --git a/src/main/org/codehaus/groovy/ast/expr/ArrayExpression.java b/src/main/org/codehaus/groovy/ast/expr/ArrayExpression.java
index 523b839427..0795854c5e 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ArrayExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ArrayExpression.java
@@ -65,23 +65,23 @@ public class ArrayExpression extends Expression {
     public ArrayExpression() {
         this(new ArrayList());
     }
-    
+
     public ArrayExpression(List expressions) {
         this("java/lang/Object", expressions);
     }
-    
+
     public ArrayExpression(String type, List expressions) {
         this.type = type;
         this.expressions = expressions;
-        
-        for (Iterator iter = expressions.iterator(); iter.hasNext(); ) {
+
+        for (Iterator iter = expressions.iterator(); iter.hasNext();) {
             Object item = iter.next();
-            if (! (item instanceof Expression)) {
+            if (!(item instanceof Expression)) {
                 throw new ClassCastException("Item: " + item + " is not an Expression");
             }
         }
     }
-    
+
     public ArrayExpression(Expression[] expressionArray) {
         this();
         expressions.addAll(Arrays.asList(expressionArray));
@@ -90,7 +90,7 @@ public class ArrayExpression extends Expression {
     public void addExpression(Expression expression) {
         expressions.add(expression);
     }
-    
+
     public List getExpressions() {
         return expressions;
     }
@@ -99,6 +99,10 @@ public class ArrayExpression extends Expression {
         visitor.visitArrayExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new ArrayExpression(type, transformExpressions(expressions, transformer));
+    }
+
     public Expression getExpression(int i) {
         Object object = expressions.get(i);
         return (Expression) object;
@@ -111,15 +115,15 @@ public class ArrayExpression extends Expression {
     public String getText() {
         StringBuffer buffer = new StringBuffer("[");
         boolean first = true;
-        for (Iterator iter = expressions.iterator(); iter.hasNext(); ) {
+        for (Iterator iter = expressions.iterator(); iter.hasNext();) {
             if (first) {
                 first = false;
             }
             else {
                 buffer.append(", ");
             }
-            
-            buffer.append(((Expression)iter.next()).getText());
+
+            buffer.append(((Expression) iter.next()).getText());
         }
         buffer.append("]");
         return buffer.toString();
diff --git a/src/main/org/codehaus/groovy/ast/expr/BinaryExpression.java b/src/main/org/codehaus/groovy/ast/expr/BinaryExpression.java
index 8e3f035cb4..eb6e6e33c2 100644
--- a/src/main/org/codehaus/groovy/ast/expr/BinaryExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/BinaryExpression.java
@@ -76,6 +76,10 @@ public class BinaryExpression extends Expression {
         visitor.visitBinaryExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new BinaryExpression(transformer.transform(leftExpression), operation, transformer.transform(rightExpression));
+    }
+
     public Expression getLeftExpression() {
         return leftExpression;
     }
@@ -97,6 +101,9 @@ public class BinaryExpression extends Expression {
     }
 
     public String getText() {
+        if (operation.getType() == Token.LEFT_SQUARE_BRACKET) {
+            return leftExpression.getText() + "[" + rightExpression.getText() + "]";
+        }
         return "(" + leftExpression.getText() + " " + operation.getText() + " " + rightExpression.getText() + ")";
     }
 
diff --git a/src/main/org/codehaus/groovy/ast/expr/BooleanExpression.java b/src/main/org/codehaus/groovy/ast/expr/BooleanExpression.java
index 96a89997fe..a73b3f6a9b 100644
--- a/src/main/org/codehaus/groovy/ast/expr/BooleanExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/BooleanExpression.java
@@ -67,7 +67,11 @@ public class BooleanExpression extends Expression {
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitBooleanExpression(this);
     }
-
+    
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new BooleanExpression(transformer.transform(expression));
+    }
+    
     public String getText() {
         return expression.getText();
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/CastExpression.java b/src/main/org/codehaus/groovy/ast/expr/CastExpression.java
index 51b72d4d21..58b41ca515 100644
--- a/src/main/org/codehaus/groovy/ast/expr/CastExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/CastExpression.java
@@ -70,7 +70,11 @@ public class CastExpression extends Expression {
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitCastExpression(this);
     }
-
+    
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new CastExpression(type, transformer.transform(expression));
+    }
+    
     public String getText() {
         return "(" + type + ") " + expression.getText();
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/ClassExpression.java b/src/main/org/codehaus/groovy/ast/expr/ClassExpression.java
index d3141e426b..1acaf883f3 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ClassExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ClassExpression.java
@@ -65,7 +65,11 @@ public class ClassExpression extends Expression {
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitClassExpression(this);
     }
-
+    
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return this;
+    }
+    
     public String getType() {
         return type;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/ClosureExpression.java b/src/main/org/codehaus/groovy/ast/expr/ClosureExpression.java
index ad8fbc84a3..0d03446e5a 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ClosureExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ClosureExpression.java
@@ -71,6 +71,10 @@ public class ClosureExpression extends Expression {
         visitor.visitClosureExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return this;
+    }
+    
     public Statement getCode() {
         return code;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/ConstantExpression.java b/src/main/org/codehaus/groovy/ast/expr/ConstantExpression.java
index 0271e47039..cbca5367b2 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ConstantExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ConstantExpression.java
@@ -74,6 +74,10 @@ public class ConstantExpression extends Expression {
         visitor.visitConstantExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return this;
+    }
+    
     /**
      * @return the value of this constant expression
      */    
diff --git a/src/main/org/codehaus/groovy/ast/expr/ConstructorCallExpression.java b/src/main/org/codehaus/groovy/ast/expr/ConstructorCallExpression.java
index c41e3c0e51..9173a01651 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ConstructorCallExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ConstructorCallExpression.java
@@ -67,6 +67,10 @@ public class ConstructorCallExpression extends Expression {
         visitor.visitConstructorCallExpression(this);
     }
     
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new ConstructorCallExpression(type, transformer.transform(arguments)); 
+    }
+    
     public String getType() {
         if (type == null) {
             return "java.lang.Object";
diff --git a/src/main/org/codehaus/groovy/ast/expr/Expression.java b/src/main/org/codehaus/groovy/ast/expr/Expression.java
index 68bb41d15f..770565c690 100644
--- a/src/main/org/codehaus/groovy/ast/expr/Expression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/Expression.java
@@ -45,6 +45,10 @@
  */
 package org.codehaus.groovy.ast.expr;
 
+import java.util.ArrayList;
+import java.util.Iterator;
+import java.util.List;
+
 import org.codehaus.groovy.ast.ASTNode;
 
 /**
@@ -53,5 +57,24 @@ import org.codehaus.groovy.ast.ASTNode;
  * @author <a href="mailto:james@coredevelopers.net">James Strachan</a>
  * @version $Revision$
  */
-public class Expression extends ASTNode {
+public abstract class Expression extends ASTNode {
+    
+    /**
+     * Return a copy of the expression calling the transformer on any nested expressions 
+     * @param transformer
+     * @return
+     */
+    public abstract Expression transformExpression(ExpressionTransformer transformer);
+    
+    /**
+     * Transforms the list of expressions
+     * @return a new list of transformed expressions
+     */
+    protected List transformExpressions(List expressions, ExpressionTransformer transformer) {
+        List list = new ArrayList(expressions.size());
+        for (Iterator iter = expressions.iterator(); iter.hasNext(); ) {
+            list.add(transformer.transform((Expression) iter.next()));
+        }
+        return list;
+    }
 }
diff --git a/src/main/org/codehaus/groovy/ast/expr/ExpressionTransformer.java b/src/main/org/codehaus/groovy/ast/expr/ExpressionTransformer.java
new file mode 100644
index 0000000000..ca1fbb8c09
--- /dev/null
+++ b/src/main/org/codehaus/groovy/ast/expr/ExpressionTransformer.java
@@ -0,0 +1,61 @@
+/*
+ $Id$
+
+ Copyright 2003 (C) James Strachan and Bob Mcwhirter. All Rights Reserved.
+
+ Redistribution and use of this software and associated documentation
+ ("Software"), with or without modification, are permitted provided
+ that the following conditions are met:
+
+ 1. Redistributions of source code must retain copyright
+    statements and notices.  Redistributions must also contain a
+    copy of this document.
+
+ 2. Redistributions in binary form must reproduce the
+    above copyright notice, this list of conditions and the
+    following disclaimer in the documentation and/or other
+    materials provided with the distribution.
+
+ 3. The name "groovy" must not be used to endorse or promote
+    products derived from this Software without prior written
+    permission of The Codehaus.  For written permission,
+    please contact info@codehaus.org.
+
+ 4. Products derived from this Software may not be called "groovy"
+    nor may "groovy" appear in their names without prior written
+    permission of The Codehaus. "groovy" is a registered
+    trademark of The Codehaus.
+
+ 5. Due credit should be given to The Codehaus -
+    http://groovy.codehaus.org/
+
+ THIS SOFTWARE IS PROVIDED BY THE CODEHAUS AND CONTRIBUTORS
+ ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
+ NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
+ FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
+ THE CODEHAUS OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
+ SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ OF THE POSSIBILITY OF SUCH DAMAGE.
+
+ */
+package org.codehaus.groovy.ast.expr;
+
+
+/**
+ * Provides a way to transform expressions
+ * 
+ * @author <a href="mailto:james@coredevelopers.net">James Strachan</a>
+ * @version $Revision$
+ */
+public interface ExpressionTransformer {
+    
+    /** 
+     * Transforms the given expression into another expression
+     */
+    public Expression transform(Expression expression);
+}
diff --git a/src/main/org/codehaus/groovy/ast/expr/FieldExpression.java b/src/main/org/codehaus/groovy/ast/expr/FieldExpression.java
index fce9643d6d..aa3f21f0aa 100644
--- a/src/main/org/codehaus/groovy/ast/expr/FieldExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/FieldExpression.java
@@ -66,6 +66,10 @@ public class FieldExpression extends Expression {
         visitor.visitFieldExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return this;
+    }
+    
     public String getFieldName() {
         return field.getName();
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/GStringExpression.java b/src/main/org/codehaus/groovy/ast/expr/GStringExpression.java
index 451ce57f57..0eb4222ed7 100644
--- a/src/main/org/codehaus/groovy/ast/expr/GStringExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/GStringExpression.java
@@ -63,15 +63,28 @@ public class GStringExpression extends Expression {
     private String verbatimText;
     private List strings = new ArrayList();
     private List values = new ArrayList();
-    
+
     public GStringExpression(String verbatimText) {
         this.verbatimText = verbatimText;
     }
 
+    public GStringExpression(String verbatimText, List strings, List values) {
+        this.verbatimText = verbatimText;
+        this.strings = strings;
+        this.values = values;
+    }
+
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitGStringExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new GStringExpression(
+            verbatimText,
+            transformExpressions(strings, transformer),
+            transformExpressions(values, transformer));
+    }
+
     public String toString() {
         return super.toString() + "[strings: " + strings + " values: " + values + "]";
     }
@@ -92,9 +105,10 @@ public class GStringExpression extends Expression {
     }
 
     public void addValue(Expression value) {
-    	// If the first thing is an value, then we need a dummy empty string in front of it so that when we
-    	// toString it they come out in the correct order.
-    	if (strings.size() == 0) strings.add(ConstantExpression.EMPTY_STRING);
+        // If the first thing is an value, then we need a dummy empty string in front of it so that when we
+        // toString it they come out in the correct order.
+        if (strings.size() == 0)
+            strings.add(ConstantExpression.EMPTY_STRING);
         values.add(value);
     }
 
diff --git a/src/main/org/codehaus/groovy/ast/expr/ListExpression.java b/src/main/org/codehaus/groovy/ast/expr/ListExpression.java
index c5d402c67f..76588a6ca9 100644
--- a/src/main/org/codehaus/groovy/ast/expr/ListExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/ListExpression.java
@@ -80,6 +80,10 @@ public class ListExpression extends Expression {
         visitor.visitListExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new ListExpression(transformExpressions(getExpressions(), transformer));
+    }
+    
     public Expression getExpression(int i) {
         return (Expression) expressions.get(i);
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/MapEntryExpression.java b/src/main/org/codehaus/groovy/ast/expr/MapEntryExpression.java
index 3de5dc9339..bd4c290f05 100644
--- a/src/main/org/codehaus/groovy/ast/expr/MapEntryExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/MapEntryExpression.java
@@ -67,6 +67,10 @@ public class MapEntryExpression extends Expression {
         visitor.visitMapEntryExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new RangeExpression(transformer.transform(keyExpression), transformer.transform(valueExpression)); 
+    }
+    
     public Expression getKeyExpression() {
         return keyExpression;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/MapExpression.java b/src/main/org/codehaus/groovy/ast/expr/MapExpression.java
index b1f055aeab..7208382da0 100644
--- a/src/main/org/codehaus/groovy/ast/expr/MapExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/MapExpression.java
@@ -79,6 +79,10 @@ public class MapExpression extends Expression {
         visitor.visitMapExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new MapExpression(transformExpressions(getMapEntryExpressions(), transformer));
+    }
+    
     public void addMapEntryExpression(Expression keyExpression, Expression valueExpression) {
         addMapEntryExpression(new MapEntryExpression(keyExpression, valueExpression));
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/MethodCallExpression.java b/src/main/org/codehaus/groovy/ast/expr/MethodCallExpression.java
index e996bce2de..2e1a5032e1 100644
--- a/src/main/org/codehaus/groovy/ast/expr/MethodCallExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/MethodCallExpression.java
@@ -59,17 +59,24 @@ public class MethodCallExpression extends Expression {
     private String method;
     private Expression arguments;
     private boolean safe;
-    
+
     public MethodCallExpression(Expression objectExpression, String method, Expression arguments) {
         this.objectExpression = objectExpression;
         this.method = method;
         this.arguments = arguments;
     }
-    
+
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitMethodCallExpression(this);
     }
-    
+
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        MethodCallExpression answer =
+            new MethodCallExpression(transformer.transform(objectExpression), method, transformer.transform(arguments));
+        answer.setSafe(safe);
+        return answer;
+    }
+
     public Expression getArguments() {
         return arguments;
     }
@@ -99,7 +106,14 @@ public class MethodCallExpression extends Expression {
     }
 
     public String toString() {
-        return super.toString() + "[object: " + objectExpression + " method: " + method + " arguments: " + arguments + "]";
+        return super.toString()
+            + "[object: "
+            + objectExpression
+            + " method: "
+            + method
+            + " arguments: "
+            + arguments
+            + "]";
     }
 
     public static boolean isSuperMethodCall(MethodCallExpression call) {
diff --git a/src/main/org/codehaus/groovy/ast/expr/NamedArgumentListExpression.java b/src/main/org/codehaus/groovy/ast/expr/NamedArgumentListExpression.java
index f23bcecc1a..4f113d6171 100644
--- a/src/main/org/codehaus/groovy/ast/expr/NamedArgumentListExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/NamedArgumentListExpression.java
@@ -61,4 +61,9 @@ public class NamedArgumentListExpression extends MapExpression {
     public NamedArgumentListExpression(List mapEntryExpressions) {
         super(mapEntryExpressions);
     }
+
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new NamedArgumentListExpression(transformExpressions(getMapEntryExpressions(), transformer));
+    }
+    
 }
diff --git a/src/main/org/codehaus/groovy/ast/expr/NegationExpression.java b/src/main/org/codehaus/groovy/ast/expr/NegationExpression.java
index 43c1752e13..37cad20f9a 100644
--- a/src/main/org/codehaus/groovy/ast/expr/NegationExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/NegationExpression.java
@@ -37,9 +37,6 @@ import org.codehaus.groovy.ast.GroovyCodeVisitor;
 
 /**
  * @author sam
- *
- * To change the template for this generated type comment go to
- * Window - Preferences - Java - Code Generation - Code and Comments
  */
 public class NegationExpression extends Expression {
 
@@ -57,6 +54,10 @@ public class NegationExpression extends Expression {
 		visitor.visitNegationExpression(this);
 	}
 
+	public Expression transformExpression(ExpressionTransformer transformer) {
+	    return new NegationExpression(transformer.transform(expression));
+	}
+	
 	public String getText() {
 		return expression.getText();
 	}
diff --git a/src/main/org/codehaus/groovy/ast/expr/NotExpression.java b/src/main/org/codehaus/groovy/ast/expr/NotExpression.java
index 9a8fea926a..c619fd1a0c 100644
--- a/src/main/org/codehaus/groovy/ast/expr/NotExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/NotExpression.java
@@ -35,9 +35,6 @@ import org.codehaus.groovy.ast.GroovyCodeVisitor;
 
 /**
  * @author sam
- *
- * To change the template for this generated type comment go to
- * Window - Preferences - Java - Code Generation - Code and Comments
  */
 public class NotExpression extends BooleanExpression {
 
@@ -49,4 +46,7 @@ public class NotExpression extends BooleanExpression {
 		visitor.visitNotExpression(this);
 	}
 
-}
+	public Expression transformExpression(ExpressionTransformer transformer) {
+	    return new NotExpression(transformer.transform(getExpression()));
+	}
+	}
diff --git a/src/main/org/codehaus/groovy/ast/expr/PostfixExpression.java b/src/main/org/codehaus/groovy/ast/expr/PostfixExpression.java
index 401071e21c..dc2dd2e1da 100644
--- a/src/main/org/codehaus/groovy/ast/expr/PostfixExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/PostfixExpression.java
@@ -72,6 +72,10 @@ public class PostfixExpression extends Expression {
         visitor.visitPostfixExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new PostfixExpression(transformer.transform(expression), operation);
+    }
+    
     public void setExpression(Expression expression) {
         this.expression = expression;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/PrefixExpression.java b/src/main/org/codehaus/groovy/ast/expr/PrefixExpression.java
index b3479d0f6a..3f3e6eae1a 100644
--- a/src/main/org/codehaus/groovy/ast/expr/PrefixExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/PrefixExpression.java
@@ -72,6 +72,10 @@ public class PrefixExpression extends Expression {
         visitor.visitPrefixExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new PrefixExpression(operation, transformer.transform(expression));
+    }
+    
     public void setExpression(Expression expression) {
         this.expression = expression;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/PropertyExpression.java b/src/main/org/codehaus/groovy/ast/expr/PropertyExpression.java
index 8be786f229..24ef3db453 100644
--- a/src/main/org/codehaus/groovy/ast/expr/PropertyExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/PropertyExpression.java
@@ -73,6 +73,10 @@ public class PropertyExpression extends Expression {
         visitor.visitPropertyExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return this;
+    }
+    
     public Expression getObjectExpression() {
         return objectExpression;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/RangeExpression.java b/src/main/org/codehaus/groovy/ast/expr/RangeExpression.java
index 7b68a776d9..42930e639f 100644
--- a/src/main/org/codehaus/groovy/ast/expr/RangeExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/RangeExpression.java
@@ -59,16 +59,20 @@ public class RangeExpression extends Expression {
 
     private Expression from;
     private Expression to;
-    
+
     public RangeExpression(Expression from, Expression to) {
         this.from = from;
         this.to = to;
     }
-    
+
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitRangeExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new RangeExpression(transformer.transform(from), transformer.transform(to)); 
+    }
+    
     public Expression getFrom() {
         return from;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/RegexExpression.java b/src/main/org/codehaus/groovy/ast/expr/RegexExpression.java
index ac6ad258ac..0762455af6 100644
--- a/src/main/org/codehaus/groovy/ast/expr/RegexExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/RegexExpression.java
@@ -56,18 +56,22 @@ import org.codehaus.groovy.ast.GroovyCodeVisitor;
  */
 public class RegexExpression extends Expression {
     
-    private Expression gstring;
+    private Expression string;
     
-    public RegexExpression(Expression gstring) {
-        this.gstring = gstring;
+    public RegexExpression(Expression string) {
+        this.string = string;
     }
     
     public void visit(GroovyCodeVisitor visitor) {
         visitor.visitRegexExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new RegexExpression(transformer.transform(string));
+    }
+    
     public Expression getRegex() {
-        return gstring;
+        return string;
     }
 
 }
diff --git a/src/main/org/codehaus/groovy/ast/expr/StaticMethodCallExpression.java b/src/main/org/codehaus/groovy/ast/expr/StaticMethodCallExpression.java
index 8846e222f7..6ff75b4c2e 100644
--- a/src/main/org/codehaus/groovy/ast/expr/StaticMethodCallExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/StaticMethodCallExpression.java
@@ -69,6 +69,10 @@ public class StaticMethodCallExpression extends Expression {
         visitor.visitStaticMethodCallExpression(this);
     }
     
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new StaticMethodCallExpression(type, method, transformer.transform(arguments)); 
+    }
+    
     public Expression getArguments() {
         return arguments;
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/TupleExpression.java b/src/main/org/codehaus/groovy/ast/expr/TupleExpression.java
index fd3dd1ec0d..f01d455991 100644
--- a/src/main/org/codehaus/groovy/ast/expr/TupleExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/TupleExpression.java
@@ -86,6 +86,10 @@ public class TupleExpression extends Expression {
         visitor.visitTupleExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return new TupleExpression(transformExpressions(getExpressions(), transformer));
+    }
+    
     public Expression getExpression(int i) {
         return (Expression) expressions.get(i);
     }
diff --git a/src/main/org/codehaus/groovy/ast/expr/VariableExpression.java b/src/main/org/codehaus/groovy/ast/expr/VariableExpression.java
index df2ee6378c..052eaf93c1 100644
--- a/src/main/org/codehaus/groovy/ast/expr/VariableExpression.java
+++ b/src/main/org/codehaus/groovy/ast/expr/VariableExpression.java
@@ -68,6 +68,10 @@ public class VariableExpression extends Expression {
         visitor.visitVariableExpression(this);
     }
 
+    public Expression transformExpression(ExpressionTransformer transformer) {
+        return this;
+    }
+
     public String getVariable() {
         return variable;
     }
diff --git a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
index ee885ea037..9f3031baeb 100644
--- a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
+++ b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
@@ -69,6 +69,7 @@ import org.codehaus.groovy.ast.expr.ClosureExpression;
 import org.codehaus.groovy.ast.expr.ConstantExpression;
 import org.codehaus.groovy.ast.expr.ConstructorCallExpression;
 import org.codehaus.groovy.ast.expr.Expression;
+import org.codehaus.groovy.ast.expr.ExpressionTransformer;
 import org.codehaus.groovy.ast.expr.FieldExpression;
 import org.codehaus.groovy.ast.expr.GStringExpression;
 import org.codehaus.groovy.ast.expr.ListExpression;
@@ -797,7 +798,7 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
 
         statement.getExpression().visit(this);
 
-        Expression assignExpr = assignmentExpression(statement.getExpression());
+        Expression assignExpr = createReturnLHSExpression(statement.getExpression());
         if (assignExpr != null) {
             leftHandExpression = false;
             assignExpr.visit(this);
@@ -961,6 +962,9 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
 
             case Token.LEFT_SQUARE_BRACKET :
                 evaluateBinaryExpression(leftHandExpression ? "set" : "get", expression);
+                if (leftHandExpression) {
+                    cv.visitInsn(POP);
+                }
                 break;
 
             default :
@@ -1748,6 +1752,7 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
         return innerClasses.add(innerClass);
     }
 
+
     protected ClassNode createClosureClass(ClosureExpression expression) {
         ClassNode owner = classNode;
         if (owner instanceof InnerClassNode) {
@@ -1981,6 +1986,7 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
                         "put",
                         new ArgumentListExpression(
                             new Expression[] { leftBinExpr.getRightExpression(), expression.getRightExpression()})));
+                cv.visitInsn(POP);
                 return;
             }
         }
@@ -2163,20 +2169,29 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
         return false;
     }
 
-    protected Expression assignmentExpression(Expression expression) {
+    /**
+     * For assignment expressions, return a safe expression for the LHS we can use
+     * to return the value 
+     */
+    protected Expression createReturnLHSExpression(Expression expression) {
         if (expression instanceof BinaryExpression) {
             BinaryExpression binExpr = (BinaryExpression) expression;
             if (binExpr.getOperation().isAssignmentToken()) {
-                return binExpr.getLeftExpression();
+                return binExpr.getLeftExpression().transformExpression(new ExpressionTransformer() {
+                    public Expression transform(Expression expression) {
+                        if (expression instanceof PostfixExpression) {
+                            PostfixExpression postfixExp = (PostfixExpression) expression;
+                            return postfixExp.getExpression();
+                        }
+                        else if (expression instanceof PrefixExpression) {
+                            PrefixExpression prefixExp = (PrefixExpression) expression;
+                            return prefixExp.getExpression();
+                        }
+                        return expression;
+                    }
+                });
             }
         }
-        /*
-         * else if (expression instanceof PostfixExpression) {
-         * PostfixExpression expr = (PostfixExpression) expression; return
-         * expr.getExpression(); } else if (expression instanceof
-         * PrefixExpression) { PrefixExpression expr = (PrefixExpression)
-         * expression; return expr.getExpression(); }
-         */
         return null;
     }
 
diff --git a/src/main/org/codehaus/groovy/classgen/Verifier.java b/src/main/org/codehaus/groovy/classgen/Verifier.java
index c7dc41f12d..7994dae2ab 100644
--- a/src/main/org/codehaus/groovy/classgen/Verifier.java
+++ b/src/main/org/codehaus/groovy/classgen/Verifier.java
@@ -385,5 +385,4 @@ public class Verifier implements GroovyClassVisitor, Constants {
         return new ExpressionStatement(
             new BinaryExpression(new FieldExpression(field), Token.equal(0, 0), new VariableExpression("value")));
     }
-
 }
diff --git a/src/test/groovy/bugs/GuillaumesMapBug.groovy b/src/test/groovy/bugs/GuillaumesMapBug.groovy
index 68aa8f141f..2dda2e9319 100644
--- a/src/test/groovy/bugs/GuillaumesMapBug.groovy
+++ b/src/test/groovy/bugs/GuillaumesMapBug.groovy
@@ -4,7 +4,7 @@
  */
 class GuillaumesMapBug extends GroovyTestCase {
     
-    void testBug() {
+    void testBug2() {
         list = [1, 2, 3]
         map = [:]
         
@@ -18,29 +18,23 @@ class GuillaumesMapBug extends GroovyTestCase {
     void doLoop(list, map) {
         i = 0
         for (it in list) {
-            set(map, i++, it)
-            
-            /** @todo fix this bug
-            //map[i] = it
-            //i++
-             */
+            map[i++] = it
         }
     }
     
-    void set(map, i, it) {
-        map[i] = it
-    }
     
-    /** @todo fix this bug
-    void testBug2() {
-        i = 0
+    void testBug() {
         list = [1, 2, 3]
         map = [:]
-        list.each { map[i++] = it }
+        doClosureLoop(list, map)
         
         assert map[0] == 1 
         assert map[1] == 2 
         assert map[2] == 3 
     }
-    */
+    
+    void doClosureLoop(list, map) {
+        i = 0
+        list.each { map[i++] = it }
+    }    
 }
\ No newline at end of file
diff --git a/src/test/org/codehaus/groovy/classgen/RunBugsTest.java b/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
index e03dbca65e..f4f1ca6917 100644
--- a/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
+++ b/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
@@ -49,17 +49,11 @@ import org.codehaus.groovy.classgen.TestSupport;
  */
 public class RunBugsTest extends TestSupport {
 
-    /*
     public void testStaticMethodCall() throws Exception {
         GroovyObject object = compile("src/test/groovy/bugs/StaticMethodCallBug.groovy");
         object.invokeMethod("testBug", null);
     }
     
-    public void testGuillaumesMapBug() throws Exception {
-        GroovyObject object = compile("src/test/groovy/bugs/GuillaumesMapBug.groovy");
-        object.invokeMethod("testBug", null);
-    }
-    
     public void testTryCatchBug() throws Exception {
         GroovyObject object = compile("src/test/groovy/bugs/TryCatchBug.groovy");
         object.invokeMethod("testBug", null);
@@ -69,10 +63,14 @@ public class RunBugsTest extends TestSupport {
         GroovyObject object = compile("src/test/groovy/bugs/RodsBug.groovy");
         object.invokeMethod("testBug", null);
     }
-    */
-
+    
     public void testCastBug() throws Exception {
         GroovyObject object = compile("src/test/groovy/ClosureMethodCallTest.groovy");
         object.invokeMethod("testCallingClosureWithMultipleArguments", null);
     }
-   }
+
+    public void testGuillaumesMapBug() throws Exception {
+        GroovyObject object = compile("src/test/groovy/bugs/GuillaumesMapBug.groovy");
+        object.invokeMethod("testBug", null);
+    }    
+}
