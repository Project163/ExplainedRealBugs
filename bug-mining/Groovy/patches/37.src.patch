diff --git a/src/main/org/codehaus/groovy/ast/ClassNode.java b/src/main/org/codehaus/groovy/ast/ClassNode.java
index 25925910a3..6a047cabf2 100644
--- a/src/main/org/codehaus/groovy/ast/ClassNode.java
+++ b/src/main/org/codehaus/groovy/ast/ClassNode.java
@@ -65,7 +65,8 @@ public class ClassNode extends MetadataNode implements Constants {
     private Map fieldIndex = new HashMap();
     private ModuleNode module;
     private boolean staticClass = false;
-
+    private boolean scriptBody = false;
+    
     /**
      * @param name
      *            is the full name of the class
@@ -396,4 +397,15 @@ public class ClassNode extends MetadataNode implements Constants {
         this.staticClass = staticClass;
     }
 
+    /**
+     * @return Returns true if this inner class or closure was declared inside a script body
+     */
+    public boolean isScriptBody() {
+        return scriptBody;
+    }
+
+    public void setScriptBody(boolean scriptBody) {
+        this.scriptBody = scriptBody;
+    }
+
 }
diff --git a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
index bbcd3267e0..0d75fed67b 100644
--- a/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
+++ b/src/main/org/codehaus/groovy/classgen/ClassGenerator.java
@@ -1339,8 +1339,8 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
                 doCast(type);
             }
             else {
-	            // this may be superflous
-	            doConvertAndCast(type);
+                // this may be superflous
+                doConvertAndCast(type);
             }
         }
         int opcode =
@@ -1534,11 +1534,16 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
      * local variables but are properties
      */
     protected boolean isInScriptBody() {
-        String superClass = classNode.getSuperClass();
-        return superClass != null
-            && superClass.equals("groovy.lang.Script")
-            && methodNode != null
-            && methodNode.getName().equals("run");
+        if (classNode.isScriptBody()) {
+            return true;
+        }
+        else {
+            String superClass = classNode.getSuperClass();
+            return superClass != null
+                && superClass.equals("groovy.lang.Script")
+                && methodNode != null
+                && methodNode.getName().equals("run");
+        }
     }
 
     /**
@@ -1785,9 +1790,11 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
 
         InnerClassNode answer = new InnerClassNode(owner, name, ACC_PUBLIC, "groovy.lang.Closure");
         if (staticMethodOrInStaticClass) {
-            //System.out.println("#### Declaring closure in static method");
             answer.setStaticClass(true);
         }
+        if (isInScriptBody()) {
+            answer.setScriptBody(true);
+        }
         answer.addMethod("doCall", ACC_PUBLIC, "java.lang.Object", parameters, expression.getCode());
         if (parameters.length > 1
             || (parameters.length == 1
@@ -2350,10 +2357,6 @@ public class ClassGenerator extends CodeVisitorSupport implements GroovyClassVis
                     vars.add(new Parameter(type, var));
                 }
             }
-
-            //            if (!vars.isEmpty()) {
-            //                System.out.println(classNode.getName() + " - closure is copying variables from outer context: " + vars);
-            //            }
         }
         Parameter[] answer = new Parameter[vars.size()];
         vars.toArray(answer);
diff --git a/src/test/groovy/bugs/ClosuresInScriptBug.java b/src/test/groovy/bugs/ClosuresInScriptBug.java
new file mode 100644
index 0000000000..8cb89b81ee
--- /dev/null
+++ b/src/test/groovy/bugs/ClosuresInScriptBug.java
@@ -0,0 +1,63 @@
+/*
+ $Id$
+
+ Copyright 2003 (C) James Strachan and Bob Mcwhirter. All Rights Reserved.
+
+ Redistribution and use of this software and associated documentation
+ ("Software"), with or without modification, are permitted provided
+ that the following conditions are met:
+
+ 1. Redistributions of source code must retain copyright
+    statements and notices.  Redistributions must also contain a
+    copy of this document.
+
+ 2. Redistributions in binary form must reproduce the
+    above copyright notice, this list of conditions and the
+    following disclaimer in the documentation and/or other
+    materials provided with the distribution.
+
+ 3. The name "groovy" must not be used to endorse or promote
+    products derived from this Software without prior written
+    permission of The Codehaus.  For written permission,
+    please contact info@codehaus.org.
+
+ 4. Products derived from this Software may not be called "groovy"
+    nor may "groovy" appear in their names without prior written
+    permission of The Codehaus. "groovy" is a registered
+    trademark of The Codehaus.
+
+ 5. Due credit should be given to The Codehaus -
+    http://groovy.codehaus.org/
+
+ THIS SOFTWARE IS PROVIDED BY THE CODEHAUS AND CONTRIBUTORS
+ ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
+ NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
+ FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
+ THE CODEHAUS OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
+ (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
+ SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ OF THE POSSIBILITY OF SUCH DAMAGE.
+
+ */
+
+package groovy.bugs;
+
+import org.codehaus.groovy.classgen.TestSupport;
+
+
+/**
+ * Base class for test cases
+ * 
+ * @author <a href="mailto:james@coredevelopers.net">James Strachan</a>
+ * @version $Revision$
+ */
+public class ClosuresInScriptBug extends TestSupport {
+
+    public void testBug() throws Exception {
+        assertScript( "a = 1\n [2].each { a = it }\n assert a == 2" );
+    }
+}
diff --git a/src/test/org/codehaus/groovy/classgen/RunBugsTest.java b/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
index b4fdd8fcc6..31275745fb 100644
--- a/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
+++ b/src/test/org/codehaus/groovy/classgen/RunBugsTest.java
@@ -87,5 +87,5 @@ public class RunBugsTest extends TestSupport {
     public void testStaticMarkupBug() throws Exception {
         GroovyObject object = compile("src/test/groovy/bugs/StaticMarkupBug.groovy");
         object.invokeMethod("testBug", null);
-    } 
+    }
 }
diff --git a/src/test/org/codehaus/groovy/classgen/TestSupport.java b/src/test/org/codehaus/groovy/classgen/TestSupport.java
index a8d345ad87..a22e6d50d2 100644
--- a/src/test/org/codehaus/groovy/classgen/TestSupport.java
+++ b/src/test/org/codehaus/groovy/classgen/TestSupport.java
@@ -46,13 +46,16 @@
 
 package org.codehaus.groovy.classgen;
 
+import groovy.lang.Binding;
 import groovy.lang.GroovyClassLoader;
 import groovy.lang.GroovyObject;
+import groovy.lang.Script;
 import groovy.util.GroovyTestCase;
 
 import java.beans.BeanInfo;
 import java.beans.Introspector;
 import java.beans.PropertyDescriptor;
+import java.io.ByteArrayInputStream;
 import java.lang.reflect.Field;
 import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
@@ -63,6 +66,7 @@ import org.codehaus.groovy.ast.expr.Expression;
 import org.codehaus.groovy.ast.expr.FieldExpression;
 import org.codehaus.groovy.ast.expr.MethodCallExpression;
 import org.codehaus.groovy.ast.stmt.ExpressionStatement;
+import org.codehaus.groovy.runtime.InvokerHelper;
 import org.objectweb.asm.Constants;
 
 /**
@@ -148,6 +152,19 @@ public class TestSupport extends GroovyTestCase implements Constants {
                 expression));
     }
 
+    /**
+     * Asserts that the script runs without any exceptions
+     * @param script
+     */
+    protected void assertScript(String text) throws Exception {
+        log.info("About to execute script");
+        log.info(text);
+        
+        Class groovyClass = loader.parseClass(new ByteArrayInputStream(text.getBytes()), "TestScript.groovy");
+        Script script = InvokerHelper.createScript(groovyClass, new Binding());
+        script.run();
+    }
+    
     protected GroovyObject compile(String fileName) throws Exception {
         Class groovyClass = loader.parseClass(fileName);
 
