diff --git a/src/main/org/codehaus/groovy/classgen/FinalVariableAnalyzer.java b/src/main/org/codehaus/groovy/classgen/FinalVariableAnalyzer.java
index e131840ba6..1c26c76952 100644
--- a/src/main/org/codehaus/groovy/classgen/FinalVariableAnalyzer.java
+++ b/src/main/org/codehaus/groovy/classgen/FinalVariableAnalyzer.java
@@ -118,11 +118,9 @@ public class FinalVariableAnalyzer extends ClassCodeVisitorSupport {
     }
 
     public boolean isEffectivelyFinal(Variable v) {
-        if (v instanceof VariableExpression) {
-            v = ((VariableExpression) v).getAccessedVariable();
-        }
         VariableState state = getState().get(v);
-        return state == null || state.isFinal();
+        return (v instanceof Parameter && state == null)
+                || (state != null && state.isFinal());
     }
 
     @Override
diff --git a/src/test/org/codehaus/groovy/classgen/FinalVariableAnalyzerTest.groovy b/src/test/org/codehaus/groovy/classgen/FinalVariableAnalyzerTest.groovy
index 132cc2222b..d458a5c4d5 100644
--- a/src/test/org/codehaus/groovy/classgen/FinalVariableAnalyzerTest.groovy
+++ b/src/test/org/codehaus/groovy/classgen/FinalVariableAnalyzerTest.groovy
@@ -18,6 +18,7 @@ package org.codehaus.groovy.classgen
 
 import groovy.transform.CompileStatic
 import org.codehaus.groovy.ast.ClassNode
+import org.codehaus.groovy.ast.InnerClassNode
 import org.codehaus.groovy.ast.Variable
 import org.codehaus.groovy.ast.expr.VariableExpression
 import org.codehaus.groovy.control.CompilerConfiguration
@@ -249,7 +250,7 @@ class FinalVariableAnalyzerTest extends GroovyTestCase {
         '''
     }
 
-    void testDelayedAssignedClosureSharedVariableShouldBeConsideredFinal() {
+    void testDelayedAssignedClosureSharedVariableShouldNotBeConsideredFinal() {
         assertFinals x:false, '''
             def x
             def cl = { x }
@@ -266,6 +267,32 @@ class FinalVariableAnalyzerTest extends GroovyTestCase {
         ''')
     }
 
+
+    void testDirectlyAssignedAICSharedVariableShouldBeConsideredFinal() {
+        assertFinals x:true, '''
+            def x = 1
+            def cl = new Runnable() { void run() { x } }
+            cl.run()
+        '''
+    }
+
+    void testDelayedAssignedAICSharedVariableShouldNotBeConsideredFinal() {
+        assertFinals x:false, '''
+            def x
+            def cl = new Runnable() { void run() { x } }
+            cl.run()
+            x = 1
+        '''
+    }
+    void testShouldThrowCompilationErrorBecauseUsedInAIC() {
+        assertFinalCompilationErrors(['x'], '''
+            final x
+
+            def cl = new Runnable() { public void run() { x } }
+            x=1
+        ''')
+    }
+
     void testShouldBeCompileTimeErrorBecauseOfUninitializedVar() {
         assertFinalCompilationErrors(['x'], '''
             final x
@@ -395,8 +422,8 @@ class FinalVariableAnalyzerTest extends GroovyTestCase {
     @CompileStatic
     private static class AssertionFinalVariableAnalyzer extends FinalVariableAnalyzer {
 
-        private final Set<Variable> variablesToCheck = []
-        private final Map<String,Boolean> assertionsToCheck
+        private Set<Variable> variablesToCheck
+        private Map<String,Boolean> assertionsToCheck
 
         AssertionFinalVariableAnalyzer(final SourceUnit sourceUnit, final Map<String,Boolean> assertions) {
             super(sourceUnit)
@@ -414,14 +441,20 @@ class FinalVariableAnalyzerTest extends GroovyTestCase {
 
         @Override
         void visitClass(final ClassNode node) {
+            def old = variablesToCheck
+            variablesToCheck = []
             super.visitClass(node)
-            checkAssertions()
+            if (!(node instanceof InnerClassNode)) {
+                checkAssertions()
+            }
+            variablesToCheck = old
         }
 
         private void checkAssertions() {
-            variablesToCheck.each { var ->
-                def expectedValue = assertionsToCheck[var.name]
-                assert isEffectivelyFinal(var) == expectedValue
+            assertionsToCheck.each { name, shouldBeFinal ->
+                def candidates = variablesToCheck.findAll { it.name == name }
+                assert candidates.any { isEffectivelyFinal(it) == shouldBeFinal }
+
             }
         }
     }
