diff --git a/src/main/groovy/xml/StreamingMarkupBuilder.groovy b/src/main/groovy/xml/StreamingMarkupBuilder.groovy
index 255ec17a8e..be5fa46805 100644
--- a/src/main/groovy/xml/StreamingMarkupBuilder.groovy
+++ b/src/main/groovy/xml/StreamingMarkupBuilder.groovy
@@ -1,5 +1,5 @@
 /*
- * Copyright 2003-2010 the original author or authors.
+ * Copyright 2003-2011 the original author or authors.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -99,7 +99,6 @@ class StreamingMarkupBuilder extends AbstractStreamingBuilder {
         body.each {
             if (it instanceof Closure) {
                 def body1 = it.clone()
-
                 body1.delegate = doc
                 body1(doc)
             } else if (it instanceof Buildable) {
@@ -124,7 +123,6 @@ class StreamingMarkupBuilder extends AbstractStreamingBuilder {
             if (!(namespaces.containsKey(prefix) || pendingNamespaces.containsKey(prefix))) {
                 throw new GroovyRuntimeException("Namespace prefix: ${prefix} is not bound to a URI")
             }
-
             if (prefix != ":") tag = prefix + ":" + tag
         }
 
@@ -233,7 +231,7 @@ class StreamingMarkupBuilder extends AbstractStreamingBuilder {
         def enc = encoding; // take a snapshot of the encoding when the closure is bound to the builder
 
         {out ->
-            out = new StreamingMarkupWriter(out, enc)
+            out = new StreamingMarkupWriter(out, enc, useDoubleQuotes)
             boundClosure.trigger = out
             out.flush()
         }.asWritable()
diff --git a/src/main/groovy/xml/streamingmarkupsupport/StreamingMarkupWriter.java b/src/main/groovy/xml/streamingmarkupsupport/StreamingMarkupWriter.java
index 844b542769..a2821ac0e7 100644
--- a/src/main/groovy/xml/streamingmarkupsupport/StreamingMarkupWriter.java
+++ b/src/main/groovy/xml/streamingmarkupsupport/StreamingMarkupWriter.java
@@ -1,5 +1,5 @@
 /*
- * Copyright 2003-2007 the original author or authors.
+ * Copyright 2003-2011 the original author or authors.
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -32,6 +32,7 @@ public class StreamingMarkupWriter extends Writer {
     protected boolean writingAttribute = false;
     protected boolean haveHighSurrogate = false;
     protected StringBuffer surrogatePair = new StringBuffer(2);
+    private boolean useDoubleQuotes;
     private final Writer escapedWriter = new Writer() {
         /* (non-Javadoc)
         * @see java.io.Writer#close()
@@ -85,6 +86,11 @@ public class StreamingMarkupWriter extends Writer {
     };
 
     public StreamingMarkupWriter(final Writer writer, final String encoding) {
+        this(writer, encoding, false);
+    }
+
+    public StreamingMarkupWriter(final Writer writer, final String encoding, boolean useDoubleQuotes) {
+        this.useDoubleQuotes = useDoubleQuotes;
         this.writer = writer;
 
         if (encoding != null) {
@@ -160,8 +166,11 @@ public class StreamingMarkupWriter extends Writer {
                 this.writer.write("&#x");
                 this.writer.write(Integer.toHexString(c));
                 this.writer.write(';');
-            } else if (c == '\'' && this.writingAttribute) {
-                this.writer.write("&apos;");
+            }    else if(c == '\'' && this.writingAttribute && !useDoubleQuotes) {
+                    this.writer.write("&apos;");
+                }
+                else if(c == '"' && this.writingAttribute && useDoubleQuotes) {
+                    this.writer.write("&quot;");
             } else {
                 this.writer.write(c);
             }
diff --git a/src/test/groovy/xml/BuilderTestSupport.groovy b/src/test/groovy/xml/BuilderTestSupport.groovy
index c36ad9ae5a..86d4085e89 100644
--- a/src/test/groovy/xml/BuilderTestSupport.groovy
+++ b/src/test/groovy/xml/BuilderTestSupport.groovy
@@ -51,6 +51,26 @@ abstract class BuilderTestSupport extends GroovyTestCase {
         assertExpectedXml m, { it.useDoubleQuotes = true }, '<a href="http://groovy.codehaus.org">groovy</a>'
     }
 
+    void testNestedQuotesSingle() {
+        def m = {
+            root {
+                one( foo:"bar('baz')", 'foo("baz")' )
+                two( foo:'bar("baz")', "foo('baz')" )
+            }
+        }
+        assertExpectedXml m, '<root><one foo=\'bar(&apos;baz&apos;)\'>foo("baz")</one><two foo=\'bar("baz")\'>foo(\'baz\')</two></root>'
+    }
+
+    void testNestedQuotesDouble() {
+        def m = {
+            root {
+                one( foo:"bar('baz')", 'foo("baz")' )
+                two( foo:'bar("baz")', "foo('baz')" )
+            }
+        }
+        assertExpectedXml m, { it.useDoubleQuotes = true }, '<root><one foo="bar(\'baz\')">foo("baz")</one><two foo="bar(&quot;baz&quot;)">foo(\'baz\')</two></root>'
+    }
+
     void testTree() {
         def m = {
             root2(a: 5, b: 7) {
