diff --git a/pom.xml b/pom.xml
index eda0fca..606b670 100644
--- a/pom.xml
+++ b/pom.xml
@@ -62,7 +62,7 @@ under the License.
     <!--
       ! The following property is used in the integration tests MCOMPILER-157
     -->
-    <mavenPluginPluginVersion>3.3</mavenPluginPluginVersion>
+    <mavenPluginPluginVersion>3.5</mavenPluginPluginVersion>
     <plexusCompilerVersion>2.8</plexusCompilerVersion>
     <groovyVersion>1.8.0</groovyVersion>
     <groovyEclipseCompilerVersion>2.7.0-01</groovyEclipseCompilerVersion>
@@ -117,7 +117,7 @@ under the License.
     <dependency>
       <groupId>org.ow2.asm</groupId>
       <artifactId>asm</artifactId>
-      <version>5.1</version>
+      <version>6.0_ALPHA</version>
     </dependency>
 
     <dependency>
@@ -204,6 +204,9 @@ under the License.
                 <rules>
                   <enforceBytecodeVersion>
                     <maxJdkVersion>1.6</maxJdkVersion>
+                    <excludes>
+                      <exclude>org.ow2.asm:asm</exclude>
+                    </excludes>
                   </enforceBytecodeVersion>
                   <requireSameVersions />
                 </rules>
@@ -213,6 +216,13 @@ under the License.
         </plugin>
       </plugins>
     </pluginManagement>
+    <plugins>
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-plugin-plugin</artifactId>
+        <version>3.5</version>
+      </plugin>
+    </plugins>
   </build>
 
   <profiles>
diff --git a/src/it/MCOMPILER-268_modulepath/invoker.properties b/src/it/MCOMPILER-268_modulepath/invoker.properties
new file mode 100644
index 0000000..b70e6b3
--- /dev/null
+++ b/src/it/MCOMPILER-268_modulepath/invoker.properties
@@ -0,0 +1,18 @@
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+# 
+#   http://www.apache.org/licenses/LICENSE-2.0
+# 
+# Unless required by applicable law or agreed to in writing,
+# software distributed under the License is distributed on an
+# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+# KIND, either express or implied.  See the License for the
+# specific language governing permissions and limitations
+# under the License.
+
+invoker.java.version = 1.9+
diff --git a/src/it/MCOMPILER-268_modulepath/pom.xml b/src/it/MCOMPILER-268_modulepath/pom.xml
new file mode 100644
index 0000000..30be2cf
--- /dev/null
+++ b/src/it/MCOMPILER-268_modulepath/pom.xml
@@ -0,0 +1,58 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+  ~ Licensed to the Apache Software Foundation (ASF) under one
+  ~ or more contributor license agreements.  See the NOTICE file
+  ~ distributed with this work for additional information
+  ~ regarding copyright ownership.  The ASF licenses this file
+  ~ to you under the Apache License, Version 2.0 (the
+  ~ "License"); you may not use this file except in compliance
+  ~ with the License.  You may obtain a copy of the License at
+  ~
+  ~   http://www.apache.org/licenses/LICENSE-2.0
+  ~
+  ~ Unless required by applicable law or agreed to in writing,
+  ~ software distributed under the License is distributed on an
+  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+  ~ KIND, either express or implied.  See the License for the
+  ~ specific language governing permissions and limitations
+  ~ under the License.
+  -->
+
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+  <modelVersion>4.0.0</modelVersion>
+
+  <groupId>org.apache.maven.plugins.compiler.it</groupId>
+  <artifactId>mcompiler270</artifactId>
+  <version>1.0-SNAPSHOT</version>
+
+  <url>https://issues.apache.org/jira/browse/MCOMPILER-270</url>
+
+  <properties>
+    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
+  </properties>
+
+  <dependencies>
+    <dependency>
+      <groupId>junit</groupId>
+      <artifactId>junit</artifactId>
+      <version>3.8.2</version>
+      <scope>test</scope>
+    </dependency>
+  </dependencies>
+
+  <build>
+    <plugins>
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-compiler-plugin</artifactId>
+        <version>@project.version@</version>
+        <configuration>
+          <release>9</release>
+        </configuration>
+      </plugin>
+    </plugins>
+  </build>
+
+</project>
diff --git a/src/it/MCOMPILER-268_modulepath/src/main/java/com/foo/MyClass.java b/src/it/MCOMPILER-268_modulepath/src/main/java/com/foo/MyClass.java
new file mode 100644
index 0000000..dae085a
--- /dev/null
+++ b/src/it/MCOMPILER-268_modulepath/src/main/java/com/foo/MyClass.java
@@ -0,0 +1,25 @@
+package com.foo;
+
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * 
+ *   http://www.apache.org/licenses/LICENSE-2.0
+ * 
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+
+public class MyClass
+{
+
+}
diff --git a/src/it/MCOMPILER-268_modulepath/src/main/java/module-info.java b/src/it/MCOMPILER-268_modulepath/src/main/java/module-info.java
new file mode 100644
index 0000000..c0e023a
--- /dev/null
+++ b/src/it/MCOMPILER-268_modulepath/src/main/java/module-info.java
@@ -0,0 +1,22 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * 
+ *   http://www.apache.org/licenses/LICENSE-2.0
+ * 
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+
+module M.N {
+    
+}
\ No newline at end of file
diff --git a/src/it/MCOMPILER-268_modulepath/src/test/java/com/foo/MyTest.java b/src/it/MCOMPILER-268_modulepath/src/test/java/com/foo/MyTest.java
new file mode 100644
index 0000000..efb936e
--- /dev/null
+++ b/src/it/MCOMPILER-268_modulepath/src/test/java/com/foo/MyTest.java
@@ -0,0 +1,28 @@
+package com.foo;
+
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * 
+ *   http://www.apache.org/licenses/LICENSE-2.0
+ * 
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+
+import junit.framework.TestCase;
+
+public class MyTest
+    extends TestCase
+{
+    private MyClass myClass = new MyClass();
+}
diff --git a/src/it/MCOMPILER-268_modulepath/verify.groovy b/src/it/MCOMPILER-268_modulepath/verify.groovy
new file mode 100644
index 0000000..fc9c702
--- /dev/null
+++ b/src/it/MCOMPILER-268_modulepath/verify.groovy
@@ -0,0 +1,25 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *   http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+def log = new File( basedir, 'build.log').text
+
+assert log.count( " -release" ) == 2
+
+assert !( log =~  /\s-source\s/ )
+assert !( log =~  /\s-target\s/ )
+
diff --git a/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java b/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java
index 4303db3..3b937a4 100644
--- a/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java
+++ b/src/main/java/org/apache/maven/plugin/compiler/AbstractCompilerMojo.java
@@ -19,6 +19,17 @@ package org.apache.maven.plugin.compiler;
  * under the License.
  */
 
+import java.io.File;
+import java.lang.reflect.Method;
+import java.util.ArrayList;
+import java.util.Date;
+import java.util.HashSet;
+import java.util.LinkedHashMap;
+import java.util.LinkedHashSet;
+import java.util.List;
+import java.util.Map;
+import java.util.Set;
+
 import org.apache.maven.artifact.Artifact;
 import org.apache.maven.artifact.DefaultArtifact;
 import org.apache.maven.artifact.handler.ArtifactHandler;
@@ -58,17 +69,6 @@ import org.codehaus.plexus.compiler.util.scan.mapping.SingleTargetSourceMapping;
 import org.codehaus.plexus.compiler.util.scan.mapping.SourceMapping;
 import org.codehaus.plexus.compiler.util.scan.mapping.SuffixMapping;
 
-import java.io.File;
-import java.lang.reflect.Method;
-import java.util.ArrayList;
-import java.util.Date;
-import java.util.HashSet;
-import java.util.LinkedHashMap;
-import java.util.LinkedHashSet;
-import java.util.List;
-import java.util.Map;
-import java.util.Set;
-
 /**
  * TODO: At least one step could be optimized, currently the plugin will do two
  * scans of all the source code if the compiler has to have the entire set of
@@ -456,6 +456,8 @@ public abstract class AbstractCompilerMojo
 
     protected abstract List<String> getClasspathElements();
 
+    protected abstract List<String> getModulepathElements();
+
     protected abstract List<String> getCompileSourceRoots();
 
     protected abstract File getOutputDirectory();
@@ -472,6 +474,11 @@ public abstract class AbstractCompilerMojo
 
     protected abstract File getGeneratedSourcesDirectory();
 
+    protected final MavenProject getProject()
+    {
+        return project;
+    }
+
     @Override
     public void execute()
         throws MojoExecutionException, CompilationFailureException
@@ -529,6 +536,7 @@ public abstract class AbstractCompilerMojo
         {
             getLog().debug( "Source directories: " + compileSourceRoots.toString().replace( ',', '\n' ) );
             getLog().debug( "Classpath: " + getClasspathElements().toString().replace( ',', '\n' ) );
+            getLog().debug( "Modulepath: " + getModulepathElements().toString().replace( ',', '\n' ) );
             getLog().debug( "Output directory: " + getOutputDirectory() );
         }
 
@@ -542,6 +550,8 @@ public abstract class AbstractCompilerMojo
 
         compilerConfiguration.setClasspathEntries( getClasspathElements() );
 
+        compilerConfiguration.setModulepathEntries( getModulepathElements() );
+
         compilerConfiguration.setOptimize( optimize );
 
         compilerConfiguration.setDebug( debug );
@@ -831,6 +841,15 @@ public abstract class AbstractCompilerMojo
                 getLog().debug( " " + s );
             }
 
+            if ( !getModulepathElements().isEmpty() )
+            {
+                getLog().debug( "Modulepath:" );
+                for ( String s : getModulepathElements() )
+                {
+                    getLog().debug( " " + s );
+                }
+            }
+
             getLog().debug( "Source roots:" );
 
             for ( String root : getCompileSourceRoots() )
@@ -1308,11 +1327,15 @@ public abstract class AbstractCompilerMojo
 
         Date buildStartTime = getBuildStartTime();
 
-        for ( String classPathElement : getClasspathElements() )
+        List<String> pathElements = new ArrayList<String>();
+        pathElements.addAll( getClasspathElements() );
+        pathElements.addAll( getModulepathElements() );
+        
+        for ( String pathElement : pathElements )
         {
             // ProjectArtifacts are artifacts which are available in the local project
             // that's the only ones we are interested in now.
-            File artifactPath = new File( classPathElement );
+            File artifactPath = new File( pathElement );
             if ( artifactPath.isDirectory() )
             {
                 if ( hasNewFile( artifactPath, buildStartTime ) )
diff --git a/src/main/java/org/apache/maven/plugin/compiler/CompilerMojo.java b/src/main/java/org/apache/maven/plugin/compiler/CompilerMojo.java
index 9910b83..c9f34f0 100644
--- a/src/main/java/org/apache/maven/plugin/compiler/CompilerMojo.java
+++ b/src/main/java/org/apache/maven/plugin/compiler/CompilerMojo.java
@@ -20,6 +20,7 @@ package org.apache.maven.plugin.compiler;
  */
 
 import org.apache.maven.artifact.Artifact;
+import org.apache.maven.artifact.DependencyResolutionRequiredException;
 import org.apache.maven.plugin.MojoExecutionException;
 import org.apache.maven.plugins.annotations.LifecyclePhase;
 import org.apache.maven.plugins.annotations.Parameter;
@@ -53,12 +54,6 @@ public class CompilerMojo
     @Parameter( defaultValue = "${project.compileSourceRoots}", readonly = true, required = true )
     private List<String> compileSourceRoots;
 
-    /**
-     * Project classpath.
-     */
-    @Parameter( defaultValue = "${project.compileClasspathElements}", readonly = true, required = true )
-    private List<String> classpathElements;
-
     /**
      * The directory for compiled classes.
      */
@@ -103,6 +98,10 @@ public class CompilerMojo
     @Parameter ( property = "maven.main.skip" )
     private boolean skipMain;
 
+    private List<String> classpathElements;
+
+    private List<String> modulepathElements;
+    
     protected List<String> getCompileSourceRoots()
     {
         return compileSourceRoots;
@@ -113,6 +112,12 @@ public class CompilerMojo
         return classpathElements;
     }
 
+    @Override
+    protected List<String> getModulepathElements()
+    {
+        return modulepathElements;
+    }
+
     protected File getOutputDirectory()
     {
         return outputDirectory;
@@ -126,6 +131,16 @@ public class CompilerMojo
             getLog().info( "Not compiling main sources" );
             return;
         }
+
+        try
+        {
+            preparePaths();
+        }
+        catch ( DependencyResolutionRequiredException e )
+        {
+            throw new MojoExecutionException( e.getMessage() );
+        }
+
         super.execute();
 
         if ( outputDirectory.isDirectory() )
@@ -133,6 +148,28 @@ public class CompilerMojo
             projectArtifact.setFile( outputDirectory );
         }
     }
+    
+    private void preparePaths() throws DependencyResolutionRequiredException
+    {
+        boolean hasModuleDescriptor = false;
+        for ( String sourceRoot : getProject().getCompileSourceRoots() )
+        {
+            hasModuleDescriptor |= new File( sourceRoot, "module-info.java" ).exists();
+        }
+
+        List<String> pathElements = getProject().getCompileClasspathElements();
+        
+        if ( hasModuleDescriptor )
+        {
+            modulepathElements = pathElements;
+            classpathElements = Collections.emptyList();
+        }
+        else
+        {
+            classpathElements = pathElements;
+            modulepathElements = Collections.emptyList();
+        }
+    }
 
     protected SourceInclusionScanner getSourceInclusionScanner( int staleMillis )
     {
diff --git a/src/main/java/org/apache/maven/plugin/compiler/TestCompilerMojo.java b/src/main/java/org/apache/maven/plugin/compiler/TestCompilerMojo.java
index fc32bae..6ca9d98 100644
--- a/src/main/java/org/apache/maven/plugin/compiler/TestCompilerMojo.java
+++ b/src/main/java/org/apache/maven/plugin/compiler/TestCompilerMojo.java
@@ -19,6 +19,7 @@ package org.apache.maven.plugin.compiler;
  * under the License.
  */
 
+import org.apache.maven.artifact.DependencyResolutionRequiredException;
 import org.apache.maven.plugin.MojoExecutionException;
 import org.apache.maven.plugins.annotations.LifecyclePhase;
 import org.apache.maven.plugins.annotations.Mojo;
@@ -28,7 +29,10 @@ import org.codehaus.plexus.compiler.util.scan.SimpleSourceInclusionScanner;
 import org.codehaus.plexus.compiler.util.scan.SourceInclusionScanner;
 import org.codehaus.plexus.compiler.util.scan.StaleSourceScanner;
 
+
 import java.io.File;
+import java.io.IOException;
+import java.util.ArrayList;
 import java.util.Collections;
 import java.util.HashSet;
 import java.util.List;
@@ -60,12 +64,6 @@ public class TestCompilerMojo
     @Parameter ( defaultValue = "${project.testCompileSourceRoots}", readonly = true, required = true )
     private List<String> compileSourceRoots;
 
-    /**
-     * Project test classpath.
-     */
-    @Parameter ( defaultValue = "${project.testClasspathElements}", required = true, readonly = true )
-    private List<String> classpathElements;
-
     /**
      * The directory where compiled test classes go.
      */
@@ -147,6 +145,9 @@ public class TestCompilerMojo
     @Parameter ( defaultValue = "${project.build.directory}/generated-test-sources/test-annotations" )
     private File generatedTestSourcesDirectory;
 
+    private List<String> classpathElements;
+
+    private List<String> modulepathElements;
 
     public void execute()
         throws MojoExecutionException, CompilationFailureException
@@ -157,6 +158,15 @@ public class TestCompilerMojo
         }
         else
         {
+            try
+            {
+                preparePaths();
+            }
+            catch ( DependencyResolutionRequiredException e )
+            {
+                throw new MojoExecutionException( e.getMessage() );
+            }
+            
             super.execute();
         }
     }
@@ -170,12 +180,89 @@ public class TestCompilerMojo
     {
         return classpathElements;
     }
+    
+    @Override
+    protected List<String> getModulepathElements()
+    {
+        return modulepathElements;
+    }
 
     protected File getOutputDirectory()
     {
         return outputDirectory;
     }
 
+    private void preparePaths()
+        throws DependencyResolutionRequiredException
+    {
+        File mainOutputDirectory = new File( getProject().getBuild().getOutputDirectory() );
+
+        File mainModuleInfo = new File( mainOutputDirectory, "module-info.class" );
+        
+        boolean hasMainModuleDescriptor = mainModuleInfo.exists();
+        
+        boolean hasTestModuleDescriptor = false;
+        for ( String sourceRoot : getProject().getTestCompileSourceRoots() )
+        {
+            hasTestModuleDescriptor |= new File( sourceRoot, "module-info.java" ).exists();
+        }
+        
+        List<String> compilePathElements = getProject().getCompileClasspathElements();
+        List<String> testPathElements = getProject().getTestClasspathElements();
+
+        List<String> testScopedElements = new ArrayList<String>( testPathElements );
+        testScopedElements.removeAll( compilePathElements );
+        
+        if ( hasTestModuleDescriptor )
+        {
+            modulepathElements = testPathElements;
+            classpathElements = Collections.emptyList();
+
+            if ( hasMainModuleDescriptor )
+            {
+                // maybe some extra analysis required
+            }
+            else
+            {
+                // very odd
+                // Means that main sources must be compiled with -modulesource and -Xmodule:<moduleName>
+                // However, this has a huge impact since you can't simply use it as a classpathEntry 
+                // due to extra folder in between
+                throw new UnsupportedOperationException( "Can't compile test sources "
+                    + "when main sources are missing a module descriptor" );
+            }
+        }
+        else
+        {
+            if ( hasMainModuleDescriptor )
+            {
+                modulepathElements = compilePathElements;
+                classpathElements = testScopedElements;
+                if ( compilerArgs == null )
+                {
+                    compilerArgs = new ArrayList<String>();
+                }
+                
+                try
+                {
+                    String moduleName = new AsmModuleInfoParser().getModuleName( mainOutputDirectory  );
+                    compilerArgs.add( "-Xmodule:" + moduleName );
+                    compilerArgs.add( "--add-modules" );
+                    compilerArgs.add( moduleName );
+                }
+                catch ( IOException e )
+                {
+                    throw new RuntimeException( "Failed to parse module-info: " + e.getMessage() );
+                }
+            }
+            else
+            {
+                modulepathElements = Collections.emptyList();
+                classpathElements = testPathElements;
+            }
+        }
+    }
+
     protected SourceInclusionScanner getSourceInclusionScanner( int staleMillis )
     {
         SourceInclusionScanner scanner;
diff --git a/src/test/java/org/apache/maven/plugin/compiler/CompilerMojoTestCase.java b/src/test/java/org/apache/maven/plugin/compiler/CompilerMojoTestCase.java
index 1b1e469..f948cb1 100644
--- a/src/test/java/org/apache/maven/plugin/compiler/CompilerMojoTestCase.java
+++ b/src/test/java/org/apache/maven/plugin/compiler/CompilerMojoTestCase.java
@@ -32,6 +32,7 @@ import java.util.List;
 import java.util.Set;
 
 import org.apache.maven.artifact.Artifact;
+import org.apache.maven.artifact.handler.ArtifactHandler;
 import org.apache.maven.execution.MavenSession;
 import org.apache.maven.plugin.MojoExecution;
 import org.apache.maven.plugin.compiler.stubs.CompilerManagerStub;
@@ -45,6 +46,25 @@ import org.apache.maven.project.MavenProject;
 public class CompilerMojoTestCase
     extends AbstractMojoTestCase
 {
+    
+    private String source;
+    
+    private String target;
+    
+    @Override
+    protected void setUp()
+        throws Exception
+    {
+        super.setUp();
+        
+        String javaSpec = System.getProperty( "java.specification.version" );
+        if ( "9".equals( javaSpec ) )
+        {
+            source = "6";
+            target = "6";
+        }
+    }
+    
     /**
      * tests the ability of the plugin to compile a basic file
      *
@@ -54,7 +74,7 @@ public class CompilerMojoTestCase
         throws Exception
     {
         CompilerMojo compileMojo = getCompilerMojo( "target/test-classes/unit/compiler-basic-test/plugin-config.xml" );
-
+        
         compileMojo.execute();
 
         File testClass = new File( compileMojo.getOutputDirectory(), "TestCompile0.class" );
@@ -305,8 +325,8 @@ public class CompilerMojoTestCase
         setVariableValueToObject( mojo, "session", getMockMavenSession() );
         setVariableValueToObject( mojo, "project", getMockMavenProject() );
         setVariableValueToObject( mojo, "mojoExecution", getMockMojoExecution() );
-
-        assertNotNull( mojo );
+        setVariableValueToObject( mojo, "source", source );
+        setVariableValueToObject( mojo, "target", target );
 
         return mojo;
     }
@@ -325,28 +345,40 @@ public class CompilerMojoTestCase
         setVariableValueToObject( mojo, "outputDirectory", testClassesDir );
 
         List<String> testClasspathList = new ArrayList<String>();
+        
+        Artifact junitArtifact = mock( Artifact.class );
+        ArtifactHandler handler = mock( ArtifactHandler.class );
+        when( handler.isAddedToClasspath() ).thenReturn( true );
+        when( junitArtifact.getArtifactHandler() ).thenReturn( handler );
 
+        File artifactFile;
         String localRepository = System.getProperty( "localRepository" );
         if ( localRepository != null )
         {
-            testClasspathList.add( localRepository + "/junit/junit/3.8.1/junit-3.8.1.jar" );
+            artifactFile = new File( localRepository, "junit/junit/3.8.1/junit-3.8.1.jar" );
         }
         else
         {
             // for IDE
             String junitURI = org.junit.Test.class.getResource( "Test.class" ).toURI().toString();
             junitURI = junitURI.substring( "jar:".length(), junitURI.indexOf( '!' ) );
-            testClasspathList.add( new File( URI.create( junitURI ) ).getAbsolutePath() );
+            artifactFile = new File( URI.create( junitURI ) );
         }
+        when ( junitArtifact.getFile() ).thenReturn( artifactFile );
         
         testClasspathList.add( compilerMojo.getOutputDirectory().getPath() );
-        setVariableValueToObject( mojo, "classpathElements", testClasspathList );
 
         String testSourceRoot = testPom.getParent() + "/src/test/java";
         setVariableValueToObject( mojo, "compileSourceRoots", Collections.singletonList( testSourceRoot ) );
 
+        MavenProject project = getMockMavenProject();
+        project.setArtifacts( Collections.singleton( junitArtifact )  );
+        project.getBuild().setOutputDirectory( new File( buildDir, "classes" ).getAbsolutePath() );
+        setVariableValueToObject( mojo, "project", project );
         setVariableValueToObject( mojo, "session", getMockMavenSession() );
         setVariableValueToObject( mojo, "mojoExecution", getMockMojoExecution() );
+        setVariableValueToObject( mojo, "source", source );
+        setVariableValueToObject( mojo, "target", target );
 
         return mojo;
     }
@@ -355,7 +387,8 @@ public class CompilerMojoTestCase
     {
         MavenProject mp = new MavenProject();
         mp.getBuild().setDirectory( "target" );
-
+        mp.getBuild().setOutputDirectory( "target/classes" );
+        mp.getBuild().setTestOutputDirectory( "target/test-classes" );
         return mp;
     }
 
