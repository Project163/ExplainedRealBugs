<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3781] Zookeeper 3.5.7 not creating snapshot</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3781</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;In our deployment, we are using zookeepers as Kafka quorum.&lt;/p&gt;

&lt;p&gt;Recently we upgraded Zookeeper from 3.4.14 to 3.5.7.&lt;br/&gt;
During the upgrade, we enabled snapshot.trust.empty and removed it after.&lt;br/&gt;
However, about 25% of zookeepers (all on 3.5.7) are not creating snapshot files, so they keep crashing on reboot with ERROR.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main:QuorumPeer@937] - Unable to load database on disk
&amp;lt;http://java.io|java.io&amp;gt;.IOException: No snapshot found, but there are log entries. Something is broken!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nothing suspecious did I find from the zookeeper log.&lt;/p&gt;

&lt;p&gt;I managed to reproduce the issue with the data from our servers, I put them in the attachment.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13295551">ZOOKEEPER-3781</key>
            <summary>Zookeeper 3.5.7 not creating snapshot</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="weichu">Wei Chu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 1 Apr 2020 14:54:08 +0000</created>
                <updated>Mon, 16 May 2022 19:13:44 +0000</updated>
                            <resolved>Sat, 6 Mar 2021 19:43:24 +0000</resolved>
                                                    <fixVersion>3.5.10</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                    <fixVersion>3.6.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15600">4h 20m</timespent>
                                <comments>
                            <comment id="17072843" author="weichu" created="Wed, 1 Apr 2020 15:01:16 +0000"  >&lt;p&gt;According to the document, &lt;tt&gt;snapshot.trust.empty&lt;/tt&gt; should only be used during upgrade. I interpret it as if all zookeepers are on newer version, they should all generate snapshot.&lt;/p&gt;

&lt;p&gt;But our instances are not behaving like that, so zk cannot boot without &lt;tt&gt;snapshot.trust.empty=true&lt;/tt&gt;. This looks like a bug to me.&lt;/p&gt;

&lt;p&gt;I used the vanilla zookeeper 3.5.7 and the issue can be reproduced by the commands&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
terminal-1 $ ./apache-zookeeper-3.5.7-bin/bin/zkServer.sh start-foreground /path/to/zk1.cfg

terminal-2 $ ./apache-zookeeper-3.5.7-bin/bin/zkServer.sh start-foreground /path/to/zk2.cfg

terminal-3 $ ./apache-zookeeper-3.5.7-bin/bin/zkServer.sh start-foreground /path/to/zk2.cfg
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17162678" author="tharindu" created="Wed, 22 Jul 2020 10:16:04 +0000"  >&lt;p&gt;Facing the same issue when upgrading to 3.5.8 from 3.4.14 utilizing snapshot.trust.empty=true where some zookeeper nodes in the ensemble did not have snapshot files.&#160;&lt;/p&gt;

&lt;p&gt;Having successfully starting up with 3.5.8, nodes that did not have snapshot files did not create them and we were not able to start zookeeper without the&#160;snapshot.trust.empty=true config.&#160;&lt;/p&gt;

&lt;p&gt;Had to delete the data and datalog directories and allow syncing from the ensemble to work around.&#160;&lt;/p&gt;</comment>
                            <comment id="17261317" author="srdo" created="Fri, 8 Jan 2021 13:53:02 +0000"  >&lt;p&gt;We are also seeing this on versions from 3.5.7 to 3.6.2.&lt;/p&gt;

&lt;p&gt;I took at look at when snapshots are written, and it seems to be in these cases:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The node is starting off an empty database (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L291&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L291&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;If the node is becoming leader (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java#L511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java#L511&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;If the node is following, received UPTODATE and the protocol is pre ZAB 1.0, which is not happening in 3.5.x+ (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java#L669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java#L669&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;If the node is following and did not receive DIFF from the leader, i.e. the follower is far behind the leader (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java#L689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java#L689&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;If the node has received enough transactions (controlled by snapCount) that the periodic snapshot should be written (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/SyncRequestProcessor.java#L193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/release-3.6.2/zookeeper-server/src/main/java/org/apache/zookeeper/server/SyncRequestProcessor.java#L193&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This leads me to believe that there are the following workarounds, unless you want to run with snapshot.trust.empty=true long-term:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Leave the cluster running with snapshot.trust.empty=true until enough transactions has been written to trigger a snapshot write. The default snapCount is 100.000, but this could be temporarily lowered.&lt;/li&gt;
	&lt;li&gt;While leaving a quorum running, shut down the nodes without snapshots and delete their data. When they restart, the leader will send them a snapshot instead of DIFF.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think it would be nice if this could be fixed in a future Zookeeper version to make migration from 3.4.x easier. Maybe followers could ask for a full snapshot from the leader if snapshot.trust.empty=true, or they could write a snapshot on boot?&lt;/p&gt;</comment>
                            <comment id="17296635" author="ztzg" created="Sat, 6 Mar 2021 19:43:24 +0000"  >&lt;p&gt;Issue resolved by pull request 1581&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1581&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1581&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17456149" author="ananysin" created="Thu, 9 Dec 2021 05:14:24 +0000"  >&lt;p&gt;Hi, can we backport this to branch-3.5?&lt;/p&gt;</comment>
                            <comment id="17537739" author="symat" created="Mon, 16 May 2022 19:13:44 +0000"  >&lt;p&gt;this is an important fix, I cherry-picked it to branch-3.5 to be part of the release 3.5.10 I&apos;m working on.&lt;/p&gt;

&lt;p&gt;As it was missing also from branch-3.6, I pushed it there too (after running the tests).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13416443">ZOOKEEPER-4421</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12998484" name="zk_no_snapshot.zip" size="1648014" author="weichu" created="Wed, 1 Apr 2020 14:51:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0d648:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>