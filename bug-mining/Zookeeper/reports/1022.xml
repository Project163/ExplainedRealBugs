<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3905] Race condition causes sessions to be created for clients even though their certificate authentication has failed</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3905</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;To reproduce, apply the diff and run&#160;ClientSSLTest#testSecureStandaloneServer() test.&#160;The logs would show that a valid session was created before connection was rejected and client had to retry&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKTrustManager.java b/zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKTrustManager.java
 index aa02145b2..df1bdcc0f 100644
 &#8212; a/zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKTrustManager.java
 +++ b/zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKTrustManager.java
 @@ -111,6 +111,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkServerTrusted(X509Certificate[] chain, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; authType, SSLEngi
 @Override
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkClientTrusted(X509Certificate[] chain, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; authType) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CertificateException
{ x509ExtendedTrustManager.checkClientTrusted(chain, authType); + &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CertificateException(); }
@Override
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&#160;&lt;br/&gt;
 What should have happened:&lt;br/&gt;
 Server should instantly close the client&apos;s connection and NOT process any request.&lt;br/&gt;
 &#160;&lt;br/&gt;
 Potential threat:&lt;br/&gt;
 Malicious clients may be able to put unnecessary&#160;load/traffic&#160;on the leader by creating these sessions.&lt;br/&gt;
 &#160;&lt;br/&gt;
 Race Condition:&lt;br/&gt;
 In&#160;CertificateVerifier#operationComplete(), `addCnxn(cnxn)` method is only called after auth is completed.&#160;NettyServerCnxn#close() returns as a no-op&#160;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.5/zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java#L105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;br/&gt;
 &#160;&lt;br/&gt;
 I see this as an issue.&#160;Please assess the risk and let me know if this is a legit behavior or not.&lt;br/&gt;
 &#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13320715">ZOOKEEPER-3905</key>
            <summary>Race condition causes sessions to be created for clients even though their certificate authentication has failed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andor">Andor Molnar</assignee>
                                    <reporter username="karanmehta93">Karan Mehta</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Aug 2020 17:46:14 +0000</created>
                <updated>Thu, 10 Sep 2020 10:43:34 +0000</updated>
                            <resolved>Sat, 8 Aug 2020 09:53:22 +0000</resolved>
                                    <version>3.5.8</version>
                    <version>3.6.2</version>
                                    <fixVersion>3.5.9</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                    <fixVersion>3.6.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="21000">5h 50m</timespent>
                                <comments>
                            <comment id="17170234" author="karanmehta93" created="Mon, 3 Aug 2020 17:48:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt_impala_99b5&quot; class=&quot;user-hover&quot; rel=&quot;phunt_impala_99b5&quot;&gt;phunt_impala_99b5&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abrahamfine&quot; class=&quot;user-hover&quot; rel=&quot;abrahamfine&quot;&gt;abrahamfine&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17170673" author="andorm" created="Tue, 4 Aug 2020 09:22:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karanmehta93&quot; class=&quot;user-hover&quot; rel=&quot;karanmehta93&quot;&gt;karanmehta93&lt;/a&gt;&#160;Thansk for reporting the issue.&lt;/p&gt;

&lt;p&gt;I cannot apply your diff. Would you please attach a file instead which can be applied via &quot;git apply&quot; command?&lt;/p&gt;</comment>
                            <comment id="17170820" author="andorm" created="Tue, 4 Aug 2020 14:10:20 +0000"  >&lt;p&gt;Okay, it was long time ago, but I see the following which might be an issue here. In the test you mentioned the problem is that although client certificate is not trusted (hence the patch to force it), the test is able to create ZK client successfully and establishing a session.&lt;/p&gt;

&lt;p&gt;Exception is thrown later when the client timeouts, because while the server is processing requests, it&apos;s unable to response to a non-registered client. Weird.&lt;/p&gt;

&lt;p&gt;I&apos;m trying to repro it with a &quot;real&quot; server.&lt;/p&gt;</comment>
                            <comment id="17170826" author="andorm" created="Tue, 4 Aug 2020 14:18:47 +0000"  >&lt;p&gt;&lt;em&gt;&quot;it&apos;s unable to response to a non-registered client&quot;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;ConnectRequest/ConnectResponse is different, because ZookeeperServer doesn&apos;t care about&#160;&lt;em&gt;channelClosing&lt;/em&gt;&#160;flag and sends the response to the buffer no matter what. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17170880" author="andorm" created="Tue, 4 Aug 2020 15:30:04 +0000"  >&lt;p&gt;This is very odd, I cannot repro it with a real cluster/client.&#160;&lt;/p&gt;

&lt;p&gt;If I try to create a client which provides a certificate that is not trusted, I&apos;ll get a connection cannot be established error during SSL handshake. Handshake fails essentially.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-08-04 16:50:09,883 [myid:1] - ERROR [nioEventLoopGroup-7-4:NettyServerCnxnFactory$CertificateVerifier@363] - Unsuccessful handshake with session 0x0
2020-08-04 16:50:09,884 [myid:1] - WARN  [nioEventLoopGroup-7-4:NettyServerCnxnFactory$CnxnChannelHandler@220] - Exception caught
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: General SSLEngine problem
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;CertificateVerifier&lt;/tt&gt; doesn&apos;t even try to authenticate the client, because the handshake process failed previously.&lt;/p&gt;

&lt;p&gt;Question: is it possible to provide a cerificate which is trusted by the server, handshake completes and later &lt;tt&gt;CerificateVerifier&lt;/tt&gt; fails to authenticate?&lt;/p&gt;

&lt;p&gt;It uses the same &lt;tt&gt;ZKTrustManager&lt;/tt&gt; as SSLHandler and calls the same &lt;tt&gt;checkClientTrusted()&lt;/tt&gt;&#160;method.&lt;/p&gt;

&lt;p&gt;We might double check the certificate in this process and CertificateVerifier is redundant.&lt;/p&gt;</comment>
                            <comment id="17171000" author="karanmehta93" created="Tue, 4 Aug 2020 18:00:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt;&#160;Let me clarify a few more things.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Question: is it possible to provide a cerificate which is trusted by the server, handshake completes and later&#160;&lt;tt&gt;CerificateVerifier&lt;/tt&gt;&#160;fails to authenticate?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. Actually, we have added some more code in&#160;CerificateVerifier class for authorization of clients. This is where it is failing. We do this check &lt;em&gt;only if&lt;/em&gt;&#160;certificate is validated to be good (SSL level checks are passed)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clientId = getClientId(clientCert);
 &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; authZResult = authorizeClient(clientId);
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!authZResult) {
 LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Client id {} doesn&apos;t match the allowedList&quot;&lt;/span&gt;, clientId);
 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; KeeperException.Code.AUTHFAILED;
 }
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;This is very odd, I cannot repro it with a real cluster/client.&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Actually, I saw this issue on a real cluster only. I didn&apos;t have any easy way to reproduce this, so hacked up the code in this manner.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Exception is thrown later when the client timeouts, because while the server is processing requests, it&apos;s unable to response to a non-registered client. Weird.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What I expected is that returning&#160;AUTHFAILED, would immediately terminate that connection (and even send that response code back to client). Yes, what you said is exactly right.&lt;/p&gt;

&lt;p&gt;What do you think should be next steps here?&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17171138" author="andorm" created="Tue, 4 Aug 2020 21:29:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Actually, we have added some more code in&#160;CerificateVerifier class for authorization of clients.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That means you have modified ZooKeeper&apos;s source code which essentially created this problem.&#160;This is not supported and we don&apos;t have anything to fix here. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Instead I believe we can do this via a custom x509 authentication provider. KeyManager and TrustManager remain the same meaning we&apos;ll have successful SSL handshake, but we add custom code to &lt;tt&gt;handleAuthentication()&lt;/tt&gt; and fail. I&apos;ll try this tomorrow.&lt;/p&gt;</comment>
                            <comment id="17171158" author="karanmehta93" created="Tue, 4 Aug 2020 21:49:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt;&#160;yes, thats exactly what we do. We use a custom X509AuthProvider. It is a light fork from branch-3.5. It extends&#160;X509AuthenticationProvider class, with a small business logic for authorization (which I posted in code above). It was needed to address our internal security requirements.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;That means you have modified ZooKeeper&apos;s source code which essentially created this problem.&#160;This is not supported and we don&apos;t have anything to fix here. We might double check the certificate in this process and CertificateVerifier is redundant.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Makes sense, this piece of code was added a long time ago and things might have changed since.&#160;If this isn&apos;t supported, how should we address it?&lt;/p&gt;</comment>
                            <comment id="17171314" author="andorm" created="Wed, 5 Aug 2020 07:33:54 +0000"  >&lt;p&gt;Originally you said &quot;we have added some more code in&#160;CerificateVerifier&quot; that&apos;s why I said you&apos;ve modified ZooKeeper source code. If you inherited&#160;X509AuthProvider and injected the code in the supported way by definining it in the config file, that&apos;s completely file. That&apos;s how it should done.&lt;/p&gt;

&lt;p&gt;I&apos;m talking about a new test case that works in a similar fashion and I&apos;m trying to put together later today. Stay tuned.&lt;/p&gt;</comment>
                            <comment id="17171728" author="andorm" created="Wed, 5 Aug 2020 20:06:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karanmehta93&quot; class=&quot;user-hover&quot; rel=&quot;karanmehta93&quot;&gt;karanmehta93&lt;/a&gt;&#160;I&apos;ve managed to repro the issue with a real cluster. I injected an authentication provider which succeeds in SSL handshake, but returns AUTHFAIL when authenticates the client. I was able to connect with the CLI client and create a znode in the tree. The response didn&apos;t get back to the client, but the tree has been modified which is not good.&#160;&lt;/p&gt;

&lt;p&gt;Issue is confirmed.&lt;/p&gt;

&lt;p&gt;I&apos;ll put together a unit test and PR soon.&lt;/p&gt;</comment>
                            <comment id="17171751" author="karanmehta93" created="Wed, 5 Aug 2020 20:57:23 +0000"  >&lt;p&gt;Great, thanks for the update. Looking forward for the patch.&lt;/p&gt;</comment>
                            <comment id="17172363" author="andorm" created="Thu, 6 Aug 2020 13:33:25 +0000"  >&lt;p&gt;Pull request available&#160;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1422&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17172387" author="symat" created="Thu, 6 Aug 2020 13:56:39 +0000"  >&lt;p&gt;does this error happen only when custom authentication provider is defined together with SSL?&lt;/p&gt;

&lt;p&gt;Is SASL a custom provider in this case? Does the error happen with failed SASL authentication when SSL is also used?&lt;/p&gt;</comment>
                            <comment id="17172519" author="andorm" created="Thu, 6 Aug 2020 16:29:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;These are very good questions, I don&apos;t know yet.&lt;/p&gt;

&lt;p&gt;It should not be related to SSL, but I need to double check.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hfkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>