<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3885] zoo_aremove_watches segfault: zk_hashtable needs locking!</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3885</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We&apos;re encountering the following segfault (stack abridged).&lt;/p&gt;

&lt;p&gt;This happens because the watcher hashtable has no locking, and is accessed concurrently from multiple threads:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the thread doing zoo_aremove_watches, and&lt;/li&gt;
	&lt;li&gt;the IO thread adding / firing watchers&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We encountered this with zookeeper 3.5.8, but by code inspection the code appears the same in 3.6.&lt;/p&gt;

&lt;p&gt;&#160;*** Aborted at 1594473472 (Unix time, try &apos;date -d @1594473472&apos;) ***&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;Signal 11 (SIGSEGV) (0xae000000aa) received by PID 199 (pthread TID 0x7f1d64667700) (linux TID 1273) (code: address not mapped to object), stack trace: ***&lt;br/&gt;
    @ 00007f1d98dfc8b3 folly::symbolizer::(anonymous namespace)::signalHandler(int, siginfo_t*, void*)&lt;br/&gt;
                       /src/folly/folly/experimental/symbolizer/SignalHandler.cpp:431&lt;br/&gt;
    @ 00007f1d95e6c89f (unknown)&lt;br/&gt;
    @ 00007f1d8f73de1e containsWatcher.part.3&lt;br/&gt;
                       /src/zookeeper/zookeeper-client/zookeeper-client-c/src/zk_hashtable.c:152&lt;br/&gt;
    @ 00007f1d8f73e806 pathHasWatcher&lt;br/&gt;
                       /src/zookeeper/zookeeper-client/zookeeper-client-c/src/zk_hashtable.c:456&lt;br/&gt;
    @ 00007f1d8f7382dd aremove_watches&lt;br/&gt;
                       /src/zookeeper/zookeeper-client/zookeeper-client-c/src/zookeeper.c:4260&lt;br/&gt;
    @ 00007f1d8f738f82 zoo_aremove_watches&lt;br/&gt;
                       /src/zookeeper/zookeeper-client/zookeeper-client-c/src/zookeeper.c:5131&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13316511">ZOOKEEPER-3885</key>
            <summary>zoo_aremove_watches segfault: zk_hashtable needs locking!</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tudorb">Tudor Bosman</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jul 2020 17:29:43 +0000</created>
                <updated>Thu, 10 Sep 2020 10:43:36 +0000</updated>
                            <resolved>Fri, 31 Jul 2020 14:47:50 +0000</resolved>
                                    <version>3.6.1</version>
                    <version>3.5.8</version>
                                    <fixVersion>3.5.9</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                    <fixVersion>3.6.2</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17157648" author="tudorb" created="Tue, 14 Jul 2020 20:10:48 +0000"  >&lt;p&gt;PR: &lt;a href=&quot;https://github.com/apache/zookeeper/pull/1403&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1403&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17159437" author="tudorb" created="Thu, 16 Jul 2020 19:56:17 +0000"  >&lt;p&gt;This has a bug; we are holding the new mutex around calling the watcher callbacks, which means there&apos;s a possibility for deadlock (specifically, we can&apos;t call zoo_aremove_watchers from the callback.)&lt;/p&gt;</comment>
                            <comment id="17159451" author="tudorb" created="Thu, 16 Jul 2020 20:15:26 +0000"  >&lt;p&gt;Thankfully, we don&apos;t need the mutex at all around deliverWatchers(), as that&apos;s iterating through a private list; the watchers were moved from the global hashtable (under the lock) to the private list in collectWatchers(). PR updated.&lt;/p&gt;</comment>
                            <comment id="17168906" author="symat" created="Fri, 31 Jul 2020 14:47:50 +0000"  >&lt;p&gt;Issue resolved by pull request 1403&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1403&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1403&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gpoo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>