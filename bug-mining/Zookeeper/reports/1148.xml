<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:05:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4394] Learner.syncWithLeader got NullPointerException</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4394</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;ZooKeeper follower node encountered NullPointerException during syncWithLeader.&lt;/p&gt;

&lt;p&gt;Logs indicate that the follower has received NEWLEADER packet between a PROPOSAL packet and it&apos;s corresponding COMMIT packet. The NEWLEADER packet leads to&#160;packetsNotCommitted.clear(), yet the COMMIT packet still wants to do packetsNotCommitted.peekFirst() to get the former PROPOSAL packet, and the later if-statement raised NPE.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Leader.COMMIT:
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Leader.COMMITANDACTIVATE:
    pif = packetsNotCommitted.peekFirst();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pif.hdr.getZxid() == qp.getZxid() &amp;amp;&amp;amp; qp.getType() == Leader.COMMITANDACTIVATE) {
        &lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;    }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After look into the Leader side, I found:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;LearnerHandler.syncFollower queues packets with zxid &amp;lt;=&#160;maxCommittedLog (PROPOSAL/COMMIT pairs);&lt;/li&gt;
	&lt;li&gt;Leader.startForwarding queues toBeApplied packets(PROPOSAL/COMMIT pairs);&lt;/li&gt;
	&lt;li&gt;Leader.startForwarding queues&#160;outstandingProposals packets(PROSOAL only);&lt;/li&gt;
	&lt;li&gt;LeanerHandler.run sends NEWLEADER message.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Seams if the outstandingProposals is not empty at the certain moment, the follower could then receive PROPOSAL/NEWLEADER/COMMIT&#160;packets in order.&lt;/p&gt;

&lt;p&gt;The follower will retry from LOOKING again and is expected to be succeed at last, however, under heavy load it may be too many retries. Further more, I my case the follower has to sync data from leader&apos;s disk, and start over again after the NPE(prior sync not flushed?), which may harm the leader.&lt;/p&gt;

&lt;p&gt;I don&apos;t know if it is designed so or not, but consider the performance, can we at least avoid wasting of network/disk IO?&lt;/p&gt;</description>
                <environment>&lt;p&gt;ZooKeeper 3.7.0&lt;/p&gt;</environment>
        <key id="13405756">ZOOKEEPER-4394</key>
            <summary>Learner.syncWithLeader got NullPointerException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="littleorca">Liu Haifeng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 9 Oct 2021 08:47:52 +0000</created>
                <updated>Wed, 30 Apr 2025 02:22:01 +0000</updated>
                            <resolved>Thu, 19 Sep 2024 15:34:35 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>3.10.0</fixVersion>
                    <fixVersion>3.9.3</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10200">2h 50m</timespent>
                                <comments>
                            <comment id="17854738" author="tsuna" created="Thu, 13 Jun 2024 12:31:38 +0000"  >&lt;p&gt;This issue was reported in the 3.7.x branch but it also exists in 3.8.x (and probably 3.9.x although I haven&apos;t checked there). Other related JIRA: &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-4541&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;ZOOKEEPER-4541&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17872050" author="tsuna" created="Thu, 8 Aug 2024 15:03:35 +0000"  >&lt;p&gt;One of our dev clusters ran into this bug.&lt;/p&gt;

&lt;p&gt;Quorum: zookeeper-0, zookeeper-1(leader), zookeeper-2&lt;/p&gt;

&lt;p&gt;Client app holding an ephemeral znode exits:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# zookeeper-0 log
2024-08-07 15:22:58,929 [myid:] - INFO  [NIOWorkerThread-4:o.a.z.s.NIOServerCnxn@337] - Unable to read additional data from client, it probably closed the socket: address = /10.128.31.11:42544, session = 0x30019eb942d0028
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;shortly thereafter:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# zookeeper-2 log
2024-08-07 15:23:00,009 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.QuorumPeer@922] - Peer state changed: following - synchronization
2024-08-07 15:23:00,010 [myid:] - INFO &#160;[QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.CommitProcessor@490] - Configuring CommitProcessor with readBatchSize -1 commitBatchSize 1
2024-08-07 15:23:00,010 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.CommitProcessor@451] - Configuring CommitProcessor with 8 worker threads.
2024-08-07 15:23:00,010 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.FollowerRequestProcessor@59] - Initialized FollowerRequestProcessor with zookeeper.follower.skipLearnerRequestToNextProcessor as &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
2024-08-07 15:23:00,011 [myid:] - WARN  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.j.MBeanRegistry@110] - Failed to register MBean InMemoryDataTree
2024-08-07 15:23:00,011 [myid:] - WARN  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.LearnerZooKeeperServer@104] - Failed to register with JMX
javax.management.InstanceAlreadyExistsException: org.apache.ZooKeeperService:name0=ReplicatedServer_id3,name1=replica.3,name2=Follower,name3=InMemoryDataTree
	at java.management/com.sun.jmx.mbeanserver.Repository.addMBean(Unknown Source)
	at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerWithRepository(Unknown Source)
	at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(Unknown Source)
	at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(Unknown Source)
	at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(Unknown Source)
	at java.management/com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(Unknown Source)
	at org.apache.zookeeper.jmx.MBeanRegistry.register(MBeanRegistry.java:106)
	at org.apache.zookeeper.server.quorum.LearnerZooKeeperServer.registerJMX(LearnerZooKeeperServer.java:102)
	at org.apache.zookeeper.server.ZooKeeperServer.startupWithServerState(ZooKeeperServer.java:730)
	at org.apache.zookeeper.server.ZooKeeperServer.startupWithoutServing(ZooKeeperServer.java:713)
	at org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:760)
	at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:108)
	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1539)
2024-08-07 15:23:00,012 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.Learner@721] - Learner received UPTODATE message
2024-08-07 15:23:00,013 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.QuorumPeer@917] - Peer state changed: following - broadcast
2024-08-07 15:23:00,015 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.LearnerSessionTracker@116] - Committing global session 0x10000242c8c49bc
2024-08-07 15:23:00,015 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.LearnerSessionTracker@116] - Committing global session 0x10000242c8c49bd
2024-08-07 15:23:00,016 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.LearnerSessionTracker@116] - Committing global session 0x10000242c8c49be
2024-08-07 15:23:00,103 [myid:] - WARN  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.Follower@169] - Got zxid 0x632029b34c expected 0x1
2024-08-07 15:23:00,604 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.LearnerSessionTracker@116] - Committing global session 0x10000242c8c49bf
2024-08-07 15:23:02,202 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.LearnerSessionTracker@116] - Committing global session 0x10000242c8c49c0
2024-08-07 15:23:05,426 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.LearnerSessionTracker@116] - Committing global session 0x200001b71c42ddb
2024-08-07 15:23:05,671 [myid:] - INFO  [NIOWorkerThread-1:o.a.z.s.NIOServerCnxn@522] - Processing ruok command from /127.0.0.1:48192
2024-08-07 15:23:05,671 [myid:] - INFO  [NIOWorkerThread-8:o.a.z.s.NIOServerCnxn@522] - Processing ruok command from /127.0.0.1:48184
2024-08-07 15:23:07,087 [myid:] - WARN  [SyncThread:3:o.a.z.s.p.FileTxnLog@394] - fsync-ing the write ahead log in SyncThread:3 took 7075ms which will adversely effect operation latency.File size is 67108880 bytes. See the ZooKeeper troubleshooting guide
2024-08-07 15:23:10,107 [myid:] - WARN  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.Follower@128] - Exception when following the leader
java.io.EOFException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at java.base/java.io.DataInputStream.readInt(Unknown Source)
	at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:96)
	at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:86)
	at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:134)
	at org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:228)
	at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:124)
	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1539)
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.Follower@142] - Disconnected from leader (with address: zookeeper-1-zookeeper.zookeeper.svc.cluster.local./172.29.203.237:2888). Was connected &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 17136ms. Sync state: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.Follower@286] - shutdown Follower
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.ZooKeeperServer@853] - shutting down
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.RequestThrottler@256] - Shutting down
2024-08-07 15:23:10,108 [myid:] - INFO  [RequestThrottler:o.a.z.s.RequestThrottler@217] - Draining request throttler queue
2024-08-07 15:23:10,108 [myid:] - INFO  [RequestThrottler:o.a.z.s.RequestThrottler@195] - RequestThrottler shutdown. Dropped 0 requests
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.FollowerRequestProcessor@172] - Shutting down
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.q.CommitProcessor@631] - Shutting down
2024-08-07 15:23:10,108 [myid:] - INFO  [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.FinalRequestProcessor@684] - shutdown of request processor complete
2024-08-07 15:23:10,108 [myid:] - INFO  [FollowerRequestProcessor:3:o.a.z.s.q.FollowerRequestProcessor@128] - FollowerRequestProcessor exited loop!
2024-08-07 15:23:10,108 [myid:] - INFO  [CommitProcessor:3:o.a.z.s.q.CommitProcessor@419] - CommitProcessor exited loop!
2024-08-07 15:23:10,191 [myid:] - ERROR [QuorumPeer[myid=3](plain=0.0.0.0:2181)(secure=disabled):o.a.z.s.p.Util@166] - Last transaction was partial.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Resulting state: ephemeral znode held by&#160;10.128.31.11:42544&#160;was correctly removed on zookeeper-0 and zookeeper-1 but lingers on zookeeper-2.&lt;/p&gt;

&lt;p&gt;Env:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2024-08-07 16:18:46,793 [myid:3] - INFO  [main:o.a.z.Environment@98] - Server environment:zookeeper.version=3.8.2-139d619b58292d7734b4fc83a0f44be4e7b0c986, built on 2023-07-05 19:24 UTC
2024-08-07 16:18:46,793 [myid:3] - INFO  [main:o.a.z.Environment@98] - Server environment:host.name=zookeeper-2.zookeeper.zookeeper.svc.cluster.local
2024-08-07 16:18:46,794 [myid:3] - INFO  [main:o.a.z.Environment@98] - Server environment:java.version=11.0.20.1
2024-08-07 16:18:46,794 [myid:3] - INFO  [main:o.a.z.Environment@98] - Server environment:java.vendor=Eclipse Adoptium
2024-08-07 16:18:46,794 [myid:3] - INFO  [main:o.a.z.Environment@98] - Server environment:java.home=/opt/java/openjdk
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13616749">ZOOKEEPER-4925</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13510604">ZOOKEEPER-4643</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13154018">ZOOKEEPER-3023</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13510811">ZOOKEEPER-4646</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13444408">ZOOKEEPER-4541</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vpi0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>