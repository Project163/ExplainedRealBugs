<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3698] NoRouteToHostException when starting large ZooKeeper cluster on localhost</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3698</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;During testing RC for 3.6.0, we found that ZooKeeper cluster with large number of ensemble members (e.g. 23) can not start properly. We see a lot of warnings in the log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-01-15 20:02:13,431 [myid:13] - WARN
 [ListenerHandler-phunt-MBP13.local/192.168.1.91:4193:QuorumCnxManager@691]
- None of the addresses (/192.168.1.91:4190) are reachable &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sid 10
java.net.NoRouteToHostException: No valid address among [/192.168.1.91:4190]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;and also:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-01-17 11:02:26,177 [myid:4] - WARN &#160;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2531:QuorumCnxManager$SendWorker@1269] - destination address /127.0.0.1&#160;not reachable anymore, shutting down the SendWorker &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sid 6
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The exceptions are happening when the new MultiAddress feature tries to filter the unreachable hosts from the address list. This involves the calling of the InetAddress.isReachable method with a default timeout of 500ms, which goes down to a native call in java and basically try to do a ping (an&#160;ICMP echo request) to the host. Naturally, the localhost should be always reachable. For some reason, this call gets failed (timeouted or simly refused) on mac if we have many ensemble members. I tested with 9 members and the cluster started properly. With 11-13-15 members it took more and more time to get the cluster to start, and the &quot;NoRouteToHostException&quot; started to appear in the logs. After around 1 minute the 15 ensemble members cluster started, but obviously this is not good this way. (I also tried with JDK 11 but the I found the same behaviour)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;On linux, I haven&apos;t been able to reproduce the problem. I tried with 5, 9, 15 and 23 ensemble members and the quorum always seems to start properly in a few seconds. (I used OpenJDK 1.8.232 on Ubuntu 18.04)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Update&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;On mac, we we have the ICMP rate limit set to 250 by default. You can turn this off using the following command: sudo sysctl -w net.inet.icmp.icmplim=0&lt;br/&gt;
 (see &lt;a href=&quot;https://krypted.com/mac-os-x/disable-icmp-rate-limiting-os-x/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://krypted.com/mac-os-x/disable-icmp-rate-limiting-os-x/&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Using the above command before starting the 23 ensemble members cluster locally seems to solve the problem for me. (can someone verify?) The question is if this workaround is enough or not.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the current code will generate &lt;tt&gt;2*A*(M-1)&lt;/tt&gt;&#160;ICMP calls in each ZooKeeper server during startup, if &lt;tt&gt;&apos;M&apos;&lt;/tt&gt;&#160;is the number of ensemble members and &lt;tt&gt;&apos;A&apos;&lt;/tt&gt;&#160;is the number of election addresses provided for each member. This is not that high, if each ZooKeeper server is started on a different machine, but if we start a lot of ZooKeeper servers on a single machine, then it can quickly go beyond the predefined limit of 250 for mac.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13280106">ZOOKEEPER-3698</key>
            <summary>NoRouteToHostException when starting large ZooKeeper cluster on localhost</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="symat">Mate Szalay-Beko</assignee>
                                    <reporter username="symat">Mate Szalay-Beko</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 17 Jan 2020 10:15:03 +0000</created>
                <updated>Sun, 28 Mar 2021 08:55:08 +0000</updated>
                            <resolved>Thu, 23 Jan 2020 12:44:13 +0000</resolved>
                                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="17018611" author="eolivelli" created="Sat, 18 Jan 2020 15:14:25 +0000"  >&lt;p&gt;In my opinion we could address this issue working on the following items:&lt;br/&gt;
1) do not use a &quot;parallelStream&quot; to perform the reachability test (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/9053f7c431bb17ed79c2be129b6ba4ba18d15ab1/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/MultipleAddresses.java#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/9053f7c431bb17ed79c2be129b6ba4ba18d15ab1/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/MultipleAddresses.java#L124&lt;/a&gt;)&lt;br/&gt;
2) make the timeout configurable, and maybe default to 1second  (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/9053f7c431bb17ed79c2be129b6ba4ba18d15ab1/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/MultipleAddresses.java#L43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/9053f7c431bb17ed79c2be129b6ba4ba18d15ab1/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/MultipleAddresses.java#L43&lt;/a&gt;)&lt;br/&gt;
3) make che reachabilty test configurabile, in a way the it is not done by default&lt;br/&gt;
4) do not make the reachability test in case of ONE single address (this will make the behaviour similar to 3.5 in case of one single address per server, that is the very common configuration)&lt;/p&gt;

&lt;p&gt;I would go for 3 and/or 4 this new reachability test adds new burden to the system and by default if you have only a single route to the other peer it is not needed, our code is already handling the case of connection failure.&lt;/p&gt;

</comment>
                            <comment id="17018688" author="eolivelli" created="Sat, 18 Jan 2020 19:18:55 +0000"  >&lt;p&gt;Thinking a bit more....parallelStream() in this case is not the problem, we have only 1 address per peer, so parallelStream is not doing something special, it is using only one thread&lt;/p&gt;</comment>
                            <comment id="17019297" author="symat" created="Mon, 20 Jan 2020 08:31:19 +0000"  >&lt;p&gt;I can agree with 3) and 4).&lt;/p&gt;

&lt;p&gt;Regarding 3) I will add to the documentation, that disabling the reachability check will cause the cluster not to be able to reconfigure itself properly during network problems, so the disabling is useful only during testing. For the same reason I would keep it enabled by default. (of course, if there is only a single address, then it should be disabled, as you proposed in 4) )&lt;/p&gt;

&lt;p&gt;Also I don&apos;t think 1), the parallel stream would be an issue here.&lt;/p&gt;

&lt;p&gt;Regarding 2) I think it won&apos;t hurt, but won&apos;t really help either. I tested it by raising the hardcoded timeout value up to 5 sec, and it didn&apos;t solve the problem. (My hypothesis is that the ICMP calls might fail quickly on mac, not waiting / retrying during the timeout period.) Still, being able to fine-tune this parameter might be a good idea on production environment. I also agree with the slightly higher default value of 1 sec. Exactly because of the parallel stream, we should get back the address from the list with the quickest ping time.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17022047" author="andorm" created="Thu, 23 Jan 2020 12:44:13 +0000"  >&lt;p&gt;Issue resolved by pull request 1228&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1228&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13291930">ZOOKEEPER-3758</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0am3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>