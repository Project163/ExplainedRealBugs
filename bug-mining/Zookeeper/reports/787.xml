<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:59:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2383] Startup race in ZooKeeperServer</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2383</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In attempting to upgrade Solr&apos;s ZooKeeper dependency from 3.4.6 to 3.4.8 (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8724&quot; title=&quot;Upgrade Zookeeper to 3.4.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8724&quot;&gt;&lt;del&gt;SOLR-8724&lt;/del&gt;&lt;/a&gt;) I ran into test failures where attempts to create a node in a newly started standalone ZooKeeperServer were failing because of an assertion in MBeanRegistry.&lt;/p&gt;

&lt;p&gt;ZooKeeperServer.startup() first sets up its request processor chain then registers itself in JMX, but if a connection comes in before the server&apos;s JMX registration happens, registration of the connection will fail because it trips the assertion that (effectively) its parent (the server) has already registered itself.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;ZooKeeperServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void startup() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sessionTracker == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            createSessionTracker();
        }
        startSessionTracker();
        setupRequestProcessors();

        registerJMX();

        state = State.RUNNING;
        notifyAll();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;MBeanRegistry.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void register(ZKMBeanInfo bean, ZKMBeanInfo parent)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMException
    {
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; bean != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (parent != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            path = mapBean2Path.get(parent);
            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; path != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This problem appears to be new with ZK 3.4.8 - AFAIK Solr never had this issue with ZK 3.4.6. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12948074">ZOOKEEPER-2383</key>
            <summary>Startup race in ZooKeeperServer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh Radhakrishnan</assignee>
                                    <reporter username="sarowe">Steven Rowe</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Mar 2016 17:00:14 +0000</created>
                <updated>Fri, 31 Mar 2017 09:01:14 +0000</updated>
                            <resolved>Tue, 3 Jan 2017 17:54:19 +0000</resolved>
                                    <version>3.4.8</version>
                                    <fixVersion>3.4.10</fixVersion>
                    <fixVersion>3.5.3</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>jmx</component>
                    <component>server</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="15185285" author="steve_rowe" created="Tue, 8 Mar 2016 17:17:11 +0000"  >&lt;p&gt;This program triggers the problem for me roughly 10% of the time with ZK 3.4.8 - note that if I don&apos;t use a thread to start ZooKeeperServer, the connection always comes in after the server has had a chance to register itself with JMX (imports omitted - attaching full file here in a sec): &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TestZkStandaloneJMXRegistrationRaceConcurrent.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestZkStandaloneJMXRegistrationRaceConcurrent {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException, KeeperException {
    &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ServerThread &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ZooKeeperServer server;
      &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ServerCnxnFactory cnxnFactory;
      @Override &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          File tempDir = Files.createTempDirectory(FileSystems.getDefault().getPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt;),&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;).toFile();
          FileTxnSnapLog txnSnapLog = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileTxnSnapLog(tempDir, tempDir);
          server = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeperServer
            (txnSnapLog, 2000, 2000, 4000, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZKDatabase(txnSnapLog));
          cnxnFactory = ServerCnxnFactory.createFactory(55555, -1);
          cnxnFactory.startup(server);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) { 
          &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
        }
      }
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shutdown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {
        cnxnFactory.shutdown();
        cnxnFactory.join();
        server.shutdown();
      }
    }
    ServerThread serverThread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServerThread();
    serverThread.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    serverThread.start();
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(3);
    ZooKeeper zk = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeper(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1:55555&quot;&lt;/span&gt;, 45000, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Watcher() {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(WatchedEvent event) {} });
    zk.create(&lt;span class=&quot;code-quote&quot;&gt;&quot;/testing123&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]{}, Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
    serverThread.shutdown();
    serverThread.join();
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s an excerpt from a log exhibiting the failure - I&apos;ll also attach the full log (I&apos;ve added some logging to ZK 3.4.8 - I&apos;ll attach a patch showing those additions here in a minute):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-03-08 11:32:08,414 [myid:] - WARN  [SyncThread:0:MBeanRegistry@100] - bean &apos;Connections/127.0.0.1/0x153571244a70000&apos; with parent &apos;StandaloneServer_port55555&apos; has null path.
java.lang.Throwable: 
	at org.apache.zookeeper.jmx.MBeanRegistry.register(MBeanRegistry.java:98)
	at org.apache.zookeeper.server.ServerCnxnFactory.registerConnection(ServerCnxnFactory.java:147)
	at org.apache.zookeeper.server.ZooKeeperServer.finishSessionInit(ZooKeeperServer.java:613)
	at org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:181)
	at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:200)
	at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:131)
2016-03-08 11:32:08,414 [myid:] - WARN  [Thread-0:MBeanRegistry@118] - registered bean &apos;StandaloneServer_port55555&apos; with parent &apos;null&apos; at path &apos;/&apos;
java.lang.Throwable: 
	at org.apache.zookeeper.jmx.MBeanRegistry.register(MBeanRegistry.java:116)
	at org.apache.zookeeper.server.ZooKeeperServer.registerJMX(ZooKeeperServer.java:385)
	at org.apache.zookeeper.server.ZooKeeperServer.startup(ZooKeeperServer.java:418)
	at org.apache.zookeeper.server.NIOServerCnxnFactory.startup(NIOServerCnxnFactory.java:119)
	at TestZkStandaloneJMXRegistrationRaceConcurrent$1ServerThread.run(TestZkStandaloneJMXRegistrationRaceConcurrent.java:29)
2016-03-08 11:32:08,415 [myid:] - ERROR [SyncThread:0:ZooKeeperCriticalThread@49] - Severe unrecoverable error, from thread : SyncThread:0
java.lang.AssertionError
	at org.apache.zookeeper.jmx.MBeanRegistry.register(MBeanRegistry.java:104)
	at org.apache.zookeeper.server.ServerCnxnFactory.registerConnection(ServerCnxnFactory.java:147)
	at org.apache.zookeeper.server.ZooKeeperServer.finishSessionInit(ZooKeeperServer.java:613)
	at org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:181)
	at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:200)
	at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:131)
2016-03-08 11:32:08,416 [myid:] - WARN  [Thread-0:MBeanRegistry@118] - registered bean &apos;InMemoryDataTree&apos; with parent &apos;StandaloneServer_port55555&apos; at path &apos;/StandaloneServer_port55555&apos;
java.lang.Throwable: 
	at org.apache.zookeeper.jmx.MBeanRegistry.register(MBeanRegistry.java:116)
	at org.apache.zookeeper.server.ZooKeeperServer.registerJMX(ZooKeeperServer.java:389)
	at org.apache.zookeeper.server.ZooKeeperServer.startup(ZooKeeperServer.java:418)
	at org.apache.zookeeper.server.NIOServerCnxnFactory.startup(NIOServerCnxnFactory.java:119)
	at TestZkStandaloneJMXRegistrationRaceConcurrent$1ServerThread.run(TestZkStandaloneJMXRegistrationRaceConcurrent.java:29)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15185299" author="steve_rowe" created="Tue, 8 Mar 2016 17:24:00 +0000"  >&lt;p&gt;Attaching files:&lt;/p&gt;

&lt;p&gt;Test case: TestZkStandaloneJMXRegistrationRaceConcurrent.java&lt;br/&gt;
ZK 3.4.8 source patch to add JXM logging: release-3.4.8-extra-logging.patch&lt;br/&gt;
Log file exhibiting failure: zk-3.4.8-MBeanRegistry.log&lt;/p&gt;</comment>
                            <comment id="15185305" author="steve_rowe" created="Tue, 8 Mar 2016 17:27:42 +0000"  >&lt;p&gt;Sometimes the attached test case will trigger a NullPointerException in ZooKeeperServer.createSession() - see attached zk-3.4.8-NPE.log.  For some reason I never saw this failure mode in Solr tests using ZK 3.4.8.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-03-08 11:29:00,374 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:55555:NIOServerCnxnFactory@213] - Ignoring unexpected runtime e
xception
java.lang.NullPointerException
        at org.apache.zookeeper.server.ZooKeeperServer.createSession(ZooKeeperServer.java:569)
        at org.apache.zookeeper.server.ZooKeeperServer.processConnectRequest(ZooKeeperServer.java:902)
        at org.apache.zookeeper.server.NIOServerCnxn.readConnectRequest(NIOServerCnxn.java:418)
        at org.apache.zookeeper.server.NIOServerCnxn.readPayload(NIOServerCnxn.java:198)
        at org.apache.zookeeper.server.NIOServerCnxn.doIO(NIOServerCnxn.java:244)
        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:203)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="15185323" author="fpj" created="Tue, 8 Mar 2016 17:38:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; Thanks for reporting this issue. According to git blame, the latest changes around the startup method in ZooKeeperServer are due to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt;, which actually turned out to be quite problematic, so this could be another issue due to that patch, I&apos;m not sure.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;91f579e4 src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Hongchao Deng          2015-08-17 20:52:07 +0000  411)     public synchronized void startup() {
55b03fce src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Mahadev Konar          2012-01-31 06:50:06 +0000  412)         if (sessionTracker == null) {
55b03fce src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Mahadev Konar          2012-01-31 06:50:06 +0000  413)             createSessionTracker();
55b03fce src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Mahadev Konar          2012-01-31 06:50:06 +0000  414)         }
55b03fce src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Mahadev Konar          2012-01-31 06:50:06 +0000  415)         startSessionTracker();
097b7979 zookeeper/java/src/com/yahoo/zookeeper/server/ZooKeeperServer.java (Benjamin Reed          2008-05-12 23:01:25 +0000  416)         setupRequestProcessors();
87e1e030 src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Patrick D. Hunt        2009-01-15 22:57:14 +0000  417) 
87e1e030 src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Patrick D. Hunt        2009-01-15 22:57:14 +0000  418)         registerJMX();
87e1e030 src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Patrick D. Hunt        2009-01-15 22:57:14 +0000  419) 
91f579e4 src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Hongchao Deng          2015-08-17 20:52:07 +0000  420)         state = State.RUNNING;
91f579e4 src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java     (Hongchao Deng          2015-08-17 20:52:07 +0000  421)         notifyAll();
097b7979 zookeeper/java/src/com/yahoo/zookeeper/server/ZooKeeperServer.java (Benjamin Reed          2008-05-12 23:01:25 +0000  422)     }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;commit 91f579e40755de870ed9123c8fd55925517d9aa6
Author: Hongchao Deng &amp;lt;hdeng@apache.org&amp;gt;
Date:   Mon Aug 17 20:52:07 2015 +0000

    ZOOKEEPER-1907 Improve Thread handling (Rakesh R via hdeng)
    
    git-svn-id: https://svn.apache.org/repos/asf/zookeeper/branches/branch-3.4@1696337 13f79535-47bb-0310-9956-ffa450edef68
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; could you have a look, please?&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15185412" author="steve_rowe" created="Tue, 8 Mar 2016 18:19:58 +0000"  >&lt;p&gt;FWIW, I was able to work around the problem in Solr tests by subclassing ZooKeeperServer and ordering server JMX registration before setting up its request processing pipeline, like so:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestZooKeeperServer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ZooKeeperServer {
    @Override &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void registerJMX() {
      &lt;span class=&quot;code-comment&quot;&gt;// no-op - &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.registerJMX() is called in overridden startup()
&lt;/span&gt;    }
    &lt;span class=&quot;code-comment&quot;&gt;/** Register in JMX before starting the request processors. */&lt;/span&gt;
    @Override &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void startup() {
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.registerJMX();
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.startup();
    }
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TestZooKeeperServer(FileTxnSnapLog txnLogFactory, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; tickTime,
                               &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minSessionTimeout, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxSessionTimeout,
                               DataTreeBuilder treeBuilder, ZKDatabase zkDb) {
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(txnLogFactory, tickTime, minSessionTimeout, maxSessionTimeout, treeBuilder, zkDb);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15185740" author="steve_rowe" created="Tue, 8 Mar 2016 20:37:00 +0000"  >&lt;p&gt;Similarly to the subclassed ZooKeeperServer above, if I apply the following patch to ZK 3.4.8 and run the attached test case with it, the JMX registration race no longer happens:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java
===================================================================
--- src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java	(revision 1732157)
+++ src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java	(working copy)
@@ -413,10 +413,9 @@
             createSessionTracker();
         }
         startSessionTracker();
+        registerJMX();
         setupRequestProcessors();
 
-        registerJMX();
-
         state = State.RUNNING;
         notifyAll();
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15186556" author="rakeshr" created="Wed, 9 Mar 2016 05:38:52 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; for reporting this issue and good analysis.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;According to git blame, the latest changes around the startup method in ZooKeeperServer are due to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt;, which actually turned out to be quite problematic, so this could be another issue due to that patch, I&apos;m not sure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, sure I&apos;m happy to investigate this. To understand the impact of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt;, first I took the code before &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt; commit version &lt;tt&gt;da3e7e0d4b66ac5a25d40ae2d0102b1b57994b62&lt;/tt&gt;. I&apos;ve debugged the code and able to re-produce the issue even without &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt; changes.&lt;/p&gt;

&lt;p&gt;Coming back to the issues reported in this jira, there are two issues. IIUC, both the cases are due to the race between server startup and processing a client connection request. I&apos;ve tried an attempt to figure it out, please see the below sequence that creating the trouble.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;NullPointerException while creating session
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-03-08 11:29:00,374 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:55555:NIOServerCnxnFactory@213] - Ignoring unexpected runtime exception
java.lang.NullPointerException
	at org.apache.zookeeper.server.ZooKeeperServer.createSession(ZooKeeperServer.java:569)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;ins&gt;Thread-1: Starting the server&lt;/ins&gt;&lt;br/&gt;
1=&amp;gt; Invoked cnxnFactory.startup(server);&lt;br/&gt;
2=&amp;gt; Started NIOServerCxn.Factory thread and register OP_ACCEPT to accept connections&lt;br/&gt;
3=&amp;gt; sets zookeeper server to the connection factory&lt;br/&gt;
4=&amp;gt; loads zookeeper data&lt;br/&gt;
5=&amp;gt; Assume server is about to invoke &lt;tt&gt;zks.startup();&lt;/tt&gt; and &lt;tt&gt;sessionTracker&lt;/tt&gt; is not yet initialized.&lt;br/&gt;
&lt;ins&gt;Thread-2: creating client connection&lt;/ins&gt;&lt;br/&gt;
1=&amp;gt; sends connection request to the server&lt;br/&gt;
2=&amp;gt; NIOServerCnxn reads the request and invokes &lt;tt&gt;NIOServerCnxn#readConnectRequest()&lt;/tt&gt;&lt;br/&gt;
3=&amp;gt; It then calls &lt;tt&gt;zkServer.processConnectRequest(this, incomingBuffer);&lt;/tt&gt;&lt;br/&gt;
4=&amp;gt; While processing the request it needs &lt;tt&gt;sessionTracker&lt;/tt&gt; reference, but this is not yet initialized and the server is still in the startup phase causing the NPE error.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;MBeanRegistry throws assertion error due to parent doesn&apos;t exists
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-03-08 11:29:00,449 [myid:] - WARN  [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-0:MBeanRegistry@118] - registered bean &lt;span class=&quot;code-quote&quot;&gt;&apos;InMemoryDataTree&apos;&lt;/span&gt; with parent &lt;span class=&quot;code-quote&quot;&gt;&apos;StandaloneServer_port55555&apos;&lt;/span&gt; at path &lt;span class=&quot;code-quote&quot;&gt;&apos;/StandaloneServer_port55555&apos;&lt;/span&gt;
java.lang.Throwable: 
	at org.apache.zookeeper.jmx.MBeanRegistry.register(MBeanRegistry.java:116)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;ins&gt;Thread-1: Starting the server&lt;/ins&gt;&lt;br/&gt;
1=&amp;gt; Invoked cnxnFactory.startup(server);&lt;br/&gt;
2=&amp;gt; Started NIOServerCxn.Factory thread and register OP_ACCEPT to accept connections&lt;br/&gt;
3=&amp;gt; sets zookeeper server to the connection factory&lt;br/&gt;
4=&amp;gt; loads zookeeper data&lt;br/&gt;
5=&amp;gt; Server invoked &lt;tt&gt;zks.startup();&lt;/tt&gt;&lt;br/&gt;
6=&amp;gt; Started session tracker&lt;br/&gt;
7=&amp;gt; Finished settingup RequestProcessors&lt;br/&gt;
8=&amp;gt; Invoked &lt;tt&gt;ZooKeeperServer#registerJMX();&lt;/tt&gt;&lt;br/&gt;
9=&amp;gt; Now assume ZooKeeperServer has initialized &lt;tt&gt;jmxServerBean = new ZooKeeperServerBean(this);&lt;/tt&gt; and about to register the bean in the registry &lt;tt&gt;MBeanRegistry.getInstance().register(jmxServerBean, null);&lt;/tt&gt;&lt;br/&gt;
&lt;ins&gt;Thread-2: creating client connection&lt;/ins&gt;&lt;br/&gt;
1=&amp;gt; sends connection request to the server&lt;br/&gt;
2=&amp;gt; NIOServerCnxn reads the request and invokes &lt;tt&gt;NIOServerCnxn#readConnectRequest()&lt;/tt&gt;&lt;br/&gt;
3=&amp;gt; It then calls &lt;tt&gt;zkServer.processConnectRequest(this, incomingBuffer);&lt;/tt&gt;&lt;br/&gt;
4=&amp;gt; Since all the request processors are ready, it successfully creates the session and goes to register the connection bean&lt;br/&gt;
5=&amp;gt; Now, it will invoke &lt;tt&gt;zkServer.finishSessionInit()&lt;/tt&gt;. Here it invokes &lt;tt&gt;serverCnxnFactory.registerConnection(cnxn);&lt;/tt&gt; and hitting the path error.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15189157" author="rakeshr" created="Thu, 10 Mar 2016 11:23:25 +0000"  >&lt;p&gt;I think I found the code changes which results in this bug. Its due to the change in startup sequence - &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2026&quot; title=&quot;Startup order in ServerCnxnFactory-ies is wrong&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2026&quot;&gt;&lt;del&gt;ZOOKEEPER-2026&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Here it just moved up setting &apos;zkServer&apos; reference before starting up the standalone server fully. Internally, this &apos;zkServer&apos; reference is used to see ZooKeeperServer&apos;s running status. In the defect scenario, the standalone server is partially started(by Thread1) and simultaneously client(by Thread2) send a connection request. Since the &apos;zkServer&apos; is not null it proceeds to process the connection request and causing the trouble. Please refer my previous comment to understand the problematic call sequence.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ZooKeeperServer.java

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void readConnectRequest() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zkServer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ZooKeeperServer not running&quot;&lt;/span&gt;);
        }
        zkServer.processConnectRequest(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, incomingBuffer);
        initialized = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Probably should use server RUNNING state instead of &quot;zkServer == null&quot; checks to know the running status. Server is updating the state to RUNNING after starting all the services.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ZooKeeperServer.java

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void startup() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sessionTracker == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            createSessionTracker();
        }
        startSessionTracker();
        setupRequestProcessors();

        registerJMX();

        state = State.RUNNING;
        notifyAll();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15198781" author="jbrosenberg@gmail.com" created="Thu, 17 Mar 2016 05:39:19 +0000"  >&lt;p&gt;I&apos;ve run into similar issues, with the register call causing an AssertionError, which is not caught anywhere, which results in test failures (especially if you have multiple QuorumPeers running in the same jvm during tests).  JMX registration gets confused if you have individual nodes starting and stopping.   (Asserts are only enabled for us during testing/ci, so it doesn&apos;t affect production).&lt;br/&gt;
I worked around it be calling &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;MBeanRegistry.setInstance(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FakeMBeanRegistry())&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.  Where &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FakeMBeanRegistry&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FakeMBeanRegistry &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; MBeanRegistry {
    @Override &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void register(ZKMBeanInfo bean, ZKMBeanInfo parent) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; JMException {}
    @Override &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void unregister(ZKMBeanInfo bean) {}
    @Override &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void unregisterAll() {}
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe there should be a flag to disable all JMX registrations (e.g. for most tests), and it could be handled with something like this fake class.&lt;/p&gt;</comment>
                            <comment id="15206169" author="rakeshr" created="Tue, 22 Mar 2016 11:02:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbrosenberg%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;jbrosenberg@gmail.com&quot;&gt;jbrosenberg@gmail.com&lt;/a&gt;. Disbaling or mocking may affect the &lt;tt&gt;org.apache.zookeeper.testJMXEnv#ensureAll(expectednames)&lt;/tt&gt; verification, isn&apos;t it?. In unit tests, it verifies all the registered jmx beans to ensure that the server is started fully.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, I have one idea to fix this issue by modifying the condition &lt;tt&gt;zkServer == null&lt;/tt&gt; with &lt;tt&gt;zkServer.isRunning()&lt;/tt&gt; status check. After seeing the code changes, I feel to push this logic carefully after 3.5.2 release, which is waiting to be released soon. Also, I think needs to identify and add more unit test cases covering server startup/shutdown/restart corner cases in order to push this change. Now, I&apos;m planning to revert &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2026&quot; title=&quot;Startup order in ServerCnxnFactory-ies is wrong&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2026&quot;&gt;&lt;del&gt;ZOOKEEPER-2026&lt;/del&gt;&lt;/a&gt; committed changes and re-open the jira. Does this makes sense to you?&lt;/p&gt;</comment>
                            <comment id="15206310" author="jbrosenberg@gmail.com" created="Tue, 22 Mar 2016 13:05:46 +0000"  >&lt;p&gt;Yes, agreed, you wouldn&apos;t use a FakeMBeanRegistry for tests that are actually testing the jmx functionality!&lt;br/&gt;
However, I think it makes sense to have it be something easily configurable/settable for most tests (and especially for tests which launch multiple peers in the same jvm).&lt;/p&gt;</comment>
                            <comment id="15391420" author="ozawa" created="Mon, 25 Jul 2016 06:38:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; hi Rakesh, how is the progress of this issue?&lt;/p&gt;</comment>
                            <comment id="15391428" author="rakeshr" created="Mon, 25 Jul 2016 06:53:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ozawa&quot; class=&quot;user-hover&quot; rel=&quot;ozawa&quot;&gt;ozawa&lt;/a&gt;, thanks for the interest. I was busy with other things and will give priority to this issue. I will update patch soon. I&apos;m planning to include this in 3.4.9 release and please see the &lt;a href=&quot;http://goo.gl/SJJhbx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.4.9 release discussion&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15391877" author="rakeshr" created="Mon, 25 Jul 2016 13:23:09 +0000"  >&lt;p&gt;Attached initial patch where I&apos;ve used &lt;tt&gt;zkServer.isRunning()&lt;/tt&gt; status to check whether the server is up and running. Appreciate your help in reviews. Thanks!&lt;/p&gt;</comment>
                            <comment id="15392021" author="rakeshr" created="Mon, 25 Jul 2016 14:45:26 +0000"  >&lt;p&gt;fyi: The patch got a green &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3284/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build_3284&lt;/a&gt; , unfortunately there is a &lt;tt&gt;Permission denied&lt;/tt&gt; issue in the build and due to that its not commenting to the jira. Anyone has idea about this problem?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[exec] /home/jenkins/jenkins-slave/workspace/PreCommit-ZOOKEEPER-Build/trunk/src/java/test/bin/test-patch.sh: line 558: /home/jenkins/tools/jiracli/latest/jira: Permission denied
     [exec] /home/jenkins/jenkins-slave/workspace/PreCommit-ZOOKEEPER-Build/trunk/src/java/test/bin/test-patch.sh: line 559: /home/jenkins/tools/jiracli/latest/jira: Permission denied
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15396992" author="hadoopqa" created="Thu, 28 Jul 2016 05:56:09 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12819926/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12819926/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1754188.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3290//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3290//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3290//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3290//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3290//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3290//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15399042" author="suda" created="Fri, 29 Jul 2016 09:40:32 +0000"  >&lt;p&gt;+1 (non-binding).&lt;/p&gt;

&lt;p&gt;Locally tested ZooKeeperServerStartupTest 300 times and it passed.&lt;/p&gt;</comment>
                            <comment id="15399613" author="rakeshr" created="Fri, 29 Jul 2016 16:26:59 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=suda&quot; class=&quot;user-hover&quot; rel=&quot;suda&quot;&gt;suda&lt;/a&gt; for the feedback.&lt;/p&gt;</comment>
                            <comment id="15399680" author="steve_rowe" created="Fri, 29 Jul 2016 17:01:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, looks like your patch is against trunk - if you make a branch-3.4 version of the patch, I&apos;ll run Solr&apos;s tests using a build off that branch (I&apos;m assuming the next Solr ZK dep version will be 3.4.9).&lt;/p&gt;</comment>
                            <comment id="15399783" author="rakeshr" created="Fri, 29 Jul 2016 18:07:31 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt;. I&apos;m attaching another patch based on br-3.4, would be great to see your feedback on this.&lt;/p&gt;

&lt;p&gt;Note: Jenkins will pick this &lt;tt&gt;ZK-2383-br-3-4&lt;/tt&gt; patch and will fail while applying against trunk code, please ignore it.&lt;/p&gt;</comment>
                            <comment id="15399789" author="hadoopqa" created="Fri, 29 Jul 2016 18:09:26 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12821043/ZOOKEEPER-2383-br-3-4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12821043/ZOOKEEPER-2383-br-3-4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1754188.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3310//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3310//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15408727" author="steve_rowe" created="Fri, 5 Aug 2016 01:08:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, I patched branch-3.4 at revision 1754563 with your &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;-br-3-4.patch&lt;/tt&gt;, applied my &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-8724&quot; title=&quot;Upgrade Zookeeper to 3.4.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SOLR-8724&quot;&gt;&lt;del&gt;SOLR-8724&lt;/del&gt;&lt;/a&gt; patch with a small change to account for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2141&quot; title=&quot;ACL cache in DataTree never removes entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2141&quot;&gt;&lt;del&gt;ZOOKEEPER-2141&lt;/del&gt;&lt;/a&gt;, and changed the depended-on ZK version from 3.4.8 to 3.4.9-SNAPSHOT (the version built off branch-3.4 with your patch), and Solr tests pass, so +1 from me to include your patch in the 3.4.9 release.&lt;/p&gt;</comment>
                            <comment id="15408810" author="rakeshr" created="Fri, 5 Aug 2016 03:19:08 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; for the feedback. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, do you have some cycles to review this. Thanks!&lt;/p&gt;</comment>
                            <comment id="15408826" author="rgs" created="Fri, 5 Aug 2016 03:48:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;: looks good to me, one nit though. In testClientConnectionRequestDuringStartup:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        CountdownWatcher watcher = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountdownWatcher();
+        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZooKeeper(HOSTPORT, ClientBase.CONNECTION_TIMEOUT, watcher);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;lets assign the ZooKeeper object to a var and explicitly clean it up when done. Other than that, +1.&lt;/p&gt;

&lt;p&gt;Happy to merge it after that. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15408906" author="rakeshr" created="Fri, 5 Aug 2016 05:35:12 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;. Attached new patch addressing the comments.&lt;/p&gt;</comment>
                            <comment id="15408930" author="hadoopqa" created="Fri, 5 Aug 2016 05:59:39 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822237/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822237/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755100.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3324//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3324//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3324//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3324//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3324//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3324//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15409316" author="hadoopqa" created="Fri, 5 Aug 2016 10:57:06 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822237/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822237/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755100.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3325//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3325//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3325//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3325//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3325//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3325//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15409640" author="hanm" created="Fri, 5 Aug 2016 16:14:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;-br-3-4.patch may also be updated with this fix as well.&lt;/p&gt;</comment>
                            <comment id="15409673" author="hanm" created="Fri, 5 Aug 2016 16:30:36 +0000"  >&lt;p&gt;One small suggestion - the condition of &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; zkServer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !zkServer.isRunning() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; could be refactored into a dedicated method such as &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isZKServerRunning(ZooKeeperServer zkServer) { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; zkServer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; zkServer.isRunning(); }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;, which centralized such logic and make it reusable later. We could put it in Command.java or ZKUtil.java maybe?&lt;/p&gt;</comment>
                            <comment id="15409828" author="rakeshr" created="Fri, 5 Aug 2016 18:08:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; for the reviews. It looks like &lt;tt&gt;ZKUtil.java&lt;/tt&gt; has ZooKeeper client related operations. Attached new patch, where I&apos;ve tried keeping &lt;tt&gt;isZKServerRunning()&lt;/tt&gt; in &lt;tt&gt;AbstractFourLetterCommand.java&lt;/tt&gt;. Does this sound good to you?&lt;/p&gt;</comment>
                            <comment id="15409886" author="hadoopqa" created="Fri, 5 Aug 2016 18:39:16 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822349/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822349/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755100.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3327//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3327//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3327//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3327//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3327//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3327//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15409917" author="hanm" created="Fri, 5 Aug 2016 19:10:04 +0000"  >&lt;p&gt;Thanks Rakesh for quick reply - looks good to me.&lt;/p&gt;</comment>
                            <comment id="15410424" author="hadoopqa" created="Sat, 6 Aug 2016 03:18:29 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822349/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822349/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755379.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3328//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3328//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3328//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3328//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3328//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3328//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15410820" author="rakeshr" created="Sun, 7 Aug 2016 04:17:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, would you take another look at the latest patch and help me pushing this in. Thanks!&lt;/p&gt;</comment>
                            <comment id="15420205" author="phunt" created="Sun, 14 Aug 2016 04:11:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; possible for you take another look?&lt;/p&gt;</comment>
                            <comment id="15422902" author="rakeshr" created="Tue, 16 Aug 2016 15:38:28 +0000"  >&lt;p&gt;I am moving this out to 3.4.10 for now. Please feel free to discuss the target version, Thanks!&lt;/p&gt;</comment>
                            <comment id="15470882" author="rakeshr" created="Wed, 7 Sep 2016 15:13:22 +0000"  >&lt;p&gt;I&apos;ve got +1(non-binding) from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_rowe&quot; class=&quot;user-hover&quot; rel=&quot;steve_rowe&quot;&gt;steve_rowe&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, do you have some cycles to review the proposed patch considering the bug priority. Thanks!&lt;/p&gt;</comment>
                            <comment id="15499075" author="fpj" created="Sat, 17 Sep 2016 13:57:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; I have checked the 3.4 patch. In &lt;tt&gt;NettyServerCnxn&lt;/tt&gt;, it looks like we are only updating the code for 4lws. Don&apos;t we have to also update it here:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                        if (zks == null) {
                            throw new IOException(&quot;ZK down&quot;);
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is in {{NettyServerCnxn.receiveMessage}.&lt;/p&gt;

&lt;p&gt;About the test case:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;I ran it with and without the changes. With the changes, it works fine. Without the changes, it hangs forever. I noticed in the logs that it gets:&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Since zk server is not started createsession method to be invoked
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but it never exists as the client keeps trying to connect. It sounds like some thread is hanging and not letting the test framework exit.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;This sentence doesn&apos;t make much sense to me: &lt;tt&gt;Since zk server is not started createsession method to be invoked&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Please reduce the test case timeout to no longer than 30s.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15499350" author="rakeshr" created="Sat, 17 Sep 2016 17:05:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the comments. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In NettyServerCnxn, it looks like we are only updating the code for 4lws. Don&apos;t we have to also update it here:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think, I have handled this case and the following condition present in &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12821043/ZOOKEEPER-2383-br-3-4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;ZOOKEEPER-2383-br-3-4.patch&lt;/a&gt;. Am I missing any other case apart from the below line of code.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@@ -735,7 +735,7 @@
                         bb.flip();
 
                         ZooKeeperServer zks = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zkServer;
-                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zks == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zks == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !zks.isRunning()) {
                             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ZK down&quot;&lt;/span&gt;);
                         }
                         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (initialized) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;but it never exists as the client keeps trying to connect. It sounds like some thread is hanging and not letting the test framework exit.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Without patch it fails at &lt;tt&gt;simplezks.waitForStartupInvocation(10)&lt;/tt&gt;. On the other side &lt;tt&gt;SimpleZooKeeperServer#startup&lt;/tt&gt; thread is waiting at startupDelayLatch.await() and this is causing an indefinite wait. How about adding the countdown logic in finally so that it will proceed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            Assert.assertFalse(
                    &lt;span class=&quot;code-quote&quot;&gt;&quot;Should fail to create zk client session as server is not fully started&quot;&lt;/span&gt;,
                    simplezks.waitForSessionCreation(10));
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            LOG.info(
                    &lt;span class=&quot;code-quote&quot;&gt;&quot;Decrements the count of the latch, so that server will proceed with startup&quot;&lt;/span&gt;);
            startupDelayLatch.countDown();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;This sentence doesn&apos;t make much sense to me: Since zk server is not started createsession method to be invoked&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will modify this to &quot;Should fail to create zk client session as server is not fully started&quot;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Please reduce the test case timeout to no longer than 30s.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed.&lt;/p&gt;

&lt;p&gt;FYI, apart from the above, I had fixed &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383?focusedCommentId=15409673&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15409673&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Michael&apos;s comment&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383?focusedCommentId=15408826&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15408826&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Raul&apos;s comment&lt;/a&gt; in trunk patch, need to rebase branch-3-4 patch to incorporate these comments.&lt;/p&gt;</comment>
                            <comment id="15502828" author="fpj" created="Mon, 19 Sep 2016 09:22:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; the try/finally suggestion sounds good.&lt;/p&gt;

&lt;p&gt;I have a couple more comments that I&apos;m not sure we can address, but I have have them written down at least:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It sounds like you have covered all necessary &lt;tt&gt;zkServer == null&lt;/tt&gt; cases, but I&apos;m concerned we might have missed any, I&apos;m not sure there is a way of guaranteeing and the only course of action is visual inspection. It&apos;d be much better if we could sort out the problem in the startup call instead of relying on the methods accessing the &lt;tt&gt;zkServer&lt;/tt&gt; to check whether the server is running.&lt;br/&gt;
#&#160;The test case isn&apos;t covering the whole modified code. In particular, it is not covering the 4lw changes this patch is making.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15502832" author="fpj" created="Mon, 19 Sep 2016 09:23:57 +0000"  >&lt;p&gt;Actually, what prevents us from doing this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--- a/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java
+++ b/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java
@@ -113,10 +113,10 @@ public void start() {
     @Override
     public void startup(ZooKeeperServer zks) throws IOException,
             InterruptedException {
-        start();
         setZooKeeperServer(zks);
         zks.startdata();
         zks.startup();
+        start();
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Interestingly, the tests pass for me with this change, so if it doesn&apos;t work, then we have at least a test coverage problem.&lt;/p&gt;</comment>
                            <comment id="15507169" author="rakeshr" created="Tue, 20 Sep 2016 17:18:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;The test case isn&apos;t covering the whole modified code. In particular, it is not covering the 4lw changes this patch is making.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, would need to add more test cases covering 4lw and netty server.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Actually, what prevents us from doing this:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Its an interesting thought to view the problem from different angle and frame a simple solution. I could see the following changes will happen if we move #start() at the end.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;If someone sends 4lw command to the server during startup, zk server won&apos;t respond to it and will not print message &lt;tt&gt;&quot;This ZooKeeper instance is not currently serving requests&quot;&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;There is a change in the client and server side logging.&lt;br/&gt;
Before:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-09-20 22:17:33,542 [myid:127.0.0.1:11222] - INFO  [main-SendThread(127.0.0.1:11222):ClientCnxn$SendThread@1113] - Opening socket connection to server 127.0.0.1/127.0.0.1:11222. Will not attempt to authenticate using SASL (unknown error)
2016-09-20 22:17:33,548 [myid:] - INFO  [NIOServerCxnFactory.AcceptThread:0.0.0.0/0.0.0.0:11222:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /127.0.0.1:12510
2016-09-20 22:17:33,548 [myid:127.0.0.1:11222] - INFO  [main-SendThread(127.0.0.1:11222):ClientCnxn$SendThread@948] - Socket connection established, initiating session, client: /127.0.0.1:12510, server: 127.0.0.1/127.0.0.1:11222
2016-09-20 22:17:33,563 [myid:] - WARN  [NIOWorkerThread-1:NIOServerCnxn@369] - Exception causing close of session 0x0: ZooKeeperServer not running
2016-09-20 22:17:33,564 [myid:] - INFO  [NIOWorkerThread-1:NIOServerCnxn@607] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /127.0.0.1:12510 (no session established &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client)
2016-09-20 22:17:33,564 [myid:127.0.0.1:11222] - INFO  [main-SendThread(127.0.0.1:11222):ClientCnxn$SendThread@1231] - Unable to read additional data from server sessionid 0x0, likely server has closed socket, closing socket connection and attempting reconnect
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-09-20 22:14:15,309 [myid:127.0.0.1:11222] - INFO  [main-SendThread(127.0.0.1:11222):ClientCnxn$SendThread@1113] - Opening socket connection to server 127.0.0.1/127.0.0.1:11222. Will not attempt to authenticate using SASL (unknown error)
2016-09-20 22:14:15,312 [myid:127.0.0.1:11222] - INFO  [main-SendThread(127.0.0.1:11222):ClientCnxn$SendThread@948] - Socket connection established, initiating session, client: /127.0.0.1:12418, server: 127.0.0.1/127.0.0.1:11222
2016-09-20 22:14:45,313 [myid:127.0.0.1:11222] - WARN  [main-SendThread(127.0.0.1:11222):ClientCnxn$SendThread@1181] - Client session timed out, have not heard from server in 30001ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid 0x0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Ideally server startup won&apos;t take too much time, only exceptional case is zks#loadData() is too large. I&apos;m not aware about the use case of 4lws during startup, do anyone expect quick output shows server not running rather than connection timeout?&lt;/p&gt;</comment>
                            <comment id="15528370" author="rakeshr" created="Wed, 28 Sep 2016 04:43:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, any thoughts about the above points? Thanks!&lt;/p&gt;</comment>
                            <comment id="15636358" author="rakeshr" created="Fri, 4 Nov 2016 13:40:10 +0000"  >&lt;p&gt;Will this proposed fix induce any other component integration test failures. Would be great to see your view on the above analysis. Thanks!&lt;/p&gt;</comment>
                            <comment id="15636584" author="fpj" created="Fri, 4 Nov 2016 15:00:17 +0000"  >&lt;p&gt;Moving the &lt;tt&gt;start()&lt;/tt&gt; call to the end of the &lt;tt&gt;startup()&lt;/tt&gt; method will cause the change of behavior you point out, that&apos;s correct, we shouldn&apos;t do it.&lt;/p&gt;

&lt;p&gt;Applying the test alone without the other changes still makes the test run forever. We need to fix it.&lt;/p&gt;

&lt;p&gt;There are a few format suggestions I wanted to make, perhaps it is better to have a pull request for this. &lt;/p&gt;</comment>
                            <comment id="15636680" author="rakeshr" created="Fri, 4 Nov 2016 15:25:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;. OK, I&apos;ll modify the test case and create pull request.&lt;/p&gt;</comment>
                            <comment id="15642047" author="githubbot" created="Sun, 6 Nov 2016 16:35:48 +0000"  >&lt;p&gt;GitHub user rakeshadr opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rakeshadr/zookeeper-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rakeshadr/zookeeper-1&lt;/a&gt; ZK-2383&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #101&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 401ce15e7cd1eeb0e8cef367bff53c1054ea17df&lt;br/&gt;
Author: Rakesh Radhakrishnan &amp;lt;rakeshr@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-11-06T16:24:53Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15642057" author="rakeshr" created="Sun, 6 Nov 2016 16:44:03 +0000"  >&lt;p&gt;Attached patch including test cases to verify the changs w.r.t &lt;tt&gt;NIOServerCnxn&lt;/tt&gt;, &lt;tt&gt;NettyServerCnxn&lt;/tt&gt;, &lt;tt&gt;flw commands&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, Created PR &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101&lt;/a&gt;&lt;/tt&gt;, please take  look at this. Thanks!&lt;/p&gt;</comment>
                            <comment id="15642086" author="hadoopqa" created="Sun, 6 Nov 2016 17:06:24 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12837652/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12837652/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision bcb07a09b06c91243ed244f04a71b8daf629e286.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 19 new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3526//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3526//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3526//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3526//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3526//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3526//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15642088" author="hadoopqa" created="Sun, 6 Nov 2016 17:06:53 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12837652/ZOOKEEPER-2383.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12837652/ZOOKEEPER-2383.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision bcb07a09b06c91243ed244f04a71b8daf629e286.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 19 new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3527//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3527//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3527//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3527//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3527//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3527//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15643583" author="hadoopqa" created="Mon, 7 Nov 2016 09:13:33 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/46//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/46//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15724255" author="rakeshr" created="Tue, 6 Dec 2016 04:03:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, would be great to see your feedback on the &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;proposed code changes&lt;/a&gt;, do you have some cycles to review this. Thanks!&lt;/p&gt;</comment>
                            <comment id="15752671" author="githubbot" created="Thu, 15 Dec 2016 22:19:30 +0000"  >&lt;p&gt;Github user fpj commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101#discussion_r92712695&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101#discussion_r92712695&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/ZooKeeperServerStartupTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,266 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.client.FourLetterWordMain.send4LetterWord;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.concurrent.CountDownLatch;&lt;br/&gt;
    +import java.util.concurrent.TimeUnit;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.common.X509Exception.SSLContextException;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +import org.slf4j.Logger;&lt;br/&gt;
    +import org.slf4j.LoggerFactory;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * This class tests the startup behavior of ZooKeeper server.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ZooKeeperServerStartupTest extends ZKTestCase {&lt;br/&gt;
    +    private static final Logger LOG = LoggerFactory&lt;br/&gt;
    +            .getLogger(ZooKeeperServerStartupTest.class);&lt;br/&gt;
    +    private static int PORT = PortAssignment.unique();&lt;br/&gt;
    +    private static String HOST = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +    private static String HOSTPORT = HOST + &quot;:&quot; + PORT;&lt;br/&gt;
    +    private static final String ZK_NOT_SERVING = &quot;This ZooKeeper instance is not currently serving requests&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    private ServerCnxnFactory servcnxnf;&lt;br/&gt;
    +    private ZooKeeperServer zks;&lt;br/&gt;
    +    private File tmpDir;&lt;br/&gt;
    +    private CountDownLatch startupDelayLatch = new CountDownLatch(1);&lt;br/&gt;
    +&lt;br/&gt;
    +    @After&lt;br/&gt;
    +    public void teardown() throws Exception {&lt;br/&gt;
    +        // count down to avoid infinite blocking call due to this latch, if&lt;br/&gt;
    +        // any.&lt;br/&gt;
    +        startupDelayLatch.countDown();&lt;br/&gt;
    +&lt;br/&gt;
    +        if (servcnxnf != null) &lt;/p&gt;
{
    +            servcnxnf.shutdown();
    +        }
&lt;p&gt;    +        if (zks != null) &lt;/p&gt;
{
    +            zks.shutdown();
    +        }
&lt;p&gt;    +        if (zks.getZKDatabase() != null) &lt;/p&gt;
{
    +            zks.getZKDatabase().close();
    +        }
&lt;p&gt;    +        ClientBase.recursiveDelete(tmpDir);&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for&lt;br/&gt;
    +     * &lt;/p&gt;
{@link https://issues.apache.org/jira/browse/ZOOKEEPER-2383}
&lt;p&gt;.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 30000)&lt;br/&gt;
    +    public void testClientConnectionRequestDuringStartupWithNIOServerCnxn()&lt;br/&gt;
    +            throws Exception &lt;/p&gt;
{
    +        tmpDir = ClientBase.createTmpDir();
    +        ClientBase.setupTestEnv();
    +
    +        startSimpleZKServer(startupDelayLatch);
    +        SimpleZooKeeperServer simplezks = (SimpleZooKeeperServer) zks;
    +        Assert.assertTrue(
    +                &quot;Failed to invoke zks#startup() method during server startup&quot;,
    +                simplezks.waitForStartupInvocation(10));
    +
    +        CountdownWatcher watcher = new CountdownWatcher();
    +        ZooKeeper zkClient = new ZooKeeper(HOSTPORT,
    +                ClientBase.CONNECTION_TIMEOUT, watcher);
    +
    +        Assert.assertFalse(
    +                &quot;Since server is not fully started, zks#createSession() shouldn&apos;t be invoked&quot;,
    +                simplezks.waitForSessionCreation(5));
    +
    +        LOG.info(
    +                &quot;Decrements the count of the latch, so that server will proceed with startup&quot;);
    +        startupDelayLatch.countDown();
    +
    +        Assert.assertTrue(&quot;waiting for server being up &quot;, ClientBase
    +                .waitForServerUp(HOSTPORT, ClientBase.CONNECTION_TIMEOUT));
    +
    +        Assert.assertTrue(
    +                &quot;Failed to invoke zks#createSession() method during client session creation&quot;,
    +                simplezks.waitForSessionCreation(5));
    +        watcher.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
    +        zkClient.close();
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for&lt;br/&gt;
    +     * &lt;/p&gt;
{@link https://issues.apache.org/jira/browse/ZOOKEEPER-2383}
&lt;p&gt;.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 30000)&lt;br/&gt;
    +    public void testClientConnectionRequestDuringStartupWithNettyServerCnxn()&lt;br/&gt;
    +            throws Exception {&lt;br/&gt;
    +        tmpDir = ClientBase.createTmpDir();&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +&lt;br/&gt;
    +        String originalServerCnxnFactory = System&lt;br/&gt;
    +                .getProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY);&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY,
    +                    NettyServerCnxnFactory.class.getName());
    +            startSimpleZKServer(startupDelayLatch);
    +            SimpleZooKeeperServer simplezks = (SimpleZooKeeperServer) zks;
    +            Assert.assertTrue(
    +                    &quot;Failed to invoke zks#startup() method during server startup&quot;,
    +                    simplezks.waitForStartupInvocation(10));
    +
    +            CountdownWatcher watcher = new CountdownWatcher();
    +            ZooKeeper zkClient = new ZooKeeper(HOSTPORT,
    +                    ClientBase.CONNECTION_TIMEOUT, watcher);
    +
    +            Assert.assertFalse(
    +                    &quot;Since server is not fully started, zks#createSession() shouldn&apos;t be invoked&quot;,
    +                    simplezks.waitForSessionCreation(5));
    +
    +            LOG.info(
    +                    &quot;Decrements the count of the latch, so that server will proceed with startup&quot;);
    +            startupDelayLatch.countDown();
    +
    +            Assert.assertTrue(&quot;waiting for server being up &quot;, ClientBase
    +                    .waitForServerUp(HOSTPORT, ClientBase.CONNECTION_TIMEOUT));
    +
    +            Assert.assertTrue(
    +                    &quot;Failed to invoke zks#createSession() method during client session creation&quot;,
    +                    simplezks.waitForSessionCreation(5));
    +            watcher.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
    +            zkClient.close();
    +        }
&lt;p&gt; finally {&lt;br/&gt;
    +            // reset cnxn factory&lt;br/&gt;
    +            if (originalServerCnxnFactory == null) &lt;/p&gt;
{
    +                System.clearProperty(
    +                        ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY);
    +                return;
    +            }
&lt;p&gt;    +            System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY,&lt;br/&gt;
    +                    originalServerCnxnFactory);&lt;br/&gt;
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for&lt;br/&gt;
    +     * &lt;/p&gt;
{@link https://issues.apache.org/jira/browse/ZOOKEEPER-2383}
&lt;p&gt;.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 30000)&lt;br/&gt;
    +    public void testFourLetterWords() throws Exception &lt;/p&gt;
{
    +        startSimpleZKServer(startupDelayLatch);
    +        verify(&quot;conf&quot;, ZK_NOT_SERVING);
    +        verify(&quot;crst&quot;, ZK_NOT_SERVING);
    +        verify(&quot;cons&quot;, ZK_NOT_SERVING);
    +        verify(&quot;dirs&quot;, ZK_NOT_SERVING);
    +        verify(&quot;dump&quot;, ZK_NOT_SERVING);
    +        verify(&quot;mntr&quot;, ZK_NOT_SERVING);
    +        verify(&quot;stat&quot;, ZK_NOT_SERVING);
    +        verify(&quot;srst&quot;, ZK_NOT_SERVING);
    +        verify(&quot;wchp&quot;, ZK_NOT_SERVING);
    +        verify(&quot;wchc&quot;, ZK_NOT_SERVING);
    +        verify(&quot;wchs&quot;, ZK_NOT_SERVING);
    +        verify(&quot;isro&quot;, &quot;null&quot;);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private void verify(String cmd, String expected)&lt;br/&gt;
    +            throws IOException, SSLContextException &lt;/p&gt;
{
    +        String resp = sendRequest(cmd);
    +        LOG.info(&quot;cmd &quot; + cmd + &quot; expected &quot; + expected + &quot; got &quot; + resp);
    +        Assert.assertTrue(&quot;Unexpected response&quot;, resp.contains(expected));
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private String sendRequest(String cmd)&lt;br/&gt;
    +            throws IOException, SSLContextException &lt;/p&gt;
{
    +        return send4LetterWord(HOST, PORT, cmd);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private void startSimpleZKServer(CountDownLatch startupDelayLatch)&lt;br/&gt;
    +            throws IOException {&lt;br/&gt;
    +        zks = new SimpleZooKeeperServer(tmpDir, tmpDir, 3000,&lt;br/&gt;
    +                startupDelayLatch);&lt;br/&gt;
    +        SyncRequestProcessor.setSnapCount(100);&lt;br/&gt;
    +        final int PORT = Integer.parseInt(HOSTPORT.split(&quot;:&quot;)&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +        servcnxnf = ServerCnxnFactory.createFactory(PORT, -1);&lt;br/&gt;
    +        Thread startupThread = new Thread() {&lt;br/&gt;
    +            public void run() {&lt;br/&gt;
    +                try &lt;/p&gt;
{
    +                    servcnxnf.startup(zks);
    +                }
&lt;p&gt; catch (IOException | InterruptedException e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We can&apos;t have a multi-catch with Java 6, which is the earliest version we say we support in the docs.&lt;/p&gt;</comment>
                            <comment id="15752679" author="fpj" created="Thu, 15 Dec 2016 22:21:05 +0000"  >&lt;p&gt;There is a compilation issue in the 3.4 branch, I left a comment in the pull request:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;compile-test:
    [mkdir] Created dir: /Users/fpj/code/github/zookeeper/build/test/classes
    [javac] Compiling 145 source files to /Users/fpj/code/github/zookeeper/build/test/classes
    [javac] warning: [options] bootstrap class path not set in conjunction with -source 1.6
    [javac] /Users/fpj/code/github/zookeeper/src/java/test/org/apache/zookeeper/server/ZooKeeperServerStartupTest.java:209: error: multi-catch statement is not supported in -source 1.6
    [javac]                 } catch (IOException | InterruptedException e) {
    [javac]                                      ^
    [javac]   (use -source 7 or higher to enable multi-catch statement)
    [javac] 1 error
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15754024" author="githubbot" created="Fri, 16 Dec 2016 10:16:39 +0000"  >&lt;p&gt;Github user rakeshadr commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101#discussion_r92785304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101#discussion_r92785304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/ZooKeeperServerStartupTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,266 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.client.FourLetterWordMain.send4LetterWord;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.concurrent.CountDownLatch;&lt;br/&gt;
    +import java.util.concurrent.TimeUnit;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.common.X509Exception.SSLContextException;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +import org.slf4j.Logger;&lt;br/&gt;
    +import org.slf4j.LoggerFactory;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * This class tests the startup behavior of ZooKeeper server.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ZooKeeperServerStartupTest extends ZKTestCase {&lt;br/&gt;
    +    private static final Logger LOG = LoggerFactory&lt;br/&gt;
    +            .getLogger(ZooKeeperServerStartupTest.class);&lt;br/&gt;
    +    private static int PORT = PortAssignment.unique();&lt;br/&gt;
    +    private static String HOST = &quot;127.0.0.1&quot;;&lt;br/&gt;
    +    private static String HOSTPORT = HOST + &quot;:&quot; + PORT;&lt;br/&gt;
    +    private static final String ZK_NOT_SERVING = &quot;This ZooKeeper instance is not currently serving requests&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    private ServerCnxnFactory servcnxnf;&lt;br/&gt;
    +    private ZooKeeperServer zks;&lt;br/&gt;
    +    private File tmpDir;&lt;br/&gt;
    +    private CountDownLatch startupDelayLatch = new CountDownLatch(1);&lt;br/&gt;
    +&lt;br/&gt;
    +    @After&lt;br/&gt;
    +    public void teardown() throws Exception {&lt;br/&gt;
    +        // count down to avoid infinite blocking call due to this latch, if&lt;br/&gt;
    +        // any.&lt;br/&gt;
    +        startupDelayLatch.countDown();&lt;br/&gt;
    +&lt;br/&gt;
    +        if (servcnxnf != null) &lt;/p&gt;
{
    +            servcnxnf.shutdown();
    +        }
&lt;p&gt;    +        if (zks != null) &lt;/p&gt;
{
    +            zks.shutdown();
    +        }
&lt;p&gt;    +        if (zks.getZKDatabase() != null) &lt;/p&gt;
{
    +            zks.getZKDatabase().close();
    +        }
&lt;p&gt;    +        ClientBase.recursiveDelete(tmpDir);&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for&lt;br/&gt;
    +     * &lt;/p&gt;
{@link https://issues.apache.org/jira/browse/ZOOKEEPER-2383}
&lt;p&gt;.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 30000)&lt;br/&gt;
    +    public void testClientConnectionRequestDuringStartupWithNIOServerCnxn()&lt;br/&gt;
    +            throws Exception &lt;/p&gt;
{
    +        tmpDir = ClientBase.createTmpDir();
    +        ClientBase.setupTestEnv();
    +
    +        startSimpleZKServer(startupDelayLatch);
    +        SimpleZooKeeperServer simplezks = (SimpleZooKeeperServer) zks;
    +        Assert.assertTrue(
    +                &quot;Failed to invoke zks#startup() method during server startup&quot;,
    +                simplezks.waitForStartupInvocation(10));
    +
    +        CountdownWatcher watcher = new CountdownWatcher();
    +        ZooKeeper zkClient = new ZooKeeper(HOSTPORT,
    +                ClientBase.CONNECTION_TIMEOUT, watcher);
    +
    +        Assert.assertFalse(
    +                &quot;Since server is not fully started, zks#createSession() shouldn&apos;t be invoked&quot;,
    +                simplezks.waitForSessionCreation(5));
    +
    +        LOG.info(
    +                &quot;Decrements the count of the latch, so that server will proceed with startup&quot;);
    +        startupDelayLatch.countDown();
    +
    +        Assert.assertTrue(&quot;waiting for server being up &quot;, ClientBase
    +                .waitForServerUp(HOSTPORT, ClientBase.CONNECTION_TIMEOUT));
    +
    +        Assert.assertTrue(
    +                &quot;Failed to invoke zks#createSession() method during client session creation&quot;,
    +                simplezks.waitForSessionCreation(5));
    +        watcher.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
    +        zkClient.close();
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for&lt;br/&gt;
    +     * &lt;/p&gt;
{@link https://issues.apache.org/jira/browse/ZOOKEEPER-2383}
&lt;p&gt;.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 30000)&lt;br/&gt;
    +    public void testClientConnectionRequestDuringStartupWithNettyServerCnxn()&lt;br/&gt;
    +            throws Exception {&lt;br/&gt;
    +        tmpDir = ClientBase.createTmpDir();&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +&lt;br/&gt;
    +        String originalServerCnxnFactory = System&lt;br/&gt;
    +                .getProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY);&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY,
    +                    NettyServerCnxnFactory.class.getName());
    +            startSimpleZKServer(startupDelayLatch);
    +            SimpleZooKeeperServer simplezks = (SimpleZooKeeperServer) zks;
    +            Assert.assertTrue(
    +                    &quot;Failed to invoke zks#startup() method during server startup&quot;,
    +                    simplezks.waitForStartupInvocation(10));
    +
    +            CountdownWatcher watcher = new CountdownWatcher();
    +            ZooKeeper zkClient = new ZooKeeper(HOSTPORT,
    +                    ClientBase.CONNECTION_TIMEOUT, watcher);
    +
    +            Assert.assertFalse(
    +                    &quot;Since server is not fully started, zks#createSession() shouldn&apos;t be invoked&quot;,
    +                    simplezks.waitForSessionCreation(5));
    +
    +            LOG.info(
    +                    &quot;Decrements the count of the latch, so that server will proceed with startup&quot;);
    +            startupDelayLatch.countDown();
    +
    +            Assert.assertTrue(&quot;waiting for server being up &quot;, ClientBase
    +                    .waitForServerUp(HOSTPORT, ClientBase.CONNECTION_TIMEOUT));
    +
    +            Assert.assertTrue(
    +                    &quot;Failed to invoke zks#createSession() method during client session creation&quot;,
    +                    simplezks.waitForSessionCreation(5));
    +            watcher.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
    +            zkClient.close();
    +        }
&lt;p&gt; finally {&lt;br/&gt;
    +            // reset cnxn factory&lt;br/&gt;
    +            if (originalServerCnxnFactory == null) &lt;/p&gt;
{
    +                System.clearProperty(
    +                        ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY);
    +                return;
    +            }
&lt;p&gt;    +            System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY,&lt;br/&gt;
    +                    originalServerCnxnFactory);&lt;br/&gt;
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for&lt;br/&gt;
    +     * &lt;/p&gt;
{@link https://issues.apache.org/jira/browse/ZOOKEEPER-2383}
&lt;p&gt;.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 30000)&lt;br/&gt;
    +    public void testFourLetterWords() throws Exception &lt;/p&gt;
{
    +        startSimpleZKServer(startupDelayLatch);
    +        verify(&quot;conf&quot;, ZK_NOT_SERVING);
    +        verify(&quot;crst&quot;, ZK_NOT_SERVING);
    +        verify(&quot;cons&quot;, ZK_NOT_SERVING);
    +        verify(&quot;dirs&quot;, ZK_NOT_SERVING);
    +        verify(&quot;dump&quot;, ZK_NOT_SERVING);
    +        verify(&quot;mntr&quot;, ZK_NOT_SERVING);
    +        verify(&quot;stat&quot;, ZK_NOT_SERVING);
    +        verify(&quot;srst&quot;, ZK_NOT_SERVING);
    +        verify(&quot;wchp&quot;, ZK_NOT_SERVING);
    +        verify(&quot;wchc&quot;, ZK_NOT_SERVING);
    +        verify(&quot;wchs&quot;, ZK_NOT_SERVING);
    +        verify(&quot;isro&quot;, &quot;null&quot;);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private void verify(String cmd, String expected)&lt;br/&gt;
    +            throws IOException, SSLContextException &lt;/p&gt;
{
    +        String resp = sendRequest(cmd);
    +        LOG.info(&quot;cmd &quot; + cmd + &quot; expected &quot; + expected + &quot; got &quot; + resp);
    +        Assert.assertTrue(&quot;Unexpected response&quot;, resp.contains(expected));
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private String sendRequest(String cmd)&lt;br/&gt;
    +            throws IOException, SSLContextException &lt;/p&gt;
{
    +        return send4LetterWord(HOST, PORT, cmd);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private void startSimpleZKServer(CountDownLatch startupDelayLatch)&lt;br/&gt;
    +            throws IOException {&lt;br/&gt;
    +        zks = new SimpleZooKeeperServer(tmpDir, tmpDir, 3000,&lt;br/&gt;
    +                startupDelayLatch);&lt;br/&gt;
    +        SyncRequestProcessor.setSnapCount(100);&lt;br/&gt;
    +        final int PORT = Integer.parseInt(HOSTPORT.split(&quot;:&quot;)&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +        servcnxnf = ServerCnxnFactory.createFactory(PORT, -1);&lt;br/&gt;
    +        Thread startupThread = new Thread() {&lt;br/&gt;
    +            public void run() {&lt;br/&gt;
    +                try &lt;/p&gt;
{
    +                    servcnxnf.startup(zks);
    +                }
&lt;p&gt; catch (IOException | InterruptedException e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Thank you @fpj . I&apos;ve separated out the catch block and done another commit in PR.&lt;/p&gt;</comment>
                            <comment id="15754060" author="hadoopqa" created="Fri, 16 Dec 2016 10:28:50 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/130//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/130//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/130//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/130//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15754062" author="hadoopqa" created="Fri, 16 Dec 2016 10:30:02 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/129//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/129//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/129//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/129//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/129//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/129//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15754181" author="githubbot" created="Fri, 16 Dec 2016 11:28:59 +0000"  >&lt;p&gt;Github user fpj commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This is including the commit I just did for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-761&quot; title=&quot;Remove *synchronous* calls from the *single-threaded* C clieant API, since they are documented not to work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-761&quot;&gt;&lt;del&gt;ZOOKEEPER-761&lt;/del&gt;&lt;/a&gt;, could you rebase your branch, please, @rakeshadr ?&lt;/p&gt;</comment>
                            <comment id="15754797" author="hadoopqa" created="Fri, 16 Dec 2016 15:59:13 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/134//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/134//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/134//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/134//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/134//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/134//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15754824" author="githubbot" created="Fri, 16 Dec 2016 16:08:22 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    oops, I&apos;ve rebased it and hope the PR is clean now. Please take a look at this when you get some time. Thanks!&lt;/p&gt;</comment>
                            <comment id="15768361" author="githubbot" created="Wed, 21 Dec 2016 22:32:35 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/101&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15768373" author="fpj" created="Wed, 21 Dec 2016 22:36:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; pull request #101 merged fine onto master, but not branch 3.5. I haven&apos;t tried branch 3.4.&lt;/p&gt;</comment>
                            <comment id="15768490" author="hudson" created="Wed, 21 Dec 2016 23:37:36 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3204 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3204/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3204/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;: Startup race in ZooKeeperServer (fpj: rev eac693cc76a34f96b9116ef33d1e92af7129416d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/AbstractFourLetterCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/DumpCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/StatResetCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/IsroCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/ConsCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/admin/Commands.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/MonitorCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/ConfCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/WatchCommand.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/ZooKeeperServerStartupTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/CnxnStatResetCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/DirsCommand.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/command/StatCommand.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15768992" author="rakeshr" created="Thu, 22 Dec 2016 04:25:52 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the help in resolving this.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;pull request #101 merged fine onto master, but not branch 3.5. I haven&apos;t tried branch 3.4.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ve tried cherry pick the commits to branch-3.5 locally and it worked. Is there anything specific to be done to &lt;tt&gt;branch 3.5&lt;/tt&gt;?. But it requires a separate PR for &lt;tt&gt;branch 3.4&lt;/tt&gt; as the code is different from master branch, I&apos;will create a PR for &lt;tt&gt;branch 3.4&lt;/tt&gt; shortly.&lt;/p&gt;</comment>
                            <comment id="15770897" author="rakeshr" created="Thu, 22 Dec 2016 19:35:04 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; for merging this to &lt;tt&gt;branch-3.5&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15773276" author="githubbot" created="Fri, 23 Dec 2016 17:00:41 +0000"  >&lt;p&gt;GitHub user rakeshadr opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;: Startup race in ZooKeeperServer&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rakeshadr/zookeeper-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rakeshadr/zookeeper-1&lt;/a&gt; ZK-2383-br-3.4&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #135&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 08d26512f131897f82b2566439c55c8fe539c4e5&lt;br/&gt;
Author: Rakesh Radhakrishnan &amp;lt;rakeshr@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-12-23T16:54:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2383&quot; title=&quot;Startup race in ZooKeeperServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2383&quot;&gt;&lt;del&gt;ZOOKEEPER-2383&lt;/del&gt;&lt;/a&gt;: Startup race in ZooKeeperServer&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15773279" author="rakeshr" created="Fri, 23 Dec 2016 17:03:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR_135&lt;/a&gt; is created to merge the changes to &lt;tt&gt;branch-3.4&lt;/tt&gt;. Please review this. Thanks!&lt;/p&gt;</comment>
                            <comment id="15795574" author="githubbot" created="Tue, 3 Jan 2017 17:17:14 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rakeshadr The test file is put in source folder (src/java/main/org/apache/zookeeper/server/ZooKeeperServerStartupTest.java) - it should be put in test folder (src/java/test) right?&lt;/p&gt;</comment>
                            <comment id="15795616" author="githubbot" created="Tue, 3 Jan 2017 17:37:58 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @hanm for pointing out this. I&apos;ve moved the test accordingly.&lt;/p&gt;</comment>
                            <comment id="15795648" author="githubbot" created="Tue, 3 Jan 2017 17:52:01 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @rakeshadr , looks good. Merging.&lt;/p&gt;</comment>
                            <comment id="15795654" author="hanm" created="Tue, 3 Jan 2017 17:54:20 +0000"  >&lt;p&gt;Issue resolved by pull request 135&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15833796" author="githubbot" created="Mon, 23 Jan 2017 01:36:53 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rakeshadr Could you close this PR since it has been merged in? Thanks.&lt;/p&gt;</comment>
                            <comment id="15833876" author="githubbot" created="Mon, 23 Jan 2017 04:03:20 +0000"  >&lt;p&gt;Github user rakeshadr closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15833877" author="githubbot" created="Mon, 23 Jan 2017 04:03:38 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Done!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12941580">SOLR-8724</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13030203">ZOOKEEPER-2655</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13042404">ARIES-1684</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12995073">SOLR-9386</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12792036" name="TestZkStandaloneJMXRegistrationRaceConcurrent.java" size="2081" author="sarowe" created="Tue, 8 Mar 2016 17:24:00 +0000"/>
                            <attachment id="12821043" name="ZOOKEEPER-2383-br-3-4.patch" size="14052" author="rakeshr" created="Fri, 29 Jul 2016 18:04:26 +0000"/>
                            <attachment id="12837652" name="ZOOKEEPER-2383.patch" size="22078" author="rakeshr" created="Sun, 6 Nov 2016 16:44:03 +0000"/>
                            <attachment id="12822349" name="ZOOKEEPER-2383.patch" size="15441" author="rakeshr" created="Fri, 5 Aug 2016 18:08:43 +0000"/>
                            <attachment id="12822237" name="ZOOKEEPER-2383.patch" size="14827" author="rakeshr" created="Fri, 5 Aug 2016 05:34:09 +0000"/>
                            <attachment id="12819926" name="ZOOKEEPER-2383.patch" size="14762" author="rakeshr" created="Mon, 25 Jul 2016 13:21:23 +0000"/>
                            <attachment id="12792038" name="release-3.4.8-extra-logging.patch" size="2824" author="sarowe" created="Tue, 8 Mar 2016 17:24:00 +0000"/>
                            <attachment id="12792037" name="zk-3.4.8-MBeanRegistry.log" size="10183" author="sarowe" created="Tue, 8 Mar 2016 17:24:00 +0000"/>
                            <attachment id="12792040" name="zk-3.4.8-NPE.log" size="12467" author="sarowe" created="Tue, 8 Mar 2016 17:27:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ucfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>