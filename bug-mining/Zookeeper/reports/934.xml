<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3306] Node may not accessible due the the inconsistent ACL reference map after SNAP sync </title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3306</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;This is a new bug we found on production.&lt;/p&gt;

&lt;p&gt;ZooKeeper uses ACL reference id and count to save the space in snapshot. During fuzzy snapshot sync, the reference count may not be updated correctly in case like the znode is already exist.&lt;/p&gt;

&lt;p&gt;When ACL reference count reaches 0, it will be deleted from the system, but actually there might be other nodes still using it. And when visiting a node with the deleted ACL id, it will be rejected because it doesn&apos;t exist anymore.&lt;/p&gt;

&lt;p&gt;Here is the detailed flow for one of the scenario here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Server A starts to have snap sync with&#160;leader&lt;/li&gt;
	&lt;li&gt;After serializing the ACL map to Server A, there is a txn T1 to create a node&#160;N1 with new ACL_1 which was not exist in ACL map&lt;/li&gt;
	&lt;li&gt;On leader, after this txn, the ACL map will be ID1 -&amp;gt; (ACL_1, COUNT: 1), and data tree N1 -&amp;gt; ID1&lt;/li&gt;
	&lt;li&gt;On server A, it will be empty ACL map, and N1 -&amp;gt; ID1 in fuzzy snapshot&lt;/li&gt;
	&lt;li&gt;When replaying the txn T1, it will skip at the beginning since the node is already exist, which leaves an empty ACL map,&#160;and N1 is referencing to a non-exist ACL ID1&lt;/li&gt;
	&lt;li&gt;Node N1 will be not accessible because the ACL not exist, and if it became leader later then all the write requests will be rejected as well with marshalling error.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We&apos;re still working on the fix,&#160;suggestions are welcome.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13220887">ZOOKEEPER-3306</key>
            <summary>Node may not accessible due the the inconsistent ACL reference map after SNAP sync </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lvfangmin">Fangmin Lv</assignee>
                                    <reporter username="lvfangmin">Fangmin Lv</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 11 Mar 2019 17:16:38 +0000</created>
                <updated>Thu, 20 Apr 2023 04:12:18 +0000</updated>
                            <resolved>Mon, 29 Apr 2019 14:49:48 +0000</resolved>
                                    <version>3.5.4</version>
                    <version>3.6.0</version>
                    <version>3.4.13</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="16829316" author="andorm" created="Mon, 29 Apr 2019 14:49:48 +0000"  >&lt;p&gt;Issue resolved by pull request 848&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/848&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16829568" author="hudson" created="Mon, 29 Apr 2019 17:50:28 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #500 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/500/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/500/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3306&quot; title=&quot;Node may not accessible due the the inconsistent ACL reference map after SNAP sync &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3306&quot;&gt;&lt;del&gt;ZOOKEEPER-3306&lt;/del&gt;&lt;/a&gt;: Fixing node not accessible issue due the inconsistent (andor: rev 46b2018dbe008e010462e0dc06ddb73981d19d2a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/persistence/FileTxnSnapLogTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/DataTree.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16829798" author="hudson" created="Mon, 29 Apr 2019 22:50:54 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #334 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/334/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/334/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3306&quot; title=&quot;Node may not accessible due the the inconsistent ACL reference map after SNAP sync &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3306&quot;&gt;&lt;del&gt;ZOOKEEPER-3306&lt;/del&gt;&lt;/a&gt;: Fixing node not accessible issue due the inconsistent (andor: rev 46b2018dbe008e010462e0dc06ddb73981d19d2a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/persistence/FileTxnSnapLogTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/DataTree.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17714409" author="JIRAUSER293710" created="Thu, 20 Apr 2023 04:12:18 +0000"  >&lt;p&gt;I think there&apos;s an issue with this patch and created &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-4689&quot; title=&quot;Node may not accessible due the the inconsistent ACL reference map after SNAP sync (again)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-4689&quot;&gt;ZOOKEEPER-4689&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00kmg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>