<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:59:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2325] Data inconsistency if all snapshots empty or missing</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2325</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;When loading state from snapshots on startup, FileTxnSnapLog.java ignores the result of FileSnap.deserialize, which is -1L if no valid snapshots are found. Recovery proceeds with dt.lastProcessed == 0, its initial value.&lt;/p&gt;

&lt;p&gt;The result is that Zookeeper will process the transaction logs and then begin serving requests with a different state than the rest of the ensemble.&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;br/&gt;
In a healthy zookeeper cluster of size &amp;gt;= 3, shut down one node.&lt;br/&gt;
Either delete all snapshots for this node or change all to be empty files.&lt;br/&gt;
Restart the node.&lt;/p&gt;

&lt;p&gt;We believe this can happen organically if a node runs out of disk space.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12914273">ZOOKEEPER-2325</key>
            <summary>Data inconsistency if all snapshots empty or missing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="agrasso">Andrew Grasso</assignee>
                                    <reporter username="agrasso">Andrew Grasso</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 18 Nov 2015 22:21:56 +0000</created>
                <updated>Wed, 21 Aug 2019 16:59:07 +0000</updated>
                            <resolved>Fri, 26 Oct 2018 10:04:07 +0000</resolved>
                                    <version>3.4.6</version>
                                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>15</watches>
                                    <workratio workratioPercent="16"/>
                                    <progress percentage="16">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="16" backgroundColor="#51a825"/>
                                                    <row percentage="84" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="16">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="16" backgroundColor="#51a825"/>
                                                    <row percentage="84" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3000">50m</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="15012198" author="agrasso" created="Wed, 18 Nov 2015 22:31:02 +0000"  >&lt;p&gt;By returning -1L, transaction logs are skipped and recovery succeeds.&lt;/p&gt;</comment>
                            <comment id="15261095" author="nwolchko" created="Wed, 27 Apr 2016 22:37:43 +0000"  >&lt;p&gt;I&apos;ve seen some cases where our zookeeper servers lost data, and this looks like it could be the cause. Is there anything blocking this change?&lt;/p&gt;</comment>
                            <comment id="15261574" author="fpj" created="Thu, 28 Apr 2016 05:41:15 +0000"  >&lt;p&gt;It sounds like this should be easy to reproduce. Do you think you can add a test case for this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=agrasso&quot; class=&quot;user-hover&quot; rel=&quot;agrasso&quot;&gt;agrasso&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15262505" author="agrasso" created="Thu, 28 Apr 2016 16:54:38 +0000"  >&lt;p&gt;This patch adds a test that fails due to this bug, but succeeds with the submitted patch applied.&lt;/p&gt;

&lt;p&gt;I believe the behavior expected by this test is the &quot;correct&quot; behavior, but please let me know if my understanding is incorrect.&lt;/p&gt;</comment>
                            <comment id="15419230" author="breed" created="Fri, 12 Aug 2016 18:06:26 +0000"  >&lt;p&gt;patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;.001.patch to make sure the initial case is handled correctly: the server starts up and logs a few transactions and then restarts. (found because this patch doesn&apos;t pass unit tests.)&lt;/p&gt;</comment>
                            <comment id="15514078" author="hadoopqa" created="Thu, 22 Sep 2016 18:23:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12823508/zk.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12823508/zk.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision ec20c5434cc8a334b3fd25e27d26dccf4793c8f3.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3447//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3447//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15706783" author="githubbot" created="Tue, 29 Nov 2016 22:39:13 +0000"  >&lt;p&gt;GitHub user breed opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;: Data inconsistency if all snapshots empty or missing&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/breed/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/breed/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #117&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 02bf3d57786d51da205e78a070a45703da21f916&lt;br/&gt;
Author: Benjamin Reed &amp;lt;br33d@fb.com&amp;gt;&lt;br/&gt;
Date:   2016-11-29T22:08:22Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;: Data inconsistency if all snapshots empty or missing&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15706785" author="breed" created="Tue, 29 Nov 2016 22:40:16 +0000"  >&lt;p&gt;hey andrew, i&apos;ve merged all the patches into a pull request. can you take a look and make sure everything looks ok?&lt;/p&gt;</comment>
                            <comment id="15706823" author="agrasso" created="Tue, 29 Nov 2016 22:55:42 +0000"  >&lt;p&gt;This looks good to me. Thanks for putting the pull request together.&lt;/p&gt;</comment>
                            <comment id="15706861" author="hadoopqa" created="Tue, 29 Nov 2016 23:10:53 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15710502" author="githubbot" created="Thu, 1 Dec 2016 01:37:53 +0000"  >&lt;p&gt;Github user lvfangmin commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90368114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90368114&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java &amp;#8212;&lt;br/&gt;
    @@ -165,8 +165,22 @@ public File getSnapDir() {&lt;br/&gt;
          */&lt;br/&gt;
         public long restore(DataTree dt, Map&amp;lt;Long, Integer&amp;gt; sessions,&lt;br/&gt;
                 PlayBackListener listener) throws IOException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapLog.deserialize(dt, sessions);&lt;br/&gt;
    +        long deserializeResult = snapLog.deserialize(dt, sessions);&lt;br/&gt;
             FileTxnLog txnLog = new FileTxnLog(dataDir);&lt;br/&gt;
    +        if (-1L == deserializeResult) {&lt;br/&gt;
    +            /* this means that we couldn&apos;t find any snapshot, so we need to&lt;br/&gt;
    +             * initialize an empty database */&lt;br/&gt;
    +            if (txnLog.getLastLoggedZxid() != -1) 
{
    +                throw new IOException(
    +                        &quot;No snapshot found, but there are log entries. &quot; +
    +                        &quot;Something is broken!&quot;);
    +            }
&lt;p&gt;    +            /* TODO: (br33d) we should either put a ConcurrentHashMap on restore()&lt;br/&gt;
    +             *       or use Map on save() */&lt;br/&gt;
    +            save(dt, (ConcurrentHashMap&amp;lt;Long, Integer&amp;gt;)sessions);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    n00b question, why we need to save here? I saw there is potential that the follower will sync with with leader just to send over the empty snapshot.&lt;/p&gt;</comment>
                            <comment id="15710994" author="hadoopqa" created="Thu, 1 Dec 2016 05:50:13 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15712489" author="githubbot" created="Thu, 1 Dec 2016 17:06:36 +0000"  >&lt;p&gt;Github user rgs1 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90490925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90490925&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java &amp;#8212;&lt;br/&gt;
    @@ -165,8 +165,22 @@ public File getSnapDir() {&lt;br/&gt;
          */&lt;br/&gt;
         public long restore(DataTree dt, Map&amp;lt;Long, Integer&amp;gt; sessions,&lt;br/&gt;
                 PlayBackListener listener) throws IOException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapLog.deserialize(dt, sessions);&lt;br/&gt;
    +        long deserializeResult = snapLog.deserialize(dt, sessions);&lt;br/&gt;
             FileTxnLog txnLog = new FileTxnLog(dataDir);&lt;br/&gt;
    +        if (-1L == deserializeResult) {&lt;br/&gt;
    +            /* this means that we couldn&apos;t find any snapshot, so we need to&lt;br/&gt;
    +             * initialize an empty database */
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: can you add a reference to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt; here?&lt;/p&gt;</comment>
                            <comment id="15712490" author="githubbot" created="Thu, 1 Dec 2016 17:06:36 +0000"  >&lt;p&gt;Github user rgs1 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90491384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90491384&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.PrintWriter;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.LinkedList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.log4j.Logger;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.Leader.Proposal;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.SyncRequestProcessor;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should &lt;br/&gt;
    + *  not proceed to read its transactiong log files&lt;br/&gt;
    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots&lt;br/&gt;
    + */&lt;br/&gt;
    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {&lt;br/&gt;
    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);&lt;br/&gt;
    +    private static String HOSTPORT = &quot;127.0.0.1:&quot; + PortAssignment.unique();&lt;br/&gt;
    +    private static final int CONNECTION_TIMEOUT = 3000;&lt;br/&gt;
    +    private static final int N_TRANSACTIONS = 150;&lt;br/&gt;
    +    private static final int SNAP_COUNT = 100;&lt;br/&gt;
    +&lt;br/&gt;
    +    public void runTest(boolean leaveEmptyFile) throws Exception {&lt;br/&gt;
    +        File tmpSnapDir = ClientBase.createTmpDir();&lt;br/&gt;
    +        File tmpLogDir  = ClientBase.createTmpDir();&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        ZooKeeperServer zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);&lt;br/&gt;
    +        SyncRequestProcessor.setSnapCount(SNAP_COUNT);&lt;br/&gt;
    +        final int PORT = Integer.parseInt(HOSTPORT.split(&quot;:&quot;)&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +        ServerCnxnFactory f = ServerCnxnFactory.createFactory(PORT, -1);&lt;br/&gt;
    +        f.startup(zks);&lt;br/&gt;
    +        Assert.assertTrue(&quot;waiting for server being up &quot;,&lt;br/&gt;
    +                ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(HOSTPORT, CONNECTION_TIMEOUT, this);&lt;br/&gt;
    +        try {&lt;br/&gt;
    +            for (int i = 0; i&amp;lt; N_TRANSACTIONS; i++) &lt;/p&gt;
{
    +                zk.create(&quot;/node-&quot; + i, new byte[0], Ids.OPEN_ACL_UNSAFE,
    +                        CreateMode.PERSISTENT);
    +            }
&lt;p&gt;    +        } finally &lt;/p&gt;
{
    +            zk.close();
    +        }
&lt;p&gt;    +        f.shutdown();&lt;br/&gt;
    +        zks.shutdown();&lt;br/&gt;
    +        Assert.assertTrue(&quot;waiting for server to shutdown&quot;,&lt;br/&gt;
    +                ClientBase.waitForServerDown(HOSTPORT, CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        // start server again with intact database&lt;br/&gt;
    +        zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);&lt;br/&gt;
    +        zks.startdata();&lt;br/&gt;
    +        long zxid = zks.getZKDatabase().getDataTreeLastProcessedZxid();&lt;br/&gt;
    +        LOG.info(&quot;After clean restart, zxid = &quot; + zxid);&lt;br/&gt;
    +        Assert.assertTrue(&quot;zxid &amp;gt; 0&quot;, zxid &amp;gt; 0);&lt;br/&gt;
    +        zks.shutdown();&lt;br/&gt;
    +&lt;br/&gt;
    +        // Make all snapshots empty&lt;br/&gt;
    +        FileTxnSnapLog txnLogFactory = zks.getTxnLogFactory();&lt;br/&gt;
    +        List&amp;lt;File&amp;gt; snapshots = txnLogFactory.findNRecentSnapshots(10);&lt;br/&gt;
    +        Assert.assertTrue(&quot;We have a snapshot to corrupt&quot;, snapshots.size() &amp;gt; 0);&lt;br/&gt;
    +        for (File file: snapshots) {&lt;br/&gt;
    +            if (leaveEmptyFile) &lt;/p&gt;
{
    +                new PrintWriter(file).close ();
    +            }
&lt;p&gt;    +            else &lt;/p&gt;
{
    --- End diff --
    
    nit: coding style `}
&lt;p&gt; else {`&lt;/p&gt;</comment>
                            <comment id="15712832" author="githubbot" created="Thu, 1 Dec 2016 19:24:04 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1, just one comment on test coverage.&lt;/p&gt;</comment>
                            <comment id="15712900" author="githubbot" created="Thu, 1 Dec 2016 19:51:06 +0000"  >&lt;p&gt;Github user breed commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90523518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90523518&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java &amp;#8212;&lt;br/&gt;
    @@ -165,8 +165,22 @@ public File getSnapDir() {&lt;br/&gt;
          */&lt;br/&gt;
         public long restore(DataTree dt, Map&amp;lt;Long, Integer&amp;gt; sessions,&lt;br/&gt;
                 PlayBackListener listener) throws IOException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapLog.deserialize(dt, sessions);&lt;br/&gt;
    +        long deserializeResult = snapLog.deserialize(dt, sessions);&lt;br/&gt;
             FileTxnLog txnLog = new FileTxnLog(dataDir);&lt;br/&gt;
    +        if (-1L == deserializeResult) {&lt;br/&gt;
    +            /* this means that we couldn&apos;t find any snapshot, so we need to&lt;br/&gt;
    +             * initialize an empty database */&lt;br/&gt;
    +            if (txnLog.getLastLoggedZxid() != -1) 
{
    +                throw new IOException(
    +                        &quot;No snapshot found, but there are log entries. &quot; +
    +                        &quot;Something is broken!&quot;);
    +            }
&lt;p&gt;    +            /* TODO: (br33d) we should either put a ConcurrentHashMap on restore()&lt;br/&gt;
    +             *       or use Map on save() */&lt;br/&gt;
    +            save(dt, (ConcurrentHashMap&amp;lt;Long, Integer&amp;gt;)sessions);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    yes, &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-261&quot; title=&quot;Reinitialized servers should not participate in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-261&quot;&gt;&lt;del&gt;ZOOKEEPER-261&lt;/del&gt;&lt;/a&gt; is still a problem. is that what you are referring to? brian has a patch coming that builds on this one to fix that problem.&lt;/p&gt;</comment>
                            <comment id="15712905" author="githubbot" created="Thu, 1 Dec 2016 19:52:30 +0000"  >&lt;p&gt;Github user breed commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90523812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90523812&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.PrintWriter;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.LinkedList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.log4j.Logger;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.Leader.Proposal;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.SyncRequestProcessor;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should &lt;br/&gt;
    + *  not proceed to read its transactiong log files&lt;br/&gt;
    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots&lt;br/&gt;
    + */&lt;br/&gt;
    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {&lt;br/&gt;
    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);&lt;br/&gt;
    +    private static String HOSTPORT = &quot;127.0.0.1:&quot; + PortAssignment.unique();&lt;br/&gt;
    +    private static final int CONNECTION_TIMEOUT = 3000;&lt;br/&gt;
    +    private static final int N_TRANSACTIONS = 150;&lt;br/&gt;
    +    private static final int SNAP_COUNT = 100;&lt;br/&gt;
    +&lt;br/&gt;
    +    public void runTest(boolean leaveEmptyFile) throws Exception {&lt;br/&gt;
    +        File tmpSnapDir = ClientBase.createTmpDir();&lt;br/&gt;
    +        File tmpLogDir  = ClientBase.createTmpDir();&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        ZooKeeperServer zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);&lt;br/&gt;
    +        SyncRequestProcessor.setSnapCount(SNAP_COUNT);&lt;br/&gt;
    +        final int PORT = Integer.parseInt(HOSTPORT.split(&quot;:&quot;)&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;);&lt;br/&gt;
    +        ServerCnxnFactory f = ServerCnxnFactory.createFactory(PORT, -1);&lt;br/&gt;
    +        f.startup(zks);&lt;br/&gt;
    +        Assert.assertTrue(&quot;waiting for server being up &quot;,&lt;br/&gt;
    +                ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(HOSTPORT, CONNECTION_TIMEOUT, this);&lt;br/&gt;
    +        try {&lt;br/&gt;
    +            for (int i = 0; i&amp;lt; N_TRANSACTIONS; i++) &lt;/p&gt;
{
    +                zk.create(&quot;/node-&quot; + i, new byte[0], Ids.OPEN_ACL_UNSAFE,
    +                        CreateMode.PERSISTENT);
    +            }
&lt;p&gt;    +        } finally &lt;/p&gt;
{
    +            zk.close();
    +        }
&lt;p&gt;    +        f.shutdown();&lt;br/&gt;
    +        zks.shutdown();&lt;br/&gt;
    +        Assert.assertTrue(&quot;waiting for server to shutdown&quot;,&lt;br/&gt;
    +                ClientBase.waitForServerDown(HOSTPORT, CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        // start server again with intact database&lt;br/&gt;
    +        zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);&lt;br/&gt;
    +        zks.startdata();&lt;br/&gt;
    +        long zxid = zks.getZKDatabase().getDataTreeLastProcessedZxid();&lt;br/&gt;
    +        LOG.info(&quot;After clean restart, zxid = &quot; + zxid);&lt;br/&gt;
    +        Assert.assertTrue(&quot;zxid &amp;gt; 0&quot;, zxid &amp;gt; 0);&lt;br/&gt;
    +        zks.shutdown();&lt;br/&gt;
    +&lt;br/&gt;
    +        // Make all snapshots empty&lt;br/&gt;
    +        FileTxnSnapLog txnLogFactory = zks.getTxnLogFactory();&lt;br/&gt;
    +        List&amp;lt;File&amp;gt; snapshots = txnLogFactory.findNRecentSnapshots(10);&lt;br/&gt;
    +        Assert.assertTrue(&quot;We have a snapshot to corrupt&quot;, snapshots.size() &amp;gt; 0);&lt;br/&gt;
    +        for (File file: snapshots) {&lt;br/&gt;
    +            if (leaveEmptyFile) &lt;/p&gt;
{
    +                new PrintWriter(file).close ();
    +            }
&lt;p&gt;    +            else {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    yes that is ugly!&lt;/p&gt;</comment>
                            <comment id="15712961" author="githubbot" created="Thu, 1 Dec 2016 20:15:45 +0000"  >&lt;p&gt;Github user breed commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @hanm i can&apos;t seem to find your comment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15713015" author="githubbot" created="Thu, 1 Dec 2016 20:38:34 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90516233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90516233&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.PrintWriter;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.LinkedList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.log4j.Logger;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.Leader.Proposal;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.SyncRequestProcessor;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should &lt;br/&gt;
    + *  not proceed to read its transactiong log files&lt;br/&gt;
    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots&lt;br/&gt;
    + */&lt;br/&gt;
    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {&lt;br/&gt;
    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);&lt;br/&gt;
    +    private static String HOSTPORT = &quot;127.0.0.1:&quot; + PortAssignment.unique();&lt;br/&gt;
    +    private static final int CONNECTION_TIMEOUT = 3000;&lt;br/&gt;
    +    private static final int N_TRANSACTIONS = 150;&lt;br/&gt;
    +    private static final int SNAP_COUNT = 100;&lt;br/&gt;
    +&lt;br/&gt;
    +    public void runTest(boolean leaveEmptyFile) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Test coverage improvement suggestion: here we don&apos;t cover the case where both transaction log files and snap shot files are missing (either deleted, or empty) - in which case the ZK server should happily recover w/o problem. Something like this should work: `runTest(boolean leaveEmptySnapshotFile, boolean leaveEmptyTxnLogFile)`.&lt;/p&gt;</comment>
                            <comment id="15713016" author="githubbot" created="Thu, 1 Dec 2016 20:38:34 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90516950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90516950&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java &amp;#8212;&lt;br/&gt;
    @@ -165,8 +165,22 @@ public File getSnapDir() {&lt;br/&gt;
          */&lt;br/&gt;
         public long restore(DataTree dt, Map&amp;lt;Long, Integer&amp;gt; sessions,&lt;br/&gt;
                 PlayBackListener listener) throws IOException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapLog.deserialize(dt, sessions);&lt;br/&gt;
    +        long deserializeResult = snapLog.deserialize(dt, sessions);&lt;br/&gt;
             FileTxnLog txnLog = new FileTxnLog(dataDir);&lt;br/&gt;
    +        if (-1L == deserializeResult) {&lt;br/&gt;
    +            /* this means that we couldn&apos;t find any snapshot, so we need to&lt;br/&gt;
    +             * initialize an empty database */&lt;br/&gt;
    +            if (txnLog.getLastLoggedZxid() != -1) 
{
    +                throw new IOException(
    +                        &quot;No snapshot found, but there are log entries. &quot; +
    +                        &quot;Something is broken!&quot;);
    +            }
&lt;p&gt;    +            /* TODO: (br33d) we should either put a ConcurrentHashMap on restore()&lt;br/&gt;
    +             *       or use Map on save() */&lt;br/&gt;
    +            save(dt, (ConcurrentHashMap&amp;lt;Long, Integer&amp;gt;)sessions);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think we need it here because if we are getting here then the zxid of this server must be -1, so it would not win leader election if at least one other server is sane (with valid snapshot/txn log to recover.), so this server will become a follow and sync the (none empty) snapshot from the leader. If all servers have empty snapshots then this save is also required to bootstrap the recover process.&lt;/p&gt;</comment>
                            <comment id="15713018" author="githubbot" created="Thu, 1 Dec 2016 20:39:39 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @breed I think I commented by started a review but not submitted - haven&apos;t used this github feature until now. Just submitted my comments, they should appear now.&lt;/p&gt;</comment>
                            <comment id="15713392" author="hadoopqa" created="Thu, 1 Dec 2016 23:21:39 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15718424" author="githubbot" created="Sat, 3 Dec 2016 17:21:43 +0000"  >&lt;p&gt;Github user rgs1 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90761121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90761121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.PrintWriter;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.LinkedList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.log4j.Logger;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.Leader.Proposal;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.SyncRequestProcessor;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should &lt;br/&gt;
    + *  not proceed to read its transactiong log files&lt;br/&gt;
    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots&lt;br/&gt;
    + */&lt;br/&gt;
    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {&lt;br/&gt;
    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);&lt;br/&gt;
    +    private static String HOSTPORT = &quot;127.0.0.1:&quot; + PortAssignment.unique();&lt;br/&gt;
    +    private static final int CONNECTION_TIMEOUT = 3000;&lt;br/&gt;
    +    private static final int N_TRANSACTIONS = 150;&lt;br/&gt;
    +    private static final int SNAP_COUNT = 100;&lt;br/&gt;
    +&lt;br/&gt;
    +    public void runTest(boolean leaveEmptyFile) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @breed do you want to take @hanm&apos;s suggestion or should I merge this and we get that in another pass?&lt;/p&gt;</comment>
                            <comment id="15720874" author="githubbot" created="Mon, 5 Dec 2016 00:36:58 +0000"  >&lt;p&gt;Github user breed commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117#discussion_r90791441&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117#discussion_r90791441&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,134 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.PrintWriter;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.LinkedList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.log4j.Logger;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.ZKTestCase;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.Leader.Proposal;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.SyncRequestProcessor;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should &lt;br/&gt;
    + *  not proceed to read its transactiong log files&lt;br/&gt;
    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots&lt;br/&gt;
    + */&lt;br/&gt;
    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {&lt;br/&gt;
    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);&lt;br/&gt;
    +    private static String HOSTPORT = &quot;127.0.0.1:&quot; + PortAssignment.unique();&lt;br/&gt;
    +    private static final int CONNECTION_TIMEOUT = 3000;&lt;br/&gt;
    +    private static final int N_TRANSACTIONS = 150;&lt;br/&gt;
    +    private static final int SNAP_COUNT = 100;&lt;br/&gt;
    +&lt;br/&gt;
    +    public void runTest(boolean leaveEmptyFile) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    i think we should skip that test. we have a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-261&quot; title=&quot;Reinitialized servers should not participate in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-261&quot;&gt;&lt;del&gt;ZOOKEEPER-261&lt;/del&gt;&lt;/a&gt; that fixes that specific scenario.&lt;/p&gt;</comment>
                            <comment id="15752196" author="breed" created="Thu, 15 Dec 2016 19:02:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; can you commit this? we need it to get &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-261&quot; title=&quot;Reinitialized servers should not participate in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-261&quot;&gt;&lt;del&gt;ZOOKEEPER-261&lt;/del&gt;&lt;/a&gt; in.&lt;/p&gt;</comment>
                            <comment id="15752213" author="hanm" created="Thu, 15 Dec 2016 19:07:58 +0000"  >&lt;p&gt;I noticed that the pull request of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-261&quot; title=&quot;Reinitialized servers should not participate in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-261&quot;&gt;&lt;del&gt;ZOOKEEPER-261&lt;/del&gt;&lt;/a&gt; contains changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt; already: &lt;a href=&quot;https://github.com/apache/zookeeper/pull/120/commits&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/120/commits&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15805547" author="nixon" created="Fri, 6 Jan 2017 19:53:37 +0000"  >&lt;p&gt;Any word on committing this patch? I&apos;d love to unblock &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-261&quot; title=&quot;Reinitialized servers should not participate in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-261&quot;&gt;&lt;del&gt;ZOOKEEPER-261&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="15805924" author="hanm" created="Fri, 6 Jan 2017 22:04:39 +0000"  >&lt;p&gt;I could help committing this one as the patch is reviewed. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt; I thought you just need the PR associated with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-261&quot; title=&quot;Reinitialized servers should not participate in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-261&quot;&gt;&lt;del&gt;ZOOKEEPER-261&lt;/del&gt;&lt;/a&gt; whose change is a superset of this JIRA (and committing both same time would probably save your some effort on rebase, if any), but probably separation of concern is better..&lt;/p&gt;</comment>
                            <comment id="15806240" author="githubbot" created="Sat, 7 Jan 2017 00:10:18 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15806241" author="hanm" created="Sat, 7 Jan 2017 00:10:36 +0000"  >&lt;p&gt;Issue resolved by pull request 117&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/117&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15806250" author="hanm" created="Sat, 7 Jan 2017 00:15:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=breed&quot; class=&quot;user-hover&quot; rel=&quot;breed&quot;&gt;breed&lt;/a&gt; merged in master and 3.5. &lt;/p&gt;

&lt;p&gt;I think we also want this in 3.4, but there is a merge conflict, so that merge will be handled separately. &lt;/p&gt;</comment>
                            <comment id="15806330" author="githubbot" created="Sat, 7 Jan 2017 00:51:55 +0000"  >&lt;p&gt;GitHub user hanm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt; for branch-3.4.&lt;/p&gt;

&lt;p&gt;    There was a merge conflict on file Zab1_0Test.java when cherry-picking commit 7c51b01e89acb38165553366f7e3b2a46c00aa27 to branch-3.4. This PR resolves the merge conflict (it is trivial, just two imports conflicts).&lt;/p&gt;

&lt;p&gt;    @breed @rgs1 @rakeshadr Please take a look and help committing this thanks.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hanm/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanm/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #144&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit afd34f286c860591f1e26b1c29539b322cef7bcc&lt;br/&gt;
Author: Benjamin Reed &amp;lt;br33d@fb.com&amp;gt;&lt;br/&gt;
Date:   2017-01-07T00:09:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt; (Data inconsistency if all snapshots empty or missing) for branch-3.4.&lt;br/&gt;
    Resolved merge conflict on Zab1_0Test.java when cherry-picking 7c51b01e89acb38165553366f7e3b2a46c00aa27.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15806336" author="hanm" created="Sat, 7 Jan 2017 00:53:03 +0000"  >&lt;p&gt;Reopen issue as patch is not merged in branch-3.4. Resolve the issue after &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144&lt;/a&gt; merged in.&lt;/p&gt;</comment>
                            <comment id="15806362" author="hudson" created="Sat, 7 Jan 2017 01:04:48 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3227 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3227/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3227/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;: Data inconsistency if all snapshots empty or missing (hanm: rev 7c51b01e89acb38165553366f7e3b2a46c00aa27)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/test/TruncateTest.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15810600" author="nixon" created="Mon, 9 Jan 2017 04:01:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Glad we kept the changes for this task and 261 separate. I&apos;ll make sure that &lt;a href=&quot;https://github.com/apache/zookeeper/pull/120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/120&lt;/a&gt; still commits cleanly and update that PR as necessary.&lt;/p&gt;</comment>
                            <comment id="15827048" author="githubbot" created="Tue, 17 Jan 2017 23:30:39 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144#discussion_r96526559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144#discussion_r96526559&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java &amp;#8212;&lt;br/&gt;
    @@ -135,8 +135,22 @@ public File getSnapDir() {&lt;br/&gt;
          */&lt;br/&gt;
         public long restore(DataTree dt, Map&amp;lt;Long, Integer&amp;gt; sessions, &lt;br/&gt;
                 PlayBackListener listener) throws IOException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;snapLog.deserialize(dt, sessions);&lt;br/&gt;
    +        long deserializeResult = snapLog.deserialize(dt, sessions);&lt;br/&gt;
             FileTxnLog txnLog = new FileTxnLog(dataDir);&lt;br/&gt;
    +        if (-1L == deserializeResult) {&lt;br/&gt;
    +            /* this means that we couldn&apos;t find any snapshot, so we need to&lt;br/&gt;
    +             * initialize an empty database (reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;) */&lt;br/&gt;
    +            if (txnLog.getLastLoggedZxid() != -1) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    would it be worth adding the -1 case to the javadoc for deserialize?&lt;/p&gt;</comment>
                            <comment id="15827049" author="githubbot" created="Tue, 17 Jan 2017 23:30:39 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144#discussion_r96534436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144#discussion_r96534436&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -37,6 +37,8 @@&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.HashMap;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    this change appears to break `testDirtySnapshot`&lt;/p&gt;</comment>
                            <comment id="15827050" author="githubbot" created="Tue, 17 Jan 2017 23:30:39 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144#discussion_r96534854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144#discussion_r96534854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,133 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.PrintWriter;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.LinkedList;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    a couple unneeded imports here as well&lt;/p&gt;</comment>
                            <comment id="15827051" author="githubbot" created="Tue, 17 Jan 2017 23:30:39 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144#discussion_r96525078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144#discussion_r96525078&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -37,6 +37,8 @@&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.HashMap;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: i don&apos;t think that this import is needed&lt;/p&gt;</comment>
                            <comment id="15827431" author="githubbot" created="Wed, 18 Jan 2017 05:07:07 +0000"  >&lt;p&gt;Github user rakeshadr commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/144#discussion_r96568373&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/144#discussion_r96568373&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -37,6 +37,8 @@&lt;br/&gt;
     import java.util.ArrayList;&lt;br/&gt;
     import java.util.HashMap;&lt;br/&gt;
     import java.util.List;&lt;br/&gt;
    +import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Good catch, @afine. This test is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1558&quot; title=&quot;Leader should not snapshot uncommitted state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1558&quot;&gt;&lt;del&gt;ZOOKEEPER-1558&lt;/del&gt;&lt;/a&gt;. Perhaps, we need to re-look the fix to see any chance of creating snapshot with uncommitted state.&lt;/p&gt;</comment>
                            <comment id="15963604" author="bothra90" created="Mon, 10 Apr 2017 22:44:29 +0000"  >&lt;p&gt;We saw a scenario where the zookeeper cluster had a log.1 file, but no snapshot.0. Is this a possible state of the data dir? If yes, this change prevents Zookeeper from restoring from just a txn log.&lt;/p&gt;</comment>
                            <comment id="15968437" author="nixon" created="Fri, 14 Apr 2017 00:20:11 +0000"  >&lt;p&gt;When a server starts up, it should always capture the state of the loaded database with a fresh snapshot. I don&apos;t believe it is a valid state to have a log file without a snapshot file.&lt;/p&gt;</comment>
                            <comment id="16664967" author="andorm" created="Fri, 26 Oct 2018 10:03:23 +0000"  >&lt;p&gt;This issue was originally targeted to 3.5 and 3.6 and fix has been committed to these branches.&lt;br/&gt;
Porting it to 3.4 is still open, but hasn&apos;t been updated for a while.&lt;/p&gt;

&lt;p&gt;In the process of cleaning up outstanding 3.5 tickets, I&apos;ll close this one and consider it fixed in 3.5.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13252045">ZOOKEEPER-3513</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="13164196">ZOOKEEPER-3056</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12801274" name="ZOOKEEPER-2325-test.patch" size="5513" author="agrasso" created="Thu, 28 Apr 2016 16:54:38 +0000"/>
                            <attachment id="12773102" name="ZOOKEEPER-2325.001.patch" size="846" author="agrasso" created="Wed, 18 Nov 2015 22:31:02 +0000"/>
                            <attachment id="12823508" name="zk.patch" size="1398" author="breed" created="Fri, 12 Aug 2016 18:06:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oluf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>