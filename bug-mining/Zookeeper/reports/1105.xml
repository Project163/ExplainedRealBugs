<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4565] Config watch path get truncated abnormally and fail chroot zookeeper client</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4565</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;tt&gt;ClientCnxn&lt;/tt&gt; strips off &lt;tt&gt;chrootPath&lt;/tt&gt; for notifications. This strip could break &quot;/zookeeper/config&quot; to illegal zookeeper path(aka. not start with &quot;/&quot;) and fail zookeeper client due to index out of bound exception in &lt;tt&gt;PathParentIterator.next&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-comment&quot;&gt;// convert from a server path to a client path
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (chrootPath != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; serverPath = event.getPath();
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (serverPath.compareTo(chrootPath) == 0) {
                        event.setPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (serverPath.length() &amp;gt; chrootPath.length()) {
                        event.setPath(serverPath.substring(chrootPath.length()));
                     } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                         LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got server path {} which is too &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; chroot path {}.&quot;&lt;/span&gt;,
                             event.getPath(), chrootPath);
                     }
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think we could make this strip similar to c client version &lt;tt&gt;sub_string&lt;/tt&gt; and warns only for not &quot;/zookeeper&quot; nodes.&lt;/p&gt;

&lt;p&gt;I found this issue in reproducing &lt;a href=&quot;https://issues.apache.org/jira/browse/CURATOR-593&quot; title=&quot;EnsembleTracker  &amp;quot;configToConnectionString&amp;quot; method doesn&amp;#39;t include zookeeper chroot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CURATOR-593&quot;&gt;&lt;del&gt;CURATOR-593&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CURATOR-611&quot; title=&quot;EnsembleTracker not appending the chroot node when setting the new connection string&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CURATOR-611&quot;&gt;&lt;del&gt;CURATOR-611&lt;/del&gt;&lt;/a&gt;. And the consequences are different in 3.6.3 and before.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Before 3.6.3(exclusive), watcher of &lt;tt&gt;getConfig&lt;/tt&gt; will receive event with illegal path.&lt;/li&gt;
	&lt;li&gt;After 3.6.3(inclusive), the client will disconnect due to exception from &lt;tt&gt;ZKWatchManager.addPersistentWatches&lt;/tt&gt; which calls &lt;tt&gt;PathParentIterator.forAll&lt;/tt&gt;. See codes from &lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.6.3/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeper.java#L627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.6.3&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.7.0/zookeeper-server/src/main/java/org/apache/zookeeper/ZKWatchManager.java#L450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.7+&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13469082">ZOOKEEPER-4565</key>
            <summary>Config watch path get truncated abnormally and fail chroot zookeeper client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kezhuw">Kezhu Wang</assignee>
                                    <reporter username="kezhuw">Kezhu Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 29 Jun 2022 11:06:30 +0000</created>
                <updated>Fri, 4 Aug 2023 11:28:32 +0000</updated>
                            <resolved>Tue, 26 Jul 2022 07:40:22 +0000</resolved>
                                    <version>3.6.3</version>
                    <version>3.8.0</version>
                    <version>3.7.1</version>
                                    <fixVersion>3.9.0</fixVersion>
                    <fixVersion>3.8.1</fixVersion>
                    <fixVersion>3.7.2</fixVersion>
                                    <component>java client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17567771" author="kezhuw" created="Mon, 18 Jul 2022 01:59:09 +0000"  >&lt;p&gt;I presented a possible solution in &lt;a href=&quot;https://github.com/apache/zookeeper/pull/1899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pr#1899&lt;/a&gt;. But I think there are subtle situations that we should aware of. What happen if the chroot is &quot;/zookeeper&quot; ?&lt;/p&gt;

&lt;p&gt;The currently behaviors(pr#1899 keeps this) is that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Both &lt;tt&gt;getData&lt;/tt&gt; and &lt;tt&gt;getConfig&lt;/tt&gt; will issue event with path &quot;/config&quot; for &quot;/zookeeper/config&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It sounds a bit surprising that &lt;tt&gt;getConfig&lt;/tt&gt; behaves different due to chroot. Personally, I prefer to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;getConfig&lt;/tt&gt; always get events with path &quot;/zookeeper/config&quot;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;getData&lt;/tt&gt; and others get events with path stripped by chroot.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think we chould intercept &lt;tt&gt;watcher&lt;/tt&gt; in &lt;tt&gt;getConfig&lt;/tt&gt; to achieve this.&lt;/p&gt;

&lt;p&gt;But this might be a breaking change to old behavior though probably not by design.&lt;/p&gt;

&lt;p&gt;What do you think ? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eolivelli&quot; class=&quot;user-hover&quot; rel=&quot;eolivelli&quot;&gt;eolivelli&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maoling&quot; class=&quot;user-hover&quot; rel=&quot;maoling&quot;&gt;maoling&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Tison&quot; class=&quot;user-hover&quot; rel=&quot;tison&quot;&gt;Tison&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17571255" author="symat" created="Tue, 26 Jul 2022 07:40:22 +0000"  >&lt;p&gt;Issue resolved by pull request 1899&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1899&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13365962">CURATOR-593</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13395866">CURATOR-611</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12471300">ZOOKEEPER-838</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13473574">ZOOKEEPER-4601</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 16 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16gn4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>