<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3644] Data loss after upgrading standalone ZK server 3.4.14 to 3.5.6 with snapshot.trust.empty=true</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3644</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We have tried to upgrade single node &lt;b&gt;standalone&lt;/b&gt; ZK server from 3.4.14 to 3.5.6.&#160; There were no snapshot files, so as suggested in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3056&quot; title=&quot;Fails to load database with missing snapshot file but valid transaction log file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3056&quot;&gt;&lt;del&gt;ZOOKEEPER-3056&lt;/del&gt;&lt;/a&gt;, we have set snapshot.trust.empty to true. After server startup, when we tried to list the znodes, we found that znodes are missing.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start a single node ZK 3.4.14 server and create few znodes&lt;/li&gt;
	&lt;li&gt;Upgrade the server to 3.5.6 with&#160;&#160;snapshot.trust.empty=true config&lt;/li&gt;
	&lt;li&gt;try to list the znodes using zkShell&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Looking into the &lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.5.6/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;source code&lt;/a&gt;, looks like we are not reading transaction log if there are no snapshot files and snapshot.trust.empty is set to true.&lt;/p&gt;

&lt;p&gt;ZK 3.5.6 logs:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,007&amp;#93;&lt;/span&gt; INFO Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /var/lib/zookeeper/version-2 snapdir /var/lib/zookeeper/version-2&lt;br/&gt;
 &#160;(org.apache.zookeeper.server.ZooKeeperServer)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,012&amp;#93;&lt;/span&gt; INFO Using org.apache.zookeeper.server.NIOServerCnxnFactory as server connection factory (org.apache.zookeeper.server.ServerCnxnFactory)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,014&amp;#93;&lt;/span&gt; INFO Configuring NIO connection handler with 10s sessionless connection timeout, 1 selector thread(s), 12 worker threads, and 64 kB direct buffers. (org.apache&lt;br/&gt;
 .zookeeper.server.NIOServerCnxnFactory)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,017&amp;#93;&lt;/span&gt; INFO binding to port&#160;&lt;a href=&quot;http://0.0.0.0/0.0.0.0:2181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;0.0.0.0/0.0.0.0:2181&lt;/a&gt;&#160;(org.apache.zookeeper.server.NIOServerCnxnFactory)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,027&amp;#93;&lt;/span&gt; INFO zookeeper.snapshotSizeFactor = 0.33 (org.apache.zookeeper.server.ZKDatabase)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,029&amp;#93;&lt;/span&gt; DEBUG Created new input stream /var/lib/zookeeper/version-2/log.1 (org.apache.zookeeper.server.persistence.FileTxnLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,031&amp;#93;&lt;/span&gt; DEBUG Created new input archive /var/lib/zookeeper/version-2/log.1 (org.apache.zookeeper.server.persistence.FileTxnLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,035&amp;#93;&lt;/span&gt; DEBUG EOF exception java.io.EOFException: Failed to read /var/lib/zookeeper/version-2/log.1 (org.apache.zookeeper.server.persistence.FileTxnLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,035&amp;#93;&lt;/span&gt; WARN No snapshot found, but there are log entries. This should only be allowed during upgrading. (org.apache.zookeeper.server.persistence.FileTxnSnapLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,035&amp;#93;&lt;/span&gt; INFO Snapshotting: 0x0 to /var/lib/zookeeper/version-2/snapshot.0 (org.apache.zookeeper.server.persistence.FileTxnSnapLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,036&amp;#93;&lt;/span&gt; INFO Snapshotting: 0x0 to /var/lib/zookeeper/version-2/snapshot.0 (org.apache.zookeeper.server.persistence.FileTxnSnapLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:13:35,050&amp;#93;&lt;/span&gt; INFO Using checkIntervalMs=60000 maxPerMinute=10000 (org.apache.zookeeper.server.ContainerManager)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,137&amp;#93;&lt;/span&gt; DEBUG Accepted socket connection from /&lt;a href=&quot;http://127.0.0.1:38888/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;127.0.0.1:38888&lt;/a&gt;&#160;(org.apache.zookeeper.server.NIOServerCnxnFactory)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,144&amp;#93;&lt;/span&gt; DEBUG Session establishment request from client /&lt;a href=&quot;http://127.0.0.1:38888/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;127.0.0.1:38888&lt;/a&gt;&#160;client&apos;s lastZxid is 0x0 (org.apache.zookeeper.server.ZooKeeperServer)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,145&amp;#93;&lt;/span&gt; DEBUG Adding session 0x100006e15fb0000 (org.apache.zookeeper.server.SessionTrackerImpl)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,148&amp;#93;&lt;/span&gt; TRACE SessionTrackerImpl &#8212; Adding session 0x100006e15fb0000 30000 (org.apache.zookeeper.server.SessionTrackerImpl)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,149&amp;#93;&lt;/span&gt; DEBUG Client attempting to establish new session: session = 0x100006e15fb0000, zxid = 0x0, timeout = 30000, address = /&lt;a href=&quot;http://127.0.0.1:38888/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;127.0.0.1:38888&lt;/a&gt;&#160;(org.apache.zookeeper.server.ZooKeeperServer)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,155&amp;#93;&lt;/span&gt; TRACE :Psessionid:0x100006e15fb0000 type:createSession cxid:0x0 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a (org.apache.zookeeper.server.PrepRequestProcessor)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,155&amp;#93;&lt;/span&gt; TRACE SessionTrackerImpl &#8212; Existing session 0x100006e15fb0000 30000 (org.apache.zookeeper.server.SessionTrackerImpl)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,155&amp;#93;&lt;/span&gt; INFO Creating new log file: log.1 (org.apache.zookeeper.server.persistence.FileTxnLog)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2019-12-07 12:15:07,170&amp;#93;&lt;/span&gt; DEBUG Processing request:: sessionid:0x100006e15fb0000 type:createSession cxid:0x0 zxid:0x1 txntype:-10 reqpath:n/a (org.apache.zookeeper.server.FinalRequestProcessor)&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13273647">ZOOKEEPER-3644</key>
            <summary>Data loss after upgrading standalone ZK server 3.4.14 to 3.5.6 with snapshot.trust.empty=true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hanm">Michael Han</assignee>
                                    <reporter username="omkreddy">Manikumar</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 10 Dec 2019 15:38:07 +0000</created>
                <updated>Fri, 14 Feb 2020 15:23:44 +0000</updated>
                            <resolved>Sun, 5 Jan 2020 21:19:10 +0000</resolved>
                                    <version>3.5.6</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                    <fixVersion>3.5.7</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="8400">2h 20m</timespent>
                                <comments>
                            <comment id="16994034" author="hanm" created="Thu, 12 Dec 2019 01:09:41 +0000"  >&lt;p&gt;Thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt;. This should be a bug. After we skip the validation of the empty snapshot, we didn&apos;t replay the transactions which leads to the loss of the data. I&apos;ll try to put up a patch this week. &lt;/p&gt;

&lt;p&gt;Though, the data is not lost (provided the transaction logs are intact) - I believe if you restart your server after the upgrade finishes the data will be visible in the data tree, because after upgrade, when restarting we should have a valid snapshot file locally and ZK will hit a different code path which will actually load and replay the transactions. Still, it&apos;s not acceptable for end user and should be fixed, but could be used as a temp workaround.&lt;/p&gt;</comment>
                            <comment id="16997014" author="hadoopqa" created="Mon, 16 Dec 2019 06:40:49 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version ) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4295//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4295//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4295//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4295//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4295//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4295//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="17008423" author="andorm" created="Sun, 5 Jan 2020 21:19:10 +0000"  >&lt;p&gt;Issue resolved by pull request 1182&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1182&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13164196">ZOOKEEPER-3056</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09iyo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>