<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2959] ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2959</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Once the ZooKeeper cluster finishes the election for new leader, all learners report their accepted epoch to the leader for the computation of new cluster epoch.&lt;/p&gt;

&lt;p&gt;org.apache.zookeeper.server.quorum.Leader#getEpochToPropose&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; connectingFollowers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt;();
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; getEpochToPropose(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sid, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lastAcceptedEpoch) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException, IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(connectingFollowers) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!waitingForNewEpoch) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; epoch;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastAcceptedEpoch &amp;gt;= epoch) {
                epoch = lastAcceptedEpoch+1;
            }
            connectingFollowers.add(sid);
            QuorumVerifier verifier = self.getQuorumVerifier();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectingFollowers.contains(self.getId()) &amp;amp;&amp;amp;
                                            verifier.containsQuorum(connectingFollowers)) {
                waitingForNewEpoch = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                self.setAcceptedEpoch(epoch);
                connectingFollowers.notifyAll();
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; start = Time.currentElapsedTime();
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; cur = start;
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; end = start + self.getInitLimit()*self.getTickTime();
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(waitingForNewEpoch &amp;amp;&amp;amp; cur &amp;lt; end) {
                    connectingFollowers.wait(end - cur);
                    cur = Time.currentElapsedTime();
                }
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (waitingForNewEpoch) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InterruptedException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; epoch from quorum&quot;&lt;/span&gt;);
                }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; epoch;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The computation will get an outcome once :&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The leader has call method &quot;getEpochToPropose&quot;&lt;/li&gt;
	&lt;li&gt;The number of all reporters is greater than half of participants.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The problem is, an observer server will also send its accepted epoch to the leader, while this procedure treat observers as participants.&lt;/p&gt;

&lt;p&gt;Supposed that the cluster consists of 1 leader, 2 followers and 1 observer, and now the leader and the observer have reported their accepted epochs while neither of the followers has. Thus, the connectingFollowers set consists of two elements, resulting in a size of 2, which is greater than half quorum, namely, 2. Then QuorumVerifier#containsQuorum will return true, because it does not check whether the elements of the parameter are participants.&lt;/p&gt;

&lt;p&gt;The same flaw exists in org.apache.zookeeper.server.quorum.Leader#waitForEpochAck&lt;/p&gt;</description>
                <environment></environment>
        <key id="13126179">ZOOKEEPER-2959</key>
            <summary>ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bkanivets">Bogdan Kanivets</assignee>
                                    <reporter username="xiangyq000">xiangyq000</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 20 Dec 2017 06:46:38 +0000</created>
                <updated>Wed, 20 Mar 2019 00:26:47 +0000</updated>
                            <resolved>Thu, 10 May 2018 04:03:32 +0000</resolved>
                                    <version>3.4.10</version>
                    <version>3.5.3</version>
                                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.4.13</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="16306144" author="githubbot" created="Fri, 29 Dec 2017 09:20:06 +0000"  >&lt;p&gt;GitHub user xyq000 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;: ignore accepted epoch and ack from observers&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&lt;/a&gt;&lt;br/&gt;
    After a round of elections completes, followers and observers send their accepted epochs to the leader to determine a final epoch.&lt;br/&gt;
    Since `QuorumVerifier#containsQuorum(Set set)` does not check whether the elements of argument `set` exactly represent participants, this pull request is intended to ignore reported epochs and acks from observers for logical consistency.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/xyq000/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xyq000/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #438&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 647061aa7ba1182b83b44b7f2671508012a30b4c&lt;br/&gt;
Author: Yongqiang Xiang &amp;lt;xiangyongqiang@...&amp;gt;&lt;br/&gt;
Date:   2017-12-29T08:20:06Z&lt;/p&gt;

&lt;p&gt;    ignore accepted epoch and ack from observers&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16306154" author="hadoopqa" created="Fri, 29 Dec 2017 09:43:59 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +0 tests included.  The patch appears to be a documentation patch that doesn&apos;t require tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1391//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1391//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1391//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1391//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1391//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1391//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16316906" author="githubbot" created="Mon, 8 Jan 2018 19:56:39 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @xyq000 &lt;br/&gt;
    Thanks for the contribution. I think fixing this issues makes sense, would you please add at least one unit test to reproduce the problem?&lt;/p&gt;</comment>
                            <comment id="16317361" author="githubbot" created="Mon, 8 Jan 2018 23:45:58 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438#discussion_r160286100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438#discussion_r160286100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -1183,8 +1183,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 if (lastAcceptedEpoch &amp;gt;= epoch) &lt;/p&gt;
{
                     epoch = lastAcceptedEpoch+1;
                 }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;connectingFollowers.add(sid);&lt;br/&gt;
                 QuorumVerifier verifier = self.getQuorumVerifier();&lt;br/&gt;
    +            if(verifier.getVotingMembers().containsKey(sid)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I&apos;m wondering if this logic is best suited for the `QuorumVerifier`. In other words, the quorum verifier should be able to determine if a quorum is present from a set of ids while taking into account which sids represent voting members.&lt;/p&gt;</comment>
                            <comment id="16318513" author="githubbot" created="Tue, 9 Jan 2018 14:38:54 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438#discussion_r160422756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438#discussion_r160422756&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -1183,8 +1183,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 if (lastAcceptedEpoch &amp;gt;= epoch) &lt;/p&gt;
{
                     epoch = lastAcceptedEpoch+1;
                 }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;connectingFollowers.add(sid);&lt;br/&gt;
                 QuorumVerifier verifier = self.getQuorumVerifier();&lt;br/&gt;
    +            if(verifier.getVotingMembers().containsKey(sid)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +1&lt;/p&gt;</comment>
                            <comment id="16426533" author="githubbot" created="Thu, 5 Apr 2018 06:48:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438#discussion_r179363930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438#discussion_r179363930&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -1183,8 +1183,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 if (lastAcceptedEpoch &amp;gt;= epoch) &lt;/p&gt;
{
                     epoch = lastAcceptedEpoch+1;
                 }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;connectingFollowers.add(sid);&lt;br/&gt;
                 QuorumVerifier verifier = self.getQuorumVerifier();&lt;br/&gt;
    +            if(verifier.getVotingMembers().containsKey(sid)) 
{
    --- End diff --
    
    If I recall correctly, the reason this wasn&apos;t done are concerns around the impact on performance - containsQuorum is called every time an ACK is received for every operation proposal. So if you need 3 asks to commit an operation, we&apos;ll be doing these checks (figuring out who&apos;s a participant and who&apos;s not}
&lt;p&gt; for &lt;/p&gt;
{ACK1}
&lt;p&gt;, for &lt;/p&gt;
{ACK1, ACK2}
&lt;p&gt; and for &lt;/p&gt;
{ACK1, ACK2, ACK3}
&lt;p&gt;. This compared to comparing two ints as it stands now. So this is why it wasn&apos;t done...&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16427413" author="githubbot" created="Thu, 5 Apr 2018 18:29:00 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/438#discussion_r179558826&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/438#discussion_r179558826&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -1183,8 +1183,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 if (lastAcceptedEpoch &amp;gt;= epoch) &lt;/p&gt;
{
                     epoch = lastAcceptedEpoch+1;
                 }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;connectingFollowers.add(sid);&lt;br/&gt;
                 QuorumVerifier verifier = self.getQuorumVerifier();&lt;br/&gt;
    +            if(verifier.getVotingMembers().containsKey(sid)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +1 makes sense.&lt;/p&gt;</comment>
                            <comment id="16429690" author="githubbot" created="Sun, 8 Apr 2018 09:05:09 +0000"  >&lt;p&gt;GitHub user lavacat opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;: ignore accepted epoch and LEADERINFO ack from observers&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add getVotingView check for id in getEpochToPropose and waitForEpochAck&lt;/li&gt;
	&lt;li&gt;refactor waitForNewLeaderAck to use getVotingView&lt;/li&gt;
	&lt;li&gt;unit tests&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    credit: Xiang Yongqiang (&lt;a href=&quot;https://github.com/xyq000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xyq000&lt;/a&gt;) for original PR and reporting the issue&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/lavacat/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lavacat/zookeeper&lt;/a&gt; branch-3.4&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #500&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 98c40dac60951c61b3b1922d0038461d81b843a1&lt;br/&gt;
Author: Bogdan Kanivets &amp;lt;bkanivets@...&amp;gt;&lt;br/&gt;
Date:   2018-04-08T08:46:37Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;: ignore accepted epoch and LEADERINFO ack from observers&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add getVotingView check for id in getEpochToPropose and waitForEpochAck&lt;/li&gt;
	&lt;li&gt;refactor waitForNewLeaderAck to use getVotingView&lt;/li&gt;
	&lt;li&gt;unit tests&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    credit: Xiang Yongqiang (&lt;a href=&quot;https://github.com/xyq000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xyq000&lt;/a&gt;) for original PR and reporting the issue&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16429801" author="githubbot" created="Sun, 8 Apr 2018 16:30:32 +0000"  >&lt;p&gt;Github user shralex commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;m +1. Thanks Bogdan for making the PR.&lt;/p&gt;</comment>
                            <comment id="16434910" author="githubbot" created="Thu, 12 Apr 2018 04:17:19 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r180793047&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r180793047&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -245,6 +245,180 @@ public void testLastAcceptedEpoch() throws Exception &lt;/p&gt;
{
                 recursiveDelete(tmpDir);
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test&lt;br/&gt;
    +    public void testGetEpochToProposeWithObserver() throws Exception {&lt;br/&gt;
    +        File tmpDir = File.createTempFile(&quot;test&quot;, &quot;dir&quot;, testData);&lt;br/&gt;
    +        tmpDir.delete();&lt;br/&gt;
    +        tmpDir.mkdir();&lt;br/&gt;
    +        Leader leader = null;&lt;br/&gt;
    +        try {&lt;br/&gt;
    +            QuorumPeer peer = createQuorumPeer(tmpDir);&lt;br/&gt;
    +            long participantId = 1;&lt;br/&gt;
    +            long observerId = peer.quorumPeers.size();&lt;br/&gt;
    +            peer.quorumPeers.put(observerId, new QuorumServer(observerId, &quot;0.0.0.0&quot;, 33225,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think to be consistent with `createQuorumPeer()` method this should be something like:&lt;br/&gt;
    ```&lt;br/&gt;
    peers.put(observerId, new QuorumServer(observerId, new InetSocketAddress(&quot;127.0.0.1&quot;, PortAssignment.unique()), &lt;br/&gt;
                   new InetSocketAddress(&quot;127.0.0.1&quot;, PortAssignment.unique()),&lt;br/&gt;
                   new InetSocketAddress(&quot;127.0.0.1&quot;, PortAssignment.unique()),&lt;br/&gt;
                   QuorumPeer.LearnerType.OBSERVER));&lt;br/&gt;
    ```&lt;/p&gt;
</comment>
                            <comment id="16434911" author="githubbot" created="Thu, 12 Apr 2018 04:17:19 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r180789703&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r180789703&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -245,6 +245,180 @@ public void testLastAcceptedEpoch() throws Exception &lt;/p&gt;
{
                 recursiveDelete(tmpDir);
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test&lt;br/&gt;
    +    public void testGetEpochToProposeWithObserver() throws Exception {&lt;br/&gt;
    +        File tmpDir = File.createTempFile(&quot;test&quot;, &quot;dir&quot;, testData);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Have you considered using ClientBase.createEmptyTestDir() instead?&lt;/p&gt;</comment>
                            <comment id="16434923" author="githubbot" created="Thu, 12 Apr 2018 04:46:21 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Given that this change affects leader election I think it&apos;d be very beneficial if @fpj could take a look by any chance.&lt;/p&gt;</comment>
                            <comment id="16435149" author="githubbot" created="Thu, 12 Apr 2018 08:27:28 +0000"  >&lt;p&gt;Github user lavacat commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181001854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181001854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -245,6 +245,180 @@ public void testLastAcceptedEpoch() throws Exception &lt;/p&gt;
{
                 recursiveDelete(tmpDir);
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test&lt;br/&gt;
    +    public void testGetEpochToProposeWithObserver() throws Exception {&lt;br/&gt;
    +        File tmpDir = File.createTempFile(&quot;test&quot;, &quot;dir&quot;, testData);&lt;br/&gt;
    +        tmpDir.delete();&lt;br/&gt;
    +        tmpDir.mkdir();&lt;br/&gt;
    +        Leader leader = null;&lt;br/&gt;
    +        try {&lt;br/&gt;
    +            QuorumPeer peer = createQuorumPeer(tmpDir);&lt;br/&gt;
    +            long participantId = 1;&lt;br/&gt;
    +            long observerId = peer.quorumPeers.size();&lt;br/&gt;
    +            peer.quorumPeers.put(observerId, new QuorumServer(observerId, &quot;0.0.0.0&quot;, 33225,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Do you mean using PortAssignment.unique() and &quot;127.0.0.1&quot;? Changed it.&lt;/p&gt;</comment>
                            <comment id="16435153" author="githubbot" created="Thu, 12 Apr 2018 08:28:42 +0000"  >&lt;p&gt;Github user lavacat commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181002193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181002193&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -245,6 +245,180 @@ public void testLastAcceptedEpoch() throws Exception &lt;/p&gt;
{
                 recursiveDelete(tmpDir);
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test&lt;br/&gt;
    +    public void testGetEpochToProposeWithObserver() throws Exception {&lt;br/&gt;
    +        File tmpDir = File.createTempFile(&quot;test&quot;, &quot;dir&quot;, testData);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Refactored&lt;/p&gt;</comment>
                            <comment id="16435154" author="githubbot" created="Thu, 12 Apr 2018 08:31:48 +0000"  >&lt;p&gt;Github user lavacat commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Moved these 3 new tests into new class - LeaderWithObserverTest. Had to make createLeader and createQuorumPeer &apos;public static&apos; in Zab1_0Test. Happy to refactor into common base class&lt;/p&gt;</comment>
                            <comment id="16435177" author="githubbot" created="Thu, 12 Apr 2018 08:53:22 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @lavacat I think either moving these methods/classes to a base class or creating a separate `ZabUtils` makes sense in this case to get cleaner code.&lt;/p&gt;</comment>
                            <comment id="16436644" author="githubbot" created="Fri, 13 Apr 2018 01:21:43 +0000"  >&lt;p&gt;Github user lavacat commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @anmolnar added ZabUtils&lt;/p&gt;</comment>
                            <comment id="16438510" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181266640&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181266640&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ZabUtils.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,140 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxn;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZKDatabase;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.FileOutputStream;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.lang.reflect.Field;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +&lt;br/&gt;
    +public class ZabUtils {&lt;br/&gt;
    +    public static final int SYNC_LIMIT = 2;&lt;br/&gt;
    +&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If this is a helper class that doesn&apos;t require instantiation then create a private constructor: this makes it &quot;final&quot; and prevents instantiation.&lt;/p&gt;</comment>
                            <comment id="16438511" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181564082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181564082&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ZabUtils.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,140 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxn;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZKDatabase;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.FileOutputStream;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.lang.reflect.Field;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +&lt;br/&gt;
    +public class ZabUtils {&lt;br/&gt;
    +    public static final int SYNC_LIMIT = 2;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static QuorumPeer createQuorumPeer(File tmpDir) throws IOException&lt;/p&gt;
{
    +        QuorumPeer peer = new QuorumPeer();
    +        peer.syncLimit = 2;
    +        peer.initLimit = 2;
    +        peer.tickTime = 2000;
    +        peer.quorumPeers = new HashMap&amp;lt;Long, QuorumPeer.QuorumServer&amp;gt;();
    +        peer.quorumPeers.put(0L, new QuorumPeer.QuorumServer(0, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));
    +        peer.quorumPeers.put(1L, new QuorumPeer.QuorumServer(1, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));
    +        peer.quorumPeers.put(2L, new QuorumPeer.QuorumServer(2, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));
    +        peer.setQuorumVerifier(new QuorumMaj(peer.quorumPeers.size()));
    +        peer.setCnxnFactory(new NullServerCnxnFactory());
    +        File version2 = new File(tmpDir, &quot;version-2&quot;);
    +        version2.mkdir();
    +        FileOutputStream fos;
    +        fos = new FileOutputStream(new File(version2, &quot;currentEpoch&quot;));
    +        fos.write(&quot;0\n&quot;.getBytes());
    +        fos.close();
    +        fos = new FileOutputStream(new File(version2, &quot;acceptedEpoch&quot;));
    +        fos.write(&quot;0\n&quot;.getBytes());
    +        fos.close();
    +        return peer;
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    public static Leader createLeader(File tmpDir, QuorumPeer peer)&lt;br/&gt;
    +            throws IOException, NoSuchFieldException, IllegalAccessException&lt;/p&gt;
{
    +        LeaderZooKeeperServer zk = prepareLeader(tmpDir, peer);
    +        return new Leader(peer, zk);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    public static MockLeader createMockLeader(File tmpDir, QuorumPeer peer)&lt;br/&gt;
    +            throws IOException, NoSuchFieldException, IllegalAccessException&lt;/p&gt;
{
    +        LeaderZooKeeperServer zk = prepareLeader(tmpDir, peer);
    +        return new MockLeader(peer, zk);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private static LeaderZooKeeperServer prepareLeader(File tmpDir, QuorumPeer peer)&lt;br/&gt;
    +            throws IOException, NoSuchFieldException, IllegalAccessException &lt;/p&gt;
{
    +        FileTxnSnapLog logFactory = new FileTxnSnapLog(tmpDir, tmpDir);
    +        peer.setTxnFactory(logFactory);
    +        Field addrField = peer.getClass().getDeclaredField(&quot;myQuorumAddr&quot;);
    +        addrField.setAccessible(true);
    +        addrField.set(peer, new InetSocketAddress(PortAssignment.unique()));
    +        ZKDatabase zkDb = new ZKDatabase(logFactory);
    +        return new LeaderZooKeeperServer(logFactory, peer, new ZooKeeperServer.BasicDataTreeBuilder(), zkDb);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private static final class NullServerCnxnFactory extends ServerCnxnFactory {&lt;br/&gt;
    +        public void startup(ZooKeeperServer zkServer) throws IOException,&lt;br/&gt;
    +                InterruptedException &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public void start() {    +        }
&lt;p&gt;    +        public void shutdown() &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public void setMaxClientCnxnsPerHost(int max) {    +        }
&lt;p&gt;    +        public void join() throws InterruptedException &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public int getMaxClientCnxnsPerHost() {
    +            return 0;
    +        }&lt;br/&gt;
    +        public int getLocalPort() {    +            return 0;    +        }&lt;br/&gt;
    +        public InetSocketAddress getLocalAddress() {
    +            return null;
    +        }&lt;br/&gt;
    +        public Iterable&amp;lt;ServerCnxn&amp;gt; getConnections() {    +            return null;    +        }&lt;br/&gt;
    +        public void configure(InetSocketAddress addr, int maxClientCnxns)&lt;br/&gt;
    +                throws IOException {    +        }
&lt;p&gt;    +        public void closeSession(long sessionId) &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public void closeAll() {    +        }
&lt;p&gt;    +        @Override&lt;br/&gt;
    +        public int getNumAliveConnections() &lt;/p&gt;
{
    +            return 0;
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static final class MockLeader extends Leader {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `private` ?&lt;/p&gt;</comment>
                            <comment id="16438512" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181267252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181267252&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -161,8 +127,8 @@ public void testLeaderInConnectingFollowers() throws Exception {&lt;br/&gt;
             tmpDir.mkdir();&lt;br/&gt;
             Leader leader = null;&lt;br/&gt;
             try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;QuorumPeer peer = createQuorumPeer(tmpDir);&lt;/li&gt;
	&lt;li&gt;leader = createLeader(tmpDir, peer);&lt;br/&gt;
    +            QuorumPeer peer = ZabUtils.createQuorumPeer(tmpDir);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `import static org.apache.zookeeper.server.quorum. ZabUtil.*` then you can simplify method invocation by using `createQuorumPeer(tmpDir);` instead of `ZabUtils.createQuorumPeer(tmpDir);`&lt;/p&gt;</comment>
                            <comment id="16438514" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181267836&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181267836&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -868,8 +868,8 @@ synchronized public long startForwarding(LearnerHandler handler,&lt;/p&gt;

&lt;p&gt;             return lastProposed;&lt;br/&gt;
         }&lt;br/&gt;
    -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private HashSet&amp;lt;Long&amp;gt; connectingFollowers = new HashSet&amp;lt;Long&amp;gt;();&lt;br/&gt;
    +    // VisibleForTesting&lt;br/&gt;
    +    protected HashSet&amp;lt;Long&amp;gt; connectingFollowers = new HashSet&amp;lt;Long&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `protected Set&amp;lt;Long&amp;gt; connectingFollowers = new HashSet&amp;lt;&amp;gt;();`&lt;/p&gt;

</comment>
                            <comment id="16438513" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181268803&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181268803&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ZabUtils.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,140 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxn;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZKDatabase;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.FileOutputStream;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.lang.reflect.Field;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +&lt;br/&gt;
    +public class ZabUtils {&lt;br/&gt;
    +    public static final int SYNC_LIMIT = 2;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static QuorumPeer createQuorumPeer(File tmpDir) throws IOException{&lt;br/&gt;
    +        QuorumPeer peer = new QuorumPeer();&lt;br/&gt;
    +        peer.syncLimit = 2;&lt;br/&gt;
    +        peer.initLimit = 2;&lt;br/&gt;
    +        peer.tickTime = 2000;&lt;br/&gt;
    +        peer.quorumPeers = new HashMap&amp;lt;Long, QuorumPeer.QuorumServer&amp;gt;();&lt;br/&gt;
    +        peer.quorumPeers.put(0L, new QuorumPeer.QuorumServer(0, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));&lt;br/&gt;
    +        peer.quorumPeers.put(1L, new QuorumPeer.QuorumServer(1, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));&lt;br/&gt;
    +        peer.quorumPeers.put(2L, new QuorumPeer.QuorumServer(2, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));&lt;br/&gt;
    +        peer.setQuorumVerifier(new QuorumMaj(peer.quorumPeers.size()));&lt;br/&gt;
    +        peer.setCnxnFactory(new NullServerCnxnFactory());&lt;br/&gt;
    +        File version2 = new File(tmpDir, &quot;version-2&quot;);&lt;br/&gt;
    +        version2.mkdir();&lt;br/&gt;
    +        FileOutputStream fos;&lt;br/&gt;
    +        fos = new FileOutputStream(new File(version2, &quot;currentEpoch&quot;));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Could join lines 52 and 53.&lt;/p&gt;</comment>
                            <comment id="16438515" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181564184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181564184&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -916,7 +919,9 @@ public void waitForEpochAck(long id, StateSummary ss) throws IOException, Interr&lt;br/&gt;
                                                         + leaderStateSummary.getLastZxid()&lt;br/&gt;
                                                         + &quot; (last zxid)&quot;);&lt;br/&gt;
                     }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;electingFollowers.add(id);&lt;br/&gt;
    +                if (self.getVotingView().containsKey(id)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would suggest to encapsulate the `self.getVotingView().containsKey(id)` into a private method as below, if nothing else, for the sake of readability&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    private boolean isParticipant(long sid) &lt;/p&gt;
{
       return self.getVotingView().containsKey(id);
    }
&lt;p&gt;    ```&lt;/p&gt;</comment>
                            <comment id="16438516" author="githubbot" created="Sat, 14 Apr 2018 21:38:34 +0000"  >&lt;p&gt;Github user eribeiro commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r181267704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r181267704&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -900,9 +902,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 return epoch;&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
    -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private HashSet&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;Long&amp;gt;();&lt;/li&gt;
	&lt;li&gt;private boolean electionFinished = false;&lt;br/&gt;
    +    // VisibleForTesting&lt;br/&gt;
    +    protected HashSet&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;Long&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `protected Set&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;&amp;gt;()`&lt;/p&gt;</comment>
                            <comment id="16441069" author="githubbot" created="Tue, 17 Apr 2018 15:50:56 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r182128913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r182128913&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -161,8 +127,8 @@ public void testLeaderInConnectingFollowers() throws Exception {&lt;br/&gt;
             tmpDir.mkdir();&lt;br/&gt;
             Leader leader = null;&lt;br/&gt;
             try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;QuorumPeer peer = createQuorumPeer(tmpDir);&lt;/li&gt;
	&lt;li&gt;leader = createLeader(tmpDir, peer);&lt;br/&gt;
    +            QuorumPeer peer = ZabUtils.createQuorumPeer(tmpDir);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Agreed, but please don&apos;t use asterisk &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; import. We avoid wildcard imports in Zk project.&lt;/p&gt;</comment>
                            <comment id="16441297" author="githubbot" created="Tue, 17 Apr 2018 18:22:59 +0000"  >&lt;p&gt;Github user edwardoliveira commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r182180406&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r182180406&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -161,8 +127,8 @@ public void testLeaderInConnectingFollowers() throws Exception {&lt;br/&gt;
             tmpDir.mkdir();&lt;br/&gt;
             Leader leader = null;&lt;br/&gt;
             try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;QuorumPeer peer = createQuorumPeer(tmpDir);&lt;/li&gt;
	&lt;li&gt;leader = createLeader(tmpDir, peer);&lt;br/&gt;
    +            QuorumPeer peer = ZabUtils.createQuorumPeer(tmpDir);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yup, you right. Sorry about that. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16444818" author="githubbot" created="Thu, 19 Apr 2018 21:19:02 +0000"  >&lt;p&gt;Github user lavacat commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r182887771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r182887771&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ZabUtils.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,140 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxn;&lt;br/&gt;
    +import org.apache.zookeeper.server.ServerCnxnFactory;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZKDatabase;&lt;br/&gt;
    +import org.apache.zookeeper.server.ZooKeeperServer;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.File;&lt;br/&gt;
    +import java.io.FileOutputStream;&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.lang.reflect.Field;&lt;br/&gt;
    +import java.net.InetSocketAddress;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +&lt;br/&gt;
    +public class ZabUtils {&lt;br/&gt;
    +    public static final int SYNC_LIMIT = 2;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static QuorumPeer createQuorumPeer(File tmpDir) throws IOException&lt;/p&gt;
{
    +        QuorumPeer peer = new QuorumPeer();
    +        peer.syncLimit = 2;
    +        peer.initLimit = 2;
    +        peer.tickTime = 2000;
    +        peer.quorumPeers = new HashMap&amp;lt;Long, QuorumPeer.QuorumServer&amp;gt;();
    +        peer.quorumPeers.put(0L, new QuorumPeer.QuorumServer(0, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));
    +        peer.quorumPeers.put(1L, new QuorumPeer.QuorumServer(1, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));
    +        peer.quorumPeers.put(2L, new QuorumPeer.QuorumServer(2, &quot;127.0.0.1&quot;, PortAssignment.unique(), 0, null));
    +        peer.setQuorumVerifier(new QuorumMaj(peer.quorumPeers.size()));
    +        peer.setCnxnFactory(new NullServerCnxnFactory());
    +        File version2 = new File(tmpDir, &quot;version-2&quot;);
    +        version2.mkdir();
    +        FileOutputStream fos;
    +        fos = new FileOutputStream(new File(version2, &quot;currentEpoch&quot;));
    +        fos.write(&quot;0\n&quot;.getBytes());
    +        fos.close();
    +        fos = new FileOutputStream(new File(version2, &quot;acceptedEpoch&quot;));
    +        fos.write(&quot;0\n&quot;.getBytes());
    +        fos.close();
    +        return peer;
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    public static Leader createLeader(File tmpDir, QuorumPeer peer)&lt;br/&gt;
    +            throws IOException, NoSuchFieldException, IllegalAccessException&lt;/p&gt;
{
    +        LeaderZooKeeperServer zk = prepareLeader(tmpDir, peer);
    +        return new Leader(peer, zk);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    public static MockLeader createMockLeader(File tmpDir, QuorumPeer peer)&lt;br/&gt;
    +            throws IOException, NoSuchFieldException, IllegalAccessException&lt;/p&gt;
{
    +        LeaderZooKeeperServer zk = prepareLeader(tmpDir, peer);
    +        return new MockLeader(peer, zk);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private static LeaderZooKeeperServer prepareLeader(File tmpDir, QuorumPeer peer)&lt;br/&gt;
    +            throws IOException, NoSuchFieldException, IllegalAccessException &lt;/p&gt;
{
    +        FileTxnSnapLog logFactory = new FileTxnSnapLog(tmpDir, tmpDir);
    +        peer.setTxnFactory(logFactory);
    +        Field addrField = peer.getClass().getDeclaredField(&quot;myQuorumAddr&quot;);
    +        addrField.setAccessible(true);
    +        addrField.set(peer, new InetSocketAddress(PortAssignment.unique()));
    +        ZKDatabase zkDb = new ZKDatabase(logFactory);
    +        return new LeaderZooKeeperServer(logFactory, peer, new ZooKeeperServer.BasicDataTreeBuilder(), zkDb);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private static final class NullServerCnxnFactory extends ServerCnxnFactory {&lt;br/&gt;
    +        public void startup(ZooKeeperServer zkServer) throws IOException,&lt;br/&gt;
    +                InterruptedException &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public void start() {    +        }
&lt;p&gt;    +        public void shutdown() &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public void setMaxClientCnxnsPerHost(int max) {    +        }
&lt;p&gt;    +        public void join() throws InterruptedException &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public int getMaxClientCnxnsPerHost() {
    +            return 0;
    +        }&lt;br/&gt;
    +        public int getLocalPort() {    +            return 0;    +        }&lt;br/&gt;
    +        public InetSocketAddress getLocalAddress() {
    +            return null;
    +        }&lt;br/&gt;
    +        public Iterable&amp;lt;ServerCnxn&amp;gt; getConnections() {    +            return null;    +        }&lt;br/&gt;
    +        public void configure(InetSocketAddress addr, int maxClientCnxns)&lt;br/&gt;
    +                throws IOException {    +        }
&lt;p&gt;    +        public void closeSession(long sessionId) &lt;/p&gt;
{
    +        }&lt;br/&gt;
    +        public void closeAll() {    +        }
&lt;p&gt;    +        @Override&lt;br/&gt;
    +        public int getNumAliveConnections() &lt;/p&gt;
{
    +            return 0;
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static final class MockLeader extends Leader {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can&apos;t make it private, this class is still used in Zab1_0Test&lt;/p&gt;</comment>
                            <comment id="16444826" author="githubbot" created="Thu, 19 Apr 2018 21:24:25 +0000"  >&lt;p&gt;Github user lavacat commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r182889043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r182889043&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -900,9 +902,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 return epoch;&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
    -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private HashSet&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;Long&amp;gt;();&lt;/li&gt;
	&lt;li&gt;private boolean electionFinished = false;&lt;br/&gt;
    +    // VisibleForTesting&lt;br/&gt;
    +    protected HashSet&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;Long&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Can&apos;t use Set, because QuorumVerifier uses HashSet param. &lt;br/&gt;
    QuorumVerifier.containsQuorum(HashSet&amp;lt;Long&amp;gt; set);&lt;/p&gt;

&lt;p&gt;    I can refactor it all, but then I&apos;ll need to touch QuorumVerifier.java, QuorumMaj.java and QuorumHierarchical.java&lt;/p&gt;</comment>
                            <comment id="16444884" author="hadoopqa" created="Thu, 19 Apr 2018 22:10:09 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1604//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1604//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1604//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1604//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1604//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1604//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16445056" author="githubbot" created="Fri, 20 Apr 2018 00:49:24 +0000"  >&lt;p&gt;Github user lavacat commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/500#discussion_r182922147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/500#discussion_r182922147&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -900,9 +902,10 @@ public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws Interrupt&lt;br/&gt;
                 return epoch;&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
    -&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private HashSet&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;Long&amp;gt;();&lt;/li&gt;
	&lt;li&gt;private boolean electionFinished = false;&lt;br/&gt;
    +    // VisibleForTesting&lt;br/&gt;
    +    protected HashSet&amp;lt;Long&amp;gt; electingFollowers = new HashSet&amp;lt;Long&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    updated&lt;/p&gt;</comment>
                            <comment id="16445063" author="githubbot" created="Fri, 20 Apr 2018 00:59:29 +0000"  >&lt;p&gt;GitHub user lavacat opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/503&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;: ignore accepted epoch and LEADERINFO ack from observers&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added getVotingMembers check for id in getEpochToPropose and waitForEpochAck&lt;/li&gt;
	&lt;li&gt;removed unused learnerType param in waitForNewLeaderAck&lt;/li&gt;
	&lt;li&gt;unit tests&lt;/li&gt;
	&lt;li&gt;refactored common test helpers into ZabUtils&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    credit: Xiang Yongqiang (&lt;a href=&quot;https://github.com/xyq000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xyq000&lt;/a&gt;) for original PR and reporting the issue&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/lavacat/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lavacat/zookeeper&lt;/a&gt; branch-3.5&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/503.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/503.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #503&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d7181d65f66adcfc0fecda2670580e2d2b8ddccb&lt;br/&gt;
Author: Bogdan Kanivets &amp;lt;bkanivets@...&amp;gt;&lt;br/&gt;
Date:   2018-04-20T00:02:59Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;: ignore accepted epoch and LEADERINFO ack from observers&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added getVotingMembers check for id in getEpochToPropose and waitForEpochAck&lt;/li&gt;
	&lt;li&gt;removed unused learnerType param in waitForNewLeaderAck&lt;/li&gt;
	&lt;li&gt;unit tests&lt;/li&gt;
	&lt;li&gt;refactored common test helpers into ZabUtils&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    credit: Xiang Yongqiang (&lt;a href=&quot;https://github.com/xyq000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xyq000&lt;/a&gt;) for original PR and reporting the issue&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16445066" author="hadoopqa" created="Fri, 20 Apr 2018 01:04:53 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    -1 contrib tests.  The patch failed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1605//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1605//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1605//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1605//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1605//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1605//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16445067" author="hadoopqa" created="Fri, 20 Apr 2018 01:04:59 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1606//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1606//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1606//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1606//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1606//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1606//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16446678" author="hadoopqa" created="Sat, 21 Apr 2018 08:09:55 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1610//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1610//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1610//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1610//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1610//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1610//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16447661" author="hadoopqa" created="Mon, 23 Apr 2018 07:14:41 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1619//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1619//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1619//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1619//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1619//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1619//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16457266" author="hadoopqa" created="Sat, 28 Apr 2018 00:56:09 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1646//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1646//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1646//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1646//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1646//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1646//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16459482" author="hadoopqa" created="Tue, 1 May 2018 06:37:38 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1658//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1658//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1658//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1658//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1658//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1658//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16467905" author="hadoopqa" created="Tue, 8 May 2018 20:04:09 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1664//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1664//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1664//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1664//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1664//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1664//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16469516" author="bkanivets" created="Wed, 9 May 2018 21:13:40 +0000"  >&lt;p&gt;I think this is ready to merge. There are 3 PRs for 3.4, 3.5 and master.&lt;/p&gt;

&lt;p&gt;Steps to reproduce the bug:&lt;/p&gt;

&lt;p&gt;Start with 3 servers. Config:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
clientPort=2181
leaderServes=yes
server.1=&amp;lt;server.1-ip&amp;gt;:2888:3888
server.2=&amp;lt;server.2-ip&amp;gt;:2888:3888
server.3=&amp;lt;server.3-ip&amp;gt;:2888:3888:observer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;On server.2 block follower port from server.1 to server.2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sudo iptables -A INPUT -s &amp;lt;server.1-ip&amp;gt; -p tcp --destination-port 2888 -j DROP&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Start server.1, server.2 and server.3&lt;br/&gt;
Wait for server.2 to declare itself a leader and then fail in waitForNewLeaderAck&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-04-16 20:56:25,990 [myid:2] - INFO [QuorumPeer[myid=2]/0:0:0:0:0:0:0:0:2181:Leader@361] - LEADING - LEADER ELECTION TOOK - 3903
2018-04-16 20:56:27,275 [myid:2] - INFO [LearnerHandler-/&amp;lt;server.3-ip&amp;gt;:29223:LearnerHandler@329] - Follower sid: 3 : info : org.apache.zookeeper.server.quorum.QuorumPeer$QuorumServer@136ca5bc
2018-04-16 20:56:27,281 [myid:2] - INFO [LearnerHandler-/&amp;lt;server.3-ip&amp;gt;:29223:LearnerHandler@384] - Synchronizing with Follower sid: 3 maxCommittedLog=0x0 minCommittedLog=0x0 peerLastZxid=0x0
2018-04-16 20:56:27,281 [myid:2] - INFO [LearnerHandler-/&amp;lt;server.3-ip&amp;gt;:29223:LearnerHandler@393] - leader and follower are in sync, zxid=0x0
2018-04-16 20:56:27,282 [myid:2] - INFO [LearnerHandler-/&amp;lt;server.3-ip&amp;gt;:29223:LearnerHandler@458] - Sending DIFF
2018-04-16 20:56:27,291 [myid:2] - INFO [LearnerHandler-/&amp;lt;server.3-ip&amp;gt;:29223:LearnerHandler@518] - Received NEWLEADER-ACK message from 3
2018-04-16 20:56:47,283 [myid:2] - INFO [QuorumPeer[myid=2]/0:0:0:0:0:0:0:0:2181:Leader@502] - Shutting down
2018-04-16 20:56:47,284 [myid:2] - INFO [QuorumPeer[myid=2]/0:0:0:0:0:0:0:0:2181:Leader@508] - Shutdown called
java.lang.Exception: shutdown Leader! reason: Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a quorum of followers, only synced with sids: [ 2 ]
at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:508)
at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:406)
at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:859)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On server.2 check that currentEpoch is incremented in currentEpoch file. This is the bug. Epoch is incremented in getEpochToPropose because server.3 is counted in connectingFollowers.&lt;/p&gt;</comment>
                            <comment id="16469973" author="hudson" created="Thu, 10 May 2018 06:28:08 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #18 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/18/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/18/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2959&quot; title=&quot;ignore accepted epoch and LEADERINFO ack from observers when a newly elected leader computes new epoch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2959&quot;&gt;&lt;del&gt;ZOOKEEPER-2959&lt;/del&gt;&lt;/a&gt;: ignore accepted epoch and LEADERINFO ack from observers (ashraer: rev 088dfdf188663f6bad79b0e87b710737b318537d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/quorum/ZabUtils.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/quorum/LeaderWithObserverTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16474807" author="hadoopqa" created="Mon, 14 May 2018 21:13:10 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1684//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1684//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1684//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1684//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1684//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1684//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3o43b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>