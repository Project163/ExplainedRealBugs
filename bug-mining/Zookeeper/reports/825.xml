<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:00:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2355] Ephemeral node is never deleted if follower fails while reading the proposal packet</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2355</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;ZooKeeper ephemeral node is never deleted if follower fail while reading the proposal packet&lt;br/&gt;
The scenario is as follows:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Configure three node ZooKeeper cluster, lets say nodes are A, B and C, start all, assume A is leader, B and C are follower&lt;/li&gt;
	&lt;li&gt;Connect to any of the server and create ephemeral node /e1&lt;/li&gt;
	&lt;li&gt;Close the session, ephemeral node /e1 will go for deletion&lt;/li&gt;
	&lt;li&gt;While receiving delete proposal make Follower B to fail with &lt;tt&gt;SocketTimeoutException&lt;/tt&gt;. This we need to do to reproduce the scenario otherwise in production environment it happens because of network fault.&lt;/li&gt;
	&lt;li&gt;Remove the fault, just check that faulted Follower is now connected with quorum&lt;/li&gt;
	&lt;li&gt;Connect to any of the server, create the same ephemeral node /e1, created is success.&lt;/li&gt;
	&lt;li&gt;Close the session,  ephemeral node /e1 will go for deletion&lt;/li&gt;
	&lt;li&gt;&lt;font color=&quot;red&quot;&gt;/e1 is not deleted from the faulted Follower B, It should have been deleted as it was again created with another session&lt;/font&gt;&lt;/li&gt;
	&lt;li&gt;&lt;font color=&quot;green&quot;&gt;/e1 is deleted from Leader A and other Follower C&lt;/font&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12932170">ZOOKEEPER-2355</key>
            <summary>Ephemeral node is never deleted if follower fails while reading the proposal packet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arshad.mohammad">Mohammad Arshad</assignee>
                                    <reporter username="arshad.mohammad">Mohammad Arshad</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jan 2016 14:54:29 +0000</created>
                <updated>Fri, 23 Jul 2021 13:06:00 +0000</updated>
                            <resolved>Thu, 3 Aug 2017 15:58:24 +0000</resolved>
                                    <version>3.4.8</version>
                    <version>3.4.9</version>
                    <version>3.4.10</version>
                    <version>3.5.1</version>
                    <version>3.5.2</version>
                    <version>3.5.3</version>
                                    <fixVersion>3.4.11</fixVersion>
                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>quorum</component>
                    <component>server</component>
                        <due></due>
                            <votes>12</votes>
                                    <watches>22</watches>
                                                                                                                                                            <comments>
                            <comment id="15105390" author="arshad.mohammad" created="Mon, 18 Jan 2016 14:59:14 +0000"  >&lt;p&gt;At step 6, while creating the ephemeral node /e1  following error is observed at faulted node B but after adjusting the parent c version it continues and user does not get any error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-01-18 20:17:47,928 [myid:3] - DEBUG [CommitProcWorkThread-1:DataTree@961] - Failed: 72279218071011328,5,8589934597,1453128465886,1
:&lt;span class=&quot;code-quote&quot;&gt;&apos;/e1,,v{s{31,s{&apos;&lt;/span&gt;world,&apos;anyone}}},T,2

org.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists
	at org.apache.zookeeper.server.DataTree.createNode(DataTree.java:514)
	at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:827)
	at org.apache.zookeeper.server.ZKDatabase.processTxn(ZKDatabase.java:401)
	at org.apache.zookeeper.server.ZooKeeperServer.processTxn(ZooKeeperServer.java:1216)
	at org.apache.zookeeper.server.ZooKeeperServer.processTxn(ZooKeeperServer.java:1207)
	at org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:109)
	at org.apache.zookeeper.server.quorum.CommitProcessor$CommitWorkRequest.doWork(CommitProcessor.java:296)
	at org.apache.zookeeper.server.WorkerService$ScheduledWorkRequest.run(WorkerService.java:162)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
2016-01-18 20:17:50,378 [myid:3] - DEBUG [CommitProcWorkThread-1:DataTree@1003] - Adjusting parent cversion &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Txn: 1 path:/e1 err: -110
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15105413" author="arshad.mohammad" created="Mon, 18 Jan 2016 15:15:33 +0000"  >&lt;p&gt;In think following points to be analysed to figure out the root cause,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When faulted server B joins the quorum after recovery, why still it has the extra node /e1, why not synchronized with the current leader.&lt;/li&gt;
	&lt;li&gt;Why only C version updated, why not the other information like ephemeral owner etc.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Submitting a test patch &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;-01.patch for reproducing the scenario.&lt;/p&gt;</comment>
                            <comment id="15105415" author="arshad.mohammad" created="Mon, 18 Jan 2016 15:17:09 +0000"  >&lt;p&gt;test patch&lt;/p&gt;</comment>
                            <comment id="15105914" author="marshall" created="Mon, 18 Jan 2016 22:43:40 +0000"  >&lt;p&gt;I wonder if this is the same issue described in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2145&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2145&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15106037" author="rgs" created="Tue, 19 Jan 2016 00:42:15 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; - reviewing it now.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;: if this bug is confirmed, do we want to include in 3.4.8? (probably yes)&lt;/p&gt;</comment>
                            <comment id="15106050" author="rgs" created="Tue, 19 Jan 2016 00:57:57 +0000"  >&lt;p&gt;Well, the bug is apparently confirmed (I read the test case, it makes sense to me). Unclear on what the fix is. I&apos;d definitely like to have this for 3.4.8. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;: a few nits:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;there&apos;s a typo in the filename for EphemralNodeNotDeletedTest.java&lt;/li&gt;
	&lt;li&gt;there are few extra (unneeded) tabs in QuorumPeerTestBase.java (you can see them with git diff)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other than that, the test looks great - thanks! &lt;/p&gt;</comment>
                            <comment id="15106060" author="eribeiro" created="Tue, 19 Jan 2016 01:05:46 +0000"  >&lt;p&gt;Very good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;! My two cents*:&lt;/p&gt;

&lt;p&gt;Other typo:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stat firstEphemralNode = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Stat();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PS: have been absent for a loooong time, coming back now, cheers! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15106062" author="eribeiro" created="Tue, 19 Jan 2016 01:07:26 +0000"  >&lt;p&gt;oops, in fact, &quot;&lt;tt&gt;ephemral&lt;/tt&gt;&quot; is repeated across the text.&lt;/p&gt;</comment>
                            <comment id="15106073" author="eribeiro" created="Tue, 19 Jan 2016 01:15:28 +0000"  >&lt;p&gt;Also, if the reason to add a &lt;tt&gt;QuorumPeer#getZkDb()&lt;/tt&gt; is to use it in &lt;tt&gt;CustomPeer#makeFollower&lt;/tt&gt; then *&lt;b&gt;I&lt;/b&gt;* would advise to make this method *&lt;b&gt;protected&lt;/b&gt;* instead of *&lt;b&gt;public&lt;/b&gt;* as &lt;tt&gt;CustomPeer&lt;/tt&gt; extends &lt;tt&gt;QuorumPeer&lt;/tt&gt;. Making it public is too much exposition (imho) just to make a test run. A protected method is more conservative (again, imho).&lt;/p&gt;</comment>
                            <comment id="15116752" author="fpj" created="Tue, 26 Jan 2016 05:59:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; could you have a look at the txn logs (using log formatter) and see what is in there in the situation you describe above?&lt;/p&gt;</comment>
                            <comment id="15116850" author="arshad.mohammad" created="Tue, 26 Jan 2016 07:19:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, I checked the transaction log and snapshot, both do not have entry for the failed transaction.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Because actual transaction proposal failed, it is expected that failed transaction will not be in the transaction log&lt;/li&gt;
	&lt;li&gt;While receiving the diff from leader, again proposal got failed, that is why no entry in snapshot also.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15116868" author="arshad.mohammad" created="Tue, 26 Jan 2016 07:38:30 +0000"  >&lt;p&gt;The lastProcessedZxid is getting updated even proposal failed. So next time follower sends this updated zxid and getting blank DIFF. This is the root cause why sync is not happening. &lt;/p&gt;

&lt;p&gt;Don&apos;t know why lastProcessedZxid is updated here &lt;a href=&quot;https://github.com/arshadmohammad/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java#L398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Learner.java#L398&lt;/a&gt;.&lt;br/&gt;
as the data received still not presisted in case of DIFF.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, what is your thought on this&lt;/p&gt;</comment>
                            <comment id="15123912" author="rgs" created="Fri, 29 Jan 2016 18:21:05 +0000"  >&lt;p&gt;Per discussion in the mailing list, lets punt this to 3.4.9.&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15124029" author="arshad.mohammad" created="Fri, 29 Jan 2016 19:20:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eribeiro&quot; class=&quot;user-hover&quot; rel=&quot;eribeiro&quot;&gt;eribeiro&lt;/a&gt; for your review comments on test code.&lt;br/&gt;
Submitting the solution. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; please have a look&lt;/p&gt;</comment>
                            <comment id="15124088" author="hadoopqa" created="Fri, 29 Jan 2016 19:52:22 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15316819" author="makuchta" created="Mon, 6 Jun 2016 17:30:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;I&apos;m looking into fixing this since I&apos;m seeing the same issue. I understand the reasoning behind your fix, but it seems to be causing some other tests to fail consistently when applied to trunk. The Jenkins build is too old to view, but I&apos;m guessing it failed for similar reasons. Were you seeing these failures and did you look at what was happening? I&apos;ve only scratched the surface with investigating this bug and your patch, but I wanted to check to avoid repeating any work you had already done. I&apos;ll keep investigating to see if I can find a solution.&lt;/p&gt;

&lt;p&gt;Failures listed below:&lt;/p&gt;

&lt;p&gt;Zab1_0Test:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Testcase: testNormalFollowerRun took 4.198 sec
    FAILED
expected:&amp;lt;4294967297&amp;gt; but was:&amp;lt;4294967296&amp;gt;
junit.framework.AssertionFailedError: expected:&amp;lt;4294967297&amp;gt; but was:&amp;lt;4294967296&amp;gt;
    at org.apache.zookeeper.server.quorum.Zab1_0Test$4.converseWithFollower(Zab1_0Test.java:705)
    at org.apache.zookeeper.server.quorum.Zab1_0Test.testFollowerConversation(Zab1_0Test.java:511)
    at org.apache.zookeeper.server.quorum.Zab1_0Test.testNormalFollowerRun(Zab1_0Test.java:643)
    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)

Testcase: testNormalFollowerRunWithDiff took 4.073 sec
    FAILED
expected:&amp;lt;4294967298&amp;gt; but was:&amp;lt;4294967296&amp;gt;
junit.framework.AssertionFailedError: expected:&amp;lt;4294967298&amp;gt; but was:&amp;lt;4294967296&amp;gt;
    at org.apache.zookeeper.server.quorum.Zab1_0Test$5.converseWithFollower(Zab1_0Test.java:847)
    at org.apache.zookeeper.server.quorum.Zab1_0Test.testFollowerConversation(Zab1_0Test.java:511)
    at org.apache.zookeeper.server.quorum.Zab1_0Test.testNormalFollowerRunWithDiff(Zab1_0Test.java:771)
    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)

Testcase: testNormalObserverRun took 4.054 sec
    FAILED
expected:&amp;lt;4294967298&amp;gt; but was:&amp;lt;4294967296&amp;gt;
junit.framework.AssertionFailedError: expected:&amp;lt;4294967298&amp;gt; but was:&amp;lt;4294967296&amp;gt;
    at org.apache.zookeeper.server.quorum.Zab1_0Test$8.converseWithObserver(Zab1_0Test.java:1072)
    at org.apache.zookeeper.server.quorum.Zab1_0Test.testObserverConversation(Zab1_0Test.java:562)
    at org.apache.zookeeper.server.quorum.Zab1_0Test.testNormalObserverRun(Zab1_0Test.java:997)
    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ZxidRolloverTest:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Testcase: testRolloverThenFollowerRestart took 23.677 sec
    Caused an ERROR
KeeperErrorCode = ConnectionLoss for /foofoofoo-connected
org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /foofoofoo-connected
    at org.apache.zookeeper.KeeperException.create(KeeperException.java:99)
    at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)
    at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1846)
    at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1874)
    at org.apache.zookeeper.server.ZxidRolloverTest.checkClientConnected(ZxidRolloverTest.java:119)
    at org.apache.zookeeper.server.ZxidRolloverTest.checkClientsConnected(ZxidRolloverTest.java:90)
    at org.apache.zookeeper.server.ZxidRolloverTest.start(ZxidRolloverTest.java:165)
    at org.apache.zookeeper.server.ZxidRolloverTest.testRolloverThenFollowerRestart(ZxidRolloverTest.java:345)
    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;WatchEventWhenAutoResetTest:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Testcase: testNodeChildrenChanged took 0.001 sec
    Caused an ERROR
Timeout occurred. Please note the time in the report does not reflect the time until the timeout.
junit.framework.AssertionFailedError: Timeout occurred. Please note the time in the report does not reflect the time until the timeout.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15316897" author="hadoopqa" created="Mon, 6 Jun 2016 18:04:48 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1746511.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15321334" author="makuchta" created="Wed, 8 Jun 2016 19:59:33 +0000"  >&lt;p&gt;I&apos;ve been playing with some variations on the proposed fix and trying to reason about what&apos;s actually going wrong. When syncing with the leader, of the three leader responses (DIFF, SNAP, TRUNC), I think there&apos;s only an issue with setting the last processed ZXID the way it&apos;s currently done in the DIFF case. In the SNAP and TRUNC cases, we&apos;ve already deserialized the snapshot or truncated the log by the time setLastProcessedZxid is called. In the DIFF case, the reason it&apos;s incorrect is because we&apos;re setting the last processed ZXID as if we&apos;ve already committed all the transactions we&apos;re about to receive, so a failure before that actually happens leaves us in an inconsistent state.&lt;/p&gt;

&lt;p&gt;The logic in the patch of moving the call to setLastProcessedZxid to when the follower receives UPTODATE or NEWLEADER makes sense to me, but this isn&apos;t consistent with the behavior expected by some of the other unit tests.&lt;/p&gt;

&lt;p&gt;I don&apos;t think setLastProcessedZxid needs to be explicitly called at all when the follower receives a DIFF message because we will update the last processed ZXID as we commit transactions received from the leader anyway. I do think it needs to be preserved as-is for SNAP and TRUNC to keep the currently expected behavior. Whether there are other problematic scenarios associated with how SNAP and TRUNC are processed can be investigated separately since there may still be cases where the last processed ZXID and the actual transaction log state are out of sync.&lt;/p&gt;

&lt;p&gt;I&apos;m submitting a modified version of the patch provided by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;. The patch includes his original unit test which still fails against trunk and passes with the patch, but the changes to Learner.java are the slightly different ones that I&apos;m proposing.&lt;/p&gt;

&lt;p&gt;(I do have two unit tests failing locally that are also failing against trunk, so I think it&apos;s an unrelated issue with my environment that I&apos;ll need to look into when I get time. If that turns out to not be the case based on the Jenkins build, I&apos;ll investigate.)&lt;/p&gt;</comment>
                            <comment id="15321366" author="marshall" created="Wed, 8 Jun 2016 20:18:52 +0000"  >&lt;p&gt;Martin is unable to attach patches to Jiras for some reason. So I&apos;m going to help him out and cancel the existing patch and upload a new patch.&lt;/p&gt;</comment>
                            <comment id="15321369" author="marshall" created="Wed, 8 Jun 2016 20:20:04 +0000"  >&lt;p&gt;Updated patch with Martin&apos;s proposed solution.&lt;/p&gt;</comment>
                            <comment id="15321401" author="hadoopqa" created="Wed, 8 Jun 2016 20:37:27 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1747408.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15321410" author="marshall" created="Wed, 8 Jun 2016 20:41:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=makuchta&quot; class=&quot;user-hover&quot; rel=&quot;makuchta&quot;&gt;makuchta&lt;/a&gt; - I&apos;ll leave you to investigate the failure reported above.&lt;/p&gt;</comment>
                            <comment id="15321459" author="makuchta" created="Wed, 8 Jun 2016 21:17:00 +0000"  >&lt;p&gt;A search for the new test failures shows them as known flaky tests (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1806&quot; title=&quot;testCurrentServersAreObserversInNextConfig failing frequently on trunk with non-jdk6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1806&quot;&gt;&lt;del&gt;ZOOKEEPER-1806&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1807&quot; title=&quot;Observers spam each other creating connections to the election addr&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1807&quot;&gt;&lt;del&gt;ZOOKEEPER-1807&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2137&quot; title=&quot;Make testPortChange() less flaky&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2137&quot;&gt;&lt;del&gt;ZOOKEEPER-2137&lt;/del&gt;&lt;/a&gt;), and they seem far removed from anything this patch touches. I haven&apos;t seen them at all locally.&lt;/p&gt;
</comment>
                            <comment id="15329621" author="fpj" created="Tue, 14 Jun 2016 14:59:35 +0000"  >&lt;p&gt;Do we need a patch for 3.5 and trunk as well, or is it an issue only in the 3.4 branch?&lt;/p&gt;</comment>
                            <comment id="15329856" author="fpj" created="Tue, 14 Jun 2016 16:45:53 +0000"  >&lt;p&gt;I had a look at the latest patch and the solution sounds sensible. The patch doesn&apos;t apply to the 3.4, which is the one that this issue to be fixed in. I believe the issue exists in both 3.5 and trunk as well.&lt;/p&gt;

&lt;p&gt;I also liked the way the error was injected here. It&apos;d be nice to have a more general and structured way of doing it so that we could use in other scenarios too. It is not a blocker for this patch, but really one of those &quot;nice to have&quot; features for my todo list.&lt;/p&gt;</comment>
                            <comment id="15399696" author="rakeshr" created="Fri, 29 Jul 2016 17:09:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=makuchta&quot; class=&quot;user-hover&quot; rel=&quot;makuchta&quot;&gt;makuchta&lt;/a&gt; for working on this issue. The patch looks overall good. I&apos;ve few comments:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Good test case. I could see an existing &lt;tt&gt;class MockTestQPMain&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/test/org/apache/zookeeper/server/quorum/RaceConditionTest.java#L235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RaceConditionTest.java&lt;/a&gt;, can we reuse the same. One idea is to move MockTestQPMain class to a separate java file.&lt;/li&gt;
	&lt;li&gt;Can we include &lt;tt&gt;qp.getZxid()&lt;/tt&gt; in the below log message.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Getting a snapshot from leader&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15414746" author="rgs" created="Wed, 10 Aug 2016 05:40:49 +0000"  >&lt;p&gt;One small nit, these two methods:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; QuorumPeer getLeader(MainThread[] mt) {
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = mt.length - 1; i &amp;gt;= 0; i--) {
+            QuorumPeer quorumPeer = mt[i].getQuorumPeer();
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != quorumPeer &amp;amp;&amp;amp; ServerState.LEADING == quorumPeer.getPeerState()) {
+                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; quorumPeer;
+            }
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+    }
+
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; QuorumPeer getFollower(MainThread[] mt) {
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = mt.length - 1; i &amp;gt;= 0; i--) {
+            QuorumPeer quorumPeer = mt[i].getQuorumPeer();
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != quorumPeer &amp;amp;&amp;amp; ServerState.FOLLOWING == quorumPeer.getPeerState()) {
+                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; quorumPeer;
+            }
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can probably be reduced to one more general method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; QuorumPeer getByServerState(MainThread[] mt, ServerState state) {
+        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = mt.length - 1; i &amp;gt;= 0; i--) {
+            QuorumPeer quorumPeer = mt[i].getQuorumPeer();
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != quorumPeer &amp;amp;&amp;amp; state == quorumPeer.getPeerState()) {
+                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; quorumPeer;
+            }
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="15422903" author="rakeshr" created="Tue, 16 Aug 2016 15:38:41 +0000"  >&lt;p&gt;I am moving this out to 3.4.10 for now. Please feel free to discuss the target version, Thanks!&lt;/p&gt;</comment>
                            <comment id="15458720" author="randgalt" created="Fri, 2 Sep 2016 14:46:03 +0000"  >&lt;p&gt;We&apos;ve now experienced this at Elasticsearch. This is a Critical issue that should be released sooner rather than later.&lt;/p&gt;</comment>
                            <comment id="15458732" author="hadoopqa" created="Fri, 2 Sep 2016 14:49:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1757584.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3384//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3384//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15458926" author="fpj" created="Fri, 2 Sep 2016 16:10:03 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=makuchta&quot; class=&quot;user-hover&quot; rel=&quot;makuchta&quot;&gt;makuchta&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15459296" author="arshad.mohammad" created="Fri, 2 Sep 2016 18:54:20 +0000"  >&lt;ol&gt;
	&lt;li&gt;Submited &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;-04.patch . This patch is for branch-3.5 and trunk, After commit to  branch-3.5 and trunk i will prepare patch for branch-3.4&lt;/li&gt;
	&lt;li&gt;Handled comments by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, I got better way to inject QuorumPeer. Modified RaceConditionTest.java also. Now I think there is no need to move the mock  classed to different class as not much code duplication&lt;/li&gt;
	&lt;li&gt;Handled comments by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Reanamed test class and test method and other small improvments&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15459343" author="hadoopqa" created="Fri, 2 Sep 2016 19:09:36 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12826909/ZOOKEEPER-2355-04.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12826909/ZOOKEEPER-2355-04.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1757584.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15470796" author="randgalt" created="Wed, 7 Sep 2016 14:33:52 +0000"  >&lt;p&gt;This is a very serious bug for us at Elasticsearch. Is there any way to get an emergency release out for this?&lt;/p&gt;</comment>
                            <comment id="15470862" author="rakeshr" created="Wed, 7 Sep 2016 15:04:10 +0000"  >&lt;p&gt;I agree this is an important bug. Perhaps we could do thorough reviews and push the patch in so that make this fix ready for the next release, hopefully will include this in 3.4.10 version.&lt;/p&gt;</comment>
                            <comment id="15470968" author="randgalt" created="Wed, 7 Sep 2016 15:46:38 +0000"  >&lt;p&gt;FYI - We&apos;re on 3.5.x so that&apos;s needed as well&lt;/p&gt;</comment>
                            <comment id="15471012" author="rakeshr" created="Wed, 7 Sep 2016 16:04:01 +0000"  >&lt;p&gt;sure, while committing will target branches &lt;tt&gt;3.4&lt;/tt&gt;, &lt;tt&gt;3.5&lt;/tt&gt; and trunk.&lt;/p&gt;</comment>
                            <comment id="15568748" author="rakeshr" created="Wed, 12 Oct 2016 13:41:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, Can you check 2nd point in the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355?focusedCommentId=15399696&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15399696&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;review comment&lt;/a&gt;. I think logging &lt;tt&gt;last processed zxid&lt;/tt&gt; would help in debugging, right?&lt;/p&gt;</comment>
                            <comment id="15568820" author="rakeshr" created="Wed, 12 Oct 2016 14:05:31 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the patch. Just few comments, apart from this +1 from me.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Can you look at the 2nd point in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355?focusedCommentId=15399696&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15399696&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;review comment&lt;/a&gt;. I think logging &lt;tt&gt;last processed zxid&lt;/tt&gt; would help in debugging, right?&lt;/li&gt;
	&lt;li&gt;Move &lt;tt&gt;mt = new MainThread&lt;/tt&gt; this to the object reference like, 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; MainThread[] mt = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MainThread[SERVER_COUNT];&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then make the teardown section like, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @After
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void tearDown() {
        &lt;span class=&quot;code-comment&quot;&gt;// stop all severs
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; mt.length; i++) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (mt[i] != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    mt[i].shutdown();
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Quorum Peer interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; shutting it down&quot;&lt;/span&gt;, e);
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Close &lt;tt&gt;followerZK.close();&lt;/tt&gt; session at the end.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15572954" author="arshad.mohammad" created="Thu, 13 Oct 2016 19:41:18 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;,&lt;br/&gt;
Addressed all the comments, submitted new patch.&lt;/p&gt;</comment>
                            <comment id="15573023" author="hadoopqa" created="Thu, 13 Oct 2016 20:09:11 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision f78061aafb19b102c37cb6d744ec6258d5f5b66e.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15580148" author="rakeshr" created="Sun, 16 Oct 2016 15:42:06 +0000"  >&lt;p&gt;+1, latest patch looks good to me.&lt;/p&gt;

&lt;p&gt;ping  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, I will wait to see your votes before commits. Thanks!&lt;/p&gt;</comment>
                            <comment id="15676303" author="rakeshr" created="Fri, 18 Nov 2016 09:34:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;,  it is better to open a pull request for wider reviews. Could you make the PR, please?. Since this is a critical issue, it would be good to get one more +1 from a committer.&lt;/p&gt;</comment>
                            <comment id="15684421" author="githubbot" created="Mon, 21 Nov 2016 18:59:31 +0000"  >&lt;p&gt;GitHub user arshadmohammad opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;:Ephemeral node is never deleted if follower fails while reading the proposal packet&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;:Ephemeral node is never deleted if follower fails while reading the proposal packet&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/arshadmohammad/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/arshadmohammad/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #112&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e8b2b59758c755afedfec8d6ab87d3f7ca0a0ffe&lt;br/&gt;
Author: arshadmohammad &amp;lt;arshad.mohammad.k@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-11-21T18:29:33Z&lt;/p&gt;

&lt;p&gt;    Ephemeral node is never deleted if follower fails while reading the proposal packet&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15684464" author="hadoopqa" created="Mon, 21 Nov 2016 19:18:52 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 20 new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15837989" author="hadoopqa" created="Wed, 25 Jan 2017 16:09:34 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 8771ffdaacb87126a485ae740558f6a288ab980b.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3570//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3570//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16013446" author="fjcyue" created="Wed, 17 May 2017 03:02:31 +0000"  >&lt;p&gt;we saw this bug in 3.4.10, is there any schedule of fixing it in branch 3.4 ?&lt;/p&gt;</comment>
                            <comment id="16044155" author="jiangjiafu" created="Fri, 9 Jun 2017 08:40:55 +0000"  >&lt;p&gt;Can this bug be fixed in 3.4.11??? As I know the consistency is the most important property of ZooKeeper, so I think this bug has higher priority than many others. &lt;br/&gt;
Hope it can be fixed soon.&lt;/p&gt;</comment>
                            <comment id="16044196" author="rakeshr" created="Fri, 9 Jun 2017 09:19:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can this bug be fixed in 3.4.11???&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for the interest &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fjcyue&quot; class=&quot;user-hover&quot; rel=&quot;fjcyue&quot;&gt;fjcyue&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangjiafu&quot; class=&quot;user-hover&quot; rel=&quot;jiangjiafu&quot;&gt;jiangjiafu&lt;/a&gt;, will include this in 3.4.11, if there is no objection from anyone. Since the priority is critical, I&apos;d like to see one more +1 from a committer.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;, do you have some time to review this pull request and give your vote. Thanks!&lt;/p&gt;</comment>
                            <comment id="16044197" author="fpj" created="Fri, 9 Jun 2017 09:19:55 +0000"  >&lt;p&gt;It does look like a good candidate to be resolved soon. There is a patch available, but it seems to be stale. I also have had a look at it some time back, so I need to refresh my view.&lt;/p&gt;

&lt;p&gt;In any case, help is appreciated.&lt;/p&gt;</comment>
                            <comment id="16044225" author="rakeshr" created="Fri, 9 Jun 2017 09:42:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, I didn&apos;t see your comment, looks like we both commented at the same time&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thanks for pitches in.&lt;/p&gt;

&lt;p&gt;Yes, the &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR_112&lt;/a&gt; has to be rebased. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, would you mind rebasing the pull req.&lt;/p&gt;</comment>
                            <comment id="16045624" author="hadoopqa" created="Sat, 10 Jun 2017 17:34:56 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16048391" author="githubbot" created="Tue, 13 Jun 2017 20:52:38 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112#discussion_r121793647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112#discussion_r121793647&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -390,6 +391,7 @@ else if (qp.getType() == Leader.SNAP) &lt;/p&gt;
{
                                 + Long.toHexString(qp.getZxid()));
                         System.exit(13);
                     }
&lt;p&gt;    +                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The fix looks good to me.&lt;/p&gt;

&lt;p&gt;    I think we should also set the zxid extracted from the current proposal packet after each proposal is &lt;span class=&quot;error&quot;&gt;&amp;#91;committed&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/arshadmohammad/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/Learner.java#L460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/arshadmohammad/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/Learner.java#L460&lt;/a&gt;). Otherwise the follower will have a lagged view of the committed transactions, because with the fix in this patch, we will never do setlastProcessedZxid during a DIFF sync. For example imagine a case like this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Follower has its latest zxid with value a before DIFF SYNC happens.&lt;/li&gt;
	&lt;li&gt;Leader send over proposals with zxids value b, c, d.&lt;/li&gt;
	&lt;li&gt;Follower received and applied proposals b and c. Before follower had a chance to get hands on d, network partition happens.&lt;/li&gt;
	&lt;li&gt;Now partition healed, follower will do a DIFF think again. Because the zk database would not be reloaded from logs (it&apos;s already initialized), follower has a skewed view of the world - it thinks it only has tnx a, but in fact it has a, b, and c. So rather asking b, c, and d, the follower could just ask d.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Anyway I think it is an optimization that might worth doing - it is not functional critical because the idempotent nature of applying transactions.&lt;/p&gt;</comment>
                            <comment id="16048398" author="githubbot" created="Tue, 13 Jun 2017 21:00:22 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112#discussion_r121795494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112#discussion_r121795494&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,222 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertEquals;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;127.0.0.1:&quot;
    +                    + clientPorts[i];
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String currentQuorumCfgSection = sb.toString();&lt;br/&gt;
    +        // start all the servers&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, currentQuorumCfgSection,&lt;br/&gt;
    +                    false) {&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                public TestQPMain getTestQPMain() &lt;/p&gt;
{
    +                    return new MockTestQPMain();
    +                }
&lt;p&gt;    +            };&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // ensure all servers started&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts[i],
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        CountdownWatcher watch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;,&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        /**&lt;br/&gt;
    +         * now the problem scenario starts&lt;br/&gt;
    +         */&lt;br/&gt;
    +&lt;br/&gt;
    +        Stat firstEphemeralNode = new Stat();&lt;br/&gt;
    +&lt;br/&gt;
    +        // 1: create ephemeral node&lt;br/&gt;
    +        String nodePath = &quot;/e1&quot;;&lt;br/&gt;
    +        zk.create(nodePath, &quot;1&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,&lt;br/&gt;
    +                CreateMode.EPHEMERAL, firstEphemeralNode);&lt;br/&gt;
    +        assertEquals(&quot;Current session and ephemeral owner should be same&quot;,&lt;br/&gt;
    +                zk.getSessionId(), firstEphemeralNode.getEphemeralOwner());&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2: inject network problem in one of the follower&lt;br/&gt;
    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,&lt;br/&gt;
    +                ServerState.FOLLOWING);&lt;br/&gt;
    +        follower.setInjectError(true);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3: close the session so that ephemeral node is deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes the test case depends on these happened between starting of the partition (injected fault) and ending of the partition. The key invariant I see here is to make sure that during this period, the follower that currently disconnected with the quorum has gone through at least one leader election cycle and also have gone through at least one SYNC cycle. Otherwise the code path that this patch fixes will not be executed - i.e. there will be no errors during syncing the DIFF and everything will just work as expected. We need trigger at least one fault during the first DIFF sync cycle, and currently the test case is not doing this in a fine grained way and potentially due to timing issue we can get flaky behavior.&lt;/p&gt;

&lt;p&gt;    Though, I am not sure how to precisely control this - I think it will be a nice improvement in test case to explicitly control the behavior as i just said, but this should not block this patch landed.&lt;/p&gt;</comment>
                            <comment id="16048399" author="githubbot" created="Tue, 13 Jun 2017 21:01:08 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    lgtm overall, with one nit on a potential optimization we can do and one potential improvement on test case. &lt;/p&gt;</comment>
                            <comment id="16048411" author="hanm" created="Tue, 13 Jun 2017 21:12:46 +0000"  >&lt;p&gt;Just reviewed the patch, I think the key issue that this patch fixes is that each SYNC type should have transaction semantic around the &lt;tt&gt;setlastProcessedZxid&lt;/tt&gt; - otherwise we might end up with inconsistent view when errors happen during SYNC phase. Previously TRNC and SNAP has transaction semantic W.R.T &lt;tt&gt;setlastProcessedZxid&lt;/tt&gt; but DIFF does not. &lt;/p&gt;

&lt;p&gt;Patch looks good to me, though I am wondering what do you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; think about the optimization I mentioned in the git PR. In addition I had a comment about test case which &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangjiafu&quot; class=&quot;user-hover&quot; rel=&quot;jiangjiafu&quot;&gt;jiangjiafu&lt;/a&gt; also observed similar issue but I don&apos;t think that is a blocker.&lt;/p&gt;</comment>
                            <comment id="16070800" author="githubbot" created="Fri, 30 Jun 2017 22:24:59 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    If no objection I will commit this one soon given the interests and criticality of the fix.&lt;/p&gt;</comment>
                            <comment id="16071488" author="githubbot" created="Sun, 2 Jul 2017 04:15:16 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @hanm, Thanks for the heads up. I will give my feedback soon, in a day or two.&lt;/p&gt;</comment>
                            <comment id="16072263" author="githubbot" created="Mon, 3 Jul 2017 11:08:04 +0000"  >&lt;p&gt;Github user rakeshadr commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112#discussion_r125264767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112#discussion_r125264767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -390,6 +391,7 @@ else if (qp.getType() == Leader.SNAP) &lt;/p&gt;
{
                                 + Long.toHexString(qp.getZxid()));
                         System.exit(13);
                     }
&lt;p&gt;    +                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @hanm, Do we have any issue created to handle this case, if not please create one for tracking this change. Thanks!&lt;/p&gt;</comment>
                            <comment id="16072266" author="githubbot" created="Mon, 3 Jul 2017 11:10:23 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks Michael for pushing this long standing issue.&lt;/p&gt;

&lt;p&gt;    +1 from me, I&apos;m OK to commit this patch after creating an issue for the code changes suggested previously.&lt;/p&gt;</comment>
                            <comment id="16073123" author="githubbot" created="Tue, 4 Jul 2017 05:32:36 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112#discussion_r125391857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112#discussion_r125391857&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -390,6 +391,7 @@ else if (qp.getType() == Leader.SNAP) &lt;/p&gt;
{
                                 + Long.toHexString(qp.getZxid()));
                         System.exit(13);
                     }
&lt;p&gt;    +                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @rakeshadr Created &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2833&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2833&lt;/a&gt; to avoid this gets lost.&lt;/p&gt;</comment>
                            <comment id="16073124" author="githubbot" created="Tue, 4 Jul 2017 05:33:23 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rakeshadr Thanks for double check. Followed your suggestion created &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2833&quot; title=&quot;Keep the follower transaction up to date after the fix made in ZOOKEEPER-2355.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2833&quot;&gt;ZOOKEEPER-2833&lt;/a&gt; tracking the optimization work. I am merging this now.&lt;/p&gt;</comment>
                            <comment id="16073129" author="githubbot" created="Tue, 4 Jul 2017 05:40:26 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/112&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16073133" author="hanm" created="Tue, 4 Jul 2017 05:45:33 +0000"  >&lt;p&gt;Committed to master 69710181042a8c1f0461c1739b96171d88f2b126, 3.5: ca22b3db19371f6b0f5507b7dd80b283cddc7700.&lt;/p&gt;

&lt;p&gt;Pending resolve JIRA after committing to branch-3.4 - the current pull request has merge conflicts.&lt;/p&gt;</comment>
                            <comment id="16073217" author="hudson" created="Tue, 4 Jul 2017 07:09:21 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #3454 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3454/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3454/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;: Ephemeral node is never deleted if follower fails while (hanm: rev 69710181042a8c1f0461c1739b96171d88f2b126)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16075797" author="githubbot" created="Thu, 6 Jul 2017 02:05:44 +0000"  >&lt;p&gt;GitHub user hanm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;: Ephemeral node is never deleted if follower fails while reading the proposal packet.&lt;/p&gt;

&lt;p&gt;    This commit is a port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 from branch-3.5 to branch-3.4. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.&lt;/p&gt;

&lt;p&gt;    @arshadmohammad @rakeshadr Could you please review this to close the loop of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hanm/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanm/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #304&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 007e2b37f24907c03e4e28547756b91aea4f78d4&lt;br/&gt;
Author: Michael Han &amp;lt;hanm@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-07-05T21:23:58Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;: Ephemeral node is never deleted if follower fails while reading the proposal packet.&lt;/p&gt;

&lt;p&gt;    This commit is a back port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 on branch-3.5. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16075802" author="githubbot" created="Thu, 6 Jul 2017 02:13:22 +0000"  >&lt;p&gt;Github user asdf2014 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304#discussion_r125798526&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304#discussion_r125798526&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,219 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.security.sasl.SaslException;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = PortAssignment.unique();&lt;br/&gt;
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()&lt;br/&gt;
    +                    + &quot;:&quot; + PortAssignment.unique();&lt;br/&gt;
    +            sb.append(server + &quot;\n&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe use the following code style will be better.&lt;br/&gt;
    ```java&lt;br/&gt;
    sb.append(server).append(&quot;\n&quot;);&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16075804" author="githubbot" created="Thu, 6 Jul 2017 02:15:37 +0000"  >&lt;p&gt;Github user asdf2014 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304#discussion_r125798689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304#discussion_r125798689&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,219 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.security.sasl.SaslException;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique();
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String currentQuorumCfgSection = sb.toString();&lt;br/&gt;
    +        System.out.println(currentQuorumCfgSection);&lt;br/&gt;
    +        // start all the servers&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, currentQuorumCfgSection) {&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                public TestQPMain getTestQPMain() &lt;/p&gt;
{
    +                    return new MockTestQPMain();
    +                }
&lt;p&gt;    +            };&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // ensure all servers started&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts[i],
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        CountdownWatcher watch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;,&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        /**&lt;br/&gt;
    +         * now the problem scenario starts&lt;br/&gt;
    +         */&lt;br/&gt;
    +&lt;br/&gt;
    +        // 1: create ephemeral node&lt;br/&gt;
    +        String nodePath = &quot;/e1&quot;;&lt;br/&gt;
    +        zk.create(nodePath, &quot;1&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2: inject network problem in one of the follower&lt;br/&gt;
    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,&lt;br/&gt;
    +                ServerState.FOLLOWING);&lt;br/&gt;
    +        follower.setInjectError(true);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3: close the session so that ephemeral node is deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    +        // remove the error&lt;br/&gt;
    +        follower.setInjectError(false);&lt;br/&gt;
    +&lt;br/&gt;
    +        Assert.assertTrue(&quot;Faulted Follower should have joined quorum by now&quot;,&lt;br/&gt;
    +                ClientBase.waitForServerUp(&lt;br/&gt;
    +                        &quot;127.0.0.1:&quot; + follower.getClientPort(),&lt;br/&gt;
    +                        CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        QuorumPeer leader = getByServerState(mt, ServerState.LEADING);&lt;br/&gt;
    +        assertNotNull(&quot;Leader should not be null&quot;, leader);&lt;br/&gt;
    +        Assert.assertTrue(&quot;Leader must be running&quot;, ClientBase.waitForServerUp(&lt;br/&gt;
    +                &quot;127.0.0.1:&quot; + leader.getClientPort(), CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        watch = new CountdownWatcher();&lt;br/&gt;
    +        zk = new ZooKeeper(&quot;127.0.0.1:&quot; + leader.getClientPort(),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        Stat exists = zk.exists(nodePath, false);&lt;br/&gt;
    +        assertNull(&quot;Node must have been deleted from leader&quot;, exists);&lt;br/&gt;
    +&lt;br/&gt;
    +        CountdownWatcher followerWatch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper followerZK = new ZooKeeper(&lt;br/&gt;
    +                &quot;127.0.0.1:&quot; + follower.getClientPort(),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, followerWatch);&lt;br/&gt;
    +        followerWatch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +        Stat nodeAtFollower = followerZK.exists(nodePath, false);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Problem 1: Follower had one extra ephemeral node /e1&lt;br/&gt;
    +        assertNull(&quot;ephemeral node must not exist&quot;, nodeAtFollower);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Create the node with another session&lt;br/&gt;
    +        zk.create(nodePath, &quot;2&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);&lt;br/&gt;
    +&lt;br/&gt;
    +        // close the session and newly created ephemeral node should be deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    +        nodeAtFollower = followerZK.exists(nodePath, false);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Problem 2: Before fix, after session close the ephemeral node&lt;br/&gt;
    +        // was not getting deleted. But now after the fix after session close&lt;br/&gt;
    +        // ephemeral node is getting deleted.&lt;br/&gt;
    +        assertNull(&quot;After session close ephemeral node must be deleted&quot;,&lt;br/&gt;
    +                nodeAtFollower);&lt;br/&gt;
    +        followerZK.close();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @After&lt;br/&gt;
    +    public void tearDown() {&lt;br/&gt;
    +        // stop all severs&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; mt.length; i++) {&lt;br/&gt;
    +            try &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
    +                LOG.warn(&quot;Quorum Peer interrupted while shutting it down&quot;, e);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {&lt;br/&gt;
    +        for (int i = mt.length - 1; i &amp;gt;= 0; i--) {&lt;br/&gt;
    +            QuorumPeer quorumPeer = mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getQuorumPeer();&lt;br/&gt;
    +            if (null != quorumPeer &amp;amp;&amp;amp; state == quorumPeer.getPeerState()) &lt;/p&gt;
{
    +                return quorumPeer;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        return null;&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static class CustomQuorumPeer extends QuorumPeer  {&lt;br/&gt;
    +        private boolean injectError = false;&lt;br/&gt;
    +&lt;br/&gt;
    +        public CustomQuorumPeer() throws SaslException &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        protected Follower makeFollower(FileTxnSnapLog logFactory)&lt;br/&gt;
    +                throws IOException {&lt;br/&gt;
    +            return new Follower(this, new FollowerZooKeeperServer(logFactory,&lt;br/&gt;
    +                    this, null /&lt;b&gt;DataTreeBuilder is never used&lt;/b&gt;/,&lt;br/&gt;
    +                    this.getZkDb())) {&lt;br/&gt;
    +&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                void readPacket(QuorumPacket pp) throws IOException {&lt;br/&gt;
    +                    /**&lt;br/&gt;
    +                     * In real scenario got SocketTimeoutException while reading&lt;br/&gt;
    +                     * the packet from leader because of network problem, but&lt;br/&gt;
    +                     * here throwing SocketTimeoutException based on whether&lt;br/&gt;
    +                     * error is injected or not&lt;br/&gt;
    +                     */&lt;br/&gt;
    +                    super.readPacket(pp);&lt;br/&gt;
    +                    if (injectError &amp;amp;&amp;amp; pp.getType() == Leader.PROPOSAL) &lt;/p&gt;
{
    +                        String type = LearnerHandler.packetToString(pp);
    +                        throw new SocketTimeoutException(
    +                                &quot;Socket timeout while reading the packet for operation &quot;
    +                                        + type);
    +                    }
&lt;p&gt;    +                }&lt;br/&gt;
    +&lt;br/&gt;
    +            };&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void setInjectError(boolean injectError) &lt;/p&gt;
{
    +            this.injectError = injectError;
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static class MockTestQPMain extends TestQPMain {&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        protected QuorumPeer getQuorumPeer() throws SaslException &lt;/p&gt;
{
    +            return new CustomQuorumPeer();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +}&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Should add a new line for the end of file.&lt;/p&gt;</comment>
                            <comment id="16075825" author="hadoopqa" created="Thu, 6 Jul 2017 02:41:29 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16085152" author="githubbot" created="Thu, 13 Jul 2017 03:58:14 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304#discussion_r127123189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304#discussion_r127123189&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,219 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.security.sasl.SaslException;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = PortAssignment.unique();&lt;br/&gt;
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()&lt;br/&gt;
    +                    + &quot;:&quot; + PortAssignment.unique();&lt;br/&gt;
    +            sb.append(server + &quot;\n&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @asdf2014 Yes, I agree. Though I&apos;d prefer doing this in a separate JIRA as a refactoring task as it&apos;s used everywhere in tests. If you have time, you are more than welcome to file a JIRA and do the refactoring work (btw, sorry for lagging on reviewing your refactoring patches, we got many high priority JIRAs in the backlog that we want to get in first.).&lt;/p&gt;</comment>
                            <comment id="16085153" author="githubbot" created="Thu, 13 Jul 2017 03:58:31 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304#discussion_r127123221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304#discussion_r127123221&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,219 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.security.sasl.SaslException;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique();
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String currentQuorumCfgSection = sb.toString();&lt;br/&gt;
    +        System.out.println(currentQuorumCfgSection);&lt;br/&gt;
    +        // start all the servers&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, currentQuorumCfgSection) {&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                public TestQPMain getTestQPMain() &lt;/p&gt;
{
    +                    return new MockTestQPMain();
    +                }
&lt;p&gt;    +            };&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // ensure all servers started&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts[i],
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        CountdownWatcher watch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;,&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        /**&lt;br/&gt;
    +         * now the problem scenario starts&lt;br/&gt;
    +         */&lt;br/&gt;
    +&lt;br/&gt;
    +        // 1: create ephemeral node&lt;br/&gt;
    +        String nodePath = &quot;/e1&quot;;&lt;br/&gt;
    +        zk.create(nodePath, &quot;1&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2: inject network problem in one of the follower&lt;br/&gt;
    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,&lt;br/&gt;
    +                ServerState.FOLLOWING);&lt;br/&gt;
    +        follower.setInjectError(true);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3: close the session so that ephemeral node is deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    +        // remove the error&lt;br/&gt;
    +        follower.setInjectError(false);&lt;br/&gt;
    +&lt;br/&gt;
    +        Assert.assertTrue(&quot;Faulted Follower should have joined quorum by now&quot;,&lt;br/&gt;
    +                ClientBase.waitForServerUp(&lt;br/&gt;
    +                        &quot;127.0.0.1:&quot; + follower.getClientPort(),&lt;br/&gt;
    +                        CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        QuorumPeer leader = getByServerState(mt, ServerState.LEADING);&lt;br/&gt;
    +        assertNotNull(&quot;Leader should not be null&quot;, leader);&lt;br/&gt;
    +        Assert.assertTrue(&quot;Leader must be running&quot;, ClientBase.waitForServerUp(&lt;br/&gt;
    +                &quot;127.0.0.1:&quot; + leader.getClientPort(), CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        watch = new CountdownWatcher();&lt;br/&gt;
    +        zk = new ZooKeeper(&quot;127.0.0.1:&quot; + leader.getClientPort(),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        Stat exists = zk.exists(nodePath, false);&lt;br/&gt;
    +        assertNull(&quot;Node must have been deleted from leader&quot;, exists);&lt;br/&gt;
    +&lt;br/&gt;
    +        CountdownWatcher followerWatch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper followerZK = new ZooKeeper(&lt;br/&gt;
    +                &quot;127.0.0.1:&quot; + follower.getClientPort(),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, followerWatch);&lt;br/&gt;
    +        followerWatch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +        Stat nodeAtFollower = followerZK.exists(nodePath, false);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Problem 1: Follower had one extra ephemeral node /e1&lt;br/&gt;
    +        assertNull(&quot;ephemeral node must not exist&quot;, nodeAtFollower);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Create the node with another session&lt;br/&gt;
    +        zk.create(nodePath, &quot;2&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);&lt;br/&gt;
    +&lt;br/&gt;
    +        // close the session and newly created ephemeral node should be deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    +        nodeAtFollower = followerZK.exists(nodePath, false);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Problem 2: Before fix, after session close the ephemeral node&lt;br/&gt;
    +        // was not getting deleted. But now after the fix after session close&lt;br/&gt;
    +        // ephemeral node is getting deleted.&lt;br/&gt;
    +        assertNull(&quot;After session close ephemeral node must be deleted&quot;,&lt;br/&gt;
    +                nodeAtFollower);&lt;br/&gt;
    +        followerZK.close();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @After&lt;br/&gt;
    +    public void tearDown() {&lt;br/&gt;
    +        // stop all severs&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; mt.length; i++) {&lt;br/&gt;
    +            try &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
    +                LOG.warn(&quot;Quorum Peer interrupted while shutting it down&quot;, e);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {&lt;br/&gt;
    +        for (int i = mt.length - 1; i &amp;gt;= 0; i--) {&lt;br/&gt;
    +            QuorumPeer quorumPeer = mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getQuorumPeer();&lt;br/&gt;
    +            if (null != quorumPeer &amp;amp;&amp;amp; state == quorumPeer.getPeerState()) &lt;/p&gt;
{
    +                return quorumPeer;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        return null;&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static class CustomQuorumPeer extends QuorumPeer  {&lt;br/&gt;
    +        private boolean injectError = false;&lt;br/&gt;
    +&lt;br/&gt;
    +        public CustomQuorumPeer() throws SaslException &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        protected Follower makeFollower(FileTxnSnapLog logFactory)&lt;br/&gt;
    +                throws IOException {&lt;br/&gt;
    +            return new Follower(this, new FollowerZooKeeperServer(logFactory,&lt;br/&gt;
    +                    this, null /&lt;b&gt;DataTreeBuilder is never used&lt;/b&gt;/,&lt;br/&gt;
    +                    this.getZkDb())) {&lt;br/&gt;
    +&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                void readPacket(QuorumPacket pp) throws IOException {&lt;br/&gt;
    +                    /**&lt;br/&gt;
    +                     * In real scenario got SocketTimeoutException while reading&lt;br/&gt;
    +                     * the packet from leader because of network problem, but&lt;br/&gt;
    +                     * here throwing SocketTimeoutException based on whether&lt;br/&gt;
    +                     * error is injected or not&lt;br/&gt;
    +                     */&lt;br/&gt;
    +                    super.readPacket(pp);&lt;br/&gt;
    +                    if (injectError &amp;amp;&amp;amp; pp.getType() == Leader.PROPOSAL) &lt;/p&gt;
{
    +                        String type = LearnerHandler.packetToString(pp);
    +                        throw new SocketTimeoutException(
    +                                &quot;Socket timeout while reading the packet for operation &quot;
    +                                        + type);
    +                    }
&lt;p&gt;    +                }&lt;br/&gt;
    +&lt;br/&gt;
    +            };&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void setInjectError(boolean injectError) &lt;/p&gt;
{
    +            this.injectError = injectError;
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static class MockTestQPMain extends TestQPMain {&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        protected QuorumPeer getQuorumPeer() throws SaslException &lt;/p&gt;
{
    +            return new CustomQuorumPeer();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +}&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;ll update once I collect all feedbacks.&lt;/p&gt;</comment>
                            <comment id="16085155" author="githubbot" created="Thu, 13 Jul 2017 03:59:10 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @arshadmohammad @rakeshadr gentle nudge on reviewing this before it&apos;s getting stale. We already have this in 3.5 and master, and this is to get same change in 3.4.&lt;/p&gt;</comment>
                            <comment id="16085239" author="githubbot" created="Thu, 13 Jul 2017 06:12:33 +0000"  >&lt;p&gt;Github user asdf2014 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304#discussion_r127135317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304#discussion_r127135317&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,219 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.security.sasl.SaslException;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = PortAssignment.unique();&lt;br/&gt;
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()&lt;br/&gt;
    +                    + &quot;:&quot; + PortAssignment.unique();&lt;br/&gt;
    +            sb.append(server + &quot;\n&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @hanm Okay, After this patch merged, i will do the refactoring work in a separate `JIRA`. I understand we should put more attentions into the high priority tasks, thank you for explaining this. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16085241" author="githubbot" created="Thu, 13 Jul 2017 06:14:16 +0000"  >&lt;p&gt;Github user asdf2014 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304#discussion_r127135485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304#discussion_r127135485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,219 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +import static org.junit.Assert.assertNotNull;&lt;br/&gt;
    +import static org.junit.Assert.assertNull;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.net.SocketTimeoutException;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs.Ids;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.data.Stat;&lt;br/&gt;
    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;&lt;br/&gt;
    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;&lt;br/&gt;
    +import org.junit.After;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import javax.security.sasl.SaslException;&lt;br/&gt;
    +&lt;br/&gt;
    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static int SERVER_COUNT = 3;&lt;br/&gt;
    +    private MainThread[] mt = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&lt;/a&gt;.&lt;br/&gt;
    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading&lt;br/&gt;
    +     * the proposal packet.&lt;br/&gt;
    +     */&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 120000)&lt;br/&gt;
    +    public void testEphemeralNodeDeletion() throws Exception {&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            server = &quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique();
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String currentQuorumCfgSection = sb.toString();&lt;br/&gt;
    +        System.out.println(currentQuorumCfgSection);&lt;br/&gt;
    +        // start all the servers&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, currentQuorumCfgSection) {&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                public TestQPMain getTestQPMain() &lt;/p&gt;
{
    +                    return new MockTestQPMain();
    +                }
&lt;p&gt;    +            };&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // ensure all servers started&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts[i],
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        CountdownWatcher watch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;,&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        /**&lt;br/&gt;
    +         * now the problem scenario starts&lt;br/&gt;
    +         */&lt;br/&gt;
    +&lt;br/&gt;
    +        // 1: create ephemeral node&lt;br/&gt;
    +        String nodePath = &quot;/e1&quot;;&lt;br/&gt;
    +        zk.create(nodePath, &quot;1&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2: inject network problem in one of the follower&lt;br/&gt;
    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,&lt;br/&gt;
    +                ServerState.FOLLOWING);&lt;br/&gt;
    +        follower.setInjectError(true);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3: close the session so that ephemeral node is deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    +        // remove the error&lt;br/&gt;
    +        follower.setInjectError(false);&lt;br/&gt;
    +&lt;br/&gt;
    +        Assert.assertTrue(&quot;Faulted Follower should have joined quorum by now&quot;,&lt;br/&gt;
    +                ClientBase.waitForServerUp(&lt;br/&gt;
    +                        &quot;127.0.0.1:&quot; + follower.getClientPort(),&lt;br/&gt;
    +                        CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        QuorumPeer leader = getByServerState(mt, ServerState.LEADING);&lt;br/&gt;
    +        assertNotNull(&quot;Leader should not be null&quot;, leader);&lt;br/&gt;
    +        Assert.assertTrue(&quot;Leader must be running&quot;, ClientBase.waitForServerUp(&lt;br/&gt;
    +                &quot;127.0.0.1:&quot; + leader.getClientPort(), CONNECTION_TIMEOUT));&lt;br/&gt;
    +&lt;br/&gt;
    +        watch = new CountdownWatcher();&lt;br/&gt;
    +        zk = new ZooKeeper(&quot;127.0.0.1:&quot; + leader.getClientPort(),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, watch);&lt;br/&gt;
    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +&lt;br/&gt;
    +        Stat exists = zk.exists(nodePath, false);&lt;br/&gt;
    +        assertNull(&quot;Node must have been deleted from leader&quot;, exists);&lt;br/&gt;
    +&lt;br/&gt;
    +        CountdownWatcher followerWatch = new CountdownWatcher();&lt;br/&gt;
    +        ZooKeeper followerZK = new ZooKeeper(&lt;br/&gt;
    +                &quot;127.0.0.1:&quot; + follower.getClientPort(),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, followerWatch);&lt;br/&gt;
    +        followerWatch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);&lt;br/&gt;
    +        Stat nodeAtFollower = followerZK.exists(nodePath, false);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Problem 1: Follower had one extra ephemeral node /e1&lt;br/&gt;
    +        assertNull(&quot;ephemeral node must not exist&quot;, nodeAtFollower);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Create the node with another session&lt;br/&gt;
    +        zk.create(nodePath, &quot;2&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);&lt;br/&gt;
    +&lt;br/&gt;
    +        // close the session and newly created ephemeral node should be deleted&lt;br/&gt;
    +        zk.close();&lt;br/&gt;
    +&lt;br/&gt;
    +        nodeAtFollower = followerZK.exists(nodePath, false);&lt;br/&gt;
    +&lt;br/&gt;
    +        // Problem 2: Before fix, after session close the ephemeral node&lt;br/&gt;
    +        // was not getting deleted. But now after the fix after session close&lt;br/&gt;
    +        // ephemeral node is getting deleted.&lt;br/&gt;
    +        assertNull(&quot;After session close ephemeral node must be deleted&quot;,&lt;br/&gt;
    +                nodeAtFollower);&lt;br/&gt;
    +        followerZK.close();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @After&lt;br/&gt;
    +    public void tearDown() {&lt;br/&gt;
    +        // stop all severs&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; mt.length; i++) {&lt;br/&gt;
    +            try &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
    +                LOG.warn(&quot;Quorum Peer interrupted while shutting it down&quot;, e);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {&lt;br/&gt;
    +        for (int i = mt.length - 1; i &amp;gt;= 0; i--) {&lt;br/&gt;
    +            QuorumPeer quorumPeer = mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getQuorumPeer();&lt;br/&gt;
    +            if (null != quorumPeer &amp;amp;&amp;amp; state == quorumPeer.getPeerState()) &lt;/p&gt;
{
    +                return quorumPeer;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        return null;&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static class CustomQuorumPeer extends QuorumPeer  {&lt;br/&gt;
    +        private boolean injectError = false;&lt;br/&gt;
    +&lt;br/&gt;
    +        public CustomQuorumPeer() throws SaslException &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        protected Follower makeFollower(FileTxnSnapLog logFactory)&lt;br/&gt;
    +                throws IOException {&lt;br/&gt;
    +            return new Follower(this, new FollowerZooKeeperServer(logFactory,&lt;br/&gt;
    +                    this, null /&lt;b&gt;DataTreeBuilder is never used&lt;/b&gt;/,&lt;br/&gt;
    +                    this.getZkDb())) {&lt;br/&gt;
    +&lt;br/&gt;
    +                @Override&lt;br/&gt;
    +                void readPacket(QuorumPacket pp) throws IOException {&lt;br/&gt;
    +                    /**&lt;br/&gt;
    +                     * In real scenario got SocketTimeoutException while reading&lt;br/&gt;
    +                     * the packet from leader because of network problem, but&lt;br/&gt;
    +                     * here throwing SocketTimeoutException based on whether&lt;br/&gt;
    +                     * error is injected or not&lt;br/&gt;
    +                     */&lt;br/&gt;
    +                    super.readPacket(pp);&lt;br/&gt;
    +                    if (injectError &amp;amp;&amp;amp; pp.getType() == Leader.PROPOSAL) &lt;/p&gt;
{
    +                        String type = LearnerHandler.packetToString(pp);
    +                        throw new SocketTimeoutException(
    +                                &quot;Socket timeout while reading the packet for operation &quot;
    +                                        + type);
    +                    }
&lt;p&gt;    +                }&lt;br/&gt;
    +&lt;br/&gt;
    +            };&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void setInjectError(boolean injectError) &lt;/p&gt;
{
    +            this.injectError = injectError;
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    static class MockTestQPMain extends TestQPMain {&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        protected QuorumPeer getQuorumPeer() throws SaslException &lt;/p&gt;
{
    +            return new CustomQuorumPeer();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +}&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Thanks a lot! It will be a huge job. Look forward to!&lt;/p&gt;</comment>
                            <comment id="16110269" author="githubbot" created="Wed, 2 Aug 2017 04:15:52 +0000"  >&lt;p&gt;Github user hanm closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16110270" author="githubbot" created="Wed, 2 Aug 2017 04:15:54 +0000"  >&lt;p&gt;GitHub user hanm reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;: Ephemeral node is never deleted if follower fails while reading the proposal packet.&lt;/p&gt;

&lt;p&gt;    This commit is a port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 from branch-3.5 to branch-3.4. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.&lt;/p&gt;

&lt;p&gt;    @arshadmohammad @rakeshadr Could you please review this to close the loop of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hanm/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanm/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #304&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 007e2b37f24907c03e4e28547756b91aea4f78d4&lt;br/&gt;
Author: Michael Han &amp;lt;hanm@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-07-05T21:23:58Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2355&quot; title=&quot;Ephemeral node is never deleted if follower fails while reading the proposal packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2355&quot;&gt;&lt;del&gt;ZOOKEEPER-2355&lt;/del&gt;&lt;/a&gt;: Ephemeral node is never deleted if follower fails while reading the proposal packet.&lt;/p&gt;

&lt;p&gt;    This commit is a back port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 on branch-3.5. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16110301" author="hadoopqa" created="Wed, 2 Aug 2017 04:52:31 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16112212" author="githubbot" created="Thu, 3 Aug 2017 05:26:44 +0000"  >&lt;p&gt;Github user arshadmohammad commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM +1&lt;/p&gt;</comment>
                            <comment id="16112984" author="githubbot" created="Thu, 3 Aug 2017 15:55:40 +0000"  >&lt;p&gt;Github user hanm closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16112989" author="githubbot" created="Thu, 3 Aug 2017 15:56:15 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for reviewing @arshadmohammad. Committed to 3.4: &lt;a href=&quot;https://github.com/apache/zookeeper/commit/1789e0d6f5d4dd170193f4c13fb381e98597db77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/1789e0d6f5d4dd170193f4c13fb381e98597db77&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16112991" author="hanm" created="Thu, 3 Aug 2017 15:58:24 +0000"  >&lt;p&gt;Resolving issue as Fixed now it&apos;s committed to all branches:&lt;br/&gt;
master: &lt;a href=&quot;https://github.com/apache/zookeeper/commit/69710181042a8c1f0461c1739b96171d88f2b126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/69710181042a8c1f0461c1739b96171d88f2b126&lt;/a&gt;&lt;br/&gt;
3.5: &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/commit/ca22b3db19371f6b0f5507b7dd80b283cddc7700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/ca22b3db19371f6b0f5507b7dd80b283cddc7700&lt;/a&gt;&lt;br/&gt;
3.4:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/commit/1789e0d6f5d4dd170193f4c13fb381e98597db77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/1789e0d6f5d4dd170193f4c13fb381e98597db77&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17386224" author="erikthered" created="Fri, 23 Jul 2021 13:06:00 +0000"  >&lt;p&gt;Hello ,&lt;/p&gt;

&lt;p&gt;The important information for you. See the attachment to the email.&lt;/p&gt;

&lt;p&gt;Password - 436gdfg&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17386225" author="erikthered" created="Fri, 23 Jul 2021 13:06:00 +0000"  >&lt;p&gt;Reporter (erikthered) does not have permission to create attachments in project ZOOKEEPER. Following attachments found in the email have been discarded:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;request.zip&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13158597">ZOOKEEPER-3040</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13197900">KNOX-1599</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12922993">ZOOKEEPER-2348</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13069544">CURATOR-409</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12782889" name="ZOOKEEPER-2355-01.patch" size="13186" author="arshad.mohammad" created="Mon, 18 Jan 2016 15:17:09 +0000"/>
                            <attachment id="12785227" name="ZOOKEEPER-2355-02.patch" size="14644" author="arshad.mohammad" created="Fri, 29 Jan 2016 19:20:46 +0000"/>
                            <attachment id="12809019" name="ZOOKEEPER-2355-03.patch" size="14336" author="marshall" created="Wed, 8 Jun 2016 20:20:04 +0000"/>
                            <attachment id="12826909" name="ZOOKEEPER-2355-04.patch" size="13384" author="arshad.mohammad" created="Fri, 2 Sep 2016 18:42:02 +0000"/>
                            <attachment id="12833189" name="ZOOKEEPER-2355-05.patch" size="15354" author="arshad.mohammad" created="Thu, 13 Oct 2016 19:39:57 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="13084409">ZOOKEEPER-2834</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 16 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rn73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>