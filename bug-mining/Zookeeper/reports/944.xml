<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2418] txnlog diff sync can skip sending some transactions to followers</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2418</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;If the leader is having disk issues so that its on disk txnlog is behind the in memory commit log, it will send a DIFF that is missing the transactions in between the two.&lt;/p&gt;

&lt;p&gt;Example:&lt;br/&gt;
There are 5 hosts in the cluster. 1 is the leader. 5 is disconnected.&lt;br/&gt;
We commit up to zxid 1000.&lt;br/&gt;
At zxid 450, the leader&apos;s disk stalls, but we still commit transactions because 2,3,4 are up and acking writes.&lt;br/&gt;
At zxid 1000, the txnlog on the leader has 1-450 and the commit log has 500-1000.&lt;br/&gt;
Then host 5 regains its connection to the cluster and syncs with the leader. It will receive a DIFF containing zxids 1-450 and 500-1000.&lt;/p&gt;

&lt;p&gt;This is because queueCommittedProposals in the LearnerHandler just queues everything within its zxid range. It doesn&apos;t give an error if there is a gap between peerLastZxid and the iterator it is queueing from.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12963558">ZOOKEEPER-2418</key>
            <summary>txnlog diff sync can skip sending some transactions to followers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enixon">Brian Nixon</assignee>
                                    <reporter username="nwolchko">Nicholas Wolchko</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 28 Apr 2016 16:57:10 +0000</created>
                <updated>Thu, 4 Jul 2019 01:17:04 +0000</updated>
                            <resolved>Wed, 3 Jul 2019 18:54:34 +0000</resolved>
                                    <version>3.5.1</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="604800">168h</timeoriginalestimate>
                            <timeestimate seconds="598800">166h 20m</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="15263170" author="fpj" created="Thu, 28 Apr 2016 22:33:19 +0000"  >&lt;p&gt;Thanks for reporting this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nwolchko&quot; class=&quot;user-hover&quot; rel=&quot;nwolchko&quot;&gt;nwolchko&lt;/a&gt;. In your example, what happens to txns 451-499 at the leader? They don&apos;t seem to be in the memory commit log or the disk log. &lt;/p&gt;</comment>
                            <comment id="15263180" author="nwolchko" created="Thu, 28 Apr 2016 22:41:24 +0000"  >&lt;p&gt;Zookeeper applied them normally, but they were flushed from the commit log because it only stores the most recent transactions.&lt;/p&gt;</comment>
                            <comment id="15263193" author="fpj" created="Thu, 28 Apr 2016 22:50:58 +0000"  >&lt;p&gt;When you say that ZK has applied them normally, I think you mean that 2, 3, and 4 have applied them. The leader can&apos;t have applied them because in your example they haven&apos;t gone through SyncRequestProcessor yet, otherwise they would be on disk. I feel that I&apos;m missing something here...&lt;/p&gt;</comment>
                            <comment id="15263211" author="nwolchko" created="Thu, 28 Apr 2016 23:05:23 +0000"  >&lt;p&gt;Transactions are applied based on receiving a quorum of acks. The SyncRequestProcessor being stalled prevents the leader from acking proposals,  but committing is based only on receiving enough acks. If there are a quorum of followers who have acked the proposal, the leader will continue to commit the transaction even though it didn&apos;t ack it itself.&lt;/p&gt;

&lt;p&gt;In my example the leader has applied all transactions from 1-1000 to its data tree even though the SyncRequestProcessor is stalled.&lt;/p&gt;</comment>
                            <comment id="15265345" author="fpj" created="Sat, 30 Apr 2016 15:32:07 +0000"  >&lt;p&gt;Got it, I think you&apos;re referring to this logic in &lt;tt&gt;LearnerHandler&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                    LOG.info(&quot;Use txnlog and committedLog for peer sid: &quot; +  getSid());
                    currentZxid = queueCommittedProposals(txnLogItr, peerLastZxid,
                                                         minCommittedLog, maxCommittedLog);

                    LOG.debug(&quot;Queueing committedLog 0x&quot; + Long.toHexString(currentZxid));
                    Iterator&amp;lt;Proposal&amp;gt; committedLogItr = db.getCommittedLog().iterator();
                    currentZxid = queueCommittedProposals(committedLogItr, currentZxid,
                                                         null, maxCommittedLog);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We are currently assuming that the two sequences (txn log and committed log) overlap, but as your example rightfully shows, it may not be the case. There are three options I see here:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Error the attempt to join the follower&lt;/li&gt;
	&lt;li&gt;Block new commits until the leader catches up&lt;/li&gt;
	&lt;li&gt;Leader drops leadership&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The first option is better than having a gap, but I&apos;m concerned that the leader might end up with a gap for a long time and may keep dropping followers. The second forces the leader to catch up, but it may be desirable to use the third in the case the leader is lagging behind. Having the leader slowing down the ensemble is not ideal. &lt;/p&gt;</comment>
                            <comment id="16878086" author="hanm" created="Wed, 3 Jul 2019 18:54:34 +0000"  >&lt;p&gt;Issue resolved by pull request 972&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/972&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16878249" author="hudson" created="Thu, 4 Jul 2019 00:35:51 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Zookeeper-trunk-single-thread #434 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/434/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/434/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2418&quot; title=&quot;txnlog diff sync can skip sending some transactions to followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2418&quot;&gt;&lt;del&gt;ZOOKEEPER-2418&lt;/del&gt;&lt;/a&gt;: txnlog diff sync can skip sending some transactions t&#8230; (hanm: rev 4cadbb1a649b70a2243bc4c1e5f736df4d35c462)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/LearnerHandlerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16878257" author="hudson" created="Thu, 4 Jul 2019 01:17:04 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #600 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/600/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/600/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2418&quot; title=&quot;txnlog diff sync can skip sending some transactions to followers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2418&quot;&gt;&lt;del&gt;ZOOKEEPER-2418&lt;/del&gt;&lt;/a&gt;: txnlog diff sync can skip sending some transactions t&#8230; (hanm: rev 4cadbb1a649b70a2243bc4c1e5f736df4d35c462)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/LearnerHandlerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wwxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>