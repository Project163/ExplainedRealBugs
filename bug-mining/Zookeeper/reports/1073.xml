<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4309] QuorumCnxManager&apos;s ListenerHandler thread leak</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4309</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;QuorumCnxManager::Listener::run is creating a Executors.newFixedThreadPool(addresses.size()) without shutting it down after ListenerHandler task has been completed causing it to leak.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13381291">ZOOKEEPER-4309</key>
            <summary>QuorumCnxManager&apos;s ListenerHandler thread leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="nigrofranz">Francesco Nigro</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 31 May 2021 13:13:04 +0000</created>
                <updated>Mon, 14 Jun 2021 09:47:19 +0000</updated>
                            <resolved>Mon, 14 Jun 2021 09:46:28 +0000</resolved>
                                    <version>3.6.3</version>
                    <version>3.7.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                    <fixVersion>3.7.1</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9600">2h 40m</timespent>
                                <comments>
                            <comment id="17354768" author="kyangcm" created="Tue, 1 Jun 2021 03:21:29 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;ExecutorService executor = Executors.newFixedThreadPool(addresses.size());&lt;br/&gt;
listenerHandlers.forEach(executor::submit);&lt;/p&gt;

&lt;p&gt;try {&lt;br/&gt;
 &lt;font color=&quot;#FF0000&quot;&gt;latch.await();&lt;/font&gt;&lt;br/&gt;
} catch (InterruptedException ie) &lt;/p&gt;
{
 LOG.error(&quot;Interrupted while sleeping. Ignoring exception&quot;, ie);
}
&lt;p&gt; finally {...}&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;we use countdownLatch to block that until&#160;listenerHandler accept connection. You can see countdownLatch.countDown invoked in&#160;listenerHandler.run() that we pass&#160;countdownLatch variable into it via its ctor().&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;so it does not affect memory leak in my concern.&lt;/p&gt;</comment>
                            <comment id="17354802" author="nigrofranz" created="Tue, 1 Jun 2021 04:49:22 +0000"  >&lt;p&gt;There are other parts in the zookeeper source code where a similar pattern is used and executor::shutdown is called to save the leak to happen.&lt;br/&gt;
The leak happen while halting QuorumCnxManager: listenerHandlers task can be already completed or are going to complete on halt, but the executorservice&apos;s thread are still alive, and given that non-daemon threads are GC roots they won&apos;t be garbage collected, although not reacheable.&lt;br/&gt;
An ExecutorService which non-daemon threads are still alive prevent a main thread to complete.&lt;/p&gt;

&lt;p&gt;As example of the existing code patterns that correctly shutdown the executor, you can find &lt;a href=&quot;https://github.com/franz1981/zookeeper/blob/b4f9aab099880ba8ef08eaff697debe6cdeae057/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Leader.java#L456-L468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/franz1981/zookeeper/blob/b4f9aab099880ba8ef08eaff697debe6cdeae057/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Leader.java#L456-L468&lt;/a&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                ExecutorService executor = Executors.newFixedThreadPool(serverSockets.size());
                CountDownLatch latch = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(serverSockets.size());

                serverSockets.forEach(serverSocket -&amp;gt;
                        executor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LearnerCnxAcceptorHandler(serverSocket, latch)));

                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    latch.await();
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
                    LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; sleeping in LearnerCnxAcceptor.&quot;&lt;/span&gt;, ie);
                } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                    closeSockets();
                    executor.shutdown();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;executor::shutdown is used to prevent the just created executor to leak, as explained above.&lt;/p&gt;

&lt;p&gt;A sample program that shows this ExecutorService behaviour is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; STOP_EXECUTOR = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CountDownLatch interruptibleTask = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(1);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CountDownLatch completed = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(1);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CountDownLatch starting = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(1);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ExecutorService service = Executors.newFixedThreadPool(1);
        service.submit(() -&amp;gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                starting.countDown();
                interruptibleTask.await();
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Graceful stop&quot;&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;This cannot happen&quot;&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                completed.countDown();
            }
        });
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (STOP_EXECUTOR) {
            service.shutdown();
        }
        starting.await();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Gracefully stop the submitted task&quot;&lt;/span&gt;);
        interruptibleTask.countDown();
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Await interruptible task to complete&quot;&lt;/span&gt;);
        completed.await();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (STOP_EXECUTOR) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;The application can correctly complete and there is no leak&quot;&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Perform some full GC and take an heap dump: you&apos;ll see the service &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; still alive&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;And &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; application won&apos;t stop&quot;&lt;/span&gt;);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Setting STOP_EXECUTOR = false shows that the application never end because of the Thread leak, while STOP_EXECUTOR = true just make it works, and the application can exit with code 0.&lt;br/&gt;
Hope that&apos;s enough to explain what&apos;s the issue here.&lt;/p&gt;
</comment>
                            <comment id="17354978" author="kyangcm" created="Tue, 1 Jun 2021 09:54:11 +0000"  >&lt;p&gt;yep&#160;Francesco Nigro&lt;/p&gt;

&lt;p&gt;I used your demp and reproduced it. Here are my puzzle: why the pool worker was still parking?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17355018" author="nigrofranz" created="Tue, 1 Jun 2021 11:16:42 +0000"  >&lt;p&gt;Because It&apos;s the Executor contract: it isn&apos;t shutdown so it&apos;s ready to accept new tasks.&lt;/p&gt;</comment>
                            <comment id="17355465" author="kyangcm" created="Wed, 2 Jun 2021 03:32:18 +0000"  >&lt;p&gt;I have some idea on threadpool. Its spinning routine that called getTask always try to get or else blocked itself until pool accept a closed signal.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholderprivate &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; getTask() {
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; timedOut = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// Did the last poll() time out?
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (;;) {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; c = ctl.get();
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rs = runStateOf(c);

        &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; queue empty only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; necessary.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rs &amp;gt;= SHUTDOWN &amp;amp;&amp;amp; (rs &amp;gt;= STOP || workQueue.isEmpty())) {  &lt;span class=&quot;code-comment&quot;&gt;//exit once accept stop
&lt;/span&gt;            decrementWorkerCount();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }

        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; wc = workerCountOf(c);

        &lt;span class=&quot;code-comment&quot;&gt;// Are workers subject to culling?
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; timed = allowCoreThreadTimeOut || wc &amp;gt; corePoolSize;

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((wc &amp;gt; maximumPoolSize || (timed &amp;amp;&amp;amp; timedOut))
            &amp;amp;&amp;amp; (wc &amp;gt; 1 || workQueue.isEmpty())) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (compareAndDecrementWorkerCount(c))
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
        }

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();     &lt;span class=&quot;code-comment&quot;&gt;//that block itself within core thread
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (r != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; r;
            timedOut = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException retry) {
            timedOut = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17362850" author="eolivelli" created="Mon, 14 Jun 2021 09:46:28 +0000"  >&lt;p&gt;Issue resolved by pull request 1705&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1705&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1705&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13298759">ARTEMIS-2716</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ripc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>