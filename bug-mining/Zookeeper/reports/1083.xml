<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4367] Zookeeper#Login thread leak in case of Sasl AuthFailed.</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4367</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We are seeing 1000&apos;s of Zookeeper#Login threads leak in our production clusters.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.4.13/src/java/main/org/apache/zookeeper/client/ZooKeeperSaslClient.java#L205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperSaslClient#createSaslClient&lt;/a&gt; creates Login thread.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.4.13/src/java/main/org/apache/zookeeper/client/ZooKeeperSaslClient.java#L310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperSaslClient#createSaslToken &lt;/a&gt; throws SaslException which propagates all the way back to &lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.4.13/src/java/main/org/apache/zookeeper/ClientCnxn.java#L1074&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ClientCnxn#SendThread#run&lt;/a&gt; method.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.4.13/src/java/main/org/apache/zookeeper/ClientCnxn.java#L1075-L1078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ClientCnxn#SendThread#run&lt;/a&gt; handles SaslException by changing setting state to AUTH_FAILED, queueing the eventOfDeath for EventThread and exiting/cleaning up the SendThread but we DON&apos;T close the zookeeperSaslClient which in turns shutDown the Login thread.&lt;/p&gt;

&lt;p&gt;Logs are added below for one failed connection.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;`20210831053800.393 jute.maxbuffer value is 4194304 Bytes
`20210831053800.393 Initiating client connection, connectString=&amp;lt;zookeeper-ensemble string&amp;gt; sessionTimeout=4000 watcher=org.apache.curator.ConnectionState@7b974f93

`20210831053800.401 zookeeper.request.timeout value is 10000. feature enabled=
`20210831053800.404 Client successfully logged in.
`20210831053800.405 Client will use GSSAPI as SASL mechanism.
`20210831053800.405 TGT refresh sleeping until: Wed Sep 01 00:59:06 GMT 2021
`20210831053800.405 TGT refresh thread started.
`20210831053800.405 TGT valid starting at:        Tue Aug 31 05:38:00 GMT 2021
`20210831053800.405 TGT expires:                  Wed Sep 01 05:38:00 GMT 2021

`20210831053800.407 Opening socket connection to server &amp;lt;zookeeper-server-1&amp;gt;. Will attempt to SASL-authenticate using Login Context section &apos;Client&apos;

`20210831053800.419 Socket connection established to &amp;lt;zookeeper-server-1&amp;gt;, initiating session

`20210831053800.435 Session establishment complete on server &amp;lt;zookeeper-server-1&amp;gt;, sessionid = 0x1000004066cc52b, negotiated timeout = 6000

`20210831053800.438 An error: (java.security.PrivilegedActionException: javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Server not found in Kerberos database (7) - UNKNOWN_SERVER)]) occurred when evaluating Zookeeper Quorum Member&apos;s  received SASL token. This may be caused by Java&apos;s being unable to resolve the Zookeeper Quorum Member&apos;s hostname correctly. You may want to try to adding &apos;-Dsun.net.spi.nameservice.provider.1=dns,sun&apos; to your client&apos;s JVMFLAGS environment. Zookeeper Client will go to AUTH_FAILED state.

`20210831053800.438 EventThread shut down for session: 0x1000004066cc52b

`20210831053800.438 SASL authentication with Zookeeper Quorum member failed: javax.security.sasl.SaslException: An error: (java.security.PrivilegedActionException: javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Server not found in Kerberos database (7) - UNKNOWN_SERVER)]) occurred when evaluating Zookeeper Quorum Member&apos;s  received SASL token. This may be caused by Java&apos;s being unable to resolve the Zookeeper Quorum Member&apos;s hostname correctly. You may want to try to adding &apos;-Dsun.net.spi.nameservice.provider.1=dns,sun&apos; to your client&apos;s JVMFLAGS environment. Zookeeper Client will go to AUTH_FAILED state.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;What is the correct way to shutdown Login thread in case of SaslException ?&lt;br/&gt;
We use Curator framework to connect to Zookeeper.&lt;/p&gt;

&lt;p&gt;We fixed similar bug here where we were leaking EventThreads.  &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3059&quot; title=&quot;EventThread leak in case of Sasl AuthFailed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3059&quot;&gt;&lt;del&gt;ZOOKEEPER-3059&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
This is similar except for Login threads. Please help.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13399018">ZOOKEEPER-4367</key>
            <summary>Zookeeper#Login thread leak in case of Sasl AuthFailed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="shahrs87">Rushabh Shah</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 2 Sep 2021 20:08:40 +0000</created>
                <updated>Wed, 9 Oct 2024 16:06:20 +0000</updated>
                            <resolved>Mon, 27 Sep 2021 15:49:07 +0000</resolved>
                                    <version>3.4.13</version>
                                    <fixVersion>3.5.10</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                    <fixVersion>3.7.1</fixVersion>
                                    <component>java client</component>
                    <component>kerberos</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15600">4h 20m</timespent>
                                <comments>
                            <comment id="17415178" author="shahrs87" created="Tue, 14 Sep 2021 21:16:10 +0000"  >&lt;p&gt;I have attached the PR but unable to assign the jira to me. I think someone needs to add me to contributors list.&lt;/p&gt;</comment>
                            <comment id="17415523" author="shahrs87" created="Wed, 15 Sep 2021 13:46:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maoling&quot; class=&quot;user-hover&quot; rel=&quot;maoling&quot;&gt;maoling&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ztzg&quot; class=&quot;user-hover&quot; rel=&quot;ztzg&quot;&gt;ztzg&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nkalmar&quot; class=&quot;user-hover&quot; rel=&quot;nkalmar&quot;&gt;nkalmar&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eolivelli&quot; class=&quot;user-hover&quot; rel=&quot;eolivelli&quot;&gt;eolivelli&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; Could you guys please help review the PR ? Thank you !&lt;/p&gt;</comment>
                            <comment id="17420841" author="eolivelli" created="Mon, 27 Sep 2021 15:49:07 +0000"  >&lt;p&gt;Issue resolved by pull request 1755&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1755&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1755&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17421643" author="shahrs87" created="Tue, 28 Sep 2021 19:55:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eolivelli&quot; class=&quot;user-hover&quot; rel=&quot;eolivelli&quot;&gt;eolivelli&lt;/a&gt; Whenever you get time, can you please add me to Contributors list so that I can assign jira to myself.&lt;br/&gt;
Also I have patch ready for branch-3.5 also. Thank you !&lt;/p&gt;</comment>
                            <comment id="17431028" author="nkalmar" created="Wed, 20 Oct 2021 07:36:31 +0000"  >&lt;p&gt;Merged to 3.5, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shahrs87&quot; class=&quot;user-hover&quot; rel=&quot;shahrs87&quot;&gt;shahrs87&lt;/a&gt;. Unfortunately I can&apos;t add you to contributors, and I think after one of your PR landed in the repo it should automatically sync you to be a contributor. But I couldn&apos;t yet add you as an assignee. Please give it a try later, maybe...&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13363095">ZOOKEEPER-4235</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13363095">ZOOKEEPER-4235</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ujxs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>