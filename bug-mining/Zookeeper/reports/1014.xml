<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3829] Zookeeper refuses request after node expansion</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3829</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;It&apos;s easy to reproduce this bug.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//&#20195;&#30721;&#21344;&#20301;&#31526;
&lt;/span&gt;&#160;
Step 1.&#160;Deploy 3 nodes&#160; A,B,C with configuration A,B,C .
Step 2. Deploy node ` D` with configuration&#160; `A,B,C,D` ,&#160;cluster&#160;state is ok now.
Step 3. Restart nodes A,B,C with&#160;configuration A,B,C,D, then the leader will be D, cluster hangs, but it can accept `mntr` command, other command like `ls /` will be blocked.

Step 4. Restart nodes D, cluster state is back to normal now.
&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We have looked into the code of 3.5.6 version, and we found it may be the issue of&#160; `workerPool` .&lt;/p&gt;

&lt;p&gt;The `CommitProcessor` shutdown and make `workerPool` shutdown, but `workerPool` still exists. It will never work anymore, yet the cluster still thinks it&apos;s ok.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the bug may still exist in master branch.&lt;/p&gt;

&lt;p&gt;We have tested it in our machines by reset the `workerPool` to null. If it&apos;s ok, please assign this issue to me, and then I&apos;ll create a PR.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13305094">ZOOKEEPER-3829</key>
            <summary>Zookeeper refuses request after node expansion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="symat">Mate Szalay-Beko</assignee>
                                    <reporter username="sundyli">Sundy Li</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 May 2020 03:12:54 +0000</created>
                <updated>Thu, 10 Sep 2020 10:43:46 +0000</updated>
                            <resolved>Wed, 3 Jun 2020 07:59:50 +0000</resolved>
                                    <version>3.6.1</version>
                    <version>3.5.8</version>
                                    <fixVersion>3.5.9</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                    <fixVersion>3.6.2</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="19800">5.5h</timespent>
                                <comments>
                            <comment id="17107888" author="sundyli" created="Fri, 15 May 2020 03:15:47 +0000"  >&lt;p&gt;I think we can reset the `workerPool` to null. If it&apos;s ok, please assign this issue to me, and then I&apos;ll create a PR.&lt;/p&gt;</comment>
                            <comment id="17107986" author="eolivelli" created="Fri, 15 May 2020 06:22:15 +0000"  >&lt;p&gt;That&apos;s very strange.&lt;br/&gt;
As you already dug into the code.&lt;br/&gt;
Can you create a reproducer test?&lt;/p&gt;

&lt;p&gt;The behaviour is the same even on latest release? I guess so as I can&apos;t recall any fix in this area&lt;/p&gt;</comment>
                            <comment id="17107999" author="symat" created="Fri, 15 May 2020 06:44:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sundyli&quot; class=&quot;user-hover&quot; rel=&quot;sundyli&quot;&gt;sundyli&lt;/a&gt; thanks for reporting the issue! I haven&apos;t seen this error before.&lt;br/&gt;
Let me quickly try to reproduce your issue to see if the steps you described results in the same problem for me.&lt;/p&gt;</comment>
                            <comment id="17108023" author="sundyli" created="Fri, 15 May 2020 07:33:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eolivelli&quot; class=&quot;user-hover&quot; rel=&quot;eolivelli&quot;&gt;eolivelli&lt;/a&gt;&#160;I think it&apos;s&#160;the same even on latest release. But I didn&apos;t test it in the latest release.&#160;&lt;/p&gt;

&lt;p&gt;My workmates and I can reproduce it in 3.5.6 version every time, how to create a&#160;reproducer test?&#160;&lt;/p&gt;</comment>
                            <comment id="17108046" author="sundyli" created="Fri, 15 May 2020 07:51:09 +0000"  >&lt;p&gt;We start `CommitProcessor` &lt;a href=&quot;https://github.com/apache/zookeeper/blob/e87bad6774e7269ef21a156aff9dad089ef54794/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/CommitProcessor.java#L455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;We shutdown `CommitProcessor` &lt;a href=&quot;https://github.com/apache/zookeeper/blob/e87bad6774e7269ef21a156aff9dad089ef54794/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/CommitProcessor.java#L637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;But when we call `start` method again, the `workerPool` will not work anymore. I submit the node D logs attachment `d.log`, and we can see that happens.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
307:  2020-05-14 18:04:12,022 [myid:4] - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):CommitProcessor@362] - Shutting down 
308 2020-05-14 18:04:12,022 [myid:4] - INFO  [FollowerRequestProcessor:4:FollowerRequestProcessor@110] - FollowerRequestProcessor exited loop!
309 2020-05-14 18:04:12,022 [myid:4] - INFO  [CommitProcessor:4:CommitProcessor@195] - CommitProcessor exited loop!
310 2020-05-14 18:04:12,023 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):FinalRequestProcessor@514] - shutdown of request processor complete
311 2020-05-14 18:04:12,024 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):FileTxnLog$FileTxnIterator@655] - Created &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; input stream /data1/zookeeper    /logs/version-2/log.2a0000000b
312 2020-05-14 18:04:12,024 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):FileTxnLog$FileTxnIterator@658] - Created &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; input archive /data1/zookeepe    r/logs/version-2/log.2a0000000b
313 2020-05-14 18:04:12,024 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):FileTxnLog$FileTxnIterator@696] - EOF exception java.io.EOFException: Faile    d to read /data1/zookeeper/logs/version-2/log.2a0000000b
314 --
315 2020-05-14 18:04:29,000 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):SessionTrackerImpl@274] - Adding session 0x3082f5048fc0000
316 2020-05-14 18:04:29,000 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):SessionTrackerImpl@274] - Adding session 0x40a33f8f3f40002
317 2020-05-14 18:04:29,000 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):SessionTrackerImpl@274] - Adding session 0x40a33f8f3f40000
318 2020-05-14 18:04:29,000 [myid:4] - DEBUG [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):SessionTrackerImpl@274] - Adding session 0x40a33f8f3f40001
319 2020-05-14 18:04:29,000 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):CommitProcessor@256] - Configuring CommitProcessor with 24 worker threads.
320 2020-05-14 18:04:29,002 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):ContainerManager@64] - Using checkIntervalMs=60000 maxPerMinute=10000
321 2020-05-14 18:04:29,003 [myid:4] - DEBUG [LearnerHandler-/146.196.79.232:38708:LearnerHandler@534] - Sending UPTODATE message to 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17108106" author="symat" created="Fri, 15 May 2020 09:03:14 +0000"  >&lt;p&gt;I failed to reproduce your case. I created docker compose files (&lt;a href=&quot;https://github.com/symat/zookeeper-docker-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/symat/zookeeper-docker-test&lt;/a&gt;) and using 3.5.6, I executed these steps:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;start A,B,C with config (A,B,C)&lt;/li&gt;
	&lt;li&gt;start D with config (A,B,C,D)&lt;/li&gt;
	&lt;li&gt;stop A&lt;/li&gt;
	&lt;li&gt;start A&#160;with config (A,B,C,D)&lt;/li&gt;
	&lt;li&gt;stop B&lt;/li&gt;
	&lt;li&gt;start B with config (A,B,C,D)&lt;/li&gt;
	&lt;li&gt;stop C&lt;/li&gt;
	&lt;li&gt;start C with config (A,B,C,D)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;At the end, everything worked for me just fine, leader was D and all nodes were up, forming a quorum (A,B,C,D) and zkCli worked (&quot;&lt;tt&gt;ls /&quot;&lt;/tt&gt;)&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
 There must be some differences between your reproduction and mine. Can you please share your zoo.cfg?&lt;/p&gt;

&lt;p&gt;My looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
dataDir=/data
dataLogDir=/datalog
tickTime=2000
initLimit=5
syncLimit=2
autopurge.snapRetainCount=3
autopurge.purgeInterval=0
maxClientCnxns=60

standaloneEnabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
admin.enableServer=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
localSessionsEnabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
localSessionsUpgradingEnabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;

4lw.commands.whitelist=stat, ruok, conf, isro, wchc, wchp, srvr, mntr, cons

clientCnxnSocket=org.apache.zookeeper.ClientCnxnSocketNetty
serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory

# server host/port config in my &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (when I have 4 nodes)
server.1=zoo1:2888:3888;2181
server.2=zoo2:2888:3888;2181
server.3=zoo3:2888:3888;2181
server.4=zoo4:2888:3888;2181
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I checked the log file you uploaded. But I don&apos;t really see why you think the problem is with CommitProcessor. Maybe I miss something. Is this the full log file from your D node?&lt;/p&gt;

&lt;p&gt;Also I checked the code. I think the &lt;tt&gt;CommitProcessor&lt;/tt&gt; class should never be reused after a &lt;tt&gt;shutdown()&lt;/tt&gt; is called. After a new leader election, a new &lt;tt&gt;LeaderZooKeeperServer&lt;/tt&gt; / &lt;tt&gt;FollowerZooKeeperServer&lt;/tt&gt; / &lt;tt&gt;ObserverZooKeeperServer&lt;/tt&gt; object will be created (depending on the role of the given server), with a fresh &lt;tt&gt;CommitProcessor&lt;/tt&gt; and new &lt;tt&gt;workerPool&lt;/tt&gt;. So AFAICT (based only on a high-level look on the code) it shouldn&apos;t really matter to set &lt;tt&gt;workerPool=null&lt;/tt&gt; in the shutdown method. But maybe I just don&apos;t follow your reasoning, or missed something in the code. Feel free to create a PR then we can see what you suggest.&lt;/p&gt;

&lt;p&gt;Did you try your proposed fix already and saw that it solves your original issue?&lt;/p&gt;</comment>
                            <comment id="17108113" author="symat" created="Fri, 15 May 2020 09:12:17 +0000"  >&lt;p&gt;Did you actually see in the logs this printout &lt;a href=&quot;https://github.com/apache/zookeeper/blob/e87bad6774e7269ef21a156aff9dad089ef54794/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/CommitProcessor.java#L632&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&quot;Shutting down&quot;&lt;/a&gt;&#160;before the &lt;tt&gt;start&lt;/tt&gt; method would be called on the&#160;same CommitProcessor?&lt;/p&gt;

&lt;p&gt;I see this one in your logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
310 2020-05-14 18:04:12,023 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):FinalRequestProcessor@514] - shutdown of request processor complete
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But this is about shutting down the &lt;tt&gt;FinalRequestProcessor&lt;/tt&gt; and not the &lt;tt&gt;CommitProcessor&lt;/tt&gt;.&lt;br/&gt;
 &#160;&lt;/p&gt;</comment>
                            <comment id="17108258" author="sundyli" created="Fri, 15 May 2020 13:02:23 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The logs are in&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
line 307:  2020-05-14 18:04:12,022 [myid:4] - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):CommitProcessor@362] - Shutting down

line 319: 2020-05-14 18:04:29,000 [myid:4] - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):CommitProcessor@256] - Configuring CommitProcessor with 24 worker threads.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thanks for your feedback, I reproduced it without docker,&#160; I will try to reproduce it with docker-compose.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17108338" author="sundyli" created="Fri, 15 May 2020 14:28:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hi, I reproduced it with your docker-compose scripts.&lt;/p&gt;

&lt;p&gt;my zoo.cfg as ClickHouse documents [tips|&lt;a href=&quot;https://clickhouse.tech/docs/en/operations/tips/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://clickhouse.tech/docs/en/operations/tips/&lt;/a&gt;]&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
libenwang@ck015:~/git/zookeeper-docker-test$ cat conf/zoo.cfg
dataDir=/data
dataLogDir=/datalog

tickTime=2000
initLimit=30000
syncLimit=10
maxClientCnxns=2000
maxSessionTimeout=60000000
autopurge.snapRetainCount=10
autopurge.purgeInterval=1
preAllocSize=131072
snapCount=3000000
leaderServes=yes
standaloneEnabled=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
clientPort=2181
admin.serverPort=8084
&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Scripts&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
export ZOOKEEPER_GIT_REPO=~/git/zookeeper
export ZOOKEEPER_DOCKER_TEST_GIT_REPO=~/git/zookeeper-docker-test
# you always need to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a maven install to have the assembly tar.gz file updated!
cd $ZOOKEEPER_GIT_REPO
mvn clean install -DskipTests
cd $ZOOKEEPER_DOCKER_TEST_GIT_REPO
sudo rm -rf data
docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml up -d
docker exec -it zookeeper_zoo1_1 /bin/bash /zookeeper/bin/zkCli.sh create /clickhouse aaa
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml create zoo4
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml start zoo4

docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml stop zoo1
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml create zoo1
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml start zoo1
&#160;
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml stop zoo2
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml create zoo2
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml start zoo2
&#160;
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml stop zoo3
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml create zoo3
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml start zoo3
# This hangs
docker exec -it zookeeper_zoo4_1 /bin/bash /zookeeper/bin/zkCli.sh ls /

docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml down
&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17108353" author="symat" created="Fri, 15 May 2020 14:40:45 +0000"  >&lt;p&gt;I see now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(you pasted the logs from line 308 in your previous comment, this is why I missed it)&lt;/p&gt;

&lt;p&gt;But still I don&apos;t know if it the two log lines are produced by the same CommitProcessor object instance. As I said, my understanding is that a new ZooKeeperServer with a new clean CommitProcessor is getting created after each leader election.&lt;/p&gt;

&lt;p&gt;What I see in Line 225 is that this server was (re)started? Then at least a whole leader election is missing from the log. Then I see that the server become a Follower. &lt;br/&gt;
Then in line 299 it can not follow the current leader anymore. I guess then happens a new leader election, missing from the logs. But we see that the LearnerZooKeeperServer is shutting down (also closing the CommitProcessor).&lt;/p&gt;

&lt;p&gt;And then the next thing I see is what you are mentioning: &quot;Configuring CommitProcessor with 24 worker threads&quot;. But this time the server is already a leader, as it is sending the UPTODATE messages (lines 321, 322). So my assumption would be that this time this CommitProcessor is inside a LederZooKeeperServer, not inside a LearnerZooKeeperServer. So these are actually different CommitProcessors and different workerPools.&lt;/p&gt;

&lt;p&gt;Anyway, I am not saying you are not right (this is a quite complicated piece of code). All I say is that I am not convinced yet and it is very hard for me to tell what is happening, as I don&apos;t see the full logs and also I was not able to reproduce the problem locally. (maybe my mistake, I don&apos;t know) I don&apos;t think it is related to docker compose vs. plain docker. &lt;/p&gt;

&lt;p&gt;Based on your description, something must have been stucked, I am just not sure if it is the workerPool in the CommitProcessor. Can I ask again: &quot;Did you try your proposed fix already and saw that it solves your original issue?&quot;&lt;br/&gt;
(you can download the ZooKeeper code then apply your fix and run `mvn clean install -DskipTests` and change the zookeeper jar files in the docker image for testing)&lt;/p&gt;</comment>
                            <comment id="17108368" author="sundyli" created="Fri, 15 May 2020 14:48:23 +0000"  >&lt;p&gt;Did you try your proposed fix already and saw that it solves your original issue?&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;Sorry, I forgot to answer this.&lt;br/&gt;
 Yes, I fixed it and tested, it works normally after the fix.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Have you checked my reply message? (I reproduced it with your docker repo).&lt;br/&gt;
It must be some configuration that makes this issue happen. I will try to find which config is wrong.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17108370" author="symat" created="Fri, 15 May 2020 14:51:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Hi, I reproduced it with your docker-compose scripts&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;great, thanks for the detailed steps!&lt;br/&gt;
I will try them locally on Monday and I can verify your findings. (I used slightly different docker-compose commands, maybe those made the difference.)&lt;/p&gt;

&lt;p&gt;The config looks OK, except the &lt;tt&gt;initLimit&lt;/tt&gt;, which should be way smaller. It should be given in number of ticks instead of millisecs. But I don&apos;t think it should matter much in this case.&lt;/p&gt;

&lt;p&gt;Thanks for taking so much time chasing a ZooKeeper error! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17109306" author="keliwang" created="Sun, 17 May 2020 04:15:44 +0000"  >&lt;p&gt;When using &lt;a href=&quot;https://github.com/symat/zookeeper-docker-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/symat/zookeeper-docker-test&lt;/a&gt;, disable options related to localSessions in zoo.cfg can reproduce this bug.&lt;/p&gt;</comment>
                            <comment id="17110357" author="symat" created="Mon, 18 May 2020 14:46:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=keliwang&quot; class=&quot;user-hover&quot; rel=&quot;keliwang&quot;&gt;keliwang&lt;/a&gt; this is a very nice catch! I was also validating your find from the other direction: If I add the &lt;tt&gt;localSessionsEnabled=true&lt;/tt&gt; to the config just sent by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sundyli&quot; class=&quot;user-hover&quot; rel=&quot;sundyli&quot;&gt;sundyli&lt;/a&gt;, the zkCli was not hanging (while using his config I reproduced the original issue). So having &lt;tt&gt;localSessionsEnabled=true&lt;/tt&gt; in my config caused that I was unable to reproduce the issue in the first place.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;localSessionsEnabled=true&lt;/tt&gt; matters only because when the local sessions are enabled, then the client will be able to connect without having it&apos;s global session ID committed. The basic problem is indeed with this log line, as you wrote in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3830&quot; title=&quot;After add a new node, zookeeper cluster won&amp;#39;t commit any proposal if this new node is leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3830&quot;&gt;&lt;del&gt;ZOOKEEPER-3830&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-05-18 14:08:07,051 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0.0.0.0:2181)(secure=disabled):Leader@1296] - Have quorum of supporters, sids: [ [4, 1, 3],[1, 3] ]; starting up and setting last processed zxid: 0x400000000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will lead that the designated leader will not be the new leader (&lt;a href=&quot;https://github.com/apache/zookeeper/blob/c11b7e26bc554b8523dc929761dd28808913f091/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Leader.java#L1310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;see here&lt;/a&gt;), and &lt;tt&gt;allowedToCommit = false&lt;/tt&gt; will be set a few lines later. But no new leader election will be started, as the dynamic reconfig is not enabled. So the leader will start to work, but it won&apos;t be able to commit anything.&lt;/p&gt;

&lt;p&gt;So I think the solution would be to skip the whole &lt;tt&gt;designatedLeader&lt;/tt&gt; check when the dynamicReconfig is disabled.&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sundyli&quot; class=&quot;user-hover&quot; rel=&quot;sundyli&quot;&gt;sundyli&lt;/a&gt;, I was adding some debug logs to the commit processor and found that when the &quot;&lt;tt&gt;Configuring CommitProcessor with XX worker threads&lt;/tt&gt;&quot; log is printed out, we always creating a new &lt;tt&gt;workerPool&lt;/tt&gt;. I am not sure how resetting the &lt;tt&gt;workerPool&lt;/tt&gt; to null would solve this issue. Are you sure that it helps in your case? Maybe then we are chasing here a different error &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - The one I just reproduced with your zoo.cfg in docker compose seems to be unrelated to &lt;tt&gt;workerPool&lt;/tt&gt; but related to &lt;tt&gt;lastSeenQuorumVerifier&lt;/tt&gt; and dynamic-reconfig.&lt;/p&gt;

&lt;p&gt;I will create a PR now with the proposed fix (skipping the checking of the  &lt;tt&gt;designatedLeader&lt;/tt&gt; when dynamic-reconfig is disabled), but I need some time first to check if the same error affects the master branch and also to see if I can add some unit tests for this.&lt;/p&gt;</comment>
                            <comment id="17110780" author="keliwang" created="Tue, 19 May 2020 02:23:45 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (curQV.getVersion() == 0 &amp;amp;&amp;amp; curQV.getVersion() == lastSeenQV.getVersion()) {
    &lt;span class=&quot;code-comment&quot;&gt;// This was added in ZOOKEEPER-1783. The initial config has version 0 (not explicitly
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// specified by the user; the lack of version in a config file is interpreted as version=0). 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// As soon as a config is established we would like to increase its version so that it
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// takes presedence over other initial configs that were not established (such as a config
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// of a server trying to join the ensemble, which may be a partial view of the system, not the full config). 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// We chose to set the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; version to the one of the NEWLEADER message. However, before we can &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; that
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// there must be agreement on the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; version, so we can only change the version when sending/receiving UPTODATE,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// not when sending/receiving NEWLEADER. In other words, we can&apos;t change curQV here since its the committed quorum verifier, 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// and there&lt;span class=&quot;code-quote&quot;&gt;&apos;s still no agreement on the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; version that we&apos;&lt;/span&gt;d like to use. Instead, we use 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// lastSeenQuorumVerifier which is being sent with NEWLEADER message
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// so its a good way to let followers know about the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; version. (The original reason &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sending 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// lastSeenQuorumVerifier with NEWLEADER is so that the leader completes any potentially uncommitted reconfigs
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// that it finds before starting to propose operations. Here we&apos;re reusing the same code path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// reaching consensus on the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; version number.)
&lt;/span&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// It is important that &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is done before the leader executes waitForEpochAck,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// so before LearnerHandlers &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; from their waitForEpochAck
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// hence before they construct the NEWLEADER message containing
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// the last-seen-quorumverifier of the leader, which we change below
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        QuorumVerifier newQV = self.configFromString(curQV.toString());
        newQV.setVersion(zk.getZxid());
        self.setLastSeenQuorumVerifier(newQV, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);    
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(e);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt; In the code above, can leader always overwrite lastSeenQuorumVerifier with its latest quorumVerifier when dynamic-reconfig disabled? If lastSeenQuorumVerifier is the same as quorumVerifier, then allowedToCommit should always be true.&lt;/p&gt;</comment>
                            <comment id="17110847" author="sundyli" created="Tue, 19 May 2020 04:40:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hi, I have pushed my code to my repo.&lt;/p&gt;

&lt;p&gt;With this fix, we won&apos;t reproduce this issue(but we use docker-compose down, we still have this issue), you can try that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
git clone --depth=50 --branch=ZOOKEEPER-3829&#160; &#160;git@github.com:sundy-li/zookeeper.git
export ZOOKEEPER_GIT_REPO=~/git/zookeeper 
export ZOOKEEPER_DOCKER_TEST_GIT_REPO=~/git/zookeeper-docker-test
cd $ZOOKEEPER_GIT_REPO 
mvn install -DskipTests=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Dmaven.javadoc.skip=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -B -V 
cd $ZOOKEEPER_DOCKER_TEST_GIT_REPO 
sudo rm -rf data
&#160;
docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml up -d
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml create zoo4
docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml start zoo4
## If we use docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml down, we reproduce &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; issue even with the fix, that&apos;s weired.
docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml stop zoo1 
docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml stop zoo2 
docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml stop zoo3

docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml up -d&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yet I believe `localSessionsEnabled` configuration matters,&#160; maybe there is not just one bug that causes this issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17110857" author="keliwang" created="Tue, 19 May 2020 05:11:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sundyli&quot; class=&quot;user-hover&quot; rel=&quot;sundyli&quot;&gt;sundyli&lt;/a&gt; I tried your reproduce steps with your fixed branch, but still got zkCli.sh stuck in CONNECTING state.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
zookeeper-docker-test on &#57504; master [!] took 3m55s
&#10095; docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml down
Stopping zookeeper_zoo2_1 ... done
Stopping zookeeper_zoo3_1 ... done
Stopping zookeeper_zoo1_1 ... done
Stopping zookeeper_zoo4_1 ... done
Removing zookeeper_zoo2_1 ... done
Removing zookeeper_zoo3_1 ... done
Removing zookeeper_zoo1_1 ... done
Removing zookeeper_zoo4_1 ... done
Removing network zookeeper_default

zookeeper-docker-test on &#57504; master [!] took 11s
&#10095; rm -rf data

zookeeper-docker-test on &#57504; master [!]
&#10095; exa
3_nodes_2_networks_zk.yml       3_nodes_zk.yml                 3_nodes_zk_jdk_12.yml               3_nodes_zk_no_wildcard_addr.yml         4_nodes_2_networks_zk.yml           conf         logs       start_zookeeper.sh
3_nodes_digest_quorum_auth.yml  3_nodes_zk_dynamic_config.yml  3_nodes_zk_mounted_data_folder.yml  3_nodes_zk_server_hostname_changed.yml  4_nodes_zk_mounted_data_folder.yml  LICENSE.txt  README.md

zookeeper-docker-test on &#57504; master [!]
&#10095; docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml up -d
Creating network &lt;span class=&quot;code-quote&quot;&gt;&quot;zookeeper_default&quot;&lt;/span&gt; with the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; driver
Creating zookeeper_zoo1_1 ... done
Creating zookeeper_zoo2_1 ... done
Creating zookeeper_zoo3_1 ... done

zookeeper-docker-test on &#57504; master [!]
&#10095; docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml create zoo4
WARNING: The create command is deprecated. Use the up command with the --no-start flag instead.
Creating zookeeper_zoo4_1 ... done

zookeeper-docker-test on &#57504; master [!]
&#10095; docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml start zoo4
Starting zoo4 ... done

zookeeper-docker-test on &#57504; master [!]
&#10095; docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml stop zoo1
  docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml stop zoo2
  docker-compose --project-name zookeeper --file 3_nodes_zk_mounted_data_folder.yml stop zoo3
Stopping zookeeper_zoo1_1 ... done
Stopping zookeeper_zoo2_1 ... done
Stopping zookeeper_zoo3_1 ... done

zookeeper-docker-test on &#57504; master [!] took 32s
&#10095; docker-compose --project-name zookeeper --file 4_nodes_zk_mounted_data_folder.yml up -d
Recreating zookeeper_zoo2_1 ...
Recreating zookeeper_zoo2_1 ... done
Recreating zookeeper_zoo3_1 ... done
Recreating zookeeper_zoo1_1 ... done

zookeeper-docker-test on &#57504; master [!]
&#10095; docker exec -it zookeeper_zoo4_1 /bin/bash /zookeeper/bin/zkCli.sh
Connecting to localhost:2181
2020-05-19 05:10:25,321 [myid:] - INFO  [main:Environment@98] - Client environment:zookeeper.version=3.7.0-SNAPSHOT-f87c14dd8a984b5850b9afc9a5c9358f5420877e, built on 2020-05-19 05:03 UTC
2020-05-19 05:10:25,326 [myid:] - INFO  [main:Environment@98] - Client environment:host.name=zoo4
2020-05-19 05:10:25,326 [myid:] - INFO  [main:Environment@98] - Client environment:java.version=1.8.0_222
2020-05-19 05:10:25,333 [myid:] - INFO  [main:Environment@98] - Client environment:java.vendor=Oracle Corporation
2020-05-19 05:10:25,333 [myid:] - INFO  [main:Environment@98] - Client environment:java.home=/usr/local/openjdk-8
2020-05-19 05:10:25,333 [myid:] - INFO  [main:Environment@98] - Client environment:java.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;path=/zookeeper/bin/../zookeeper-server/target/classes:/zookeeper/bin/../build/classes:/zookeeper/bin/../zookeeper-server/target/lib/*.jar:/zookeeper/bin/../build/lib/*.jar:/zookeeper/bin/../lib/zookeeper-prometheus-metrics-3.7.0-SNAPSHOT.jar:/zookeeper/bin/../lib/zookeeper-jute-3.7.0-SNAPSHOT.jar:/zookeeper/bin/../lib/zookeeper-3.7.0-SNAPSHOT.jar:/zookeeper/bin/../lib/snappy-java-1.1.7.jar:/zookeeper/bin/../lib/slf4j-log4j12-1.7.25.jar:/zookeeper/bin/../lib/slf4j-api-1.7.25.jar:/zookeeper/bin/../lib/simpleclient_servlet-0.6.0.jar:/zookeeper/bin/../lib/simpleclient_hotspot-0.6.0.jar:/zookeeper/bin/../lib/simpleclient_common-0.6.0.jar:/zookeeper/bin/../lib/simpleclient-0.6.0.jar:/zookeeper/bin/../lib/netty-transport-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-unix-common-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-transport-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-epoll-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-transport-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-resolver-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-handler-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-common-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-codec-4.1.48.Final.jar:/zookeeper/bin/../lib/netty-buffer-4.1.48.Final.jar:/zookeeper/bin/../lib/metrics-core-3.2.5.jar:/zookeeper/bin/../lib/log4j-1.2.17.jar:/zookeeper/bin/../lib/json-simple-1.1.1.jar:/zookeeper/bin/../lib/jline-2.14.6.jar:/zookeeper/bin/../lib/jetty-util-9.4.24.v20191120.jar:/zookeeper/bin/../lib/jetty-servlet-9.4.24.v20191120.jar:/zookeeper/bin/../lib/jetty-server-9.4.24.v20191120.jar:/zookeeper/bin/../lib/jetty-security-9.4.24.v20191120.jar:/zookeeper/bin/../lib/jetty-io-9.4.24.v20191120.jar:/zookeeper/bin/../lib/jetty-http-9.4.24.v20191120.jar:/zookeeper/bin/../lib/javax.servlet-api-3.1.0.jar:/zookeeper/bin/../lib/jackson-databind-2.10.3.jar:/zookeeper/bin/../lib/jackson-core-2.10.3.jar:/zookeeper/bin/../lib/jackson-annotations-2.10.3.jar:/zookeeper/bin/../lib/commons-lang-2.6.jar:/zookeeper/bin/../lib/commons-cli-1.2.jar:/zookeeper/bin/../lib/audience-annotations-0.5.0.jar:/zookeeper/bin/../zookeeper-*.jar:/zookeeper/bin/../zookeeper-server/src/main/resources/lib/*.jar:/zookeeper/bin/../conf:
2020-05-19 05:10:25,334 [myid:] - INFO  [main:Environment@98] - Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib
2020-05-19 05:10:25,334 [myid:] - INFO  [main:Environment@98] - Client environment:java.io.tmpdir=/tmp
2020-05-19 05:10:25,334 [myid:] - INFO  [main:Environment@98] - Client environment:java.compiler=&amp;lt;NA&amp;gt;
2020-05-19 05:10:25,334 [myid:] - INFO  [main:Environment@98] - Client environment:os.name=Linux
2020-05-19 05:10:25,335 [myid:] - INFO  [main:Environment@98] - Client environment:os.arch=amd64
2020-05-19 05:10:25,335 [myid:] - INFO  [main:Environment@98] - Client environment:os.version=4.19.76-linuxkit
2020-05-19 05:10:25,335 [myid:] - INFO  [main:Environment@98] - Client environment:user.name=root
2020-05-19 05:10:25,335 [myid:] - INFO  [main:Environment@98] - Client environment:user.home=/root
2020-05-19 05:10:25,336 [myid:] - INFO  [main:Environment@98] - Client environment:user.dir=/
2020-05-19 05:10:25,336 [myid:] - INFO  [main:Environment@98] - Client environment:os.memory.free=23MB
2020-05-19 05:10:25,338 [myid:] - INFO  [main:Environment@98] - Client environment:os.memory.max=228MB
2020-05-19 05:10:25,338 [myid:] - INFO  [main:Environment@98] - Client environment:os.memory.total=31MB
2020-05-19 05:10:25,347 [myid:] - INFO  [main:ZooKeeper@633] - Initiating client connection, connectString=localhost:2181 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@65e579dc
2020-05-19 05:10:25,351 [myid:] - INFO  [main:X509Util@77] - Setting -D jdk.tls.rejectClientInitiatedRenegotiation=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; to disable client-initiated TLS renegotiation
2020-05-19 05:10:25,362 [myid:] - INFO  [main:ClientCnxnSocket@239] - jute.maxbuffer value is 1048575 Bytes
2020-05-19 05:10:25,374 [myid:] - INFO  [main:ClientCnxn@1714] - zookeeper.request.timeout value is 0. feature enabled=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
Welcome to ZooKeeper!
2020-05-19 05:10:25,394 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1159] - Opening socket connection to server localhost/127.0.0.1:2181.
2020-05-19 05:10:25,395 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@1161] - SASL config status: Will not attempt to authenticate using SASL (unknown error)
JLine support is enabled
2020-05-19 05:10:25,407 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn$SendThread@993] - Socket connection established, initiating session, client: /127.0.0.1:40788, server: localhost/127.0.0.1:2181
[zk: localhost:2181(CONNECTING) 0]
2020-05-19 05:10:49,712 [myid:] - ERROR [main:ServiceUtils@42] - Exiting JVM with code 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17110960" author="symat" created="Tue, 19 May 2020 08:20:53 +0000"  >&lt;p&gt;I&apos;ll push a PR with some proposed fixes and also some tests that reproduces the steps we discussed before. (these tests fail without the changes but after the changes they are passing). &lt;/p&gt;

&lt;p&gt;see: &lt;a href=&quot;https://github.com/apache/zookeeper/pull/1356&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1356&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17111115" author="symat" created="Tue, 19 May 2020 12:00:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;we use docker-compose down, we still have this issue&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;maybe &quot;&lt;tt&gt;docker-compose down&lt;/tt&gt;&quot; is also removing the virtual network?&lt;/p&gt;

&lt;p&gt;I always use &quot;&lt;tt&gt;stop zoo3&lt;/tt&gt;&quot; to stop a service and &quot;&lt;tt&gt;up -d zoo3&lt;/tt&gt;&quot; to rebuild/start it again.&lt;/p&gt;</comment>
                            <comment id="17119575" author="nkalmar" created="Fri, 29 May 2020 13:04:25 +0000"  >&lt;p&gt;Had non-trivial merge conflicts when cherry-picking to branch-3.5, it will need a seperate PR.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13324679">ZOOKEEPER-3920</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13306392">ZOOKEEPER-3842</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13302400">ZOOKEEPER-3814</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13305246">ZOOKEEPER-3830</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13324679">ZOOKEEPER-3920</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13003009" name="d.log" size="60395" author="sundyli" created="Fri, 15 May 2020 07:52:20 +0000"/>
                            <attachment id="13003035" name="screenshot-1.png" size="872889" author="sundyli" created="Fri, 15 May 2020 12:58:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0erk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>