<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3652] Improper synchronization in ClientCnxn</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3652</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2111&quot; title=&quot;Not isAlive states should be synchronized in ClientCnxn&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2111&quot;&gt;&lt;del&gt;ZOOKEEPER-2111&lt;/del&gt;&lt;/a&gt; introduced &lt;tt&gt;synchronized(state)&lt;/tt&gt; statements in&#160;&lt;tt&gt;ClientCnxn&lt;/tt&gt; and&#160;&lt;tt&gt;ClientCnxn.SendThread&lt;/tt&gt; to coordinate insertion in &lt;tt&gt;outgoingQueue&lt;/tt&gt; and draining it when the client connection isn&apos;t alive.&lt;/p&gt;

&lt;p&gt;There are several issues with this approach:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the value of the &lt;tt&gt;state&lt;/tt&gt; field is not stable, meaning we don&apos;t always synchronize on the same object.&lt;/li&gt;
	&lt;li&gt;the &lt;tt&gt;state&lt;/tt&gt; field is an enum value, which are global objects. So in an application with several ZooKeeper clients connected to different servers, this causes some contention between clients.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;An easy fix is change those &lt;tt&gt;synchronized(state)&lt;/tt&gt; statements to &lt;tt&gt;synchronized(outgoingQueue)&lt;/tt&gt; since it is local to each client and is what we want to coordinate.&lt;/p&gt;

&lt;p&gt;I&apos;ll be happy to prepare a PR with the above change if this is deemed to be the correct way to fix it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Another issue that makes contention worse is &lt;tt&gt;ClientCnxnSocketNIO.cleanup()&lt;/tt&gt; that is called from within the above synchronized block and contains &lt;tt&gt;Thread.sleep(100)&lt;/tt&gt;. Why is this sleep statement needed, and can we remove it?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13274776">ZOOKEEPER-3652</key>
            <summary>Improper synchronization in ClientCnxn</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sylvain">Sylvain Wallez</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 16 Dec 2019 14:31:06 +0000</created>
                <updated>Mon, 17 Apr 2023 23:10:22 +0000</updated>
                            <resolved>Wed, 30 Mar 2022 18:30:04 +0000</resolved>
                                    <version>3.5.6</version>
                                    <fixVersion>3.5.10</fixVersion>
                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.6.4</fixVersion>
                    <fixVersion>3.9.0</fixVersion>
                    <fixVersion>3.8.1</fixVersion>
                                    <component>java client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="17040610" author="maoling" created="Thu, 20 Feb 2020 04:02:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sylvain&quot; class=&quot;user-hover&quot; rel=&quot;sylvain&quot;&gt;sylvain&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;synchronized(outgoingQueue&#65289;*may be an alternative way to fix&#160;&lt;/b&gt;-&lt;del&gt;*&lt;b&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2111&quot; title=&quot;Not isAlive states should be synchronized in ClientCnxn&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2111&quot;&gt;&lt;del&gt;ZOOKEEPER-2111&lt;/del&gt;&lt;/a&gt;&lt;/b&gt;&lt;/del&gt;-&lt;/p&gt;

&lt;p&gt;but I cannot understand this : In an application with several ZooKeeper clients,&#160;&lt;tt&gt;&lt;b&gt;outgoingQueue&lt;/b&gt; is local&lt;/tt&gt;&#160;and&#160;&lt;b&gt;&lt;tt&gt;state&lt;/tt&gt;&lt;/b&gt;&#160;field is an enum value, which are global objects ?&lt;/p&gt;

&lt;p&gt;Could plz explain this for me ?&lt;/p&gt;</comment>
                            <comment id="17041187" author="sylvain" created="Thu, 20 Feb 2020 17:53:27 +0000"  >&lt;p&gt;We synchronize on the &lt;ins&gt;value&lt;/ins&gt; of the &lt;tt&gt;state&lt;/tt&gt; field, which is one of the members of the &lt;tt&gt;States&lt;/tt&gt; enumeration.&lt;/p&gt;

&lt;p&gt;Since a member of an enumeration is a &lt;tt&gt;public static final&lt;/tt&gt; instance of the enumeration class, this means that &lt;tt&gt;synchronize(state)&lt;/tt&gt; effectively synchronizes on a global object (the enum member), shared by all ZooKeeper clients that may be running.&lt;/p&gt;

&lt;p&gt;Now things get worse as beyond being a shared global object, the value of &lt;tt&gt;state&lt;/tt&gt; changes over time. Which means that the object on which we synchronize may not always be the same, thus defeating the purpose of using synchronization to coordinate access between threads.&lt;/p&gt;

&lt;p&gt;The suggested fix &lt;tt&gt;synchronized(outgoingQueue)&lt;/tt&gt; uses an object that is internal to the client instance and is doesn&apos;t change over time to fix these issues.&lt;/p&gt;

&lt;p&gt;I hope I was clear.&lt;/p&gt;</comment>
                            <comment id="17041741" author="maoling" created="Fri, 21 Feb 2020 10:21:13 +0000"  >&lt;p&gt;&lt;em&gt;&lt;b&gt;---&amp;gt;the value of&#160;&lt;tt&gt;state&lt;/tt&gt;&#160;changes over time. Which means that the object on which we synchronize may not always be the same, thus defeating the purpose of using synchronization to coordinate access between&lt;/b&gt;&lt;/em&gt; &lt;b&gt;threads&lt;/b&gt;&lt;b&gt;.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I write an example to check this. Yes, I can read&#160;&lt;b&gt;Thread name:A-thread, the state is:B&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;EnumTest {

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; States state = States.C;

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; object = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;();

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; States {
        A,
        B,
        C;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {

        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; a = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyThreadA(&lt;span class=&quot;code-quote&quot;&gt;&quot;A-thread&quot;&lt;/span&gt;);
        a.start();

        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; b = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyThreadB(&lt;span class=&quot;code-quote&quot;&gt;&quot;B-thread&quot;&lt;/span&gt;);
        b.start();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyThreadB &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; {

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MyThreadB(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.name = name;
        }

        Random r = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(1);
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (state) {
                    state = States.B;
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        TimeUnit.MILLISECONDS.sleep(r.nextInt(1000));
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                        e.printStackTrace();
                    }
                    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; name:&quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;, the state is:&quot;&lt;/span&gt; + state);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    TimeUnit.MILLISECONDS.sleep(r.nextInt(1000));
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyThreadA &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; {

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MyThreadA(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.name = name;
        }

        Random r = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(1);
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (state) {
                    state = States.A;
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        TimeUnit.MILLISECONDS.sleep(r.nextInt(1000));
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                        e.printStackTrace();
                    }
                    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; name:&quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;, the state is:&quot;&lt;/span&gt; + state);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    TimeUnit.MILLISECONDS.sleep(r.nextInt(1000));
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sylvain&quot; class=&quot;user-hover&quot; rel=&quot;sylvain&quot;&gt;sylvain&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you please help us improve this?&lt;/p&gt;

&lt;p&gt;Zookeeper uses the github workflow. The contributor guideline&lt;br/&gt;
 is &lt;span class=&quot;error&quot;&gt;&amp;#91;here&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&lt;/a&gt;])&lt;/p&gt;</comment>
                            <comment id="17041899" author="sylvain" created="Fri, 21 Feb 2020 14:04:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maoling&quot; class=&quot;user-hover&quot; rel=&quot;maoling&quot;&gt;maoling&lt;/a&gt; I submitted a &lt;a href=&quot;https://github.com/apache/zookeeper/pull/1257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull request&lt;/a&gt; with a fix!&lt;/p&gt;</comment>
                            <comment id="17513978" author="arshad.mohammad" created="Tue, 29 Mar 2022 10:21:02 +0000"  >&lt;p&gt;Good finding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sylvain&quot; class=&quot;user-hover&quot; rel=&quot;sylvain&quot;&gt;sylvain&lt;/a&gt;. I will review and merge your PR.&lt;/p&gt;</comment>
                            <comment id="17514212" author="arshad.mohammad" created="Tue, 29 Mar 2022 17:19:54 +0000"  >&lt;p&gt;Some how wrong version number &quot;3.6.4,3.7.1,3.8.0,3.9.0&quot; got created into the jira system. I will delete this version number&lt;/p&gt;</comment>
                            <comment id="17514877" author="arshad.mohammad" created="Wed, 30 Mar 2022 18:30:04 +0000"  >&lt;p&gt;Issue resolved by pull request 1257&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1257&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17514878" author="arshad.mohammad" created="Wed, 30 Mar 2022 18:31:21 +0000"  >&lt;p&gt;Merged. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sylvain&quot; class=&quot;user-hover&quot; rel=&quot;sylvain&quot;&gt;sylvain&lt;/a&gt; for the contribution.&lt;/p&gt;</comment>
                            <comment id="17515135" author="sylvain@apache.org" created="Thu, 31 Mar 2022 07:41:22 +0000"  >&lt;p&gt;Awesome! Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="17517245" author="symat" created="Tue, 5 Apr 2022 06:28:01 +0000"  >&lt;p&gt;Great catch, thanks for the fix!&lt;/p&gt;

&lt;p&gt;Is there a reason why not to backport this to branch-3.5? (it is an important bugfix and 3.5 is not EoL yet)&lt;/p&gt;</comment>
                            <comment id="17517247" author="symat" created="Tue, 5 Apr 2022 06:33:31 +0000"  >&lt;p&gt;I&apos;ll submit a PR for branch-3.5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12770436">ZOOKEEPER-2111</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09pxk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>