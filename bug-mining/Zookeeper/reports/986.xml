<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-1936] Server exits when unable to create data directory due to race </title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1936</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We sometime see issues with ZooKeeper server not starting and seeing this error in the log:&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-05-27 09:29:48.248&amp;#93;&lt;/span&gt; ERROR   : -               &lt;br/&gt;
.org.apache.zookeeper.server.ZooKeeperServerMain    Unexpected exception,&lt;br/&gt;
exiting abnormally\nexception=\njava.io.IOException: Unable to create data&lt;br/&gt;
directory /home/y/var/zookeeper/version-2\n\tat&lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnSnapLog.&amp;lt;init&amp;gt;(FileTxnSnapLog.java:85)\n\tat&lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:103)\n\tat&lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServerMain.initializeAndRun(ZooKeeperServerMain.java:86)\n\tat&lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServerMain.main(ZooKeeperServerMain.java:52)\n\tat&lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:116)\n\tat&lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\n\t&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Stack trace from JVM gives this:&lt;/p&gt;

&lt;p&gt;&quot;PurgeTask&quot; daemon prio=10 tid=0x000000000201d000 nid=0x1727 runnable&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f55d7dc7000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
    at java.io.UnixFileSystem.createDirectory(Native Method)&lt;br/&gt;
    at java.io.File.mkdir(File.java:1310)&lt;br/&gt;
    at java.io.File.mkdirs(File.java:1337)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnSnapLog.&amp;lt;init&amp;gt;(FileTxnSnapLog.java:84)&lt;br/&gt;
    at org.apache.zookeeper.server.PurgeTxnLog.purge(PurgeTxnLog.java:68)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.DatadirCleanupManager$PurgeTask.run(DatadirCleanupManager.java:140)&lt;br/&gt;
    at java.util.TimerThread.mainLoop(Timer.java:555)&lt;br/&gt;
    at java.util.TimerThread.run(Timer.java:505)&lt;/p&gt;

&lt;p&gt;&quot;zookeeper server&quot; prio=10 tid=0x00000000027df800 nid=0x1715 runnable&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f55d7ed8000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
    at java.io.UnixFileSystem.createDirectory(Native Method)&lt;br/&gt;
    at java.io.File.mkdir(File.java:1310)&lt;br/&gt;
    at java.io.File.mkdirs(File.java:1337)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.persistence.FileTxnSnapLog.&amp;lt;init&amp;gt;(FileTxnSnapLog.java:84)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:103)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServerMain.initializeAndRun(ZooKeeperServerMain.java:86)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.ZooKeeperServerMain.main(ZooKeeperServerMain.java:52)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:116)&lt;br/&gt;
    at&lt;br/&gt;
org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;So it seems that when autopurge is used (as it is in our case), it might happen at the same time as starting the server itself. In FileTxnSnapLog() it will check if the directory exists and create it if not. These two tasks do this at the same time, and mkdir fails and server exits the JVM.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12720291">ZOOKEEPER-1936</key>
            <summary>Server exits when unable to create data directory due to race </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yuzhihong@gmail.com">Ted Yu</assignee>
                                    <reporter username="hmusum">Harald Musum</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 10 Jun 2014 07:25:37 +0000</created>
                <updated>Fri, 24 Jan 2020 14:20:39 +0000</updated>
                            <resolved>Thu, 23 Jan 2020 15:47:09 +0000</resolved>
                                    <version>3.4.6</version>
                    <version>3.5.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>16</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="14104283" author="apurtell" created="Wed, 20 Aug 2014 18:24:07 +0000"  >&lt;p&gt;Attached patch applies to trunk and branch-3.4&lt;/p&gt;</comment>
                            <comment id="14104625" author="hadoopqa" created="Wed, 20 Aug 2014 21:24:30 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12663176/ZOOKEEPER-1936.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12663176/ZOOKEEPER-1936.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1619166.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2292//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2292//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14105744" author="rgs" created="Thu, 21 Aug 2014 18:35:59 +0000"  >&lt;p&gt;lgtm, +1. cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15089595" author="yuzhihong@gmail.com" created="Fri, 8 Jan 2016 17:48:22 +0000"  >&lt;p&gt;We encountered this issue during testing, though intermittently.&lt;/p&gt;

&lt;p&gt;Can the fix be committed ?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15089628" author="hadoopqa" created="Fri, 8 Jan 2016 18:15:12 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12663176/ZOOKEEPER-1936.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12663176/ZOOKEEPER-1936.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1720227.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3005//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3005//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15089636" author="yuzhihong@gmail.com" created="Fri, 8 Jan 2016 18:18:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;:&lt;br/&gt;
Can you take a look ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="15098985" author="yuzhihong@gmail.com" created="Thu, 14 Jan 2016 22:12:00 +0000"  >&lt;p&gt;Alternate patch for consideration.&lt;/p&gt;

&lt;p&gt;Only throw exception if dataDir doesn&apos;t exist and mkdirs() call fails.&lt;/p&gt;</comment>
                            <comment id="15098999" author="rgs" created="Thu, 14 Jan 2016 22:15:00 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tedyu@apache.org&quot;&gt;tedyu@apache.org&lt;/a&gt; - looking. Maybe we can get this in for 3.4.8 as well. &lt;/p&gt;</comment>
                            <comment id="15099001" author="rgs" created="Thu, 14 Jan 2016 22:16:17 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15099184" author="hadoopqa" created="Fri, 15 Jan 2016 00:21:15 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12782377/ZOOKEEPER-1936.v2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12782377/ZOOKEEPER-1936.v2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1720227.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3008//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3008//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15101270" author="rakeshr" created="Fri, 15 Jan 2016 06:12:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt; for the fix. +1 for the additional &lt;tt&gt;#exists()&lt;/tt&gt; check.&lt;/p&gt;

&lt;p&gt;I&apos;ve few comments:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Could you consider &lt;tt&gt;snapDir&lt;/tt&gt; creation too.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.mkdirs()) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create snap directory &quot;&lt;/span&gt;
                        + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Can we reduce the nested calls. How about using AND operator like,
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.mkdirs() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.exists())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15101984" author="fpj" created="Fri, 15 Jan 2016 16:10:13 +0000"  >&lt;p&gt;what happens if the call to mkdir legitimaly fails? It looks like we would assume that the directory exists and would move on. I think we need to differentiate the dir existing from other issues when creating it. Does it sound reasonable?&lt;/p&gt;</comment>
                            <comment id="15102058" author="yuzhihong@gmail.com" created="Fri, 15 Jan 2016 16:50:54 +0000"  >&lt;p&gt;After logging onto the node where the error happened, we found that dataDir didn&apos;t exist. &lt;br/&gt;
So my patch doesn&apos;t suffice. &lt;/p&gt;

&lt;p&gt;Manual start on that node didn&apos;t reproduce the error though.&lt;/p&gt;

&lt;p&gt;Comment is welcome.&lt;/p&gt;</comment>
                            <comment id="15102249" author="cnauroth" created="Fri, 15 Jan 2016 18:26:45 +0000"  >&lt;p&gt;I&apos;m in favor of the approach in patch v2.  This would be a deterministic fix.  Adding a delay like the first patch might still not work if we got unlucky in the way the OS scheduled the threads.  What do others think?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;tedyu&lt;/a&gt;, could you please do the following?&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Make the same fix for &lt;tt&gt;snapDir&lt;/tt&gt;, which is right after the code you already changed in &lt;tt&gt;FileTxnSnapLog&lt;/tt&gt;.  Otherwise, we might get past the &lt;tt&gt;dataDir&lt;/tt&gt; creation only to fail again on &lt;tt&gt;snapDir&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Post 2 patch files: one that applied to trunk and one that applies to branch-3.4.&lt;/li&gt;
	&lt;li&gt;Generate the patch files with &lt;tt&gt;git diff --no-prefix&lt;/tt&gt; for compatibility with our pre-commit automation.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                            <comment id="15102276" author="yuzhihong@gmail.com" created="Fri, 15 Jan 2016 18:42:13 +0000"  >&lt;p&gt;Patch v3 addresses comments from Chris and Rakesh.&lt;/p&gt;

&lt;p&gt;The same patch can be applied smoothly on branch-3.4&lt;/p&gt;

&lt;p&gt;Let me know if separate patch for branch-3.4 should be attached.&lt;/p&gt;</comment>
                            <comment id="15102294" author="fpj" created="Fri, 15 Jan 2016 18:55:07 +0000"  >&lt;p&gt;but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ted_yu&quot; class=&quot;user-hover&quot; rel=&quot;ted_yu&quot;&gt;ted_yu&lt;/a&gt; said that even with his patch &lt;tt&gt;dataDir&lt;/tt&gt; wasn&apos;t created, and if what you suggest in step 1 fixed it, then the directory would be there, no? I&apos;m actually wondering if there is something else causing trouble.&lt;/p&gt;</comment>
                            <comment id="15102301" author="hadoopqa" created="Fri, 15 Jan 2016 18:57:27 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12782581/ZOOKEEPER-1936.v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12782581/ZOOKEEPER-1936.v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1720227.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3009//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3009//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15102307" author="cnauroth" created="Fri, 15 Jan 2016 19:02:24 +0000"  >&lt;p&gt;Yeah, my comments got crossed up, because I hadn&apos;t refreshed the page to see the latest.&lt;/p&gt;

&lt;p&gt;Unfortunately, &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/io/File.html#mkdirs()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;File#mkdirs&lt;/tt&gt;&lt;/a&gt; only gives us a boolean response with no further information about root cause.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;tedyu&lt;/a&gt;, do you think you can try as a troubleshooting step switching it to call &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#createDirectories(java.nio.file.Path,%20java.nio.file.attribute.FileAttribute...)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Files#createDirectories&lt;/tt&gt;&lt;/a&gt; ?  That might give us more detailed information about the error.&lt;/p&gt;

&lt;p&gt;We can&apos;t use the JDK 1.7 file APIs in the 3.4 maintenance line, so this would just be a temporary troubleshooting step.  We can use those APIs in trunk/branch-3.5 though.&lt;/p&gt;</comment>
                            <comment id="15108039" author="rgs" created="Wed, 20 Jan 2016 05:35:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tedyu@apache.org&quot;&gt;tedyu@apache.org&lt;/a&gt;: mind generating the patch with something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git diff --no-prefix HEAD~1.. &amp;gt; ZOOKEEPER-1936.patch
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The latest one you uploaded didn&apos;t apply cleanly. Patch lgtm, +1.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;: mind giving it one last look?&lt;/p&gt;</comment>
                            <comment id="15108068" author="yuzhihong@gmail.com" created="Wed, 20 Jan 2016 06:05:07 +0000"  >&lt;p&gt;Previous patch was generated for branch-3.4&lt;/p&gt;

&lt;p&gt;Attached patch for trunk.&lt;/p&gt;</comment>
                            <comment id="15108083" author="rakeshr" created="Wed, 20 Jan 2016 06:17:15 +0000"  >&lt;p&gt;For better understanding about the target branch, probably can include branch details while naming the patch, something like &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&quot; title=&quot;Server exits when unable to create data directory due to race &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1936&quot;&gt;&lt;del&gt;ZOOKEEPER-1936&lt;/del&gt;&lt;/a&gt;-br-3-4.patch&lt;/tt&gt; and for trunk can use like &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&quot; title=&quot;Server exits when unable to create data directory due to race &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1936&quot;&gt;&lt;del&gt;ZOOKEEPER-1936&lt;/del&gt;&lt;/a&gt;.patch&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15108088" author="hadoopqa" created="Wed, 20 Jan 2016 06:20:43 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12783285/ZOOKEEPER-1936.v3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12783285/ZOOKEEPER-1936.v3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1720227.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15108940" author="yuzhihong@gmail.com" created="Wed, 20 Jan 2016 17:08:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//testReport/org.apache.zookeeper.test/AsyncHammerTest/testHammer/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3010//testReport/org.apache.zookeeper.test/AsyncHammerTest/testHammer/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;doesn&apos;t seem to be related to the patch.&lt;/p&gt;</comment>
                            <comment id="15113278" author="yuzhihong@gmail.com" created="Fri, 22 Jan 2016 22:47:48 +0000"  >&lt;p&gt;Any thing I need to do here ? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15123906" author="cnauroth" created="Fri, 29 Jan 2016 18:18:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt;, my understanding is that you only can repro this in standalone mode, not when deploying a full ensemble.  Is that correct?  Did you get to a point where you had a consistent repro and were able to verify that this patch helped fix it?&lt;/p&gt;

&lt;p&gt;The logic change looks correct to me, but I&apos;m trying to figure out if there is really something more going on, as suggested in earlier comments.  Thanks!&lt;/p&gt;</comment>
                            <comment id="15123934" author="yuzhihong@gmail.com" created="Fri, 29 Jan 2016 18:32:03 +0000"  >&lt;p&gt;Haven&apos;t got a chance to reproduce the bug.&lt;/p&gt;

&lt;p&gt;After some QE fix, hbase un-secure deployment works reliably.&lt;/p&gt;</comment>
                            <comment id="15123961" author="cnauroth" created="Fri, 29 Jan 2016 18:44:03 +0000"  >&lt;p&gt;It&apos;s a tough call then.  I don&apos;t see a way to write a deterministic JUnit test to prove the fix.  I&apos;m reluctant to accept a code change without a test or a manual verification, at least on a stable maintenance line.&lt;/p&gt;

&lt;p&gt;Here is my take on it.  Even without a consistent repro, I see the theoretical problem in the code.  The logic change in the patch looks correct to me, even if there might have been something more happening when Ted reported it.  Let&apos;s put a fix into trunk and branch-3.5, but not branch-3.4.  In trunk and branch-3.5, we also can make the switch to &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/nio/file/Files.html#createDirectories(java.nio.file.Path,%20java.nio.file.attribute.FileAttribute...)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Files#createDirectories&lt;/tt&gt;&lt;/a&gt; that I mentioned earlier, because those branches are compiling to JDK 7.  That way, if we see another repro, we&apos;ll get additional debugging information to help with any subsequent patches.&lt;/p&gt;

&lt;p&gt;Would some other committers like to comment on that plan?  Thanks!&lt;/p&gt;</comment>
                            <comment id="15124007" author="yuzhihong@gmail.com" created="Fri, 29 Jan 2016 19:08:42 +0000"  >&lt;p&gt;Patch v4 addresses Chris&apos; comment above&lt;/p&gt;</comment>
                            <comment id="15124017" author="hadoopqa" created="Fri, 29 Jan 2016 19:15:00 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785223/ZOOKEEPER-1936.v4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785223/ZOOKEEPER-1936.v4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3021//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3021//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15124054" author="hadoopqa" created="Fri, 29 Jan 2016 19:31:04 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785224/ZOOKEEPER-1936.v4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785224/ZOOKEEPER-1936.v4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3022//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3022//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3022//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3022//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3022//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3022//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15124117" author="cnauroth" created="Fri, 29 Jan 2016 20:04:53 +0000"  >&lt;p&gt;There was a test failure in &lt;tt&gt;WatcherTest#testWatcherAutoResetWithLocal&lt;/tt&gt;, but I can&apos;t reproduce it.&lt;/p&gt;</comment>
                            <comment id="15397513" author="mumrah" created="Thu, 28 Jul 2016 13:10:54 +0000"  >&lt;p&gt;Are there any known scenarios that will trigger this race? We&apos;ve seen it intermittently in an EC2 environment, but have yet to figure out why it happens there and not other environments. &lt;/p&gt;

&lt;p&gt;Also, any updates on the status of this issue?&lt;/p&gt;</comment>
                            <comment id="15397533" author="hadoopqa" created="Thu, 28 Jul 2016 13:35:51 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785224/ZOOKEEPER-1936.v4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785224/ZOOKEEPER-1936.v4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1754188.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3298//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3298//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3298//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3298//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3298//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3298//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15397919" author="cnauroth" created="Thu, 28 Jul 2016 18:03:26 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mumrah&quot; class=&quot;user-hover&quot; rel=&quot;mumrah&quot;&gt;mumrah&lt;/a&gt;.  At this point, I don&apos;t believe any of us have a repro, so bringing in this patch was not prioritized.  I&apos;m going to update fix version to 3.5.3 to indicate that as the next potential release to contain the patch.&lt;/p&gt;

&lt;p&gt;I&apos;m curious if you are running the 3.5 release line of ZooKeeper, and if so, do you have the ability to apply the latest proposed patch?  If we can get confirmation that the patch fixes the problem you&apos;re seeing in your environment, then that would help build confidence in the patch.&lt;/p&gt;</comment>
                            <comment id="15398047" author="nicholas.dipiazza" created="Thu, 28 Jul 2016 19:11:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; Is it going to be viciously hard to patch this against the 3.4 release? I took a stab at it and the codebases are pretty different so i didn&apos;t get too far and figured I&apos;d ask you.&lt;/p&gt;

&lt;p&gt;I looking into testing on the latest branch&lt;/p&gt;</comment>
                            <comment id="15398125" author="cnauroth" created="Thu, 28 Jul 2016 20:07:33 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicholas.dipiazza&quot; class=&quot;user-hover&quot; rel=&quot;nicholas.dipiazza&quot;&gt;nicholas.dipiazza&lt;/a&gt;.  The v3 patch attachment is similar logic that is compatible with the 3.4 release line.  If you can test your 3.4-based environment with that patch, then that would be interesting for us.  Thanks!&lt;/p&gt;</comment>
                            <comment id="15398609" author="nicholas.dipiazza" created="Fri, 29 Jul 2016 02:26:03 +0000"  >&lt;p&gt;v1 and v2 patch with no changes. v3 doesn&apos;t:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;branch-3.4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;patch -p0 &amp;lt; ZOOKEEPER-1936.v3.patch
patching file src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
Hunk #1 FAILED at 101.
Hunk #2 FAILED at 117.
2 out of 2 hunks FAILED -- saving rejects to file src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java.rej
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cat src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java.rej
--- src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
+++ src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
@@ -101,7 +101,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FileTxnSnapLog(File dataDir, File snapDir) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
                         + &lt;span class=&quot;code-quote&quot;&gt;&quot; is &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;). Please create &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; directory manually.&quot;&lt;/span&gt;);
             }
 
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.mkdirs()) {
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.mkdirs() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.exists()) {
                 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create data directory &quot;&lt;/span&gt;
                         + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir);
             }
@@ -117,7 +117,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FileTxnSnapLog(File dataDir, File snapDir) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
                         + &lt;span class=&quot;code-quote&quot;&gt;&quot; is &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;). Please create &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; directory manually.&quot;&lt;/span&gt;);
             }
 
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.mkdirs()) {
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.mkdirs() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.exists()) {
                 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create snap directory &quot;&lt;/span&gt;
                         + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir);
             }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My attempt at patching 3.4.9:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/75&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;*&lt;b&gt;zookeeper-1936-port-3.4.patch&lt;/b&gt;*&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java
index b1682c3..3f26b0a 100644
--- a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java
+++ b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java
@@ -355,7 +355,20 @@
      * logs
      */
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TxnIterator read(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; zxid) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileTxnIterator(logDir, zxid);
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; read(zxid, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
+    }
+
+    /**
+     * start reading all the transactions from the given zxid.
+     *
+     * @param zxid the zxid to start reading transactions from
+     * @param fastForward &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the iterator should be fast forwarded to point
+     *        to the txn of a given zxid, &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; the iterator will point to the
+     *        starting txn of a txnlog that may contain txn of a given zxid
+     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; returns an iterator to iterate through the transaction logs
+     */
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TxnIterator read(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; zxid, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fastForward) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileTxnIterator(logDir, zxid, fastForward);
     }
 
     /**
@@ -375,10 +388,10 @@
             }
             &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; pos = input.getPosition();
             &lt;span class=&quot;code-comment&quot;&gt;// now, truncate at the current position
&lt;/span&gt;-            RandomAccessFile raf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessFile(itr.logFile, &lt;span class=&quot;code-quote&quot;&gt;&quot;rw&quot;&lt;/span&gt;);
+            RandomAccessFile raf=&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RandomAccessFile(itr.logFile,&lt;span class=&quot;code-quote&quot;&gt;&quot;rw&quot;&lt;/span&gt;);
             raf.setLength(pos);
             raf.close();
-            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (itr.goToNextLog()) {
+            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(itr.goToNextLog()) {
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!itr.logFile.delete()) {
                     LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to truncate {}&quot;&lt;/span&gt;, itr.logFile);
                 }
@@ -523,12 +536,34 @@
          * create an iterator over a transaction database directory
          * @param logDir the transaction database directory
          * @param zxid the zxid to start reading from
+         * @param fastForward   &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the iterator should be fast forwarded to
+         *        point to the txn of a given zxid, &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; the iterator will
+         *        point to the starting txn of a txnlog that may contain txn of
+         *        a given zxid
+         * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
+         */
+        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FileTxnIterator(File logDir, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; zxid, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fastForward)
+                &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.logDir = logDir;
+            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zxid = zxid;
+            init();
+
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fastForward &amp;amp;&amp;amp; hdr != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (hdr.getZxid() &amp;lt; zxid) {
+                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!next())
+                        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
+                }
+            }
+        }
+        
+        /**
+         * create an iterator over a transaction database directory
+         * @param logDir the transaction database directory
+         * @param zxid the zxid to start reading from
          * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
          */
         &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FileTxnIterator(File logDir, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; zxid) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
-          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.logDir = logDir;
-          &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.zxid = zxid;
-          init();
+            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(logDir, zxid, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
         }
 
         /**
@@ -552,10 +587,17 @@
             goToNextLog();
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!next())
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
-            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (hdr.getZxid() &amp;lt; zxid) {
-                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!next())
-                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
+        }
+        
+        /**
+         * Return total storage size of txnlog that will &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; by &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; iterator.
+         */
+        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; getStorageSize() {
+            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sum = 0;
+            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (File f : storedFiles) {
+                sum += f.length();
             }
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; sum;
         }
 
         /**
@@ -637,8 +679,6 @@
                 crc.update(bytes, 0, bytes.length);
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (crcValue != crc.getValue())
                     &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(CRC_ERROR);
-                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bytes == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || bytes.length == 0)
-                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                 hdr = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TxnHeader();
                 record = SerializeUtils.deserializeTxn(bytes, hdr);
             } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (EOFException e) {
diff --git a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
index 6f0df51..98d94b4 100644
--- a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
+++ b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
@@ -58,6 +58,10 @@
     
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger LOG = LoggerFactory.getLogger(FileTxnSnapLog.class);
     
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; ZOOKEEPER_DATADIR_AUTOCREATE =
+            &lt;span class=&quot;code-quote&quot;&gt;&quot;zookeeper.datadir.autocreate&quot;&lt;/span&gt;;
+
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; ZOOKEEPER_DATADIR_AUTOCREATE_DEFAULT = &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;;
     /**
      * This listener helps
      * the external apis calling
@@ -80,15 +84,38 @@
 
         &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(dataDir, version + VERSION);
         &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(snapDir, version + VERSION);
+        &lt;span class=&quot;code-comment&quot;&gt;// by &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; create snap/log dirs, but otherwise complain instead
&lt;/span&gt;+        &lt;span class=&quot;code-comment&quot;&gt;// See ZOOKEEPER-1161 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details
&lt;/span&gt;+        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; enableAutocreate = &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.valueOf(
+                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(ZOOKEEPER_DATADIR_AUTOCREATE,
+                        ZOOKEEPER_DATADIR_AUTOCREATE_DEFAULT));
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.exists()) {
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.mkdirs()) {
-                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create data directory &quot;&lt;/span&gt;
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!enableAutocreate) {
+                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Missing data directory &quot;&lt;/span&gt;
+                        + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir
+                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;, automatic data directory creation is disabled (&quot;&lt;/span&gt;
+                        + ZOOKEEPER_DATADIR_AUTOCREATE
+                        + &lt;span class=&quot;code-quote&quot;&gt;&quot; is &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;). Please create &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; directory manually.&quot;&lt;/span&gt;);
+            }
+
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.mkdirs() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir.exists()) {
+                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create data directory &quot;&lt;/span&gt;
                         + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataDir);
             }
         }
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.exists()) {
-            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.mkdirs()) {
-                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create snap directory &quot;&lt;/span&gt;
+            &lt;span class=&quot;code-comment&quot;&gt;// by &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; create &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; directory, but otherwise complain instead
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// See ZOOKEEPER-1161 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!enableAutocreate) {
+                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Missing snap directory &quot;&lt;/span&gt;
+                        + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir
+                        + &lt;span class=&quot;code-quote&quot;&gt;&quot;, automatic data directory creation is disabled (&quot;&lt;/span&gt;
+                        + ZOOKEEPER_DATADIR_AUTOCREATE
+                        + &lt;span class=&quot;code-quote&quot;&gt;&quot; is &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;). Please create &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; directory manually.&quot;&lt;/span&gt;);
+            }
+
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.mkdirs() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir.exists()) {
+                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DatadirException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to create snap directory &quot;&lt;/span&gt;
                         + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.snapDir);
             }
         }
@@ -164,6 +191,33 @@
             }
         }
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; highestZxid;
+    }
+
+    /**
+     * Get TxnIterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; iterating through txnlog starting at a given zxid
+     *
+     * @param zxid starting zxid
+     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TxnIterator
+     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
+     */
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TxnIterator readTxnLog(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; zxid) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; readTxnLog(zxid, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
+    }
+
+    /**
+     * Get TxnIterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; iterating through txnlog starting at a given zxid
+     *
+     * @param zxid starting zxid
+     * @param fastForward &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the iterator should be fast forwarded to point
+     *        to the txn of a given zxid, &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; the iterator will point to the
+     *        starting txn of a txnlog that may contain txn of a given zxid
+     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TxnIterator
+     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
+     */
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TxnIterator readTxnLog(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; zxid, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fastForward)
+            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
+        FileTxnLog txnLog = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileTxnLog(dataDir);
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; txnLog.read(zxid, fastForward);
     }
     
     /**
@@ -338,4 +392,14 @@
         txnLog.close();
         snapLog.close();
     }
+
+    @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;serial&quot;&lt;/span&gt;)
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DatadirException &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; IOException {
+        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DatadirException(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg) {
+            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(msg);
+        }
+        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DatadirException(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg, Exception e) {
+            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(msg, e);
+        }
+    }
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;UPDATE:&lt;/b&gt; Testing 3.4.9 with this patch looks ok for me. you might have squashed this issue.&lt;/p&gt;</comment>
                            <comment id="15398742" author="githubbot" created="Fri, 29 Jul 2016 05:38:22 +0000"  >&lt;p&gt;GitHub user nddipiazza opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/75&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    port fix to 3.4&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/nddipiazza/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nddipiazza/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&quot; title=&quot;Server exits when unable to create data directory due to race &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1936&quot;&gt;&lt;del&gt;ZOOKEEPER-1936&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/75.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/75.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #75&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit bdd8798895e21bf3158c63c1d00aa99fba5e9f34&lt;br/&gt;
Author: Nicholas DiPiazza &amp;lt;nicholas.dipiazza@lucidworks.com&amp;gt;&lt;br/&gt;
Date:   2016-07-29T05:32:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1936&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;    port fix to 3.4&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15505015" author="cnauroth" created="Mon, 19 Sep 2016 23:27:37 +0000"  >&lt;p&gt;This patch has been stalled, because there is no easy way to write a unit test for it, and no one has been able to produce a consistent repro in a live environment.&lt;/p&gt;

&lt;p&gt;I have good news.  I was able to find a consistent repro with an environment that could reproduce the problem in approximately 80% of ZooKeeper server starts.  FWIW, the OS was SUSE11sp3, and it was running ZooKeeper 3.4.6.  I applied the v3 patch, deployed it in this environment, and we could no longer repro.&lt;/p&gt;

&lt;p&gt;Based on successful manual testing, I am now +1 to commit patch v4 to trunk and branch-3.5, and commit patch v3 to branch-3.4.  I will wait until later in the week in case other committers who have been watching the issue would like to discuss further.&lt;/p&gt;</comment>
                            <comment id="15531396" author="mattf" created="Thu, 29 Sep 2016 00:45:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, please do commit.  +1.  Thanks.&lt;/p&gt;</comment>
                            <comment id="15534026" author="cnauroth" created="Thu, 29 Sep 2016 20:56:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, could I please trouble one of you to do one last review pass to make sure we&apos;re in agreement before I commit?  Thank you.&lt;/p&gt;</comment>
                            <comment id="15536684" author="fpj" created="Fri, 30 Sep 2016 18:36:52 +0000"  >&lt;p&gt;I was looking at this pull request:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/75.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/75.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but it looks like it doesn&apos;t correspond to the v4 patch attached. What is it precisely that we are proposing to merge?&lt;/p&gt;</comment>
                            <comment id="15536734" author="fpj" created="Fri, 30 Sep 2016 18:52:10 +0000"  >&lt;p&gt;Is it better to catch &lt;tt&gt;FileAlreadyExistsException&lt;/tt&gt; for the &lt;tt&gt;Files.createDirectories&lt;/tt&gt; call to be safe, in the case the directory is created concurrently?&lt;/p&gt;

&lt;p&gt;I&apos;m actually wondering why we added that &lt;tt&gt;DatadirException&lt;/tt&gt;. I&apos;d much rather just keep it &lt;tt&gt;IOException&lt;/tt&gt; instead... I understand this isn&apos;t being introduced in this patch, although maybe for 3.4 if we merge there. Actually, what are the fix versions for this issue?   &lt;/p&gt;</comment>
                            <comment id="15536740" author="fpj" created="Fri, 30 Sep 2016 18:56:31 +0000"  >&lt;p&gt;Given that I&apos;m not sure what exactly we are considering to merge at this point, I don&apos;t know who the assignee is. Once we clarify it, I can assign accordingly.&lt;/p&gt;</comment>
                            <comment id="15536893" author="cnauroth" created="Fri, 30 Sep 2016 19:57:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, thank you for looking.  I am proposing that we fix this for 3.5.3 and 3.4.10.  I am proposing separate patches for the 2 branches, so that we can use the NIO APIs with the richer error reporting in trunk/branch-3.5 and use the JDK 6 APIs in branch-3.4.&lt;/p&gt;

&lt;p&gt;I now realize that the trunk/branch-3.5 patch wasn&apos;t ready.  Thanks for pointing out the problem.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt;, would you please update that to catch the exception from &lt;tt&gt;Files#createDirectories&lt;/tt&gt; and allow the method to succeed if the directory already exists?  That will keep it similar to the branch-3.4 logic.  Would you please upload new patch files for both trunk/branch-3.5 and branch-3.4?  That will help eliminate the current confusion about which patch files to use.&lt;/p&gt;

&lt;p&gt;Ted has contributed the most recent patches that I am proposing to commit&#160;after another revision, so I&apos;ll assign to him.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m actually wondering why we added that DatadirException. I&apos;d much rather just keep it IOException instead.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This traces back to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1161&quot; title=&quot;Provide an option for disabling auto-creation of the data directory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1161&quot;&gt;&lt;del&gt;ZOOKEEPER-1161&lt;/del&gt;&lt;/a&gt;, which introduced the ability to disable automatic directory creation.  Part of that includes special handling of &lt;tt&gt;DatadirException&lt;/tt&gt; in &lt;tt&gt;QuorumPeerMain&lt;/tt&gt; and &lt;tt&gt;ZooKeeperServerMain&lt;/tt&gt; so that they can return unique exit codes when directory creation fails.  I think we need to keep this as is for now to preserve backward compatibility.&lt;/p&gt;</comment>
                            <comment id="15550505" author="yuzhihong@gmail.com" created="Thu, 6 Oct 2016 01:10:43 +0000"  >&lt;p&gt;Is there anything I can do to move this forward ?&lt;/p&gt;</comment>
                            <comment id="15551351" author="fpj" created="Thu, 6 Oct 2016 08:45:36 +0000"  >&lt;p&gt;I&apos;d expect &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; to +1 it. In the meanwhile, I&apos;ve had another look, and there are a couple of things I don&apos;t understand:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;With the 3.4 patch, we have this:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (!this.dataDir.exists()) {
            if (!this.dataDir.mkdirs() &amp;amp;&amp;amp; !this.dataDir.exists()) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;why do we need the first call to &lt;tt&gt;this.dataDir.exists()&lt;/tt&gt; and the encapsulating if block? It sounds like we don&apos;t need the outer if block.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In the 3.5 patch, I&apos;m not sure why we need this if:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (!this.snapDir.exists())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the case &lt;tt&gt;Files.createDirectories&lt;/tt&gt; fails to create the directory, then we will have an exception, so the two possible outcomes are: 1) directory is created just fine; 2) exception is thrown. Consequently, it doesn&apos;t look like we need that last if, but maybe I&apos;m missing something.&lt;/p&gt;</comment>
                            <comment id="15930873" author="githubbot" created="Fri, 17 Mar 2017 23:12:11 +0000"  >&lt;p&gt;Github user Humbedooh closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/75&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16028186" author="eolivelli" created="Mon, 29 May 2017 09:58:08 +0000"  >&lt;p&gt;this issue is marked as fixversion = 3.5.4, the PR #75 has been closed.&lt;br/&gt;
I cannot find commits in 3.5 branch&lt;br/&gt;
which is the actual status ?&lt;/p&gt;

&lt;p&gt;I am very interested in this fix&lt;/p&gt;</comment>
                            <comment id="16028323" author="fpj" created="Mon, 29 May 2017 13:22:21 +0000"  >&lt;p&gt;I think it was simply closed, I had a few comments there that were never addressed.&lt;/p&gt;</comment>
                            <comment id="16028326" author="fpj" created="Mon, 29 May 2017 13:25:36 +0000"  >&lt;p&gt;It also looks like the diff was broken as the number of commits listed is large. I haven&apos;t looked closely but it seems that merges weren&apos;t done appropriately.&lt;/p&gt;</comment>
                            <comment id="16028392" author="eolivelli" created="Mon, 29 May 2017 14:14:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I can pick up the issue a propose my local patch.&lt;/p&gt;

&lt;p&gt;This issue is quite annoying in JUnit tests cases of projects which use ZK and spawn ZK servers.&lt;/p&gt;

&lt;p&gt;I would like to provide a patch for 3.5 branch and 3.6&lt;/p&gt;</comment>
                            <comment id="16629504" author="yuzhihong@gmail.com" created="Wed, 26 Sep 2018 23:05:09 +0000"  >&lt;p&gt;Can you outline how you plan to fix ?&lt;/p&gt;

&lt;p&gt;thanks&lt;/p&gt;</comment>
                            <comment id="17022201" author="eolivelli" created="Thu, 23 Jan 2020 15:47:09 +0000"  >&lt;p&gt;Issue resolved by pull request 1225&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1225&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12831161" name="ZOOKEEPER-1936.branch-3.4.patch" size="1232" author="yuzhihong@gmail.com" created="Fri, 30 Sep 2016 20:13:16 +0000"/>
                            <attachment id="12663176" name="ZOOKEEPER-1936.patch" size="1253" author="apurtell" created="Wed, 20 Aug 2014 18:24:07 +0000"/>
                            <attachment id="12782377" name="ZOOKEEPER-1936.v2.patch" size="912" author="yuzhihong@gmail.com" created="Thu, 14 Jan 2016 22:12:00 +0000"/>
                            <attachment id="12783285" name="ZOOKEEPER-1936.v3.patch" size="1221" author="yuzhihong@gmail.com" created="Wed, 20 Jan 2016 06:03:59 +0000"/>
                            <attachment id="12782581" name="ZOOKEEPER-1936.v3.patch" size="1173" author="yuzhihong@gmail.com" created="Fri, 15 Jan 2016 18:38:28 +0000"/>
                            <attachment id="12785224" name="ZOOKEEPER-1936.v4.patch" size="1781" author="yuzhihong@gmail.com" created="Fri, 29 Jan 2016 19:17:32 +0000"/>
                            <attachment id="12831166" name="ZOOKEEPER-1936.v5.patch" size="2200" author="yuzhihong@gmail.com" created="Fri, 30 Sep 2016 20:26:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wlsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398615</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>