<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3296] Cannot join quorum due to Quorum SSLSocket connection not closed explicitly when there is handshake issue</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3296</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Recently, on prod ensembles, we saw some peers failed to connect to others due to timed out when connecting to the other&apos;s leader election port. This was triggered by a network incident with lots of packet loss.&lt;/p&gt;

&lt;p&gt;After investigation, we found it&apos;s because we&#160;doesn&apos;t close the socket explicitly when it timed out during ssl handshake in QuorumCnxManager.connectOne.&lt;/p&gt;

&lt;p&gt;The quorum connection manager is handling connections sequentially with a default listen backlog queue size 50, during the network loss, there are socket read timed out, which is syncLimit * tickTime, and almost all the following connect requests in the backlog queue will timed out from the other side before it&apos;s being processed. Those timed out learners&#160;will try to connect to a different server, and leaves the connect requests on server side without sending the close_notify packet. The server is slowly consuming from these queue with syncLimit * tickTime timeout for each of those requests which haven&apos;t sent notify_close packet. Any new connect requests will be queued up again when there is spot in the listen backlog queue, but timed out before the server handles it, and it can never successfully finish any new connection, so it failed to join the quorum. And&#160;the peers are&#160;leaking FD because all those connections are in CLOSE-WAIT state.&lt;br/&gt;
 &#160;&lt;br/&gt;
 Restarting the servers to drain the listen backlog queue mitigated the issue.&lt;/p&gt;

&lt;p&gt;Here are the steps to manually reproduce the issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;issuing two telnet connect to server A in the quorum without sending any packet&lt;/li&gt;
	&lt;li&gt;stop all other servers&lt;/li&gt;
	&lt;li&gt;start those again&lt;/li&gt;
	&lt;li&gt;server A read timed out from those telnet connect request one by one and it cannot join the quorum anymore&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13220273">ZOOKEEPER-3296</key>
            <summary>Cannot join quorum due to Quorum SSLSocket connection not closed explicitly when there is handshake issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lvfangmin">Fangmin Lv</assignee>
                                    <reporter username="lvfangmin">Fangmin Lv</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 7 Mar 2019 18:07:41 +0000</created>
                <updated>Fri, 14 Jun 2019 12:09:39 +0000</updated>
                            <resolved>Fri, 14 Jun 2019 07:09:58 +0000</resolved>
                                    <version>3.5.4</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="8400">2h 20m</timespent>
                                <comments>
                            <comment id="16863763" author="eolivelli" created="Fri, 14 Jun 2019 07:09:58 +0000"  >&lt;p&gt;Issue resolved by pull request 843&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/843&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16863876" author="hudson" created="Fri, 14 Jun 2019 09:22:30 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #569 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/569/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/569/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3296&quot; title=&quot;Cannot join quorum due to Quorum SSLSocket connection not closed explicitly when there is handshake issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3296&quot;&gt;&lt;del&gt;ZOOKEEPER-3296&lt;/del&gt;&lt;/a&gt;: Explicitly closing the sslsocket when it failed (eolivelli: rev 5874a0f355417024ce8ebe03ab2f6eaf5b9a228c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
	&lt;li&gt;(add) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;(delete) zookeeper-server/src/test/java/org/apache/zookeeper/test/CnxManagerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16863983" author="hudson" created="Fri, 14 Jun 2019 12:09:39 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #403 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/403/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/403/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3296&quot; title=&quot;Cannot join quorum due to Quorum SSLSocket connection not closed explicitly when there is handshake issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3296&quot;&gt;&lt;del&gt;ZOOKEEPER-3296&lt;/del&gt;&lt;/a&gt;: Explicitly closing the sslsocket when it failed (eolivelli: rev 5874a0f355417024ce8ebe03ab2f6eaf5b9a228c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;(delete) zookeeper-server/src/test/java/org/apache/zookeeper/test/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(add) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00gu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>