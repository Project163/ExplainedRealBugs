<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:58:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2141] ACL cache in DataTree never removes entries</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2141</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The problem and potential solutions are discussed in &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/zookeeper-user/201502.mbox/browser&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/zookeeper-user/201502.mbox/browser&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I will attach a proposed patch in due course.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12782166">ZOOKEEPER-2141</key>
            <summary>ACL cache in DataTree never removes entries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adammilnesmith">Adam Milne-Smith</assignee>
                                    <reporter username="karold">Karol Dudzinski</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Mar 2015 10:28:31 +0000</created>
                <updated>Thu, 21 Jul 2016 20:18:31 +0000</updated>
                            <resolved>Wed, 6 Apr 2016 18:09:26 +0000</resolved>
                                    <version>3.4.6</version>
                                    <fixVersion>3.4.9</fixVersion>
                    <fixVersion>3.5.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15002182" author="karold" created="Thu, 12 Nov 2015 14:53:11 +0000"  >&lt;p&gt;I&apos;m attaching a patch which implements the reference counted solution discussed on email.  This patch is for the 3.4 branch.&lt;/p&gt;</comment>
                            <comment id="15002206" author="hadoopqa" created="Thu, 12 Nov 2015 14:59:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12771977/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12771977/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1713774.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2955//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2955//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15186805" author="adammilnesmith" created="Wed, 9 Mar 2016 09:13:11 +0000"  >&lt;p&gt;Attaching trunk patch&lt;/p&gt;</comment>
                            <comment id="15187012" author="hadoopqa" created="Wed, 9 Mar 2016 12:21:22 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12792212/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12792212/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1733679.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 3 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 2 release audit warnings (more than the trunk&apos;s current 0 warnings).&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3094//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15188407" author="phunt" created="Thu, 10 Mar 2016 00:49:21 +0000"  >&lt;p&gt;qabot identified a couple issues:&lt;/p&gt;

&lt;p&gt;1) missing license headers in the new files&lt;br/&gt;
2) findbugs noticed some locking issues.&lt;/p&gt;</comment>
                            <comment id="15188871" author="adammilnesmith" created="Thu, 10 Mar 2016 07:54:25 +0000"  >&lt;p&gt;I&apos;ll take a look and fix these - thanks&lt;/p&gt;</comment>
                            <comment id="15190767" author="adammilnesmith" created="Fri, 11 Mar 2016 10:22:53 +0000"  >&lt;p&gt;Including fix for findbugs issues and headers&lt;/p&gt;</comment>
                            <comment id="15194909" author="adammilnesmith" created="Tue, 15 Mar 2016 08:18:18 +0000"  >&lt;p&gt;QA bot didn&apos;t pick up my last patch upload - JIRA was being incredibly slow at the time so I don&apos;t know if that was related. Uploading the patch again.&lt;/p&gt;</comment>
                            <comment id="15195603" author="phunt" created="Tue, 15 Mar 2016 16:39:26 +0000"  >&lt;p&gt;Hi Adam. qabot only looks at jiras in the &quot;patch availabile&quot; state. You need to &quot;submit patch&quot; button for that to happen.&lt;/p&gt;</comment>
                            <comment id="15195613" author="adammilnesmith" created="Tue, 15 Mar 2016 16:44:18 +0000"  >&lt;p&gt;Thanks Patrick. It looks like I did it correctly the first time but not subsequently.&lt;/p&gt;</comment>
                            <comment id="15195621" author="adammilnesmith" created="Tue, 15 Mar 2016 16:48:45 +0000"  >&lt;p&gt;Ticket in correct state now - uploading patch.&lt;/p&gt;</comment>
                            <comment id="15195968" author="hadoopqa" created="Tue, 15 Mar 2016 18:55:37 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12793592/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12793592/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1735116.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3099//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3099//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3099//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3099//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3099//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3099//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15195985" author="adammilnesmith" created="Tue, 15 Mar 2016 19:04:49 +0000"  >&lt;p&gt;I don&apos;t think the test failure was related to my change but it does look like I might have missed a find bugs warning - sorry about that.&lt;/p&gt;</comment>
                            <comment id="15196255" author="adammilnesmith" created="Tue, 15 Mar 2016 21:04:40 +0000"  >&lt;p&gt;Patrick,&lt;/p&gt;

&lt;p&gt;The remaining findbugs complaint was the lack of synchronisation around &quot;that.aclIndex&quot; in the equals(). The equals is only used by the tests and if passing the findbugs were not a requirement I probably wouldn&apos;t have been too worried about it - I&apos;m not generally fond of an equals including mutable fields. I&apos;ve added the synchronized(that) block in for now. Please do let me know if you don&apos;t think this is appropriate and would prefer something else like moving the equals logic to the test class only. &lt;/p&gt;

&lt;p&gt;I ran test-core-java again locally and  ReconfigRecoveryTest.testCurrentObserverIsParticipantInNewConfig passed. Given the tests in ReconfigRecoveryTest seem a little intermittent on the trunk right now (&lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk-jdk8/521/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk-jdk8/521/&lt;/a&gt;) I don&apos;t think this was related to my change.&lt;/p&gt;

&lt;p&gt;Do let me know if you have any feedback on the code and I&apos;ll have a crack at any changes that you&apos;d like to see.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Adam&lt;/p&gt;</comment>
                            <comment id="15196549" author="hadoopqa" created="Wed, 16 Mar 2016 00:34:41 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12793634/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12793634/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1735116.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3101//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3101//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3101//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3101//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3101//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3101//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15197318" author="fournc" created="Wed, 16 Mar 2016 13:36:40 +0000"  >&lt;p&gt;It&apos;s failing in AsyncHammerTest. Not sure if this is a flaky test or not. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adammilnesmith_gs&quot; class=&quot;user-hover&quot; rel=&quot;adammilnesmith_gs&quot;&gt;adammilnesmith_gs&lt;/a&gt; if you&apos;ll run that test locally and see if you think it should pass, I&apos;ll review this and get it committed. Thanks for this, nice to see you folks contributing!&lt;/p&gt;</comment>
                            <comment id="15197532" author="adammilnesmith" created="Wed, 16 Mar 2016 15:45:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;fournc&lt;/a&gt;. AsyncHammerTest was passing for me locally before I uploaded the most recent patch and it didn&apos;t fail AsyncHammerTest in the version of the patch before that either (PreCommit-ZOOKEEPER-Build/3099). The only change between patches was a synchronize block in an equals that is only invoked by the new test included in the patch.&lt;/p&gt;</comment>
                            <comment id="15199206" author="adammilnesmith" created="Thu, 17 Mar 2016 09:31:00 +0000"  >&lt;p&gt;I just ran the failing test locally 5 times with the patch and 5 times without the patch; it succeeded every time.&lt;/p&gt;</comment>
                            <comment id="15199812" author="hadoopqa" created="Thu, 17 Mar 2016 16:16:50 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12793634/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12793634/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1735369.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3105//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3105//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3105//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3105//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3105//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3105//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15200102" author="fournc" created="Thu, 17 Mar 2016 18:24:43 +0000"  >&lt;p&gt;This one failed on a cpp test....&lt;br/&gt;
 TestReconfigServer::testRemoveConnectedFollowerStarting zookeeper ... FAILED TO START&lt;/p&gt;

&lt;p&gt;Is this test flaky? Does anyone know? I don&apos;t think I can run the cpp tests from my computer.&lt;/p&gt;</comment>
                            <comment id="15203108" author="hadoopqa" created="Sun, 20 Mar 2016 04:53:41 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12793634/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12793634/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1735836.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3112//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3112//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3112//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3112//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3112//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3112//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15204790" author="fournc" created="Mon, 21 Mar 2016 18:13:24 +0000"  >&lt;p&gt;Do you all want this fixed on the 3.4 branch? The patch will only apply to trunk currently. LMK.&lt;/p&gt;</comment>
                            <comment id="15204817" author="adammilnesmith" created="Mon, 21 Mar 2016 18:27:06 +0000"  >&lt;p&gt;Fixing this for the 3.4 branch too would be ideal. Would you like me to provide a modified patch for the 3.4 branch? If so, should I attach it in the same way or differently for the branch version?&lt;/p&gt;</comment>
                            <comment id="15204821" author="fournc" created="Mon, 21 Mar 2016 18:29:20 +0000"  >&lt;p&gt;Yes please just make a patch that applies to the 3.4 branch and attach it here with a naming indication that it&apos;s for 3.4. Thanks!&lt;/p&gt;</comment>
                            <comment id="15204840" author="adammilnesmith" created="Mon, 21 Mar 2016 18:34:45 +0000"  >&lt;p&gt;No problem - will do - I should have some time one evening this week to do it.&lt;/p&gt;</comment>
                            <comment id="15207522" author="fournc" created="Tue, 22 Mar 2016 23:32:49 +0000"  >&lt;p&gt;Reviewed the patch against trunk, +1 on that and checked in. Waiting on patch against 3.4. Checking existing patch against 3.5.&lt;/p&gt;</comment>
                            <comment id="15207534" author="fournc" created="Tue, 22 Mar 2016 23:37:01 +0000"  >&lt;p&gt;Into 3.5 as well. Just waiting on 3.4.&lt;/p&gt;</comment>
                            <comment id="15207709" author="hudson" created="Wed, 23 Mar 2016 01:48:13 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2865 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2865/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2865/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2141&quot; title=&quot;ACL cache in DataTree never removes entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2141&quot;&gt;&lt;del&gt;ZOOKEEPER-2141&lt;/del&gt;&lt;/a&gt;. ACL cache in DataTree never removes entries&lt;br/&gt;
(Adam Milne-Smith via camille) (camille: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1736259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1736259&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk&lt;/li&gt;
	&lt;li&gt;trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/DataTree.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/FinalRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ReferenceCountedACLCache.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ZKDatabase.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/server/ReferenceCountedACLCacheTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15213623" author="adammilnesmith" created="Sun, 27 Mar 2016 21:18:06 +0000"  >&lt;p&gt;Sorry for the delay - I&apos;ve attached a patch for the 3.4 branch. I ran test-core-java successfully twice. If there are any issues with it please let me know. Thanks!&lt;/p&gt;</comment>
                            <comment id="15213625" author="hadoopqa" created="Sun, 27 Mar 2016 21:20:20 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12795560/ZOOKEEPER-2141-3.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12795560/ZOOKEEPER-2141-3.4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1736259.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3123//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3123//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15213628" author="adammilnesmith" created="Sun, 27 Mar 2016 21:29:04 +0000"  >&lt;p&gt;QA bot tried to apply the 3.4 branch patch to trunk, hence the failure above.&lt;/p&gt;</comment>
                            <comment id="15216359" author="fournc" created="Tue, 29 Mar 2016 17:15:23 +0000"  >&lt;p&gt;This is great, +1 on all of it, I&apos;ve applied to trunk, 3.5 and 3.4. Thank you all!&lt;/p&gt;</comment>
                            <comment id="15216993" author="eribeiro" created="Tue, 29 Mar 2016 22:38:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adammilnesmith&quot; class=&quot;user-hover&quot; rel=&quot;adammilnesmith&quot;&gt;adammilnesmith&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;fournc&lt;/a&gt;, I am &lt;b&gt;really&lt;/b&gt; sorry for only having (limited) time to review/check this patch after it has been committed to trunk. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; So, please, take it more like a couple of highlights, if you like.&lt;/p&gt;

&lt;p&gt;The patch is really cool, and great work, but I have seen some things that raised some questions I would like to point, plus a couple of minor (i.e., irrelevant) issues.&lt;/p&gt;

&lt;p&gt;1. The piece of code below, from &lt;tt&gt;ReferenceCountedACLCache&lt;/tt&gt;, worried me a bit:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; equals(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; o) {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; == o) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (o == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || getClass() != o.getClass()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

    ReferenceCountedACLCache that = (ReferenceCountedACLCache) o;
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (that) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (aclIndex != that.aclIndex) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }    
        (...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See, we are acquiring a lock of object &lt;tt&gt;foo1&lt;/tt&gt; and then acquiring the lock of object &lt;tt&gt;foo2&lt;/tt&gt; (&lt;tt&gt;that&lt;/tt&gt;, in this case) inside it. My question is: wouldn&apos;t this potentially leads to a DEADLOCK? I mean, imagine a situation below, or something alike:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1: foo1.equals(foo2);
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-2: foo2.equals(foo1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess that with the &lt;b&gt;right thread interleaving&lt;/b&gt;, it could lead to a deadlock. I was so amused by this possibility that wrote a dummy snippet to evaluate  this, as you can see here (with appropriate insertion of  &lt;tt&gt;Thread.sleeps&lt;/tt&gt; to reproduce the desired interleaving):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/eribeiro/bd2aca6fbae0255b64ba0b4f896e6a8d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/eribeiro/bd2aca6fbae0255b64ba0b4f896e6a8d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and got some runs to successfully reproduce a deadlock as seen here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/eribeiro/96f95b295a4b90c0d261057d4542063a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/eribeiro/96f95b295a4b90c0d261057d4542063a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Disclaimer: maybe this situation NEVER happens in this particular case (if so, sorry for disturbing you, &lt;b&gt;really&lt;/b&gt;), but I thought it was worth mentioning. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I &lt;b&gt;guess&lt;/b&gt; a possible solution would be to make &lt;tt&gt;aclIndex&lt;/tt&gt; a &lt;tt&gt;volatile&lt;/tt&gt; variable as a &quot;lightweight&quot; alternative to &lt;tt&gt;synchronized&lt;/tt&gt;, right? Volatile makes has a happens before semantic and it prevents reordering of statements. Wdyt?&lt;/p&gt;

&lt;p&gt;2. The inherited code has the following snippet (now moved to &lt;tt&gt;ReferenceCountedACLCache&lt;/tt&gt;):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; convertAcls(List&amp;lt;ACL&amp;gt; acls) {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acls == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1L;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What if the acls list is empty, i.e., &lt;tt&gt;acls = new ArrayList&amp;lt;&amp;gt;()&lt;/tt&gt;? It&apos;s okay to cache an empty ACL &lt;tt&gt;List&lt;/tt&gt; or could we just change the lines above to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; convertAcls(List&amp;lt;ACL&amp;gt; acls) {
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acls == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || acls.isEmpty())
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1L;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Again, this can NEVER happen in this case above so, I am all for letting it as-is today. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;p&gt; 3. The comment in the following snippet seems a bit out of date (list of longs???):&lt;/p&gt;

 &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * converts the list of acls to a list of longs.
     * Increments the reference counter &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; ACL.
     * @param acls
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a list of longs that map to the acls
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; convertAcls(List&amp;lt;ACL&amp;gt; acls) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; 4. AtomicLongWithEquals extends AtomicLong. I failed to see a &lt;em&gt;good&lt;/em&gt; reason to create a custom AtomicLong, as its instances are not used as keys. What is the rationale behind this? Disclaimer: IMO, extending a j.u. library is an anti-pattern as we don&apos;t have control over it and future changes in the parent class can easily break the codebase.&lt;/p&gt;


&lt;p&gt; 5. ReferenceCountedACLCache.OPEN_UNSAFE_ACL_ID could be made static besides being final.&lt;/p&gt;

&lt;p&gt; 6. ReferenceCountedACLCacheTest#convertACLsNTimes performs n-1 convertions as seen here (see the ``&amp;lt;`` and the ``-1``):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; num -1; i++) {
		cache.convertAcls(acl);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is this the intended behaviour?&lt;/p&gt;

&lt;p&gt;There are other irrelevant observations, but I will refrain myself from citing them by now.&lt;/p&gt;

&lt;p&gt;Cheers!&lt;br/&gt;
Eddie&lt;/p&gt;</comment>
                            <comment id="15217052" author="fournc" created="Tue, 29 Mar 2016 23:24:25 +0000"  >&lt;p&gt;Nice catch Eddie. Issue #1 is worth addressing, I&apos;m less sure about the rest. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adammilnesmith&quot; class=&quot;user-hover&quot; rel=&quot;adammilnesmith&quot;&gt;adammilnesmith&lt;/a&gt; why did you synchronize that value in the equals?&lt;/p&gt;</comment>
                            <comment id="15217445" author="fpj" created="Wed, 30 Mar 2016 05:51:52 +0000"  >&lt;p&gt;I&apos;m changing the priority to blocker to make sure we don&apos;t ship the next release with a deadlock in it. Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eribeiro&quot; class=&quot;user-hover&quot; rel=&quot;eribeiro&quot;&gt;eribeiro&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15217496" author="fpj" created="Wed, 30 Mar 2016 06:31:22 +0000"  >&lt;p&gt;Ok, I checked the code &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eribeiro&quot; class=&quot;user-hover&quot; rel=&quot;eribeiro&quot;&gt;eribeiro&lt;/a&gt; has pointed out and it seems to be fairly harmless because it is in the equals code of the new cache class and I haven&apos;t seen it called anywhere else other than one test case (&lt;tt&gt;testSerializeDesirialize&lt;/tt&gt;). We should fix it nonetheless.&lt;/p&gt;

&lt;p&gt;Can we simply remove that synchronization block around &lt;tt&gt;aclIndex&lt;/tt&gt;? Would it make a significant difference to the semantics of the method? Also, since we are on the topic, has anyone checked carefully the synchronization in this patch? There are 22 matches and some of them were part of the code base already. I&apos;m sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adammilnesmith&quot; class=&quot;user-hover&quot; rel=&quot;adammilnesmith&quot;&gt;adammilnesmith&lt;/a&gt; checked it carefully, but I wonder if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;fournc&lt;/a&gt; or maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt; have been able to do it too just to have a second opinion. &lt;/p&gt;</comment>
                            <comment id="15217511" author="adammilnesmith" created="Wed, 30 Mar 2016 06:44:20 +0000"  >&lt;p&gt;I think I made a comment about being uncertain about it further up in the thread somewhere but it was to make findbugs be quiet. I justified it as only used in a test and suggested I move it to the test code if you wanted.&lt;/p&gt;</comment>
                            <comment id="15217516" author="adammilnesmith" created="Wed, 30 Mar 2016 06:51:10 +0000"  >&lt;p&gt;I checked it carefully before findbugs suggested some synchronisation changes which I might have been too quick to adopt so I may have made some mistakes there. The feedback is greatly appreciated.&lt;/p&gt;</comment>
                            <comment id="15217529" author="adammilnesmith" created="Wed, 30 Mar 2016 07:02:22 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eribeiro&quot; class=&quot;user-hover&quot; rel=&quot;eribeiro&quot;&gt;eribeiro&lt;/a&gt; - I&apos;ll take a stab at fixing some of these.&lt;/p&gt;</comment>
                            <comment id="15217566" author="adammilnesmith" created="Wed, 30 Mar 2016 07:20:11 +0000"  >&lt;p&gt;To remove the deadlock concerns in the equals(), I was considering just making the access package local on those fields and moving the equals logic to the test class given this is the only place that uses it. Does this sound reasonable?&lt;/p&gt;</comment>
                            <comment id="15217648" author="fpj" created="Wed, 30 Mar 2016 08:24:07 +0000"  >&lt;p&gt;That&apos;s an option and I&apos;m fine if you want to move the code to the tests, but I&apos;m thinking that you have a couple of other options here:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Make the synchronization of this and that non-overlapping. You can remove the synchronized modifier from the signature, have a &lt;tt&gt;synchronized (that)&lt;/tt&gt; block that collects the values of the variables to be compared, and have a {{synchronized (this)} block that performs the comparisons with the local instance variables.&lt;/li&gt;
	&lt;li&gt;Make aclIndex an AtomicLong would also work, although it might be overkill.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15217663" author="adammilnesmith" created="Wed, 30 Mar 2016 08:38:17 +0000"  >&lt;p&gt;I had been tempted to move the equals out on the basis of it not being required by any main code but happy to go with option 1. I can make that change now.&lt;/p&gt;</comment>
                            <comment id="15217692" author="adammilnesmith" created="Wed, 30 Mar 2016 09:02:33 +0000"  >&lt;p&gt;Responses to each (now that I&apos;m at a computer):&lt;br/&gt;
1. Absolutely - will provide a patch for this very shortly.&lt;br/&gt;
2. Good question - I would have assumed if a node were assigned no acls at all then it should have no access rather than open unsafe. I believe there is no change in behaviour from this patch though.&lt;br/&gt;
3. I&apos;ll correct this in the aforementioned patch.&lt;br/&gt;
4. It was to be able to lean on the Map.equals() where there is an AtomicLong as the value - happy to make this change if desired.&lt;br/&gt;
5. I&apos;ll correct this in the aforementioned patch.&lt;br/&gt;
6. This is the intended behaviour as the line after the for loop calls it an extra time and returns.&lt;/p&gt;</comment>
                            <comment id="15217696" author="adammilnesmith" created="Wed, 30 Mar 2016 09:08:06 +0000"  >&lt;p&gt;Attaching trunk patch for equals() synchronization as discussed. Unlike before, this should apply to the 3.4 branch too.&lt;/p&gt;</comment>
                            <comment id="15217757" author="hadoopqa" created="Wed, 30 Mar 2016 10:10:47 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12796041/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12796041/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1736259.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3129//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3129//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3129//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3129//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3129//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3129//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15217762" author="adammilnesmith" created="Wed, 30 Mar 2016 10:17:48 +0000"  >&lt;p&gt;Notes on the pre-commit build results above:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;No new tests: I didn&apos;t include a test for the change to the equals. Would you like me to add a test to show deadlocking isn&apos;t possible?&lt;/li&gt;
	&lt;li&gt;Core unit test failure: Some of the reconfig tests failed - they don&apos;t call any code touched by this patch.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15217794" author="adammilnesmith" created="Wed, 30 Mar 2016 10:54:04 +0000"  >&lt;p&gt;I&apos;ve provided a patch for using option 1. The only remaining issue I can see with this is that we are delegating to HashMap.equals() which could result in a ConcurrentModificationException if another method was called on &quot;that&quot; concurrently. I can&apos;t envisage a reason why main code would have 2 ACL caches and compare them, but if we wanted to be cautious so this doesn&apos;t come back to bite anyone later, we could replace the HashMaps with ConcurrentHashMaps.&lt;/p&gt;</comment>
                            <comment id="15217921" author="eribeiro" created="Wed, 30 Mar 2016 12:56:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adammilnesmith&quot; class=&quot;user-hover&quot; rel=&quot;adammilnesmith&quot;&gt;adammilnesmith&lt;/a&gt;, I will try to check your patch today. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Nevertheless, I would like to step back a bit and ask you &lt;b&gt;what would be the gain of having an equality check between two caches&lt;/b&gt;? Why not get rid of the &lt;tt&gt;equals()&lt;/tt&gt; in &lt;tt&gt;ReferenceCountedACLCache&lt;/tt&gt; and let the equality be handled by the parent Object class (i.e., using the object reference)? Maybe, to make Findbugs happy it would be rewritten as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; equals(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; object) {
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; == object;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Caches are highly changing objects so I don&apos;t see any multi-threading &lt;tt&gt;equals()&lt;/tt&gt; implementation being short of complex and error prone (beside that, two caches can be equal now and different a second later). And I question myself if there will be a really compelling reason to check for equality besides the test that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; pointed out. IMHO, we could also change &lt;tt&gt;testSerializeDeserialize&lt;/tt&gt; to assert the class fields to make sure the serialization/deserialization worked fine.&lt;/p&gt;

&lt;p&gt;Furthermore, it&apos;s class is mean to be used by &lt;tt&gt;DataTree&lt;/tt&gt; only so a single instance is okay, imho. But I am certainly missing some points here, so I would be glad if you help me figure it out a scenario where semantic equality is really necessary here by users of the cache.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Eddie&lt;/p&gt;</comment>
                            <comment id="15217934" author="adammilnesmith" created="Wed, 30 Mar 2016 13:04:50 +0000"  >&lt;p&gt;I completely agree, I can&apos;t envisage a reason why main code would have 2 ACL caches and compare them, hence my suggestion above to make the access package local on those fields and moving the equals logic to the test class. I have an alternative patch locally doing just that which I can share as well if you&apos;d like.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Adam&lt;/p&gt;</comment>
                            <comment id="15217955" author="adammilnesmith" created="Wed, 30 Mar 2016 13:22:24 +0000"  >&lt;p&gt;Providing alternative patch with no equals on the cache itself and an assertCachesEqual method in the test instead.&lt;/p&gt;</comment>
                            <comment id="15217962" author="adammilnesmith" created="Wed, 30 Mar 2016 13:27:25 +0000"  >&lt;p&gt;I&apos;ve provided the alternative patch for consideration (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2141&quot; title=&quot;ACL cache in DataTree never removes entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2141&quot;&gt;&lt;del&gt;ZOOKEEPER-2141&lt;/del&gt;&lt;/a&gt;-equalsMovedToTest.patch) without an equals on the cache. Happy for either to be used. This one is my preference but this is my first contribution and it&apos;s not really my call.&lt;/p&gt;</comment>
                            <comment id="15220606" author="fpj" created="Thu, 31 Mar 2016 20:22:43 +0000"  >&lt;p&gt;I&apos;m fine with the version that moves the assertion to the test. I think you&apos;ve introduced some white spaces in and I was wondering if you could just elaborate a bit on this comments:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-
+    
     /*
     For reasons we don&apos;t all agree with, AtomicLong does not have an equals.
      */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;both really minor, hope you don&apos;t mind.&lt;/p&gt;</comment>
                            <comment id="15220636" author="adammilnesmith" created="Thu, 31 Mar 2016 20:40:40 +0000"  >&lt;p&gt;I didn&apos;t notice which bit of whitespace was introduced  but will look for and remove it. I&apos;ll remove the comment too and provide a new patch in the morning. The initial pass on a patch was a while ago but I think it was some sort of nod to the JDKs reasoning for AtomicLong not having a semantic equals - this shouldn&apos;t have made it into the patch - sorry about that.&lt;/p&gt;</comment>
                            <comment id="15220652" author="adammilnesmith" created="Thu, 31 Mar 2016 20:53:04 +0000"  >&lt;p&gt;Here&apos;s a version with the comment and accidental whitespace removed. I&apos;m attaching it as &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2141&quot; title=&quot;ACL cache in DataTree never removes entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2141&quot;&gt;&lt;del&gt;ZOOKEEPER-2141&lt;/del&gt;&lt;/a&gt;.patch and deleting the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2141&quot; title=&quot;ACL cache in DataTree never removes entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2141&quot;&gt;&lt;del&gt;ZOOKEEPER-2141&lt;/del&gt;&lt;/a&gt;-equalsMovedToTest.patch file to remove any ambiguity in case it affects QA bot&apos;s patch choice.&lt;/p&gt;</comment>
                            <comment id="15220677" author="hadoopqa" created="Thu, 31 Mar 2016 21:09:45 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12796401/ZOOKEEPER-2141.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12796401/ZOOKEEPER-2141.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1736259.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3133//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3133//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3133//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3133//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3133//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3133//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15222172" author="fournc" created="Fri, 1 Apr 2016 18:56:04 +0000"  >&lt;p&gt;OK I&apos;m looking at this patch more carefully this time. It looks OK to me but would love for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eribeiro&quot; class=&quot;user-hover&quot; rel=&quot;eribeiro&quot;&gt;eribeiro&lt;/a&gt; to take a look as well since he caught some details last time. If you +1 I&apos;ll check it in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eribeiro&quot; class=&quot;user-hover&quot; rel=&quot;eribeiro&quot;&gt;eribeiro&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15224818" author="eribeiro" created="Mon, 4 Apr 2016 18:57:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fournc&quot; class=&quot;user-hover&quot; rel=&quot;fournc&quot;&gt;fournc&lt;/a&gt;, thank you for your consideration! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; And sorry for the delay to answer. Well, &lt;b&gt;I looked carefully and it&apos;s +1, IMHO.&lt;/b&gt;&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adammilnesmith&quot; class=&quot;user-hover&quot; rel=&quot;adammilnesmith&quot;&gt;adammilnesmith&lt;/a&gt;, congrats for the good work! I would only to suggest a little thing (but see, this is &lt;b&gt;not&lt;/b&gt; required to commit this patch, I am +1 in spite of this): you could have made &lt;tt&gt;aclIndex&lt;/tt&gt; a volatile as below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; aclIndex = 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See this link for further information about the advantage of using &lt;tt&gt;volatiles&lt;/tt&gt; with long/int/double: &lt;a href=&quot;http://stackoverflow.com/a/3038233/2698109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/a/3038233/2698109&lt;/a&gt; . But again, &lt;b&gt;I am +1 even without this change&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Ed&lt;/p&gt;</comment>
                            <comment id="15228885" author="hudson" created="Wed, 6 Apr 2016 18:53:40 +0000"  >&lt;p&gt;FAILURE: Integrated in ZooKeeper-trunk #2880 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2880/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2880/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2141&quot; title=&quot;ACL cache in DataTree never removes entries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2141&quot;&gt;&lt;del&gt;ZOOKEEPER-2141&lt;/del&gt;&lt;/a&gt; ACL cache in DataTree never removes entries (Adam Milne-Smith via camille) (camille: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1738012&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1738012&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ReferenceCountedACLCache.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/server/ReferenceCountedACLCacheTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12795560" name="ZOOKEEPER-2141-3.4.patch" size="33160" author="adammilnesmith" created="Sun, 27 Mar 2016 21:18:06 +0000"/>
                            <attachment id="12796401" name="ZOOKEEPER-2141.patch" size="4708" author="adammilnesmith" created="Thu, 31 Mar 2016 20:53:04 +0000"/>
                            <attachment id="12796041" name="ZOOKEEPER-2141.patch" size="3778" author="adammilnesmith" created="Wed, 30 Mar 2016 09:08:06 +0000"/>
                            <attachment id="12793634" name="ZOOKEEPER-2141.patch" size="30974" author="adammilnesmith" created="Tue, 15 Mar 2016 21:04:40 +0000"/>
                            <attachment id="12793592" name="ZOOKEEPER-2141.patch" size="30932" author="adammilnesmith" created="Tue, 15 Mar 2016 17:10:04 +0000"/>
                            <attachment id="12793498" name="ZOOKEEPER-2141.patch" size="30932" author="adammilnesmith" created="Tue, 15 Mar 2016 08:18:18 +0000"/>
                            <attachment id="12792212" name="ZOOKEEPER-2141.patch" size="29030" author="adammilnesmith" created="Wed, 9 Mar 2016 09:13:11 +0000"/>
                            <attachment id="12771977" name="ZOOKEEPER-2141.patch" size="33062" author="karold" created="Thu, 12 Nov 2015 14:53:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26su7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>