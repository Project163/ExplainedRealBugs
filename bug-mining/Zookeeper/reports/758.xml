<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:58:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2380] Deadlock between leader shutdown and forwarding ACK to the leader</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2380</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Zookeeper enters into deadlock while shutting down itself, thus making zookeeper service unavailable as deadlocked server is a leader. Here is the thread dump:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)&quot;&lt;/span&gt; #25 prio=5 os_prio=0 tid=0x00007fbc502a6800 nid=0x834 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007fbc4d9a8000] &#160;&#160;&#160;&#160; java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (on object monitor) &#160;&#160;&#160;&#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method) &#160;&#160;&#160;&#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.join(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1245) &#160;&#160;&#160;&#160; - locked &amp;lt;
0x00000000feb78000&amp;gt; (a org.apache.zookeeper.server.SyncRequestProcessor) &#160;&#160;&#160;&#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.join(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1319) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.SyncRequestProcessor.shutdown(SyncRequestProcessor.java:196) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.ProposalRequestProcessor.shutdown(ProposalRequestProcessor.java:90) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.PrepRequestProcessor.shutdown(PrepRequestProcessor.java:1016) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.LeaderRequestProcessor.shutdown(LeaderRequestProcessor.java:78) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.ZooKeeperServer.shutdown(ZooKeeperServer.java:561) &#160;&#160;&#160;&#160; - locked &amp;lt;
0x00000000feb61e20&amp;gt; (a org.apache.zookeeper.server.quorum.LeaderZooKeeperServer) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.QuorumZooKeeperServer.shutdown(QuorumZooKeeperServer.java:169) &#160;&#160;&#160;&#160; - locked &amp;lt;
0x00000000feb61e20&amp;gt; (a org.apache.zookeeper.server.quorum.LeaderZooKeeperServer) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.LeaderZooKeeperServer.shutdown(LeaderZooKeeperServer.java:102) &#160;&#160;&#160;&#160; - locked &amp;lt;
0x00000000feb61e20&amp;gt; (a org.apache.zookeeper.server.quorum.LeaderZooKeeperServer) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:637) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:590) &#160;&#160;&#160;&#160; - locked &amp;lt;
0x00000000feb781a0&amp;gt; (a org.apache.zookeeper.server.quorum.Leader) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1108)


&lt;span class=&quot;code-quote&quot;&gt;&quot;SyncThread:1&quot;&lt;/span&gt; #46 prio=5 os_prio=0 tid=0x00007fbc5848f000 nid=0x867 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x00007fbc4ca90000] &#160;&#160;&#160;&#160; java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.Leader.processAck(Leader.java:784) &#160;&#160;&#160;&#160; - waiting to lock &amp;lt;0x00000000feb781a0&amp;gt; (a org.apache.zookeeper.server.quorum.Leader) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.quorum.AckRequestProcessor.processRequest(AckRequestProcessor.java:46) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:183) &#160;&#160;&#160;&#160; at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:113)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Leader.lead() calls shutdown() from the synchronized block, it acquired lock on Leader.java instance&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; start = Time.currentElapsedTime();
				.....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the shutdown flow SyncThread is trying to acquire lock on the same Leader.java instance. &lt;/p&gt;

&lt;p&gt;Leader thread acquired lock and waiting for SyncThread shutdown. SyncThread waiting for the lock to complete its shutdown.  This is how ZooKeeper entered into deadlock&lt;/p&gt;</description>
                <environment></environment>
        <key id="12946892">ZOOKEEPER-2380</key>
            <summary>Deadlock between leader shutdown and forwarding ACK to the leader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arshad.mohammad">Mohammad Arshad</assignee>
                                    <reporter username="arshad.mohammad">Mohammad Arshad</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Mar 2016 05:32:18 +0000</created>
                <updated>Thu, 21 Jul 2016 20:18:31 +0000</updated>
                            <resolved>Thu, 23 Jun 2016 21:20:37 +0000</resolved>
                                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15179387" author="arshad.mohammad" created="Fri, 4 Mar 2016 05:56:30 +0000"  >&lt;p&gt;It is very similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2347&quot; title=&quot;Deadlock shutting down zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2347&quot;&gt;&lt;del&gt;ZOOKEEPER-2347&lt;/del&gt;&lt;/a&gt; but it is different. &lt;/p&gt;</comment>
                            <comment id="15180222" author="rakeshr" created="Fri, 4 Mar 2016 17:37:32 +0000"  >&lt;p&gt;Good catch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;. Probably we could try moving the &lt;tt&gt;this.shutdown&lt;/tt&gt; call outside synchronization block.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Deadlock sequence is:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Quorum Leader Thread:&lt;br/&gt;
1=&amp;gt; &lt;tt&gt;leader.lead()&lt;/tt&gt;&lt;br/&gt;
2=&amp;gt; Say, leader losts quorum and call &lt;tt&gt;this.shutdown()&lt;/tt&gt;. This shutdown call is made under &lt;tt&gt;synchronized (this)&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Leader.java#L554&lt;/a&gt;&lt;br/&gt;
3=&amp;gt; Shutdown will trigger &lt;tt&gt;firstProcessor.shutdown();&lt;/tt&gt; and reaches &lt;tt&gt;SyncRequestProcessor#shutdown()&lt;/tt&gt; call.&lt;br/&gt;
4=&amp;gt; Now, SyncRequestProcessor will add &lt;tt&gt;requestOfDeath&lt;/tt&gt; and wait to &lt;tt&gt;this.join()&lt;/tt&gt;;&lt;/p&gt;

&lt;p&gt;SyncThread:&lt;br/&gt;
1=&amp;gt; SyncRequestProcessor forwards the request to its next processor &lt;tt&gt;nextProcessor.processRequest(si);&lt;/tt&gt;, which is AckRequestProcessor.&lt;br/&gt;
2=&amp;gt; AckRequestProcessor, forwards the request the leader &lt;tt&gt;leader.processAck&lt;/tt&gt;&lt;br/&gt;
3=&amp;gt; Since &lt;tt&gt;leader.processAck&lt;/tt&gt; is synchronized at method level and requires &lt;tt&gt;leader.this&lt;/tt&gt; lock &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L783&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Leader.java#L783&lt;/a&gt;. Since &lt;tt&gt;leader.this&lt;/tt&gt; is already acquired by &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Leader.java#L554&lt;/a&gt;, thus results in deadlock.&lt;/p&gt;</comment>
                            <comment id="15181537" author="arshad.mohammad" created="Sat, 5 Mar 2016 05:38:45 +0000"  >&lt;p&gt;Moved shutdown() call out of synchronized block. &lt;br/&gt;
Used string variable shutdownMessage instead of boolean as it can server two purpose, shut-down flag and shut-down message holder&lt;/p&gt;</comment>
                            <comment id="15181548" author="hadoopqa" created="Sat, 5 Mar 2016 06:02:05 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12791608/ZOOKEEPER-2380-01.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12791608/ZOOKEEPER-2380-01.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1733679.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3087//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3087//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3087//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3087//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3087//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3087//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15181789" author="arshad.mohammad" created="Sat, 5 Mar 2016 17:54:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;-1 core tests. The patch failed core unit tests.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Failed test is not related to this patch. Verified locally it is passing&lt;/p&gt;</comment>
                            <comment id="15182008" author="rakeshr" created="Sun, 6 Mar 2016 05:38:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the patch. Instead of checking &lt;tt&gt;shutdownMessage != null&lt;/tt&gt; inside loop everytime, how about sets &lt;tt&gt;shutdownMessage&lt;/tt&gt; and break the while loop. After loop, if message exists then do the shutdown call. Also, could you check the possibility of unit testing this behavior.&lt;/p&gt;</comment>
                            <comment id="15182626" author="arshad.mohammad" created="Mon, 7 Mar 2016 05:52:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, for your very valid comment.&lt;br/&gt;
Moved shutdown call out of the while loop,&lt;br/&gt;
For UT, it see no value add here. so submitting the path without UT&lt;/p&gt;</comment>
                            <comment id="15182637" author="hadoopqa" created="Mon, 7 Mar 2016 06:15:47 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12791715/ZOOKEEPER-2380-02.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12791715/ZOOKEEPER-2380-02.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1733679.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3090//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3090//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3090//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3090//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3090//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3090//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15186939" author="rakeshr" created="Wed, 9 Mar 2016 10:49:26 +0000"  >&lt;p&gt;I&apos;m just adding a point to avoid confusions, this issue has no relation with the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2347&quot; title=&quot;Deadlock shutting down zookeeper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2347&quot;&gt;&lt;del&gt;ZOOKEEPER-2347&lt;/del&gt;&lt;/a&gt;. The call sequence or the execution path is completely different for both these issues.&lt;/p&gt;</comment>
                            <comment id="15186951" author="rakeshr" created="Wed, 9 Mar 2016 11:05:12 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the updates. Since this is a critical issue, its good to back with unit tests. I know it is not that simple, but could you check any chance to write unit tests by stubbing &lt;tt&gt;MockSyncRequestProcessor extends SyncRequestProcessor&lt;/tt&gt; or welcome some other approach.&lt;/p&gt;</comment>
                            <comment id="15206180" author="arshad.mohammad" created="Tue, 22 Mar 2016 11:08:01 +0000"  >&lt;p&gt;Submitting patch with test case&lt;/p&gt;</comment>
                            <comment id="15206199" author="hadoopqa" created="Tue, 22 Mar 2016 11:26:34 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12794739/ZOOKEEPER-2380-03.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12794739/ZOOKEEPER-2380-03.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1736090.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3114//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3114//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3114//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3114//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3114//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3114//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15206226" author="arshad.mohammad" created="Tue, 22 Mar 2016 11:55:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;-1 core tests. The patch failed core unit tests.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No test case failed, one test case is skipped which is not related to this patch&lt;/p&gt;</comment>
                            <comment id="15229774" author="rakeshr" created="Thu, 7 Apr 2016 06:29:16 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the updates. Overall patch looks good,  please take a look at the following comments.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;In RaceConditionTest.java, it uses tab space. Please change the indentation by using spaces instead of tabs.&lt;/li&gt;
	&lt;li&gt;Please change &lt;tt&gt;null != quorumPeer&lt;/tt&gt; checks to &lt;tt&gt;quorumPeer != null&lt;/tt&gt;, we are using this fashion and would be good to follow same way.&lt;/li&gt;
	&lt;li&gt;Please remove the following overridden method &lt;tt&gt;#runFromConfig()&lt;/tt&gt; from class TestQPMain, its not required.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void runFromConfig(QuorumPeerConfig config) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException,
                AdminServerException {
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.runFromConfig(config);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also, remove unused code.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
 * it is same as Container feature is disabled
 */
&lt;span class=&quot;code-comment&quot;&gt;// setupContainerManager();&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Make the following methods to use private access specifier
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockTestQPMain
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockSyncRequestProcessor
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockProposalRequestProcessor
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; MainThread[] startQuorum()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Change &lt;tt&gt;e.printStackTrace();&lt;/tt&gt; to LOG.warn(&quot;&quot;) messaging&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;&quot;Leader must have gone into LOOKING state&quot;&lt;/tt&gt;, here it should be &lt;tt&gt;Leader failed to transition to LOOKING state&lt;/tt&gt;, right?&lt;/li&gt;
	&lt;li&gt;Good unit test. Could you please write the sequence of steps which results in deadlock in the unit test case, that would help to maintain it well and convey the idea quickly to others.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15251451" author="arshad.mohammad" created="Thu, 21 Apr 2016 07:19:09 +0000"  >&lt;ol&gt;
	&lt;li&gt;Fixed&lt;/li&gt;
	&lt;li&gt;Fixed&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;runFromConfig()&lt;/tt&gt; in &lt;tt&gt;QuorumPeerTestBase.TestQPMain&lt;/tt&gt; is required. it can not be removed&lt;br/&gt;
It is added so that other test cases can customise runFromConfig() behaviour as it is done in &lt;tt&gt;MockTestQPMain&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Fixed&lt;/li&gt;
	&lt;li&gt;Fixed&lt;/li&gt;
	&lt;li&gt;Fixed&lt;/li&gt;
	&lt;li&gt;Jira number is mentioned in the test case, jira can provide the complete information and step, shall we duplicate the same information in the test case as well?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15251537" author="hadoopqa" created="Thu, 21 Apr 2016 08:19:27 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12799919/ZOOKEEPER-2380-04.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12799919/ZOOKEEPER-2380-04.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1738012.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3141//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3141//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3141//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3141//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3141//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3141//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15302587" author="cnauroth" created="Thu, 26 May 2016 17:57:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, have you had a chance to review the latest patch revision from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;?  I&apos;d like to see if we can get this into a 3.5.2 release candidate.  I can volunteer to do a second review too, but I wanted to make sure your feedback had been addressed.&lt;/p&gt;</comment>
                            <comment id="15303762" author="rakeshr" created="Fri, 27 May 2016 08:45:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the reminder. &lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the good work. Apart from the following minor comment, I&apos;m +1 for the patch. I think this bug doesn&apos;t exists in branch3-4. Arshad, can you please confirm once.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;runFromConfig() in QuorumPeerTestBase.TestQPMain is required. it can not be removed&lt;br/&gt;
It is added so that other test cases can customise runFromConfig() behaviour as it is done in MockTestQPMain&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ve removed the overridden method &lt;tt&gt;#runFromConfig()&lt;/tt&gt; from class TestQPMain and couldn&apos;t see any impact. If someone needs then they can override &lt;tt&gt;QuorumPeerMain#runFromConfig&lt;/tt&gt; method at that time, do we really need this now?&lt;/p&gt;</comment>
                            <comment id="15305456" author="arshad.mohammad" created="Sat, 28 May 2016 16:08:41 +0000"  >&lt;ol&gt;
	&lt;li&gt;yes, This bug does not exist in branch-3.4. In branch-3.4 shutdown is not called from sychronised block.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; you are correct. runFromConfig() in &lt;tt&gt;QuorumPeerTestBase.TestQPMain&lt;/tt&gt; is not requried at all. Same method is in super class of TestQPMain. So we can override it without adding it in &lt;tt&gt;QuorumPeerTestBase.TestQPMain&lt;/tt&gt;.&lt;br/&gt;
I removed it.&lt;/li&gt;
	&lt;li&gt;Another correction I did, removed shutdown call from shutdownFollowers() as &quot;stop ping&quot; itself will lead to shutdown.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15305462" author="hadoopqa" created="Sat, 28 May 2016 16:36:32 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12806820/ZOOKEEPER-2380-05.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12806820/ZOOKEEPER-2380-05.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1745534.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3176//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3176//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3176//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3176//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3176//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3176//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15305477" author="arshad.mohammad" created="Sat, 28 May 2016 16:59:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;-1 core tests. The patch failed core unit tests.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There is no test case failure. One test case is skipped which is not because of this patch. For skip reason please refer &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2285&quot; title=&quot;QuorumTest&amp;#39;s ignored test case causes wrong CI pre-commit feedback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2285&quot;&gt;ZOOKEEPER-2285&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15305530" author="rakeshr" created="Sat, 28 May 2016 18:20:55 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the updates.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, latest patch looks good to me, please do a second review. Thanks!&lt;/p&gt;</comment>
                            <comment id="15340719" author="cnauroth" created="Mon, 20 Jun 2016 23:55:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, the change in &lt;tt&gt;Leader&lt;/tt&gt; looks right, but the new test is failing intermittently for me.  In approximately 1 out of every 10 attempts, the assertion on &lt;tt&gt;LOOKING_STATE&lt;/tt&gt; fails.  Instead, it goes to &lt;tt&gt;FOLLOWING_STATE&lt;/tt&gt; after a successful leader election.  My theory is that there is still a brief window in which the dropped pings haven&apos;t taken effect yet, so 2 of 3 peers still appear to be alive, and thus  new leader election is still possible.  I have attached the output from one of my failed test runs in case it&apos;s helpful for you.&lt;/p&gt;</comment>
                            <comment id="15340732" author="hadoopqa" created="Mon, 20 Jun 2016 23:59:46 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812046/ZOOKEEPER-2380-fail.out&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812046/ZOOKEEPER-2380-fail.out&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 55 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3193//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3193//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15340940" author="arshad.mohammad" created="Tue, 21 Jun 2016 02:40:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The problem is that if assertion is not made timely leader moves to LOOKING state, this is fine. In this test we just need to ensure that Leader is not stuck in LEADING state even when there no majority, it gives up its leadership.It can be in LOOKING or FOLLOWING state and keep switching very frequently as ping problem is injected.&lt;/li&gt;
	&lt;li&gt;Corrected the intermittent failure by validating that state is either LOOKING or FOLLOWING.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15340973" author="hadoopqa" created="Tue, 21 Jun 2016 03:05:57 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812076/ZOOKEEPER-2380-06.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812076/ZOOKEEPER-2380-06.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3194//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3194//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3194//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3194//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3194//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3194//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15342476" author="cnauroth" created="Tue, 21 Jun 2016 19:10:23 +0000"  >&lt;p&gt;The bug is in a code path for handling loss of quorum.  Unfortunately, if it enters FOLLOWING state, then it means the test run hasn&apos;t really covered that code path.  It would be great if this test could be made to cover the fixed code path predictably.  Maybe it would help if the stubbed code dropped more packet types than just the PING?&lt;/p&gt;</comment>
                            <comment id="15342690" author="arshad.mohammad" created="Tue, 21 Jun 2016 21:04:48 +0000"  >&lt;p&gt;It enters into FOLLOWING state when fix is applied. If the code fix is not applied it will not enter into FOLLOWING state. Can you please apply only test code modification and run the test case to verify the efficacy of code and test code.&lt;/p&gt;</comment>
                            <comment id="15342818" author="cnauroth" created="Tue, 21 Jun 2016 21:52:32 +0000"  >&lt;p&gt;Actually, I was wrong in my earlier comment.  It&apos;s acceptable for test coverage to enter either LOOKING or FOLLOWING state.  In both cases, since it has left LEADING state, by definition that means it lost its previous quorum, and therefore the code path is covered.  The change in revision 06 is sufficient.  Thank you.&lt;/p&gt;

&lt;p&gt;I just have one more request.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// shutdown 2 followers so that leader does not have majority and goes
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// in looking state
&lt;/span&gt;        shutdownFollowers(mt);
        assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Leader failed to transition to LOOKING or FOLLOWING state&quot;&lt;/span&gt;, ClientBase.waitForServerState(leader,
                15000, QuorumStats.Provider.LOOKING_STATE, QuorumStats.Provider.FOLLOWING_STATE));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please update the comment to state that FOLLOWING is acceptable too, depending on the timing of the test.&lt;/p&gt;</comment>
                            <comment id="15342906" author="hadoopqa" created="Tue, 21 Jun 2016 22:27:08 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812315/ZOOKEEPER-2380-07.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812315/ZOOKEEPER-2380-07.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    -1 contrib tests.  The patch failed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3199//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3199//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3199//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3199//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3199//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3199//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15342969" author="arshad.mohammad" created="Tue, 21 Jun 2016 22:52:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;-1 core tests. The patch failed core unit tests.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The failure is not related to this patch. Verified locally it passes.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;-1 contrib tests. The patch failed contrib unit tests&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can&apos;t figure out which contrib test failed. But it should not be because of this patch as in the latest patch only a comment is changed and for previous patch all test case were passed.&lt;/p&gt;</comment>
                            <comment id="15343049" author="hadoopqa" created="Tue, 21 Jun 2016 23:44:50 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812315/ZOOKEEPER-2380-07.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812315/ZOOKEEPER-2380-07.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3236//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3236//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3236//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3236//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3236//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3236//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15343074" author="cnauroth" created="Wed, 22 Jun 2016 00:04:39 +0000"  >&lt;p&gt;+1 for patch 07.  I&apos;ll make sure to commit this before the 3.5.2 release candidate.&lt;/p&gt;</comment>
                            <comment id="15347225" author="cnauroth" created="Thu, 23 Jun 2016 21:20:37 +0000"  >&lt;p&gt;I have committed this to trunk and branch-3.5.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, thank you for the patch.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, thank you for code reviewing.&lt;/p&gt;</comment>
                            <comment id="15347342" author="hudson" created="Thu, 23 Jun 2016 22:36:55 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2972 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2972/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2972/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2380&quot; title=&quot;Deadlock between leader shutdown and forwarding ACK to the leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2380&quot;&gt;&lt;del&gt;ZOOKEEPER-2380&lt;/del&gt;&lt;/a&gt;: Deadlock between leader shutdown and forwarding ACK to the leader. (Arshad Mohammad via cnauroth) (cnauroth: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1750022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1750022&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerTestBase.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/server/quorum/RaceConditionTest.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/test/ClientBase.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12791608" name="ZOOKEEPER-2380-01.patch" size="1919" author="arshad.mohammad" created="Sat, 5 Mar 2016 05:38:45 +0000"/>
                            <attachment id="12791715" name="ZOOKEEPER-2380-02.patch" size="1980" author="arshad.mohammad" created="Mon, 7 Mar 2016 05:52:39 +0000"/>
                            <attachment id="12794739" name="ZOOKEEPER-2380-03.patch" size="14095" author="arshad.mohammad" created="Tue, 22 Mar 2016 11:08:01 +0000"/>
                            <attachment id="12799919" name="ZOOKEEPER-2380-04.patch" size="15592" author="arshad.mohammad" created="Thu, 21 Apr 2016 07:18:09 +0000"/>
                            <attachment id="12806820" name="ZOOKEEPER-2380-05.patch" size="15167" author="arshad.mohammad" created="Sat, 28 May 2016 16:09:06 +0000"/>
                            <attachment id="12812076" name="ZOOKEEPER-2380-06.patch" size="16489" author="arshad.mohammad" created="Tue, 21 Jun 2016 02:40:25 +0000"/>
                            <attachment id="12812315" name="ZOOKEEPER-2380-07.patch" size="16511" author="arshad.mohammad" created="Tue, 21 Jun 2016 22:06:12 +0000"/>
                            <attachment id="12812046" name="ZOOKEEPER-2380-fail.out" size="174524" author="cnauroth" created="Mon, 20 Jun 2016 23:55:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u55b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>