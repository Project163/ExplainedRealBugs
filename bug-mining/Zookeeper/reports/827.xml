<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:00:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2819] Changing membership configuration via rolling restart does not work on 3.5.x.</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2819</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In 3.5.x there is no easy way of changing the membership config using rolling restarts because of the introduction of dynamic reconfig feature in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-107&quot; title=&quot;Allow dynamic changes to server cluster membership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-107&quot;&gt;&lt;del&gt;ZOOKEEPER-107&lt;/del&gt;&lt;/a&gt;, which automatically manages membership configuration parameters.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2014&quot; title=&quot;Only admin should be allowed to reconfig a cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2014&quot;&gt;&lt;del&gt;ZOOKEEPER-2014&lt;/del&gt;&lt;/a&gt; introduced a reconfigEnabled flag to turn on / off the reconfig feature. We can use same flag and when it sets to false, it should disable both in memory and on disk updates of membership configuration information, besides disabling the reconfig commands on CLI which &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2014&quot; title=&quot;Only admin should be allowed to reconfig a cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2014&quot;&gt;&lt;del&gt;ZOOKEEPER-2014&lt;/del&gt;&lt;/a&gt; already did, so users can continue using rolling restarts if needed. &lt;/p&gt;

&lt;p&gt;We should also document explicitly the support of membership changes via rolling restarts will be deprecated at what release time frame and promote reconfig as the replacement.&lt;/p&gt;

&lt;p&gt;The problem was raised at user mailing list by Guillermo Vega-Toro, reference thread:&lt;br/&gt;
&lt;a href=&quot;http://zookeeper-user.578899.n2.nabble.com/How-to-add-nodes-to-a-Zookeeper-3-5-3-beta-ensemble-with-reconfigEnabled-false-td7583138.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zookeeper-user.578899.n2.nabble.com/How-to-add-nodes-to-a-Zookeeper-3-5-3-beta-ensemble-with-reconfigEnabled-false-td7583138.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13082163">ZOOKEEPER-2819</key>
            <summary>Changing membership configuration via rolling restart does not work on 3.5.x.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hanm">Michael Han</assignee>
                                    <reporter username="hanm">Michael Han</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Jun 2017 16:06:01 +0000</created>
                <updated>Tue, 21 Jul 2020 10:49:41 +0000</updated>
                            <resolved>Thu, 6 Jul 2017 16:49:16 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.5.2</version>
                    <version>3.5.3</version>
                                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>quorum</component>
                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                                                            <comments>
                            <comment id="16061296" author="shralex" created="Fri, 23 Jun 2017 17:50:57 +0000"  >&lt;p&gt;A second issue was raised by Guillermo where one may be using reconfig, but the cluster is partitioned and an admin may want to force a minority of servers to form a cluster (even though this is clearly not safe, since the other majority servers may also have a quorum and continue to operate). &lt;/p&gt;

&lt;p&gt;One idea of how this can be achieved is by setting reconfigEnable parameter to false whenever such manual intervention is made, as a means of manual configuration override that will prevent the server from automatically accepting a configration from other servers.&lt;/p&gt;</comment>
                            <comment id="16063959" author="githubbot" created="Mon, 26 Jun 2017 23:18:47 +0000"  >&lt;p&gt;GitHub user hanm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt;:Changing membership configuration via rolling restart &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;does not work on 3.5.x.&lt;/p&gt;

&lt;p&gt;    This patch disables the creation of dynamic config files (zoo.cfg.dynamic) and static config back up files (zoo.cfg.bak) when the dynamic reconfig feature flag (reconfigEnabled) is disabled. With this patch the membership information (such as server list) will be stored in static zoo.cfg file and such information would not go through quorum and leader / follower sync phase, which makes it possible for users to continue using the old rolling restart approach.&lt;/p&gt;

&lt;p&gt;    @shralex PTAL.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hanm/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanm/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #292&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 896ee06502d602ea5147d489a5e6f777fbaaa83e&lt;br/&gt;
Author: Michael Han &amp;lt;hanm@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-06-26T22:41:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt;:Changing membership configuration via rolling restart does not work on 3.5.x.&lt;br/&gt;
    This patch disables the creation of dynamic config files (zoo.cfg.dynamic) and static config back up files (zoo.cfg.bak) when the dynamic reconfig feature flag (reconfigEnabled) is disabled. With this patch the membership information (such as server list) will be stored in static zoo.cfg file and such information would not go through quorum and leader / follower sync phase, which makes it possible for users to continue using the old rolling restart approach.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16063970" author="hanm" created="Mon, 26 Jun 2017 23:27:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;the cluster is partitioned and an admin may want to force a minority of servers to form a cluster&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I think being able to deal with the partitioned / none quorum forming case is important from an operational point of view. Actually I think this is the main reason we should continue supporting rolling restart while advocating dynamic reconfig as the main approach to do reconfig.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;One idea of how this can be achieved is by setting reconfigEnable parameter to false&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2820&quot; title=&quot;Update documentation on how to do rolling restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2820&quot;&gt;ZOOKEEPER-2820&lt;/a&gt; to document this. &lt;/p&gt;
</comment>
                            <comment id="16063990" author="hadoopqa" created="Mon, 26 Jun 2017 23:37:35 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/824//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/824//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/824//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/824//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/824//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/824//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16064318" author="githubbot" created="Tue, 27 Jun 2017 05:56:02 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r124183585&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r124183585&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java &amp;#8212;&lt;br/&gt;
    @@ -1744,9 +1744,14 @@ public void setAcceptedEpoch(long e) throws IOException {&lt;br/&gt;
         public boolean processReconfig(QuorumVerifier qv, Long suggestedLeaderId, Long zxid, boolean restartLE) {&lt;br/&gt;
            InetSocketAddress oldClientAddr = getClientAddress();&lt;/p&gt;

&lt;p&gt;    +       boolean isReconfigEnabled = QuorumPeerConfig.isReconfigEnabled();&lt;br/&gt;
            // update last committed quorum verifier, write the new config to disk&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// and restart leader election if config changed&lt;/li&gt;
	&lt;li&gt;QuorumVerifier prevQV = setQuorumVerifier(qv, true);&lt;br/&gt;
    +       // and restart leader election if config changed. If reconfig feature is&lt;br/&gt;
    +       // not enabled, just set last committed quorum verifier and bail out.&lt;br/&gt;
    +       QuorumVerifier prevQV = setQuorumVerifier(qv, isReconfigEnabled);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The server acts according to the config it has in its quorum verifier, so setting quorum verifier overwrites the config file settings with the leader&apos;s settings&lt;/p&gt;</comment>
                            <comment id="16064338" author="githubbot" created="Tue, 27 Jun 2017 06:12:58 +0000"  >&lt;p&gt;Github user asdf2014 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r124185161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r124185161&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,94 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    final int SERVER_COUNT = 3;&lt;br/&gt;
    +    final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +    final String serverList[] = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +    StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +&lt;br/&gt;
    +    @Before&lt;br/&gt;
    +    public void setup() throws InterruptedException {&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts[i];
    +            serverList[i] = server;
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        String currentQuorumCfgSection = sb.toString();&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts[i],
    +                    currentQuorumCfgSection, false);
    +            mt[i].start();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts[i],
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverList[i],
    +                    staticFileContent[i].contains(serverList[i]));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +}&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Should add a new line for the end of file.&lt;/p&gt;</comment>
                            <comment id="16065469" author="githubbot" created="Tue, 27 Jun 2017 21:11:26 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r124396899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r124396899&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java &amp;#8212;&lt;br/&gt;
    @@ -1744,9 +1744,14 @@ public void setAcceptedEpoch(long e) throws IOException {&lt;br/&gt;
         public boolean processReconfig(QuorumVerifier qv, Long suggestedLeaderId, Long zxid, boolean restartLE) {&lt;br/&gt;
            InetSocketAddress oldClientAddr = getClientAddress();&lt;/p&gt;

&lt;p&gt;    +       boolean isReconfigEnabled = QuorumPeerConfig.isReconfigEnabled();&lt;br/&gt;
            // update last committed quorum verifier, write the new config to disk&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// and restart leader election if config changed&lt;/li&gt;
	&lt;li&gt;QuorumVerifier prevQV = setQuorumVerifier(qv, true);&lt;br/&gt;
    +       // and restart leader election if config changed. If reconfig feature is&lt;br/&gt;
    +       // not enabled, just set last committed quorum verifier and bail out.&lt;br/&gt;
    +       QuorumVerifier prevQV = setQuorumVerifier(qv, isReconfigEnabled);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Updated. Now I am returning immediately at the start of processReconfig if the feature flag is not set. &lt;/p&gt;</comment>
                            <comment id="16065472" author="githubbot" created="Tue, 27 Jun 2017 21:12:10 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r124397041&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r124397041&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,94 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    final int SERVER_COUNT = 3;&lt;br/&gt;
    +    final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +    final String serverList[] = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +    StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +&lt;br/&gt;
    +    @Before&lt;br/&gt;
    +    public void setup() throws InterruptedException {&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts[i];
    +            serverList[i] = server;
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        String currentQuorumCfgSection = sb.toString();&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts[i],
    +                    currentQuorumCfgSection, false);
    +            mt[i].start();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts[i],
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverList[i],
    +                    staticFileContent[i].contains(serverList[i]));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +}&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Should be fixed now.&lt;/p&gt;</comment>
                            <comment id="16065484" author="githubbot" created="Tue, 27 Jun 2017 21:17:27 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for review, @shralex @asdf2014 . Code updated. &lt;/p&gt;

&lt;p&gt;    I also refactored a couple of reconfig tests to consolidate the setting of the feature flag, which makes the test both easier to read and also fix potential race conditions I found out while working on this patch: because the flag was set in a different thread while the peers are running, it is possible the peer thread still cache old value. Such case would not happen for real use case (aside from artificial tests we created here) because the feature flag will not change after ensemble is started. &lt;/p&gt;</comment>
                            <comment id="16065490" author="hadoopqa" created="Tue, 27 Jun 2017 21:21:04 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/828//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/828//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/828//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/828//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/828//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/828//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16065493" author="githubbot" created="Tue, 27 Jun 2017 21:21:51 +0000"  >&lt;p&gt;Github user shralex commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Michael, thanks for the changes. Do we need some tests that can catch the issue I pointed out - one server is getting rebooted with a new config file, but other servers push old config to that server, need to make sure that it actually acts upon or has the config its supposed to have. Two scenarios - config pushed durning leader sync, and config pushed during leader election (in FastLeaderElection.java). Perhaps you&apos;re already doing this, I haven&apos;t looked.&lt;/p&gt;</comment>
                            <comment id="16067720" author="hadoopqa" created="Thu, 29 Jun 2017 04:29:25 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/838//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/838//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/838//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/838//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/838//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/838//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16067735" author="hadoopqa" created="Thu, 29 Jun 2017 04:47:29 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/839//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/839//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/839//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/839//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/839//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/839//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16067737" author="githubbot" created="Thu, 29 Jun 2017 04:57:31 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Added test cases to cover rolling restart. The pre-commit Jenkins failure is a known flaky test.&lt;/p&gt;</comment>
                            <comment id="16070703" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125121157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125121157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/test/ReconfigExceptionTest.java &amp;#8212;&lt;br/&gt;
    @@ -89,6 +89,7 @@ public void tearDown() throws Exception {&lt;/p&gt;

&lt;p&gt;         @Test(timeout = 10000)&lt;br/&gt;
         public void testReconfigDisabledByDefault() throws InterruptedException {&lt;br/&gt;
    +        QuorumPeerConfig.setReconfigEnabled(false);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Given that the test is called &quot;disabled-by-default&quot; Its strange to disable this manually here. I suggest to rename the test to reflect what its doing - checking that when the flag is false reconfig ops aren&apos;t allowed.&lt;/p&gt;</comment>
                            <comment id="16070704" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125127752&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125127752&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        config = updateExistingQuorumConfig(Arrays.asList(3, 4), new ArrayList&amp;lt;Integer&amp;gt;());&lt;br/&gt;
    +        serverCount = serverAddress.size();&lt;br/&gt;
    +        Assert.assertEquals(&quot;Server count should be 5 after config update.&quot;, serverCount, 5);&lt;br/&gt;
    +&lt;br/&gt;
    +        mt = Arrays.copyOf(mt, mt.length + 2);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Please add a comment here to say that the new servers should have a config with all five servers, and the old servers a config with 3 servers.&lt;/p&gt;</comment>
                            <comment id="16070705" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125120823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125120823&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -28,9 +28,15 @@&lt;br/&gt;
     import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
     import org.apache.zookeeper.test.ReconfigTest;&lt;br/&gt;
     import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
     import org.junit.Test;&lt;/p&gt;

&lt;p&gt;     public class ReconfigRecoveryTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    @Before&lt;br/&gt;
    +    public void setup() {&lt;br/&gt;
    +        QuorumPeerConfig.setReconfigEnabled(true);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    is the same needed also in all other reconfig test files ?&lt;/p&gt;</comment>
                            <comment id="16070706" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125124612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125124612&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        config = updateExistingQuorumConfig(Arrays.asList(3, 4), new ArrayList&amp;lt;Integer&amp;gt;());&lt;br/&gt;
    +        serverCount = serverAddress.size();&lt;br/&gt;
    +        Assert.assertEquals(&quot;Server count should be 5 after config update.&quot;, serverCount, 5);&lt;br/&gt;
    +&lt;br/&gt;
    +        mt = Arrays.copyOf(mt, mt.length + 2);&lt;br/&gt;
    +        for (int i = 3; i &amp;lt; 5; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            verifyConfig(mt[i]);
    +            verifyQuorum(i);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String conf : oldServerAddress.values()) {
    +            // Remove &quot;server.x=&quot; prefix.
    +            expectedConfigs.add(conf.substring(9));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; 3; ++i) {
    +            verifyConfig(mt[i], expectedConfigs);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i].shutdown();    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    // A successful write operation indicates a quorum is up.&lt;br/&gt;
    +    private void verifyQuorum(int sid)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can you reuse some helper methods from ReconfigTest.java ?&lt;/p&gt;</comment>
                            <comment id="16070707" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125126374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125126374&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        config = updateExistingQuorumConfig(Arrays.asList(3, 4), new ArrayList&amp;lt;Integer&amp;gt;());&lt;br/&gt;
    +        serverCount = serverAddress.size();&lt;br/&gt;
    +        Assert.assertEquals(&quot;Server count should be 5 after config update.&quot;, serverCount, 5);&lt;br/&gt;
    +&lt;br/&gt;
    +        mt = Arrays.copyOf(mt, mt.length + 2);&lt;br/&gt;
    +        for (int i = 3; i &amp;lt; 5; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            verifyConfig(mt[i]);
    +            verifyQuorum(i);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String conf : oldServerAddress.values()) {
    +            // Remove &quot;server.x=&quot; prefix.
    +            expectedConfigs.add(conf.substring(9));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; 3; ++i) {
    +            verifyConfig(mt[i], expectedConfigs);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i].shutdown();    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    // A successful write operation indicates a quorum is up.&lt;br/&gt;
    +    private void verifyQuorum(int sid)&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts.get(sid),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, new Watcher() {&lt;br/&gt;
    +            public void process(WatchedEvent event) {&lt;br/&gt;
    +            }});&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int j = 0; j &amp;lt; 30; j++) {&lt;br/&gt;
    +            try &lt;/p&gt;
{
    +                zk.create(&quot;/&quot; + Integer.toString(sid) + &quot;.&quot; + Math.random(),
    +                        &quot;foobar&quot;.getBytes(),
    +                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    +                break;
    +            }
&lt;p&gt; catch (KeeperException.ConnectionLossException e) {&lt;br/&gt;
    +                if (j &amp;lt; 29) &lt;/p&gt;
{
    +                    Thread.sleep(1000);
    +                }
&lt;p&gt; else &lt;/p&gt;
{
    +                    Assert.fail(&quot;client could not connect to reestablished quorum: &quot; +
    +                            &quot;giving up after 30+ seconds.&quot;);
    +                }
&lt;p&gt;    +            }&lt;br/&gt;
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private void verifyConfig(QuorumPeerTestBase.MainThread mt) {&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String config : serverAddress.values()) {&lt;br/&gt;
    +            // Remove &quot;server.x=&quot; prefix.&lt;br/&gt;
    +            expectedConfigs.add(config.substring(9));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    this seems fragile (works only for single digit ids, perhaps use the index of &quot;=&quot;&lt;/p&gt;</comment>
                            <comment id="16070708" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125126799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125126799&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        config = updateExistingQuorumConfig(Arrays.asList(3, 4), new ArrayList&amp;lt;Integer&amp;gt;());&lt;br/&gt;
    +        serverCount = serverAddress.size();&lt;br/&gt;
    +        Assert.assertEquals(&quot;Server count should be 5 after config update.&quot;, serverCount, 5);&lt;br/&gt;
    +&lt;br/&gt;
    +        mt = Arrays.copyOf(mt, mt.length + 2);&lt;br/&gt;
    +        for (int i = 3; i &amp;lt; 5; ++i) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            verifyConfig(mt[i]);
    +            verifyQuorum(i);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String conf : oldServerAddress.values()) {&lt;br/&gt;
    +            // Remove &quot;server.x=&quot; prefix.&lt;br/&gt;
    +            expectedConfigs.add(conf.substring(9));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    same comment - using 9 seems fragile. Also perhaps create a method for this since this code appears twice&lt;/p&gt;</comment>
                            <comment id="16070709" author="githubbot" created="Fri, 30 Jun 2017 20:51:35 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125125684&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125125684&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.shutdown();&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +            verifyQuorum&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    two comments:&lt;br/&gt;
    1. is calling start immediately after shutdown effective ? I don&apos;t remember what shutdown is doing, but if its setting a flag and a thread periodically checks it, it may take time to take effect.&lt;br/&gt;
    2. nothing is changing about the config as far as I can see. Why would this ever fail ? &lt;/p&gt;</comment>
                            <comment id="16070728" author="githubbot" created="Fri, 30 Jun 2017 21:09:20 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125130820&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125130820&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java &amp;#8212;&lt;br/&gt;
    @@ -28,9 +28,15 @@&lt;br/&gt;
     import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
     import org.apache.zookeeper.test.ReconfigTest;&lt;br/&gt;
     import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Before;&lt;br/&gt;
     import org.junit.Test;&lt;/p&gt;

&lt;p&gt;     public class ReconfigRecoveryTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    @Before&lt;br/&gt;
    +    public void setup() {&lt;br/&gt;
    +        QuorumPeerConfig.setReconfigEnabled(true);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes if those tests require reconfig feature being enabled. I think I&apos;ve patched all reconfig test in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2014&quot; title=&quot;Only admin should be allowed to reconfig a cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2014&quot;&gt;&lt;del&gt;ZOOKEEPER-2014&lt;/del&gt;&lt;/a&gt;, and the modifications of related tests here are all about refactoring and consolidating setting of the flag in a single place.&lt;/p&gt;</comment>
                            <comment id="16070736" author="githubbot" created="Fri, 30 Jun 2017 21:16:35 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125131915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125131915&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.shutdown();&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +            verifyQuorum&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    for 1 - for this specific case this is fine, because this test case does not change setting of the reconfig flag (from false to true or vice versa) so there is no concern on that end. shutdown is synchronous so once shutdown finishes, it&apos;s safe to call start. &lt;/p&gt;

&lt;p&gt;    I think your concern was around the visibility of a shared variable among multiple threads (in this case, reconfigEnabled). Adding volatile should address the concern (also a new test case specifically to test the visibility of the variable is required.). I will do this as part of sub-task &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2828&quot; title=&quot;Test case improvement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2828&quot;&gt;ZOOKEEPER-2828&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;    For 2, yes as the test name implies, no config changes here. I guess I can remove the config verify part here though leave it there for insurance seems ok too.&lt;/p&gt;</comment>
                            <comment id="16070738" author="shralex" created="Fri, 30 Jun 2017 21:17:47 +0000"  >&lt;p&gt;The reason I&apos;m asking about getConfig, is that I suspect it won&apos;t work properly with manual reconfiguration. &lt;br/&gt;
It may return information that is wrong, e.g., reflect the 3 nodes even when you added 2 more nodes in your tests (when queried on the added nodes)&lt;br/&gt;
or different information at different nodes&lt;/p&gt;</comment>
                            <comment id="16070739" author="githubbot" created="Fri, 30 Jun 2017 21:18:13 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125132133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125132133&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        config = updateExistingQuorumConfig(Arrays.asList(3, 4), new ArrayList&amp;lt;Integer&amp;gt;());&lt;br/&gt;
    +        serverCount = serverAddress.size();&lt;br/&gt;
    +        Assert.assertEquals(&quot;Server count should be 5 after config update.&quot;, serverCount, 5);&lt;br/&gt;
    +&lt;br/&gt;
    +        mt = Arrays.copyOf(mt, mt.length + 2);&lt;br/&gt;
    +        for (int i = 3; i &amp;lt; 5; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            verifyConfig(mt[i]);
    +            verifyQuorum(i);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String conf : oldServerAddress.values()) {
    +            // Remove &quot;server.x=&quot; prefix.
    +            expectedConfigs.add(conf.substring(9));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; 3; ++i) {
    +            verifyConfig(mt[i], expectedConfigs);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i].shutdown();    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    // A successful write operation indicates a quorum is up.&lt;br/&gt;
    +    private void verifyQuorum(int sid)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I missed testServerHasConfig - I think that should do it. &lt;/p&gt;</comment>
                            <comment id="16070740" author="githubbot" created="Fri, 30 Jun 2017 21:18:32 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125132175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125132175&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,275 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.WatchedEvent;&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.CreateMode;&lt;br/&gt;
    +import org.apache.zookeeper.ZooDefs;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.KeeperException;&lt;br/&gt;
    +import org.apache.zookeeper.Watcher;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String backupFileName = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(backupFileName));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),    +                    config, false);    +            mt[i].start();    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange()&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            verifyQuorum(i);
    +            verifyConfig(mt[i]);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        config = updateExistingQuorumConfig(Arrays.asList(3, 4), new ArrayList&amp;lt;Integer&amp;gt;());&lt;br/&gt;
    +        serverCount = serverAddress.size();&lt;br/&gt;
    +        Assert.assertEquals(&quot;Server count should be 5 after config update.&quot;, serverCount, 5);&lt;br/&gt;
    +&lt;br/&gt;
    +        mt = Arrays.copyOf(mt, mt.length + 2);&lt;br/&gt;
    +        for (int i = 3; i &amp;lt; 5; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            verifyConfig(mt[i]);
    +            verifyQuorum(i);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String conf : oldServerAddress.values()) {
    +            // Remove &quot;server.x=&quot; prefix.
    +            expectedConfigs.add(conf.substring(9));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; 3; ++i) {
    +            verifyConfig(mt[i], expectedConfigs);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {    +            mt[i].shutdown();    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    // A successful write operation indicates a quorum is up.&lt;br/&gt;
    +    private void verifyQuorum(int sid)&lt;br/&gt;
    +            throws IOException, InterruptedException, KeeperException {&lt;br/&gt;
    +        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts.get(sid),&lt;br/&gt;
    +                ClientBase.CONNECTION_TIMEOUT, new Watcher() {&lt;br/&gt;
    +            public void process(WatchedEvent event) {&lt;br/&gt;
    +            }});&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int j = 0; j &amp;lt; 30; j++) {&lt;br/&gt;
    +            try &lt;/p&gt;
{
    +                zk.create(&quot;/&quot; + Integer.toString(sid) + &quot;.&quot; + Math.random(),
    +                        &quot;foobar&quot;.getBytes(),
    +                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    +                break;
    +            }
&lt;p&gt; catch (KeeperException.ConnectionLossException e) {&lt;br/&gt;
    +                if (j &amp;lt; 29) &lt;/p&gt;
{
    +                    Thread.sleep(1000);
    +                }
&lt;p&gt; else &lt;/p&gt;
{
    +                    Assert.fail(&quot;client could not connect to reestablished quorum: &quot; +
    +                            &quot;giving up after 30+ seconds.&quot;);
    +                }
&lt;p&gt;    +            }&lt;br/&gt;
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private void verifyConfig(QuorumPeerTestBase.MainThread mt) {&lt;br/&gt;
    +        Set&amp;lt;String&amp;gt; expectedConfigs = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (String config : serverAddress.values()) {&lt;br/&gt;
    +            // Remove &quot;server.x=&quot; prefix.&lt;br/&gt;
    +            expectedConfigs.add(config.substring(9));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    With the ReconfigTest helpers I can remove these code, hopefully.&lt;/p&gt;</comment>
                            <comment id="16070741" author="githubbot" created="Fri, 30 Jun 2017 21:20:38 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;gt;&amp;gt; One question - what happens with getConfig when reconfig is disabled ? Does it still work ?&lt;/p&gt;

&lt;p&gt;    Yes getConfigwill continue working until the heat death of the universe regardless of reconfigEnabled flag settings &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. &lt;/p&gt;</comment>
                            <comment id="16071016" author="hadoopqa" created="Sat, 1 Jul 2017 05:49:40 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/847//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/847//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/847//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/847//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/847//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/847//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16071457" author="hadoopqa" created="Sun, 2 Jul 2017 00:36:13 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/851//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/851//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/851//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/851//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/851//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/851//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16071480" author="githubbot" created="Sun, 2 Jul 2017 03:44:59 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Addressed code review comments from @shralex:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Use ReconfigTest.testServerHasConfig for additional test coverage.&lt;/li&gt;
	&lt;li&gt;Improve fragile substring extraction.&lt;/li&gt;
	&lt;li&gt;Add comments around test logic.&lt;/li&gt;
	&lt;li&gt;Also made a fix to ensure during rolling restart, config information returned from getConfig is consistent with local config.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16071482" author="githubbot" created="Sun, 2 Jul 2017 03:49:27 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125173093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125173093&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -374,6 +374,13 @@ else if (qp.getType() == Leader.SNAP) {&lt;br/&gt;
                     // The leader is going to dump the database&lt;br/&gt;
                     // db is clear as part of deserializeSnapshot()&lt;br/&gt;
                     zk.getZKDatabase().deserializeSnapshot(leaderIs);&lt;br/&gt;
    +                // &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt;: overwrite config node content extracted&lt;br/&gt;
    +                // from leader snapshot with local config, to avoid potential&lt;br/&gt;
    +                // inconsistency of config node content during rolling restart.&lt;br/&gt;
    +                if (!QuorumPeerConfig.isReconfigEnabled()) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @shralex instead of avoiding deserializing the config zNode we could overwrite the deserialized zNode content with local quorum config. Test will be covered in the test improvement JIRA &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2828&quot; title=&quot;Test case improvement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2828&quot;&gt;ZOOKEEPER-2828&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16071490" author="hadoopqa" created="Sun, 2 Jul 2017 04:19:34 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    -1 contrib tests.  The patch failed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/852//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/852//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/852//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/852//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/852//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/852//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16071491" author="hadoopqa" created="Sun, 2 Jul 2017 04:19:35 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/853//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/853//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/853//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/853//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/853//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/853//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16071509" author="hadoopqa" created="Sun, 2 Jul 2017 04:50:05 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/854//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/854//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/854//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/854//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/854//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/854//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16075879" author="githubbot" created="Thu, 6 Jul 2017 03:49:23 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125805265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125805265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,263 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ReconfigTest;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String ZOO_CFG_BAK_FILE = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(ZOO_CFG_BAK_FILE));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange() throws Exception {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; joiningServers = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; leavingServers = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            joiningServers.add(serverAddress.get(i));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.shutdown();&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +            verifyQuorumConfig(i, joiningServers, leavingServers);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    you can remove the leavingServers variable and pass null here. Same in the other test&lt;/p&gt;</comment>
                            <comment id="16075880" author="githubbot" created="Thu, 6 Jul 2017 03:49:23 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125806125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125806125&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,263 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    you don&apos;t really need leavingServers - you can pass null instead of it in all the tests since no one is leaving&lt;/p&gt;</comment>
                            <comment id="16075881" author="githubbot" created="Thu, 6 Jul 2017 03:49:23 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292#discussion_r125806082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292#discussion_r125806082&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,263 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *     &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server.quorum;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.nio.charset.StandardCharsets;&lt;br/&gt;
    +import java.nio.file.Files;&lt;br/&gt;
    +import java.util.Arrays;&lt;br/&gt;
    +import java.util.Map;&lt;br/&gt;
    +import java.util.Set;&lt;br/&gt;
    +import java.util.List;&lt;br/&gt;
    +import java.util.HashMap;&lt;br/&gt;
    +import java.util.HashSet;&lt;br/&gt;
    +import java.util.ArrayList;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.zookeeper.ZooKeeper;&lt;br/&gt;
    +import org.apache.zookeeper.PortAssignment;&lt;br/&gt;
    +import org.apache.zookeeper.test.ClientBase;&lt;br/&gt;
    +import org.apache.zookeeper.test.ReconfigTest;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * ReconfigRollingRestartCompatibilityTest - we want to make sure that users&lt;br/&gt;
    + * can continue using the rolling restart approach when reconfig feature is disabled.&lt;br/&gt;
    + * It is important to stay compatible with rolling restart because dynamic reconfig&lt;br/&gt;
    + * has its limitation: it requires a quorum of server to work. When no quorum can be formed,&lt;br/&gt;
    + * rolling restart is the only approach to reconfigure the ensemble (e.g. removing bad nodes&lt;br/&gt;
    + * such that a new quorum with smaller number of nodes can be formed.).&lt;br/&gt;
    + *&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt; for more details.&lt;br/&gt;
    + */&lt;br/&gt;
    +public class ReconfigRollingRestartCompatibilityTest extends QuorumPeerTestBase {&lt;br/&gt;
    +    private static final String ZOO_CFG_BAK_FILE = &quot;zoo.cfg.bak&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    Map&amp;lt;Integer, Integer&amp;gt; clientPorts = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +    Map&amp;lt;Integer, String&amp;gt; serverAddress = new HashMap&amp;lt;&amp;gt;(5);&lt;br/&gt;
    +&lt;br/&gt;
    +    private String generateNewQuorumConfig(int serverCount) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        String server;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            clientPorts.put(i, PortAssignment.unique());
    +            server = &quot;server.&quot; + i + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(i);
    +            serverAddress.put(i, server);
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    private String updateExistingQuorumConfig(List&amp;lt;Integer&amp;gt; sidsToAdd, List&amp;lt;Integer&amp;gt; sidsToRemove) {&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (Integer sid : sidsToAdd) &lt;/p&gt;
{
    +            clientPorts.put(sid, PortAssignment.unique());
    +            serverAddress.put(sid, &quot;server.&quot; + sid + &quot;=localhost:&quot; + PortAssignment.unique()
    +                    + &quot;:&quot; + PortAssignment.unique() + &quot;:participant;localhost:&quot;
    +                    + clientPorts.get(sid));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (Integer sid : sidsToRemove) &lt;/p&gt;
{
    +            clientPorts.remove(sid);
    +            serverAddress.remove(sid);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (String server : serverAddress.values()) &lt;/p&gt;
{
    +            sb.append(server + &quot;\n&quot;);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        return sb.toString();&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // Verify no zoo.cfg.dynamic and zoo.cfg.bak files existing locally&lt;br/&gt;
    +    // when reconfig feature flag is off by default.&lt;br/&gt;
    +    public void testNoLocalDynamicConfigAndBackupFiles()&lt;br/&gt;
    +            throws InterruptedException, IOException {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        String[] staticFileContent = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +            Assert.assertNull(&quot;static file backup (zoo.cfg.bak) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(ZOO_CFG_BAK_FILE));
    +            Assert.assertNull(&quot;dynamic configuration file (zoo.cfg.dynamic.*) shouldn&apos;t exist!&quot;,
    +                    mt[i].getFileByName(mt[i].getQuorumPeer().getNextDynamicConfigFilename()));
    +            staticFileContent[i] = Files.readAllLines(mt[i].confFile.toPath(), StandardCharsets.UTF_8).toString();
    +            Assert.assertTrue(&quot;static config file should contain server entry &quot; + serverAddress.get(i),
    +                    staticFileContent[i].contains(serverAddress.get(i)));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 60000)&lt;br/&gt;
    +    // This test simulate the usual rolling restart with no membership change:&lt;br/&gt;
    +    // 1. A node is shutdown first (e.g. to upgrade software, or hardware, or cleanup local data.).&lt;br/&gt;
    +    // 2. After upgrade, start the node.&lt;br/&gt;
    +    // 3. Do this for every node, one at a time.&lt;br/&gt;
    +    public void testRollingRestartWithoutMembershipChange() throws Exception {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; joiningServers = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; leavingServers = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            joiningServers.add(serverAddress.get(i));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) {
    +            mt[i].shutdown();
    +            mt[i].start();
    +            verifyQuorumConfig(i, joiningServers, leavingServers);
    +            verifyQuorumMembers(mt[i]);
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; i++) {    +            mt[i].shutdown();    +        }
&lt;p&gt;    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    @Test(timeout = 90000)&lt;br/&gt;
    +    // This test simulate the use case of change of membership through rolling&lt;br/&gt;
    +    // restart. For a 3 node ensemble we expand it to a 5 node ensemble, verify&lt;br/&gt;
    +    // during the process each node has the expected configuration setting pushed&lt;br/&gt;
    +    // via updating local zoo.cfg file.&lt;br/&gt;
    +    public void testRollingRestartWithMembershipChange() throws Exception {&lt;br/&gt;
    +        int serverCount = 3;&lt;br/&gt;
    +        String config = generateNewQuorumConfig(serverCount);&lt;br/&gt;
    +        QuorumPeerTestBase.MainThread mt[] = new QuorumPeerTestBase.MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;serverCount&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; joiningServers = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; leavingServers = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            mt[i] = new QuorumPeerTestBase.MainThread(i, clientPorts.get(i),
    +                    config, false);
    +            mt[i].start();
    +            joiningServers.add(serverAddress.get(i));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            Assert.assertTrue(&quot;waiting for server &quot; + i + &quot; being up&quot;,
    +                    ClientBase.waitForServerUp(&quot;127.0.0.1:&quot; + clientPorts.get(i),
    +                            CONNECTION_TIMEOUT));
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; serverCount; ++i) &lt;/p&gt;
{
    +            verifyQuorumConfig(i, joiningServers, leavingServers);
    +            verifyQuorumMembers(mt[i]);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        Map&amp;lt;Integer, String&amp;gt; oldServerAddress = new HashMap&amp;lt;&amp;gt;(serverAddress);&lt;br/&gt;
    +        List&amp;lt;String&amp;gt; newServers = new ArrayList&amp;lt;&amp;gt;(joiningServers);&lt;br/&gt;
    +        newServers.add(&quot;3&quot;); newServers.add(&quot;4&quot;);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    move this one line down until after you have the actual addresses, then put the actual config lines of 3 and 4 into newServers&lt;/p&gt;</comment>
                            <comment id="16075896" author="githubbot" created="Thu, 6 Jul 2017 04:05:50 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @shralex The snapshot and sync tests will be covered in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2828&quot; title=&quot;Test case improvement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2828&quot;&gt;ZOOKEEPER-2828&lt;/a&gt;. I will update the PR shortly to address other comments.&lt;/p&gt;</comment>
                            <comment id="16075964" author="hadoopqa" created="Thu, 6 Jul 2017 05:35:58 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/863//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/863//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/863//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/863//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/863//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/863//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16075969" author="githubbot" created="Thu, 6 Jul 2017 05:38:40 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @shralex for review. Good catch on the &quot;3&quot;, &quot;4&quot; server issue. PR updated that addresses latest comments. The failed test is a known flaky one. &lt;/p&gt;</comment>
                            <comment id="16075972" author="githubbot" created="Thu, 6 Jul 2017 05:43:21 +0000"  >&lt;p&gt;Github user shralex commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    LGTM&lt;/p&gt;</comment>
                            <comment id="16076881" author="githubbot" created="Thu, 6 Jul 2017 16:49:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16076882" author="hanm" created="Thu, 6 Jul 2017 16:49:16 +0000"  >&lt;p&gt;Issue resolved by pull request 292&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/292&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16076883" author="hanm" created="Thu, 6 Jul 2017 16:51:19 +0000"  >&lt;p&gt;Committed to master: &lt;a href=&quot;https://github.com/apache/zookeeper/commit/ddf0364903bf7ac7cd25b2e1927f0d9d3c7203c4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/ddf0364903bf7ac7cd25b2e1927f0d9d3c7203c4&lt;/a&gt;&lt;br/&gt;
branch-3.5: &lt;a href=&quot;https://github.com/apache/zookeeper/commit/6ab74115e2576a81f649f12708ebc4d4efdb15ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/6ab74115e2576a81f649f12708ebc4d4efdb15ac&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16076946" author="hudson" created="Thu, 6 Jul 2017 17:38:25 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3457 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3457/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3457/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2819&quot; title=&quot;Changing membership configuration via rolling restart does not work on 3.5.x.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2819&quot;&gt;&lt;del&gt;ZOOKEEPER-2819&lt;/del&gt;&lt;/a&gt;: Changing membership configuration via rolling restart &#8230; (hanm: rev ddf0364903bf7ac7cd25b2e1927f0d9d3c7203c4)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/QuorumPeerConfig.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/test/ReconfigMisconfigTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/test/ReconfigExceptionTest.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/quorum/ReconfigRollingRestartCompatibilityTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17153473" author="ivan.farre" created="Wed, 8 Jul 2020 10:17:07 +0000"  >&lt;p&gt;I still faced this issue through versions 3.5.5 and 3.6.1. Could you provide some documentation on how to perform rolling upgrades to update the statics configurations through zoo.cfg file, please?&lt;/p&gt;</comment>
                            <comment id="17161941" author="mladens42" created="Tue, 21 Jul 2020 10:49:41 +0000"  >&lt;p&gt;Running into same issue with 3.5.5&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13082663">ZOOKEEPER-2820</subtask>
                            <subtask id="13083849">ZOOKEEPER-2828</subtask>
                            <subtask id="13083970">ZOOKEEPER-2831</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3go8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>