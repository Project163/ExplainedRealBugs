<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:05:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4846] Failure to reload database due to missing ACL</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4846</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;ZooKeeper snapshots are &lt;em&gt;fuzzy&lt;/em&gt;, as the server does not stop processing requests while ACLs and nodes are being streamed to disk.&lt;/p&gt;

&lt;p&gt;ACLs, notably, are streamed &lt;em&gt;first&lt;/em&gt;, as a mapping between the full serialized ACL and an &quot;ACL ID&quot; referenced by the node.&lt;/p&gt;

&lt;p&gt;Consequently, a snapshot can very well contain ACL IDs which do not exist in the mapping. Prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-4799&quot; title=&quot;Refactor ACL check in addWatch command&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-4799&quot;&gt;&lt;del&gt;ZOOKEEPER-4799&lt;/del&gt;&lt;/a&gt;, such situations would produce harmless (if annoying) &quot;Ignoring acl XYZ as it does not exist in the cache&quot; INFO entries in the server logs.&lt;/p&gt;

&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-4799&quot; title=&quot;Refactor ACL check in addWatch command&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-4799&quot;&gt;&lt;del&gt;ZOOKEEPER-4799&lt;/del&gt;&lt;/a&gt;, we started &quot;eagerly&quot; fetching the referenced ACLs in &lt;tt&gt;DataTree&lt;/tt&gt; operations such as &lt;tt&gt;createNode&lt;/tt&gt;, &lt;tt&gt;deleteNode&lt;/tt&gt;, etc.&#8212;as opposed to just fetching them from request processors.&lt;/p&gt;

&lt;p&gt;This can result in fatal errors during the &lt;tt&gt;fastForwardFromEdits&lt;/tt&gt; phase of restoring a database, when transactions are processed on top of an inconsistent data tree&#8212;preventing the server from starting.&lt;/p&gt;

&lt;p&gt;The errors are thrown in this code path:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// ReferenceCountedACLCache.java:90
&lt;/span&gt;List&amp;lt;ACL&amp;gt; acls = longKeyMap.get(longVal);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acls == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;ERROR: ACL not available &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; {}&quot;&lt;/span&gt;, longVal);
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to fetch acls &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &quot;&lt;/span&gt; + longVal);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here is a scenario leading to such a failure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;An existing node &lt;tt&gt;/foo&lt;/tt&gt;, sporting an unique ACL, is deleted. This is recorded in transaction log &lt;tt&gt;$SNAP-1&lt;/tt&gt;; said ACL is also deallocated;&lt;/li&gt;
	&lt;li&gt;Snapshot &lt;tt&gt;$SNAP&lt;/tt&gt; is started;&lt;/li&gt;
	&lt;li&gt;The ACL map is serialized to &lt;tt&gt;$SNAP&lt;/tt&gt;;&lt;/li&gt;
	&lt;li&gt;A new node &lt;tt&gt;/foo&lt;/tt&gt; sporting the same unique ACL is created in a portion of the data tree which still has to be serialized;&lt;/li&gt;
	&lt;li&gt;Node &lt;tt&gt;/foo&lt;/tt&gt; is serialized to &lt;tt&gt;$SNAP&lt;/tt&gt;&#8212;but its ACL isn&apos;t;&lt;/li&gt;
	&lt;li&gt;The server is restarted;&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;DataTree&lt;/tt&gt; is initialized from &lt;tt&gt;$SNAP&lt;/tt&gt;, including node &lt;tt&gt;/foo&lt;/tt&gt; with a dangling ACL reference;&lt;/li&gt;
	&lt;li&gt;Transaction log &lt;tt&gt;$SNAP-1&lt;/tt&gt; is being replayed, leading to a &lt;tt&gt;deleteNode(&quot;/foo&quot;)&lt;/tt&gt;;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;getACL(node)&lt;/tt&gt; panics, preventing a successful restart.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13587121">ZOOKEEPER-4846</key>
            <summary>Failure to reload database due to missing ACL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ztzg">Damien Diederen</assignee>
                                    <reporter username="ztzg">Damien Diederen</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 28 Jul 2024 10:51:12 +0000</created>
                <updated>Fri, 29 Aug 2025 21:28:59 +0000</updated>
                            <resolved>Tue, 11 Feb 2025 16:49:08 +0000</resolved>
                                                    <fixVersion>3.10.0</fixVersion>
                    <fixVersion>3.8.5</fixVersion>
                    <fixVersion>3.9.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17924680" author="andorm" created="Thu, 6 Feb 2025 19:49:33 +0000"  >&lt;p&gt;Example stack trace.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2025-02-05 16:07:20,312 ERROR org.apache.zookeeper.server.ZooKeeperServerMain: Unexpected exception, exiting abnormally
java.lang.RuntimeException: Failed to fetch acls for 7382
        at org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:93)
        at org.apache.zookeeper.server.DataTree.getACL(DataTree.java:801)
        at org.apache.zookeeper.server.DataTree.createNode(DataTree.java:455)
        at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:881)
        at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:864)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.processTransaction(FileTxnSnapLog.java:442)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.fastForwardFromEdits(FileTxnSnapLog.java:350)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.lambda$restore$0(FileTxnSnapLog.java:267)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:312)
        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:285)
        at org.apache.zookeeper.server.ZooKeeperServer.loadData(ZooKeeperServer.java:531)
        at org.apache.zookeeper.server.ZooKeeperServer.startdata(ZooKeeperServer.java:704)
        at org.apache.zookeeper.server.NettyServerCnxnFactory.startup(NettyServerCnxnFactory.java:745)
        at org.apache.zookeeper.server.ServerCnxnFactory.startup(ServerCnxnFactory.java:130)
        at org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:161)
        at org.apache.zookeeper.server.ZooKeeperServerMain.initializeAndRun(ZooKeeperServerMain.java:113)
        at org.apache.zookeeper.server.ZooKeeperServerMain.main(ZooKeeperServerMain.java:68)
        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:141)
        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:91)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It indicates that problem happens when trying to execute createTxn a znode whose &lt;b&gt;parent&lt;/b&gt; doesn&apos;t have a valid ACL.&lt;/p&gt;</comment>
                            <comment id="17924725" author="andorm" created="Thu, 6 Feb 2025 23:21:35 +0000"  >&lt;p&gt;Found a solution. It&apos;s super simple. ZooKeeper actually doesn&apos;t lose that txn gap, it&apos;s in the previous logfile and it iterates over it.&lt;/p&gt;

&lt;p&gt;Look at this log snippet:&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2025-02-06 17:12:40,818 [myid:] - INFO &#160;[main:FileSnap@85] - Reading snapshot /home/andor/tmp/zookeeper/version-2/snapshot.674c0
2025-02-06 17:12:40,845 [myid:] - INFO &#160;[main:ReferenceCountedACLCache@174] - Ignoring acl 7382 as it does not exist in the cache
2025-02-06 17:12:40,847 [myid:] - INFO &#160;[main:DataTree@1719] - The digest in the snapshot has digest version of 2, with zxid as 0x674c1, and digest value as 8282470946294
2025-02-06 17:12:40,858 [myid:] - INFO &#160;[main:FileTxnLog$FileTxnIterator@693] - Going to next log file /home/andor/tmp/zookeeper/version-2/log.5a1df
2025-02-06 17:12:40,924 [myid:] - INFO &#160;[main:FileTxnSnapLog@351] - Processing zxid 0x674c1: 0x674c1
2025-02-06 17:12:40,924 [myid:] - INFO &#160;[main:DataTree@469] - Creating node /cloudera_manager_zookeeper_canary with acl 6
2025-02-06 17:12:40,928 [myid:] - INFO &#160;[main:FileTxnLog$FileTxnIterator@693] - Going to next log file /home/andor/tmp/zookeeper/version-2/log.674c2
2025-02-06 17:12:40,928 [myid:] - INFO &#160;[main:FileTxnSnapLog@351] - Processing zxid 0x674c2: 0x674c2
2025-02-06 17:12:40,928 [myid:] - INFO &#160;[main:FileTxnSnapLog@351] - Processing zxid 0x674c3: 0x674c3
2025-02-06 17:12:40,929 [myid:] - ERROR [main:ReferenceCountedACLCache@92] - ERROR: ACL not available for long 7382
2025-02-06 17:12:40,929 [myid:] - ERROR [main:ZooKeeperServerMain@91] - Unexpected exception, exiting abnormally
java.lang.RuntimeException: Failed to fetch acls for 7382
&#160; &#160; &#160; &#160; at org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:93)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Snapshot zxid is &lt;b&gt;0x674c0&lt;/b&gt;, so ZK goes to txn logfile &lt;b&gt;0x5a1df&lt;/b&gt; first and fast forward to txn zxid &lt;b&gt;0x674c1&lt;/b&gt;, so actually processing the txn where the parent znode was created. Clearly the ACL id is different in the cache and the data tree: 6 &amp;lt;&amp;gt; 7382&lt;/p&gt;

&lt;p&gt;Look at the code where we process the txn:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (parent) {
&#160; &#160; parentAcl = getACL(parent);&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Add the ACL to ACL cache first, to avoid the ACL not being
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// created race condition during fuzzy snapshot sync.
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// This is the simplest fix, which may add ACL reference count
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// again &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s already counted in in the ACL map of fuzzy
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// snapshot, which might also happen &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deleteNode txn, but
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// at least it won&apos;t cause the ACL not exist issue.
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Later we can audit and delete all non-referenced ACLs from
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// ACL map when loading the snapshot/txns from disk, like what
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// we did &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the global sessions.
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; longval = aclCache.convertAcls(acl); &#160; &amp;lt;---- we re-create the ACL in the ACL cache, but potentially with different id &#160; &#160; &#160;&#160;&#160; &#160;   
    Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; children = parent.getChildren();
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (children.contains(childName)) {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KeeperException.NodeExistsException(); &#160; &#160;&amp;lt;---- znode already exists in DataTree, so we skip
&#160; &#160; }
...  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The only thing that we need to do here is to get a reference to the existing znode and fix the ACL reference.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (children.contains(childName)) {
    DataNode child = nodes.get(path);
    child.acl = longval;
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KeeperException.NodeExistsException();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or maybe something more elegant.&lt;/p&gt;

&lt;p&gt;We don&apos;t lose the ACL information.&lt;/p&gt;</comment>
                            <comment id="17924952" author="cnauroth" created="Fri, 7 Feb 2025 16:36:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; , nice, I think that makes sense!&lt;/p&gt;</comment>
                            <comment id="17926062" author="andorm" created="Tue, 11 Feb 2025 16:49:08 +0000"  >&lt;p&gt;Issue resolved by pull request 2222&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/2222&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/2222&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13595141">ZOOKEEPER-4874</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qkdc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>