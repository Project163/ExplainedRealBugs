<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:05:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4785] Txn loss due to race condition in Learner.syncWithLeader() during DIFF sync</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4785</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We had txn loss incident in production recently. After investigation, we found it was caused by the race condition of follower writing the current epoch and sending the ACK_LD before successfully persisting all the txns from DIFF sync in Learner.syncWithLeader() method.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Leader.NEWLEADER: 
        ...
        self.setCurrentEpoch(newEpoch);
        writeToTxnLog = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-comment&quot;&gt;//Anything after &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; needs to go to the transaction log, not applied directly in memory
&lt;/span&gt;        isPreZAB1_0 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

        &lt;span class=&quot;code-comment&quot;&gt;// ZOOKEEPER-3911: make sure sync the uncommitted logs before commit them (ACK NEWLEADER).
&lt;/span&gt;        sock.setSoTimeout(self.tickTime * self.syncLimit);
        self.setSyncMode(QuorumPeer.SyncMode.NONE);
        zk.startupWithoutServing();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zk &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; FollowerZooKeeperServer) {
            FollowerZooKeeperServer fzk = (FollowerZooKeeperServer) zk;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (PacketInFlight p : packetsNotCommitted) {
              fzk.logRequest(p.hdr, p.rec, p.digest);
            }
            packetsNotCommitted.clear();
        }

        writePacket(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QuorumPacket(Leader.ACK, newLeaderZxid, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;p&gt;In this method, when follower receives the NEWLEADER msg, the current epoch is updated before writing the uncommitted txns to the disk and writing txns is done asynchronously by the SyncThreadd.  If follower crashes after setting the current epoch and sending ACK_LD and before all transactions are successfully written to disk, transactions loss can happen.  &lt;/p&gt;

&lt;p&gt;This is because leader election is based on epoch first and then transaction id.  When the follower becomes a leader because it has highest epoch, it will ask the other followers to truncate txns even they have been written to disk, causing data loss.&lt;/p&gt;

&lt;p&gt;The following is the scenario&lt;/p&gt;

&lt;p&gt;1. Leader election happened&lt;br/&gt;
2. A follower synced with Leader via DIFF, received committed proposals from leader and kept them in memory&lt;br/&gt;
3. The follower received the NEWLEADER message&lt;br/&gt;
4. The follower updated the newEpoch&lt;br/&gt;
5. The follower was bounced  before writing all the uncommitted txns to disk&lt;br/&gt;
6. Leader shutdown and a new election triggered&lt;br/&gt;
7. Follower became the new leader because it has largest currentEpoch&lt;br/&gt;
8. New leader asked other followers to truncate their committed txns and transactions got lost&lt;/p&gt;



</description>
                <environment></environment>
        <key id="13564433">ZOOKEEPER-4785</key>
            <summary>Txn loss due to race condition in Learner.syncWithLeader() during DIFF sync</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="li4wang">Li Wang</assignee>
                                    <reporter username="li4wang">Li Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 12 Jan 2024 00:00:54 +0000</created>
                <updated>Mon, 7 Jul 2025 14:20:32 +0000</updated>
                            <resolved>Wed, 20 Mar 2024 19:10:24 +0000</resolved>
                                    <version>3.8.0</version>
                    <version>3.7.1</version>
                    <version>3.8.1</version>
                    <version>3.7.2</version>
                    <version>3.8.2</version>
                    <version>3.9.1</version>
                                    <fixVersion>3.10.0</fixVersion>
                    <fixVersion>3.8.4</fixVersion>
                    <fixVersion>3.9.2</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="17805844" author="JIRAUSER299380" created="Fri, 12 Jan 2024 00:46:28 +0000"  >&lt;p&gt;The issue can be fixed by persisting uncommitted txns from leader synchronously, so we can ensure the following order when processing NEWLEADER msg in the Learner.syncWithLeader() method.&lt;/p&gt;

&lt;p&gt;1. Persisting all the txns/proposals in disk&lt;br/&gt;
2. Writing current epoch to disk&lt;br/&gt;
3. Sending ACK of NEWLEADER to leader&lt;br/&gt;
4. Sending ACK of proposals to leader&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13568215">ZOOKEEPER-4808</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13154018">ZOOKEEPER-3023</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13510604">ZOOKEEPER-4643</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13510811">ZOOKEEPER-4646</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13444408">ZOOKEEPER-4541</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mpfk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>