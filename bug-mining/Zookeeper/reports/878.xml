<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2982] Re-try DNS hostname -&gt; IP resolution</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2982</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1506&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution if node connection fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1506&quot;&gt;&lt;del&gt;ZOOKEEPER-1506&lt;/del&gt;&lt;/a&gt; fixed a DNS resolution issue in 3.4.  Some portions of the fix haven&apos;t yet been ported to 3.5.&lt;/p&gt;

&lt;p&gt;To recap the outstanding problem in 3.5, if a given ZK server is started before all peer addresses are resolvable, that server may cache a negative lookup result and forever fail to resolve the address.    For example, deploying ZK 3.5 to Kubernetes using a StatefulSet plus a Service (headless) may fail because the DNS records are created lazily.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-02-18 09:11:22,583 [myid:0] - WARN  [QuorumPeer[myid=0](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):Follower@95] - Exception when following the leader
java.net.UnknownHostException: zk-2.zk.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.svc.cluster.local
        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:184)
        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
        at java.net.Socket.connect(Socket.java:589)
        at org.apache.zookeeper.server.quorum.Learner.sockConnect(Learner.java:227)
        at org.apache.zookeeper.server.quorum.Learner.connectToLeader(Learner.java:256)
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:76)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1133)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the above example, the address `zk-2.zk.default.svc.cluster.local` was not resolvable when the server started, but became resolvable shortly thereafter.    The server should eventually succeed but doesn&apos;t.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13139513">ZOOKEEPER-2982</key>
            <summary>Re-try DNS hostname -&gt; IP resolution</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Paiva Junqueira</assignee>
                                    <reporter username="eronwright">Eron Wright</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Feb 2018 19:28:06 +0000</created>
                <updated>Tue, 31 Dec 2019 19:46:56 +0000</updated>
                            <resolved>Tue, 8 May 2018 22:57:31 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.5.3</version>
                                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16369441" author="eronwright" created="Mon, 19 Feb 2018 19:31:04 +0000"  >&lt;p&gt;Looking at `Learner` in 3.4 versus 3.5, a necessary call within `findLeader` to `recreateSocketAddresses` was added in 3.4 but not ported to 3.5.  The suggested fix is to add the call.&lt;/p&gt;

&lt;p&gt;Note that other elements of ZOOKEEPR-1506 were already ported:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/commit/d2a49163b7bc7c9589140dbba7f60e591028f908&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/d2a49163b7bc7c9589140dbba7f60e591028f908&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16369596" author="githubbot" created="Mon, 19 Feb 2018 23:13:02 +0000"  >&lt;p&gt;GitHub user EronWright opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/468&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2982&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2982&quot;&gt;&lt;del&gt;ZOOKEEPER-2982&lt;/del&gt;&lt;/a&gt;: Re-try DNS hostname -&amp;gt; IP resolution if node connection fails&lt;/p&gt;

&lt;p&gt;    This PR ports a fix from the 3.4 to the 3.5 branch, that was originally made in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1506&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution if node connection fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1506&quot;&gt;&lt;del&gt;ZOOKEEPER-1506&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/EronWright/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EronWright/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2982&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2982&quot;&gt;&lt;del&gt;ZOOKEEPER-2982&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/468.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/468.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #468&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4f8f3ce8074b878f2a6e32c15ec177f4dcd050e0&lt;br/&gt;
Author: Eron Wright &amp;lt;eron.wright@...&amp;gt;&lt;br/&gt;
Date:   2018-02-19T23:05:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2982&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2982&quot;&gt;&lt;del&gt;ZOOKEEPER-2982&lt;/del&gt;&lt;/a&gt; Re-try DNS hostname -&amp;gt; IP resolution if node connection fails&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16370631" author="abrahamfine" created="Tue, 20 Feb 2018 21:53:41 +0000"  >&lt;p&gt;I&apos;m wondering if  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rthille&quot; class=&quot;user-hover&quot; rel=&quot;rthille&quot;&gt;rthille&lt;/a&gt; can chime in on this.&lt;/p&gt;

&lt;p&gt;It looks like the change this JIRA is talking about is referenced by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1506?focusedCommentId=14711955&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-14711955&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-1506?focusedCommentId=14711955&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-14711955&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is there a reason why this change was left out of branch-3.5 (and master)?&lt;/p&gt;

&lt;p&gt;My guess is that in master and branch-3.5 we always call `recreateSocketAddresses` in `connectOne` which should be called during leader election of communication to another quorum member stops. Again, it would be great to have &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rthille&quot; class=&quot;user-hover&quot; rel=&quot;rthille&quot;&gt;rthille&lt;/a&gt; confirm/tell me how wrong I am.&lt;/p&gt;</comment>
                            <comment id="16370670" author="githubbot" created="Tue, 20 Feb 2018 22:28:47 +0000"  >&lt;p&gt;Github user afine commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/468&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @EronWright I left a comment in the JIRA. &lt;/p&gt;</comment>
                            <comment id="16370676" author="eronwright" created="Tue, 20 Feb 2018 22:32:15 +0000"  >&lt;p&gt;I can confirm that the fix is effective in my K8s environment.  I discovered the problem while using 3.5.3-beta.&lt;/p&gt;</comment>
                            <comment id="16370682" author="fpj" created="Tue, 20 Feb 2018 22:36:37 +0000"  >&lt;p&gt;I don&apos;t see a reason why it would be a problem to invoke {recreateSocketAddresses} from {Learner.findLeader}. That method is simply returning the {QuorumServer} instance corresponding to the server it believes to be the leader.&lt;/p&gt;

&lt;p&gt;The thing that is puzzling is how a server ended up voting for another server that it can&apos;t talk to (because the name doesn&apos;t resolve). Is it a race that eventually goes away?&lt;/p&gt;</comment>
                            <comment id="16370688" author="eronwright" created="Tue, 20 Feb 2018 22:38:56 +0000"  >&lt;p&gt;Looking at the code a bit, the learner makes a raw socket connection (`connectToLeader` -&amp;gt; `sockConnect`) not involving `QuorumCnxManager`.   Sorry I don&apos;t know all the details.   &lt;/p&gt;</comment>
                            <comment id="16370690" author="fpj" created="Tue, 20 Feb 2018 22:41:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt;&#160;a follower invokes followLeader after leader election completes. followLeader makes a call to connectToLeader.&lt;/p&gt;</comment>
                            <comment id="16370694" author="eronwright" created="Tue, 20 Feb 2018 22:44:47 +0000"  >&lt;p&gt;Sorry I was just responding to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abrahamfine&quot; class=&quot;user-hover&quot; rel=&quot;abrahamfine&quot;&gt;abrahamfine&lt;/a&gt; regarding why `connectOne` doesn&apos;t cover all cases.&lt;/p&gt;

&lt;p&gt;Based on empirical evidence I think this patch is critical for ZK 3.5.&lt;/p&gt;</comment>
                            <comment id="16370695" author="fpj" created="Tue, 20 Feb 2018 22:45:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt; in your set up, once you get that exception, is it the case that the ensemble never recovers (it is never able to elect a leader)?&lt;/p&gt;</comment>
                            <comment id="16370699" author="eronwright" created="Tue, 20 Feb 2018 22:47:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; that is correct; without the patch, the ensemble never comes online.&lt;/p&gt;</comment>
                            <comment id="16370708" author="abrahamfine" created="Tue, 20 Feb 2018 22:55:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt; I think `connectToLeader` uses the address from `findLeader` which should read the `QuorumVerifier` updated by `recreateSocketAddresses` called in `connectOne`.&lt;/p&gt;

&lt;p&gt;I have a feeling it would be tough, but if you could come up with a test to reproduce the issue you are facing or give us step by step instructions to reproduce (ideally outside of K8s) that would help us confirm the problem.&lt;/p&gt;</comment>
                            <comment id="16370712" author="eronwright" created="Tue, 20 Feb 2018 23:01:43 +0000"  >&lt;p&gt;The step-by-step instructions are:&lt;br/&gt;
1. configure a three node ensemble (0,1,2).&lt;br/&gt;
2. by whatever means, configure 0 such that it cannot resolve the DNS address of 1 and/or 2.   Do likewise for other servers.&lt;br/&gt;
3. Start the ensemble, observing the &lt;tt&gt;UnknownHostException&lt;/tt&gt; as shown in the description.&lt;br/&gt;
4. While the servers are running, fix the DNS issue so that the addresses may be resolved.&lt;br/&gt;
5. Observe that the exception continues to occur.&lt;/p&gt;</comment>
                            <comment id="16370721" author="fpj" created="Tue, 20 Feb 2018 23:08:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt; could you upload some server logs so that we can have a look, please?&lt;/p&gt;</comment>
                            <comment id="16370735" author="eronwright" created="Tue, 20 Feb 2018 23:20:27 +0000"  >&lt;p&gt;Attached &apos;fixed.log&apos; which demonstrates the behavior after the fix is applied.   Let me know if you also need to see the output from an unpatched cluster (I would prefer not to spend the time to get that).&lt;/p&gt;</comment>
                            <comment id="16371425" author="andorm" created="Wed, 21 Feb 2018 13:53:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve tried this on localhost by adding fake dns names to /etc/hosts like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;127.0.0.1 one.andor.org
127.0.0.1 two.andor.org
#127.0.0.1 three.andor.org&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;First, all of the 3 entries were commented out and I started ZooKeeper nodes with the following server config:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;server.1=one.andor.org:2222:2223
server.2=two.andor.org:3333:3334
server.3=three.andor.org:4444:4445
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Nodes were unable to connect because of the following resolution error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-02-21 14:33:25,509 [myid:1] - WARN [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):QuorumPeer$QuorumServer@172] - Failed to resolve address: two.andor.org
java.net.UnknownHostException: two.andor.org
at java.net.InetAddress.getAllByName0(InetAddress.java:1273)
at java.net.InetAddress.getAllByName(InetAddress.java:1185)
at java.net.InetAddress.getAllByName(InetAddress.java:1119)
at java.net.InetAddress.getByName(InetAddress.java:1069)
at org.apache.zookeeper.server.quorum.QuorumPeer$QuorumServer.recreateSocketAddresses(QuorumPeer.java:170)
at org.apache.zookeeper.server.quorum.QuorumPeer.recreateSocketAddresses(QuorumPeer.java:726)
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:686)
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:720)
at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:919)
at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1171)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Similar entries are keep repeated in both server logs. As I can see ZK is trying to call recreateSocketAddresses() and tries to re-resolve the address every time it&apos;s trying to connect.&lt;/p&gt;

&lt;p&gt;This is the case &lt;em&gt;without&lt;/em&gt; your patch.&lt;/p&gt;

&lt;p&gt;When I enabled the entries in /etc/hosts, the following error showed up in the logs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-02-21 14:37:07,178 [myid:1] - WARN [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):QuorumCnxManager@663] - Cannot open channel to 2 at election address two.andor.org/127.0.0.1:3334
java.net.ConnectException: Connection refused (Connection refused)
at java.net.PlainSocketImpl.socketConnect(Native Method)
at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:339)
at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:200)
at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:182)
at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
at java.net.Socket.connect(Socket.java:580)
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:641)
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:692)
at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:720)
at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:919)
at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1171)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The error shows that DNS resolution was successful (127.0.0.1) and the connection issue is different (Connection refused) which might be related to my silly test environment (socket has not been created on the other side), but the key takeaway here is that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abrahamfine&quot; class=&quot;user-hover&quot; rel=&quot;abrahamfine&quot;&gt;abrahamfine&lt;/a&gt; is probably right and the re-resolution happens properly.&lt;/p&gt;

&lt;p&gt;I repeated the test with your patch too and the results are the same. No difference.&lt;/p&gt;

&lt;p&gt;Maybe I&apos;m missing something and the test might not be relevant at all, but at least it&apos;s a little bit confusing.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt;Would you please attach logs running the same ensemble&#160;&lt;em&gt;without&lt;/em&gt;&#160;your patch too?&lt;/p&gt;</comment>
                            <comment id="16371452" author="fpj" created="Wed, 21 Feb 2018 14:13:04 +0000"  >&lt;p&gt;From the logs, we can see the same exception being raised when the server is trying to connect to elect a leader:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-02-20 20:41:25,669 [myid:1] - WARN  [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):QuorumPeer$QuorumServer@173] - Failed to resolve address: pravega-zookeeper-2.pravega-zookeeper-headless.default.svc.cluster.local
java.net.UnknownHostException: pravega-zookeeper-2.pravega-zookeeper-headless.default.svc.cluster.local
	at java.net.InetAddress.getAllByName0(InetAddress.java:1280)
	at java.net.InetAddress.getAllByName(InetAddress.java:1192)
	at java.net.InetAddress.getAllByName(InetAddress.java:1126)
	at java.net.InetAddress.getByName(InetAddress.java:1076)
	at org.apache.zookeeper.server.quorum.QuorumPeer$QuorumServer.recreateSocketAddresses(QuorumPeer.java:171)
	at org.apache.zookeeper.server.quorum.QuorumPeer.recreateSocketAddresses(QuorumPeer.java:727)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:682)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:716)
	at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:919)
	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1190)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once the address resolves and it can connect, the exception goes away and the notification messages flow regularly. The question is why the update performed during leader election to the quorum view in &lt;tt&gt;QuorumCnxManager.connectOne&lt;/tt&gt; is not taking any effect in the view that &lt;tt&gt;Learner.findLeader&lt;/tt&gt; uses to get the `QuorumServer` instance to connect to the leader. Two possibilities I can think of:&lt;/p&gt;

&lt;p&gt;1- The server hasn&apos;t connected to the elected server during leader election, in which case the address wasn&apos;t updated.&lt;br/&gt;
2- The quorum view that the learner is using to get the quorum server instance is not the one that was updated in &lt;tt&gt;QuorumCnxManager&lt;/tt&gt;.&lt;/p&gt;
</comment>
                            <comment id="16371727" author="eronwright" created="Wed, 21 Feb 2018 17:38:21 +0000"  >&lt;p&gt;Thanks everyone for your patience.  I&apos;ve attached a log showing the unpatched behavior (3.5.3-beta).   You&apos;ll observe two ongoing exceptions, one from &lt;tt&gt;QuorumCnxManager&lt;/tt&gt;, the other from &lt;tt&gt;Learner&lt;/tt&gt;.     Around &lt;tt&gt;2018-02-21 17:23:36,746&lt;/tt&gt;, the DNS record finally comes up and &lt;tt&gt;QuorumCnxManager&lt;/tt&gt; recovers whereas &lt;tt&gt;Learner&lt;/tt&gt; doesn&apos;t.&lt;/p&gt;</comment>
                            <comment id="16371886" author="fpj" created="Wed, 21 Feb 2018 19:19:40 +0000"  >&lt;p&gt;I think I know what&apos;s going on. It is correct that &lt;tt&gt;connectOne&lt;/tt&gt; invokes &lt;tt&gt;recreateSocketAddresses&lt;/tt&gt;, but that invocation won&apos;t happen in the case that the server receives a connection request rather than starting the connection. In fact, servers with larger ids are always supposed to start the connections.&lt;/p&gt;

&lt;p&gt;I think the patch proposed here of invoking &lt;tt&gt;recreateSocketAddresses&lt;/tt&gt; in &lt;tt&gt;findLeader&lt;/tt&gt; in the learner class makes sense to compensate for &lt;tt&gt;recreateSocketAddresses&lt;/tt&gt; not being invoked during leader election. Any other insight or anything I&apos;m missing?&lt;/p&gt;
</comment>
                            <comment id="16371943" author="andorm" created="Wed, 21 Feb 2018 20:14:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; I think you&apos;re right.&lt;/p&gt;

&lt;p&gt;Looking at the logfile that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt;uploaded recently I see connections are being received&#160;from other members of the ensembe on the election port. myid=1 is just unable to initiate due to DNS error and doesn&apos;t either give up connection, because not realizing that myid=1 &amp;lt; id of the other connection.&lt;/p&gt;

&lt;p&gt;I believe the ensembe looks like this:&lt;/p&gt;

&lt;p&gt;myid=1 zookeeper-0.zookeeper-headless.default.svc.cluster.local 10.8.2.14&lt;br/&gt;
myid=2 zookeeper-1.zookeeper-headless.default.svc.cluster.local 10.8.0.6&lt;br/&gt;
myid=3 zookeeper-2.zookeeper-headless.default.svc.cluster.local 10.8.1.7&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16371980" author="andorm" created="Wed, 21 Feb 2018 20:42:20 +0000"  >&lt;p&gt;Looks like that sock.connect() in connectToLeader() requires the address to be resolved already.&lt;/p&gt;

&lt;p&gt;If QuorumCnxnManager() fails to do that, connectToLeader() should be able to detect &amp;amp; fix it by doing resolution explicitly when addr.isUnresolved() == true.&lt;/p&gt;

&lt;p&gt;Not sure if it&apos;s any better than doing recreateSocketAddress() in findLeader(), but it may be another option to consider.&lt;/p&gt;</comment>
                            <comment id="16372542" author="fpj" created="Thu, 22 Feb 2018 08:33:27 +0000"  >&lt;p&gt;I have tried your recipe for reproducing as well &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; by changing &lt;tt&gt;/etc/hosts&lt;/tt&gt; and got the same issue. The problem is that the leader fails to bind to the port, which actually makes me wonder whether we need to do anything about the leader with respect to this issue:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.net.SocketException: Unresolved address
	at java.net.ServerSocket.bind(ServerSocket.java:368)
	at java.net.ServerSocket.bind(ServerSocket.java:329)
	at org.apache.zookeeper.server.quorum.Leader.&amp;lt;init&amp;gt;(Leader.java:240)
	at org.apache.zookeeper.server.quorum.QuorumPeer.makeLeader(QuorumPeer.java:1023)
	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1226)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Your suggestion of the alternative change is sensible, but I&apos;d say that for consistency, it is better that we simply do the same that we have in 3.4, which is to make the change in &lt;tt&gt;findLeader&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;One thing that I believe we haven&apos;t been able to do is to have a test case to report it. It would be good to have it, but I&apos;m not sure what would be a good way.&lt;/p&gt;</comment>
                            <comment id="16373047" author="andorm" created="Thu, 22 Feb 2018 16:42:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; Sounds reasonable to me.&lt;/p&gt;

&lt;p&gt;I&apos;ll think about how to test this and will let you know when I can come up with something.&#160;&lt;/p&gt;</comment>
                            <comment id="16375152" author="eronwright" created="Sat, 24 Feb 2018 00:08:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; ready to merge this fix?&lt;/p&gt;</comment>
                            <comment id="16375213" author="abrahamfine" created="Sat, 24 Feb 2018 01:38:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; I believe your diagnosis to be correct and I agree that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt;&apos;s fix would solve the problem in the case that DNS eventually is fixed. My concern with the current solution is that it could cause us to jump back and forth between leader election and the quorum when the DNS stays in a bad state. For example, imagine a 3 node cluster &lt;/p&gt;
{z1, z2, z3}
&lt;p&gt;. z3 is always offline and z2 has no entry in dns. z2 will connect to z1 and win the leader election. When it comes time to form the quorum z1 will be unable to follow z2 as it wont be able to resolve its address.&lt;/p&gt;

&lt;p&gt;Just spitballing here, but what if we had z1 connect to the &lt;tt&gt;remoteSocketAddress&lt;/tt&gt; of the socket created from the connection it received in &lt;tt&gt;QuorumCnxManager&lt;/tt&gt;? I understand there are some security concerns here and I&apos;m not sure how much we care about that since they would be cured by Kerberos or TLS (one day). We could also do a reverse dns lookup and reject the connection if the reverse lookup does not align with our expected hostname. &lt;/p&gt;

&lt;p&gt;What do you guys think?&lt;/p&gt;</comment>
                            <comment id="16377219" author="eronwright" created="Mon, 26 Feb 2018 17:35:42 +0000"  >&lt;p&gt;My humble opinion is that there&apos;s no risk in taking this patch as-is, since it fixes a regression.   Improvements could be made from there, on their own strength.&lt;/p&gt;</comment>
                            <comment id="16393254" author="eronwright" created="Fri, 9 Mar 2018 17:40:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; are you driving this issue now?   Would you please assign the bug appropriately?&lt;/p&gt;

&lt;p&gt;I&apos;m keen to see the patch make it into 3.5.4.&lt;/p&gt;</comment>
                            <comment id="16397477" author="eronwright" created="Tue, 13 Mar 2018 19:04:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abrahamfine&quot; class=&quot;user-hover&quot; rel=&quot;abrahamfine&quot;&gt;abrahamfine&lt;/a&gt; are you OK with accepting this patch as-is for now?  This would fix the regression between 3.4 and 3.5.  Thanks!&lt;/p&gt;</comment>
                            <comment id="16398500" author="fpj" created="Wed, 14 Mar 2018 12:30:34 +0000"  >&lt;p&gt;hey guys, here are some comments based on the latest points:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abrahamfine&quot; class=&quot;user-hover&quot; rel=&quot;abrahamfine&quot;&gt;abrahamfine&lt;/a&gt; the improvement you are proposing requires further discussion. for one thing, the user has told us to use names and now we are trying to second-guess how to connect to the server. I&apos;m not saying this is necessarily a bad idea, but I feel it needs to be addressed separately. I think we should go for now with the fix that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eronwright&quot; class=&quot;user-hover&quot; rel=&quot;eronwright&quot;&gt;eronwright&lt;/a&gt; is proposing as it fixes an issue with the port.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; do you think you will be able to come up with a test case? To recap, I think we need to test that we are able to resolve names correctly despite changes in the mapping of name to address. I&apos;m not sure what a good way of testing it would be.&lt;/p&gt;</comment>
                            <comment id="16439848" author="eronwright" created="Mon, 16 Apr 2018 18:34:03 +0000"  >&lt;p&gt;Are we ready to accept this patch yet?   &lt;/p&gt;</comment>
                            <comment id="16448996" author="eronwright" created="Mon, 23 Apr 2018 22:53:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; would you please assign this issue to someone and clarify what your expectations are? &lt;/p&gt;</comment>
                            <comment id="16460772" author="abalur" created="Wed, 2 May 2018 09:27:50 +0000"  >&lt;p&gt;Can someone please comment on&#160;whether this is getting merged in 3.5.4?? When is 3.5.4 expected?&lt;/p&gt;</comment>
                            <comment id="16467049" author="fpj" created="Tue, 8 May 2018 08:10:45 +0000"  >&lt;p&gt;Based on this comment, I&apos;m +1 from this change:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2982?focusedCommentId=16371886&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16371886&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2982?focusedCommentId=16371886&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16371886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It would have been good to have a test case, but we haven&apos;t been able to come up with anything, so I suggest we leave it for future work. We also have a +1 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; in the pull request.&lt;/p&gt;</comment>
                            <comment id="16468019" author="hadoopqa" created="Tue, 8 May 2018 22:02:33 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +0 tests included.  The patch appears to be a documentation patch that doesn&apos;t require tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1665//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1665//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1665//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1665//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1665//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1665//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16468044" author="eronwright" created="Tue, 8 May 2018 22:21:25 +0000"  >&lt;p&gt;Note that I opened two PRs - one for &lt;tt&gt;branch-3.5&lt;/tt&gt; and&#160;the other&#160;for &lt;tt&gt;master&lt;/tt&gt; branch.&lt;/p&gt;</comment>
                            <comment id="16468083" author="fpj" created="Tue, 8 May 2018 22:57:31 +0000"  >&lt;p&gt;Issue resolved by pull request 513&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/513&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16468194" author="hudson" created="Wed, 9 May 2018 01:05:42 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #15 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/15/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/15/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2982&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2982&quot;&gt;&lt;del&gt;ZOOKEEPER-2982&lt;/del&gt;&lt;/a&gt;: Re-try DNS hostname -&amp;gt; IP resolution if node connection (fpj: rev b1f6279a8c4708d1df7dd1128dc4fdf41fc7e24a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12597797">ZOOKEEPER-1506</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12911406" name="3.5.3-beta.zip" size="16995" author="eronwright" created="Wed, 21 Feb 2018 17:33:10 +0000"/>
                            <attachment id="12911293" name="fixed.log" size="60218" author="eronwright" created="Tue, 20 Feb 2018 23:18:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qcrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>