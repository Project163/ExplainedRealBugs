<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:58:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2366] Reconfiguration of client port causes a socket leak</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2366</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The NIOServerCnxnFactory reconfigure method can leak server sockets, and hence make ports unusable until the JVM restarts:&lt;/p&gt;

&lt;p&gt;The first line of the method takes a reference to the current ServerSocketChannel and then the next line replaces it. The subsequent interactions with the server socket can fail (for example if the reconfiguration tries to bind to an in-use port). If they fail &lt;b&gt;before&lt;/b&gt; the  call to oldSS.close() then oldSS is &lt;b&gt;never&lt;/b&gt; closed. This holds that port open forever, and prevents the user from rolling back to the previous port!&lt;/p&gt;

&lt;p&gt;The code from reconfigure is shown below:&lt;/p&gt;

&lt;p&gt; ServerSocketChannel oldSS = ss;        &lt;br/&gt;
        try {&lt;br/&gt;
           this.ss = ServerSocketChannel.open();&lt;br/&gt;
           ss.socket().setReuseAddress(true);&lt;br/&gt;
           LOG.info(&quot;binding to port &quot; + addr);&lt;br/&gt;
           ss.socket().bind(addr);&lt;br/&gt;
           ss.configureBlocking(false);&lt;br/&gt;
           acceptThread.setReconfiguring();&lt;br/&gt;
           oldSS.close();           &lt;br/&gt;
           acceptThread.wakeupSelector();&lt;br/&gt;
           try &lt;/p&gt;
{
			  acceptThread.join();
		   }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
			   LOG.error(&quot;Error joining old acceptThread when reconfiguring client port &quot; + e.getMessage());
		   }
&lt;p&gt;           acceptThread = new AcceptThread(ss, addr, selectorThreads);&lt;br/&gt;
           acceptThread.start();&lt;br/&gt;
        } catch(IOException e) &lt;/p&gt;
{
           LOG.error(&quot;Error reconfiguring client port to &quot; + addr + &quot; &quot; + e.getMessage());
        }


</description>
                <environment></environment>
        <key id="12938854">ZOOKEEPER-2366</key>
            <summary>Reconfiguration of client port causes a socket leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fpj">Flavio Paiva Junqueira</assignee>
                                    <reporter username="timothyjward">Timothy James Ward</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Feb 2016 16:59:27 +0000</created>
                <updated>Thu, 21 Jul 2016 20:18:21 +0000</updated>
                            <resolved>Thu, 23 Jun 2016 21:46:53 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15144879" author="cnauroth" created="Fri, 12 Feb 2016 17:15:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=timothyjward&quot; class=&quot;user-hover&quot; rel=&quot;timothyjward&quot;&gt;timothyjward&lt;/a&gt;, thank you for the bug report.  Let&apos;s try to target a fix for 3.5.2, which is the next release.&lt;/p&gt;</comment>
                            <comment id="15147498" author="timothyjward" created="Mon, 15 Feb 2016 15:39:13 +0000"  >&lt;p&gt;This test case highlights the issue outlined in the bug, and shows that it affects both the Netty and Nio connection providers.&lt;/p&gt;</comment>
                            <comment id="15147510" author="hadoopqa" created="Mon, 15 Feb 2016 15:50:08 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12787954/zookeeper.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12787954/zookeeper.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1729259.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3047//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3047//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15171425" author="rgs" created="Mon, 29 Feb 2016 05:31:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=timothyjward&quot; class=&quot;user-hover&quot; rel=&quot;timothyjward&quot;&gt;timothyjward&lt;/a&gt;: thanks for the writing the test case! Mind generating the patch with something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git diff --no-prefix HEAD~1.. &amp;gt; ZOOKEEPER-2366.patch
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so that it applies cleanly and CI can run.. Thanks!&lt;/p&gt;</comment>
                            <comment id="15179362" author="phunt" created="Fri, 4 Mar 2016 05:34:44 +0000"  >&lt;p&gt;I updated the patch to apply cleanly - &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2366&quot; title=&quot;Reconfiguration of client port causes a socket leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2366&quot;&gt;&lt;del&gt;ZOOKEEPER-2366&lt;/del&gt;&lt;/a&gt;.patch&lt;/p&gt;</comment>
                            <comment id="15179382" author="hadoopqa" created="Fri, 4 Mar 2016 05:54:13 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12791407/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12791407/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1733525.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3082//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3082//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3082//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3082//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3082//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3082//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15294066" author="hadoopqa" created="Fri, 20 May 2016 19:54:01 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12791407/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12791407/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1743978.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3163//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3163//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3163//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3163//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3163//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3163//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15294866" author="fpj" created="Sat, 21 May 2016 09:07:36 +0000"  >&lt;p&gt;I think there is a confusion here. The patch that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=timothyjward&quot; class=&quot;user-hover&quot; rel=&quot;timothyjward&quot;&gt;timothyjward&lt;/a&gt; proposed is a test case to illustrate the problem, it is not a fix. We need to produce a fix and use the test case to verify.&lt;/p&gt;</comment>
                            <comment id="15295049" author="fpj" created="Sat, 21 May 2016 14:28:32 +0000"  >&lt;p&gt;Attaching a patch for this issue. I&apos;m a bit puzzled by the error handling for the reconfigure method. It sounds like it is swallowing exceptions and let the caller continue normally. In this patch, I have made changes to propagate the exception, and I think this is fine, but I&apos;d appreciate if someone else could have a look.&lt;/p&gt;</comment>
                            <comment id="15295061" author="hadoopqa" created="Sat, 21 May 2016 14:57:40 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12805471/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12805471/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1743978.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3168//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3168//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3168//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3168//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3168//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3168//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15295137" author="cnauroth" created="Sat, 21 May 2016 17:02:00 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;.  Thank you for picking up this patch.  I think the approach of propagating the exceptions looks like the right direction.  Here are a few comments.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                acceptThread.join();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error joining old acceptThread when reconfiguring client port &quot;&lt;/span&gt; + e.getMessage());
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This wasn&apos;t introduced by your patch, but it&apos;s generally a bad practice to catch an &lt;tt&gt;InterruptedException&lt;/tt&gt; and neither propagate it nor re-raise the interrupted status.  Other layers of code might be expecting to react to thread interruption.  Since we&apos;re touching this code, do you think we should add a call to &lt;tt&gt;Thread.currentThread().interrupt()&lt;/tt&gt;?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error reconfiguring client port to &quot;&lt;/span&gt; + addr + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + e.getMessage());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is also not a problem introduced by your patch, but can we pass along the &lt;tt&gt;e&lt;/tt&gt; as the second argument to log the full stack trace for better diagnosis?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
           LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;binding to port &quot;&lt;/span&gt; + addr);
           parentChannel = bootstrap.bind(addr);
           localAddress = addr;
       } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
           LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; reconfiguring&quot;&lt;/span&gt;, e);
           &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(e.getMessage());
       } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
           oldChannel.close();
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If there is an exception thrown from the try body, and then &lt;tt&gt;oldChannel.close()&lt;/tt&gt; also throws an exception, then the caller will receive the second exception.  Generally, the first exception is probably more interesting for root cause information, so I think it&apos;s preferrable to catch and log the exception in the finally block, or if you prefer, only throw from the finally block if the whole try block was successful.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { 
                self.processReconfig(newQV, designatedLeader, zk.getZxid(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does this exception need to be logged at this layer, or do all exceptions already get logged somewhere within the &lt;tt&gt;QuorumPeer#processReconfig&lt;/tt&gt; call?&lt;/p&gt;

&lt;p&gt;I think the test works for covering this change, but I see some incorrect indentation.  Would you please clean that up?&lt;/p&gt;</comment>
                            <comment id="15295141" author="shralex" created="Sat, 21 May 2016 17:09:56 +0000"  >&lt;p&gt;Thanks for the patch. A few comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In case the new port is taken, perhaps its better to leave the old port in effect ? (rather than to remain without a client port at all like now, which is expected in the new test)&lt;/li&gt;
	&lt;li&gt;Error message in Netty method is less informative. Consider making messages consistent in both methods.&lt;/li&gt;
	&lt;li&gt;I&apos;m not sure simply returning false in  Leader.java is sufficient. That operation may forever remain in the queue ? I&apos;m not sure about this since the&lt;br/&gt;
new test somehow works.&lt;/li&gt;
	&lt;li&gt;Indentation seems a bit weird in the changes in QuorumPeer and in the test.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15295146" author="shralex" created="Sat, 21 May 2016 17:23:11 +0000"  >&lt;p&gt;looks like the operation is removed from outstanding beforehand, so that&apos;s not a problem, but I&apos;m still&lt;br/&gt;
concerned about this for two reasons: its commit isn&apos;t being sent out, so followers will have a hole in the sequence,&lt;br/&gt;
and, if you see how tryToCommit is used, you&apos;ll see that there may be operations queued behind the reconfig that already have acks and by returning&lt;br/&gt;
false you&apos;re preventing those from being committed.&lt;/p&gt;</comment>
                            <comment id="15295147" author="shralex" created="Sat, 21 May 2016 17:30:20 +0000"  >&lt;p&gt;sorry, one more thing: quorumpeer.processreconfig is used not only by Leader.java but also in other places (follower, observer, learner etc). In fact the new test changes the follower&apos;s port, so I suspect that it doesn&apos;t even exercise the new code in Leader.java! &lt;/p&gt;</comment>
                            <comment id="15295167" author="shralex" created="Sat, 21 May 2016 18:07:15 +0000"  >&lt;p&gt;This is probably why errors were silent - introducing a proper failure flow for operations during commit might have been too complicated. For example, you must change the port to the blocked one in the config since a quorum accepted the op (unlike what I suggested previously before thinking more about it - you can&apos;t retain the old one open, this is exactly this bug).  For simplicity I&apos;d consider not throwing exceptions, logging as before and just fixing the leak. But perhaps there&apos;s a better solution.&lt;/p&gt;</comment>
                            <comment id="15295250" author="fpj" created="Sat, 21 May 2016 20:49:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;In case the new port is taken, perhaps its better to leave the old port in effect ? (rather than to remain without a client port at all like now, which is expected in the new test)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe so, my concern is that processReconfig-&amp;gt; reconfigure is called upon processing commit and activate and in the case there is a problem binding to the port, the current code will simply return successfully from reconfigure like if the processing of the message had succeeded, which it hasn&apos;t. The behavior sounds wrong to me, does it sound right to you?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Error message in Netty method is less informative. Consider making messages consistent in both methods.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure, I can change it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure simply returning false in Leader.java is sufficient. That operation may forever remain in the queue ? I&apos;m not sure about this since the&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;new test somehow works.&lt;/p&gt;

&lt;p&gt;Sounds like you have some more insight further down.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Indentation seems a bit weird in the changes in QuorumPeer and in the test.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, will fix&lt;/p&gt;</comment>
                            <comment id="15295255" author="fpj" created="Sat, 21 May 2016 20:53:08 +0000"  >&lt;p&gt;I think I see the concern, but it doesn&apos;t sound right either to not fail the reconfig operation in the case the processing of the operation doesn&apos;t succeed. That&apos;s actually the reason why I was concerned about this error handling. It sounds like either the tests aren&apos;t capturing reconfig failure scenarios properly or there is another code path to recover from these errors during the execution of the reconfiguration. There is something here that I&apos;m missing.&lt;/p&gt;</comment>
                            <comment id="15295258" author="fpj" created="Sat, 21 May 2016 20:57:58 +0000"  >&lt;p&gt;Sure, I noticed that it is called in all those places. When you say that the Leader code isn&apos;t being executed, what&apos;s your concern exactly? From what I can tell, if there is an error in NIOServerCnxnFactory.reconfigure(), the exception will propagate all the way to lead() and lead() will propagate up forcing the leader to resign, which I think it is fine if the server isn&apos;t behaving correctly.&lt;/p&gt;</comment>
                            <comment id="15295259" author="fpj" created="Sat, 21 May 2016 21:00:15 +0000"  >&lt;p&gt;I need to convince myself that we will get the correct behavior if we keep swallowing the exception. Right now my sense is that this isn&apos;t right, which led me to propose this patch, but I was actually counting on having to tweak it more because it feels like it needs some thinking. There is no rush, let&apos;s do this right.&lt;/p&gt;</comment>
                            <comment id="15295261" author="fpj" created="Sat, 21 May 2016 21:01:06 +0000"  >&lt;p&gt;Thanks for the comments, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;. Let&apos;s agree first on the right way to fix this and then I&apos;ll make sure these are addressed.&lt;/p&gt;</comment>
                            <comment id="15295278" author="shralex" created="Sat, 21 May 2016 21:44:08 +0000"  >&lt;p&gt;let me try to clarify:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;as you know, in ZK operations fail only (a) at the leader and (b) during pre-processing. Here the situation is different - (a) the reconfig could be trying to alter a follower&apos;s port, which may be taken (the leader has no way to know that), and (b) this is detected during commit time when the change is attempted. At that point, the operation is committed for all practical purposes (quorum already accepted), there is no way to abort it. What can we do without redesigning ZK ? my suggestion is to keep logging an error and not propagate it up (because you can&apos;t do anything about it anyway) but of course to close the port, which is what the bug was opened for and what the patch does. The alternative is perhaps to bring down that server because its state can&apos;t reflect a committed operation, but I think its an overkill &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why I said that the new &quot;return false&quot; in Leader.java isn&apos;t exercised by the test: because the test scenario is trying to change a follower&apos;s port, so processReconfig fails to change it at the follower, the leader will execute processReconfig just fine, since all it does is update the config in memory.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;returning false in Leader.java is wrong. My comments can probably be better there, but false has a different meaning - it indicates that there are not enough acks. Operations do not fail at the commit stage.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The test can be improved a bit to also try to reconfig the leader&apos;s client port and see what happens when its taken. Right now it only checks for follower. Its possible to do that without adding too much code if you do the flow in a loop - once for leader and once for follower. I think its also ok without this extension though.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="15295575" author="fpj" created="Sun, 22 May 2016 14:06:42 +0000"  >&lt;p&gt;That&apos;s good insight.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At that point, the operation is committed for all practical purposes (quorum already accepted), there is no way to abort it. What can we do without redesigning ZK ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;d say that this part is fine, I&apos;m ok with letting it commit. I&apos;m less ok with the server that is supposed to change the port failing to do it and keep operating regularly. For example, if we are changing the port of a follower and the port change fails, then I&apos;d say that the follower should stop following, and a bit more drastically perhaps even exit.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The alternative is perhaps to bring down that server because its state can&apos;t reflect a committed operation, but I think its an overkill.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I actually think this is a problem. If the user changes something on the server, then the user expects to either see the change reflected or an immediate indication of an error. Granted that we are printing an error message, but I think we can do better than that to call the admin attention to the problem right away.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the test scenario is trying to change a follower&apos;s port, so processReconfig fails to change it at the follower, the leader will execute processReconfig just fine, since all it does is update the config in memory. Returning false in Leader.java is wrong. My comments can probably be better there, but false has a different meaning - it indicates that there are not enough acks. Operations do not fail at the commit stage.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Got it, and I don&apos;t claim that bit is correct, I&apos;ll have a closer look at the Leader code.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The test can be improved a bit to also try to reconfig the leader&apos;s client port and see what happens when its taken. Right now it only checks for follower. Its possible to do that without adding too much code if you do the flow in a loop - once for leader and once for follower. I think its also ok without this extension though.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok.&lt;/p&gt;
</comment>
                            <comment id="15295631" author="shralex" created="Sun, 22 May 2016 17:04:43 +0000"  >&lt;p&gt;Sure. But keep in mind that many clients could be connected to the follower, so shutting down may be disruptive.&lt;br/&gt;
And more importantly, if this is the leader we&apos;re talking about (failed attempt to change leader&apos;s client port), then shutting it down&lt;br/&gt;
will bring the whole system down, and it may not recover since it is very likely to keep trying to become the leader and fail&lt;br/&gt;
due to the taken client port. So unless there&apos;s some way to raise an alert, maybe we should just document in the manual &lt;br/&gt;
that when changing the client port of a server the admin should always verify that it worked the port by opening CLI or similar.&lt;/p&gt;

&lt;p&gt;BTW, I briefly looked what happens when other ports are changed: for leading port change, the leader will resign, and for quorum port the leader election is restarted.&lt;/p&gt;</comment>
                            <comment id="15297305" author="fpj" created="Mon, 23 May 2016 23:04:20 +0000"  >&lt;p&gt;Let&apos;s see if we can agree on the behavior. Without reconfiguration, if there is an IOException while starting the cnxn factory, then the server will exit. You&apos;re saying that upon a reconfiguration of the client port, the situation is different because the server might already have a number of clients connected to it. But, if we are to close the old port regardless of whether binding to the new port succeeded, then we&apos;ll be losing those clients connections in any case. I get the point of the server being re-elected and failing every time, we do want to avoid that scenario, so either we log and proceed or we exit the server. &lt;/p&gt;
</comment>
                            <comment id="15297318" author="shralex" created="Mon, 23 May 2016 23:14:52 +0000"  >&lt;p&gt;I don&apos;t think we&apos;re loosing the connected clients since the port is only used to accept connections, but then another random port is used to actually communicate. I&apos;m not 100% sure, but if I remember correctly this is how it works. &lt;/p&gt;</comment>
                            <comment id="15297325" author="shralex" created="Mon, 23 May 2016 23:18:02 +0000"  >&lt;p&gt;Yeah I also say this in the manual, so I must have checked it &quot;When the client port of a server is modified, it does not drop existing client connections. New connections to the server will have to use the new client port.&quot;&lt;/p&gt;</comment>
                            <comment id="15297388" author="cnauroth" created="Tue, 24 May 2016 00:06:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, thank you for your comments.  I missed a lot of subtlety in the error handling here when I reviewed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At that point, the operation is committed for all practical purposes (quorum already accepted), there is no way to abort it. What can we do without redesigning ZK ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thinking out loud, so I&apos;m probably missing something, but can we do something like bind to the new port during the proposal, but still keep the old port listening too?  Then, during commit, we&apos;d transition the accept thread to the new already-bound port and close the old one.  The effect I&apos;m trying to achieve is moving the bind failure to proposal time, so it won&apos;t get ack&apos;d as successful, and therefore the quorum won&apos;t accept it.&lt;/p&gt;

&lt;p&gt;Of course, this is a much heavier change and maybe strays towards &quot;redesigning ZK&quot;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;so either we log and proceed or we exit the server.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thinking about the operational model, I could see &quot;exit the server&quot; easily escalating to &quot;exit the ensemble.&quot;  If the admin accidentally reconfigs to a commonly bound port, such as 8080 for an HTTP server, then there is a strong possibility that all servers in the ensemble would hit the bind failure and exit.&lt;/p&gt;</comment>
                            <comment id="15297431" author="cnauroth" created="Tue, 24 May 2016 00:32:53 +0000"  >&lt;p&gt;If we pursued something like this, then we&apos;d open up another edge case to worry about: a port getting bound on a subset of servers, but not accepted by the quorum, so then the bound port is left lingering on that subset of servers.&lt;/p&gt;</comment>
                            <comment id="15297685" author="shralex" created="Tue, 24 May 2016 05:04:02 +0000"  >&lt;p&gt;I think its actually worse - consider a reconfig changing just one client port, of one of the servers. All the other servers don&apos;t need to perform any operation besides updating the config in their memory, so they won&apos;t have any issue. The single server may object because it can&apos;t bind to the port, but the leader only needs a majority vote, so his objection may not arrive on time for the commit.&lt;/p&gt;

&lt;p&gt;I just want to point out that there is no voting in Paxos or ZooKeeper. Servers don&apos;t say no to the leader&apos;s proposals. Protocols in which servers can say no are distributed commit protocols (e.g., 2 phase commit, 3 phase commit, E3PC, etc.) but ZooKeeper solves consensus, in which servers don&apos;t have a Yes/No vote or veto powers.&lt;/p&gt;</comment>
                            <comment id="15298372" author="cnauroth" created="Tue, 24 May 2016 15:42:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;I just want to point out that there is no voting in Paxos or ZooKeeper.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Absolutely.  As I think more about trying to push the bind into the proposal phase, it just opens up more failure modes with no clear solutions.  As you said, this is exactly what multi-phase commit addresses, but then we&apos;ve got a very different system on our hands.&lt;/p&gt;

&lt;p&gt;I&apos;m slowly coming around to the opinion that we should follow your earlier suggestion to leave the error handling as is and simply ensure the old socket gets closed to prevent the leak.  This would allow the admin to recover by reconfiguring back to the old port (or a different new port).  It&apos;s unusual in that the server can&apos;t reflect committed state, but the alternative of halting increases the severity of the problem.  I don&apos;t see a cleaner alternative that wouldn&apos;t cause a huge impact on overall ZooKeeper architecture.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, what are your current thoughts?&lt;/p&gt;</comment>
                            <comment id="15298451" author="fpj" created="Tue, 24 May 2016 16:23:02 +0000"  >&lt;p&gt;It doesn&apos;t actually bother me that we don&apos;t abort the command, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; points out, we don&apos;t have the notion of abort. The bit the bothers me is the fact that it transparently fails and we rely on the administrator to go check logs or perform manual tests to make sure that it worked. Bringing the server down is indeed sounding like a bad idea, but not surfacing the problem in a fairly visible manner is also not ideal. &lt;/p&gt;</comment>
                            <comment id="15298462" author="cnauroth" created="Tue, 24 May 2016 16:30:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;...not surfacing the problem in a fairly visible manner is also not ideal.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you think we could solve this part with an enhancement to do some additional sanity checks from the client side after the reconfig completes?&lt;/p&gt;</comment>
                            <comment id="15302591" author="cnauroth" created="Thu, 26 May 2016 17:59:24 +0000"  >&lt;p&gt;Since this has turned out to be trickier than simply ensuring close of a socket, and we haven&apos;t reached consensus on a solution, I&apos;d like to suggest that we defer out of the upcoming 3.5.2 release candidate.  Are there any objections?&lt;/p&gt;</comment>
                            <comment id="15302606" author="shralex" created="Thu, 26 May 2016 18:06:20 +0000"  >&lt;p&gt;It sounds like the three of us agree that 1. we must close the socket and log the error 2. We shouldn&apos;t abort or crash the server. 3. we should think of a way to make the administrator aware of the problem (documentation / client-side checking / some kind of alert / something else)&lt;/p&gt;

&lt;p&gt;1 and 2 sound straightforward and require simplifying the patch and removing some stuff. 3 is something we&apos;re not sure about. &lt;br/&gt;
So perhaps it could make sense to have 1+2 go into the 3.5.2 and 3 should be a separate jira. Up to you guys.&lt;/p&gt;</comment>
                            <comment id="15302646" author="cnauroth" created="Thu, 26 May 2016 18:30:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, thanks for the reply.&lt;/p&gt;

&lt;p&gt;Yes, I agree on all 3 points.  I also agree that 1+2 in 3.5.2 is a viable plan, with 3 to go into a separate JIRA targeted to a later release.  If others disagree, then I&apos;d also be comfortable deferring the whole thing in the interest of building consensus and moving ahead with a 3.5.2 release candidate.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, what is your opinion?&lt;/p&gt;</comment>
                            <comment id="15303083" author="fpj" created="Thu, 26 May 2016 22:31:20 +0000"  >&lt;p&gt;I&apos;m fine with not fixing the third point for 3.5.2. I&apos;ve been thinking that we could have an admin tool for reconfiguration, and the tool could use a new 4lw to pull the result of the execution of the latest successful reconfig command. Because we don&apos;t have an error path for the execution of the reconfiguration itself, the viable way I see is to store it and enable a client to pull it. Would that work?&lt;/p&gt;</comment>
                            <comment id="15335818" author="fpj" created="Fri, 17 Jun 2016 10:11:40 +0000"  >&lt;p&gt;I&apos;ve reverted the change back to no propagate the exception, but only log the error message. I&apos;ll do the client side change in another jira because I don&apos;t want it blocking this issue. &lt;/p&gt;

&lt;p&gt;I&apos;ve added a few reformatting changes to this jira, but if it bothers anyone, I&apos;m happy to not do them here.&lt;/p&gt;</comment>
                            <comment id="15335843" author="hadoopqa" created="Fri, 17 Jun 2016 10:37:35 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12811336/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12811336/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3189//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3189//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3189//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3189//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3189//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3189//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15338013" author="cnauroth" created="Sat, 18 Jun 2016 16:38:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, thank you for the new patch.&lt;/p&gt;

&lt;p&gt;This is a repeat of an earlier comment: This wasn&apos;t introduced by your patch, but it&apos;s generally a bad practice to catch an &lt;tt&gt;InterruptedException&lt;/tt&gt; and neither propagate it nor re-raise the interrupted status. Other layers of code might be expecting to react to thread interruption. Since we&apos;re touching this code, do you think we should add a call to &lt;tt&gt;Thread.currentThread().interrupt()&lt;/tt&gt;?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void reconfigure(InetSocketAddress addr) {
       Channel oldChannel = parentChannel;
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
           LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;binding to port &quot;&lt;/span&gt; + addr);
           parentChannel = bootstrap.bind(addr);
           localAddress = addr;
       } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
           LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; reconfiguring&quot;&lt;/span&gt;, e);
       } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
           oldChannel.close();
       }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t see a checked exception raised in that code block.  Is the catch block there in anticipation of an unchecked exception that you&apos;ve seen?&lt;/p&gt;

&lt;p&gt;Hmmm... this isn&apos;t directly related to your patch, but something seems odd here.  The Netty bind and close calls are asynchronous, so when this method returns, it&apos;s not guaranteed that the bind and close have completed.  I wonder if we have a race condition lurking.&lt;/p&gt;

&lt;p&gt;A very minor nitpick:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NIOServerCnxnFactory.java:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;binding to port &quot;&lt;/span&gt; + addr);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error joining old acceptThread when reconfiguring client port &quot;&lt;/span&gt; + e.getMessage());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error reconfiguring client port to &quot;&lt;/span&gt; + addr + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + e.getMessage());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;NettyServerCnxnFactory:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;           LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;binding to port &quot;&lt;/span&gt; + addr);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since we&apos;re touching these lines of code anyway for the reformatting, let&apos;s take the opportunity to switch to the SLF4J calling convention with {} token substitutions.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, would you also like to review the latest approach?&lt;/p&gt;</comment>
                            <comment id="15338543" author="fpj" created="Sun, 19 Jun 2016 14:47:58 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since we&apos;re touching this code, do you think we should add a call to Thread.currentThread().interrupt()?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The try/catch block wasn&apos;t there for the netty cnxn factory, I&apos;ve added it in this patch because the bind call does seem to throw some runtime exceptions so I wanted to make sure we at least log the error in the case something goes wrong. But, according to the documentation, &lt;tt&gt;ServerBootstrap.bind&lt;/tt&gt; does not throw &lt;tt&gt;InterruptedException&lt;/tt&gt;, or am I reading it wrong?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The Netty bind and close calls are asynchronous, so when this method returns, it&apos;s not guaranteed that the bind and close have completed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If the bind is asynchronous, then the server will simply not accept client connection requests until it completes. As for the close, the worst that can happen is that it accepts a connection request through the old port after the reconfigure call completes. I don&apos;t see a problem, but you let me know if I&apos;m missing anything.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;let&apos;s take the opportunity to switch to the SLF4J calling convention with {} token substitutions&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep, done.&lt;/p&gt;
</comment>
                            <comment id="15338555" author="hadoopqa" created="Sun, 19 Jun 2016 15:05:17 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12811707/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12811707/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3191//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3191//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3191//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3191//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3191//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3191//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15338808" author="cnauroth" created="Sun, 19 Jun 2016 21:56:45 +0000"  >&lt;p&gt;Thanks for the updated patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The comment about thread interruption referred to this piece of code in &lt;tt&gt;NIOServerCnxnFactory&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                acceptThread.join();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error joining old acceptThread when reconfiguring client port {}&quot;&lt;/span&gt;,
                            e.getMessage());
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sorry if I was unclear about that.  Again, this isn&apos;t introduced by your patch, so feel free to defer this part of the feedback if you prefer.&lt;/p&gt;

&lt;p&gt;I was concerned that the asynchronous bind might be a source of flaky tests, but really the client-side retry logic would just take care of it.  I think you&apos;re right that it&apos;s not really a problem.&lt;/p&gt;

&lt;p&gt;+1 for the patch.  I leave it to you to decide whether or not to address the thread interruption.  I&apos;d be +1 either way.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, do you have further feedback?&lt;/p&gt;</comment>
                            <comment id="15342189" author="fpj" created="Tue, 21 Jun 2016 17:05:42 +0000"  >&lt;p&gt;I&apos;ll make the change you&apos;re requesting and submit a new patch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="15343979" author="fpj" created="Wed, 22 Jun 2016 09:17:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; added the interrupt call.&lt;/p&gt;</comment>
                            <comment id="15344007" author="hadoopqa" created="Wed, 22 Jun 2016 09:38:29 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812439/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812439/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3237//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3237//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3237//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3237//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3237//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3237//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15344692" author="cnauroth" created="Wed, 22 Jun 2016 16:35:31 +0000"  >&lt;p&gt;+1 for the latest patch.  Thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; or any other committers, can we possibly get someone to do a second review by 12 noon Thursday, 6/23 PST, so that we can include this for the deadline I set out for the 3.5.2 release candidate?&lt;/p&gt;</comment>
                            <comment id="15344702" author="shralex" created="Wed, 22 Jun 2016 16:40:40 +0000"  >&lt;p&gt;Hi Chris, I&apos;ll try to do a review later today. Sorry for the delay but I&apos;m&lt;br/&gt;
traveling.&lt;/p&gt;

</comment>
                            <comment id="15344707" author="cnauroth" created="Wed, 22 Jun 2016 16:41:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, no worries.  Thank you!&lt;/p&gt;</comment>
                            <comment id="15345955" author="fpj" created="Thu, 23 Jun 2016 07:24:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;can we possibly get someone to do a second review by 12 noon Thursday, 6/23 PST, so that we can include this for the deadline I set out for the 3.5.2 release candidate?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A quick reminder that we need this in for the release candidate &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15346291" author="shralex" created="Thu, 23 Jun 2016 11:28:47 +0000"  >&lt;p&gt;Two comments about the test:&lt;br/&gt;
1. It still checks follower&apos;s client port change, but not leader&apos;s client port change, which we may also want to do as suggested in the comments above. &lt;br/&gt;
2. There&apos;s a try block without a catch. &lt;br/&gt;
  try (ServerSocket ss2 = new ServerSocket()) &lt;/p&gt;
{
+                ss2.bind(new InetSocketAddress(getLoopbackAddress(), oldClientPort));
+            }

&lt;p&gt;Is this intentional ? The test also throws an exception.&lt;br/&gt;
Maybe the intention is to bind the old port and then unbind when ss2 goes out of scope. Is this release instantanious or could it&lt;br/&gt;
fail the following code that needs the old port vacant ? Maybe we should just remove this try block ?&lt;/p&gt;

&lt;p&gt;Another question: could Thread.currentThread().interrupt() somehow crash the server ? &lt;/p&gt;</comment>
                            <comment id="15346294" author="shralex" created="Thu, 23 Jun 2016 11:33:18 +0000"  >&lt;p&gt;Regarding extending the test, if you don&apos;t want to do it now because of time constraints, maybe just add a TODO in the code or something ?&lt;/p&gt;</comment>
                            <comment id="15346521" author="fpj" created="Thu, 23 Jun 2016 14:35:01 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;. I have added the test case for the leader. I had to fix the call to &lt;tt&gt;updateThreadName&lt;/tt&gt; in &lt;tt&gt;QuorumPeer&lt;/tt&gt; because it was giving me a NPE for the leader test case as &lt;tt&gt;getLocalAddress&lt;/tt&gt; is null when the port reconfiguration changes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;try (ServerSocket ss2 = new ServerSocket()) { + ss2.bind(new InetSocketAddress(getLoopbackAddress(), oldClientPort)); + } Is this intentional ? The test also throws an exception.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is intentional, it is just defining the scope of ss2 to be that block so that we can check the status of the port.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;could Thread.currentThread().interrupt() somehow crash the server ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think so, but we don&apos;t want to swallow &lt;tt&gt;InterruptedException&lt;/tt&gt; in general. If it turns out to be a problem, then we will fix it, but I&apos;d say that we do as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; suggested.&lt;/p&gt;</comment>
                            <comment id="15346560" author="hadoopqa" created="Thu, 23 Jun 2016 14:58:52 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812837/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812837/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3246//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3246//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3246//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3246//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3246//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3246//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15346571" author="shralex" created="Thu, 23 Jun 2016 15:05:47 +0000"  >&lt;p&gt;Thanks Flavio. +1 from me&lt;/p&gt;</comment>
                            <comment id="15346631" author="rgs" created="Thu, 23 Jun 2016 15:43:21 +0000"  >&lt;p&gt;Hey all, sorry for joining the party late. One quick note is that in NIOServerCnxnFactory.reconfigure():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;....
+            acceptThread.setReconfiguring();
+            oldSS.close();
+            acceptThread.wakeupSelector();
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;sounds like that first oldSS.close() call should be wrapped with a try/catch IOException given it&apos;s best effort too (it could be gone by that time, no?).&lt;/p&gt;

&lt;p&gt;Other than, +1.&lt;/p&gt;</comment>
                            <comment id="15346710" author="fpj" created="Thu, 23 Jun 2016 16:35:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; I&apos;m not sure whether you missed it or I&apos;m not getting the comment, but the close call is within a try/catch block:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
try {
            this.ss = ServerSocketChannel.open();
            ss.socket().setReuseAddress(true);
            LOG.info(&quot;binding to port &quot; + addr);
            ss.socket().bind(addr);
            ss.configureBlocking(false);
            acceptThread.setReconfiguring();
            oldSS.close();
            acceptThread.wakeupSelector();
            try {
                acceptThread.join();
            } catch (InterruptedException e) {
                LOG.error(&quot;Error joining old acceptThread when reconfiguring client port {}&quot;,
                            e.getMessage());
                Thread.currentThread().interrupt();
            }
            acceptThread = new AcceptThread(ss, addr, selectorThreads);
            acceptThread.start();
        } catch(IOException e) {
            LOG.error(&quot;Error reconfiguring client port to {} {}&quot;, addr, e.getMessage());
            try {
                oldSS.close();
            } catch (IOException sse) {
                LOG.error(&quot;Error while closing old server socket.&quot;, sse);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Assuming that everything is ok, you get to commit it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15346728" author="cnauroth" created="Thu, 23 Jun 2016 16:45:48 +0000"  >&lt;p&gt;Thanks very much, everyone.  I&apos;ll make sure to commit this before creating a 3.5.2 release candidate, unless another friendly volunteer beats me to it.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15346833" author="rgs" created="Thu, 23 Jun 2016 17:33:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;: what I am saying is that closing the (old) socket should always be best effort, the outer try/catch means that acceptThread.wakeupSelector() (and what comes after) would be skipped, which doesn&apos;t sound right.&lt;/p&gt;

&lt;p&gt;I think it should be like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void tryClose(ServerSocketChannel s) {
          &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                s.close();
          } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException sse) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; closing server socket.&quot;&lt;/span&gt;, sse);
          }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void reconfigure(InetSocketAddress addr) {
         ServerSocketChannel oldSS = ss;        
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.ss = ServerSocketChannel.open();
            ss.socket().setReuseAddress(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;binding to port &quot;&lt;/span&gt; + addr);
            ss.socket().bind(addr);
            ss.configureBlocking(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            acceptThread.setReconfiguring();
            tryClose(oldSS);
            acceptThread.wakeupSelector();
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                acceptThread.join();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error joining old acceptThread when reconfiguring client port {}&quot;&lt;/span&gt;,
                            e.getMessage());
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
            }
            acceptThread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AcceptThread(ss, addr, selectorThreads);
            acceptThread.start();
         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(IOException e) {
            LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error reconfiguring client port to {} {}&quot;&lt;/span&gt;, addr, e.getMessage());
            tryClose(oldSS);
         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thus, the outer try/catch is about the rest of the stuff we are doing and closing the old socket is only a best effort thing. &lt;/p&gt;</comment>
                            <comment id="15346871" author="fpj" created="Thu, 23 Jun 2016 18:00:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; Got it, in the case it all goes well but closing the old socket throws an exception, then we would be skipping the subsequent calls. I&apos;ll make the change.&lt;/p&gt;</comment>
                            <comment id="15346973" author="fpj" created="Thu, 23 Jun 2016 18:53:09 +0000"  >&lt;p&gt;Can I get a +1 here, please?&lt;/p&gt;</comment>
                            <comment id="15346986" author="rgs" created="Thu, 23 Jun 2016 19:01:04 +0000"  >&lt;p&gt;+1, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;: i&apos;ll go ahead and merge this. &lt;/p&gt;</comment>
                            <comment id="15346989" author="rgs" created="Thu, 23 Jun 2016 19:01:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;: actually, can&apos;t merge from here, I am on the wrong laptop, sorry &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="15347018" author="hadoopqa" created="Thu, 23 Jun 2016 19:19:03 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812901/ZOOKEEPER-2366.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812901/ZOOKEEPER-2366.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1749951.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 11 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3248//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3248//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3248//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3248//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3248//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3248//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15347053" author="cnauroth" created="Thu, 23 Jun 2016 19:50:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, thanks very much for that additional catch in your code review.  +1 from me again on the latest patch.  I&apos;ll make sure to commit it before creating the release candidate.&lt;/p&gt;</comment>
                            <comment id="15347271" author="cnauroth" created="Thu, 23 Jun 2016 21:46:53 +0000"  >&lt;p&gt;I have committed this to trunk and branch-3.5.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, thank you for the patch.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, thank you for the code reviews.&lt;/p&gt;</comment>
                            <comment id="15347341" author="hudson" created="Thu, 23 Jun 2016 22:36:54 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2972 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2972/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2972/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2366&quot; title=&quot;Reconfiguration of client port causes a socket leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2366&quot;&gt;&lt;del&gt;ZOOKEEPER-2366&lt;/del&gt;&lt;/a&gt;: Reconfiguration of client port causes a socket leak. (fpj via cnauroth) (cnauroth: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1750025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1750025&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/test/NettyNettySuiteTest.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/test/NioNettySuiteTest.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/test/ReconfigTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12812901" name="ZOOKEEPER-2366.patch" size="14358" author="fpj" created="Thu, 23 Jun 2016 18:53:09 +0000"/>
                            <attachment id="12812837" name="ZOOKEEPER-2366.patch" size="14079" author="fpj" created="Thu, 23 Jun 2016 14:29:22 +0000"/>
                            <attachment id="12812439" name="ZOOKEEPER-2366.patch" size="13058" author="fpj" created="Wed, 22 Jun 2016 09:17:48 +0000"/>
                            <attachment id="12811707" name="ZOOKEEPER-2366.patch" size="13005" author="fpj" created="Sun, 19 Jun 2016 14:41:03 +0000"/>
                            <attachment id="12811336" name="ZOOKEEPER-2366.patch" size="12501" author="fpj" created="Fri, 17 Jun 2016 10:06:22 +0000"/>
                            <attachment id="12805471" name="ZOOKEEPER-2366.patch" size="13725" author="fpj" created="Sat, 21 May 2016 14:28:32 +0000"/>
                            <attachment id="12791407" name="ZOOKEEPER-2366.patch" size="6202" author="phunt" created="Fri, 4 Mar 2016 05:34:44 +0000"/>
                            <attachment id="12787954" name="zookeeper.patch" size="6178" author="timothyjward" created="Mon, 15 Feb 2016 15:40:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ss4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>