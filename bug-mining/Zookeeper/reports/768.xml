<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:58:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2247] Zookeeper service becomes unavailable when leader fails to write transaction log</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2247</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Zookeeper service becomes unavailable when leader fails to write transaction log. Bellow are the exceptions&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2015-08-14 15:41:18,556 [myid:100] - ERROR [SyncThread:100:ZooKeeperCriticalThread@48] - Severe unrecoverable error, from thread : SyncThread:100
java.io.IOException: Input/output error
	at sun.nio.ch.FileDispatcherImpl.force0(Native Method)
	at sun.nio.ch.FileDispatcherImpl.force(FileDispatcherImpl.java:76)
	at sun.nio.ch.FileChannelImpl.force(FileChannelImpl.java:376)
	at org.apache.zookeeper.server.persistence.FileTxnLog.commit(FileTxnLog.java:331)
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.commit(FileTxnSnapLog.java:380)
	at org.apache.zookeeper.server.ZKDatabase.commit(ZKDatabase.java:563)
	at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:178)
	at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:113)
2015-08-14 15:41:18,559 [myid:100] - INFO  [SyncThread:100:ZooKeeperServer$ZooKeeperServerListenerImpl@500] - &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; SyncThread:100 exits, error code 1
2015-08-14 15:41:18,559 [myid:100] - INFO  [SyncThread:100:ZooKeeperServer@523] - shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:SessionTrackerImpl@232] - Shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:LeaderRequestProcessor@77] - Shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:PrepRequestProcessor@1035] - Shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:ProposalRequestProcessor@88] - Shutting down
2015-08-14 15:41:18,561 [myid:100] - INFO  [SyncThread:100:CommitProcessor@356] - Shutting down
2015-08-14 15:41:18,561 [myid:100] - INFO  [CommitProcessor:100:CommitProcessor@191] - CommitProcessor exited loop!
2015-08-14 15:41:18,562 [myid:100] - INFO  [SyncThread:100:Leader$ToBeAppliedRequestProcessor@915] - Shutting down
2015-08-14 15:41:18,562 [myid:100] - INFO  [SyncThread:100:FinalRequestProcessor@646] - shutdown of request processor complete
2015-08-14 15:41:18,562 [myid:100] - INFO  [SyncThread:100:SyncRequestProcessor@191] - Shutting down
2015-08-14 15:41:18,563 [myid:100] - INFO  [ProcessThread(sid:100 cport:-1)::PrepRequestProcessor@159] - PrepRequestProcessor exited loop!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After this exception Leader server still remains leader. After this non recoverable exception the leader should go down and let other followers become leader.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12856158">ZOOKEEPER-2247</key>
            <summary>Zookeeper service becomes unavailable when leader fails to write transaction log</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rakeshr">Rakesh Radhakrishnan</assignee>
                                    <reporter username="arshad.mohammad">Mohammad Arshad</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 14 Aug 2015 13:13:18 +0000</created>
                <updated>Wed, 30 Jan 2019 14:31:35 +0000</updated>
                            <resolved>Sat, 13 Aug 2016 13:59:04 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.4.9</fixVersion>
                    <fixVersion>3.5.3</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="14696980" author="arshad.mohammad" created="Fri, 14 Aug 2015 13:21:20 +0000"  >&lt;p&gt;The problem is because quorum is not being shutdown along with other services. We should also call shutdown on  &lt;tt&gt;org.apache.zookeeper.server.quorum.QuorumPeer&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14696982" author="arshad.mohammad" created="Fri, 14 Aug 2015 13:21:44 +0000"  >&lt;p&gt;I will soon submit a patch&lt;/p&gt;</comment>
                            <comment id="14698563" author="rakeshr" created="Sun, 16 Aug 2015 07:30:07 +0000"  >&lt;p&gt;Yes, it should do &lt;tt&gt;quorumpeer#shutdown&lt;/tt&gt; inorder to stop the service. Also, could you verify the behavior of standalone server.&lt;/p&gt;</comment>
                            <comment id="14701091" author="arshad.mohammad" created="Tue, 18 Aug 2015 11:13:27 +0000"  >&lt;p&gt;Standalone zookeeper server has the same behavior. After error neither it exists nor able to serve client request. I think in standalone case we should shutdown the process itself as it does not have option to switch to other role.&lt;/p&gt;</comment>
                            <comment id="14701107" author="fpj" created="Tue, 18 Aug 2015 11:34:16 +0000"  >&lt;p&gt;From the log lines in the description, it is shutting down, so I suppose you&apos;re saying that the same server keeps being re-elected? Do you what&apos;s wrong with your disk?&lt;/p&gt;</comment>
                            <comment id="14701139" author="rakeshr" created="Tue, 18 Aug 2015 11:53:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the analysis. IMHO we should handle QuorumPeer and Standalone separately. One approach I&apos;m thinking is, presently &lt;tt&gt;ZooKeeperServerListenerImpl&lt;/tt&gt; is inside ZooKeeperServer.java we can move this to a separate java file. &lt;br/&gt;
.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Standalone&lt;/b&gt; server can use this one, here instead of zks#shutdown() we should think of interrupting &lt;tt&gt;cnxnFactory&lt;/tt&gt; and &lt;tt&gt;secureCnxnFactory&lt;/tt&gt; and gracefully bring down the server.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;QuorumPeer&lt;/b&gt; can do &lt;tt&gt;QuorumPeerListenerImpl extends ZooKeeperServerListenerImpl&lt;/tt&gt; and stop respective observer/follower/leader service. This way  will make the server to LOOKING state and allows to continue with the internal leader-election. This is similar to a situation where QuorumPeer hits unexpected exception and giving another chance to join quorum. Please refer below switch case logic, which is similar to the finally block of each &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java#L1055&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;QuorumPeer#L1055&lt;/a&gt; server respectively.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;QuorumPeer#stopService(){
	&lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (getPeerState()) {
		&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; OBSERVING:
                       &lt;span class=&quot;code-comment&quot;&gt;// stopObserver();
&lt;/span&gt;                       observer.shutdown();
                       setObserver(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);  
                       updateServerState();
                       &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
		&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; FOLLOWING:
                       &lt;span class=&quot;code-comment&quot;&gt;// stopFollower();
&lt;/span&gt;                       follower.shutdown();
                       setFollower(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
                       updateServerState();
                       &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
		&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; LEADING:
                       &lt;span class=&quot;code-comment&quot;&gt;// stopLeader();
&lt;/span&gt;                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (leader != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            leader.shutdown(&lt;span class=&quot;code-quote&quot;&gt;&quot;Forcing shutdown&quot;&lt;/span&gt;);
                            setLeader(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
                        }
                        updateServerState();
                       &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14701168" author="rakeshr" created="Tue, 18 Aug 2015 12:13:06 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the interest. I haven&apos;t seen your comment and was composing the below comment&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; My understanding about the case is, presently &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperServer.java#L474&lt;/a&gt; does quorumserver#shutdown(), but here it is leaving quorum peer state as running(Observer/Follower/Leader). This is not calling Observer/Follower/Leader#shutdown the service. Also, zks#shutdown is stopping &lt;tt&gt;ElectionAlg&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14701172" author="arshad.mohammad" created="Tue, 18 Aug 2015 12:16:43 +0000"  >&lt;p&gt;1) No, same server is not being being re-elected again-again. Re-election is not happening at all, this is because quorum not stopped.&lt;br/&gt;
2) Yes, the disk suddenly becomes read-only&lt;/p&gt;</comment>
                            <comment id="14701189" author="rakeshr" created="Tue, 18 Aug 2015 12:41:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, zks#shutdown is stopping ElectionAlg.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is wrong statement, please ignore it.&lt;/p&gt;</comment>
                            <comment id="14701583" author="fpj" created="Tue, 18 Aug 2015 16:56:05 +0000"  >&lt;p&gt;Bear with me because it doesn&apos;t make sense to me, the description of the jira has this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-08-14 15:41:18,559 [myid:100] - INFO  [SyncThread:100:ZooKeeperServer@523] - shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:SessionTrackerImpl@232] - Shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:LeaderRequestProcessor@77] - Shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:PrepRequestProcessor@1035] - Shutting down
2015-08-14 15:41:18,560 [myid:100] - INFO  [SyncThread:100:ProposalRequestProcessor@88] - Shutting down
2015-08-14 15:41:18,561 [myid:100] - INFO  [SyncThread:100:CommitProcessor@356] - Shutting down
2015-08-14 15:41:18,561 [myid:100] - INFO  [CommitProcessor:100:CommitProcessor@191] - CommitProcessor exited loop!
2015-08-14 15:41:18,562 [myid:100] - INFO  [SyncThread:100:Leader$ToBeAppliedRequestProcessor@915] - Shutting down
2015-08-14 15:41:18,562 [myid:100] - INFO  [SyncThread:100:FinalRequestProcessor@646] - shutdown of request processor complete
2015-08-14 15:41:18,562 [myid:100] - INFO  [SyncThread:100:SyncRequestProcessor@191] - Shutting down
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This says that the server pipeline is shutting down!&lt;/p&gt;</comment>
                            <comment id="14701585" author="fpj" created="Tue, 18 Aug 2015 16:56:57 +0000"  >&lt;p&gt;Also, I&apos;m not sure how the disk can suddenly become read-only. It doesn&apos;t seem to be full from the exception.&lt;/p&gt;</comment>
                            <comment id="14702429" author="rakeshr" created="Wed, 19 Aug 2015 04:35:34 +0000"  >&lt;p&gt;Let me try to add more details. &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt; has added &lt;tt&gt;ZooKeeperServerListenerImpl&lt;/tt&gt; to handle exceptions from ZK thread. On receiving exception, ZooKeeperServerListenerImpl will call zks#shutdown(). The above exception trace is showing the same. Like I mentioned earlier here it missed to stop the server state (Observer/Follower/Leader) fully, due to this it won&apos;t trigger re-election again and reforms the server pipeline. Probably &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; can share the unit tests to understand it well.&lt;/p&gt;</comment>
                            <comment id="14702916" author="arshad.mohammad" created="Wed, 19 Aug 2015 12:11:08 +0000"  >&lt;p&gt;In test environment, after the zookeeper server start, disk is made read-only using an internal tool which executes commands similar to &lt;tt&gt;mount -o ro,remount /dev/sda3&lt;/tt&gt;. yes, it is not a disk full scenario &lt;/p&gt;</comment>
                            <comment id="14703191" author="arshad.mohammad" created="Wed, 19 Aug 2015 15:29:27 +0000"  >&lt;p&gt;Test case are added as part of the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;-01.patch&lt;/p&gt;</comment>
                            <comment id="14703548" author="hadoopqa" created="Wed, 19 Aug 2015 18:44:51 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12751287/ZOOKEEPER-2247-01.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12751287/ZOOKEEPER-2247-01.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1694317.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2830//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2830//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2830//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2830//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2830//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2830//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14708487" author="arshad.mohammad" created="Sun, 23 Aug 2015 19:13:46 +0000"  >&lt;p&gt;Fixed findbug issue which was reported in pre-commit check.&lt;/p&gt;</comment>
                            <comment id="14708503" author="rgs" created="Sun, 23 Aug 2015 19:47:30 +0000"  >&lt;p&gt;Generally, lgtm.&lt;/p&gt;

&lt;p&gt;A few nits:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In src/java/systest/org/apache/zookeeper/test/system/NonRecoverableErrorTests.java, testZookeeperSericeShouldBeAvailableEvenAfterNonRecoverableErrorOnLeader could probably just be named testZooKeeperServiceAvailableOnLeader (or something along that length...)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In TestUtils, there&apos;s a typo in deleteFileRecusively&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;also about TestUtils.deleteFileRecursively - if you grep for recursiveDelete you&apos;ll see that a few tests have their own (repeated) definition as well:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;src/java/systest/org/apache/zookeeper/test/system/QuorumPeerInstance.java
src/java/test/org/apache/zookeeper/test/ClientBase.java
src/java/test/org/apache/zookeeper/server/quorum/LearnerTest.java
src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;and that these are used across multiple test files... Can we have everyone using TestUtils.deleteFileRecursively while we are at it? It would be easier to clean it now than to do it in another patch...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;given that QuorumPeer.setConfigFileName is protected, maybe it&apos;s easier/cleaner to extend QuorumPeer and add a public setter for configFileName. The problem with using reflection if it breaks, we&apos;d only know after running CI.. whereas otherwise compilation would fail and we&apos;d know sooner.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="14708578" author="arshad.mohammad" created="Sun, 23 Aug 2015 22:44:18 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; for your review comments. Submitted new patch &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;-03.patch with all your comments fixed except bellow&lt;/p&gt;

&lt;p&gt;The recursiveDelete  method in src/java/test/org/apache/zookeeper/test/ClientBase.java has slightly different functionality from TestUtils.deleteFileRecursively method functionality.&lt;br/&gt;
So can not replaced ClientBase.recursiveDelete with TestUtils.deleteFileRecursively&lt;/p&gt;</comment>
                            <comment id="14709563" author="arshad.mohammad" created="Mon, 24 Aug 2015 16:26:33 +0000"  >&lt;p&gt;any idea why build is not triggered?&lt;/p&gt;</comment>
                            <comment id="14709689" author="hadoopqa" created="Mon, 24 Aug 2015 17:37:21 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12752017/ZOOKEEPER-2247-04.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12752017/ZOOKEEPER-2247-04.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1697227.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 18 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2838//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2838//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2838//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2838//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2838//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2838//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14709791" author="arshad.mohammad" created="Mon, 24 Aug 2015 18:22:44 +0000"  >&lt;p&gt;This patch is not reason for &lt;tt&gt;org.apache.zookeeper.server.quorum.ReconfigRecoveryTest.testCurrentServersAreObserversInNextConfig&lt;/tt&gt; test case failure. Verified the test case is passing locally&lt;/p&gt;</comment>
                            <comment id="14710609" author="rgs" created="Tue, 25 Aug 2015 05:27:20 +0000"  >&lt;p&gt;Yeah, that one is flaky from time to time. &lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; (in case you have some cycles to look at that failure case)&lt;/p&gt;</comment>
                            <comment id="14710617" author="rgs" created="Tue, 25 Aug 2015 05:37:27 +0000"  >&lt;p&gt;lgtm, +1 with a caveat: I am a bit worried about the getPrivateField/setPrivateField methods. I can&apos;t think of a cleaner approach now, but I suspect that doing it this is way isn&apos;t sustainable and might create issues in the future...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;: any ideas on a cleaner approach to get access to those private fields?&lt;/p&gt;</comment>
                            <comment id="14710722" author="rakeshr" created="Tue, 25 Aug 2015 06:56:30 +0000"  >&lt;p&gt;I&apos;ve few comments, please take a look at this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Please add log for the &lt;tt&gt;default:&lt;/tt&gt; case. That would be helpful for debugging.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;QuorumPeer.java
+        &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;:
+            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Please add time out parameter to the tests. &lt;tt&gt;@Test=600000&lt;/tt&gt; or something bigger calue depends on your case.&lt;/li&gt;
	&lt;li&gt;Do we really need to create a new &lt;tt&gt;ConfigBaseSystemTest&lt;/tt&gt; test class?  Instead can we try reusing &lt;tt&gt;QuorumPeerTestBase&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Few format issues, please correct these also.&lt;br/&gt;
a) 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFakeMachines()
+    {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It should be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFakeMachines() {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;b) Add one newline in between these two &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    }
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ZooKeeperServerListener getZooKeeperServerListener() {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14710730" author="rakeshr" created="Tue, 25 Aug 2015 06:58:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Rakesh R: any ideas on a cleaner approach to get access to those private fields?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; Thats really good point. I also feel this can be avoided. There is one possible way - Mock the ZKDatabase with your &lt;tt&gt;fileTxnSnapLogWithError&lt;/tt&gt; and set this MockZKDatabase back to the ZooKeeperServer#setZKDatabase(mockDB). Please find the below sequence for simulating the case:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;step-1) 
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockZKDatabase &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ZKDatabase {
        MockZKDatabase(FileTxnSnapLog fileTxnSnapLogWithError) {
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(snapLog);
        }
}

step-2)
MockZKDatabase mockDB = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MockZKDatabase(fileTxnSnapLogWithError);
QuorumPeer leader = getLeaderQuorumPeer();
leader.getActiveServer().setZKDatabase(mockDB);

step-3)
Execute your test scenario and see the execution is flowing through fileTxnSnapLogWithError and failing:)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14711463" author="arshad.mohammad" created="Tue, 25 Aug 2015 15:40:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; for your suggestion. I was using private accessors to get &lt;tt&gt;FileTxnSnapLog&lt;/tt&gt; but this I can get even from &lt;tt&gt;ZooKeeperServer&lt;/tt&gt;. So actually neither private accessor nor mock is required. Please find the fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;-05.patch&lt;/p&gt;</comment>
                            <comment id="14711483" author="arshad.mohammad" created="Tue, 25 Aug 2015 15:47:39 +0000"  >&lt;ol&gt;
	&lt;li&gt;fixed&lt;/li&gt;
	&lt;li&gt;fixed&lt;/li&gt;
	&lt;li&gt;fixed, &lt;tt&gt;ConfigBaseSystemTest&lt;/tt&gt; not necessary for this patch. Since this patch is not testing any configuration related issue, I used &lt;tt&gt;BaseSysTest)) instead of {{QuorumPeerTestBase&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;fixed&lt;/li&gt;
	&lt;li&gt;fixed&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14711495" author="hadoopqa" created="Tue, 25 Aug 2015 15:52:42 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12752256/ZOOKEEPER-2247-05.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12752256/ZOOKEEPER-2247-05.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1697551.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 20 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2841//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2841//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2841//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2841//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2841//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2841//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14712438" author="beeflyme" created="Wed, 26 Aug 2015 03:38:09 +0000"  >&lt;p&gt;mark&lt;/p&gt;</comment>
                            <comment id="14976429" author="rakeshr" created="Tue, 27 Oct 2015 13:59:04 +0000"  >&lt;p&gt;Good work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, thanks for taking care this. Overall patch looks nice, just few more comments, please take a look at it.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Could you please try to use existing CountdownWatcher#waitForConnected() function rather than SimpleSysTest#waitForConnect. Reference &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/test/org/apache/zookeeper/RemoveWatchesTest.java#L770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RemoveWatchesTest.java#L770&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;I could see there are few improvements &lt;tt&gt;TestUtils.deleteFileRecursively&lt;/tt&gt; done along with this jira, its really great work and I appreciate your initiatives. But I think this is not related to this jira. I&apos;d suggest to push these changes through separate jira. IMHO, that would help the reviewers focusing only on the changes(minimal code changes) needed to handle the defect scenario and resolve the defect as early as possible.&lt;/li&gt;
	&lt;li&gt;Generally constant sleeping in test case is problematic. One alternative approach I can quickly suggest is to use sliced sleeping in a while loop and check for new LE occurred. Each slice could be 500 milliseconds window and while loop can iterate/counter 20times or 30times before failing, probably would give overall bigger timeout.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        
+        &lt;span class=&quot;code-comment&quot;&gt;// give enough time, so that &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; leader election takes place
&lt;/span&gt;+        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;I hope the below exception is expected. In that case, it would be good to add Assert.fail(&quot;Must throw exception as____&quot;) statement before catching the exception. That would make the test more better.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; create operation, so that injected IOException is thrown
&lt;/span&gt;+            zk.create(uniqueNode(), data.getBytes(), Ids.OPEN_ACL_UNSAFE,
+                    CreateMode.PERSISTENT);
&lt;span class=&quot;code-comment&quot;&gt;//////////Include Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Must &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; exception as____&quot;&lt;/span&gt;) statement 
&lt;/span&gt;+        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
+            /**
+             * intended IOException might have already thrown. so at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point
+             * of time connection may not be available
+             */
+            e.printStackTrace();
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;minor suggestion: I&apos;d prefer to add assert message in the unit test for better readability/debugging. Please add assertion messages.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;assertNotNull(leader);
assertNotNull(currentleader);
assertEquals(uniqueNode, createNode);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14977917" author="arshad.mohammad" created="Wed, 28 Oct 2015 07:49:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; for your review comments. &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Changed test case base class to &lt;tt&gt;QuorumPeerTestBase&lt;/tt&gt; which makes it easier to handle above comments. handled all comments.&lt;/li&gt;
	&lt;li&gt;Created jira &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2306&quot; title=&quot;Remove file delete duplicate  code from test code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2306&quot;&gt;&lt;del&gt;ZOOKEEPER-2306&lt;/del&gt;&lt;/a&gt; for cleaning the test classes.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14978262" author="hadoopqa" created="Wed, 28 Oct 2015 11:21:39 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12769223/ZOOKEEPER-2247-06.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12769223/ZOOKEEPER-2247-06.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1709293.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2932//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2932//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2932//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2932//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2932//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2932//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14978304" author="rakeshr" created="Wed, 28 Oct 2015 12:06:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the updates. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; do you also want to take another look at the latest patch since you had reviewed this earlier. Thanks!&lt;/p&gt;</comment>
                            <comment id="15065114" author="fpj" created="Sat, 19 Dec 2015 01:20:37 +0000"  >&lt;p&gt;Can we have the patch here somewhere for review, the review board or even github as a pull request? There are a few small things I want to point and it is easier with a review tool. &lt;/p&gt;

&lt;p&gt;One high-level point I wanted to raise is that I don&apos;t really like the separation between standalone and quorum member for the listener implementation. If the way we are shutting down servers and request processors needs adjustment, then lest&apos;s do it, but creating workarounds just makes it messier. For the standalone case, we are shutting down it in ZooKeeperServerMain, and I think the latest patch here is just trying to replicate how we shut down the server in ZooKeeperServerMain, which isn&apos;t good because it is duplicating code. We need to make this better before checking in and ideally not have two listener implementations. &lt;/p&gt;</comment>
                            <comment id="15097649" author="rakeshr" created="Thu, 14 Jan 2016 05:50:51 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15097726" author="hadoopqa" created="Thu, 14 Jan 2016 06:58:49 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12769223/ZOOKEEPER-2247-06.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12769223/ZOOKEEPER-2247-06.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1720227.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 5 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3007//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3007//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3007//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3007//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3007//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3007//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15104106" author="githubbot" created="Mon, 18 Jan 2016 03:26:52 +0000"  >&lt;p&gt;GitHub user arshadmohammad opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/52&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt; Zookeeper service becomes unavailable when leader fail&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;s to write transaction log&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/arshadmohammad/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/arshadmohammad/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/52.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/52.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #52&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d0e8f91080a11a0be8031aaca2d6f2b631b0be17&lt;br/&gt;
Author: Arshad Mohammad &amp;lt;arshad.mohammad.k@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-01-18T03:20:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt; Zookeeper service becomes unavailable when leader fails to write transaction log&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15108024" author="rgs" created="Wed, 20 Jan 2016 05:11:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;: thanks for the pull request! Patch lgtm, +1. I did leave some nits on GH... Other than that, I&apos;d like to have this for 3.4.8 if others agree. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;: mind taking another look?&lt;/p&gt;</comment>
                            <comment id="15110541" author="arshad.mohammad" created="Thu, 21 Jan 2016 12:55:04 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; for your comments, I handled it at GH&lt;/p&gt;</comment>
                            <comment id="15113849" author="fpj" created="Sat, 23 Jan 2016 17:07:58 +0000"  >&lt;p&gt;I can&apos;t convince myself that this is the right way to fix this issue. In fact, the critical thread addition might not have been done in the way I&apos;d expect. If you check the run method in QuorumPeer, around line 1093, I&apos;d expect that we deal with the problem reported here by simply returning from &lt;tt&gt;observeLeader()&lt;/tt&gt;, &lt;tt&gt;followLeader()&lt;/tt&gt;, and &lt;tt&gt;lead()&lt;/tt&gt;. Instead, it sounds like the &lt;tt&gt;handleException()&lt;/tt&gt; call is taking a different call path and the finally blocks for &lt;tt&gt;observeLeader()&lt;/tt&gt;, &lt;tt&gt;followLeader()&lt;/tt&gt;, and &lt;tt&gt;lead()&lt;/tt&gt; aren&apos;t being executed, which would have avoided this present issue in the first place. Could anyone explain to me why we aren&apos;t simply relying on the finally blocks? If we can do it, I&apos;d much rather have this option implemented rather than multiple code paths that change the state of the server.&lt;/p&gt;</comment>
                            <comment id="15114748" author="rakeshr" created="Mon, 25 Jan 2016 04:48:25 +0000"  >&lt;p&gt;Thanks Flavio for pointing out the multiple execution paths.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Could anyone explain to me why we aren&apos;t simply relying on the finally blocks?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;When there is an uncaught exception thrown by any of the internal critical threads, QuourmPeer doesn&apos;t have any mechanism to know that internal error state. He still continue with the #readPacket(). For example,  &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Follower.java#L88&lt;/a&gt; will continue reading without knowing that error. To execute the finally blocks there should be a way to stop this reading logic. So as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1907&quot; title=&quot;Improve Thread handling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1907&quot;&gt;&lt;del&gt;ZOOKEEPER-1907&lt;/del&gt;&lt;/a&gt; design discussions, the point has come up to introduce a listening mechanism which will take action and gracefully bring down the QuourmPeer. This made another execution path that change the state of the server.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If we can do it, I&apos;d much rather have this option implemented rather than multiple code paths that change the state of the server.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I understand your point. How about introducing a polling mechanism at QuorumPeer. Presently ZooKeeperServerListener is taking the decision to shutdown the server, instead of this ZooKeeperServerListener will just mark the internal error state only. Later while polling QuorumPeer will see this error and exits the loop gracefully.&lt;/p&gt;

&lt;p&gt;The idea is something like, ZooKeeper server will maintain an &lt;tt&gt;internalErrorState&lt;/tt&gt;, which will be then used by the QuorumPeer while reading the packet. If QuorumPeer sees an error then will break and executes the finally block. On the other side, all the threads will use ZooKeeperServerListener. He will listen the unexpected errors and notify the QuourmPeer about that error by setting &lt;tt&gt;zk.setInternalErrorState(true)&lt;/tt&gt; to true.&lt;/p&gt;

&lt;p&gt;QuourmPeer should have a logic like,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (self.isRunning() &amp;amp;&amp;amp; !zk.hasInternalError()) {
        readPacket(qp);
        processPacket(qp);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Similar polling mechanism has to be introduced at the standalone server &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java#L149&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperServerMain.java#L149&lt;/a&gt; as well.&lt;/p&gt;

&lt;p&gt;I don&apos;t think we need to worry about the other internal exceptions which can occur before the ZK server enters into the #readPacket() state &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Follower.java#L88&lt;/a&gt;. I hope all these errors will come out and stops the server gracefully. Please correct me if I&apos;m missing any other cases.&lt;/p&gt;</comment>
                            <comment id="15115230" author="fpj" created="Mon, 25 Jan 2016 14:05:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; It sounds ok to add to the predicate a call to &lt;tt&gt;!zk.hasInternalError()&lt;/tt&gt; as you propose, but why can&apos;t we simply make &lt;tt&gt;self.isRunning()&lt;/tt&gt; return false in the case of an error by setting running to false? That&apos;s what we want, that the server stops running in the case of an error, right? &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;QuorumPeer.isRunning()&lt;/tt&gt; returns the value of &lt;tt&gt;QuorumPeer.running&lt;/tt&gt;, which is the condition to keep running the main loop, so we don&apos;t want to set it to false. It sounds like using &lt;tt&gt;QuorumPeer.isRunning()&lt;/tt&gt; as is with follower, observer, learner, and leader isn&apos;t great because there are scenarios (like the one discussed here) in which we want to shutdown a participant/observer, but not the quorum peer. We may want to have a &lt;tt&gt;isRunning()&lt;/tt&gt; for the follower, observer, learner, and leader classes that returns something like &lt;tt&gt;running &amp;amp;&amp;amp; !zk.hasInternalError()&lt;/tt&gt;. We may need to implement a &lt;tt&gt;isRunning()&lt;/tt&gt; method for each one of those classes because they might eventually have different predicates to determine whether they are running or not. &lt;/p&gt;

&lt;p&gt;Does it make sense? &lt;/p&gt;</comment>
                            <comment id="15116827" author="rakeshr" created="Tue, 26 Jan 2016 07:01:13 +0000"  >&lt;p&gt;The idea looks good. Agreed.&lt;/p&gt;

&lt;p&gt;I&apos;m thinking about standalone/embedded server to implement &lt;tt&gt;zks.hasInternalError()&lt;/tt&gt; logic. Here server waiting for &lt;tt&gt;thread.join()&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java#L149&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperServerMain.java#L149&lt;/a&gt;. Probably we may need to introduce another monitor thread to watch zkserver errors and interrupt the waiting threads. Whats your opinion?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; Would you mind preparing a patch based on the above discussions.&lt;/p&gt;</comment>
                            <comment id="15122420" author="fpj" created="Thu, 28 Jan 2016 22:17:51 +0000"  >&lt;p&gt;Guys, we need to wrap up 3.4.8, if we can&apos;t get a patch ready by the end of this week, I&apos;d suggest we leave for the next release.&lt;/p&gt;</comment>
                            <comment id="15122931" author="rakeshr" created="Fri, 29 Jan 2016 04:35:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; Agreed. I&apos;ve tried an attempt based on the above discussions. Please take a look at the latest patch. Thanks!&lt;/p&gt;

&lt;p&gt;Following are the changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added #isRunning() at Learner &amp;amp; Leader&lt;/li&gt;
	&lt;li&gt;Added &lt;tt&gt;internalError&lt;/tt&gt; flag at ZooKeeperServer&lt;/li&gt;
	&lt;li&gt;Added &lt;tt&gt;HealthMonitorThread&lt;/tt&gt; in ZooKeeperServerMain. I think, for supporting embedded deployment, we may need to move this to ZooKeeperServer, right?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15122972" author="hadoopqa" created="Fri, 29 Jan 2016 05:08:08 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785089/ZOOKEEPER-2247-07.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785089/ZOOKEEPER-2247-07.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3018//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3018//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3018//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3018//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3018//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3018//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15123244" author="hadoopqa" created="Fri, 29 Jan 2016 09:28:46 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785133/ZOOKEEPER-2247-09.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785133/ZOOKEEPER-2247-09.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3019//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3019//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3019//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3019//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3019//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3019//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15123914" author="rgs" created="Fri, 29 Jan 2016 18:21:39 +0000"  >&lt;p&gt;Per discussion in the mailing list, lets punt this to 3.4.9.&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15124549" author="cnauroth" created="Sat, 30 Jan 2016 01:00:19 +0000"  >&lt;p&gt;In the latest patch, I only see the new &lt;tt&gt;HeartbeatMonitor&lt;/tt&gt; thread started in standalone mode, because it&apos;s coupled with &lt;tt&gt;ZooKeeperServerMain&lt;/tt&gt;.  In the case of a full ensemble, &lt;tt&gt;QuorumPeerMain&lt;/tt&gt; won&apos;t start the thread, because it won&apos;t call &lt;tt&gt;ZooKeeperServerMain&lt;/tt&gt; (unless it&apos;s the degenerate case of a single-node ensemble).&lt;/p&gt;

&lt;p&gt;I&apos;ve been trying to look for a way to solve this without adding another watchdog thread, but unfortunately I don&apos;t have another proposal to offer right now.&lt;/p&gt;</comment>
                            <comment id="15124723" author="fpj" created="Sat, 30 Jan 2016 04:28:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; Thanks for updating the patch. There are two things I believe we can improve here:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Instead of doing this &lt;tt&gt;while (self.isRunning() &amp;amp;&amp;amp; this.isRunning())&lt;/tt&gt;, why don&apos;t you do this &lt;tt&gt;while (this.isRunning())&lt;/tt&gt; and check &lt;tt&gt;self.running()&lt;/tt&gt; in &lt;tt&gt;this.isRunning()&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;I don&apos;t think we need the health monitor thread. It is just shutting down the cnxn factories and you could do it immediately after the server loops. For example, in Follower.java, add the cnxn factory shutdown calls after the {{while (this.isRunning()) 
{...}
&lt;p&gt; }}. Does it work?&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15124729" author="rakeshr" created="Sat, 30 Jan 2016 04:47:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the interest.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In the latest patch, I only see the new HeartbeatMonitor thread started in standalone mode, because it&apos;s coupled with ZooKeeperServerMain. In the case of a full ensemble, QuorumPeerMain won&apos;t start the thread, because it won&apos;t call ZooKeeperServerMain (unless it&apos;s the degenerate case of a single-node ensemble).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Monitor thread is not required for the quorum as they already have a server loop where the &lt;tt&gt;internalError&lt;/tt&gt; checks has been integrated. But in case of standalone there is no loops instead it has &lt;tt&gt;#join()&lt;/tt&gt; like I mentioned earlier &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java#L149&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperServerMain.java#L149&lt;/a&gt;. Thats the reason I&apos;ve added a watch dog there.&lt;/p&gt;</comment>
                            <comment id="15124733" author="rakeshr" created="Sat, 30 Jan 2016 05:00:38 +0000"  >
&lt;blockquote&gt;&lt;p&gt;Per discussion in the mailing list, lets punt this to 3.4.9.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for the patience &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; . If we get a good solution will include this, otw agreed to postpone.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the review comments.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Instead of doing this while (self.isRunning() &amp;amp;&amp;amp; this.isRunning()), why don&apos;t you do this while (this.isRunning()) and check self.running() in this.isRunning()?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, will change it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt; I don&apos;t think we need the health monitor thread. It is just shutting down the cnxn factories and you could do it immediately after the server loops. For example, in Follower.java, add the cnxn factory shutdown calls after the &apos;while (this.isRunning())&apos;. Does it work?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The solution works well with ensemble. IIUC, there is no server loop in the standalone server. He just waits on &lt;tt&gt;#join&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java#L149&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperServerMain.java#L149&lt;/a&gt;. I&apos;m not finding a way to interrupt this without a watchdog in standalone mode. Could you please correct me if I&apos;m missing anything. Thanks!&lt;/p&gt;</comment>
                            <comment id="15124741" author="rakeshr" created="Sat, 30 Jan 2016 05:29:24 +0000"  >&lt;p&gt;Attached another patch addressing &lt;tt&gt;while (self.isRunning() &amp;amp;&amp;amp; this.isRunning())&lt;/tt&gt; comment. Also, added checks in the &lt;tt&gt;Leader&lt;/tt&gt;, that was missed previously.&lt;/p&gt;</comment>
                            <comment id="15124766" author="hadoopqa" created="Sat, 30 Jan 2016 06:17:50 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785335/ZOOKEEPER-2247-10.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785335/ZOOKEEPER-2247-10.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3024//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3024//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3024//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3024//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3024//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3024//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15126714" author="rgs" created="Mon, 1 Feb 2016 18:23:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Mind taking one more look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15126934" author="cnauroth" created="Mon, 1 Feb 2016 20:09:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, thank you for your patient explanations while I play catch-up understanding the problem and the patch.  I think I see it now.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The solution works well with ensemble. IIUC, there is no server loop in the standalone server.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I see the key difference now.  Standalone mode puts the main thread straight into &lt;tt&gt;ServerCnxnFactory#join&lt;/tt&gt;, which does not react to these internal errors and therefore does not shut down.  Ensemble mode puts the main thread into &lt;tt&gt;QuorumPeer#join&lt;/tt&gt;, and &lt;tt&gt;QuorumPeer#run&lt;/tt&gt; has a polling loop that is equipped to react to these internal errors.&lt;/p&gt;

&lt;p&gt;What if &lt;tt&gt;ZooKeeperServerMain&lt;/tt&gt; was changed so that the main thread was put into a polling loop, similar to &lt;tt&gt;QuorumPeer&lt;/tt&gt;?  Essentially, I think this means taking the current patch&apos;s &lt;tt&gt;HealthMonitor&lt;/tt&gt; code and putting it inline with the main thread&apos;s execution of &lt;tt&gt;ZooKeeperServerMain#runFromConfig&lt;/tt&gt; before it tries to join.  Would that achieve the same effect without needing the extra watchdog thread?&lt;/p&gt;</comment>
                            <comment id="15127034" author="fpj" created="Mon, 1 Feb 2016 21:09:24 +0000"  >&lt;p&gt;I was thinking the same thing, +1 to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; suggestion.&lt;/p&gt;</comment>
                            <comment id="15127499" author="rakeshr" created="Tue, 2 Feb 2016 02:45:02 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the good suggestion. Uploaded another patch with this change.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;. I&apos;m just adding a thought to know any integration issues. Now, with the new proposed solution, it will wait in &lt;tt&gt;while loop&lt;/tt&gt; by periodically checking the status of the ZooKeeper server and will not execute the &lt;tt&gt;ServerCnxnFactory#join()&lt;/tt&gt; function. I hope any of the ZooKeeper customers haven&apos;t overridden the &lt;tt&gt;ServerCnxnFactory#join()&lt;/tt&gt; method and added extra functionality there.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ServerCnxnFactory {

          &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; void join() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15127523" author="hadoopqa" created="Tue, 2 Feb 2016 02:54:43 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785683/ZOOKEEPER-2247-11.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785683/ZOOKEEPER-2247-11.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3025//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3025//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3025//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3025//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3025//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3025//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15127678" author="fpj" created="Tue, 2 Feb 2016 05:11:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; what about the changes in the patch I&apos;m uploading? Please keep in mind that we&apos;ll need a patch for 3.4, I&apos;m assuming the patch for 3.5 will also apply to trunk and if not we&apos;ll need a third patch.&lt;/p&gt;</comment>
                            <comment id="15127699" author="rakeshr" created="Tue, 2 Feb 2016 05:41:08 +0000"  >&lt;p&gt;OK, looks good. &lt;tt&gt;NonRecoverableErrorTest.java&lt;/tt&gt; is missing, can we include this unit test to verify the internal error behavior of quorum?&lt;/p&gt;</comment>
                            <comment id="15127719" author="rakeshr" created="Tue, 2 Feb 2016 05:58:40 +0000"  >&lt;p&gt;Adding one more observation:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ZooKeeperServer.java
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isRunning() {
-        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.RUNNING;
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (state == State.RUNNING) &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.hasInternalError();
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m thinking the above changes will affect the &lt;tt&gt;zks#shutdown()&lt;/tt&gt; logic. Many places I could see it is skipping the shutdown logic by doing &lt;tt&gt;!isRunning()&lt;/tt&gt; checks. Now, once the server hits an internal error, it will set the &lt;tt&gt;internalError=true&lt;/tt&gt; flag. After this when shutting down it will skip the shutdown thinking server is already down, right?&lt;/p&gt;

&lt;p&gt;Existing shutdown logic like,&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerZooKeeperServer.java#L161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;LearnerZooKeeperServer.java#L161&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/ObserverZooKeeperServer.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ObserverZooKeeperServer.java#L135&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/ReadOnlyZooKeeperServer.java#L140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ReadOnlyZooKeeperServer.java#L140&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ZooKeeperServer.java

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void shutdown() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isRunning()) {
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;ZooKeeper server is not running, so not proceeding to shutdown!&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;shutting down&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15128663" author="fpj" created="Tue, 2 Feb 2016 17:54:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; I wasn&apos;t proposing a final patch, just a change to your patch. I might have missed a file, so feel free to incorporate the changes to your patch. I&apos;d rather have you proposing it so that I can review it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15128705" author="rgs" created="Tue, 2 Feb 2016 18:14:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;: could we wrap this today please? Thanks!&lt;/p&gt;</comment>
                            <comment id="15128821" author="fpj" created="Tue, 2 Feb 2016 19:12:05 +0000"  >&lt;p&gt;You&apos;re absolutely right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt;, it changes the behavior so we need to fix it. &lt;/p&gt;

&lt;p&gt;Here is my rationale. &lt;tt&gt;ZooKeeperServer.isRunning()&lt;/tt&gt; should return true if the server is running. If there has been an error that made the server stop, then it isn&apos;t running, even if the state is &lt;tt&gt;RUNNING&lt;/tt&gt;. There are a couple of options I see to fix this:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;We add a new state &lt;tt&gt;ERROR&lt;/tt&gt;, which means that the server is in this limbo state, it isn&apos;t shut down but came across an internal error that made it stop. If the server is in this state, then we proceed with the shutdown logic you mention above. We would make the server transition to this state when we hit an error, and if we do it, then I think we don&apos;t need the &lt;tt&gt;hasInternalError()&lt;/tt&gt; call any longer.&lt;/li&gt;
	&lt;li&gt;We add a call like &lt;tt&gt;isStateRunning()&lt;/tt&gt;, which is basically &lt;tt&gt;return state == State.RUNNING&lt;/tt&gt;. If we do this, then we are essentially saying that &lt;tt&gt;isRunning()&lt;/tt&gt; determines whether the server is running or not by checking the state and the internal error flag, while &lt;tt&gt;isStateRunning()&lt;/tt&gt; simply determines whether the state of the server is &lt;tt&gt;State.RUNNING&lt;/tt&gt;. We replace the &lt;tt&gt;if(!isRunning()&lt;/tt&gt; in the code you mentioned above with &lt;tt&gt;if(!isStateRunning())&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Option 1 sounds cleaner to me, but happy to hear opinions.&lt;/p&gt;</comment>
                            <comment id="15129196" author="cnauroth" created="Tue, 2 Feb 2016 22:28:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;I hope any of the ZooKeeper customers haven&apos;t overridden the &lt;tt&gt;ServerCnxnFactory#join()&lt;/tt&gt; method and added extra functionality there.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would find it very surprising if anyone was doing this.  I don&apos;t believe this can be considered part of a public stable API.  We don&apos;t publish the JavaDocs for it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Option 1 sounds cleaner to me, but happy to hear opinions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree.  I think adding an &lt;tt&gt;ERROR&lt;/tt&gt; state would model the problem more clearly.&lt;/p&gt;</comment>
                            <comment id="15129634" author="rakeshr" created="Wed, 3 Feb 2016 02:21:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would find it very surprising if anyone was doing this. I don&apos;t believe this can be considered part of a public stable API. We don&apos;t publish the JavaDocs for it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, you are correct. This is not published in the javadocs.&lt;/p&gt;</comment>
                            <comment id="15129704" author="rakeshr" created="Wed, 3 Feb 2016 03:16:25 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the idea. Attached another patch with the new server state &lt;tt&gt;ERROR&lt;/tt&gt;. Please take another look at the patch.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isRunning() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.RUNNING || state == State.ERROR;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isStateRunning() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.RUNNING;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15129705" author="rakeshr" created="Wed, 3 Feb 2016 03:17:52 +0000"  >&lt;p&gt;OK&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15129764" author="hadoopqa" created="Wed, 3 Feb 2016 04:24:32 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12785927/ZOOKEEPER-2247-12.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12785927/ZOOKEEPER-2247-12.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3026//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3026//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3026//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3026//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3026//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3026//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15131246" author="cnauroth" created="Wed, 3 Feb 2016 22:15:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, patch v12 looks good to me.  I just have one comment.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-comment&quot;&gt;// Watch status of ZooKeeper server. If there is an internal error
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// then will &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; a graceful shutdown.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (zkServer.isStateRunning()) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000); &lt;span class=&quot;code-comment&quot;&gt;// watch interval
&lt;/span&gt;                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
                    LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; interrupted&quot;&lt;/span&gt;);
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s generally an anti-pattern to swallow &lt;tt&gt;InterruptedException&lt;/tt&gt;, even though there is a lot of existing code in ZooKeeper and other codebases that does it.  In this specific case, it would clear the interrupted status, and then that could potentially impact later code like &lt;tt&gt;ServerCnxnFactory#join&lt;/tt&gt; that calls interruptable methods.  Let&apos;s restore interrupted status in the catch block by calling &lt;tt&gt;Thread.currentThread().interrupt()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll be +1 after that change.  Thanks again for your diligence on this one!&lt;/p&gt;</comment>
                            <comment id="15131328" author="fpj" created="Wed, 3 Feb 2016 23:01:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; One simple thing I&apos;d like to have changed is the timeout of the test cases. Can we please use 30s by default?&lt;/p&gt;

&lt;p&gt;I also had the same observation about the exception that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; made, and there are a couple of other things I don&apos;t understand. In this loop:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+            while (zkServer.isStateRunning()) {
+                try {
+                    Thread.sleep(1000); // watch interval
+                } catch (InterruptedException ie) {
+                    LOG.info(&quot;Thread interrupted&quot;);
+                }
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Shouldn&apos;t it be &lt;tt&gt;while (zk.isRunning()) {&lt;/tt&gt; instead?&lt;/p&gt;

&lt;p&gt;For the leader and learner, why is it &lt;tt&gt;isStateRunning&lt;/tt&gt; here:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+    public boolean isRunning() {
+        return self.isRunning() &amp;amp;&amp;amp; zk.isStateRunning();
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and not this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+    public boolean isRunning() {
+        return self.isRunning() &amp;amp;&amp;amp; zk.isRunning();
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The rationale is that we are running if both the peer is running and the server is running, so just checking if the state is running isn&apos;t sufficient.&lt;/p&gt;</comment>
                            <comment id="15131644" author="rakeshr" created="Thu, 4 Feb 2016 03:12:17 +0000"  >
&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can we please use 30s by default?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t it be while (zk.isRunning()) instead?&lt;/p&gt;&lt;/blockquote&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isRunning() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.RUNNING || state == State.ERROR;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isStateRunning() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.RUNNING;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;State transitions:&lt;br/&gt;
1. At the beginning the state will be &lt;tt&gt;INITIAL&lt;/tt&gt;.&lt;br/&gt;
2. After the successful start, update the server state to &lt;tt&gt;RUNNING&lt;/tt&gt;&lt;br/&gt;
3. When there is an internal error, update the server state to &lt;tt&gt;ERROR&lt;/tt&gt;.&lt;br/&gt;
4. On shutdown, update the server state to &lt;tt&gt;SHUTDOWN&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Standlone server watch logic:&lt;br/&gt;
The newly added watch logic will periodically checks &lt;tt&gt;RUNNING&lt;/tt&gt; state and come out of the loop if it sees a state other than &lt;tt&gt;RUNNING&lt;/tt&gt;. With &lt;tt&gt;zks.isRunning()&lt;/tt&gt; method, it will return true if server is &lt;tt&gt;RUNNING&lt;/tt&gt; or &lt;tt&gt;ERROR&lt;/tt&gt; state. So if I use &lt;tt&gt;isRunning()&lt;/tt&gt;, it will never come out of the loop on error situations, right?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For the leader and learner, why is it isStateRunning here:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Here also the same case. It should come out of the &lt;tt&gt;readPacket&lt;/tt&gt; function if the server is not RUNNING. With &lt;tt&gt;zks.isRunning()&lt;/tt&gt;, it will never identify the &lt;tt&gt;ERROR&lt;/tt&gt; state and continue reading packet, right?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;isRunning&lt;/tt&gt; method is reflecting dual state, &lt;tt&gt;running&lt;/tt&gt; as well as &lt;tt&gt;running with an error&lt;/tt&gt;, I think that causes the confusion. I failed to find a better name for this function.&lt;/p&gt;</comment>
                            <comment id="15131651" author="rakeshr" created="Thu, 4 Feb 2016 03:19:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, good catch. I will include this in my next patch.&lt;/p&gt;</comment>
                            <comment id="15131739" author="fpj" created="Thu, 4 Feb 2016 04:54:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; Thanks for the clarification, but I&apos;m still finding the predicates a bit confusing, please bear with me. &lt;tt&gt;isRunning()&lt;/tt&gt; should return true if the server is running and the main loop should keep going as long as the call to &lt;tt&gt;isRunning()&lt;/tt&gt; returns true. If there is an error in one of the processors, then the server isn&apos;t really running and we want the main loop to exit if the server isn&apos;t running.&lt;/p&gt;

&lt;p&gt;I proposed &lt;tt&gt;isStateRunning&lt;/tt&gt; before because in the shutdown methods you pointed out above for learner, observer, and RO we need to know if the server needs shutdown or not. However, it sounds like it would be better to have a call like &lt;tt&gt;needsShutdown()&lt;/tt&gt; instead of &lt;tt&gt;isStateRunning&lt;/tt&gt;, which looks like &lt;tt&gt;return state == State.RUNNING || state == State.ERROR&lt;/tt&gt;. The method &lt;tt&gt;isRunning()&lt;/tt&gt; should go back to &lt;tt&gt;state == State.RUNNING&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Let me know if this makes sense. &lt;/p&gt;</comment>
                            <comment id="15131747" author="rakeshr" created="Thu, 4 Feb 2016 05:10:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the detailed explanation. This looks good, clear semantics. I&apos;ll soon prepare a patch with this.&lt;/p&gt;</comment>
                            <comment id="15131801" author="hadoopqa" created="Thu, 4 Feb 2016 06:16:24 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12786193/ZOOKEEPER-2247-13.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12786193/ZOOKEEPER-2247-13.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1726354.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3027//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3027//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3027//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3027//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3027//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3027//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15132544" author="fpj" created="Thu, 4 Feb 2016 16:34:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; The patch is looking much better now. There are a couple of small points that I think we can still fix:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Could you review the methods you&apos;re adding and remove the public modifier if it isn&apos;t necessary? For example, a method to set the state shouldn&apos;t really be public, it should be at least package protected if not protected/private. I know we aren&apos;t super consistent about the modifiers in our code base, but we should try to improve it when possible.&lt;/li&gt;
	&lt;li&gt;Did you mean to have an annotation here &lt;tt&gt;// VisibleForTesting&lt;/tt&gt;? Perhaps you should just have a comment that this method exists for testing.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15132596" author="rakeshr" created="Thu, 4 Feb 2016 17:05:27 +0000"  >&lt;p&gt;1 &amp;gt;&amp;gt; Agreed, I&apos;ll revisit the access specifiers and correct it.&lt;br/&gt;
2 &amp;gt;&amp;gt; &lt;tt&gt;// VisibleForTesting&lt;/tt&gt; I could see similar comments exists in our code. I referred these and thought of using similar pattern &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ContainerManager.java#L134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ContainerManager.java#L134&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/PurgeTxnLog.java#L78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PurgeTxnLog.java#L78&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/ZooKeeper.java#L1011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeper.java#L1011&lt;/a&gt;. Can we follow this pattern now and later if requires can replace together ?&lt;/p&gt;</comment>
                            <comment id="15132615" author="fpj" created="Thu, 4 Feb 2016 17:15:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt; Sure, we can revisit it later, perhaps create a jira so that we don&apos;t forget? Keep in mind that we will need patches for all three branches, please.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; are you +1 on this patch? It&apos;d be good to give it a last look before we check this in.&lt;/p&gt;
</comment>
                            <comment id="15132656" author="rakeshr" created="Thu, 4 Feb 2016 17:42:32 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ZooKeeperServerMain.java
+            &lt;span class=&quot;code-comment&quot;&gt;// connection factory will take care of shutting down &lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// of the services
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cnxnFactory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                cnxnFactory.shutdown();
+            }
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (secureCnxnFactory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                secureCnxnFactory.shutdown();
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;ve just noticed one more thing. The above graceful shutdown logic in my patch is leaving &lt;tt&gt;containerManager&lt;/tt&gt; and &lt;tt&gt;adminServer&lt;/tt&gt; references. Instead of shutdown each entity separately, how about just make a &lt;tt&gt;ZooKeeperServerMain#shutdown()&lt;/tt&gt; call like below?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (zkServer.isRunning()) {
+               &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000); &lt;span class=&quot;code-comment&quot;&gt;// watch interval
&lt;/span&gt;+               } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
+                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
+                   LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; interrupted&quot;&lt;/span&gt;);
+               }
+           }
+
+          shutdown();

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cnxnFactory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                cnxnFactory.join();
            }
           &lt;span class=&quot;code-comment&quot;&gt;// ......
&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// .....&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15132685" author="rakeshr" created="Thu, 4 Feb 2016 18:06:03 +0000"  >&lt;p&gt;Thanks for the advice. I just created &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2361&quot; title=&quot;Revisit &amp;#39;VisibleForTesting&amp;#39; phrase used to indicate a member or method visible for testing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2361&quot;&gt;ZOOKEEPER-2361&lt;/a&gt; to track this. Sure, once I get +1s, will upload patch for respective branches.&lt;/p&gt;</comment>
                            <comment id="15132761" author="fpj" created="Thu, 4 Feb 2016 18:44:45 +0000"  >&lt;p&gt;By leaving &lt;tt&gt;containerManager&lt;/tt&gt; and &lt;tt&gt;adminServer&lt;/tt&gt; references, do you mean not stopping and shutting down the respective instances? I think you&apos;re proposing to replace this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ZooKeeperServerMain.java
+            // connection factory will take care of shutting down rest
+            // of the services
+            if (cnxnFactory != null) {
+                cnxnFactory.shutdown();
+            }
+            if (secureCnxnFactory != null) {
+                secureCnxnFactory.shutdown();
+            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with a call to the existing method &lt;tt&gt;ZooKeeperServerMain.shutdown()&lt;/tt&gt;, is that right? I haven&apos;t checked if calling &lt;tt&gt;adminServer.shutdown()&lt;/tt&gt; can produce any issue like an NPE here, but it doesn&apos;t look like.&lt;/p&gt;
</comment>
                            <comment id="15132790" author="rakeshr" created="Thu, 4 Feb 2016 19:00:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;By leaving containerManager and adminServer references, do you mean not stopping and shutting down the respective instances? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;exactly, stopping &lt;tt&gt;containerManager&lt;/tt&gt; and &lt;tt&gt;adminServer&lt;/tt&gt;. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;with a call to the existing method ZooKeeperServerMain.shutdown(), is that right? I haven&apos;t checked if calling adminServer.shutdown() can produce any issue like an NPE here, but it doesn&apos;t look like.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, in addition to the above &lt;tt&gt;ZooKeeperServerMain.shutdown()&lt;/tt&gt; replacement, am thinking to add a new &lt;tt&gt;running&lt;/tt&gt; flag in ZooKeeperServerMain class to avoid multiple shutdown calls. While shutdown, it will first check whether the main#shutdown() is already invoked. Does this makes sense?&lt;/p&gt;

&lt;p&gt;Also, I feel it is safe to add extra null check &lt;tt&gt;adminServer != null&lt;/tt&gt;. I will include this also in my next patch.&lt;/p&gt;
</comment>
                            <comment id="15132987" author="fpj" created="Thu, 4 Feb 2016 20:46:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;am thinking to add a new running flag in ZooKeeperServerMain class to avoid multiple shutdown calls.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Avoiding multiple shutdown calls sounds good, even though I&apos;d expect the shutdown call to be idempotent. I&apos;d rather avoid having yet another flag if possible, though. &lt;/p&gt;</comment>
                            <comment id="15133662" author="rakeshr" created="Fri, 5 Feb 2016 04:58:57 +0000"  >&lt;p&gt;Attached another patch with above mentioned &lt;tt&gt;ZooKeeperServerMain.shutdown()&lt;/tt&gt; changes. Please review it again. Thanks!&lt;/p&gt;</comment>
                            <comment id="15133669" author="hadoopqa" created="Fri, 5 Feb 2016 05:07:04 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12786408/ZOOKEEPER-2247-14.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12786408/ZOOKEEPER-2247-14.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1728577.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3031//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3031//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3031//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3031//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3031//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3031//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15133755" author="hadoopqa" created="Fri, 5 Feb 2016 06:42:47 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12786418/ZOOKEEPER-2247-15.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12786418/ZOOKEEPER-2247-15.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1728577.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3032//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3032//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3032//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3032//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3032//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3032//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15133775" author="hadoopqa" created="Fri, 5 Feb 2016 07:10:33 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12786428/ZOOKEEPER-2247-br-3.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12786428/ZOOKEEPER-2247-br-3.4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1728577.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3033//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3033//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15171735" author="rakeshr" created="Mon, 29 Feb 2016 10:53:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; could you review it again once you get a chance, thanks!&lt;/p&gt;</comment>
                            <comment id="15181381" author="cnauroth" created="Sat, 5 Mar 2016 01:08:36 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;.  This looks good, and I am +1 for v15 of the trunk patch.&lt;/p&gt;

&lt;p&gt;I have one question on the branch-3.4 patch.  I see this is removing the &lt;tt&gt;System#exit&lt;/tt&gt; call from &lt;tt&gt;SyncRequestProcessor&lt;/tt&gt;.  For trunk, that call was already removed as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-602&quot; title=&quot;log all exceptions not caught by ZK threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-602&quot;&gt;&lt;del&gt;ZOOKEEPER-602&lt;/del&gt;&lt;/a&gt;.  Was there some specific reason that this wasn&apos;t removed during the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-602&quot; title=&quot;log all exceptions not caught by ZK threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-602&quot;&gt;&lt;del&gt;ZOOKEEPER-602&lt;/del&gt;&lt;/a&gt; backport to branch-3.4, or do you think it was just an oversight?&lt;/p&gt;</comment>
                            <comment id="15181457" author="rakeshr" created="Sat, 5 Mar 2016 02:23:31 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the reviews. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I have one question on the branch-3.4 patch. I see this is removing the System#exit call from SyncRequestProcessor&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was actually missed during the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-602&quot; title=&quot;log all exceptions not caught by ZK threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-602&quot;&gt;&lt;del&gt;ZOOKEEPER-602&lt;/del&gt;&lt;/a&gt; backport to &lt;tt&gt;branch-3.4&lt;/tt&gt;. Now, I&apos;ve got the chance to cleanup &lt;tt&gt;System#exit&lt;/tt&gt; call. As we know with this patch it is giving another chance to do the re-election after hitting unrecoverable errors. So this call is not required.&lt;/p&gt;</comment>
                            <comment id="15181533" author="cnauroth" created="Sat, 5 Mar 2016 05:25:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;As we know with this patch it is giving another chance to do the re-election after hitting unrecoverable errors. So this call is not required.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great, this all lines up with my understanding.  I just wanted to make sure there wasn&apos;t some edge case related to the &lt;tt&gt;System#exit&lt;/tt&gt; call specific to branch-3.4.&lt;/p&gt;

&lt;p&gt;With that, I am now +1 for both the trunk/branch-3.5 patch and the branch-3.4 patch.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, would you like to take another look?&lt;/p&gt;</comment>
                            <comment id="15187619" author="githubbot" created="Wed, 9 Mar 2016 18:40:25 +0000"  >&lt;p&gt;Github user arshadmohammad closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/52&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15247188" author="rakeshr" created="Tue, 19 Apr 2016 05:06:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, would be great to see your feedback. Please take a look at the patch when you get some time. Thanks!&lt;/p&gt;</comment>
                            <comment id="15247699" author="fpj" created="Tue, 19 Apr 2016 12:59:43 +0000"  >&lt;p&gt;I&apos;ll have a look, but why was the pull request closed? I like reviewing on github and also I had some comments there. Were those comments addressed?&lt;/p&gt;</comment>
                            <comment id="15247854" author="githubbot" created="Tue, 19 Apr 2016 14:36:22 +0000"  >&lt;p&gt;GitHub user rakeshadr opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/65&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Created this PR using proposed &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;-15.patch&quot; in the jira.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rakeshadr/zookeeper-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rakeshadr/zookeeper-1&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/65.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/65.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #65&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 27b66905a69e57cd21f225f998edea4e1812825d&lt;br/&gt;
Author: Rakesh R &amp;lt;rakeshr@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-04-19T14:27:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15247889" author="rakeshr" created="Tue, 19 Apr 2016 14:51:31 +0000"  >&lt;p&gt;PR &lt;tt&gt;zookeeper/pull/52&lt;/tt&gt; was initially created by Arshad. Later the solution is changed and I hope thats the reason he closed the PR. I&apos;ve created another PR with the latest patch &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;-15.patch for reviews. I think I&apos;ve addressed your comments which are applicable to the new solution. Following are the review comments I&apos;ve referred from previous PR &lt;tt&gt;zookeeper/pull/52&lt;/tt&gt;&lt;br/&gt;
1) Can we make this timeout shorter and use the same 30000 we use with others? =&amp;gt; DONE&lt;br/&gt;
2) minor: &quot;... so not proceeding to shutdown!&quot; -&amp;gt; &quot;... not proceeding with shutdown.&quot; =&amp;gt; there is no code changes in new solution.&lt;br/&gt;
3) minor: can we make this uniform and have &quot;x != null&quot;? =&amp;gt; DONE&lt;br/&gt;
4) The parent class also has a private member that is a listener. Do we really need two listeners for a QuorumZooKeeperServer instance? =&amp;gt; DONE&lt;/p&gt;</comment>
                            <comment id="15247932" author="fpj" created="Tue, 19 Apr 2016 15:09:36 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15346334" author="hadoopqa" created="Thu, 23 Jun 2016 12:19:23 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812810/ZOOKEEPER-2247-16.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812810/ZOOKEEPER-2247-16.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 10 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3242//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3242//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15346336" author="rakeshr" created="Thu, 23 Jun 2016 12:25:35 +0000"  >&lt;p&gt;Attached &lt;tt&gt;ZK-16.patch&lt;/tt&gt; new patch addressing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;&apos;s comments given in the &lt;a href=&quot;https://github.com/apache/zookeeper/pull/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR-65&lt;/a&gt;. I will prepare patch for 3.4 branch once I get +1 for the latest patch.&lt;/p&gt;</comment>
                            <comment id="15346372" author="hadoopqa" created="Thu, 23 Jun 2016 12:49:25 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812810/ZOOKEEPER-2247-16.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812810/ZOOKEEPER-2247-16.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 10 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3244//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3244//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15346410" author="hadoopqa" created="Thu, 23 Jun 2016 13:17:12 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812823/ZOOKEEPER-2247-17.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812823/ZOOKEEPER-2247-17.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3245//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3245//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3245//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3245//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3245//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3245//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15346581" author="hadoopqa" created="Thu, 23 Jun 2016 15:11:45 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12812843/ZOOKEEPER-2247-18.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12812843/ZOOKEEPER-2247-18.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1748630.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3247//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3247//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3247//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3247//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3247//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3247//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15346610" author="rakeshr" created="Thu, 23 Jun 2016 15:27:58 +0000"  >&lt;p&gt;Note: It seems the test case failure is not related to my patch, please ignore it.&lt;/p&gt;</comment>
                            <comment id="15347115" author="fpj" created="Thu, 23 Jun 2016 20:28:15 +0000"  >&lt;p&gt;+1, LGTM. Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15347184" author="rgs" created="Thu, 23 Jun 2016 21:05:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;: sorry for the late comments. So, for the test case in ZooKeeperServerMainTest.java:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     /**
+     * Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; https:&lt;span class=&quot;code-comment&quot;&gt;//issues.apache.org/jira/browse/ZOOKEEPER-2247.
&lt;/span&gt;+     * Test to verify that even after non recoverable error (error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;
+     * writing transaction log) on ZooKeeper service will be available
+     */
+    @Test(timeout = 30000)
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNonRecoverableError() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That&apos;s really not what&apos;s happening, given that we don&apos;t wait for the quorum to come back. We only wait for the injected failure to happen. Does this test case actually provide anything new to what we have for in NonRecoverableErrorTest.java? Am I missing some context?&lt;/p&gt;</comment>
                            <comment id="15347195" author="rgs" created="Thu, 23 Jun 2016 21:11:39 +0000"  >&lt;p&gt;Another thing, this feels weird, in ZooKeeperServerStateListener.java:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ZooKeeperServerStateListener {
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CountDownLatch shutdownLatch;
+
+    ZooKeeperServerStateListener(CountDownLatch shutdownLatch) {
+        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.shutdownLatch = shutdownLatch;
+    }
+
+    /**
+     * This will be invoked when the server transition to a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; server state.
+     *
+     * @param state &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; server state
+     */
+    void stateChanged(State state) {
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state != State.RUNNING) {
+            shutdownLatch.countDown();
+        }
+    }
+}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the name is misleading, since it&apos;s only used to watch/count shutdown events. Should we name it appropriately then?&lt;/p&gt;

&lt;p&gt;Also, what happens if someone calls stateChanged(State.INITIAL), we&apos;d still call shutdownLatch.countDown(). Should we not assert that doesn&apos;t happen?&lt;/p&gt;</comment>
                            <comment id="15347203" author="rgs" created="Thu, 23 Jun 2016 21:14:01 +0000"  >&lt;p&gt;Minor nit:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    /**
+     * This can be used &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; shutting down the server to see whether the server
+     * is already shutdown or not.
+     *
+     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the server is running or server hits an error, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
+     *         otherwise.
+     */
+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; needsShutdown() {
+        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.RUNNING || state == State.ERROR;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;should probably be canShutdown(), given that if you are in State.RUNNING it&apos;s not like you need a shutdown. &lt;/p&gt;</comment>
                            <comment id="15347235" author="fpj" created="Thu, 23 Jun 2016 21:30:11 +0000"  >&lt;p&gt;Let&apos;s not rush into getting this one in, it would be good to fix it, but we can leave to 3.5.3.&lt;/p&gt;</comment>
                            <comment id="15347553" author="rakeshr" created="Fri, 24 Jun 2016 02:05:51 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; for taking a look at this.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;NonRecoverableErrorTest extends QuorumPeerTestBase&lt;/tt&gt; =&amp;gt; This is testing the behavior in zookeeper quorum servers.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ZooKeeperServerMainTest#testNonRecoverableError&lt;/tt&gt; =&amp;gt; This test class is for testing behavior in standalone server, thats the reason it is just injecting failure to the single standalone server and continue to next step.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
 * Test stand-alone server.
 *
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ZooKeeperServerMainTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ZKTestCase &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Watcher {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is anything required to be done?&lt;/p&gt;</comment>
                            <comment id="15347571" author="rakeshr" created="Fri, 24 Jun 2016 02:27:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think the name is misleading, since it&apos;s only used to watch/count shutdown events. Should we name it appropriately then?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Since this receives all the state change notifications I named it as &lt;tt&gt;StateListener&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;How about renaming to &lt;tt&gt;ZooKeeperServerShutdownListener&lt;/tt&gt; or &lt;tt&gt;ZooKeeperServerShutdownHandler&lt;/tt&gt; ?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Also, what happens if someone calls stateChanged(State.INITIAL), we&apos;d still call shutdownLatch.countDown(). Should we not assert that doesn&apos;t happen?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. I will change the condition to &lt;tt&gt;if ((state == State.ERROR) || (state == State.SHUTDOWN))&lt;/tt&gt;. OK?&lt;/p&gt;</comment>
                            <comment id="15347574" author="rakeshr" created="Fri, 24 Jun 2016 02:28:47 +0000"  >&lt;p&gt;OK, will use &lt;tt&gt;canShutdown&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15348897" author="arshad.mohammad" created="Fri, 24 Jun 2016 23:43:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, Latest patch does not apply, Can you please rebase it.&lt;/p&gt;</comment>
                            <comment id="15350184" author="rakeshr" created="Sun, 26 Jun 2016 17:10:31 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the interest. I&apos;m planning to prepare new patch once I get a reply/inputs from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; for the above set of review comments. &lt;/p&gt;</comment>
                            <comment id="15362058" author="rakeshr" created="Tue, 5 Jul 2016 05:59:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, Few days back I&apos;ve replied to your comments. It would be great to see your feedback and I will prepare final patch based on that. Thanks!&lt;/p&gt;</comment>
                            <comment id="15383661" author="rakeshr" created="Tue, 19 Jul 2016 06:40:58 +0000"  >&lt;p&gt;Attached new patch addressing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; comments. Please review it again.&lt;/p&gt;</comment>
                            <comment id="15383689" author="hadoopqa" created="Tue, 19 Jul 2016 07:05:56 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12818755/ZOOKEEPER-2247-19.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12818755/ZOOKEEPER-2247-19.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1750739.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3278//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3278//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3278//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3278//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3278//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3278//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15383804" author="rakeshr" created="Tue, 19 Jul 2016 08:39:10 +0000"  >&lt;p&gt;It looks like &lt;tt&gt;LETest.testLE&lt;/tt&gt; failure is not related to the patch, please ignore it.&lt;/p&gt;</comment>
                            <comment id="15391504" author="rakeshr" created="Mon, 25 Jul 2016 08:01:45 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, would be great to see your feedback on pushing this in. I&apos;ve tried fixing all your comments in the latest patch. Kindly review it again. Thanks!&lt;/p&gt;</comment>
                            <comment id="15392276" author="hanm" created="Mon, 25 Jul 2016 16:53:22 +0000"  >&lt;p&gt;This is a known flaky tests and is tracked by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2483&quot; title=&quot;Flaky Test: org.apache.zookeeper.test.LETest.testLE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2483&quot;&gt;&lt;del&gt;ZOOKEEPER-2483&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15392542" author="fpj" created="Mon, 25 Jul 2016 19:29:39 +0000"  >&lt;p&gt;Is this PR updated, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/65&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15393102" author="rakeshr" created="Tue, 26 Jul 2016 02:51:31 +0000"  >&lt;p&gt;I&apos;ve updated the PR with the changes.&lt;/p&gt;</comment>
                            <comment id="15403413" author="rgs" created="Tue, 2 Aug 2016 05:57:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;: sorry for dropping the ball here. Lgtm, +1. One nit though:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((state == State.ERROR) || (state == State.SHUTDOWN)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Drop the extra ()s around the state checks, it&apos;s readable enough without them.&lt;/p&gt;

&lt;p&gt;I can merge this once we have a +1 from Flavio as well. Thanks!&lt;/p&gt;</comment>
                            <comment id="15403436" author="rakeshr" created="Tue, 2 Aug 2016 06:15:56 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; for the reviews, attached new patch addressing the same. It seems separate patch for &lt;tt&gt;branch-3.4&lt;/tt&gt; is needed, I&apos;ll upload once it is ready for commit.&lt;/p&gt;</comment>
                            <comment id="15403469" author="hadoopqa" created="Tue, 2 Aug 2016 06:39:21 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12821512/ZOOKEEPER-2247-20.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12821512/ZOOKEEPER-2247-20.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1754582.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3319//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3319//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3319//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3319//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3319//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3319//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15404377" author="fpj" created="Tue, 2 Aug 2016 16:55:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; hope you don&apos;t mind, I left just a few minor questions on github. It looks good, though.&lt;/p&gt;</comment>
                            <comment id="15404425" author="rakeshr" created="Tue, 2 Aug 2016 17:21:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the reviews. I&apos;ve replied to those comments.&lt;/p&gt;</comment>
                            <comment id="15409735" author="rakeshr" created="Fri, 5 Aug 2016 17:10:12 +0000"  >&lt;p&gt;Attached new patch addressing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;&apos;s comments given in &lt;a href=&quot;https://github.com/apache/zookeeper/pull/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Github_PR_65&lt;/a&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="15409759" author="hadoopqa" created="Fri, 5 Aug 2016 17:29:05 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822331/ZOOKEEPER-2247-21.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822331/ZOOKEEPER-2247-21.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755100.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3326//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3326//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3326//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3326//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3326//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3326//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15410814" author="rakeshr" created="Sun, 7 Aug 2016 03:46:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, I&apos;ll prepare branch-3-4 patch once I get +1 for the latest trunk patch. Kindly take a look at the attached patch, Thanks!&lt;/p&gt;</comment>
                            <comment id="15411587" author="fpj" created="Mon, 8 Aug 2016 09:29:12 +0000"  >&lt;p&gt;The patch looks good, it is pretty much ready to go. Since you&apos;ll have to generate at least the 3.4 patch, I&apos;ll ask you to fix a couple of small things, hope you don&apos;t mind:&lt;/p&gt;

&lt;p&gt;I have extended the javadoc of `setState`, would you mind using this one instead:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/**
+     * Sets the state of ZooKeeper server. After changing the state, it
+     * notifies the server state change to a registered shutdown handler,
+     * if any.
+     * &amp;lt;p&amp;gt;
+     * The following are the server state transitions:
+     * &amp;lt;li&amp;gt;During startup the server will be in the INITIAL state.&amp;lt;/li&amp;gt;
+     * &amp;lt;li&amp;gt;After successfully starting, the server sets the state to
+     * RUNNING.&amp;lt;/li&amp;gt;
+     * &amp;lt;li&amp;gt; The server transitions to the ERROR state if it hits an internal error.
+     * {@link ZooKeeperServerListenerImpl} notifies any critical resource error
+     * events, e.g., SyncRequestProcessor not being able to write a txn to disk.&amp;lt;/li&amp;gt;
+     * &amp;lt;li&amp;gt;During shutdown the server sets the state to SHUTDOWN, which
+     * corresponds to the server not running.&amp;lt;/li&amp;gt;
+     *
+     * @param state new server state.
+     */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The same for the javadoc of &lt;tt&gt;ZooKeeperServerShutdownHandler&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+/**
+ * ZooKeeper server shutdown handler which will be used to handle ERROR or
+ * SHUTDOWN server state transitions, which in turn releases the associated shutdown
+ * latch.
+ */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, in &lt;tt&gt;waitForNewLeaderElection&lt;/tt&gt;, would you mind setting the &lt;tt&gt;Thread.sleep&lt;/tt&gt; to sleep for only 100ms each time? Not sure if we need to increase the counter, but I&apos;d rather reduce the duration of each iteration.&lt;/p&gt;

&lt;p&gt;Otherwise, it looks very good, thanks for bearing with all the comments and working hard to get it in good shape. If you make these changes and generate the branch patches, I&apos;ll check this one in.&lt;/p&gt;</comment>
                            <comment id="15411618" author="fpj" created="Mon, 8 Aug 2016 10:20:12 +0000"  >&lt;p&gt;+1, pending jenkins run.&lt;/p&gt;</comment>
                            <comment id="15411636" author="hadoopqa" created="Mon, 8 Aug 2016 10:38:28 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822541/ZOOKEEPER-2247-22.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822541/ZOOKEEPER-2247-22.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755379.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3331//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3331//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3331//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3331//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3331//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3331//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15411667" author="rakeshr" created="Mon, 8 Aug 2016 11:03:10 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the detailed reviews and comments. I&apos;ll upload br-3-4 patch shortly.&lt;/p&gt;</comment>
                            <comment id="15411691" author="rakeshr" created="Mon, 8 Aug 2016 11:35:50 +0000"  >&lt;p&gt;Attached trunk(made one minor javadoc correction in ZooKeeperServerMainTest.java test class) and branch-3-4 patches.&lt;/p&gt;</comment>
                            <comment id="15411698" author="hadoopqa" created="Mon, 8 Aug 2016 11:39:52 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822559/ZOOKEEPER-2247-br-3.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822559/ZOOKEEPER-2247-br-3.4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755379.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 9 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3332//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3332//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15411774" author="rakeshr" created="Mon, 8 Aug 2016 13:06:57 +0000"  >&lt;p&gt;Re-attaching the trunk patch again to trigger the Jenkins. Please ignore the previous failure which is due to applying in branch.&lt;/p&gt;</comment>
                            <comment id="15411807" author="hadoopqa" created="Mon, 8 Aug 2016 13:30:54 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822569/ZOOKEEPER-2247-23.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822569/ZOOKEEPER-2247-23.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755379.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3333//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3333//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3333//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3333//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3333//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3333//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15411851" author="rakeshr" created="Mon, 8 Aug 2016 14:09:36 +0000"  >&lt;p&gt;Test case failure is unrelated to the patch, which will be taken care by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2152&quot; title=&quot;Intermittent failure in TestReconfig.cc&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2152&quot;&gt;&lt;del&gt;ZOOKEEPER-2152&lt;/del&gt;&lt;/a&gt; jira.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     [exec]      [exec] Zookeeper_readOnly::testReadOnly : elapsed 4153 : OK
     [exec]      [exec] /home/jenkins/jenkins-slave/workspace/PreCommit-ZOOKEEPER-Build/trunk/src/c/tests/TestReconfig.cc:154: Assertion: assertion failed [Expression: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]
     [exec]      [exec] Failures !!!
     [exec]      [exec] Run: 72   Failure total: 1   Failures: 1   Errors: 0
     [exec]      [exec] FAIL: zktest-mt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15419924" author="hudson" created="Sat, 13 Aug 2016 13:39:06 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #3035 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3035/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3035/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2247&quot; title=&quot;Zookeeper service becomes unavailable when leader fails to write transaction log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2247&quot;&gt;&lt;del&gt;ZOOKEEPER-2247&lt;/del&gt;&lt;/a&gt;: Zookeeper service becomes unavailable when leader fails to write transaction log (Rakesh via fpj) (fpj: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1756262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1756262&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerListenerImpl.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServerShutdownHandler.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/Follower.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/Observer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/ObserverZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/main/org/apache/zookeeper/server/quorum/ReadOnlyZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/server/ZooKeeperServerMainTest.java&lt;/li&gt;
	&lt;li&gt;trunk/src/java/test/org/apache/zookeeper/test/NonRecoverableErrorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15419930" author="fpj" created="Sat, 13 Aug 2016 13:59:04 +0000"  >&lt;p&gt;+1, thanks for the hard work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakesh_r&quot; class=&quot;user-hover&quot; rel=&quot;rakesh_r&quot;&gt;rakesh_r&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Branch 3.4: Committed revision 1756260.&lt;br/&gt;
Branch 3.5: Committed revision 1756270.&lt;br/&gt;
Trunk: Committed revision 1756262.&lt;/p&gt;</comment>
                            <comment id="15419991" author="rakeshr" created="Sat, 13 Aug 2016 16:37:04 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; for the continuous support in resolving this issue. Also, thanking &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for your reviews and inputs.&lt;/p&gt;</comment>
                            <comment id="16079311" author="githubbot" created="Sat, 8 Jul 2017 20:53:56 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/65&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rakeshadr I think this pr can be closed because it&apos;s merged already.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12999864">ZOOKEEPER-2529</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12982448">ZOOKEEPER-2452</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12705679">ZOOKEEPER-1907</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12751287" name="ZOOKEEPER-2247-01.patch" size="37475" author="arshad.mohammad" created="Wed, 19 Aug 2015 15:27:14 +0000"/>
                            <attachment id="12751926" name="ZOOKEEPER-2247-02.patch" size="37526" author="arshad.mohammad" created="Sun, 23 Aug 2015 19:13:46 +0000"/>
                            <attachment id="12751937" name="ZOOKEEPER-2247-03.patch" size="46234" author="arshad.mohammad" created="Sun, 23 Aug 2015 22:41:51 +0000"/>
                            <attachment id="12752017" name="ZOOKEEPER-2247-04.patch" size="46526" author="arshad.mohammad" created="Mon, 24 Aug 2015 14:58:05 +0000"/>
                            <attachment id="12752256" name="ZOOKEEPER-2247-05.patch" size="36124" author="arshad.mohammad" created="Tue, 25 Aug 2015 15:30:59 +0000"/>
                            <attachment id="12769223" name="ZOOKEEPER-2247-06.patch" size="19230" author="arshad.mohammad" created="Wed, 28 Oct 2015 07:47:59 +0000"/>
                            <attachment id="12785089" name="ZOOKEEPER-2247-07.patch" size="21540" author="rakeshr" created="Fri, 29 Jan 2016 04:27:22 +0000"/>
                            <attachment id="12785133" name="ZOOKEEPER-2247-09.patch" size="21949" author="rakeshr" created="Fri, 29 Jan 2016 09:05:07 +0000"/>
                            <attachment id="12785335" name="ZOOKEEPER-2247-10.patch" size="21953" author="rakeshr" created="Sat, 30 Jan 2016 05:26:20 +0000"/>
                            <attachment id="12785683" name="ZOOKEEPER-2247-11.patch" size="21465" author="rakeshr" created="Tue, 2 Feb 2016 02:25:45 +0000"/>
                            <attachment id="12785927" name="ZOOKEEPER-2247-12.patch" size="22608" author="rakeshr" created="Wed, 3 Feb 2016 03:07:44 +0000"/>
                            <attachment id="12786193" name="ZOOKEEPER-2247-13.patch" size="24373" author="rakeshr" created="Thu, 4 Feb 2016 05:30:11 +0000"/>
                            <attachment id="12786408" name="ZOOKEEPER-2247-14.patch" size="25692" author="rakeshr" created="Fri, 5 Feb 2016 04:39:23 +0000"/>
                            <attachment id="12786418" name="ZOOKEEPER-2247-15.patch" size="24402" author="rakeshr" created="Fri, 5 Feb 2016 06:23:05 +0000"/>
                            <attachment id="12812810" name="ZOOKEEPER-2247-16.patch" size="30786" author="rakeshr" created="Thu, 23 Jun 2016 12:13:47 +0000"/>
                            <attachment id="12812823" name="ZOOKEEPER-2247-17.patch" size="28517" author="rakeshr" created="Thu, 23 Jun 2016 13:02:42 +0000"/>
                            <attachment id="12812843" name="ZOOKEEPER-2247-18.patch" size="28812" author="rakeshr" created="Thu, 23 Jun 2016 14:57:59 +0000"/>
                            <attachment id="12818755" name="ZOOKEEPER-2247-19.patch" size="28527" author="rakeshr" created="Tue, 19 Jul 2016 06:39:00 +0000"/>
                            <attachment id="12821512" name="ZOOKEEPER-2247-20.patch" size="28523" author="rakeshr" created="Tue, 2 Aug 2016 06:11:05 +0000"/>
                            <attachment id="12822331" name="ZOOKEEPER-2247-21.patch" size="29669" author="rakeshr" created="Fri, 5 Aug 2016 17:06:05 +0000"/>
                            <attachment id="12822541" name="ZOOKEEPER-2247-22.patch" size="29787" author="rakeshr" created="Mon, 8 Aug 2016 10:11:57 +0000"/>
                            <attachment id="12822569" name="ZOOKEEPER-2247-23.patch" size="29779" author="rakeshr" created="Mon, 8 Aug 2016 13:06:57 +0000"/>
                            <attachment id="12785702" name="ZOOKEEPER-2247-b3.5.patch" size="12767" author="fpj" created="Tue, 2 Feb 2016 05:11:19 +0000"/>
                            <attachment id="12822559" name="ZOOKEEPER-2247-br-3.4.patch" size="30429" author="rakeshr" created="Mon, 8 Aug 2016 11:33:11 +0000"/>
                            <attachment id="12786428" name="ZOOKEEPER-2247-br-3.4.patch" size="24451" author="rakeshr" created="Fri, 5 Feb 2016 07:06:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>25.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ixev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>