<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:05:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4712] Follower.shutdown() and Observer.shutdown() do not correctly shutdown the syncProcessor, which may lead to data inconsistency</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4712</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Follower.shutdown() and Observer.shutdown() do not correctly shutdown the syncProcessor. It may lead to potential data inconsistency (see &lt;b&gt;Potential Risk&lt;/b&gt;).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A follower / observer will invoke syncProcessor.shutdown() in LearnerZooKeeperServer.shutdown() / ObserverZooKeeperServer.shutdown(), respectively.&lt;/p&gt;

&lt;p&gt;However, after the &lt;a href=&quot;https://github.com/apache/zookeeper/commit/efbd660e1c4b90a8f538f2cccb5dcb7094cf9a22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FIX&lt;/a&gt; of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3642&quot; title=&quot;Data inconsistency when the leader crashes right after sending SNAP sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3642&quot;&gt;&lt;del&gt;ZOOKEEPER-3642&lt;/del&gt;&lt;/a&gt;, Follower.shutdown() / Observer.shutdown() will not invoke LearnerZooKeeperServer.shutdown() / ObserverZooKeeperServer.shutdown() anymore.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;MethodInvocationPath&quot;&gt;&lt;/a&gt;Method Invocation Path&lt;/h2&gt;
&lt;h5&gt;&lt;a name=&quot;Version3.8.1%2F3.8.0%2F3.7.1%2F3.7.0%2F3.6.4%2F3.6.3%2F3.5.10...&quot;&gt;&lt;/a&gt;Version 3.8.1 / 3.8.0 / 3.7.1 / 3.7.0 / 3.6.4 / 3.6.3 / 3.5.10 ...&lt;/h5&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;(Buggy)&lt;/b&gt; Observer.shutdown() -&amp;gt; Learner.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;(Buggy)&lt;/b&gt; Follower.shutdown() -&amp;gt; Learner.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;(For comparison) Leader.shutdown(String) -&amp;gt;&#160; LeaderZooKeeper.shutdown() -&amp;gt; ZooKeeperServer.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;Forcomparison%2Cinversion3.4.X%2C&quot;&gt;&lt;/a&gt;For comparison, in version 3.4.X,&lt;/h5&gt;
&lt;ul&gt;
	&lt;li&gt;Observer.shutdown() -&amp;gt; Learner.shutdown() -&amp;gt; &lt;b&gt;ObserverZooKeeperServer.shutdown() -&lt;/b&gt;&amp;gt; ZooKeeperServer.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Follower.shutdown() -&amp;gt; Learner.shutdown() -&amp;gt; &lt;b&gt;FollowerZooKeeperServer.shutdown() -&lt;/b&gt;&amp;gt; ZooKeeperServer.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;Or%2Cinversion3.6.0%2C&quot;&gt;&lt;/a&gt;Or, in version 3.6.0,&lt;/h5&gt;
&lt;ul&gt;
	&lt;li&gt;Observer.shutdown() -&amp;gt; Learner.shutdown() -&amp;gt; &lt;b&gt;LearnerZooKeeperServer.shutdown() -&lt;/b&gt;&amp;gt; ZooKeeperServer.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Follower.shutdown() -&amp;gt; Learner.shutdown() -&amp;gt; &lt;b&gt;Learner&lt;/b&gt;&lt;b&gt;ZooKeeperServer.shutdown() -&lt;/b&gt;&amp;gt; ZooKeeperServer.shutdown() -&amp;gt; ZooKeeperServer.shutdown(boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;CodeDetails&quot;&gt;&lt;/a&gt;Code Details&lt;/h2&gt;

&lt;p&gt;Take version 3.8.0 as an example.&lt;/p&gt;

&lt;p&gt;In Follower.shutdown() :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shutdown() {
&#160; &#160; &#160; &#160; LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;shutdown Follower&quot;&lt;/span&gt;);
+ &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// invoke Learner.shutdown()
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.shutdown(); &#160;&#160;
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In Learner.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shutdown() {
&#160; &#160; &#160; &#160; ...
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// shutdown previous zookeeper
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (zk != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// If we haven&apos;t finished SNAP sync, force fully shutdown
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// to avoid potential inconsistency
&lt;/span&gt;+ &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// This will invoke ZooKeeperServer.shutdown(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;),&#160;
&lt;/span&gt;+ &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// which will not shutdown syncProcessor
&lt;/span&gt;+ &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Before the fix of ZOOLEEPER-3642,&#160;
&lt;/span&gt;+ &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// FollowerZooKeeperServer.shutdown() will be invoked here
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; zk.shutdown(self.getSyncMode().equals(QuorumPeer.SyncMode.SNAP)); &#160;&#160; &#160; &#160; &#160; }
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In ZooKeeperServer.java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void shutdown(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fullyShutDown) {
&#160; &#160; &#160; &#160; ...
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (firstProcessor != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+ &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// For a follower, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will not shutdown its syncProcessor.
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; firstProcessor.shutdown();&#160;
&#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; ...
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In expectation, Follower.shutdown() should invoke LearnerZooKeeperServer.shutdown() to shutdown the syncProcessor:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void shutdown() {
&#160; &#160; &#160; &#160; ...
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+ &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// shutdown the syncProcessor here
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (syncProcessor != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; syncProcessor.shutdown(); &#160; &#160;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; } ...
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Observer.shutdown() has the similar problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;PotentialRisk&quot;&gt;&lt;/a&gt;Potential Risk&lt;/h2&gt;

&lt;p&gt;When Follower.shutdown() is called, the follower&apos;s QuorumPeer thread may update the lastProcessedZxid for the election and recovery phase before its syncThread drains the pending requests and flushes them to disk.&lt;/p&gt;

&lt;p&gt;In consequence, this lastProcessedZxid is not the latest zxid in its log, leading to log inconsistency after the SYNC phase. (Similar to the symptoms of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;.)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13541926">ZOOKEEPER-4712</key>
            <summary>Follower.shutdown() and Observer.shutdown() do not correctly shutdown the syncProcessor, which may lead to data inconsistency</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jonmv">Jon Marius Venstad</assignee>
                                    <reporter username="ouyang">Sirius</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 29 Jun 2023 10:59:11 +0000</created>
                <updated>Tue, 29 Oct 2024 02:11:06 +0000</updated>
                            <resolved>Fri, 20 Sep 2024 19:10:41 +0000</resolved>
                                    <version>3.5.10</version>
                    <version>3.6.3</version>
                    <version>3.7.0</version>
                    <version>3.8.0</version>
                    <version>3.7.1</version>
                    <version>3.6.4</version>
                    <version>3.9.0</version>
                    <version>3.8.1</version>
                    <version>3.9.1</version>
                                    <fixVersion>3.10.0</fixVersion>
                    <fixVersion>3.9.3</fixVersion>
                                    <component>quorum</component>
                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15000">4h 10m</timespent>
                                <comments>
                            <comment id="17883383" author="andorm" created="Fri, 20 Sep 2024 19:10:41 +0000"  >&lt;p&gt;Issue resolved by pull request 2154&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/2154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/2154&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17883463" author="kezhuw" created="Sat, 21 Sep 2024 09:04:17 +0000"  >&lt;p&gt;This should be assigned to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonmv&quot; class=&quot;user-hover&quot; rel=&quot;jonmv&quot;&gt;jonmv&lt;/a&gt;. I saw &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-4541?focusedCommentId=17608752&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17608752&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-4541?focusedCommentId=17608752&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17608752&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13273469">ZOOKEEPER-3642</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13436111">ZOOKEEPER-4502</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13444408">ZOOKEEPER-4541</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13541929">ZOOKEEPER-4713</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ivdc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>