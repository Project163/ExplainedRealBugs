<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-1998] C library calls getaddrinfo unconditionally from zookeeper_interest</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-1998</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;(commented this on &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-338&quot; title=&quot;zk hosts should be resolved periodically for loadbalancing amongst zk servers.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-338&quot;&gt;ZOOKEEPER-338&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;I&apos;ve just noticed that we call getaddrinfo from zookeeper_interest... on every call. So from zookeeper_interest we always call update_addrs:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L2082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L2082&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;which in turns unconditionally calls resolve_hosts:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L787&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L787&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;which does the unconditional calls to getaddrinfo:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L648&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We should fix this since it&apos;ll make 3.5.0 slower for people relying on DNS. I think this is happened as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-107&quot; title=&quot;Allow dynamic changes to server cluster membership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-107&quot;&gt;&lt;del&gt;ZOOKEEPER-107&lt;/del&gt;&lt;/a&gt; in which the list of servers can be updated. &lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12730581">ZOOKEEPER-1998</key>
            <summary>C library calls getaddrinfo unconditionally from zookeeper_interest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ztzg">Damien Diederen</assignee>
                                    <reporter username="rgs">Ra&#250;l Guti&#233;rrez Segal&#233;s</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 29 Jul 2014 19:27:17 +0000</created>
                <updated>Sun, 28 Mar 2021 08:55:32 +0000</updated>
                            <resolved>Sun, 17 May 2020 13:17:42 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.7.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>14</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="11400">3h 10m</timespent>
                                <comments>
                            <comment id="14078237" author="marshall" created="Tue, 29 Jul 2014 19:39:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; - yep, you&apos;re right. I added that code as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-107&quot; title=&quot;Allow dynamic changes to server cluster membership&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-107&quot;&gt;&lt;del&gt;ZOOKEEPER-107&lt;/del&gt;&lt;/a&gt; working with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;. But if I recall correctly, the original code also unconditionally called resolve_hosts. Though I&apos;d have to go look at the original code to confirm that. I&apos;m guessing you&apos;ve done that already and that it did not do that? &lt;/p&gt;

&lt;p&gt;Do you have thoughts on how we could avoid this? I suppose we could easily just check if the addrvec is the same and if it is bypass resolving the hosts. &lt;/p&gt;</comment>
                            <comment id="14078246" author="rgs" created="Tue, 29 Jul 2014 19:48:23 +0000"  >&lt;p&gt;I actually didn&apos;t look at 3.4! Since the code looked new, I just guessed. But, it turns out the that getaddrs is only called from zookeeper_init in 3.4 (unless I am overlooking something):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.4/src/c/src/zookeeper.c#L836&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/branch-3.4/src/c/src/zookeeper.c#L836&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do you have thoughts on how we could avoid this? I suppose we could easily just check if the addrvec is the same and if it is bypass resolving the hosts. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, but lookups should only happen upon reconnects right? When things are healthy (i.e.: connected), it doesn&apos;t matter if we have (even new) unresolved hosts. So I&apos;d say we only call resolve_hosts() when a new connection is needed.. Thoughts?&lt;/p&gt;</comment>
                            <comment id="14078406" author="marshall" created="Tue, 29 Jul 2014 21:30:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; - Looking at the 3.4 code I agree with you. It seems like we should only do the lookup when we are connecting.&lt;/p&gt;</comment>
                            <comment id="14078426" author="hdeng" created="Tue, 29 Jul 2014 21:40:57 +0000"  >&lt;p&gt;hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;.&lt;br/&gt;
One suggestion &amp;#8211; when pointing Github link don&apos;t use &quot;trunk&quot; use specific commit hash in the URL. This would make it point to where you meant when trunk commits change. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14522078" author="yasumoto" created="Thu, 30 Apr 2015 19:11:51 +0000"  >&lt;p&gt;I&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/MESOS-2681&quot; title=&quot;Slave process must restart to update ensemble members&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MESOS-2681&quot;&gt;MESOS-2681&lt;/a&gt; which tracks Apache Mesos being affected by this as well in the 3.4.x branch.&lt;/p&gt;</comment>
                            <comment id="15278509" author="jfield" created="Tue, 10 May 2016 17:25:25 +0000"  >&lt;p&gt;We&apos;ve got a few hundred ZooKeeper clients per datacenter that are doing ~30 lookups a minute each that they don&apos;t need to be doing any as far as I can tell, which I think is because of this issue. Is there active work on a fix for this?&lt;/p&gt;</comment>
                            <comment id="15325543" author="hanm" created="Sat, 11 Jun 2016 00:13:29 +0000"  >&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/MESOS-2681&quot; title=&quot;Slave process must restart to update ensemble members&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MESOS-2681&quot;&gt;MESOS-2681&lt;/a&gt; is not directly affected by this issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1998&quot; title=&quot;C library calls getaddrinfo unconditionally from zookeeper_interest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1998&quot;&gt;&lt;del&gt;ZOOKEEPER-1998&lt;/del&gt;&lt;/a&gt;). The problematic code path we are talking about here in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1998&quot; title=&quot;C library calls getaddrinfo unconditionally from zookeeper_interest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1998&quot;&gt;&lt;del&gt;ZOOKEEPER-1998&lt;/del&gt;&lt;/a&gt; is a different code path: &lt;b&gt;zookeeper_interest&lt;/b&gt; is the entry point instead of &lt;b&gt;zookeeper_init&lt;/b&gt;. &lt;/p&gt;

&lt;p&gt;What Mesos experienced was caused by &lt;b&gt;Mesos forcefully expires session (locally) if it is disconnected from ZK for &amp;gt;10s.&lt;/b&gt; according to the comment made in &lt;a href=&quot;https://issues.apache.org/jira/browse/MESOS-2681&quot; title=&quot;Slave process must restart to update ensemble members&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MESOS-2681&quot;&gt;MESOS-2681&lt;/a&gt;, and when ZK client in Mesos tried to re-establish the session it was the &lt;b&gt;zookeeper_init()&lt;/b&gt; code gets called (which, would call resolve_hosts). I tend to think the proper fix on Mesos side would be to try avoid frequent session expiration if possible, which would reduce the attempts to re-establishment of sessions and thus reduces the DNS lookup.&lt;/p&gt;


</comment>
                            <comment id="16695483" author="mkedwards" created="Thu, 22 Nov 2018 02:16:25 +0000"  >&lt;p&gt;This seems like it could be pretty serious in some environments.  Addressable for 3.5.5?&lt;/p&gt;</comment>
                            <comment id="16918728" author="ztzg" created="Thu, 29 Aug 2019 15:50:53 +0000"  >&lt;p&gt;I have recently pushed a GitHub &quot;pull request&quot; which addresses this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1068&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It passes all tests and (includes some new ones). Comments and/or suggestions are welcome.&lt;/p&gt;</comment>
                            <comment id="17109474" author="eolivelli" created="Sun, 17 May 2020 13:17:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ztzg&quot; class=&quot;user-hover&quot; rel=&quot;ztzg&quot;&gt;ztzg&lt;/a&gt; I have committed your patch.&lt;/p&gt;

&lt;p&gt;thank you very much !&lt;br/&gt;
thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt; for your review&lt;/p&gt;</comment>
                            <comment id="17109504" author="ztzg" created="Sun, 17 May 2020 14:39:24 +0000"  >&lt;p&gt;Thank you!  (And sorry for the nagging!)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12826402">MESOS-2681</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13129583">ZOOKEEPER-2965</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ybc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408652</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>