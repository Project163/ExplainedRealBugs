<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3320] Leader election port stop listen when hostname unresolvable for some time </title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3320</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;When trying to run Zookeeper 3.5.4 cluster on Kubernetes, I found out that in some circumstances Zookeeper node stop listening on leader election port. This cause unavailability of ZK cluster. &lt;br/&gt;
Zookeeper deployed &#160;as StatefulSet in term of Kubernetes and has following dynamic configuration:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
zookeeper-0.zookeeper:2182:2183:participant;2181
zookeeper-1.zookeeper:2182:2183:participant;2181
zookeeper-2.zookeeper:2182:2183:participant;2181
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Bind address contains DNS name which generated by Kubernetes for each StatefulSet pod.&lt;br/&gt;
These DNS names will become resolvable after container start, but with some delay. That delay cause stopping of leader election port listener in QuorumCnxManager.Listener class.&lt;br/&gt;
Error happens in QuorumCnxManager.Listener &quot;run&quot; method, it tries to bind leader election port to hostname which not resolvable at this moment. Retry count is hard-coded and equals to 3(with backoff of 1 sec). &lt;/p&gt;

&lt;p&gt;Zookeeper server log contains following errors:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-03-17 07:56:04,844 [myid:1] - WARN  [QuorumPeer[myid=1](plain=/0.0.0.0:2181)(secure=disabled):QuorumPeer@1230] - Unexpected exception
java.net.SocketException: Unresolved address
	at java.base/java.net.ServerSocket.bind(ServerSocket.java:374)
	at java.base/java.net.ServerSocket.bind(ServerSocket.java:335)
	at org.apache.zookeeper.server.quorum.Leader.&amp;lt;init&amp;gt;(Leader.java:241)
	at org.apache.zookeeper.server.quorum.QuorumPeer.makeLeader(QuorumPeer.java:1023)
	at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1226)
2019-03-17 07:56:04,844 [myid:1] - WARN  [QuorumPeer[myid=1](plain=/0.0.0.0:2181)(secure=disabled):QuorumPeer@1261] - PeerState set to LOOKING
2019-03-17 07:56:04,845 [myid:1] - INFO  [QuorumPeer[myid=1](plain=/0.0.0.0:2181)(secure=disabled):QuorumPeer@1136] - LOOKING
2019-03-17 07:56:04,845 [myid:1] - INFO  [QuorumPeer[myid=1](plain=/0.0.0.0:2181)(secure=disabled):FastLeaderElection@893] - New election. My id =  1, proposed zxid=0x0
2019-03-17 07:56:04,846 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@687] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xf (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)
2019-03-17 07:56:04,979 [myid:1] - INFO  [zookeeper-0.zookeeper:2183:QuorumCnxManager$Listener@892] - Leaving listener
2019-03-17 07:56:04,979 [myid:1] - ERROR [zookeeper-0.zookeeper:2183:QuorumCnxManager$Listener@894] - As I&lt;span class=&quot;code-quote&quot;&gt;&apos;m leaving the listener thread, I won&apos;&lt;/span&gt;t be able to participate in leader election any longer: zookeeper-0.zookeeper:2183
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This error happens on most nodes on cluster start and Zookeeper is unable to form quorum. This will leave cluster in unusable state.&lt;br/&gt;
As I can see, error present on branches 3.4 and 3.5. &lt;br/&gt;
I think, this error can be fixed by configurable number of retries(instead of hard-coded value of 3). &lt;br/&gt;
Other way to fix this is removing of max retries at all. Currently, ZK server only stop leader election listener and continue to serve on other ports. Maybe, if leader election halts, we should abort process.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13222125">ZOOKEEPER-3320</key>
            <summary>Leader election port stop listen when hostname unresolvable for some time </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lagrang">Igor Skokov</assignee>
                                    <reporter username="lagrang">Igor Skokov</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 17 Mar 2019 08:21:29 +0000</created>
                <updated>Wed, 16 Oct 2019 18:59:11 +0000</updated>
                            <resolved>Tue, 13 Aug 2019 11:36:39 +0000</resolved>
                                    <version>3.4.10</version>
                    <version>3.5.4</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.6</fixVersion>
                                    <component>leaderElection</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="39000">10h 50m</timespent>
                                <comments>
                            <comment id="16796341" author="nixon" created="Tue, 19 Mar 2019 17:49:52 +0000"  >&lt;p&gt;This is an interesting error case!&lt;/p&gt;

&lt;p&gt;I would expect an issue in QuorumCnxManager to bring the peer down if it cannot create the socket but it seems this only occurs with a BindException and not a generic SocketException. At the least, I think we ought to fix that.&lt;/p&gt;

&lt;p&gt;Looking at this from the opposite direction, can you add the desired delay in the startup sequence of your Kubernetes container? My concern is that the pattern of &quot;DNS is currently unreliable but will be reliable soon&quot; seems specific to the container management and may result in strange behavior when applied to other environments.&lt;/p&gt;</comment>
                            <comment id="16796844" author="lagrang" created="Wed, 20 Mar 2019 06:33:33 +0000"  >&lt;p&gt;&lt;cite&gt;I would expect an issue in QuorumCnxManager to bring the peer down if it cannot create the socket but it seems this only occurs with a BindException and not a generic SocketException. At the least, I think we ought to fix that.&lt;/cite&gt;&lt;br/&gt;
As I can see, QuorumCnxManager.Listener.run() catches IOException, and consequently SocketException&amp;amp;BindException. In any case, ZK server will continue to run without leader election participation&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;Looking at this from the opposite direction, can you add the desired delay in the startup sequence of your Kubernetes container? My concern is that the pattern of &quot;DNS is currently unreliable but will be reliable soon&quot; seems specific to the container management and may result in strange behavior when applied to other environments.&lt;/cite&gt;&lt;br/&gt;
Sure, I can integrate artificial delay to my container(or some DNS name check loop). &lt;br/&gt;
But, it will be great if ZK can handle such temporary errors by itself. I agree, that &quot;retry forever&quot; is not best solution, but as I mention earlier, maybe we can make retry count configurable?  &lt;/p&gt;</comment>
                            <comment id="16797657" author="nixon" created="Wed, 20 Mar 2019 23:29:19 +0000"  >&lt;p&gt;A configurable retry seems like a good idea to me. Either something like &quot;election port bind time&quot; or &quot;dns unavailable time&quot; if we want to be more general. Do you want to contribute a short diff?&lt;/p&gt;

&lt;p&gt;This may also be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2982&quot; title=&quot;Re-try DNS hostname -&amp;gt; IP resolution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2982&quot;&gt;&lt;del&gt;ZOOKEEPER-2982&lt;/del&gt;&lt;/a&gt; (or may not, making a note to check later).&lt;/p&gt;</comment>
                            <comment id="16797880" author="lagrang" created="Thu, 21 Mar 2019 07:03:29 +0000"  >&lt;p&gt;I attach link to pull request. It based on branch-3.5, but as far as a know, this error can happen on master branch. If needed, I can create another pull request for master.&lt;/p&gt;</comment>
                            <comment id="16895110" author="nkalmar" created="Mon, 29 Jul 2019 09:52:01 +0000"  >&lt;p&gt;Merged to master.&lt;br/&gt;
Please create a seperate PR for 3.5.&lt;br/&gt;
Thank you!&lt;/p&gt;</comment>
                            <comment id="16895159" author="hudson" created="Mon, 29 Jul 2019 11:36:28 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Zookeeper-trunk-single-thread #468 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/468/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/468/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3320&quot; title=&quot;Leader election port stop listen when hostname unresolvable for some time &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3320&quot;&gt;&lt;del&gt;ZOOKEEPER-3320&lt;/del&gt;&lt;/a&gt;: Leader election port stop listen when hostname (nkalmar: rev 05ee9413e7a31703395b81fb8d72baf1cb09a46d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16895238" author="hudson" created="Mon, 29 Jul 2019 13:16:38 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #634 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/634/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/634/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3320&quot; title=&quot;Leader election port stop listen when hostname unresolvable for some time &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3320&quot;&gt;&lt;del&gt;ZOOKEEPER-3320&lt;/del&gt;&lt;/a&gt;: Leader election port stop listen when hostname (nkalmar: rev 05ee9413e7a31703395b81fb8d72baf1cb09a46d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16897154" author="hudson" created="Wed, 31 Jul 2019 13:02:27 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Zookeeper-trunk-single-thread #473 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/473/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/473/&lt;/a&gt;)&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3320&quot; title=&quot;Leader election port stop listen when hostname unresolvable for some time &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3320&quot;&gt;&lt;del&gt;ZOOKEEPER-3320&lt;/del&gt;&lt;/a&gt;: Leader election port stop listen when hostname (andor: rev a89c0942e45bb16e5282eee9d3a56ebbddbaae15)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16897209" author="hudson" created="Wed, 31 Jul 2019 13:59:38 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #638 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/638/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/638/&lt;/a&gt;)&lt;br/&gt;
Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3320&quot; title=&quot;Leader election port stop listen when hostname unresolvable for some time &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3320&quot;&gt;&lt;del&gt;ZOOKEEPER-3320&lt;/del&gt;&lt;/a&gt;: Leader election port stop listen when hostname (andor: rev a89c0942e45bb16e5282eee9d3a56ebbddbaae15)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16901114" author="hudson" created="Tue, 6 Aug 2019 14:36:06 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #485 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/485/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/485/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3320&quot; title=&quot;Leader election port stop listen when hostname unresolvable for some time &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3320&quot;&gt;&lt;del&gt;ZOOKEEPER-3320&lt;/del&gt;&lt;/a&gt;: Leader election port stop listen when hostname (andor: rev 6692d7a5b4bc3f0dbd36677c06e782ef5240153a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16901192" author="hudson" created="Tue, 6 Aug 2019 15:41:51 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #650 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/650/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/650/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3320&quot; title=&quot;Leader election port stop listen when hostname unresolvable for some time &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3320&quot;&gt;&lt;del&gt;ZOOKEEPER-3320&lt;/del&gt;&lt;/a&gt;: Leader election port stop listen when hostname (andor: rev 6692d7a5b4bc3f0dbd36677c06e782ef5240153a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/CnxManagerTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16906104" author="andorm" created="Tue, 13 Aug 2019 11:36:39 +0000"  >&lt;p&gt;Issue resolved by pull request 1053&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1053&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1053&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 14 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00s9c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>