<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:56:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2062] RemoveWatchesTest takes forever to run</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2062</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.zookeeper.RemoveWatchesTest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 46, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 306.188 sec&lt;/p&gt;</description>
                <environment></environment>
        <key id="12748168">ZOOKEEPER-2062</key>
            <summary>RemoveWatchesTest takes forever to run</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cnauroth">Chris Nauroth</assignee>
                                    <reporter username="fpj">Flavio Paiva Junqueira</reporter>
                        <labels>
                            <label>remove_watches</label>
                    </labels>
                <created>Tue, 14 Oct 2014 23:23:44 +0000</created>
                <updated>Sun, 16 Dec 2018 14:27:51 +0000</updated>
                            <resolved>Tue, 5 May 2015 02:44:05 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.1</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14171846" author="rakeshr" created="Wed, 15 Oct 2014 01:29:43 +0000"  >&lt;p&gt;Thanks @fpj for pointing out this. Following are the testcases which takes huge amount of time. Most of them have verification points by checking that the watcher(data/child) is really removed or not, its done by waiting few seconds(CONNECTION_TIMEOUT/5) for the watch notifications. This certainly needs improvement and can think for a better verification idea.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RemoveWatchesTest.java
       Assert.assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Shouldn&apos;t remove data watcher&quot;&lt;/span&gt;, w1.matches());

       &lt;span class=&quot;code-comment&quot;&gt;// matches logic is waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the watch notification ?
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; matches() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!latch.await(CONNECTION_TIMEOUT/5, TimeUnit.MILLISECONDS)) {
                LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed waiting to remove the watches&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;testRemoveAllChildWatchesOnAPath[0]	30 sec	Passed
testRemoveAllChildWatchesOnAPath[1]	30 sec	Passed
testRemoveAllDataWatchesOnAPath[0]	30 sec	Passed
testRemoveAllDataWatchesOnAPath[1]	30 sec	Passed
testRemoveWatcherWhenNoConnection[0]	14 sec	Passed
testRemoveWatcherWhenNoConnection[1]	14 sec	Passed
testMultipleChildWatchers[0]		9 sec	Passed
testMultipleChildWatchers[1]		9 sec	Passed
testManyWatchersWhenNoConnection[1]	6.9 sec	Passed
testChRootRemoveWatcher[0]		6.1 sec	Passed
testChRootRemoveWatcher[1]		6 sec	Passed
testMultipleDataWatchers[0]		6 sec	Passed
testMultipleDataWatchers[1]		6 sec	Passed
testRemoveAnyChildWatcher[0]		6 sec	Passed
testRemoveAnyChildWatcher[1]		6 sec	Passed
testRemoveAnyDataWatcher[0]		6 sec	Passed
testRemoveAnyDataWatcher[1]		6 sec	Passed
testRemoveSingleWatcher[0]		6.4 sec	Passed
testRemoveSingleWatcher[1]		6 sec	Passed
testManyWatchersWhenNoConnection[0]	5.2 sec	Passed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14171873" author="rakeshr" created="Wed, 15 Oct 2014 01:51:42 +0000"  >&lt;p&gt;Again, few of these test cases has similar kinda false notification checks by waiting long time. Here its 30secs wait period to see any possibility of getting a false notification:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Assert.assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Received data watch notification!&quot;&lt;/span&gt;,
                dWatchCount.await(CONNECTION_TIMEOUT, TimeUnit.MILLISECONDS));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14512772" author="cnauroth" created="Sat, 25 Apr 2015 23:52:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, I&apos;m attaching a patch that speeds up the 4 slowest tests in the suite.  Would you be interested in reviewing?  Running the entire &lt;tt&gt;RemoveWatchesTest&lt;/tt&gt; suite from trunk on my machine takes ~5 minutes.  With this patch, that drops to ~2 minutes.&lt;/p&gt;

&lt;p&gt;This required hooking into the internals of some of the production code.  This is the least intrusive way to do it that I could find, but let me know if you have other ideas.  I&apos;ve defined a new &lt;tt&gt;WatchManagerListener&lt;/tt&gt; interface that receives direct notification when the &lt;tt&gt;WatchManager&lt;/tt&gt; triggers a watch.  For the tests that need to check that they did not receive notification after removing a watch, they can use the listener to check immediately instead of relying on a long wait to be sure.  This also makes the tests deterministic as opposed to the waiting approach.&lt;/p&gt;

&lt;p&gt;I wanted to make sure I didn&apos;t harm what the tests were trying to prove.  To do that, I temporarily introduced a bug in my local environment.  I hacked &lt;tt&gt;ZKDatabase#removeWatch&lt;/tt&gt; so that it didn&apos;t actually remove the watch.  When I did that, the tests still failed and caught the bug (as they should).&lt;/p&gt;

&lt;p&gt;Please let me know your thoughts on the patch.  It would be nice to shave a few minutes off of every pre-commit run.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14512806" author="hadoopqa" created="Sun, 26 Apr 2015 00:49:14 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12728183/ZOOKEEPER-2062.001.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12728183/ZOOKEEPER-2062.001.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1672934.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2648//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2648//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2648//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2648//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2648//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2648//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14513157" author="cnauroth" created="Sun, 26 Apr 2015 17:50:40 +0000"  >&lt;p&gt;I&apos;m attaching patch v002, which simplifies the test a bit by having it directly implement the &lt;tt&gt;WatchManagerListener&lt;/tt&gt; interface.  I also corrected a JavaDoc typo in &lt;tt&gt;WatchManagerListener&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14513182" author="hadoopqa" created="Sun, 26 Apr 2015 18:48:48 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12728243/ZOOKEEPER-2062.002.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12728243/ZOOKEEPER-2062.002.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1672934.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2650//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2650//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2650//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2650//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2650//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2650//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14513407" author="rakeshr" created="Mon, 27 Apr 2015 01:47:36 +0000"  >&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; I really appreciate your thoughts. Its very nice approach by directly using the &lt;tt&gt;DataTree&lt;/tt&gt; watch information in tests. This would make the tests more deterministic as opposed to the waiting approach. Your idea of &lt;tt&gt;WatchManagerListener&lt;/tt&gt; makes it simple. On a second thought I&apos;m trying to avoid creating an extra listener just for testing purpose, if we couldn&apos;t manage to find a best way, I agree to go ahead with the &lt;tt&gt;WatchManagerListener&lt;/tt&gt;. Can we first think of using existing data structures and the APIs available in &lt;tt&gt;DataTree&lt;/tt&gt; to satisfy the test assertions.&lt;/p&gt;


&lt;p&gt;I&apos;ve tried slightly different approach. Please see the below improvement and does this sound good to you? If yes, we will modify all the similar waiting cases into this kinda approach.&lt;/p&gt;

&lt;p&gt;1. In &lt;tt&gt;testRemoveAllDataWatchesOnAPath&lt;/tt&gt;. Modify the below part&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Assert.assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t set data watches&quot;&lt;/span&gt;,
                zk2.exists(&lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;, w2));

        removeAllWatches(zk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;, WatcherType.Data, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Code.OK);
        Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t remove data watcher&quot;&lt;/span&gt;,
                rmWatchCount.await(CONNECTION_TIMEOUT, TimeUnit.MILLISECONDS));

        zk1.setData(&lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;.getBytes(), -1);
        LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; data watchers notification after watch removal&quot;&lt;/span&gt;);
        Assert.assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Received data watch notification!&quot;&lt;/span&gt;,
                dWatchCount.await(CONNECTION_TIMEOUT, TimeUnit.MILLISECONDS));
        Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Received watch notification after removal!&quot;&lt;/span&gt;, 2,
                dWatchCount.getCount());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; sessions = getServer(serverFactory).getZKDatabase()
                .getDataTree().getWatchesByPath().getSessions(&lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;);
        Assert.assertNotNull(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t find the session&quot;&lt;/span&gt;, sessions);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sessionId = sessions.iterator().next();
        Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Session mismatches&quot;&lt;/span&gt;, zk2.getSessionId(), sessionId);

        removeAllWatches(zk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;, WatcherType.Data, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Code.OK);

        Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t remove data watcher&quot;&lt;/span&gt;,
                rmWatchCount.await(CONNECTION_TIMEOUT, TimeUnit.MILLISECONDS));
        Assert.assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Child watchers exists after removal!&quot;&lt;/span&gt;,
                getServer(serverFactory).getZKDatabase().getDataTree()
                .getWatchesByPath().hasSessions(&lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. In &lt;tt&gt;testChRootRemoveWatcher&lt;/tt&gt;. Modify the below part&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Assert.assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Shouldn&apos;t remove data watcher&quot;&lt;/span&gt;, w2.matches());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t find child watcher&quot;&lt;/span&gt;, 1, zk2
                .getChildWatches().size());
        removeWatches(zk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;/node1&quot;&lt;/span&gt;, w2, WatcherType.Any, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Code.OK);
        Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t remove child watcher&quot;&lt;/span&gt;, w2.matches());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14514596" author="fournc" created="Mon, 27 Apr 2015 18:15:49 +0000"  >&lt;p&gt;I dig this a bunch.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; if you wanna upload an updated patch with your changes I will review it and pending my +1 you can check it in.&lt;/p&gt;</comment>
                            <comment id="14514607" author="cnauroth" created="Mon, 27 Apr 2015 18:19:34 +0000"  >&lt;p&gt;Thanks, Camille.  I&apos;ve got something in progress making similar changes across the suite.&lt;/p&gt;</comment>
                            <comment id="14514617" author="cnauroth" created="Mon, 27 Apr 2015 18:25:39 +0000"  >&lt;p&gt;I also wanted to mention that &lt;tt&gt;DataTree#getWatchesByPath&lt;/tt&gt; returns only data watchers (not child watchers), so I modified the suggestion from Rakesh a bit to check if the &lt;tt&gt;ServerCnxn&lt;/tt&gt; is registered as a watcher for covering both cases.  Thanks for the help Rakesh!&lt;/p&gt;</comment>
                            <comment id="14514833" author="cnauroth" created="Mon, 27 Apr 2015 19:50:34 +0000"  >&lt;p&gt;I&apos;m attaching patch v003.  This brings the whole test suite run down to 1 minute 20 seconds on my machine.&lt;/p&gt;

&lt;p&gt;This applies the suggestions from the last comment from Rakesh.  As mentioned in my last comment though, I found that &lt;tt&gt;DataTree#getWatchesByPath&lt;/tt&gt; returned only data watches.  Instead of relying on that, I&apos;ve added assertions on whether or not the server-side session is registered as a watcher.  Let me know if this is sufficient.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;testRemoveSingleWatcher&lt;/tt&gt; and &lt;tt&gt;testMultipleDataWatchers&lt;/tt&gt; are still a tad slow.  However, I didn&apos;t want to change these, because it seems these are specifically intended to check session close semantics.  Once the session is closed, trying to do these new assertions wouldn&apos;t be valid, so I left these tests waiting on the latches for timeouts.&lt;/p&gt;

&lt;p&gt;I also didn&apos;t change the &lt;tt&gt;*NoConnection&lt;/tt&gt; tests.  It seems the only option here would be to downtune client timeout settings, which could get finicky.&lt;/p&gt;

&lt;p&gt;I verified again that introducing bugs in &lt;tt&gt;ZKDatabase&lt;/tt&gt; causes test failures, so the tests are still capable of catching regressions.&lt;/p&gt;

&lt;p&gt;Rakesh and Camille, what do you think of this version?  Thanks again for your guidance!&lt;/p&gt;</comment>
                            <comment id="14514960" author="hadoopqa" created="Mon, 27 Apr 2015 20:48:27 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12728495/ZOOKEEPER-2062.003.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12728495/ZOOKEEPER-2062.003.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1676359.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2652//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2652//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2652//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2652//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2652//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2652//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14515020" author="cnauroth" created="Mon, 27 Apr 2015 21:18:28 +0000"  >&lt;p&gt;I just spotted &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1274&quot; title=&quot;Support child watches to be displayed with 4 letter zookeeper commands (i.e. wchs, wchp and wchc)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1274&quot;&gt;&lt;del&gt;ZOOKEEPER-1274&lt;/del&gt;&lt;/a&gt; tracking an enhancement to include child watches in the watch reports for &lt;tt&gt;wchc&lt;/tt&gt; and &lt;tt&gt;wchp&lt;/tt&gt;.  I&apos;m linking the issues for the benefit of anyone who stumbles onto this conversation later.&lt;/p&gt;</comment>
                            <comment id="14519233" author="rakeshr" created="Wed, 29 Apr 2015 12:11:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for taking care this. Latest patch looks nice!&lt;/p&gt;

&lt;p&gt;For the &lt;tt&gt;testRemoveSingleWatcher&lt;/tt&gt; and &lt;tt&gt;testMultipleDataWatchers&lt;/tt&gt;. Its written to see any events triggered after the session closure. I think there is a space to improve this also. In these tests, &lt;tt&gt;assertFalse&lt;/tt&gt; is too costly and we could replace the &lt;tt&gt;assertFalse&lt;/tt&gt; statement like below and move them above &lt;tt&gt;zk1.close();&lt;/tt&gt; statement.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t remove data watcher&quot;&lt;/span&gt;, w1.matches());
        Assert.assertFalse(&lt;span class=&quot;code-quote&quot;&gt;&quot;Should have removed data watcher&quot;&lt;/span&gt;, w2.matches());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t find data watcher&quot;&lt;/span&gt;, 1, zk2.getDataWatches().size());
        Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t find data watcher&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;/node2&quot;&lt;/span&gt;, zk2.getDataWatches().get(0));
        removeWatches(zk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;/node2&quot;&lt;/span&gt;, w2, WatcherType.Any, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, Code.OK);
        Assert.assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Didn&apos;t remove data watcher&quot;&lt;/span&gt;, w2.matches());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14519696" author="cnauroth" created="Wed, 29 Apr 2015 16:42:51 +0000"  >&lt;p&gt;Thanks again, Rakesh.  Here is patch v004 incorporating your last suggestion.&lt;/p&gt;</comment>
                            <comment id="14519785" author="hadoopqa" created="Wed, 29 Apr 2015 17:33:33 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12729218/ZOOKEEPER-2062.004.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12729218/ZOOKEEPER-2062.004.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1676359.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2657//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2657//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2657//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2657//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2657//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2657//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14519804" author="cnauroth" created="Wed, 29 Apr 2015 17:40:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;-1 core tests. The patch failed core unit tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The test failure looks unrelated, since the patch changed only one test suite, and the failure is in a different test suite.&lt;/p&gt;

&lt;p&gt;There is a nice speed-up visible in that last Jenkins run!  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Before:&lt;br/&gt;
Tests run: 46, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 306.188 sec&lt;/p&gt;

&lt;p&gt;After:&lt;br/&gt;
Tests run: 46, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 54.075 sec&lt;/p&gt;</comment>
                            <comment id="14519817" author="rakeshr" created="Wed, 29 Apr 2015 17:45:37 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, Nice to see the tests passed in 53secs in the latest jenkins report. I could see only &lt;tt&gt;*NoConnection&lt;/tt&gt; tests are taking more time, but I&apos;m OK as these unit test cases depending on zookeeper client connection timeouts.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;testChRootRemoveWatcher[0]			86 ms	Passed
testChRootRemoveWatcher[1]			76 ms	Passed
testManyChildWatchers[0]			0.3 sec	Passed
testManyChildWatchers[1]			0.24 secPassed
testManyDataWatchers[0]				0.28 secPassed
testManyDataWatchers[1]				0.26 secPassed
testManyPreNodeWatchers[0]			0.21 secPassed
testManyPreNodeWatchers[1]			0.19 secPassed
testManyWatchersWhenNoConnection[0]		5.7 sec	Passed
testManyWatchersWhenNoConnection[1]		6.3 sec	Passed
testMultipleChildWatchers[0]			3 sec	Passed
testMultipleChildWatchers[1]			3 sec	Passed
testMultipleDataWatchers[0]			67 ms	Passed
testMultipleDataWatchers[1]			58 ms	Passed
testNoWatcherException[0]			79 ms	Passed
testNoWatcherException[1]			60 ms	Passed
testNoWatcherServerException[0]			58 ms	Passed
testNoWatcherServerException[1]			46 ms	Passed
testNullWatcherReference[0]			48 ms	Passed
testNullWatcherReference[1]			45 ms	Passed
testRemoveAllChildWatchers[0]			59 ms	Passed
testRemoveAllChildWatchers[1]			59 ms	Passed
testRemoveAllChildWatchesOnAPath[0]		50 ms	Passed
testRemoveAllChildWatchesOnAPath[1]		47 ms	Passed
testRemoveAllDataWatchers[0]			65 ms	Passed
testRemoveAllDataWatchers[1]			64 ms	Passed
testRemoveAllDataWatchesOnAPath[0]		55 ms	Passed
testRemoveAllDataWatchesOnAPath[1]		48 ms	Passed
testRemoveAllNoWatcherException[0]		55 ms	Passed
testRemoveAllNoWatcherException[1]		46 ms	Passed
testRemoveAllWatchers[0]			73 ms	Passed
testRemoveAllWatchers[1]			62 ms	Passed
testRemoveAllWatchesOnAPath[0]			55 ms	Passed
testRemoveAllWatchesOnAPath[1]			51 ms	Passed
testRemoveAnyChildWatcher[0]			62 ms	Passed
testRemoveAnyChildWatcher[1]			53 ms	Passed
testRemoveAnyDataWatcher[0]			66 ms	Passed
testRemoveAnyDataWatcher[1]			52 ms	Passed
testRemoveSingleWatcher[0]			0.36 secPassed
testRemoveSingleWatcher[1]			54 ms	Passed
testRemoveWatcherWhenNoConnection[0]		16 sec	Passed
testRemoveWatcherWhenNoConnection[1]		15 sec	Passed
testRemoveWhenMultipleChildWatchesOnAPath[0]	55 ms	Passed
testRemoveWhenMultipleChildWatchesOnAPath[1]	50 ms	Passed
testRemoveWhenMultipleDataWatchesOnAPath[0]	58 ms	Passed
testRemoveWhenMultipleDataWatchesOnAPath[1]	51 ms	Passed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;+1 latest patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="14527805" author="rakeshr" created="Tue, 5 May 2015 02:42:44 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; for the contribution!&lt;/p&gt;

&lt;p&gt;Committed to trunk : &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1677724&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1677724&lt;/a&gt;&lt;br/&gt;
Committed to br3.5 : &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1677726&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1677726&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14527873" author="cnauroth" created="Tue, 5 May 2015 04:18:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;, thank you for the helpful code review feedback and the commit!&lt;/p&gt;</comment>
                            <comment id="14528274" author="hudson" created="Tue, 5 May 2015 11:19:54 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2682 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2682/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2682/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2062&quot; title=&quot;RemoveWatchesTest takes forever to run&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2062&quot;&gt;&lt;del&gt;ZOOKEEPER-2062&lt;/del&gt;&lt;/a&gt; RemoveWatchesTest takes forever to run (Chris Nauroth via rakeshr) (rakeshr: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1677724&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1677724&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/zookeeper/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/zookeeper/trunk/src/java/test/org/apache/zookeeper/RemoveWatchesTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12529452">ZOOKEEPER-1274</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12728183" name="ZOOKEEPER-2062.001.patch" size="8415" author="cnauroth" created="Sat, 25 Apr 2015 23:52:05 +0000"/>
                            <attachment id="12728243" name="ZOOKEEPER-2062.002.patch" size="8313" author="cnauroth" created="Sun, 26 Apr 2015 17:50:40 +0000"/>
                            <attachment id="12728495" name="ZOOKEEPER-2062.003.patch" size="9996" author="cnauroth" created="Mon, 27 Apr 2015 19:50:34 +0000"/>
                            <attachment id="12729218" name="ZOOKEEPER-2062.004.patch" size="12133" author="cnauroth" created="Wed, 29 Apr 2015 16:42:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i216dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>