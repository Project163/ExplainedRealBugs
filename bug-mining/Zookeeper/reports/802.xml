<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:59:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2687] Deadlock while shutting down the Leader server.</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2687</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Leader server enters into deadlock while shutting down. This happens some time only.&lt;br/&gt;
The reason and deadlock flow is same as &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2380&quot; title=&quot;Deadlock between leader shutdown and forwarding ACK to the leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2380&quot;&gt;&lt;del&gt;ZOOKEEPER-2380&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
shutdown was removed from synchronized block in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2380&quot; title=&quot;Deadlock between leader shutdown and forwarding ACK to the leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2380&quot;&gt;&lt;del&gt;ZOOKEEPER-2380&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
Now shutdown is called from synchronized block from another place.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// check leader running status
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isRunning()) {
    shutdown(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected internal error&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13041293">ZOOKEEPER-2687</key>
            <summary>Deadlock while shutting down the Leader server.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arshad.mohammad">Mohammad Arshad</assignee>
                                    <reporter username="arshad.mohammad">Mohammad Arshad</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Feb 2017 07:19:58 +0000</created>
                <updated>Thu, 18 May 2017 03:43:58 +0000</updated>
                            <resolved>Wed, 15 Feb 2017 16:24:48 +0000</resolved>
                                    <version>3.5.2</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.5.3</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15859697" author="hadoopqa" created="Thu, 9 Feb 2017 15:56:57 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12851881/ZOOKEEPER-2687-01.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12851881/ZOOKEEPER-2687-01.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 434abbbb7eef271fab02306bcc9c8ad29ec2fe2e.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3576//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3576//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3576//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3576//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3576//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3576//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15864306" author="githubbot" created="Mon, 13 Feb 2017 19:51:54 +0000"  >&lt;p&gt;GitHub user arshadmohammad opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2687&quot; title=&quot;Deadlock while shutting down the Leader server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2687&quot;&gt;&lt;del&gt;ZOOKEEPER-2687&lt;/del&gt;&lt;/a&gt;:Deadlock while shutting down the Leader server.&lt;/p&gt;

&lt;p&gt;    Leader server enters into deadlock while shutting down itself. Shutdown of the leader server is called from the synchronized block which must be called from outside the synchronized block. For detail pls refer &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2380&quot; title=&quot;Deadlock between leader shutdown and forwarding ACK to the leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2380&quot;&gt;&lt;del&gt;ZOOKEEPER-2380&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/arshadmohammad/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/arshadmohammad/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2687&quot; title=&quot;Deadlock while shutting down the Leader server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2687&quot;&gt;&lt;del&gt;ZOOKEEPER-2687&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #176&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1e3ed70b281e1afc9adc6a8c8ea72bef5b9c25e8&lt;br/&gt;
Author: Mohammad Arshad &amp;lt;arshad@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-02-13T19:48:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2687&quot; title=&quot;Deadlock while shutting down the Leader server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2687&quot;&gt;&lt;del&gt;ZOOKEEPER-2687&lt;/del&gt;&lt;/a&gt;:Deadlock while shutting down the Leader server.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15864317" author="githubbot" created="Mon, 13 Feb 2017 19:55:26 +0000"  >&lt;p&gt;Github user arshadmohammad commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    There is not test case, as the change is very simple and understandable and the test will complicate the overall fix.&lt;/p&gt;</comment>
                            <comment id="15865369" author="arshad.mohammad" created="Tue, 14 Feb 2017 08:41:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; can you please have a look on the proposed change as you are most familiar with the related defect &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2380&quot; title=&quot;Deadlock between leader shutdown and forwarding ACK to the leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2380&quot;&gt;&lt;del&gt;ZOOKEEPER-2380&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15866851" author="githubbot" created="Tue, 14 Feb 2017 22:40:43 +0000"  >&lt;p&gt;Github user afine commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 lgtm&lt;/p&gt;

&lt;p&gt;    looked through he code and i did not see any other places where this particular deadlock occurs&lt;/p&gt;</comment>
                            <comment id="15867686" author="githubbot" created="Wed, 15 Feb 2017 11:44:38 +0000"  >&lt;p&gt;Github user rakeshadr commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176#discussion_r101259308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176#discussion_r101259308&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Leader.java &amp;#8212;&lt;br/&gt;
    @@ -590,8 +590,8 @@ void lead() throws IOException, InterruptedException {&lt;/p&gt;

&lt;p&gt;                         // check leader running status&lt;br/&gt;
                         if (!this.isRunning()) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown(&quot;Unexpected internal error&quot;);&lt;/li&gt;
	&lt;li&gt;return;&lt;br/&gt;
    +                        shutdownMessage = &quot;Unexpected internal error&quot;;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Good catch @arshadmohammad. Yes, this is another code where it can leads to deadlock similar to ZK-2380. &lt;/p&gt;

&lt;p&gt;    As we know, `shutdownMessage` is acting as flag. Could you please add comments to make this clear,&lt;br/&gt;
    `// set shutdown flag`&lt;br/&gt;
    `shutdownMessage` = &quot;Unexpected internal error&quot;;`&lt;/p&gt;</comment>
                            <comment id="15868111" author="githubbot" created="Wed, 15 Feb 2017 16:16:40 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 LGTM, I will merge this to branch-3.5 and master shortly.&lt;/p&gt;</comment>
                            <comment id="15868121" author="githubbot" created="Wed, 15 Feb 2017 16:23:57 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15868122" author="rakeshr" created="Wed, 15 Feb 2017 16:24:48 +0000"  >&lt;p&gt;Issue resolved by pull request 176&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/176&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15868127" author="rakeshr" created="Wed, 15 Feb 2017 16:28:52 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; for the contribution. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abrahamfine&quot; class=&quot;user-hover&quot; rel=&quot;abrahamfine&quot;&gt;abrahamfine&lt;/a&gt; for the reviews.&lt;/p&gt;

&lt;p&gt;Merged to branch-3.5 : &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=zookeeper.git;a=commit;h=f07a836e3e24e9b643fecf0c0cfca3d7dbc60859&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=zookeeper.git;a=commit;h=f07a836e3e24e9b643fecf0c0cfca3d7dbc60859&lt;/a&gt;&lt;br/&gt;
Merged to master : &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=zookeeper.git;a=commit;h=fd211a5275b6231e668268fb9df2820e07f5f33c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=zookeeper.git;a=commit;h=fd211a5275b6231e668268fb9df2820e07f5f33c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15868196" author="hudson" created="Wed, 15 Feb 2017 17:15:30 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #3281 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3281/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3281/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2687&quot; title=&quot;Deadlock while shutting down the Leader server.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2687&quot;&gt;&lt;del&gt;ZOOKEEPER-2687&lt;/del&gt;&lt;/a&gt;: Deadlock while shutting down the Leader server (rakeshr: rev fd211a5275b6231e668268fb9df2820e07f5f33c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12851881" name="ZOOKEEPER-2687-01.patch" size="765" author="arshad.mohammad" created="Thu, 9 Feb 2017 15:34:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39rz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>