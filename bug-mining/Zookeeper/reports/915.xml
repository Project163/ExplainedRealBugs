<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3113] EphemeralType.get() fails to verify ephemeralOwner when currentElapsedTime() is small enough</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3113</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;EphemeralTypeTest.testServerIds() unit test fails on some systems that System.nanoTime() is smaller than a certain value.&lt;/p&gt;

&lt;p&gt;The test&#160;generates ephemeralOwner in the old way (pre &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; title=&quot;Session ID that is negative causes mis-calculation of Ephemeral Type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2901&quot;&gt;&lt;del&gt;ZOOKEEPER-2901&lt;/del&gt;&lt;/a&gt;) without enabling the emulation flag and asserts for exception to be thrown when serverId == 255. This is right. ZooKeeper should fail on this case, because serverId cannot be larger than 254 if extended types are enabled. In this case ephemeralOwner&#160;with 0xff in the most significant byte indicates an extended type.&lt;/p&gt;

&lt;p&gt;The logic which does the validation is in EphemeralType.get().&lt;/p&gt;

&lt;p&gt;It checks 2 things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the extended type byte is set: 0xff,&lt;/li&gt;
	&lt;li&gt;reserved bits (next 2 bytes) corresponds to a valid extended type.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is the problem: currently we only have 1 extended type: TTL with value of 0x0000 in the reserved bits.&lt;/p&gt;

&lt;p&gt;Logic expects that if we have anything different from it in the reserved bits, the ephemeralOwner is invalid and exception should be thrown. That&apos;s what the test asserts for and it works on most systems, because the timestamp part of the sessionId usually have some bits in the reserved bits as well which eventually will be larger than 0, so the value is unsupported.&lt;/p&gt;

&lt;p&gt;I think the problem is twofold:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Either if we have more extended types, we&apos;ll increase the possibility that this logic will accept invalid sessionIds (as long as reserved bits indicate a valid extended type),&lt;/li&gt;
	&lt;li&gt;Or (which happens on some systems) if the currentElapsedTime (timestamp part of sessionId) is small enough and doesn&apos;t occupy reserved bits, this logic will accept the invalid sessionId.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unfortunately I cannot repro the problem yet: it constantly happens on a specific Jenkins slave, but even with the same distro and same JDK version I cannot reproduce the same nanoTime() values.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13177431">ZOOKEEPER-3113</key>
            <summary>EphemeralType.get() fails to verify ephemeralOwner when currentElapsedTime() is small enough</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andor">Andor Molnar</assignee>
                                    <reporter username="andor">Andor Molnar</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>ttl_nodes</label>
                    </labels>
                <created>Tue, 7 Aug 2018 14:58:13 +0000</created>
                <updated>Fri, 4 Oct 2019 14:55:12 +0000</updated>
                            <resolved>Thu, 18 Oct 2018 09:19:01 +0000</resolved>
                                    <version>3.5.4</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.5</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="16200">4.5h</timespent>
                                <comments>
                            <comment id="16571795" author="andorm" created="Tue, 7 Aug 2018 14:58:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=randgalt&quot; class=&quot;user-hover&quot; rel=&quot;randgalt&quot;&gt;randgalt&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I believe you guys are interested in this.&lt;/p&gt;</comment>
                            <comment id="16571830" author="andorm" created="Tue, 7 Aug 2018 15:19:48 +0000"  >&lt;p&gt;Finally I&apos;ve managed to repro the issue:&lt;/p&gt;

&lt;p&gt;System.nanoTime() is calculated from system uptime, so the bug occurs with freshly booted machines as long as the value is small enough.&lt;/p&gt;</comment>
                            <comment id="16585130" author="maoling" created="Sun, 19 Aug 2018 11:54:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;yes.the Jenkins has complained about this&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/ZooKeeper_branch35_jdk8/1033/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper_branch35_jdk8/1033/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16654912" author="andorm" created="Thu, 18 Oct 2018 09:19:01 +0000"  >&lt;p&gt;Issue resolved by pull request 651&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/651&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16655059" author="hudson" created="Thu, 18 Oct 2018 11:10:19 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #23 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/23/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/23/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3113&quot; title=&quot;EphemeralType.get() fails to verify ephemeralOwner when currentElapsedTime() is small enough&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3113&quot;&gt;&lt;del&gt;ZOOKEEPER-3113&lt;/del&gt;&lt;/a&gt;: EphemeralType.get() fails to verify ephemeralOwner when (andor: rev 5c85a236c9eb0805ea8389a52dab3b1bc0efadac)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/Emulate353TTLTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/EphemeralTypeTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16655504" author="hudson" created="Thu, 18 Oct 2018 16:12:47 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #238 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/238/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/238/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3113&quot; title=&quot;EphemeralType.get() fails to verify ephemeralOwner when currentElapsedTime() is small enough&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3113&quot;&gt;&lt;del&gt;ZOOKEEPER-3113&lt;/del&gt;&lt;/a&gt;: EphemeralType.get() fails to verify ephemeralOwner when (andor: rev 5c85a236c9eb0805ea8389a52dab3b1bc0efadac)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/EphemeralTypeTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/Emulate353TTLTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wscf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>