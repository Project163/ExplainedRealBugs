<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:05:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4293] Lock Contention in ClientCnxnSocketNetty (possible deadlock)</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4293</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We have encountered a scenario where a `ClientCnxn#SendThread` has become blocked in `ClientCnxnSocketNetty#cleanup` in the call to `channel.close().syncUninterruptibly()`. As the `syncUninterruptibly` method blocks, processing in the `epollEventLoopGroup` thread for the same client is unable to obtain the lock in the listener associated with the client (line 151 in v3.5.8) and application threads using the `ZooKeeperAdmin` containing the `ClientCnxn` themselves become blocked on the same lock when attempting to close the client.&lt;/p&gt;

&lt;p&gt;The thread dump for the situation is attached, with the three interesting threads/stacks inlined below. Each occurrence lists three threads as it occurred to three clients simultaneously. &lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;SendThread&quot;&gt;&lt;/a&gt;SendThread&lt;/h2&gt;
&lt;ul&gt;
	&lt;li&gt;vert.x-eventloop-thread-0-SendThread(foo-0xtq07v5viyjxv8-zookeeper-0.foo-0xtq07v5viyjxv8-zookeeper-nodes.foo-0xtq07v5viyjxv8.svc:2181) awaiting notification , holding [ 0x00000000f6b5fdd0 ]&lt;/li&gt;
	&lt;li&gt;vert.x-eventloop-thread-0-SendThread(foo-lgr9apuzr7ngznmd-zookeeper-2.foo-lgr9apuzr7ngznmd-zookeeper-nodes.foo-lgr9apuzr7ngznmd.svc:2181) awaiting notification , holding [ 0x00000000f6b8e5c0 ]&lt;/li&gt;
	&lt;li&gt;vert.x-eventloop-thread-0-SendThread(foo-tukt40lcdodsux6n-zookeeper-1.foo-tukt40lcdodsux6n-zookeeper-nodes.foo-tukt40lcdodsux6n.svc:2181) awaiting notification , holding [ 0x00000000f6b9d5a0 ] 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(java.base@11.0.11/Native Method)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(java.base@11.0.11/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:328)
at io.netty.util.concurrent.DefaultPromise.awaitUninterruptibly(DefaultPromise.java:275)
at io.netty.channel.DefaultChannelPromise.awaitUninterruptibly(DefaultChannelPromise.java:137)
at io.netty.channel.DefaultChannelPromise.awaitUninterruptibly(DefaultChannelPromise.java:30)
at io.netty.util.concurrent.DefaultPromise.syncUninterruptibly(DefaultPromise.java:411)
at io.netty.channel.DefaultChannelPromise.syncUninterruptibly(DefaultChannelPromise.java:125)
at io.netty.channel.DefaultChannelPromise.syncUninterruptibly(DefaultChannelPromise.java:30)
at org.apache.zookeeper.ClientCnxnSocketNetty.cleanup(ClientCnxnSocketNetty.java:212)
at org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1338)
at org.apache.zookeeper.ClientCnxn$SendThread.cleanAndNotifyState(ClientCnxn.java:1276)
at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1254)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;epollEventLoopGroup&quot;&gt;&lt;/a&gt;epollEventLoopGroup&lt;/h2&gt;
&lt;ul&gt;
	&lt;li&gt;epollEventLoopGroup-11-1 awaiting notification on [ 0x00000000f6b8e5c0 ]&lt;/li&gt;
	&lt;li&gt;epollEventLoopGroup-19-1 awaiting notification on [ 0x00000000f6b9d5a0 ]&lt;/li&gt;
	&lt;li&gt;epollEventLoopGroup-2-1 awaiting notification on [ 0x00000000f6b5fdd0 ] 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at jdk.internal.misc.Unsafe.park(java.base@11.0.11/Native Method)
at java.util.concurrent.locks.LockSupport.park(java.base@11.0.11/LockSupport.java:194)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(java.base@11.0.11/AbstractQueuedSynchronizer.java:885)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(java.base@11.0.11/AbstractQueuedSynchronizer.java:917)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@11.0.11/AbstractQueuedSynchronizer.java:1240)
at java.util.concurrent.locks.ReentrantLock.lock(java.base@11.0.11/ReentrantLock.java:267)
at org.apache.zookeeper.ClientCnxnSocketNetty$1.operationComplete(ClientCnxnSocketNetty.java:151)
at org.apache.zookeeper.ClientCnxnSocketNetty$1.operationComplete(ClientCnxnSocketNetty.java:146)
at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:578)
at io.netty.util.concurrent.DefaultPromise.notifyListeners0(DefaultPromise.java:571)
at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:550)
at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:491)
at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:616)
at io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:605)
at io.netty.util.concurrent.DefaultPromise.trySuccess(DefaultPromise.java:104)
at io.netty.channel.DefaultChannelPromise.trySuccess(DefaultChannelPromise.java:84)
at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.fulfillConnectPromise(AbstractEpollChannel.java:653)
at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.finishConnect(AbstractEpollChannel.java:691)
at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.epollOutReady(AbstractEpollChannel.java:567)
at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:470)
at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)
at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)
at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@11.0.11/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;vert.xworkerthread%28applicationthread%29&quot;&gt;&lt;/a&gt;vert.x-worker-thread (application thread)&lt;/h2&gt;
&lt;ul&gt;
	&lt;li&gt;vert.x-worker-thread-16 awaiting notification on [ 0x00000000f6b8e5c0 ] , holding [ 0x00000000f6b8d148 0x00000000f6b76870 ]&lt;/li&gt;
	&lt;li&gt;vert.x-worker-thread-19 awaiting notification on [ 0x00000000f6b9d5a0 ] , holding [    0x00000000f6b9b4c8 0x00000000f6b76df8 ]&lt;/li&gt;
	&lt;li&gt;vert.x-worker-thread-4 awaiting notification on [ 0x00000000f6b5fdd0 ] , holding [    0x00000000f6b5ab08 0x00000000f6b43a98 ] 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at jdk.internal.misc.Unsafe.park(java.base@11.0.11/Native Method)
at java.util.concurrent.locks.LockSupport.park(java.base@11.0.11/LockSupport.java:194)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(java.base@11.0.11/AbstractQueuedSynchronizer.java:885)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(java.base@11.0.11/AbstractQueuedSynchronizer.java:917)
at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(java.base@11.0.11/AbstractQueuedSynchronizer.java:1240)
at java.util.concurrent.locks.ReentrantLock.lock(java.base@11.0.11/ReentrantLock.java:267)
at org.apache.zookeeper.ClientCnxnSocketNetty.cleanup(ClientCnxnSocketNetty.java:205)
at org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1338)
at org.apache.zookeeper.ClientCnxn$SendThread.cleanAndNotifyState(ClientCnxn.java:1276)
at org.apache.zookeeper.ClientCnxn$SendThread.access$2800(ClientCnxn.java:805)
at org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1534)
at org.apache.zookeeper.ClientCnxn.submitRequest(ClientCnxn.java:1512)
at org.apache.zookeeper.ClientCnxn.close(ClientCnxn.java:1481)
at org.apache.zookeeper.ZooKeeper.close(ZooKeeper.java:1415)
at org.apache.zookeeper.ZooKeeper.close(ZooKeeper.java:1437)
at io.strimzi.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.cluster.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.resource.ZookeeperScaler.lambda$closeConnection$10(ZookeeperScaler.java:244)
at io.strimzi.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.cluster.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;.resource.ZookeeperScaler$$Lambda$501/0x0000000840629840.handle(Unknown Source)
at io.vertx.core.impl.ContextImpl.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$0(ContextImpl.java:179)
at io.vertx.core.impl.ContextImpl$$Lambda$208/0x00000008402ea440.handle(Unknown Source)
at io.vertx.core.impl.AbstractContext.dispatch(AbstractContext.java:96)
at io.vertx.core.impl.ContextImpl.lambda$executeBlocking$1(ContextImpl.java:177)
at io.vertx.core.impl.ContextImpl$$Lambda$205/0x00000008402e9040.run(Unknown Source)
at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@11.0.11/ThreadPoolExecutor.java:1128)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@11.0.11/ThreadPoolExecutor.java:628)
at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@11.0.11/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13377936">ZOOKEEPER-4293</key>
            <summary>Lock Contention in ClientCnxnSocketNetty (possible deadlock)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="michael.edgar">Michael Edgar</assignee>
                                    <reporter username="michael.edgar">Michael Edgar</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 11 May 2021 18:13:11 +0000</created>
                <updated>Wed, 30 Jul 2025 18:44:06 +0000</updated>
                            <resolved>Thu, 19 Sep 2024 19:33:16 +0000</resolved>
                                    <version>3.5.8</version>
                                    <fixVersion>3.10.0</fixVersion>
                    <fixVersion>3.8.5</fixVersion>
                    <fixVersion>3.9.3</fixVersion>
                                    <component>java client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="22800">6h 20m</timespent>
                                <comments>
                            <comment id="17360499" author="changrui lin" created="Thu, 10 Jun 2021 02:26:50 +0000"  >&lt;p&gt;Any idea about this issue? We have reproduced this bug many times, and almost every time it reproduces with an artificial network failure. The specific command is &apos;tc qdisc add dev eth0 root netem delay 8s&apos;.&lt;/p&gt;

&lt;p&gt;The stack dump is as same as Michael&apos;s. It looks like epollEventLoopGroup is blocked by SendThread, and SendThread can&apos;t finish from cleanup.&lt;/p&gt;

&lt;p&gt;I&apos;m not very familiar with netty, but here is my suspect. EpollEventGroupLoop should handle the &apos;channel.cleanup&apos; of SendThread in an event queue somewhere, but it is blocked to acquire the connectLock during it is handling the event &apos;connect.operationComplete&apos;, and the connectLock is held by the &apos;channel.cleanup&apos; which cannot be completed. I guess it happened because of the network delay. The future of channel.connect is called after this channle is closed.&lt;/p&gt;

&lt;p&gt;If my guess is incorrect, I hope you can point out. This bug is really serious and it affects the normal use of the service. I hope it can be resolved ASAP. Thank you!&lt;/p&gt;</comment>
                            <comment id="17360842" author="michael.edgar" created="Thu, 10 Jun 2021 12:23:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Changrui+Lin&quot; class=&quot;user-hover&quot; rel=&quot;Changrui Lin&quot;&gt;Changrui Lin&lt;/a&gt; - can you share more information about your setup to reproduce this situation?&lt;/p&gt;</comment>
                            <comment id="17361420" author="changrui lin" created="Fri, 11 Jun 2021 05:52:46 +0000"  >&lt;p&gt;Hi Michael,&lt;br/&gt;
I&#8217;m not very sure that it can be reproduced with this scenario , but you can have a try.&lt;br/&gt;
We use zk3.6.2 and CentOS. We have a three servers cluster and setup zk on it. Our client is also on these three servers. &lt;br/&gt;
When the zk service is running normally, set one server network delay. The specific command is &#8216;tc qdisc add dev $networkName root netem delay 8s&#8217; (zk sessionTimeout 6s). After doing that, the blocking will occur probably when the client call any ZooKeeper function, such as &apos;new ZooKeeper()&apos;, &apos;zk.exists&apos;, &apos;zk.setData&apos; or watch callback.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13575362">ZOOKEEPER-4824</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13025331" name="strimzi-jstack-1620755249.log" size="123776" author="michael.edgar" created="Tue, 11 May 2021 18:02:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qy0w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>