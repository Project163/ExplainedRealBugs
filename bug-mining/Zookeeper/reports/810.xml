<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:59:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2743] Netty connection leaks JMX connection bean upon connection close in certain race conditions.</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2743</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;This is a tricky issue found while debugging failure of &quot;flaky&quot; watcher test (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2686&quot; title=&quot;Flaky Test: org.apache.zookeeper.test.WatcherTest.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2686&quot;&gt;&lt;del&gt;ZOOKEEPER-2686&lt;/del&gt;&lt;/a&gt;). When closing a Netty connection, depend on timing the connection bean registered when the connection was provisioned might not get unregistered, leading to leaked Java beans. &lt;/p&gt;

&lt;p&gt;The race happens at the time when the client is in the process of finalizing the session. As part of session finalization, a connection bean will be registered &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. But right before the registering bean, the connection might gets closed, in cases for example the server that the client is connecting to is shutdown. As part of connection close, the bean will be un-registered, as expected &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, however the problem is when we execute at &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, the connection bean might not finish registering at &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, so the unregister of bean is a NOP. What&apos;s worse, as part of connection close, we remove this connection from connection factory &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, so future connection close call will get short circuited and directly return; in other words the bean unregister code in connection close call will only get executed once. Depends on luck, the bean might not get unregistered, as previously illustrated.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L700&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java#L114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java#L114&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java#L96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java#L96&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13060932">ZOOKEEPER-2743</key>
            <summary>Netty connection leaks JMX connection bean upon connection close in certain race conditions.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hanm">Michael Han</assignee>
                                    <reporter username="hanm">Michael Han</reporter>
                        <labels>
                            <label>netty</label>
                    </labels>
                <created>Sat, 1 Apr 2017 20:30:47 +0000</created>
                <updated>Mon, 17 Apr 2017 23:44:45 +0000</updated>
                            <resolved>Mon, 10 Apr 2017 17:20:14 +0000</resolved>
                                    <version>3.4.10</version>
                    <version>3.5.2</version>
                                    <fixVersion>3.4.11</fixVersion>
                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15952406" author="githubbot" created="Sat, 1 Apr 2017 20:59:28 +0000"  >&lt;p&gt;GitHub user hanm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;: Netty connection leaks JMX connection bean.&lt;/p&gt;

&lt;p&gt;    See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&lt;/a&gt; for details on the symptom and diagnostic.&lt;/p&gt;

&lt;p&gt;    There are many ways of fixing this. For example we can enforce certain ordering of the close operations to eliminate the race condition however that would incur non trivial performance penalty as a result of synchronization. I think the solution in this patch is simple and effective as it observes that the bean unregister call is idempotent and the call itself is trivial so we just always unregister connection upon close the connection, to ensure the bean is unregistered regardless of the races.&lt;/p&gt;

&lt;p&gt;    I&apos;ve also stress tested this solution on internal Jenkins which indicates no failures of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2707&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2707&lt;/a&gt; for the past two days.&lt;/p&gt;

&lt;p&gt;    A side note is NIO connection in theory would suffer the same problem however I am unable to reproduce the same racing with existing unit test. So I just leave NIO as it is, for now.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hanm/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanm/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #211&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7dd916c4c7c8d4e0e83cb5780175058a5626de19&lt;br/&gt;
Author: Michael Han &amp;lt;hanm@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-04-01T20:37:48Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;: Netty connection leaks JMX connection bean upon connection close in certain race conditions.&lt;br/&gt;
    Always unregister connection upon close to prevent connection bean leak under certain race conditions.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15952424" author="hadoopqa" created="Sat, 1 Apr 2017 21:18:36 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +0 tests included.  The patch appears to be a documentation patch that doesn&apos;t require tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/496//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/496//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/496//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/496//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/496//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/496//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15958303" author="githubbot" created="Thu, 6 Apr 2017 05:15:04 +0000"  >&lt;p&gt;Github user rakeshadr commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211#discussion_r110080170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211#discussion_r110080170&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java &amp;#8212;&lt;br/&gt;
    @@ -87,6 +87,12 @@ public void close() &lt;/p&gt;
{
                 LOG.debug(&quot;close called for sessionid:0x&quot;
                         + Long.toHexString(sessionId));
             }
&lt;p&gt;    +&lt;br/&gt;
    +        // &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
    +        // Always unregister connection upon close to prevent&lt;br/&gt;
    +        // connection bean leak under certain race conditions.&lt;br/&gt;
    +        factory.unregisterConnection(this);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Any chance to occur another race condition, &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; session finalization is in progress &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; client cnxn closure due to server shutdown. Assume &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; step is in progress and not yet registered the connection bean &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; step is in progress and as per this patch unregistered bean irrespective of cnxn exists in factory and returns. Again assume now, &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; step continues and registering the connection bean. This is again leaking the cnxn bean, right?&lt;/p&gt;</comment>
                            <comment id="15958313" author="githubbot" created="Thu, 6 Apr 2017 05:35:23 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211#discussion_r110081828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211#discussion_r110081828&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java &amp;#8212;&lt;br/&gt;
    @@ -87,6 +87,12 @@ public void close() &lt;/p&gt;
{
                 LOG.debug(&quot;close called for sessionid:0x&quot;
                         + Long.toHexString(sessionId));
             }
&lt;p&gt;    +&lt;br/&gt;
    +        // &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
    +        // Always unregister connection upon close to prevent&lt;br/&gt;
    +        // connection bean leak under certain race conditions.&lt;br/&gt;
    +        factory.unregisterConnection(this);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    That is fine, I might able to provide a formal verification of the theorem but here is a quick prove of that case:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Assume close is called before connection bean is registered &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;The unregister bean in close call is no-op because the bean is not registered. But the channel will be closed, as part of close call.&lt;/li&gt;
	&lt;li&gt;Now before finalizing session returns, some sort of exception is going to throw, because the channel is closed. Probably here &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/li&gt;
	&lt;li&gt;As part of exception the close is called again. This time it will unregister the bean (before this fix it will not, so it will miss this edge case.).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Basically we are safe as close will be called multiple times and guaranteed at least one close call will happen after cnx bean is registered. &lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L699&lt;/a&gt;&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;br/&gt;
    &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L716&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L716&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15958322" author="githubbot" created="Thu, 6 Apr 2017 05:39:51 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211#discussion_r110082136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211#discussion_r110082136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java &amp;#8212;&lt;br/&gt;
    @@ -87,6 +87,12 @@ public void close() &lt;/p&gt;
{
                 LOG.debug(&quot;close called for sessionid:0x&quot;
                         + Long.toHexString(sessionId));
             }
&lt;p&gt;    +&lt;br/&gt;
    +        // &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
    +        // Always unregister connection upon close to prevent&lt;br/&gt;
    +        // connection bean leak under certain race conditions.&lt;br/&gt;
    +        factory.unregisterConnection(this);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Also it is guaranteed that the close call will be called at least once after the cnx bean is registered (e.g. when sever shutdown, the factor will iterate every cnx and close it..).&lt;/p&gt;</comment>
                            <comment id="15963117" author="githubbot" created="Mon, 10 Apr 2017 16:30:19 +0000"  >&lt;p&gt;Github user rakeshadr commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211#discussion_r110702056&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211#discussion_r110702056&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java &amp;#8212;&lt;br/&gt;
    @@ -87,6 +87,12 @@ public void close() &lt;/p&gt;
{
                 LOG.debug(&quot;close called for sessionid:0x&quot;
                         + Long.toHexString(sessionId));
             }
&lt;p&gt;    +&lt;br/&gt;
    +        // &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
    +        // Always unregister connection upon close to prevent&lt;br/&gt;
    +        // connection bean leak under certain race conditions.&lt;br/&gt;
    +        factory.unregisterConnection(this);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Agreed Michael. I&apos;ve noticed `NIOServerCnxnFactory#removeCnxn()` execution path, we should correct this part as well, like you mentioned in the PR comment. Could you please raise a new jira to track the  changes.&lt;/p&gt;

&lt;p&gt;    +1 the netty code changes looks good to me.&lt;/p&gt;</comment>
                            <comment id="15963209" author="githubbot" created="Mon, 10 Apr 2017 17:14:21 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211#discussion_r110711280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211#discussion_r110711280&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java &amp;#8212;&lt;br/&gt;
    @@ -87,6 +87,12 @@ public void close() &lt;/p&gt;
{
                 LOG.debug(&quot;close called for sessionid:0x&quot;
                         + Long.toHexString(sessionId));
             }
&lt;p&gt;    +&lt;br/&gt;
    +        // &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
    +        // Always unregister connection upon close to prevent&lt;br/&gt;
    +        // connection bean leak under certain race conditions.&lt;br/&gt;
    +        factory.unregisterConnection(this);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &amp;gt;&amp;gt; Could you please raise a new jira to track the changes.&lt;/p&gt;

&lt;p&gt;    Created &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2751&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2751&lt;/a&gt; for this. Merging this PR now.&lt;/p&gt;</comment>
                            <comment id="15963217" author="githubbot" created="Mon, 10 Apr 2017 17:19:46 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15963219" author="hanm" created="Mon, 10 Apr 2017 17:20:14 +0000"  >&lt;p&gt;Issue resolved by pull request 211&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/211&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15963297" author="hudson" created="Mon, 10 Apr 2017 18:27:35 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #3350 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3350/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3350/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2743&quot; title=&quot;Netty connection leaks JMX connection bean upon connection close in certain race conditions.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2743&quot;&gt;&lt;del&gt;ZOOKEEPER-2743&lt;/del&gt;&lt;/a&gt;: Netty connection leaks JMX connection bean. (hanm: rev b3ef40bffe49c1e42aee23a600a775194f36bca0)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13062949">ZOOKEEPER-2751</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13045779">ZOOKEEPER-2707</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3d3l3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>