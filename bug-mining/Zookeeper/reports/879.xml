<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2901] Session ID that is negative causes mis-calculation of Ephemeral Type</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2901</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In the code that determines the EphemeralType it is looking at the owner (which is the client ID or connection ID):&lt;/p&gt;

&lt;p&gt;EphemeralType.java:&lt;/p&gt;

&lt;p&gt;   public static EphemeralType get(long ephemeralOwner) {&lt;br/&gt;
       if (ephemeralOwner == CONTAINER_EPHEMERAL_OWNER) &lt;/p&gt;
{
           return CONTAINER;
       }
&lt;p&gt;       if (ephemeralOwner &amp;lt; 0) &lt;/p&gt;
{
           return TTL;
       }
&lt;p&gt;       return (ephemeralOwner == 0) ? VOID : NORMAL;&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;However my connection ID is:&lt;/p&gt;

&lt;p&gt;header.getClientId(): -720548323429908480&lt;/p&gt;

&lt;p&gt;This causes the code to think this is a TTL Ephemeral node instead of a&lt;br/&gt;
NORMAL Ephemeral node.&lt;/p&gt;

&lt;p&gt;This also explains why this is random - if my client ID is non-negative&lt;br/&gt;
then the node gets added correctly.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Running 3.5.3-beta in Docker container&lt;/p&gt;</environment>
        <key id="13103695">ZOOKEEPER-2901</key>
            <summary>Session ID that is negative causes mis-calculation of Ephemeral Type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="randgalt">Jordan Zimmerman</assignee>
                                    <reporter username="mjohnson207">Mark Johnson</reporter>
                        <labels>
                            <label>ttl_nodes</label>
                    </labels>
                <created>Wed, 20 Sep 2017 18:54:16 +0000</created>
                <updated>Mon, 21 Jan 2019 14:52:39 +0000</updated>
                            <resolved>Wed, 9 May 2018 22:12:54 +0000</resolved>
                                    <version>3.5.3</version>
                                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                                                                        <aggregatetimeremainingestimate seconds="0">0h</aggregatetimeremainingestimate>
                                        <aggregatetimespent seconds="1800">0.5h</aggregatetimespent>
                                    <comments>
                            <comment id="16173704" author="randgalt" created="Wed, 20 Sep 2017 19:15:29 +0000"  >&lt;p&gt;The &quot;client&quot; ID is the same as the session ID. The session ID is an incrementing number. However, it appears that the &quot;High order byte is serverId&quot;. Holy cow! How did this get by? This is major.&lt;/p&gt;</comment>
                            <comment id="16173758" author="randgalt" created="Wed, 20 Sep 2017 20:08:36 +0000"  >&lt;p&gt;There are a number of possibilities to address this:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Remove the feature completely&lt;/li&gt;
	&lt;li&gt;Quick fix now, larger fix later&lt;/li&gt;
	&lt;li&gt;Find another way to denote container/TTL&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem is that ServerIDs &amp;gt; 63 will now appear to be TTL nodes (server IDs &amp;gt;= 255 will appear to be container nodes). &lt;/p&gt;

&lt;p&gt;Commentary:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Remove the Feature completely&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t see how we can do this without breaking existing clients. Even if we remove TTLs, Container nodes have been out there for over a year (or more?). Container nodes has the same problem.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Quick fix now, larger fix later&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The quick fix is to mask the 2 high bits of the Server ID when seeding the session ID. This has major implications for how the ServerID is chosen. But, this is beyond my knowledge. The way the Server ID is/was stored prior to TTL/Container nodes implied that the ServerID had to have unique bits across the ensemble. I need other committers to comment on this. To be clear, this is the change:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// in SessionTrackerImpl#initializeNextSession()
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; initializeNextSession(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; id) {
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; nextSid;
        nextSid = (Time.currentElapsedTime() &amp;lt;&amp;lt; 24) &amp;gt;&amp;gt;&amp;gt; 8;
        nextSid =  nextSid | (id &amp;lt;&amp;lt;56);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; EphemeralType.maskSessionId(nextSid);
    }

&lt;span class=&quot;code-comment&quot;&gt;// in EphemeralType
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; EPHEMERAL_MASK = 0x3FFFFFFFFFFFFFFFL;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; maskSessionId(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; id) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; id &amp;amp; EPHEMERAL_MASK;
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;em&gt;Find another way to denote container/TTL&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I need ideas here. Not sure how to handle this in a backward compatible way.&lt;/p&gt;</comment>
                            <comment id="16173780" author="mjohnson207" created="Wed, 20 Sep 2017 20:29:20 +0000"  >&lt;p&gt;I&apos;m probably not qualified to comment on this but does the server ID need to be embedded in the session ID?  If so, then how about using only 4 bytes from the timestamp instead of 5?  Then move the server ID over 1 byte.  Maybe:&lt;/p&gt;

&lt;p&gt;    public static long initializeNextSession(long id) &lt;/p&gt;
{
        long nextSid;
        nextSid = (Time.currentElapsedTime() &amp;lt;&amp;lt; 28) &amp;gt;&amp;gt;&amp;gt; 16;
        nextSid =  nextSid | (id &amp;lt;&amp;lt;52);
        return nextSid;
    }</comment>
                            <comment id="16174792" author="randgalt" created="Thu, 21 Sep 2017 13:57:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjohnson207&quot; class=&quot;user-hover&quot; rel=&quot;mjohnson207&quot;&gt;mjohnson207&lt;/a&gt; - I think that can work. The hard part is deciding what to do about existing sessions when the new server loads. I think the only choice is to somehow invalidate those sessions. We need to do this because of this code in LeaderSessionTracker.java - which I don&apos;t understand TBH&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        /*
         * &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; local session is not enabled or it used to be our local session
         * &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; sessions expires
         */
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!localSessionsEnabled
                || (getServerIdFromSessionId(sessionId) == serverId)) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SessionExpiredException();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s the only place in the code where the ServerId from the session ID is used.&lt;/p&gt;</comment>
                            <comment id="16175282" author="randgalt" created="Thu, 21 Sep 2017 18:55:06 +0000"  >&lt;p&gt;Update: I believe I have a mechanism to identify pre 3.5.4 files without changing &lt;tt&gt;FileTxnLog.VERSION&lt;/tt&gt;. Every file (snapshot and transaction) has a header that maps to &lt;tt&gt;FileHeader.java&lt;/tt&gt;. The field &lt;tt&gt;dbId&lt;/tt&gt; isn&apos;t really used for anything. For snapshots it&apos;s -1 and transactions it&apos;s 0. So, we can easily use this. For post 3.5.3 files we can make dbId 1 for snapshots and 2 for transactions (or whatever). When loading older files, we can invalidate any sessions.&lt;/p&gt;

&lt;p&gt;Question:&lt;/p&gt;

&lt;p&gt;What is the best way to invalidate sessions when loading transactions and snapshot files?&lt;/p&gt;</comment>
                            <comment id="16175342" author="randgalt" created="Thu, 21 Sep 2017 19:50:09 +0000"  >&lt;p&gt;Update - after researching this further, the exposure from Container Nodes doesn&apos;t exist. Container Nodes are denoted by ephemeralOwner of &lt;tt&gt;Long.MIN_VALUE&lt;/tt&gt;. There can never be a session ID with this value so we&apos;re safe. Thus, the only exposure is for TTL nodes. I&apos;m still researching and will continue to report back here.&lt;/p&gt;</comment>
                            <comment id="16175451" author="randgalt" created="Thu, 21 Sep 2017 20:53:04 +0000"  >&lt;p&gt;There is another option here. We update the documentation to say that if you&apos;re going to use container and TTL nodes then your server ID must &amp;lt;= 127. Thoughts?&lt;/p&gt;</comment>
                            <comment id="16177260" author="githubbot" created="Fri, 22 Sep 2017 22:20:27 +0000"  >&lt;p&gt;GitHub user Randgalt opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; title=&quot;Session ID that is negative causes mis-calculation of Ephemeral Type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2901&quot;&gt;&lt;del&gt;ZOOKEEPER-2901&lt;/del&gt;&lt;/a&gt; TTL Nodes don&apos;t work with Server IDs &amp;gt; 127&lt;/p&gt;

&lt;p&gt;    There was a major oversight when TTL nodes were implemented. The session ID generator for each server is seeded with the configured Server ID in the high byte. TTL Nodes were using the highest bit to denote a TTL node when used in the ephemeral owner. This meant that Server IDs &amp;gt; 127 that created ephemeral nodes would have those nodes always considered TTL nodes (with the TTL being essentially a random number).&lt;/p&gt;

&lt;p&gt;    This PR fixes the issue by disabling TTL Nodes by default. They must now be enabled in zoo.cfg. When TTL Nodes are enabled, the max Server ID changes from 255 to 254. This allows the high byte of a session ID stored in the ephemeral owner to use 0xFF to denote a TTL node.&lt;/p&gt;

&lt;p&gt;    About this change:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The doc has been updated to note that TTL nodes are disabled by default and must be enabled via config. Also, the docs explains that when TTL nodes are enabled the max Server ID becomes 254&lt;/li&gt;
	&lt;li&gt;The TTL implementation has been updated to use 0xFF in the high byte of the ephemeralOwner to denote a TTL node. This decreases the max TTL by an insignificant amount&lt;/li&gt;
	&lt;li&gt;PrepRequestProcessor now throws `KeeperException.UnimplementedException` when an attempt to create a TTL node is made but the server has not been configured to enable TTL Nodes.&lt;/li&gt;
	&lt;li&gt;QuorumPeer throws a `RuntimeException` if TTL Nodes are enabled but the Server ID &amp;gt; 254&lt;/li&gt;
	&lt;li&gt;Tests have been added to validate all of this&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Randgalt/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Randgalt/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; title=&quot;Session ID that is negative causes mis-calculation of Ephemeral Type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2901&quot;&gt;&lt;del&gt;ZOOKEEPER-2901&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #377&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 21fa7716133e903c8d43c1003012837f980cb044&lt;br/&gt;
Author: randgalt &amp;lt;jordan@jordanzimmerman.com&amp;gt;&lt;br/&gt;
Date:   2017-09-22T22:10:30Z&lt;/p&gt;

&lt;p&gt;    There was a major oversight when TTL nodes were implemented. The session ID generator for each server is seeded with the configured&lt;br/&gt;
    Server ID in the high byte. TTL Nodes were using the highest bit to denote a TTL node when used in the ephemeral owner. This meant&lt;br/&gt;
    that Server IDs &amp;gt; 127 that created ephemeral nodes would have those nodes always considered TTL nodes (with the TTL being essentially&lt;br/&gt;
    a random number).&lt;/p&gt;

&lt;p&gt;    This PR fixes the issue by disabling TTL Nodes by default. They must now be enabled in zoo.cfg. When TTL Nodes are enabled, the max&lt;br/&gt;
    Server ID changes from 255 to 254. This allows the high byte of a session ID stored in the ephemeral owner to use 0xFF to denote&lt;br/&gt;
    a TTL node.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16177277" author="hadoopqa" created="Fri, 22 Sep 2017 22:36:04 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1034//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1034//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1034//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1034//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1034//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1034//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16177292" author="githubbot" created="Fri, 22 Sep 2017 22:51:57 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The zoo_sample.cfg file should also be updated as part of this patch. It should include the option, and IMO it should have ttl turned on by default (similar warning wrt id as comment in the file?)&lt;/p&gt;</comment>
                            <comment id="16177298" author="phunt" created="Fri, 22 Sep 2017 22:58:34 +0000"  >&lt;p&gt;It&apos;s very unfortunate that we have to turn ttl off by default. I&apos;m wondering if we should relax the b/w compat requirement in this case - esp given it&apos;s a config option and one that we could highlight in the release notes and in the LOG message if the server were &quot;misconfigured&quot;. What do folks think?&lt;/p&gt;</comment>
                            <comment id="16177575" author="randgalt" created="Sat, 23 Sep 2017 05:21:57 +0000"  >&lt;p&gt;I&apos;m happy to switch the default to true. I was being cautious. Can we get to consensus?&lt;/p&gt;</comment>
                            <comment id="16177825" author="hadoopqa" created="Sat, 23 Sep 2017 14:46:49 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1035//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1035//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1035//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1035//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1035//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1035//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16177829" author="githubbot" created="Sat, 23 Sep 2017 14:57:30 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    There are 4 tests with this line of code and it&apos;s failing because the logger is not there (NullPointerException). Any ideas?&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
            Layout layout =&lt;br/&gt;
                    Logger.getRootLogger().getAppender(&quot;CONSOLE&quot;).getLayout();&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16177853" author="githubbot" created="Sat, 23 Sep 2017 15:40:37 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    FYI - I did some local ad-hoc testing with server IDs 254/255 and the config value true/false in zoo.cfg and everything works as expected.&lt;/p&gt;</comment>
                            <comment id="16181681" author="githubbot" created="Tue, 26 Sep 2017 22:24:42 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r141200124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r141200124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java &amp;#8212;&lt;br/&gt;
    @@ -84,6 +84,9 @@ public static long initializeNextSession(long id) {&lt;br/&gt;
             long nextSid;&lt;br/&gt;
             nextSid = (Time.currentElapsedTime() &amp;lt;&amp;lt; 24) &amp;gt;&amp;gt;&amp;gt; 8;&lt;br/&gt;
             nextSid =  nextSid | (id &amp;lt;&amp;lt;56);&lt;br/&gt;
    +        if (nextSid == EphemeralType.CONTAINER_EPHEMERAL_OWNER) {&lt;br/&gt;
    +            ++nextSid;  // this is an unlikely edge case, but check it just in case&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This makes me nervous but I can&apos;t think of a reason why it wont work. It may be worth changing the comment on this method because it is no longer strictly true. &lt;/p&gt;</comment>
                            <comment id="16181682" author="githubbot" created="Tue, 26 Sep 2017 22:24:42 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r141200554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r141200554&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -125,6 +125,8 @@&lt;br/&gt;
         private final ZooKeeperServerListener listener;&lt;br/&gt;
         private ZooKeeperServerShutdownHandler zkShutdownHandler;&lt;/p&gt;

&lt;p&gt;    +    private volatile boolean defaultTtlNodesEnabled = true;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    for the sake of clarity, why can&apos;t this be false?&lt;/p&gt;</comment>
                            <comment id="16183631" author="githubbot" created="Thu, 28 Sep 2017 03:47:04 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r141521002&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r141521002&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java &amp;#8212;&lt;br/&gt;
    @@ -84,6 +84,9 @@ public static long initializeNextSession(long id) {&lt;br/&gt;
             long nextSid;&lt;br/&gt;
             nextSid = (Time.currentElapsedTime() &amp;lt;&amp;lt; 24) &amp;gt;&amp;gt;&amp;gt; 8;&lt;br/&gt;
             nextSid =  nextSid | (id &amp;lt;&amp;lt;56);&lt;br/&gt;
    +        if (nextSid == EphemeralType.CONTAINER_EPHEMERAL_OWNER) {&lt;br/&gt;
    +            ++nextSid;  // this is an unlikely edge case, but check it just in case&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    &quot;no longer strictly true&quot; - actually it still is true. If `Time.currentElapsedTime()` returns 0 and server Id is 0x80, this will happen. That&apos;s why nextSid has to be incremented in that case.&lt;/p&gt;</comment>
                            <comment id="16183632" author="githubbot" created="Thu, 28 Sep 2017 03:47:23 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r141521029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r141521029&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -125,6 +125,8 @@&lt;br/&gt;
         private final ZooKeeperServerListener listener;&lt;br/&gt;
         private ZooKeeperServerShutdownHandler zkShutdownHandler;&lt;/p&gt;

&lt;p&gt;    +    private volatile boolean defaultTtlNodesEnabled = true;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If it&apos;s false, then TTL nodes won&apos;t be available in Standalone mode.&lt;/p&gt;</comment>
                            <comment id="16184138" author="hadoopqa" created="Thu, 28 Sep 2017 13:14:26 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 10 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1054//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1054//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1054//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1054//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1054//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1054//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16184143" author="githubbot" created="Thu, 28 Sep 2017 13:17:16 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The integration above doesn&apos;t seem to update, but the build passes now.&lt;/p&gt;</comment>
                            <comment id="16184381" author="hadoopqa" created="Thu, 28 Sep 2017 16:10:48 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1062//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1062//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1062//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1062//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1062//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1062//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16184384" author="hadoopqa" created="Thu, 28 Sep 2017 16:13:33 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 7 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1061//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1061//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1061//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1061//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1061//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1061//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16189231" author="hadoopqa" created="Tue, 3 Oct 2017 03:53:49 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1077//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1077//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1077//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1077//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1077//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1077//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16189238" author="githubbot" created="Tue, 3 Oct 2017 03:57:20 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This feature is ready to merge (along with #378)&lt;/p&gt;</comment>
                            <comment id="16189851" author="mjohnson207" created="Tue, 3 Oct 2017 15:26:03 +0000"  >&lt;p&gt;With this fix, is there anything to ensure that the session ID is constrained to a valid range?  0-254 or whatever it needs to be to work correctly with the rest of the code?&lt;/p&gt;</comment>
                            <comment id="16189858" author="randgalt" created="Tue, 3 Oct 2017 15:30:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjohnson207&quot; class=&quot;user-hover&quot; rel=&quot;mjohnson207&quot;&gt;mjohnson207&lt;/a&gt; - no. It wasn&apos;t checked before and there&apos;s already an issue for this: &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2503&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2503&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16196888" author="githubbot" created="Mon, 9 Oct 2017 12:30:07 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @phunt Can we get this merged please?&lt;/p&gt;</comment>
                            <comment id="16200374" author="githubbot" created="Wed, 11 Oct 2017 14:33:42 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @Randgalt I&apos;ve been trying to focus on getting the branches, jenkins, etc... back in shape so that I can cut some releases. Any chance your original collaborators can help? I&apos;m kinda swamped and just getting up to speed on these will take time...&lt;/p&gt;</comment>
                            <comment id="16201729" author="githubbot" created="Thu, 12 Oct 2017 09:59:46 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @phunt you reviewed this PR originally so I was hoping you&apos;d merge. @rgs1 can you merge if Pat can&apos;t?&lt;/p&gt;</comment>
                            <comment id="16204349" author="githubbot" created="Fri, 13 Oct 2017 23:31:36 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    My &quot;review&quot; was a question. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Honestly I&apos;m not sure what is the right thing to do here. Afraid it&apos;s painted itself into a bit of corner.&lt;/p&gt;</comment>
                            <comment id="16204369" author="phunt" created="Fri, 13 Oct 2017 23:55:27 +0000"  >&lt;p&gt;Jordan, given the lack of feedback on my earlier question/suggestion it seems like the prudent thing to do would be to go ahead with your original proposal - turn if off by default. (please resubmit that PR) I think we could have a separate jira to &quot;deprecate&quot; the use of the high order server id (please enter a jira for this if you agree), and then in a future version of ZK turn this feature on by default. The &quot;deprecation&quot; would allow folks time to address.&lt;/p&gt;

&lt;p&gt;I basically have zero time to look at this, but given the lack of anyone else having time to look at this I will try to make some time next week. Thanks for hanging in there.&lt;/p&gt;</comment>
                            <comment id="16207544" author="hadoopqa" created="Tue, 17 Oct 2017 12:05:30 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1107//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1107//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1107//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1107//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1107//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1107//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16207564" author="githubbot" created="Tue, 17 Oct 2017 12:26:26 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @phunt it&apos;s back to default false now. So, I hope this can be merged.&lt;/p&gt;</comment>
                            <comment id="16207580" author="randgalt" created="Tue, 17 Oct 2017 12:36:52 +0000"  >&lt;p&gt;Default is set back to false. I really don&apos;t think we need to deprecate the high bit as it&apos;s now documented and you have to opt in to it. So, keep using Server IDs up to 255 unless you want TTLS then it&apos;s 254.&lt;/p&gt;</comment>
                            <comment id="16207878" author="dbenediktson" created="Tue, 17 Oct 2017 16:33:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=randgalt&quot; class=&quot;user-hover&quot; rel=&quot;randgalt&quot;&gt;randgalt&lt;/a&gt; You mean Server IDs, not Session IDs, and up to 127, correct?&lt;/p&gt;</comment>
                            <comment id="16207880" author="randgalt" created="Tue, 17 Oct 2017 16:34:33 +0000"  >&lt;p&gt;derp - fixed&lt;/p&gt;</comment>
                            <comment id="16213495" author="githubbot" created="Fri, 20 Oct 2017 23:38:27 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @Randgalt - this looks like a reasonable change to me however it&apos;s not working. I used the sample zoo.cfg file as my config and started via bin/zkServer.sh - however I can still create a ttl based node even though &quot;ttlNodesEnabled=false&quot; in the zoo.cfg. I recommend you add a test for this.&lt;/p&gt;

&lt;p&gt;    Can you take a look?&lt;/p&gt;

&lt;p&gt;    Also I&apos;d appreciate if you could rebase against current apache master. I did this locally manually, however I&apos;m not sure how the submission script is going to manage it (there were conflicts because you had merged multiple times, including from third party repos (abe)). I can probably figure it out, but if you&apos;re working to address this issue perhaps you can fix this too. thx.&lt;/p&gt;</comment>
                            <comment id="16213497" author="githubbot" created="Fri, 20 Oct 2017 23:40:27 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r146086967&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r146086967&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: conf/zoo_sample.cfg &amp;#8212;&lt;br/&gt;
    @@ -6,6 +6,10 @@ initLimit=10&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The number of ticks that can pass between&lt;/li&gt;
	&lt;li&gt;sending a request and getting an acknowledgement&lt;br/&gt;
     syncLimit=5&lt;br/&gt;
    +# enable TTL Nodes&lt;br/&gt;
    +# IMPORTANT: when enabled, your server ID cannot be greater than 254&lt;br/&gt;
    +# See &lt;a href=&quot;https://zookeeper.apache.org/doc/r3.5.3-beta/zookeeperAdmin.html#sc_configuration&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zookeeper.apache.org/doc/r3.5.3-beta/zookeeperAdmin.html#sc_configuration&lt;/a&gt; for details
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Perhaps note the document and section, rather than the link? It&apos;s going to get out of date quickly.&lt;/p&gt;</comment>
                            <comment id="16213499" author="githubbot" created="Fri, 20 Oct 2017 23:41:24 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r146087059&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r146087059&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: conf/zoo_sample.cfg &amp;#8212;&lt;br/&gt;
    @@ -6,6 +6,10 @@ initLimit=10&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The number of ticks that can pass between&lt;/li&gt;
	&lt;li&gt;sending a request and getting an acknowledgement&lt;br/&gt;
     syncLimit=5&lt;br/&gt;
    +# enable TTL Nodes&lt;br/&gt;
    +# IMPORTANT: when enabled, your server ID cannot be greater than 254&lt;br/&gt;
    +# See &lt;a href=&quot;https://zookeeper.apache.org/doc/r3.5.3-beta/zookeeperAdmin.html#sc_configuration&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zookeeper.apache.org/doc/r3.5.3-beta/zookeeperAdmin.html#sc_configuration&lt;/a&gt; for details&lt;br/&gt;
    +ttlNodesEnabled=false
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    I was actually thinking that this specific line (not in general) should be true by default. That way anyone starting out would get the feature enabled by default - and they wouldn&apos;t have any legacy serverids specified. What do you think?&lt;/p&gt;</comment>
                            <comment id="16213566" author="githubbot" created="Sat, 21 Oct 2017 00:19:32 +0000"  >&lt;p&gt;Github user DanBenediktson commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r146089767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r146089767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: conf/zoo_sample.cfg &amp;#8212;&lt;br/&gt;
    @@ -6,6 +6,10 @@ initLimit=10&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The number of ticks that can pass between&lt;/li&gt;
	&lt;li&gt;sending a request and getting an acknowledgement&lt;br/&gt;
     syncLimit=5&lt;br/&gt;
    +# enable TTL Nodes&lt;br/&gt;
    +# IMPORTANT: when enabled, your server ID cannot be greater than 254
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Same comment I left on the JIRA ticket: shouldn&apos;t it be 127, not 254? My understanding of the problem was that the whole high bit was being used, not the whole byte sequence of 255.&lt;/p&gt;</comment>
                            <comment id="16234610" author="phunt" created="Wed, 1 Nov 2017 19:24:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=randgalt&quot; class=&quot;user-hover&quot; rel=&quot;randgalt&quot;&gt;randgalt&lt;/a&gt; any updates on this one? Some comments from me/Dan to address.&lt;/p&gt;</comment>
                            <comment id="16237640" author="githubbot" created="Fri, 3 Nov 2017 14:12:49 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r148792118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r148792118&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: conf/zoo_sample.cfg &amp;#8212;&lt;br/&gt;
    @@ -6,6 +6,10 @@ initLimit=10&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The number of ticks that can pass between&lt;/li&gt;
	&lt;li&gt;sending a request and getting an acknowledgement&lt;br/&gt;
     syncLimit=5&lt;br/&gt;
    +# enable TTL Nodes&lt;br/&gt;
    +# IMPORTANT: when enabled, your server ID cannot be greater than 254
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    @DanBenediktson 127 is the case with the existing bug. I re-wrote how this is handled so that now it&apos;s 255. The high bit is now used to signal that the ephemeralOwner is special. &lt;/p&gt;</comment>
                            <comment id="16237656" author="githubbot" created="Fri, 3 Nov 2017 14:27:30 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;gt; I used the sample zoo.cfg file as my config and started via bin/zkServer.sh - however I can still create a ttl based node even though &quot;ttlNodesEnabled=false&quot; in the zoo.cfg. I recommend you add a test for this.&lt;/p&gt;

&lt;p&gt;    @phunt I imagine the server started in Standalone mode. Please verify. When the server starts in Standalone mode it ignores most of zoo.cfg. Also in Standalone mode there is no Server ID so it&apos;s a non issue. If you add `server.X` and `standaloneEnabled=false` to zoo.cfg then the ttlNodesEnabled has effect. Make sense? Does this need to be documented?&lt;/p&gt;</comment>
                            <comment id="16242349" author="randgalt" created="Tue, 7 Nov 2017 16:45:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt; Anything else needed before this can be merged along with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2903&quot; title=&quot;Port ZOOKEEPER-2901 to 3.5.4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2903&quot;&gt;&lt;del&gt;ZOOKEEPER-2903&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16254140" author="githubbot" created="Wed, 15 Nov 2017 20:39:53 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think it needs to do the same thing whether it&apos;s in standalone mode or not. Least surprise. Also folks might want to test in standalone mode with the same basic configuration that they use with an ensemble size &amp;gt; 1. They&apos;d want the same behavior. I&apos;d say it should work the same regardless whether it&apos;s standalone or not.&lt;/p&gt;</comment>
                            <comment id="16267445" author="randgalt" created="Mon, 27 Nov 2017 20:32:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt; - the ttlNodesEnabled now applies to stand alone mode too. I ported this to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2903&quot; title=&quot;Port ZOOKEEPER-2901 to 3.5.4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2903&quot;&gt;&lt;del&gt;ZOOKEEPER-2903&lt;/del&gt;&lt;/a&gt; as well.&lt;/p&gt;</comment>
                            <comment id="16267512" author="hadoopqa" created="Mon, 27 Nov 2017 20:51:40 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 6 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1310//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1310//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1310//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1310//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1310//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1310//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16269363" author="githubbot" created="Tue, 28 Nov 2017 19:55:16 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @Randgalt I had to resolve some conflicts in order to compare this to current master. Posted the updated branch here: &lt;a href=&quot;https://github.com/phunt/zookeeper/commits/ZOOKEEPER-2901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/phunt/zookeeper/commits/ZOOKEEPER-2901&lt;/a&gt; Can you review this and update this patch when you have a chance (I&apos;m still reviewing/testing the updates at that link)&lt;/p&gt;</comment>
                            <comment id="16269839" author="githubbot" created="Wed, 29 Nov 2017 00:57:09 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r153668593&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r153668593&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -40,19 +39,21 @@&lt;br/&gt;
         TTL;&lt;/p&gt;

&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x00ffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL_SERVER_ID = 0xfe;  // 254&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static EphemeralType get(long ephemeralOwner) {&lt;br/&gt;
             if (ephemeralOwner == CONTAINER_EPHEMERAL_OWNER) &lt;/p&gt;
{
                 return CONTAINER;
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (ephemeralOwner &amp;lt; 0) {&lt;br/&gt;
    +        if ((ephemeralOwner &amp;amp; TTL_MASK) == TTL_MASK) 
{
    --- End diff --
    
    I think this is broken. If, for example, org.apache.zookeeper.server.DataTree#deleteNode calls this method with TTL turned off, but using a server id of 255 it will end up calling this code
    
                }
&lt;p&gt; else if (ephemeralType == EphemeralType.TTL) {&lt;br/&gt;
                    ttls.remove(path);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    and the node will not be removed properly in deleteNode.&lt;/p&gt;</comment>
                            <comment id="16269842" author="githubbot" created="Wed, 29 Nov 2017 00:58:33 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r153668817&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r153668817&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -40,19 +39,21 @@&lt;br/&gt;
         TTL;&lt;/p&gt;

&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x00ffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL_SERVER_ID = 0xfe;  // 254&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static EphemeralType get(long ephemeralOwner) {&lt;br/&gt;
             if (ephemeralOwner == CONTAINER_EPHEMERAL_OWNER) &lt;/p&gt;
{
                 return CONTAINER;
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (ephemeralOwner &amp;lt; 0) {&lt;br/&gt;
    +        if ((ephemeralOwner &amp;amp; TTL_MASK) == TTL_MASK) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    In particular you need to add a bunch more testing to ensure this case is working properly.&lt;/p&gt;</comment>
                            <comment id="16276080" author="hadoopqa" created="Sun, 3 Dec 2017 20:45:59 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    -1 release audit.  The applied patch generated 1 release audit warnings (more than the trunk&apos;s current 0 warnings).&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//testReport/&lt;/a&gt;&lt;br/&gt;
Release audit warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1327//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16276082" author="githubbot" created="Sun, 3 Dec 2017 20:49:36 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Controlling TTL Nodes via zoo.cfg turned out to be untennable. There are too many parts of the code that need to know about TTLs being enabled or not. The previous PR had several holes relating to this. This new commit changes the enabled/disabled mechanism to be a System property so that it can be accessed anywhere in the code. It&apos;s also been renamed something more general so that it can be applied to future features and not just TTLs.&lt;/p&gt;</comment>
                            <comment id="16276094" author="hadoopqa" created="Sun, 3 Dec 2017 21:12:17 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 8 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1330//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1330//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1330//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1330//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1330//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1330//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16290053" author="githubbot" created="Wed, 13 Dec 2017 22:45:21 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r156808074&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r156808074&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml &amp;#8212;&lt;br/&gt;
    @@ -949,14 +949,15 @@ server.3=zoo3:2888:3888&amp;lt;/programlisting&amp;gt;&lt;br/&gt;
               &amp;lt;/varlistentry&amp;gt;&lt;/p&gt;

&lt;p&gt;               &amp;lt;varlistentry&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;term&amp;gt;ttlNodesEnabled&amp;lt;/term&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/term&amp;gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Do we are have any room left for this? iiuc ttls are the last.&lt;/p&gt;

&lt;p&gt;    My concern here - won&apos;t people be confused by this, e.g. &quot;are containers extended types&quot;?&lt;/p&gt;

&lt;p&gt;    What do you think @Randgalt ?&lt;/p&gt;</comment>
                            <comment id="16290061" author="githubbot" created="Wed, 13 Dec 2017 22:53:21 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r156809696&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r156809696&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml &amp;#8212;&lt;br/&gt;
    @@ -949,14 +949,15 @@ server.3=zoo3:2888:3888&amp;lt;/programlisting&amp;gt;&lt;br/&gt;
               &amp;lt;/varlistentry&amp;gt;&lt;/p&gt;

&lt;p&gt;               &amp;lt;varlistentry&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;term&amp;gt;ttlNodesEnabled&amp;lt;/term&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/term&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                 &amp;lt;listitem&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;para&amp;gt;(No Java system property)&amp;lt;/para&amp;gt;&lt;br/&gt;
    +                &amp;lt;para&amp;gt;(Java system property only: &amp;lt;emphasis
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is a bit confusing given QuorumPeerConfig line 326&lt;/p&gt;

&lt;p&gt;                    System.setProperty(&quot;zookeeper.&quot; + key, value);&lt;/p&gt;

&lt;p&gt;    See the doc for forceSync for an example of a better way to set this up. (forceSync works this same way)&lt;/p&gt;
</comment>
                            <comment id="16290114" author="githubbot" created="Wed, 13 Dec 2017 23:59:39 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r156821102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r156821102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is really ugly. Why not using a quorum peer instead? Given you want to control the serverid.&lt;/p&gt;</comment>
                            <comment id="16290117" author="githubbot" created="Thu, 14 Dec 2017 00:00:12 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r156821178&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r156821178&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml &amp;#8212;&lt;br/&gt;
    @@ -949,14 +949,15 @@ server.3=zoo3:2888:3888&amp;lt;/programlisting&amp;gt;&lt;br/&gt;
               &amp;lt;/varlistentry&amp;gt;&lt;/p&gt;

&lt;p&gt;               &amp;lt;varlistentry&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;term&amp;gt;ttlNodesEnabled&amp;lt;/term&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/term&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                 &amp;lt;listitem&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;para&amp;gt;(No Java system property)&amp;lt;/para&amp;gt;&lt;br/&gt;
    +                &amp;lt;para&amp;gt;(Java system property only: &amp;lt;emphasis&lt;br/&gt;
    +                    role=&quot;bold&quot;&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/emphasis&amp;gt;)&amp;lt;/para&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;para&amp;gt;&amp;lt;emphasis role=&quot;bold&quot;&amp;gt;New in 3.5.4, 3.6.0:&amp;lt;/emphasis&amp;gt; Set to &quot;true&quot; to enable&lt;/li&gt;
	&lt;li&gt;the creation of &amp;lt;ulink url=&quot;zookeeperProgrammers.html#TTL+Nodes&quot;&amp;gt;TTL Nodes&amp;lt;/ulink&amp;gt;.&lt;/li&gt;
	&lt;li&gt;They are disabled by default. IMPORTANT: when TTL Nodes are enabled server IDs must&lt;br/&gt;
    +              &amp;lt;para&amp;gt;&amp;lt;emphasis role=&quot;bold&quot;&amp;gt;New in 3.5.4, 3.6.0:&amp;lt;/emphasis&amp;gt; Define to &quot;true&quot; to enable&lt;br/&gt;
    +              extended features such as the creation of &amp;lt;ulink url=&quot;zookeeperProgrammers.html#TTL+Nodes&quot;&amp;gt;TTL Nodes&amp;lt;/ulink&amp;gt;.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    obv update this to reflect.&lt;/p&gt;</comment>
                            <comment id="16290118" author="githubbot" created="Thu, 14 Dec 2017 00:00:22 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r156821209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r156821209&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperProgrammers.xml &amp;#8212;&lt;br/&gt;
    @@ -271,9 +271,9 @@&lt;br/&gt;
               is not modified within the TTL and has no children it will become a candidate&lt;br/&gt;
               to be deleted by the server at some point in the future.&amp;lt;/para&amp;gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;para&amp;gt;Note: TTL Nodes must be enabled in your ZooKeeper configuration file as&lt;br/&gt;
    +        &amp;lt;para&amp;gt;Note: TTL Nodes must be enabled via System property as
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    and this.&lt;/p&gt;</comment>
                            <comment id="16306450" author="githubbot" created="Fri, 29 Dec 2017 18:38:36 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r159091284&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r159091284&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @phunt I&apos;m not sure what you mean about quorum peer. I could find another way to set this value. Also, it&apos;s only for testing and clearly marked. What do you suggest?&lt;/p&gt;</comment>
                            <comment id="16306451" author="githubbot" created="Fri, 29 Dec 2017 18:40:57 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r159091495&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r159091495&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml &amp;#8212;&lt;br/&gt;
    @@ -949,14 +949,15 @@ server.3=zoo3:2888:3888&amp;lt;/programlisting&amp;gt;&lt;br/&gt;
               &amp;lt;/varlistentry&amp;gt;&lt;/p&gt;

&lt;p&gt;               &amp;lt;varlistentry&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&amp;lt;term&amp;gt;ttlNodesEnabled&amp;lt;/term&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/term&amp;gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I only thought that we might be able to use the setting for other things in the future. But, I&apos;m OK either way. Let me know.&lt;/p&gt;</comment>
                            <comment id="16323604" author="githubbot" created="Fri, 12 Jan 2018 06:14:00 +0000"  >&lt;p&gt;Github user lvfangmin commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r161147063&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r161147063&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -40,19 +39,40 @@&lt;br/&gt;
         TTL;&lt;/p&gt;

&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x00ffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL_SERVER_ID = 0xfe;  // 254&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final String EXTENDED_TYPES_ENABLED_PROPERTY = &quot;zookeeper.extendedTypesEnabled&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static boolean extendedEphemeralTypesEnabled() 
{
    +        return Boolean.getBoolean(EXTENDED_TYPES_ENABLED_PROPERTY);
    +    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static EphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    +        if ( extendedEphemeralTypesEnabled() ) {&lt;br/&gt;
    +            if ((ephemeralOwner &amp;amp; TTL_MASK) == TTL_MASK) &lt;/p&gt;
{
    +                return TTL;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
             if (ephemeralOwner == CONTAINER_EPHEMERAL_OWNER) &lt;/p&gt;
{
                 return CONTAINER;
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (ephemeralOwner &amp;lt; 0) 
{
    -            return TTL;
    -        }
&lt;p&gt;             return (ephemeralOwner == 0) ? VOID : NORMAL;&lt;br/&gt;
         }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +    public static void validateServerId(long serverId) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe we should not start the server if the server id is conflict with TTL feature, we can do this in QuorumPeerConfig.checkValidity.&lt;/p&gt;</comment>
                            <comment id="16323605" author="githubbot" created="Fri, 12 Jan 2018 06:14:00 +0000"  >&lt;p&gt;Github user lvfangmin commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r161146799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r161146799&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -40,19 +39,40 @@&lt;br/&gt;
         TTL;&lt;/p&gt;

&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x00ffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL_SERVER_ID = 0xfe;  // 254&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final String EXTENDED_TYPES_ENABLED_PROPERTY = &quot;zookeeper.extendedTypesEnabled&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static boolean extendedEphemeralTypesEnabled() 
{
    +        return Boolean.getBoolean(EXTENDED_TYPES_ENABLED_PROPERTY);
    +    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static EphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    +        if ( extendedEphemeralTypesEnabled() ) {&lt;br/&gt;
    +            if ((ephemeralOwner &amp;amp; TTL_MASK) == TTL_MASK) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    To keep backward compatible, shouldn&apos;t we keep use 0x80 as the TTL byte? &lt;/p&gt;

&lt;p&gt;    People may not use sid larger than 127, it&apos;s more likely they will use the TTL with 0x80 highest byte. With this change, those nodes won&apos;t be expired anymore.&lt;/p&gt;</comment>
                            <comment id="16336601" author="githubbot" created="Wed, 24 Jan 2018 00:06:29 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r163419925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r163419925&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -40,19 +39,40 @@&lt;br/&gt;
         TTL;&lt;/p&gt;

&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x00ffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    public static final long MAX_TTL_SERVER_ID = 0xfe;  // 254&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final String EXTENDED_TYPES_ENABLED_PROPERTY = &quot;zookeeper.extendedTypesEnabled&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static boolean extendedEphemeralTypesEnabled() 
{
    +        return Boolean.getBoolean(EXTENDED_TYPES_ENABLED_PROPERTY);
    +    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static EphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    +        if ( extendedEphemeralTypesEnabled() ) {&lt;br/&gt;
    +            if ((ephemeralOwner &amp;amp; TTL_MASK) == TTL_MASK) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We discussed this earlier in the PR. Problem is it&apos;s b/w incompat one way or the other. Given serverid has been around forever, and TTL only added in 3.5.3 (a beta) we went forward with this approach.&lt;/p&gt;</comment>
                            <comment id="16336603" author="githubbot" created="Wed, 24 Jan 2018 00:08:09 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r163420180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r163420180&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I looked at it a bit originally, iirc I figured that you&apos;d pass it through in some way (during instance creation) rather than making it a global.&lt;/p&gt;</comment>
                            <comment id="16336606" author="githubbot" created="Wed, 24 Jan 2018 00:10:22 +0000"  >&lt;p&gt;Github user phunt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @Randgalt i&apos;d really like to push out a 3.5.4 - do you think it would make sense to release note this in 3.5.4 and address for 3.5.5? If you think we can finalize this PR soon I&apos;m still open to that.&lt;/p&gt;</comment>
                            <comment id="16338182" author="githubbot" created="Wed, 24 Jan 2018 20:38:32 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r163671234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r163671234&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    As I recall that was extremely difficult. Config is not shared between different parts of the code. The only way to do that type of thing is via System defines. That&apos;s why I did this.&lt;/p&gt;</comment>
                            <comment id="16338436" author="githubbot" created="Wed, 24 Jan 2018 23:38:01 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r163712641&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r163712641&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It being a global seems to kick the problem down the road to the next person. I&apos;m worried that setting this jvm wide could have an impact when developing tests in the future. That&apos;s why it caught my eye.&lt;/p&gt;</comment>
                            <comment id="16338707" author="githubbot" created="Thu, 25 Jan 2018 04:11:07 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r163746348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r163746348&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Here&apos;s the issue @phunt - `serverId` is consumed by `ZooKeeperServer.createSessionTracker()`. For tests, the ZooKeeperServer is created by the *&lt;b&gt;static&lt;/b&gt;* method `ClientBase.startServerInstance()`. So, &lt;em&gt;I&apos;m&lt;/em&gt; the person down the road that has to deal with the static method created long ago. It would take significant re-write for `ClientBase.startServerInstance()` to be non-static and parameterized.&lt;/p&gt;</comment>
                            <comment id="16338710" author="githubbot" created="Thu, 25 Jan 2018 04:26:15 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r163747537&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r163747537&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -476,9 +474,12 @@ public ZooKeeperServerListener getZooKeeperServerListener() &lt;/p&gt;
{
             return listener;
         }

&lt;p&gt;    +    // Visible for testing&lt;br/&gt;
    +    static volatile int serverId = 1;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    That said - I could probably do it. Let me know. If you think it&apos;s important I&apos;ll see what I can do.&lt;/p&gt;</comment>
                            <comment id="16341168" author="githubbot" created="Fri, 26 Jan 2018 15:34:29 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Attn: @phunt - I just pushed two changes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Better docs and new reserved bits in the `EphemeralType` enum.&lt;/li&gt;
	&lt;li&gt;Better implementation of the testable `serverId` in ZooKeeperServer.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16341257" author="githubbot" created="Fri, 26 Jan 2018 16:45:52 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    IMPORTANT NOTE: TTL Nodes created in 3.5.3 will revert to EPHEMERAL with this change. We need to discuss the impact of this and consider workarounds, etc.&lt;/p&gt;</comment>
                            <comment id="16341322" author="githubbot" created="Fri, 26 Jan 2018 17:29:32 +0000"  >&lt;p&gt;Github user Randgalt commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    FYI - I just pushed a change that adds yet-another-flag that allows 3.5.4 ZKs to read the old 3.5.3 TTL nodes. I think we must have this. The docs are updated too.&lt;/p&gt;</comment>
                            <comment id="16356218" author="githubbot" created="Wed, 7 Feb 2018 23:13:54 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r166787489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r166787489&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml &amp;#8212;&lt;br/&gt;
    @@ -950,6 +952,39 @@ server.3=zoo3:2888:3888&amp;lt;/programlisting&amp;gt;&lt;br/&gt;
                 &amp;lt;/listitem&amp;gt;&lt;br/&gt;
               &amp;lt;/varlistentry&amp;gt;&lt;/p&gt;

&lt;p&gt;    +          &amp;lt;varlistentry&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/term&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +            &amp;lt;listitem&amp;gt;&lt;br/&gt;
    +                &amp;lt;para&amp;gt;(Java system property only: &amp;lt;emphasis&lt;br/&gt;
    +                    role=&quot;bold&quot;&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/emphasis&amp;gt;)&amp;lt;/para&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +              &amp;lt;para&amp;gt;&amp;lt;emphasis role=&quot;bold&quot;&amp;gt;New in 3.5.4, 3.6.0:&amp;lt;/emphasis&amp;gt; Define to &quot;true&quot; to enable&lt;br/&gt;
    +              extended features such as the creation of &amp;lt;ulink url=&quot;zookeeperProgrammers.html#TTL+Nodes&quot;&amp;gt;TTL Nodes&amp;lt;/ulink&amp;gt;.&lt;br/&gt;
    +              They are disabled by default. IMPORTANT: when enabled server IDs must&lt;br/&gt;
    +              be less than 255 due to internal limitations.&lt;br/&gt;
    +              &amp;lt;/para&amp;gt;&lt;br/&gt;
    +            &amp;lt;/listitem&amp;gt;&lt;br/&gt;
    +          &amp;lt;/varlistentry&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +          &amp;lt;varlistentry&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.emulate353TTLNodes&amp;lt;/term&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    What&apos;s the plan for deprecating this? Keeping this parameter around forever seems like a bad idea. Adds complication that we don&apos;t really need to carry around. Perhaps we can deprecate in 3.5.4 and remove in 3.5.5? Similarly I don&apos;t think we should include this at all in 3.6.0 (trunk).&lt;/p&gt;</comment>
                            <comment id="16356219" author="githubbot" created="Wed, 7 Feb 2018 23:14:41 +0000"  >&lt;p&gt;Github user phunt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r166787684&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r166787684&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml &amp;#8212;&lt;br/&gt;
    @@ -950,6 +952,39 @@ server.3=zoo3:2888:3888&amp;lt;/programlisting&amp;gt;&lt;br/&gt;
                 &amp;lt;/listitem&amp;gt;&lt;br/&gt;
               &amp;lt;/varlistentry&amp;gt;&lt;/p&gt;

&lt;p&gt;    +          &amp;lt;varlistentry&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/term&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +            &amp;lt;listitem&amp;gt;&lt;br/&gt;
    +                &amp;lt;para&amp;gt;(Java system property only: &amp;lt;emphasis&lt;br/&gt;
    +                    role=&quot;bold&quot;&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/emphasis&amp;gt;)&amp;lt;/para&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +              &amp;lt;para&amp;gt;&amp;lt;emphasis role=&quot;bold&quot;&amp;gt;New in 3.5.4, 3.6.0:&amp;lt;/emphasis&amp;gt; Define to &quot;true&quot; to enable&lt;br/&gt;
    +              extended features such as the creation of &amp;lt;ulink url=&quot;zookeeperProgrammers.html#TTL+Nodes&quot;&amp;gt;TTL Nodes&amp;lt;/ulink&amp;gt;.&lt;br/&gt;
    +              They are disabled by default. IMPORTANT: when enabled server IDs must&lt;br/&gt;
    +              be less than 255 due to internal limitations.&lt;br/&gt;
    +              &amp;lt;/para&amp;gt;&lt;br/&gt;
    +            &amp;lt;/listitem&amp;gt;&lt;br/&gt;
    +          &amp;lt;/varlistentry&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +          &amp;lt;varlistentry&amp;gt;&lt;br/&gt;
    +            &amp;lt;term&amp;gt;zookeeper.emulate353TTLNodes&amp;lt;/term&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +            &amp;lt;listitem&amp;gt;&lt;br/&gt;
    +                &amp;lt;para&amp;gt;(Java system property only: &amp;lt;emphasis&lt;br/&gt;
    +                    role=&quot;bold&quot;&amp;gt;zookeeper.emulate353TTLNodes&amp;lt;/emphasis&amp;gt;)&amp;lt;/para&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +              &amp;lt;para&amp;gt;&amp;lt;emphasis role=&quot;bold&quot;&amp;gt;New in 3.5.4, 3.6.0:&amp;lt;/emphasis&amp;gt; Due to&lt;br/&gt;
    +                &amp;lt;ulink url=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot;&amp;gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; title=&quot;Session ID that is negative causes mis-calculation of Ephemeral Type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2901&quot;&gt;&lt;del&gt;ZOOKEEPER-2901&lt;/del&gt;&lt;/a&gt;&amp;lt;/ulink&amp;gt; TTL nodes&lt;br/&gt;
    +                created in version 3.5.3 are not supported in 3.5.4/3.6.0. However, a workaround is provided via the&lt;br/&gt;
    +                zookeeper.emulate353TTLNodes system property. If you used TTL nodes in ZooKeeper 3.5.3 and need to maintain&lt;br/&gt;
    +                compatibility set &amp;lt;emphasis role=&quot;bold&quot;&amp;gt;zookeeper.emulate353TTLNodes&amp;lt;/emphasis&amp;gt; to &quot;true&quot; in addition to&lt;br/&gt;
    +                &amp;lt;emphasis role=&quot;bold&quot;&amp;gt;zookeeper.extendedTypesEnabled&amp;lt;/emphasis&amp;gt;. NOTE: due to the bug, server IDs&lt;br/&gt;
    +                must be 127 or less. Additionally, the maximum support TTL value is 1099511627775 which is smaller&lt;br/&gt;
    +                than what was allowed in 3.5.3 (1152921504606846975)&amp;lt;/para&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Is there documentation around this? I&apos;d recommend documenting the bounds.&lt;/p&gt;</comment>
                            <comment id="16372474" author="githubbot" created="Thu, 22 Feb 2018 06:38:17 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r169865059&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r169865059&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -37,41 +77,152 @@&lt;br/&gt;
         /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TTL node&lt;br/&gt;
          */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TTL;&lt;br/&gt;
    +    TTL() {&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public long maxValue() 
{
    +            return EXTENDED_FEATURE_VALUE_MASK;  // 12725 days, about 34 years
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public long toEphemeralOwner(long ttl) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +            if ((ttl &amp;gt; TTL.maxValue()) || (ttl &amp;lt;= 0)) {
    +                throw new IllegalArgumentException(&quot;ttl must be positive and cannot be larger than: &quot; + TTL.maxValue());
    +            }    +            //noinspection PointlessBitwiseExpression    +            return EXTENDED_MASK | EXTENDED_BIT_TTL | ttl;  // TTL_RESERVED_BIT is actually zero - but it serves to document that the proper extended bit needs to be set    +        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public long getValue(long ephemeralOwner) &lt;/p&gt;
{
    +            return getExtendedFeatureValue(ephemeralOwner);
    +        }
&lt;p&gt;    +    };&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * For types that support it, the maximum extended value&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return 0 or max&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long maxValue() &lt;/p&gt;
{
    +        return 0;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * For types that support it, convert a value to an extended ephemeral owner&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return 0 or extended ephemeral owner&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long toEphemeralOwner(long value) {    +        return 0;    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * For types that support it, return the extended value from an extended ephemeral owner&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return 0 or extended value&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long getValue(long ephemeralOwner) &lt;/p&gt;
{
    +        return 0;
    +    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_EXTENDED_SERVER_ID = 0xfe;  // 254&lt;br/&gt;
    +&lt;br/&gt;
    +    private static final long EXTENDED_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    private static final long EXTENDED_BIT_TTL = 0x0000;&lt;br/&gt;
    +    private static final long RESERVED_BITS_MASK = 0x00ffff0000000000L;&lt;br/&gt;
    +    private static final long RESERVED_BITS_SHIFT = 40;&lt;br/&gt;
    +&lt;br/&gt;
    +    private static final Map&amp;lt;Long, EphemeralType&amp;gt; extendedFeatureMap;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +    static &lt;/p&gt;
{
    +        Map&amp;lt;Long, EphemeralType&amp;gt; map = new HashMap&amp;lt;&amp;gt;();
    +        map.put(EXTENDED_BIT_TTL, TTL);
    +        extendedFeatureMap = Collections.unmodifiableMap(map);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private static final long EXTENDED_FEATURE_VALUE_MASK = ~(EXTENDED_MASK | RESERVED_BITS_MASK);&lt;br/&gt;
    +&lt;br/&gt;
    +    // Visible for testing&lt;br/&gt;
    +    static final String EXTENDED_TYPES_ENABLED_PROPERTY = &quot;zookeeper.extendedTypesEnabled&quot;;&lt;br/&gt;
    +    static final String TTL_3_5_3_EMULATION_PROPERTY = &quot;zookeeper.emulate353TTLNodes&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Return true if extended ephemeral types are enabled&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return true/false&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public static boolean extendedEphemeralTypesEnabled() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe I&apos;m missing the point here. Would you please elaborate a little bit on what&apos;s the additional benefit of making this generic by extended ephemeral types?&lt;br/&gt;
    Why don&apos;t you just KISS (keep it simple), because YAGNI (you ain&apos;t gonna need) the extended types?&lt;/p&gt;</comment>
                            <comment id="16372475" author="githubbot" created="Thu, 22 Feb 2018 06:38:17 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r169863794&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r169863794&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/OldEphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,74 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * version 3.5.3 introduced bugs associated with how TTL nodes were implemented. version 3.5.4&lt;br/&gt;
    + * fixes the problems but makes TTL nodes created in 3.5.3 invalid. OldEphemeralType is a copy&lt;br/&gt;
    + * of the old - bad - implementation that is provided as a workaround. &lt;/p&gt;
{@link EphemeralType#TTL_3_5_3_EMULATION_PROPERTY}
&lt;p&gt;    + * can be used to emulate support of the badly specified TTL nodes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public enum OldEphemeralType {&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Not ephemeral&lt;br/&gt;
    +     */&lt;br/&gt;
    +    VOID,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Standard, pre-3.5.x EPHEMERAL&lt;br/&gt;
    +     */&lt;br/&gt;
    +    NORMAL,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Container node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    CONTAINER,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * TTL node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    TTL;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static OldEphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Do think it has value to keep this &quot;old&quot; type in the codebase?&lt;br/&gt;
    For backward compatibility reason I don&apos;t think it makes sense on a non-stable branch.&lt;br/&gt;
    Its contents only used from the &quot;new&quot; type and tests.&lt;br/&gt;
    I&apos;d rather put the logic which is still needed in the &quot;new&quot; type and get rid of this one completely keeping EphemeralType nice and clean.&lt;br/&gt;
    What do you think?&lt;/p&gt;</comment>
                            <comment id="16372907" author="githubbot" created="Thu, 22 Feb 2018 15:02:40 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r169984867&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r169984867&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/OldEphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,74 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * version 3.5.3 introduced bugs associated with how TTL nodes were implemented. version 3.5.4&lt;br/&gt;
    + * fixes the problems but makes TTL nodes created in 3.5.3 invalid. OldEphemeralType is a copy&lt;br/&gt;
    + * of the old - bad - implementation that is provided as a workaround. &lt;/p&gt;
{@link EphemeralType#TTL_3_5_3_EMULATION_PROPERTY}
&lt;p&gt;    + * can be used to emulate support of the badly specified TTL nodes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public enum OldEphemeralType {&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Not ephemeral&lt;br/&gt;
    +     */&lt;br/&gt;
    +    VOID,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Standard, pre-3.5.x EPHEMERAL&lt;br/&gt;
    +     */&lt;br/&gt;
    +    NORMAL,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Container node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    CONTAINER,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * TTL node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    TTL;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static OldEphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We should create a new task to delete it after a while. However, I know that this will be important. Whoever used TTLs in 3.5.3 will run into problems when they upgrade. We need to have a workaround for these users.&lt;/p&gt;</comment>
                            <comment id="16372909" author="githubbot" created="Thu, 22 Feb 2018 15:04:15 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r169985373&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r169985373&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/EphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -37,41 +77,152 @@&lt;br/&gt;
         /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TTL node&lt;br/&gt;
          */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TTL;&lt;br/&gt;
    +    TTL() {&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public long maxValue() 
{
    +            return EXTENDED_FEATURE_VALUE_MASK;  // 12725 days, about 34 years
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public long toEphemeralOwner(long ttl) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +            if ((ttl &amp;gt; TTL.maxValue()) || (ttl &amp;lt;= 0)) {
    +                throw new IllegalArgumentException(&quot;ttl must be positive and cannot be larger than: &quot; + TTL.maxValue());
    +            }    +            //noinspection PointlessBitwiseExpression    +            return EXTENDED_MASK | EXTENDED_BIT_TTL | ttl;  // TTL_RESERVED_BIT is actually zero - but it serves to document that the proper extended bit needs to be set    +        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +        @Override&lt;br/&gt;
    +        public long getValue(long ephemeralOwner) &lt;/p&gt;
{
    +            return getExtendedFeatureValue(ephemeralOwner);
    +        }
&lt;p&gt;    +    };&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * For types that support it, the maximum extended value&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return 0 or max&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long maxValue() &lt;/p&gt;
{
    +        return 0;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * For types that support it, convert a value to an extended ephemeral owner&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return 0 or extended ephemeral owner&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long toEphemeralOwner(long value) {    +        return 0;    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * For types that support it, return the extended value from an extended ephemeral owner&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return 0 or extended value&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long getValue(long ephemeralOwner) &lt;/p&gt;
{
    +        return 0;
    +    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;/li&gt;
	&lt;li&gt;public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +    public static final long MAX_EXTENDED_SERVER_ID = 0xfe;  // 254&lt;br/&gt;
    +&lt;br/&gt;
    +    private static final long EXTENDED_MASK = 0xff00000000000000L;&lt;br/&gt;
    +    private static final long EXTENDED_BIT_TTL = 0x0000;&lt;br/&gt;
    +    private static final long RESERVED_BITS_MASK = 0x00ffff0000000000L;&lt;br/&gt;
    +    private static final long RESERVED_BITS_SHIFT = 40;&lt;br/&gt;
    +&lt;br/&gt;
    +    private static final Map&amp;lt;Long, EphemeralType&amp;gt; extendedFeatureMap;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +    static &lt;/p&gt;
{
    +        Map&amp;lt;Long, EphemeralType&amp;gt; map = new HashMap&amp;lt;&amp;gt;();
    +        map.put(EXTENDED_BIT_TTL, TTL);
    +        extendedFeatureMap = Collections.unmodifiableMap(map);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    private static final long EXTENDED_FEATURE_VALUE_MASK = ~(EXTENDED_MASK | RESERVED_BITS_MASK);&lt;br/&gt;
    +&lt;br/&gt;
    +    // Visible for testing&lt;br/&gt;
    +    static final String EXTENDED_TYPES_ENABLED_PROPERTY = &quot;zookeeper.extendedTypesEnabled&quot;;&lt;br/&gt;
    +    static final String TTL_3_5_3_EMULATION_PROPERTY = &quot;zookeeper.emulate353TTLNodes&quot;;&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Return true if extended ephemeral types are enabled&lt;br/&gt;
    +     *&lt;br/&gt;
    +     * @return true/false&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public static boolean extendedEphemeralTypesEnabled() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The way it&apos;s implemented now, we can add easily new features in the future. Why code ourselves into a corner when we can leave some room? BTW - I&apos;d discussed this offline with @phunt &lt;/p&gt;</comment>
                            <comment id="16372993" author="githubbot" created="Thu, 22 Feb 2018 16:09:43 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r170008461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r170008461&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/OldEphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,74 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * version 3.5.3 introduced bugs associated with how TTL nodes were implemented. version 3.5.4&lt;br/&gt;
    + * fixes the problems but makes TTL nodes created in 3.5.3 invalid. OldEphemeralType is a copy&lt;br/&gt;
    + * of the old - bad - implementation that is provided as a workaround. &lt;/p&gt;
{@link EphemeralType#TTL_3_5_3_EMULATION_PROPERTY}
&lt;p&gt;    + * can be used to emulate support of the badly specified TTL nodes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public enum OldEphemeralType {&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Not ephemeral&lt;br/&gt;
    +     */&lt;br/&gt;
    +    VOID,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Standard, pre-3.5.x EPHEMERAL&lt;br/&gt;
    +     */&lt;br/&gt;
    +    NORMAL,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Container node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    CONTAINER,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * TTL node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    TTL;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static OldEphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, that&apos;s fine with the emulate353 flag.&lt;br/&gt;
    My concern is that we keep 2 enums in the codebase: `EphemeralType` and `OldEphemeralType` while I think it&apos;d be nicer to build the functionality of the old enum into the new one.&lt;/p&gt;</comment>
                            <comment id="16372998" author="githubbot" created="Thu, 22 Feb 2018 16:11:35 +0000"  >&lt;p&gt;Github user Randgalt commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r170009123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r170009123&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/OldEphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,74 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * version 3.5.3 introduced bugs associated with how TTL nodes were implemented. version 3.5.4&lt;br/&gt;
    + * fixes the problems but makes TTL nodes created in 3.5.3 invalid. OldEphemeralType is a copy&lt;br/&gt;
    + * of the old - bad - implementation that is provided as a workaround. &lt;/p&gt;
{@link EphemeralType#TTL_3_5_3_EMULATION_PROPERTY}
&lt;p&gt;    + * can be used to emulate support of the badly specified TTL nodes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public enum OldEphemeralType {&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Not ephemeral&lt;br/&gt;
    +     */&lt;br/&gt;
    +    VOID,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Standard, pre-3.5.x EPHEMERAL&lt;br/&gt;
    +     */&lt;br/&gt;
    +    NORMAL,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Container node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    CONTAINER,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * TTL node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    TTL;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static OldEphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I put it in `OldEphemeralType` so it&apos;s easier to remove and reason about. The emulation is a separate concern.&lt;/p&gt;</comment>
                            <comment id="16387728" author="githubbot" created="Tue, 6 Mar 2018 13:12:02 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377#discussion_r172509908&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377#discussion_r172509908&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/OldEphemeralType.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,74 @@&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + * &amp;lt;p/&amp;gt;&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.zookeeper.server;&lt;br/&gt;
    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * See &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * version 3.5.3 introduced bugs associated with how TTL nodes were implemented. version 3.5.4&lt;br/&gt;
    + * fixes the problems but makes TTL nodes created in 3.5.3 invalid. OldEphemeralType is a copy&lt;br/&gt;
    + * of the old - bad - implementation that is provided as a workaround. &lt;/p&gt;
{@link EphemeralType#TTL_3_5_3_EMULATION_PROPERTY}
&lt;p&gt;    + * can be used to emulate support of the badly specified TTL nodes.&lt;br/&gt;
    + */&lt;br/&gt;
    +public enum OldEphemeralType {&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Not ephemeral&lt;br/&gt;
    +     */&lt;br/&gt;
    +    VOID,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Standard, pre-3.5.x EPHEMERAL&lt;br/&gt;
    +     */&lt;br/&gt;
    +    NORMAL,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Container node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    CONTAINER,&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * TTL node&lt;br/&gt;
    +     */&lt;br/&gt;
    +    TTL;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static final long CONTAINER_EPHEMERAL_OWNER = Long.MIN_VALUE;&lt;br/&gt;
    +    public static final long MAX_TTL = 0x0fffffffffffffffL;&lt;br/&gt;
    +    public static final long TTL_MASK = 0x8000000000000000L;&lt;br/&gt;
    +&lt;br/&gt;
    +    public static OldEphemeralType get(long ephemeralOwner) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Makes sense.&lt;br/&gt;
    I think it would be slightly more accurate to name the old enum to `EphemeralTypeEmu353`.&lt;br/&gt;
    What do you think?&lt;/p&gt;</comment>
                            <comment id="16387751" author="githubbot" created="Tue, 6 Mar 2018 13:21:40 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @Randgalt @phunt I think this PR is in a pretty good shape, we should finalize it. Any thoughts or outstanding concerns?&lt;/p&gt;</comment>
                            <comment id="16409744" author="githubbot" created="Thu, 22 Mar 2018 15:43:03 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @afine This one is also an important PR to review and merge if you have a chance. I think it&apos;s already in a good shape.&lt;/p&gt;</comment>
                            <comment id="16469587" author="phunt" created="Wed, 9 May 2018 22:12:54 +0000"  >&lt;p&gt;Issue resolved by pull request 377&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/377&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16469623" author="hudson" created="Wed, 9 May 2018 22:38:39 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #16 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/16/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/16/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2901&quot; title=&quot;Session ID that is negative causes mis-calculation of Ephemeral Type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2901&quot;&gt;&lt;del&gt;ZOOKEEPER-2901&lt;/del&gt;&lt;/a&gt;: TTL Nodes don&apos;t work with Server IDs &amp;gt; 127 (phunt: rev ceaeccd6e310983d37e685a9d5fff3d7e75cf125)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/ContainerManager.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/main/org/apache/zookeeper/server/OldEphemeralType.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/test/TruncateTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/test/ClientBase.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/ZooKeeper.java&lt;/li&gt;
	&lt;li&gt;(edit) src/docs/src/documentation/content/xdocs/zookeeperProgrammers.xml&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/DataTree.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/EphemeralType.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/CreateContainerTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/docs/src/documentation/content/xdocs/zookeeperAdmin.xml&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/cli/CreateCommand.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/Emulate353TTLTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/CreateTTLTest.java&lt;/li&gt;
	&lt;li&gt;(add) src/java/test/org/apache/zookeeper/server/ServerIdTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/config/findbugsExcludeFile.xml&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/EphemeralTypeTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12995259">ZOOKEEPER-2503</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12820594">ZOOKEEPER-2163</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12821659">ZOOKEEPER-2169</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13104422">ZOOKEEPER-2903</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kbav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>