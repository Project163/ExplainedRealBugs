<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3531] Synchronization on ACLCache cause cluster to hang when network/disk issues happen during datatree serialization</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3531</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;During our ZooKeeper fault injection testing, we observed that sometimes the ZK cluster could hang (requests time out, node status shows ok). After inspecting the issue, we believe this is caused by I/O (serializing ACLCache) inside a critical section. The bug is essentially similar to what is described in ZooKeeper-2201.&lt;/p&gt;

&lt;p&gt;org.apache.zookeeper.server.DataTree#serialize calls the aclCache.serialize when doing dataree serialization, however, org.apache.zookeeper.server.ReferenceCountedACLCache#serialize could get stuck at OutputArchieve.writeInt due to potential network/disk issues. This can cause the system experiences hanging issues similar to ZooKeeper-2201 (any attempt to create/delete/modify the DataNode will cause the leader to hang at the beginning of the request processor chain). The root cause is the lock contention between:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.zookeeper.server.DataTree#serialize -&amp;gt; org.apache.zookeeper.server.ReferenceCountedACLCache#serialize&#160;&lt;/li&gt;
	&lt;li&gt;PrepRequestProcessor#getRecordForPath -&amp;gt; org.apache.zookeeper.server.DataTree#getACL(org.apache.zookeeper.server.DataNode) -&amp;gt; org.apache.zookeeper.server.ReferenceCountedACLCache#convertLong&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When the snapshot gets stuck in acl serialization, it would prevent all other operations to ReferenceCountedACLCache. Since getRecordForPath calls ReferenceCountedACLCache#convertLong, any op triggering getRecordForPath will cause the leader to hang at the beginning of the request processor chain:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:87)
org.apache.zookeeper.server.DataTree.getACL(DataTree.java:734)
&#160;&#160;&#160;- locked org.apache.zookeeper.server.DataNode@4a062b7d
org.apache.zookeeper.server.ZKDatabase.aclForNode(ZKDatabase.java:371)
org.apache.zookeeper.server.PrepRequestProcessor.getRecordForPath(PrepRequestProcessor.java:170)
&#160;&#160;&#160;- locked java.util.ArrayDeque@3f7394f7
org.apache.zookeeper.server.PrepRequestProcessor.pRequest2Txn(PrepRequestProcessor.java:417)
org.apache.zookeeper.server.PrepRequestProcessor.pRequest(PrepRequestProcessor.java:757)
org.apache.zookeeper.server.PrepRequestProcessor.run(PrepRequestProcessor.java:145)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Similar to ZooKeeper-2201, the leader can still send out heartbeats so the cluster will not recover until the network/disk issue resolves.&#160;&#160;&lt;/p&gt;

&lt;p&gt;Steps to reproduce this bug:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;start a cluster with 1 leader and n followers&lt;/li&gt;
	&lt;li&gt;manually create some ACLs, to enlarge the window of dumping acls so it would be more likely to hang at serializing ACLCache when delay happens. (we wrote a script to generate such workloads, see attachments)&lt;/li&gt;
	&lt;li&gt;inject long network/disk write delays and run some benchmarks to trigger snapshots&lt;/li&gt;
	&lt;li&gt;once stuck, you should observe new requests to the cluster would fail.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Essentially the core problem is the OutputArchive write should not be kept inside this synchronization block. So a straightforward solution is to move writes out of sync block: do a copy inside the sync block and perform vulnerable network writes afterwards. The patch for this solution is attached and verified.&#160; Another more systematic fix is perhaps replacing all synchronized methods in the ReferenceCountedACLCache with ConcurrentHashMap.&#160;&lt;/p&gt;

&lt;p&gt;We double checked that the issue remains in the latest version of master branch (68c21988d55c57e483370d3ee223c22da2d1bbcf).&#160;&lt;/p&gt;

&lt;p&gt;Attachments are 1) patch for fix and regression test 2) scripts to generate workloads to fill ACL cache&lt;/p&gt;</description>
                <environment></environment>
        <key id="13254299">ZOOKEEPER-3531</key>
            <summary>Synchronization on ACLCache cause cluster to hang when network/disk issues happen during datatree serialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chlou">Chang Lou</assignee>
                                    <reporter username="chlou">Chang Lou</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 2 Sep 2019 21:02:01 +0000</created>
                <updated>Wed, 9 Oct 2019 19:28:00 +0000</updated>
                            <resolved>Wed, 9 Oct 2019 14:39:04 +0000</resolved>
                                    <version>3.5.2</version>
                    <version>3.5.3</version>
                    <version>3.5.4</version>
                    <version>3.5.5</version>
                                    <fixVersion>3.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10200">2h 50m</timespent>
                                <comments>
                            <comment id="16921815" author="hanm" created="Wed, 4 Sep 2019 01:55:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chlou&quot; class=&quot;user-hover&quot; rel=&quot;chlou&quot;&gt;chlou&lt;/a&gt; thanks for detailed analysis of the issue. do you mind creating a pull request from your patch? see instructions here: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16921818" author="chlou" created="Wed, 4 Sep 2019 01:58:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;&#160;No problem, I&apos;m happy to. I&apos;ll attach the link shortly after.&lt;/p&gt;</comment>
                            <comment id="16921885" author="chlou" created="Wed, 4 Sep 2019 02:33:01 +0000"  >&lt;p&gt;Pull request created.&lt;/p&gt;</comment>
                            <comment id="16922835" author="lvfangmin" created="Wed, 4 Sep 2019 20:24:09 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chlou&quot; class=&quot;user-hover&quot; rel=&quot;chlou&quot;&gt;chlou&lt;/a&gt;&#160;for reporting the issue, I&apos;ve commented in the PR.&lt;/p&gt;</comment>
                            <comment id="16924398" author="chlou" created="Fri, 6 Sep 2019 16:46:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;&#160;I updated my comments in the github PR, any feedbacks are appreciated, thx!&lt;/p&gt;</comment>
                            <comment id="16947756" author="andorm" created="Wed, 9 Oct 2019 14:39:04 +0000"  >&lt;p&gt;Issue resolved by pull request 1077&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1077&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16947758" author="andorm" created="Wed, 9 Oct 2019 14:41:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chlou&quot; class=&quot;user-hover&quot; rel=&quot;chlou&quot;&gt;chlou&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I added you to the contributors list. Now you can assign ZooKeeper tickets to yourself.&lt;/p&gt;</comment>
                            <comment id="16947858" author="hudson" created="Wed, 9 Oct 2019 17:10:50 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #730 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/730/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/730/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3531&quot; title=&quot;Synchronization on ACLCache cause cluster to hang when network/disk issues happen during datatree serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3531&quot;&gt;&lt;del&gt;ZOOKEEPER-3531&lt;/del&gt;&lt;/a&gt;: Synchronization on ACLCache cause cluster to hang whe&#8230; (andor: rev f4c7b698bd239bcd15ee380d2ee38814dba432cd)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/ReferenceCountedACLCache.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/DataTreeTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16947937" author="hudson" created="Wed, 9 Oct 2019 19:10:22 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #568 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/568/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/568/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3531&quot; title=&quot;Synchronization on ACLCache cause cluster to hang when network/disk issues happen during datatree serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3531&quot;&gt;&lt;del&gt;ZOOKEEPER-3531&lt;/del&gt;&lt;/a&gt;: Synchronization on ACLCache cause cluster to hang whe&#8230; (andor: rev f4c7b698bd239bcd15ee380d2ee38814dba432cd)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/DataTreeTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/ReferenceCountedACLCache.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16947945" author="chlou" created="Wed, 9 Oct 2019 19:28:00 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt;! I&apos;m looking into some open issues particularly close to our on-going failure study and see if I could start to help from there.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12979174" name="fix.patch" size="4351" author="chlou" created="Mon, 2 Sep 2019 21:00:07 +0000"/>
                            <attachment id="12979173" name="generator.py" size="287" author="chlou" created="Mon, 2 Sep 2019 21:01:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z069bk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>