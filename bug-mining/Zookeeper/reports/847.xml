<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:00:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2684] Fix a crashing bug in the mixed workloads commit processor</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2684</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We deployed our build with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2024&quot; title=&quot;Major throughput improvement with mixed workloads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2024&quot;&gt;&lt;del&gt;ZOOKEEPER-2024&lt;/del&gt;&lt;/a&gt; and it quickly started to crash with the following error&lt;/p&gt;

&lt;p&gt;atla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:24:42,305 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:2&amp;#93;&lt;/span&gt; -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) &#8211; Got cxid 0x119fa expected 0x11fc5 for client session id 1009079ba470055&lt;br/&gt;
atla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:32:04,746 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:2&amp;#93;&lt;/span&gt; -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) &#8211; Got cxid 0x698 expected 0x928 for client session id 4002eeb3fd0009d&lt;br/&gt;
atla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:34:46,648 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:2&amp;#93;&lt;/span&gt; -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) &#8211; Got cxid 0x8904 expected 0x8f34 for client session id 51b8905c90251&lt;br/&gt;
atla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:43:46,834 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:2&amp;#93;&lt;/span&gt; -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) &#8211; Got cxid 0x3a8d expected 0x3ebc for client session id 2051af11af900cc&lt;/p&gt;

&lt;p&gt;clearly something is not right in the new commit processor per session queue implementation.&lt;/p&gt;</description>
                <environment>&lt;p&gt;with pretty heavy load on a real cluster&lt;/p&gt;</environment>
        <key id="13040862">ZOOKEEPER-2684</key>
            <summary>Fix a crashing bug in the mixed workloads commit processor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kfirlevari">Kfir Lev-Ari</assignee>
                                    <reporter username="nerdyyatrice">Ryan Zhang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 7 Feb 2017 05:23:02 +0000</created>
                <updated>Wed, 30 Jan 2019 18:46:10 +0000</updated>
                            <resolved>Fri, 3 Nov 2017 04:20:04 +0000</resolved>
                                    <version>3.6.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="15855408" author="shralex" created="Tue, 7 Feb 2017 06:19:47 +0000"  >&lt;p&gt;From these logs it is difficult to know what&apos;s going on besides that some reordering is happening somewhere. It would be good to find out where exactly this happens. It would be interesting for example to see what is the cxid order in which the leader commits these operations (you can print their zxid).&lt;/p&gt;</comment>
                            <comment id="15855426" author="nerdyyatrice" created="Tue, 7 Feb 2017 06:38:13 +0000"  >&lt;p&gt;The ZK as is lacks pretty much any live debuggability so that&apos;s all it logged. I did add temporary logs to the code base and was fortunately able to repro albeit with dismal performances. I was going to put the detailed logs in the comment following this but sounds like you would like to see them in the description (which I was going to just use as a description of the problem instead of an analysis and solution). I am still debating on a proper fix (I have two less than perfect solutions) and thinking of adding a more compelling test than the test I have now but it&apos;s kinda tricky. I will put in more details and possibly the solution tomorrow if I figure out how to do the github thing,  stay tuned.&lt;/p&gt;</comment>
                            <comment id="15855428" author="shralex" created="Tue, 7 Feb 2017 06:41:04 +0000"  >&lt;p&gt;Hi Ryan, I didn&apos;t mean to rush you. Putting the logs in the comments sounds just fine.&lt;/p&gt;</comment>
                            <comment id="15855432" author="nerdyyatrice" created="Tue, 7 Feb 2017 06:44:03 +0000"  >&lt;p&gt;Sounds good, btw, is this the recommended way to communicate (through comments)?&lt;/p&gt;</comment>
                            <comment id="15855436" author="shralex" created="Tue, 7 Feb 2017 06:46:06 +0000"  >&lt;p&gt;yes, I think so&lt;/p&gt;</comment>
                            <comment id="15856615" author="kfirlevari" created="Tue, 7 Feb 2017 19:26:06 +0000"  >&lt;p&gt;Hi Ryan, is it possible that the reason you see this type of bad behavior is because it wasn&apos;t examined before in the commit processor? i.e., it&apos;s a new error message that we added in order to notify that commit messages don&apos;t follow their client order. &lt;br/&gt;
I wonder, can you to add to an un-patched version the same error message? (and see if you get that error) &lt;br/&gt;
e.g., before &lt;a href=&quot;https://github.com/apache/zookeeper/commit/9fc632c4f0a340b0a00ec6dff39c7b454c802822?diff=split#diff-5cc688a027068714af01b0ad4d292fe5L223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; point, add something like        &lt;/p&gt;

&lt;p&gt;if (pending != null &amp;amp;&amp;amp; pending.sessionId == request.sessionId &amp;amp;&amp;amp; pending.cxid &amp;gt; request.cxid) &lt;br/&gt;
 LOG.error(&quot;Got cxid 0x &quot; + Long.toHexString(request.cxid) + &quot; expected 0x&quot; + Long.toHexString(pending.cxid) + &quot; for client session id &quot; + Long.toHexString(request.sessionId));&lt;br/&gt;
 throw new IOException(&quot;Error: unexpected cxid for&quot; + &quot;client session&quot;);&lt;/p&gt;</comment>
                            <comment id="15857009" author="nerdyyatrice" created="Tue, 7 Feb 2017 23:17:03 +0000"  >&lt;p&gt;Hi, Kfir,  I think you are getting to the point. (I don&apos;t need to add the log, I knew what happened) The unpatched version just pass that request to the next processor while this patch throw an exception. I am pasting the exact reason below to save you more guess time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15857018" author="nerdyyatrice" created="Tue, 7 Feb 2017 23:24:17 +0000"  >&lt;p&gt;While I am at it, let me paste the enhanced log of a repo.&lt;/p&gt;

&lt;p&gt;The problem was created when there is a session move. When a session just moved, the new processor starts to get requests from the session so it will crash when a commit coming from previous session handler comes.  Here are the logs from on repro&lt;/p&gt;

&lt;p&gt;Learner A  got the session 0x100186ea825fa45 starting from cxid 0xfb6 &lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:03,635 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:0&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:03,636 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:0&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb7 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965514&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:03,636 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:0&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb8 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:04,123 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=0&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:04,123 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:0&amp;#93;&lt;/span&gt; - Got request sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65: expected request sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.65: for client session id 0x100186ea825fa45&lt;/p&gt;


&lt;p&gt;follower B that processed 0xfb5 and got session 0x100186ea825fa45 closed after 0Xfb5&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,234 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb0 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965515&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,345 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb1 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,659 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:delete cxid:0xfae zxid:0x8e06e3c727 txntype:2 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,659 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:create cxid:0xfaf zxid:0x8e06e3c728 txntype:1 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,664 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb2 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965516&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,764 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb3 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,056 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb4 zxi&lt;br/&gt;
d:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965517&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,363 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:delete cxid:0xfb0 zxid:0x8e06e3d4bc txntype:2 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,465 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:create cxid:0xfb1 zxid:0x8e06e3d718 txntype:1 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,804 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:delete cxid:0xfb2 zxid:0x8e06e3de59 txntype:2 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,882 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:create cxid:0xfb3 zxid:0x8e06e3dfe6 txntype:1 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:36,150 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001&lt;br/&gt;
86ea825fa45 type:delete cxid:0xfb4 zxid:0x8e06e3e4c8 txntype:2 reqpath:n/a&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:56:03,132 - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOWorkerThread-16&amp;#93;&lt;/span&gt; - Unable to read additional data from client sessionid 0x100186ea825fa45, likely clie&lt;br/&gt;
nt has closed socket&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:56:03,136 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:56:04,123 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a&lt;/p&gt;

&lt;p&gt;2017-02-06 20:56:03,136 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_&lt;br/&gt;
2017-02-06 20:56:04,123 - INFO  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a&lt;/p&gt;

&lt;p&gt;the leader got 0xfb5 first&lt;br/&gt;
2017-02-06 20:56:04,122 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Leader proposing: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a&lt;br/&gt;
2017-02-06 20:56:04,122 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.40.89.122:42232&amp;#93;&lt;/span&gt; - Commit a proposal: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a&lt;/p&gt;

&lt;p&gt;and then 0xfb6&lt;br/&gt;
2017-02-06 20:56:04,610 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Leader proposing: sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxid:0x8e06e60bfb txntype:1 reqpath:n/a&lt;br/&gt;
2017-02-06 20:56:04,611 - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.40.91.124:52180&amp;#93;&lt;/span&gt; - Commit a proposal: sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxid:0x8e06e60bfb txntype:1 reqpath:n/a&lt;/p&gt;

&lt;p&gt;So there is no out of order commit but the session queue in the commitProcessor gets created before the last commit from previous session life comes.&lt;/p&gt;</comment>
                            <comment id="15857354" author="shralex" created="Wed, 8 Feb 2017 04:04:11 +0000"  >&lt;p&gt;Hi Ryan,&lt;/p&gt;

&lt;p&gt;Thanks for the analysis! How about throwing an exception only in case we see a cxid &amp;gt; what we expected, and only logging if we see something smaller than expected ?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Alex&lt;/p&gt;</comment>
                            <comment id="15857357" author="kfirlevari" created="Wed, 8 Feb 2017 04:07:26 +0000"  >&lt;p&gt;+ to what Alex wrote - handle the case of &amp;lt; as a remote session commit. &lt;br/&gt;
I.e., something like these changes:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; change the &quot;!=&quot; to &quot;&amp;gt;&quot;.&lt;/p&gt;

&lt;p&gt;and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L255&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; need to &quot;peek&quot; instead of &quot;poll&quot;.&lt;/p&gt;

&lt;p&gt;and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; need to add &lt;/p&gt;

&lt;p&gt;&quot;if (request.cxid == topPending.cxid) {&lt;br/&gt;
sessionQueue.poll();&quot;&lt;br/&gt;
and the rest of the local request processing up until &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; line.&lt;/p&gt;</comment>
                            <comment id="15857452" author="nerdyyatrice" created="Wed, 8 Feb 2017 05:46:40 +0000"  >&lt;p&gt;Alex, yes, I think the solution is pretty much along this line after we know what leads to this crash.&lt;/p&gt;

&lt;p&gt;Kfir, I am sorry that I can&apos;t really make out exactly what those &quot;this&quot; links point to, can you put a line number somewhere?&lt;/p&gt;

&lt;p&gt;In any case, I have a fix along the line of knowing the first CXid of the session this server sees and only does the comparison to queue head when it&apos;s larger than that. I am testing it internally and also trying to figure out how to do that github and &quot;pull request&quot; thing if I am happy with the result. I am still working on a test case that can repro this reliably and being unsuccessful so far.&lt;/p&gt;</comment>
                            <comment id="15857465" author="nerdyyatrice" created="Wed, 8 Feb 2017 06:03:16 +0000"  >&lt;p&gt;newbie questions, there seems to be two git remote ( &lt;a href=&quot;https://github.com/apache/zookeeper.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper.git&lt;/a&gt; and &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf/zookeeper.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf/zookeeper.git&lt;/a&gt;), which one should I pick?&lt;br/&gt;
Which branch should I base on? My understanding is that this is in 3.6 but there is no 3.6 branch, does this mean I will patch it on top of master?&lt;/p&gt;</comment>
                            <comment id="15857467" author="hanm" created="Wed, 8 Feb 2017 06:06:25 +0000"  >&lt;p&gt;Please use &lt;a href=&quot;https://github.com/apache/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper&lt;/a&gt; - fork it and you can create pull request.&lt;br/&gt;
branch master is for 3.6 so yes, patch on top of master.&lt;/p&gt;</comment>
                            <comment id="15857469" author="hanm" created="Wed, 8 Feb 2017 06:09:13 +0000"  >&lt;p&gt;btw more info on &lt;a href=&quot;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&lt;/a&gt; (section Pull requests via github)&lt;/p&gt;</comment>
                            <comment id="15857496" author="kfirlevari" created="Wed, 8 Feb 2017 06:37:51 +0000"  >&lt;p&gt;Ryan, sorry for the mess I wrote, I&apos;ll write it again as a patch so that we&apos;ll see we&apos;re on the same page (I&apos;ll try to write a unit test that cover the case you identified).&lt;/p&gt;</comment>
                            <comment id="15857529" author="nerdyyatrice" created="Wed, 8 Feb 2017 06:59:10 +0000"  >&lt;p&gt;Hi, Michael,  the link you and Alex gave me has the &quot;git clone &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf/zookeeper.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf/zookeeper.git&lt;/a&gt;&quot;  as the first command, that&apos;s why I was confused, I guess I will go through the github route. Thanks for the clarification.&lt;/p&gt;
</comment>
                            <comment id="15857531" author="nerdyyatrice" created="Wed, 8 Feb 2017 07:00:24 +0000"  >&lt;p&gt;Hi, Kfir, I have a unit case and it&apos;s not bad. The problem is to come up with a quorum based test.&lt;/p&gt;</comment>
                            <comment id="15857680" author="kfirlevari" created="Wed, 8 Feb 2017 08:51:44 +0000"  >&lt;p&gt;Hi Ryan, do you mean that you want  to test it on several running servers? &lt;br/&gt;
I think you can modify the system test (or the upgraded one here - &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2023&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2023&lt;/a&gt;) by making clients to change server every couple of writes. &lt;br/&gt;
If this is what you need I can add it as well to 2023. &lt;br/&gt;
I&apos;m also attaching a patch, let me know if you agree with it. &lt;/p&gt;</comment>
                            <comment id="15858474" author="nerdyyatrice" created="Wed, 8 Feb 2017 20:05:07 +0000"  >&lt;p&gt;Hi, Kfir, when I say a quorum based test I mean a test class that extends the QuorumBase class.&lt;/p&gt;

&lt;p&gt;as for your patch, the biggest question for me is that how does it check that the commit is not duplicated? The request could have been processed in the queue before. On a high level, I am not sure what piece of code ensures that won&apos;t happen (I assume in the lead code but I don&apos;t know on top of my head). My approach is to remember the first CXid ever appeared but it&apos;s kinda messy. If you can point me to that code guarantee no duplication and no reorder then I think I would be happy to not be so strict here in the commitProcessor&lt;/p&gt;
</comment>
                            <comment id="15858769" author="hanm" created="Thu, 9 Feb 2017 00:29:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nerdyyatrice&quot; class=&quot;user-hover&quot; rel=&quot;nerdyyatrice&quot;&gt;nerdyyatrice&lt;/a&gt; The wiki page was a little bit out dated - I just updated the page &lt;a href=&quot;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute&lt;/a&gt; hopefully will create less confusions for new contributors.&lt;/p&gt;</comment>
                            <comment id="15859210" author="kfirlevari" created="Thu, 9 Feb 2017 08:38:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nerdyyatrice&quot; class=&quot;user-hover&quot; rel=&quot;nerdyyatrice&quot;&gt;nerdyyatrice&lt;/a&gt;, can you please describe the scenario in which the same request is processed in the queue twice? &lt;/p&gt;

&lt;p&gt;As I see it, if a request r is received from a local client, then r is added to the queue (note that r was already sent to the leader prior to that point).&lt;/p&gt;

&lt;p&gt;Once a commit arrives from the leader, r is processed, and r won&apos;t be back to the queue, regardless of a possible client disconnection (AFAIK, the connection is only needed at the end of the line, when some kind of result is returned).&lt;/p&gt;

&lt;p&gt;Now, lets say the client gets disconnected at some point in the time frame above while r is processed, and connects to some server (same server or different). &lt;/p&gt;

&lt;p&gt;If a commit arrives to a different server, r will be processed as if it belongs to a remote client, i.e., we will only perform the update, without using the connection. I&apos;m not sure that after disconnection ZK is required to inform the client&apos;s new session on his past actions.. (but I guess it can also be fixed if needed).&lt;br/&gt;
If a commit arrives and r is in the queue waiting for it, then it is processed as if it belongs to a local connected client, but eventually the connection handle will show that that connection ended, (if I remember the code correctly), so nothing to report, but ZK continue as usual. &lt;/p&gt;

&lt;p&gt;Note that if a client writes something with lower cxid than r, the commit processor doesn&apos;t track such a behavior, i.e., it is possible that the next head after r will have lower cxid than r. We only care about the order of commits that we receive from the leader, and that order can&apos;t be changed, because it is based on the network protocol order of messages (i.e., if r was already sent to the leader, than clearly r is committed prior to any new message of the same client). &lt;/p&gt;

&lt;p&gt;Bottom line, it seems like r is processed only once per processor. What am I missing?&lt;/p&gt;</comment>
                            <comment id="15860081" author="nerdyyatrice" created="Thu, 9 Feb 2017 19:52:41 +0000"  >&lt;p&gt;Kfir Lev-Ari, no, you are not missing anything. I just wondered how does ZK guarantee that the same request won&apos;t be send to the commit processor twice as a lot of strange things can happen in a distributed system. I would like to add a check in the commit processor but my implementation is a bit messier than I like, otherwise I think it won&apos;t hurt even if this never happens.&lt;/p&gt;</comment>
                            <comment id="15860130" author="kfirlevari" created="Thu, 9 Feb 2017 20:22:50 +0000"  >&lt;p&gt;Oh, I see. Well, the leader is the one that sends commit messages (i.e., saying that an update should be committed). &lt;br/&gt;
Unless I&apos;m mistaken, based on ZAB (i.e., ZK&apos;s consensus algorithm), leaders wouldn&apos;t send commit of the same message twice. I&apos;m not sure about the exact locations in the code that you can read in order to validate it (here is a link about ZAB - &lt;a href=&quot;https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="15860158" author="shralex" created="Thu, 9 Feb 2017 20:38:51 +0000"  >&lt;p&gt;If I understand the concern correctly, you&apos;re worried that we&apos;d consider a duplicate request as legitimate because it has op cxid &amp;lt; queued cxid like in the session migration case. I agree that if something goes wrong that&apos;s possible. But, I think we should just log this when it happens, maybe Log.warn. This is very similar&lt;br/&gt;
to what is done in other parts of ZooKeeper, see for example Follower.java  when the follower gets a proposal which it doesn&apos;t expect. &lt;/p&gt;

&lt;p&gt;It is also somewhat related to ZooKeeper-22 Jira, which is about identifying whether a client&apos;s operation has been executed or not. I don&apos;t think we want to tackle it here.&lt;/p&gt;</comment>
                            <comment id="15860200" author="nerdyyatrice" created="Thu, 9 Feb 2017 21:02:55 +0000"  >&lt;p&gt;Sounds good to me. I will change my implementation then. I am still trying to figure out the github thing so please go ahead with the patch if I don&apos;t get time to do a pull request (which is not the same as doing a patch here, I guess?)&lt;/p&gt;</comment>
                            <comment id="15860525" author="nerdyyatrice" created="Fri, 10 Feb 2017 01:38:12 +0000"  >&lt;p&gt;k, I followed the instruction and (I think) submitted a pull request &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;. What&apos;s next?&lt;/p&gt;</comment>
                            <comment id="15860894" author="githubbot" created="Fri, 10 Feb 2017 08:06:42 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167#discussion_r100486359&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167#discussion_r100486359&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -251,27 +252,29 @@ public void run() {&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
    +                        Request topPending = sessionQueue.peekFirst();&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Request topPending = sessionQueue.poll();&lt;/li&gt;
	&lt;li&gt;if (request.cxid != topPending.cxid) {&lt;/li&gt;
	&lt;li&gt;LOG.error(&lt;/li&gt;
	&lt;li&gt;&quot;Got cxid 0x&quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; expected 0x&quot; + Long.toHexString(&lt;/li&gt;
	&lt;li&gt;topPending.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; for client session id &quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.sessionId));&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Error: unexpected cxid for&quot;&lt;/li&gt;
	&lt;li&gt;+ &quot;client session&quot;);&lt;br/&gt;
    +                        // we can get commit requests for requests before we even get this session&lt;br/&gt;
    +                        //(see &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;). We will just pass those commits to the next processor.&lt;br/&gt;
    +                        if(request.cxid &amp;lt; topPending.cxid) 
{
    +                            LOG.warn(&quot;Got commit request &quot; + request
    +                                + &quot; that is less than our queue head &quot; + topPending);
    +                        }
&lt;p&gt; else {&lt;br/&gt;
    +                            topPending = sessionQueue.poll();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Do you mind separating the if into 3 cases instead of 2 ? here&apos;s a suggestion:&lt;br/&gt;
    if ( &amp;lt; )&lt;br/&gt;
        // comment here about this case, pointing to the JIRA.&lt;br/&gt;
       Log.warn&lt;br/&gt;
    else if ( &amp;gt; )&lt;br/&gt;
       Log error, throw exception&lt;br/&gt;
    else&lt;br/&gt;
       poll and do what the old code does.&lt;/p&gt;</comment>
                            <comment id="15860895" author="githubbot" created="Fri, 10 Feb 2017 08:06:42 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167#discussion_r100486141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167#discussion_r100486141&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -251,27 +252,29 @@ public void run() {&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
    +                        Request topPending = sessionQueue.peekFirst();&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Request topPending = sessionQueue.poll();&lt;/li&gt;
	&lt;li&gt;if (request.cxid != topPending.cxid) {&lt;/li&gt;
	&lt;li&gt;LOG.error(&lt;/li&gt;
	&lt;li&gt;&quot;Got cxid 0x&quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; expected 0x&quot; + Long.toHexString(&lt;/li&gt;
	&lt;li&gt;topPending.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; for client session id &quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.sessionId));&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Error: unexpected cxid for&quot;&lt;/li&gt;
	&lt;li&gt;+ &quot;client session&quot;);&lt;br/&gt;
    +                        // we can get commit requests for requests before we even get this session&lt;br/&gt;
    +                        //(see &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;). We will just pass those commits to the next processor.&lt;br/&gt;
    +                        if(request.cxid &amp;lt; topPending.cxid) {&lt;br/&gt;
    +                            LOG.warn(&quot;Got commit request &quot; + request
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This isn&apos;t as informative as the other messsege. Could you please use the same message format in both ?&lt;/p&gt;</comment>
                            <comment id="15860896" author="githubbot" created="Fri, 10 Feb 2017 08:06:42 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167#discussion_r100486459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167#discussion_r100486459&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -251,27 +252,29 @@ public void run() {&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
    +                        Request topPending = sessionQueue.peekFirst();&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Request topPending = sessionQueue.poll();&lt;/li&gt;
	&lt;li&gt;if (request.cxid != topPending.cxid) {&lt;/li&gt;
	&lt;li&gt;LOG.error(&lt;/li&gt;
	&lt;li&gt;&quot;Got cxid 0x&quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; expected 0x&quot; + Long.toHexString(&lt;/li&gt;
	&lt;li&gt;topPending.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; for client session id &quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.sessionId));&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Error: unexpected cxid for&quot;&lt;/li&gt;
	&lt;li&gt;+ &quot;client session&quot;);&lt;br/&gt;
    +                        // we can get commit requests for requests before we even get this session&lt;br/&gt;
    +                        //(see &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;). We will just pass those commits to the next processor.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    please remove the new comments from here and add them inside the if, where this case is handled.&lt;/p&gt;</comment>
                            <comment id="15866318" author="nerdyyatrice" created="Tue, 14 Feb 2017 18:18:30 +0000"  >&lt;p&gt;Unfortunately, this is only half of the story. I tested the build and see the following crash&lt;/p&gt;

&lt;p&gt;atla-cbo-26-sr4.prod.twttr.net:  2017-02-14 17:55:42,323 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:4&amp;#93;&lt;/span&gt; - Severe unrecoverable error, from thread : CommitProcessor:4&lt;br/&gt;
atla-cbo-26-sr4.prod.twttr.net:  org.apache.zookeeper.KeeperException$RuntimeInconsistencyException: KeeperErrorCode = RuntimeInconsistency&lt;br/&gt;
atla-cbo-26-sr4.prod.twttr.net:  	at org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:276)&lt;br/&gt;
atla-cbo-26-sr4.prod.twttr.net:  2017-02-14 18:12:25,515 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:4&amp;#93;&lt;/span&gt; - Got request sessionid:0x40069edcb5b7b7f type:create cxid:0x36 zxid:0x38205009d26 txntype:1 reqpath:n/a&lt;br/&gt;
atla-cbo-26-sr4.prod.twttr.net:   but we are expecting request sessionid:0x40069edcb5b7b7f type:delete cxid:0x30 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1759491424&lt;br/&gt;
atla-cbo-26-sr4.prod.twttr.net:  &lt;/p&gt;


&lt;p&gt;Stay tuned, I am adding back the verbose logs and will report on what I found&lt;/p&gt;</comment>
                            <comment id="15866702" author="kfirlevari" created="Tue, 14 Feb 2017 21:13:48 +0000"  >&lt;p&gt;From what I understand, seems like a session starts a connection with a smaller cxid than it had in a previous connection?&lt;/p&gt;</comment>
                            <comment id="15869349" author="nerdyyatrice" created="Thu, 16 Feb 2017 06:53:20 +0000"  >&lt;p&gt;so here is what actually happened&lt;/p&gt;

&lt;p&gt;On the server A, the request is processed right after the session connection is closed and the request is forwarded to the lead&lt;/p&gt;

&lt;p&gt;investigate.log:2017-02-14 23:30:50,373 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x14 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775503086&lt;br/&gt;
investigate.log:2017-02-14 23:30:54,327 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x15 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775503083&lt;br/&gt;
investigate.log:2017-02-14 23:30:57,888 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x16 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775503084&lt;br/&gt;
investigate.log:2017-02-14 23:31:01,583 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x17 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775493180&lt;br/&gt;
investigate.log:2017-02-14 23:31:04,867 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x18 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775493181&lt;br/&gt;
investigate.log:2017-02-14 23:31:08,150 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x19 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775985079&lt;br/&gt;
investigate.log:2017-02-14 23:31:12,672 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:getChildren2 cxid:0x1a zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen&lt;br/&gt;
investigate.log:2017-02-14 23:31:17,293 - WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;NIOWorkerThread-16&amp;#93;&lt;/span&gt; - Exception causing close of session 0x4006b1b17808b0c: Broken pipe&lt;br/&gt;
investigate.log:2017-02-14 23:31:17,297 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:4&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1776069644&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x27 zxid:0x385012a1e94 txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x28 zxid:0x385012a1e95 txntype:1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x29 zxid:0x385012a1e96 txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2a zxid:0x385012a1e98 txntype:1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,817 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2b zxid:0x385012a1e9b txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,817 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2c zxid:0x385012a1e9c txntype:1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,818 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2d zxid:0x385012a1ea1 txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,822 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2e zxid:0x385012a1eb8 txntype:1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,824 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2f zxid:0x385012a1ec0 txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:21,833 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x30 zxid:0x385012a1ee9 txntype:1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:22,048 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:error cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:31:22,690 - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CommitProcessor:4&amp;#93;&lt;/span&gt; - Got request sessionid:0x4006b1b17808b0c type:delete cxid:0x27 zxid:0x385012a1e94 txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log: but we are expecting request sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1776069644&lt;br/&gt;
investigate.log:2017-02-14 23:32:39,172 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x4c zxid:0x385012b34fa txntype:1 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:32:48,677 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x4e zxid:0x385012b6c31 txntype:2 reqpath:n/a&lt;br/&gt;
investigate.log:2017-02-14 23:32:54,580 - INFO [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=4&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: se&lt;/p&gt;


&lt;p&gt;while on the lead side, the requests are arrived out of order (in terms of Cxid) &lt;/p&gt;

&lt;p&gt;2017-02-14 23:31:21,822 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.111.116:53431&amp;#93;&lt;/span&gt; - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2e zxid:0x385012a1eb8 txntype:1 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:21,824 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.111.116:53431&amp;#93;&lt;/span&gt; - Commit a proposal: sessionid:0x4006b1b17808b0c type:delete cxid:0x2f zxid:0x385012a1ec0 txntype:2 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:21,824 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.111.116:53431&amp;#93;&lt;/span&gt; - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2f zxid:0x385012a1ec0 txntype:2 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:21,833 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.111.116:53431&amp;#93;&lt;/span&gt; - Commit a proposal: sessionid:0x4006b1b17808b0c type:create cxid:0x30 zxid:0x385012a1ee9 txntype:1 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:21,833 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.111.116:53431&amp;#93;&lt;/span&gt; - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x30 zxid:0x385012a1ee9 txntype:1 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:21,999 - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Got user-level KeeperException when processing sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644 Error Path:null Error:KeeperErrorCode = Session moved&lt;br/&gt;
investigate.log.1:2017-02-14 23:31:21,999 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644&lt;br/&gt;
investigate.log.1:2017-02-14 23:31:21,999 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Leader proposing: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644&lt;br/&gt;
investigate.log.1:2017-02-14 23:31:22,048 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.112.127:53292&amp;#93;&lt;/span&gt; - Commit a proposal: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644&lt;br/&gt;
investigate.log.1:2017-02-14 23:31:22,048 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.45.112.127:53292&amp;#93;&lt;/span&gt; - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644&lt;br/&gt;
2017-02-14 23:31:26,728 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x32 zxid:0x385012a3bd0 txntype:2 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:26,728 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Leader proposing: sessionid:0x4006b1b17808b0c type:delete cxid:0x32 zxid:0x385012a3bd0 txntype:2 reqpath:n/a&lt;br/&gt;
2017-02-14 23:31:26,728 - INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1):&amp;#93;&lt;/span&gt; - Processing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x33 zxid:0x385012a3bd1 txntype:1 reqpath:n/a&lt;/p&gt;

&lt;p&gt;Ideally, I would like to check if the server still owns the session (has a connection open) but it seems there is no easy way to check that. Any thoughts? The worst case is just be like the un-patched version to not check at all...&lt;/p&gt;</comment>
                            <comment id="15869431" author="kfirlevari" created="Thu, 16 Feb 2017 07:51:09 +0000"  >&lt;p&gt;Good catch!&lt;br/&gt;
About testing if the connection is still open - I think that the following scenario is possible:&lt;br/&gt;
1. a client C disconnects from server A.&lt;br/&gt;
2. C sends some requests via server B&lt;br/&gt;
3. C disconnects from B and returns to A. &lt;/p&gt;

&lt;p&gt;In that scenario, we&apos;ll see that C has an open connection, but still we&apos;ll receive (at A) the messages from B with higher cxid.&lt;br/&gt;
IMHO, we should just remove the check, i.e., only attach the connection info if it is equal to the pending commit we see, (as in the original version).&lt;/p&gt;</comment>
                            <comment id="15871003" author="nerdyyatrice" created="Fri, 17 Feb 2017 01:27:59 +0000"  >&lt;p&gt;That&apos;s what I thought too. I submitted the new change but the test failed at random places. How can I rekick this build?&lt;/p&gt;</comment>
                            <comment id="15924710" author="kfirlevari" created="Tue, 14 Mar 2017 18:09:12 +0000"  >&lt;p&gt;Hi Ryan, any updates regarding your patch?&lt;/p&gt;</comment>
                            <comment id="15947547" author="shralex" created="Wed, 29 Mar 2017 17:18:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nerdyyatrice&quot; class=&quot;user-hover&quot; rel=&quot;nerdyyatrice&quot;&gt;nerdyyatrice&lt;/a&gt; ping&lt;/p&gt;</comment>
                            <comment id="15977838" author="nerdyyatrice" created="Fri, 21 Apr 2017 00:11:22 +0000"  >&lt;p&gt;Sorry, didn&apos;t follow this after my previous submission got stuck. Just kicked another round and still not sure what&apos;s next.&lt;/p&gt;</comment>
                            <comment id="16016601" author="githubbot" created="Thu, 18 May 2017 22:56:32 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt; kick jenkins bot&lt;/p&gt;</comment>
                            <comment id="16016632" author="githubbot" created="Thu, 18 May 2017 23:12:23 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @nerdyyatrice I don&apos;t see Jenkins pre-commit build is kicked off for your patch. I think a combination of these should kick the build bot:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Put string &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;&quot; in pull request title. The bot running a script that looks for JIRA number.&lt;/li&gt;
	&lt;li&gt;And, after update title, close and reopen this pull request. This should again trigger a pre-commit build.&lt;br/&gt;
    Do you mind do these so we can sign off this pull request from jenkins?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16022068" author="githubbot" created="Tue, 23 May 2017 23:24:08 +0000"  >&lt;p&gt;Github user nerdyyatrice closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16022069" author="githubbot" created="Tue, 23 May 2017 23:24:11 +0000"  >&lt;p&gt;GitHub user nerdyyatrice reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt; commitProcessor does not crash when an unseen commit somes&lt;/p&gt;

&lt;p&gt;    commitProcessor with the zookeeper-2024 improvement patch throws an exception when it sees a commit request that is not at the queue head.  It turned out that it is actually a valid case when there is session movement. After discussion with the community, I submit this pull request to mitigate this issue by passing those commits to the next processor instead.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/nerdyyatrice/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nerdyyatrice/zookeeper&lt;/a&gt; zookeeper-2684&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #167&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 423e385038d055b034a71e91a503ff31532e84a2&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-02-10T01:33:23Z&lt;/p&gt;

&lt;p&gt;    commitProcessor does not crash when an unseen commit somes&lt;/p&gt;

&lt;p&gt;commit cde12800a4ddecce26d41a4870cd19ae8d7e6f15&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-02-10T02:24:19Z&lt;/p&gt;

&lt;p&gt;    commitProcessor does not crash when an unseen commit somes&lt;/p&gt;

&lt;p&gt;commit 0f7c2e815c3744d8088f12b6e802365ab164ff9a&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-02-16T20:53:56Z&lt;/p&gt;

&lt;p&gt;    remove the exception in the commit processor as commit requests can arrive out of order in terms of CXid&lt;/p&gt;

&lt;p&gt;commit d80b715620bbbef173be4acbeb022892ff13934d&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-02-16T20:59:34Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;zookeeper-2684&apos; of &lt;a href=&quot;https://github.com/nerdyyatrice/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nerdyyatrice/zookeeper&lt;/a&gt; into zookeeper-2684&lt;/p&gt;

&lt;p&gt;commit 61f4764b51c92d93cdf5b63ab617efa41e1ee44c&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-02-16T23:45:06Z&lt;/p&gt;

&lt;p&gt;    adjust the test and to re-kick the submit&lt;/p&gt;

&lt;p&gt;commit 5191fa83eb88967e91fc7df4c18a106369b0dd0c&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-04-21T00:18:51Z&lt;/p&gt;

&lt;p&gt;     &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;: Fix a crashing bug in the mixed workloads commit processor&lt;/p&gt;

&lt;p&gt;commit fde3b0eba781361e5775445ecc6cfd20efe71f05&lt;br/&gt;
Author: rzhang &amp;lt;rzhang@twitter.com&amp;gt;&lt;br/&gt;
Date:   2017-04-21T22:38:07Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;: Fix a crashing bug in the mixed workloads commit processor&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16022129" author="hadoopqa" created="Wed, 24 May 2017 00:13:57 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16022290" author="githubbot" created="Wed, 24 May 2017 04:15:39 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @nerdyyatrice I see you&apos;ve closed / reopened this PR, and the build bot is kicked off as expected.  There is the same test failure in pre-commit build: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/&lt;/a&gt;. We should get this fixed before merging this PR.&lt;/p&gt;

&lt;p&gt;    I&apos;ll try reviewing this patch in detail to understand what goes wrong here.&lt;/p&gt;</comment>
                            <comment id="16022355" author="githubbot" created="Wed, 24 May 2017 06:01:12 +0000"  >&lt;p&gt;Github user nerdyyatrice commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I can&#8217;t repro it on my laptop so I tried to see if it can pass on the machine. I will look into code in more detail. &lt;/p&gt;

&lt;p&gt;    &amp;gt; On May 23, 2017, at 9:15 PM, Michael Han &amp;lt;notifications@github.com&amp;gt; wrote:&lt;br/&gt;
    &amp;gt; &lt;br/&gt;
    &amp;gt; @nerdyyatrice &amp;lt;&lt;a href=&quot;https://github.com/nerdyyatrice&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nerdyyatrice&lt;/a&gt;&amp;gt; I see you&apos;ve closed / reopened this PR, and the build bot is kicked off as expected. There is the same test failure in pre-commit build: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/&lt;/a&gt; &amp;lt;&lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/&lt;/a&gt;&amp;gt;. We should get this fixed before merging this PR.&lt;br/&gt;
    &amp;gt; &lt;br/&gt;
    &amp;gt; I&apos;ll try reviewing this patch in detail to understand what goes wrong here.&lt;br/&gt;
    &amp;gt; &lt;br/&gt;
    &amp;gt; &#8212;&lt;br/&gt;
    &amp;gt; You are receiving this because you were mentioned.&lt;br/&gt;
    &amp;gt; Reply to this email directly, view it on GitHub &amp;lt;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/167#issuecomment-303613061&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167#issuecomment-303613061&lt;/a&gt;&amp;gt;, or mute the thread &amp;lt;&lt;a href=&quot;https://github.com/notifications/unsubscribe-auth/ALGPjMle9unhxIR4OqgDteDFY_uCDzcLks5r867ygaJpZM4L85T6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/notifications/unsubscribe-auth/ALGPjMle9unhxIR4OqgDteDFY_uCDzcLks5r867ygaJpZM4L85T6&lt;/a&gt;&amp;gt;.&lt;br/&gt;
    &amp;gt; &lt;/p&gt;

</comment>
                            <comment id="16043497" author="githubbot" created="Thu, 8 Jun 2017 21:43:29 +0000"  >&lt;p&gt;Github user fpj commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167#discussion_r121006265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167#discussion_r121006265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -254,24 +254,23 @@ public void run() {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) &lt;/p&gt;
{
    -                            LOG.error(
    -                                    &quot;Got cxid 0x&quot;
    -                                            + Long.toHexString(request.cxid)
    -                                            + &quot; expected 0x&quot; + Long.toHexString(
    -                                                    topPending.cxid)
    -                                    + &quot; for client session id &quot;
    -                                    + Long.toHexString(request.sessionId));
    -                            throw new IOException(&quot;Error: unexpected cxid for&quot;
    -                                    + &quot;client session&quot;);
    +                            // we can get commit requests that is not at the queue head when 
    +                            // session moves (see ZOOKEEPER-2684). We will just pass the 
    +                            // commit to the next processor and put the pending back with
    +                            // a warning, we should not see this often under normal load
    +                            LOG.warn(&quot;Got request &quot; + request + 
    +                                &quot; but we are expecting request &quot; + topPending);
    +                            sessionQueue.addFirst(topPending);
    +                        }
&lt;p&gt; else {                            &lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Is it the case that for a given session, once we execute the else block once, executing the if block would be incorrect? If so, would it make sense to have a flag per session indicating that the else block has not been executed for the session? It might not even be a flag per session, but perhaps a set of session ids instead that we remove from once we execute the else block.   &lt;/p&gt;</comment>
                            <comment id="16224639" author="githubbot" created="Mon, 30 Oct 2017 10:42:40 +0000"  >&lt;p&gt;GitHub user kfirlevari opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt; Fix a crashing bug in the mixed workloads commit processor&lt;/p&gt;

&lt;p&gt;    We wish to fix this long-standing issue in the code.&lt;br/&gt;
    Note that the previous commit processor algorithm had the same approach (as the one suggested in this fix) when dealing with a request that has a different cxid than session&apos;s expected one (see &lt;span class=&quot;error&quot;&gt;&amp;#91;here&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/zookeeper/commit/9fc632c4f0a340b0a00ec6dff39c7b454c802822#diff-5cc688a027068714af01b0ad4d292fe5L238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/9fc632c4f0a340b0a00ec6dff39c7b454c802822#diff-5cc688a027068714af01b0ad4d292fe5L238&lt;/a&gt;)).&lt;/p&gt;

&lt;p&gt;    This fix is based on the code from &lt;a href=&quot;https://github.com/apache/zookeeper/pull/167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/167&lt;/a&gt;, following the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kfirlevari/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kfirlevari/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #411&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7e67982430d1f88fc50a6e60aceb168851a4c88c&lt;br/&gt;
Author: Kfir Lev-Ari &amp;lt;klevari@apple.com&amp;gt;&lt;br/&gt;
Date:   2017-10-30T10:29:58Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2684&quot; title=&quot;Fix a crashing bug in the mixed workloads commit processor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2684&quot;&gt;&lt;del&gt;ZOOKEEPER-2684&lt;/del&gt;&lt;/a&gt; Fix a crashing bug in the mixed workloads commit processor&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16224664" author="hadoopqa" created="Mon, 30 Oct 2017 11:01:19 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16224777" author="githubbot" created="Mon, 30 Oct 2017 11:51:21 +0000"  >&lt;p&gt;Github user kfirlevari commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The build failed because &lt;em&gt;testNodeDataChanged&lt;/em&gt; failed (a test that doesn&apos;t seem related to the current change). &lt;br/&gt;
    It seems like zk2.create at line 122 (&lt;span class=&quot;error&quot;&gt;&amp;#91;WatchEventWhenAutoResetTest.java&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/test/WatchEventWhenAutoResetTest.java#L122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/test/WatchEventWhenAutoResetTest.java#L122&lt;/a&gt;)) is taking too long, and therefore we receive the NodeDeleted event instead of the expected NodeDataChanged (locally on my machine it didn&apos;t fail). I guess adding some kind of sleep prior to line 124 should solve this issue?&lt;/p&gt;</comment>
                            <comment id="16225126" author="githubbot" created="Mon, 30 Oct 2017 15:26:17 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @kfirlevari yeah, that&apos;s an outstanding flaky test.&lt;br/&gt;
    Here&apos;s the jira about it: &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2807&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2807&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Amend your latest commit to trigger another Jenkins build.&lt;/p&gt;</comment>
                            <comment id="16225503" author="hadoopqa" created="Mon, 30 Oct 2017 18:33:05 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16225873" author="githubbot" created="Mon, 30 Oct 2017 22:39:42 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r147854385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r147854385&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java &amp;#8212;&lt;br/&gt;
    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception &lt;/p&gt;
{
                         !processedRequests.contains(r));
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * In the following test, we verify that we can handle the case that we got a commit&lt;br/&gt;
    +     * of a request we never seen since the session that we just established. This can happen&lt;br/&gt;
    +     * when a session is just established and there is request waiting to be committed in the&lt;br/&gt;
    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 1000)&lt;br/&gt;
    +    public void noCrashOnCommittedRequestsOfUnseenRequestTest() throws Exception {&lt;br/&gt;
    +        final String path = &quot;/noCrash/OnCommittedRequests/OfUnseenRequestTest&quot;;&lt;br/&gt;
    +        final int numberofReads = 10;&lt;br/&gt;
    +        final int sessionid = 0x123456;&lt;br/&gt;
    +        final int firstCXid = 0x100;&lt;br/&gt;
    +        int readReqId = firstCXid;&lt;br/&gt;
    +        processor.stoppedMainLoop = true;&lt;br/&gt;
    +        HashSet&amp;lt;Request&amp;gt; localRequests = new HashSet&amp;lt;Request&amp;gt;();&lt;br/&gt;
    +        // queue the blocking write request to queuedRequests&lt;br/&gt;
    +        Request firstCommittedReq = newRequest(&lt;br/&gt;
    +                new CreateRequest(path, new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, Ids.OPEN_ACL_UNSAFE,&lt;br/&gt;
    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),&lt;br/&gt;
    +                OpCode.create, sessionid, readReqId++);&lt;br/&gt;
    +        processor.queuedRequests.add(firstCommittedReq);&lt;br/&gt;
    +        localRequests.add(firstCommittedReq);&lt;br/&gt;
    +&lt;br/&gt;
    +        // queue read requests to queuedRequests&lt;br/&gt;
    +        for (; readReqId &amp;lt;= numberofReads+firstCXid; ++readReqId) &lt;/p&gt;
{
    +            Request readReq = newRequest(new GetDataRequest(path, false),
    +                    OpCode.getData, sessionid, readReqId);
    +            processor.queuedRequests.add(readReq);
    +            localRequests.add(readReq);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        //run once&lt;br/&gt;
    +        Assert.assertTrue(processor.queuedRequests.containsAll(localRequests));&lt;br/&gt;
    +        processor.initThreads(numberofReads* 2);&lt;br/&gt;
    +        processor.run();&lt;br/&gt;
    +&lt;br/&gt;
    +        //We verify that the processor is waiting for the commit&lt;br/&gt;
    +        Assert.assertTrue(processedRequests.isEmpty());&lt;br/&gt;
    +&lt;br/&gt;
    +        // We add a commit that belongs to the same session but with smaller cxid,&lt;br/&gt;
    +        // i.e., commit of an update from previous connection of this session.&lt;br/&gt;
    +        Request preSessionCommittedReq = newRequest(&lt;br/&gt;
    +                new CreateRequest(path, new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, Ids.OPEN_ACL_UNSAFE,&lt;br/&gt;
    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),&lt;br/&gt;
    +                OpCode.create, sessionid, firstCXid - 2);&lt;br/&gt;
    +        processor.committedRequests.add(preSessionCommittedReq);&lt;br/&gt;
    +        processor.committedRequests.add(firstCommittedReq);&lt;br/&gt;
    +        processor.run();&lt;br/&gt;
    +&lt;br/&gt;
    +        //We verify that the commit processor processed the old commit prior to the newer messages&lt;br/&gt;
    +        Assert.assertTrue(processedRequests.peek() == preSessionCommittedReq);&lt;br/&gt;
    +&lt;br/&gt;
    +        processor.run();&lt;br/&gt;
    +&lt;br/&gt;
    +        //We verify that the commit processor handle all messages.&lt;br/&gt;
    +        Assert.assertTrue(processedRequests.containsAll(localRequests));&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * In the following test, we verify if we handle the case in which we get a commit&lt;br/&gt;
    +     * for a request that has higher Cxid than the one we are waiting. This can happen&lt;br/&gt;
    +     * when a session connection is lost but there is a request waiting to be committed in the&lt;br/&gt;
    +     * session queue. However, since the session has moved, new requests can get to&lt;br/&gt;
    +     * the leader out of order. Hence, the commits can also arrive &quot;out of order&quot; w.r.t. cxid.&lt;br/&gt;
    +     * We should commit the requests according to the order we receive from the leader, i.e., wait for the relevant commit.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    1) I think its worth while explaining the two scenarios in the CommitProcessor.java comments. I mean how its possible to get higher cxid and lower cxid from leader compared to what you expect. Including the part where requests may reach the leader out of cxid order if session is moved. &lt;/p&gt;

&lt;p&gt;    2) I wonder if in this case (receiving higher cxid from leader) we should also empty the local pending requests ? What&apos;s the value of keeping the requests in the local queue ?&lt;/p&gt;</comment>
                            <comment id="16226141" author="githubbot" created="Tue, 31 Oct 2017 02:37:11 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r147883484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r147883484&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -255,24 +255,23 @@ public void run() {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) &lt;/p&gt;
{
    -                            LOG.error(
    -                                    &quot;Got cxid 0x&quot;
    -                                            + Long.toHexString(request.cxid)
    -                                            + &quot; expected 0x&quot; + Long.toHexString(
    -                                                    topPending.cxid)
    -                                    + &quot; for client session id &quot;
    -                                    + Long.toHexString(request.sessionId));
    -                            throw new IOException(&quot;Error: unexpected cxid for&quot;
    -                                    + &quot;client session&quot;);
    +                            // we can get commit requests that are not at the queue head after
    +                            // a session moved (see ZOOKEEPER-2684). We will just pass the
    +                            // commit to the next processor and put the pending back with
    +                            // a warning, we should not see this often under normal load
    +                            LOG.warn(&quot;Got request &quot; + request +
    +                                    &quot; but we are expecting request &quot; + topPending);
    +                            sessionQueue.addFirst(topPending);
    +                        }
&lt;p&gt; else {&lt;br/&gt;
    +                            /*&lt;br/&gt;
    +                             * We want to send our version of the request. the&lt;br/&gt;
    +                             * pointer to the connection in the request&lt;br/&gt;
    +                             */&lt;br/&gt;
    +                            topPending.setHdr(request.getHdr());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Would you mind explaining why we normally want to send our version of the request and why it is ok not to in this case?&lt;/p&gt;</comment>
                            <comment id="16226142" author="githubbot" created="Tue, 31 Oct 2017 02:37:11 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r147854977&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r147854977&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java &amp;#8212;&lt;br/&gt;
    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception &lt;/p&gt;
{
                         !processedRequests.contains(r));
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * In the following test, we verify that we can handle the case that we got a commit&lt;br/&gt;
    +     * of a request we never seen since the session that we just established. This can happen&lt;br/&gt;
    +     * when a session is just established and there is request waiting to be committed in the&lt;br/&gt;
    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    typo: &quot;in the in the&quot;&lt;/p&gt;</comment>
                            <comment id="16226888" author="githubbot" created="Tue, 31 Oct 2017 14:35:04 +0000"  >&lt;p&gt;Github user kfirlevari commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148014302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148014302&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java &amp;#8212;&lt;br/&gt;
    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception &lt;/p&gt;
{
                         !processedRequests.contains(r));
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * In the following test, we verify that we can handle the case that we got a commit&lt;br/&gt;
    +     * of a request we never seen since the session that we just established. This can happen&lt;br/&gt;
    +     * when a session is just established and there is request waiting to be committed in the&lt;br/&gt;
    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.&lt;br/&gt;
    +     */&lt;br/&gt;
    +    @Test(timeout = 1000)&lt;br/&gt;
    +    public void noCrashOnCommittedRequestsOfUnseenRequestTest() throws Exception {&lt;br/&gt;
    +        final String path = &quot;/noCrash/OnCommittedRequests/OfUnseenRequestTest&quot;;&lt;br/&gt;
    +        final int numberofReads = 10;&lt;br/&gt;
    +        final int sessionid = 0x123456;&lt;br/&gt;
    +        final int firstCXid = 0x100;&lt;br/&gt;
    +        int readReqId = firstCXid;&lt;br/&gt;
    +        processor.stoppedMainLoop = true;&lt;br/&gt;
    +        HashSet&amp;lt;Request&amp;gt; localRequests = new HashSet&amp;lt;Request&amp;gt;();&lt;br/&gt;
    +        // queue the blocking write request to queuedRequests&lt;br/&gt;
    +        Request firstCommittedReq = newRequest(&lt;br/&gt;
    +                new CreateRequest(path, new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, Ids.OPEN_ACL_UNSAFE,&lt;br/&gt;
    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),&lt;br/&gt;
    +                OpCode.create, sessionid, readReqId++);&lt;br/&gt;
    +        processor.queuedRequests.add(firstCommittedReq);&lt;br/&gt;
    +        localRequests.add(firstCommittedReq);&lt;br/&gt;
    +&lt;br/&gt;
    +        // queue read requests to queuedRequests&lt;br/&gt;
    +        for (; readReqId &amp;lt;= numberofReads+firstCXid; ++readReqId) &lt;/p&gt;
{
    +            Request readReq = newRequest(new GetDataRequest(path, false),
    +                    OpCode.getData, sessionid, readReqId);
    +            processor.queuedRequests.add(readReq);
    +            localRequests.add(readReq);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        //run once&lt;br/&gt;
    +        Assert.assertTrue(processor.queuedRequests.containsAll(localRequests));&lt;br/&gt;
    +        processor.initThreads(numberofReads* 2);&lt;br/&gt;
    +        processor.run();&lt;br/&gt;
    +&lt;br/&gt;
    +        //We verify that the processor is waiting for the commit&lt;br/&gt;
    +        Assert.assertTrue(processedRequests.isEmpty());&lt;br/&gt;
    +&lt;br/&gt;
    +        // We add a commit that belongs to the same session but with smaller cxid,&lt;br/&gt;
    +        // i.e., commit of an update from previous connection of this session.&lt;br/&gt;
    +        Request preSessionCommittedReq = newRequest(&lt;br/&gt;
    +                new CreateRequest(path, new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;, Ids.OPEN_ACL_UNSAFE,&lt;br/&gt;
    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),&lt;br/&gt;
    +                OpCode.create, sessionid, firstCXid - 2);&lt;br/&gt;
    +        processor.committedRequests.add(preSessionCommittedReq);&lt;br/&gt;
    +        processor.committedRequests.add(firstCommittedReq);&lt;br/&gt;
    +        processor.run();&lt;br/&gt;
    +&lt;br/&gt;
    +        //We verify that the commit processor processed the old commit prior to the newer messages&lt;br/&gt;
    +        Assert.assertTrue(processedRequests.peek() == preSessionCommittedReq);&lt;br/&gt;
    +&lt;br/&gt;
    +        processor.run();&lt;br/&gt;
    +&lt;br/&gt;
    +        //We verify that the commit processor handle all messages.&lt;br/&gt;
    +        Assert.assertTrue(processedRequests.containsAll(localRequests));&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * In the following test, we verify if we handle the case in which we get a commit&lt;br/&gt;
    +     * for a request that has higher Cxid than the one we are waiting. This can happen&lt;br/&gt;
    +     * when a session connection is lost but there is a request waiting to be committed in the&lt;br/&gt;
    +     * session queue. However, since the session has moved, new requests can get to&lt;br/&gt;
    +     * the leader out of order. Hence, the commits can also arrive &quot;out of order&quot; w.r.t. cxid.&lt;br/&gt;
    +     * We should commit the requests according to the order we receive from the leader, i.e., wait for the relevant commit.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Regarding 2 - I&apos;ve answered the question also in the new comments. I think we shouldn&apos;t empty the queue because it is possible that the session returned to us (i.e., moved back). It does no harm to keep the old requests, given that the cnxn handle in the old request shows that the old connection is closed.&lt;/p&gt;</comment>
                            <comment id="16226889" author="githubbot" created="Tue, 31 Oct 2017 14:35:35 +0000"  >&lt;p&gt;Github user kfirlevari commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148014452&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148014452&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java &amp;#8212;&lt;br/&gt;
    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception &lt;/p&gt;
{
                         !processedRequests.contains(r));
             }
&lt;p&gt;         }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * In the following test, we verify that we can handle the case that we got a commit&lt;br/&gt;
    +     * of a request we never seen since the session that we just established. This can happen&lt;br/&gt;
    +     * when a session is just established and there is request waiting to be committed in the&lt;br/&gt;
    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Fixed&lt;/p&gt;</comment>
                            <comment id="16226890" author="githubbot" created="Tue, 31 Oct 2017 14:36:07 +0000"  >&lt;p&gt;Github user kfirlevari commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148014638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148014638&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -255,24 +255,23 @@ public void run() {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) &lt;/p&gt;
{
    -                            LOG.error(
    -                                    &quot;Got cxid 0x&quot;
    -                                            + Long.toHexString(request.cxid)
    -                                            + &quot; expected 0x&quot; + Long.toHexString(
    -                                                    topPending.cxid)
    -                                    + &quot; for client session id &quot;
    -                                    + Long.toHexString(request.sessionId));
    -                            throw new IOException(&quot;Error: unexpected cxid for&quot;
    -                                    + &quot;client session&quot;);
    +                            // we can get commit requests that are not at the queue head after
    +                            // a session moved (see ZOOKEEPER-2684). We will just pass the
    +                            // commit to the next processor and put the pending back with
    +                            // a warning, we should not see this often under normal load
    +                            LOG.warn(&quot;Got request &quot; + request +
    +                                    &quot; but we are expecting request &quot; + topPending);
    +                            sessionQueue.addFirst(topPending);
    +                        }
&lt;p&gt; else {&lt;br/&gt;
    +                            /*&lt;br/&gt;
    +                             * We want to send our version of the request. the&lt;br/&gt;
    +                             * pointer to the connection in the request&lt;br/&gt;
    +                             */&lt;br/&gt;
    +                            topPending.setHdr(request.getHdr());&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I added an explanation, let me know if you meant something more specific. &lt;/p&gt;</comment>
                            <comment id="16226898" author="hadoopqa" created="Tue, 31 Oct 2017 14:40:48 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    -1 contrib tests.  The patch failed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16226899" author="hadoopqa" created="Tue, 31 Oct 2017 14:40:49 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16226922" author="hadoopqa" created="Tue, 31 Oct 2017 14:50:22 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16226923" author="hadoopqa" created="Tue, 31 Oct 2017 14:50:23 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    -1 contrib tests.  The patch failed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16226924" author="hadoopqa" created="Tue, 31 Oct 2017 14:50:23 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16226928" author="hadoopqa" created="Tue, 31 Oct 2017 14:51:30 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16227448" author="githubbot" created="Tue, 31 Oct 2017 20:20:12 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148115810&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148115810&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -246,33 +246,51 @@ public void run() {&lt;br/&gt;
                         }&lt;/p&gt;

&lt;p&gt;                         /*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Check if request is pending, if so, update it with the&lt;/li&gt;
	&lt;li&gt;* committed info&lt;br/&gt;
    +                     * Check if request is pending, if so, update it with the committed info&lt;br/&gt;
                          */&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) 
{
    -                            LOG.error(
    -                                    &quot;Got cxid 0x&quot;
    -                                            + Long.toHexString(request.cxid)
    -                                            + &quot; expected 0x&quot; + Long.toHexString(
    -                                                    topPending.cxid)
    -                                    + &quot; for client session id &quot;
    -                                    + Long.toHexString(request.sessionId));
    -                            throw new IOException(&quot;Error: unexpected cxid for&quot;
    -                                    + &quot;client session&quot;);
    +                            // TL;DR - we should not encounter this scenario often under normal load.
    +                            // We pass the commit to the next processor and put the pending back with a warning.
    +
    +                            // Generally, we can get commit requests that are not at the queue head after
    +                            // a session moved (see ZOOKEEPER-2684). Let&apos;s denote the previous server of the session
    +                            // with A, and the server that the session moved to with B (keep in mind that it is
    +                            // possible that the session already moved from B to a new server C, and maybe C=A).
    +                            // 1. If request.cxid &amp;lt; topPending.cxid : this means that the session requested this update
    +                            // from A, then moved to B (i.e., which is us), and now B receives the commit
    +                            // for the update after the session already performed several operations in B
    +                            // (and therefore its cxid is higher than that old request).
    +                            // 2. If request.cxid &amp;gt; topPending.cxid : this means that the session requested an updated
    +                            // from B with cxid that is bigger than the one we know therefore in this case we
    +                            // are A, and we lost the connection to the session. Given that we are waiting for a commit
    +                            // for that update, it means that we already sent the request to the leader and it will
    +                            // be committed at some point (in this case the order of cxid won&apos;t follow zxid, since zxid
    +                            // is an increasing order). It is not safe for us to delete the session&apos;s queue at this
    +                            // point, since it is possible that the session has newer requests in it after it moved
    +                            // back to us. We just leave the queue as it is, and once the commit arrives (for the old
    +                            // request), the finalRequestProcessor will see a closed cnxn handle, and just won&apos;t send a
    +                            // response.
    +                            // Also note that we don&apos;t have a local session, therefore we treat the request
    +                            // like any other commit for a remote request, i.e., we perform the update without sending
    +                            // a response.
    +
    +                            LOG.warn(&quot;Got request &quot; + request +
    +                                    &quot; but we are expecting request &quot; + topPending);
    +                            sessionQueue.addFirst(topPending);
    +                        }
&lt;p&gt; else {&lt;br/&gt;
    +                            // We want to send to the next processor our version of the request,&lt;br/&gt;
    +                            // since it contains the session information that is needed&lt;br/&gt;
    +                            // for post update processing (e.g., using request.cnxn we send a response to the client).&lt;br/&gt;
    +                            topPending.setHdr(request.getHdr());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The explanation is really great. I was also hoping you could shed some light on this part of the code. Why do we &quot;want to send to the next processor our version of the request&quot; and why can we proceed in the other case if this is required here?&lt;/p&gt;</comment>
                            <comment id="16227449" author="githubbot" created="Tue, 31 Oct 2017 20:20:12 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148113899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148113899&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -246,33 +246,51 @@ public void run() {&lt;br/&gt;
                         }&lt;/p&gt;

&lt;p&gt;                         /*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Check if request is pending, if so, update it with the&lt;/li&gt;
	&lt;li&gt;* committed info&lt;br/&gt;
    +                     * Check if request is pending, if so, update it with the committed info&lt;br/&gt;
                          */&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) {&lt;/li&gt;
	&lt;li&gt;LOG.error(&lt;/li&gt;
	&lt;li&gt;&quot;Got cxid 0x&quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; expected 0x&quot; + Long.toHexString(&lt;/li&gt;
	&lt;li&gt;topPending.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; for client session id &quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.sessionId));&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Error: unexpected cxid for&quot;&lt;/li&gt;
	&lt;li&gt;+ &quot;client session&quot;);&lt;br/&gt;
    +                            // TL;DR - we should not encounter this scenario often under normal load.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I hate to be &quot;that guy&quot; but we generally use &quot;/*&quot; comments for long blocks like this.&lt;/p&gt;</comment>
                            <comment id="16227461" author="githubbot" created="Tue, 31 Oct 2017 20:26:50 +0000"  >&lt;p&gt;Github user shralex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148117464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148117464&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -246,33 +246,51 @@ public void run() {&lt;br/&gt;
                         }&lt;/p&gt;

&lt;p&gt;                         /*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Check if request is pending, if so, update it with the&lt;/li&gt;
	&lt;li&gt;* committed info&lt;br/&gt;
    +                     * Check if request is pending, if so, update it with the committed info&lt;br/&gt;
                          */&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) 
{
    -                            LOG.error(
    -                                    &quot;Got cxid 0x&quot;
    -                                            + Long.toHexString(request.cxid)
    -                                            + &quot; expected 0x&quot; + Long.toHexString(
    -                                                    topPending.cxid)
    -                                    + &quot; for client session id &quot;
    -                                    + Long.toHexString(request.sessionId));
    -                            throw new IOException(&quot;Error: unexpected cxid for&quot;
    -                                    + &quot;client session&quot;);
    +                            // TL;DR - we should not encounter this scenario often under normal load.
    +                            // We pass the commit to the next processor and put the pending back with a warning.
    +
    +                            // Generally, we can get commit requests that are not at the queue head after
    +                            // a session moved (see ZOOKEEPER-2684). Let&apos;s denote the previous server of the session
    +                            // with A, and the server that the session moved to with B (keep in mind that it is
    +                            // possible that the session already moved from B to a new server C, and maybe C=A).
    +                            // 1. If request.cxid &amp;lt; topPending.cxid : this means that the session requested this update
    +                            // from A, then moved to B (i.e., which is us), and now B receives the commit
    +                            // for the update after the session already performed several operations in B
    +                            // (and therefore its cxid is higher than that old request).
    +                            // 2. If request.cxid &amp;gt; topPending.cxid : this means that the session requested an updated
    +                            // from B with cxid that is bigger than the one we know therefore in this case we
    +                            // are A, and we lost the connection to the session. Given that we are waiting for a commit
    +                            // for that update, it means that we already sent the request to the leader and it will
    +                            // be committed at some point (in this case the order of cxid won&apos;t follow zxid, since zxid
    +                            // is an increasing order). It is not safe for us to delete the session&apos;s queue at this
    +                            // point, since it is possible that the session has newer requests in it after it moved
    +                            // back to us. We just leave the queue as it is, and once the commit arrives (for the old
    +                            // request), the finalRequestProcessor will see a closed cnxn handle, and just won&apos;t send a
    +                            // response.
    +                            // Also note that we don&apos;t have a local session, therefore we treat the request
    +                            // like any other commit for a remote request, i.e., we perform the update without sending
    +                            // a response.
    +
    +                            LOG.warn(&quot;Got request &quot; + request +
    +                                    &quot; but we are expecting request &quot; + topPending);
    +                            sessionQueue.addFirst(topPending);
    +                        }
&lt;p&gt; else {&lt;br/&gt;
    +                            // We want to send to the next processor our version of the request,&lt;br/&gt;
    +                            // since it contains the session information that is needed&lt;br/&gt;
    +                            // for post update processing (e.g., using request.cnxn we send a response to the client).&lt;br/&gt;
    +                            topPending.setHdr(request.getHdr());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    My understanding is that when a request is in the local queue, there is (or could be) a client attached to this server waiting for a response, and there is other bookeeping of requests that are outstanding and have originated from this server (e.g., for setting the max outstanding requests) - we need to update this info when an outstanding request completes. In the other case, the operation originated from a different server and there is no local bookeeeping or a local client session that needs to be notified. &lt;/p&gt;</comment>
                            <comment id="16227464" author="hadoopqa" created="Tue, 31 Oct 2017 20:27:37 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16227480" author="githubbot" created="Tue, 31 Oct 2017 20:33:08 +0000"  >&lt;p&gt;Github user kfirlevari commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148119207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148119207&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -246,33 +246,51 @@ public void run() {&lt;br/&gt;
                         }&lt;/p&gt;

&lt;p&gt;                         /*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Check if request is pending, if so, update it with the&lt;/li&gt;
	&lt;li&gt;* committed info&lt;br/&gt;
    +                     * Check if request is pending, if so, update it with the committed info&lt;br/&gt;
                          */&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) {&lt;/li&gt;
	&lt;li&gt;LOG.error(&lt;/li&gt;
	&lt;li&gt;&quot;Got cxid 0x&quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; expected 0x&quot; + Long.toHexString(&lt;/li&gt;
	&lt;li&gt;topPending.cxid)&lt;/li&gt;
	&lt;li&gt;+ &quot; for client session id &quot;&lt;/li&gt;
	&lt;li&gt;+ Long.toHexString(request.sessionId));&lt;/li&gt;
	&lt;li&gt;throw new IOException(&quot;Error: unexpected cxid for&quot;&lt;/li&gt;
	&lt;li&gt;+ &quot;client session&quot;);&lt;br/&gt;
    +                            // TL;DR - we should not encounter this scenario often under normal load.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    NP &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16227481" author="hadoopqa" created="Tue, 31 Oct 2017 20:33:28 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16227482" author="githubbot" created="Tue, 31 Oct 2017 20:33:37 +0000"  >&lt;p&gt;Github user kfirlevari commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411#discussion_r148119340&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411#discussion_r148119340&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java &amp;#8212;&lt;br/&gt;
    @@ -246,33 +246,51 @@ public void run() {&lt;br/&gt;
                         }&lt;/p&gt;

&lt;p&gt;                         /*&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Check if request is pending, if so, update it with the&lt;/li&gt;
	&lt;li&gt;* committed info&lt;br/&gt;
    +                     * Check if request is pending, if so, update it with the committed info&lt;br/&gt;
                          */&lt;br/&gt;
                         LinkedList&amp;lt;Request&amp;gt; sessionQueue = pendingRequests&lt;br/&gt;
                                 .get(request.sessionId);&lt;br/&gt;
                         if (sessionQueue != null) {&lt;br/&gt;
                             // If session queue != null, then it is also not empty.&lt;br/&gt;
                             Request topPending = sessionQueue.poll();&lt;br/&gt;
                             if (request.cxid != topPending.cxid) 
{
    -                            LOG.error(
    -                                    &quot;Got cxid 0x&quot;
    -                                            + Long.toHexString(request.cxid)
    -                                            + &quot; expected 0x&quot; + Long.toHexString(
    -                                                    topPending.cxid)
    -                                    + &quot; for client session id &quot;
    -                                    + Long.toHexString(request.sessionId));
    -                            throw new IOException(&quot;Error: unexpected cxid for&quot;
    -                                    + &quot;client session&quot;);
    +                            // TL;DR - we should not encounter this scenario often under normal load.
    +                            // We pass the commit to the next processor and put the pending back with a warning.
    +
    +                            // Generally, we can get commit requests that are not at the queue head after
    +                            // a session moved (see ZOOKEEPER-2684). Let&apos;s denote the previous server of the session
    +                            // with A, and the server that the session moved to with B (keep in mind that it is
    +                            // possible that the session already moved from B to a new server C, and maybe C=A).
    +                            // 1. If request.cxid &amp;lt; topPending.cxid : this means that the session requested this update
    +                            // from A, then moved to B (i.e., which is us), and now B receives the commit
    +                            // for the update after the session already performed several operations in B
    +                            // (and therefore its cxid is higher than that old request).
    +                            // 2. If request.cxid &amp;gt; topPending.cxid : this means that the session requested an updated
    +                            // from B with cxid that is bigger than the one we know therefore in this case we
    +                            // are A, and we lost the connection to the session. Given that we are waiting for a commit
    +                            // for that update, it means that we already sent the request to the leader and it will
    +                            // be committed at some point (in this case the order of cxid won&apos;t follow zxid, since zxid
    +                            // is an increasing order). It is not safe for us to delete the session&apos;s queue at this
    +                            // point, since it is possible that the session has newer requests in it after it moved
    +                            // back to us. We just leave the queue as it is, and once the commit arrives (for the old
    +                            // request), the finalRequestProcessor will see a closed cnxn handle, and just won&apos;t send a
    +                            // response.
    +                            // Also note that we don&apos;t have a local session, therefore we treat the request
    +                            // like any other commit for a remote request, i.e., we perform the update without sending
    +                            // a response.
    +
    +                            LOG.warn(&quot;Got request &quot; + request +
    +                                    &quot; but we are expecting request &quot; + topPending);
    +                            sessionQueue.addFirst(topPending);
    +                        }
&lt;p&gt; else {&lt;br/&gt;
    +                            // We want to send to the next processor our version of the request,&lt;br/&gt;
    +                            // since it contains the session information that is needed&lt;br/&gt;
    +                            // for post update processing (e.g., using request.cnxn we send a response to the client).&lt;br/&gt;
    +                            topPending.setHdr(request.getHdr());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Updated accordingly&lt;/p&gt;</comment>
                            <comment id="16227516" author="hadoopqa" created="Tue, 31 Oct 2017 20:46:16 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16227546" author="hadoopqa" created="Tue, 31 Oct 2017 20:57:16 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16227663" author="shralex" created="Tue, 31 Oct 2017 21:44:43 +0000"  >&lt;p&gt;+1 &lt;/p&gt;

&lt;p&gt;Thanks a lot, Kfir, LGTM&lt;/p&gt;</comment>
                            <comment id="16237057" author="githubbot" created="Fri, 3 Nov 2017 04:05:36 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/411&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="12737480">ZOOKEEPER-2024</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12851589" name="ZOOKEEPER-2684.patch" size="6160" author="kfirlevari" created="Wed, 8 Feb 2017 08:56:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39pbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>