<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:00:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2845] Data inconsistency issue due to retain database in leader election</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2845</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;, the ZKDatabase is retained to reduce the unavailable time during leader election. In ZooKeeper ensemble, it&apos;s possible that the snapshot is ahead of txn file (due to slow disk on the server, etc), or the txn file is ahead of snapshot due to no commit message being received yet. &lt;/p&gt;

&lt;p&gt;If snapshot is ahead of txn file, since the SyncRequestProcessor queue will be drained during shutdown, the snapshot and txn file will keep consistent before leader election happening, so this is not an issue.&lt;/p&gt;

&lt;p&gt;But if txn is ahead of snapshot, it&apos;s possible that the ensemble will have data inconsistent issue, here is the simplified scenario to show the issue:&lt;/p&gt;

&lt;p&gt;Let&apos;s say we have a 3 servers in the ensemble, server A and B are followers, and C is leader, and all the snapshot and txn are up to T0:&lt;br/&gt;
1. A new request reached to leader C to create Node N, and it&apos;s converted to txn T1 &lt;br/&gt;
2. Txn T1 was synced to disk in C, but just before the proposal reaching out to the followers, A and B restarted, so the T1 didn&apos;t exist in A and B&lt;br/&gt;
3. A and B formed a new quorum after restart, let&apos;s say B is the leader&lt;br/&gt;
4. C changed to looking state due to no enough followers, it will sync with leader B with last Zxid T0, which will have an empty diff sync&lt;br/&gt;
5. Before C take snapshot it restarted, it replayed the txns on disk which includes T1, now it will have Node N, but A and B doesn&apos;t have it.&lt;/p&gt;

&lt;p&gt;Also I included the a test case to reproduce this issue consistently. &lt;/p&gt;

&lt;p&gt;We have a totally different RetainDB version which will avoid this issue by doing consensus between snapshot and txn files before leader election, will submit for review.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13087331">ZOOKEEPER-2845</key>
            <summary>Data inconsistency issue due to retain database in leader election</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="revans2">Robert Joseph Evans</assignee>
                                    <reporter username="lvfangmin">Fangmin Lv</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 14 Jul 2017 23:20:00 +0000</created>
                <updated>Fri, 14 Sep 2018 00:19:07 +0000</updated>
                            <resolved>Fri, 23 Feb 2018 23:20:00 +0000</resolved>
                                    <version>3.4.10</version>
                    <version>3.5.3</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.4.12</fixVersion>
                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16088277" author="githubbot" created="Fri, 14 Jul 2017 23:23:11 +0000"  >&lt;p&gt;GitHub user lvfangmin opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Test&amp;#93;&lt;/span&gt; Test used to reproduce the data inconsistency issue due to retain database in leader election&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/lvfangmin/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lvfangmin/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;-TEST&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #310&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ff0bc49de51635da1d5bff0e4f260a61acc87db0&lt;br/&gt;
Author: Fangmin Lyu &amp;lt;allenlyu@fb.com&amp;gt;&lt;br/&gt;
Date:   2017-07-14T23:02:20Z&lt;/p&gt;

&lt;p&gt;    reproduce the data inconsistency issue&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16088293" author="hadoopqa" created="Fri, 14 Jul 2017 23:37:54 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/883//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/883//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/883//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/883//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/883//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/883//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16088296" author="githubbot" created="Fri, 14 Jul 2017 23:39:04 +0000"  >&lt;p&gt;Github user lvfangmin commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310#discussion_r127567852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310#discussion_r127567852&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -784,4 +784,126 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for(int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +               clientPorts[i] = PortAssignment.unique();
    +               sb.append(&quot;server.&quot;+i+&quot;=127.0.0.1:&quot;+PortAssignment.unique()+&quot;:&quot;+PortAssignment.unique()+&quot;;&quot;+clientPorts[i]+&quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +         }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                    CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) {}&lt;br/&gt;
    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    +        p.qvAcksetPairs.get(0).getAckset().contains(leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 6. wait the leader to quit due to no enough followers&lt;br/&gt;
    +        waitForOne(zk&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        int newLeader = -1;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                newLeader = i;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        // make sure a different leader was elected&lt;br/&gt;
    +        Assert.assertTrue(newLeader != leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 7. restart the previous leader&lt;br/&gt;
    +        mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.shutdown();&lt;br/&gt;
    +        waitForOne(zk&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;, States.CONNECTING);&lt;br/&gt;
    +        mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.start();&lt;br/&gt;
    +        waitForOne(zk&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 8. check the node exist in previous leader but not others&lt;br/&gt;
    +        //    make sure everything is consistent&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            Assert.assertTrue(&quot;server &quot; + i + &quot; should not have /zk&quot; + leader, zk&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.exists(&quot;/zk&quot; + leader, false) == null);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The test will fail here as the node exist in previous leader.&lt;/p&gt;</comment>
                            <comment id="16088299" author="hanm" created="Fri, 14 Jul 2017 23:43:17 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;C changed to looking state due to no enough followers, it will sync with leader B with last Zxid T0, which will have an empty diff sync&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you saying leader B is sending a DIFF to follower C in this case? Since B does not have T1, I think it should send a TRUNC and C should drop T1 in its txn log.&lt;/p&gt;</comment>
                            <comment id="16088306" author="lvfangmin" created="Fri, 14 Jul 2017 23:53:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; T1 only exists in txn file but hasn&apos;t been applied to the data tree yet, the lastProcessedZxid in follower C is T0, so no TRUNC message when sync with leader.&lt;/p&gt;</comment>
                            <comment id="16088464" author="hanm" created="Sat, 15 Jul 2017 05:11:55 +0000"  >&lt;p&gt;Make sense to me. I think previously we don&apos;t have this issue because the &lt;tt&gt;zkDb&lt;/tt&gt; was cleared across leader election, and C will find out its &lt;tt&gt;lastProcessedZxid&lt;/tt&gt; is T1, rather than T0, while reinitialize &lt;tt&gt;zkDb&lt;/tt&gt; from snap/tnx log which will yield a TRUNC instead of DIFF from leader B. &lt;/p&gt;</comment>
                            <comment id="16124813" author="hanm" created="Sun, 13 Aug 2017 05:34:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt; Any plan to submit your retain db implementation? This is an important bug to fix.&lt;/p&gt;</comment>
                            <comment id="16125267" author="lvfangmin" created="Mon, 14 Aug 2017 05:47:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; we&apos;ve just finished and tried to test the RetainDB in our internal ensemble, might submit the code for review next week. &lt;/p&gt;</comment>
                            <comment id="16135559" author="lvfangmin" created="Mon, 21 Aug 2017 18:28:28 +0000"  >&lt;p&gt;The internal patch has been stabilized, which have been tested for a long time, we&apos;ve rolled it out to one of the production environment last week. Joseph from our team will attach the patch here for review this week.&lt;/p&gt;</comment>
                            <comment id="16136242" author="hanm" created="Tue, 22 Aug 2017 04:07:47 +0000"  >&lt;p&gt;Thanks for the update, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;. Good to know the patch is tested in prod environment!&lt;/p&gt;</comment>
                            <comment id="16153628" author="githubbot" created="Tue, 5 Sep 2017 13:17:32 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @lvfangmin any update on getting a pull request for the actual fix?&lt;/p&gt;</comment>
                            <comment id="16154246" author="githubbot" created="Tue, 5 Sep 2017 20:28:37 +0000"  >&lt;p&gt;Github user lvfangmin commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @revans2 my teammate was working on the fix, and he was planning run it on prod for a while before sending out the diff. I&apos;ll sync with him today about the status. &lt;/p&gt;</comment>
                            <comment id="16283999" author="davelatham" created="Fri, 8 Dec 2017 18:37:59 +0000"  >&lt;p&gt;Any updates here?  We were considering upgrading our zookeeper, but don&apos;t want to go to a release with a known data inconsistency problem.&lt;/p&gt;</comment>
                            <comment id="16284066" author="lvfangmin" created="Fri, 8 Dec 2017 19:16:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davelatham&quot; class=&quot;user-hover&quot; rel=&quot;davelatham&quot;&gt;davelatham&lt;/a&gt; our internal patch is based on 3.6 branch, and we found it amplified the issue reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2926&quot; title=&quot;Data inconsistency issue due to the flaw in the session management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2926&quot;&gt;&lt;del&gt;ZOOKEEPER-2926&lt;/del&gt;&lt;/a&gt;, on our production we need to disable the local session feature to mitigate the issue. Also, we haven&apos;t patched and tested the diff on 3.4 yet, so we&apos;re not confident to get it out yet. Instead, I would suggest to revert the existing broken retainDB commit to unblock the next release. &lt;/p&gt;

&lt;p&gt;I have made a patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2926&quot; title=&quot;Data inconsistency issue due to the flaw in the session management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2926&quot;&gt;&lt;del&gt;ZOOKEEPER-2926&lt;/del&gt;&lt;/a&gt;, will update it there. And assign this Jira to my teammate Joseph to follow up, he is the owner of our internal retainDB feature.&lt;/p&gt;
</comment>
                            <comment id="16284068" author="lvfangmin" created="Fri, 8 Dec 2017 19:18:02 +0000"  >&lt;p&gt;Can someone help add my teammate jtuple as the contributor? So I can assign the task to him.&lt;/p&gt;</comment>
                            <comment id="16284144" author="davelatham" created="Fri, 8 Dec 2017 20:06:45 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;.  The broken &quot;retainDB&quot; commit is &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt; right?  You&apos;re suggesting that be reverted?&lt;/p&gt;</comment>
                            <comment id="16284444" author="lvfangmin" created="Fri, 8 Dec 2017 23:55:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davelatham&quot; class=&quot;user-hover&quot; rel=&quot;davelatham&quot;&gt;davelatham&lt;/a&gt; I meant the broken &quot;retainDB&quot; commit in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;, we should revert it before we have a sound solution.&lt;/p&gt;</comment>
                            <comment id="16343979" author="githubbot" created="Mon, 29 Jan 2018 20:39:45 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @lvfangmin &lt;/p&gt;

&lt;p&gt;    I am trying to reproduce the issue you have seen here, and I have not been able to do so.  The test either fails for me with the same leader being elected each time, or on newer versions with the leader client connected instead of connecting waiting for it to quit with a timeout, that I am not sure if it ever happens.&lt;/p&gt;

&lt;p&gt;    How frequently would this test pass for you?&lt;/p&gt;</comment>
                            <comment id="16344024" author="githubbot" created="Mon, 29 Jan 2018 21:03:24 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Apparently for some reason I don&apos;t understand if I don&apos;t run all of the tests in QuorumPeerMainTest The old leader is elected again each time.&lt;/p&gt;</comment>
                            <comment id="16347026" author="revans2" created="Wed, 31 Jan 2018 15:36:01 +0000"  >&lt;p&gt;I have a fix that I will be posting shortly.&#160; I need to clean up the patch and make sure that I get pull requests ready for all of the branches that &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2926&quot; title=&quot;Data inconsistency issue due to the flaw in the session management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2926&quot;&gt;&lt;del&gt;ZOOKEEPER-2926&lt;/del&gt;&lt;/a&gt; went into.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The following table describes the situation that allows a node to get into an inconsistent state.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&#160;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;N1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;N2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;N3&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Start with cluster in sync N1 is leader&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x0 0x5&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x0 0x5&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x0 0x5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;N2 and N3 go down&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x0 0x5&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Proposal to N1 (fails with no quorum)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x0 0x6&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;N2 and N3 return, but N1 is restarting.&#160; N2 elected leader&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x1 0x0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x1 0x0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;A proposal is accepted&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x1 0x1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x1 0x1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;N1 returns and is trying to sync with the new leader N2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x0 0x6&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x1 0x1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0x1 0x1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;At this point the code in &lt;tt&gt;LearnerHandler.syncFollower&lt;/tt&gt; takes over to bring N1 into sync with N2 the new leader.&lt;/p&gt;

&lt;p&gt;That code checks the following in order&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Is there a &lt;tt&gt;forceSync&lt;/tt&gt;? Not in this case&lt;/li&gt;
	&lt;li&gt;Are the two zxids in sync already?&#160; No &lt;tt&gt;0x0 0x6 != 0x1 0x1&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;is the peer zxid &amp;gt; the local zxid (and peer didn&apos;t just rotate to a new epoch)? No &lt;tt&gt;0x0 0x6 &amp;lt; 0x1 0x1&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;is the peer zxid in between the max committed log and the min committed log?&#160; In this case yes it is, but it shouldn&apos;t be.&#160; The max committed log is &lt;tt&gt;0x1 0x1&lt;/tt&gt;.&#160; The min committed log is &lt;tt&gt;0x0 0x5&lt;/tt&gt; or something likely below it because it is based off of distance in the edit log.&#160; The issue is that once the epoch changes, &lt;tt&gt;0x0&lt;/tt&gt; to &lt;tt&gt;0x1&lt;/tt&gt;, the leader has no idea if the edits are in its edit log without explicitly checking for them.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The reason that &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2926&quot; title=&quot;Data inconsistency issue due to the flaw in the session management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2926&quot;&gt;&lt;del&gt;ZOOKEEPER-2926&lt;/del&gt;&lt;/a&gt; exposed this is because previously when a leader was elected the in memory DB was dropped and everything was reread from disk.&#160; When this happens the&#160;&lt;tt&gt;0x0 0x6&lt;/tt&gt; proposal was lost.&#160; But it is not guaranteed to be lost in all cases.&#160; In theory a snapshot could be taken triggered by that proposal, either on the leader, or on a follower that also received the proposal, but does not join the new quorum in time.&#160;&#160; As such &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2926&quot; title=&quot;Data inconsistency issue due to the flaw in the session management&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2926&quot;&gt;&lt;del&gt;ZOOKEEPER-2926&lt;/del&gt;&lt;/a&gt; really just extended the window of an already existing race.&#160; But it extended it almost indefinitely so it is much more likely to happen.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My fix is to update &lt;tt&gt;LearnerHandler.syncFollower&lt;/tt&gt; to only send a&#160;&lt;tt&gt;DIFF&lt;/tt&gt; if the epochs are the same.  If they are not the same we don&apos;t know if something we inserted that we don&apos;t know about.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16347557" author="githubbot" created="Wed, 31 Jan 2018 20:25:45 +0000"  >&lt;p&gt;GitHub user revans2 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Send a SNAP if transactions cannot be verified.&lt;/p&gt;

&lt;p&gt;    I will be creating a patch/pull request for 3.4 and 3.5 too, but I wanted to get a pull request up for others to look at ASAP.&lt;/p&gt;

&lt;p&gt;    I have a version of this based off of #310 at &lt;a href=&quot;https://github.com/revans2/zookeeper/tree/ZOOKEEPER-2845-orig-test-patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper/tree/ZOOKEEPER-2845-orig-test-patch&lt;/a&gt; but the test itself is flaky.  Frequently leader election does not go as planned on the test and it ends up failing but not because it ended up in an inconsistent state.&lt;/p&gt;

&lt;p&gt;    I am happy to answer any questions anyone has about the patch.  &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/revans2/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;-master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #453&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 0219b2c9e44527067cd5fed4b642729171721886&lt;br/&gt;
Author: Robert Evans &amp;lt;evans@...&amp;gt;&lt;br/&gt;
Date:   2018-01-29T20:27:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Send a SNAP if transactions cannot be verified.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16347678" author="githubbot" created="Wed, 31 Jan 2018 21:57:37 +0000"  >&lt;p&gt;GitHub user revans2 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/454&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Send a SNAP if transactions cannot be verified. (3.5)&lt;/p&gt;

&lt;p&gt;    This is the version of #453 for the 3.5 branch&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/revans2/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;-3.5&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/454.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/454.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #454&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 70436249c830af0b129caf3d1bed2f55a2498b6b&lt;br/&gt;
Author: Robert Evans &amp;lt;evans@...&amp;gt;&lt;br/&gt;
Date:   2018-01-29T20:27:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Send a SNAP if transactions cannot be verified.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16347901" author="githubbot" created="Thu, 1 Feb 2018 02:12:11 +0000"  >&lt;p&gt;GitHub user revans2 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/455&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Send a SNAP if transactions cannot be verified.&lt;/p&gt;

&lt;p&gt;    This is the version of #453 for the 3.4 branch&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/revans2/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;-3.4&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/455.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/455.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #455&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b035df19616424036afb1f31f345dedf26e3b2ae&lt;br/&gt;
Author: Robert Evans &amp;lt;evans@...&amp;gt;&lt;br/&gt;
Date:   2018-02-01T02:09:53Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Send a SNAP if transactions cannot be verified.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16358060" author="lvfangmin" created="Fri, 9 Feb 2018 08:08:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt;&#160;Thanks for jumping in and working on this issue, the consistency issue mentioned here is not because of syncing protocol, but because there might be uncommitted txns in txn file but not in ZKDatabase during retain database. If I understand your proposal and diff correctly, you&apos;re trying to solve the issue by checking the epoch during syncing with the leader, but it doesn&apos;t solve the issue that there will be uncommitted txn in txn file, and during replay the txns it could load this txn and cause inconsistency.&lt;/p&gt;</comment>
                            <comment id="16358627" author="revans2" created="Fri, 9 Feb 2018 16:36:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Perhaps I don&apos;t understand the issue well enough which is totally possible because I am not a frequent contributor and the path for all of the request processors is kind of complex.&lt;/p&gt;

&lt;p&gt;My understanding is that the SyncRequestProcessor handles writing out edits to the edit log and snapshots, there are a few other places where this happens at startup though. The SyncRequestProcessor writes out edits as they arrive and will flush them to disk periodically in batches. It also takes snapshots periodically.&lt;/p&gt;

&lt;p&gt;The in memory portion appears to be updated by the FinalRequestProcessor prior to a quorum of acks being received.&lt;/p&gt;

&lt;p&gt;So yes there is the possibility that something is written to the transaction log that is not applied to memory. This means that when ZKDatabase.clear() is called it should actually fast forward the in memory changes to match those in the edit log + snapshot.&lt;/p&gt;

&lt;p&gt;So you are saying that &lt;br/&gt;
 1) proposals come in, are written to the transaction log, but the in memory database is not updated yet.&lt;br/&gt;
 2) the server does a soft restart for some reason and some transactions appear to be lost (because the in memory DB was not fast forwarded).&lt;br/&gt;
 3) more transactions come in (possibly conflicting with the first set of transactions).&lt;br/&gt;
 4) before a snapshot can happen the leader or follower restarts and has to reconstruct the in memory DB from edits + snapshot. This would then reapply the edits that originally appeared to be lost.&lt;/p&gt;

&lt;p&gt;This does look like it might happen, so I will look into that as well.&lt;/p&gt;

&lt;p&gt;But the test in &lt;a href=&quot;https://github.com/apache/zookeeper/pull/310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/310&lt;/a&gt; didn&apos;t appear to trigger this. I could be wrong because I concentrated most of my debugging on the original leader and what was happening with it, instead of the followers and what was happening with them. I also didn&apos;t understand how clearing the leader&apos;s in memory database caused an edit to be lost, if the edits are being written out to disk before the in memory DB is updated. What I saw was that&lt;/p&gt;

&lt;p&gt;1) a bunch of edits and leaders/followers being restarted that didn&apos;t really do much of anything.&lt;br/&gt;
 2) the original leader lost a connection to the followers.&lt;br/&gt;
 3a) A transaction was written to the leader in memory DB but it didn&apos;t get a quorum of acks&lt;br/&gt;
 3b) The followers restarted and formed a new quorum&lt;br/&gt;
 4) The original leader timed out and joined the new quorum&lt;br/&gt;
 5) As part of the sync when the old leader joined the new quorum it got a diff (not a snap), but it had an edit that was not a part of the new leader so it was off from the others.&lt;/p&gt;

&lt;p&gt;I could see this second part happening even without my change so I don&apos;t really understand how that clearing the database would prevent it.&#160; My thinking was that it was a race condition where the edits in the edit log were not flushed yet, and as such when we cleared the DB they were lost.&#160; But I didn&apos;t confirm this.&lt;/p&gt;</comment>
                            <comment id="16358804" author="lvfangmin" created="Fri, 9 Feb 2018 18:46:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt; the txn will only be applied to DB when it&apos;s quorum committed, the problem here is not&#160;lost a txn but with an extra txn which is not quorum committed, and it&apos;s what shown in the&#160;Jira description.&lt;/p&gt;</comment>
                            <comment id="16358899" author="revans2" created="Fri, 9 Feb 2018 20:17:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;So how does clearing the DB prevent it from re-applying the transactions in the transaction log?&lt;/p&gt;</comment>
                            <comment id="16359421" author="lvfangmin" created="Sat, 10 Feb 2018 12:57:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt; clean and reload the DB will use the correct zxid to vote or sync with new leader, if it&apos;s being elected as new leader, the ensemble will all have&#160;this extra txn, otherwise, the new leader will send truncate or snap to this server, which means it will be discarded.&lt;/p&gt;

&lt;p&gt;With RetainDB, it will ignore the truth that it actually&#160;has the txn flushed to&#160;disk, and&#160;there is race condition that if&#160;DB is reloaded from disk it&#160;may&#160;include this txn.&lt;/p&gt;</comment>
                            <comment id="16360557" author="githubbot" created="Mon, 12 Feb 2018 10:24:50 +0000"  >&lt;p&gt;Github user mfenes commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r167513290&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r167513290&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java &amp;#8212;&lt;br/&gt;
    @@ -758,6 +760,11 @@ public boolean syncFollower(long peerLastZxid, ZKDatabase db, Leader leader) &lt;/p&gt;
{
                     currentZxid = maxCommittedLog;
                     needOpPacket = false;
                     needSnap = false;
    +            }
&lt;p&gt; else if (peerLastEpoch != lastProcessedEpoch &amp;amp;&amp;amp; !db.isInCommittedLog(peerLastZxid)) {&lt;br/&gt;
    +                //Be sure we do a snap, because if the epochs are not the same we don&apos;t know what&lt;br/&gt;
    +                // could have happened in between and it may take a TRUNC + UPDATES to get them in SYNC&lt;br/&gt;
    +                LOG.debug(&quot;Will send SNAP to peer sid: {} epochs are too our of sync local 0x{} remote 0x{}&quot;,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think there is a typo here: &quot;our of sync&quot;&lt;/p&gt;</comment>
                            <comment id="16360880" author="revans2" created="Mon, 12 Feb 2018 15:28:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I will spend some more time debugging it because I could have made a mistake, but that is not what I saw from the unit test you provided.&#160; When I logged the zxid used for leader election both before and after clearing the DB it didn&apos;t change, but like I said I could have missed something and I am not a regular contributor so I will go back and try to do it again.&lt;/p&gt;</comment>
                            <comment id="16361234" author="revans2" created="Mon, 12 Feb 2018 18:32:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;You are right I did miss the ID changing on the reload as part of my tests.&#160; I will spend some more time debugging.&#160; My patch does fix the test case that was uploaded, but I want to be sure I understand the issue well enough to see what situations might not be fixed by it.&lt;/p&gt;</comment>
                            <comment id="16362164" author="githubbot" created="Tue, 13 Feb 2018 11:25:36 +0000"  >&lt;p&gt;Github user mfenes commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r167835407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r167835407&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java &amp;#8212;&lt;br/&gt;
    @@ -758,6 +760,11 @@ public boolean syncFollower(long peerLastZxid, ZKDatabase db, Leader leader) &lt;/p&gt;
{
                     currentZxid = maxCommittedLog;
                     needOpPacket = false;
                     needSnap = false;
    +            }
&lt;p&gt; else if (peerLastEpoch != lastProcessedEpoch &amp;amp;&amp;amp; !db.isInCommittedLog(peerLastZxid)) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Could you please add a description to the comments above (to &quot;Here are the cases that we want to handle&quot;) what this else if case is doing?&lt;/p&gt;</comment>
                            <comment id="16362222" author="githubbot" created="Tue, 13 Feb 2018 12:34:22 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r167838605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r167838605&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/LearnerHandlerTest.java &amp;#8212;&lt;br/&gt;
    @@ -498,31 +507,20 @@ public void testNewEpochZxidWithTxnlogOnly() throws Exception {&lt;/p&gt;

&lt;p&gt;             // Peer has zxid of epoch 3&lt;br/&gt;
             peerZxid = getZxid(3, 0);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertFalse(learnerHandler.syncFollower(peerZxid, db, leader));&lt;/li&gt;
	&lt;li&gt;// We send DIFF to (6,0) and forward any packet starting at (4,1)&lt;/li&gt;
	&lt;li&gt;assertOpType(Leader.DIFF, getZxid(6, 0), getZxid(4, 1));&lt;/li&gt;
	&lt;li&gt;// DIFF + 1 proposals + 1 commit&lt;/li&gt;
	&lt;li&gt;assertEquals(3, learnerHandler.getQueuedPackets().size());&lt;/li&gt;
	&lt;li&gt;queuedPacketMatches(new long[] 
{ getZxid(4, 1)}
&lt;p&gt;);&lt;br/&gt;
    +        //There is no 3, 0 proposal in the committed log so sync&lt;br/&gt;
    +        assertTrue(learnerHandler.syncFollower(peerZxid, db, leader));&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It seems to me that this test checking the same thing 3 times in a row.&lt;br/&gt;
    Do you think it&apos;s necessary to do so?&lt;/p&gt;</comment>
                            <comment id="16362223" author="githubbot" created="Tue, 13 Feb 2018 12:34:22 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r167838309&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r167838309&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/LearnerHandlerTest.java &amp;#8212;&lt;br/&gt;
    @@ -462,6 +469,8 @@ public void testNewEpochZxid() throws Exception {&lt;/p&gt;

&lt;p&gt;             // Peer has zxid of epoch 1&lt;br/&gt;
             peerZxid = getZxid(1, 0);&lt;br/&gt;
    +        //We are on a different epoch so we don&apos;t know 1, 0 is in our log or not.&lt;br/&gt;
    +        // So we need to do a full SNAP&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this comment has been added by mistake. You added (1,0) to the log above, hence syncFollower() returns false which means we don&apos;t need to do full SNAP.&lt;/p&gt;</comment>
                            <comment id="16362233" author="githubbot" created="Tue, 13 Feb 2018 12:40:36 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thank you to everyone who reviewed the patch, but with the help of Fangmin Lv I found one case that the original patch didn&apos;t cover.  I have reworked the patch to cover that case, but to do so I had to take a completely different approach.&lt;/p&gt;

&lt;p&gt;    I think this is a better approach because it reuses a lot of the code that was originally run to load the database from disk.  So now instead of reloading the entire database from disk, we apply all of the uncommitted transactions in the log to the in memory database.  This should put it in exactly the same state as if we had cleared the data and reloaded it from disk, but with much less overhead.&lt;/p&gt;</comment>
                            <comment id="16362234" author="revans2" created="Tue, 13 Feb 2018 12:42:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for pushing on this.  I had missed an error case in the follower.  I have updated the patch to hopefully fix all of the issues, but please have a look at it.&lt;/p&gt;</comment>
                            <comment id="16362412" author="githubbot" created="Tue, 13 Feb 2018 14:39:38 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @revans2 Your latest change looks good to me and a bit safer than the previous one. Would you please consider adding some unit tests to validate the functionality?&lt;br/&gt;
    What do you think of porting testTxnAheadSnapInRetainDB() test from your codebase?&lt;br/&gt;
    Maybe I can help making it not flaky, if you think it correctly verifies the original issue.&lt;/p&gt;
</comment>
                            <comment id="16362423" author="githubbot" created="Tue, 13 Feb 2018 14:44:50 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r167884587&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r167884587&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZKDatabase.java &amp;#8212;&lt;br/&gt;
    @@ -233,14 +233,32 @@ public long getDataTreeLastProcessedZxid() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@throws IOException&lt;br/&gt;
          */&lt;br/&gt;
         public long loadDataBase() throws IOException {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;PlayBackListener listener=new PlayBackListener(){&lt;br/&gt;
    +        PlayBackListener listener = new PlayBackListener()
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {                 public void onTxnLoaded(TxnHeader hdr,Record txn){
                     Request r = new Request(0, hdr.getCxid(),hdr.getType(), hdr, txn, hdr.getZxid());
                     addCommittedProposal(r);
                 }             }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long zxid = snapLog.restore(dataTree,sessionsWithTimeouts,listener);&lt;br/&gt;
    +        long zxid = snapLog.restore(dataTree, sessionsWithTimeouts, listener);&lt;br/&gt;
    +        initialized = true;&lt;br/&gt;
    +        return zxid;&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Fast forward the database adding transactions from the committed log into memory.&lt;br/&gt;
    +     * @return the last valid zxid.&lt;br/&gt;
    +     * @throws IOException&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long fastForwardDataBase() throws IOException {&lt;br/&gt;
    +        PlayBackListener listener = new PlayBackListener(){
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think it&apos;d be nice to extract the common logic of these two methods into a operate one.&lt;/p&gt;</comment>
                            <comment id="16362425" author="githubbot" created="Tue, 13 Feb 2018 14:46:44 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r167885280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r167885280&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZKDatabase.java &amp;#8212;&lt;br/&gt;
    @@ -233,14 +233,32 @@ public long getDataTreeLastProcessedZxid() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@throws IOException&lt;br/&gt;
          */&lt;br/&gt;
         public long loadDataBase() throws IOException {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;PlayBackListener listener=new PlayBackListener(){&lt;br/&gt;
    +        PlayBackListener listener = new PlayBackListener()
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {                 public void onTxnLoaded(TxnHeader hdr,Record txn){
                     Request r = new Request(0, hdr.getCxid(),hdr.getType(), hdr, txn, hdr.getZxid());
                     addCommittedProposal(r);
                 }             }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long zxid = snapLog.restore(dataTree,sessionsWithTimeouts,listener);&lt;br/&gt;
    +        long zxid = snapLog.restore(dataTree, sessionsWithTimeouts, listener);&lt;br/&gt;
    +        initialized = true;&lt;br/&gt;
    +        return zxid;&lt;br/&gt;
    +    }&lt;br/&gt;
    +&lt;br/&gt;
    +    /**&lt;br/&gt;
    +     * Fast forward the database adding transactions from the committed log into memory.&lt;br/&gt;
    +     * @return the last valid zxid.&lt;br/&gt;
    +     * @throws IOException&lt;br/&gt;
    +     */&lt;br/&gt;
    +    public long fastForwardDataBase() throws IOException {&lt;br/&gt;
    +        PlayBackListener listener = new PlayBackListener(){
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Will do&lt;/p&gt;</comment>
                            <comment id="16362505" author="githubbot" created="Tue, 13 Feb 2018 15:41:42 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @anmolnar I will add some kind of a test.  I ran into a lot of issues with `testTxnAheadSnapInRetainDB`.  I could not get it to run correctly against master as it would always end up electing the original leader again and the test would fail, but not because it had reproduced the issue.  I finally just did development work based off of the &lt;span class=&quot;error&quot;&gt;&amp;#91;original patch&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/zookeeper/compare/master...revans2:ZOOKEEPER-2845-updated-fix?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/compare/master...revans2:ZOOKEEPER-2845-updated-fix?expand=1&lt;/a&gt;) and verified that `testTxnAheadSnapInRetainDB` passed, or that if it failed it did so because of leader election.&lt;/p&gt;</comment>
                            <comment id="16362576" author="githubbot" created="Tue, 13 Feb 2018 16:20:11 +0000"  >&lt;p&gt;Github user anmolnar commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @revans2 Take a look at `testElectionFraud()` in the same file. Maybe I&apos;m wrong, but it seems to me trying to achieve something similar.&lt;/p&gt;</comment>
                            <comment id="16362939" author="githubbot" created="Tue, 13 Feb 2018 19:46:32 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @anmolnar I added in an updated version of the test in #310. The issue turned out to be a race condition where the original leader would time out clients and then would join the new quorum too quickly for the test to be able to detect it.  I changed it so there is a hard coded sleep instead and then just shut down the leader.  I would love to get rid of the hard coded sleep, but I wasn&apos;t really sure how to do it without making some major changes in the leader code to put in a synchronization point.  If you really want me to do it I can, but it felt rather intrusive.&lt;/p&gt;

&lt;p&gt;    I verified that when I comment out my code that does the fast forward the test fails and when I put it back the test passes.  If this looks OK I&apos;ll try to port the test to the other release branches too.&lt;/p&gt;

&lt;p&gt;    I also addressed your request to make some of the code common.&lt;/p&gt;</comment>
                            <comment id="16366481" author="githubbot" created="Fri, 16 Feb 2018 00:59:02 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168653437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168653437&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    There is a lot of `Thread.sleep()` going on and I would like to find a way to minimize that. Apache infra can occasionally be quite slow (it can starve threads) and tests with many `Thread.sleep()`s in them have historically been quite flaky.&lt;/p&gt;

&lt;p&gt;    So, to the extent that it is possible. I would like to minimize occurrences of `Thread.sleep()`, or at least those outside the context of retry logic.&lt;/p&gt;

&lt;p&gt;    So perhaps, we can throw `p.qvAcksetPairs.get(0).getAckset().contains(leader);` in a loop waiting one second between iterations.&lt;/p&gt;

&lt;p&gt;    w.r.t. step 6, we can wait for the leader to enter the looking state.&lt;/p&gt;

&lt;p&gt;    What do you think?&lt;/p&gt;



</comment>
                            <comment id="16366482" author="githubbot" created="Fri, 16 Feb 2018 00:59:02 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168649459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168649459&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: I don&apos;t think we use the terminology &quot;RetainDB&quot; anywhere else. Perhaps we can get rid of &quot;retain&quot;?&lt;/p&gt;</comment>
                            <comment id="16366483" author="githubbot" created="Fri, 16 Feb 2018 00:59:02 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168651275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168651275&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Do we need this cast?&lt;/p&gt;</comment>
                            <comment id="16366484" author="githubbot" created="Fri, 16 Feb 2018 00:59:02 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168649080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168649080&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -435,7 +435,7 @@ private void waitForOne(ZooKeeper zk, States state) throws InterruptedException&lt;br/&gt;
             int iterations = ClientBase.CONNECTION_TIMEOUT / 500;&lt;br/&gt;
             while (zk.getState() != state) {&lt;br/&gt;
                 if (iterations-- == 0) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Waiting too long&quot;);&lt;br/&gt;
    +                throw new RuntimeException(&quot;Waiting too long &quot; + zk.getState() + &quot; != &quot; + state);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: let&apos;s minimize unrelated test changes and whitespace changes&lt;/p&gt;</comment>
                            <comment id="16366485" author="githubbot" created="Fri, 16 Feb 2018 00:59:02 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168649906&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168649906&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, quorumCfgSection);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    is there any reason we can&apos;t use the existing test infra to clean this up a little&lt;/p&gt;</comment>
                            <comment id="16366486" author="githubbot" created="Fri, 16 Feb 2018 00:59:02 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168649723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168649723&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    +        p.qvAcksetPairs.get(0).getAckset().contains(leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 6. wait the leader to quit due to no enough followers&lt;br/&gt;
    +        Thread.sleep(4000);&lt;br/&gt;
    +        //waitForOne(zk&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;, States.CONNECTING);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    remove this&lt;/p&gt;</comment>
                            <comment id="16367491" author="githubbot" created="Fri, 16 Feb 2018 15:49:24 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168793211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168793211&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -435,7 +435,7 @@ private void waitForOne(ZooKeeper zk, States state) throws InterruptedException&lt;br/&gt;
             int iterations = ClientBase.CONNECTION_TIMEOUT / 500;&lt;br/&gt;
             while (zk.getState() != state) {&lt;br/&gt;
                 if (iterations-- == 0) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Waiting too long&quot;);&lt;br/&gt;
    +                throw new RuntimeException(&quot;Waiting too long &quot; + zk.getState() + &quot; != &quot; + state);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Although I agree with you in general, I think this one here is a good addition to test output.&lt;/p&gt;</comment>
                            <comment id="16367492" author="githubbot" created="Fri, 16 Feb 2018 15:50:28 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168793569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168793569&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, quorumCfgSection);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    +1&lt;br/&gt;
    As mentioned testElectionFraud() is a good example for that.&lt;/p&gt;</comment>
                            <comment id="16367495" author="githubbot" created="Fri, 16 Feb 2018 15:51:12 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168793764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168793764&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, quorumCfgSection);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I am not super familiar with the test infrastructure.  If you have a suggestion I would love it, otherwise I will look around and see what I can come up with.&lt;/p&gt;</comment>
                            <comment id="16367497" author="githubbot" created="Fri, 16 Feb 2018 15:52:15 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168794042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168794042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I will see if I can make it work.  I agree I would love to kill as many of the sleeps as possible.&lt;/p&gt;</comment>
                            <comment id="16367503" author="githubbot" created="Fri, 16 Feb 2018 15:57:43 +0000"  >&lt;p&gt;Github user anmolnar commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168795633&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168795633&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = new MainThread(i, clientPorts&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, quorumCfgSection);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Use `LaunchServers(numServers, tickTime)` method in this class.&lt;br/&gt;
    It gives you a collection of `MainThread` and `ZooKeeper` objects properly initialized.&lt;br/&gt;
    Test `tearDown()` will care about destroying it. &lt;/p&gt;</comment>
                            <comment id="16367504" author="githubbot" created="Fri, 16 Feb 2018 15:57:48 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168795646&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168795646&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -435,7 +435,7 @@ private void waitForOne(ZooKeeper zk, States state) throws InterruptedException&lt;br/&gt;
             int iterations = ClientBase.CONNECTION_TIMEOUT / 500;&lt;br/&gt;
             while (zk.getState() != state) {&lt;br/&gt;
                 if (iterations-- == 0) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Waiting too long&quot;);&lt;br/&gt;
    +                throw new RuntimeException(&quot;Waiting too long &quot; + zk.getState() + &quot; != &quot; + state);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    @anmolnar  and @afine I put this in for my own debugging and I forgot to remove it.  If you want me to I am happy to either remove it or file a separate JIRA and put it up as a separate pull request, or just leave it.  Either way is fine with me.&lt;/p&gt;</comment>
                            <comment id="16367559" author="githubbot" created="Fri, 16 Feb 2018 16:41:18 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168807853&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168807853&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I was able to do what you said and drop the 1 second sleep, but the sleep at step 6 I am going to need something else because the leader is only in the looking state for 2 ms.  Leader election happens way too fast for us to be able to catch that by polling.  &lt;/p&gt;

&lt;p&gt;    If I remove the 4 second sleep it does not trigger the error case, I don&apos;t completely know why.  I&apos;ll spend some time looking at it, but if you have any suggestions I would appreciate it.&lt;/p&gt;</comment>
                            <comment id="16367561" author="githubbot" created="Fri, 16 Feb 2018 16:41:30 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168807914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168807914&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    removed the cast&lt;/p&gt;</comment>
                            <comment id="16367562" author="githubbot" created="Fri, 16 Feb 2018 16:41:42 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168807943&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168807943&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    +        p.qvAcksetPairs.get(0).getAckset().contains(leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 6. wait the leader to quit due to no enough followers&lt;br/&gt;
    +        Thread.sleep(4000);&lt;br/&gt;
    +        //waitForOne(zk&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;, States.CONNECTING);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    done&lt;/p&gt;</comment>
                            <comment id="16367563" author="githubbot" created="Fri, 16 Feb 2018 16:41:48 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168807976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168807976&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    done&lt;/p&gt;</comment>
                            <comment id="16367809" author="githubbot" created="Fri, 16 Feb 2018 20:02:03 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168857052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168857052&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -435,7 +435,7 @@ private void waitForOne(ZooKeeper zk, States state) throws InterruptedException&lt;br/&gt;
             int iterations = ClientBase.CONNECTION_TIMEOUT / 500;&lt;br/&gt;
             while (zk.getState() != state) {&lt;br/&gt;
                 if (iterations-- == 0) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;throw new RuntimeException(&quot;Waiting too long&quot;);&lt;br/&gt;
    +                throw new RuntimeException(&quot;Waiting too long &quot; + zk.getState() + &quot; != &quot; + state);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Since @anmolnar thinks it is valuable, I think it is fine for it to be left in. &lt;/p&gt;</comment>
                            <comment id="16367814" author="githubbot" created="Fri, 16 Feb 2018 20:05:12 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168857757&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168857757&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +888,127 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testTxnAheadSnapInRetainDB() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        final int clientPorts[] = new int&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        StringBuilder sb = new StringBuilder();&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            clientPorts[i] = PortAssignment.unique();
    +            sb.append(&quot;server.&quot; + i + &quot;=127.0.0.1:&quot; + PortAssignment.unique() + &quot;:&quot; + PortAssignment.unique() + &quot;;&quot; + clientPorts[i] + &quot;\n&quot;);
    +        }
&lt;p&gt;    +        String quorumCfgSection = sb.toString();&lt;br/&gt;
    +&lt;br/&gt;
    +        MainThread mt[] = new MainThread&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        ZooKeeper zk[] = new ZooKeeper&lt;span class=&quot;error&quot;&gt;&amp;#91;SERVER_COUNT&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i] = new MainThread(i, clientPorts[i], quorumCfgSection);
    +            mt[i].start();
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].shutdown();
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTING);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) &lt;/p&gt;
{
    +            mt[i].start();
    +            // Recreate a client session since the previous session was not persisted.
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        waitForAll(zk, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = -1;&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding = null;&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (mt&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.main.quorumPeer.leader != null) &lt;/p&gt;
{
    +                leader = i;
    +                outstanding = mt[leader].main.quorumPeer.leader.outstandingProposals;
    +                // increase the tick time to delay the leader going to looking
    +                mt[leader].main.quorumPeer.tickTime = 10000;
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, this);
    +                waitForOne(zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertTrue(outstanding.size() == 1);&lt;br/&gt;
    +        Proposal p = (Proposal) outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertTrue(p.request.getHdr().getType() == OpCode.create);&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        Thread.sleep(1000);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    @revans2 take a look at `testElectionFraud`, specifically: &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java#L383&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java#L383&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java#L397&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java#L397&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    You can manually start and stop leader election, I think that may solve this problem. &lt;/p&gt;</comment>
                            <comment id="16367823" author="githubbot" created="Fri, 16 Feb 2018 20:12:02 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @afine and @anmolnar I think I have addressed all of your review comments, except for the one about the change to `waitForOne` and I am happy to adjust however you want there.&lt;/p&gt;</comment>
                            <comment id="16367960" author="githubbot" created="Fri, 16 Feb 2018 22:40:04 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168887935&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168887935&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +923,103 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testFailedTxnAsPartOfQuorumLoss() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        servers = LaunchServers(SERVER_COUNT);&lt;br/&gt;
    +&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        servers.shutDownAllServers();&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTING);&lt;br/&gt;
    +        servers.restartAllServersAndClients(this);&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = servers.findLeader();&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding =  servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.leader.outstandingProposals;&lt;br/&gt;
    +        // increase the tick time to delay the leader going to looking&lt;br/&gt;
    +        servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.tickTime = 10000;&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                servers.mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                servers.mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the new leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                servers.restartClient(i, this);
    +                waitForOne(servers.zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to old leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            servers.zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertEquals(1, outstanding.size());&lt;br/&gt;
    +        Proposal p = outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertEquals(OpCode.create, p.request.getHdr().getType());&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        int sleepTime = 0;&lt;br/&gt;
    +        Long longLeader = new Long(leader);&lt;br/&gt;
    +        while (!p.qvAcksetPairs.get(0).getAckset().contains(longLeader)) {&lt;br/&gt;
    +            if (sleepTime &amp;gt; 2000) &lt;/p&gt;
{
    +                Assert.fail(&quot;Transaction not synced to disk within 1 second &quot; + p.qvAcksetPairs.get(0).getAckset()
    +                    + &quot; expected &quot; + leader);
    +            }
&lt;p&gt;    +            Thread.sleep(100);&lt;br/&gt;
    +            sleepTime += 100;&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 6. wait for the leader to quit due to not enough followers and come back up as a part of the new quorum&lt;br/&gt;
    +        sleepTime = 0;&lt;br/&gt;
    +        Follower f = servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.follower;&lt;br/&gt;
    +        while (f == null || !f.isRunning()) {&lt;br/&gt;
    +            if (sleepTime &amp;gt; 10_000) &lt;/p&gt;
{
    +                Assert.fail(&quot;Took too long for old leader to time out &quot; + servers.mt[leader].main.quorumPeer.getPeerState());
    +            }
&lt;p&gt;    +            Thread.sleep(100);&lt;br/&gt;
    +            sleepTime += 100;&lt;br/&gt;
    +            f = servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.follower;&lt;br/&gt;
    +        }&lt;br/&gt;
    +        servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.shutdown();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    why do we need this?&lt;/p&gt;</comment>
                            <comment id="16367961" author="githubbot" created="Fri, 16 Feb 2018 22:40:04 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168884819&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168884819&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -465,6 +470,37 @@ private void waitForAll(ZooKeeper[] zks, States state) throws InterruptedExcepti&lt;br/&gt;
         private static class Servers {&lt;br/&gt;
             MainThread mt[];&lt;br/&gt;
             ZooKeeper zk[];&lt;br/&gt;
    +        int[] clientPorts;&lt;br/&gt;
    +&lt;br/&gt;
    +        public void shutDownAllServers() throws InterruptedException {&lt;br/&gt;
    +            for (MainThread t: mt) &lt;/p&gt;
{
    +                t.shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void restartAllServersAndClients(Watcher watcher) throws IOException {&lt;br/&gt;
    +            for (MainThread t : mt) {&lt;br/&gt;
    +                if (!t.isAlive()) &lt;/p&gt;
{
    +                    t.start();
    +                }
&lt;p&gt;    +            }&lt;br/&gt;
    +            for (int i = 0; i &amp;lt; zk.length; i++) &lt;/p&gt;
{
    +                restartClient(i, watcher);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void restartClient(int i, Watcher watcher) throws IOException &lt;/p&gt;
{
    +            zk[i] = new ZooKeeper(&quot;127.0.0.1:&quot; + clientPorts[i], ClientBase.CONNECTION_TIMEOUT, watcher);
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        public int findLeader() {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    there are other places in this test class that benefit from this refactoring. Would you mind cleaning that up?&lt;/p&gt;</comment>
                            <comment id="16367962" author="githubbot" created="Fri, 16 Feb 2018 22:40:04 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168886064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168886064&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +923,103 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testFailedTxnAsPartOfQuorumLoss() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        servers = LaunchServers(SERVER_COUNT);&lt;br/&gt;
    +&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        servers.shutDownAllServers();&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTING);&lt;br/&gt;
    +        servers.restartAllServersAndClients(this);&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = servers.findLeader();&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding =  servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.leader.outstandingProposals;&lt;br/&gt;
    +        // increase the tick time to delay the leader going to looking&lt;br/&gt;
    +        servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.tickTime = 10000;&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                servers.mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                servers.mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the new leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                servers.restartClient(i, this);
    +                waitForOne(servers.zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to old leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            servers.zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertEquals(1, outstanding.size());&lt;br/&gt;
    +        Proposal p = outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertEquals(OpCode.create, p.request.getHdr().getType());&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        int sleepTime = 0;&lt;br/&gt;
    +        Long longLeader = new Long(leader);&lt;br/&gt;
    +        while (!p.qvAcksetPairs.get(0).getAckset().contains(longLeader)) {&lt;br/&gt;
    +            if (sleepTime &amp;gt; 2000) &lt;/p&gt;
{
    +                Assert.fail(&quot;Transaction not synced to disk within 1 second &quot; + p.qvAcksetPairs.get(0).getAckset()
    +                    + &quot; expected &quot; + leader);
    +            }
&lt;p&gt;    +            Thread.sleep(100);&lt;br/&gt;
    +            sleepTime += 100;&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 6. wait for the leader to quit due to not enough followers and come back up as a part of the new quorum&lt;br/&gt;
    +        sleepTime = 0;&lt;br/&gt;
    +        Follower f = servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.follower;&lt;br/&gt;
    +        while (f == null || !f.isRunning()) {&lt;br/&gt;
    +            if (sleepTime &amp;gt; 10_000) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nitpick: can we reuse the ticktime here to make the relationship more obvious?&lt;/p&gt;</comment>
                            <comment id="16367963" author="githubbot" created="Fri, 16 Feb 2018 22:40:04 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r168884569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r168884569&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -465,6 +470,37 @@ private void waitForAll(ZooKeeper[] zks, States state) throws InterruptedExcepti&lt;br/&gt;
         private static class Servers {&lt;br/&gt;
             MainThread mt[];&lt;br/&gt;
             ZooKeeper zk[];&lt;br/&gt;
    +        int[] clientPorts;&lt;br/&gt;
    +&lt;br/&gt;
    +        public void shutDownAllServers() throws InterruptedException {&lt;br/&gt;
    +            for (MainThread t: mt) &lt;/p&gt;
{
    +                t.shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void restartAllServersAndClients(Watcher watcher) throws IOException {&lt;br/&gt;
    +            for (MainThread t : mt) {&lt;br/&gt;
    +                if (!t.isAlive()) &lt;/p&gt;
{
    +                    t.start();
    +                }
&lt;p&gt;    +            }&lt;br/&gt;
    +            for (int i = 0; i &amp;lt; zk.length; i++) &lt;/p&gt;
{
    +                restartClient(i, watcher);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        public void restartClient(int i, Watcher watcher) throws IOException {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    annoying nitpick: let&apos;s use a better argument name than `i`&lt;/p&gt;</comment>
                            <comment id="16371509" author="githubbot" created="Wed, 21 Feb 2018 14:56:24 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453#discussion_r169662234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453#discussion_r169662234&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java &amp;#8212;&lt;br/&gt;
    @@ -888,4 +923,103 @@ public void testWithOnlyMinSessionTimeout() throws Exception &lt;/p&gt;
{
                     maxSessionTimeOut, quorumPeer.getMaxSessionTimeout());
         }

&lt;p&gt;    +    @Test&lt;br/&gt;
    +    public void testFailedTxnAsPartOfQuorumLoss() throws Exception {&lt;br/&gt;
    +        // 1. start up server and wait for leader election to finish&lt;br/&gt;
    +        ClientBase.setupTestEnv();&lt;br/&gt;
    +        final int SERVER_COUNT = 3;&lt;br/&gt;
    +        servers = LaunchServers(SERVER_COUNT);&lt;br/&gt;
    +&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // we need to shutdown and start back up to make sure that the create session isn&apos;t the first transaction since&lt;br/&gt;
    +        // that is rather innocuous.&lt;br/&gt;
    +        servers.shutDownAllServers();&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTING);&lt;br/&gt;
    +        servers.restartAllServersAndClients(this);&lt;br/&gt;
    +        waitForAll(servers, States.CONNECTED);&lt;br/&gt;
    +&lt;br/&gt;
    +        // 2. kill all followers&lt;br/&gt;
    +        int leader = servers.findLeader();&lt;br/&gt;
    +        Map&amp;lt;Long, Proposal&amp;gt; outstanding =  servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.leader.outstandingProposals;&lt;br/&gt;
    +        // increase the tick time to delay the leader going to looking&lt;br/&gt;
    +        servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.tickTime = 10000;&lt;br/&gt;
    +        LOG.warn(&quot;LEADER {}&quot;, leader);&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                servers.mt[i].shutdown();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 3. start up the followers to form a new quorum&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                servers.mt[i].start();
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 4. wait one of the follower to be the new leader&lt;br/&gt;
    +        for (int i = 0; i &amp;lt; SERVER_COUNT; i++) {&lt;br/&gt;
    +            if (i != leader) &lt;/p&gt;
{
    +                // Recreate a client session since the previous session was not persisted.
    +                servers.restartClient(i, this);
    +                waitForOne(servers.zk[i], States.CONNECTED);
    +            }
&lt;p&gt;    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 5. send a create request to old leader and make sure it&apos;s synced to disk,&lt;br/&gt;
    +        //    which means it acked from itself&lt;br/&gt;
    +        try &lt;/p&gt;
{
    +            servers.zk[leader].create(&quot;/zk&quot; + leader, &quot;zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                CreateMode.PERSISTENT);
    +            Assert.fail(&quot;create /zk&quot; + leader + &quot; should have failed&quot;);
    +        }
&lt;p&gt; catch (KeeperException e) &lt;/p&gt;
{
    +        }
&lt;p&gt;    +&lt;br/&gt;
    +        // just make sure that we actually did get it in process at the&lt;br/&gt;
    +        // leader&lt;br/&gt;
    +        Assert.assertEquals(1, outstanding.size());&lt;br/&gt;
    +        Proposal p = outstanding.values().iterator().next();&lt;br/&gt;
    +        Assert.assertEquals(OpCode.create, p.request.getHdr().getType());&lt;br/&gt;
    +&lt;br/&gt;
    +        // make sure it has a chance to write it to disk&lt;br/&gt;
    +        int sleepTime = 0;&lt;br/&gt;
    +        Long longLeader = new Long(leader);&lt;br/&gt;
    +        while (!p.qvAcksetPairs.get(0).getAckset().contains(longLeader)) {&lt;br/&gt;
    +            if (sleepTime &amp;gt; 2000) &lt;/p&gt;
{
    +                Assert.fail(&quot;Transaction not synced to disk within 1 second &quot; + p.qvAcksetPairs.get(0).getAckset()
    +                    + &quot; expected &quot; + leader);
    +            }
&lt;p&gt;    +            Thread.sleep(100);&lt;br/&gt;
    +            sleepTime += 100;&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        // 6. wait for the leader to quit due to not enough followers and come back up as a part of the new quorum&lt;br/&gt;
    +        sleepTime = 0;&lt;br/&gt;
    +        Follower f = servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.follower;&lt;br/&gt;
    +        while (f == null || !f.isRunning()) {&lt;br/&gt;
    +            if (sleepTime &amp;gt; 10_000) &lt;/p&gt;
{
    +                Assert.fail(&quot;Took too long for old leader to time out &quot; + servers.mt[leader].main.quorumPeer.getPeerState());
    +            }
&lt;p&gt;    +            Thread.sleep(100);&lt;br/&gt;
    +            sleepTime += 100;&lt;br/&gt;
    +            f = servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.main.quorumPeer.follower;&lt;br/&gt;
    +        }&lt;br/&gt;
    +        servers.mt&lt;span class=&quot;error&quot;&gt;&amp;#91;leader&amp;#93;&lt;/span&gt;.shutdown();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It is a lot of very specific steps that make the data inconsistency show up.  This is needed to force the transaction log to be replayed which has an edit in it that wasn&apos;t considered as a part of leader election.&lt;/p&gt;</comment>
                            <comment id="16371517" author="githubbot" created="Wed, 21 Feb 2018 15:03:12 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @afine &lt;/p&gt;

&lt;p&gt;    I have addressed you most recent comments.  If you want me to squash commits please let me know.&lt;/p&gt;

&lt;p&gt;    I have a pull request for the 3.5 branch #454 and for the 3.4 branch #455.  I will be spending some time porting the test to them, and let you know when it is ready.&lt;/p&gt;</comment>
                            <comment id="16371535" author="githubbot" created="Wed, 21 Feb 2018 15:21:24 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/454&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I just rebased this and pulled in all of the changes made to the main test.&lt;/p&gt;</comment>
                            <comment id="16371611" author="githubbot" created="Wed, 21 Feb 2018 16:22:16 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/455&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I just rebased this and pulled in all of the changes made to the main test.&lt;/p&gt;</comment>
                            <comment id="16371612" author="githubbot" created="Wed, 21 Feb 2018 16:22:47 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @afine all of the changes in this branch are now in the pull requests to the 3.5 and 3.5 branches,&lt;/p&gt;</comment>
                            <comment id="16375064" author="githubbot" created="Fri, 23 Feb 2018 22:51:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16375106" author="abrahamfine" created="Fri, 23 Feb 2018 23:20:00 +0000"  >&lt;p&gt;Issue resolved by pull request 455&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/455&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16375107" author="githubbot" created="Fri, 23 Feb 2018 23:20:31 +0000"  >&lt;p&gt;Github user afine commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @revans2. I merged this and the PR&apos;s for 3.4 and 3.5&lt;/p&gt;</comment>
                            <comment id="16375208" author="hudson" created="Sat, 24 Feb 2018 01:36:51 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3740 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3740/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3740/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2845&quot; title=&quot;Data inconsistency issue due to retain database in leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2845&quot;&gt;&lt;del&gt;ZOOKEEPER-2845&lt;/del&gt;&lt;/a&gt;: Apply commit log when restarting server. (afine: rev 722ba9409a44a35d287aac803813f508cff2420a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/ZKDatabase.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16378691" author="githubbot" created="Tue, 27 Feb 2018 14:47:55 +0000"  >&lt;p&gt;Github user revans2 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/454&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16378692" author="githubbot" created="Tue, 27 Feb 2018 14:48:01 +0000"  >&lt;p&gt;Github user revans2 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/455&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16378693" author="githubbot" created="Tue, 27 Feb 2018 14:48:16 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/453&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @afine I closed them.&lt;/p&gt;</comment>
                            <comment id="16614183" author="lvfangmin" created="Fri, 14 Sep 2018 00:17:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt; sorry to get back to this lately, I was in parental leave and totally missed this thread (my girl was born on Jan 25, so was busy dealing with the new challenges there &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;

&lt;p&gt;I&apos;m revisiting my&#160;opening&#160;PR today and came&#160;across&#160;this one.&lt;/p&gt;

&lt;p&gt;Checked your fix, looks nice and simple!&lt;/p&gt;

&lt;p&gt;There was one thing I thought which might be a problem but actually it won&apos;t be a problem anymore with &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt; you made last time. The thing I was thinking is in &lt;a href=&quot;https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L1213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperServer.processTxn&lt;/a&gt;&#160;it didn&apos;t add itself to commit log in ZKDatabase, which will leave a hole in commit logs if we apply txns directly to DataTree during&#160;DIFF sync, which in turn could cause data inconsistency if it became leader. But we&apos;re not doing this anymore with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;, so it&apos;s fine.&lt;/p&gt;

&lt;p&gt;Our internal patch is&#160;a little bit&#160;heavier and complexity, we may change to use this simpler solution as well.&#160;Thanks again for moving this forward!&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13038156">ZOOKEEPER-2678</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hjzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>