<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:58:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2172] Cluster crashes when reconfig a new node as a participant</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2172</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;The operations are quite simple: start three zk servers one by one, then reconfig the cluster to add the new one as a participant. When I add the  third one, the zk cluster may enter a weird state and cannot recover.&lt;/p&gt;

&lt;p&gt;      I found &#8220;2015-04-20 12:53:48,236 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1)::PrepRequestProcessor@547&amp;#93;&lt;/span&gt; - Incremental reconfig&#8221; in node-1 log. So the first node received the reconfig cmd at 12:53:48. Latter, it logged &#8220;2015-04-20  12:53:52,230 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.0.0.2:55890:LearnerHandler@580&amp;#93;&lt;/span&gt; - Unexpected exception causing shutdown while sock still open&#8221; and &#8220;2015-04-20 12:53:52,231 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.0.0.2:55890:LearnerHandler@595&amp;#93;&lt;/span&gt; - ******* GOODBYE  /10.0.0.2:55890 ********&#8221;. From then on, the first node and second node rejected all client connections and the third node didn&#8217;t join the cluster as a participant. The whole cluster was done.&lt;/p&gt;

&lt;p&gt;     When the problem happened, all three nodes just used the same dynamic config file zoo.cfg.dynamic.10000005d which only contained the first two nodes. But there was another unused dynamic config file in node-1 directory zoo.cfg.dynamic.next  which already contained three nodes.&lt;/p&gt;

&lt;p&gt;     When I extended the waiting time between starting the third node and reconfiguring the cluster, the problem didn&#8217;t show again. So it should be a race condition problem.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 12.04 + java 7&lt;/p&gt;</environment>
        <key id="12822558">ZOOKEEPER-2172</key>
            <summary>Cluster crashes when reconfig a new node as a participant</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arshad.mohammad">Mohammad Arshad</assignee>
                                    <reporter username="ziyouw">Ziyou Wang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Apr 2015 04:14:24 +0000</created>
                <updated>Wed, 7 Mar 2018 14:37:08 +0000</updated>
                            <resolved>Thu, 8 Sep 2016 21:01:46 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.3</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>leaderElection</component>
                    <component>quorum</component>
                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="14504287" author="ziyouw" created="Tue, 21 Apr 2015 04:16:19 +0000"  >&lt;p&gt;Error log when this bug happened.&lt;/p&gt;</comment>
                            <comment id="14546965" author="michim" created="Sat, 16 May 2015 22:43:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt; could you also post the initial configuration files for all the nodes? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; could you take a look at these log files when you get a chance?&lt;/p&gt;</comment>
                            <comment id="14546968" author="shralex" created="Sat, 16 May 2015 22:50:28 +0000"  >&lt;p&gt;Thanks Michi for the pointer, I&apos;ll take a look, but may not have time today.&lt;/p&gt;

&lt;p&gt;In general the .next file is created when a server acks a reconfig request and deleted when it commits the request.&lt;br/&gt;
We check that a quorum is synced before starting the reconfig but once someone knows about a reconfig proposal and can talk to a quorum of nodes, there is no going back &amp;#8211; if a quorum of the new config isn&apos;t available the system will get stuck (just like without reconfig the system will get stuck if there&apos;s no quorum). &lt;/p&gt;</comment>
                            <comment id="14546972" author="michim" created="Sat, 16 May 2015 22:56:15 +0000"  >&lt;p&gt;Would it be possible that this is hitting the case described in &lt;a href=&quot;http://zookeeper.apache.org/doc/trunk/zookeeperReconfig.html#sc_reconfig_general&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zookeeper.apache.org/doc/trunk/zookeeperReconfig.html#sc_reconfig_general&lt;/a&gt; :&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Finally, note that once connected to the leader, a joiner adopts the last committed configuration, in which it is absent (the initial config of the joiner is backed up before being rewritten). If the joiner restarts in this state, it will not be able to boot since it is absent from its configuration file. In order to start it you&#8217;ll once again have to specify an initial configuration.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14546973" author="shralex" created="Sat, 16 May 2015 22:59:21 +0000"  >&lt;p&gt;quite possible. the question is why weren&apos;t 1 and 2 enough to form a quorum. 3 doesn&apos;t need to be up if both 1 and 2 are participants in the last committed config.&lt;/p&gt;</comment>
                            <comment id="14546974" author="shralex" created="Sat, 16 May 2015 23:02:57 +0000"  >&lt;p&gt;looks like the config here is using the patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2031&quot; title=&quot;Support tagging a QuorumServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2031&quot;&gt;ZOOKEEPER-2031&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14547023" author="michim" created="Sun, 17 May 2015 02:32:22 +0000"  >&lt;p&gt;node1 doesn&apos;t seem to receive the vote from itself. it receives votes from node2 and node3:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;node-1.log:2015-04-20 12:55:03,358 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@698] - Notification: 2 (message format version), 2 (n.leader), 0x100000084 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LEADING (my state)10000005d (n.config version)
node-1.log:2015-04-20 12:55:51,547 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@698] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x1 (n.peerEPoch), LEADING (my state)10000005d (n.config version)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;node2 receives votes from node1 and itself:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;node-2.log:2015-04-20 12:55:03,361 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xffffffffffffffff (n.round), LEADING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)10000005d (n.config version)
node-2.log:2015-04-20 12:55:54,564 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 2 (n.leader), 0x100000084 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)10000005d (n.config version)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is node3&apos;s vote somehow confusing node1?&lt;/p&gt;

&lt;p&gt;Yes, I think this cluster is using the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2031&quot; title=&quot;Support tagging a QuorumServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2031&quot;&gt;ZOOKEEPER-2031&lt;/a&gt;. Do you think that might be related to this issue?&lt;/p&gt;</comment>
                            <comment id="14547490" author="shralex" created="Mon, 18 May 2015 03:15:16 +0000"  >&lt;p&gt;Server 1 continues to be leading till the end of the execution. It is able to push its version to server 3 but for some reason its leader election messages have round 0xffffffffffffffff so I think this is why servers 2 and 3 don&apos;t adopt it as leader. It also doesnt timeout for some reason.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;, this looks related to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1732&quot; title=&quot;ZooKeeper server unable to join established ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1732&quot;&gt;&lt;del&gt;ZOOKEEPER-1732&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1805&quot; title=&quot;&amp;quot;Don&amp;#39;t care&amp;quot; value in ZooKeeper election breaks rolling upgrades&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1805&quot;&gt;&lt;del&gt;ZOOKEEPER-1805&lt;/del&gt;&lt;/a&gt;, any thoughts ?&lt;/p&gt;

&lt;p&gt;Unlike what the description says, the .next file provided here is identical to the other config file and contains a config with servers 1 and 2, so it probably resulted from the reconfiguration adding server 2. Which server is this coming from ? server 2 probably ? That may happen if server 1 committed the reconfig but server 2 hasn&apos;t learned the commit yet (but its other config file has to be different in this case). &lt;/p&gt;

&lt;p&gt;It would be helpful if you can reproduce the scenario without using the ZK-2031 patch and provide all the config files, including the initial ones, from the servers and all the reconfig commands you run and when.&lt;/p&gt;

&lt;p&gt;I can see from the logs that there were many attempts to reconfigure (probably add server 2) before it was synced with server 1 so they failed, which is normal. Then a reconfig succeeds at time 12:51:48, then more reconfig commands are invoked (like minute 12:51:56), which is before server 3 even starts. Is this intentional ? What do these commands attempt to do ? &lt;/p&gt;


</comment>
                            <comment id="14549742" author="michim" created="Tue, 19 May 2015 03:58:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt; would it be possible to reproduce it without zk-2031? If not, could you try reproducing this with debug log enabled? Thanks!&lt;/p&gt;</comment>
                            <comment id="14555672" author="ziyouw" created="Fri, 22 May 2015 06:33:53 +0000"  >&lt;p&gt;Hi Alexander and Michi,&lt;/p&gt;

&lt;p&gt;Thanks a lot for looking at this bug. The zk-2031 is developed as a part of our system. So I cannot remove this patch away to reproduce this problem. I will try to reproduce this problem with debug log enabled.&lt;/p&gt;

&lt;p&gt;BTW. we hit this problems many time after reporting this issue. If we move to a slower environment, e.g. a nested host, it need more time between start and reconfig to avoid it. So I suspect it may be caused when the node 3 doesn&apos;t finish sync latest data from leader, the reconfig comes and breaks some thing. Do you have some idea about this?&lt;/p&gt;

&lt;p&gt;For Alexander&apos;s quesitons, our system had a bug in such case when reporting this jira. It just retried to do the reconfig to add node2 even the node 2 is already in the list. I already fixed it, but we still hit this jira problem again now.&lt;/p&gt;</comment>
                            <comment id="14557965" author="ziyouw" created="Mon, 25 May 2015 04:45:11 +0000"  >&lt;p&gt;I open the zookeeper debug log and reproduce the problem again.&lt;/p&gt;</comment>
                            <comment id="14557967" author="ziyouw" created="Mon, 25 May 2015 04:47:18 +0000"  >&lt;p&gt;No, it is just a bug in previous system. It just will try to reconfig the second node even it already join the cluster. So it also just use &quot;reconfig -add&quot; to add the second node to the participant list. &lt;/p&gt;</comment>
                            <comment id="14557968" author="ziyouw" created="Mon, 25 May 2015 04:47:21 +0000"  >&lt;p&gt;No, it is just a bug in previous system. It just will try to reconfig the second node even it already join the cluster. So it also just use &quot;reconfig -add&quot; to add the second node to the participant list. &lt;/p&gt;</comment>
                            <comment id="14557969" author="ziyouw" created="Mon, 25 May 2015 04:50:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michim&quot; class=&quot;user-hover&quot; rel=&quot;michim&quot;&gt;michim&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alemayo&quot; class=&quot;user-hover&quot; rel=&quot;alemayo&quot;&gt;alemayo&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I opened the debug log for zookeeper and reproduce this problem. Could you help to check the problem again? Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="14558059" author="michim" created="Mon, 25 May 2015 09:20:30 +0000"  >&lt;p&gt;Thanks Ziyou.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; it looks like node1 and node2 are not forming a quorum because node2 has seen zxid 0x100000059 but node1 keeps sending 0x0 as its zxid. Isn&apos;t node1 supposed send the highest zxid it has seen?&lt;/p&gt;

&lt;p&gt;From zookeeper-1.log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-05-25 12:34:36,920 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=2 zxid=0x0 leader=1 config version = 100000049
2015-05-25 12:34:39,090 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=3 zxid=0x0 leader=1 config version = 100000049
2015-05-25 12:35:28,128 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=2 zxid=0x0 leader=1 config version = 100000049
2015-05-25 12:35:30,301 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=3 zxid=0x0 leader=1 config version = 100000049
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From zookeeper-2.log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-05-25 12:34:36,918 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 2 (n.leader), 0x100000059 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)100000049 (n.config version)
2015-05-25 12:34:36,923 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xffffffffffffffff (n.round), LEADING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)100000049 (n.config version)
2015-05-25 12:35:28,124 [myid:2] - DEBUG [QuorumPeer[myid=2]/10.0.0.2:1300:FastLeaderElection@688] - Sending Notification: 2 (n.leader), 0x100000059 (n.zxid), 0x1 (n.round), 1 (recipient), 2 (myid), 0x1 (n.peerEpoch)
2015-05-25 12:35:28,125 [myid:2] - DEBUG [QuorumPeer[myid=2]/10.0.0.2:1300:FastLeaderElection@688] - Sending Notification: 2 (n.leader), 0x100000059 (n.zxid), 0x1 (n.round), 2 (recipient), 2 (myid), 0x1 (n.peerEpoch)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14558594" author="shralex" created="Tue, 26 May 2015 00:18:08 +0000"  >&lt;p&gt;Michi, I agree that its weird, and again I see this 0xffffffffffffffff round number which I think causes the other server to ignore the leader&apos;s messages and continue looking even though server 1 is leading (without timing out for some reason).  This looks related to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1732&quot; title=&quot;ZooKeeper server unable to join established ensemble&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1732&quot;&gt;&lt;del&gt;ZOOKEEPER-1732&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1805&quot; title=&quot;&amp;quot;Don&amp;#39;t care&amp;quot; value in ZooKeeper election breaks rolling upgrades&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1805&quot;&gt;&lt;del&gt;ZOOKEEPER-1805&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt; could you take a look ?&lt;/p&gt;

&lt;p&gt;It also seems like there are a lot of client sessions being established and destroyed (clients connect and disconnect).&lt;br/&gt;
And in particular when the reconfig adding server 3 happens (12:33:21,797 on server 1) the client session 0x14d8b08424a0014 (this is the client that submitted the reconfig) gets closed in the middle of the operation. Then, the connection to server 2 is suddenly closed with the error (on server 2)&lt;/p&gt;

&lt;p&gt;2015-05-25 12:33:25,786 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - WARN  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=2&amp;#93;&lt;/span&gt;/10.0.0.2:1300:Follower@92] - Exception when following the leader java.net.SocketTimeoutException: Read timed out&lt;/p&gt;

&lt;p&gt;Could it be that the termination of a client session in the middle of an op messes up server-to-server connections ?&lt;/p&gt;</comment>
                            <comment id="14558632" author="ziyouw" created="Tue, 26 May 2015 02:50:04 +0000"  >&lt;p&gt;The reason why there are many clients connect and disconnect is we use zk cli to do the operations. So the cli just create a client, do the operation and shutdown it.&lt;/p&gt;

&lt;p&gt;From our tests, I think it should be a race condition problem and may not have relationship with the cli. When the cluster is running in a faster environment, we just need to wait a small interval between starting the node3 and reconfiguring it to join cluster, then we almost can avoid this problem. But when we move to a slower environment, it can be reproduced consistently again. So the temp solution is extending the waiting time and we can avoid it again.  &lt;/p&gt;</comment>
                            <comment id="14558641" author="shralex" created="Tue, 26 May 2015 03:04:04 +0000"  >&lt;p&gt;when you run in the slower environment does server 2 still disconnect like in the logs when you add server 3 ? &lt;/p&gt;

&lt;p&gt;Can you please provide your initial configs for all 3 servers ? and the reconfig commands you run ? I&apos;d like to try to reproduce this.&lt;/p&gt;</comment>
                            <comment id="14558698" author="ziyouw" created="Tue, 26 May 2015 05:18:02 +0000"  >&lt;p&gt;Yes, it has the same problem.&lt;/p&gt;

&lt;p&gt;The step is:&lt;br/&gt;
1. Start server 1, its zoo.cfg contains:&lt;br/&gt;
standaloneEnabled=false&lt;br/&gt;
syncLimit=2&lt;br/&gt;
tickTime=2000&lt;br/&gt;
initLimit=5&lt;/p&gt;

&lt;p&gt;ant its dynamic config file just contains itself.&lt;/p&gt;

&lt;p&gt;2. Start server 2, its zoo.cfg is the same and its init dynamic config file contains 1 and itself. Then reconfig itself as a participant after it sync data from 1 (need to try a few time until the reconfig can be finished).&lt;/p&gt;

&lt;p&gt;3. Start server 3, use the same zoo.cfg and its init dynamic config file contains 1, 2 and itself. Then reconfig itself as the third participant (where we hit the bug).&lt;/p&gt;

&lt;p&gt;Since it is a race condition, it may be not easy to be reproduced in your environment. In my dev, the zk server is running in a docker-in-VM &lt;br/&gt;
environment. If I change the script to just wait 5 secs after starting the server 3, the problem can be reproduced every time. &lt;/p&gt;</comment>
                            <comment id="14558709" author="shralex" created="Tue, 26 May 2015 05:45:34 +0000"  >&lt;p&gt;Thanks. The basic scenario you described works for me, but you&apos;re right of course - there may be a race condition.&lt;/p&gt;

&lt;p&gt;It would be great if you could help investigate this further. For example, why does server 2 disconnect when you add server 3 ? BTW, server 3 doesn&apos;t even have to be up in order for you to add it to the ensemble since you have 2 out of 3 servers without it. &lt;/p&gt;

&lt;p&gt;I also wonder if the problem has anything to do with the client shutting off right after &amp;#8211; does it happen if you don&apos;t close the connection on the client ? &lt;/p&gt;</comment>
                            <comment id="14558958" author="ziyouw" created="Tue, 26 May 2015 10:29:55 +0000"  >&lt;p&gt;BTW, all the reconfigs are sent to server1 to finish.&lt;/p&gt;

&lt;p&gt;I can check the problem, but I am not familiar with the state machine in zookeeper. And you are right, we can config server 3 even before it starts. But we need to deploy a cluster automatically, it is weird to config server 2 after it starts and config server 3 before it starts.&lt;/p&gt;

&lt;p&gt;As I mentioned, we just use CLI to do the reconfig. So I need to change the cli to test this. I think the client should already get the result from the server before it shutdown.&lt;/p&gt;</comment>
                            <comment id="14559062" author="shralex" created="Tue, 26 May 2015 12:42:09 +0000"  >&lt;p&gt;I was just suggesting this to see if we can minimize the scenario causing the race condition. For example what happens when you don&apos;t start server 3 at all. I also really doubt that the problem is at the client. ZK should work whether or not the client disconnects in the middle of an operation. I&apos;m just trying to think how we could track down the bug.&lt;/p&gt;

&lt;p&gt;I&apos;d try to understand whether the client&apos;s shut down is somehow not handled well in the server.&lt;br/&gt;
Could you see if the problem is still there when you a) not shutting down the client after reconfig ? if the problem goes away can you try b) have a write after the reconfig and shut it down the client only after the write completes ?&lt;/p&gt;</comment>
                            <comment id="14559143" author="ziyouw" created="Tue, 26 May 2015 14:12:35 +0000"  >&lt;p&gt;OK, I see. I will try this.&lt;/p&gt;

&lt;p&gt;For debug purpose, do you want to add more log to related code? You can point out the places and I can add them. Right now, even with debug log, I still don&apos;t see much important log in the bug moment.&lt;/p&gt;

&lt;p&gt;For the server 2 disconnect problem, since all the servers are running in one os (different containers), they use exactly the same system clock. The server 2 got a read timeout first and the server 1 shutdown the connection latter. So I think the server 1&apos;s state machine may enter some error state first.&lt;/p&gt;</comment>
                            <comment id="14560424" author="shralex" created="Wed, 27 May 2015 05:18:20 +0000"  >&lt;p&gt;I&apos;m not sure where to add the debug messages yet, but happy to point you to the relevant places once we determine where they are. Is it possible that servers 2 and 3 are using the same resources somehow ? Ports, data directory or something else ? this may explain why one joining messes up the connection to the other.&lt;/p&gt;</comment>
                            <comment id="14564347" author="ziyouw" created="Fri, 29 May 2015 07:35:42 +0000"  >&lt;p&gt;No, they are in totally independent docker containers (then isolate ip, port, file system), so they don&apos;t share any resources directly.&lt;/p&gt;

&lt;p&gt;I changed the client issue, but the problem is still there. I also tried the same reconfig steps in a faster environment (outside of docker container). It cannot be reproduced any more. So the slow environment just extends the bug window and makes it can be reproduced consistently. &lt;/p&gt;</comment>
                            <comment id="14565874" author="shralex" created="Sat, 30 May 2015 07:29:16 +0000"  >&lt;p&gt;can you post the logs from the run you mention where the client doesn&apos;t disconnect ?&lt;/p&gt;</comment>
                            <comment id="14566031" author="fpj" created="Sat, 30 May 2015 14:58:58 +0000"  >&lt;p&gt;There are a few really weird things here. Check these notifications:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Notification: 2 (message format version), -9223372036854775808 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LEADING (my state)100000049 (n.config version)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I checked the logs of 3 and does sound like it sent this notification. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Sending Notification: -9223372036854775808 (n.leader), 0x0 (n.zxid), 0x1 (n.round), 1 (recipient), 3 (myid), 0x0 (n.peerEpoch)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The initialization of leader election here doesn&apos;t sound right.  And, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; has pointed out, 2 and 3 apparently received notifications with 0xffffffffffffffff as the round of the sender.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xffffffffffffffff (n.round), LEADING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)100000049 (n.config version)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;I found no evidence in the log of 1 that it has actually set or sent such a value. &lt;/p&gt;

&lt;p&gt;The values I&apos;m seeing in the notification across logs look a bit strange.&lt;/p&gt;</comment>
                            <comment id="14566340" author="michim" created="Sun, 31 May 2015 04:35:18 +0000"  >&lt;p&gt;I&apos;m guessing node1 is hitting this case?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/76bb6747c8250f28157636cf4011b78e7569727a/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/76bb6747c8250f28157636cf4011b78e7569727a/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L332&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this case we don&apos;t log the message that gets sent out.&lt;/p&gt;</comment>
                            <comment id="14567362" author="ziyouw" created="Mon, 1 Jun 2015 14:34:50 +0000"  >&lt;p&gt;In this test, the ReconfigCommand class is changed to stay after finishing the reconfig request. The client connection for reconfiguring node 2 stays about extra 5 secs there. But the client connection for reconfiguring node 3 still fails immediately.  So it means client connection is broken by something in server side.&lt;/p&gt;</comment>
                            <comment id="14568511" author="ziyouw" created="Tue, 2 Jun 2015 04:42:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I tried this and upload the logs. Seems the bug itself will break the client connection. In the client side, after it issues the request, I just get an exception: KeeperErrorCode = ConnectionLoss. So even we don&apos;t close the session, the server does.&lt;/p&gt;</comment>
                            <comment id="14568514" author="ziyouw" created="Tue, 2 Jun 2015 04:48:24 +0000"  >&lt;p&gt;When the bug is triggered, the client connection which is used to issue the reconfig request also will be broken. The client will get a ConnectionLoss error as the reconfig result.&lt;/p&gt;</comment>
                            <comment id="14569805" author="rgs" created="Tue, 2 Jun 2015 21:39:37 +0000"  >&lt;p&gt;That&apos;s expected right?&lt;/p&gt;</comment>
                            <comment id="14569823" author="rgs" created="Tue, 2 Jun 2015 21:45:23 +0000"  >&lt;p&gt;Slightly related: &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2202&quot; title=&quot;Cluster crashes when reconfig adds an unreachable observer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2202&quot;&gt;ZOOKEEPER-2202&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14570213" author="ziyouw" created="Wed, 3 Jun 2015 03:26:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;thought the bug may be caused when the client connection is closed. But the result shows that the server will close the connection before the client. In correct case, the connection should be kept until the client receives the new config status.&lt;/p&gt;</comment>
                            <comment id="14570229" author="shralex" created="Wed, 3 Jun 2015 03:52:25 +0000"  >&lt;p&gt;In zoo-2-3.log you can see server 3 processing requests till the end of the run. The other servers seem ok too, the only thing is the connection being closed right after the reconfig, but this is expected -  the leader election algorithm is being reset. Server 2 should still be connected to server 1 through the leader port and can continue processing requests. So the last logs seem quite ok. &lt;/p&gt;

&lt;p&gt;Can we conclude that the bug happens when the client disconnects before getting a response ?&lt;/p&gt;</comment>
                            <comment id="14570531" author="ziyouw" created="Wed, 3 Jun 2015 09:25:30 +0000"  >&lt;p&gt;The bug shows again with the same code change in last change.&lt;/p&gt;</comment>
                            <comment id="14570539" author="ziyouw" created="Wed, 3 Jun 2015 09:38:03 +0000"  >&lt;p&gt;The bug just was not triggered in that run. Please check the new log. I use the same code to try again and hit the bug this time. I really doubt that it is caused by client connections, because it is hard to explain why we cannot hit this bug with the same client after waiting some time.&lt;/p&gt;</comment>
                            <comment id="14571772" author="rgs" created="Wed, 3 Jun 2015 22:41:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;: it might be helpful to dump the FLE (FastLeaderElection) and ZAB messages when the bug is triggered. You could do this with zktraffic (&lt;a href=&quot;https://github.com/twitter/zktraffic&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twitter/zktraffic&lt;/a&gt;), i.e.:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;$ sudo pip install zktraffic&lt;br/&gt;
$ sudo fle-dump --iface=eth0&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;from another terminal&lt;br/&gt;
$ sudo zab-dump --iface=eth0&lt;/li&gt;
&lt;/ol&gt;

</comment>
                            <comment id="14571946" author="suda" created="Thu, 4 Jun 2015 01:23:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;&lt;br/&gt;
FYI this patch for zktraffic might be useful: &lt;a href=&quot;https://github.com/twitter/zktraffic/pull/30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/twitter/zktraffic/pull/30&lt;/a&gt; (Deeper dissection of Quorum packets and Reconfig packets)&lt;/p&gt;
</comment>
                            <comment id="14572133" author="shralex" created="Thu, 4 Jun 2015 04:45:31 +0000"  >&lt;p&gt;Server 1:&lt;/p&gt;

&lt;p&gt;2015-06-03 17:15:27,692 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1)::QuorumCnxManager@365&amp;#93;&lt;/span&gt; - Opening channel to server 3&lt;br/&gt;
2015-06-03 17:15:27,710 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1)::QuorumCnxManager@371&amp;#93;&lt;/span&gt; - Connected to server 3&lt;br/&gt;
...&lt;br/&gt;
2015-06-03 17:15:31,649 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.0.0.2:50710:LearnerHandler@580&amp;#93;&lt;/span&gt; - Unexpected exception causing shutdown while sock still open&lt;br/&gt;
java.net.SocketTimeoutException: Read timed out&lt;br/&gt;
	at java.net.SocketInputStream.socketRead0(Native Method)&lt;br/&gt;
	at java.net.SocketInputStream.read(Unknown Source)&lt;br/&gt;
	at java.net.SocketInputStream.read(Unknown Source)&lt;br/&gt;
	at java.io.BufferedInputStream.fill(Unknown Source)&lt;br/&gt;
	at java.io.BufferedInputStream.read(Unknown Source)&lt;br/&gt;
	at java.io.DataInputStream.readInt(Unknown Source)&lt;br/&gt;
	at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)&lt;br/&gt;
	at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:493)&lt;br/&gt;
2015-06-03 17:15:31,650 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.0.0.2:50710:LearnerHandler@595&amp;#93;&lt;/span&gt; - ******* GOODBYE /10.0.0.2:50710 ********&lt;br/&gt;
Server 3:&lt;/p&gt;

&lt;p&gt;2015-06-03 17:15:27,702 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;/10.0.0.3:1200:QuorumCnxManager$Listener@556&amp;#93;&lt;/span&gt; - Received connection request /10.0.0.1:39184&lt;br/&gt;
2015-06-03 17:15:31,718 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:3&amp;#93;&lt;/span&gt; - WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;/10.0.0.3:1200:QuorumCnxManager@268&amp;#93;&lt;/span&gt; - Exception reading or writing challenge: java.net.SocketTimeoutException: Read timed out&lt;/p&gt;

&lt;p&gt;It seems that server 3 is still in the initial connection phase while server 1 already passed it and wants to start working (fails on the qp = new QuorumPacket() line).&lt;/p&gt;

&lt;p&gt;It may be helpful to log everything server 3 gets from server 1 before it crashes in QuorumCnxnManager receiveConnection, exactly what execution path is taken, etc.  You could also print server 1&apos;s side in LearnerHandler.java&lt;/p&gt;

&lt;p&gt;Also, are you sure that the zookeeper distribution on these two servers is the same ?&lt;/p&gt;
</comment>
                            <comment id="14572134" author="shralex" created="Thu, 4 Jun 2015 04:46:46 +0000"  >&lt;p&gt;btw, sorry for being slow to respond&lt;/p&gt;</comment>
                            <comment id="14572346" author="shralex" created="Thu, 4 Jun 2015 08:13:50 +0000"  >&lt;p&gt;I might have misread the log - the exception on server 1 may be due to a problem talking with server 2. Would be good to log the server id to which the learnerhandler belongs.&lt;/p&gt;

&lt;p&gt;Another suggestion is to log more things in Follower.java - case Leader.PROPOSAL and Leader.COMMIT.&lt;br/&gt;
Its possible that something happens there that causes the follower to hang and the leader&apos;s socket to timeout.&lt;/p&gt;</comment>
                            <comment id="14572383" author="ziyouw" created="Thu, 4 Jun 2015 08:46:02 +0000"  >&lt;p&gt;Yes, I also suspect this is caused when server 3 is still syncing data from server 1 or server 2. So it explains why this bug is easier to be triggered in slow environment and can be avoided by waiting.&lt;/p&gt;

&lt;p&gt;So you mean I need to add extra log in QuorumCnxnManager and LearnerHandler for this case?&lt;/p&gt;

&lt;p&gt;Yes, the three servers use the same docker image.&lt;/p&gt;</comment>
                            <comment id="14572425" author="ziyouw" created="Thu, 4 Jun 2015 09:17:14 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=suda&quot; class=&quot;user-hover&quot; rel=&quot;suda&quot;&gt;suda&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks a lot for this info. I can try this when I try to reproduce it next time.&lt;/p&gt;</comment>
                            <comment id="14572900" author="shralex" created="Thu, 4 Jun 2015 14:44:50 +0000"  >&lt;p&gt;Yeah, just add a lot of logging statements if you could, in QuorumCnxnManager, LearnerHandler  and Follower.java where proposals and COMMITS are received. I&apos;d actually start from the latter to see if server 2 somehow gets stuck in the middle of processing a reconfig command.&lt;/p&gt;</comment>
                            <comment id="14587117" author="shralex" created="Mon, 15 Jun 2015 23:14:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;, could you please check if the bug still exists with 2212 patch applied ?&lt;/p&gt;</comment>
                            <comment id="14588049" author="ziyouw" created="Tue, 16 Jun 2015 13:48:20 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, thanks for notifying this. I try the 2212 patch today and find it indeed reduce the chance to reproduce the problem. From the log, I can see this logic:&lt;/p&gt;

&lt;p&gt;if (!rqv.equals(curQV)) {&lt;br/&gt;
    LOG.info(&quot;restarting leader election&quot;);&lt;br/&gt;
    self.shuttingDownLE = true;&lt;br/&gt;
    self.getElectionAlg().shutdown();&lt;br/&gt;
    break;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;will be executed in node 2 once and node 3 twice in success case.&lt;/p&gt;

&lt;p&gt;But I still can hit the problem (although it is hard than before). In the fail case, I find the above logic only is executed once in the node 3.&lt;/p&gt;

&lt;p&gt;Sorry for updating this jira late, I am busy for some urgent issues before.&lt;/p&gt;</comment>
                            <comment id="14589603" author="ziyouw" created="Wed, 17 Jun 2015 10:34:58 +0000"  >&lt;p&gt;Log files after applying patch 2212. The bug is hard to be reproduced after applying 2212.&lt;/p&gt;</comment>
                            <comment id="14591101" author="suda" created="Thu, 18 Jun 2015 01:45:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2212&quot; title=&quot;distributed race condition related to QV version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2212&quot;&gt;&lt;del&gt;ZOOKEEPER-2212&lt;/del&gt;&lt;/a&gt; seems not directly related to this bug.&lt;/p&gt;

&lt;p&gt;If ZK hits a race condition that is resolved in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2212&quot; title=&quot;distributed race condition related to QV version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2212&quot;&gt;&lt;del&gt;ZOOKEEPER-2212&lt;/del&gt;&lt;/a&gt;, &lt;tt&gt;LOG.debug(&quot;Skip processReconfig(), state: {}&quot;, self.getServerState());&lt;/tt&gt; must be found in log files.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/ec056d3c3a18b862d0cd83296b7d4319652b0b1c/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/ec056d3c3a18b862d0cd83296b7d4319652b0b1c/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L308&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Perhaps the bug got hard due to other causes (e.g., network latency gets shorter)?&lt;/p&gt;
</comment>
                            <comment id="14591102" author="suda" created="Thu, 18 Jun 2015 01:45:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2212&quot; title=&quot;distributed race condition related to QV version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2212&quot;&gt;&lt;del&gt;ZOOKEEPER-2212&lt;/del&gt;&lt;/a&gt; seems not directly related to this bug.&lt;/p&gt;

&lt;p&gt;If ZK hits a race condition that is resolved in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2212&quot; title=&quot;distributed race condition related to QV version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2212&quot;&gt;&lt;del&gt;ZOOKEEPER-2212&lt;/del&gt;&lt;/a&gt;, &lt;tt&gt;LOG.debug(&quot;Skip processReconfig(), state: {}&quot;, self.getServerState());&lt;/tt&gt; must be found in log files.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/ec056d3c3a18b862d0cd83296b7d4319652b0b1c/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/ec056d3c3a18b862d0cd83296b7d4319652b0b1c/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L308&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Perhaps the bug got hard due to other causes (e.g., network latency gets shorter)?&lt;/p&gt;
</comment>
                            <comment id="14591132" author="ziyouw" created="Thu, 18 Jun 2015 02:20:33 +0000"  >&lt;p&gt;Just check the patch again. Yes, we should not hit 2212 here. But it is really weird to find the affection in our case. I just use three docker containers to run the nodes in the same host. So I don&apos;t think the network latency will change, but I am not sure the disk latency changes or not.&lt;/p&gt;</comment>
                            <comment id="14593156" author="suda" created="Fri, 19 Jun 2015 07:56:29 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;It is so interesting that both of servers 1 and 2 timeout at 15:55:08,439 after reconfig has begun at 15:55:04.&lt;br/&gt;
After these timeouts, both &lt;tt&gt;ZooKeeperServer&lt;/tt&gt; cannot be revived and the ensemble gets weird.&lt;br/&gt;
(However in zoo-3-2.log (Jun 3), server 2 raises &lt;tt&gt;EOFException&lt;/tt&gt;, not &lt;tt&gt;SocketTimeoutException&lt;/tt&gt; at 17:15:31).&lt;/p&gt;

&lt;p&gt;These timeouts are raised by &lt;a href=&quot;https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L515&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this while loop&lt;/a&gt; in server 1 and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L89&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this while loop&lt;/a&gt; in server 2.&lt;/p&gt;

&lt;p&gt;Unfortunately, we are not sure which types of QuorumPacket are triggering these timeouts.&lt;br/&gt;
So I think it might be helpful to add &lt;tt&gt;LOG.debug(qp.getType())&lt;/tt&gt; at &lt;a href=&quot;https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this switch&lt;/a&gt; for server 1 and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this switch&lt;/a&gt; for server 2.&lt;/p&gt;

&lt;p&gt;Perhaps they are not pinging each other?&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L924-925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This&lt;/a&gt; comment in &lt;tt&gt;LearnerHandler.ping()&lt;/tt&gt; seems interesting.&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;// If learner hasn&apos;t sync properly yet, don&apos;t send ping packet&lt;br/&gt;
// otherwise, the learner will crash&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14597197" author="ziyouw" created="Tue, 23 Jun 2015 05:38:55 +0000"  >&lt;p&gt;Add log to record quorum packet types.&lt;/p&gt;</comment>
                            <comment id="14597203" author="ziyouw" created="Tue, 23 Jun 2015 05:44:18 +0000"  >&lt;p&gt;Thanks for looking on this. I always suspect this problem may has relationship with the sync. Because I need to wait more time to avoid it when the cluster is running with a slow disk.&lt;/p&gt;

&lt;p&gt;I upload the log files after I add the log to record the quorum packet type.&lt;/p&gt;</comment>
                            <comment id="14597439" author="suda" created="Tue, 23 Jun 2015 10:12:30 +0000"  >&lt;p&gt;Hi,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for logging.&lt;/p&gt;

&lt;p&gt;From the latest logs, we can confirm that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;server 1 is not &lt;a href=&quot;https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pinging(packet type=5) to server 2&lt;/a&gt; after reconfig at 13:30:33,573, and hence server 2 cannot &lt;a href=&quot;https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pong&lt;/a&gt; to server 1. then server 1 timeouts for pong from server 2 and shutdowns(&lt;a href=&quot;https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L619-622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; at 13:30:37,560 and &lt;a href=&quot;https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; at 13:30:53,638).&lt;/li&gt;
	&lt;li&gt;server 1 is not &lt;a href=&quot;https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L1066&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;proposing(packet type=2) to server 2&lt;/a&gt;. &lt;tt&gt;CommitProcessor&lt;/tt&gt; is working at 13:30:33,575, but &lt;tt&gt;ProposalRequestProcessor&lt;/tt&gt; seems not.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Maybe &lt;tt&gt;Leader.lead()&lt;/tt&gt; and &lt;tt&gt;Leader.propose()&lt;/tt&gt; are racing due to some reasons related to syncing?&lt;br/&gt;
I will check this later.&lt;/p&gt;</comment>
                            <comment id="14598909" author="ziyouw" created="Wed, 24 Jun 2015 05:56:23 +0000"  >&lt;p&gt;Can we add more logs to find the race condition here? I guess the problem will happens when server 3 still is syncing data from leader. So if you can slow down this sync process and do the reconfig before it finishes, we may also can reproduce this process in normal environment. &lt;/p&gt;</comment>
                            <comment id="14602661" author="suda" created="Fri, 26 Jun 2015 10:20:01 +0000"  >&lt;p&gt;Yes, as many logs as possible might be helpful.&lt;br/&gt;
Plus some additional information such as the accurate ZK version, workload scripts, or filesystem information might be also helpful.&lt;/p&gt;

&lt;p&gt;I am trying to reproduce the bug by injecting some {{Thread.sleep()}}s into syncing-related functions using byteman.&lt;br/&gt;
But I could not reproduced the bug at this moment, as I am not sure which function should be injected.&lt;/p&gt;</comment>
                            <comment id="14634903" author="mitake" created="Tue, 21 Jul 2015 10:12:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;It seems that I could reproduce this problem. Just adding new servers with reconfig one by one, then the ensemble rejects every client request.&lt;br/&gt;
(Of course there is a possibility of my misunderstanding)&lt;/p&gt;

&lt;p&gt;I used our distributed systems debugger named &lt;a href=&quot;https://github.com/osrg/earthquake&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;earthquake&lt;/a&gt;. It uses byteman and inspect execution of debuggee (zookeeper server in this case). It tries to cause corner case situations that is hard to be produced in ordinal testing by reordering inspected method calls and returns.&lt;/p&gt;

&lt;p&gt;We are preparing a docker image for easy reproducing in your environment. Please wait for a while.&lt;/p&gt;

&lt;p&gt;I&apos;m analyzing the problem and would like to post the root cause and patch, but it may take a time because I&apos;m new to zookeeper. So I attached logs (zookeeper-123.out) and the history of ensemble (history.txt). The logs seem to be similar to yours.&lt;br/&gt;
The format of the history is earthquake specific format, so it wouldn&apos;t be easy to read. But I think you can interpret the event sequence roughly (it is just a sequence of method calls and returns + their stacktrace). It would be great if I can hear your comments.&lt;/p&gt;</comment>
                            <comment id="14636159" author="shralex" created="Wed, 22 Jul 2015 03:36:51 +0000"  >&lt;p&gt;It looks like server 2 is crashing before the first reconfig is invoked (18:14:48 is when the reconfig happens).&lt;/p&gt;

&lt;p&gt;This is what happens on server 2:&lt;/p&gt;

&lt;p&gt;INFO: paramMap: &lt;/p&gt;
{quorumPacket=PING 200000001 null}
&lt;p&gt;quorum packet send in Follower : org.jboss.byteman.rule.exception.ExecuteException: MethodExpression.interpret : exception invoking method packetToString file /earthquake/reconfig-trunk/materials/server.btm line 34&lt;br/&gt;
2015-07-21 18:14:43,735 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;SyncThread:2:ZooKeeperCriticalThread@48&amp;#93;&lt;/span&gt; - Severe unrecoverable error, from thread : SyncThread:2&lt;br/&gt;
org.jboss.byteman.rule.exception.ExecuteException: MethodExpression.interpret : exception invoking method packetToString file /earthquake/reconfig-trunk/materials/server.btm line 34&lt;br/&gt;
	at org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:347)&lt;br/&gt;
	at org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:334)&lt;br/&gt;
	at org.jboss.byteman.rule.Action.interpret(Action.java:144)&lt;br/&gt;
	at net.osrg.earthquake.PBEQHelper_HelperAdapter_Interpreted_2.fire(server.btm)&lt;br/&gt;
	at net.osrg.earthquake.PBEQHelper_HelperAdapter_Interpreted_2.execute0(server.btm)&lt;br/&gt;
	at net.osrg.earthquake.PBEQHelper_HelperAdapter_Interpreted_2.execute(server.btm)&lt;br/&gt;
	at org.jboss.byteman.rule.Rule.execute(Rule.java:684)&lt;br/&gt;
	at org.jboss.byteman.rule.Rule.execute(Rule.java:653)&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.Learner.writePacket(Learner.java)&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.SendAckRequestProcessor.flush(SendAckRequestProcessor.java:62)&lt;br/&gt;
	at org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:186)&lt;br/&gt;
	at org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:113)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.zookeeper.server.quorum.LearnerHandler.packetToString(LearnerHandler.java:261)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:606)&lt;br/&gt;
	at org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:341)&lt;br/&gt;
	... 11 more&lt;br/&gt;
2015-07-21 18:14:43,735 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;SyncThread:2:ZooKeeperServer$ZooKeeperServerListenerImpl@442&amp;#93;&lt;/span&gt; - Thread SyncThread:2 exits, error code 1&lt;br/&gt;
2015-07-21 18:14:43,735 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;SyncThread:2:LearnerZooKeeperServer@165&amp;#93;&lt;/span&gt; - Shutting down&lt;br/&gt;
2015-07-21 18:14:43,735 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;SyncThread:2:ZooKeeperServer@465&amp;#93;&lt;/span&gt; - shutting down&lt;br/&gt;
2015-07-21 18:14:43,735 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;SyncThread:2:FollowerRequestProcessor@138&amp;#93;&lt;/span&gt; - Shutting down&lt;br/&gt;
2015-07-21 18:14:43,735 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;SyncThread:2:CommitProcessor@358&amp;#93;&lt;/span&gt; - Shutting down&lt;br/&gt;
2015-07-21 18:14:43,736 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:2&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;FollowerRequestProcessor:2:FollowerRequestProcessor@109&amp;#93;&lt;/span&gt; - FollowerRequestProcessor exited loop!&lt;/p&gt;


&lt;p&gt;then server 1, the leader, is sending an incremental reconfig and timing out and closing the connection.&lt;/p&gt;

&lt;p&gt;2015-07-21 18:14:48,750 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ProcessThread(sid:1 cport:-1)::PrepRequestProcessor@512&amp;#93;&lt;/span&gt; - Incremental reconfig&lt;br/&gt;
Jul 21, 2015 6:14:48 PM net.osrg.earthquake.PBInspector EventFuncReturn&lt;br/&gt;
INFO: paramMap: &lt;/p&gt;
{quorumPacket=PROPOSAL 200000002 null}
&lt;p&gt;.....&lt;br/&gt;
2015-07-21 18:15:02,739 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - WARN  [QuorumPeer&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=1&amp;#93;&lt;/span&gt;(plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):LearnerHandler@937] - Closing connection to peer due to transaction timeout.&lt;/p&gt;

</comment>
                            <comment id="14636214" author="shralex" created="Wed, 22 Jul 2015 04:44:31 +0000"  >&lt;p&gt;I may be wrong, but it looks like the crash on server 2 happens after the sync, when the server tries to respond to the leader&apos;s PING. It executes the following:&lt;/p&gt;

&lt;p&gt;   protected void processPacket(QuorumPacket qp) throws Exception{&lt;br/&gt;
        switch (qp.getType()) {&lt;br/&gt;
        case Leader.PING:            &lt;br/&gt;
            ping(qp);            &lt;/p&gt;

&lt;p&gt;So just tries to send a PING back. The ping() function in Learner.java sends the same packet back, just changes the data, it doesn&apos;t create a new packet. I wonder if its a problem somehow that a new packet is not being created. The exception message is NullPointerException, so maybe somehow the old packet gets deallocated ?&lt;/p&gt;</comment>
                            <comment id="14636344" author="mitake" created="Wed, 22 Jul 2015 05:54:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, thanks for your reply.&lt;/p&gt;

&lt;p&gt;As you pointed, the crash is caused in the inspection layer (written in byteman). Sorry for bothering.&lt;/p&gt;

&lt;p&gt;But the NullPointerException is a little bit odd. The exception is caused by the byteman script like this:&lt;br/&gt;
RULE quorum packet receive in Follower&lt;br/&gt;
CLASS Learner&lt;br/&gt;
METHOD readPacket&lt;br/&gt;
HELPER net.osrg.earthquake.PBEQHelper&lt;br/&gt;
BIND argMap = new java.util.HashMap()&lt;br/&gt;
AT EXIT&lt;br/&gt;
IF $# == 1&lt;br/&gt;
DO&lt;br/&gt;
argMap.put(&quot;quorumPacket&quot;, org.apache.zookeeper.server.quorum.LearnerHandler.packetToString($1));&lt;br/&gt;
eventFuncReturn(&quot;Learner.readPacket&quot;, argMap);&lt;br/&gt;
ENDRULE&lt;/p&gt;

&lt;p&gt;IIUC, the quorumpacket will never be null in follower. I&apos;ll look at the problem.&lt;/p&gt;</comment>
                            <comment id="14642401" author="ziyouw" created="Mon, 27 Jul 2015 07:42:36 +0000"  >&lt;p&gt;Thanks for watching on this. For this JIRA, I think the problem will happen if we do reconfig before the new node can sync all data from leader. So cloud we use earthquake to simulate this race condition? Currently, this problem only can be hit in VM environment.&lt;/p&gt;</comment>
                            <comment id="14642415" author="mitake" created="Mon, 27 Jul 2015 08:09:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Could you check my understanding is correct? IIUC, your situation is like below:&lt;br/&gt;
1. server 1 boot&lt;br/&gt;
2. server 2 boot&lt;br/&gt;
3. client issues reconfig to server 1&lt;br/&gt;
4. server 2 tries to sync with server 1 with Learner.syncWithLeader()&lt;br/&gt;
5. server 3 boot&lt;br/&gt;
6. client issues reconfig to server 1&lt;/p&gt;

&lt;p&gt;(reconfig requests in 3 and 6 are overwrapping)&lt;/p&gt;

&lt;p&gt;Is this correct, I&apos;ll be able to reproduce the situation with earthquake.&lt;/p&gt;
</comment>
                            <comment id="14642435" author="mitake" created="Mon, 27 Jul 2015 08:30:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt; BTW, if it is possible, could you share your dockerfile for your testing?&lt;/p&gt;</comment>
                            <comment id="14642436" author="mitake" created="Mon, 27 Jul 2015 08:30:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt; BTW, if it is possible, could you share your dockerfile for your testing?&lt;/p&gt;</comment>
                            <comment id="14642437" author="mitake" created="Mon, 27 Jul 2015 08:30:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt; BTW, if it is possible, could you share your dockerfile for your testing?&lt;/p&gt;</comment>
                            <comment id="14642439" author="mitake" created="Mon, 27 Jul 2015 08:31:44 +0000"  >&lt;p&gt;Sorry for bothering with duplicated replies...&lt;/p&gt;</comment>
                            <comment id="14643947" author="mitake" created="Tue, 28 Jul 2015 06:56:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ziyouw&quot; class=&quot;user-hover&quot; rel=&quot;ziyouw&quot;&gt;ziyouw&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I found a little bit strange code path like below:&lt;br/&gt;
1. In the tail of Leader.shutdown(), leader tries to remove all learner handlers with synchronized (learners). The loop calls LearnerHandler.shutdown().&lt;br/&gt;
2. In LearnerHandler.shutdown(), learder.removeLearnerHandler() is called.&lt;br/&gt;
3. In Leader.removeLearnerHandler(), the member of Leader, learners, is also locked by synchronized&lt;/p&gt;

&lt;p&gt;Seems that the above sequence can cause deadlock.&lt;/p&gt;

&lt;p&gt;I removed synchronized(learners) in removeLearnerHandler in the attached patch. Could you test it on your environment?&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the targetting version is 3.5.0&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14643952" author="mitake" created="Tue, 28 Jul 2015 06:58:02 +0000"  >&lt;p&gt;Sorry, the synchronized is reentrant, the patch would be wrong... please ignore it.&lt;/p&gt;</comment>
                            <comment id="14643954" author="mitake" created="Tue, 28 Jul 2015 07:04:05 +0000"  >&lt;p&gt;But the attached logs (with DEBUG level) don&apos;t contain messages of QuorumPeer.updateServerState(). Perhaps shutdown process of leader is stopping QuorumPeer main thread?&lt;/p&gt;</comment>
                            <comment id="14651669" author="ziyouw" created="Mon, 3 Aug 2015 09:43:44 +0000"  >&lt;p&gt;Sorry, I had some problems to receive mails from the registered mail address in last week.&lt;/p&gt;

&lt;p&gt;The situation is quite simple: start one zk server, and reconfig in server 1 to add the new server in the cluster, then start and reconfig the next server. But 4 should be finished before 3, because when we increase the node number from 1 to 2, zk must make sure the cluster still in majority after reconfig. When we add the second server into the cluster, then the server 3 is started and reconfigured to be part of the cluster.&lt;/p&gt;</comment>
                            <comment id="14651679" author="ziyouw" created="Mon, 3 Aug 2015 09:50:40 +0000"  >&lt;p&gt;Sorry, it is commercial code and I don&apos;t have the right to share it. But the environment is quite simple, I just run each zk server in one docker container and all the containers are running in the same VM. I think the key problem of this environment is the disk latency should be longer than  normal cases. And this problem will become even serious if all of them are running with a slow disk.&lt;/p&gt;</comment>
                            <comment id="15390949" author="arshad.mohammad" created="Sun, 24 Jul 2016 05:39:58 +0000"  >&lt;p&gt;We also faced this issue.&lt;br/&gt;
The problem occurs when reconfig&apos;s PROPOSAL and COMMITANDACTIVATE come in between the snapshot and the uptodate&lt;br/&gt;
Following steps can followed to reproduce this issue very easily:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;start three server zookeeper cluster, lets say servers are server-1, server-2, server-3&lt;/li&gt;
	&lt;li&gt;create big data in zookeeper, around 150 MB&lt;/li&gt;
	&lt;li&gt;install the fourth server server-4, add server information of all the four servers in server-4
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;server.1=192.168.1.3:2888:3888:participant
server.2=192.168.1.3:2889:3889:participant
server.3=192.168.1.3:2890:3890:participant
server.4=192.168.1.2:2890:3890:participant
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;connect to any of the existing servers&lt;/li&gt;
	&lt;li&gt;start server-4, immediately run reconfig command from already connected client.&lt;br/&gt;
&lt;tt&gt;reconfig -add server.4=192.168.1.2:2890:3890:participant;2181&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;open zookeeper/conf folder, you will find zoo.cfg.dynamic.next and existing quorum dynamic configuration file zoo.cfg.dynamic.100000000&lt;br/&gt;
zoo.cfg.dynamic.next --&amp;gt; this has information of all the servers&lt;br/&gt;
zoo.cfg.dynamic.100000000 --&amp;gt; this has information of only existing servers server-1,server-2,server-3&lt;/li&gt;
	&lt;li&gt;Even though server-4 started and joined the quorum, if try to to restart, it will fail with following errors
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-07-24 11:00:11,689 [myid:4] - ERROR [main:QuorumPeerMain@98] - Unexpected exception, exiting abnormally
java.lang.RuntimeException: My id 4 not in the peer list
		at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:748)
		at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:183)
		at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:120)
		at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:79)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15390956" author="arshad.mohammad" created="Sun, 24 Jul 2016 06:04:01 +0000"  >&lt;p&gt;The issue occurs when reconfig&apos;s PROPOSAL and COMMITANDACTIVATE come in between the snapshot and the uptodate, while syncing with the leader.&lt;br/&gt;
In the existing code the reconfig commit is not processed as it should be processed for follower. In case of observer the reconfig&apos;s commit is processed properly.&lt;br/&gt;
We can process the reconfig&apos;s commit for follower in the same way as it is being processed for observer to fix this issue.&lt;br/&gt;
Submitting the fix&lt;/p&gt;</comment>
                            <comment id="15390957" author="shralex" created="Sun, 24 Jul 2016 06:11:32 +0000"  >&lt;p&gt;Could you please provide the logs ?&lt;/p&gt;

&lt;p&gt;The existence of .next file indicates that there was a failure in the middle of reconfig, and the commitandactivate&lt;br/&gt;
message didn&apos;t arrive to the server on which you find this file. Which server was it ? just 4 or all of them ?&lt;br/&gt;
The zoo.cfg.dynamic.100000000 file is the old configuration.&lt;/p&gt;

&lt;p&gt;Did the other servers continue to operate normally ? did they reboot ? were they able to serve requests afterwards ? would be helpful if you describe this too.&lt;/p&gt;

&lt;p&gt;7) is actually expected if server 4 crashed before it got the commitandactivate message. I described this in the manual:&lt;/p&gt;

&lt;p&gt;&quot;Finally, note that once connected to the leader, a joiner adopts the last committed configuration, in which it is absent (the initial config of the joiner is backed up before being rewritten). If the joiner restarts in this state, it will not be able to boot since it is absent from its configuration file. In order to start it you&#8217;ll once again have to specify an initial configuration.&quot;&lt;/p&gt;</comment>
                            <comment id="15393388" author="arshad.mohammad" created="Tue, 26 Jul 2016 07:53:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;The existence of .next file indicates that there was a failure in the middle of reconfig, and the commitandactivate message didn&apos;t arrive to the server on which you find this file. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Failure may be one of scenarios where .next file is not deleted but not the only scenario. In this scenario .next file exists because of logical problem in the code.&lt;br/&gt;
commitandactivate message arrives but it is not getting process because of bellow reason:&lt;br/&gt;
sequence of events:&lt;br/&gt;
1) case Leader.NEWLEADER:&lt;br/&gt;
lastSeenQuorumVerifier is updated with 100000000 and .next file created.&lt;br/&gt;
2) case Leader.PROPOSAL(reconfig): &lt;br/&gt;
lastSeenQuorumVerifier is updated with 200000000 and earlier .next file overridden&lt;br/&gt;
3) case Leader.COMMITANDACTIVATE:&lt;br/&gt;
Because snapshot in taken in step 1 snapshotTaken=true and &lt;tt&gt;self.processReconfig();&lt;/tt&gt; is not called. This call was supposed to delete .next file and create the updated zoo.cfg.dynamic.200000000 file&lt;br/&gt;
code reference:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!snapshotTaken) {
----
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; majorChange =
	   self.processReconfig(qv, ByteBuffer.wrap(qp.getData()).getLong(), qp.getZxid(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
----
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;4) &lt;br/&gt;
case Leader.UPTODATE:&lt;br/&gt;
this calls self.processReconfig but again it is skipped because the lastSeenQuorumVerifier version is higher. it got updated in 2)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; QuorumVerifier setQuorumVerifier(QuorumVerifier qv, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; writeToDisk){
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((quorumVerifier != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &amp;amp;&amp;amp; (quorumVerifier.getVersion() &amp;gt;= qv.getVersion())) {

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;blockquote&gt;&lt;p&gt;Which server was it ? just 4 or all of them ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;just 4&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;is actually expected if server 4 crashed before it got the commitandactivate message. I described this in the manual:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But the sever did not crash. It is in normal flow&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Could you please provide the logs ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can you please try to reproduce with the above steps, we can reach to a conclusion fast. Let me know, if not reproducing I will reproduce and share the logs&lt;/p&gt;</comment>
                            <comment id="15393954" author="shralex" created="Tue, 26 Jul 2016 15:34:36 +0000"  >&lt;p&gt;Hi Arshad, your patch makes sense to me (as you say - processReconfig should be called and it wasn&apos;t when the snapshot flag was on), &lt;br/&gt;
but we probably shouldn&apos;t commit it without a test. Since you have a clear scenario when this fails without the patch, would you be able to add a test ?&lt;br/&gt;
I&apos;m away until Aug 8 but can review when I&apos;m back.&lt;/p&gt;</comment>
                            <comment id="15407936" author="arshad.mohammad" created="Thu, 4 Aug 2016 15:25:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, Please find new patch &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2172&quot; title=&quot;Cluster crashes when reconfig a new node as a participant&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2172&quot;&gt;&lt;del&gt;ZOOKEEPER-2172&lt;/del&gt;&lt;/a&gt;-03.patch, which includes test case as well.&lt;/p&gt;</comment>
                            <comment id="15407977" author="hadoopqa" created="Thu, 4 Aug 2016 15:47:04 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12822094/ZOOKEEPER-2172-03.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12822094/ZOOKEEPER-2172-03.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1755100.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15414507" author="shralex" created="Wed, 10 Aug 2016 00:32:26 +0000"  >&lt;p&gt;Arshad Mohammad, thanks for adding the test! &lt;/p&gt;

&lt;p&gt;Does this test consistently fail without your fix ? the reason I&apos;m asking is that you pointed out previously that the issue occurs when a large snapshot is being taken, whereas in the test I don&apos;t see that the state is large. How do you make sure that COMMITANDACTIVATE is received while snapshotting ?&lt;/p&gt;</comment>
                            <comment id="15414659" author="arshad.mohammad" created="Wed, 10 Aug 2016 03:44:26 +0000"  >&lt;ol&gt;
	&lt;li&gt;Without fix, I just run 10 times, 9 times it failed one time it passed.&lt;br/&gt;
After fix: 10 times passed out of 10 run&lt;br/&gt;
At first place, covering this reconfig scenario through test cases is very difficult.&lt;br/&gt;
This test case has been added to give reviewer a confidence in the fix. Hope the test case serves the purpose.&lt;/li&gt;
	&lt;li&gt;&lt;blockquote&gt;&lt;p&gt;How do you make sure that COMMITANDACTIVATE is received while snapshotting ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not while snapshotting, but in between snapshotting and updtodate message.&lt;br/&gt;
Before sending Leader.ACK sleep is added which gives a bigger time window for reconfig PROPOSAL and COMMITANDACTIVATE arrival&lt;br/&gt;
and finally packet arrival seqence becomes  Leader.NEWLEADER(snapshotting done here) --&amp;gt; reconfig Leader.PROPOSAL --&amp;gt; reconfig Leader.COMMITANDACTIVATE --&amp;gt; Leader.UPTODATE&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15418102" author="shralex" created="Thu, 11 Aug 2016 23:21:39 +0000"  >&lt;p&gt;Thanks Arshad, I verified that the test fails before the patch and passes afterwards. I realize that the patch is complex, and appreciate you writing it! I was trying to understand the logic.&lt;/p&gt;

&lt;p&gt;A few minor comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Please rename the test so that the name reflects what is being tested. Such as ReconfigDuringLeaderSync / ReconfigDuringSnapshot or something similar.&lt;/li&gt;
	&lt;li&gt;Please don&apos;t assume that SERVER_COUNT = 3 (so the extra server can be number 4). You could use a different variable in the test instead of SERVER_COUNT, or just give the new server an id based on SERVER_COUNT instead of 4.&lt;/li&gt;
	&lt;li&gt;The test shuts down the 4th server in one method and the other three in another. Consider doing this in the same place and also closing the client handles.&lt;/li&gt;
	&lt;li&gt;getQP could be static, maybe rename to getCustomQuorumPeer or something like that&lt;/li&gt;
	&lt;li&gt;Please add more comments explaining the logic of the test. For example, in writePacket please add a comment that you&apos;re delaying the ACK message a follower sends as response to a NEWLEADER message, so that the leader has a chance to send the reconfig and only then the UPTODATE (basically your comment in this thread above). Without the comment its not clear why you&apos;re checking for ACK while setting the newLeaderMessage flag. (I hope I understood the logic correctly). Similarly, when the 4th server is being started, please add a comment saying that this server will delay the response to a NEWLEADER message. Basically, more comments would be helpful &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;In the code, shouldn&apos;t the condition of the if be &quot;pif.hdr.getZxid() == qp.getZxid() &amp;amp;&amp;amp; qp.getType() == Leader.COMMITANDACTIVATE&quot; ?&lt;br/&gt;
otherwise the logic inside the if may not be correct (the configuration info qv is extracted from pif).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Maybe change to:&lt;/p&gt;

&lt;p&gt;                    if (pif.hdr.getZxid() != qp.getZxid()) &lt;/p&gt;
{
                        LOG.warn(&quot;Committing &quot; + qp.getZxid() + &quot;, but next proposal is &quot; + pif.hdr.getZxid());
                    }
&lt;p&gt; else if (qp.getType() == Leader.COMMITANDACTIVATE) {&lt;/p&gt;


</comment>
                            <comment id="15419988" author="shralex" created="Sat, 13 Aug 2016 16:26:46 +0000"  >&lt;p&gt;another thing you could add is to check that the quorumverifier was updated e.g., when you start the fourth server do that with only itself and the leader&lt;br/&gt;
and then at the end of the test check that its quorum verifier includes all 4 servers. Checking the file deletion is ok, but its sort of a symptom of the fact&lt;br/&gt;
that reconfiguration didn&apos;t complete on that server, so this is an attempt to check the configuration explicitly.&lt;/p&gt;</comment>
                            <comment id="15420065" author="hadoopqa" created="Sat, 13 Aug 2016 20:36:04 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12823593/ZOOKEEPER-2172-04.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12823593/ZOOKEEPER-2172-04.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1756262.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15420066" author="arshad.mohammad" created="Sat, 13 Aug 2016 20:39:37 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;, addressed all the comments in the latest patch.&lt;/p&gt;</comment>
                            <comment id="15420112" author="shralex" created="Sat, 13 Aug 2016 22:59:43 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
I made a few more changes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;starting the new server with only itself and the leader in the inittial config, so we can know that its config was really updated after reconfig&lt;/li&gt;
	&lt;li&gt;changed the Learner.java logic a bit, to match what was there before ZK-107 (see revision history). Also I noticed that if majorChange = true we often skip important logic when throwing an exception, so I moved the exception part to the end of each code block.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Can another committer take a look before we commit ? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpj&quot; class=&quot;user-hover&quot; rel=&quot;fpj&quot;&gt;fpj&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15420113" author="shralex" created="Sat, 13 Aug 2016 23:11:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt;, please take a look&lt;/p&gt;</comment>
                            <comment id="15420117" author="hadoopqa" created="Sat, 13 Aug 2016 23:26:10 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12823597/ZOOKEPER-2172-05.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12823597/ZOOKEPER-2172-05.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1756262.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15420144" author="shralex" created="Sun, 14 Aug 2016 00:38:33 +0000"  >&lt;p&gt;On second thought, investigating the right way to throw the exception should probably be done in a separate jira, so I reverted some of my changes.&lt;/p&gt;</comment>
                            <comment id="15420145" author="shralex" created="Sun, 14 Aug 2016 00:47:21 +0000"  >&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2513&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2513&lt;/a&gt; as a followup&lt;/p&gt;</comment>
                            <comment id="15420214" author="hadoopqa" created="Sun, 14 Aug 2016 04:49:53 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12823602/ZOOKEEPER-2172-06.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12823602/ZOOKEEPER-2172-06.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1756262.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15420233" author="arshad.mohammad" created="Sun, 14 Aug 2016 06:16:48 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; for authoring the patch, patch is improved a lot.&lt;br/&gt;
It is good that the changes you introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2172&quot; title=&quot;Cluster crashes when reconfig a new node as a participant&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2172&quot;&gt;&lt;del&gt;ZOOKEEPER-2172&lt;/del&gt;&lt;/a&gt;-05.patch have removed in the latest patch and created new jira to address those concerns.&lt;br/&gt;
I corrected following nits in the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2172&quot; title=&quot;Cluster crashes when reconfig a new node as a participant&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2172&quot;&gt;&lt;del&gt;ZOOKEEPER-2172&lt;/del&gt;&lt;/a&gt;-06.patch  and submitted new patch&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ZOOKEEPER-2172-06.patch:10: trailing whitespace.
ZOOKEEPER-2172-06.patch:30: trailing whitespace.
                        boolean majorChange =
ZOOKEEPER-2172-06.patch:31: space before tab in indent.
                                        self.processReconfig(qv, ByteBuffer.wrap(qp.getData()).getLong(), qp.getZxid(), true);
ZOOKEEPER-2172-06.patch:35: trailing whitespace.
                    }
ZOOKEEPER-2172-06.patch:111: trailing whitespace.
     *
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15420241" author="hadoopqa" created="Sun, 14 Aug 2016 06:36:14 +0000"  >&lt;p&gt;+1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12823615/ZOOKEEPER-2172-07.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12823615/ZOOKEEPER-2172-07.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1756262.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15420429" author="shralex" created="Sun, 14 Aug 2016 18:29:44 +0000"  >&lt;p&gt;+1 from me. Since I removed most my changes, I feel comfortable committing this but lets wait a week or so to let&lt;br/&gt;
other people comment if they wish. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; would you like to take a stab at &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2513&quot; title=&quot;majorChange exceptions during leader sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2513&quot;&gt;ZOOKEEPER-2513&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="15474994" author="phunt" created="Thu, 8 Sep 2016 21:01:46 +0000"  >&lt;p&gt;Given this has signoff by Alex and it&apos;s been pending for a while I&apos;ve committed it to 3.5.3 and trunk. Thanks Arshad (and Alex)!&lt;/p&gt;</comment>
                            <comment id="15475076" author="hudson" created="Thu, 8 Sep 2016 21:27:37 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #3070 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3070/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3070/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2172&quot; title=&quot;Cluster crashes when reconfig a new node as a participant&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2172&quot;&gt;&lt;del&gt;ZOOKEEPER-2172&lt;/del&gt;&lt;/a&gt;: Cluster crashes when reconfig a new node as a participant (Arshad Mohammad via phunt) (phunt: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1759907&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1759907&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;(edit) trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
	&lt;li&gt;(add) trunk/src/java/test/org/apache/zookeeper/server/quorum/ReconfigDuringLeaderSyncTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15492587" author="arshad.mohammad" created="Thu, 15 Sep 2016 06:59:16 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bhupendra&quot; class=&quot;user-hover&quot; rel=&quot;Bhupendra&quot;&gt;Bhupendra&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ajithshetty&quot; class=&quot;user-hover&quot; rel=&quot;ajithshetty&quot;&gt;ajithshetty&lt;/a&gt; for helping me in analysing this issue.&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phunt&quot; class=&quot;user-hover&quot; rel=&quot;phunt&quot;&gt;phunt&lt;/a&gt; for reviewing and committing the patch.&lt;br/&gt;
Thanks every one for participating in the discussion and providing useful information.&lt;/p&gt;</comment>
                            <comment id="16389307" author="yuvald" created="Wed, 7 Mar 2018 09:29:32 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This issue happens in a few of our customers using 3.4.8 version.&lt;/p&gt;

&lt;p&gt;During this days we are upgrading to 3.4.10.&lt;/p&gt;

&lt;p&gt;As 3.5.3 is in Beta, is it possible to backport this fix?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yuval&#160;&lt;/p&gt;</comment>
                            <comment id="16389378" author="andorm" created="Wed, 7 Mar 2018 10:38:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuvald&quot; class=&quot;user-hover&quot; rel=&quot;yuvald&quot;&gt;yuvald&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Are you sure about it&apos;s the same issue?&lt;/p&gt;

&lt;p&gt;Dynamic reconfig is a 3.5+ feature.&lt;/p&gt;</comment>
                            <comment id="16389390" author="yuvald" created="Wed, 7 Mar 2018 11:01:01 +0000"  >&lt;p&gt;1.&#160;The use case here was adding node to ZK cluster using zookeeper-3.5.jar. It&apos;s not the same use case as for our customers.&#160;the first&#160;use 5 machines with 3 ZK instances. shutdown 2 machine (one with ZK. so 2 ZK left) and got &quot;java.lang.IllegalStateException: instance must be started before calling this method&quot;. The second customer got this error when deploying the application.&lt;/p&gt;

&lt;p&gt;This is this issue stack trace:&#160;&lt;/p&gt;

&lt;p&gt;2015-04-20 12:53:52,230 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.0.0.2:55890:LearnerHandler@580&amp;#93;&lt;/span&gt; - Unexpected exception causing shutdown while sock still open&#160;&lt;br/&gt;
java.io.EOFException&#160;&lt;br/&gt;
at java.io.DataInputStream.readInt(Unknown Source)&#160;&lt;br/&gt;
at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)&#160;&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)&#160;&lt;br/&gt;
at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)&#160;&lt;br/&gt;
at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:493)&#160;&lt;br/&gt;
2015-04-20 12:53:52,231 &lt;span class=&quot;error&quot;&gt;&amp;#91;myid:1&amp;#93;&lt;/span&gt; - WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;LearnerHandler-/10.0.0.2:55890:LearnerHandler@595&amp;#93;&lt;/span&gt; - ******* GOODBYE /10.0.0.2:55890 ********&#160;&lt;/p&gt;

&lt;p&gt;And this our customers stack trace:&#160;&lt;/p&gt;

&lt;p&gt;2018-02-15T09:58:12.094+0100; ERROR; WSOSTSLXWIT01/MANAGER; P3424/T194; &lt;span class=&quot;error&quot;&gt;&amp;#91;SPACE/LearnerHandler-/10.17.46.142:49336/LearnerHandler&amp;#93;&lt;/span&gt;; Unexpected exception causing shutdown while sock still open&#160;&lt;br/&gt;
java.net.SocketTimeoutException: Read timed out&#160;&lt;br/&gt;
at java.net.SocketInputStream.socketRead0(Native Method)&#160;&lt;br/&gt;
at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)&#160;&lt;br/&gt;
at java.net.SocketInputStream.read(SocketInputStream.java:171)&#160;&lt;br/&gt;
at java.net.SocketInputStream.read(SocketInputStream.java:141)&#160;&lt;br/&gt;
at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)&#160;&lt;br/&gt;
at java.io.BufferedInputStream.read(BufferedInputStream.java:265)&#160;&lt;br/&gt;
at java.io.DataInputStream.readInt(DataInputStream.java:387)&#160;&lt;br/&gt;
at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)&#160;&lt;br/&gt;
at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)&#160;&lt;br/&gt;
at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:99)&#160;&lt;br/&gt;
at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:542)&#160;&lt;/p&gt;

&lt;p&gt;As you can see the row lines for BinaryInputArchive.java and LearnerHandler.java are different but I thought its related to the different versions (3.4.8 vs 3.5).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The first customer tested it with ZK 3.5.3 and it didn&apos;t reproduced!&lt;/p&gt;

&lt;p&gt;What is this new feature that was added to 3.5?&lt;/p&gt;

&lt;p&gt;I&apos;ll be happy to hear whether do you think if it&apos;s related or not.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yuval&lt;/p&gt;</comment>
                            <comment id="16389444" author="andorm" created="Wed, 7 Mar 2018 11:48:57 +0000"  >&lt;p&gt;These are 2 totally different errors I believe.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure they&apos;re not related, because the Jira is about a feature which is available from 3.5 versions only as mentioned.&lt;/p&gt;

&lt;p&gt;Would you please kindly move this discussion to ZooKeeper &apos;user&apos; mailing list and provide some more information (ensemble topology, config files, log files, step-by-step scenario, etc.)?&lt;/p&gt;</comment>
                            <comment id="16389604" author="yuvald" created="Wed, 7 Mar 2018 14:14:59 +0000"  >&lt;p&gt;Thanks Andor.&lt;/p&gt;

&lt;p&gt;Do you think it&apos;s another ZK bug or something else?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16389608" author="andorm" created="Wed, 7 Mar 2018 14:16:59 +0000"  >&lt;p&gt;Could be.&lt;/p&gt;</comment>
                            <comment id="16389619" author="yuvald" created="Wed, 7 Mar 2018 14:27:46 +0000"  >&lt;p&gt;So, in order to further investigate it, do I need to subscribe here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://zookeeper.apache.org/lists.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zookeeper.apache.org/lists.html&lt;/a&gt;&#160;?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yuval&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16389636" author="andorm" created="Wed, 7 Mar 2018 14:37:08 +0000"  >&lt;p&gt;Yes, please subscribe to &apos;users&apos; list.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13089692">ZOOKEEPER-2855</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12997163">ZOOKEEPER-2513</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12819814" name="ZOOKEEPER-2172-02.patch" size="2557" author="arshad.mohammad" created="Sun, 24 Jul 2016 06:04:01 +0000"/>
                            <attachment id="12822094" name="ZOOKEEPER-2172-03.patch" size="12024" author="arshad.mohammad" created="Thu, 4 Aug 2016 15:23:46 +0000"/>
                            <attachment id="12823593" name="ZOOKEEPER-2172-04.patch" size="12977" author="arshad.mohammad" created="Sat, 13 Aug 2016 20:17:51 +0000"/>
                            <attachment id="12823602" name="ZOOKEEPER-2172-06.patch" size="13890" author="shralex" created="Sun, 14 Aug 2016 00:38:33 +0000"/>
                            <attachment id="12823615" name="ZOOKEEPER-2172-07.patch" size="13148" author="arshad.mohammad" created="Sun, 14 Aug 2016 06:16:48 +0000"/>
                            <attachment id="12747504" name="ZOOKEEPER-2172.patch" size="680" author="mitake" created="Tue, 28 Jul 2015 06:56:35 +0000"/>
                            <attachment id="12823597" name="ZOOKEPER-2172-05.patch" size="16606" author="shralex" created="Sat, 13 Aug 2016 22:59:43 +0000"/>
                            <attachment id="12746313" name="history.txt" size="64819" author="mitake" created="Tue, 21 Jul 2015 10:07:02 +0000"/>
                            <attachment id="12726778" name="node-1.log" size="175329" author="ziyouw" created="Tue, 21 Apr 2015 04:16:19 +0000"/>
                            <attachment id="12726779" name="node-2.log" size="110773" author="ziyouw" created="Tue, 21 Apr 2015 04:16:19 +0000"/>
                            <attachment id="12726780" name="node-3.log" size="20101" author="ziyouw" created="Tue, 21 Apr 2015 04:16:19 +0000"/>
                            <attachment id="12736571" name="zoo-1.log" size="1625062" author="ziyouw" created="Mon, 1 Jun 2015 14:34:50 +0000"/>
                            <attachment id="12736729" name="zoo-2-1.log" size="1681893" author="ziyouw" created="Tue, 2 Jun 2015 04:48:24 +0000"/>
                            <attachment id="12736730" name="zoo-2-2.log" size="445019" author="ziyouw" created="Tue, 2 Jun 2015 04:48:24 +0000"/>
                            <attachment id="12736731" name="zoo-2-3.log" size="61607" author="ziyouw" created="Tue, 2 Jun 2015 04:48:24 +0000"/>
                            <attachment id="12736572" name="zoo-2.log" size="507235" author="ziyouw" created="Mon, 1 Jun 2015 14:34:50 +0000"/>
                            <attachment id="12740083" name="zoo-2212-1.log" size="4107098" author="ziyouw" created="Wed, 17 Jun 2015 10:34:58 +0000"/>
                            <attachment id="12740084" name="zoo-2212-2.log" size="3248193" author="ziyouw" created="Wed, 17 Jun 2015 10:34:58 +0000"/>
                            <attachment id="12740085" name="zoo-2212-3.log" size="122714" author="ziyouw" created="Wed, 17 Jun 2015 10:34:58 +0000"/>
                            <attachment id="12737136" name="zoo-3-1.log" size="1849645" author="ziyouw" created="Wed, 3 Jun 2015 09:25:30 +0000"/>
                            <attachment id="12737137" name="zoo-3-2.log" size="880313" author="ziyouw" created="Wed, 3 Jun 2015 09:25:30 +0000"/>
                            <attachment id="12737138" name="zoo-3-3.log" size="69558" author="ziyouw" created="Wed, 3 Jun 2015 09:25:30 +0000"/>
                            <attachment id="12736573" name="zoo-3.log" size="58292" author="ziyouw" created="Mon, 1 Jun 2015 14:34:50 +0000"/>
                            <attachment id="12741219" name="zoo-4-1.log" size="1452933" author="ziyouw" created="Tue, 23 Jun 2015 05:38:55 +0000"/>
                            <attachment id="12741220" name="zoo-4-2.log" size="450117" author="ziyouw" created="Tue, 23 Jun 2015 05:38:55 +0000"/>
                            <attachment id="12741221" name="zoo-4-3.log" size="61149" author="ziyouw" created="Tue, 23 Jun 2015 05:38:55 +0000"/>
                            <attachment id="12726781" name="zoo.cfg.dynamic.10000005d" size="181" author="ziyouw" created="Tue, 21 Apr 2015 04:16:19 +0000"/>
                            <attachment id="12726782" name="zoo.cfg.dynamic.next" size="181" author="ziyouw" created="Tue, 21 Apr 2015 04:16:19 +0000"/>
                            <attachment id="12735115" name="zookeeper-1.log" size="1376680" author="ziyouw" created="Mon, 25 May 2015 04:45:11 +0000"/>
                            <attachment id="12746314" name="zookeeper-1.out" size="51717" author="mitake" created="Tue, 21 Jul 2015 10:07:02 +0000"/>
                            <attachment id="12735116" name="zookeeper-2.log" size="259399" author="ziyouw" created="Mon, 25 May 2015 04:45:11 +0000"/>
                            <attachment id="12746315" name="zookeeper-2.out" size="33860" author="mitake" created="Tue, 21 Jul 2015 10:07:02 +0000"/>
                            <attachment id="12735117" name="zookeeper-3.log" size="63128" author="ziyouw" created="Mon, 25 May 2015 04:45:11 +0000"/>
                            <attachment id="12746316" name="zookeeper-3.out" size="60142" author="mitake" created="Tue, 21 Jul 2015 10:07:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2disv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>