<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4504] ZKUtil#deleteRecursive causing deadlock in HDFS HA functionality</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4504</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem and Analysis:&lt;/b&gt;&lt;br/&gt;
After integrating ZooKeeper 3.6.3 we observed deadlock in HDFS HA functionality as shown in below thread dumps.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main-EventThread&quot;&lt;/span&gt; #33 daemon prio=5 os_prio=0 tid=0x00007f9c017f1000 nid=0x101b waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x00007f9bda8a6000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
	at org.apache.hadoop.ha.ActiveStandbyElector.processWatchEvent(ActiveStandbyElector.java:603)
	- waiting to lock &amp;lt;0x00000000c17986c0&amp;gt; (a org.apache.hadoop.ha.ActiveStandbyElector)
	at org.apache.hadoop.ha.ActiveStandbyElector$WatcherWithClientRef.process(ActiveStandbyElector.java:1193)
	at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:626)
	at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:582)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; #1 prio=5 os_prio=0 tid=0x00007f9c00060000 nid=0xea3 waiting on condition [0x00007f9c06404000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000c1b383c8&amp;gt; (a java.util.concurrent.Semaphore$NonfairSync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:838)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:999)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1306)
	at java.util.concurrent.Semaphore.acquire(Semaphore.java:467)
	at org.apache.zookeeper.ZKUtil.deleteInBatch(ZKUtil.java:122)
	at org.apache.zookeeper.ZKUtil.deleteRecursive(ZKUtil.java:64)
	at org.apache.zookeeper.ZKUtil.deleteRecursive(ZKUtil.java:76)
	at org.apache.hadoop.ha.ActiveStandbyElector$1.run(ActiveStandbyElector.java:386)
	at org.apache.hadoop.ha.ActiveStandbyElector$1.run(ActiveStandbyElector.java:383)
	at org.apache.hadoop.ha.ActiveStandbyElector.zkDoWithRetries(ActiveStandbyElector.java:1103)
	at org.apache.hadoop.ha.ActiveStandbyElector.zkDoWithRetries(ActiveStandbyElector.java:1095)
	at org.apache.hadoop.ha.ActiveStandbyElector.clearParentZNode(ActiveStandbyElector.java:383)
	- locked &amp;lt;0x00000000c17986c0&amp;gt; (a org.apache.hadoop.ha.ActiveStandbyElector)
	at org.apache.hadoop.ha.ZKFailoverController.formatZK(ZKFailoverController.java:290)
	at org.apache.hadoop.ha.ZKFailoverController.doRun(ZKFailoverController.java:227)
	at org.apache.hadoop.ha.ZKFailoverController.access$000(ZKFailoverController.java:66)
	at org.apache.hadoop.ha.ZKFailoverController$1.run(ZKFailoverController.java:186)
	at org.apache.hadoop.ha.ZKFailoverController$1.run(ZKFailoverController.java:182)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:360)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1741)
	at org.apache.hadoop.security.SecurityUtil.doAsLoginUserOrFatal(SecurityUtil.java:498)
	at org.apache.hadoop.ha.ZKFailoverController.run(ZKFailoverController.java:182)
	at org.apache.hadoop.hdfs.tools.DFSZKFailoverController.main(DFSZKFailoverController.java:220)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;org.apache.hadoop.ha.ActiveStandbyElector#clearParentZNode is instance synchronized and calls ZKUtil.deleteRecursive(zk, pathRoot)&lt;/p&gt;

&lt;p&gt;ZKUtil.deleteRecursive is making async delete API call with MultiCallback as it callback.&lt;br/&gt;
As processWatchEvent is being processed, pathRoot or one of the child paths must have set watcher for delete notification.&lt;/p&gt;

&lt;p&gt;When delete API is called, notification comes first to client then the actual delete response.&lt;br/&gt;
In this case both notification and delete response are processed through callback and through common waitingEvents queue one by one.&lt;/p&gt;

&lt;p&gt;First notification is processed, but it cannot complete as it cannot take lock on processWatchEvent() method as lock is already taken by another thread while calling clearParentZNode()&lt;br/&gt;
As delete notification cannot be processed, MultiCallback is not taken from queue for processing. It stays there in the queue forever.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Why this problem was not happening with earlier versions (3.5.x)?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In earlier ZK versions, ZKUtil.deleteRecursive was using sync delete API. So delete response was processed directly not though the callback. &lt;br/&gt;
Sot both clearParentZNode and processWatchEvent were completing independently. &lt;/p&gt;


&lt;p&gt;&lt;b&gt;Proposed Fix:&lt;/b&gt;&lt;br/&gt;
There are two approaches to fix this problem. &lt;br/&gt;
1. We can fix the problem in HDFS, modify the HDFS code to avoid the deadlock. But we may get similar bugs in other projects.&lt;br/&gt;
2. Fix the problem in ZK. Make the API behavior same as the old behavior(use sync API to delete the ZK node) and provide new overloaded API with new behavior(use async API to delete the ZK node)&lt;/p&gt;

&lt;p&gt;I propose to fix the problem with 2nd approach.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13436389">ZOOKEEPER-4504</key>
            <summary>ZKUtil#deleteRecursive causing deadlock in HDFS HA functionality</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arshad.mohammad">Mohammad Arshad</assignee>
                                    <reporter username="arshad.mohammad">Mohammad Arshad</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 29 Mar 2022 10:01:19 +0000</created>
                <updated>Mon, 30 Jan 2023 07:57:07 +0000</updated>
                            <resolved>Wed, 6 Apr 2022 08:29:56 +0000</resolved>
                                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.6.4</fixVersion>
                    <fixVersion>3.9.0</fixVersion>
                    <fixVersion>3.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17514000" author="eolivelli" created="Tue, 29 Mar 2022 11:01:18 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2. Fix the problem in ZK. Make the API behavior same as the old behavior(use sync API to delete the ZK node) and provide new overloaded API with new behavior(use async API to delete the ZK node)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Makes sense to me.&lt;/p&gt;

&lt;p&gt;We should then cut a release, it looks like a bad regression&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17514001" author="eolivelli" created="Tue, 29 Mar 2022 11:02:42 +0000"  >&lt;p&gt;are you sure that the problem is not about the fact that we have this semaphore ?&#160;&lt;br/&gt;
java.util.concurrent.Semaphore.acquire(Semaphore.java:467)&lt;br/&gt;
probably the number of permits is too low&lt;/p&gt;</comment>
                            <comment id="17514033" author="arshad.mohammad" created="Tue, 29 Mar 2022 11:39:02 +0000"  >&lt;p&gt;yes, I am sure problem is not because of low value of rateLimit. If it was because of low concurrency, call would have taken bit longer but not stuck forever. Also the call was not deleting a lot of znode, so there was no need to submit multiple batches, one batch was sufficient. &lt;/p&gt;</comment>
                            <comment id="17514146" author="ctubbsii" created="Tue, 29 Mar 2022 15:06:51 +0000"  >&lt;p&gt;I agree the behavior should be fixed (option 2), but before creating the async API, it would be good to ensure it isn&apos;t vulnerable to the same deadlock. Can an async version be created that avoids the deadlock? It&apos;s not clear from the discussion above what the actual cause was.&lt;/p&gt;

&lt;p&gt;The above description of the issue implied that a fix could be applied to HDFS to avoid the issue there (option 1). If there is a known workaround with the existing buggy version, it would be great to document that here, for anybody using the existing version.&lt;/p&gt;</comment>
                            <comment id="17514194" author="arshad.mohammad" created="Tue, 29 Mar 2022 16:57:52 +0000"  >&lt;p&gt;There is no need to create new sync or asyc API. There was already one attempt in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3763&quot; title=&quot;Restore ZKUtil.deleteRecursive in order to help compatibility of applications with 3.5 and 3.6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3763&quot;&gt;&lt;del&gt;ZOOKEEPER-3763&lt;/del&gt;&lt;/a&gt; to make deleteRecursive API compatible to older version. but that patch missed changing  delete api invocation from async to sync. In this jira we can handle that part and make deleteRecursive API fully compatible with older versions&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It&apos;s not clear from the discussion above what the actual cause was.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Please refer the analysis along with the hdfs code, hope that will give better clarity on the root cause.  &lt;/p&gt;

</comment>
                            <comment id="17514196" author="ctubbsii" created="Tue, 29 Mar 2022 17:00:21 +0000"  >&lt;p&gt;&quot;Please refer the analysis along with the hdfs code, hope that will give better clarity on the root cause.&quot;&lt;/p&gt;

&lt;p&gt;Which analysis, specifically? Which hdfs code, specifically? If the root cause is known, can somebody provide a brief summary here for context? I just want to make sure to avoid the issue in my own projects.&lt;/p&gt;</comment>
                            <comment id="17514204" author="arshad.mohammad" created="Tue, 29 Mar 2022 17:10:07 +0000"  >&lt;p&gt;Analysis is put into the issue description, hdfs code org.apache.hadoop.ha.ActiveStandbyElector&lt;/p&gt;</comment>
                            <comment id="17514253" author="ctubbsii" created="Tue, 29 Mar 2022 17:55:37 +0000"  >&lt;p&gt;Okay yeah, so I&apos;ve read that, but sorry, it&apos;s still not entirely clear. From the description, it seems like this problem is either caused by a poorly written callback that synchronizes in a way it shouldn&apos;t. Or that this ZK delete function synchronizes on the callback instance when it shouldn&apos;t. I&apos;m looking for clarity, as a user of ZK, on what the right thing to do is in general, and what should be avoided in order to avoid similar problems as this bug. The code and analysis of this specific manifestation is useful for the developers to troubleshoot the problem, but it&apos;s not very helpful for a user who is just trying to understand the high level view in order to avoid encountering a similar issue. I&apos;m looking for the high level summary, so I know what to avoid as a user of the ZK API.&lt;/p&gt;</comment>
                            <comment id="17517305" author="arshad.mohammad" created="Tue, 5 Apr 2022 08:29:58 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctubbsii&quot; class=&quot;user-hover&quot; rel=&quot;ctubbsii&quot;&gt;ctubbsii&lt;/a&gt;&lt;br/&gt;
I have added few more details in description, Pls have a look.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;It seems like this problem is either caused by a poorly written callback that synchronizes in a way it shouldn&apos;t.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I observed this issue when I upgraded from zk 3.5.6 to zk 3.6.3 in my cluster, HDFS code remained same before and after upgrade. So at high level it is not an issue of poorly written callback. It is an issue of impact of changed behavior in ZKUtil.deleteRecursive API.&lt;/p&gt;

&lt;p&gt;Also please have a look on the proposed change in the PR. May be it is helpful in understanding the context &lt;/p&gt;


</comment>
                            <comment id="17517932" author="arshad.mohammad" created="Wed, 6 Apr 2022 08:29:56 +0000"  >&lt;p&gt;Issue resolved by pull request 1843&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1843&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17517933" author="arshad.mohammad" created="Wed, 6 Apr 2022 08:32:36 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eolivelli&quot; class=&quot;user-hover&quot; rel=&quot;eolivelli&quot;&gt;eolivelli&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt; for the reviews.&lt;br/&gt;
Merged to master, branch-3.8, branch-3.7 and branch-3.6&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10xbk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>