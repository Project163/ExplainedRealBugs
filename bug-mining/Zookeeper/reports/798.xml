<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:59:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2678] Large databases take a long time to regain a quorum</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2678</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;I know this is long but please here me out.&lt;/p&gt;

&lt;p&gt;I recently inherited a massive zookeeper ensemble.  The snapshot is 3.4 GB on disk.  Because of its massive size we have been running into a number of issues. There are lots of problems that we hope to fix with tuning GC etc, but the big one right now that is blocking us making a lot of progress on the rest of them is that when we lose a quorum because the leader left, for what ever reason, it can take well over 5 mins for a new quorum to be established.  So we cannot tune the leader without risking downtime.&lt;/p&gt;

&lt;p&gt;We traced down where the time was being spent and found that each server was clearing the database so it would be read back in again before leader election even started.  Then as part of the sync phase each server will write out a snapshot to checkpoint the progress it made as part of the sync.&lt;/p&gt;

&lt;p&gt;I will be putting up a patch shortly with some proposed changes in it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13038156">ZOOKEEPER-2678</key>
            <summary>Large databases take a long time to regain a quorum</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="revans2">Robert Joseph Evans</assignee>
                                    <reporter username="revans2">Robert Joseph Evans</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jan 2017 15:16:55 +0000</created>
                <updated>Thu, 19 Sep 2024 06:29:03 +0000</updated>
                            <resolved>Tue, 14 Feb 2017 18:06:12 +0000</resolved>
                                    <version>3.4.9</version>
                    <version>3.5.2</version>
                                    <fixVersion>3.4.10</fixVersion>
                    <fixVersion>3.5.3</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>13</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="15839860" author="githubbot" created="Thu, 26 Jan 2017 15:26:04 +0000"  >&lt;p&gt;GitHub user revans2 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;: Discovery and Sync can take a very long time on large DB&lt;/p&gt;

&lt;p&gt;    This patch addresses recovery time when a leader is lost on a large DB.  &lt;/p&gt;

&lt;p&gt;    It does this by not clearing the DB before leader election begins, and by avoiding taking a snapshot as part of the SYNC phase, specifically for a DIFF sync. It does this by buffering the proposals and commits just like the code currently does for proposals/commits sent after the NEWLEADER and before the UPTODATE messages. &lt;/p&gt;

&lt;p&gt;    If a SNAP is sent we cannot avoid writing out the full snapshot because there is no other way to make sure the disk DB is in sync with what is in memory.  So any edits to the edit log before a background snapshot happened could possibly be applied on top of an incorrect snapshot.&lt;/p&gt;

&lt;p&gt;    This same optimization should work for TRUNC too, but I opted not to do it for TRUNC because TRUNC is rare and TRUNC by its very nature already forces the DB to be reread after the edit logs are modified.  So it would still not be fast.&lt;/p&gt;

&lt;p&gt;    In practice this makes it so instead of taking 5+ mins for the cluster to recover from losing a leader it now takes about 3 seconds.&lt;/p&gt;

&lt;p&gt;    I am happy to port this to 3.5. if it looks good.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/revans2/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #157&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 5aa25620e0189b28d7040305272be2fda28126fb&lt;br/&gt;
Author: Robert (Bobby) Evans &amp;lt;evans@yahoo-inc.com&amp;gt;&lt;br/&gt;
Date:   2017-01-19T19:50:32Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;: Discovery and Sync can take a very long time on large DBs&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15844164" author="githubbot" created="Sat, 28 Jan 2017 19:15:34 +0000"  >&lt;p&gt;Github user fpj commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98336253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98336253&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -364,10 +367,12 @@ else if (qp.getType() == Leader.SNAP) {&lt;/p&gt;

&lt;p&gt;                 long lastQueued = 0;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// in V1.0 we take a snapshot when we get the NEWLEADER message, but in pre V1.0&lt;br/&gt;
    +            // in Zab V1.0 (ZK 3.4+) we might take a snapshot when we get the NEWLEADER message, but in pre V1.0&lt;br/&gt;
                 // we take the snapshot at the UPDATE, since V1.0 also gets the UPDATE (after the NEWLEADER)&lt;br/&gt;
                 // we need to make sure that we don&apos;t take the snapshot twice.&lt;/li&gt;
	&lt;li&gt;boolean snapshotTaken = false;&lt;br/&gt;
    +            boolean isPreZAB1_0 = true;&lt;br/&gt;
    +            //If we are not going to take the snapshot be sure the edits are not applied in memory&lt;br/&gt;
    +            boolean writeToEditLog = !snapshotNeeded;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    The changes here are using `edit` to refer to `txns`. I&apos;d rather use `txn` to be consistent across the project. Specifically here, you&apos;re using `EditLog` to refer to the `TxnLog`, please change accordingly to have it consistent across the project.&lt;/p&gt;</comment>
                            <comment id="15844165" author="githubbot" created="Sat, 28 Jan 2017 19:15:34 +0000"  >&lt;p&gt;Github user fpj commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98337403&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98337403&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -839,6 +839,13 @@ public void converseWithFollower(InputArchive ia, OutputArchive oa,&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getAcceptedEpoch());&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getCurrentEpoch());&lt;/p&gt;

&lt;p&gt;    +                    //Wait for the edits to be written out&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I need to think some more whether it makes any sense to add test cases for this. The test cases we already have probably cover this enough given that there is no real change of behavior.&lt;/p&gt;

&lt;p&gt;    This change here is necessary, though. We don&apos;t really care about time in general in our tests because we can never be sure of the timing we will get across runs and with different settings.&lt;/p&gt;</comment>
                            <comment id="15844166" author="githubbot" created="Sat, 28 Jan 2017 19:16:45 +0000"  >&lt;p&gt;Github user fpj commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the patch @revans2 . It makes sense to port this change to both 3.5 and master.&lt;/p&gt;</comment>
                            <comment id="15845251" author="githubbot" created="Mon, 30 Jan 2017 14:24:35 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98449817&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98449817&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -364,10 +367,12 @@ else if (qp.getType() == Leader.SNAP) {&lt;/p&gt;

&lt;p&gt;                 long lastQueued = 0;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// in V1.0 we take a snapshot when we get the NEWLEADER message, but in pre V1.0&lt;br/&gt;
    +            // in Zab V1.0 (ZK 3.4+) we might take a snapshot when we get the NEWLEADER message, but in pre V1.0&lt;br/&gt;
                 // we take the snapshot at the UPDATE, since V1.0 also gets the UPDATE (after the NEWLEADER)&lt;br/&gt;
                 // we need to make sure that we don&apos;t take the snapshot twice.&lt;/li&gt;
	&lt;li&gt;boolean snapshotTaken = false;&lt;br/&gt;
    +            boolean isPreZAB1_0 = true;&lt;br/&gt;
    +            //If we are not going to take the snapshot be sure the edits are not applied in memory&lt;br/&gt;
    +            boolean writeToEditLog = !snapshotNeeded;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Sorry about that I am still a bit new at the internal terminology.  I will update it.&lt;/p&gt;</comment>
                            <comment id="15845252" author="githubbot" created="Mon, 30 Jan 2017 14:27:51 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fpj Thanks for the review I will update the comments and start porting it to other lines.&lt;/p&gt;</comment>
                            <comment id="15845367" author="githubbot" created="Mon, 30 Jan 2017 16:05:04 +0000"  >&lt;p&gt;GitHub user revans2 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/158&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;: Discovery and Sync can take a very long time on large DBs&lt;/p&gt;

&lt;p&gt;    This is the 3.5 version of #157 &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/revans2/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;-3.5&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/158.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/158.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #158&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f871601abaf2420c674bb78658ceeb5083b3b04f&lt;br/&gt;
Author: Robert (Bobby) Evans &amp;lt;evans@yahoo-inc.com&amp;gt;&lt;br/&gt;
Date:   2017-01-19T19:50:32Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;: Discovery and Sync can take a very long time on large DBs&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15845368" author="githubbot" created="Mon, 30 Jan 2017 16:05:23 +0000"  >&lt;p&gt;GitHub user revans2 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;: Discovery and Sync can take a very long time on large DBs&lt;/p&gt;

&lt;p&gt;    This is the master version of #157 &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/revans2/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/revans2/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;-master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #159&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="15845373" author="githubbot" created="Mon, 30 Jan 2017 16:07:47 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @fpj I addressed your review comments, and I also found another race in the ZAB test that I addressed.  Apparently the log line I removed was taking enough time for the transactions to be fully flushed.  When I removed it the test would occasionally fail.&lt;/p&gt;

&lt;p&gt;    Please also take a look at #158 and #159 for master and branch 3.5.&lt;/p&gt;</comment>
                            <comment id="15845401" author="hadoopqa" created="Mon, 30 Jan 2017 16:27:18 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/265//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/265//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/265//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/265//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/265//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/265//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15845464" author="githubbot" created="Mon, 30 Jan 2017 16:58:49 +0000"  >&lt;p&gt;Github user eribeiro commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hey @revans2, FYI. I was able to apply the both #158 and #159 without any explicit conflict on `branch-3.5` and `master` and #157 on branch-3.4 (but not on the others cited previously). So... *&lt;b&gt;you really don&apos;t need 3 PR, just 2: one for branch-3.4 and other for `branch-3.5` and `master`&lt;/b&gt;*, right?&lt;/p&gt;

&lt;p&gt;    If I am right then putting a comment to apply #158 to both branch-3.4 and master should be enough, *&lt;b&gt;IMHO&lt;/b&gt;*.&lt;/p&gt;</comment>
                            <comment id="15845632" author="githubbot" created="Mon, 30 Jan 2017 18:31:06 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @eribeiro will do.  It is a clean cherry pick between master and 3.5&lt;/p&gt;</comment>
                            <comment id="15845634" author="githubbot" created="Mon, 30 Jan 2017 18:31:28 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/158&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closing this because master applies cleanly to 3.5 as well&lt;/p&gt;</comment>
                            <comment id="15845635" author="githubbot" created="Mon, 30 Jan 2017 18:31:29 +0000"  >&lt;p&gt;Github user revans2 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/158&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15845636" author="githubbot" created="Mon, 30 Jan 2017 18:32:06 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This also applies cleanly to the 3.5 line #157 is for the 3.4 line&lt;/p&gt;</comment>
                            <comment id="15846202" author="githubbot" created="Tue, 31 Jan 2017 00:24:40 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98574533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98574533&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -321,13 +321,16 @@ protected void syncWithLeader(long newLeaderZxid) throws IOException, Interrupte&lt;br/&gt;
             QuorumPacket ack = new QuorumPacket(Leader.ACK, 0, null, null);&lt;br/&gt;
             QuorumPacket qp = new QuorumPacket();&lt;br/&gt;
             long newEpoch = ZxidUtils.getEpochFromZxid(newLeaderZxid);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;readPacket(qp);&lt;br/&gt;
    +        //In the DIFF case we don&apos;t need to do a snapshot because the transactions will sync on top of any existing snapshot
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    nit: I think we generally put spaces after the //&lt;/p&gt;</comment>
                            <comment id="15846203" author="githubbot" created="Tue, 31 Jan 2017 00:24:40 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98574493&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98574493&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -839,12 +839,25 @@ public void converseWithFollower(InputArchive ia, OutputArchive oa,&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getAcceptedEpoch());&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getCurrentEpoch());&lt;/p&gt;

&lt;p&gt;    +                    //Wait for the transactions to be written out. The thread that writes them out&lt;br/&gt;
    +                    // does not send anything back when it is done.&lt;br/&gt;
    +                    long start = System.currentTimeMillis();&lt;br/&gt;
    +                    while (createSessionZxid != f.fzk.getLastProcessedZxid() &amp;amp;&amp;amp; (System.currentTimeMillis() - start) &amp;lt; 50) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    just an idea, not sure if it is worth the effort and it may be outside the scope of this patch.&lt;/p&gt;

&lt;p&gt;    we could play with the test infrastructure here a little bit and do some dependency injection in `createFollower` that can let us track if db clearing and snapshotting occurs when expected.&lt;/p&gt;

&lt;p&gt;    this may help prevent hard to track race conditions with tests like this in the future.&lt;/p&gt;</comment>
                            <comment id="15847250" author="githubbot" created="Tue, 31 Jan 2017 18:18:45 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98734336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98734336&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java &amp;#8212;&lt;br/&gt;
    @@ -507,9 +507,12 @@ public synchronized void shutdown() {&lt;br/&gt;
             if (firstProcessor != null) &lt;/p&gt;
{
                 firstProcessor.shutdown();
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (zkDb != null) 
{
    -            zkDb.clear();
    -        }
&lt;p&gt;    +&lt;br/&gt;
    +        // There is no need to clear the database&lt;br/&gt;
    +        //  * When a new quorum is established we can still apply the diff&lt;br/&gt;
    +        //    on top of the same zkDb data&lt;br/&gt;
    +        //  * If we fetch a new snapshot from leader, the zkDb will be&lt;br/&gt;
    +        //    cleared anyway before loading the snapshot&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    There is one case we may still want to clear db here - when one of the ZooKeeper critical threads (such as * processors, session trackers) fail, ZooKeeper server will shutdown (see runFromConfig) and consequently invoke ZooKeeper#shutdown. In this case, I don&apos;t see a particular reason not to clear the db, though not doing it might be fine (as one could argue the server will be dead anyway), but I tend to lean towards the safe side on cleaning the db. One way to conditionally do that is to add a Boolean parameter to ZooKeeper#shutdown so we can have fine grained control over when to clear db in what code path.&lt;/p&gt;</comment>
                            <comment id="15847325" author="githubbot" created="Tue, 31 Jan 2017 19:04:32 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r98744573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r98744573&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -839,12 +839,25 @@ public void converseWithFollower(InputArchive ia, OutputArchive oa,&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getAcceptedEpoch());&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getCurrentEpoch());&lt;/p&gt;

&lt;p&gt;    +                    //Wait for the transactions to be written out. The thread that writes them out&lt;br/&gt;
    +                    // does not send anything back when it is done.&lt;br/&gt;
    +                    long start = System.currentTimeMillis();&lt;br/&gt;
    +                    while (createSessionZxid != f.fzk.getLastProcessedZxid() &amp;amp;&amp;amp; (System.currentTimeMillis() - start) &amp;lt; 50) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It does seem a bit beyond the scope of this.  But if you really want me to I can look into it.&lt;/p&gt;</comment>
                            <comment id="15847487" author="githubbot" created="Tue, 31 Jan 2017 20:50:40 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @hanm I addressed your review comments.&lt;/p&gt;</comment>
                            <comment id="15847522" author="hadoopqa" created="Tue, 31 Jan 2017 21:10:34 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/273//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/273//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/273//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/273//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/273//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/273//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15848059" author="githubbot" created="Wed, 1 Feb 2017 06:18:12 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @revans2 the change looks good, thanks.&lt;/p&gt;</comment>
                            <comment id="15850699" author="githubbot" created="Thu, 2 Feb 2017 23:04:38 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r99242422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r99242422&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -839,12 +839,25 @@ public void converseWithFollower(InputArchive ia, OutputArchive oa,&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getAcceptedEpoch());&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getCurrentEpoch());&lt;/p&gt;

&lt;p&gt;    +                    //Wait for the transactions to be written out. The thread that writes them out&lt;br/&gt;
    +                    // does not send anything back when it is done.&lt;br/&gt;
    +                    long start = System.currentTimeMillis();&lt;br/&gt;
    +                    while (createSessionZxid != f.fzk.getLastProcessedZxid() &amp;amp;&amp;amp; (System.currentTimeMillis() - start) &amp;lt; 50) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    it would be nice, a good way of actually validating everything is behaving as expected&lt;/p&gt;</comment>
                            <comment id="15851558" author="githubbot" created="Fri, 3 Feb 2017 14:34:36 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157#discussion_r99347551&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157#discussion_r99347551&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java &amp;#8212;&lt;br/&gt;
    @@ -839,12 +839,25 @@ public void converseWithFollower(InputArchive ia, OutputArchive oa,&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getAcceptedEpoch());&lt;br/&gt;
                         Assert.assertEquals(1, f.self.getCurrentEpoch());&lt;/p&gt;

&lt;p&gt;    +                    //Wait for the transactions to be written out. The thread that writes them out&lt;br/&gt;
    +                    // does not send anything back when it is done.&lt;br/&gt;
    +                    long start = System.currentTimeMillis();&lt;br/&gt;
    +                    while (createSessionZxid != f.fzk.getLastProcessedZxid() &amp;amp;&amp;amp; (System.currentTimeMillis() - start) &amp;lt; 50) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    OK Will see what I can do&lt;/p&gt;</comment>
                            <comment id="15853129" author="githubbot" created="Sun, 5 Feb 2017 06:03:25 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Had another look at the patch, specifically the changes on Learner. Looks good to me. +1.&lt;/p&gt;</comment>
                            <comment id="15854220" author="githubbot" created="Mon, 6 Feb 2017 15:39:44 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @afine I updated the test to spy on the `LearnerZooKeeperServer` instance and check if and when `takeSnapshot` was called.  I think this fulfills your desires, but with tests there can always be more. So, if you do want more tests or other areas covered please let me know.&lt;/p&gt;</comment>
                            <comment id="15854358" author="hadoopqa" created="Mon, 6 Feb 2017 17:00:18 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/281//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/281//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/281//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/281//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/281//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/281//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15854809" author="githubbot" created="Mon, 6 Feb 2017 21:44:31 +0000"  >&lt;p&gt;Github user afine commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @revans2 &lt;/p&gt;

&lt;p&gt;    +1 lgtm&lt;/p&gt;</comment>
                            <comment id="15859658" author="githubbot" created="Thu, 9 Feb 2017 15:35:40 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Is there any more I need to do to get this merged in?&lt;/p&gt;</comment>
                            <comment id="15859992" author="githubbot" created="Thu, 9 Feb 2017 18:53:20 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @revans2 No more work is required, the patch is ready, but I am not sure if this should be included in the upcoming 3.4.10 release. If not we will wait until 3.4.10 is out to merge this into branch-3.4. @rakeshadr Do you think this should be included in 3.4.10?&lt;/p&gt;

&lt;p&gt;    The PR to master &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159/&lt;/a&gt; could be merged in, I&apos;ll have another look and merge it today.&lt;/p&gt;</comment>
                            <comment id="15860031" author="githubbot" created="Thu, 9 Feb 2017 19:25:01 +0000"  >&lt;p&gt;Github user hanm commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159#discussion_r100389617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159#discussion_r100389617&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -498,14 +504,19 @@ else if (qp.getType() == Leader.SNAP) &lt;/p&gt;
{
                                throw new Exception(&quot;changes proposed in reconfig&quot;);
                            }
&lt;p&gt;                         }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!snapshotTaken) { // true for the pre v1.0 case&lt;/li&gt;
	&lt;li&gt;zk.takeSnapshot();&lt;br/&gt;
    +                    if (isPreZAB1_0) 
{
    +                        zk.takeSnapshot();
                             self.setCurrentEpoch(newEpoch);
                         }
&lt;p&gt;                         self.setZooKeeperServer(zk);&lt;br/&gt;
                         self.adminServer.setZooKeeperServer(zk);&lt;br/&gt;
                         break outerLoop;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;case Leader.NEWLEADER: // it will be NEWLEADER in v1.0&lt;br/&gt;
    +                case Leader.NEWLEADER: // Getting NEWLEADER here instead of in discovery &lt;br/&gt;
    +                    // means this is Zab 1.0&lt;br/&gt;
    +                    // Create updatingEpoch file and remove it after current
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This comment does not apply here - my guess is it is a copy paste error from your branch-3.4 patch... can we get this comment removed?&lt;/p&gt;</comment>
                            <comment id="15861379" author="githubbot" created="Fri, 10 Feb 2017 15:05:40 +0000"  >&lt;p&gt;Github user revans2 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159#discussion_r100552192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159#discussion_r100552192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java &amp;#8212;&lt;br/&gt;
    @@ -498,14 +504,19 @@ else if (qp.getType() == Leader.SNAP) &lt;/p&gt;
{
                                throw new Exception(&quot;changes proposed in reconfig&quot;);
                            }
&lt;p&gt;                         }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!snapshotTaken) { // true for the pre v1.0 case&lt;/li&gt;
	&lt;li&gt;zk.takeSnapshot();&lt;br/&gt;
    +                    if (isPreZAB1_0) 
{
    +                        zk.takeSnapshot();
                             self.setCurrentEpoch(newEpoch);
                         }
&lt;p&gt;                         self.setZooKeeperServer(zk);&lt;br/&gt;
                         self.adminServer.setZooKeeperServer(zk);&lt;br/&gt;
                         break outerLoop;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;case Leader.NEWLEADER: // it will be NEWLEADER in v1.0&lt;br/&gt;
    +                case Leader.NEWLEADER: // Getting NEWLEADER here instead of in discovery &lt;br/&gt;
    +                    // means this is Zab 1.0&lt;br/&gt;
    +                    // Create updatingEpoch file and remove it after current
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    You are right will fix that.&lt;/p&gt;</comment>
                            <comment id="15861381" author="githubbot" created="Fri, 10 Feb 2017 15:07:34 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @hanm thanks for the reviews I removed the incorrect comment.&lt;/p&gt;</comment>
                            <comment id="15861407" author="hadoopqa" created="Fri, 10 Feb 2017 15:22:08 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/295//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/295//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/295//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/295//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/295//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/295//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15862572" author="githubbot" created="Sat, 11 Feb 2017 23:12:25 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/159&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15862574" author="hanm" created="Sat, 11 Feb 2017 23:22:48 +0000"  >&lt;p&gt;Failed tests on pre commit are not related to the pull requested. Merged to master &lt;a href=&quot;https://github.com/apache/zookeeper/commit/bbfd0169417c316bbdd22ff7a38176845aa0efc6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/bbfd0169417c316bbdd22ff7a38176845aa0efc6&lt;/a&gt;. Thanks for your patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt;!&lt;br/&gt;
JIRA not resolved due to pending request &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt; to branch-3.4.&lt;/p&gt;
</comment>
                            <comment id="15862584" author="hudson" created="Sat, 11 Feb 2017 23:36:37 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3273 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/3273/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/3273/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2678&quot; title=&quot;Large databases take a long time to regain a quorum&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2678&quot;&gt;&lt;del&gt;ZOOKEEPER-2678&lt;/del&gt;&lt;/a&gt;: Discovery and Sync can take a very long time on large (hanm: rev bbfd0169417c316bbdd22ff7a38176845aa0efc6)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Learner.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/ZooKeeperServerMain.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15863123" author="githubbot" created="Mon, 13 Feb 2017 02:26:04 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @hanm , mostly it makes sense to me as you all have done detailed code reviews and there is no open comments now. I hope the code path is thoroughly discussed/tested? I&apos;d like to freeze the code changes asap.&lt;/p&gt;</comment>
                            <comment id="15863783" author="githubbot" created="Mon, 13 Feb 2017 14:55:47 +0000"  >&lt;p&gt;Github user revans2 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rakeshadr If it makes you feel any better we have been running with an older version of this patch in production for a while.  We have used it as part of a rolling upgrade at least 10 times in production where if it were not there we would have had some very painful outages. &lt;/p&gt;

&lt;p&gt;    I have also manually tested it at least 50 times shooting the leader under load (10,000 operations/second) on a 3.4 GB DB, watching it recover, and then validating the integrity of the DB to be sure we didn&apos;t get any corruption.&lt;/p&gt;</comment>
                            <comment id="15866115" author="githubbot" created="Tue, 14 Feb 2017 16:55:01 +0000"  >&lt;p&gt;Github user rakeshadr commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @revans2 for the useful results. I spend sometime going through the changes and looks good to me. @hanm, please go ahead with merging this to branch-3.4.&lt;/p&gt;</comment>
                            <comment id="15866278" author="hanm" created="Tue, 14 Feb 2017 18:06:12 +0000"  >&lt;p&gt;Issue resolved by pull request 157&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15866283" author="hanm" created="Tue, 14 Feb 2017 18:07:42 +0000"  >&lt;p&gt;Merged to 3.4: &lt;a href=&quot;https://github.com/apache/zookeeper/commit/2de93fe450b909ff76ac8bd8fa44296a515845a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/2de93fe450b909ff76ac8bd8fa44296a515845a5&lt;/a&gt;.&lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15866743" author="revans2" created="Tue, 14 Feb 2017 21:38:10 +0000"  >&lt;p&gt;Thanks everyone.  I appreciate the great feedback and the quick turnaround time on this.&lt;/p&gt;</comment>
                            <comment id="15868105" author="rakeshr" created="Wed, 15 Feb 2017 16:13:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;, I think this is not merged into &lt;tt&gt;branch-3.5&lt;/tt&gt;. I failed to see any comments about branch-3.5 merge discussion, was that purposefully skipped?&lt;/p&gt;</comment>
                            <comment id="15868839" author="hanm" created="Thu, 16 Feb 2017 00:05:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakeshr&quot; class=&quot;user-hover&quot; rel=&quot;rakeshr&quot;&gt;rakeshr&lt;/a&gt; - yes it was deliberately skipped as I was not sure whether to put this in any releasing branch or not (that was before the discussions on whether or not we put this in 3.4.10.). Now with this in 3.4.10 I don&apos;t see why it should not be included 3.5.3. So I will merge this in 3.5. Thanks for the double check.&lt;/p&gt;

&lt;p&gt;Now merged in branch-3.5&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/commit/c164ee454cd70b3e65212ea1367ec86bb16ec022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/c164ee454cd70b3e65212ea1367ec86bb16ec022&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15971865" author="githubbot" created="Tue, 18 Apr 2017 00:04:49 +0000"  >&lt;p&gt;Github user hanm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @revans2 Please close this pull request; it&apos;s merged.&lt;/p&gt;</comment>
                            <comment id="15972691" author="githubbot" created="Tue, 18 Apr 2017 13:47:39 +0000"  >&lt;p&gt;Github user revans2 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/157&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/157&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13154018">ZOOKEEPER-3023</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13322856">ZOOKEEPER-3911</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12638243">ZOOKEEPER-1674</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13087331">ZOOKEEPER-2845</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3990v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>