<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3162] Broken lock semantics in C client lock-recipe</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3162</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;As reported (but never fixed) in the past by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2409&quot; title=&quot;zookeeper recipes lock&amp;#39;s c implement: function child_floor bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2409&quot;&gt;ZOOKEEPER-2409&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2038&quot; title=&quot;Coding error in recipes/lock/src/c/src/zoo_lock.c&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2038&quot;&gt;ZOOKEEPER-2038&lt;/a&gt; and (partly) &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2878&quot; title=&quot;some issues in c code of lock of recipes &quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2878&quot;&gt;ZOOKEEPER-2878&lt;/a&gt;, the C client lock-recipe implementation is broken.&lt;/p&gt;

&lt;p&gt;I identified three issues.&lt;/p&gt;

&lt;p&gt;The main one (as also reported in the aforementioned reports) is that the logic that goes through the lock waiting list is broken. child_floor uses strcmp and compares the full node name (i.e., sessionID-sequence) rather than only comparing the sequence number. This makes it possible for two different clients to hold the lock at the same time: assume two clients, one associated with session A, the other with session B, with A &amp;lt; B lexicographically. Now assume that at some point a thread in B holds a lock and a thread in A tries to acquire the same lock. A will manage to get the lock because of the wrong comparison function, so now two guys hold the lock.&lt;/p&gt;

&lt;p&gt;The second issue is a possible deadlock inside zkr_lock_operation. zkr_lock_operation is always called by holding the mutex associated to the client lock. In some cases, zkr_lock_operaton may decide to give-up locking and call zkr_lock_unlock to release the lock. When this happens, it will try to acquire again the same phtread mutex, which will lead to a deadlock.&lt;/p&gt;

&lt;p&gt;The third issue relates to the return value of zkr_lock_lock. According to the API docs, the functions returns 0 when no errors. Then it is up to the invoker to check when the lock is held by calling zkr_lock_isowner. However, the implementation, in case of no error, returns zkr_lock_isowner. This is wrong because it becomes impossible to distinguish an error condition from a success (but not ownerhsip). Instead the API (as described in the docs, btw) should return always 0 when no errors occur.&lt;/p&gt;

&lt;p&gt;Shortly I will add the link to a PR fixing the issues.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13190396">ZOOKEEPER-3162</key>
            <summary>Broken lock semantics in C client lock-recipe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrea.reale">Andrea Reale</assignee>
                                    <reporter username="andrea.reale">Andrea Reale</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 9 Oct 2018 15:18:00 +0000</created>
                <updated>Tue, 2 Apr 2019 10:40:10 +0000</updated>
                            <resolved>Mon, 12 Nov 2018 22:21:18 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.4.13</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.5</fixVersion>
                    <fixVersion>3.4.14</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="16679192" author="hudson" created="Thu, 8 Nov 2018 02:22:22 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #99 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/99/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/99/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3162&quot; title=&quot;Broken lock semantics in C client lock-recipe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3162&quot;&gt;&lt;del&gt;ZOOKEEPER-3162&lt;/del&gt;&lt;/a&gt;: Broken lock semantics in C client lock-recipe. (andor: rev 477fa0724fa66cc41d14e8a974ab4ac2a1b68433)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/src/main/c/tests/TestClient.cc&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/src/main/c/src/zoo_lock.c&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-queue/build.xml&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/build.xml&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/src/main/c/configure.ac&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-queue/src/main/c/configure.ac&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16679247" author="hudson" created="Thu, 8 Nov 2018 03:18:12 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #261 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/261/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/261/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3162&quot; title=&quot;Broken lock semantics in C client lock-recipe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3162&quot;&gt;&lt;del&gt;ZOOKEEPER-3162&lt;/del&gt;&lt;/a&gt;: Broken lock semantics in C client lock-recipe. (andor: rev 477fa0724fa66cc41d14e8a974ab4ac2a1b68433)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-queue/src/main/c/configure.ac&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/src/main/c/src/zoo_lock.c&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/build.xml&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/src/main/c/configure.ac&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-lock/src/main/c/tests/TestClient.cc&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-recipes/zookeeper-recipes-queue/build.xml&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16684435" author="andorm" created="Mon, 12 Nov 2018 22:21:18 +0000"  >&lt;p&gt;Issue resolved by pull request 699&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/699&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yztr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>