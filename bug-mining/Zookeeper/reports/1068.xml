<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4247] NPE while processing message from restarted quorum member</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4247</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;While upgrading K8S cluster, container running Zookeeper (during serving it&apos;s client) will rollover one by one.&lt;br/&gt;
 During this rollover, &lt;ins&gt;Null Pointer Exception&lt;/ins&gt; was observed as below.&lt;br/&gt;
 After updating to the latest Zookeeper 3.6.2 we still see the problem.&lt;br/&gt;
 This is happening on a fresh install (and has all the time).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Stack-trace&lt;/b&gt;&lt;b&gt;:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;from zk-pod-0-log&amp;gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-02-08T12:42:08.229+0000 [myid:] - ERROR [nioEventLoopGroup-4-1:NettyServerCnxnFactory$CnxnChannelHandler@329] - Unexpected exception in receive
 java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.zookeeper.server.NettyServerCnxn.receiveMessage(NettyServerCnxn.java:518) ~[zookeeper-3.6.2.jar:3.6.2]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.zookeeper.server.NettyServerCnxn.processMessage(NettyServerCnxn.java:368) ~[zookeeper-3.6.2.jar:3.6.2]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.channelRead(NettyServerCnxnFactory.java:326) [zookeeper-3.6.2.jar:3.6.2]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:163) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:714) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:650) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:576) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493) [netty-transport-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989) [netty-common-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) [netty-common-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-common-4.1.50.Final.jar:4.1.50.Final]
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834) [?:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expectation:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This scenario should be handled and Zookeeper should not print Null Pointer Exception in logs when peer member goes down as a part of the upgrade procedure.&#160;&lt;/p&gt;

&lt;p&gt;We are kindly requesting Apache Zookeeper team to fix this issue.&lt;/p&gt;</description>
                <environment>&lt;p&gt;K8S&lt;/p&gt;</environment>
        <key id="13364060">ZOOKEEPER-4247</key>
            <summary>NPE while processing message from restarted quorum member</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="symat">Mate Szalay-Beko</assignee>
                                    <reporter username="TheDevarshiShah">Devarshi Shah</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 12 Mar 2021 08:49:46 +0000</created>
                <updated>Mon, 9 Oct 2023 11:20:55 +0000</updated>
                            <resolved>Wed, 14 Apr 2021 16:56:11 +0000</resolved>
                                    <version>3.6.2</version>
                                    <fixVersion>3.8.0</fixVersion>
                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.6.4</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17300166" author="symat" created="Fri, 12 Mar 2021 09:13:26 +0000"  >&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheDevarshiShah&quot; class=&quot;user-hover&quot; rel=&quot;TheDevarshiShah&quot;&gt;TheDevarshiShah&lt;/a&gt; for reporting the issue!&lt;/p&gt;

&lt;p&gt;looks like the server is trying to process an incomming message before the zkServer object would be initialized.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/803c7f1a12f85978cb049af5e4ef23bd8b688715/zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java#L518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/803c7f1a12f85978cb049af5e4ef23bd8b688715/zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java#L518&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Before this line, I think we should check if zkServer is null. If it is null, then we should either&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ignore the message&lt;/li&gt;
	&lt;li&gt;or throw an IOException + close the connection&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not sure which of the above solution is the better. Whoever is doing this fix, she/he should think this through and also write some tests (which can be tricky, as this can be some race condition triggered for some reason in kubernetes).&lt;/p&gt;

&lt;p&gt;Unfortunately I don&apos;t have free cycles at the moment, but I hope someone else has.&lt;/p&gt;</comment>
                            <comment id="17300343" author="thedevarshishah" created="Fri, 12 Mar 2021 14:22:01 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;,&lt;/p&gt;


&lt;p&gt;Thanks for your valuable explanation!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For the fixes you suggests:&lt;br/&gt;
 1. &lt;ins&gt;Ignoring the message&lt;/ins&gt;:&lt;/p&gt;

&lt;p&gt;We do not want to see such exceptions in logs because this is just a standard upgrade procedure we are following.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2. &lt;ins&gt;Throw IOException + Close Connection&lt;/ins&gt;:&lt;/p&gt;

&lt;p&gt;On/after this fix from Apache Zookeeper, we assume and hope that it&apos;ll not print such exception in the logs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3. &lt;ins&gt;Race Condition can be triggered in Kubernetes&lt;/ins&gt;:&lt;/p&gt;

&lt;p&gt;We are running a standard container using linux OS and we have just copied Zookeeper&apos;s tar.gz and running Zookeeper as &lt;em&gt;start-foreground&lt;/em&gt; option. During upgrade, kubernetes sends the termination signal and as part of that termination signal, the process goes down.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks &amp;amp; Regards,&lt;/p&gt;

&lt;p&gt;Devarshi Shah&lt;/p&gt;</comment>
                            <comment id="17300358" author="symat" created="Fri, 12 Mar 2021 14:47:19 +0000"  >&lt;p&gt;sorry, what I wrote was misleading...&#160; by &quot;Ignoring the message&quot; I didn&apos;t mean you should ignore the exception in the logs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I meant that ignoring the RPC message we process in the code and not printing any exception. So in the code, if zkServer==null, then simply not calling the &quot;zkServer.checkRequestSizeWhenReceivingMessage(len);&quot; method (which throws the exception now).&#160;&lt;/p&gt;</comment>
                            <comment id="17309209" author="thedevarshishah" created="Fri, 26 Mar 2021 06:55:39 +0000"  >&lt;p&gt;Hi Team,&#160;&lt;/p&gt;



&lt;p&gt;Is there any update on this issue? Can we get more insight / work around regarding the issue? Is Apache Zookeeper planning to fix the issue in next version?&lt;/p&gt;

&lt;p&gt;&lt;em&gt;(Thank you&lt;/em&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;&lt;em&gt;for your explanation!)&lt;/em&gt;&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;Thanks &amp;amp; Regards,&lt;br/&gt;
Devarshi&lt;/p&gt;</comment>
                            <comment id="17314677" author="thedevarshishah" created="Mon, 5 Apr 2021 06:05:06 +0000"  >&lt;p&gt;Hi Team,&#160;&lt;/p&gt;


&lt;p&gt;Is there any update on this issue? Can we get more insight / work around regarding the issue? Is Apache Zookeeper planning to fix the issue in next version?&lt;br/&gt;
&#160;&lt;/p&gt;

&lt;p&gt;Thanks &amp;amp; Regards,&lt;br/&gt;
Devarshi&lt;/p&gt;</comment>
                            <comment id="17316895" author="thedevarshishah" created="Thu, 8 Apr 2021 06:39:36 +0000"  >&lt;p&gt;Hi Team,&lt;br/&gt;
&#160;&lt;br/&gt;
 As per the Apache Zookeeper official website, the latest version 3.7.0 is released. Does this release version resolved the issue ?&lt;br/&gt;
&#160;&lt;br/&gt;
Thanks &amp;amp; Regards,&lt;br/&gt;
 Devarshi&lt;/p&gt;</comment>
                            <comment id="17316896" author="thedevarshishah" created="Thu, 8 Apr 2021 06:40:46 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;,&lt;br/&gt;
&#160;&lt;br/&gt;
It will be very helpful if you have free cycle.&lt;br/&gt;
&#160;&lt;br/&gt;
Thanks &amp;amp; Regards,&lt;br/&gt;
Devarshi&lt;/p&gt;</comment>
                            <comment id="17319047" author="thedevarshishah" created="Mon, 12 Apr 2021 06:10:01 +0000"  >&lt;p&gt;Hi Team,&lt;br/&gt;
&#160;&lt;br/&gt;
As per the Apache Zookeeper official website, the latest version 3.7.0 is released. Does this release version resolved the issue ?&lt;br/&gt;
&#160;&lt;br/&gt;
(&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;if you have free cycle, it will be very helpful.)&lt;br/&gt;
&#160;&lt;br/&gt;
Thanks &amp;amp; Regards,&lt;br/&gt;
Devarshi&lt;/p&gt;</comment>
                            <comment id="17319051" author="symat" created="Mon, 12 Apr 2021 06:21:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=TheDevarshiShah&quot; class=&quot;user-hover&quot; rel=&quot;TheDevarshiShah&quot;&gt;TheDevarshiShah&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I try to fix it during this week.&lt;/p&gt;</comment>
                            <comment id="17324732" author="thedevarshishah" created="Mon, 19 Apr 2021 06:37:51 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;/ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arshad.mohammad&quot; class=&quot;user-hover&quot; rel=&quot;arshad.mohammad&quot;&gt;arshad.mohammad&lt;/a&gt; &lt;br/&gt;
&#160;&lt;br/&gt;
May we know the estimated date when Apache Zookeeper will release the (mentioned) fix versions &lt;b&gt;3.8.0, 3.7.1, 3.6.4&lt;/b&gt; ?&lt;br/&gt;
&#160;&lt;br/&gt;
Thanks &amp;amp; Regards,&lt;br/&gt;
Devarshi&lt;/p&gt;</comment>
                            <comment id="17324814" author="symat" created="Mon, 19 Apr 2021 08:00:38 +0000"  >&lt;p&gt;I don&apos;t know about any plans for release dates... but you can try to ask this on the ZooKeeper user mail list.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0olag:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>