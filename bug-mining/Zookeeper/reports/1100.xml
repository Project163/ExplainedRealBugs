<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4537] Race between SyncThread and CommitProcessor thread</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4537</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Zookeeper server can get stuck when it has just one client and the only way it recovers is due to a socket timeout or another client commit request.&lt;/p&gt;

&lt;p&gt;Details:&lt;/p&gt;

&lt;p&gt;We have a system where a system manager app (SM) launches all the other applications based on some config criteria. &#160;When system boots up, SM connects to zookeeper and is the only client talking to zookeeper until all other apps are launched. SM does a bunch of sync create() calls to zookeeper, before it starts up all the other apps. So at this point zookeeper server has got just one connection, which is from SM. 1 out of 3 times during system startup, SM gets stuck at a random create calls and there are only two ways this gets unwedged.&lt;br/&gt;
1. The socket has to time out and we get ZOPERATIONTIMEOUT&lt;br/&gt;
2. If we start another connection to zookeeper (I used zkCli.sh to do this), this unwedges the exiting connection to SM.&lt;br/&gt;
&#160;&lt;br/&gt;
From strace I can see that there is a race between SyncThread and CommitProcessor thread.&lt;br/&gt;
&#160;&lt;br/&gt;
Sync thread&lt;br/&gt;
class CommitProcessor {&lt;br/&gt;
run() {&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; int requestsToProcess = 0;&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; boolean commitIsWaiting = false;&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; do {&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; commitIsWaiting = !committedRequests.isEmpty(); &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; we are checking if there are more messages to process here&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; requestsToProcess = queuedRequests.size();&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; // Avoid sync if we have something to do&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if (requestsToProcess == 0 &amp;amp;&amp;amp; !commitIsWaiting) {&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; // Waiting for requests to process&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; synchronized (this) {&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; while (!stopped &amp;amp;&amp;amp; requestsToProcess == 0 &amp;amp;&amp;amp; !commitIsWaiting) &lt;/p&gt;
{ &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; and acting on the information read above inside the sync block
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; wait(); &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; wait here
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; commitIsWaiting = !committedRequests.isEmpty();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; requestsToProcess = queuedRequests.size();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
Commit thread&lt;br/&gt;
&#160; &#160; public void commit(Request request) {&lt;br/&gt;
&#160; &#160; &#160; &#160; if (stopped || request == null) &lt;/p&gt;
{
&#160; &#160; &#160; &#160; &#160; &#160; return;
&#160; &#160; &#160; &#160; }
&lt;p&gt;&#160; &#160; &#160; &#160; LOG.debug(&quot;Committing request:: {}&quot;, request);&lt;br/&gt;
&#160; &#160; &#160; &#160; request.commitRecvTime = Time.currentElapsedTime();&lt;br/&gt;
&#160; &#160; &#160; &#160; ServerMetrics.getMetrics().COMMITS_QUEUED.add(1);&lt;br/&gt;
&#160; &#160; &#160; &#160; committedRequests.add(request); &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; enqueue messages here&lt;br/&gt;
&#160; &#160; &#160; &#160; wakeup();&lt;br/&gt;
&#160; &#160; }&lt;br/&gt;
&#160;&lt;br/&gt;
&#160; &#160; @SuppressFBWarnings(&quot;NN_NAKED_NOTIFY&quot;)&lt;br/&gt;
&#160; &#160; private synchronized void wakeup() &lt;/p&gt;
{ &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; wakeup call is synchronized
&#160; &#160; &#160; &#160; notifyAll();
&#160; &#160; }
&lt;p&gt;&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
Now lets consider the following scenario&lt;br/&gt;
&#160; 1. Sync thread reads commitIsWaiting and there are no commits pending.&lt;br/&gt;
&#160; 2. This thread gets scheduled out&lt;br/&gt;
&#160; 3. We got a commit request &#8211; CommitProcessor thread adds the request to committedRequests and calls wakeup&lt;br/&gt;
&#160; 4. CommitProcessor goes ahead and does a notifyAll().&lt;br/&gt;
&#160; 5. Since the sync thread has not reached the wait() yet, there is no one to wake up.&lt;br/&gt;
&#160; 6. Sync thread gets scheduled back in.&lt;br/&gt;
&#160; 7. It goes ahead and does a wait() but since there are no other connections or new commit requests no one does a wakeup(). So this thread waits here until the socket is timed out.&lt;br/&gt;
&#160; &#160; &#160;7a. Or if another commit is made where we endup calling notifyAll() which wakes up the waiting thread.&lt;br/&gt;
&#160;&lt;br/&gt;
I modified the CommitProcessor::run() like this&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; do {&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; /*&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* Since requests are placed in the queue before being sent to&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* the leader, if commitIsWaiting = true, the commit belongs to&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* the first update operation in the queuedRequests or to a&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* request from a client on another server (i.e., the order of&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;* the following two lines is important!).&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;*/&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; synchronized (this) { &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; commitIsWaiting = !committedRequests.isEmpty(); &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; moved the queue checks inside the sync block to ensure we don&#8217;t have the race condition&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; requestsToProcess = queuedRequests.size();&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; // Avoid sync if we have something to do&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if (requestsToProcess == 0 &amp;amp;&amp;amp; !commitIsWaiting) {&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; // Waiting for requests to process&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; while (!stopped &amp;amp;&amp;amp; requestsToProcess == 0 &amp;amp;&amp;amp; !commitIsWaiting) &lt;/p&gt;
{
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; wait();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; commitIsWaiting = !committedRequests.isEmpty();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; requestsToProcess = queuedRequests.size();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }&lt;br/&gt;
&#160;&lt;br/&gt;
This seems to have fixed the issue.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13443700">ZOOKEEPER-4537</key>
            <summary>Race between SyncThread and CommitProcessor thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jithingirish">Jithin Girish</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 6 May 2022 18:18:54 +0000</created>
                <updated>Mon, 30 Jan 2023 07:57:07 +0000</updated>
                            <resolved>Tue, 17 May 2022 11:46:39 +0000</resolved>
                                                    <fixVersion>3.6.4</fixVersion>
                    <fixVersion>3.9.0</fixVersion>
                    <fixVersion>3.8.1</fixVersion>
                    <fixVersion>3.7.2</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17533904" author="symat" created="Mon, 9 May 2022 16:41:23 +0000"  >&lt;p&gt;nice catch!&lt;/p&gt;

&lt;p&gt;Thank you for reporting this issue and thanks for your investigation!&lt;/p&gt;

&lt;p&gt;Which ZooKeeper version did you face this issue?&lt;/p&gt;

&lt;p&gt;(I only had a quick look on the code, but I think this bug is present even on the current master branch)&lt;/p&gt;</comment>
                            <comment id="17533907" author="symat" created="Mon, 9 May 2022 16:46:19 +0000"  >&lt;p&gt;I think this bug might have been introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2024&quot; title=&quot;Major throughput improvement with mixed workloads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2024&quot;&gt;&lt;del&gt;ZOOKEEPER-2024&lt;/del&gt;&lt;/a&gt; (in 3.6.0)&lt;/p&gt;</comment>
                            <comment id="17533913" author="symat" created="Mon, 9 May 2022 17:05:16 +0000"  >&lt;p&gt;what do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shralex&quot; class=&quot;user-hover&quot; rel=&quot;shralex&quot;&gt;shralex&lt;/a&gt; ? I think you were working on these parts (optimizing the Commit Processor in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2024&quot; title=&quot;Major throughput improvement with mixed workloads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2024&quot;&gt;&lt;del&gt;ZOOKEEPER-2024&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I think the solution from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jithingirish&quot; class=&quot;user-hover&quot; rel=&quot;jithingirish&quot;&gt;jithingirish&lt;/a&gt; looks OK, but I am a bit afraid of the cost of synchronisation. But I&apos;m not sure if this can be avoided.&lt;/p&gt;</comment>
                            <comment id="17533955" author="shralex" created="Mon, 9 May 2022 18:34:32 +0000"  >&lt;p&gt;actually &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kfirlevari&quot; class=&quot;user-hover&quot; rel=&quot;kfirlevari&quot;&gt;kfirlevari&lt;/a&gt; was working on 2024. Kfir, can you take a look ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17533965" author="JIRAUSER289121" created="Mon, 9 May 2022 19:00:40 +0000"  >&lt;p&gt;I am using 3.6.0 but the bug exists on master branch as well. I was able to repro the issue on 3.8.0 as well.&#160;&lt;/p&gt;</comment>
                            <comment id="17533972" author="kfirlevari" created="Mon, 9 May 2022 19:13:33 +0000"  >&lt;p&gt;Nice catch Jithin!&lt;br/&gt;
Based on the code that you shared here, your solution looks right to me and should be merged in order to deal with this corner case.&#160;&lt;br/&gt;
Specifically, I don&apos;t see a reason from the correctness perspective not to call the sync before looking at the queues, given that we already doing it a few lines later. I.e., we&apos;re not introducing here a new order between sync operation and reading the queues, so I don&apos;t see why calling it earlier will danger the rest of the code, even the parts that you didn&apos;t share here.&lt;br/&gt;
I don&apos;t believe performance is an issue - but If the 1 extra sync cost in terms of performance is noticeable, I guess we can consider avoiding syncs altogether, and move to a busy-wait approach (i.e., use bounded wait instead of unbounded).&lt;/p&gt;</comment>
                            <comment id="17536720" author="symat" created="Fri, 13 May 2022 15:17:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;If the 1 extra sync cost in terms of performance is noticeable, I guess we can consider avoiding syncs altogether, and move to a busy-wait approach (i.e., use bounded wait instead of unbounded).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Hmm... I really like this approach...&lt;/p&gt;

&lt;p&gt;on the other hand, I never dug deep into this part. And changing to busy-wait approach would require (at least for me) to really follow through the life of these queues in the code. Unfortunately I don&apos;t have much time for it right now... So unless someone can spend the time, I propose to go forward with the simpler solution from &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jithingirish&quot; class=&quot;user-hover&quot; rel=&quot;jithingirish&quot;&gt;jithingirish&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jithingirish&quot; class=&quot;user-hover&quot; rel=&quot;jithingirish&quot;&gt;jithingirish&lt;/a&gt; , would you like to make a PR with your proposed fix? If you don&apos;t have the time for it, I can make one. I just don&apos;t want to take the credit from you. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17537742" author="JIRAUSER289121" created="Mon, 16 May 2022 19:17:49 +0000"  >&lt;p&gt;I will initiate a PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160; I was running a few more tests in our test deployments and the fix looks good.&lt;/p&gt;</comment>
                            <comment id="17537779" author="JIRAUSER289121" created="Mon, 16 May 2022 20:32:37 +0000"  >&lt;p&gt;I have initiated the PR&lt;/p&gt;</comment>
                            <comment id="17538127" author="symat" created="Tue, 17 May 2022 11:46:39 +0000"  >&lt;p&gt;Issue resolved by pull request 1877&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1877&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17538130" author="symat" created="Tue, 17 May 2022 11:48:25 +0000"  >&lt;p&gt;I submitted the fix to all active branches (except 3.5, where this issue is not present).&lt;/p&gt;

&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jithingirish&quot; class=&quot;user-hover&quot; rel=&quot;jithingirish&quot;&gt;jithingirish&lt;/a&gt; for raising and solving this issue!&lt;/p&gt;</comment>
                            <comment id="17538407" author="JIRAUSER289121" created="Tue, 17 May 2022 18:47:50 +0000"  >&lt;p&gt;More than happy to contribute&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z125e8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>