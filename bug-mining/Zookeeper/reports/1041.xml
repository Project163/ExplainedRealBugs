<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3426] ZK prime_connection(the Handshake) can complete without reading all the payload.</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3426</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;/* returns:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;-1 if recv call failed,&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;0 if recv would block,&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;1 if success&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; */&lt;/p&gt;

&lt;p&gt;static int recv_buffer(zhandle_t *zh, buffer_list_t *buff)&lt;/p&gt;

&lt;p&gt;{&lt;/p&gt;

&lt;p&gt;  int off = buff-&amp;gt;curr_offset;&lt;/p&gt;

&lt;p&gt;  int rc = 0;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;................&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt; if (buff == &amp;amp;zh-&amp;gt;primer_buffer &amp;amp;&amp;amp; rc == buff-&amp;gt;len - 1) ++rc; &amp;lt;====== Handshake prematurely complete.&lt;/p&gt;





&lt;p&gt;On non-blocking socket, it&apos;s possible that socket has exactly &quot;buff-&amp;gt;len - 1&quot; bytes to read.&lt;br/&gt;
Because of the above line, the Handshake is prematurely completed.&lt;br/&gt;
What this can lead to is:&lt;br/&gt;
There will be one outstanding byte left on the socket and it might go as part of next message which could get corrupted.&lt;/p&gt;

&lt;p&gt;I think this can lead to ZRUNTIMEINCONSISTENCY issues later.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13238847">ZOOKEEPER-3426</key>
            <summary>ZK prime_connection(the Handshake) can complete without reading all the payload.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ztzg">Damien Diederen</assignee>
                                    <reporter username="suhas.dantkale">Suhas Dantkale</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 11 Jun 2019 19:11:54 +0000</created>
                <updated>Sun, 28 Mar 2021 08:55:20 +0000</updated>
                            <resolved>Wed, 13 Jan 2021 08:29:16 +0000</resolved>
                                                    <fixVersion>3.7.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17260814" author="ztzg" created="Thu, 7 Jan 2021 20:48:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=suhas.dantkale&quot; class=&quot;user-hover&quot; rel=&quot;suhas.dantkale&quot;&gt;suhas.dantkale&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;That is a nasty one, indeed.  Have you actually experienced the problem, or did you just spot it in the code?  In any case, I agree with your analysis.&lt;/p&gt;

&lt;p&gt;I have a proposed fix, but I still have to figure out how to include tests.  (I will submit a &quot;pull request&quot; once I am done.)  In the meantime, here is a sneak peek:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-c&quot;&gt;
rc = zookeeper_recv(zh-&amp;gt;fd, buff-&amp;gt;buffer+off, buff-&amp;gt;len-off, 0);

/* dirty hack to make &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; client work against old server
 * old server sends 40 bytes to finish connection handshake,
 * &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; we&apos;re expecting 41 (1 byte &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; read-only mode data) */
if (rc &amp;gt; 0 &amp;amp;&amp;amp; buff == &amp;amp;zh-&amp;gt;primer_buffer) {
    &lt;span class=&quot;code-comment&quot;&gt;/* primer_buffer&apos;s curr_offset starts at 4 (see prime_connection) */&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&lt;/span&gt; avail = buff-&amp;gt;curr_offset - &lt;span class=&quot;code-keyword&quot;&gt;sizeof&lt;/span&gt;(buff-&amp;gt;len) + rc;

    &lt;span class=&quot;code-comment&quot;&gt;/* exactly 40 bytes (out of 41 expected) collected? */&lt;/span&gt;
    if (avail == buff-&amp;gt;len - 1) {
        int32_t reply_len;

        &lt;span class=&quot;code-comment&quot;&gt;/* extract length of ConnectResponse (+ 1-byte flag?) */&lt;/span&gt;
        memcpy(&amp;amp;reply_len, buff-&amp;gt;buffer, &lt;span class=&quot;code-keyword&quot;&gt;sizeof&lt;/span&gt;(reply_len));
        reply_len = ntohl(reply_len);

        &lt;span class=&quot;code-comment&quot;&gt;/* if 1-byte flag was &lt;span class=&quot;code-keyword&quot;&gt;not&lt;/span&gt; sent, fake it (value 0) */&lt;/span&gt;
        if ((&lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&lt;/span&gt;)(reply_len + &lt;span class=&quot;code-keyword&quot;&gt;sizeof&lt;/span&gt;(reply_len)) == buff-&amp;gt;len - 1) {
            ++rc;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The gist of it is:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;We look at how much data has accumulated in the buffer (as opposed to checking &lt;tt&gt;rc&lt;/tt&gt;);&lt;/li&gt;
	&lt;li&gt;If the amount is sufficient, we look at the encoded &lt;tt&gt;length&lt;/tt&gt; at offset 0.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Comments welcome!&lt;/p&gt;</comment>
                            <comment id="17263982" author="ztzg" created="Wed, 13 Jan 2021 08:29:16 +0000"  >&lt;p&gt;Issue resolved by pull request 1576&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1576&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03mso:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>