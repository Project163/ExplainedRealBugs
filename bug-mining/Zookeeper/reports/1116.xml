<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:04:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4393] Problem to connect to zookeeper in FIPS mode</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4393</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In my environment zookeeper is running in fips mode of 3 node cluster. My service is also running in fips mode with security provider org.bouncycastle.jcajce.provider.BouncyCastleFipsProvider&lt;/p&gt;

&lt;p&gt;And from the my service when I am trying to connect to zookeeper I am getting the below error.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-10-06 17:14:52,645 [nioEventLoopGroup-5-1] WARN  io.netty.channel.ChannelInitializer - opc.request.id=none - Failed to initialize a channel. Closing: [id: 0xa129ece9] -
org.apache.zookeeper.common.X509Exception$SSLContextException: java.security.KeyManagementException: FIPS mode: only SunJSSE TrustManagers may be used
	at org.apache.zookeeper.common.X509Util.createSSLContextAndOptionsFromConfig(X509Util.java:386)
	at org.apache.zookeeper.common.X509Util.createSSLContextAndOptions(X509Util.java:328)
	at org.apache.zookeeper.common.X509Util.createSSLContext(X509Util.java:256)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason is the zookeeper has its own trust manager implementation which is &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ZKTrustManager &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; X509ExtendedTrustManager
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and jdk also provide a trust manager implementation as below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
X509TrustManagerImpl &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; X509ExtendedTrustManager &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; X509TrustManager
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Because of this hierarchy in SSLContextImpl::chooseTrustManager() method the below instance check become false and hence it falls to the exception block.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (SunJSSE.isFIPS() &amp;amp;&amp;amp; !(var1[var2] &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; X509TrustManagerImpl)) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KeyManagementException(&lt;span class=&quot;code-quote&quot;&gt;&quot;FIPS mode: only SunJSSE TrustManagers may be used&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13405604">ZOOKEEPER-4393</key>
            <summary>Problem to connect to zookeeper in FIPS mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andor">Andor Molnar</assignee>
                                    <reporter username="edipesh19">Dipesh Kumar Dutta</reporter>
                        <labels>
                            <label>FIPS</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 8 Oct 2021 11:17:25 +0000</created>
                <updated>Sun, 24 Nov 2024 15:50:10 +0000</updated>
                            <resolved>Thu, 15 Jun 2023 12:13:36 +0000</resolved>
                                    <version>3.6.3</version>
                                    <fixVersion>3.9.0</fixVersion>
                    <fixVersion>3.8.2</fixVersion>
                                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17426972" author="symat" created="Mon, 11 Oct 2021 06:52:07 +0000"  >&lt;p&gt;just after a few glances, looks like we are using the custom trust manager to perform some extra host verification:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * A custom TrustManager that supports hostname verification via org.apache.http.conn.ssl.DefaultHostnameVerifier.
 *
 * We attempt to perform verification using just the IP address first and &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; that fails will attempt to perform a
 * reverse DNS lookup and verify using the hostname.
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ZKTrustManager &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; X509ExtendedTrustManager {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think we could make the trust manager class configurable and add multiple trust managers. E.g.:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;having the current ZKTrustManager&lt;/li&gt;
	&lt;li&gt;having a new trust manager that extends X509TrustManagerImpl and adds the host verification&lt;/li&gt;
	&lt;li&gt;having SunJSSE default X509TrustManagerImpl&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17427480" author="edipesh19" created="Tue, 12 Oct 2021 06:48:06 +0000"  >&lt;p&gt;Extending X509TrustManagerImpl is not possible as this is a final class.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One way for Zookeeper to do this &quot;extra validation&quot; will be to use AOP &quot;afterMethod&quot; interceptor or use Java java.lang.reflect.Proxy class.&lt;/p&gt;</comment>
                            <comment id="17428121" author="symat" created="Wed, 13 Oct 2021 09:57:27 +0000"  >&lt;p&gt;true...&lt;br/&gt;
sorry, I wanted, but it looks I won&apos;t have time to work on this in the next week. Open for anyone to pick it up. &lt;br/&gt;
(I&apos;ll also ask around in my team if someone can do it)&lt;/p&gt;</comment>
                            <comment id="17479220" author="JIRAUSER283921" created="Thu, 20 Jan 2022 09:42:52 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Any updates on this issue. Even I am facing the same issue while using bc-fips jar in FIPS mode with Kafka and zookeeper.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please let me know, if there is a workaround available for this issue.&lt;/p&gt;</comment>
                            <comment id="17480806" author="edipesh19" created="Mon, 24 Jan 2022 03:24:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nilendra_jain&quot; class=&quot;user-hover&quot; rel=&quot;nilendra_jain&quot;&gt;nilendra_jain&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;If you do not want to use ZKTrustManager you can replace the below line with return tm; in &lt;a href=&quot;https://github.com/apache/zookeeper/pull/1780/files#diff-fac34f7da2a9463c894ab6758e3f316c2acc513c3666c0e8fc66cc2e1613abcc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;X509Util.java.&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZKTrustManager((X509ExtendedTrustManager) tm, serverHostnameVerificationEnabled, clientHostnameVerificationEnabled);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17527704" author="JIRAUSER284104" created="Mon, 25 Apr 2022 18:29:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt;, I checked out your PR and noticed it fails a bunch of unit tests. Do you have an update that fixes those or adds a unit test showing this fix working?&lt;/p&gt;</comment>
                            <comment id="17712394" author="andorm" created="Fri, 14 Apr 2023 13:44:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt; Since you abandoned the ticket and the PR for a while, let me take this over and introduce a different approach.&lt;/p&gt;

&lt;p&gt;I&apos;m going to introduce a new ZooKeeper variable &lt;tt&gt;fips_mode&lt;/tt&gt; which will be off by default and if turned on, we&apos;ll use the built-in TrustManager without our extra validations. I believe this is the intention of FIPS mode and the Sun check cited in the description.&lt;/p&gt;

&lt;p&gt;Will create a new PR soon.&lt;/p&gt;</comment>
                            <comment id="17712428" author="andorm" created="Fri, 14 Apr 2023 14:54:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nilendra_jain&quot; class=&quot;user-hover&quot; rel=&quot;nilendra_jain&quot;&gt;nilendra_jain&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;How do you run ZooKeeper in FIPS-mode? (which triggers the error)&lt;/p&gt;</comment>
                            <comment id="17712449" author="symat" created="Fri, 14 Apr 2023 15:57:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;How do you run ZooKeeper in FIPS-mode? (which triggers the error)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;good question... I only tried it on proprietary distributions / ZooKeeper versions in my previous workplace, where we had test systems and docker or AMI images already configured with fips. But I never saw this particular error message in our production environment back then. Of course, there are many security configurations and it is likely that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt; used a more strict one than what we had. Dipesh, can you maybe share your security configs, if it is not sensitive?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Btw, it would be nice to make a fips compliant docker image for zookeeper testing. If it is possible... Or just give some pointers in the ZooKeeper documentation.&lt;/p&gt;</comment>
                            <comment id="17718949" author="andorm" created="Wed, 3 May 2023 14:29:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I was trying to reproduce this issue in-house on a FIPS-enabled cluster with ZooKeeper 3.5, but I don&apos;t see the error happening and exception to be thrown.&lt;/p&gt;

&lt;p&gt;Although your analysis is quite clear and I can create a patch to select between ZK&apos;s custom and Sun&apos;s built-in trustmanager. Unfortunately I don&apos;t see a way to validate it on a FIPS-cluster and make sure the error message is gone.&lt;/p&gt;</comment>
                            <comment id="17719166" author="symat" created="Thu, 4 May 2023 06:24:20 +0000"  >&lt;p&gt;Strange...&lt;/p&gt;

&lt;p&gt;if this code is executed&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (SunJSSE.isFIPS() &amp;amp;&amp;amp; !(var1[var2] &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; X509TrustManagerImpl)) { &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KeyManagementException(&lt;span class=&quot;code-quote&quot;&gt;&quot;FIPS mode: only SunJSSE TrustManagers may be used&quot;&lt;/span&gt;);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and we can not reproduce the issue, then it means that `SunJSSE.isFIPS()` is false in our tests, while for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt; it is true. I wonder why...&#160;&lt;/p&gt;

&lt;p&gt;btw, SunJSSE.isFIPS is set true here: &lt;a href=&quot;https://github.com/frohoff/jdk8u-dev-jdk/blob/da0da73ab82ed714dc5be94acd2f0d00fbdfe2e9/src/share/classes/sun/security/ssl/SunJSSE.java#L117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/frohoff/jdk8u-dev-jdk/blob/master/src/share/classes/sun/security/ssl/SunJSSE.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I wonder where this SunJSSE class is instantiated. Because it is called with different constructor in your case than in our tests. (or maybe in our case, it is not even set... isFIPS is checking a static Boolean and returns null when uninitialized)&lt;/p&gt;

&lt;p&gt;Maybe it would be good to see the whole stack-trace, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edipesh19&quot; class=&quot;user-hover&quot; rel=&quot;edipesh19&quot;&gt;edipesh19&lt;/a&gt; , could you share it? I see the last exception in ZK is thrown at this line: &lt;a href=&quot;https://github.com/apache/zookeeper/blob/6401e4ad2087061bc6b9f80dec2d69f2e3c8660a/zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java#L386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/6401e4ad2087061bc6b9f80dec2d69f2e3c8660a/zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java#L386&lt;/a&gt; - but it would be good to see the whole &quot;caused by&quot; chain. Maybe SunJSSE class is instantiated somewhere around that chain? I am really not familiar with these code parts.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vok0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>