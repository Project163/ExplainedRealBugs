<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3104] Potential data inconsistency due to NEWLEADER packet being sent too early during SNAP sync</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3104</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;Currently, in SNAP sync, the leader will start queuing the proposal/commits and the NEWLEADER packet before sending over the snapshot over wire. So it&apos;s possible that the zxid associated with the snapshot might be higher than all the packets queued before NEWLEADER.&lt;br/&gt;
&#160;&lt;br/&gt;
When the follower received the snapshot, it will apply all the txns queued before NEWLEADER, which may not cover all the txns up to the zxid in the snapshot. After that, it will write the snapshot out to disk with the zxid associated with the snapshot. In case the server crashed after writing this out, when loading the data from disk, it will use zxid of the snapshot file to sync with leader, and it could cause data inconsistent, because we only replayed partial of the historical data during previous syncing.&lt;br/&gt;
&#160;&lt;br/&gt;
NEWLEADER packet means the learner now has the correct and almost up to data state as leader, so it makes more sense to move the NEWLEADER packet after sending over snapshot, and this is what we did in the fix.&lt;br/&gt;
&#160;&lt;br/&gt;
Besides this, the socket timeout is changed to use smaller sync timeout after received NEWLEADER ack, in high write traffic ensembles with large snapshot, the follower might be timed out by leader before finishing sending over those queued txns after writing snapshot out, which could cause the follower staying in syncing state forever. Move the NEWLEADER packet after sending over snapshot can avoid this issue as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13174407">ZOOKEEPER-3104</key>
            <summary>Potential data inconsistency due to NEWLEADER packet being sent too early during SNAP sync</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lvfangmin">Fangmin Lv</assignee>
                                    <reporter username="lvfangmin">Fangmin Lv</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 25 Jul 2018 16:27:32 +0000</created>
                <updated>Mon, 9 Dec 2019 21:24:41 +0000</updated>
                            <resolved>Fri, 3 Aug 2018 16:53:19 +0000</resolved>
                                    <version>3.5.4</version>
                    <version>3.6.0</version>
                    <version>3.4.13</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.5</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="16568470" author="breed" created="Fri, 3 Aug 2018 16:53:19 +0000"  >&lt;p&gt;Issue resolved by pull request 583&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/583&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/583&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16568533" author="hudson" created="Fri, 3 Aug 2018 17:46:57 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #133 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/133/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/133/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3104&quot; title=&quot;Potential data inconsistency due to NEWLEADER packet being sent too early during SNAP sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3104&quot;&gt;&lt;del&gt;ZOOKEEPER-3104&lt;/del&gt;&lt;/a&gt;: Fix data inconsistency due to NEWLEADER being sent too (breed: rev 148c2cd6ba73e66b1879a2e10ecda4ce4e0e2c7b)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/quorum/Leader.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16576482" author="andorm" created="Fri, 10 Aug 2018 15:57:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=breed&quot; class=&quot;user-hover&quot; rel=&quot;breed&quot;&gt;breed&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Given that this is a critical bug in 3.4 and 3.5 why have you committed to trunk only?&lt;/p&gt;</comment>
                            <comment id="16577297" author="lvfangmin" created="Sat, 11 Aug 2018 19:38:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt;&#160;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=breed&quot; class=&quot;user-hover&quot; rel=&quot;breed&quot;&gt;breed&lt;/a&gt; is planning to port this to other branch as well. Ben,&#160;it should be trivial to port this from 3.6 to 3.5, let me know if it needs more effort to port to 3.4, I can send out another patch to 3.4 if it takes more effort (mostly for testing I think).&lt;/p&gt;</comment>
                            <comment id="16611777" author="andorm" created="Wed, 12 Sep 2018 08:57:45 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We don&apos;t get too many (maybe not at all) data inconsistency reports with 3.4, so I would say fixing this in 3.5 additionally would be beneficial for us.&lt;/p&gt;</comment>
                            <comment id="16956767" author="yfx416" created="Tue, 22 Oct 2019 07:27:39 +0000"  >&lt;p&gt;Actually it indeed exists in 3.4.13.&lt;/p&gt;

&lt;p&gt;In our 3.4.13 cluster, the data&#160;inconsistency happens often.&lt;/p&gt;

&lt;p&gt;After dig some txn logs and snapshot, I think&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3104&quot; title=&quot;Potential data inconsistency due to NEWLEADER packet being sent too early during SNAP sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3104&quot;&gt;&lt;del&gt;ZOOKEEPER-3104&lt;/del&gt;&lt;/a&gt; indeed contributes our data inconsistency in our product environment.&lt;/p&gt;

&lt;p&gt;We already backport it in our internal fork.&#160; I will open another issue for 3.4-branch and contribute our patch.&lt;/p&gt;

&lt;p&gt;Hope someone can help review the backport&lt;/p&gt;</comment>
                            <comment id="16968874" author="mirg" created="Thu, 7 Nov 2019 02:47:28 +0000"  >&lt;p&gt;We are using zk 3.5.5, and seem to have run twice into potential fallout from the fix itself.&lt;/p&gt;

&lt;p&gt;If the leader crashes after sending a SNAP sync to a learner, but before sending the NEWLEADER message, the learner will not save the snapshot to disk. But it will advance its lastProcessedZxid to that from the snapshot (call it Zxid X)&lt;/p&gt;

&lt;p&gt;A new leader will get elected, and it will resync our learner again immediately. But this time, it will use the incremental DIFF method, starting from Zxid X. A DIFF-based resync does not trigger snapshots, so the learner is still holding the original snapshot purely in memory. If the learner restarts after that, it will silently lose all the data up to Zxid X.&lt;/p&gt;

&lt;p&gt;An easy way to reproduce is to insert System.exit into LearnerHandler.java right before sending the NEWLEADER message (on the one instance that is currently running the leader, but not the others):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;             LOG.debug(&quot;Sending NEWLEADER message to &quot; + sid);
+            if (leader.self.getId() == 1 &amp;amp;&amp;amp; sid == 3) {
+               LOG.debug(&quot;Bail when server.1 resyncs server.3&quot;);
+               System.exit(0);
+            }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A crude fix that appears to work is to defer setting lastProcessedZxid in Learner.java until it receives NEWLEADER and decides to actually persist the snap. Could someone comment on whether this is a valid approach?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                     LOG.error(&quot;Missing signature. Got &quot; + signature);
                     throw new IOException(&quot;Missing signature&quot;);                   
                 }
-                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());
+                LOG.info(&quot;Got the snapshot, but not setting lastProcessedZxid to &quot; + qp.getZxid());
             } else if (qp.getType() == Leader.TRUNC) {
                 //we need to truncate the log to the lastzxid of the leader
                 LOG.warn(&quot;Truncating log to get in sync with the leader 0x&quot;
@@ -555,6 +555,10 @@ else if (qp.getType() == Leader.SNAP) {
                    }
 
                    if (snapshotNeeded) {
+                       LOG.info(&quot;Changing lastProcessedZxid from &quot; +
+                                zk.getZKDatabase().getDataTreeLastProcessedZxid() + &quot; to &quot; +
+                                qp.getZxid());
+                       zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());
                        zk.takeSnapshot();
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16969871" author="mirg" created="Fri, 8 Nov 2019 06:13:04 +0000"  >&lt;p&gt;&amp;gt;&#160;We are using zk 3.5.5, and seem to have run twice into potential fallout from the fix itself.&lt;/p&gt;

&lt;p&gt;Looking at it some more, the behavior we observed is not a fallout from the &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3104&quot; title=&quot;Potential data inconsistency due to NEWLEADER packet being sent too early during SNAP sync&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3104&quot;&gt;&lt;del&gt;ZOOKEEPER-3104&lt;/del&gt;&lt;/a&gt; fix. A similar problem existed even before. The NEWLEADER packet used to be added to queuedPackets before serializing the snapshot, but it was still being sent afterwards, in startSendingPackets.&lt;/p&gt;

&lt;p&gt;So crashing the leader right before startSendingPackets would achieve the same effect. The learner would receive the snapshot, but not the NEWLEADER packet. It would not persist the snapshot to disk, but still advance lastProcessedZxid. Resyncing with a new leader would then be done via Diff, and the data from the original snapshot will remain purely in memory and unprotected.&lt;/p&gt;</comment>
                            <comment id="16991921" author="apurtell" created="Mon, 9 Dec 2019 20:10:03 +0000"  >&lt;p&gt;Is there a JIRA open somewhere to address the issues mentioned at the tail of this one? &lt;/p&gt;</comment>
                            <comment id="16991951" author="mirg" created="Mon, 9 Dec 2019 21:24:41 +0000"  >&lt;p&gt;&amp;gt; Is there a JIRA open somewhere to address the issues mentioned at the tail of this one?&lt;/p&gt;

&lt;p&gt;I&apos;ve just opened &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3642&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;ZOOKEEPER-3642&lt;/a&gt; and copied that comment there, but provided a different workaround (It seems safe, but is still not the ideal way to fix it).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w9zj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>