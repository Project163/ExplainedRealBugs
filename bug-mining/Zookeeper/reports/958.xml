<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3056] Fails to load database with missing snapshot file but valid transaction log file</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3056</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://lists.apache.org/thread.html/cc17af6ef05d42318f74148f1a704f16934d1253f1472cccc1a93b4b@%3Cdev.zookeeper.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;An issue&lt;/a&gt; was reported when a user failed to upgrade from 3.4.10 to 3.5.4 with missing snapshot file.&lt;/p&gt;

&lt;p&gt;The code complains about missing snapshot file is &lt;a href=&quot;https://github.com/apache/zookeeper/blob/release-3.5.4/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which is introduced as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;With this check, ZK will not load the db without a snapshot file, even the transaction log files are present and valid. This could be a problem for restoring a ZK instance which does not have a snapshot file but have a sound state (e.g. it crashes before being able to take the first snap shot with a large snapCount parameter configured).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;how to use this fix&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Add zookeeper.snapshot.trust.empty=true to your server configuration file and start the server.&lt;/p&gt;

&lt;p&gt;This property will skip the check.&lt;/p&gt;

&lt;p&gt;It is recommended to remove the property once you have a working server, because that check is important to ensure that the system is in good shape&lt;/p&gt;</description>
                <environment></environment>
        <key id="13164196">ZOOKEEPER-3056</key>
            <summary>Fails to load database with missing snapshot file but valid transaction log file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hanm">Michael Han</assignee>
                                    <reporter username="hanm">Michael Han</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 5 Jun 2018 15:03:09 +0000</created>
                <updated>Sat, 19 Dec 2020 07:59:39 +0000</updated>
                            <resolved>Tue, 3 Sep 2019 06:54:03 +0000</resolved>
                                    <version>3.5.3</version>
                    <version>3.5.4</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.6</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>20</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="21000">5h 50m</timespent>
                                <comments>
                            <comment id="16501920" author="hanm" created="Tue, 5 Jun 2018 15:05:33 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=breed&quot; class=&quot;user-hover&quot; rel=&quot;breed&quot;&gt;breed&lt;/a&gt;&#160;who introduced the check in &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What do you guys think about this? Do you always have valid snapshot files in your deployment?&lt;/p&gt;</comment>
                            <comment id="16502527" author="sijie@apache.org" created="Tue, 5 Jun 2018 21:26:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=breed&quot; class=&quot;user-hover&quot; rel=&quot;breed&quot;&gt;breed&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Do you think it is worth reverting that change first? Or maybe put the validation in a if-else branch and controlled by a configuration setting. So people who is using 3.4.6 can turn the flag off for upgrading and turn the flag on after upgrade.&lt;/p&gt;</comment>
                            <comment id="16502830" author="hanm" created="Wed, 6 Jun 2018 05:22:22 +0000"  >&lt;p&gt;I think we just need to differentiate the state of missing snapshot vs not taking a snapshot file. To do that, we can create a signal file under the dataLogDir whenever we are taking our first snapshot. The presence of that signal file indicates there is a dependency between transaction logs and snapshot and we can&apos;t just ignore the missing snapshot file. The conditional check now checks both the presence of that signal file and the snapshot file, and it only complains if it found the signal file but not found the snapshot file. This should cover all cases include upgrade. Note this is a best effort as it&apos;s still possible to subvert the effort but I think it&apos;s fine as we don&apos;t deal with Byzantine faults.&#160;&lt;/p&gt;</comment>
                            <comment id="16506419" author="nixon" created="Fri, 8 Jun 2018 18:25:17 +0000"  >&lt;p&gt;We have not run an ensemble without some form of &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt; in years, as such we always have snapshots available and ZooKeeper being unable to load a valid snapshot is a sign that something is very wrong.&lt;/p&gt;

&lt;p&gt;From my read on the mail thread there are two questions that we&apos;re trying to answer:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;how to update ensembles without snapshots from a pre-2325 to a post-2325 state&lt;/li&gt;
	&lt;li&gt;what constitutes a stable db (and what role a snapshot plays in that)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The second ought to take more thought so I&apos;ll follow up on that after considering it.&lt;/p&gt;

&lt;p&gt;Two possible interventions on the first:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the base snapshot is very small and simple, one could copy/create a snapshot.0 file to the appropriate directory before upgrade&lt;/li&gt;
	&lt;li&gt;property gate the entire &quot;-1L == deserializeResult&quot; conditional block in 3.4, 3.5, and master to allow a snapshot-less db. To the extent that we agree that snapshot-less is a degenerate mode, we also add a 4 letter or admin command to create a snapshot on demand (allowing the admin to quickly move out of this state post-upgrade)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16506443" author="mmerli" created="Fri, 8 Jun 2018 18:46:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt; My concern is that in most cases there might not be an experienced ZK admin available, confortable in doing that operation. I would hope for a way to get a seamless migration path from 3.4 to 3.5 that doesn&apos;t require manual intervention. A flag to turn off that validation would be helpful. The risk is understood, but it would be the same behavior as in ZK-3.4.x.&lt;/p&gt;</comment>
                            <comment id="16506598" author="hanm" created="Fri, 8 Jun 2018 21:38:55 +0000"  >&lt;p&gt;I agree we should try providing a seamless upgrade path.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt; What do you think about my previous proposal on the signal file? I think it&apos;s pretty similar with the initialization marker file you introduced in ZK-261 whose presence indicate trust empty DB or not. The signal file&apos;s presence indicate trust of the transaction log alone or not (or, ignore the&#160;-1L == deserializeResult check or not).&lt;/p&gt;

&lt;p&gt;This is like an automatic flag to turn on / off the deserializeResult check by ZK itself.&lt;/p&gt;</comment>
                            <comment id="16506687" author="nixon" created="Fri, 8 Jun 2018 23:17:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmerli&quot; class=&quot;user-hover&quot; rel=&quot;mmerli&quot;&gt;mmerli&lt;/a&gt; That&apos;s a very reasonable concern and I&apos;d ideally have all upgrades be seamless in exactly the way you describe. Property gating the validation is only undesirable from a proliferation of config point of view.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; I think the signal file is a very workable approach and pretty straightforward to implement. The first intervention that I scoped out (create a snapshot.0) was inspired by yours as it simplifies the path of &quot;signal file&quot; to &quot;database load with trust in the transaction log&quot; to &quot;create snapshot, delete signal file&quot;. &amp;#8211; It&apos;s a trade-off between admin time and server side code complexity for sure.&lt;/p&gt;

&lt;p&gt;In order of decreasing seamlessness/admin time:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;property flag snapshot validation (default off)&lt;/li&gt;
	&lt;li&gt;property flag snapshot validation (default on)&lt;/li&gt;
	&lt;li&gt;signal file&lt;/li&gt;
	&lt;li&gt;admin script to create a snapshot.0 file in the snapshot directory&lt;/li&gt;
	&lt;li&gt;upgrade notes to create a snapshot.0 file in the snapshot directory&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the use cases that we maintain, it&apos;s far more likely that being unable to load a snapshot indicates corruption or machine malfeasance than a legitimate database so I&apos;d like to expand that impression with more information from the community. Is a snapshot-less db expected/unremarkable under some reasonable workloads or is it something worth (politely) discouraging? I do believe &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt; is a good feature and it would be a shame to set it off by default.&lt;/p&gt;</comment>
                            <comment id="16508441" author="breed" created="Mon, 11 Jun 2018 17:57:55 +0000"  >&lt;p&gt;how are you getting in a state where you have log file but no snapshot? is it that a machine starts up with no data and then diff syncs with the leader? or is there another case that i&apos;m missing.&lt;/p&gt;

&lt;p&gt;trying to use a txn log with no base snapshot seems frought with danger.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16508448" author="mmerli" created="Mon, 11 Jun 2018 18:04:40 +0000"  >&lt;p&gt;The main case is with ZK 3.4.x, for example with a single ZK quorum (though I think that would happen in the same way in a multi-node cluster).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;* Start ZK with 3.4.X&lt;/p&gt;

&lt;p&gt;&#160;* Create few z-nodes (not enough to trigger snapshot)&lt;/p&gt;

&lt;p&gt;&#160;* Stop ZK&lt;/p&gt;

&lt;p&gt;&#160;* Start with ZK 3.5.x --&amp;gt; Fail because snapshot is missing&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16509199" author="hanm" created="Tue, 12 Jun 2018 05:12:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s a trade-off between admin time and server side code complexity for sure.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree. If a snapshot-less use case is rare, it&apos;s better to provide an admin ool to force generate a snapshot before upgrade (or migrate data), to keep a simple server side code.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I do believe&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2325&quot; title=&quot;Data inconsistency if all snapshots empty or missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2325&quot;&gt;&lt;del&gt;ZOOKEEPER-2325&lt;/del&gt;&lt;/a&gt;is a good feature and it would be a shame to set it off by default.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree, data consistency is important and even if we decide to provide such a flag, the check should be enabled by default.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16519839" author="nixon" created="Thu, 21 Jun 2018 23:22:09 +0000"  >&lt;p&gt;As a work-around for anyone currently blocked on this issue, I&apos;ve uploaded a empty snapshot file here.&lt;/p&gt;

&lt;p&gt;To perform an upgrade (3.4 -&amp;gt; 3.5):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;download the &quot;snapshot.0&quot; file attached&lt;/li&gt;
	&lt;li&gt;copy it to the versioned directory (e.g. &quot;version-2&quot;) within your data directory (parameter &quot;dataDir&quot; in your config - this is the directory containing the &quot;myid&quot; file for a peer)&lt;/li&gt;
	&lt;li&gt;restart the peer&lt;/li&gt;
	&lt;li&gt;upgrade the peer (this can be combined with the above step if you like)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16695438" author="mkedwards" created="Thu, 22 Nov 2018 01:01:56 +0000"  >&lt;p&gt;Fix needed for 3.5.5?&lt;/p&gt;</comment>
                            <comment id="16912523" author="hanm" created="Wed, 21 Aug 2019 17:00:00 +0000"  >&lt;p&gt;Given enough people already complain about this, i am taking a stab and implementing the proposed solution to provide a seamless upgrade path.&lt;/p&gt;</comment>
                            <comment id="16916237" author="addisonj@gmail.com" created="Tue, 27 Aug 2019 00:01:31 +0000"  >&lt;p&gt;Just ran into this myself... one thing to note is that in a cloud containerized environment, such as a k8s StatefulSet, this is extra tricky for users as they probably have volumes being dynamically attached and crash back-off loops that make getting to the volume a pain. The way I was able to fix this was to add another &quot;debug&quot; container with the same volume mounted that I could then copy the empty snapshot into.&lt;/p&gt;</comment>
                            <comment id="16921200" author="eolivelli" created="Tue, 3 Sep 2019 06:55:17 +0000"  >&lt;p&gt;Committed to master branch as 68c21988d55c57e483370d3ee223c22da2d1bbcf&lt;br/&gt;
Committed to branch-3.5 branch as  77496b948f1eec3f8fa243bb8003cc97839982e4&lt;/p&gt;

&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nixon&quot; class=&quot;user-hover&quot; rel=&quot;nixon&quot;&gt;nixon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16922891" author="hudson" created="Wed, 4 Sep 2019 22:01:06 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build ZooKeeper-trunk #678 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/678/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/678/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3056&quot; title=&quot;Fails to load database with missing snapshot file but valid transaction log file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3056&quot;&gt;&lt;del&gt;ZOOKEEPER-3056&lt;/del&gt;&lt;/a&gt;: Fails to load database with missing snapshot file but (enrico.olivelli: rev 68c21988d55c57e483370d3ee223c22da2d1bbcf)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16922967" author="hudson" created="Thu, 5 Sep 2019 00:47:08 +0000"  >&lt;p&gt;ABORTED: Integrated in Jenkins build Zookeeper-trunk-single-thread #514 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/514/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/514/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3056&quot; title=&quot;Fails to load database with missing snapshot file but valid transaction log file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3056&quot;&gt;&lt;del&gt;ZOOKEEPER-3056&lt;/del&gt;&lt;/a&gt;: Fails to load database with missing snapshot file but (enrico.olivelli: rev 68c21988d55c57e483370d3ee223c22da2d1bbcf)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16973273" author="vguptadub" created="Wed, 13 Nov 2019 11:44:02 +0000"  >&lt;p&gt;Hi Sorry but I don&apos;t see the workaround is working for me. I have zookeeper running in Statefulset in Kubernetes. I followed the steps and downloaded the snapshot.0 file and copied it under my dataDir under /var/lib/zookeeper/data/version-2 and I restarted the container via `kill 1` command. and then I upgraded the zookeeper image but still I see the below logs but container is still in crash loop state. please help.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-11-13 11:38:45,320 [myid:3] - INFO&#160; [main:QuorumPeer@2183] - quorum.cnxn.threads.size set to 20
2019-11-13 11:38:45,399 [myid:3] - ERROR [main:QuorumPeer@955] - Unable to load database on disk
java.io.IOException: No snapshot found, but there are log entries. Something is broken!
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:211)
	at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:240)
	at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:919)
	at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:905)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:205)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:123)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:82)
2019-11-13 11:38:45,404 [myid:3] - ERROR [main:QuorumPeerMain@101] - Unexpected exception, exiting abnormally
java.lang.RuntimeException: Unable to run quorum server&#160;
	at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:956)
	at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:905)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:205)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:123)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:82)
Caused by: java.io.IOException: No snapshot found, but there are log entries. Something is broken!
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:211)
	at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:240)
	at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:919)
	... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16974835" author="nikifa" created="Fri, 15 Nov 2019 06:11:03 +0000"  >&lt;p&gt;Faced the same issue when upgrade from 3.4.9 to 3.5.6&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
2019-11-15 06:04:18,455 [main] ERROR QuorumPeer.java (line 955) Unable to load database on disk
java.io.IOException: No snapshot found, but there are log entries. Something is broken!
 at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:222)
 at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:240)
 at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:919)
 at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:905)
 at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:205)
 at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:123)
 at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:82)
2019-11-15 06:04:18,462 [main] ERROR QuorumPeerMain.java (line 101) Unexpected exception, exiting abnormally

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16974857" author="vguptadub" created="Fri, 15 Nov 2019 06:43:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enixon&quot; class=&quot;user-hover&quot; rel=&quot;enixon&quot;&gt;enixon&lt;/a&gt;&#160;, I tried the workaround provided by you to copy the snapshot.0 file into the container file system. and then did the rolling update of my Statefulset in Kubernetes , it didn&apos;t still load the database snapshot and gave the error.&#160;&lt;/p&gt;

&lt;p&gt;May I please request you to re-check if the steps needs to be done any differently for container filesystem or if anything is missing there. It seems to have blocked my couple of projects.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I sincerely appreciate the help !&lt;/p&gt;</comment>
                            <comment id="16974858" author="eolivelli" created="Fri, 15 Nov 2019 06:45:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nikifa&quot; class=&quot;user-hover&quot; rel=&quot;nikifa&quot;&gt;nikifa&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am sorry, we did not update the description of the issue with the &apos;solution&apos;&lt;/p&gt;

&lt;p&gt;this is the link to the fix&#160;&lt;a href=&quot;https://github.com/apache/zookeeper/commit/68c21988d55c57e483370d3ee223c22da2d1bbcf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/68c21988d55c57e483370d3ee223c22da2d1bbcf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;You have to add this configuration entry zookeeper.snapshot.trust.empty=true&#160; (it is actually a java system property, but it should work if you add it to zoo.cfg).&lt;/p&gt;

&lt;p&gt;This way the system allows such empty snapshot.&lt;/p&gt;

&lt;p&gt;Once you are able to perform the upgrade I suggest to remove the line because it is actually disabling an integrity check that we added in 3.5.x&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will update the description&lt;/p&gt;</comment>
                            <comment id="16974905" author="nikifa" created="Fri, 15 Nov 2019 07:59:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eolivelli&quot; class=&quot;user-hover&quot; rel=&quot;eolivelli&quot;&gt;eolivelli&lt;/a&gt;, &lt;br/&gt;
Awesome! Thanks for the reply.&lt;/p&gt;

&lt;p&gt;One more question. As I understand that option will help us to start zk without snapshot.&lt;br/&gt;
To automate that I can find by &quot;snapshot*&quot; in my shell script(which start zk instance) in zk data directory and set that option to &quot;true&quot; if there no snapshot files, right?&lt;/p&gt;

&lt;p&gt;I&apos;m not able to manually turn that option on/off on thousand of zk clusters. &lt;/p&gt;

&lt;p&gt;Should I force restart the instance which have that option? Which marker can I use to understand that snapshot successfully created and I can remove that option from config and restart instance?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16976234" author="hanm" created="Mon, 18 Nov 2019 02:20:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;As I understand that option will help us to start zk without snapshot.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This option is an escape hatch for users upgrading from 3.4.x (where it&apos;s possible to have zookeeper clusters in valid state without the presence of snapshot) to 3.5.6+, and it&apos;s not intended to be used to work around the data integrity checks during start up. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;To automate that I can find by &quot;snapshot*&quot; in my shell script(which start zk instance) in zk data directory and set that option to &quot;true&quot; if there no snapshot files, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This should work. My recommendation is to also at least check your zookeeper clusters before triggering this automation to make sure the missing of local snapshot files is caused by legitimate reasons (such as not enough transactions to trigger a snapshot file). If it&apos;s not legitimate - e.g. the snapshot files were missing because they were removed by mistake, then we should not proceed force restart which will compromise the data integrity of the cluster. Also please note, for 3.5.x, it should never happen that local snapshot files are missing.&lt;/p&gt;</comment>
                            <comment id="16976415" author="marvin.lillehaug" created="Mon, 18 Nov 2019 10:12:49 +0000"  >&lt;blockquote&gt;

&lt;p&gt;You have to add this configuration entry zookeeper.snapshot.trust.empty=true&#160; (it is actually a java system property, but it should work if you add it to zoo.cfg).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think this is possible to set from config. We had this problem when going from 3.4.14 to 3.5.6, and when setting this is zoo.cfg we still got the same error on startup.&lt;/p&gt;

&lt;p&gt;zookeeper.snapshot.trust.empty is read in&#160;&lt;a href=&quot;https://github.com/apache/zookeeper/blob/branch-3.5.6/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/branch-3.5.6/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So unless there is some part of Zookeeper that puts all properties in config as system properties there is no way it will take effekt from config file.&lt;/p&gt;</comment>
                            <comment id="16992535" author="tomncooper" created="Tue, 10 Dec 2019 13:27:52 +0000"  >&lt;p&gt;As Marvin states above the setting to skip the checks cannot be supplied in the config file. It has to passed as a system property, for example as part of the KAFKA_OPTS variable when running zookeeper-server-start.sh:&lt;/p&gt;

&lt;p&gt;KAFKA_OPTS=&quot;$KAFKA_OPTS -Dzookeeper.snapshot.trust.empty=true&quot;&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://cwiki.apache.org/confluence/display/ZOOKEEPER/Upgrade+FAQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade FAQ&lt;/a&gt; should be update to state this.&lt;/p&gt;</comment>
                            <comment id="16993608" author="ijuma" created="Wed, 11 Dec 2019 14:54:06 +0000"  >&lt;p&gt;The config `snapshot.trust.empty` works, I believe (note that naming is slightly different). However, it seems to cause other issues, see&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3644&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-3644&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16994032" author="hanm" created="Thu, 12 Dec 2019 01:03:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;The config `snapshot.trust.empty` works, I believe (note that naming is slightly different)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, put the option name as &lt;b&gt;snapshot.trust.empty&lt;/b&gt; (instead of &lt;b&gt;zookeeper.snapshot.trust.empty&lt;/b&gt;) in the config file should generate a java system property named &lt;b&gt;zookeeper.snapshot.trust.empty&lt;/b&gt; after ZK starts up. Though, I realized we had wrong documentation where we mentioned this is a java system property only (which it&apos;s not). i&apos;ll update doc soon.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So unless there is some part of Zookeeper that puts all properties in config as system properties&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes there actually is such code that generate java system property from (a subset of) configuration options parsed from cfg file. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3644&quot; title=&quot;Data loss after upgrading standalone ZK server 3.4.14 to 3.5.6 with snapshot.trust.empty=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3644&quot;&gt;&lt;del&gt;ZOOKEEPER-3644&lt;/del&gt;&lt;/a&gt; is a real issue, I&apos;ll follow up there.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13341268">ZOOKEEPER-4005</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13273647">ZOOKEEPER-3644</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12914273">ZOOKEEPER-2325</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13252045">ZOOKEEPER-3513</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12928686" name="snapshot.0" size="424" author="enixon" created="Thu, 21 Jun 2018 23:03:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ujan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>