<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3131] org.apache.zookeeper.server.WatchManager resource leak</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3131</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;In some cases, the variable &lt;em&gt;watch2Paths&lt;/em&gt; in &lt;em&gt;Class WatchManager&lt;/em&gt; does not remove the entry, even if the associated value &quot;HashSet&quot; is empty already.&#160;&lt;/p&gt;

&lt;p&gt;The type of key in Map &lt;em&gt;watch2Paths&lt;/em&gt;&#160;is&#160;Watcher, instance of&#160;&lt;em&gt;NettyServerCnxn.&lt;/em&gt; If it is not removed when the associated set of paths is empty, it will cause the memory increases little by little, and OutOfMemoryError triggered finally.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#FF0000&quot;&gt;&lt;b&gt;Possible Solution:&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;In the following function, the logic should be added to remove the entry.&lt;/p&gt;

&lt;p&gt;org.apache.zookeeper.server.WatchManager#removeWatcher(java.lang.String, org.apache.zookeeper.Watcher)&lt;/p&gt;

&lt;p&gt;if (paths.isEmpty())&lt;/p&gt;

{ watch2Paths.remove(watcher); }

&lt;p&gt;For the following function as well:&lt;/p&gt;

&lt;p&gt;org.apache.zookeeper.server.WatchManager#triggerWatch(java.lang.String, org.apache.zookeeper.Watcher.Event.EventType, java.util.Set&amp;lt;org.apache.zookeeper.Watcher&amp;gt;)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please confirm this issue?&lt;/p&gt;</description>
                <environment>&lt;p&gt;-Xmx512m&#160;&lt;/p&gt;</environment>
        <key id="13181545">ZOOKEEPER-3131</key>
            <summary>org.apache.zookeeper.server.WatchManager resource leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lvfangmin">Fangmin Lv</assignee>
                                    <reporter username="hw_wangchao">ChaoWang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 28 Aug 2018 08:32:41 +0000</created>
                <updated>Sun, 29 Sep 2024 12:39:41 +0000</updated>
                            <resolved>Fri, 7 Sep 2018 00:35:17 +0000</resolved>
                                    <version>3.5.3</version>
                    <version>3.5.4</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.5</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15600">4h 20m</timespent>
                                <comments>
                            <comment id="16595645" author="nixon" created="Tue, 28 Aug 2018 21:48:53 +0000"  >&lt;p&gt;I&apos;m not sure I follow what you&apos;re proposing. Do you want to put up a pull request with your suggested changes and we can discuss there?&lt;/p&gt;</comment>
                            <comment id="16597590" author="lvfangmin" created="Thu, 30 Aug 2018 15:49:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hw_wangchao&quot; class=&quot;user-hover&quot; rel=&quot;hw_wangchao&quot;&gt;hw_wangchao&lt;/a&gt;&#160;it was by&#160;design to leave it as is to improve the performance, since the watcher number is usually related with the connections on that server, and we can rely on the connection close to&#160;clean&#160;it up.&#160;&lt;/p&gt;

&lt;p&gt;The problem here is that, NettyServerCnxn didn&apos;t remove itself from ZK server as what we did in NIOServerCnxn, that&apos;s why it starts to leak slowly. I have a patch to make the behavior consistent with NIOServerCnxn, I can send it out today.&lt;/p&gt;

&lt;p&gt;There are also other features missing&#160;comparing to NIO,&#160;for example,&#160;it&apos;s missing the maximum cnxns per IP limit support, doesn&apos;t have cnxn expirer, the NettyServerCnxnFactory.closeSession is not that efficient, etc.&#160;I&apos;m recently working on get netty prod ready, I&apos;ll send out&#160;other patches as well.&lt;/p&gt;</comment>
                            <comment id="16597594" author="lvfangmin" created="Thu, 30 Aug 2018 15:53:47 +0000"  >&lt;p&gt;This one will be fixed if the ongoing optimized watch manager PR get landed: &lt;a href=&quot;https://github.com/apache/zookeeper/pull/590.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/590.&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;But that may take long time, I&apos;ll send a separate one just for this one.&lt;/p&gt;</comment>
                            <comment id="16603325" author="hadoopqa" created="Tue, 4 Sep 2018 17:01:50 +0000"  >&lt;p&gt;-1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    -1 core tests.  The patch failed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2117//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2117//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2117//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2117//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2117//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2117//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16606572" author="hanm" created="Fri, 7 Sep 2018 00:35:17 +0000"  >&lt;p&gt;Issue resolved by pull request 612&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/612&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16606636" author="hudson" created="Fri, 7 Sep 2018 02:20:19 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #180 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/180/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/180/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3131&quot; title=&quot;org.apache.zookeeper.server.WatchManager resource leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3131&quot;&gt;&lt;del&gt;ZOOKEEPER-3131&lt;/del&gt;&lt;/a&gt;: Remove watcher when session closed in NettyServerCnxn (hanm: rev 95557a30edbdfdf4479a1cb142e0d82a4ba6061d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java&lt;/li&gt;
	&lt;li&gt;(edit) src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12934664">ZOOKEEPER-2358</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12996162">ZOOKEEPER-2509</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12999635">ZOOKEEPER-2527</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12999918">ZOOKEEPER-2530</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xho7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>