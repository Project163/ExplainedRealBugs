<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:03:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4220] Potential redundant connection attempts during leader election</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4220</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We&apos;ve seen a few failures or long delays in electing a new leader when the previous one has a hard host reset (as opposed to just the service process down, since connections don&apos;t need to wait for timeout there). Symptoms are similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2164&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2164&lt;/a&gt;. Reducing cnxTimeout from 5 to 1.5 seconds makes the problem much less frequent, but doesn&apos;t fix it completely. We are still using an old ZooKeeper version (3.5.5), and the new async connect feature will presumably avoid it.&lt;/p&gt;

&lt;p&gt;But we noticed a pattern of twice the expected number of connection attempts to the same downed instance in the log, and it appears to be due to a code glitch in QuorumCnxManager.java:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void connectOne(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sid) {
    ...
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastCommittedView.containsKey(sid)) {
        knownId = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectOne(sid, lastCommittedView.get(sid).electionAddr))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastSeenQV != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; lastProposedView.containsKey(sid)
            &amp;amp;&amp;amp; (!knownId || (lastProposedView.get(sid).electionAddr !=   &amp;lt;----
            lastCommittedView.get(sid).electionAddr))) {
        knownId = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connectOne(sid, lastProposedView.get(sid).electionAddr))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Comparing electionAddrs should be done with !equals presumably, otherwise connectOne will be invoked an extra time even in the common case when the addresses do match.&lt;/p&gt;

&lt;p&gt;The code around it has changed recently, but the check itself still exists at the top of master. It might not matter as much with the async connects, but perhaps it helps even then.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13360398">ZOOKEEPER-4220</key>
            <summary>Potential redundant connection attempts during leader election</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="symat">Mate Szalay-Beko</assignee>
                                    <reporter username="mirg">Alex Mirgorodskiy</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 23 Feb 2021 18:26:32 +0000</created>
                <updated>Sun, 28 Mar 2021 08:54:13 +0000</updated>
                            <resolved>Sat, 6 Mar 2021 20:54:22 +0000</resolved>
                                    <version>3.5.9</version>
                    <version>3.6.2</version>
                                    <fixVersion>3.5.10</fixVersion>
                    <fixVersion>3.6.3</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13800">3h 50m</timespent>
                                <comments>
                            <comment id="17289791" author="symat" created="Wed, 24 Feb 2021 09:01:41 +0000"  >&lt;p&gt;Nice catch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mirg&quot; class=&quot;user-hover&quot; rel=&quot;mirg&quot;&gt;mirg&lt;/a&gt;, thank you!!&lt;/p&gt;

&lt;p&gt;This is also present on the current master branch: &lt;a href=&quot;https://github.com/apache/zookeeper/blob/37eae03080b93d63a6ba9f624b37c764511ad2dc/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/blob/37eae03080b93d63a6ba9f624b37c764511ad2dc/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L771&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Would you like to make a PR by changing this line?&lt;br/&gt;
If you don&apos;t have time just now, I&apos;m happy to fix this quickly.&lt;/p&gt;</comment>
                            <comment id="17290572" author="mirg" created="Thu, 25 Feb 2021 00:33:16 +0000"  >&lt;p&gt;Great, please go ahead &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=symat&quot; class=&quot;user-hover&quot; rel=&quot;symat&quot;&gt;symat&lt;/a&gt;! (I am not up to speed on testing and checkin procedures). But let me know if it takes much effort on your side too, I&apos;ll figure it out.&lt;/p&gt;</comment>
                            <comment id="17290876" author="symat" created="Thu, 25 Feb 2021 11:58:04 +0000"  >&lt;p&gt;Sure, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mirg&quot; class=&quot;user-hover&quot; rel=&quot;mirg&quot;&gt;mirg&lt;/a&gt;! I&apos;ll sent the PR soon&lt;/p&gt;</comment>
                            <comment id="17290898" author="symat" created="Thu, 25 Feb 2021 12:48:49 +0000"  >&lt;p&gt;Hmm... checking this code and I don&apos;t think that this bug would cause an increased number of connection attempts. It might lead to call the `connectOne` method more frequently, but in that method we are always checking if there is an open connection already for the give SID. (and there are more synchronization later in the connection initiations) But I am not 100% sure... also a lot changed since 3.5.5.&lt;/p&gt;

&lt;p&gt;Also I think this part of the code should be reached, only if dynamic reconfig is used. Are you using dynamic reconfig? Even if the quorum membership changed (using static configuration file modification), this code should not be reached. At least on the master branch. (although there was a bug in the earlier 3.5 and 3.6 versions that might affect this)&lt;/p&gt;

&lt;p&gt;Anyway, the bottom line is that this is clearly a bug, so we need to fix it. I&apos;m just not sure that it would be responsible for the high number of connection attempts you see in your logs.&lt;/p&gt;

&lt;p&gt;Update: actually if the other server is unreachable, then this &quot;!=&quot; can indeed cause that we try to connect to it twice, before giving up. I tried to explain this in the PR. (bit if the servers are online during the leader election, then this shouldn&apos;t matter)&lt;/p&gt;</comment>
                            <comment id="17290911" author="symat" created="Thu, 25 Feb 2021 13:18:51 +0000"  >&lt;p&gt;I submitted the PR: &lt;a href=&quot;https://github.com/apache/zookeeper/pull/1615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1615&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17291319" author="mirg" created="Fri, 26 Feb 2021 00:53:14 +0000"  >&lt;p&gt;Yep, this is what we are seeing. We forcibly shut down the current leader, and one of the remaining instances occasionally runs into two back-to-back timeouts (2 x 1.5s) trying to connect to the downed leader:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2020-12-13T22:46:30.997+0000 [.WorkerReceiver&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=6&amp;#93;&lt;/span&gt;] Notification: 2 (message format version), 1 (n.leader), 0x700003804 (n.zxid), 0x4 (n.round), LOOKING (n.state), 1 (n.sid), 0x7 (n.peerEPoch), FOLLOWING (my state)7000000ad (n.config version)&lt;br/&gt;
 2020-12-13T22:46:32.503+0000 [.WorkerSender&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=6&amp;#93;&lt;/span&gt;] Cannot open channel to 4 at election address /10.80.140.226:3888java.net.SocketTimeoutException: connect timed out\n\tat java.net.PlainSocketImpl.socketConnect(Native Method)\n\tat java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:345)\n\tat java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)\n\tat java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)\n\tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)\n\tat java.net.Socket.connect(Socket.java:589)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:648)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:705)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:618)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:478)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:457)\n\tat java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
 2020-12-13T22:46:34.006+0000 [.WorkerSender&lt;span class=&quot;error&quot;&gt;&amp;#91;myid=6&amp;#93;&lt;/span&gt;] Cannot open channel to 4 at election address /10.80.140.226:3888java.net.SocketTimeoutException: connect timed out\n\tat java.net.PlainSocketImpl.socketConnect(Native Method)\n\tat java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:345)\n\tat java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)\n\tat java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)\n\tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)\n\tat java.net.Socket.connect(Socket.java:589)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:648)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:712)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:618)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:478)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:457)\n\tat java.lang.Thread.run(Thread.java:745)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sometimes, this pair of connects repeats, perhaps when the remaining live instances disagree on the election round. This is when the election doesn&apos;t seem to converge.&lt;/p&gt;

&lt;p&gt;And yes, we are using dynamic reconfig (but not at the time of the crash, I believe).&lt;/p&gt;

&lt;p&gt;Thank you for making the change!&lt;/p&gt;</comment>
                            <comment id="17291487" author="symat" created="Fri, 26 Feb 2021 08:44:28 +0000"  >&lt;p&gt;Thanks for the clarification &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mirg&quot; class=&quot;user-hover&quot; rel=&quot;mirg&quot;&gt;mirg&lt;/a&gt;!&lt;br/&gt;
In this case this fix will likely improve the situation. Cool! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17296650" author="ztzg" created="Sat, 6 Mar 2021 20:54:22 +0000"  >&lt;p&gt;Issue resolved by pull request 1615&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1615&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nzco:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>