<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:01:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2778] Potential server deadlock between follower sync with leader and follower receiving external connection requests.</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2778</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;It&apos;s possible to have a deadlock during recovery phase. &lt;br/&gt;
Found this issue by analyzing thread dumps of &quot;flaky&quot; ReconfigRecoveryTest &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. . Here is a sample thread dump that illustrates the state of the execution:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit]  java.lang.Thread.State: BLOCKED
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumPeer.getElectionAddress(QuorumPeer.java:686)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumCnxManager.initiateConnection(QuorumCnxManager.java:265)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:445)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumCnxManager.receiveConnection(QuorumCnxManager.java:369)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener.run(QuorumCnxManager.java:642)
    [junit] 


    [junit]  java.lang.Thread.State: BLOCKED
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:472)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumPeer.connectNewPeers(QuorumPeer.java:1438)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumPeer.setLastSeenQuorumVerifier(QuorumPeer.java:1471)
    [junit]         at  org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:520)
    [junit]         at  org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:88)
    [junit]         at  org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1133)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The dead lock happens between the quorum peer thread which running the follower that doing sync with leader work, and the listener of the qcm of the same quorum peer that doing the receiving connection work. Basically to finish sync with leader, the follower needs to synchronize on both QV_LOCK and the qmc object it owns; while in the receiver thread to finish setup an incoming connection the thread needs to synchronize on both the qcm object the quorum peer owns, and the same QV_LOCK. It&apos;s easy to see the problem here is the order of acquiring two locks are different, thus depends on timing / actual execution order, two threads might end up acquiring one lock while holding another.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; org.apache.zookeeper.server.quorum.ReconfigRecoveryTest.testCurrentServersAreObserversInNextConfig&lt;/p&gt;</description>
                <environment></environment>
        <key id="13069641">ZOOKEEPER-2778</key>
            <summary>Potential server deadlock between follower sync with leader and follower receiving external connection requests.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mkedwards">Michael K. Edwards</assignee>
                                    <reporter username="hanm">Michael Han</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 6 May 2017 05:08:32 +0000</created>
                <updated>Fri, 4 Oct 2019 14:55:14 +0000</updated>
                            <resolved>Fri, 7 Dec 2018 12:12:08 +0000</resolved>
                                    <version>3.5.3</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>3.5.5</fixVersion>
                                    <component>quorum</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="31800">8h 50m</timespent>
                                <comments>
                            <comment id="15999303" author="githubbot" created="Sat, 6 May 2017 05:35:28 +0000"  >&lt;p&gt;Github user hanm closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/247&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15999304" author="githubbot" created="Sat, 6 May 2017 05:35:30 +0000"  >&lt;p&gt;GitHub user hanm reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/247&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2778&quot; title=&quot;Potential server deadlock between follower sync with leader and follower receiving external connection requests.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2778&quot;&gt;&lt;del&gt;ZOOKEEPER-2778&lt;/del&gt;&lt;/a&gt;: Potential server deadlock between follower sync with leader and follower receiving external connection requests.&lt;/p&gt;

&lt;p&gt;    Remove synchronization requirements on certain methods to prevent dead lock. Current analysis indicates these methods don&apos;t require synchronization for them to work properly. Patch is stress tested with 1k runs of entire unit test suites.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hanm/zookeeper&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hanm/zookeeper&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2778&quot; title=&quot;Potential server deadlock between follower sync with leader and follower receiving external connection requests.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2778&quot;&gt;&lt;del&gt;ZOOKEEPER-2778&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/247.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/247.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #247&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4453ab2a32f8b1a6d195a65c5466c1749bbb3464&lt;br/&gt;
Author: Michael Han &amp;lt;hanm@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-05-06T05:13:26Z&lt;/p&gt;

&lt;p&gt;    Potential server deadlock between follower sync with leader and follower receiving external connection requests.&lt;br/&gt;
    Remove synchronization requirements on certain methods to prevent dead lock. Current analysis indicates these methods don&apos;t require synchronization for them to work properly.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15999307" author="hadoopqa" created="Sat, 6 May 2017 05:54:05 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +0 tests included.  The patch appears to be a documentation patch that doesn&apos;t require tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/667//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/667//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/667//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/667//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/667//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/667//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16018073" author="githubbot" created="Fri, 19 May 2017 21:47:31 +0000"  >&lt;p&gt;Github user afine commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/zookeeper/pull/247#discussion_r117582004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/247#discussion_r117582004&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java &amp;#8212;&lt;br/&gt;
    @@ -682,27 +682,19 @@ public void setQuorumAddress(InetSocketAddress addr){&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         public InetSocketAddress getElectionAddress(){&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronized (QV_LOCK) 
{
    -            return myElectionAddr;
    -        }
&lt;p&gt;    +        return myElectionAddr;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;gt; All set code path was protected by QV_LOCK already, which implies that whoever calls set* should already acquire the QV_LOCK.&lt;/p&gt;

&lt;p&gt;    Not sure about this one. `setElectionAddress` is called by `recreateSocketAddresses` which is called by `QuorumCnxManager#Listener.run` without acquiring QV_LOCK. Not sure what the implication of this is. Although I believe you are correct about `setClientAddress`.&lt;/p&gt;

&lt;p&gt;    &amp;gt; if we get out dated addr (in case the current quorum peer is being reconfigured) and sent this to another peer, another peer will not able to connect but that&apos;s fine, it will retry until at certain point later it will get correct information.&lt;/p&gt;

&lt;p&gt;    What is the behavior if we are able to connect to the &quot;incorrect peer&quot;. Will we eventually disconnect or do we stay connected until reconfiguration occurs again?&lt;/p&gt;</comment>
                            <comment id="16151039" author="castuardo" created="Fri, 1 Sep 2017 19:15:23 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;We are computer science PhD students building a Distributed model checking tool. We have been able to reproduce this issue too, when the QuorumPeer thread is racing with the Listener thread and gets into deadlock by requesting QCNXManager lock while holding QV_LOCK (on the other side, Listener thread holds QCNXManager lock and requests QV_LOCK). We also see this potential issue with the WorkerSender thread while performing toSend -&amp;gt; connectOne (one argument, requesting QCNXManager_LOCK) -&amp;gt; connectOne (two arguments, requesting QCNXManager_LOCK) -&amp;gt; initiateConnection -&amp;gt; getElectionAddress (requesting QV_LOCK) which can also race with the QuorumPeer thread for the same locks.&lt;/p&gt;
</comment>
                            <comment id="16155336" author="hanm" created="Wed, 6 Sep 2017 13:33:19 +0000"  >&lt;p&gt;Thanks for your efforts on reproducing this bug (and many others), &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=castuardo&quot; class=&quot;user-hover&quot; rel=&quot;castuardo&quot;&gt;castuardo&lt;/a&gt;! I&apos;ll resume working on this soon.&lt;/p&gt;</comment>
                            <comment id="16156297" author="castuardo" created="Thu, 7 Sep 2017 01:41:39 +0000"  >&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;Happy to help &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt;! Are we correct about the issue (regarding the path)?&lt;/p&gt;</comment>
                            <comment id="16162151" author="hanm" created="Mon, 11 Sep 2017 22:32:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Are we correct about the issue (regarding the path)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes it sounds right - what you said:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;We also see this potential issue with the WorkerSender thread while performing toSend -&amp;gt; connectOne (one argument, requesting QCNXManager_LOCK) -&amp;gt; connectOne (two arguments, requesting QCNXManager_LOCK) -&amp;gt; initiateConnection -&amp;gt; getElectionAddress (requesting QV_LOCK) which can also race with the QuorumPeer thread for the same locks.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Feel free to create a separate JIRA for this issue.&lt;/p&gt;</comment>
                            <comment id="16640957" author="maoling" created="Sun, 7 Oct 2018 03:02:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hanm&quot; class=&quot;user-hover&quot; rel=&quot;hanm&quot;&gt;hanm&lt;/a&gt; &lt;br/&gt;
Are you still working on this?Could I pick up it(smirk)?&lt;/p&gt;</comment>
                            <comment id="16664987" author="andorm" created="Fri, 26 Oct 2018 10:21:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maoling&quot; class=&quot;user-hover&quot; rel=&quot;maoling&quot;&gt;maoling&lt;/a&gt; Do you have an update on this ticket?&lt;/p&gt;</comment>
                            <comment id="16683362" author="maoling" created="Mon, 12 Nov 2018 07:56:45 +0000"  >&lt;p&gt;@  all&lt;br/&gt;
I was stuck with other staffs the other day.I will spare no effort to chase this girl down these day.&lt;/p&gt;</comment>
                            <comment id="16693231" author="mkedwards" created="Tue, 20 Nov 2018 13:26:59 +0000"  >&lt;p&gt;May I suggest a different approach?&#160; There are three&#160;fragments of data here (myQuorumAddr, myClientAddr, and myElectionAddr) that should be 1) updated atomically as a group, and 2) aggressively made visible to concurrent threads on other CPUs.&#160; There isn&apos;t really a need to lock out access to them while other code that holds QV_LOCK runs.&#160; Seems like an ideal candidate for an AtomicReference to an immutable POJO that holds the three addresses.&#160; Suggested patch in&#160;&lt;a href=&quot;https://github.com/apache/zookeeper/pull/707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/707&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16693304" author="maoling" created="Tue, 20 Nov 2018 14:28:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkedwards&quot; class=&quot;user-hover&quot; rel=&quot;mkedwards&quot;&gt;mkedwards&lt;/a&gt;&lt;br/&gt;
I take a quick look at your patch.&lt;br/&gt;
the solution you had provided is so smart and elegant.incredible!&lt;/p&gt;</comment>
                            <comment id="16693530" author="mkedwards" created="Tue, 20 Nov 2018 17:20:34 +0000"  >&lt;p&gt;Is there a need to add a reader/writer lock that prevents read access to these addresses until they have been written for the first time?&#160; I haven&apos;t yet looked closely enough at the code to see whether that&apos;s a possible scenario.&lt;/p&gt;</comment>
                            <comment id="16693898" author="mkedwards" created="Tue, 20 Nov 2018 23:40:58 +0000"  >&lt;p&gt;From what I&apos;m seeing, it would be a crashing bug for &lt;tt&gt;getQuorumAddress()&lt;/tt&gt; (which cannot be marked &lt;tt&gt;protected&lt;/tt&gt;, because it&apos;s called by has-a holders of a &lt;tt&gt;QuorumPeer&lt;/tt&gt; reference rather than by is-a subclasses of &lt;tt&gt;QuorumPeer&lt;/tt&gt;, but can and should be package-private) to be called before the addresses are set.  The only call to &lt;tt&gt;getClientAddress()&lt;/tt&gt; (which should be &lt;tt&gt;private&lt;/tt&gt;) is in &lt;tt&gt;processReconfig()&lt;/tt&gt;, and it&apos;s appropriate for it to return &lt;tt&gt;null&lt;/tt&gt; if called early.  This leaves &lt;tt&gt;getElectionAddress()&lt;/tt&gt;, which again is pseudo-protected and would produce a crash if called before the addresses are set.&lt;/p&gt;

&lt;p&gt;So the actual problem here is that, if the election address is not yet known, there&apos;s no safe return value from &lt;tt&gt;getElectionAddress()&lt;/tt&gt; in the race scenario cited in the bug description.  This &quot;fix&quot; &#8211; hanm&apos;s or mine &#8211; will turn it into an NPE instead of a deadlock.&lt;/p&gt;

&lt;p&gt;This might be addressable by ensuring that code that needs the &lt;tt&gt;QV_LOCK&lt;/tt&gt; for a &lt;tt&gt;QuorumPeer&lt;/tt&gt; associated with a &lt;tt&gt;QuorumCnxManager&lt;/tt&gt; (to protect the macroscopic critical sections in &lt;tt&gt;QuorumCnxManager.connectOne()&lt;/tt&gt;, &lt;tt&gt;QuorumPeer.setLastSeenQuorumVerifier()&lt;/tt&gt;, and &lt;tt&gt;QuorumPeer.setQuorumVerifier()&lt;/tt&gt;) always takes the lock on the &lt;tt&gt;QuorumCnxManager&lt;/tt&gt; instance first.  Looking into that.&lt;/p&gt;</comment>
                            <comment id="16693936" author="hanm" created="Wed, 21 Nov 2018 00:23:39 +0000"  >&lt;p&gt;I have to refresh my memory on this issue, but now looking back I think the gist of the issue is:&lt;br/&gt;
We want to guarantee to get a consistent membership view of the ensemble thus we need to lock (QV_LOCK) on the quorum peer when we access (read/write) to it. Meanwhile we need another lock on QCM itself and the order of acquiring both locks in different path is not consistent, thus causing dead lock.&lt;/p&gt;

&lt;p&gt;The fix I proposed earlier and PR 707 did it by removing the QV lock on the read path. The problem is I am not sure how to validate its correctness given the intertwined code path &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - I previously while working on this was convinced removing QV_LOCK on read path of the three addresses is sound, now I am not sure.&lt;/p&gt;

&lt;p&gt;We could also try remove one or both synchronized on the connectOne of QCM - it seems OK at least for the first connectOne (with two parameters) and this should fix this specific dead lock.&lt;/p&gt;

&lt;p&gt;Another idea is to avoid QV lock completely by abstract the quorum verifier as an AtomicrReference similar as 707 did for three address field, if it&apos;s feasible to do so.&lt;/p&gt;</comment>
                            <comment id="16694401" author="mkedwards" created="Wed, 21 Nov 2018 08:46:17 +0000"  >&lt;p&gt;I have implemented a more complete fix which (I think) solves all the lock ordering and cross-thread visibility issues associated with the QV_LOCK, qcm, and address fields.  Testing now; assuming no surprises, I&apos;ll push it as an update to &lt;a href=&quot;https://github.com/apache/zookeeper/pull/707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/707&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16694994" author="mkedwards" created="Wed, 21 Nov 2018 17:27:48 +0000"  >&lt;p&gt;Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maoling&quot; class=&quot;user-hover&quot; rel=&quot;maoling&quot;&gt;maoling&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; for quick review!  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=castuardo&quot; class=&quot;user-hover&quot; rel=&quot;castuardo&quot;&gt;castuardo&lt;/a&gt;, @afine, any chance you might be able to take a look at the alternate patch?&lt;/p&gt;</comment>
                            <comment id="16695219" author="mkedwards" created="Wed, 21 Nov 2018 20:10:57 +0000"  >&lt;p&gt;Legit green build!&lt;/p&gt;</comment>
                            <comment id="16698085" author="mkedwards" created="Sun, 25 Nov 2018 07:28:32 +0000"  >&lt;p&gt;Note that the current version of this patch also addresses &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2488&quot; title=&quot;Unsynchronized access to shuttingDownLE in QuorumPeer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2488&quot;&gt;ZOOKEEPER-2488&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16700689" author="mkedwards" created="Tue, 27 Nov 2018 16:45:03 +0000"  >&lt;p&gt;The current versions of this patch (#719 for master, #707 for branch-3.5) build green and don&apos;t have extraneous content.&lt;/p&gt;</comment>
                            <comment id="16712762" author="andorm" created="Fri, 7 Dec 2018 12:12:08 +0000"  >&lt;p&gt;Issue resolved by pull request 707&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/707&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16712827" author="hudson" created="Fri, 7 Dec 2018 13:01:19 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Zookeeper-trunk-single-thread #137 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/137/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/137/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2778&quot; title=&quot;Potential server deadlock between follower sync with leader and follower receiving external connection requests.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2778&quot;&gt;&lt;del&gt;ZOOKEEPER-2778&lt;/del&gt;&lt;/a&gt;: QuorumPeer: address potential reconfiguration deadlocks (andor: rev 6ea3c0b6897ec3a833f5b86fe8612bc9b2ac672c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/test/ReconfigTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/LeaderBeanTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16713037" author="hudson" created="Fri, 7 Dec 2018 16:09:59 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #298 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/298/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/298/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2778&quot; title=&quot;Potential server deadlock between follower sync with leader and follower receiving external connection requests.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2778&quot;&gt;&lt;del&gt;ZOOKEEPER-2778&lt;/del&gt;&lt;/a&gt;: QuorumPeer: address potential reconfiguration deadlocks (andor: rev 6ea3c0b6897ec3a833f5b86fe8612bc9b2ac672c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/LeaderBeanTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/test/ReconfigTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12754914">ZOOKEEPER-2080</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12754914">ZOOKEEPER-2080</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ekp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>