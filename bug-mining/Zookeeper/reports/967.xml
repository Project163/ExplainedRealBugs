<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:02:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-3471] Potential lock unavailable due to dangling ephemeral nodes left during local session upgrading</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-3471</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;There is a race condition which&#160;might be triggered if the client create session, upgrading the session with ephemeral node, then immediately issued close session request before it&apos;s removed from local session tracker.&lt;br/&gt;
&#160;&lt;br/&gt;
The close session request will be treated as a local session close request since it still exists in the local session tracker, which goes through the ZK pipeline and delete the session from both local and global session tracker. Since the session is not tracked anymore, it will leave the ephemeral nodes there.&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13247541">ZOOKEEPER-3471</key>
            <summary>Potential lock unavailable due to dangling ephemeral nodes left during local session upgrading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lvfangmin">Fangmin Lv</assignee>
                                    <reporter username="lvfangmin">Fangmin Lv</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 28 Jul 2019 17:50:16 +0000</created>
                <updated>Wed, 16 Oct 2019 22:12:06 +0000</updated>
                            <resolved>Wed, 9 Oct 2019 14:49:21 +0000</resolved>
                                    <version>3.6.0</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="16894762" author="hadoopqa" created="Sun, 28 Jul 2019 18:42:03 +0000"  >&lt;p&gt;+1 overall.  GitHub Pull Request  Build&lt;/p&gt;


&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 3 new or modified tests.&lt;/p&gt;

&lt;p&gt;    +1 javadoc.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4076//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4076//testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4076//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4076//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4076//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/4076//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="16905643" author="hanm" created="Mon, 12 Aug 2019 22:30:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt; I feel I get the race condition you described at a high level, but I had a hard time to actually construct a conceptual model on the race that maps to the code (due to the convoluted session handling codes). &lt;/p&gt;

&lt;p&gt;Do you mind to provide a little bit more concrete examples on where exactly the race happening? In particular:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;delete the session from both local and global session tracker&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Does this happen before or after the session upgrade finish? As we know, the session upgrade finishing by commit a session in quorum, so if this delete from session tracker finishes before session upgrading finish, then the commit session will re-add the session back; if this delete is finished after session upgrading finish, then we still have the session on other quorum servers. So every case seems ok?&lt;/p&gt;</comment>
                            <comment id="16947091" author="lvfangmin" created="Tue, 8 Oct 2019 18:03:57 +0000"  >&lt;p&gt;Hi Michael, sorry for the lately reply, just saw your comment here.&lt;/p&gt;

&lt;p&gt;Here is the detailed flow for this issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;client created a local session s1&lt;/li&gt;
	&lt;li&gt;it then issued create ephemeral node request, which&#160;will go through the FollowerRequestProcessor, check and upgrade the session&lt;/li&gt;
	&lt;li&gt;but before it&apos;s finished checking, the client issued close session request immediately, which will be treated as a local session&lt;/li&gt;
	&lt;li&gt;in case the previous upgrading session is finished and committed, then executing the local close session in step 3 in FinalRequestProcessor, &lt;a href=&quot;#L76]&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;LearnerSessionTracker&lt;/a&gt; will remove it from both local session and global session&lt;/li&gt;
	&lt;li&gt;so the global session will miss on this learner, but exists on others.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Let me know if this is not clear.&lt;/p&gt;</comment>
                            <comment id="16947768" author="andorm" created="Wed, 9 Oct 2019 14:49:21 +0000"  >&lt;p&gt;Issue resolved by pull request 1025&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/pull/1025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/1025&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16947859" author="hudson" created="Wed, 9 Oct 2019 17:10:52 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #730 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/730/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/730/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3471&quot; title=&quot;Potential lock unavailable due to dangling ephemeral nodes left during local session upgrading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3471&quot;&gt;&lt;del&gt;ZOOKEEPER-3471&lt;/del&gt;&lt;/a&gt;: Fix potential lock unavailable due to dangling ephemeral (andor: rev 4951a090d7c946f57ac5ab09b5d48a5d7831001d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/SessionUpgradeQuorumTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16947938" author="hudson" created="Wed, 9 Oct 2019 19:10:23 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Zookeeper-trunk-single-thread #568 (See &lt;a href=&quot;https://builds.apache.org/job/Zookeeper-trunk-single-thread/568/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Zookeeper-trunk-single-thread/568/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-3471&quot; title=&quot;Potential lock unavailable due to dangling ephemeral nodes left during local session upgrading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-3471&quot;&gt;&lt;del&gt;ZOOKEEPER-3471&lt;/del&gt;&lt;/a&gt;: Fix potential lock unavailable due to dangling ephemeral (andor: rev 4951a090d7c946f57ac5ab09b5d48a5d7831001d)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/SessionUpgradeQuorumTest.java&lt;/li&gt;
	&lt;li&gt;(edit) zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16953222" author="hanm" created="Wed, 16 Oct 2019 22:08:22 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lvfangmin&quot; class=&quot;user-hover&quot; rel=&quot;lvfangmin&quot;&gt;lvfangmin&lt;/a&gt; for getting back on this. Your reply explained well on the race condition. My initial understanding after reading problem description was that this was a quorum level problem (where my confusions came from) but it actually is a local (learner specific) problem, which now makes sense to me.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z053s8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>