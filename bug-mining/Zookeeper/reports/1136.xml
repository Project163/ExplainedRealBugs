<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:05:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-4276] Serving only with secureClientPort fails</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-4276</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;clientPort in zoo.cfg is forcefully complemented from client address by QuorumPeerConfig#setupClientPort even though secureClientPort is set and matches with client address&apos; port.&lt;br/&gt;
Because of this behavior, in case rolling update with replacing clientPort to secureClientPort in the same port number following &lt;a href=&quot;https://zookeeper.apache.org/doc/r3.7.0/zookeeperAdmin.html#Upgrading+existing+nonTLS+cluster&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Upgrading existing non-TLS cluster with no downtime&lt;/a&gt; conflicts and gets errors below.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-03-29 23:21:58,638 - INFO  [main:NettyServerCnxnFactory@590] - binding to port /0.0.0.0:2281
2021-03-29 23:21:58,748 - INFO  [main:NettyServerCnxnFactory@595] - bound to port 2281
2021-03-29 23:21:58,749 - INFO  [main:NettyServerCnxnFactory@590] - binding to port 0.0.0.0/0.0.0.0:2281
2021-03-29 23:21:58,753 - ERROR [main:QuorumPeerMain@101] - Unexpected exception, exiting abnormally
java.net.BindException: Address already in use
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;QuorumPeerConfig#setupClientPort should complement only when both clientPort and secureClientPort are empty, and allow serving zookeeper server only with secure client port.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13369955">ZOOKEEPER-4276</key>
            <summary>Serving only with secureClientPort fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abhilash1in">Abhilash Kishore</assignee>
                                    <reporter username="kkori">Kei Kori</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 7 Apr 2021 05:58:41 +0000</created>
                <updated>Sat, 16 Mar 2024 04:25:42 +0000</updated>
                            <resolved>Sat, 9 Mar 2024 03:47:11 +0000</resolved>
                                    <version>3.7.0</version>
                    <version>3.5.8</version>
                    <version>3.6.2</version>
                    <version>3.8.0</version>
                                    <fixVersion>3.10.0</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13200">3h 40m</timespent>
                                <comments>
                            <comment id="17531850" author="lars_francke" created="Wed, 4 May 2022 17:09:30 +0000"  >&lt;p&gt;This is not only an issue during rolling upgrades. It also happens during regular server runs.&lt;/p&gt;

&lt;p&gt;This basically means you can&apos;t run &quot;secure only&quot;, it still happens on 3.8.0&lt;/p&gt;</comment>
                            <comment id="17774068" author="andorm" created="Wed, 11 Oct 2023 13:26:17 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=larsfrancke&quot; class=&quot;user-hover&quot; rel=&quot;larsfrancke&quot;&gt;larsfrancke&lt;/a&gt; , let me pick this up. It looks important.&lt;/p&gt;</comment>
                            <comment id="17774073" author="andorm" created="Wed, 11 Oct 2023 13:37:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkori&quot; class=&quot;user-hover&quot; rel=&quot;kkori&quot;&gt;kkori&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=larsfrancke&quot; class=&quot;user-hover&quot; rel=&quot;larsfrancke&quot;&gt;larsfrancke&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I cannot repro this issue. Would you please upload your zoo.cfg?&lt;/p&gt;

&lt;p&gt;This one works for me:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;tickTime=2000
initLimit=10
syncLimit=5
dataDir=./andor-5560-ubuntu:2181/data
secureClientPort=2181
clientCnxnSocket=org.apache.zookeeper.ClientCnxnSocketNetty
...
serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory
...
server.1=andor-5560-ubuntu:3181:4181
server.2=andor-5560-ubuntu:3182:4182
server.3=andor-5560-ubuntu:3183:4183
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I don&apos;t set clientPort and clientPortAddress. Startup logs look like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2023-10-11 15:28:35,358 [myid:] - INFO &#160;[main:o.a.z.s.q.QuorumPeerConfig@177] - Reading configuration from: ./andor-5560-ubuntu:2181/zoo.cfg
2023-10-11 15:28:35,360 [myid:] - INFO &#160;[main:o.a.z.s.q.QuorumPeerConfig@431] - clientPort is not set
2023-10-11 15:28:35,366 [myid:] - INFO &#160;[main:o.a.z.s.q.QuorumPeerConfig@453] - secureClientPortAddress is 0.0.0.0:2181
...
2023-10-11 15:28:35,635 [myid:1] - INFO &#160;[main:o.a.z.s.NettyServerCnxnFactory@707] - binding to port 0.0.0.0/0.0.0.0:2181
2023-10-11 15:28:35,704 [myid:1] - INFO &#160;[main:o.a.z.s.NettyServerCnxnFactory@712] - bound to port 2181&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ZooKeeper is listening in secure-mode only.&lt;/p&gt;</comment>
                            <comment id="17774094" author="lars_francke" created="Wed, 11 Oct 2023 14:33:04 +0000"  >&lt;p&gt;Thanks for taking a look. This was a while ago and we need to refresh our memories &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Which version are you testing with?&lt;/p&gt;

&lt;p&gt;I am pretty sure that we saw the described behavior and we could see the issue in code as well but it&apos;s a bit foggy.&lt;/p&gt;</comment>
                            <comment id="17774114" author="andorm" created="Wed, 11 Oct 2023 15:19:18 +0000"  >&lt;p&gt;&lt;tt&gt;Server environment:zookeeper.version=3.8.3-6ad6d364c7c0bcf0de452d54ebefa3058098ab56&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17780132" author="abhilash1in" created="Fri, 27 Oct 2023 01:26:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; Can you please please try this config?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
tickTime=2000
initLimit=10
syncLimit=5
dataDir=./andor-5560-ubuntu:2181/data
secureClientPort=2181
clientCnxnSocket=org.apache.zookeeper.ClientCnxnSocketNetty
...
serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory
...
server.1=andor-5560-ubuntu:3181:4181;2181  # or server.1=andor-5560-ubuntu:3181:4181:participant;0.0.0.0:2181
server.2=andor-5560-ubuntu:3182:4182;2181
server.3=andor-5560-ubuntu:3183:4183:participant;0.0.0.0:2181
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe this issue happens when `secureClientPort` is declared in zoo.cfg in addition to client port in the server entry (e.g., 2181 in &quot;server.1=andor-5560-ubuntu:3181:4181;2181&quot;)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://zookeeper.apache.org/doc/current/zookeeperReconfig.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeper reconfig doc&lt;/a&gt; recommends specifying client port in the dynamic config server entry (and not declare separate clientPort and clientPortAddress). But it doesn&apos;t talk about how to indicate to ZK server that the client port (2181) in &quot;server.1=andor-5560-ubuntu:3181:4181;2181&quot; entry should be treated as secureClientPort and not just clientPort. I believe there&apos;s no way to do this currently.&lt;/p&gt;

&lt;p&gt;So for a TLS only cluster, we &lt;b&gt;have&lt;/b&gt; to specify `secureClientPort=2181` in zoo.cfg. In such cases, ZK server should skip binding to the client port in &quot;server.1=andor-5560-ubuntu:3181:4181;2181&quot; as non-TLS client port.&lt;/p&gt;

&lt;p&gt;It can/should still do some validation to ensure the client port in server entry matches clientPort or secureClientPort and is not completely arbitrary.&lt;/p&gt;
</comment>
                            <comment id="17780252" author="andorm" created="Fri, 27 Oct 2023 08:45:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abhilash1in&quot; class=&quot;user-hover&quot; rel=&quot;abhilash1in&quot;&gt;abhilash1in&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looks like you&apos;re facing an issue in ZooKeeper which has been present since ages. I did a quick search in Jira and it was mentioned in 2018 when the secureClientPort was introduced:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2125?focusedCommentId=16638309&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16638309&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/ZOOKEEPER-2125?focusedCommentId=16638309&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16638309&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t find an answer for this, so I would say this issue hasn&apos;t been addressed (although it should have been) when the SSL option was implemented.&lt;/p&gt;

&lt;p&gt;Would you mind putting together a patch under this Jira?&lt;/p&gt;</comment>
                            <comment id="17818998" author="abhilash1in" created="Tue, 20 Feb 2024 21:36:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andor&quot; class=&quot;user-hover&quot; rel=&quot;andor&quot;&gt;andor&lt;/a&gt; I have a PR out - &lt;a href=&quot;https://github.com/apache/zookeeper/pull/2117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/pull/2117&lt;/a&gt; . Can I get your review?&lt;/p&gt;</comment>
                            <comment id="17824899" author="tison" created="Sat, 9 Mar 2024 03:47:11 +0000"  >&lt;p&gt;master via bc1fc6d36435d3fad7b31642b647dc7680d7866e.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pli8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>