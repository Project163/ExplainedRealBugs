<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:57:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[ZOOKEEPER-2311] assert in setup_random</title>
                <link>https://issues.apache.org/jira/browse/ZOOKEEPER-2311</link>
                <project id="12310801" key="ZOOKEEPER">ZooKeeper</project>
                    <description>&lt;p&gt;We&apos;ve started seeing an assert failing inside setup_random at line 537:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 528 &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void setup_random()
 529 {
 530 #ifndef _WIN32          &lt;span class=&quot;code-comment&quot;&gt;// TODO: better seed
&lt;/span&gt; 531     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; seed;
 532     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; fd = open(&lt;span class=&quot;code-quote&quot;&gt;&quot;/dev/urandom&quot;&lt;/span&gt;, O_RDONLY);
 533     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fd == -1) {
 534         seed = getpid();
 535     } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
 536         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rc = read(fd, &amp;amp;seed, sizeof(seed));
 537         &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(rc == sizeof(seed));
 538         close(fd);
 539     }
 540     srandom(seed);
 541     srand48(seed);
 542 #endif
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The core files show:&lt;/p&gt;

&lt;p&gt;Program terminated with signal 6, Aborted.&lt;br/&gt;
#0  0x00007f9ff665a0d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6&lt;br/&gt;
#0  0x00007f9ff665a0d5 in raise () from /lib/x86_64-linux-gnu/libc.so.6&lt;br/&gt;
#1  0x00007f9ff665d83b in abort () from /lib/x86_64-linux-gnu/libc.so.6&lt;br/&gt;
#2  0x00007f9ff6652d9e in ?? () from /lib/x86_64-linux-gnu/libc.so.6&lt;br/&gt;
#3  0x00007f9ff6652e42 in __assert_fail () from /lib/x86_64-linux-gnu/libc.so.6&lt;br/&gt;
#4  0x00007f9ff8e4070a in setup_random () at src/zookeeper.c:476&lt;br/&gt;
#5  0x00007f9ff8e40d76 in resolve_hosts (zh=0x7f9fe14de400, hosts_in=0x7f9fd700f400 &quot;10.26.200.6:2181,10.26.200.7:2181,10.26.200.8:2181&quot;, avec=0x7f9fd87fab60) at src/zookeeper.c:730&lt;br/&gt;
#6  0x00007f9ff8e40e87 in update_addrs (zh=0x7f9fe14de400) at src/zookeeper.c:801&lt;br/&gt;
#7  0x00007f9ff8e44176 in zookeeper_interest (zh=0x7f9fe14de400, fd=0x7f9fd87fac4c, interest=0x7f9fd87fac50, tv=0x7f9fd87fac80) at src/zookeeper.c:1980&lt;br/&gt;
#8  0x00007f9ff8e553f5 in do_io (v=0x7f9fe14de400) at src/mt_adaptor.c:379&lt;br/&gt;
#9  0x00007f9ff804de9a in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0&lt;br/&gt;
#10 0x00007f9ff671738d in clone () from /lib/x86_64-linux-gnu/libc.so.6&lt;br/&gt;
#11 0x0000000000000000 in ?? ()&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the underlying cause of this is... But POSIX always allows for a short read(2), and any program MUST check for short reads... &lt;/p&gt;

&lt;p&gt;Has anyone else encountered this issue? We are seeing it rather frequently which is concerning.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12909770">ZOOKEEPER-2311</key>
            <summary>assert in setup_random</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marshall">Marshall McMullen</assignee>
                                    <reporter username="marshall">Marshall McMullen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Nov 2015 20:24:54 +0000</created>
                <updated>Wed, 7 Aug 2024 06:06:45 +0000</updated>
                            <resolved>Sun, 6 Dec 2015 19:34:42 +0000</resolved>
                                    <version>3.4.7</version>
                    <version>3.5.1</version>
                                    <fixVersion>3.4.8</fixVersion>
                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>c client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14985978" author="marshall" created="Mon, 2 Nov 2015 20:37:25 +0000"  >&lt;p&gt;Another interesting link related to this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugzilla.kernel.org/show_bug.cgi?id=80981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugzilla.kernel.org/show_bug.cgi?id=80981&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15032536" author="marshall" created="Mon, 30 Nov 2015 21:45:05 +0000"  >&lt;p&gt;A very specific LKML thread related to this exact behavior: &lt;a href=&quot;https://lkml.org/lkml/2005/1/13/485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lkml.org/lkml/2005/1/13/485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This email thread indicates that there is in general an assumption that reading from /dev/urandom will never result in a short read. In actuality, in the face of signals, that&apos;s not really guaranteed. As with any call to read(2), it must handle short reads properly. &lt;/p&gt;</comment>
                            <comment id="15032765" author="marshall" created="Tue, 1 Dec 2015 00:13:20 +0000"  >&lt;p&gt;Uploaded patch to harden setup_random against short reads from /dev/urandom per LKML thread indicating this is a valid non-error path.&lt;/p&gt;</comment>
                            <comment id="15032781" author="hadoopqa" created="Tue, 1 Dec 2015 00:21:45 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12774911/ZOOKEEPER-2311.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12774911/ZOOKEEPER-2311.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1715590.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    -1 tests included.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    -1 patch.  The patch command could not apply the patch.&lt;/p&gt;

&lt;p&gt;Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2971//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2971//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="15034904" author="marshall" created="Tue, 1 Dec 2015 23:55:44 +0000"  >&lt;p&gt;I got another recreate of this and this time got a core file. And I was wrong originally. It&apos;s not a short read that is causing this. Instead the read is failing with a return code of -1 and errno is set to EBADF. The manpage for read(2) indicates this can only happen when:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       EBADF  fd is not a valid file descriptor or is not open &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; reading.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But we specifically opened it 2 lines of code above that and checked to ensure it wasn&apos;t -1. &lt;/p&gt;

&lt;p&gt;In the core file I also see that the fd is valid:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#4  0x00007f9ff8e4070a in setup_random () at src/zookeeper.c:476
476	in src/zookeeper.c
(gdb) print errno
$3 = 9
(gdb) print fd
$4 = 140
(gdb) print seed
$5 = 32671
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s odd that seed has something in it. That could mean we read &lt;em&gt;something&lt;/em&gt;, but it could also be because this code never initialized seed to zero and it&apos;s got whatever garbage was on the stack.&lt;/p&gt;

&lt;p&gt;The only other thing that&apos;s very curious here is that I think when this happens it coincides with a call to zookeeper_close. But this is a local stack variable so I can&apos;t fathom how that could cause this failure scenario.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep digging.&lt;/p&gt;</comment>
                            <comment id="15043528" author="rgs" created="Sat, 5 Dec 2015 22:05:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marshall&quot; class=&quot;user-hover&quot; rel=&quot;marshall&quot;&gt;marshall&lt;/a&gt;: i&apos;d like to apply the patch and follow-up the EBADF in a separate jira - makes sense? Thanks!&lt;/p&gt;</comment>
                            <comment id="15043529" author="rgs" created="Sat, 5 Dec 2015 22:06:05 +0000"  >&lt;p&gt;(that is - not checking for short reads is a real bug. the EBADF case is still unclear). &lt;/p&gt;</comment>
                            <comment id="15043537" author="marshall" created="Sat, 5 Dec 2015 22:19:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgs&quot; class=&quot;user-hover&quot; rel=&quot;rgs&quot;&gt;rgs&lt;/a&gt; - Yes, I agree. The short read is still a problem. I think the EBADF is actually a bug in our application not in ZooKeeper. So unless I discover otherwise, I think we should ignore the EBADF for now. I&apos;ll open a separate jira if I find it&apos;s a real issue.&lt;/p&gt;

&lt;p&gt;I will regenerate this patch though b/c I didn&apos;t create it properly the first time.&lt;/p&gt;</comment>
                            <comment id="15043539" author="marshall" created="Sat, 5 Dec 2015 22:25:01 +0000"  >&lt;p&gt;Updated patch to be generated from the right directory this time.&lt;/p&gt;</comment>
                            <comment id="15044072" author="rgs" created="Sun, 6 Dec 2015 19:34:42 +0000"  >&lt;p&gt;Applied:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/zookeeper/commit/b4da11fc946c7c40fda2096943cdff5af30ae6c2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/b4da11fc946c7c40fda2096943cdff5af30ae6c2&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/commit/2e0c902dfc013060d409803a107b803015dc97d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/2e0c902dfc013060d409803a107b803015dc97d7&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/zookeeper/commit/5d4b5c4283b4bac6d41775d9208c85f73dd22844&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/zookeeper/commit/5d4b5c4283b4bac6d41775d9208c85f73dd22844&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marshall&quot; class=&quot;user-hover&quot; rel=&quot;marshall&quot;&gt;marshall&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15044125" author="hudson" created="Sun, 6 Dec 2015 20:42:00 +0000"  >&lt;p&gt;SUCCESS: Integrated in ZooKeeper-trunk #2820 (See &lt;a href=&quot;https://builds.apache.org/job/ZooKeeper-trunk/2820/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/ZooKeeper-trunk/2820/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-2311&quot; title=&quot;assert in setup_random&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-2311&quot;&gt;&lt;del&gt;ZOOKEEPER-2311&lt;/del&gt;&lt;/a&gt;: assert in setup_random&lt;br/&gt;
(Marshall McMullen via rgs) (rgs: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1718207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1718207&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;trunk/src/c/src/zookeeper.c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13588088">ZOOKEEPER-4848</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12775951" name="ZOOKEEPER-2311.patch" size="1087" author="marshall" created="Sat, 5 Dec 2015 22:25:01 +0000"/>
                            <attachment id="12774911" name="ZOOKEEPER-2311.patch" size="1091" author="marshall" created="Tue, 1 Dec 2015 00:12:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nua7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>