diff --git a/CHANGES.txt b/CHANGES.txt
index ac351bb09..09ec98688 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -145,6 +145,9 @@ BUGFIXES:
   ZOOKEEPER-452. zookeeper performance graph should have percentage of reads
 rather than percentage of writes - zkperfRW-3.2.jpg (mahadev)
 
+  ZOOKEEPER-450. emphemeral cleanup not happening with session timeout. (breed
+via mahadev)
+
 IMPROVEMENTS:
   ZOOKEEPER-308. improve the atomic broadcast performance 3x.
   (breed via mahadev)
diff --git a/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java b/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java
index 735e02043..6bb63d1ff 100644
--- a/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java
+++ b/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java
@@ -361,7 +361,10 @@ protected void pRequest(Request request) {
             case OpCode.closeSession:
                 txnHeader = new TxnHeader(request.sessionId, request.cxid, zks
                         .getNextZxid(), zks.getTime(), OpCode.closeSession);
-                zks.sessionTracker.checkSession(request.sessionId, request.getOwner());
+                // We don't want to do this check since the session expiration thread
+                // queues up this operation without being the session owner.
+                // this request is the last of the session so it should be ok
+                //zks.sessionTracker.checkSession(request.sessionId, request.getOwner());
                 HashSet<String> es = zks.dataTree
                         .getEphemerals(request.sessionId);
                 synchronized (zks.outstandingChanges) {
diff --git a/src/java/test/org/apache/zookeeper/test/ClientBase.java b/src/java/test/org/apache/zookeeper/test/ClientBase.java
index 414454254..c88fa5e90 100644
--- a/src/java/test/org/apache/zookeeper/test/ClientBase.java
+++ b/src/java/test/org/apache/zookeeper/test/ClientBase.java
@@ -47,7 +47,7 @@
 public abstract class ClientBase extends TestCase {
     protected static final Logger LOG = Logger.getLogger(ClientBase.class);
 
-    public static final int CONNECTION_TIMEOUT = 30000;
+    public static int CONNECTION_TIMEOUT = 30000;
     static final File BASETEST =
         new File(System.getProperty("build.test.dir", "build"));
 
diff --git a/src/java/test/org/apache/zookeeper/test/SessionTest.java b/src/java/test/org/apache/zookeeper/test/SessionTest.java
index 3e6c79118..9608706da 100644
--- a/src/java/test/org/apache/zookeeper/test/SessionTest.java
+++ b/src/java/test/org/apache/zookeeper/test/SessionTest.java
@@ -50,11 +50,15 @@ public class SessionTest extends TestCase implements Watcher {
     
     private CountDownLatch startSignal;
 
+    File tmpDir;
+    
     @Override
     protected void setUp() throws Exception {
         LOG.info("STARTING " + getName());
 
-        File tmpDir = ClientBase.createTmpDir();
+        if (tmpDir == null) {
+            tmpDir = ClientBase.createTmpDir();
+        }
 
         ClientBase.setupTestEnv();
         ZooKeeperServer zs = new ZooKeeperServer(tmpDir, tmpDir, 3000);
@@ -179,6 +183,35 @@ public void testSession()
         zk.close();
     }
 
+    @Test
+    /**
+     * Make sure ephemerals get cleaned up when a session times out.
+     */
+    public void testSessionTimeout() throws Exception {
+        int oldTimeout = CONNECTION_TIMEOUT;
+        CONNECTION_TIMEOUT = 5000;
+        try {
+            DisconnectableZooKeeper zk = createClient();
+            zk.create("/stest", new byte[0], Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
+            zk.disconnect();
+            Thread.sleep(CONNECTION_TIMEOUT*2);
+            zk = createClient();
+            System.err.println("This test fails");
+            zk.create("/stest", new byte[0], Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
+            tearDown();
+            zk.close();
+            zk.disconnect();
+            setUp();
+            zk = createClient();
+            assertTrue(zk.exists("/stest", false) != null);
+            Thread.sleep(CONNECTION_TIMEOUT * 2);
+            assertTrue(zk.exists("/stest", false) == null);
+            zk.close();
+        } finally {
+            CONNECTION_TIMEOUT = oldTimeout;
+        }
+    }
+    
     /**
      * Make sure that we cannot have two connections with the same
      * session id.
