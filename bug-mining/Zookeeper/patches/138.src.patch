diff --git a/CHANGES.txt b/CHANGES.txt
index 67c7edb17..da29139b5 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -24,6 +24,9 @@ BUGFIXES:
 
   ZOOKEEPER-487. setdata on root (/) crashes the servers (mahadev via phunt)
 
+  ZOOKEEPER-457. Make ZookeeperMain public, support for HBase (and other)
+  embedded clients (ryan rawson via phunt)
+
 IMPROVEMENTS:
   ZOOKEEPER-473. cleanup junit tests to eliminate false positives due to
   "socket reuse" and failure to close client (phunt via mahadev)
diff --git a/src/java/main/org/apache/zookeeper/ZooKeeperMain.java b/src/java/main/org/apache/zookeeper/ZooKeeperMain.java
index c69390afc..ba09f5e53 100644
--- a/src/java/main/org/apache/zookeeper/ZooKeeperMain.java
+++ b/src/java/main/org/apache/zookeeper/ZooKeeperMain.java
@@ -60,7 +60,7 @@ public boolean getPrintWatches( ) {
         return printWatches;
     }
 
-    static void populateCommandMap() {
+    static {
         commandMap.put("connect", "host:port");
         commandMap.put("close","");
         commandMap.put("create", "[-s] [-e] path data acl");
@@ -145,12 +145,13 @@ private static void printStat(Stat stat) {
      */
     static private class MyCommandOptions {
 
-        private Map<String,String> options = null;
+        private Map<String,String> options = new HashMap<String,String>();
         private List<String> cmdArgs = null;
         private String command = null;
 
         public MyCommandOptions() {
-            options = null; command = null;
+          options.put("server", "localhost:2181");
+          options.put("timeout", "30000");
         }
 
         public String getOption(String opt) {
@@ -173,13 +174,6 @@ public String[] getArgArray() {
             return cmdArgs.toArray(new String[0]);
         }
 
-        private Map<String,String> buildDefaults( ) {
-            options = new HashMap<String,String>( );
-            options.put("server", "localhost:2181");
-            options.put("timeout", "30000");
-            return options;
-        }
-
         /**
          * Parses a command line that may contain one or more flags
          * before an optional command string
@@ -187,7 +181,6 @@ private Map<String,String> buildDefaults( ) {
          * @return true if parsing succeeded, false otherwise.
          */
         public boolean parseOptions(String[] args) {
-            Map<String, String> ret = buildDefaults();
             List<String> argList = Arrays.asList(args);
             Iterator<String> it = argList.iterator();
 
@@ -195,9 +188,9 @@ public boolean parseOptions(String[] args) {
                 String opt = it.next();
                 try {
                     if (opt.equals("-server")) {
-                        ret.put("server", it.next());
+                        options.put("server", it.next());
                     } else if (opt.equals("-timeout")) {
-                        ret.put("timeout", it.next());
+                        options.put("timeout", it.next());
                     }
                 } catch (NoSuchElementException e){
                     System.err.println("Error: no argument found for option "
@@ -271,7 +264,6 @@ protected void connectToZK(String newHost) throws InterruptedException, IOExcept
     public static void main(String args[])
         throws KeeperException, IOException, InterruptedException
     {
-        populateCommandMap();
         ZooKeeperMain main = new ZooKeeperMain(args);
         main.run();
     }
@@ -284,6 +276,10 @@ public ZooKeeperMain(String args[]) throws IOException, InterruptedException {
 //                Integer.parseInt(cl.getOption("timeout")), new MyWatcher());
     }
 
+    public ZooKeeperMain(ZooKeeper zk) {
+      this.zk = zk;
+    }
+
     @SuppressWarnings("unchecked")
     void run() throws KeeperException, IOException, InterruptedException {
         if (cl.getCommand() == null) {
@@ -310,12 +306,7 @@ void run() throws KeeperException, IOException, InterruptedException {
                 String line;
                 Method readLine = consoleC.getMethod("readLine", String.class);
                 while ((line = (String)readLine.invoke(console, getPrompt())) != null) {
-                    if (!line.equals("")) {
-                        cl.parseCommand(line);
-                        addToHistory(commandCount,line);
-                        processCmd(cl);
-                        commandCount++;
-                    }
+                    executeLine(line);
                 }
             } catch (ClassNotFoundException e) {
                 LOG.debug("Unable to start jline", e);
@@ -341,12 +332,7 @@ void run() throws KeeperException, IOException, InterruptedException {
 
                 String line;
                 while ((line = br.readLine()) != null) {
-                    if (!line.equals("")) {
-                        cl.parseCommand(line);
-                        addToHistory(commandCount,line);
-                        processCmd(cl);
-                        commandCount++;
-                    }
+                    executeLine(line);
                 }
             }
         }
@@ -357,6 +343,16 @@ void run() throws KeeperException, IOException, InterruptedException {
         }
     }
 
+    public void executeLine(String line)
+    throws InterruptedException, IOException, KeeperException {
+      if (!line.equals("")) {
+        cl.parseCommand(line);
+        addToHistory(commandCount,line);
+        processCmd(cl);
+        commandCount++;
+      }
+    }
+
     private static DataCallback dataCallback = new DataCallback() {
 
         public void processResult(int rc, String path, Object ctx, byte[] data,
