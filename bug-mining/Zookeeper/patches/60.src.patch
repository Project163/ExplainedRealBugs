diff --git a/CHANGES.txt b/CHANGES.txt
index 253bc20aa..4a9fbff32 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -51,7 +51,10 @@ BUGFIXES:
   (patrick hunt via mahadev)
 
   ZOOKEEPER-245. update readme/quickstart to be release tar, rather than
-source, based (patrick hunt via mahadev)
+  source, based (patrick hunt via mahadev)
+
+  ZOOKEEPER-251. NullPointerException stopping and starting Zookeeper servers
+  (mahadev via phunt)
   
 IMPROVEMENTS:
    
diff --git a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java
index b38d0fb71..93bfd0b3d 100644
--- a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java
+++ b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnLog.java
@@ -355,7 +355,8 @@ else if (Util.getZxidFromName(f.getName(), "log") < zxid) {
             if (!next())
                 return;
             while (hdr.getZxid() < zxid) {
-                next();
+                if (!next())
+                    return;
             }
         }
         
@@ -446,6 +447,7 @@ record = SerializeUtils.deserializeTxn(iab, hdr);
                 LOG.debug("EOF excepton " + e);
                 inputStream.close();
                 inputStream = null;
+                ia = null;
                 // thsi means that the file has ended 
                 // we shoud go to the next file
                 if (!goToNextLog()) {
diff --git a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
index a1e91718d..697442b34 100644
--- a/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
+++ b/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java
@@ -84,6 +84,24 @@ public FileTxnSnapLog(File dataDir, File snapDir) {
         snapLog = new FileSnap(this.snapDir);
     }
     
+    /**
+     * get the datadir used by this filetxn
+     * snap log
+     * @return the data dir
+     */
+    public File getDataDir() {
+        return this.dataDir;
+    }
+    
+    /**
+     * get the snap dir used by this 
+     * filetxn snap log
+     * @return the snap dir
+     */
+    public File getSnapDir() {
+        return this.snapDir;
+    }
+    
     /**
      * this function restors the server 
      * database after reading from the 
diff --git a/src/java/test/org/apache/zookeeper/test/QuorumTest.java b/src/java/test/org/apache/zookeeper/test/QuorumTest.java
index fb9395f0f..4a87e5b68 100644
--- a/src/java/test/org/apache/zookeeper/test/QuorumTest.java
+++ b/src/java/test/org/apache/zookeeper/test/QuorumTest.java
@@ -127,7 +127,7 @@ protected void tearDown() throws Exception {
         LOG.info("FINISHED " + getName());
     }
 
-    private void shutdown(QuorumPeer qp) {
+    protected void shutdown(QuorumPeer qp) {
         try {
             qp.shutdown();
             qp.join(30000);
diff --git a/src/java/test/org/apache/zookeeper/test/RepeatStartupTest.java b/src/java/test/org/apache/zookeeper/test/RepeatStartupTest.java
new file mode 100644
index 000000000..ddc7f7e3b
--- /dev/null
+++ b/src/java/test/org/apache/zookeeper/test/RepeatStartupTest.java
@@ -0,0 +1,75 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import java.io.IOException;
+
+import junit.framework.TestCase;
+
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.server.NIOServerCnxn;
+import org.apache.zookeeper.server.ZooKeeperServer;
+import org.apache.zookeeper.server.quorum.QuorumPeer;
+
+/**
+ * this test fails quorum peers 
+ * and then brings up one of the
+ * node as a standalone server
+ */
+public class RepeatStartupTest extends TestCase {
+    
+    /** bring up 5 quorum peers and then shut them down
+     * and then bring one of the nodes as server
+     * @throws Exception
+     */
+    public void testFail() throws Exception {
+        QuorumTest qt = new QuorumTest();
+        qt.setUp();
+        System.out.println("Comment: the servers are at " + qt.hostPort);
+        ZooKeeper zk = qt.createClient();
+        zk.create("/test", null, Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+        zk.close();
+        qt.shutdown(qt.s1);
+        qt.shutdown(qt.s2);
+        qt.shutdown(qt.s3);
+        qt.shutdown(qt.s4);
+        qt.shutdown(qt.s5);
+        String hp = qt.hostPort.split(",")[0];
+        ZooKeeperServer zks = new ZooKeeperServer(qt.s1.getTxnFactory().getSnapDir(), 
+                qt.s1.getTxnFactory().getDataDir(), 3000);
+        final int PORT = Integer.parseInt(hp.split(":")[1]);
+        NIOServerCnxn.Factory factory = null;
+        if (factory == null) {
+            factory = new NIOServerCnxn.Factory(PORT);
+        }
+        
+        factory.startup(zks);
+        System.out.println("Comment: starting factory");
+        assertTrue("waiting for server up",
+                   ClientBase.waitForServerUp("127.0.0.1:" + PORT,
+                           QuorumTest.CONNECTION_TIMEOUT));
+        factory.shutdown();
+        assertTrue("waiting for server down",
+                   ClientBase.waitForServerDown("127.0.0.1:" + PORT,
+                                                QuorumTest.CONNECTION_TIMEOUT));
+        System.out.println("Comment: shutting doen standalone");
+    }
+}
\ No newline at end of file
