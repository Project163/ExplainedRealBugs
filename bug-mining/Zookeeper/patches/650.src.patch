diff --git a/CHANGES.txt b/CHANGES.txt
index 4c046f263..dc1b1a4cc 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -5,6 +5,8 @@ NEW FEATURES:
 BUGFIXES:
   ZOOKEEPER-2047 testTruncationNullLog fails on windows (flavio via rakeshr)
 
+  ZOOKEEPER-2026 Startup order in ServerCnxnFactory-ies is wrong (Stevo Slavic via rakeshr)
+
 IMPROVEMENTS:
   ZOOKEEPER-1660 Documentation for Dynamic Reconfiguration (Reed Wanderman-Milne via shralex)  
 
diff --git a/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java b/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java
index 7f188c807..acabb33f6 100644
--- a/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java
+++ b/src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java
@@ -745,9 +745,9 @@ public void start() {
     public void startup(ZooKeeperServer zks) throws IOException,
             InterruptedException {
         start();
+        setZooKeeperServer(zks);
         zks.startdata();
         zks.startup();
-        setZooKeeperServer(zks);
     }
 
     @Override
diff --git a/src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java b/src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java
index 8a05f9480..727668572 100644
--- a/src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java
+++ b/src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java
@@ -371,9 +371,9 @@ public void reconfigure(InetSocketAddress addr)
     public void startup(ZooKeeperServer zks) throws IOException,
             InterruptedException {
         start();
+        setZooKeeperServer(zks);
         zks.startdata();
         zks.startup();
-        setZooKeeperServer(zks);
     }
 
     @Override
diff --git a/src/java/test/org/apache/zookeeper/server/ZooKeeperServerMainTest.java b/src/java/test/org/apache/zookeeper/server/ZooKeeperServerMainTest.java
index 3c15bc3f5..29019d13a 100644
--- a/src/java/test/org/apache/zookeeper/server/ZooKeeperServerMainTest.java
+++ b/src/java/test/org/apache/zookeeper/server/ZooKeeperServerMainTest.java
@@ -334,6 +334,77 @@ private void verifySessionTimeOut(int sessionTimeout,
         zk.close();
     }
 
+    @Test
+    public void testJMXRegistrationWithNIO() throws Exception {
+        ClientBase.setupTestEnv();
+        File tmpDir_1 = ClientBase.createTmpDir();
+        ServerCnxnFactory server_1 = startServer(tmpDir_1);
+        File tmpDir_2 = ClientBase.createTmpDir();
+        ServerCnxnFactory server_2 = startServer(tmpDir_2);
+
+        server_1.shutdown();
+        server_2.shutdown();
+
+        deleteFile(tmpDir_1);
+        deleteFile(tmpDir_2);
+    }
+
+    @Test
+    public void testJMXRegistrationWithNetty() throws Exception {
+        String originalServerCnxnFactory = System
+                .getProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY);
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY,
+                NettyServerCnxnFactory.class.getName());
+        try {
+            ClientBase.setupTestEnv();
+            File tmpDir_1 = ClientBase.createTmpDir();
+            ServerCnxnFactory server_1 = startServer(tmpDir_1);
+            File tmpDir_2 = ClientBase.createTmpDir();
+            ServerCnxnFactory server_2 = startServer(tmpDir_2);
+
+            server_1.shutdown();
+            server_2.shutdown();
+
+            deleteFile(tmpDir_1);
+            deleteFile(tmpDir_2);
+        } finally {
+            // setting back
+            if (originalServerCnxnFactory == null
+                    || originalServerCnxnFactory.isEmpty()) {
+                System.clearProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY);
+            } else {
+                System.setProperty(
+                        ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY,
+                        originalServerCnxnFactory);
+            }
+        }
+    }
+
+    private void deleteFile(File f) throws IOException {
+        if (f.isDirectory()) {
+            for (File c : f.listFiles())
+                deleteFile(c);
+        }
+        if (!f.delete())
+            // double check for the file existence
+            if (f.exists()) {
+                throw new IOException("Failed to delete file: " + f);
+            }
+    }
+
+    private ServerCnxnFactory startServer(File tmpDir) throws IOException,
+            InterruptedException {
+        final int CLIENT_PORT = PortAssignment.unique();
+        ZooKeeperServer zks = new ZooKeeperServer(tmpDir, tmpDir, 3000);
+        ServerCnxnFactory f = ServerCnxnFactory.createFactory(CLIENT_PORT, -1);
+        f.startup(zks);
+        Assert.assertNotNull("JMX initialization failed!", zks.jmxServerBean);
+        Assert.assertTrue("waiting for server being up",
+                ClientBase.waitForServerUp("127.0.0.1:" + CLIENT_PORT,
+                        CONNECTION_TIMEOUT));
+        return f;
+    }
+
     public void process(WatchedEvent event) {
         if (event.getState() == KeeperState.SyncConnected) {
             clientConnected.countDown();
