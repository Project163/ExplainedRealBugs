diff --git a/CHANGES.txt b/CHANGES.txt
index 980d44b52..c2694876e 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -471,6 +471,9 @@ BUGFIXES:
   ZOOKEEPER-1798. Fix race condition in testNormalObserverRun
   (thawan, fpj via thawan)
 
+  ZOOKEEPER-1783. Distinguish initial configuration from first established
+  configuration (shralex via breed)
+
 IMPROVEMENTS:
 
   ZOOKEEPER-1170. Fix compiler (eclipse) warnings: unused imports,
diff --git a/src/c/tests/TestReconfigServer.cc b/src/c/tests/TestReconfigServer.cc
index a847b374a..6a429ac82 100644
--- a/src/c/tests/TestReconfigServer.cc
+++ b/src/c/tests/TestReconfigServer.cc
@@ -154,7 +154,9 @@ testRemoveFollower() {
 
     // check if all the servers are listed in the config.
     parseConfig(buf, len, servers, version);
-    CPPUNIT_ASSERT_EQUAL(std::string("0"), version);
+    // initially should be 1<<32, which is 0x100000000. This is the zxid
+    // of the first NEWLEADER message, used as the initial version
+    CPPUNIT_ASSERT_EQUAL(std::string("100000000"), version);
     CPPUNIT_ASSERT_EQUAL(NUM_SERVERS, (uint32_t)(servers.size()));
     for (int i = 0; i < cluster_.size(); i++) {
         CPPUNIT_ASSERT(std::find(servers.begin(), servers.end(),
@@ -220,7 +222,9 @@ testNonIncremental() {
 
     // check if all the servers are listed in the config.
     parseConfig(buf, len, servers, version);
-    CPPUNIT_ASSERT_EQUAL(std::string("0"), version);
+    // initially should be 1<<32, which is 0x100000000. This is the zxid
+    // of the first NEWLEADER message, used as the initial version
+    CPPUNIT_ASSERT_EQUAL(std::string("100000000"), version);
     CPPUNIT_ASSERT_EQUAL(NUM_SERVERS, (uint32_t)(servers.size()));
     for (int i = 0; i < cluster_.size(); i++) {
         CPPUNIT_ASSERT(std::find(servers.begin(), servers.end(),
diff --git a/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java b/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java
index 021ddc20b..9876c3d66 100644
--- a/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java
+++ b/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java
@@ -266,19 +266,22 @@ public void run() {
                                                        
                            synchronized(self){                             
                                try {
-                                   rqv = self.configFromString(new String(b));                                             
-                                   if (rqv.getVersion() > self.getQuorumVerifier().getVersion()) {
+                                   rqv = self.configFromString(new String(b));
+                                   QuorumVerifier curQV = self.getQuorumVerifier();
+                                   if (rqv.getVersion() > curQV.getVersion()) {
                                        LOG.info(self.getId() + " Received version: " + Long.toHexString(rqv.getVersion()) + " my version: " + Long.toHexString(self.getQuorumVerifier().getVersion()));
                                        self.processReconfig(rqv, null, null, false);
-                                       LOG.info("restarting leader election");
-                                       self.shuttingDownLE = true;
-                                       self.getElectionAlg().shutdown();
+                                       if (!rqv.equals(curQV)) {
+                                           LOG.info("restarting leader election");
+                                           self.shuttingDownLE = true;
+                                           self.getElectionAlg().shutdown();
+                                       }
                                    }           
                                } catch (IOException e) {                         
                                    LOG.error("Something went wrong while processing config received from " + response.sid);
                                } catch (ConfigException e) {
                                    LOG.error("Something went wrong while processing config received from " + response.sid);
-							   } 
+                               } 
                           }                                                       
                         } else {
                             if(LOG.isInfoEnabled()){
diff --git a/src/java/main/org/apache/zookeeper/server/quorum/Leader.java b/src/java/main/org/apache/zookeeper/server/quorum/Leader.java
index 48509bb15..e8c9183bc 100644
--- a/src/java/main/org/apache/zookeeper/server/quorum/Leader.java
+++ b/src/java/main/org/apache/zookeeper/server/quorum/Leader.java
@@ -479,6 +479,37 @@ void lead() throws IOException, InterruptedException {
                         + Long.toHexString(newLeaderProposal.packet.getZxid()));
             }
 
+            QuorumVerifier lastSeenQV = self.getLastSeenQuorumVerifier();
+            QuorumVerifier curQV = self.getQuorumVerifier();
+            if (curQV.getVersion() == 0 && curQV.getVersion() == lastSeenQV.getVersion()) {
+                // This was added in ZOOKEEPER-1783. The initial config has version 0 (not explicitly
+                // specified by the user; the lack of version in a config file is interpreted as version=0). 
+                // As soon as a config is established we would like to increase its version so that it
+                // takes presedence over other initial configs that were not established (such as a config
+                // of a server trying to join the ensemble, which may be a partial view of the system, not the full config). 
+                // We chose to set the new version to the one of the NEWLEADER message. However, before we can do that
+                // there must be agreement on the new version, so we can only change the version when sending/receiving UPTODATE,
+                // not when sending/receiving NEWLEADER. In other words, we can't change curQV here since its the committed quorum verifier, 
+                // and there's still no agreement on the new version that we'd like to use. Instead, we use 
+                // lastSeenQuorumVerifier which is being sent with NEWLEADER message
+                // so its a good way to let followers know about the new version. (The original reason for sending 
+                // lastSeenQuorumVerifier with NEWLEADER is so that the leader completes any potentially uncommitted reconfigs
+                // that it finds before starting to propose operations. Here we're reusing the same code path for 
+                // reaching consensus on the new version number.)
+                
+                // It is important that this is done before the leader executes waitForEpochAck,
+                // so before LearnerHandlers return from their waitForEpochAck
+                // hence before they construct the NEWLEADER message containing
+                // the last-seen-quorumverifier of the leader, which we change below
+               try {
+                   QuorumVerifier newQV = self.configFromString(curQV.toString());
+                   newQV.setVersion(zk.getZxid());
+                   self.setLastSeenQuorumVerifier(newQV, true);    
+               } catch (Exception e) {
+                   throw new IOException(e);
+               }
+            }
+            
             newLeaderProposal.addQuorumVerifier(self.getQuorumVerifier());
             if (self.getLastSeenQuorumVerifier().getVersion() > self.getQuorumVerifier().getVersion()){
                newLeaderProposal.addQuorumVerifier(self.getLastSeenQuorumVerifier());
diff --git a/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java b/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java
index 148f1ba89..78e9520ce 100644
--- a/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java
+++ b/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java
@@ -918,6 +918,11 @@ public void run() {
                         };
                         try {
                             roZkMgr.start();
+                            reconfigFlagClear();
+                            if (shuttingDownLE) {
+                                shuttingDownLE = false;
+                                startLeaderElection();
+                            }
                             setCurrentVote(makeLEStrategy().lookForLeader());
                         } catch (Exception e) {
                             LOG.warn("Unexpected exception", e);
@@ -1292,14 +1297,23 @@ public synchronized QuorumVerifier setQuorumVerifier(QuorumVerifier qv, boolean
        if (lastSeenQuorumVerifier == null || (qv.getVersion() > lastSeenQuorumVerifier.getVersion()))
            lastSeenQuorumVerifier = qv;
         if (writeToDisk) {
-            try {
-                QuorumPeerConfig.writeDynamicConfig(dynamicConfigFilename, configFilename, configBackwardCompatibility, qv);
-                if (configBackwardCompatibility) {
-                    dynamicConfigFilename = configFilename + ".dynamic";
-                    configBackwardCompatibility = false;
+                // we need to write the dynamic config file. Either it already exists
+                // or we have the old-style config file and we're in the backward compatibility mode,
+                // so we'll create the dynamic config file for the first time now
+                if (dynamicConfigFilename !=null || (configFilename !=null && configBackwardCompatibility)) { 
+                try {
+                    QuorumPeerConfig.writeDynamicConfig(dynamicConfigFilename, configFilename, configBackwardCompatibility, qv);
+                    if (configBackwardCompatibility) {
+                        dynamicConfigFilename = configFilename + ".dynamic";
+                        configBackwardCompatibility = false;
+                    }
+                } catch(IOException e){
+                    LOG.error("Error closing file: ", e.getMessage());     
                 }
-            } catch(IOException e){
-                LOG.error("Error closing file: ", e.getMessage());     
+            } else {
+                LOG.error("writeToDisk == true but dynamicConfigFilename == null, configFilename "
+                          + (configFilename == null ? "== null": "!=null")
+                          + " and configBackwardCompatibility == " + configBackwardCompatibility);
             }
         }
 
@@ -1529,7 +1543,7 @@ public boolean processReconfig(QuorumVerifier qv, Long suggestedLeaderId, Long z
        // for Learner):
        initConfigInZKDatabase();
 
-       if (prevQV.getVersion() < qv.getVersion()) {
+       if (prevQV.getVersion() < qv.getVersion() && !prevQV.equals(qv)) {
            if (restartLE) restartLeaderElection(prevQV, qv);
 
            QuorumServer myNewQS = qv.getAllMembers().get(getId());
@@ -1545,12 +1559,10 @@ public boolean processReconfig(QuorumVerifier qv, Long suggestedLeaderId, Long z
                leaderChange = updateVote(suggestedLeaderId, zxid);
            } else {
                long currentLeaderId = getCurrentVote().getId();
-               InetSocketAddress currentLeaderAddr = prevQV.getVotingMembers()
-                       .get(currentLeaderId).addr;
-               leaderChange = (!qv.getVotingMembers().containsKey(
-                       currentLeaderId))
-                       || (!qv.getVotingMembers().get(currentLeaderId).addr
-                               .equals(currentLeaderAddr));
+               QuorumServer myleaderInCurQV = prevQV.getVotingMembers().get(currentLeaderId);
+               QuorumServer myleaderInNewQV = qv.getVotingMembers().get(currentLeaderId);
+               leaderChange = (myleaderInCurQV == null || myleaderInCurQV.addr == null || 
+                               myleaderInNewQV == null || !myleaderInCurQV.addr.equals(myleaderInNewQV.addr));
                // we don't have a designated leader - need to go into leader
                // election
                reconfigFlagClear();
diff --git a/src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java b/src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java
index 7092059ed..5f92a8f3d 100644
--- a/src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java
+++ b/src/java/test/org/apache/zookeeper/server/quorum/ReconfigRecoveryTest.java
@@ -55,7 +55,7 @@ public void testNextConfigCompletion() throws Exception {
                sb.append(server +"\n");
                if (i == 1) currentQuorumCfgSection = sb.toString();
         }
-        sb.append("version=1\n"); // version of current config is 0
+        sb.append("version=200000000\n"); // version of current config is 100000000
         nextQuorumCfgSection = sb.toString();
         
         // Both servers 0 and 1 will have the .next config file, which means
@@ -170,7 +170,7 @@ public void testCurrentServersAreObserversInNextConfig() throws Exception {
             sb.append(server +"\n");
            
         }
-        sb.append("version=1\n"); // version of current config is 0
+        sb.append("version=200000000\n"); // version of current config is 100000000
         nextQuorumCfgSection = sb.toString();
         
         MainThread mt[] = new MainThread[SERVER_COUNT];
@@ -236,7 +236,7 @@ public void testNextConfigUnreachable() throws Exception {
                sb.append(server +"\n");
                if (i == 1) currentQuorumCfgSection = sb.toString();
         }
-        sb.append("version=1\n"); // version of current config is 0
+        sb.append("version=200000000\n"); // version of current config is 100000000
         nextQuorumCfgSection = sb.toString();
         
         // lets start servers 2, 3, 4 with the new config
@@ -294,7 +294,7 @@ public void testNextConfigAlreadyActive() throws Exception {
                sb.append(server +"\n");
                if (i == 1) currentQuorumCfgSection = sb.toString();
         }
-        sb.append("version=1\n"); // version of current config is 0
+        sb.append("version=200000000\n"); // version of current config is 100000000
         nextQuorumCfgSection = sb.toString();
         
         // lets start servers 2, 3, 4 with the new config
diff --git a/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java b/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java
index 73bbc1518..b605bea9e 100644
--- a/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java
+++ b/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java
@@ -805,6 +805,7 @@ public void converseWithFollower(InputArchive ia, OutputArchive oa,
                     oa.writeRecord(qp, null);
                     qp.setType(Leader.NEWLEADER);
                     qp.setZxid(ZxidUtils.makeZxid(1, 0));
+                    qp.setData(null);
                     oa.writeRecord(qp, null);
                     qp.setType(Leader.UPTODATE);
                     qp.setZxid(0);
@@ -1225,9 +1226,6 @@ private LeaderZooKeeperServer prepareLeader(File tmpDir, QuorumPeer peer)
             throws IOException, NoSuchFieldException, IllegalAccessException {
         FileTxnSnapLog logFactory = new FileTxnSnapLog(tmpDir, tmpDir);
         peer.setTxnFactory(logFactory);
-        Field addrField = peer.getClass().getDeclaredField("myQuorumAddr");
-        addrField.setAccessible(true);
-        addrField.set(peer, new InetSocketAddress(PortAssignment.unique()));
         ZKDatabase zkDb = new ZKDatabase(logFactory);
         LeaderZooKeeperServer zk = new LeaderZooKeeperServer(logFactory, peer, zkDb);
         return zk;
diff --git a/src/java/test/org/apache/zookeeper/test/ReconfigTest.java b/src/java/test/org/apache/zookeeper/test/ReconfigTest.java
index eb8e2e4a3..52cf3f49c 100644
--- a/src/java/test/org/apache/zookeeper/test/ReconfigTest.java
+++ b/src/java/test/org/apache/zookeeper/test/ReconfigTest.java
@@ -38,9 +38,7 @@
 import org.apache.zookeeper.server.quorum.flexible.QuorumHierarchical;
 import org.apache.zookeeper.server.quorum.flexible.QuorumMaj;
 import org.apache.zookeeper.server.quorum.flexible.QuorumVerifier;
-import org.junit.After;
 import org.junit.Assert;
-import org.junit.Before;
 import org.junit.Test;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -49,22 +47,6 @@ public class ReconfigTest extends ZKTestCase implements DataCallback{
     private static final Logger LOG = LoggerFactory
             .getLogger(ReconfigTest.class);
 
-    private final QuorumBase qb = new QuorumBase();
-    private final ClientTest ct = new ClientTest();
-
-    @Before
-    public void setUp() throws Exception {
-        qb.setUp();
-        ct.hostPort = qb.hostPort;
-        ct.setUpAll();
-    }
-
-    @After
-    public void tearDown() throws Exception {
-        ct.tearDownAll();
-        qb.tearDown();
-    }
-
     private String reconfig(ZooKeeper zk, List<String> joiningServers,
             List<String> leavingServers, List<String> newMembers, long fromConfig)
             throws KeeperException, InterruptedException {
@@ -714,4 +696,19 @@ public void testQuorumSystemChange() throws Exception {
 
         closeAllHandles(zkArr);
     }
+    
+    @Test
+    public void testInitialConfigHasPositiveVersion() throws Exception {
+        QuorumUtil qu = new QuorumUtil(1); // create 3 servers
+        qu.disableJMXTest = true;
+        qu.startAll();
+        ZooKeeper[] zkArr = createHandles(qu);
+        testNormalOperation(zkArr[1], zkArr[2]);
+        for (int i=1; i<4; i++) {
+            String configStr = testServerHasConfig(zkArr[i], null, null);
+            QuorumVerifier qv = qu.getPeer(i).peer.configFromString(configStr);
+            long version = qv.getVersion();
+            Assert.assertTrue(version == 0x100000000L);
+        }
+    }
 }
