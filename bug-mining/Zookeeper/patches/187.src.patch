diff --git a/CHANGES.txt b/CHANGES.txt
index 68df39957..545cfc9bd 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -148,6 +148,9 @@ BUGFIXES:
   ZOOKEEPER-597. ASyncHammerTest is failing intermittently on hudson trunk
   (take 4) (breed via mahadev)
 
+  ZOOKEEPER-597. ASyncHammerTest is failing intermittently on hudson trunk 
+  (take 5) (mahadev)
+
 IMPROVEMENTS:
   ZOOKEEPER-473. cleanup junit tests to eliminate false positives due to
   "socket reuse" and failure to close client (phunt via mahadev)
diff --git a/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java b/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java
index 52fab056f..dc3ba1fb9 100644
--- a/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java
+++ b/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java
@@ -77,6 +77,17 @@ public void uncaughtException(Thread t, Throwable e) {
                 LOG.error("Thread " + t + " died", e);
             }
         });
+        
+        /**
+         * this is to avoid the jvm bug:
+         * NullPointerException in Selector.open()
+         * http://bugs.sun.com/view_bug.do?bug_id=6427854
+         */
+        try {
+        	Selector.open().close();
+        } catch(IOException ie) {
+        	LOG.error("Exception while opening a selector", ie);
+        }
     }
 
     static public class Factory extends Thread {
@@ -350,36 +361,40 @@ public void sendCloseSession() {
     }
 
     void sendBuffer(ByteBuffer bb) {
-        if (bb != closeConn) {
-            // We check if write interest here because if it is NOT set,
-            // nothing is queued, so we can try to send the buffer right
-            // away without waking up the selector
-            if ((sk.interestOps() & SelectionKey.OP_WRITE) == 0) {
-                try {
-                    sock.write(bb);
-                } catch (IOException e) {
-                    // we are just doing best effort right now
+        try {
+            if (bb != closeConn) {
+                // We check if write interest here because if it is NOT set,
+                // nothing is queued, so we can try to send the buffer right
+                // away without waking up the selector
+                if ((sk.interestOps() & SelectionKey.OP_WRITE) == 0) {
+                    try {
+                        sock.write(bb);
+                    } catch (IOException e) {
+                        // we are just doing best effort right now
+                    }
+                }
+                // if there is nothing left to send, we are done
+                if (bb.remaining() == 0) {
+                    packetSent();
+                    return;
                 }
             }
-            // if there is nothing left to send, we are done
-            if (bb.remaining() == 0) {
-                packetSent();
-                return;
-            }
-        }
-        synchronized (factory) {
-            sk.selector().wakeup();
-            if (LOG.isTraceEnabled()) {
-                LOG.trace("Add a buffer to outgoingBuffers, sk " + sk
-                        + " is valid: " + sk.isValid());
-            }
-            outgoingBuffers.add(bb);
-            if (sk.isValid()) {
-                sk.interestOps(sk.interestOps() | SelectionKey.OP_WRITE);
+            synchronized (factory) {
+                sk.selector().wakeup();
+                if (LOG.isTraceEnabled()) {
+                    LOG.trace("Add a buffer to outgoingBuffers, sk " + sk
+                            + " is valid: " + sk.isValid());
+                }
+                outgoingBuffers.add(bb);
+                if (sk.isValid()) {
+                    sk.interestOps(sk.interestOps() | SelectionKey.OP_WRITE);
+                }
             }
+        } catch(Exception e) {
+            LOG.error("Unexpected Exception: ", e);
         }
     }
-
+    
     private static class CloseRequestException extends IOException {
         private static final long serialVersionUID = -7854505709816442681L;
 
