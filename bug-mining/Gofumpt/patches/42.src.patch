diff --git a/flag.go b/flag.go
index 17c6436..27d614d 100644
--- a/flag.go
+++ b/flag.go
@@ -8,6 +8,7 @@ import "flag"
 var (
 	langVersion = flag.String("lang", "", "target Go version in the form 1.X (default from go.mod)")
 	extraRules  = flag.Bool("extra", false, "enable extra rules which should be vetted by a human")
+	showVersion = flag.Bool("version", false, "show version and exit")
 )
 
 func init() {
diff --git a/format/format.go b/format/format.go
index 9b336e4..4711e13 100644
--- a/format/format.go
+++ b/format/format.go
@@ -25,6 +25,8 @@ import (
 	"github.com/google/go-cmp/cmp"
 	"golang.org/x/mod/semver"
 	"golang.org/x/tools/go/ast/astutil"
+
+	"mvdan.cc/gofumpt/internal/version"
 )
 
 type Options struct {
@@ -373,6 +375,17 @@ func (f *fumpter) applyPre(c *astutil.Cursor) {
 	groupLoop:
 		for _, group := range node.Comments {
 			for _, comment := range group.List {
+				if comment.Text == "//gofumpt:diagnose" || strings.HasPrefix(comment.Text, "//gofumpt:diagnose ") {
+					slc := []string{
+						"//gofumpt:diagnose",
+						version.String(),
+						"-lang=" + f.LangVersion,
+					}
+					if f.ExtraRules {
+						slc = append(slc, "-extra")
+					}
+					comment.Text = strings.Join(slc, " ")
+				}
 				body := strings.TrimPrefix(comment.Text, "//")
 				if body == comment.Text {
 					// /*-style comment
@@ -394,7 +407,7 @@ func (f *fumpter) applyPre(c *astutil.Cursor) {
 				body := strings.TrimPrefix(comment.Text, "//")
 				r, _ := utf8.DecodeRuneInString(body)
 				if !unicode.IsSpace(r) {
-					comment.Text = "// " + strings.TrimPrefix(comment.Text, "//")
+					comment.Text = "// " + body
 				}
 			}
 		}
diff --git a/gofmt.go b/gofmt.go
index d6366ff..b24e733 100644
--- a/gofmt.go
+++ b/gofmt.go
@@ -24,6 +24,7 @@ import (
 
 	gformat "mvdan.cc/gofumpt/format"
 	"mvdan.cc/gofumpt/internal/diff"
+	"mvdan.cc/gofumpt/internal/version"
 )
 
 var (
@@ -217,7 +218,7 @@ func gofumptMain() {
 
 	// Print the gofumpt version if the user asks for it.
 	if *showVersion {
-		printVersion()
+		version.Print()
 		return
 	}
 
diff --git a/version.go b/internal/version/version.go
similarity index 57%
rename from version.go
rename to internal/version/version.go
index b70ee78..3ec8830 100644
--- a/version.go
+++ b/internal/version/version.go
@@ -1,21 +1,20 @@
 // Copyright (c) 2020, Daniel Mart√≠ <mvdan@mvdan.cc>
 // See LICENSE for licensing information
 
-package main
+package version
 
 import (
-	"flag"
 	"fmt"
+	"os"
 	"runtime/debug"
 )
 
-var (
-	showVersion = flag.Bool("version", false, "show version and exit")
+var version = "(devel)" // to match the default from runtime/debug
 
-	version = "(devel)" // to match the default from runtime/debug
-)
-
-func printVersion() {
+func String() string {
+	if testVersion := os.Getenv("GOFUMPT_VERSION_TEST"); testVersion != "" {
+		return testVersion
+	}
 	// don't overwrite the version if it was set by -ldflags=-X
 	if info, ok := debug.ReadBuildInfo(); ok && version == "(devel)" {
 		mod := &info.Main
@@ -24,5 +23,9 @@ func printVersion() {
 		}
 		version = mod.Version
 	}
-	fmt.Println(version)
+	return version
+}
+
+func Print() {
+	fmt.Println(String())
 }
diff --git a/testdata/scripts/diagnose.txt b/testdata/scripts/diagnose.txt
new file mode 100644
index 0000000..011844a
--- /dev/null
+++ b/testdata/scripts/diagnose.txt
@@ -0,0 +1,42 @@
+cp foo.go foo.go.orig
+env GOFUMPT_VERSION_TEST=v0.1.1-0.20210524140936-ba6406b58f36
+
+gofumpt -w foo.go
+cmp foo.go foo.go.golden
+
+gofumpt -w outdated.go
+cmp outdated.go foo.go.golden
+
+cp foo.go.orig foo.go
+gofumpt -w -extra foo.go
+cmp foo.go foo.go.golden-extra
+
+gofumpt -d nochange.go
+! stdout .
+
+gofumpt -d foo.go.golden
+! stdout .
+
+gofumpt -d -extra foo.go.golden-extra
+! stdout .
+
+-- foo.go --
+package p
+
+//gofumpt:diagnose
+-- outdated.go --
+package p
+
+//gofumpt:diagnose v0.1.0
+-- nochange.go --
+package p
+
+//gofumpt:diagnosefoobar
+-- foo.go.golden --
+package p
+
+//gofumpt:diagnose v0.1.1-0.20210524140936-ba6406b58f36 -lang=v1
+-- foo.go.golden-extra --
+package p
+
+//gofumpt:diagnose v0.1.1-0.20210524140936-ba6406b58f36 -lang=v1 -extra
