{"url":"https://api.github.com/repos/mvdan/gofumpt/issues/288","repository_url":"https://api.github.com/repos/mvdan/gofumpt","labels_url":"https://api.github.com/repos/mvdan/gofumpt/issues/288/labels{/name}","comments_url":"https://api.github.com/repos/mvdan/gofumpt/issues/288/comments","events_url":"https://api.github.com/repos/mvdan/gofumpt/issues/288/events","html_url":"https://github.com/mvdan/gofumpt/issues/288","id":1958691855,"node_id":"I_kwDOCqWoQc50v0QP","number":288,"title":"panic while handling some //line directives","user":{"login":"flimzy","id":8555063,"node_id":"MDQ6VXNlcjg1NTUwNjM=","avatar_url":"https://avatars.githubusercontent.com/u/8555063?v=4","gravatar_id":"","url":"https://api.github.com/users/flimzy","html_url":"https://github.com/flimzy","followers_url":"https://api.github.com/users/flimzy/followers","following_url":"https://api.github.com/users/flimzy/following{/other_user}","gists_url":"https://api.github.com/users/flimzy/gists{/gist_id}","starred_url":"https://api.github.com/users/flimzy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/flimzy/subscriptions","organizations_url":"https://api.github.com/users/flimzy/orgs","repos_url":"https://api.github.com/users/flimzy/repos","events_url":"https://api.github.com/users/flimzy/events{/privacy}","received_events_url":"https://api.github.com/users/flimzy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-10-24T07:43:25Z","updated_at":"2024-01-28T16:17:20Z","closed_at":"2024-01-28T16:16:56Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Parsing of [this file](https://github.com/grafana/loki/blob/065bee7e72b00d800431f4b70f0d673d6e0e7a2b/pkg/logql/log/pattern/lexer.rl.go) causes gofumpt to panic.  It appears to be related to `//line` directives.\r\n\r\n```\r\n$ gofumpt -w pkg/logql/log/pattern/lexer.rl.go \r\npanic: invalid line number 4 (should be < 4) [recovered]\r\n        panic: invalid line number 4 (should be < 4)\r\n\r\ngoroutine 8 [running]:\r\ngolang.org/x/tools/go/ast/astutil.Apply.func1()\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:48 +0xab\r\npanic({0x66f1e0?, 0xc00002d600?})\r\n        /usr/local/go/src/runtime/panic.go:914 +0x21f\r\ngo/token.(*File).MergeLine(0xc0000829c0, 0xc000128140?)\r\n        /usr/local/go/src/go/token/position.go:152 +0x1c8\r\nmvdan.cc/gofumpt/format.(*fumpter).removeLines(...)\r\n        /home/jonhall/src/gofumpt/format/format.go:249\r\nmvdan.cc/gofumpt/format.(*fumpter).removeLinesBetween(0xc00008dd60, 0xc00002d420?, 0x1038?)\r\n        /home/jonhall/src/gofumpt/format/format.go:257 +0x13f\r\nmvdan.cc/gofumpt/format.(*fumpter).applyPre(0xc00008dd60, 0xc000082a30)\r\n        /home/jonhall/src/gofumpt/format/format.go:545 +0x7b2\r\nmvdan.cc/gofumpt/format.File.func1(0xc000082a30)\r\n        /home/jonhall/src/gofumpt/format/format.go:109 +0x34\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x723e98?, 0xc000136300?}, {0x6bf529?, 0x0?}, 0x0?, {0x723998?, 0xc0001362d0?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:199 +0x1aa\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x723998?, 0xc000136330?}, {0x6bf69d?, 0x1?}, 0x1?, {0x723e98?, 0xc000136300?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:368 +0x187b\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc000082a20, {0x723998?, 0xc000136330}, {0x6bf69d, 0x4})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:484 +0xa5\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x723f38?, 0xc000132c80?}, {0x6bf529?, 0x0?}, 0x0?, {0x723998?, 0xc000136330?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:353 +0x15a5\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x723998?, 0xc000136570?}, {0x6bf69d?, 0x4b850e?}, 0x698d20?, {0x723f38?, 0xc000132c80?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:386 +0x1bdb\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc000082a20, {0x723998?, 0xc000136570}, {0x6bf69d, 0x4})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:484 +0xa5\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x723998?, 0xc0001365a0?}, {0x6bf69d?, 0x1?}, 0x1?, {0x723998?, 0xc000136570?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:353 +0x15a5\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc000082a20, {0x723998?, 0xc0001365a0}, {0x6bf69d, 0x4})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:484 +0xa5\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x724050?, 0xc0001365d0?}, {0x6bf529?, 0x0?}, 0x0?, {0x723998?, 0xc0001365a0?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:353 +0x15a5\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x724078?, 0xc0000d46e0?}, {0x6bf95e?, 0x40d1da?}, 0x34?, {0x724050?, 0xc0001365d0?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:429 +0x225d\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc000082a20, {0x724078?, 0xc0000d46e0}, {0x6bf95e, 0x5})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:484 +0xa5\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc000082a20, {0x7242d8?, 0xc00002d5e0?}, {0x6bf699?, 0x697fe0?}, 0xc000129cb0?, {0x724078?, 0xc0000d46e0?})\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:435 +0x230e\r\ngolang.org/x/tools/go/ast/astutil.Apply({0x724078?, 0xc0000d46e0}, 0xc000010c78, 0xc000010c90)\r\n        /home/jonhall/go/pkg/mod/golang.org/x/tools@v0.9.3/go/ast/astutil/rewrite.go:53 +0x152\r\nmvdan.cc/gofumpt/format.File(0xc00009e640, 0xc0000d46e0, {{0xc000012f58, 0x5}, {0xc00001a360, 0x17}, 0x0})\r\n        /home/jonhall/src/gofumpt/format/format.go:157 +0x2d7\r\nmain.processFile({0x7ffe5617be4a, 0x21}, {0x725828, 0xc0000964e0}, {0x0?, 0x0?}, 0x0?, 0x1)\r\n        /home/jonhall/src/gofumpt/gofmt.go:313 +0x308\r\nmain.gofmtMain.func3(0x0?)\r\n        /home/jonhall/src/gofumpt/gofmt.go:508 +0x34\r\nmain.(*sequencer).Add.func2()\r\n        /home/jonhall/src/gofumpt/gofmt.go:191 +0x42\r\ncreated by main.(*sequencer).Add in goroutine 1\r\n        /home/jonhall/src/gofumpt/gofmt.go:190 +0x1ae\r\n```","closed_by":{"login":"mvdan","id":3576549,"node_id":"MDQ6VXNlcjM1NzY1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/3576549?v=4","gravatar_id":"","url":"https://api.github.com/users/mvdan","html_url":"https://github.com/mvdan","followers_url":"https://api.github.com/users/mvdan/followers","following_url":"https://api.github.com/users/mvdan/following{/other_user}","gists_url":"https://api.github.com/users/mvdan/gists{/gist_id}","starred_url":"https://api.github.com/users/mvdan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvdan/subscriptions","organizations_url":"https://api.github.com/users/mvdan/orgs","repos_url":"https://api.github.com/users/mvdan/repos","events_url":"https://api.github.com/users/mvdan/events{/privacy}","received_events_url":"https://api.github.com/users/mvdan/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mvdan/gofumpt/issues/288/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mvdan/gofumpt/issues/288/timeline","performed_via_github_app":null,"state_reason":"completed"}