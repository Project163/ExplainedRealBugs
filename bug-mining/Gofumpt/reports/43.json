{"url":"https://api.github.com/repos/mvdan/gofumpt/issues/149","repository_url":"https://api.github.com/repos/mvdan/gofumpt","labels_url":"https://api.github.com/repos/mvdan/gofumpt/issues/149/labels{/name}","comments_url":"https://api.github.com/repos/mvdan/gofumpt/issues/149/comments","events_url":"https://api.github.com/repos/mvdan/gofumpt/issues/149/events","html_url":"https://github.com/mvdan/gofumpt/issues/149","id":998659578,"node_id":"I_kwDOCqWoQc47hlX6","number":149,"title":"format: panic when using type parameters (via gopls)","user":{"login":"leitzler","id":3111805,"node_id":"MDQ6VXNlcjMxMTE4MDU=","avatar_url":"https://avatars.githubusercontent.com/u/3111805?v=4","gravatar_id":"","url":"https://api.github.com/users/leitzler","html_url":"https://github.com/leitzler","followers_url":"https://api.github.com/users/leitzler/followers","following_url":"https://api.github.com/users/leitzler/following{/other_user}","gists_url":"https://api.github.com/users/leitzler/gists{/gist_id}","starred_url":"https://api.github.com/users/leitzler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leitzler/subscriptions","organizations_url":"https://api.github.com/users/leitzler/orgs","repos_url":"https://api.github.com/users/leitzler/repos","events_url":"https://api.github.com/users/leitzler/events{/privacy}","received_events_url":"https://api.github.com/users/leitzler/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-09-16T21:33:50Z","updated_at":"2021-10-04T16:06:24Z","closed_at":"2021-10-02T15:39:02Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"```bash\r\n$ go version\r\ngo version devel go1.18-b1bedc0774 Thu Sep 16 17:44:44 2021 +0000 darwin/amd64\r\n$ go list -m mvdan.cc/gofumpt golang.org/x/tools golang.org/x/tools/gopls\r\nmvdan.cc/gofumpt v0.1.1\r\ngolang.org/x/tools v0.1.6-0.20210902182115-3b801c8b8389\r\ngolang.org/x/tools/gopls v0.0.0-20210902182115-3b801c8b8389\r\n```\r\n\r\nUsing `gofumpt` via `gopls` and saving a file that includes a function call with type parameters:\r\n\r\n```go\r\npackage main\r\n\r\nfunc Foo[A, B any](x A, y B) {}\r\n\r\nfunc main() {\r\n    Foo[int,int](1,2)\r\n    log.Println(\"\") // <- note that \"log\" isn't imported\r\n}\r\n``` \r\n\r\nResults in a panic in `x/tools`:\r\n```\r\nPanic: Apply: unexpected node type *ast.IndexListExpr [recovered]\r\n   panic: Apply: unexpected node type *ast.IndexListExpr\r\n\r\ngoroutine 1045 [running]:\r\ngolang.org/x/tools/go/ast/astutil.Apply.func1()\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:49 +0x89\r\npanic({0x180f560, 0xc001101130})\r\n   /Users/leitzler/sdk/gotip/src/runtime/panic.go:814 +0x207\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc0022a8de0, {0x1a90988, 0xc00168d900}, {0x191c701, 0x0}, 0xc00258cb00, {0x1a90e88, 0xc00168d840})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:447 +0x2a74\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc0022a8de0, {0x1a907d0, 0xc00168d940}, {0x191c827, 0x0}, 0x0, {0x1a90988, 0xc00168d900})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:267 +0x233b\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc0022a8de0, {0x1a907d0, 0xc00168d940}, {0x191c827, 0x3})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:481 +0xae\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc0022a8de0, {0x1a90938, 0xc001f1cdb0}, {0x191d239, 0x9}, 0x8, {0x1a907d0, 0xc00168d940})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:332 +0x81c\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc0022a8de0, {0x1a90938, 0xc001f1cdb0}, {0x191d239, 0x4})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:481 +0xae\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc0022a8de0, {0x1a90ca8, 0xc001f1ce10}, {0x191cfe5, 0x0}, 0xc00258d170, {0x1a90938, 0xc001f1cdb0})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:347 +0x310\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc0022a8de0, {0x1a90c58, 0xc00196a000}, {0x191e1a4, 0x1fb}, 0x25, {0x1a90ca8, 0xc001f1ce10})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:420 +0x18c9\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc0022a8de0, {0x1a90c58, 0xc00196a000}, {0x191e1a4, 0x5})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:481 +0xae\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc0022a8de0, {0x1a92008, 0xc001101120}, {0x191d2b9, 0x29ac0770}, 0x10, {0x1a90c58, 0xc00196a000})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:426 +0xc31\r\ngolang.org/x/tools/go/ast/astutil.Apply({0x1a90c58, 0xc00196a000}, 0xc001101100, 0xc001101110)\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/go/ast/astutil/rewrite.go:54 +0x166\r\nmvdan.cc/gofumpt/format.File(0xc00168cdc0, 0xc00196a000, {{0x0, 0x18055e0}, 0x20})\r\n   /Users/leitzler/go/pkg/mod/mvdan.cc/gofumpt@v0.1.1/format/format.go:95 +0x245\r\nmvdan.cc/gofumpt/format.Source({0xc0002db440, 0x1fc, 0x214}, {{0x0, 0xc00017a598}, 0xc8})\r\n   /Users/leitzler/go/pkg/mod/mvdan.cc/gofumpt@v0.1.1/format/format.go:55 +0xb9\r\ngolang.org/x/tools/gopls/internal/hooks.Options.func1({0x1a7e340, 0xc0002db440}, {0xc0002db440, 0x184df60, 0xc00056fd80})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools/gopls@v0.0.0-20210902182115-3b801c8b8389/internal/hooks/hooks.go:26 +0x2e\r\ngolang.org/x/tools/internal/lsp/source.Format({0x1a964d8, 0xc00153ce80}, {0x1abf940, 0xc002da0200}, {0x1aa2698, 0xc0022a8840})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/lsp/source/format.go:62 +0x3b8\r\ngolang.org/x/tools/internal/lsp.(*Server).formatting(0xc001cc4e38, {0x1a964d8, 0xc00153ce80}, 0xc001cc4e10)\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/lsp/format.go:25 +0x1ce\r\ngolang.org/x/tools/internal/lsp.(*Server).Formatting(0xc002fc4640, {0x1a964d8, 0xc00153ce80}, 0x17f1ba0)\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/lsp/server_gen.go:124 +0x25\r\ngolang.org/x/tools/internal/lsp/protocol.serverDispatch({0x1a964d8, 0xc00153ce80}, {0x1ac37a0, 0xc0003c4a20}, 0xc001d29e90, {0x1a96740, 0xc00153cd80})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/lsp/protocol/tsserver.go:469 +0x1b25\r\ngolang.org/x/tools/internal/lsp/protocol.ServerHandler.func1({0x1a964d8, 0xc00153ce80}, 0xc001d29e90, {0x1a96740, 0xc00153cd80})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/lsp/protocol/protocol.go:154 +0x90\r\ngolang.org/x/tools/internal/lsp/lsprpc.handshaker.func1({0x1a964d8, 0xc00153ce80}, 0xc001d29e90, {0x1a96740, 0xc00153cd80})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/lsp/lsprpc/lsprpc.go:506 +0xa43\r\ngolang.org/x/tools/internal/jsonrpc2.MustReplyHandler.func1({0x1a964d8, 0xc00153ce80}, 0xc001063ea8, {0x1a96740, 0xc00153cd80})\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/jsonrpc2/handler.go:35 +0xf6\r\ngolang.org/x/tools/internal/jsonrpc2.AsyncHandler.func1.2()\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/jsonrpc2/handler.go:103 +0xa3\r\ncreated by golang.org/x/tools/internal/jsonrpc2.AsyncHandler.func1\r\n   /Users/leitzler/go/pkg/mod/golang.org/x/tools@v0.1.6-0.20210902182115-3b801c8b8389/internal/jsonrpc2/handler.go:100 +0x20a\r\n```","closed_by":{"login":"mvdan","id":3576549,"node_id":"MDQ6VXNlcjM1NzY1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/3576549?v=4","gravatar_id":"","url":"https://api.github.com/users/mvdan","html_url":"https://github.com/mvdan","followers_url":"https://api.github.com/users/mvdan/followers","following_url":"https://api.github.com/users/mvdan/following{/other_user}","gists_url":"https://api.github.com/users/mvdan/gists{/gist_id}","starred_url":"https://api.github.com/users/mvdan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvdan/subscriptions","organizations_url":"https://api.github.com/users/mvdan/orgs","repos_url":"https://api.github.com/users/mvdan/repos","events_url":"https://api.github.com/users/mvdan/events{/privacy}","received_events_url":"https://api.github.com/users/mvdan/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mvdan/gofumpt/issues/149/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mvdan/gofumpt/issues/149/timeline","performed_via_github_app":null,"state_reason":"completed"}