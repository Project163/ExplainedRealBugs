{"url":"https://api.github.com/repos/mvdan/gofumpt/issues/166","repository_url":"https://api.github.com/repos/mvdan/gofumpt","labels_url":"https://api.github.com/repos/mvdan/gofumpt/issues/166/labels{/name}","comments_url":"https://api.github.com/repos/mvdan/gofumpt/issues/166/comments","events_url":"https://api.github.com/repos/mvdan/gofumpt/issues/166/events","html_url":"https://github.com/mvdan/gofumpt/issues/166","id":1050255129,"node_id":"I_kwDOCqWoQc4-mZ8Z","number":166,"title":"panic when checking lots of files","user":{"login":"chipaca","id":1543430,"node_id":"MDQ6VXNlcjE1NDM0MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1543430?v=4","gravatar_id":"","url":"https://api.github.com/users/chipaca","html_url":"https://github.com/chipaca","followers_url":"https://api.github.com/users/chipaca/followers","following_url":"https://api.github.com/users/chipaca/following{/other_user}","gists_url":"https://api.github.com/users/chipaca/gists{/gist_id}","starred_url":"https://api.github.com/users/chipaca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chipaca/subscriptions","organizations_url":"https://api.github.com/users/chipaca/orgs","repos_url":"https://api.github.com/users/chipaca/repos","events_url":"https://api.github.com/users/chipaca/events{/privacy}","received_events_url":"https://api.github.com/users/chipaca/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/mvdan/gofumpt/milestones/2","html_url":"https://github.com/mvdan/gofumpt/milestone/2","labels_url":"https://api.github.com/repos/mvdan/gofumpt/milestones/2/labels","id":7451349,"node_id":"MI_kwDOCqWoQc4AcbLV","number":2,"title":"v0.2.1","description":"","creator":{"login":"mvdan","id":3576549,"node_id":"MDQ6VXNlcjM1NzY1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/3576549?v=4","gravatar_id":"","url":"https://api.github.com/users/mvdan","html_url":"https://github.com/mvdan","followers_url":"https://api.github.com/users/mvdan/followers","following_url":"https://api.github.com/users/mvdan/following{/other_user}","gists_url":"https://api.github.com/users/mvdan/gists{/gist_id}","starred_url":"https://api.github.com/users/mvdan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvdan/subscriptions","organizations_url":"https://api.github.com/users/mvdan/orgs","repos_url":"https://api.github.com/users/mvdan/repos","events_url":"https://api.github.com/users/mvdan/events{/privacy}","received_events_url":"https://api.github.com/users/mvdan/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"closed","created_at":"2021-12-02T16:25:35Z","updated_at":"2021-12-16T15:27:48Z","due_on":null,"closed_at":"2021-12-16T15:27:48Z"},"comments":4,"created_at":"2021-11-10T19:59:26Z","updated_at":"2021-12-02T16:26:12Z","closed_at":"2021-11-11T15:39:26Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If I create a file with all the .go files I want to check, and use xargs thus:\r\n\r\n    xargs < .all-files gofumpt -d\r\n\r\nas of a few minutes ago gofumpt will panic with\r\n\r\n```\r\npanic: invalid Pos value 1 (should be in [774665, 781950]) [recovered]\r\n\tpanic: invalid Pos value 1 (should be in [774665, 781950])\r\n\r\ngoroutine 1 [running]:\r\ngolang.org/x/tools/go/ast/astutil.Apply.func1()\r\n\t…/pkg/mod/golang.org/x/tools@v0.1.8-0.20211102182255-bb4add04ddef/go/ast/astutil/rewrite.go:49 +0x89\r\npanic({0x60bb20, 0xc000540770})\r\n\t/home/john/sdk/go1.17.1/src/runtime/panic.go:1038 +0x215\r\ngo/token.(*File).Offset(0xc00054a3c0, 0x2)\r\n\t/home/john/sdk/go1.17.1/src/go/token/position.go:281 +0xeb\r\nmvdan.cc/gofumpt/format.(*fumpter).addNewline(0xc0001875c0, 0xc000540430)\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/format/format.go:213 +0x3a\r\nmvdan.cc/gofumpt/format.(*fumpter).applyPre(0xc0001875c0, 0xc00054a4f0)\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/format/format.go:558 +0x12f5\r\nmvdan.cc/gofumpt/format.File.func1(0xc00054a4f0)\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/format/format.go:104 +0x3a\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc00054a4e0, {0x696ca0, 0xc000184a50}, {0x649e41, 0x18}, 0xc0001c7378, {0x6969d0, 0xc000184a20})\r\n\t…/pkg/mod/golang.org/x/tools@v0.1.8-0.20211102182255-bb4add04ddef/go/ast/astutil/rewrite.go:200 +0x202\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc00054a4e0, {0x696c50, 0xc000431180}, {0x64a094, 0xc000431180}, 0x0, {0x696ca0, 0xc000184a50})\r\n\t…/pkg/mod/golang.org/x/tools@v0.1.8-0.20211102182255-bb4add04ddef/go/ast/astutil/rewrite.go:424 +0x17fd\r\ngolang.org/x/tools/go/ast/astutil.(*application).applyList(0xc00054a4e0, {0x696c50, 0xc000431180}, {0x64a094, 0x5})\r\n\t…/pkg/mod/golang.org/x/tools@v0.1.8-0.20211102182255-bb4add04ddef/go/ast/astutil/rewrite.go:479 +0xae\r\ngolang.org/x/tools/go/ast/astutil.(*application).apply(0xc00054a4e0, {0x6974c0, 0xc000540740}, {0x649ea5, 0x18}, 0x18, {0x696c50, 0xc000431180})\r\n\t…/pkg/mod/golang.org/x/tools@v0.1.8-0.20211102182255-bb4add04ddef/go/ast/astutil/rewrite.go:430 +0xb0d\r\ngolang.org/x/tools/go/ast/astutil.Apply({0x696c50, 0xc000431180}, 0xc0005458c0, 0xc0005458d8)\r\n\t…/pkg/mod/golang.org/x/tools@v0.1.8-0.20211102182255-bb4add04ddef/go/ast/astutil/rewrite.go:54 +0x166\r\nmvdan.cc/gofumpt/format.File(0xc0000b6440, 0xc000431180, {{0xc0000240f0, 0xc00016cf00}, 0xa0})\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/format/format.go:152 +0x335\r\nmain.processFile({0x7fff6f0bca65, 0x36}, {0x0, 0x0}, {0x692e00, 0xc0000b2008}, 0x0)\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/gofmt.go:130 +0x388\r\nmain.gofumptMain()\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/gofmt.go:242 +0x458\r\nmain.main()\r\n\t…/pkg/mod/mvdan.cc/gofumpt@v0.2.0/gofmt.go:195 +0x19\r\n```\r\n\r\nhowever feeding it all the files one at a time (i.e. `xargs -n1`) does not trigger this behaviour. Larger batch sizes also work.\r\n\r\nShuffling the list of files will trigger it at a different place, e.g. while\r\n\r\n    xargs -n 1061 gofumpt -d < .all-files\r\n\r\nwill work (and -n1062 will fail),\r\n\r\n    shuf .all-files | xargs -n 1061 gofumpt -d\r\n\r\nwill fail more often than not.","closed_by":{"login":"mvdan","id":3576549,"node_id":"MDQ6VXNlcjM1NzY1NDk=","avatar_url":"https://avatars.githubusercontent.com/u/3576549?v=4","gravatar_id":"","url":"https://api.github.com/users/mvdan","html_url":"https://github.com/mvdan","followers_url":"https://api.github.com/users/mvdan/followers","following_url":"https://api.github.com/users/mvdan/following{/other_user}","gists_url":"https://api.github.com/users/mvdan/gists{/gist_id}","starred_url":"https://api.github.com/users/mvdan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvdan/subscriptions","organizations_url":"https://api.github.com/users/mvdan/orgs","repos_url":"https://api.github.com/users/mvdan/repos","events_url":"https://api.github.com/users/mvdan/events{/privacy}","received_events_url":"https://api.github.com/users/mvdan/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mvdan/gofumpt/issues/166/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mvdan/gofumpt/issues/166/timeline","performed_via_github_app":null,"state_reason":"completed"}