{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/4369","repository_url":"https://api.github.com/repos/goreleaser/goreleaser","labels_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/4369/labels{/name}","comments_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/4369/comments","events_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/4369/events","html_url":"https://github.com/goreleaser/goreleaser/issues/4369","id":1942359685,"node_id":"I_kwDOBJgEXs5zxg6F","number":4369,"title":"Unexpected `build --single-target` behavior","user":{"login":"kzantow","id":3009477,"node_id":"MDQ6VXNlcjMwMDk0Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/3009477?v=4","gravatar_id":"","url":"https://api.github.com/users/kzantow","html_url":"https://github.com/kzantow","followers_url":"https://api.github.com/users/kzantow/followers","following_url":"https://api.github.com/users/kzantow/following{/other_user}","gists_url":"https://api.github.com/users/kzantow/gists{/gist_id}","starred_url":"https://api.github.com/users/kzantow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kzantow/subscriptions","organizations_url":"https://api.github.com/users/kzantow/orgs","repos_url":"https://api.github.com/users/kzantow/repos","events_url":"https://api.github.com/users/kzantow/events{/privacy}","received_events_url":"https://api.github.com/users/kzantow/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":504976497,"node_id":"MDU6TGFiZWw1MDQ5NzY0OTc=","url":"https://api.github.com/repos/goreleaser/goreleaser/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2023-10-13T17:35:27Z","updated_at":"2023-10-16T11:27:26Z","closed_at":"2023-10-14T21:58:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What happened?\r\n\r\nThe `build` command's `--single-target` flag appears to be executing multiple steps of the build process for targets other than the single specified target.\r\n\r\nUsing [this goreleaser config](https://github.com/anchore/syft/blob/main/.goreleaser.yaml), run:\r\n\r\n```\r\n$ goreleaser build --clean --snapshot --single-target --config .goreleaser.yaml\r\n  • starting build...\r\n  • loading                                          path=.goreleaser.yaml\r\n  • building only for darwin/amd64                   reason=single target is enabled\r\n  • skipping validate...\r\n  • loading environment variables\r\n  • getting and validating git state\r\n    • git state                                      commit=2fc2588030d0e71e491cf9527164a49e86209f01 branch=chore/build-syft-for-cli-tests current_tag=v0.93.0 previous_tag=v0.92.0 dirty=false\r\n    • pipe skipped                                   reason=disabled during snapshot mode\r\n  • parsing tag\r\n  • setting defaults\r\n    • DEPRECATED:  brews.tap  should not be used anymore, check https://goreleaser.com/deprecations#brewstap for more info\r\n  • snapshotting\r\n    • building snapshot...                           version=0.93.0-SNAPSHOT-2fc25880\r\n  • checking distribution directory\r\n    • cleaning dist\r\n  • loading go mod information\r\n  • build prerequisites\r\n  • writing effective config file\r\n    • writing                                        config=dist/config.yaml\r\n  • building binaries\r\n    • building                                       binary=dist/windows-build_darwin_amd64_v1/syft\r\n    • building                                       binary=dist/linux-build_darwin_amd64_v1/syft\r\n    • building                                       binary=dist/darwin-build_darwin_amd64_v1/syft\r\n    • running hook                                   hook=.tmp/quill sign-and-notarize \"/syft/dist/darwin-build_darwin_amd64_v1/syft\" --dry-run=true --ad-hoc=true -vv\r\n    • took: 3s\r\n  • storing release metadata\r\n    • writing                                        file=dist/artifacts.json\r\n    • writing                                        file=dist/metadata.json\r\n  • you are using deprecated options, check the output above for details\r\n  • build succeeded after 3s\r\n  • thanks for using goreleaser!\r\n```\r\n\r\nYou can see that the flag identified the correct platform/architecture to use (_\"building only for darwin/amd64                   reason=single target is enabled\"_) but then the `building binaries` section indicates it's building 3 binaries, 2 of which are for incorrect platforms. It also executed the hook which is specified only for darwin builds (which was correct, in this case).\r\n\r\nBUT after this runs, it turns out it only actually built the darwin binary, but it put it in all 3 of those locations, and for some reason it was built twice (note the md5 hashes):\r\n```\r\n$ echo \"$(for f in $(find dist); do if [[ -f $f ]]; then echo $f $(md5sum $f | awk '{print $1}'); else echo $f; fi; done)\" | column -t \r\ndist\r\ndist/linux-build_darwin_amd64_v1\r\ndist/linux-build_darwin_amd64_v1/syft    95f83a28adfbf9dfb52e5b890748f544\r\ndist/metadata.json                       02ac778f6cfd61371d8c9fd9cd7544a7\r\ndist/config.yaml                         32eeb7282574cd4a51450e9a3b35c093\r\ndist/darwin-build_darwin_amd64_v1\r\ndist/darwin-build_darwin_amd64_v1/syft   c7bac673d85a1816d7363e6867a85a8b\r\ndist/windows-build_darwin_amd64_v1\r\ndist/windows-build_darwin_amd64_v1/syft  95f83a28adfbf9dfb52e5b890748f544\r\ndist/artifacts.json                      1f943b691953f1d012e56079d5ca0efe\r\n\r\n$ dist/darwin-build_darwin_amd64_v1/syft version\r\nApplication:     syft\r\nVersion:         0.93.0-SNAPSHOT-2fc25880\r\nBuildDate:       2023-10-13T15:58:44Z\r\nGitCommit:       2fc2588030d0e71e491cf9527164a49e86209f01\r\nGitDescription:  v0.93.0-17-g2fc25880\r\nPlatform:        darwin/amd64\r\nGoVersion:       go1.21.1\r\nCompiler:        gc\r\n\r\n$ dist/windows-build_darwin_amd64_v1/syft version\r\nApplication:     syft\r\nVersion:         0.93.0-SNAPSHOT-2fc25880\r\nBuildDate:       2023-10-13T15:58:44Z\r\nGitCommit:       2fc2588030d0e71e491cf9527164a49e86209f01\r\nGitDescription:  v0.93.0-17-g2fc25880\r\nPlatform:        darwin/amd64\r\nGoVersion:       go1.21.1\r\nCompiler:        gc\r\n\r\n$ dist/linux-build_darwin_amd64_v1/syft version\r\nApplication:     syft\r\nVersion:         0.93.0-SNAPSHOT-2fc25880\r\nBuildDate:       2023-10-13T15:58:44Z\r\nGitCommit:       2fc2588030d0e71e491cf9527164a49e86209f01\r\nGitDescription:  v0.93.0-17-g2fc25880\r\nPlatform:        darwin/amd64\r\nGoVersion:       go1.21.1\r\nCompiler:        gc\r\n```\r\n\r\nSo these are all darwin/amd64 binaries, but they are in directories for linux and windows, albeit with `darwin` as a part of the matrix. I would expect only the `dist/darwin-build_darwin_amd64_v1/syft` to be created. Another oddity is that of the 3 binaries, 2 are identical and the expected one is not.\r\n\r\nThe same problem occurs on Linux, as can be seen in [this workflow output](https://github.com/anchore/syft/actions/runs/6509569637/job/17681347712?pr=2016#step:4:10). You'll also see that the output indicates it's attempting to build a similar set of 3 artifacts and attempts to run the darwin hook (presumably because the darwin target seems to be running), even though it indicates _\"building only for linux/amd64                    reason=single target is enabled\"_. I'm assuming the darwin hook then fails because instead of having a macho binary, it's a linux ELF binary that's a duplicate of the linux build.\r\n\r\nAm I misunderstanding what the `--single-target` flag is supposed to do? I think the expected behavior here is that only the build configuration that matches the GOOS and GOARCH specified should run.\r\n\r\n### How can we reproduce this?\r\n\r\n```\r\ngit clone https://github.com/anchore/syft.git\r\npushd syft\r\nmake bootstrap\r\ngoreleaser build --clean --snapshot --single-target --config .goreleaser.yaml\r\n```\r\n\r\n### goreleaser version\r\n\r\n```bash\r\nGitVersion:    1.21.2\r\nGitCommit:     26fed97a0defe4e73e3094cb903225d5445e5f0d\r\nGitTreeState:  false\r\nBuildDate:     2023-09-26T11:20:15Z\r\nBuiltBy:       goreleaser\r\nGoVersion:     go1.21.1\r\nCompiler:      gc\r\nModuleSum:     h1:dgYtIS7aZlQuRMUMLCjDCOs4lWss85Oh60RDSO0rbWU=\r\nPlatform:      darwin/amd64\r\n```\r\n\r\n\r\n### GoReleaser Check\r\n\r\n- [X] goreleaser check shows no errors\r\n\r\n### Search\r\n\r\n- [X] I did search for other open and closed issues before opening this\r\n\r\n### Supporter\r\n\r\n- [ ] I am a [sponsor](https://github.com/sponsors/caarlos0/) or a [Pro](https://goreleaser.com/pro) customer\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project's Code of Conduct\r\n\r\n### Additional context\r\n\r\n_No response_","closed_by":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/4369/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/4369/timeline","performed_via_github_app":null,"state_reason":"completed"}