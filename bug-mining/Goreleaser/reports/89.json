{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/1120","repository_url":"https://api.github.com/repos/goreleaser/goreleaser","labels_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/1120/labels{/name}","comments_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/1120/comments","events_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/1120/events","html_url":"https://github.com/goreleaser/goreleaser/issues/1120","id":483048204,"node_id":"MDU6SXNzdWU0ODMwNDgyMDQ=","number":1120,"title":"Multiple brew formulas fail to upload to the same repository Github","user":{"login":"rvolosatovs","id":12877905,"node_id":"MDQ6VXNlcjEyODc3OTA1","avatar_url":"https://avatars.githubusercontent.com/u/12877905?v=4","gravatar_id":"","url":"https://api.github.com/users/rvolosatovs","html_url":"https://github.com/rvolosatovs","followers_url":"https://api.github.com/users/rvolosatovs/followers","following_url":"https://api.github.com/users/rvolosatovs/following{/other_user}","gists_url":"https://api.github.com/users/rvolosatovs/gists{/gist_id}","starred_url":"https://api.github.com/users/rvolosatovs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rvolosatovs/subscriptions","organizations_url":"https://api.github.com/users/rvolosatovs/orgs","repos_url":"https://api.github.com/users/rvolosatovs/repos","events_url":"https://api.github.com/users/rvolosatovs/events{/privacy}","received_events_url":"https://api.github.com/users/rvolosatovs/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":504976497,"node_id":"MDU6TGFiZWw1MDQ5NzY0OTc=","url":"https://api.github.com/repos/goreleaser/goreleaser/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Something isn't working"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-08-20T19:46:56Z","updated_at":"2020-11-18T22:13:36Z","closed_at":"2019-08-31T13:27:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nWhen multiple brew builds are to be uploaded to the same Github repository, the 2nd upload always fails with:\r\n```\r\n   тип release failed after 256.66s error=homebrew tap formula: failed to publish artifacts: PUT https://api.github.com/repos/rvolosatovs/homebrew-lorawan-stack/contents/ttn-lw-stack.rb: 409 is at db682719df1aa4f8e5e008d5fdb594abd1874714 but expected 7ce90d2d931b623e69b39ab43e0c3a88c973bac1 []\r\n```\r\nOnly one of the formulas is uploaded and commited.\r\n\r\nThe issue happens, since by default `goreleaser` runs in parallel and hence there is a possible race condition, when multiple `brew` formulas are updated/created.\r\nAssume: \r\n- there are 2 brew formulas to upload\r\n- the original `HEAD` of the remote repository is `A`\r\n- there are 2 goroutines each uploading a different formula to the same remote repository - R1 and R2 respectively\r\n- R1 is the first goroutine to call github API and upload the new formula\r\n\r\nConsider R1 successfully uploaded the updated formula and `HEAD` of the remote repository is changed to `B`.\r\n\r\nAt this point \r\nhttps://github.com/goreleaser/goreleaser/blob/0847b30afa7778f7647df29f452d896b60d91845/internal/client/github.go#L95 the SHA set here may be equal to either `A` or `B`, depending on when R2 called https://github.com/goreleaser/goreleaser/blob/0847b30afa7778f7647df29f452d896b60d91845/internal/client/github.go#L74\r\nApparently Github expects `SHA` to represent the SHA of `HEAD` and not the latest commit, in which the file was changed.\r\n\r\nI see 2 solutions here:\r\n1. (simplest) do not execute `brew` builds in parallel (confirmed by https://github.com/rvolosatovs/lorawan-stack/commit/e3409efd95d7dc2d65fdd2b9ed7e2e22b4bcebf7, which fixes the issue)\r\n2. (possibly better) use a per-repository mutex in `githubClient` and only update 1 file per-repository at a time.\r\n\r\nNot sure if the same issue is present in `gitlabClient` - it seems to me that it's free of it, but I'm not familiar with Gitlab API.\r\n\r\n**To Reproduce**\r\n\r\nSteps to reproduce the behavior:\r\n(irrelevant outputs removed)\r\n```yaml\r\nproject_name: lorawan-stack\r\n\r\nchangelog:\r\n  skip: true\r\n\r\nrelease:\r\n  prerelease: auto\r\n\r\nbuilds:\r\n  - id: stack\r\n    main: ./cmd/ttn-lw-stack\r\n    binary: ttn-lw-stack\r\n    ldflags:\r\n    - -s\r\n    - -w\r\n    - -X go.thethings.network/lorawan-stack/pkg/version.BuildDate={{.Date}}\r\n    - -X go.thethings.network/lorawan-stack/pkg/version.GitCommit={{.ShortCommit}}\r\n    - -X go.thethings.network/lorawan-stack/pkg/version.TTN={{.Version}}\r\n    env:\r\n      - CGO_ENABLED=0\r\n    goos:\r\n      - darwin\r\n      - linux\r\n    goarch:\r\n      - amd64\r\n\r\n  - id: cli\r\n    main: ./cmd/ttn-lw-cli\r\n    binary: ttn-lw-cli\r\n    ldflags:\r\n    - -s\r\n    - -w\r\n    - -X go.thethings.network/lorawan-stack/pkg/version.BuildDate={{.Date}}\r\n    - -X go.thethings.network/lorawan-stack/pkg/version.GitCommit={{.ShortCommit}}\r\n    - -X go.thethings.network/lorawan-stack/pkg/version.TTN={{.Version}}\r\n    env:\r\n      - CGO_ENABLED=0\r\n    goos:\r\n      - darwin\r\n      - linux\r\n    goarch:\r\n      - amd64\r\n\r\narchives:\r\n  - id: stack\r\n    name_template: \"{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}\"\r\n    builds:\r\n      - cli\r\n      - stack\r\n    files:\r\n      - LICENSE\r\n      - README.md\r\n      - doc/**/*\r\n      - docker-compose.yml\r\n      - public/**/*\r\n    wrap_in_directory: true\r\n    format_overrides:\r\n      - goos: windows\r\n        format: zip\r\n\r\n  - id: cli\r\n    name_template: \"{{ .ProjectName }}-cli_{{ .Version }}_{{ .Os }}_{{ .Arch }}{{ if .Arm }}v{{ .Arm }}{{ end }}\"\r\n    builds:\r\n      - cli\r\n    files:\r\n      - LICENSE\r\n      - README.md\r\n      - doc/**/*\r\n    wrap_in_directory: true\r\n    format_overrides:\r\n      - goos: windows\r\n        format: zip\r\n\r\nbrews:\r\n  - name: ttn-lw-stack\r\n    ids:\r\n      - stack\r\n    github:\r\n      owner: rvolosatovs\r\n      name: homebrew-lorawan-stack\r\n    commit_author:\r\n      name: ttn-ci\r\n      email: stack@thethingsnetwork.org\r\n    homepage: https://www.thethingsnetwork.org\r\n    description: The Things Stack for LoRaWAN\r\n    conflicts:\r\n      - ttn-lw-cli\r\n    skip_upload: auto\r\n    install: |\r\n      bin.install \"ttn-lw-cli\"\r\n      libexec.install %w[ttn-lw-stack public doc]\r\n      env = {\r\n          :TTN_LW_HTTP_STATIC_SEARCH_PATH => libexec/\"public\"\r\n      }\r\n      (bin/\"ttn-lw-stack\").write_env_script libexec/\"ttn-lw-stack\", env\r\n\r\n  - name: ttn-lw-cli\r\n    ids:\r\n      - cli\r\n    github:\r\n      owner: rvolosatovs\r\n      name: homebrew-lorawan-stack\r\n    commit_author:\r\n      name: ttn-ci\r\n      email: stack@thethingsnetwork.org\r\n    homepage: https://www.thethingsnetwork.org\r\n    description: CLI of The Things Stack for LoRaWAN\r\n    conflicts:\r\n      - ttn-lw-stack\r\n    skip_upload: auto\r\n    install: |\r\n      bin.install \"ttn-lw-cli\"\r\n      libexec.install doc\r\n```\r\n\r\n> Make sure your config file is valid by running\r\n> `goreleaser check -f path-to-config-file`.\r\n\r\n**Expected behavior**\r\n\r\nBoth formulas uploaded successfully\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- OS: [e.g. mac, linux] linux (Travis CI)\r\n- OS version: [uname -a] `4.15.0-1028-gcp`\r\n- GoReleaser Version [goreleaser --version] `v0.116.0` versioned via go modules\r\n\r\n**Additional context**\r\nAdd any other context about the problem here. Full output log with debug on\r\nis probably a helpful thing to add here.\r\n\r\nI'd be happy to contribute by implementing either the solution (1.), (2.) or something else?","closed_by":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/1120/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/1120/timeline","performed_via_github_app":null,"state_reason":"completed"}