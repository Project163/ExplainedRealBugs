{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/668","repository_url":"https://api.github.com/repos/goreleaser/goreleaser","labels_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/668/labels{/name}","comments_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/668/comments","events_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/668/events","html_url":"https://github.com/goreleaser/goreleaser/issues/668","id":321298621,"node_id":"MDU6SXNzdWUzMjEyOTg2MjE=","number":668,"title":"List formats for flags, ldflags, asmflags, and gcflags","user":{"login":"elyscape","id":792695,"node_id":"MDQ6VXNlcjc5MjY5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/792695?v=4","gravatar_id":"","url":"https://api.github.com/users/elyscape","html_url":"https://github.com/elyscape","followers_url":"https://api.github.com/users/elyscape/followers","following_url":"https://api.github.com/users/elyscape/following{/other_user}","gists_url":"https://api.github.com/users/elyscape/gists{/gist_id}","starred_url":"https://api.github.com/users/elyscape/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elyscape/subscriptions","organizations_url":"https://api.github.com/users/elyscape/orgs","repos_url":"https://api.github.com/users/elyscape/repos","events_url":"https://api.github.com/users/elyscape/events{/privacy}","received_events_url":"https://api.github.com/users/elyscape/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":504976499,"node_id":"MDU6TGFiZWw1MDQ5NzY0OTk=","url":"https://api.github.com/repos/goreleaser/goreleaser/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":"New feature or request"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/goreleaser/goreleaser/milestones/1","html_url":"https://github.com/goreleaser/goreleaser/milestone/1","labels_url":"https://api.github.com/repos/goreleaser/goreleaser/milestones/1/labels","id":2248611,"node_id":"MDk6TWlsZXN0b25lMjI0ODYxMQ==","number":1,"title":"v1.0.0","description":"Intended to be the first stable solution, with most of the features implemented.","creator":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":335,"state":"closed","created_at":"2017-01-12T21:47:24Z","updated_at":"2022-01-10T14:00:52Z","due_on":null,"closed_at":"2022-01-10T14:00:52Z"},"comments":9,"created_at":"2018-05-08T18:34:24Z","updated_at":"2020-11-19T01:20:02Z","closed_at":"2018-05-15T11:12:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Is your feature request related to a problem? Please describe.**\r\n[As of Go 1.10][go1.10]:\r\n>The `go build` `-asmflags`, `-gcflags`, `-gccgoflags`, and `-ldflags` options now apply by default only to the packages listed directly on the command line. For example, `go build -gcflags=-m mypkg` passes the compiler the `-m` flag when building `mypkg` but not its dependencies. The new, more general form `-asmflags=pattern=flags` (and similarly for the others) applies the flags only to the packages matching the pattern.\r\n\r\nIn other words, you can pass different flag sets to the compiler based on the package you're passing. Unfortunately, this has to be done with multiple uses of `-gcflags` et al. For example, given the following code:\r\n```shellsession\r\nelyscape:flagdemo eliyoung$ pwd\r\n/Users/eliyoung/go/src/github.com/elyscape/flagdemo\r\nelyscape:flagdemo eliyoung$ cat main.go\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\r\n\t\"github.com/elyscape/flagdemo/sub\"\r\n)\r\n\r\nvar (\r\n\tone = \"\"\r\n)\r\n\r\nfunc main() {\r\n\tfmt.Println(\"one:\", one)\r\n\tsub.Print()\r\n}\r\nelyscape:flagdemo eliyoung$ cat sub/sub.go\r\npackage sub\r\n\r\nimport (\r\n\t\"fmt\"\r\n)\r\n\r\nvar (\r\n\ttwo = \"\"\r\n)\r\n\r\nfunc Print() {\r\n\tfmt.Println(\"two:\", two)\r\n}\r\n```\r\nHere are the source file paths included in the resulting binary:\r\n```shellsession\r\nelyscape:flagdemo eliyoung$ go build -a .\r\nelyscape:flagdemo eliyoung$ strings flagdemo | grep 'elyscape.*go$'\r\n/Users/eliyoung/go/src/github.com/elyscape/flagdemo/main.go\r\n/Users/eliyoung/go/src/github.com/elyscape/flagdemo/sub/sub.go\r\n/Users/eliyoung/go/src/github.com/elyscape/flagdemo/sub/sub.go\r\n/Users/eliyoung/go/src/github.com/elyscape/flagdemo/main.go\r\n```\r\nSuppose that, for some reason, I want to set different trimpaths for different subpackages. Trying to put both in a single `-gcflags` value doesn't work:\r\n```shellsession\r\nelyscape:flagdemo eliyoung$ go build -a -gcflags '.=-trimpath=/Users/eliyoung/go/src ./sub=-trimpath=/Users/eliyoung/go/src/github.com' .\r\n# github.com/elyscape/flagdemo\r\n./sub=-trimpath=/Users/eliyoung/go/src/github.com:0:0: open ./sub=-trimpath=/Users/eliyoung/go/src/github.com: no such file or directory\r\n```\r\nBy contrast, using `-gcflags` multiple times does work:\r\n```shellsession\r\nelyscape:flagdemo eliyoung$ go build -a -gcflags '.=-trimpath=/Users/eliyoung/go/src' -gcflags './sub=-trimpath=/Users/eliyoung/go/src/github.com' .\r\nelyscape:flagdemo eliyoung$ strings flagdemo | grep 'elyscape.*go$'\r\ngithub.com/elyscape/flagdemo/main.go\r\nelyscape/flagdemo/sub/sub.go\r\nelyscape/flagdemo/sub/sub.go\r\ngithub.com/elyscape/flagdemo/main.go\r\n```\r\nAdditionally, some of the flags one might want to specify in the `flags` field, such as `-tags` (which is given in the example), take space-separated arguments, and there's currently no way to represent that.\r\n\r\n**Describe the solution you'd like**\r\nIt would be nice if the `ldflags` et al. took arrays, each of which was then processed as a template and then passed individually to the compiler. To demonstrate with a slightly modified version of example above, this:\r\n```yaml\r\nflags:\r\n- -a\r\n- tags\r\n- tagone tagtwo\r\ngcflags:\r\n- .=-trimpath={{.Env.GOPATH}}\r\n- ./sub=-trimpath=/Users/eliyoung/go/src/github.com\r\n```\r\nWould be turned into something like this (with a bunch of extraneous quotes and newlines for clarity):\r\n```shell\r\ngo build \\\r\n\t'-a' \\\r\n\t'-tags' \\\r\n\t'tagone tagtwo' \\\r\n\t'-gcflags=.=-trimpath=/Users/eliyoung/go/src' \\\r\n\t'-gcflags=./sub=-trimpath=/Users/eliyoung/go/src/github.com' \\\r\n\t.\r\n```\r\nOf course, making a field in the YAML be either a string or an array is complicated in Go. Probably the best way to do this is to use the approach provided [in this comment][StringArray]; that is, mark those fields as a new type called `StringArray`, which is basically just an alias for `[]string` but which has a custom YAML unmarshalling method that converts bare strings into one-element arrays.\r\n\r\nFor `ldflags`, `gcflags`, and `asmflags`, this would be a drop-in fix with no further ramifications, but `flags` is complicated by the fact that it currently runs the value through `strings.Fields()`, and we'd probably want to preserve that behavior to avoid breaking anything. The best way to deal with that would probably be to have it have its own custom type (`FlagsArray`?) and YAML unmarshaller that, when provided with a bare string, runs it through `strings.Fields()` and returns the result of that, instead of just wrapping the bare string in an array.\r\n\r\n**Describe alternatives you've considered**\r\nInstead of making the various fields automatically upconvert into arrays, we could instead deprecate them and add new fields like `ldflags_list` which are natively arrays. Alternatively, we could do that only for `flags`, which is the only problematic field.\r\n\r\n[go1.10]: https://golang.org/doc/go1.10#build\r\n[StringArray]: https://github.com/go-yaml/yaml/issues/100#issuecomment-324964723","closed_by":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/668/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/668/timeline","performed_via_github_app":null,"state_reason":"completed"}