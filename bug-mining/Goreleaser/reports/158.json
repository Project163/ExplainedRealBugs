{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/3027","repository_url":"https://api.github.com/repos/goreleaser/goreleaser","labels_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/3027/labels{/name}","comments_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/3027/comments","events_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/3027/events","html_url":"https://github.com/goreleaser/goreleaser/issues/3027","id":1197379254,"node_id":"I_kwDOBJgEXs5HXo62","number":3027,"title":"release fails when brew uses universal binaries","user":{"login":"troian","id":2477474,"node_id":"MDQ6VXNlcjI0Nzc0NzQ=","avatar_url":"https://avatars.githubusercontent.com/u/2477474?v=4","gravatar_id":"","url":"https://api.github.com/users/troian","html_url":"https://github.com/troian","followers_url":"https://api.github.com/users/troian/followers","following_url":"https://api.github.com/users/troian/following{/other_user}","gists_url":"https://api.github.com/users/troian/gists{/gist_id}","starred_url":"https://api.github.com/users/troian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/troian/subscriptions","organizations_url":"https://api.github.com/users/troian/orgs","repos_url":"https://api.github.com/users/troian/repos","events_url":"https://api.github.com/users/troian/events{/privacy}","received_events_url":"https://api.github.com/users/troian/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":504976497,"node_id":"MDU6TGFiZWw1MDQ5NzY0OTc=","url":"https://api.github.com/repos/goreleaser/goreleaser/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2022-04-08T14:19:36Z","updated_at":"2022-04-09T00:15:08Z","closed_at":"2022-04-09T00:15:08Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What happened?\n\nTwo issues arise when using universal binaries for Darwin\r\n\r\n### universal binaries config\r\n```yaml\r\nuniversal_binaries:\r\n  - id: akash-darwin-universal\r\n    ids:\r\n      - akash-darwin-amd64\r\n      - akash-darwin-arm64\r\n    name_template: '{{ .ProjectName }}'\r\n    replace: true\r\n```\r\n\r\n### no archive for universal binary created\r\n#### config\r\n```yaml\r\narchives:\r\n  - id: akash\r\n    builds:\r\n      - akash-darwin-universal\r\n      - akash-linux-amd64\r\n      - akash-linux-arm64\r\n      - akash-windows-amd64\r\n    name_template: \"{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}\"\r\n    wrap_in_directory: true\r\n    format: zip\r\n    files:\r\n      - none*\r\n```\r\n\r\n#### output\r\n```\r\n   • universal binaries       \r\n      • creating from 2 binaries  binary=dist/akash_darwin_all/akash\r\n   • archives                 \r\n      • creating                  archive=dist/akash_0.15.0-rc16_linux_arm64.zip\r\n      • creating                  archive=dist/akash_0.15.0-rc16_linux_amd64.zip\r\n      • creating                  archive=dist/akash_0.15.0-rc16_windows_amd64.zip\r\n```\r\n\r\n#### expected output\r\n```\r\n   • universal binaries       \r\n      • creating from 2 binaries  binary=dist/akash_darwin_all/akash\r\n   • archives                 \r\n      • creating                  archive=dist/akash_0.15.0-rc16_linux_arm64.zip\r\n      • creating                  archive=dist/akash_0.15.0-rc16_linux_amd64.zip\r\n      • creating                  archive=dist/akash_0.15.0-rc16_windows_amd64.zip\r\n      • creating                  archive=dist/akash_0.15.0-rc16_darwin_universal.zip\r\n```\r\n\r\n### Homebrew cannot find archive\r\n#### config\r\n```yaml\r\nbrews:\r\n  - name: \"{{ .Env.HOMEBREW_NAME }}\"\r\n    tap:\r\n      owner: ovrclk\r\n      name: homebrew-tap\r\n    homepage: \"https://akash.network\"\r\n    description: \"Blockchain-powered decentralized compute platform\"\r\n    custom_block: |\r\n      {{ .Env.HOMEBREW_CUSTOM }}\r\n    install: |\r\n      bin.install \"akash\"\r\n    ids:\r\n      - akash-darwin-universal\r\n```\r\n\r\n#### output\r\n```\r\n   • homebrew tap formula     \r\n   ⨯ release failed after 147.34s error=no linux/macos archives found\r\n```\r\n\r\n### Full version of the .goreleaser.yml\r\n\r\n<details>\r\n<summary>Lost of characters</summary>\r\n\r\n```yaml\r\nenv:\r\n  - GO111MODULE=on\r\n  - CGO_ENABLED=1\r\nbuilds:\r\n  - id: akash-darwin-amd64\r\n    binary: akash\r\n    main: ./cmd/akash\r\n    goarch:\r\n      - amd64\r\n    goos:\r\n      - darwin\r\n    env:\r\n      - CC=o64-clang\r\n      - CXX=o64-clang++\r\n    flags:\r\n      - \"-mod={{ .Env.MOD }}\"\r\n      - \"-tags={{ .Env.BUILD_TAGS }}\"\r\n      - -trimpath\r\n    ldflags:\r\n      - \"{{ .Env.BUILD_VARS }}\"\r\n      - \"{{ .Env.STRIP_FLAGS }}\"\r\n      - \"-linkmode={{ .Env.LINKMODE }}\"\r\n  - id: akash-darwin-arm64\r\n    binary: akash\r\n    main: ./cmd/akash\r\n    goarch:\r\n      - arm64\r\n    goos:\r\n      - darwin\r\n    env:\r\n      - CC=oa64-clang\r\n      - CXX=oa64-clang++\r\n    flags:\r\n      - \"-mod={{ .Env.MOD }}\"\r\n      - \"-tags={{ .Env.BUILD_TAGS }}\"\r\n      - -trimpath\r\n    ldflags:\r\n      - \"{{ .Env.BUILD_VARS }}\"\r\n      - \"{{ .Env.STRIP_FLAGS }}\"\r\n      - \"-linkmode={{ .Env.LINKMODE }}\"\r\n  - id: akash-linux-amd64\r\n    binary: akash\r\n    main: ./cmd/akash\r\n    env:\r\n      - CC=x86_64-linux-gnu-gcc\r\n      - CXX=x86_64-linux-gnu-g++\r\n    goarch:\r\n      - amd64\r\n    goos:\r\n      - linux\r\n    flags:\r\n      - \"-mod={{ .Env.MOD }}\"\r\n      - \"-tags={{ .Env.BUILD_TAGS }}\"\r\n      - -trimpath\r\n    ldflags:\r\n      - \"{{ .Env.BUILD_VARS }}\"\r\n      - \"{{ .Env.STRIP_FLAGS }}\"\r\n      - \"-linkmode={{ .Env.LINKMODE }}\"\r\n      - -extldflags \"-lc -lrt -lpthread --static\"\r\n  - id: akash-linux-arm64\r\n    binary: akash\r\n    main: ./cmd/akash\r\n    goarch:\r\n      - arm64\r\n    goos:\r\n      - linux\r\n    env:\r\n      - CC=aarch64-linux-gnu-gcc\r\n      - CXX=aarch64-linux-gnu-g++\r\n    flags:\r\n      - \"-mod={{ .Env.MOD }}\"\r\n      - \"-tags={{ .Env.BUILD_TAGS }}\"\r\n      - -trimpath\r\n    ldflags:\r\n      - \"{{ .Env.BUILD_VARS }}\"\r\n      - \"{{ .Env.STRIP_FLAGS }}\"\r\n      - \"-linkmode={{ .Env.LINKMODE }}\"\r\n      - -extldflags \"-lc -lrt -lpthread --static\"\r\n  - id: akash-windows-amd64\r\n    binary: akash\r\n    main: ./cmd/akash\r\n    goarch:\r\n      - amd64\r\n    goos:\r\n      - windows\r\n    env:\r\n      - CC=x86_64-w64-mingw32-gcc\r\n      - CXX=x86_64-w64-mingw32-g++\r\n    flags:\r\n      - \"-mod={{ .Env.MOD }}\"\r\n      - \"-tags={{ .Env.BUILD_TAGS }}\"\r\n      - -trimpath\r\n      - -buildmode=exe\r\n    ldflags:\r\n      - \"{{ .Env.BUILD_VARS }}\"\r\n      - \"{{ .Env.STRIP_FLAGS }}\"\r\n      - \"-linkmode={{ .Env.LINKMODE }}\"\r\n\r\nuniversal_binaries:\r\n  - id: akash-darwin-universal\r\n    ids:\r\n      - akash-darwin-amd64\r\n      - akash-darwin-arm64\r\n    name_template: '{{ .ProjectName }}'\r\n    replace: true\r\n\r\narchives:\r\n  - id: akash\r\n    builds:\r\n      - akash-darwin-universal\r\n      - akash-linux-amd64\r\n      - akash-linux-arm64\r\n      - akash-windows-amd64\r\n    name_template: \"{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}\"\r\n    wrap_in_directory: true\r\n    format: zip\r\n    files:\r\n      - none*\r\n\r\ndockers:\r\n  - ids:\r\n      - akash-linux-amd64\r\n    dockerfile: _build/Dockerfile.akash\r\n    goos: linux\r\n    goarch: amd64\r\n    image_templates:\r\n      - 'ghcr.io/ovrclk/akash:{{if eq .Env.MAINNET \"true\"}}stable{{else}}latest{{end}}'\r\n      - 'ghcr.io/ovrclk/akash:{{ .ShortCommit }}'\r\n      - 'ghcr.io/ovrclk/akash:{{ .Version }}'\r\n\r\nbrews:\r\n  - name: \"{{ .Env.HOMEBREW_NAME }}\"\r\n    tap:\r\n      owner: ovrclk\r\n      name: homebrew-tap\r\n    homepage: \"https://akash.network\"\r\n    description: \"Blockchain-powered decentralized compute platform\"\r\n    custom_block: |\r\n      {{ .Env.HOMEBREW_CUSTOM }}\r\n    install: |\r\n      bin.install \"akash\"\r\n    ids:\r\n      - akash-darwin-universal\r\n\r\nnfpms:\r\n  - vendor: \"Overclock Labs Inc.\"\r\n    homepage: \"http://ovrclk.com\"\r\n    maintainer: \"Akash Network <hello@akash.network>\"\r\n    formats:\r\n      - deb\r\n      - rpm\r\n    license: Apache 2.0\r\n\r\nrelease:\r\n  github:\r\n    owner: ovrclk\r\n    name: akash\r\n  prerelease: auto\r\n  mode: replace\r\n  draft: false\r\n```\r\n</details>\n\n### How can we reproduce this?\n\napply the following diff to the https://github.com/ovrclk/akash\r\n```diff\r\ndiff --git a/.goreleaser.yaml b/.goreleaser.yaml\r\nindex 4b75e9f1..7176dcfe 100644\r\n--- a/.goreleaser.yaml\r\n+++ b/.goreleaser.yaml\r\n@@ -95,11 +95,19 @@ builds:\r\n       - \"{{ .Env.BUILD_VARS }}\"\r\n       - \"{{ .Env.STRIP_FLAGS }}\"\r\n       - \"-linkmode={{ .Env.LINKMODE }}\"\r\n+\r\n+universal_binaries:\r\n+  - id: akash-darwin-universal\r\n+    ids:\r\n+      - akash-darwin-amd64\r\n+      - akash-darwin-arm64\r\n+    name_template: '{{ .ProjectName }}'\r\n+    replace: true\r\n+\r\n archives:\r\n   - id: akash\r\n     builds:\r\n-      - akash-darwin-amd64\r\n-      - akash-darwin-arm64\r\n+      - akash-darwin-universal\r\n       - akash-linux-amd64\r\n       - akash-linux-arm64\r\n       - akash-windows-amd64\r\n@@ -119,6 +127,7 @@ dockers:\r\n       - 'ghcr.io/ovrclk/akash:{{if eq .Env.MAINNET \"true\"}}stable{{else}}latest{{end}}'\r\n       - 'ghcr.io/ovrclk/akash:{{ .ShortCommit }}'\r\n       - 'ghcr.io/ovrclk/akash:{{ .Version }}'\r\n+\r\n brews:\r\n   - name: \"{{ .Env.HOMEBREW_NAME }}\"\r\n     tap:\r\n@@ -130,6 +139,8 @@ brews:\r\n       {{ .Env.HOMEBREW_CUSTOM }}\r\n     install: |\r\n       bin.install \"akash\"\r\n+    ids:\r\n+      - akash-darwin-universal\r\n \r\n nfpms:\r\n   - vendor: \"Overclock Labs Inc.\"\r\n```\r\n\r\n**execute**\r\n```shell\r\nGORELEASER_SKIP_VALIDATE=true make release-dry-run\r\n```\n\n### goreleaser version\n\n```bash\ngoreleaser version 1.5.0\r\ncommit: 55d7eabc79d41e073cc4592c350c1f4c7f527eb3\r\nbuilt at: 2022-02-12T17:22:26Z\r\nbuilt by: goreleaser\r\ngoos: linux\r\ngoarch: arm64\r\nmodule version: v1.5.0, checksum: h1:l4BxBt2Rrk5Tngmzyrcp7H/CszXSA0guzL4mPo4peAU=\r\n\r\nhttps://goreleaser.com\r\n```\n```\n\n\n### GoReleaser Check\n\n- [X] goreleaser check shows no errors\n\n### Search\n\n- [X] I did search for other open and closed issues before opening this.\n\n### Code of Conduct\n\n- [X] I agree to follow this project's Code of Conduct\n\n### Additional context\n\n_No response_","closed_by":{"login":"caarlos0","id":245435,"node_id":"MDQ6VXNlcjI0NTQzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/245435?v=4","gravatar_id":"","url":"https://api.github.com/users/caarlos0","html_url":"https://github.com/caarlos0","followers_url":"https://api.github.com/users/caarlos0/followers","following_url":"https://api.github.com/users/caarlos0/following{/other_user}","gists_url":"https://api.github.com/users/caarlos0/gists{/gist_id}","starred_url":"https://api.github.com/users/caarlos0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caarlos0/subscriptions","organizations_url":"https://api.github.com/users/caarlos0/orgs","repos_url":"https://api.github.com/users/caarlos0/repos","events_url":"https://api.github.com/users/caarlos0/events{/privacy}","received_events_url":"https://api.github.com/users/caarlos0/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/goreleaser/goreleaser/issues/3027/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/goreleaser/goreleaser/issues/3027/timeline","performed_via_github_app":null,"state_reason":"completed"}