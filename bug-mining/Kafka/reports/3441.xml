<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:32:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14659] source-record-write-[rate|total] metrics include filtered records</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14659</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Source tasks in Kafka connect offer two sets of metrics (documented in &lt;a href=&quot;https://github.com/apache/kafka/blob/72cfc994f5675be349d4494ece3528efed290651/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/ConnectMetricsRegistry.java#L173-L191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ConnectMetricsRegistry.java&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Metric&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;source-record-poll-rate&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;The average per-second number of records produced/polled (before transformation) by this task belonging to the named source connector in this worker.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;source-record-write-rate&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;The average per-second number of records output from the transformations and written to Kafka for this task belonging to the named source connector in this worker. This is after transformations are applied and excludes any records filtered out by the transformations.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;There are also corresponding &quot;-total&quot; metrics that capture the total number of records polled and written for the metrics above, respectively.&lt;/p&gt;

&lt;p&gt;In short, the &quot;poll&quot; metrics capture the number of messages sourced pre-transformation/filtering, and the &quot;write&quot; metrics should capture the number of messages ultimately written to Kafka post-transformation/filtering. However, the implementation of the &lt;tt&gt;source-record-write-*&lt;/tt&gt;&#160; metrics &lt;em&gt;includes&lt;/em&gt; records filtered out by transformations (and also records that result in produce failures with the config &lt;tt&gt;errors.tolerance=all&lt;/tt&gt;).&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Details&quot;&gt;&lt;/a&gt;Details&lt;/h3&gt;

&lt;p&gt;In &lt;a href=&quot;https://github.com/apache/kafka/blob/a382acd31d1b53cd8695ff9488977566083540b1/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractWorkerSourceTask.java#L389-L397&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AbstractWorkerSourceTask.java&lt;/a&gt;, each source record is passed through the transformation chain where it is potentially filtered out, checked to see if it was in fact filtered out, and if so it is accounted for in the internal metrics via &lt;tt&gt;counter.skipRecord()&lt;/tt&gt;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SourceRecord preTransformRecord : toSend) {         
    retryWithToleranceOperator.sourceRecord(preTransformRecord);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SourceRecord record = transformationChain.apply(preTransformRecord);            
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ProducerRecord&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; producerRecord = convertTransformedRecord(record);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (producerRecord == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || retryWithToleranceOperator.failed()) {                
        counter.skipRecord();
        recordDropped(preTransformRecord);
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
    }
    ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;SourceRecordWriteCounter.skipRecord()&lt;/tt&gt; is implemented as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    ....
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; SourceRecordWriteCounter(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; batchSize, SourceTaskMetricsGroup metricsGroup) {
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; batchSize &amp;gt; 0;
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; metricsGroup != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.batchSize = batchSize;
        counter = batchSize;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.metricsGroup = metricsGroup;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void skipRecord() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (counter &amp;gt; 0 &amp;amp;&amp;amp; --counter == 0) {
            finishedAllWrites();
        }
    }
    ....
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void finishedAllWrites() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!completed) {
            metricsGroup.recordWrite(batchSize - counter);
            completed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For example: If a batch starts with 100 records, &lt;tt&gt;batchSize&lt;/tt&gt; and &lt;tt&gt;counter&lt;/tt&gt; will both be initialized to 100. If all 100 records get filtered out, &lt;tt&gt;counter&lt;/tt&gt; will be decremented 100 times, and &lt;tt&gt;finishedAllWrites()&lt;/tt&gt;will record the value 100 to the underlying &lt;tt&gt;source-record-write-*&lt;/tt&gt;&#160; metrics rather than 0, the correct value according to the documentation for these metrics.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Solutions&quot;&gt;&lt;/a&gt;Solutions&lt;/h3&gt;

&lt;p&gt;Assuming the documentation correctly captures the intent of the &lt;tt&gt;source-record-write-*&lt;/tt&gt;&#160; metrics, it seems reasonable to fix these metrics such that filtered records do not get counted.&lt;/p&gt;

&lt;p&gt;It may also be useful to add additional metrics to capture the rate and total number of records filtered out by transformations, which would require a KIP.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the best way of accounting for produce failures in the case of &lt;tt&gt;errors.tolerance=all&lt;/tt&gt; is yet. Maybe these failures deserve their own new metrics?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13521821">KAFKA-14659</key>
            <summary>source-record-write-[rate|total] metrics include filtered records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hgeraldino">Hector Geraldino</assignee>
                                    <reporter username="cbeard">Chris Beard</reporter>
                        <labels>
                    </labels>
                <created>Sat, 28 Jan 2023 01:42:56 +0000</created>
                <updated>Tue, 28 Feb 2023 14:50:23 +0000</updated>
                            <resolved>Tue, 28 Feb 2023 14:41:10 +0000</resolved>
                                                    <fixVersion>3.3.3</fixVersion>
                    <fixVersion>3.4.1</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 41 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ffuo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>