<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16667] KRaftMigrationDriver gets stuck after successive failovers</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16667</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This is a continuation of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16171&quot; title=&quot;Controller failover during ZK migration can prevent metadata updates to ZK brokers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16171&quot;&gt;&lt;del&gt;KAFKA-16171&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It turns out that the active KRaftMigrationDriver can get a stale read from ZK after becoming the active controller in ZK (i.e., writing to &quot;/controller&quot;).&lt;/p&gt;

&lt;p&gt;Because ZooKeeper only offers linearizability on writes to a given ZNode, it is possible that we get a stale read on the &quot;/migration&quot; ZNode after writing to &quot;/controller&quot; (and &quot;/controller_epoch&quot;) when becoming active.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The history looks like this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Node B becomes leader in the Raft layer. KRaftLeaderEvents are enqueued on all KRaftMigrationDriver&lt;/li&gt;
	&lt;li&gt;Node A writes some state to ZK, updates &quot;/migration&quot;, and checks &quot;/controller_epoch&quot; in one transaction. This happens before B claims controller leadership in ZK. The &quot;/migration&quot; state is updated from X to Y&lt;/li&gt;
	&lt;li&gt;Node B claims leadership by updating &quot;/controller&quot; and &quot;/controller_epoch&quot;. Leader B reads &quot;/migration&quot; state X&lt;/li&gt;
	&lt;li&gt;Node A tries to write some state, fails on &quot;/controller_epoch&quot; check op.&lt;/li&gt;
	&lt;li&gt;Node A processes new leader and becomes inactive&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This does not violate consistency guarantees made by ZooKeeper.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; Write operations in ZooKeeper are&#160;&lt;em&gt;linearizable&lt;/em&gt;. In other words, each&#160;&lt;tt&gt;write&lt;/tt&gt;&#160;will appear to take effect atomically at some point between when the client issues the request and receives the corresponding response.&lt;/p&gt;

&lt;p&gt;and&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; Read operations in ZooKeeper are&#160;&lt;em&gt;not linearizable&lt;/em&gt;&#160;since they can return potentially stale data. This is because a&#160;&lt;tt&gt;read&lt;/tt&gt;&#160;in ZooKeeper is not a quorum operation and a server will respond immediately to a client that is performing a&#160;&lt;tt&gt;read&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;---&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The impact of this stale read is the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16171&quot; title=&quot;Controller failover during ZK migration can prevent metadata updates to ZK brokers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16171&quot;&gt;&lt;del&gt;KAFKA-16171&lt;/del&gt;&lt;/a&gt;. The KRaftMigrationDriver never gets past SYNC_KRAFT_TO_ZK because it has a stale zkVersion for the &quot;/migration&quot; ZNode. The result is brokers never learn about the new controller and cannot update any partition state.&lt;/p&gt;

&lt;p&gt;The workaround for this bug is to re-elect the controller by shutting down the active KRaft controller.&#160;&lt;/p&gt;

&lt;p&gt;This bug was found during a migration where the KRaft controller was rapidly failing over due to an excess of metadata.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13578164">KAFKA-16667</key>
            <summary>KRaftMigrationDriver gets stuck after successive failovers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davidarthur">David Arthur</assignee>
                                    <reporter username="davidarthur">David Arthur</reporter>
                        <labels>
                    </labels>
                <created>Sat, 4 May 2024 18:02:27 +0000</created>
                <updated>Fri, 9 Aug 2024 23:01:51 +0000</updated>
                            <resolved>Fri, 9 Aug 2024 23:01:51 +0000</resolved>
                                                    <fixVersion>3.9.0</fixVersion>
                                    <component>controller</component>
                    <component>migration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17853376" author="soarez" created="Sat, 8 Jun 2024 13:20:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davidarthur&quot; class=&quot;user-hover&quot; rel=&quot;davidarthur&quot;&gt;davidarthur&lt;/a&gt; is this still relevant for 3.7.1? This is the only remaining issue in the 3.7.1 release plan.&#160;&lt;/p&gt;</comment>
                            <comment id="17853377" author="soarez" created="Sat, 8 Jun 2024 13:24:46 +0000"  >&lt;p&gt;I&apos;m removing the 3.7.1 tag for now. Please add it back if this should go in that release.&lt;/p&gt;</comment>
                            <comment id="17856169" author="jlprat" created="Wed, 19 Jun 2024 07:19:25 +0000"  >&lt;p&gt;Changing target fix version to 3.9 since this is not a blocker and we are past code freeze&lt;/p&gt;</comment>
                            <comment id="17872509" author="cmccabe" created="Fri, 9 Aug 2024 23:01:51 +0000"  >&lt;p&gt;Fixed in 3.9&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 13 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1p16o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>