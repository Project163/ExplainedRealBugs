<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13730] OAuth access token validation fails if it does not contain the &quot;sub&quot; claim</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13730</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Client authentication fails, when configured to use OAuth and the JWT access token does &lt;b&gt;not contain the sub claim&lt;/b&gt;. This issue was discovered while testing Kafka integration with Ping Identity OAuth server. According to Ping&apos;s &lt;a href=&quot;https://apidocs.pingidentity.com/pingone/devguide/v1/api/#access-tokens-and-id-tokens&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;sub &#8211; A string that specifies the identifier for the authenticated user. This claim is not present for client_credentials tokens.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In this case Kafka broker rejects the token regardless of the &lt;a href=&quot;https://kafka.apache.org/documentation/#brokerconfigs_sasl.oauthbearer.sub.claim.name&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sasl.oauthbearer.sub.claim.name&lt;/a&gt; property value.&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Steps to reproduce:&lt;/p&gt;

&lt;p&gt;1. Client configuration:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;security.protocol=SASL_PLAINTEXT
sasl.mechanism=OAUTHBEARER
sasl.login.callback.handler.class=org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerLoginCallbackHandler
sasl.oauthbearer.token.endpoint.url=https://oauth.server.fqdn/token/endpoint
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required\
 clientId=&quot;kafka-client&quot;\
 clientSecret=&quot;kafka-client-secret&quot;;
sasl.oauthbearer.sub.claim.name=client_id # claim name for the principal to be extracted from, needed for client side validation too
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. Broker configuration:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sasl.enabled.mechanisms=...,OAUTHBEARER
listener.name.sasl_plaintext.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required;
listener.name.sasl_plaintext.oauthbearer.sasl.server.callback.handler.class=org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler
sasl.oauthbearer.jwks.endpoint.url=https://oauth.server.fqdn/jwks/endpoint
sasl.oauthbearer.expected.audience=oauth-audience # based on OAuth server setup
sasl.oauthbearer.sub.claim.name=client_id # claim name for the principal to be extracted from
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. Try to perform some client operation:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;kafka-topics --bootstrap-server `hostname`:9092 --list --command-config oauth-client.properties
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Result:&lt;/p&gt;

&lt;p&gt;Client authentication fails due to invalid access token.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;client log:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2022-03-11 16:21:20,461] ERROR [AdminClient clientId=adminclient-1] Connection to node -1 (localhost/127.0.0.1:9092) failed authentication due to: {&quot;status&quot;:&quot;invalid_token&quot;} (org.apache.kafka.clients.NetworkClient)
[2022-03-11 16:21:20,463] WARN [AdminClient clientId=adminclient-1] Metadata update failed due to authentication error (org.apache.kafka.clients.admin.internals.AdminMetadataManager)
org.apache.kafka.common.errors.SaslAuthenticationException: {&quot;status&quot;:&quot;invalid_token&quot;}
Error while executing topic command : {&quot;status&quot;:&quot;invalid_token&quot;}
[2022-03-11 16:21:20,468] ERROR org.apache.kafka.common.errors.SaslAuthenticationException: {&quot;status&quot;:&quot;invalid_token&quot;}
 (kafka.admin.TopicCommand$)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;broker log:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2022-03-11 16:21:20,150] WARN Could not validate the access token: JWT (claims-&amp;gt;{&quot;client_id&quot;:&quot;...&quot;,&quot;iss&quot;:&quot;...&quot;,&quot;iat&quot;:1647012079,&quot;exp&quot;:1647015679,&quot;aud&quot;:[...],&quot;env&quot;:&quot;...&quot;,&quot;org&quot;:&quot;...&quot;}) rejected due to invalid claims or other invalid content. Additional details: [[14] No Subject (sub) claim is present.] (org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler)
org.apache.kafka.common.security.oauthbearer.secured.ValidateException: Could not validate the access token: JWT (claims-&amp;gt;{&quot;client_id&quot;:&quot;...&quot;,&quot;iss&quot;:&quot;...&quot;,&quot;iat&quot;:1647012079,&quot;exp&quot;:1647015679,&quot;aud&quot;:[...],&quot;env&quot;:&quot;...&quot;,&quot;org&quot;:&quot;...&quot;}) rejected due to invalid claims or other invalid content. Additional details: [[14] No Subject (sub) claim is present.]
	at org.apache.kafka.common.security.oauthbearer.secured.ValidatorAccessTokenValidator.validate(ValidatorAccessTokenValidator.java:159)
	at org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler.handleValidatorCallback(OAuthBearerValidatorCallbackHandler.java:184)
	at org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerValidatorCallbackHandler.handle(OAuthBearerValidatorCallbackHandler.java:169)
	at org.apache.kafka.common.security.oauthbearer.internals.OAuthBearerSaslServer.process(OAuthBearerSaslServer.java:156)
	at org.apache.kafka.common.security.oauthbearer.internals.OAuthBearerSaslServer.evaluateResponse(OAuthBearerSaslServer.java:101)
	at org.apache.kafka.common.security.authenticator.SaslServerAuthenticator.handleSaslToken(SaslServerAuthenticator.java:451)
	at org.apache.kafka.common.security.authenticator.SaslServerAuthenticator.authenticate(SaslServerAuthenticator.java:280)
	at org.apache.kafka.common.network.KafkaChannel.prepare(KafkaChannel.java:181)
	at org.apache.kafka.common.network.Selector.pollSelectionKeys(Selector.java:543)
	at org.apache.kafka.common.network.Selector.poll(Selector.java:481)
	at kafka.network.Processor.poll(SocketServer.scala:989)
	at kafka.network.Processor.run(SocketServer.scala:892)
	at java.lang.Thread.run(Thread.java:748)
Caused by: org.jose4j.jwt.consumer.InvalidJwtException: JWT (claims-&amp;gt;{&quot;client_id&quot;:&quot;...&quot;,&quot;iss&quot;:&quot;...&quot;,&quot;iat&quot;:1647012079,&quot;exp&quot;:1647015679,&quot;aud&quot;:[...],&quot;env&quot;:&quot;...&quot;,&quot;org&quot;:&quot;...&quot;}) rejected due to invalid claims or other invalid content. Additional details: [[14] No Subject (sub) claim is present.]
	at org.jose4j.jwt.consumer.JwtConsumer.validate(JwtConsumer.java:466)
	at org.jose4j.jwt.consumer.JwtConsumer.processContext(JwtConsumer.java:311)
	at org.jose4j.jwt.consumer.JwtConsumer.process(JwtConsumer.java:433)
	at org.apache.kafka.common.security.oauthbearer.secured.ValidatorAccessTokenValidator.validate(ValidatorAccessTokenValidator.java:157)
	... 12 more
[2022-03-11 16:21:20,154] INFO [SocketServer listenerType=ZK_BROKER, nodeId=0] Failed authentication with /127.0.0.1 ({&quot;status&quot;:&quot;invalid_token&quot;}) (org.apache.kafka.common.network.Selector)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13433371">KAFKA-13730</key>
            <summary>OAuth access token validation fails if it does not contain the &quot;sub&quot; claim</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kirktrue">Kirk True</assignee>
                                    <reporter username="dfonai">Daniel Fonai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Mar 2022 15:46:29 +0000</created>
                <updated>Wed, 27 Jul 2022 16:21:05 +0000</updated>
                            <resolved>Wed, 27 Jul 2022 11:16:37 +0000</resolved>
                                    <version>3.1.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17504999" author="JIRAUSER286467" created="Fri, 11 Mar 2022 16:33:30 +0000"  >&lt;p&gt;Kafka delegates access token parsing to jose4j library and configures JWT consumer to require the sub claim to be present:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/secured/ValidatorAccessTokenValidator.java#L134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/secured/ValidatorAccessTokenValidator.java#L134&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This restriction might not be necessary, especially when the client principal is expected to be in another JWT claim. If the required client principal claim is not present,&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/secured/ValidatorAccessTokenValidator.java#L175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;subject extraction logic&lt;/a&gt; will throw an exception and validation will fail.&lt;/p&gt;</comment>
                            <comment id="17505011" author="JIRAUSER286467" created="Fri, 11 Mar 2022 16:57:05 +0000"  >&lt;p&gt;Although it would be reasonable to expect that OAuth JWT access tokens contain the &quot;sub&quot; claim (as it is the case with OpenID ID tokens), I haven&apos;t found any specification requiring it:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc6749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;OAuth 2.0 RFC&lt;/a&gt; does not specify any token format.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JWT RFC&lt;/a&gt; states that use of &quot;sub&quot; claim is optional in JWTs.&lt;/li&gt;
	&lt;li&gt;There is &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc9068.html#name-data-structure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 9068: JSON Web Token (JWT) Profile for OAuth 2.0 Access Tokens&lt;/a&gt; requiring the presence of sub claim, but it is in a proposed state yet.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With this in mind, it does not seem to be interfering in any way with OAuth standards to remove this requirement. However, it would have the benefit of extending Kafka OAuth support for additional OAuth providers.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17505095" author="kirktrue" created="Fri, 11 Mar 2022 19:39:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dfonai&quot; class=&quot;user-hover&quot; rel=&quot;dfonai&quot;&gt;dfonai&lt;/a&gt; - thanks for filing this and providing a PR. I&apos;ll take a look as soon as I can, though not until next week, probably.&lt;/p&gt;</comment>
                            <comment id="17505097" author="kirktrue" created="Fri, 11 Mar 2022 19:40:55 +0000"  >&lt;p&gt;I&apos;m unable to assign this to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dfonai&quot; class=&quot;user-hover&quot; rel=&quot;dfonai&quot;&gt;dfonai&lt;/a&gt;. I&apos;ll assign it to myself for now so that it doesn&apos;t fall of my radar.&lt;/p&gt;</comment>
                            <comment id="17507682" author="JIRAUSER286467" created="Wed, 16 Mar 2022 15:36:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; thank you for the quick response. Please let me know if you need anything from my side.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10et4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>