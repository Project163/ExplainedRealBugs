<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-18067] Kafka Streams can leak Producer client under EOS</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-18067</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Under certain conditions Kafka Streams can end up closing a producer client twice and creating a new one that then is never closed.&lt;/p&gt;

&lt;p&gt;During a StreamThread&apos;s shutdown, the TaskManager is closed first, through which the thread&apos;s producer client is also closed. Later on we call #unsubscribe on the main consumer, which can result in the #onPartitionsLost callback being invoked and ultimately trying to reset/reinitialize the StreamsProducer if EOS is enabled. This in turn includes closing the current producer and creating a new one. And since the current producer was already closed, we end up closing that client twice and never closing the newly created producer.&lt;/p&gt;

&lt;p&gt;Ideally we would just skip the reset/reinitialize process entirely when invoked during shutdown. This solves the two problems here (leaked client and double close), while also removing the unnecessary overhead of creating an entirely new client just to throw it away&lt;/p&gt;</description>
                <environment></environment>
        <key id="13599676">KAFKA-18067</key>
            <summary>Kafka Streams can leak Producer client under EOS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                            <label>newbie</label>
                            <label>newbie++</label>
                    </labels>
                <created>Fri, 22 Nov 2024 08:52:53 +0000</created>
                <updated>Thu, 3 Apr 2025 21:17:28 +0000</updated>
                            <resolved>Thu, 3 Apr 2025 21:17:28 +0000</resolved>
                                                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>4.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17900293" author="JIRAUSER305181" created="Fri, 22 Nov 2024 08:57:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;&lt;br/&gt;
I would like to give it a try, may I have this issue ?&lt;/p&gt;</comment>
                            <comment id="17900294" author="ableegoldman" created="Fri, 22 Nov 2024 08:59:42 +0000"  >&lt;p&gt;imo we should just add a &quot;closed&quot; flag to the StreamsProducer and skip the reset method entirely if its already been closed.&lt;/p&gt;</comment>
                            <comment id="17900296" author="ableegoldman" created="Fri, 22 Nov 2024 09:05:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; Go for it!&lt;/p&gt;</comment>
                            <comment id="17931937" author="cadonna" created="Mon, 3 Mar 2025 11:16:01 +0000"  >&lt;p&gt;We had to revert the fix for this bug (&lt;a href=&quot;https://github.com/apache/kafka/pull/19078&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/19078&lt;/a&gt;) because it introduces a blocking bug for AK 4.0. &lt;br/&gt;
The issue is that the fix prevented Kafka Streams from re-initializing its transactional producer under exactly-once semantics. That led to an infinite loop of {{ProducerFencedException}}s with corresponding rebalances.&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;1 A network partitions happens that causes the timeout of a transaction.&lt;/li&gt;
	&lt;li&gt;2 The transactional producer is fenced due to invalid producer epoch.&lt;/li&gt;
	&lt;li&gt;3 Kafka Streams closes the tasks dirty and re-joins the group, i.e., a rebalance is triggered.&lt;/li&gt;
	&lt;li&gt;4 The transactional producer is NOT re-initialized and does NOT get a new producer epoch.&lt;/li&gt;
	&lt;li&gt;5 Processing starts but the transactional producer is immediately fenced during the attempt to start a new transaction because of the invalid producer epoch.&lt;/li&gt;
	&lt;li&gt;step 3 is repeated&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17932778" author="ableegoldman" created="Wed, 5 Mar 2025 22:45:14 +0000"  >&lt;p&gt;thanks for catching this. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; since we had to revert the initial fix, want to revisit this issue and retry? Seems like we should not piggyback on the existing #close method to set the &quot;dont reinitialize&quot; flag, since it&apos;s not only called during shutdown but also during the `#resetProducer` method.&lt;/p&gt;

&lt;p&gt;Basically we want a separate method that will &quot;permanently&quot; close the producer only for when the thread is shutting down, and set the flag in there.&lt;/p&gt;</comment>
                            <comment id="17932826" author="JIRAUSER305181" created="Thu, 6 Mar 2025 04:56:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for the information.&lt;/p&gt;

&lt;p&gt;Sure, I definitely will try it again, and I&apos;m sorry for the previous failed one.&lt;/p&gt;

&lt;p&gt;I will ping you on the new PR once it&apos;s ready. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            35 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1spn4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>