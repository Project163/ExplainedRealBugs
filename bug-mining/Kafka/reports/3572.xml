<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:34:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13973] block-cache-capacity metrics worth twice as much as normal</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13973</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have created a very simple kafka-streams application with 1 state store. I&apos;m very surprised that the block-cache-capacity metrics show a&#160;&lt;tt&gt;100MB&lt;/tt&gt;&#160;block cache capacity instead of the default one in kafka streams is&#160;&lt;tt&gt;50MB&lt;/tt&gt;.&lt;br/&gt;
&#160;&lt;br/&gt;
My topology :&lt;br/&gt;
StreamsBuilder sb = new StreamsBuilder();&lt;br/&gt;
sb.stream(&quot;input&quot;)&lt;br/&gt;
        .groupByKey()&lt;br/&gt;
        .count()&lt;br/&gt;
        .toStream()&lt;br/&gt;
        .to(&quot;output&quot;);&lt;br/&gt;
&#160;&lt;br/&gt;
I checkout the &lt;tt&gt;kafka-streams&lt;/tt&gt;&#160;code and I saw a strange thing. When the&#160;&lt;tt&gt;RocksDBTimestampedStore&lt;/tt&gt;store is created, we try to create two column families for backward compatibility with a potentiel old key/value store.&lt;/p&gt;

&lt;p&gt;In this method,&#160;&lt;tt&gt;setDbAccessor(col1, col2)&lt;/tt&gt;&#160;if the first column is not valid, well you close this one (&lt;a href=&quot;https://github.com/apache/kafka/blob/4542acdc14d5ec3daa1f36d8dc24abc244ee24ff/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBTimestampedStore.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;L102&lt;/a&gt;). But regarding the rocksdb instance, it&apos;s seems that the column families is not deleted completely and the metrics exposed by&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/4542acdc14d5ec3daa1f36d8dc24abc244ee24ff/streams/src/main/java/org/apache/kafka/streams/state/internals/metrics/RocksDBMetricsRecorder.java#L373&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Rocksdb continue to aggregate (L373)&lt;/a&gt;&#160;{{block-cache-capacity }}for both column families (default and keyValueWithTimestamp).&lt;/p&gt;

&lt;p&gt;Maybe you have to drop explicitly the column family, in the&#160;&lt;tt&gt;setDbAccessor(col1, col2)&lt;/tt&gt;&#160;if the first column is not valid (like&#160;&lt;tt&gt;db.dropColumnFamily(noTimestampColumnFamily);&lt;/tt&gt;)&lt;br/&gt;
&#160;&lt;br/&gt;
I tried to drop the &lt;tt&gt;noTimestampColumnFamily in setDbAccessor if the first column is not valid like :&#160;&lt;/tt&gt;&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void setDbAccessor(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ColumnFamilyHandle noTimestampColumnFamily,
                           &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ColumnFamilyHandle withTimestampColumnFamily) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; RocksDBException {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RocksIterator noTimestampsIter = db.newIterator(noTimestampColumnFamily);
    noTimestampsIter.seekToFirst();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (noTimestampsIter.isValid()) {
        log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Opening store {} in upgrade mode&quot;&lt;/span&gt;, name);
        dbAccessor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DualColumnFamilyAccessor(noTimestampColumnFamily, withTimestampColumnFamily);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Opening store {} in regular mode&quot;&lt;/span&gt;, name);
        dbAccessor = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SingleColumnFamilyAccessor(withTimestampColumnFamily);
        noTimestampColumnFamily.close();
        db.dropColumnFamily(noTimestampColumnFamily); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; fix it
&lt;/span&gt;    }
    noTimestampsIter.close();
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;But it&apos;s seems that you can&apos;t drop the default column family in RocksDb (see screenshot).&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;{{&lt;b&gt;So how can we have the real block-cache-capacity metrics value in Kafka Streams monitoring ?&lt;/b&gt; }}&lt;/p&gt;</description>
                <environment></environment>
        <key id="13449160">KAFKA-13973</key>
            <summary>block-cache-capacity metrics worth twice as much as normal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nicktelford">Nicholas Telford</assignee>
                                    <reporter username="LGouellec">Sylvain Le Gouellec</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Jun 2022 06:56:05 +0000</created>
                <updated>Fri, 20 Oct 2023 15:53:59 +0000</updated>
                            <resolved>Mon, 18 Sep 2023 09:10:48 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.1</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17551999" author="cadonna" created="Thu, 9 Jun 2022 07:12:25 +0000"  >&lt;p&gt;I do not think that the increased block cache capacity you see is caused by the &lt;a href=&quot;https://github.com/apache/kafka/blob/4542acdc14d5ec3daa1f36d8dc24abc244ee24ff/streams/src/main/java/org/apache/kafka/streams/state/internals/metrics/RocksDBMetricsRecorder.java#L373&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;aggregation of the RocksDB metrics&lt;/a&gt; you pointed to. That line aggregates metrics that come from multiple segments in a segmented state store &#8212; basically multiple RocksDB state stores. It does not aggregate metrics coming from multiple column families.&lt;/p&gt;</comment>
                            <comment id="17552007" author="JIRAUSER284798" created="Thu, 9 Jun 2022 07:33:03 +0000"  >&lt;p&gt;GH Issue in rocksdb side to allow dropping the default column family : &lt;a href=&quot;https://github.com/facebook/rocksdb/issues/10138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/rocksdb/issues/10138&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17552009" author="JIRAUSER284798" created="Thu, 9 Jun 2022 07:35:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt; : &quot;It does not aggregate metrics coming from multiple column families.&quot;&lt;/p&gt;

&lt;p&gt;Are you sure ? Check the javadoc of :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
db.getAggregatedLongProperty(...)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13044824/13044824_Screenshot+2022-06-09+at+09.33.50.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17554192" author="cadonna" created="Tue, 14 Jun 2022 16:38:54 +0000"  >&lt;p&gt;I think we misunderstood each other, I was referring to the aggregation in the &lt;tt&gt;else&lt;/tt&gt;-branch. &lt;/p&gt;</comment>
                            <comment id="17738231" author="mjsax" created="Wed, 28 Jun 2023 18:05:02 +0000"  >&lt;p&gt;The GitHub issue for RocksDB was &quot;declined&quot;. I did file a follow up ticker for Speedb (&lt;a href=&quot;https://github.com/speedb-io/speedb/issues/583)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/speedb-io/speedb/issues/583)&lt;/a&gt; &#8211; maybe we get help there.&lt;/p&gt;</comment>
                            <comment id="17760835" author="nicktelford" created="Thu, 31 Aug 2023 09:57:17 +0000"  >&lt;p&gt;The bug here is that we use &lt;tt&gt;getAggregatedLongProperty&lt;/tt&gt; instead of &lt;tt&gt;getLongProperty&lt;/tt&gt; to fetch the Block Cache metrics.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;getAggregatedLongProperty&lt;/tt&gt; will get the property from each column-family in the database, and return the sum of those values.&lt;/p&gt;

&lt;p&gt;RocksDB&apos;s Block Cache is configured on a per-column family basis, although in practice, RocksDBStore always uses the same Block Cache for all column families in the backing database. Note: this is orthogonal to whether the user has configured the Block Cache to be shared among multiple stores.&lt;/p&gt;

&lt;p&gt;This means that when we aggregate the block cache properties across column families, we&apos;re querying the same block cache multiple times, and yielding a value that is multiplied by the number of column families.&lt;/p&gt;

&lt;p&gt;The solution is simple: switch to using &lt;tt&gt;getLongProperty&lt;/tt&gt; here, which will query the properties on the default column family alone. Since all column families share the same block cache, it&apos;s sufficient to query a single CF for the block cache metrics.&lt;/p&gt;

&lt;p&gt;A fix is available here: &lt;a href=&quot;https://github.com/apache/kafka/pull/14317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14317&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13044820" name="Screenshot 2022-06-09 at 08.55.36.png" size="811371" author="LGouellec" created="Thu, 9 Jun 2022 06:55:46 +0000"/>
                            <attachment id="13044824" name="Screenshot 2022-06-09 at 09.33.50.png" size="506250" author="LGouellec" created="Thu, 9 Jun 2022 07:35:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z132xc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>