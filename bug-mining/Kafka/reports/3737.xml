<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16349] ShutdownableThread fails build by calling Exit with race condition</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16349</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;`ShutdownableThread` calls `Exit.exit()` when the thread&apos;s operation throws FatalExitError. In normal operation, this calls System.exit, and exits the process. In tests, the exit procedure is masked with Exit.setExitProcedure to prevent tests that encounter a FatalExitError from crashing the test JVM.&lt;/p&gt;

&lt;p&gt;Masking of exit procedures is usually done in BeforeEach/AfterEach annotations, with the exit procedures cleaned up immediately after the test finishes. If the body of the test creates a ShutdownableThread that outlives the test, such as by omitting `ShutdownableThread#awaitShutdown`, by having `ShutdownableThread#awaitShutdown` be interrupted by a test timeout, or by a race condition between `Exit.resetExitProcedure` and `Exit.exit`, then System.exit() can be called erroneously.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// First, in the test thread:
Exit.setExitProcedure(...)
try {
    new ShutdownableThread(...).start()
} finally {
    Exit.resetExitProcedure()
}
// Second, in the ShutdownableThread:
try {
    throw new FatalExitError(...)
} catch (FatalExitError e) {
    Exit.exit(...) // Calls real System.exit()
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This can be resolved by one of the following:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Eliminate FatalExitError usages in code when setExitProcedure is in-use&lt;/li&gt;
	&lt;li&gt;Eliminate the Exit.exit call from ShutdownableThread, and instead propagate this error to another thread to handle without a race-condition&lt;/li&gt;
	&lt;li&gt;Eliminate resetExitProcedure by refactoring Exit to be non-static&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;FatalExitError is in use in a small number of places, but may be difficult to eliminate:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FinalizedFeatureChangeListener&lt;/li&gt;
	&lt;li&gt;InterBrokerSendThread&lt;/li&gt;
	&lt;li&gt;TopicBasedRemoteLogMetadataManager&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There are many other places where Exit is called from a background thread, including some implementations of ShutdownableThread which don&apos;t use FatalExitError.&lt;/p&gt;

&lt;p&gt;The effect of this bug is that the build is flaky, as race conditions/timeouts in tests can cause the gradle executors to exit with status code 1, which has happened 26 times in the last 28 days. I have not yet been able to confirm this bug is happening in other tests, but I do have a deterministic reproduction case with the exact same symptoms:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Gradle Test Run :core:test &amp;gt; Gradle Test Executor 38 &amp;gt; ShutdownableThreadTest &amp;gt; testShutdownWhenTestTimesOut(boolean) &amp;gt; &quot;testShutdownWhenTestTimesOut(boolean).isInterruptible=true&quot; SKIPPED
FAILURE: Build failed with an exception.
* What went wrong:
Execution failed for task &apos;:core:test&apos;.
&amp;gt; Process &apos;Gradle Test Executor 38&apos; finished with non-zero exit value 1
&#160; This problem might be caused by incorrect test process configuration.
&#160; For more on test execution, please refer to https://docs.gradle.org/8.6/userguide/java_testing.html#sec:test_execution in the Gradle documentation.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13571069">KAFKA-16349</key>
            <summary>ShutdownableThread fails build by calling Exit with race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gharris1727">Greg Harris</assignee>
                                    <reporter username="gharris1727">Greg Harris</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Mar 2024 22:34:24 +0000</created>
                <updated>Fri, 29 Mar 2024 03:08:33 +0000</updated>
                            <resolved>Fri, 29 Mar 2024 03:08:33 +0000</resolved>
                                    <version>3.8.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17824207" author="ijuma" created="Wed, 6 Mar 2024 22:41:49 +0000"  >&lt;p&gt;Good catch.&lt;/p&gt;</comment>
                            <comment id="17830010" author="gharris1727" created="Sat, 23 Mar 2024 00:08:51 +0000"  >&lt;p&gt;I did some more exploration here.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Some of the &quot;exit 1&quot; failures I included in my count earlier are caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15343&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15343&lt;/a&gt; and so was an overestimate. This particular failure doesn&apos;t happen all that often.&lt;/li&gt;
	&lt;li&gt;There are more places affected than just those using FatalExitError.
	&lt;ol&gt;
		&lt;li&gt;I found the ReplicaVerificationTool calls Exit from ReplicaBuffer#verifyChecksum, which is within a ShutdownableThread#doWork implementation.&lt;/li&gt;
		&lt;li&gt;When a test uses org.junit.rules.Timeout, it runs the test in a separate thread. Fortunately, most of these usages are in streams which doesn&apos;t use Exit.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;There are &lt;em&gt;many&lt;/em&gt; tests of classes that use Exit without mocking, that happen to deterministically never test those code branches (e.g. testing the CommandDefaultOptions subclasses).
	&lt;ol&gt;
		&lt;li&gt;The signatures of classes don&apos;t make it clear to developers that they sometimes call Exit&lt;/li&gt;
		&lt;li&gt;The branches which call Exit are less-tested, possibly because they require additional mocking, and are not visible from the signature.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Some usages of Exit have an extremely deep call-stack, and are therefore difficult to refactor. Here are some possible approaches, which can be applied on a case-by-case basis:
	&lt;ol&gt;
		&lt;li&gt;Passing an instance down the call-stack&lt;/li&gt;
		&lt;li&gt;Throwing a checked exception up the call-stack&lt;/li&gt;
		&lt;li&gt;Throwing an unchecked exception up the call-stack (e.g. FatalExitError)&lt;/li&gt;
		&lt;li&gt;Changing the return type from `void` to `int` or T to Optional&amp;lt;T&amp;gt; and use c-like error handling&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think that it would be good to move away from the pattern of hiding a call to Exit deep in the call stack, so the self-documenting function parameter and checked exceptions are good options to recommend. In particular, I think I like using exceptions to propagate the need to exit up the call-stack, giving an opportunity for finally clauses to run. Then the top-level of each thread/entry point can handle the exception and call out. The unchecked exception has the chance to not be handled further up the call stack, and the c-like error handling isn&apos;t idiomatic Java.&lt;/p&gt;

&lt;p&gt;Because of the number of calls to Exit and the breadth of changes needed, it isn&apos;t reasonable to perform this migration in one step, so both the old and new solution will need to coexist. I prototyped a &quot;SafeExit&quot; class that I feel good about promoting as the replacement for Exit. It behaves similar to the Time class, and can be used by some classes while others still use Exit.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I&apos;ll propose SafeExit in a PR soon, with a test that demonstrates how it should be used, along with a small migration guide&lt;/li&gt;
	&lt;li&gt;I&apos;ll do some more research to try and figure out which call-sites are most likely to be causing the failed builds&lt;/li&gt;
	&lt;li&gt;Myself and other contributors can address call-sites for Exit over time, prioritizing the places most likely to have race conditions&lt;/li&gt;
	&lt;li&gt;After all call-sites for Exit are removed, we can remove the class entirely&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17830590" author="gharris1727" created="Mon, 25 Mar 2024 16:43:23 +0000"  >&lt;p&gt;I added a tactical fix for the Exit class in my PR to resolve this bug. I&apos;ll pursue this refactor in a separate ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16420&quot; title=&quot;Refactor utils.Exit call-sites to use thread-safe alternative&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16420&quot;&gt;KAFKA-16420&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13573229">KAFKA-16420</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ntw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>