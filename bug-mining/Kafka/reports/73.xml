<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-351] Refactor some new components introduced for replication </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-351</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Jay had some good refactoring suggestions as part of the review for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-46&quot; title=&quot;Commit thread, ReplicaFetcherThread for intra-cluster replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-46&quot;&gt;&lt;del&gt;KAFKA-46&lt;/del&gt;&lt;/a&gt;. I&apos;d like to file this umbrella JIRA with individual sub tasks to cover those suggestions&lt;/p&gt;</description>
                <environment></environment>
        <key id="12558227">KAFKA-351</key>
            <summary>Refactor some new components introduced for replication </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>optimization</label>
                    </labels>
                <created>Sat, 26 May 2012 02:26:50 +0000</created>
                <updated>Mon, 30 Oct 2017 12:18:23 +0000</updated>
                            <resolved>Tue, 21 Aug 2012 17:25:50 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                                                            <aggregatetimeoriginalestimate seconds="259200">72h</aggregatetimeoriginalestimate>
                                        <aggregatetimeremainingestimate seconds="259200">72h</aggregatetimeremainingestimate>
                                                <comments>
                            <comment id="13422562" author="nehanarkhede" created="Wed, 25 Jul 2012 20:07:01 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-405&quot; title=&quot;Improve the high water mark maintenance to store high watermarks for all partitions in a single file on disk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-405&quot;&gt;&lt;del&gt;KAFKA-405&lt;/del&gt;&lt;/a&gt; -&lt;/p&gt;

&lt;p&gt;ReplicaManager:&lt;/p&gt;

&lt;p&gt;This class has a very odd public interface. Instead of managing replicas it has a bunch of passive calls--addLocalReplica(), addRemoteReplica(), etc. Who calls these? KafkaServer seems to have its own wrapper for these. Then it passes these methods on as arguments to KafkaZookeeper. Does this make sense? I think it would be good if ReplicaManager handled replica management, even if that means it depends on zookeeper.&lt;/p&gt;</comment>
                            <comment id="13433303" author="junrao" created="Mon, 13 Aug 2012 17:07:26 +0000"  >&lt;p&gt;Attach patch v1. An overview of the patch.&lt;br/&gt;
A. Use synchronized instead of lock for synchronization. The latter has more functionality, but more overhead. See&lt;br/&gt;
&lt;a href=&quot;http://blog.rapleaf.com/dev/2011/06/16/java-performance-synchronized-vs-lock/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://blog.rapleaf.com/dev/2011/06/16/java-performance-synchronized-vs-lock/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;B. Partition: Consolidated all reads/writes to leader/ISR in Partition and all accessed are synchronized. This makes sure that leader/ISR values don&apos;t change while doing the following operations.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;makeLeader&lt;/li&gt;
	&lt;li&gt;makerFollower&lt;/li&gt;
	&lt;li&gt;maybeShrinkISR&lt;/li&gt;
	&lt;li&gt;updateLeaderHWAndMaybeExpandISR (for maintaining remote replicas)&lt;/li&gt;
	&lt;li&gt;checkEnoughReplicasReachAnOffset (for checking if a produce request is satisfied)&lt;br/&gt;
This means that Partition has to access ReplicaManager. In some sense, Partition probably should be a nested class under ReplicaManager since it needs to access several members of ReplicaManager. However, this will make ReplicaManager too big.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;C. RepicaManager:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Moved most per partition operations to Partition.&lt;/li&gt;
	&lt;li&gt;Cleaned up public methods and added a few helper methods for getting partition and replica.&lt;/li&gt;
	&lt;li&gt;Use ConcurrentHashMap for managing all partitions.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;D. KafkaApis: Removed callbacks in the constructer. Instead, call methods in ReplicaManager directly.&lt;/p&gt;

&lt;p&gt;E. Replica:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Changed to the new getter/setter style for logEndOffset and highWatermark.&lt;/li&gt;
	&lt;li&gt;Local replica doesn&apos;t need to set logEndOffset anymore since the logEndOffsetUpdateTime for local replica is never used.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;F. BrokerPartitionInfo: Partition is now a complex structure and is supposed to be used only on the server side. Create a simpler PartitionAndLeader class for client usage.&lt;/p&gt;

&lt;p&gt;G. KafkaZookeeper: Removed ensurePartitionLeaderOnThisBroker(). The checking of the existence of a leader is now done by replicaManager.leaderReplicaIfLocalOrException(), which is cheaper since it doesn&apos;t access ZK.&lt;/p&gt;

&lt;p&gt;H. ISRExpirationTest: Remove the test testISRExpirationForMultiplePartitions. It doesn&apos;t seem to add additional value since ISR expiration is always done on a per partition basis.&lt;/p&gt;

&lt;p&gt;I. SyncProducerTest: Remove the test testProducRequestForUnknowTopic since the logic is always covered by #1 in testProduceCorrectlyReceivesResponse.&lt;/p&gt;

&lt;p&gt;J. TestUtils: Added a helper method leaderLocalOnBroker() that more reliably ensures that a leader exists on a broker.&lt;/p&gt;

&lt;p&gt;K. TopicCounTest: removed since it&apos;s not doing any useful test.&lt;/p&gt;

&lt;p&gt;L. ZookeeperConsumerConnectorTest.testCompressionSetConsumption(): removed the part that tests consumer timeout since it&apos;s covered in testBasic already.&lt;/p&gt;</comment>
                            <comment id="13433322" author="junrao" created="Mon, 13 Aug 2012 17:13:20 +0000"  >&lt;p&gt;I still see some transient failures in unit tests, most of which seem to be due to leader not ready. I will probably wait until kafka-369 is committed since it fixes some of those issues.&lt;/p&gt;</comment>
                            <comment id="13433385" author="junrao" created="Mon, 13 Aug 2012 18:24:41 +0000"  >&lt;p&gt;Another change in the patch:&lt;br/&gt;
M. Currently, on leaderAndISR request, the broker gets and creates all assigned replicas. In this patch, the broker only creates replicas in ISR (since they are required in the logic for shrinking ISR). Other remote replicas are created on demand during the handling for follower fetch requests. This will make implementing kafka-42 a bit easier since newly bootstrapped replicas can be added on demand.&lt;/p&gt;</comment>
                            <comment id="13434292" author="nehanarkhede" created="Tue, 14 Aug 2012 17:40:08 +0000"  >&lt;p&gt;Jun, The patch didn&apos;t apply cleanly on a fresh checkout of the 0.8 branch. Do you mind uploading another patch after rebasing ?&lt;/p&gt;</comment>
                            <comment id="13435323" author="junrao" created="Wed, 15 Aug 2012 17:26:56 +0000"  >&lt;p&gt;Attach patch v2 after rebase. Made one more change:&lt;br/&gt;
N. Make logEndOffset and highWaterMark in replica atomic long. This is because java doesn&apos;t guarantee consistency of long value if not synchronized. &lt;/p&gt;</comment>
                            <comment id="13436579" author="junrao" created="Fri, 17 Aug 2012 06:07:07 +0000"  >&lt;p&gt;Attach patch v3. Just a rebase.&lt;/p&gt;</comment>
                            <comment id="13437038" author="nehanarkhede" created="Fri, 17 Aug 2012 20:20:38 +0000"  >&lt;p&gt;Thanks for the patch! Overall, this refactoring is a good change. Here are a few review comments -&lt;/p&gt;

&lt;p&gt;1. TestUtils. How about renaming leaderLocalOnBroker to isLeaderLocalOnBroker ?&lt;/p&gt;

&lt;p&gt;2. LogOffsetTest:&lt;br/&gt;
2.1. The change in testGetOffsetsForUnknownTopic doesn&apos;t look right. Since the topic &quot;foo&quot; doesn&apos;t exist, the client should get back UnknownTopicException. The partition is not invalid, it doesn&apos;t even exist.&lt;/p&gt;

&lt;p&gt;3. SyncProducerTest&lt;br/&gt;
3.1 Same here, client should get back UnknownTopicException, not InvalidPartitionException&lt;/p&gt;

&lt;p&gt;4. ISRExpirationTest&lt;br/&gt;
4.1 getLogWithLogEndOffset expected 6 calls for log.logEndOffset since the test exercised that API 6 times during correct operation. If you change it to anyTimes, it will hide problems with either the test or the code. Was it changed to&lt;br/&gt;
get rid of some transient test failure ?&lt;br/&gt;
4.2 Minor formatting: For consistency, you might want to change to first letter caps for error messages. So far, I don&apos;t think everyone quite followed this. So some log statements have first letter caps, others don&apos;t. I personally prefer&lt;br/&gt;
 first letter caps for all log statements.&lt;/p&gt;

&lt;p&gt;5. Replica&lt;br/&gt;
5.1 Is there a reason why logEndOffsetUpdateTimeMs is not AtomicLong ? It&apos;s access is not protected by a lock.&lt;br/&gt;
5.2 What is the difference between private&lt;span class=&quot;error&quot;&gt;&amp;#91;this&amp;#93;&lt;/span&gt; var and private var ?&lt;br/&gt;
5.3 It&apos;s great that you changed logEndOffset to use the new getter/setter API convention. I think there is only one drawback to using that. I don&apos;t know a way to search the code to list all places that use the setter. Do you ?&lt;/p&gt;

&lt;p&gt;6. Partition&lt;br/&gt;
6.1 Rename addReplicaIfNotExist to addReplicaIfNotExists.&lt;br/&gt;
6.2 In getOrCreateLog, it is better to use case match, since in Scala case match always evaluates to some value. Since this API needs to return the Replica object, using case match will protect against code bugs. Instead of if-else that checks isDefined, case-match handles Options naturally, since it forces you to handle all the cases. Same for makeLeader, makeFollower, checkEnoughReplicasReachAnOffset since they also return some value.&lt;br/&gt;
6.3 Looks like assignedReplicaMap is meant to be a map of replica_id-&amp;gt;Replica. It might be a good idea to change Pool to handle Options. Options are much easier to use than handling null values. For example, getReplica can reduce to just returning assignedReplicaMap.get(replicaId), instead of the if-else checking for nulls.&lt;br/&gt;
6.5 Minor formatting comment same as 4.2&lt;br/&gt;
6.6. maybeIncrementLeaderHW: Since you are trying to access inSyncReplicas here, this method should be synchronized on the leaderAndIsrUpdateLock&lt;br/&gt;
6.7 getOutOfSyncReplicas, updateISR: Same as 6.6&lt;br/&gt;
6.8 checkEnoughReplicasReachAnOffset: &lt;br/&gt;
6.8.1 We should probably rename this to checkEnoughReplicasReachOffset. &lt;/p&gt;

&lt;p&gt;7. ReplicaManager&lt;br/&gt;
7.1 I think leaderReplicas was a poorly chosen name by me in the past. It should be renamed to leaderPartitions since it is the set of partitions with their leader hosted on the local broker. Also, that would mean we should rename leaderReplicasLock to leaderPartitionsLock&lt;br/&gt;
7.2 Same as 6.3 for allPartitions. This will greatly simplify getOrCreatePartition&lt;br/&gt;
7.3 Same as 4.2 for some of the APIs&lt;br/&gt;
7.4 Fix typo: shuttedd down &lt;br/&gt;
7.5 Fix identation and parenthesis style for checkpointHighWatermarks. &lt;br/&gt;
7.6 Same as 6.2 for becomeLeaderOrFollower &lt;br/&gt;
7.7 I wonder if it is better to rename leaderReplicaIfLocalOrException to getLeaderReplicaIfLocal ?&lt;/p&gt;</comment>
                            <comment id="13437205" author="junrao" created="Sat, 18 Aug 2012 01:29:58 +0000"  >&lt;p&gt;Thanks for the review. &lt;/p&gt;

&lt;p&gt;2,3. The difficulty is that a broker currently doesn&apos;t cache all topic/partitions (only controller does that). It only knows about topic/partitions assigned to itself. So, it&apos;s hard for a broker distinguish between a missing topic and a missing partition. We could cache all topic/partitions in all brokers, but we need to add additional ZK logic in each broker. So, in this patch, just combined UnknownTopicException and InvailidPartitionException into a more general UnknowTopicPartitionException. It&apos;s not ideal, but probably not too painful for the user to understand.&lt;/p&gt;

&lt;p&gt;5.1 That&apos;s a good point. Moved the update (which updates logEndOffsetUpdateTimeMs) of logEndOffset into Partition.updateLeaderHWAndMaybeExpandISR(). This way, both the reader and the writer of logEndOffsetUpdateTimeMs is synchronized by leaderISRUpdateLock. So, there is no need to make it an AtomicLong.&lt;/p&gt;

&lt;p&gt;6.3 Just not to make this patch too large. I will create a separate jira for changing the Pool api to use Option.&lt;/p&gt;

&lt;p&gt;6.6 and 6.7 Both methods are only called in Partition and the caller already synchronizes on leaderISRUpdateLock.&lt;/p&gt;

&lt;p&gt;The rest of the comments have been addressed.&lt;/p&gt;</comment>
                            <comment id="13437207" author="junrao" created="Sat, 18 Aug 2012 01:38:25 +0000"  >&lt;p&gt;Upload patch v5 to fix an svn rename issue.&lt;/p&gt;</comment>
                            <comment id="13437994" author="nehanarkhede" created="Mon, 20 Aug 2012 16:40:54 +0000"  >&lt;p&gt;Thanks for incorporating review suggestions!&lt;/p&gt;

&lt;p&gt;2.3 Agreed that it is a bit of work to get meaningful error codes in the client. Often this is ignored, but client contract should be very well thought out and easy to understand. It is best if we give the most descriptive error code, but if we feel it takes significant amount of work, we can start with a simple solution. We went through a pretty detailed review of the new request formats, but not error codes. It will be good to go through this before the release.&lt;/p&gt;

&lt;p&gt;5.1 That change is correct. However, in Replica.scala, highWatermarkValue and logEndOffsetValue are synchronized via AtomicLong, but not logEndOffsetUpdateTime. Right now, like you said, there is only one API that updates/reads logEndOffsetUpdateTime and it synchronizes those accesses. But since these are Replica APIs, I&apos;m pretty sure there will be more places in the code that will either update or read the logEndOffset/logEndOffsetUpdateTime and each of those APIs would have to synchronize those accesses. For what it&apos;s worth, changing it to AtomicLong actually protects us from future synchronization errors and is not much of a performance hit as well. &lt;/p&gt;

&lt;p&gt;8. HighwatermarkPersistenceTest. Fix fail error message to say KafkaException instead of IllegalStateException. I forgot to do this in my patch when I added this test, it will be great if you can include this minor change.&lt;/p&gt;

&lt;p&gt;9. Minor comment - Probably better to rename UnknownTopicPartition to UnknownTopicOrPartitionException.&lt;/p&gt;</comment>
                            <comment id="13438455" author="junrao" created="Tue, 21 Aug 2012 05:01:22 +0000"  >&lt;p&gt;Thanks for the review. Attach patch v6.&lt;/p&gt;

&lt;p&gt;5.1 Changed logEndOffsetUpdateTime to AtomicLong.&lt;/p&gt;

&lt;p&gt;8,9: Fixed.&lt;/p&gt;

&lt;p&gt;Optimized Replica.getOutOfSyncReplicas() a bit to avoid the unnecessary check for leader replica.&lt;/p&gt;

&lt;p&gt;Rebased.&lt;/p&gt;</comment>
                            <comment id="13438852" author="nehanarkhede" created="Tue, 21 Aug 2012 16:56:31 +0000"  >&lt;p&gt;+1 &lt;/p&gt;

&lt;p&gt;Minor comments before checking it in - &lt;/p&gt;

&lt;p&gt;1. Fix comment in UnknownTopicOrPartitionException.scala. Right now it describes InvalidPartitionException&lt;br/&gt;
2. Replica - Fix error message &quot;shouldn&apos;t set logEndOffset for replica %d topic %s partition %d since it&apos;s local&quot; to first letter capital&lt;/p&gt;</comment>
                            <comment id="13438885" author="junrao" created="Tue, 21 Aug 2012 17:25:50 +0000"  >&lt;p&gt;Thanks for the review. Addressed the issues in the last review and committed to 0.8.&lt;/p&gt;

&lt;p&gt;Create kafka-476 to track using Option in Pool.&lt;/p&gt;

&lt;p&gt;For priviate&lt;span class=&quot;error&quot;&gt;&amp;#91;this&amp;#93;&lt;/span&gt; var, it restricts the usage of a member field to only this instance of the class. This way, one is always forced to use the public api to access the member field in other instances of the class. &lt;/p&gt;

&lt;p&gt;Yes, Intellij seems to have an issue finding references of x_=(), which is inconvenient. Not sure if it has been addressed in a new version.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12540699" name="kafka-351_v1.patch" size="105056" author="junrao" created="Mon, 13 Aug 2012 17:07:26 +0000"/>
                            <attachment id="12541091" name="kafka-351_v2.patch" size="106957" author="junrao" created="Wed, 15 Aug 2012 17:26:56 +0000"/>
                            <attachment id="12541330" name="kafka-351_v3.patch" size="106875" author="junrao" created="Fri, 17 Aug 2012 06:07:07 +0000"/>
                            <attachment id="12541457" name="kafka-351_v4.patch" size="123296" author="junrao" created="Sat, 18 Aug 2012 01:29:58 +0000"/>
                            <attachment id="12541459" name="kafka-351_v5.patch" size="124042" author="junrao" created="Sat, 18 Aug 2012 01:38:25 +0000"/>
                            <attachment id="12541713" name="kafka-351_v6.patch" size="125605" author="junrao" created="Tue, 21 Aug 2012 05:01:22 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12558876">KAFKA-354</subtask>
                            <subtask id="12558877">KAFKA-355</subtask>
                            <subtask id="12558897">KAFKA-356</subtask>
                            <subtask id="12558898">KAFKA-357</subtask>
                            <subtask id="12603477">KAFKA-458</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>299091</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i15zjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243058</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>