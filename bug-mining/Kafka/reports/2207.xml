<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:17:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8062] StateListener is not notified when StreamThread dies</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8062</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I want my application to react when streams die. Trying to use&#160;KafkaStreams.setStateListener. Also checking KafkaStreams.state() from time to time.&lt;/p&gt;

&lt;p&gt;The test scenario: Kafka is available, but there&#160;are no topics that&#160;my Topology is supposed to use.&lt;/p&gt;

&lt;p&gt;I expect streams to crash and the state listener to be notified about that, with the new state ERROR. KafkaStreams.state() should also return ERROR.&lt;/p&gt;

&lt;p&gt;In reality the streams crash, but the KafkaStreams.state() method always returns REBALANCING and the last time the StateListener was called, the new state was also REBALANCING.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I believe the reason for this is in the methods:&lt;/p&gt;

&lt;p&gt;org.apache.kafka.streams.KafkaStreams.StreamStateListener.onChange() which does not react on the state StreamsThread.State.PENDING_SHUTDOWN&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;org.apache.kafka.streams.processor.internals.StreamThread.RebalanceListener.onPartitionsAssigned, which&#160;calls shutdown() setting the state to PENDING_SHUTDOWN and then&lt;/p&gt;

&lt;p&gt;streamThread.setStateListener(null) effectively removing the state listener, so that the DEAD state of the thread never reaches KafkaStreams object.&lt;/p&gt;

&lt;p&gt;Here is an extract from the logs:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;14:57:03.272 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; ERROR o.a.k.s.p.i.StreamsPartitionAssignor - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1-consumer&amp;#93;&lt;/span&gt; test-input-topic is unknown yet during rebalance, please make sure they have been pre-created before starting the Streams application.&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.283 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.c.c.i.AbstractCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1-consumer, groupId=Test&amp;#93;&lt;/span&gt; Successfully joined group with generation 1&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.284 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.c.c.i.ConsumerCoordinator - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1-consumer, groupId=Test&amp;#93;&lt;/span&gt; Setting newly assigned partitions []&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.285 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.s.p.i.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; Informed to shut down&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.285 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.s.p.i.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; State transition from PARTITIONS_REVOKED to PENDING_SHUTDOWN&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.316 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.s.p.i.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; Shutting down&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.317 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.c.c.KafkaConsumer - &lt;span class=&quot;error&quot;&gt;&amp;#91;Consumer clientId=Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1-restore-consumer, groupId=&amp;#93;&lt;/span&gt; Unsubscribed all topics or patterns and assigned partitions&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.317 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.c.p.KafkaProducer - &lt;span class=&quot;error&quot;&gt;&amp;#91;Producer clientId=Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1-producer&amp;#93;&lt;/span&gt; Closing the Kafka producer with timeoutMillis = 9223372036854775807 ms.&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.332 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.s.p.i.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; State transition from PENDING_SHUTDOWN to DEAD&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;14:57:03.332 &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; INFO o.a.k.s.p.i.StreamThread - stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;Test-749d56c7-505d-46a4-8dbd-2c756b353adc-StreamThread-1&amp;#93;&lt;/span&gt; Shutdown complete&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;After this calls to KafkaStreams.state() still return REBALANCING&lt;/p&gt;

&lt;p&gt;There is a workaround with requesting KafkaStreams.localThreadsMetadata() and checking each thread&apos;s state manually, but that seems very wrong.&lt;/p&gt;</description>
                <environment>Kafka 2.1.1, kafka-streams-scala version 2.1.1</environment>
        <key id="13220223">KAFKA-8062</key>
            <summary>StateListener is not notified when StreamThread dies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="andrey.v.volkov">Andrey Volkov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Mar 2019 14:16:07 +0000</created>
                <updated>Tue, 19 Mar 2019 20:37:41 +0000</updated>
                            <resolved>Tue, 19 Mar 2019 14:13:33 +0000</resolved>
                                    <version>2.1.1</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16786882" author="bbejeck" created="Thu, 7 Mar 2019 15:27:19 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrey.v.volkov&quot; class=&quot;user-hover&quot; rel=&quot;andrey.v.volkov&quot;&gt;andrey.v.volkov&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for reporting this, can you share your topology to re-create the error locally?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Bill&lt;/p&gt;</comment>
                            <comment id="16786945" author="andrey.v.volkov" created="Thu, 7 Mar 2019 16:25:59 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bbejeck&quot; class=&quot;user-hover&quot; rel=&quot;bbejeck&quot;&gt;bbejeck&lt;/a&gt;, here is the whole code:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;object Application extends App {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; val props = new Properties()&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; props.put(StreamsConfig.APPLICATION_ID_CONFIG, &quot;Test&quot;)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;test-kafka-server:9092&quot;)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; implicit val consumed = Consumed.`with`(new StringSerde, new StringSerde)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; implicit val produced = Produced.`with`(new StringSerde, new StringSerde)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; val builder = new StreamsBuilder()&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; builder.stream(&quot;test-input-topic&quot;).to(&quot;test-output-topic&quot;)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; val topology = builder.build()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; val streams = new KafkaStreams(topology, props)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; streams.setStateListener((oldState, newState) =&amp;gt; {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; println(s&quot;State change: old = $oldState, new = $newState&quot;)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; })&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; streams.start()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; while (true) {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; println(s&quot;State: ${streams.state()}&quot;)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; Thread.sleep(5000)&lt;/tt&gt;&lt;br/&gt;
 }}&lt;/p&gt;</comment>
                            <comment id="16795459" author="githubbot" created="Mon, 18 Mar 2019 23:00:59 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6468: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8062&quot; title=&quot;StateListener is not notified when StreamThread dies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8062&quot;&gt;&lt;del&gt;KAFKA-8062&lt;/del&gt;&lt;/a&gt;: Do not remore StateListener when shutting down stream thread&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6468&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   In a previous commit &lt;a href=&quot;https://github.com/apache/kafka/pull/6091&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6091&lt;/a&gt;, we&apos;ve fixed a couple of edge cases and hence do not need to remove state listener anymore (before that we removed the state listener intentionally to avoid some race conditions, which has been gone for now).&lt;/p&gt;

&lt;p&gt;   Not removing the state listener would automatically fix the issue that when threads are shutting down due to error code, the instance-level state will not be transited to ERROR, and then eventually to NOT_RUNNING.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16796126" author="githubbot" created="Tue, 19 Mar 2019 14:12:53 +0000"  >&lt;p&gt;bbejeck commented on pull request #6468: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8062&quot; title=&quot;StateListener is not notified when StreamThread dies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8062&quot;&gt;&lt;del&gt;KAFKA-8062&lt;/del&gt;&lt;/a&gt;: Do not remore StateListener when shutting down stream thread&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6468&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16796140" author="bbejeck" created="Tue, 19 Mar 2019 14:27:43 +0000"  >&lt;p&gt;cherry-picked to 2.2 as well&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00gjc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>