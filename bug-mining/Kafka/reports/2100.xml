<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7536] TopologyTestDriver cannot pre-populate KTable or GlobalKTable</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7536</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have a GlobalKTable that&apos;s defined as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

GlobalKTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, ByteString&amp;gt; userIdsByEmail = topology          
   .globalTable(USER_IDS_BY_EMAIL.name,
                       USER_IDS_BY_EMAIL.consumed(),
                       Materialized.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;user-ids-by-email&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the following test in Spock:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    def topology = &lt;span class=&quot;code-comment&quot;&gt;// my topology
&lt;/span&gt;    def driver = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TopologyTestDriver(topology, config())

    def cleanup() {
        driver.close()
    }

    def &lt;span class=&quot;code-quote&quot;&gt;&quot;create from email request&quot;&lt;/span&gt;() {

        def store = driver.getKeyValueStore(&lt;span class=&quot;code-quote&quot;&gt;&apos;user-ids-by-email&apos;&lt;/span&gt;)
        store.put(&lt;span class=&quot;code-quote&quot;&gt;&apos;string&apos;&lt;/span&gt;, ByteString.copyFrom(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[0]))
        &lt;span class=&quot;code-comment&quot;&gt;// more, but it fails at the `put` above&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I run this, I get the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

[2018-10-23 19:35:27,055] INFO (org.apache.kafka.streams.processor.internals.GlobalStateManagerImpl) mock Restoring state &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; global store user-ids-by-email

java.lang.NullPointerException
	at org.apache.kafka.streams.processor.internals.AbstractProcessorContext.topic(AbstractProcessorContext.java:115)
	at org.apache.kafka.streams.state.internals.CachingKeyValueStore.putInternal(CachingKeyValueStore.java:237)
	at org.apache.kafka.streams.state.internals.CachingKeyValueStore.put(CachingKeyValueStore.java:220)
	at org.apache.kafka.streams.state.internals.CachingKeyValueStore.put(CachingKeyValueStore.java:38)
	at org.apache.kafka.streams.state.internals.InnerMeteredKeyValueStore.put(InnerMeteredKeyValueStore.java:206)
	at org.apache.kafka.streams.state.internals.MeteredKeyValueBytesStore.put(MeteredKeyValueBytesStore.java:117)
	at pony.message.MessageWriteStreamsTest.create from mailgun email request(MessageWriteStreamsTest.groovy:52)

[2018-10-23 19:35:27,189] INFO (org.apache.kafka.streams.processor.internals.StateDirectory) stream-thread [main] Deleting state directory 0_0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 0_0 as user calling cleanup.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The same issue applies to KTable.&lt;/p&gt;

&lt;p&gt;I&apos;ve noticed that I can &lt;tt&gt;put()&lt;/tt&gt; to the store if I first write to it with &lt;tt&gt;driver.pipeInput&lt;/tt&gt;. But otherwise I get the above error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13193715">KAFKA-7536</key>
            <summary>TopologyTestDriver cannot pre-populate KTable or GlobalKTable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="dminkovsky">Dmitry Minkovsky</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Oct 2018 23:41:18 +0000</created>
                <updated>Tue, 20 Nov 2018 22:49:20 +0000</updated>
                            <resolved>Tue, 20 Nov 2018 22:49:20 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16661490" author="dminkovsky" created="Tue, 23 Oct 2018 23:58:31 +0000"  >&lt;p&gt;Remarkable that &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5824&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-5824&lt;/a&gt; was closed today. I posted this by coincidence. It&apos;s maybe the same issue?&lt;/p&gt;</comment>
                            <comment id="16661564" author="mjsax" created="Wed, 24 Oct 2018 01:27:02 +0000"  >&lt;p&gt;Thanks for reporting this. Closing the other ticket is a coincidence. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Can you use `pipeInput()` as a workaround?&lt;/p&gt;</comment>
                            <comment id="16661567" author="mjsax" created="Wed, 24 Oct 2018 01:29:31 +0000"  >&lt;p&gt;Another workaround might be, to disable caching for the global store? Can you try this?&lt;/p&gt;</comment>
                            <comment id="16662413" author="dminkovsky" created="Wed, 24 Oct 2018 15:21:08 +0000"  >&lt;p&gt;Thank you.&lt;/p&gt;

&lt;p&gt;Yes, disabling cache makes the issue go away.&lt;/p&gt;

&lt;p&gt;I tested, and this affects regular KTable as well. Disabling cache makes that go away too. &lt;/p&gt;

&lt;p&gt;Not sure how I will work around this, either by abstracting store creation to make disabling cache easy for tests, or just by piping input. Looks like it will depend on the situation.&lt;/p&gt;</comment>
                            <comment id="16662566" author="mjsax" created="Wed, 24 Oct 2018 17:12:09 +0000"  >&lt;p&gt;Thanks for the information! Really helpful.&lt;/p&gt;</comment>
                            <comment id="16665271" author="dminkovsky" created="Fri, 26 Oct 2018 15:01:44 +0000"  >&lt;p&gt;You&apos;re welcome! Thank you for Kafka and Kafka Streams.&lt;/p&gt;</comment>
                            <comment id="16690719" author="githubbot" created="Sat, 17 Nov 2018 22:22:06 +0000"  >&lt;p&gt;guozhangwang opened a new pull request #5923: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7536&quot; title=&quot;TopologyTestDriver cannot pre-populate KTable or GlobalKTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7536&quot;&gt;&lt;del&gt;KAFKA-7536&lt;/del&gt;&lt;/a&gt;: Initialize TopologyTestDriver with non-null topic&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5923&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5923&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   In TopologyTestDriver constructor set non-null topic; and in unit test intentionally turn on caching to verify this case.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16690720" author="guozhang" created="Sat, 17 Nov 2018 22:22:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dminkovsky&quot; class=&quot;user-hover&quot; rel=&quot;dminkovsky&quot;&gt;dminkovsky&lt;/a&gt; I&apos;ve submitted a PR which I think should resolve your issue, please try it out: &lt;a href=&quot;https://github.com/apache/kafka/pull/5923&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5923&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16691010" author="mjsax" created="Sun, 18 Nov 2018 19:32:45 +0000"  >&lt;p&gt;Does this also affect 1.1.1 release? If yes, we should backport to 1.0 branch, too.&lt;/p&gt;</comment>
                            <comment id="16691128" author="guozhang" created="Sun, 18 Nov 2018 23:36:04 +0000"  >&lt;p&gt;Yeah I think so.&lt;/p&gt;</comment>
                            <comment id="16693853" author="githubbot" created="Tue, 20 Nov 2018 22:39:15 +0000"  >&lt;p&gt;guozhangwang closed pull request #5923: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7536&quot; title=&quot;TopologyTestDriver cannot pre-populate KTable or GlobalKTable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7536&quot;&gt;&lt;del&gt;KAFKA-7536&lt;/del&gt;&lt;/a&gt;: Initialize TopologyTestDriver with non-null topic&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5923&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5923&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java&lt;br/&gt;
index 0753b2a8e96..af8b073092b 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/AbstractProcessorContext.java&lt;br/&gt;
@@ -33,7 +33,7 @@&lt;/p&gt;

&lt;p&gt; public abstract class AbstractProcessorContext implements InternalProcessorContext &lt;/p&gt;
{
 
-    static final String NONEXIST_TOPIC = &quot;__null_topic__&quot;;
+    public static final String NONEXIST_TOPIC = &quot;__null_topic__&quot;;
     private final TaskId taskId;
     private final String applicationId;
     private final StreamsConfig config;
diff --git a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java
index 2abfd6354be..a11ae6b8df0 100644
--- a/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java
+++ b/streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java
@@ -325,7 +325,7 @@ public void onRestoreEnd(final TopicPartition topicPartition, final String store
                 new LogContext()
             );
             globalStateTask.initialize();
-            globalProcessorContext.setRecordContext(new ProcessorRecordContext(0L, -1L, -1, null, new RecordHeaders()));
+            globalProcessorContext.setRecordContext(new ProcessorRecordContext(0L, -1L, -1, ProcessorContextImpl.NONEXIST_TOPIC, new RecordHeaders()));
         }
&lt;p&gt; else &lt;/p&gt;
{
             globalStateManager = null;
             globalStateTask = null;
@@ -352,7 +352,7 @@ public void onRestoreEnd(final TopicPartition topicPartition, final String store
             task.initializeStateStores();
             task.initializeTopology();
             context = (InternalProcessorContext) task.context();
-            context.setRecordContext(new ProcessorRecordContext(0L, -1L, -1, null, new RecordHeaders()));
+            context.setRecordContext(new ProcessorRecordContext(0L, -1L, -1, ProcessorContextImpl.NONEXIST_TOPIC, new RecordHeaders()));
         }
&lt;p&gt; else {&lt;br/&gt;
             task = null;&lt;br/&gt;
             context = null;&lt;br/&gt;
diff --git a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
index bead079ce8d..3e95c731d9e 100644&lt;br/&gt;
&amp;#8212; a/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
+++ b/streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java&lt;br/&gt;
@@ -889,6 +889,23 @@ private void flushStore() {&lt;br/&gt;
         public void close() {}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldAllowPrePopulatingStatesStoresWithCachingEnabled() &lt;/p&gt;
{
+        final Topology topology = new Topology();
+        topology.addSource(&quot;sourceProcessor&quot;, &quot;input-topic&quot;);
+        topology.addProcessor(&quot;aggregator&quot;, new CustomMaxAggregatorSupplier(), &quot;sourceProcessor&quot;);
+        topology.addStateStore(Stores.keyValueStoreBuilder(
+            Stores.inMemoryKeyValueStore(&quot;aggStore&quot;),
+            Serdes.String(),
+            Serdes.Long()).withCachingEnabled(), // intentionally turn on caching to achieve better test coverage
+            &quot;aggregator&quot;);
+
+        testDriver = new TopologyTestDriver(topology, config);
+
+        store = testDriver.getKeyValueStore(&quot;aggStore&quot;);
+        store.put(&quot;a&quot;, 21L);
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldCleanUpPersistentStateStoresOnClose() {&lt;br/&gt;
         final Topology topology = new Topology();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 51 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zk7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>