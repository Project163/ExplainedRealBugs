<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12469] The topic names in the metrics do not retain their format when extracting through JMX.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12469</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have topic names that have a period in the name:&lt;/p&gt;

&lt;p&gt;product.order&lt;br/&gt;
 product.offering.price&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, for the metrics issued by JMX by a program that is a consumer of Kafka messages, the dots are replaced with an underscore:&lt;/p&gt;

&lt;p&gt;kafka.consumer&amp;lt;type=consumer-fetch-manager-metrics, client-id=consumer-export-4, topic=product_offering_price, partition=1&amp;gt;&amp;lt;&amp;gt;records-lead&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This creates a problem if I want to calculate the customer&apos;s lag in relation to the number of messages on Kafka.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But for the producer, this problem doesn&apos;t occur:&lt;/p&gt;

&lt;p&gt;kafka.producer&amp;lt;type=producer-topic-metrics, client-id=bss.data.verification.pi_1, topic=product.offering.price&amp;gt;&amp;lt;&amp;gt;record-send-total&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As a consumer I use Akka Alpakka. But I think it&apos;s using Apache library to connect to Kafka and report metrics via JMX.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13365351">KAFKA-12469</key>
            <summary>The topic names in the metrics do not retain their format when extracting through JMX.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apoorvmittal10">Apoorv Mittal</assignee>
                                    <reporter username="rafal_chmielewski">Rafa&#322; Chmielewski</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Mar 2021 21:25:32 +0000</created>
                <updated>Thu, 2 Oct 2025 16:30:48 +0000</updated>
                            <resolved>Tue, 31 Dec 2024 17:43:05 +0000</resolved>
                                                    <fixVersion>4.1.0</fixVersion>
                                    <component>consumer</component>
                    <component>metrics</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17552040" author="JIRAUSER290714" created="Thu, 9 Jun 2022 08:37:00 +0000"  >&lt;p&gt;We&apos;re hitting this bug as well when exporting JMX metrics from Kafka Connect workers (version 3.0.0)&lt;/p&gt;</comment>
                            <comment id="17882425" author="dhoard" created="Tue, 17 Sep 2024 14:31:16 +0000"  >&lt;p&gt;More information is required on the code/library/integration flow you use to capture/expose the JMX metrics.&lt;/p&gt;</comment>
                            <comment id="17882931" author="JIRAUSER307044" created="Thu, 19 Sep 2024 07:50:14 +0000"  >&lt;p&gt;We are experiencing the same problem. In our case, the topic is called &#8216;user.test.sviluppi&#8217;, in the producer metrics (on the right in the attached image) the name is correct while in the consumer metrics (on the left in the attached image) the dots are replaced by underscores. In our architecture we use Dynatrace agent to capture the metrics and this renaming does not allow us to link producer and consumer because for Dynatrace they integrate different topics. The behaviour can also be replicated with JConsole and with clients of various versions (see attached image).&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13071649/13071649_JConsole+-+Kafka+Client.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17893547" author="legojoey17" created="Mon, 28 Oct 2024 17:20:54 +0000"  >&lt;p&gt;Yep, +1 to this. In my particular case, I&apos;m using Kafka MirrorMaker2 (3.6.1) deployed via strimzi. Our JMX prometheus exporter (again, mostly via strimzi&apos;s &lt;tt&gt;jmxPrometheusExporter&lt;/tt&gt; metrics config) has a configuration like the following for JMX -&amp;gt; Prometheus mappings.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- pattern: kafka.connect.mirror&amp;lt;type=MirrorSourceConnector, target=(.+), topic=(.+), partition=(.+)&amp;gt;&amp;lt;&amp;gt;(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;-count|record-count|...)
  name: kafka_connect_mirror_mirrorsourceconnector_$4
  labels:
    target: &lt;span class=&quot;code-quote&quot;&gt;&quot;$1&quot;&lt;/span&gt;
    topic: &lt;span class=&quot;code-quote&quot;&gt;&quot;$2&quot;&lt;/span&gt;
    partition: &lt;span class=&quot;code-quote&quot;&gt;&quot;$3&quot;&lt;/span&gt;
  help: &lt;span class=&quot;code-quote&quot;&gt;&quot;Kafka MirrorMaker2 Source Connector metrics&quot;&lt;/span&gt;
  type: GAUGE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then we&apos;ve got these metrics being collected by a relatively plain Datadog &lt;tt&gt;openmetrics&lt;/tt&gt; collection. What I&apos;ve seen is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;record-count&lt;/tt&gt; will report the true topic name, including &lt;tt&gt;.&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;bye-count&lt;/tt&gt; will report a munged topic name, with &lt;tt&gt;.&lt;/tt&gt; transformed to &lt;tt&gt;_&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case it isn&apos;t just producer vs consumer metrics but it appears even the same metrics source (bean?) appears to have varying results.&lt;/p&gt;</comment>
                            <comment id="17897282" author="apoorvmittal10" created="Mon, 11 Nov 2024 21:59:33 +0000"  >&lt;p&gt;This &lt;a href=&quot;https://github.com/apache/kafka/blob/c92f16a727ebb44b0c44038fbfa254d425dffcae/clients/src/main/java/org/apache/kafka/clients/consumer/internals/FetchMetricsManager.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt; causes the issue. Git blame shows the change from March-2023. I need to look the older versions if it was always the case or this bug was introduced in later versions.&lt;/p&gt;

&lt;p&gt;May be we would require a KIP to correct this as as there might be some existing metrics dasboard on these metrics tags which can break. I am assigning the ticket to myself.&lt;/p&gt;</comment>
                            <comment id="17897284" author="apoorvmittal10" created="Mon, 11 Nov 2024 22:24:54 +0000"  >&lt;p&gt;I have checked with kafka-clients version 3.3.2 which has been released in Jan-2023 and it also outputs the topic names as in current kafka trunk i.e. kafka-producer outputs topic names as it is without `.` being replaced, while kafka-consumer does replace `.` with `_`. If we need to fix this then we have to deprecate older metrics and output new kafka-consumer metrics without replacement. I think it should require a KIP. Adding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=schofielaj&quot; class=&quot;user-hover&quot; rel=&quot;schofielaj&quot;&gt;schofielaj&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; for feedback, I can write the KIP if we require.&lt;/p&gt;</comment>
                            <comment id="17897411" author="chia7712" created="Tue, 12 Nov 2024 08:20:30 +0000"  >&lt;p&gt;+ 1 to unify the naming. &lt;/p&gt;</comment>
                            <comment id="17897570" author="schofielaj" created="Tue, 12 Nov 2024 13:37:07 +0000"  >&lt;p&gt;+1 to unification&lt;/p&gt;</comment>
                            <comment id="17897672" author="apoorvmittal10" created="Tue, 12 Nov 2024 17:29:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=schofielaj&quot; class=&quot;user-hover&quot; rel=&quot;schofielaj&quot;&gt;schofielaj&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Here is the writeup: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-1109%3A+Unifying+Kafka+Consumer+Topic+Metrics&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-1109%3A+Unifying+Kafka+Consumer+Topic+Metrics&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17897714" author="junrao" created="Tue, 12 Nov 2024 19:38:12 +0000"  >&lt;p&gt;We replaced dot with underscore in the metric name on the server side a while back (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1902&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-1902&lt;/a&gt;). Are the concerns in that Jira still valid? If we want to change the behavior, it would be useful to change it consistently on both the client and the server.&lt;/p&gt;</comment>
                            <comment id="17897750" author="apoorvmittal10" created="Tue, 12 Nov 2024 21:34:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; I verified kafka-producer, kafka-consumer and kafka-server (BrokerTopicMetrics) and find &quot;_&quot; only in kafka-consumer. The topic name in BrokerTopicMetrics also appears with &quot;.&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13072778/13072778_image-2024-11-12-21-32-55-180.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17897751" author="apoorvmittal10" created="Tue, 12 Nov 2024 21:37:17 +0000"  >&lt;p&gt;Also looking at the Mbeans I do not see `scope` prefix now.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13072782/13072782_Screenshot+2024-11-12+at+21.35.59.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17897760" author="apoorvmittal10" created="Tue, 12 Nov 2024 22:10:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; I also looked at this patch you mentioned &lt;a href=&quot;https://reviews.apache.org/r/30321/diff/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/30321/diff/2/&lt;/a&gt; and trunk code today, I do see toScope() method (now in java). But the `getScope()` method from Yammer metrics seems not being utilized anywhere directly (some other reporters might use that). But for JMX and Telemetry reporters we utilize MBean name. The Mbean name has been populated without &quot;.&quot; replacement.&lt;/p&gt;

&lt;p&gt;So I think we should have consitency within Mbean itself as current Jira points difference of topic name in Mbean itself.&lt;/p&gt;</comment>
                            <comment id="17898033" author="apoorvmittal10" created="Wed, 13 Nov 2024 19:38:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; If we need this then it might be worth to include it in Kafka 4.0 major release. I have already surfaced a discussion thread.&lt;/p&gt;</comment>
                            <comment id="17898453" author="junrao" created="Fri, 15 Nov 2024 01:42:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apoorvmittal10&quot; class=&quot;user-hover&quot; rel=&quot;apoorvmittal10&quot;&gt;apoorvmittal10&lt;/a&gt; : The issue was just with the Yammer metric reporter since it only uses the first four fields group, type, name and scope during reporting. We replaced dot with underscore in scope to make it work better with Graphite hierarchy. It would be useful to check if this is still an issue and if so, there are better ways to handle it.&lt;/p&gt;</comment>
                            <comment id="17898691" author="apoorvmittal10" created="Fri, 15 Nov 2024 17:09:10 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;, I went through the threads you mentioned again and here is my understanding.&lt;/p&gt;

&lt;p&gt;A metric can be of type Yammer or not, in Kafka. However, kafka-clients cannot have Yammer metrics.&lt;/p&gt;

&lt;p&gt;Yammer metrics uses four fields: group, type, name and scope, leaving the tags field. KafkaMetricsGroup class creates the scope field by filling from tags field and replacing &quot;.&quot; by &quot;_&quot;.&lt;/p&gt;

&lt;p&gt;The Mbean is created without any modification to tags name, no use of scope. And JMX and Telemetry Reporter uses Mbean name to output metrics.&lt;/p&gt;

&lt;p&gt;Problem:&lt;/p&gt;

&lt;p&gt;For certain kafka-consumer topic metrics (not Yammer) there happens replacement of &quot;.&quot; to &quot;_&quot; outside of KafkaMetricsGroup.&lt;/p&gt;

&lt;p&gt;Solution:&lt;/p&gt;

&lt;p&gt;The transformation should not be done for some, either for all or none. I would say it should be for none outside KafkaMetricsGroup.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To support graphite, we should continue filling the scope field as we today. This shall give uniform behaviour i.e. if reading by Graphite reporter then all topic metrics will have &quot;.&quot; replaced, else if reading by JMX or Telemetry reporter then all will have topic as it is (i.e. maintain uniform behaviour for tags and scope field across different metrics).&lt;/p&gt;

&lt;p&gt;As far as I see &lt;a href=&quot;https://graphite.readthedocs.io/en/latest/render_api.html#paths-and-wildcards&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Graphite documentation&lt;/a&gt;, I think they still use &quot;.&quot; hierarchy model. But I am not sure how old this documentation is. Coming to Ganglia, the jars are now based on dropwizard version of metrics-core as com.yammer was last updated in 2012 and then moved to dropwizard.&lt;/p&gt;

&lt;p&gt;I do think we should be moving away from Yammer, which something is a different discussion and I ll put my thoughts in a different KIP. But for this ticket I think the above mentioned solution should be implemented unless I am missing something.&#160;&lt;/p&gt;</comment>
                            <comment id="17898748" author="junrao" created="Fri, 15 Nov 2024 19:18:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apoorvmittal10&quot; class=&quot;user-hover&quot; rel=&quot;apoorvmittal10&quot;&gt;apoorvmittal10&lt;/a&gt; : Thanks for the update. &lt;a href=&quot;https://github.com/apache/kafka/pull/939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/939&lt;/a&gt; first introduced the replacement. It&apos;s probably just to follow the replacement in Yammer metric used by the old scala consumer. Since this replacement is only needed for Yammer reporter, we could avoid the replacement in the client metrics.&lt;/p&gt;</comment>
                            <comment id="17898751" author="apoorvmittal10" created="Fri, 15 Nov 2024 19:36:26 +0000"  >&lt;p&gt;Thanks for confirming &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;. Appreciate your time and feedback.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13365353">KAFKA-12470</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13630537">KAFKA-19753</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13071649" name="JConsole - Kafka Client.png" size="42772" author="iacopo.talevi" created="Thu, 19 Sep 2024 07:49:32 +0000"/>
                            <attachment id="13072782" name="Screenshot 2024-11-12 at 21.35.59.png" size="43742" author="apoorvmittal10" created="Tue, 12 Nov 2024 21:37:46 +0000"/>
                            <attachment id="13072778" name="image-2024-11-12-21-32-55-180.png" size="176757" author="apoorvmittal10" created="Tue, 12 Nov 2024 21:32:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            51 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ot5c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>