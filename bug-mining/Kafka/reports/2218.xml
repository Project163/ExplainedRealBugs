<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:17:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8159] Built-in serdes for signed numbers do not obey lexicographical ordering</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8159</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Currently we assume consistent ordering between serialized and deserialized keys,&#160;e.g. if the objects obey objA &amp;lt; objB &amp;lt; objC then the serialized Bytes will also obey bytesA &amp;lt; bytesB &amp;lt; bytesC. This is not true in general&#160;of the built-in serdes for signed numerical types (eg Integer, Long). Specifically, it is broken by the negative number representations which&#160;are lexicographically greater than (all) positive number representations.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One consequence of this is that an interactive query of a key range with a negative lower bound and positive upper bound (eg&#160;keyValueStore.range(-1, 1) will result in &quot;unexpected behavior&quot; depending on the specific store type.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For RocksDB stores with caching disabled, an empty iterator will be returned regardless of whether any records do exist in that range.&#160;&lt;/p&gt;

&lt;p&gt;For in-memory stores and ANY store with caching enabled, Streams will throw an unchecked exception and crash.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13224149">KAFKA-8159</key>
            <summary>Built-in serdes for signed numbers do not obey lexicographical ordering</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ableegoldman">A. Sophie Blee-Goldman</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Mar 2019 21:34:25 +0000</created>
                <updated>Fri, 31 Jul 2020 22:39:21 +0000</updated>
                                                                            <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16802286" author="ableegoldman" created="Tue, 26 Mar 2019 23:57:54 +0000"  >&lt;p&gt;Consider also a user may not explicitly want or need to search a negative keyspace, or have any negative keys, but could still&#160;find their streams app crashing from a query of the range&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;key - delta, key + delta&amp;#93;&lt;/span&gt; if they ever see a key &amp;lt; delta&lt;/p&gt;</comment>
                            <comment id="16803512" author="guozhang" created="Thu, 28 Mar 2019 01:29:40 +0000"  >&lt;p&gt;Thanks for reporting this. This is indeed an overlooked issue when looking at integer serdes.&lt;/p&gt;

&lt;p&gt;More generally speaking, today we are sorta assuming that all serdes used are aligned with lexicographic ordering of bytes: if a typed object A1.compareTo(A2) &amp;gt; 0, then their serialized bytes should have the same relationaship lexicographically. However Integer / Long serdes etc definitely does not obey this. So I&apos;d suggest upgrading this ticket to this more broader scope and use the multi-key range query as a specific observable issue of it.&lt;/p&gt;</comment>
                            <comment id="17111694" author="vvcephei" created="Wed, 20 May 2020 02:17:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thanks for pointing this out in the discussion for KIP-614.&lt;/p&gt;

&lt;p&gt;This may sound crazy, but I&apos;d actually say that we do &lt;em&gt;not&lt;/em&gt; assume that there is any relationship like key1 &amp;gt; key2 implies serialize(key1) &amp;gt; serialize(key2) .&lt;/p&gt;

&lt;p&gt;Rather, for store ordering, the ordering between key1 and key2 is &lt;em&gt;defined&lt;/em&gt; by the ordering between serialize(key1) and serialize(key2). In other words, if you select the current IntegerSerializer (as written), then -1 &lt;em&gt;actually is&lt;/em&gt; greater than 3. This may be bizarre, and it may not be intentional, but that&apos;s how IntegerSerializer defines it. If you wanted some other ordering (for example, if you were going to do range scans in a store), then you need to choose a serializer that gives you the ordering you want.&lt;/p&gt;

&lt;p&gt;As a less insane example, consider a complex record: Person(FirstName, LastName). Which greater, Person(Alex, Baldwin) or Person(Barry, Allen)? It seems like there are four possible answers:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Person(Alex, Baldwin) &amp;gt; Person(Barry, Allen) : We define the serde to put the &lt;b&gt;first&lt;/b&gt; name first &lt;em&gt;because&lt;/em&gt; we want the data sorted this way for the purpose of a range scan.&lt;/li&gt;
	&lt;li&gt;Person(Alex, Baldwin) &amp;lt; Person(Barry, Allen) : We define the serde to put the &lt;b&gt;last&lt;/b&gt; name first &lt;em&gt;because&lt;/em&gt; we want the data sorted this way for the purpose of a range scan.&lt;/li&gt;
	&lt;li&gt;We don&apos;t care because we&apos;ll never do a range scan. In this case, the we can use any serde that can round-trip the data, and we simply don&apos;t care how the data is ordered.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, I would not say that everything was hunky-dory because, as you pointed out, the cache and our two provided store types (TreeMap and RocksDB) did not display consistent behavior when serialize(to) &amp;lt; serialize(from). You&apos;ve corrected this in PR 6521, and now the contract is that in that case, any store implementation should return an empty iterator.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also I would not say that this ticket is &quot;not a bug&quot; because we actually didn&apos;t intend for these serdes to produce this ordering. It seems like the &quot;fix&quot; would simply be to offer new serdes that produce the ordering we desire. If someone wants to be able to scan over negative and positive numerical keys in their natural ordering, they would just provide our new serdes in the Materialized argument or StoreBuilder for whatever store they need to query.&lt;/p&gt;</comment>
                            <comment id="17112511" author="guozhang" created="Wed, 20 May 2020 18:21:35 +0000"  >&lt;p&gt;Hey John,&lt;/p&gt;

&lt;p&gt;What I was asking is actually beyond signed numerical types &amp;#8211; for which I agree offering new serdes as opt-in should be sufficient &amp;#8211; but for any types like you described in the example above. Today our javadoc for a range query looks like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /**
     * Get an iterator over a given range of keys. This iterator must be closed after use.
     * The returned iterator must be safe from {@link java.util.ConcurrentModificationException}s
     * and must not &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; values. No ordering guarantees are provided.
     * @param from The first key that could be in the range
     * @param to The last key that could be in the range
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; The iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; range.
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NullPointerException If &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; is used &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; from or to.
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InvalidStateStoreException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the store is not initialized
     */
    KeyValueIterator&amp;lt;K, V&amp;gt; range(K from, K to);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For most users the &lt;tt&gt;from&lt;/tt&gt; &amp;lt; &lt;tt&gt;to&lt;/tt&gt; relationship is implicitly define as `from.compareTo(to) &amp;lt;= 0`, however what they mostly also assume, but actually not guaranteed is that `serialize(from).compareTo(serialize(to)) &amp;lt;= 0`. And we should make it clear in the javadoc that the &quot;first / last&quot; key in the range is actually defined based on their serialized bytes, not by their objects, and it is user&apos;s responsibility to either make sure the serializers can correctly transfer the object ordering to bytes ordering, or have parameters passed in to &lt;tt&gt;from / to&lt;/tt&gt; to obey the bytes ordering already.&lt;/p&gt;</comment>
                            <comment id="17169187" author="ableegoldman" created="Fri, 31 Jul 2020 22:39:21 +0000"  >&lt;p&gt;A related bummer is that you can&apos;t do fetches over a range of positive and negative timestamps in a Window/Session store (well you can, you just won&apos;t get the behavior you&apos;d expect)&lt;/p&gt;

&lt;p&gt;I say &quot;related&quot; because we don&apos;t use the built-in serdes to serialize the long in a windowed key, we use ByteBuffer#putLong. But it has the same problem with our lexicographical bytes&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z014p4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>