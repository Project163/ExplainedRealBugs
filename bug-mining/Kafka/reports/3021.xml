<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12951] Infinite loop while restoring a GlobalKTable</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12951</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We encountered an issue a few time in some of our Kafka Streams application.&lt;br/&gt;
 After an unexpected restart of our applications, some instances have not been able to resume operating.&lt;/p&gt;

&lt;p&gt;They got stuck while trying to restore the state store of a GlobalKTable. The only way to resume operating was to manually delete their `state.dir`.&lt;/p&gt;

&lt;p&gt;We observed the following timeline:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;After the restart of the Kafka Streams application, it tries to restore its GlobalKTable&lt;/li&gt;
	&lt;li&gt;It seeks to the last checkpoint available on the {{&lt;tt&gt;state.dir&lt;/tt&gt;}}: 382 (&lt;a href=&quot;https://github.com/apache/kafka/blob/2.7.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java#L259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/2.7.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java#L259&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;The watermark (&lt;tt&gt;endOffset&lt;/tt&gt; results) returned the offset 383&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
handling ListOffsetResponse response &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; XX. Fetched offset 383, timestamp -1&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;We enter the loop: &lt;a href=&quot;https://github.com/apache/kafka/blob/2.7.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java#L279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/2.7.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java#L279&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Then we invoked the &lt;tt&gt;poll()&lt;/tt&gt;, but the poll returns nothing, so we enter: &lt;a href=&quot;https://github.com/apache/kafka/blob/2.7.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java#L306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/2.7.0/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStateManagerImpl.java#L306&lt;/a&gt; and we crash &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Global task did not make progress to restore state within 300000 ms.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The POD restart, and we encounter the same issue until we manually delete the &lt;tt&gt;state.dir&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding the topic, by leveraging the &lt;tt&gt;DumpLogSegment&lt;/tt&gt; tool, I can see:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;Offset 381&lt;/tt&gt; - Last business message received&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Offset 382&lt;/tt&gt; - Txn COMMIT (last message)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think the real culprit is that the checkpoint is &lt;tt&gt;383&lt;/tt&gt; instead of being &lt;tt&gt;382&lt;/tt&gt;. For information, the global topic is a &lt;b&gt;transactional topic&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;While experimenting with the API, it seems that the &lt;tt&gt;consumer.position()&lt;/tt&gt; call is a bit tricky, after a &lt;tt&gt;seek()&lt;/tt&gt; and a &lt;tt&gt;poll()&lt;/tt&gt;, it seems that the &lt;tt&gt;position()&lt;/tt&gt; is actually returning the seek position. After the &lt;tt&gt;poll()&lt;/tt&gt; call, even if no data is returned, the &lt;tt&gt;position()&lt;/tt&gt; is returning the LSO. I did an example on &lt;a href=&quot;https://gist.github.com/Dabz/9aa0b4d1804397af6e7b6ad8cba82dcb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/Dabz/9aa0b4d1804397af6e7b6ad8cba82dcb&lt;/a&gt; .&lt;/p&gt;</description>
                <environment></environment>
        <key id="13383956">KAFKA-12951</key>
            <summary>Infinite loop while restoring a GlobalKTable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="Dabz">Damien Gasparina</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Jun 2021 15:05:22 +0000</created>
                <updated>Tue, 29 Jun 2021 13:30:18 +0000</updated>
                            <resolved>Mon, 28 Jun 2021 22:31:06 +0000</resolved>
                                    <version>2.7.0</version>
                                    <fixVersion>2.7.2</fixVersion>
                    <fixVersion>2.8.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                    <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13272597">KAFKA-9274</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13385233">KAFKA-12980</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13142226">KAFKA-6607</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rz3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>