<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16217] Transactional producer stuck in IllegalStateException during close</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16217</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The producer is stuck during the close. It keeps retrying to abort the transaction but it never succeeds.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] 2024-02-01 17:21:22,804 [kafka-producer-network-thread | producer-transaction-bench-transaction-id-f60SGdyRQGGFjdgg3vUgKg] org.apache.kafka.clients.producer.internals.Sender run - [Producer clientId=producer-transaction-ben
ch-transaction-id-f60SGdyRQGGFjdgg3vUgKg, transactionalId=transaction-bench-transaction-id-f60SGdyRQGGFjdgg3vUgKg] Error in kafka producer I/O thread &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; aborting transaction:
java.lang.IllegalStateException: Cannot attempt operation `abortTransaction` because the previous call to `commitTransaction` timed out and must be retried
        at org.apache.kafka.clients.producer.internals.TransactionManager.handleCachedTransactionRequestResult(TransactionManager.java:1138)
        at org.apache.kafka.clients.producer.internals.TransactionManager.beginAbort(TransactionManager.java:323)
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:274)
        at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1583)
        at org.apache.kafka.common.utils.KafkaThread.run(KafkaThread.java:66) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With the additional log, I found the root cause. If the producer is in a bad transaction state(in my case, the TransactionManager.pendingTransition was set to commitTransaction and did not get cleaned), then the producer calls close and tries to abort the existing transaction, the producer will get stuck in the transaction abortion. It is related to the fix &lt;a href=&quot;https://github.com/apache/kafka/pull/13591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/13591&lt;/a&gt;.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13567100">KAFKA-16217</key>
            <summary>Transactional producer stuck in IllegalStateException during close</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="calvinliu">Calvin Liu</assignee>
                                    <reporter username="calvinliu">Calvin Liu</reporter>
                        <labels>
                            <label>transactions</label>
                    </labels>
                <created>Thu, 1 Feb 2024 23:38:49 +0000</created>
                <updated>Sun, 5 Jan 2025 03:38:55 +0000</updated>
                            <resolved>Mon, 29 Apr 2024 15:52:45 +0000</resolved>
                                    <version>3.6.1</version>
                    <version>3.7.0</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>clients</component>
                    <component>producer </component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17813432" author="jolshan" created="Thu, 1 Feb 2024 23:45:37 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=calvinliu&quot; class=&quot;user-hover&quot; rel=&quot;calvinliu&quot;&gt;calvinliu&lt;/a&gt; for filing this bug.&#160;&lt;br/&gt;
With &lt;a href=&quot;https://github.com/apache/kafka/pull/13591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/13591&lt;/a&gt; if we are in committing state and try to abort when closing, we catch an error on IllegalStateException. At this point, it is not possible to complete the transaction. Given that we can&apos;t move past this state, we should be able to close.&lt;/p&gt;

&lt;p&gt;The server will either abort the transaction due to timeout, or the new producer coming up with the same producer ID will abort the transaction.&lt;/p&gt;</comment>
                            <comment id="17815402" author="JIRAUSER298384" created="Wed, 7 Feb 2024 18:47:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; I have a UT which simulate the close issue &lt;a href=&quot;https://github.com/apache/kafka/pull/15336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15336&lt;/a&gt; Hope it helps to resolve the bug.&lt;/p&gt;</comment>
                            <comment id="17828089" author="kirktrue" created="Mon, 18 Mar 2024 20:19:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=calvinliu&quot; class=&quot;user-hover&quot; rel=&quot;calvinliu&quot;&gt;calvinliu&lt;/a&gt;&#8212;I reassigned this to you as you&apos;ve already started tackling it. Thanks!&lt;/p&gt;</comment>
                            <comment id="17840191" author="kirktrue" created="Tue, 23 Apr 2024 18:40:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=calvinliu&quot; class=&quot;user-hover&quot; rel=&quot;calvinliu&quot;&gt;calvinliu&lt;/a&gt;&#8212;I noticed the PR request 15541 is merged, but the status of this still &quot;In Progress.&quot; The bug lists the fix versions as 3.8.0, 3.7.1, and 3.6.3. Was the change in PR 15541 back-ported to those earlier versions?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17840502" author="JIRAUSER298384" created="Wed, 24 Apr 2024 16:08:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; The cherry-pick for the 3.7 is merged. For the 3.6.3 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; mentioned we may not have the 3.6.3 release.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/15791&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/15791&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17842049" author="JIRAUSER298384" created="Mon, 29 Apr 2024 15:52:27 +0000"  >&lt;p&gt;Resolve the ticket for now. If we want to merge the fix into 3.6, we can open the ticket again.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13529502">KAFKA-14831</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n5w0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>