<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:41:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1558] AdminUtils.deleteTopic does not work</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1558</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;the AdminUtils:.deleteTopic method is implemented as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    def deleteTopic(zkClient: ZkClient, topic: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) {
        ZkUtils.createPersistentPath(zkClient, ZkUtils.getDeleteTopicPath(topic))
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but the DeleteTopicCommand actually does&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    zkClient = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZkClient(zkConnect, 30000, 30000, ZKStringSerializer)
    zkClient.deleteRecursive(ZkUtils.getTopicPath(topic))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so I guess, that the &apos;createPersistentPath&apos; above should actually be &lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    def deleteTopic(zkClient: ZkClient, topic: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) {
        ZkUtils.deletePathRecursive(zkClient, ZkUtils.getTopicPath(topic))
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12730057">KAFKA-1558</key>
            <summary>AdminUtils.deleteTopic does not work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriharsha">Harsha</assignee>
                                    <reporter username="henning">Henning Schmiedehausen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 Jul 2014 23:49:49 +0000</created>
                <updated>Wed, 30 Aug 2023 16:28:42 +0000</updated>
                            <resolved>Thu, 9 Oct 2014 21:54:19 +0000</resolved>
                                    <version>0.8.1.1</version>
                                    <fixVersion>0.8.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14075653" author="junrao" created="Sun, 27 Jul 2014 17:20:26 +0000"  >&lt;p&gt;Delete topic is not supported in 0.8.1.1. It is implemented in trunk, but hasn&apos;t been fully tested. The way this works is not to delete the topic path directly. Instead, it first indicates in a separate path that we want to delete a topic. Once all data related to the topic is deleted, the controller will then delete the topic path.&lt;/p&gt;</comment>
                            <comment id="14097214" author="sriharsha" created="Thu, 14 Aug 2014 17:02:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Incase if you are not working on this I would like to start working on this JIRA. Thanks.&lt;/p&gt;</comment>
                            <comment id="14101440" author="junrao" created="Mon, 18 Aug 2014 22:36:44 +0000"  >&lt;p&gt;Sriharsha,&lt;/p&gt;

&lt;p&gt;Yes, you can take this one. Clark will explain how to reproduce the problem and attach the relevant logs. Thanks,&lt;/p&gt;</comment>
                            <comment id="14102617" author="nehanarkhede" created="Tue, 19 Aug 2014 18:39:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clarkhaskins&quot; class=&quot;user-hover&quot; rel=&quot;clarkhaskins&quot;&gt;clarkhaskins&lt;/a&gt;, please can you attach all the server logs here when delete topic fails?&lt;/p&gt;</comment>
                            <comment id="14112311" author="sriharsha" created="Wed, 27 Aug 2014 15:02:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clarkhaskins&quot; class=&quot;user-hover&quot; rel=&quot;clarkhaskins&quot;&gt;clarkhaskins&lt;/a&gt; can you please upload server logs for delete topic failures. Thanks.&lt;/p&gt;</comment>
                            <comment id="14122074" author="guozhang" created="Thu, 4 Sep 2014 22:11:18 +0000"  >&lt;p&gt;It would be really great to have this in 0.8.2, but not sure we can make it though..&lt;/p&gt;</comment>
                            <comment id="14122134" author="sriharsha" created="Thu, 4 Sep 2014 22:55:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I am waiting some logs to show up supposed issue. I can put in sometime this week get this done if someone can give me reproduction steps or logs. Thanks&lt;/p&gt;</comment>
                            <comment id="14129451" author="sriharsha" created="Thu, 11 Sep 2014 00:50:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Do you know any steps on reproducing this. Thanks.&lt;/p&gt;</comment>
                            <comment id="14129506" author="gwenshap" created="Thu, 11 Sep 2014 01:52:34 +0000"  >&lt;p&gt;I don&apos;t think the issue as described above exists an more. &lt;br/&gt;
I tested the trunk implementation of deleteTopic in simple cases and in all of them, if delete.topic.enable was true, the topic was deleted.&lt;/p&gt;

&lt;p&gt;I think what we need now is to test deleteTopic under failure modes - leader election, partition reassignment, etc.&lt;/p&gt;</comment>
                            <comment id="14130611" author="nehanarkhede" created="Thu, 11 Sep 2014 20:00:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think what we need now is to test deleteTopic under failure modes - leader election, partition reassignment, etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, it would help if someone who has cycles can take this up and basically try to break delete topic under various failure scenarios. Currently, the approach to fixing delete topic is a little ad-hoc.&lt;/p&gt;</comment>
                            <comment id="14130630" author="sriharsha" created="Thu, 11 Sep 2014 20:11:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gwenshap&quot; class=&quot;user-hover&quot; rel=&quot;gwenshap&quot;&gt;gwenshap&lt;/a&gt; Thanks for the info. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I am working on testing those cases mentioned above. Thanks.&lt;/p&gt;</comment>
                            <comment id="14130641" author="nehanarkhede" created="Thu, 11 Sep 2014 20:18:58 +0000"  >&lt;p&gt;Great. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; for taking this on.&lt;/p&gt;</comment>
                            <comment id="14133329" author="junrao" created="Sun, 14 Sep 2014 18:30:40 +0000"  >&lt;p&gt;Sriharsha,&lt;/p&gt;

&lt;p&gt;It would be useful to test if &quot;delete topic&quot; works under the following cases.&lt;br/&gt;
1. after the controller is restarted&lt;br/&gt;
2. after a soft failure (can simulate by pausing the jvm for longer that zk session timeout) of the controller&lt;br/&gt;
3. after a topic&apos;s partitions have been reassigned to some other brokers&lt;br/&gt;
4. after running a preferred leader command&lt;br/&gt;
5. after a topic&apos;s partition has been increased&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                            <comment id="14133333" author="sriharsha" created="Sun, 14 Sep 2014 18:38:28 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; will test those cases.&lt;/p&gt;</comment>
                            <comment id="14133468" author="nehanarkhede" created="Mon, 15 Sep 2014 00:56:03 +0000"  >&lt;p&gt;I&apos;ll add one more &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
After the controller broker is killed (kill -9)&lt;/p&gt;</comment>
                            <comment id="14134699" author="sriharsha" created="Mon, 15 Sep 2014 23:40:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I ran tests for above cases manually on a cluster 3 kafka nodes and 3 zookeeper nodes&lt;br/&gt;
for each of the tests topics are created and minimum size of the log per partition was &amp;gt; 1Gb&lt;/p&gt;

&lt;p&gt;1)  after the controller is restarted&lt;br/&gt;
   issuing delete topic is successful , metadata is deleted and also the log file without any errors.&lt;/p&gt;

&lt;p&gt;2)  after a soft failure (can simulate by pausing the jvm for longer that zk session timeout) of the controller&lt;br/&gt;
   I am not sure how to induce a pause in jvm , I tried with debug tools doesn&apos;t look it had any effect. If you have any pointers on this please let me know.&lt;/p&gt;

&lt;p&gt;3)  after a topic&apos;s partitions have been reassigned to some other brokers&lt;br/&gt;
     used kafka-reassign-partitions and ran delete topic command this resulted in successful deleting of metadata and topics log files&lt;/p&gt;

&lt;p&gt;4) after running a preferred leader command&lt;br/&gt;
     No issues here topic successfully deleted&lt;/p&gt;

&lt;p&gt;5) after a topic&apos;s partition has been increased&lt;br/&gt;
    No issues here either . new partition data also deleted&lt;/p&gt;

&lt;p&gt;6) controller broker is killed (kill -9)&lt;br/&gt;
  successfully deleted the topic and metadata. Once the killed controller back online the logfiles for that topic also got deleted.&lt;/p&gt;

&lt;p&gt;Please let me know on the case 2. If you have any more cases that you would like to test please let me know.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="14134742" author="junrao" created="Tue, 16 Sep 2014 00:22:41 +0000"  >&lt;p&gt;To simulate a soft failure of a broker, you can&lt;/p&gt;

&lt;p&gt;1. kill -SIGSTOP&lt;br/&gt;
2. wait for a bit longer than zk session timeout&lt;br/&gt;
3. kill -SIGCONT&lt;/p&gt;</comment>
                            <comment id="14135811" author="sriharsha" created="Tue, 16 Sep 2014 17:50:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&lt;br/&gt;
Case 2 works fine too the topic gets deleted.&lt;/p&gt;

&lt;p&gt;Case 6 when I do kill -9 on the controller and immediately run delete topic from the same node or on different node&lt;br/&gt;
one of the brokers goes on printing these messages&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-16 16:38:17,607&amp;#93;&lt;/span&gt; INFO Reconnect due to socket error: java.nio.channels.ClosedChannelException (kafka.consumer.SimpleConsumer)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-16 16:38:17,608&amp;#93;&lt;/span&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherThread-0-1&amp;#93;&lt;/span&gt;, Error in fetch Name: FetchRequest; Version: 0; CorrelationId: 955460; ClientId: ReplicaFetcherThre&lt;br/&gt;
ad-0-1; ReplicaId: 2; MaxWait: 500 ms; MinBytes: 1 bytes; RequestInfo: &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic,1&amp;#93;&lt;/span&gt; -&amp;gt; PartitionFetchInfo(2558522,1048576). Possible cause: java.nio.channels&lt;br/&gt;
.ClosedChannelException (kafka.server.ReplicaFetcherThread)&lt;/p&gt;

&lt;p&gt;I&apos;ve to restart this broker and delete topic goes fine.&lt;br/&gt;
But if I wait after killing(kill -9) controller and fetcher is removed delete topic goes fine without any issues&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherManager on broker 3&amp;#93;&lt;/span&gt; Removed fetcher for partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic,1&amp;#93;&lt;/span&gt; (kafka.server.ReplicaFetcherManager)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-16 16:56:58,646&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ReplicaFetcherManager on broker 3&amp;#93;&lt;/span&gt; Removed fetcher for partitions &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic,0&amp;#93;&lt;/span&gt; (kafka.server.ReplicaFetcherManager)&lt;/p&gt;

&lt;p&gt;I am not sure if its related to delete topic though any ideas on this.&lt;/p&gt;
</comment>
                            <comment id="14138979" author="nehanarkhede" created="Thu, 18 Sep 2014 14:11:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Delete topic shouldn&apos;t be affected by the replica fetcher issue. Have you let it stay as is and see if delete topic eventually completes? If not, have you taken a thread dump to see where it halts, if at all? &lt;/p&gt;

&lt;p&gt;For each of the tests above, an important scenario is a large number of topics being actively written to and read from. For the tests, it is important to create, say a 1000 topics, and run producers in parallel that write to those 1000 topics, consumers that consume and then introduce each of the failures above. Delete topic should succeed even if there are writes/reads happening to the topic.&lt;/p&gt;</comment>
                            <comment id="14139025" author="sriharsha" created="Thu, 18 Sep 2014 14:57:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; Should we also consider the topic&apos;s log size. I&apos;ll work on running the tests with 1000 topics and post results today or early tomorrow. Thanks.&lt;/p&gt;</comment>
                            <comment id="14142342" author="sriharsha" created="Sun, 21 Sep 2014 05:24:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; update on the tests.&lt;br/&gt;
I ran the above tests in 5 kafka brokers and 3 zookeeper node with 1000 topics with 3 partitions 3 replication factor.&lt;br/&gt;
All these topics being written to and read from simultaneously.&lt;/p&gt;

&lt;p&gt;1)  after the controller is restarted&lt;br/&gt;
topic log files and metadata deleted successfully&lt;br/&gt;
2)  after a soft failure (can simulate by pausing the jvm for longer that zk session timeout) of the controller&lt;br/&gt;
I am not able to consistently pass this test. I am getting this error&lt;br/&gt;
&quot;2014-09-21 01:21:39,101] INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-435,0&amp;#93;&lt;/span&gt; on broker 5: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;114&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR (kafka.cluster.Partition)&quot; &lt;br/&gt;
Initially thought it could be related &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1382&quot; title=&quot;Update zkVersion on partition state update failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1382&quot;&gt;&lt;del&gt;KAFKA-1382&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
but from debug logs&lt;br/&gt;
&quot;expected Some((Leader:2,ISR:2,LeaderEpoch:4,ControllerEpoch:7)) written Some((Leader:4,ISR:4,LeaderEpoch:5,ControllerEpoch:9)) (kafka.utils.ReplicationUtils$)&quot;&lt;br/&gt;
Leader is different. This is causing the broker to keep on logging these messages.&lt;br/&gt;
I am not sure why  it didn&apos;t get the leader update. I didn&apos;t see any errors in zookeeper logs.&lt;br/&gt;
I&apos;ll get more details on this.&lt;br/&gt;
3)  after a topic&apos;s partitions have been reassigned to some other brokers&lt;br/&gt;
    topic deleted no issues&lt;br/&gt;
4) after running a preferred leader command&lt;br/&gt;
 topic successfully deleted&lt;br/&gt;
5) after a topic&apos;s partition has been increased&lt;br/&gt;
   topic and new partition data also deleted&lt;br/&gt;
6) controller broker is killed (kill -9)&lt;br/&gt;
successfully deleted the topic and metadata. Once the killed controller back online the logfiles for that topic partition on that broker also got deleted.&lt;br/&gt;
I am not able to reproduce ReplicaFetcher issue here that pointed out earlier. Before I was running tests on vms with low memory . I wasn&apos;t able to reproduce this on these nodes.&lt;/p&gt;

</comment>
                            <comment id="14142481" author="nehanarkhede" created="Sun, 21 Sep 2014 15:52:14 +0000"  >&lt;p&gt;This is great, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt;. Thanks for running these tests. For #3, #4, #5, was the reassignment, leader movement and partition increase running while the delete topic was running? It is worth trying these admin commands in parallel with delete topic. Will wait for more details on #2.&lt;/p&gt;</comment>
                            <comment id="14142484" author="sriharsha" created="Sun, 21 Sep 2014 15:57:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; for 3,4,5 I ran them after the command is completed I&apos;ll try running them parallel.  &lt;/p&gt;</comment>
                            <comment id="14142636" author="sriharsha" created="Sun, 21 Sep 2014 19:57:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; 3 and 5 test cases went fine with delete command running parallel and for test case 4 the topic gets deleted successfully but preferred leader command fails with&lt;br/&gt;
Failed to start preferred replica election&lt;br/&gt;
org.I0Itec.zkclient.exception.ZkNoNodeException: org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /brokers/topics/my-topic-693/partitions&lt;br/&gt;
        at org.I0Itec.zkclient.exception.ZkException.create(ZkException.java:47)&lt;br/&gt;
which I think is to be expected.&lt;/p&gt;</comment>
                            <comment id="14152809" author="sriharsha" created="Tue, 30 Sep 2014 05:22:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Sorry couldn&apos;t get to work on this earlier. I spent more time on case 2 I can consistently reproduce this failure. &lt;br/&gt;
1) kill -SIGSTOP pid&lt;br/&gt;
2) wait for zookeeper timeout&lt;br/&gt;
3) kill -SIGCONT pid&lt;br/&gt;
4) immediately delete  a topic&lt;br/&gt;
5) new controller keeps printing these messages &lt;br/&gt;
DeleteTopicThread goes in a loop.  I am attaching thread dump from this broker.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 05:21:39,598&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Handling deletion for topics my-topic-110 (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 05:21:39,598&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Replica state machine on controller 3&amp;#93;&lt;/span&gt;: Are all replicas for topic my-topic-110 deleted Map(&lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=1,Replica=2&amp;#93;&lt;/span&gt; -&amp;gt; ReplicaDeletionSuccessful, &lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=1,Replica=3&amp;#93;&lt;/span&gt; -&amp;gt; ReplicaDeletionSuccessful, &lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=0,Replica=1&amp;#93;&lt;/span&gt; -&amp;gt; OfflineReplica, &lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=0,Replica=2&amp;#93;&lt;/span&gt; -&amp;gt; ReplicaDeletionSuccessful) (kafka.controller.ReplicaStateMachine)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 05:21:39,599&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Not retrying deletion of topic my-topic-110 at this time since it is marked ineligible for deletion (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 05:21:39,599&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Handling deletion for topics my-topic-110 (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 05:21:39,599&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;Replica state machine on controller 3&amp;#93;&lt;/span&gt;: Are all replicas for topic my-topic-110 deleted Map(&lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=1,Replica=2&amp;#93;&lt;/span&gt; -&amp;gt; ReplicaDeletionSuccessful, &lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=1,Replica=3&amp;#93;&lt;/span&gt; -&amp;gt; ReplicaDeletionSuccessful, &lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=0,Replica=1&amp;#93;&lt;/span&gt; -&amp;gt; OfflineReplica, &lt;span class=&quot;error&quot;&gt;&amp;#91;Topic=my-topic-110,Partition=0,Replica=2&amp;#93;&lt;/span&gt; -&amp;gt; ReplicaDeletionSuccessful) (kafka.controller.ReplicaStateMachine)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 05:21:39,599&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Not retrying deletion of topic my-topic-110 at this time since it is marked ineligible for deletion (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;/p&gt;

&lt;p&gt;topic doesn&apos;t get deleted &lt;/p&gt;</comment>
                            <comment id="14153343" author="sriharsha" created="Tue, 30 Sep 2014 16:21:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; This seems to be related to the earlier issue I reported &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1558?focusedCommentId=14142342&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14142342&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-1558?focusedCommentId=14142342&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14142342&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;possible issue is related to old controller doesn&apos;t shutdown properly when a new controller is elected.&lt;br/&gt;
I ran a simple test with 1000 topics in 5 broker cluster . This is without consumers or producers running and no delete topic command issued.&lt;/p&gt;

&lt;p&gt;After a soft failure old controller log shows&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 15:59:53,398&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;SessionExpirationListener on 1&amp;#93;&lt;/span&gt;, ZK expired; shut down all controller components and try to re-elect (kafka.controller.KafkaController$SessionExpirationListener)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 15:59:53,400&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-1&amp;#93;&lt;/span&gt;, Shutting down (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;/p&gt;

&lt;p&gt;It stops there and the server.log goes on with &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 16:17:36,649&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-634,0&amp;#93;&lt;/span&gt; on broker 1: Shrinking ISR for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-634,0&amp;#93;&lt;/span&gt; from 1,3,4 to 1 (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 16:17:36,653&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-634,0&amp;#93;&lt;/span&gt; on broker 1: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 16:17:36,653&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-374,1&amp;#93;&lt;/span&gt; on broker 1: Shrinking ISR for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-374,1&amp;#93;&lt;/span&gt; from 1,2,3 to 1 (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 16:17:36,656&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-374,1&amp;#93;&lt;/span&gt; on broker 1: Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 16:17:36,657&amp;#93;&lt;/span&gt; INFO Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-549,2&amp;#93;&lt;/span&gt; on broker 1: Shrinking ISR for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;my-topic-549,2&amp;#93;&lt;/span&gt; from 1,2,3 to 1 (kafka.cluster.Partition)&lt;/p&gt;

&lt;p&gt;I tried reproduce this in a 3 node cluster in vms with 200 topics and with or without producers &amp;amp; consumers running.&lt;br/&gt;
But here old controller shutdown goes through fine.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,193&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;SessionExpirationListener on 3&amp;#93;&lt;/span&gt;, ZK expired; shut down all controller components and try to re-elect (kafka.controller.KafkaController$SessionExpirationListener)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,196&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Shutting down (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,200&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Stopped  (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,200&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-3&amp;#93;&lt;/span&gt;, Shutdown completed (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Partition state machine on Controller 3&amp;#93;&lt;/span&gt;: Stopped partition state machine (kafka.controller.PartitionStateMachine)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Replica state machine on controller 3&amp;#93;&lt;/span&gt;: Stopped replica state machine (kafka.controller.ReplicaStateMachine)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-2-send-thread&amp;#93;&lt;/span&gt;, Shutting down (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-2-send-thread&amp;#93;&lt;/span&gt;, Stopped  (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-2-send-thread&amp;#93;&lt;/span&gt;, Shutdown completed (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-1-send-thread&amp;#93;&lt;/span&gt;, Shutting down (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,202&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-1-send-thread&amp;#93;&lt;/span&gt;, Stopped  (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,203&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-1-send-thread&amp;#93;&lt;/span&gt;, Shutdown completed (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,203&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-3-send-thread&amp;#93;&lt;/span&gt;, Shutting down (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,203&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-3-send-thread&amp;#93;&lt;/span&gt;, Stopped  (kafka.controller.RequestSendThread)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 14:50:55,203&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller-3-to-broker-3-send-thread&amp;#93;&lt;/span&gt;, Shutdown completed (kafka.controller.RequestSendThread)&lt;/p&gt;


&lt;p&gt;Regarding TopicDeletionManager shouldn&apos;t we stop if one of the replicas are offline or atleast have configurable number of retries for topic deletion?&lt;/p&gt;


</comment>
                            <comment id="14153393" author="guozhang" created="Tue, 30 Sep 2014 16:51:02 +0000"  >&lt;p&gt;Just wondering if it is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1578&quot; title=&quot;Controller should de-register all listeners upon designation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1578&quot;&gt;&lt;del&gt;KAFKA-1578&lt;/del&gt;&lt;/a&gt;. Are you testing against trunk?&lt;/p&gt;</comment>
                            <comment id="14153404" author="sriharsha" created="Tue, 30 Sep 2014 17:02:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; yes testing against trunk last updated yesterday.&lt;br/&gt;
 &#11104; trunk&#177; &#11136; ~/code/kafka &#11136; &lt;br/&gt;
&#187; git log | grep -i &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1578&quot; title=&quot;Controller should de-register all listeners upon designation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1578&quot;&gt;&lt;del&gt;KAFKA-1578&lt;/del&gt;&lt;/a&gt; &lt;br/&gt;
    kafka-1578; Controller should de-register all listeners upon designation; patched by Guozhang Wang; reviewed by Jun Rao&lt;/p&gt;</comment>
                            <comment id="14153631" author="nehanarkhede" created="Tue, 30 Sep 2014 19:34:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Thanks for running more tests. I have a few questions about the latest results you&apos;ve shared above.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I ran a simple test with 1000 topics in 5 broker cluster . This is without consumers or producers running and no delete topic command issued.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What were you testing here? What didn&apos;t work as expected? &lt;/p&gt;</comment>
                            <comment id="14153663" author="sriharsha" created="Tue, 30 Sep 2014 19:53:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I was trying to test if the controller is recovering from  a soft failure successfully and above described behavior is outcome of issuing a delete topic command not necessarily anything to do with controller&apos;s ability to come out of soft failure.&lt;br/&gt;
Hence I removed the producers/consumers and didn&apos;t do delete topic command even than the old controller didn&apos;t shutdown properly and I believe this is what causing the delete topic to fail. Since the old controller didn&apos;t shutdown topic partition goes to offline which is causing new controller&apos;s TopicDeletionManager go into a loop where one of the topic partition replica&apos;s are offline and keep retrying to delete it.&lt;/p&gt;</comment>
                            <comment id="14154862" author="nehanarkhede" created="Wed, 1 Oct 2014 14:27:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Controller&apos;s inability to not shutdown on a soft failure is actually a problem and we need to look into it before fixing that case for delete topic. Would you mind filing another JIRA and stating the steps to reproduce the controller issue and make this depend on that JIRA? Since this JIRA is a blocker for 0.8.2, we are hoping to make progress on it. &lt;/p&gt;</comment>
                            <comment id="14154870" author="sriharsha" created="Wed, 1 Oct 2014 14:38:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; working on finding the issue behind controller&apos;s shutdown. I&apos;ll file a JIRA.&lt;/p&gt;</comment>
                            <comment id="14158626" author="guozhang" created="Fri, 3 Oct 2014 22:45:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=harsha_ch&quot; class=&quot;user-hover&quot; rel=&quot;harsha_ch&quot;&gt;harsha_ch&lt;/a&gt; could we also try one more test case: delete topic while leader rebalance is on-going?&lt;/p&gt;</comment>
                            <comment id="14158637" author="sriharsha" created="Fri, 3 Oct 2014 22:52:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;  I&apos;ll work on that test will report the results.  Is there any way to induce the leader rebalance manually?&lt;/p&gt;</comment>
                            <comment id="14158797" author="nehanarkhede" created="Sat, 4 Oct 2014 00:36:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Yes. The preferred replica election admin tool can be used to balance the leaders. You would have to have imbalanced leaders before that, though. A broker bounce is the easiest way to end up with leader imbalance.&lt;/p&gt;</comment>
                            <comment id="14158812" author="sriharsha" created="Sat, 4 Oct 2014 00:43:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I ran the preferred replica election tool in my tests. But I&apos;ll try bouncing the broker and run this tool.&lt;/p&gt;</comment>
                            <comment id="14159379" author="nehanarkhede" created="Sun, 5 Oct 2014 01:16:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Now that &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1663&quot; title=&quot;Controller unable to shutdown after a soft failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1663&quot;&gt;&lt;del&gt;KAFKA-1663&lt;/del&gt;&lt;/a&gt; is pushed to trunk, the previously failing test should now pass right? The only other thing to wait on would be the leader rebalance tests. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clarkhaskins&quot; class=&quot;user-hover&quot; rel=&quot;clarkhaskins&quot;&gt;clarkhaskins&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;: At this point, many failure tests pass on delete topic. It will be great to try delete topic on 100s of topics on some of LinkedIn&apos;s clusters, if possible. Any chance this test can happen in the 0.8.2 timeframe (1-2 weeks) ?&lt;/p&gt;</comment>
                            <comment id="14159381" author="sriharsha" created="Sun, 5 Oct 2014 01:26:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I ran all the tests except leader rebalance tests with &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1663&quot; title=&quot;Controller unable to shutdown after a soft failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1663&quot;&gt;&lt;del&gt;KAFKA-1663&lt;/del&gt;&lt;/a&gt; all of them are passed in my tests. With 1000 topics set to partition 3 and replication factor of 3 and producers, consumers running on all of the topics. I am planning on doing the leader rebalance tests tonight will update the results. It will be great to do this testing on LinkedIn&apos;s cluster too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="14165358" author="sriharsha" created="Thu, 9 Oct 2014 16:51:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; I ran tests for simultaneously running  preferred replica election tool and deleting multiple topics.&lt;br/&gt;
I kept running into &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1305&quot; title=&quot;Controller can hang on controlled shutdown with auto leader balance enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1305&quot;&gt;&lt;del&gt;KAFKA-1305&lt;/del&gt;&lt;/a&gt; but by increasing controller.message.queue.size to 1000 I was able to run these tests successfully.&lt;br/&gt;
While testing this couple of things caught my eye.&lt;br/&gt;
following code in KafkaController.PreferredReplicaElectionListener&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      val partitions = partitionsForPreferredReplicaElection -- controllerContext.partitionsUndergoingPreferredReplicaElection
      val partitionsForTopicsToBeDeleted = partitions.filter(p =&amp;gt; controller.deleteTopicManager.isTopicQueuedUpForDeletion(p.topic))
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(partitionsForTopicsToBeDeleted.size &amp;gt; 0) {
        error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Skipping preferred replica election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions %s since the respective topics are being deleted&quot;&lt;/span&gt;
          .format(partitionsForTopicsToBeDeleted))
      }
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        controller.onPreferredReplicaElection(partitions -- partitionsForTopicsToBeDeleted)
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It doesn&apos;t need a else part there since its calling onPreferredReplicaElection by removing partitionsForTopicsToBeDeleted&lt;/p&gt;

&lt;p&gt;In PartitionStateMachine.DeleteTopicListener&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(topicsToBeDeleted.size &amp;gt; 0) {
          info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Starting topic deletion &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; topics &quot;&lt;/span&gt; + topicsToBeDeleted.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;))
          &lt;span class=&quot;code-comment&quot;&gt;// add topic to deletion list
&lt;/span&gt;          controller.deleteTopicManager.enqueueTopicsForDeletion(topicsToBeDeleted)
          &lt;span class=&quot;code-comment&quot;&gt;// mark topic ineligible &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; other state changes are in progress
&lt;/span&gt;          topicsToBeDeleted.foreach { topic =&amp;gt;
            val preferredReplicaElectionInProgress =
              controllerContext.partitionsUndergoingPreferredReplicaElection.map(_.topic).contains(topic)
            val partitionReassignmentInProgress =
              controllerContext.partitionsBeingReassigned.keySet.map(_.topic).contains(topic)
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(preferredReplicaElectionInProgress || partitionReassignmentInProgress)
              controller.deleteTopicManager.markTopicIneligibleForDeletion(Set(topic))
          }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above code  enqueueTopicsForDeletion which calls resumeTopicDeletionThread() to start the deletion of topics &lt;br/&gt;
mark topic ineligible should be before the enqueueTopicsForDeletion. This way deletion of the topic won&apos;t happen if there is preferred replica election or partitions reassignment going for the said topics. I am testing these changes. Let me know what you think of these changes. Thanks.&lt;/p&gt;</comment>
                            <comment id="14165383" author="junrao" created="Thu, 9 Oct 2014 17:11:47 +0000"  >&lt;p&gt;Sriharsha,&lt;/p&gt;

&lt;p&gt;I think you are right on both points. Thanks for finding them out.&lt;/p&gt;</comment>
                            <comment id="14165410" author="nehanarkhede" created="Thu, 9 Oct 2014 17:40:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Those observations are right, would you like to submit a patch?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I kept running into &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1305&quot; title=&quot;Controller can hang on controlled shutdown with auto leader balance enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1305&quot;&gt;&lt;del&gt;KAFKA-1305&lt;/del&gt;&lt;/a&gt; but by increasing controller.message.queue.size to 1000 I was able to run these tests successfully.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for running the tests. Did you get a chance to test it by making the queue unbounded?&lt;/p&gt;</comment>
                            <comment id="14165601" author="sriharsha" created="Thu, 9 Oct 2014 19:26:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I am running above tests with the proposed changes. Will submit a patch shortly on this JIRA.&lt;br/&gt;
&quot;Thanks for running the tests. Did you get a chance to test it by making the queue unbounded?&quot;&lt;br/&gt;
I can set controller.message.queue.size to Int.MaxValue and run tests. &lt;/p&gt;</comment>
                            <comment id="14165750" author="sriharsha" created="Thu, 9 Oct 2014 21:13:20 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26521/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26521/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14165756" author="sriharsha" created="Thu, 9 Oct 2014 21:15:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; re-ran all of the above tests with this patch. Tests passed.&lt;br/&gt;
I ran it with controller.message.queue.size set to 1000 and also Int.MaxValue which is what LinkedBlockingQueue does for unbounded queue.&lt;/p&gt;</comment>
                            <comment id="14165821" author="junrao" created="Thu, 9 Oct 2014 21:54:19 +0000"  >&lt;p&gt;Thanks for the patch. +1. Committed to both trunk and 0.8.2.&lt;/p&gt;

&lt;p&gt;Sriharsha,&lt;/p&gt;

&lt;p&gt;Thanks a lot for helping out.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12745270">KAFKA-1663</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12674003" name="KAFKA-1558.patch" size="2590" author="sriharsha" created="Thu, 9 Oct 2014 21:13:20 +0000"/>
                            <attachment id="12671963" name="kafka-thread-dump.log" size="42462" author="sriharsha" created="Tue, 30 Sep 2014 05:24:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408130</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1y873:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408135</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>nehanarkhede</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>