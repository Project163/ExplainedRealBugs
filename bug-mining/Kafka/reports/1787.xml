<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:06:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6328] Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6328</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Today when we group processor nodes into groups (i.e. sub-topologies), we assign the sub-topology id for global tables&apos; dummy groups as well. As a result, the subtopology ids (and hence task ids) are not consecutive anymore. This is quite confusing for users trouble shooting and debugging; in addition, the node group for global stores are not useful as well: we simply exclude it in all the caller functions of makeNodeGroups.&lt;/p&gt;

&lt;p&gt;It would be better to simply exclude the global store&apos;s node groups in this function so that the subtopology ids and task ids are consecutive.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13123563">KAFKA-6328</key>
            <summary>Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Yohan123">Richard Yu</assignee>
                                    <reporter username="guozhang">Guozhang Wang</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Thu, 7 Dec 2017 22:30:19 +0000</created>
                <updated>Sat, 24 Feb 2018 04:07:21 +0000</updated>
                            <resolved>Sat, 24 Feb 2018 04:07:21 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16295264" author="yohan123" created="Mon, 18 Dec 2017 17:06:22 +0000"  >&lt;p&gt;Patch for excluding node groups&lt;/p&gt;</comment>
                            <comment id="16295412" author="mjsax" created="Mon, 18 Dec 2017 18:42:25 +0000"  >&lt;p&gt;Thanks for the patch. Please assign the JIRA to yourself and open a PR on Github so we can review it. It&apos;s also good to update the JIRA to &quot;Start Progress&quot; and &quot;Patch Available&quot; if possible.&lt;/p&gt;</comment>
                            <comment id="16295558" author="yohan123" created="Mon, 18 Dec 2017 19:46:03 +0000"  >&lt;p&gt;Sorry, I am currently operating on &quot;one active PR&quot; basis. Meaning I am operating directly on my clone of Kafka mirror. I will work towards getting out more active PRs in the future and improving my system for commits.&lt;/p&gt;</comment>
                            <comment id="16295597" author="mjsax" created="Mon, 18 Dec 2017 19:54:41 +0000"  >&lt;p&gt;You can create as many branches in your own Kafka GitHub clone as you want. Thus you can create one branch per Jira and open multiple PRs. Maybe read a Git tutorial on the Internet (there are tons) if you don&apos;t know how to do this yet.&lt;/p&gt;</comment>
                            <comment id="16295749" author="githubbot" created="Mon, 18 Dec 2017 22:10:36 +0000"  >&lt;p&gt;GitHub user ConcurrencyPractitioner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4339&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6328&quot; title=&quot;Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6328&quot;&gt;&lt;del&gt;KAFKA-6328&lt;/del&gt;&lt;/a&gt; Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ConcurrencyPractitioner/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ConcurrencyPractitioner/kafka&lt;/a&gt; kafka-6238&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/4339.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4339.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4339&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ab7531552c9e830ad87f06132f45b3257a3632fa&lt;br/&gt;
Author: RichardYuSTUG &amp;lt;yohan.richard.yu2@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-12-18T22:01:02Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6328&quot; title=&quot;Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6328&quot;&gt;&lt;del&gt;KAFKA-6328&lt;/del&gt;&lt;/a&gt; Exclude node groups belonging to global stores in InternalTopologyBuilder&lt;/p&gt;

&lt;p&gt;commit 42ea1f0e885eda70b60712ded801ba010a9a2c7e&lt;br/&gt;
Author: RichardYuSTUG &amp;lt;yohan.richard.yu2@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-12-18T22:07:58Z&lt;/p&gt;

&lt;p&gt;    Testing&lt;/p&gt;

&lt;p&gt;commit da2bf85318db465b325383ecded9b51474f1d35b&lt;br/&gt;
Author: RichardYuSTUG &amp;lt;yohan.richard.yu2@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-12-18T22:09:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6328&quot; title=&quot;Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6328&quot;&gt;&lt;del&gt;KAFKA-6328&lt;/del&gt;&lt;/a&gt; Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16301859" author="githubbot" created="Fri, 22 Dec 2017 19:30:05 +0000"  >&lt;p&gt;guozhangwang commented on issue #4339: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6328&quot; title=&quot;Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6328&quot;&gt;&lt;del&gt;KAFKA-6328&lt;/del&gt;&lt;/a&gt; Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4339#issuecomment-353661424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4339#issuecomment-353661424&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @ConcurrencyPractitioner The problem that I was pointing out, is that we need to keep compatibility in our mind: assume you are going to upgrade your streams app from 1.0.0 to 1.1.0 with this fix, and then task `3_3` becomes task `2_3` because we reorder the sub-topology ids, then sticky assignor will not work and we would unnecessarily move tasks around which would add significant rebalance delay. So as long as your proposed solution can still maintain the indexing that would be fine, though I personally cannot come up with a better solution that would keep compatibility.&lt;/p&gt;

&lt;p&gt;   Happy holidays! We can chat later when you are back.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16328079" author="githubbot" created="Wed, 17 Jan 2018 00:58:49 +0000"  >&lt;p&gt;guozhangwang closed pull request #4339: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6328&quot; title=&quot;Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6328&quot;&gt;&lt;del&gt;KAFKA-6328&lt;/del&gt;&lt;/a&gt; Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4339&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/TopologyDescription.java b/streams/src/main/java/org/apache/kafka/streams/TopologyDescription.java&lt;br/&gt;
index 01af8bf5295..131e8d31cbe 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/TopologyDescription.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/TopologyDescription.java&lt;br/&gt;
@@ -76,6 +76,8 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return the &quot;global&quot; processor node&lt;br/&gt;
          */&lt;br/&gt;
         Processor processor();&lt;br/&gt;
+&lt;br/&gt;
+        int id();&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java&lt;br/&gt;
index 90d46aa949f..09799f7ee7e 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopologyBuilder.java&lt;br/&gt;
@@ -1286,13 +1286,6 @@ private boolean isGlobalSource(final String nodeName) {&lt;br/&gt;
     public TopologyDescription describe() &lt;/p&gt;
{
         final TopologyDescription description = new TopologyDescription();
 
-        describeSubtopologies(description);
-        describeGlobalStores(description);
-
-        return description;
-    }
&lt;p&gt;-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void describeSubtopologies(final TopologyDescription description) {&lt;br/&gt;
         for (final Map.Entry&amp;lt;Integer, Set&amp;lt;String&amp;gt;&amp;gt; nodeGroup : makeNodeGroups().entrySet()) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             final Set&amp;lt;String&amp;gt; allNodesOfGroups = nodeGroup.getValue();&lt;br/&gt;
@@ -1300,6 +1293,32 @@ private void describeSubtopologies(final TopologyDescription description) {&lt;/p&gt;

&lt;p&gt;             if (!isNodeGroupOfGlobalStores) &lt;/p&gt;
{
                 describeSubtopology(description, nodeGroup.getKey(), allNodesOfGroups);
+            }
&lt;p&gt; else &lt;/p&gt;
{
+                describeGlobalStore(description, allNodesOfGroups, nodeGroup.getKey());
+            }
&lt;p&gt;+        }&lt;br/&gt;
+&lt;br/&gt;
+        return description;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private void describeGlobalStore(final TopologyDescription description, final Set&amp;lt;String&amp;gt; nodes, int id) {&lt;br/&gt;
+        final Iterator&amp;lt;String&amp;gt; it = nodes.iterator();&lt;br/&gt;
+        while (it.hasNext()) {&lt;br/&gt;
+            final String node = it.next();&lt;br/&gt;
+&lt;br/&gt;
+            if (isGlobalSource(node)) {&lt;br/&gt;
+                // we found a GlobalStore node group; those contain exactly two node: &lt;/p&gt;
{sourceNode,processorNode}&lt;br/&gt;
+                it.remove(); // remove sourceNode from group&lt;br/&gt;
+                final String processorNode = nodes.iterator().next(); // get remaining processorNode&lt;br/&gt;
+&lt;br/&gt;
+                description.addGlobalStore(new GlobalStore(&lt;br/&gt;
+                    node,&lt;br/&gt;
+                    processorNode,&lt;br/&gt;
+                    ((ProcessorNodeFactory) nodeFactories.get(processorNode)).stateStoreNames.iterator().next(),&lt;br/&gt;
+                    nodeToSourceTopics.get(node).get(0),&lt;br/&gt;
+                    id&lt;br/&gt;
+                ));&lt;br/&gt;
+                break;&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
@@ -1367,43 +1386,26 @@ private void describeSubtopology(final TopologyDescription description,&lt;br/&gt;
                 new HashSet&amp;lt;TopologyDescription.Node&amp;gt;(nodesByName.values())));&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
-    private void describeGlobalStores(final TopologyDescription description) {&lt;br/&gt;
-        for (final Map.Entry&amp;lt;Integer, Set&amp;lt;String&amp;gt;&amp;gt; nodeGroup : makeNodeGroups().entrySet()) {&lt;br/&gt;
-            final Set&amp;lt;String&amp;gt; nodes = nodeGroup.getValue();&lt;br/&gt;
-&lt;br/&gt;
-            final Iterator&amp;lt;String&amp;gt; it = nodes.iterator();&lt;br/&gt;
-            while (it.hasNext()) {&lt;br/&gt;
-                final String node = it.next();&lt;br/&gt;
-&lt;br/&gt;
-                if (isGlobalSource(node)) {&lt;br/&gt;
-                    // we found a GlobalStore node group; those contain exactly two node: {sourceNode,processorNode}
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it.remove(); // remove sourceNode from group&lt;/li&gt;
	&lt;li&gt;final String processorNode = nodes.iterator().next(); // get remaining processorNode&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;description.addGlobalStore(new GlobalStore(&lt;/li&gt;
	&lt;li&gt;node,&lt;/li&gt;
	&lt;li&gt;processorNode,&lt;/li&gt;
	&lt;li&gt;((ProcessorNodeFactory) nodeFactories.get(processorNode)).stateStoreNames.iterator().next(),&lt;/li&gt;
	&lt;li&gt;nodeToSourceTopics.get(node).get(0)&lt;/li&gt;
	&lt;li&gt;));&lt;/li&gt;
	&lt;li&gt;break;&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;br/&gt;
     public final static class GlobalStore implements TopologyDescription.GlobalStore {&lt;br/&gt;
         private final Source source;&lt;br/&gt;
         private final Processor processor;&lt;br/&gt;
+        private final int id;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public GlobalStore(final String sourceName,&lt;br/&gt;
                            final String processorName,&lt;br/&gt;
                            final String storeName,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final String topicName) {&lt;br/&gt;
+                           final String topicName,&lt;br/&gt;
+                           final int id) 
{
             source = new Source(sourceName, topicName);
             processor = new Processor(processorName, Collections.singleton(storeName));
             source.successors.add(processor);
             processor.predecessors.add(source);
+            this.id = id;
+        }
&lt;p&gt;+&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public int id() &lt;/p&gt;
{
+            return id;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         @Override&lt;br/&gt;
@@ -1418,7 +1420,7 @@ public GlobalStore(final String sourceName,&lt;/p&gt;

&lt;p&gt;         @Override&lt;br/&gt;
         public String toString() &lt;/p&gt;
{
-            return &quot;GlobalStore: &quot; + source.name + &quot; (topic: &quot; + source.topics + &quot;)\n      --&amp;gt; &quot;
+            return &quot;GlobalStore: &quot; + source.name + &quot; Id: &quot; + id + &quot; (topic: &quot; + source.topics + &quot;)\n      --&amp;gt; &quot;
                 + processor.name + &quot; (store: &quot; + processor.stores.iterator().next() + &quot;)\n&quot;;
         }

&lt;p&gt;@@ -1720,7 +1722,7 @@ public String toString() {&lt;br/&gt;
         @Override&lt;br/&gt;
         public int compare(final TopologyDescription.GlobalStore globalStore1,&lt;br/&gt;
                            final TopologyDescription.GlobalStore globalStore2) &lt;/p&gt;
{
-            return globalStore1.source().name().compareTo(globalStore2.source().name());
+            return globalStore1.id() - globalStore2.id();
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;@@ -1737,8 +1739,8 @@ public int compare(final TopologyDescription.Subtopology subtopology1,&lt;br/&gt;
     private final static SubtopologyComparator SUBTOPOLOGY_COMPARATOR = new SubtopologyComparator();&lt;/p&gt;

&lt;p&gt;     public final static class TopologyDescription implements org.apache.kafka.streams.TopologyDescription {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Set&amp;lt;TopologyDescription.Subtopology&amp;gt; subtopologies = new TreeSet&amp;lt;&amp;gt;(SUBTOPOLOGY_COMPARATOR);&lt;/li&gt;
	&lt;li&gt;private final Set&amp;lt;TopologyDescription.GlobalStore&amp;gt; globalStores = new TreeSet&amp;lt;&amp;gt;(GLOBALSTORE_COMPARATOR);&lt;br/&gt;
+        private final TreeSet&amp;lt;TopologyDescription.Subtopology&amp;gt; subtopologies = new TreeSet&amp;lt;&amp;gt;(SUBTOPOLOGY_COMPARATOR);&lt;br/&gt;
+        private final TreeSet&amp;lt;TopologyDescription.GlobalStore&amp;gt; globalStores = new TreeSet&amp;lt;&amp;gt;(GLOBALSTORE_COMPARATOR);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         public void addSubtopology(final TopologyDescription.Subtopology subtopology) {&lt;br/&gt;
             subtopologies.add(subtopology);&lt;br/&gt;
@@ -1760,33 +1762,43 @@ public void addGlobalStore(final TopologyDescription.GlobalStore globalStore) {&lt;/p&gt;

&lt;p&gt;         @Override&lt;br/&gt;
         public String toString() &lt;/p&gt;
{
-            return subtopologiesAsString() + &quot;\n&quot; + globalStoresAsString();
-        }
&lt;p&gt;-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private String subtopologiesAsString() {&lt;br/&gt;
             final StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;sb.append(&quot;Sub-topologies:\n&quot;);&lt;/li&gt;
	&lt;li&gt;if (subtopologies.isEmpty()) 
{
-                sb.append(&quot;  none\n&quot;);
-            } else {&lt;br/&gt;
-                for (final TopologyDescription.Subtopology st : subtopologies) {&lt;br/&gt;
-                    sb.append(&quot;  &quot;);&lt;br/&gt;
-                    sb.append(st);&lt;br/&gt;
+            sb.append(&quot;Topologies:\n &quot;);&lt;br/&gt;
+            final TopologyDescription.Subtopology[] sortedSubtopologies = &lt;br/&gt;
+                subtopologies.descendingSet().toArray(new TopologyDescription.Subtopology&lt;span class=&quot;error&quot;&gt;&amp;#91;subtopologies.size()&amp;#93;&lt;/span&gt;);&lt;br/&gt;
+            final TopologyDescription.GlobalStore[] sortedGlobalStores = &lt;br/&gt;
+                globalStores.descendingSet().toArray(new TopologyDescription.GlobalStore&lt;span class=&quot;error&quot;&gt;&amp;#91;globalStores.size()&amp;#93;&lt;/span&gt;);&lt;br/&gt;
+            int expectedId = 0;&lt;br/&gt;
+            int subtopologiesIndex = sortedSubtopologies.length - 1;&lt;br/&gt;
+            int globalStoresIndex = sortedGlobalStores.length - 1;&lt;br/&gt;
+            while (subtopologiesIndex != -1 &amp;amp;&amp;amp; globalStoresIndex != -1) {&lt;br/&gt;
+                sb.append(&quot;  &quot;);&lt;br/&gt;
+                final TopologyDescription.Subtopology subtopology = &lt;br/&gt;
+                    sortedSubtopologies&lt;span class=&quot;error&quot;&gt;&amp;#91;subtopologiesIndex&amp;#93;&lt;/span&gt;;&lt;br/&gt;
+                final TopologyDescription.GlobalStore globalStore = &lt;br/&gt;
+                    sortedGlobalStores&lt;span class=&quot;error&quot;&gt;&amp;#91;globalStoresIndex&amp;#93;&lt;/span&gt;;&lt;br/&gt;
+                if (subtopology.id() == expectedId) {
+                    sb.append(subtopology);
+                    subtopologiesIndex--;
+                } else {
+                    sb.append(globalStore);
+                    globalStoresIndex--;
                 }&lt;br/&gt;
+                expectedId++;&lt;br/&gt;
             }&lt;br/&gt;
-            return sb.toString();&lt;br/&gt;
-        }&lt;br/&gt;
-&lt;br/&gt;
-        private String globalStoresAsString() {&lt;br/&gt;
-            final StringBuilder sb = new StringBuilder();&lt;br/&gt;
-            sb.append(&quot;Global Stores:\n&quot;);&lt;br/&gt;
-            if (globalStores.isEmpty()) {-                sb.append(&quot;  nonen&quot;);-            }
&lt;p&gt; else {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;for (final TopologyDescription.GlobalStore gs : globalStores) 
{
-                    sb.append(&quot;  &quot;);
-                    sb.append(gs);
-                }
&lt;p&gt;+            while (subtopologiesIndex != -1) &lt;/p&gt;
{
+                final TopologyDescription.Subtopology subtopology = 
+                    sortedSubtopologies[subtopologiesIndex];
+                sb.append(&quot;  &quot;);
+                sb.append(subtopology);
+                subtopologiesIndex--;
+            }
&lt;p&gt;+            while (globalStoresIndex != -1) &lt;/p&gt;
{
+                final TopologyDescription.GlobalStore globalStore = 
+                    sortedGlobalStores[globalStoresIndex];
+                sb.append(&quot;  &quot;);
+                sb.append(globalStore);
+                globalStoresIndex--;
             }
&lt;p&gt;             return sb.toString();&lt;br/&gt;
         }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/TopologyTest.java b/streams/src/test/java/org/apache/kafka/streams/TopologyTest.java&lt;br/&gt;
index 3ba780323b7..0a45803aed5 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/TopologyTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/TopologyTest.java&lt;br/&gt;
@@ -579,14 +579,14 @@ public void processorsWithSharedStateShouldHaveSameSubtopology() {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
     public void shouldDescribeGlobalStoreTopology() &lt;/p&gt;
{
-        addGlobalStoreToTopologyAndExpectedDescription(&quot;globalStore&quot;, &quot;source&quot;, &quot;globalTopic&quot;, &quot;processor&quot;);
+        addGlobalStoreToTopologyAndExpectedDescription(&quot;globalStore&quot;, &quot;source&quot;, &quot;globalTopic&quot;, &quot;processor&quot;, 0);
         assertThat(topology.describe(), equalTo((TopologyDescription) expectedDescription));
     }

&lt;p&gt;     @Test&lt;br/&gt;
     public void shouldDescribeMultipleGlobalStoreTopology() &lt;/p&gt;
{
-        addGlobalStoreToTopologyAndExpectedDescription(&quot;globalStore1&quot;, &quot;source1&quot;, &quot;globalTopic1&quot;, &quot;processor1&quot;);
-        addGlobalStoreToTopologyAndExpectedDescription(&quot;globalStore2&quot;, &quot;source2&quot;, &quot;globalTopic2&quot;, &quot;processor2&quot;);
+        addGlobalStoreToTopologyAndExpectedDescription(&quot;globalStore1&quot;, &quot;source1&quot;, &quot;globalTopic1&quot;, &quot;processor1&quot;, 0);
+        addGlobalStoreToTopologyAndExpectedDescription(&quot;globalStore2&quot;, &quot;source2&quot;, &quot;globalTopic2&quot;, &quot;processor2&quot;, 1);
         assertThat(topology.describe(), equalTo((TopologyDescription) expectedDescription));
     }

&lt;p&gt;@@ -677,7 +677,8 @@ public void shouldDescribeMultipleGlobalStoreTopology() {&lt;br/&gt;
     private void addGlobalStoreToTopologyAndExpectedDescription(final String globalStoreName,&lt;br/&gt;
                                                                 final String sourceName,&lt;br/&gt;
                                                                 final String globalTopicName,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final String processorName) {&lt;br/&gt;
+                                                                final String processorName,&lt;br/&gt;
+                                                                final int id) 
{
         final KeyValueStoreBuilder globalStoreBuilder = EasyMock.createNiceMock(KeyValueStoreBuilder.class);
         EasyMock.expect(globalStoreBuilder.name()).andReturn(globalStoreName).anyTimes();
         EasyMock.replay(globalStoreBuilder);
@@ -695,7 +696,8 @@ private void addGlobalStoreToTopologyAndExpectedDescription(final String globalS
             sourceName,
             processorName,
             globalStoreName,
-            globalTopicName);
+            globalTopicName,
+            id);
 
         expectedDescription.addGlobalStore(expectedGlobalStore);
     }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16368138" author="githubbot" created="Sat, 17 Feb 2018 08:05:29 +0000"  >&lt;p&gt;hachikuji opened a new pull request #4583: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6328&quot; title=&quot;Exclude node groups belonging to global stores in InternalTopologyBuilder#makeNodeGroups&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6328&quot;&gt;&lt;del&gt;KAFKA-6328&lt;/del&gt;&lt;/a&gt;; Fix inter-broker protocol message format compatibility check&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4583&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4583&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This patches fixes a bug in the validation of the inter-broker protocol and the message format version. We should allow the configured message format api version to be greater than the inter-broker protocol api version as long as the actual message format versions are equal. For example, if the message format version is set to 1.0, it is fine for the inter-broker protocol version to be 0.11.0 because they both use message format v2.&lt;/p&gt;

&lt;p&gt;   I have added a unit test which checks compatibility for all combinations of the message format version and the inter-broker protocol version.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12902682" name="kafka-6328.diff" size="1586" author="Yohan123" created="Mon, 18 Dec 2017 17:06:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 39 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3no13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>