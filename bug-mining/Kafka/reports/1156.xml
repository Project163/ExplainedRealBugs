<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:55:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4051] Strange behavior during rebalance when turning the OS clock back</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4051</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If a rebalance is performed after turning the OS clock back, then the kafka server enters in a loop and the rebalance cannot be completed until the system returns to the previous date/hour.&lt;/p&gt;

&lt;p&gt;Steps to Reproduce:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start a consumer for TOPIC_NAME with group id GROUP_NAME. It will be owner of all the partitions.&lt;/li&gt;
	&lt;li&gt;Turn the system (OS) clock back. For instance 1 hour.&lt;/li&gt;
	&lt;li&gt;Start a new consumer for TOPIC_NAME  using the same group id, it will force a rebalance.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After these actions the kafka server logs constantly display the messages below, and after a while both consumers do not receive more packages. This condition lasts at least the time that the clock went back, for this example 1 hour, and finally after this time kafka comes back to work.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,023&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Preparing to restabilize group GROUP_NAME with old generation 2 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,025&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Stabilized group GROUP_NAME generation 3 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,027&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Preparing to restabilize group GROUP_NAME with old generation 3 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,029&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Group GROUP_NAME generation 3 is dead and removed (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,032&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Preparing to restabilize group GROUP_NAME with old generation 0 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,032&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Stabilized group GROUP_NAME generation 1 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,033&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Preparing to restabilize group GROUP_NAME with old generation 1 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,034&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Group GROUP generation 1 is dead and removed (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,043&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Preparing to restabilize group GROUP_NAME with old generation 0 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,044&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Stabilized group GROUP_NAME generation 1 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,044&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Preparing to restabilize group GROUP_NAME with old generation 1 (kafka.coordinator.GroupCoordinator)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-08-08 11:30:23,045&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GroupCoordinator 0&amp;#93;&lt;/span&gt;: Group GROUP_NAME generation 1 is dead and removed (kafka.coordinator.GroupCoordinator)&lt;/p&gt;

&lt;p&gt;Due to the fact that some systems could have enabled NTP or an administrator option to change the system clock (date/time) it&apos;s important to do it safely, currently the only way to do it safely is following the next steps:&lt;/p&gt;

&lt;p&gt;1-  Tear down the Kafka server.&lt;br/&gt;
2-  Change the date/time&lt;br/&gt;
3- Tear up the Kafka server.&lt;/p&gt;

&lt;p&gt;But, this approach can be done only if the change was performed by the administrator, not for NTP. Also in many systems turning down the Kafka server might cause the INFORMATION TO BE LOST.&lt;/p&gt;</description>
                <environment>OS: Ubuntu 14.04 - 64bits&lt;br/&gt;
</environment>
        <key id="12997719">KAFKA-4051</key>
            <summary>Strange behavior during rebalance when turning the OS clock back</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="gabriel.ibarra">Gabriel Ibarra</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Aug 2016 21:39:54 +0000</created>
                <updated>Mon, 22 Aug 2016 22:59:06 +0000</updated>
                            <resolved>Mon, 22 Aug 2016 22:58:58 +0000</resolved>
                                    <version>0.10.0.0</version>
                                    <fixVersion>0.10.1.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15426256" author="ijuma" created="Thu, 18 Aug 2016 10:51:45 +0000"  >&lt;p&gt;As discussed in the thread, Kafka uses System.currentTimeMillis() in a number of places, which means that changing the system clock backwards is bound to cause issues. I wouldn&apos;t be surprised if there are other problems in addition to the one mentioned here.&lt;/p&gt;</comment>
                            <comment id="15426279" author="rsivaram" created="Thu, 18 Aug 2016 11:14:01 +0000"  >&lt;p&gt;I think the issue is around the handling of timer tasks in Kafka. While task expiry is set using &lt;tt&gt;System.currentTimeMillis&lt;/tt&gt; which can move backwards (as reported in this JIRA), the internal timers in the TimingWheel in Kafka used to handle expiry is a monotonically increasing timer that starts with &lt;tt&gt;System.currentTimeMillis&lt;/tt&gt;. This mismatch causes expiry of tasks until &lt;tt&gt;System.currentTimeMillis&lt;/tt&gt; catches up with the internal timer.&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; has pointed out on the mailing list, Kafka uses &lt;tt&gt;System.currentTimeMillis&lt;/tt&gt; in a lot of places and switching to &lt;tt&gt;System.nanoTime&lt;/tt&gt; everywhere could impact performance. We have a few choices on fixing this JIRA (in increasing order of complexity)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;We could switch over to &lt;tt&gt;System.nanoTime&lt;/tt&gt; for TimerTasks alone to fix the issue with delayed tasks reported here&lt;/li&gt;
	&lt;li&gt;It may be possible to change the timer implementation to recover better when wall clock time moves backwards&lt;/li&gt;
	&lt;li&gt;Replace &lt;tt&gt;System.currentTimeMillis&lt;/tt&gt; with &lt;tt&gt;System.nanoTime&lt;/tt&gt; in time comparisons throughout Kafka code&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am inclined to do 1) and run performance tests, but am interested in what others think.&lt;/p&gt;</comment>
                            <comment id="15426290" author="rsivaram" created="Thu, 18 Aug 2016 11:26:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; As you have pointed out, there are inevitably going to be issues since Kafka uses System.currentTimeMillis in so many places. But typically, you would expect a single clock change to cause one expiry and thereafter continue to work with the changed timer (eg. producer metadata get expires and retry works since it is on the updated clock). The issue in this JIRA is that the broker doesn&apos;t recover until the wall clock time reaches the previously set time. I imagine changing the clock back by an hour is an uncommon scenario, but the impact is quite big if it does happen. If we are fixing this issue, it will be useful to have a system test to check that Kafka continues to function after a major clock change.&lt;/p&gt;</comment>
                            <comment id="15426292" author="ijuma" created="Thu, 18 Aug 2016 11:29:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;, option 1 seems worth a try. Note that it would have to be tested on Linux and Mac to verify that it fixes the underlying issue (it would be good to test on Windows too, but we have known issues in that platform so should not be a blocker, I guess). The JDK implementation relies on the OS (and with some JDK-level workarounds sometimes), so it&apos;s platform dependent.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gwenshap&quot; class=&quot;user-hover&quot; rel=&quot;gwenshap&quot;&gt;gwenshap&lt;/a&gt; had some concerns on the usage of System.nanoTime with regards to the impact on loaded systems so it would be good to get her thoughts too.&lt;/p&gt;</comment>
                            <comment id="15427554" author="gwenshap" created="Fri, 19 Aug 2016 03:32:31 +0000"  >&lt;p&gt;I was definitely concerned about complete replacement throughout the code. Especially when there was no justification in most places.&lt;/p&gt;

&lt;p&gt;I think that going with option 1, doing performance comparisons and documenting exactly why we use nanotime there will be good.&lt;/p&gt;</comment>
                            <comment id="15427840" author="rsivaram" created="Fri, 19 Aug 2016 08:47:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gwenshap&quot; class=&quot;user-hover&quot; rel=&quot;gwenshap&quot;&gt;gwenshap&lt;/a&gt; Thank you both for the feedback. I will try it out locally, and run performance tests. I can test on Linux and Mac.&lt;/p&gt;</comment>
                            <comment id="15429000" author="onurkaraman" created="Fri, 19 Aug 2016 23:01:26 +0000"  >&lt;p&gt;Is there a legitimate reason for rolling back your clock, especially by an hour? Unless there&apos;s a legitimate reason, I don&apos;t see the value in investigating a solution further.&lt;/p&gt;

&lt;p&gt;Based on some quick reading, when the delta in times grows large (it was hard for me to tell if the threshold is 128 ms or 128 s, the docs mention both), ntpd may either step the time back or do slew-based correction depending on how you configure it.&lt;/p&gt;

&lt;p&gt;warning: I know next to nothing about ntp!&lt;/p&gt;

&lt;p&gt;reference: &lt;a href=&quot;http://doc.ntp.org/4.2.4/ntpd.html#op&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://doc.ntp.org/4.2.4/ntpd.html#op&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15430479" author="githubbot" created="Mon, 22 Aug 2016 09:59:23 +0000"  >&lt;p&gt;GitHub user rajinisivaram opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1768&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4051&quot; title=&quot;Strange behavior during rebalance when turning the OS clock back&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4051&quot;&gt;&lt;del&gt;KAFKA-4051&lt;/del&gt;&lt;/a&gt;: Use nanosecond clock for timers in broker&lt;/p&gt;

&lt;p&gt;    Use System.nanoseconds instead of System.currentTimeMillis in broker timer tasks to cope with changes to wall-clock time.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rajinisivaram/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rajinisivaram/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4051&quot; title=&quot;Strange behavior during rebalance when turning the OS clock back&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4051&quot;&gt;&lt;del&gt;KAFKA-4051&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1768.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1768.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1768&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 366659f9a6a0212030349bc54e0c798e3d6c2122&lt;br/&gt;
Author: Rajini Sivaram &amp;lt;rajinisivaram@googlemail.com&amp;gt;&lt;br/&gt;
Date:   2016-08-19T10:13:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4051&quot; title=&quot;Strange behavior during rebalance when turning the OS clock back&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4051&quot;&gt;&lt;del&gt;KAFKA-4051&lt;/del&gt;&lt;/a&gt;: Use nanosecond clock for timers in broker&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15430521" author="rsivaram" created="Mon, 22 Aug 2016 10:26:48 +0000"  >&lt;p&gt;Agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=onurkaraman&quot; class=&quot;user-hover&quot; rel=&quot;onurkaraman&quot;&gt;onurkaraman&lt;/a&gt; that this is an unusual scenario. But the fix is a small change that can be seen as one small step towards improving Kafka&apos;s resilience to wall-clock time changes. The PR avoids the need for a broker restart in this case, but perhaps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ibarra&quot; class=&quot;user-hover&quot; rel=&quot;ibarra&quot;&gt;ibarra&lt;/a&gt; can provide more context to the problem scenario.&lt;/p&gt;</comment>
                            <comment id="15430981" author="gabriel.ibarra" created="Mon, 22 Aug 2016 15:23:31 +0000"  >&lt;p&gt;Hi, I&apos;m sorry for the delay.&lt;br/&gt;
I agree with you guys, it is not a typical scenario, it is even difficult for me to think about the reasons for a System Administrator to change the data/time; but he can, and as Rajini Sivaram said the impact is quite big if it does happen.&lt;/p&gt;

&lt;p&gt;Added to that, our system is working in a VM with NTP, and we see some spurious changes on the system time (this way we detected this issue), we are now analyzing why the time is changing, but we suspect that the system start with the hardware time and then NTP synchronize the system clock using the time zone configured in the VM.&lt;/p&gt;

&lt;p&gt;It is a good news that it could be fixed with small changes. Great Job Rajini&lt;/p&gt;</comment>
                            <comment id="15431751" author="gwenshap" created="Mon, 22 Aug 2016 22:58:59 +0000"  >&lt;p&gt;Issue resolved by pull request 1768&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1768&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15431752" author="githubbot" created="Mon, 22 Aug 2016 22:59:06 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1768&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32e4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>