<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13419] sync group failed with rebalanceInProgress error might cause out-of-date ownedPartition in Cooperative protocol</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13419</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13406&quot; title=&quot;Cooperative sticky assignor got stuck due to assignment validation failed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-13406&quot;&gt;&lt;del&gt;KAFKA-13406&lt;/del&gt;&lt;/a&gt;, we found there&apos;s user got stuck when in rebalancing with cooperative sticky assignor. The reason is the &quot;ownedPartition&quot; is out-of-date, and it failed the cooperative assignment validation.&lt;/p&gt;

&lt;p&gt;Investigate deeper, I found the root cause is we didn&apos;t reset generation and state after sync group fail. In &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12983&quot; title=&quot;onJoinPrepare is not always invoked before joining the group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12983&quot;&gt;&lt;del&gt;KAFKA-12983&lt;/del&gt;&lt;/a&gt;, we fixed the issue that the onJoinPrepare is not called in resetStateAndRejoin method. And it causes the ownedPartition not get cleared. But there&apos;s another case that the ownedPartition will be out-of-date. Here&apos;s the example:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;consumer A joined and synced group successfully with generation 1&lt;/li&gt;
	&lt;li&gt;New rebalance started with generation 2, consumer A joined successfully, but somehow, consumer A doesn&apos;t send out sync group immediately&lt;/li&gt;
	&lt;li&gt;other consumer completed sync group successfully in generation 2, except consumer A.&lt;/li&gt;
	&lt;li&gt;After consumer A send out sync group, the new rebalance start, with generation 3. So consumer A got REBALANCE_IN_PROGRESS error with sync group response&lt;/li&gt;
	&lt;li&gt;When receiving REBALANCE_IN_PROGRESS, we re-join the group, with generation 3, with the assignment (ownedPartition) in generation 1.&lt;/li&gt;
	&lt;li&gt;So, now, we have out-of-date ownedPartition sent, with unexpected results happened&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We might want to do &lt;b&gt;resetStateAndRejoin&lt;/b&gt; when &lt;b&gt;RebalanceInProgressException&lt;/b&gt; errors happend in &lt;b&gt;sync group&lt;/b&gt;. Because when we got sync group error, it means, join group passed, and other consumers (and the leader) might already completed this round of rebalance. The assignment distribution this consumer have is already out-of-date.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13409059">KAFKA-13419</key>
            <summary>sync group failed with rebalanceInProgress error might cause out-of-date ownedPartition in Cooperative protocol</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="showuon">Luke Chen</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Oct 2021 07:32:32 +0000</created>
                <updated>Fri, 28 Oct 2022 09:14:02 +0000</updated>
                            <resolved>Wed, 23 Feb 2022 01:36:28 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.1.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17496384" author="kirktrue" created="Tue, 22 Feb 2022 23:39:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; - this Jira is marked as in progress, yet I see that the corresponding PR has been merged already. Is this still in progress? If not, please update the fixed version and mark as fixed.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17496423" author="showuon" created="Wed, 23 Feb 2022 01:36:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; , thanks for the reminder. Updated.&lt;/p&gt;</comment>
                            <comment id="17555390" author="JIRAUSER289108" created="Fri, 17 Jun 2022 06:11:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;After i applied this fix and my previous change to make this fix work&lt;a href=&quot;https://github.com/apache/kafka/pull/12140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/12140, &lt;/a&gt;what we are seeing is that: sometimes consumer will revoker almost all partitions with cooperative enabled.&lt;/p&gt;

&lt;p&gt;detail:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we have more than 1000 consumers, coopeartive rebalance.&#160;&lt;/li&gt;
	&lt;li&gt;Just the same as the example in this JIRA:&#160; in cooperative rebalance some consumer will do a very quick re-join after get SyncGroupResponse. if there are some consumer that didn&apos;t send SyncGroupRequest yet, it will do a revoke-all and re-join operation.&lt;/li&gt;
	&lt;li&gt;after applied this change, it will solve the rebalance many rounds problem &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13891&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13891&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;but it will result in many partitions revoked if there is a very fast re-join consumer, and make cooperative almost the same as eager rebalance.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So instead of &quot;&lt;b&gt;resetStateAndRejoin&lt;/b&gt;&#160;when&#160;&lt;b&gt;RebalanceInProgressException&lt;/b&gt;&#160;errors happend in&#160;&lt;b&gt;sync group&lt;/b&gt;&quot;, can we just treat the ownedPartition in previous generation legal if there are no same partition claimed by other member?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;

&lt;p&gt;Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="17624866" author="ableegoldman" created="Thu, 27 Oct 2022 05:42:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;&#160; can we just treat the ownedPartition in previous generation legal if there are no same partition claimed by other member?&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Huh, I thought that&apos;s already what the cooperative assignor does? Maybe we intentionally left/took it out of the constrained case algorithm for some reason? Or possibly we had just discussed doing this and never did, either way I definitely remember this specific handling logic coming up during the recent(ish) optimizations that I worked on with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ll check out the code I guess&lt;/p&gt;</comment>
                            <comment id="17624885" author="showuon" created="Thu, 27 Oct 2022 06:48:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; , you are right. We have the logic to handle multiple consumers owned the same partitions case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17624934" author="ableegoldman" created="Thu, 27 Oct 2022 07:54:53 +0000"  >&lt;p&gt;Cool, thanks for confirming this is already handled in the assignor. Ok then, that said &#8211; or actually, &lt;em&gt;because&lt;/em&gt; of this, I do agree that we should revert &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13891&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13891&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe we can look into the logs to better understand the original problem you were experiencing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aiquestion&quot; class=&quot;user-hover&quot; rel=&quot;aiquestion&quot;&gt;aiquestion&lt;/a&gt; &#8211; or were you not personally hitting the issue &quot;fixed&quot; by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-13891&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-13891&lt;/a&gt;, just vigilant about submitting a patch when you noticed we had mentioned making this change in &lt;a href=&quot;https://github.com/apache/kafka/pull/11451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11451&lt;/a&gt; but then apparently left it out?&lt;/p&gt;</comment>
                            <comment id="17625532" author="dajac" created="Fri, 28 Oct 2022 09:00:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Looking at the code in AbstractStickyPartitioner, it seems that we discard all previous generations when we see a more recent one. So we have the code to handle multiple generations but we don&apos;t try to reuse previous generations. So if a partition is claimed by a member at an older generation and no one else, it seems to me that we won&apos;t reuse it. I may be reading it wrong as well. This is the first time I read this code.&lt;/p&gt;</comment>
                            <comment id="17625541" author="showuon" created="Fri, 28 Oct 2022 09:11:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt; , you&apos;re right. We don&apos;t use owned partitions in old generation. We treat is as stale owned partitions and ignore them. But you&apos;re right, if there are no other members claiming owning the partitions, we can keep letting the member own them.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17625542" author="dajac" created="Fri, 28 Oct 2022 09:14:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; Thanks for confirming.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13408621">KAFKA-13406</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0w9uw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>