<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16101] KRaft migration rollback documentation is incorrect</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16101</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I was trying the KRaft migration rollback procedure locally and I came across a potential bug or anyway a situation where the cluster is not usable/available for a certain amount of time.&lt;/p&gt;

&lt;p&gt;In order to test the procedure, I start with a one broker (broker ID = 0) and one zookeeper node cluster. Then I start the migration with a one KRaft controller node (broker ID = 1). The migration runs fine and it reaches the point of &quot;dual write&quot; state.&lt;/p&gt;

&lt;p&gt;From this point, I try to run the rollback procedure as described in the documentation.&lt;/p&gt;

&lt;p&gt;As first step, this involves ...&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;stopping the broker&lt;/li&gt;
	&lt;li&gt;removing the __cluster_metadata folder&lt;/li&gt;
	&lt;li&gt;removing ZooKeeper migration flag and controller(s) related configuration from the broker&lt;/li&gt;
	&lt;li&gt;restarting the broker&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With the above steps done, the broker starts in ZooKeeper mode (no migration, no KRaft controllers knowledge) and it keeps logging the following messages in DEBUG:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2024-01-08 11:51:20,608] DEBUG [zk-broker-0-to-controller-forwarding-channel-manager]: Controller isn&apos;t cached, looking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; local metadata changes (kafka.server.BrokerToControllerRequestThread)
[2024-01-08 11:51:20,608] DEBUG [zk-broker-0-to-controller-forwarding-channel-manager]: No controller provided, retrying after backoff (kafka.server.BrokerToControllerRequestThread)
[2024-01-08 11:51:20,629] DEBUG [zk-broker-0-to-controller-alter-partition-channel-manager]: Controller isn&apos;t cached, looking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; local metadata changes (kafka.server.BrokerToControllerRequestThread)
[2024-01-08 11:51:20,629] DEBUG [zk-broker-0-to-controller-alter-partition-channel-manager]: No controller provided, retrying after backoff (kafka.server.BrokerToControllerRequestThread) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What&apos;s happening should be clear.&lt;/p&gt;

&lt;p&gt;The /controller znode in ZooKeeper still reports the KRaft controller (broker ID = 1) as controller. The broker gets it from the znode but doesn&apos;t know how to reach it.&lt;/p&gt;

&lt;p&gt;The issue is that until the procedure isn&apos;t fully completed with the next steps (shutting down KRaft controller, deleting /controller znode), the cluster is unusable. Any admin or client operation against the broker doesn&apos;t work, just hangs, the broker doesn&apos;t reply.&lt;/p&gt;

&lt;p&gt;Imagining this scenario to a more complex one with 10-20-50 brokers and partitions&apos; replicas spread across them, when the brokers are rolled one by one (in ZK mode) reporting the above error, the topics will become not available one after the other, until all brokers are in such a state and nothing can work. This is because from a KRaft controller perspective (still running), the brokers are not available anymore and the partitions&apos; replicas are out of sync.&lt;/p&gt;

&lt;p&gt;Of course, as soon as you complete the rollback procedure, after deleting the /controller znode, the brokers are able to elect a new controller among them and everything recovers to work.&lt;/p&gt;

&lt;p&gt;My first question ... isn&apos;t the cluster supposed to work during rollback and being always available during the rollback when the procedure is not completed yet? Or having the cluster not available is an assumption during the rollback, until it&apos;s fully completed?&lt;/p&gt;

&lt;p&gt;This &quot;unavailability&quot; time window could be reduced by deleting the /controller znode before shutting down the KRaft controllers to allow the brokers electing a new controller among them, but in this case, could there be a race condition where KRaft controllers still running could steal leadership again?&lt;/p&gt;

&lt;p&gt;Or is there anything missing in the documentation maybe which is driving to this problem?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13564039">KAFKA-16101</key>
            <summary>KRaft migration rollback documentation is incorrect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cmccabe">Colin McCabe</assignee>
                                    <reporter username="ppatierno">Paolo Patierno</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Jan 2024 11:50:07 +0000</created>
                <updated>Mon, 5 Feb 2024 11:03:18 +0000</updated>
                            <resolved>Wed, 31 Jan 2024 07:25:50 +0000</resolved>
                                    <version>3.6.1</version>
                                    <fixVersion>3.7.0</fixVersion>
                                    <component>kraft</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17805009" author="showuon" created="Wed, 10 Jan 2024 08:31:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccabe&quot; class=&quot;user-hover&quot; rel=&quot;cmccabe&quot;&gt;cmccabe&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mumrah&quot; class=&quot;user-hover&quot; rel=&quot;mumrah&quot;&gt;mumrah&lt;/a&gt;, I&apos;d like to hear your thoughts about this availability issue during rolling back from KRaft mode to ZK mode. Thanks.&lt;/p&gt;</comment>
                            <comment id="17805548" author="showuon" created="Thu, 11 Jan 2024 12:11:52 +0000"  >&lt;p&gt;It seems we didn&apos;t consider it during our KIP design. I&apos;m thinking we might need another flag to let brokers know this is rollbacking and update the controller znode in ZK in brokers. Thoughts?&lt;/p&gt;</comment>
                            <comment id="17806678" author="cmccabe" created="Mon, 15 Jan 2024 08:07:24 +0000"  >&lt;p&gt;Hi Luke,&lt;/p&gt;

&lt;p&gt;Thanks for testing rollback. I think this is a case where the documentation is wrong. The intention was to for the steps to basically be:&lt;/p&gt;

&lt;p&gt;1. roll all the brokers into zk mode, but with migration enabled&lt;br/&gt;
2. take down the kraft quorum&lt;br/&gt;
3. rmr /controller, allowing a hybrid broker to take over.&lt;br/&gt;
4. roll all the brokers into zk mode without migration enabled (if desired)&lt;/p&gt;

&lt;p&gt;With these steps, there isn&apos;t really unavailability since a ZK controller can be elected quickly after the kraft quorum is gone.&lt;/p&gt;

&lt;p&gt;I will update the docs.&lt;/p&gt;</comment>
                            <comment id="17806706" author="mimaison" created="Mon, 15 Jan 2024 09:13:34 +0000"  >&lt;p&gt;Updating the docs is a good first step but we should have integration/system tests covering this operation. I created &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16130&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-16130&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mn00:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>