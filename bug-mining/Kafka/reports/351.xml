<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:39:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1008] Unmap before resizing</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1008</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;While I was studying how MappedByteBuffer works, I saw a sharing runtime exception on Windows. I applied what I learned to generate a patch which uses an internal open JDK API to solve this problem.&lt;/p&gt;

&lt;p&gt;Following Jay&apos;s advice, I made a helper method called tryUnmap(). &lt;/p&gt;</description>
                <environment>Windows, Linux, Mac OS</environment>
        <key id="12663349">KAFKA-1008</key>
            <summary>Unmap before resizing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="lizziew">Elizabeth Wei</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Tue, 13 Aug 2013 04:28:58 +0000</created>
                <updated>Tue, 15 Oct 2013 22:58:46 +0000</updated>
                            <resolved>Tue, 15 Oct 2013 22:58:46 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                    <component>log</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>10</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13737818" author="lizziew" created="Tue, 13 Aug 2013 04:57:31 +0000"  >&lt;p&gt;Patch file&lt;/p&gt;</comment>
                            <comment id="13737841" author="guozhang" created="Tue, 13 Aug 2013 05:18:43 +0000"  >&lt;p&gt;Will this patch restrict to Sun JVM-only environments?&lt;/p&gt;</comment>
                            <comment id="13737845" author="lizziew" created="Tue, 13 Aug 2013 05:26:12 +0000"  >&lt;p&gt;For non Sun JVM environments, tryUnmap is no-op for now; we can add support for other JVM environments later on.&lt;/p&gt;</comment>
                            <comment id="13738373" author="jkreps" created="Tue, 13 Aug 2013 15:36:52 +0000"  >&lt;p&gt;Hey Elizabeth, thanks for the patch!&lt;/p&gt;

&lt;p&gt;Three follow-up items for us to take this:&lt;br/&gt;
1. If we refer to sun.nio.ch.DirectBuffer that introduces a build-time dependency on Sun java. I think that is probably okay. But what is the behavior of tryUnmap on a non-sun jvm at runtime (or if sun ever changes their implementation)? My suspicion is that we would get a ClassNotFoundException for sun.nio.ch.DirectBuffer right? I think we would be better off wrapping everything inside tryUnmap inside a try/catch and trace logging if there is an exception.&lt;br/&gt;
2. It looks like you added back in a call to flush which we removed as part of another patch. Probably accidental, right?&lt;br/&gt;
3. I would like to understand the security issue on the Sun ticket for unmap here: &lt;a href=&quot;http://bugs.sun.com/view_bug.do?bug_id=4724038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.sun.com/view_bug.do?bug_id=4724038&lt;/a&gt; If we don&apos;t understand what the concern is then there is a possibility we are introducing a security problem (though I don&apos;t think so...).&lt;/p&gt;</comment>
                            <comment id="13739105" author="lizziew" created="Wed, 14 Aug 2013 01:02:53 +0000"  >&lt;p&gt;Thanks for the feedback!&lt;/p&gt;

&lt;p&gt;1 - Currently tryUnmap does a type checking. If the super class of &quot;m&quot; is changed in the future, the type check will be false, and there will be no casting errors like ClassNotFoundException at runtime. &lt;/p&gt;

&lt;p&gt;2 - I removed the flush(). I probably used an older copy a couple of weeks ago.&lt;/p&gt;

&lt;p&gt;3 - Reading through the bug report, I&apos;m not sure if the cases matter in terms of Kafka - I think all the threads in a Kafka process should be trusted and the race condition between the unmap/remap shouldn&apos;t happen if coded properly. I noticed that in the most recent version, the resize method is synchronized, which should prevent multiple threads trying to resize/unmap the files. &lt;/p&gt;</comment>
                            <comment id="13739197" author="jkreps" created="Wed, 14 Aug 2013 04:02:23 +0000"  >&lt;p&gt;Hey Elizabeth, thanks for the patch.&lt;/p&gt;

&lt;p&gt;Two issues.&lt;/p&gt;

&lt;p&gt;The first is that I think that instanceof check will actually throw an exception on a non-sun jvm. See the experiment below and see what you think.&lt;/p&gt;

&lt;p&gt;The second issue is actually a more subtle thing. Currently the synchronization is really just for changes to the buffer, the read-access are lock-free (which is good). My concern is what happens if we force clean a buffer while a read is occurring? Not sure if this can happen or not, but I think we need to somehow be sure it can&apos;t.&lt;/p&gt;

&lt;p&gt;Here was my test:&lt;br/&gt;
$ cat /tmp/code/Test.java &lt;br/&gt;
import test.MyTest;&lt;/p&gt;

&lt;p&gt;public class Test {&lt;br/&gt;
    public static void main(String[] args) &lt;/p&gt;
{
	Object o = new Object();
	    if(o instanceof MyTest)
		System.out.println(&quot;Hello&quot;);
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;$ cat /tmp/code/test/MyTest.java &lt;br/&gt;
package test;&lt;/p&gt;

&lt;p&gt;public class MyTest {&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;I do &lt;br/&gt;
javac /tmp/code/test/MyTest.java&lt;br/&gt;
javac -cp /tmp/code /tmp/code/Test.java&lt;br/&gt;
rm /tmp/code/test/MyTest.class&lt;br/&gt;
$ java -cp /tmp/code Test&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: test/MyTest&lt;br/&gt;
	at Test.main(Test.java:6)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: test.MyTest&lt;br/&gt;
	at java.net.URLClassLoader$1.run(URLClassLoader.java:202)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at java.net.URLClassLoader.findClass(URLClassLoader.java:190)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:306)&lt;br/&gt;
	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:247)&lt;br/&gt;
	... 1 more&lt;/p&gt;

&lt;p&gt;We also can&apos;t really be too sure what kind of exceptions clean() might throw.&lt;/p&gt;
</comment>
                            <comment id="13739926" author="lizziew" created="Wed, 14 Aug 2013 17:38:34 +0000"  >&lt;p&gt;Thanks, I added the try/catch to handle the exceptions.&lt;/p&gt;

&lt;p&gt;I found the following coding pattern &lt;br/&gt;
val idx = mmap.duplicate&lt;br/&gt;
in this file. It seems like it always makes a copy of the buffer for &quot;read&quot;. &lt;/p&gt;
</comment>
                            <comment id="13740611" author="jkreps" created="Thu, 15 Aug 2013 02:38:26 +0000"  >&lt;p&gt;But my understanding is that these copies are just copies of pointer object (i.e. a position, limit, mark, etc) so if you unmap the underlying mmap while reads are occurring something bad will happen.&lt;/p&gt;

&lt;p&gt;Another way to say this is what happens in the following code execution:&lt;br/&gt;
MappedByteBuffer orig = // map file&lt;br/&gt;
MappedByteBuffer copy = orig.duplicate()&lt;br/&gt;
(orig.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;sun.nio.ch.DirectBuffer&amp;#93;&lt;/span&gt;).cleaner().clean()&lt;br/&gt;
copy.get()&lt;/p&gt;

&lt;p&gt;My suspicion is that something terrible will happen, but I could be wrong.&lt;/p&gt;</comment>
                            <comment id="13740742" author="lizziew" created="Thu, 15 Aug 2013 06:19:13 +0000"  >&lt;p&gt;That&apos;s right, the duplicate is a shallow copy of the buffer. Do you have a case where the buffer is being used while resizing? I did a quick grep, and it looks like resize is only being used during logfile loading or truncation.&lt;/p&gt;</comment>
                            <comment id="13741035" author="jkreps" created="Thu, 15 Aug 2013 15:00:51 +0000"  >&lt;p&gt;Yeah, the problem is reads continue while the log is being rolled.&lt;/p&gt;

&lt;p&gt;Here are a bunch of possible solutions I can think of&lt;br/&gt;
1. Lock reads&lt;br/&gt;
2. Delay the truncate until the larger mmap is collected&lt;/p&gt;

&lt;p&gt;For (2) the problem is that it actually interferes with the recoverability of the log. If we have old log segments with a bunch of unfilled bytes in their index segment we need to recover those segments. But currently we only recover from the last flush point.&lt;/p&gt;

&lt;p&gt;So I think we need to lock read access. This isn&apos;t the end of the world but I would prefer to do this only on windows. My suggestion on implementation would be&lt;br/&gt;
1. Change from synchronized in OffsetIndex to Lock&lt;br/&gt;
2. Add an object called Os in kafka.utils that is something like&lt;/p&gt;

&lt;p&gt;object Os {&lt;br/&gt;
  private val osName = System.getProperty(&quot;os.name&quot;).toLowerCase&lt;br/&gt;
  val isWindows = osName.startsWith(&quot;windows&quot;)&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;We can expand this later if we need more specific OS detection capabilities or other OS-specific functionality.&lt;/p&gt;

&lt;p&gt;Then elsewhere we can just do&lt;br/&gt;
  if(Os.isWindows) lock.lock()&lt;br/&gt;
and the corresponding unlock.&lt;/p&gt;

&lt;p&gt;Does that seem like it would work?&lt;/p&gt;

</comment>
                            <comment id="13741037" author="jkreps" created="Thu, 15 Aug 2013 15:01:58 +0000"  >&lt;p&gt;Here is a list of os.name values (at least according to this random page):&lt;br/&gt;
&lt;a href=&quot;http://www.javaneverdie.com/java/java-os-name-property-values/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.javaneverdie.com/java/java-os-name-property-values/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13741938" author="lizziew" created="Fri, 16 Aug 2013 05:26:00 +0000"  >&lt;p&gt;Sounds like a good idea to have lock reads. Do you want to file a separate JIRA to address the lock read issue? &lt;/p&gt;</comment>
                            <comment id="13742391" author="jkreps" created="Fri, 16 Aug 2013 17:02:22 +0000"  >&lt;p&gt;I think it makes sense to do it as part of this patch since unmapping is the reason we need it and without it we will core dump the process under concurrency (so I don&apos;t think we can take the resizing change without the locking change). Sound reasonable?&lt;/p&gt;

&lt;p&gt;If we have the Os.isWindows check I think we can make BOTH the locking and the forced mmap clenaing all be inside the isWindows check. Thisshould fix things on windows and not functionally change perf at all on linux (which is good).&lt;/p&gt;</comment>
                            <comment id="13742853" author="lizziew" created="Sat, 17 Aug 2013 05:39:19 +0000"  >&lt;p&gt;Thanks Jay!&lt;br/&gt;
Please review the patch to see if it reflects your suggestion. I&apos;m still learning Scala, so please provide any feedback!&lt;/p&gt;</comment>
                            <comment id="13746719" author="tnachen" created="Wed, 21 Aug 2013 18:53:53 +0000"  >&lt;p&gt;I wonder if this patch can go in soon? It&apos;s a major blocker for anyone that wants to use Kafka on windows&lt;/p&gt;</comment>
                            <comment id="13746796" author="jkreps" created="Wed, 21 Aug 2013 20:21:12 +0000"  >&lt;p&gt;Hey Elizabeth, this basically looks good. A couple of minor things.&lt;/p&gt;

&lt;p&gt;One is I&apos;m not sure we are covering everything that needs to be locked. The next is that we are using synchronized with the lock instance which doesn&apos;t actually call lock (as in java that just acquires the monitor associated with the lock argument--sucky right?).&lt;/p&gt;

&lt;p&gt;I took a stab at reworking it. To make things not get too crazy I added a helper method inLock which makes the try/finally locking pattern a little more readable (hopefully).&lt;/p&gt;

&lt;p&gt;Would you be willing to take a detailed look at this and let me know if you think this works.&lt;/p&gt;

&lt;p&gt;The next thing we need to do is actually get this tested on Windows. I&apos;m not sure if there is anyone who has access to a Windows machine and could reproduce the old problem who could verify that this patch fixes it?&lt;/p&gt;</comment>
                            <comment id="13746866" author="lizziew" created="Wed, 21 Aug 2013 21:28:53 +0000"  >&lt;p&gt;The code change looks good. Using a higher order function makes the code look a lot cleaner! &lt;/p&gt;
</comment>
                            <comment id="13748206" author="davidlao" created="Fri, 23 Aug 2013 01:57:53 +0000"  >&lt;p&gt;Hi Jay,&lt;br/&gt;
The patch does not seem to apply cleanly on the 0.8 branch (see below). Can you look into generating a new patch for 0.8? &lt;/p&gt;

&lt;p&gt;git apply --check &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1008&quot; title=&quot;Unmap before resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1008&quot;&gt;&lt;del&gt;KAFKA-1008&lt;/del&gt;&lt;/a&gt;-v6.patch&lt;br/&gt;
error: patch failed: core/src/main/scala/kafka/log/OffsetIndex.scala:52&lt;br/&gt;
error: core/src/main/scala/kafka/log/OffsetIndex.scala: patch does not apply&lt;br/&gt;
error: patch failed: core/src/main/scala/kafka/utils/Utils.scala:21&lt;br/&gt;
error: core/src/main/scala/kafka/utils/Utils.scala: patch does not apply&lt;br/&gt;
error: patch failed: core/src/test/scala/unit/kafka/utils/UtilsTest.scala:18&lt;br/&gt;
error: core/src/test/scala/unit/kafka/utils/UtilsTest.scala: patch does not apply&lt;/p&gt;</comment>
                            <comment id="13748384" author="lizziew" created="Fri, 23 Aug 2013 08:17:08 +0000"  >&lt;p&gt;I generated a patch against the trunk to fix some of the issues in Jay&apos;s patch. Please check if it works! &lt;/p&gt;</comment>
                            <comment id="13750558" author="davidlao" created="Mon, 26 Aug 2013 21:16:01 +0000"  >&lt;p&gt;Hi Jay,&lt;br/&gt;
The master branch seems to be broken on Windows. Can you look into this? or produce a patch for 0.8? &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-08-26 14:09:41,761&amp;#93;&lt;/span&gt; FATAL &lt;span class=&quot;error&quot;&gt;&amp;#91;Replica Manager on Broker 3&amp;#93;&lt;/span&gt;: Error writing to highwatermark file:  (kafka.server.ReplicaManager)&lt;br/&gt;
java.io.IOException: File rename from c:\Apps\logs\broker-3\replication-offset-checkpoint.tmp to c:\Apps\logs\broker-3\replication-offset-checkpoint failed.&lt;br/&gt;
        at kafka.server.OffsetCheckpoint.liftedTree1$1(OffsetCheckpoint.scala:61)&lt;br/&gt;
        at kafka.server.OffsetCheckpoint.write(OffsetCheckpoint.scala:39)&lt;br/&gt;
        at kafka.server.ReplicaManager$$anonfun$checkpointHighWatermarks$2.apply(ReplicaManager.scala:312)&lt;br/&gt;
        at kafka.server.ReplicaManager$$anonfun$checkpointHighWatermarks$2.apply(ReplicaManager.scala:309)&lt;br/&gt;
        at scala.collection.immutable.Map$Map1.foreach(Map.scala:119)&lt;br/&gt;
        at kafka.server.ReplicaManager.checkpointHighWatermarks(ReplicaManager.scala:309)&lt;br/&gt;
        at kafka.server.ReplicaManager$$anonfun$startHighWaterMarksCheckPointThread$1.apply$mcV$sp(ReplicaManager.scala:92)&lt;br/&gt;
        at kafka.utils.KafkaScheduler$$anon$1.run(KafkaScheduler.scala:100)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:351)&lt;br/&gt;
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:178)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;</comment>
                            <comment id="13753086" author="jkreps" created="Thu, 29 Aug 2013 00:23:24 +0000"  >&lt;p&gt;Attached a version rebased to 0.8.&lt;/p&gt;</comment>
                            <comment id="13753311" author="sriramsub" created="Thu, 29 Aug 2013 05:16:52 +0000"  >&lt;p&gt;Looks good.&lt;/p&gt;

&lt;p&gt;1. OffsetIndex.scala&lt;/p&gt;

&lt;p&gt;1.1 Why do you need to re-calculate this.maxEntries = this.mmap.limit / 8 after remapping in resize instead of leaving it how it was previously (recalculated during the method call of maxEntries)?&lt;br/&gt;
1.2 maybeLock should be something that exist outside OffsetIndex. Seems like OS specific methods should reside together.&lt;br/&gt;
1.3 readLastOffset now locks. This is a behavior change on linux. This seems to only do a read so does it need to be &quot;maybeLock&quot;?&lt;/p&gt;

&lt;p&gt;2. Should we use the autolock for the cases below&lt;/p&gt;

&lt;p&gt;TestUtils.scala&lt;/p&gt;

&lt;p&gt;method - waitUntilLeaderIsElectedOrChanged&lt;/p&gt;

&lt;p&gt;HighWaterCheckpoint.scala&lt;/p&gt;

&lt;p&gt;method - write and read  &lt;/p&gt;

&lt;p&gt;3. Is autolock a better name than inlock?&lt;/p&gt;</comment>
                            <comment id="13754293" author="davidlao" created="Fri, 30 Aug 2013 01:30:02 +0000"  >&lt;p&gt;Thanks Jay. The 0.8 patch seems to be working on Windows. Please check it in.&lt;/p&gt;</comment>
                            <comment id="13765579" author="junrao" created="Thu, 12 Sep 2013 16:20:06 +0000"  >&lt;p&gt;Thanks for the patch. Reviewed patch v7 for 0.8. Looks good overall. Just a couple of minor comments.&lt;/p&gt;

&lt;p&gt;70. OffsetIndex: Should forceUnmap() be private?&lt;/p&gt;

&lt;p&gt;71. Just a question. Does anyone know if the OS property shows up as windows on cygwin?&lt;/p&gt;

&lt;p&gt;Sriram,&lt;/p&gt;

&lt;p&gt;For 1.1, the purpose is probably to save the division calculation, which is a bit expensive.&lt;/p&gt;</comment>
                            <comment id="13772459" author="nehanarkhede" created="Thu, 19 Sep 2013 23:22:56 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lizziew&quot; class=&quot;user-hover&quot; rel=&quot;lizziew&quot;&gt;lizziew&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkreps&quot; class=&quot;user-hover&quot; rel=&quot;jkreps&quot;&gt;jkreps&lt;/a&gt;. Could you address Jun&apos;s review comments and see if we can resolve this JIRA? This is marked for the 0.8 final release&lt;/p&gt;</comment>
                            <comment id="13773503" author="jkreps" created="Fri, 20 Sep 2013 22:17:21 +0000"  >&lt;p&gt;Sriram:&lt;br/&gt;
1.1 This is because this.mmap can be null so you have to either acquire the lock. To avoid this I just make the max size a separate variable.&lt;br/&gt;
1.2 It&apos;s actually only really useful in this class because the fact that we want to lock only on windows is very specific to the logic of this class.&lt;br/&gt;
1.3 Yeah this is technically not necessary since this method is only used during initialization but I try never to have the correctness of methods depend on when they are used.&lt;/p&gt;

&lt;p&gt;2. Added a lock for the leader election test cases. I am skipping the other usage because that file was heavily refactored in trunk and that lock removed (I think).&lt;/p&gt;

&lt;p&gt;3. I intend &lt;br/&gt;
      inLock&amp;#40;x&amp;#41; &lt;/p&gt;
{
        foo
      }
&lt;p&gt;to be read as &quot;in lock x do foo&quot;. So I like it since it is declarative.&lt;/p&gt;</comment>
                            <comment id="13773504" author="jkreps" created="Fri, 20 Sep 2013 22:18:28 +0000"  >&lt;p&gt;Jun, added private on that method. Not sure about cygwin.&lt;/p&gt;</comment>
                            <comment id="13773517" author="sriramsub" created="Fri, 20 Sep 2013 22:24:59 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13774241" author="lizziew" created="Mon, 23 Sep 2013 01:55:52 +0000"  >&lt;p&gt;Sorry - I am not as active on this at the moment. I am back at Exeter to start my junior year. I just did a quick test on my friend&apos;s computer:&lt;br/&gt;
System.out.println(System.getProperty(&quot;os.name&quot;));   &lt;br/&gt;
prints out &quot;Windows 7&quot; for both Windows cmd shell and cygwin/bash. &lt;/p&gt;

&lt;p&gt;This makes sense since cygwin is mainly a shell. &lt;/p&gt;</comment>
                            <comment id="13774619" author="junrao" created="Mon, 23 Sep 2013 15:18:32 +0000"  >&lt;p&gt;Thanks for patch v8. Just one more comment.&lt;/p&gt;

&lt;p&gt;80. OffsetIndex: The patch synchronizes in readLastOffset(), is that necessary?&lt;/p&gt;</comment>
                            <comment id="13774684" author="jkreps" created="Mon, 23 Sep 2013 16:18:34 +0000"  >&lt;p&gt;Sriram had the same comment. It is possible to reason that the existing ways the method is used don&apos;t need synchronization but I don&apos;t think the method is thread safe since it depends on both size and mmap both of which can change (so e.g. mmap could be null and a truncate call could theoretically interleave with this call). I don&apos;t think it is very safe to have methods whose correctness depends on the existing call pattern. The synchronization doesn&apos;t hurt, in any case since this is not in any critical read or write path.&lt;/p&gt;</comment>
                            <comment id="13774698" author="junrao" created="Mon, 23 Sep 2013 16:32:00 +0000"  >&lt;p&gt;Sorry, I missed that comment. +1 on v8.&lt;/p&gt;</comment>
                            <comment id="13791016" author="jkreps" created="Thu, 10 Oct 2013 00:02:40 +0000"  >&lt;p&gt;Attached &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1008&quot; title=&quot;Unmap before resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1008&quot;&gt;&lt;del&gt;KAFKA-1008&lt;/del&gt;&lt;/a&gt;-v9-trunk.patch which ports the final 0.8 patch to trunk and also adds a fix for the windows compatibility issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1036&quot; title=&quot;Unable to rename replication offset checkpoint in windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1036&quot;&gt;&lt;del&gt;KAFKA-1036&lt;/del&gt;&lt;/a&gt; in OffsetCheckpoint.scala.&lt;/p&gt;</comment>
                            <comment id="13791171" author="junrao" created="Thu, 10 Oct 2013 04:12:49 +0000"  >&lt;p&gt;Thanks for the patch for trunk. +1.&lt;/p&gt;</comment>
                            <comment id="13795767" author="jkreps" created="Tue, 15 Oct 2013 22:58:46 +0000"  >&lt;p&gt;Checked in on 0.8 and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12670233">KAFKA-1065</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12600516" name="KAFKA-0.8-1008-v7.patch" size="17860" author="jkreps" created="Thu, 29 Aug 2013 00:23:24 +0000"/>
                            <attachment id="12604322" name="KAFKA-0.8-1008-v8.patch" size="18279" author="jkreps" created="Fri, 20 Sep 2013 22:05:41 +0000"/>
                            <attachment id="12599263" name="KAFKA-1008-v6.patch" size="15748" author="jkreps" created="Wed, 21 Aug 2013 20:21:12 +0000"/>
                            <attachment id="12607697" name="KAFKA-1008-v9-trunk.patch" size="20172" author="jkreps" created="Thu, 10 Oct 2013 00:02:40 +0000"/>
                            <attachment id="12599592" name="KAFKA-trunk-1008-v7.patch" size="32362" author="lizziew" created="Fri, 23 Aug 2013 08:13:58 +0000"/>
                            <attachment id="12598572" name="unmap-v5.patch" size="12287" author="lizziew" created="Sat, 17 Aug 2013 05:38:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343350</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n7nr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>343654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>