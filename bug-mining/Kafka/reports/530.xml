<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:41:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1663] Controller unable to shutdown after a soft failure</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1663</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;As part of testing &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1558&quot; title=&quot;AdminUtils.deleteTopic does not work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1558&quot;&gt;&lt;del&gt;KAFKA-1558&lt;/del&gt;&lt;/a&gt; I came across a case where inducing soft failure in the current controller elects a new controller  but the old controller doesn&apos;t shutdown properly.&lt;br/&gt;
steps to reproduce&lt;br/&gt;
1) 5 broker cluster&lt;br/&gt;
2) high number of topics(I tested it with 1000 topics)&lt;br/&gt;
3) on the current controller do kill -SIGSTOP  pid( broker&apos;s process id)&lt;br/&gt;
4) wait for bit over zookeeper timeout (server.properties)&lt;br/&gt;
5) kill -SIGCONT pid&lt;br/&gt;
6) There will be a new controller elected. check old controller&apos;s&lt;br/&gt;
log &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 15:59:53,398&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;SessionExpirationListener on 1&amp;#93;&lt;/span&gt;, ZK expired; shut down all controller components and try to re-elect (kafka.controller.KafkaController$SessionExpirationListener)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2014-09-30 15:59:53,400&amp;#93;&lt;/span&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;delete-topics-thread-1&amp;#93;&lt;/span&gt;, Shutting down (kafka.controller.TopicDeletionManager$DeleteTopicsThread)&lt;/p&gt;

&lt;p&gt;If it stops there and the broker  logs keeps printing &lt;br/&gt;
Cached zkVersion &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; not equal to that in zookeeper, skip updating ISR (kafka.cluster.Partition)&lt;br/&gt;
than the controller shutdown never completes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745270">KAFKA-1663</key>
            <summary>Controller unable to shutdown after a soft failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sriharsha">Harsha</assignee>
                                    <reporter username="sriharsha">Harsha</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Oct 2014 14:52:42 +0000</created>
                <updated>Thu, 9 Oct 2014 21:39:15 +0000</updated>
                            <resolved>Thu, 9 Oct 2014 21:39:15 +0000</resolved>
                                                    <fixVersion>0.8.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14156873" author="sriharsha" created="Thu, 2 Oct 2014 17:54:32 +0000"  >&lt;p&gt;bit more info KafkaController.shutdown never coming out of  deleteTopicsThread.awaitShutdown() after a soft failure causing the above issue. This is not very consistent behavior but I am able to reproduce kafka cluster running  on ec2 m3.xlarge .&lt;/p&gt;</comment>
                            <comment id="14157214" author="nehanarkhede" created="Thu, 2 Oct 2014 21:30:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Thanks for reproducing this. Could you please attach the thread dump that shows where the delete topics thread hangs?&lt;/p&gt;</comment>
                            <comment id="14157501" author="sriharsha" created="Fri, 3 Oct 2014 00:23:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; testing out few possible fixes will upload the thread dump soon. Thanks.&lt;/p&gt;</comment>
                            <comment id="14157511" author="sriharsha" created="Fri, 3 Oct 2014 00:35:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I&apos;ve a question on TopicDeletionManager code&lt;br/&gt;
I think the idea is to start the DeleteTopicsThread and wait for the events like topics are added to delete set and trigger the doWork() method. &lt;br/&gt;
right now doWork() method calls awaitTopicDeletionNotifictation&lt;/p&gt;

&lt;p&gt;  private def awaitTopicDeletionNotification() {&lt;br/&gt;
    inLock(deleteLock) {&lt;br/&gt;
      while(!deleteTopicsThread.isRunning.get() &amp;amp;&amp;amp; !deleteTopicStateChanged.compareAndSet(true, false)) {&lt;br/&gt;
                       deleteTopicsCond.await()&lt;br/&gt;
}&lt;br/&gt;
This condition seems to be wrong and it doesn&apos;t block DeleteTopicThread once the TopicDeletionManager starts the deleteTopicsThread.doWork() continues to execute.&lt;/p&gt;

&lt;p&gt;The above condition should state&lt;br/&gt;
 while(deleteTopicsThread.isRunning.get() &amp;amp;&amp;amp; deleteTopicStateChanged.compareAndSet(true, false)) {&lt;br/&gt;
        deleteTopicsCond.await()&lt;br/&gt;
}&lt;br/&gt;
whenever there is topic is added we are callign resumeTopicDeletionThread() which sets deleteTopicStateChanged to true and sends deleteTopicCond.signal() which should wake up doWork() and continue with deletion of the topic.&lt;br/&gt;
I am testing with this change, will update with the results. &lt;/p&gt;</comment>
                            <comment id="14157561" author="sriharsha" created="Fri, 3 Oct 2014 01:31:16 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26306/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26306/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14157562" author="sriharsha" created="Fri, 3 Oct 2014 01:32:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I tested the attached patch for recovering from soft failure and also few delete topic cases. but I haven&apos;t gone though the entire &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1558&quot; title=&quot;AdminUtils.deleteTopic does not work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1558&quot;&gt;&lt;del&gt;KAFKA-1558&lt;/del&gt;&lt;/a&gt; test cases. I am going to run them now , meanwhile can you please review the patch. Thanks.&lt;/p&gt;</comment>
                            <comment id="14158227" author="sriharsha" created="Fri, 3 Oct 2014 17:35:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I ran all the tests in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1558&quot; title=&quot;AdminUtils.deleteTopic does not work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1558&quot;&gt;&lt;del&gt;KAFKA-1558&lt;/del&gt;&lt;/a&gt; they all pass with the above patch and didn&apos;t see any issues with soft failure case.&lt;/p&gt;</comment>
                            <comment id="14158828" author="nehanarkhede" created="Sat, 4 Oct 2014 00:53:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt; Awesome. I&apos;ll review this tomorrow.&lt;/p&gt;</comment>
                            <comment id="14159374" author="nehanarkhede" created="Sun, 5 Oct 2014 01:10:44 +0000"  >&lt;p&gt;Thanks for the patch! Pushed to trunk&lt;/p&gt;</comment>
                            <comment id="14159752" author="junrao" created="Sun, 5 Oct 2014 23:49:55 +0000"  >&lt;p&gt;Neha,&lt;/p&gt;

&lt;p&gt;Since this is a blocker for 0.8.2, could you push this to the 0.8.2 branch too? Thanks,&lt;/p&gt;</comment>
                            <comment id="14161898" author="nehanarkhede" created="Tue, 7 Oct 2014 14:04:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sriharsha&quot; class=&quot;user-hover&quot; rel=&quot;sriharsha&quot;&gt;sriharsha&lt;/a&gt;, while talking to Jun, realized that there may have been a regression introduced by the patch by removing the deleteTopicStateChanged.set(true) from startup(). The purpose of that is to let the delete topic thread resume topic deletion on startup for topics for which deletion was initiated on the previous controller. During the review, I assumed that the controller is signaling the delete topic thread separately after startup, but that is not the case. &lt;/p&gt;

&lt;p&gt;However, while reading through the code, I think there is a bug in the above case where the controller needs to resume topic deletion on startup. Basically the way for the controller to notify the TopicDeletionManager of resuming the thread is via the callers of resumeTopicDeletionThread(). Each of those caller APIs are protected via the controllerLock in KafkaController. However, awaitTopicDeletionNotification is not. So there is a window when the controller might signal a thread that is not waiting on the same monitor. I think the main problem is with having 2 locks - deleteLock and controllerLock. We might have to revisit that decision and see if we consolidate on a single lock (controllerLock). Since this is a different bug, can you file it and link it back to this issue? &lt;/p&gt;</comment>
                            <comment id="14161942" author="sriharsha" created="Tue, 7 Oct 2014 14:35:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; Both TopicDeletionManager.resumeTopicDeletionThread() and awaitTopicDeletionNoification uses deleteLock and DeleteTopicThread.doWork() waits on awaitTopicDeletionNotification before it tries to acquire controllerLock.&lt;br/&gt;
so simple fix would be to check if there are any topics in topicsToBeDeleted set and call resumeTopicDeletionThread() from &lt;br/&gt;
start(). &lt;br/&gt;
I agree that it is best to consolidate on a single lock.&lt;/p&gt;</comment>
                            <comment id="14165802" author="junrao" created="Thu, 9 Oct 2014 21:39:15 +0000"  >&lt;p&gt;Committed the original patch in the jira and the patch in kafka-1681 to 0.8.2. Both changes are in trunk too.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12735001">KAFKA-1600</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12730057">KAFKA-1558</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12746415">KAFKA-1681</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12672716" name="KAFKA-1663.patch" size="1558" author="sriharsha" created="Fri, 3 Oct 2014 01:31:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20osv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>nehanarkhede</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>