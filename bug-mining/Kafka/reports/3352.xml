<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4852] ByteBufferSerializer not compatible with offsets</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4852</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Quick intro: A ByteBuffer.rewind() resets the position to zero. What if the ByteBuffer was created with an offset? new ByteBuffer(data, 3, 10)? The ByteBufferSerializer will send from pos=0 and not from pos=3 onwards.&lt;/p&gt;

&lt;p&gt;Solution: No rewind() but flip() for reading a ByteBuffer. That&apos;s what the flip is meant for.&lt;/p&gt;

&lt;p&gt;Story:&lt;/p&gt;

&lt;p&gt;Imagine the incoming data comes from a byte[], e.g. a network stream containing topicname, partition, key, value, ... and you want to create a new ProducerRecord for that. As the constructor of ProducerRecord requires (topic, partition, key, value) you have to copy from above byte[] the key and value. That means there is a memcopy taking place. Since the payload can be potentially large, that introduces a lot of overhead. Twice the memory.&lt;/p&gt;

&lt;p&gt;A nice solution to this problem is to simply wrap the network byte[] into new ByteBuffers:&lt;br/&gt;
ByteBuffer key = ByteBuffer.wrap(data, keystart, keylength);&lt;br/&gt;
ByteBuffer value = ByteBuffer.wrap(data, valuestart, valuelength);&lt;br/&gt;
and then use the ByteBufferSerializer instead of the ByteArraySerializer.&lt;/p&gt;

&lt;p&gt;But that does not work as the ByteBufferSerializer does a rewind(), hence both, key and value, will start at position=0 of the data[].&lt;/p&gt;


&lt;p&gt;public class ByteBufferSerializer implements Serializer&amp;lt;ByteBuffer&amp;gt; {&lt;br/&gt;
    public byte[] serialize(String topic, ByteBuffer data) {&lt;br/&gt;
         data.rewind();&lt;/p&gt;</description>
                <environment>all</environment>
        <key id="13048596">KAFKA-4852</key>
            <summary>ByteBufferSerializer not compatible with offsets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="wdaehn">Werner Daehn</reporter>
                        <labels>
                            <label>needs-kip</label>
                            <label>serializers</label>
                    </labels>
                <created>Mon, 6 Mar 2017 18:27:54 +0000</created>
                <updated>Thu, 9 Jan 2025 21:04:32 +0000</updated>
                                            <version>0.10.1.1</version>
                                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17609089" author="JIRAUSER294710" created="Sun, 25 Sep 2022 07:25:55 +0000"  >&lt;p&gt;Agree! I also found this bug:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testByteBufferSerializer() {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello&quot;&lt;/span&gt;.getBytes(UTF_8);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBuffer buffer = ByteBuffer.allocate(7);
    buffer.put(bytes);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBufferSerializer serializer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteBufferSerializer()) {
        assertArrayEquals(bytes, serializer.serialize(topic, buffer));
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Executing the above test case will throw the following exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
array lengths differ, expected: &amp;lt;5&amp;gt; but was: &amp;lt;7&amp;gt;
Expected :5
Actual &#160; :7
&amp;lt;Click to see difference&amp;gt;org.opentest4j.AssertionFailedError: array lengths differ, expected: &amp;lt;5&amp;gt; but was: &amp;lt;7&amp;gt;
...
&#160; &#160; at org.apache.kafka.common.serialization.SerializationTest.testByteBufferSerializer(SerializationTest.java:397)
...
at java.util.ArrayList.forEach(ArrayList.java:1259)
...
at java.util.ArrayList.forEach(ArrayList.java:1259)
...
at worker.org.gradle.process.internal.worker.GradleWorkerMain.run(GradleWorkerMain.java:69)
&#160; &#160; at worker.org.gradle.process.internal.worker.GradleWorkerMain.main(GradleWorkerMain.java:74)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17609109" author="JIRAUSER294710" created="Sun, 25 Sep 2022 08:28:29 +0000"  >&lt;p&gt;I made a PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/12683&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/12683&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17611345" author="wdaehn" created="Fri, 30 Sep 2022 03:56:55 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17611351" author="JIRAUSER294710" created="Fri, 30 Sep 2022 04:12:48 +0000"  >&lt;p&gt;That&apos;s all right : )&lt;/p&gt;</comment>
                            <comment id="17647824" author="ableegoldman" created="Thu, 15 Dec 2022 02:54:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LSK&quot; class=&quot;user-hover&quot; rel=&quot;LSK&quot;&gt;LSK&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wdaehn&quot; class=&quot;user-hover&quot; rel=&quot;wdaehn&quot;&gt;wdaehn&lt;/a&gt; is there a reason this ticket was not resolved, or was that just an oversight?&lt;/p&gt;

&lt;p&gt;I&apos;m going to close it since the PR seems to have been merged, if there was some newly found issue please reopen this or file a new issue if applicable&lt;/p&gt;</comment>
                            <comment id="17647871" author="wdaehn" created="Thu, 15 Dec 2022 06:22:47 +0000"  >&lt;p&gt;Agree, it is resolved.&lt;/p&gt;</comment>
                            <comment id="17778727" author="mjsax" created="Mon, 23 Oct 2023 16:14:32 +0000"  >&lt;p&gt;As reported on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15602&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15602&lt;/a&gt;, this ticket introduces a couple of breaking changes and bugs.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Semantics changes like this, need to be backed up by a KIP&lt;/li&gt;
	&lt;li&gt;The code does not achieve what it aims to do&lt;/li&gt;
	&lt;li&gt;There is lack of proper unit testing&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Given that such a change requires a KIP and the current code is broken, we propose to revert this change for the time being, and do a proper fix via a KIP. I prepare a PR for this: &lt;a href=&quot;https://github.com/apache/kafka/pull/14617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14617&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;\cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17781139" author="JIRAUSER283568" created="Mon, 30 Oct 2023 22:19:20 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13595888">KAFKA-17825</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3b0br:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>