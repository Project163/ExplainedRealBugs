<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14401] Connector/Tasks reading offsets can get stuck if underneath WorkThread dies</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14401</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When a connector or task tries to read the offsets from the offsets topic, it issues `OffsetStorageImpl#offsets` method. This method gets a Future from the underneath KafkaBackingStore. KafkaBackingStore invokes `KafkaBasedLog#readToEnd` method and passes the Callback. This method essentially adds the Callback to a Queue of callbacks that are being managed.&lt;/p&gt;

&lt;p&gt;Within KafkaBasedLog, there&apos;s a WorkThread which keeps polling over the callback queue and executes them and it does this in an infinite loop. However, there is an enclosing try/catch block around the while loop. If there&apos;s an exception thrown which is not caught by any of the other catch blocks, the control goes to the outermost catch block and the WorkThread is terminated. However, the connectors/tasks are not aware of this and they would keep submitting callbacks to KafkaBasedLog with nobody processing them. This can be seen in the thread dumps as well:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;task-thread-connector-0&quot;&lt;/span&gt; #6334 prio=5 os_prio=0 cpu=19.36ms elapsed=2092.93s tid=0x00007f8d9c037000 nid=0x5d00 waiting on condition &#160;[0x00007f8dc08cd000]
&#160; &#160;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
&#160; &#160; at jdk.internal.misc.Unsafe.park(java.base@11.0.15/Native Method)
&#160; &#160; - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &#160;&amp;lt;0x000000070345c9a8&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)
&#160; &#160; at java.util.concurrent.locks.LockSupport.park(java.base@11.0.15/LockSupport.java:194)
&#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(java.base@11.0.15/AbstractQueuedSynchronizer.java:885)
&#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(java.base@11.0.15/AbstractQueuedSynchronizer.java:1039)
&#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(java.base@11.0.15/AbstractQueuedSynchronizer.java:1345)
&#160; &#160; at java.util.concurrent.CountDownLatch.await(java.base@11.0.15/CountDownLatch.java:232)
&#160; &#160; at org.apache.kafka.connect.util.ConvertingFutureCallback.get(ConvertingFutureCallback.java:98)
&#160; &#160; at org.apache.kafka.connect.storage.OffsetStorageReaderImpl.offsets(OffsetStorageReaderImpl.java:101)
&#160; &#160; at org.apache.kafka.connect.storage.OffsetStorageReaderImpl.offset(OffsetStorageReaderImpl.java:63) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We need a mechanism to fail all such offset read requests. That is because even if we restart the thread, chances are it will still fail with the same error so the offset fetch would be stuck perennially.&lt;/p&gt;

&lt;p&gt;As already explained, this scenario happens mainly when the exception thrown is such that it isn&apos;t caught by any of the catch blocks and the control lands up in the outermost catch block. In my experience, I have seen this situation happening on a few occasions, when the exception thrown is:&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2022-11-20 09:00:59,307] ERROR Unexpected exception in &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[KafkaBasedLog Work &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; - connect-offsets,5,main] (org.apache.kafka.connect.util.KafkaBasedLog:440)org.apache.kafka.connect.errors.ConnectException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; getting end offsets &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; topic &lt;span class=&quot;code-quote&quot;&gt;&apos;connect-offsets&apos;&lt;/span&gt; on brokers at XXX
&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.connect.util.TopicAdmin.endOffsets(TopicAdmin.java:695)&#160;&#160;&#160;&#160;&#160; 
      at org.apache.kafka.connect.util.KafkaBasedLog.readEndOffsets(KafkaBasedLog.java:371)&#160;&#160;&#160;&#160;&#160; 
      at org.apache.kafka.connect.util.KafkaBasedLog.readToLogEnd(KafkaBasedLog.java:332)&#160;&#160;&#160;&#160;&#160; 
      at org.apache.kafka.connect.util.KafkaBasedLog.access$400(KafkaBasedLog.java:75)&#160;&#160;&#160;&#160;&#160; 
      at org.apache.kafka.connect.util.KafkaBasedLog$WorkThread.run(KafkaBasedLog.java:406)
Caused by: java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.SslAuthenticationException: SSL handshake failed
&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.common.internals.KafkaFutureImpl.wrapAndThrow(KafkaFutureImpl.java:45)
&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.common.internals.KafkaFutureImpl.access$000(KafkaFutureImpl.java:32)
&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.common.internals.KafkaFutureImpl$SingleWaiter.await(KafkaFutureImpl.java:89)
&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:260)
&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.connect.util.TopicAdmin.endOffsets(TopicAdmin.java:672)
&#160;&#160;&#160;&#160;&#160; ... 4 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At this point, the WorkThread is dead once the control goes out of the &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/runtime/src/main/java/org/apache/kafka/connect/util/KafkaBasedLog.java#L608-L610&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;catch block&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and we can find the following line `Unexpected exception in` in the logs.&lt;/p&gt;

&lt;p&gt;Another example could be when the worker is already OOM and in such cases as well the work thread would die. This is not a good example because once the worker is OOM, we can&apos;t make any progress anyways but adding this example for brevity&apos;s sake.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13503677">KAFKA-14401</key>
            <summary>Connector/Tasks reading offsets can get stuck if underneath WorkThread dies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sagarrao">Sagar Rao</assignee>
                                    <reporter username="sagarrao">Sagar Rao</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Nov 2022 17:04:36 +0000</created>
                <updated>Thu, 2 Jan 2025 03:37:41 +0000</updated>
                            <resolved>Tue, 16 Jul 2024 00:56:04 +0000</resolved>
                                                    <fixVersion>3.9.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17691649" author="cmukka20" created="Tue, 21 Feb 2023 14:51:02 +0000"  >&lt;p&gt;Thanks for filing this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sagarrao&quot; class=&quot;user-hover&quot; rel=&quot;sagarrao&quot;&gt;sagarrao&lt;/a&gt;! I can take this up.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ccbs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>