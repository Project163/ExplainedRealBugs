<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12870] RecordAccumulator stuck in a flushing state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12870</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;After a Kafka Stream with exactly once enabled has performed its first commit, the RecordAccumulator within the stream&apos;s internal producer gets stuck in a state where all subsequent ProducerBatches that get allocated are immediately flushed instead of being held in memory until they expire, regardless of the stream&apos;s linger or batch size config.&lt;/p&gt;

&lt;p&gt;This is reproduced in the example code found at &lt;a href=&quot;https://github.com/niclaslockner/kafka-12870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/niclaslockner/kafka-12870&lt;/a&gt;&#160;which can be run with ./gradlew run --args=&amp;lt;bootstrap servers&amp;gt;&lt;/p&gt;

&lt;p&gt;The example has a producer that sends 1 record/sec to one topic, and a Kafka stream with EOS enabled that forwards the records from that topic to another topic with the configuration linger = 5 sec, commit interval = 10 sec.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The expected behavior when running the example is that the stream&apos;s ProducerBatches will expire (or get flushed because of the commit) every 5th second, and that the stream&apos;s producer will send a&#160;ProduceRequest every 5th second with an expired ProducerBatch that contains 5 records.&lt;/p&gt;

&lt;p&gt;The actual behavior is that the ProducerBatch is made immediately available for the Sender, and the Sender sends one&#160;ProduceRequest for each record.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The example code contains a copy of the RecordAccumulator class (copied from kafka-clients 2.8.0) with some additional logging added to&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;RecordAccumulator#ready(Cluster, long)&lt;/li&gt;
	&lt;li&gt;RecordAccumulator#beginFlush()&lt;/li&gt;
	&lt;li&gt;RecordAccumulator#awaitFlushCompletion()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These log entries show (see the attached RecordsAccumulator.log)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;that the batches are considered sendable because a flush is in progress&lt;/li&gt;
	&lt;li&gt;that Sender.maybeSendAndPollTransactionalRequest() calls RecordAccumulator&apos;s beginFlush() without also calling&#160;awaitFlushCompletion(), and that this makes&#160;RecordAccumulator&apos;s&#160;flushesInProgress jump between 1-2 instead of the expected 0-1.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This issue is not reproducible in version 2.3.1 or 2.4.1.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13381410">KAFKA-12870</key>
            <summary>RecordAccumulator stuck in a flushing state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="niclaslockner">Niclas Lockner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Jun 2021 09:17:44 +0000</created>
                <updated>Fri, 18 Jun 2021 23:03:42 +0000</updated>
                            <resolved>Fri, 18 Jun 2021 22:56:09 +0000</resolved>
                                    <version>2.5.1</version>
                    <version>2.6.2</version>
                    <version>2.7.1</version>
                    <version>2.8.0</version>
                                    <fixVersion>2.8.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>producer </component>
                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17359447" author="mjsax" created="Tue, 8 Jun 2021 16:26:59 +0000"  >&lt;p&gt;Could this be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10888&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-10888&lt;/a&gt;&#160;?&lt;/p&gt;</comment>
                            <comment id="17360937" author="ijuma" created="Thu, 10 Jun 2021 14:10:26 +0000"  >&lt;p&gt;I think the claim is that there&apos;s a bug in the `Sender` when exactly-once is used.&lt;/p&gt;</comment>
                            <comment id="17365660" author="guozhang" created="Fri, 18 Jun 2021 18:36:56 +0000"  >&lt;p&gt;This is a great find. Though it might not related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10888&quot; title=&quot; Sticky partition leads to uneven product msg, resulting in abnormal delays in some partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-10888&quot;&gt;&lt;del&gt;KAFKA-10888&lt;/del&gt;&lt;/a&gt;, I think it could help resolving the perf degradation with EOS (since the bug effectively disables any batching).&lt;/p&gt;</comment>
                            <comment id="17365810" author="hachikuji" created="Fri, 18 Jun 2021 23:03:42 +0000"  >&lt;p&gt;I agree this was a great find. Thanks also for the detailed investigation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=niclaslockner&quot; class=&quot;user-hover&quot; rel=&quot;niclaslockner&quot;&gt;niclaslockner&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13026233" name="RecordAccumulator.log" size="38056" author="niclaslockner" created="Tue, 1 Jun 2021 09:30:27 +0000"/>
                            <attachment id="13026232" name="full.log" size="262271" author="niclaslockner" created="Tue, 1 Jun 2021 09:30:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rjeg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>