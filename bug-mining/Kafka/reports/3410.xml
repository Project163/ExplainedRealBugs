<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:32:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12558] MM2 may not sync partition offsets correctly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12558</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;There is a race condition in &lt;tt&gt;MirrorSourceTask&lt;/tt&gt; where certain partition offsets may never be sent. The bug occurs when the &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorSourceTask.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;outstandingOffsetSync semaphore is full&lt;/a&gt;. In this case, the sendOffsetSync &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorSourceTask.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;will silently fail&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This failure is normally acceptable since offset sync will retry frequently. However, &lt;tt&gt;maybeSyncOffsets&lt;/tt&gt; has a bug where it will &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorSourceTask.java#L199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;mutate the partition state&lt;/a&gt; prior to confirming the result of&#160;&lt;tt&gt;sendOffsetSync&lt;/tt&gt;. The end result is that the partition state is mutated prematurely, and prevent future offset syncs to recover.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;MAX_OUTSTANDING_OFFSET_SYNCS&lt;/tt&gt; is 10, this bug happens when you assign more than 10 partitions to each task.&lt;/p&gt;

&lt;p&gt;In my test cases where I had over 100 partitions per task, the majority of the offsets were wrong. Here&apos;s an example of such a failure. &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12468?focusedCommentId=17308308&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17308308&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-12468?focusedCommentId=17308308&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17308308&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;During my troubleshooting, I customized the &lt;tt&gt;MirrorSourceTask&lt;/tt&gt; to confirm that all partitions that have the wrong offset were failing to acquire the initial semaphore. The condition &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorSourceTask.java#L208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;can be trapped here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Possible Fix:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;A possible fix is to create a &lt;tt&gt;shouldUpdate&lt;/tt&gt; method in &lt;tt&gt;PartitionState&lt;/tt&gt;. This method should be read-only and return true if &lt;tt&gt;sendOffsetSync&lt;/tt&gt; is needed. Once &lt;tt&gt;sendOffsetSync&lt;/tt&gt; is successful, only then &lt;tt&gt;update&lt;/tt&gt; should be called.&lt;/p&gt;

&lt;p&gt;Here&apos;s some pseudocode&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void maybeSyncOffsets(TopicPartition topicPartition, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; upstreamOffset,
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; downstreamOffset) {
    PartitionState partitionState =
        partitionStates.computeIfAbsent(topicPartition, x -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PartitionState(maxOffsetLag));
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partitionState.shouldUpdate(upstreamOffset, downstreamOffset)) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(sendOffsetSync(topicPartition, upstreamOffset, downstreamOffset)) {
            partitionState.update(upstreamOffset, downstreamOffset)
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Workaround:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;For those who are experiencing this issue, the workaround is to make sure you have less than or equal to 10 partitions per task. Set your `tasks.max` value accordingly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13367702">KAFKA-12558</key>
            <summary>MM2 may not sync partition offsets correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="askldjd">Alan Ning</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Mar 2021 20:23:17 +0000</created>
                <updated>Thu, 23 Feb 2023 14:26:28 +0000</updated>
                            <resolved>Tue, 10 Jan 2023 14:53:38 +0000</resolved>
                                    <version>2.6.1</version>
                    <version>2.7.0</version>
                                    <fixVersion>3.3.3</fixVersion>
                    <fixVersion>3.4.1</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>mirrormaker</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="17308968" author="ryannedolan" created="Thu, 25 Mar 2021 20:56:59 +0000"  >&lt;p&gt;This sounds right. Updating the partition store without sending an offset sync means additional offset syncs are unlikely to arrive for a long time, if ever.&lt;/p&gt;

&lt;p&gt;I&apos;m happy to fix but will leave this unassigned for a bit in case someone else wants to take this on.&lt;/p&gt;</comment>
                            <comment id="17321110" author="akaltsikis" created="Wed, 14 Apr 2021 15:57:26 +0000"  >&lt;p&gt;Just one clarification:&lt;br/&gt;
 The number of &lt;b&gt;LEADER&lt;/b&gt; partitions / The number of tasks &amp;lt;= 10&lt;br/&gt;
Correct?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=askldjd&quot; class=&quot;user-hover&quot; rel=&quot;askldjd&quot;&gt;askldjd&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0p7nk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>