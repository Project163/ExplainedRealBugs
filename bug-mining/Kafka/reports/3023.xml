<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:28:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12926] ConsumerGroupCommand&apos;s java.lang.NullPointerException at negative offsets while running kafka-consumer-groups.sh</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12926</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hi everybody, hope everyone is doing great.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;i) Introduction:&lt;/b&gt;&lt;br/&gt;
I noticed the following exception (on a cluster with brokers running 2.3.1) when trying to describe a consumer group (using the Kafka 2.7.1):&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./kafka-consumer-groups.sh --describe --group order-validations&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error: Executing consumer group command failed due to &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
java.lang.NullPointerException
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.$anonfun$collectGroupsOffsets$6(ConsumerGroupCommand.scala:579)
 at scala.collection.StrictOptimizedIterableOps.map(StrictOptimizedIterableOps.scala:99)
 at scala.collection.StrictOptimizedIterableOps.map$(StrictOptimizedIterableOps.scala:86)
 at scala.collection.convert.JavaCollectionWrappers$JSetWrapper.map(JavaCollectionWrappers.scala:180)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.$anonfun$collectGroupsOffsets$5(ConsumerGroupCommand.scala:578)
 at scala.collection.immutable.List.flatMap(List.scala:293)
 at scala.collection.immutable.List.flatMap(List.scala:79)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.$anonfun$collectGroupsOffsets$2(ConsumerGroupCommand.scala:574)
 at scala.collection.Iterator$$anon$9.next(Iterator.scala:575)
 at scala.collection.mutable.Growable.addAll(Growable.scala:62)
 at scala.collection.mutable.Growable.addAll$(Growable.scala:59)
 at scala.collection.mutable.HashMap.addAll(HashMap.scala:117)
 at scala.collection.mutable.HashMap$.from(HashMap.scala:570)
 at scala.collection.mutable.HashMap$.from(HashMap.scala:563)
 at scala.collection.MapOps$WithFilter.map(Map.scala:358)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.collectGroupsOffsets(ConsumerGroupCommand.scala:569)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.describeGroups(ConsumerGroupCommand.scala:369)
 at kafka.admin.ConsumerGroupCommand$.run(ConsumerGroupCommand.scala:76)
 at kafka.admin.ConsumerGroupCommand$.main(ConsumerGroupCommand.scala:63)
 at kafka.admin.ConsumerGroupCommand.main(ConsumerGroupCommand.scala)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When trying on and older version of AdminClient (2.3.1):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error: Executing consumer group command failed due to java.lang.IllegalArgumentException: Invalid negative offset
java.util.concurrent.ExecutionException: java.lang.IllegalArgumentException: Invalid negative offset
 at org.apache.kafka.common.internals.KafkaFutureImpl.wrapAndThrow(KafkaFutureImpl.java:45)
 at org.apache.kafka.common.internals.KafkaFutureImpl.access$000(KafkaFutureImpl.java:32)
 at org.apache.kafka.common.internals.KafkaFutureImpl$SingleWaiter.await(KafkaFutureImpl.java:89)
 at org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:260)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.getCommittedOffsets(ConsumerGroupCommand.scala:595)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.$anonfun$collectGroupsOffsets$2(ConsumerGroupCommand.scala:421)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService$$Lambda$131/000000004CB1EFD0.apply(Unknown Source)
 at scala.collection.TraversableLike$WithFilter.$anonfun$map$2(TraversableLike.scala:827)
 at scala.collection.TraversableLike$WithFilter$$Lambda$132/000000004CD49E20.apply(Unknown Source)
 at scala.collection.mutable.HashMap.$anonfun$foreach$1(HashMap.scala:149)
 at scala.collection.mutable.HashMap$$Lambda$133/000000004CD4A4F0.apply(Unknown Source)
 at scala.collection.mutable.HashTable.foreachEntry(HashTable.scala:237)
 at scala.collection.mutable.HashTable.foreachEntry$(HashTable.scala:230)
 at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:44)
 at scala.collection.mutable.HashMap.foreach(HashMap.scala:149)
 at scala.collection.TraversableLike$WithFilter.map(TraversableLike.scala:826)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.collectGroupsOffsets(ConsumerGroupCommand.scala:419)
 at kafka.admin.ConsumerGroupCommand$ConsumerGroupService.describeGroups(ConsumerGroupCommand.scala:312)
 at kafka.admin.ConsumerGroupCommand$.main(ConsumerGroupCommand.scala:63)
 at kafka.admin.ConsumerGroupCommand.main(ConsumerGroupCommand.scala)
Caused by: java.lang.IllegalArgumentException: Invalid negative offset
 at org.apache.kafka.clients.consumer.OffsetAndMetadata.&amp;lt;init&amp;gt;(OffsetAndMetadata.java:50)
 at org.apache.kafka.clients.admin.KafkaAdminClient$24$1.handleResponse(KafkaAdminClient.java:2832)
 at org.apache.kafka.clients.admin.KafkaAdminClient$AdminClientRunnable.handleResponses(KafkaAdminClient.java:1032)
 at org.apache.kafka.clients.admin.KafkaAdminClient$AdminClientRunnable.run(KafkaAdminClient.java:1160)
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:820)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The main difference between those outputs is what had been done in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9507&quot; title=&quot;AdminClient should check for missing committed offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9507&quot;&gt;&lt;del&gt;KAFKA-9507&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;ii) Problem:&lt;/b&gt; &lt;br/&gt;
commitedOffsets for some partitions are arriving as null to &lt;em&gt;ConsumerGroupCommand&lt;/em&gt;. Then (for the assigned consumers to those such null OffsetAndMetadata&apos;s partitions) getting the offset&apos;s value throws an java.lang.NullPointerException, because the ConsumerGroupCommand tries to map over a null value.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;iii) Example&lt;/b&gt;:&lt;br/&gt;
a) &lt;ins&gt;GroupID information (from describeConsumerGroups() method):&lt;/ins&gt;&lt;br/&gt;
(groupId=order-validations, isSimpleConsumerGroup=false, members=(memberId=order-validations-d5fbca62-ab2b-48d7-96ba-0ae72dff72a6, groupInstanceId=null, clientId=order-validations, host=/127.0.0.1, assignment=(topicPartitions=rtl_orderReceive-0,rtl_orderReceive-1,rtl_orderReceive-2,rtl_orderReceive-3,rtl_orderReceive-4,rtl_orderReceive-5,rtl_orderReceive-6,rtl_orderReceive-7,rtl_orderReceive-8,rtl_orderReceive-9)), partitionAssignor=RoundRobinAssigner, state=Stable, coordinator=f0527.cluster.cl:31047 (id: 1 rack: null), authorizedOperations=[])&lt;/p&gt;

&lt;p&gt;b) &lt;ins&gt;Commited Offsets information (from getCommittedOffsets() method):&lt;/ins&gt;&lt;br/&gt;
Map(rtl_orderReceive-0 -&amp;gt; null, rtl_orderReceive-1 -&amp;gt; OffsetAndMetadata{offset=39, leaderEpoch=null, metadata=&apos;&apos;}, rtl_orderReceive-2 -&amp;gt; null, rtl_orderReceive-3 -&amp;gt; OffsetAndMetadata{offset=33, leaderEpoch=null, metadata=&apos;&apos;}, rtl_orderReceive-4 -&amp;gt; null, rtl_orderReceive-5 -&amp;gt; null, rtl_orderReceive-7 -&amp;gt; null, rtl_orderReceive-8 -&amp;gt; null)&lt;/p&gt;

&lt;p&gt;As seen, member order-validations-d5fbca62-ab2b-48d7-96ba-0ae72dff72a6 is assigned to all partitions, but the commited offsets reported for the the partition 0,2,4,5,7,8 are null.&lt;br/&gt;
Then getting commited offsets for rtl_orderReceive-0 throws an error at .map(&lt;em&gt;.offset), because it translates to null.map(&lt;/em&gt;.offset). This is happening because the offset of that partions is -1 and that gets map to null (as defined on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9507&quot; title=&quot;AdminClient should check for missing committed offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9507&quot;&gt;&lt;del&gt;KAFKA-9507&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;iv) Proposals:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;a) &lt;ins&gt;Fix locally on the ConsumerGroupCommand:&lt;/ins&gt;&lt;br/&gt;
Add a filter to the Commited Offsets arriving from upstreams to catch border cases. In that way, even if upstreams cames with null values instead of a OffsetAndMetadata, the describeGroups would work and get the consumer group description.&lt;/p&gt;

&lt;p&gt;From&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val committedOffsets = getCommittedOffsets(groupId)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val committedOffsets = getCommittedOffsets(groupId).filter(_._2.isInstanceOf[OffsetAndMetadata])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;


&lt;p&gt;b) &lt;ins&gt;Fix upstreams on KafkaAdmin&apos;s listConsumerGroupOffsets method:&lt;/ins&gt;&lt;br/&gt;
Related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9507&quot; title=&quot;AdminClient should check for missing committed offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9507&quot;&gt;&lt;del&gt;KAFKA-9507&lt;/del&gt;&lt;/a&gt;. In that issue, the solution to handle negative offsets was to explicitly set null to the topicPartition:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offset &amp;lt; 0) {
 groupOffsetsListing.put(topicPartition, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
 } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
 groupOffsetsListing.put(topicPartition, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OffsetAndMetadata(offset, leaderEpoch, metadata));
 }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That approach solves org.apache.kafka.clients.consumer.OffsetAndMetadata for throwing an &lt;em&gt;&apos;Invalid negative offset&apos;&lt;/em&gt; error, but affects downstreams methods that use KafkaAdminClient&apos;s listConsumerGroupOffsets method (as the one at kafka-consumer-groups.sh).&lt;/p&gt;

&lt;p&gt;The proposal is to skip&#160;returning offset&#160;for topic partitions where offsets are negative:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offset &amp;gt;= 0) {
 groupOffsetsListing.put(topicPartition, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OffsetAndMetadata(offset, leaderEpoch, metadata));
 }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This would remove the negative offsets from the the listConsumerGroupOffsets and guarantee that the results are valids OffsetAndMetadata (not only handling negative offsets as &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9507&quot; title=&quot;AdminClient should check for missing committed offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9507&quot;&gt;&lt;del&gt;KAFKA-9507&lt;/del&gt;&lt;/a&gt;, but not impacting other downstreams methods which expects an OffsetAndMetadata instead of a null value).&lt;/p&gt;

&lt;p&gt;I think the second approach is cleaner because let the downstreams methods without having to handle the null&apos;s border case, which may lead to expecions (as seen).&lt;/p&gt;

&lt;p&gt;I had been working on the both approaches, and I ready to prepare a PR. What do you think?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13383062">KAFKA-12926</key>
            <summary>ConsumerGroupCommand&apos;s java.lang.NullPointerException at negative offsets while running kafka-consumer-groups.sh</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="IgnacioAcunaFri">Ignacio Acuna</assignee>
                                    <reporter username="IgnacioAcunaFri">Ignacio Acuna</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Jun 2021 00:15:09 +0000</created>
                <updated>Tue, 29 Jun 2021 14:07:13 +0000</updated>
                            <resolved>Tue, 29 Jun 2021 07:01:14 +0000</resolved>
                                                    <fixVersion>3.0.0</fixVersion>
                                    <component>admin</component>
                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rtko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>dajac</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>