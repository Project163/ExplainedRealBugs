<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:32:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14172] bug: State stores lose state when tasks are reassigned under EOS wit&#8230;</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14172</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;StatestoreslosestatewhentasksarereassignedunderEOSwithstandbyreplicasanddefaultacceptablelag.&quot;&gt;&lt;/a&gt;State stores lose state when tasks are reassigned under EOS with standby replicas and default acceptable lag.&lt;/h1&gt;

&lt;p&gt;I have observed that state stores used in a transform step under a Exactly Once semantics ends up losing state after a rebalancing event that includes reassignment of tasks to previous standby task within the acceptable standby lag.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is reproduceable and an integration test have been created to showcase the &lt;a href=&quot;https://github.com/apache/kafka/pull/12540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;issue&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;A detailed description of the observed issue is provided &lt;a href=&quot;https://github.com/apache/kafka/pull/12540/files?short_path=3ca480e#diff-3ca480ef093a1faa18912e1ebc679be492b341147b96d7a85bda59911228ef45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Similar issues have been observed and reported to StackOverflow for example &lt;a href=&quot;https://stackoverflow.com/questions/69038181/kafka-streams-aggregation-data-loss-between-instance-restarts-and-rebalances&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13477561">KAFKA-14172</key>
            <summary>bug: State stores lose state when tasks are reassigned under EOS wit&#8230;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="Horslev">Martin H&#248;rslev</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Aug 2022 09:01:08 +0000</created>
                <updated>Thu, 22 Jun 2023 13:02:55 +0000</updated>
                            <resolved>Tue, 25 Apr 2023 13:03:17 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.4.1</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17598956" author="gray.john" created="Thu, 1 Sep 2022 13:11:29 +0000"  >&lt;p&gt;My stateful/EOS Kafka apps also seem to be struggling on 3.1.0+, with a similar theme: it appears the restore consumers are not consuming all of their messages for a full restore before processing begins. This sad situation seems to happen consistently after Strimzi rolls out an upgrade to our cluster. Once the brokers are all rolled, it seems to trigger a rebalance in our stateful apps, and then we lose data. We do not have the extra disk space for standby replicas, so the acceptable.recovery.lag and related bits to the standby replicas are not at play for us. But the restore consumers fumbling data w/ EOS seems to be a big problem for us as well. &lt;/p&gt;</comment>
                            <comment id="17599002" author="gray.john" created="Thu, 1 Sep 2022 14:39:54 +0000"  >&lt;p&gt;I know next to nothing about the internal workings of Kafka, sadly, but I am noticing that &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12486&quot; title=&quot;Utilize HighAvailabilityTaskAssignor to avoid downtime on corrupted task&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12486&quot;&gt;&lt;del&gt;KAFKA-12486&lt;/del&gt;&lt;/a&gt; was introduced in 3.1.0, which is the version I started noticing problems. I see you helped out with that Jira, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt; , is there any possible way in your mind that it might cause weirdness with state restoration? &lt;/p&gt;</comment>
                            <comment id="17599294" author="JIRAUSER294597" created="Fri, 2 Sep 2022 07:32:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gray.john&quot; class=&quot;user-hover&quot; rel=&quot;gray.john&quot;&gt;gray.john&lt;/a&gt; thanks for adding your experience. I agree the scenarios seems similar although the setup you describe seems different.&#160;&lt;br/&gt;
If I understand your issue correctly then it seems related to rolling upgrades of your Kafka cluster ? &lt;br/&gt;
This issue is triggered solely by adding new stream applications.&#160;&lt;/p&gt;</comment>
                            <comment id="17599478" author="gray.john" created="Fri, 2 Sep 2022 12:48:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Horslev&quot; class=&quot;user-hover&quot; rel=&quot;Horslev&quot;&gt;Horslev&lt;/a&gt; we utilize static membership for our stateful apps, so for us the cluster upgrades seem to be about the only time they really rebalance. So I do think we lose data because of the rebalancing EOS consumers. The biggest difference I think is that we don&apos;t use standby replicas, yet still are getting data loss during restores. I think having a standby replica with 0 max.recovery.lag would be the only solution to getting around this bug since I believe it is the restore consumers dropping the ball here, but, alas, we don&apos;t have the extra disk space for standby replicas.&lt;/p&gt;</comment>
                            <comment id="17645330" author="gray.john" created="Fri, 9 Dec 2022 14:50:58 +0000"  >&lt;p&gt;I do hope this bug gets some eyes eventually, it has been pretty devastating for us. Is still a problem even on Streams 3.3.1 w/ broker 3.1.0. I amend my previous statement that this is related to our brokers rolling, it actually seems it can happen any time our restore consumers in EOS apps w/ big state try to restore said big state. Sadly, setting the acceptable.lag config does not help us because we do not have the extra space to run standby threads/replicas. &lt;/p&gt;

&lt;p&gt;We actually had to resort to dumping our keys to a sqlserver and then querying for &quot;should this key exist?&quot; when we are pulling keys from our state store. If the state store returns nothing and sqlserver says it has seen that key before, we kill the app, which then causes us to pull the state again, which then fixes the issue. Something is &lt;em&gt;very&lt;/em&gt; wrong with these restore consumers (or I am doing something horribly wrong in this app, although we never had this problem before Kafka 3.0.0 or 3.1.0).&lt;/p&gt;</comment>
                            <comment id="17698180" author="guozhang" created="Thu, 9 Mar 2023 05:17:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gray.john&quot; class=&quot;user-hover&quot; rel=&quot;gray.john&quot;&gt;gray.john&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Horslev&quot; class=&quot;user-hover&quot; rel=&quot;Horslev&quot;&gt;Horslev&lt;/a&gt; I took a deep look into this issue and I think I found the culprit. Here&apos;s a short summary:&lt;/p&gt;

&lt;p&gt;1. When standbys are enabled, Kafka Streams could recycle a standby task (and its state stores) into an active, and vice versa.&lt;br/&gt;
2. When caching is enabled, we would bypass the caching layer when updating a standby task (i.e. via putInternal).&lt;/p&gt;

&lt;p&gt;And these two together combined would cause an issue. Take a concrete example following &lt;a href=&quot;https://github.com/apache/kafka/pull/12540&amp;#39;s&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/12540&apos;s&lt;/a&gt; demo: let&apos;s say we have a task A with a cached state store S. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;For a given host, originally the task was hosted as an active.&lt;/li&gt;
	&lt;li&gt;A rebalance happens, and that task was recycled into a standby. At that time the cache is flushed, so that the underlying store and the cache layer are consistent, let&apos;s assume they are S1 (version 1).&lt;/li&gt;
	&lt;li&gt;The standby task was updated for a period of time, where updates are directly written into the underlying store. Now the underlying store is S2 while the caching layer is still S1.&lt;/li&gt;
	&lt;li&gt;A second rebalance happens, and that task was recycled again into an active. Then when that task is normally processing, a read into the store would hit the cache layer first, and very likely read out an older versioned S1 instead of S2. As a result, we have a duplicate: more specifically in the above PR&apos;s example, the &lt;tt&gt;count&lt;/tt&gt; store would return an old counter and hence cause the resulted ID inferred from counter being used twice.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That also explains why the test would not fail if caching is disabled, or standby replicas are disabled (tested locally); I think this test could still fail even when acceptable lag is set to 0, but it is less likely to have a standby -&amp;gt; active and then -&amp;gt; standby again so maybe people may not easily observe it.&lt;/p&gt;

&lt;p&gt;I have a hack fix (note, this is not for merging as it is just a hack) that is inherited from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Horslev&quot; class=&quot;user-hover&quot; rel=&quot;Horslev&quot;&gt;Horslev&lt;/a&gt;&apos;s integration test, which would clear the cache upon flushing it (which is called when the task manager is flushed). With this fix the test no longer fails.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 35 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17vug:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>