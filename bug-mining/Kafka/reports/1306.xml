<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:58:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4485] Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4485</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;As of current implementation, we will exclude follower from ISR if the begin offset of FetchRequest from this follower is smaller than logEndOffset of leader for more than replicaLagTimeMaxMs. Also, we will add a follower to ISR if the beginOffset of FetchRequest from this follower is equal or larger than high watermark of this partition.&lt;/p&gt;

&lt;p&gt;This is problematic for the following reasons:&lt;/p&gt;

&lt;p&gt;1) The criteria for ISR is inconsistent between maybeExpandIsr() and maybeShrinkIsr(). Therefore a follower may be repeatedly remove and added to the ISR (e.g. in the scenario described below).&lt;/p&gt;

&lt;p&gt;2) A follower may be removed from the ISR even if its fetch rate can keep up with produce rate. Suppose a produce keeps producing a lot of small requests at high request rate but low byte rate (e.g. many mirror makers), and the follower is always able to read all the available data at the time leader receives it. However, the begin offset of fetch request will always be smaller than logEndOffset of leader. Thus the follower will be removed from ISR after replicaLagTimeMaxMs.&lt;/p&gt;

&lt;p&gt;In the following we describe the solution to this problem.&lt;/p&gt;

&lt;p&gt;Terminology:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Definition of replica lag: we say a replica lags behind leader by X ms if its current log end offset if equivalent to the log end offset of leader X ms ago.&lt;/li&gt;
	&lt;li&gt;Definition of pseudo-ISR set: pseudo-ISR set of a partition = 
{ replica | replica belongs to the given partition AND replica&apos;s lag &amp;lt;= replicaLagTimeMaxMs}&lt;/li&gt;
	&lt;li&gt;Definition of high-watermark of a partition: high-watermark of a partition is the max(current high-watermark of the partition, min(offset of replicas in the pseudo-ISR set of this partition))&lt;/li&gt;
	&lt;li&gt;Definition of ISR set: ISR set of a partition = 
{replica | replica is in pseudo-ISR set of the given partition AND log end offset of replica &amp;gt;= high-watermark of the given partition}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Guarantee:&lt;br/&gt;
1) If a follower is close enough to the replica in the sense that its replica lag &amp;lt;= replicaLagTimeMaxMs, then this follower will be in the pseudo-ISR set. Thus the high-watermark will stop to increase until this follower&apos;s log end offset &amp;gt;= high-watermark, at which moment this follower will be added to the ISR set. This allows us the solve the 2nd problem described above.&lt;br/&gt;
2) If a follower lags behind leader for more than X ms, it will be removed out of ISR set.&lt;br/&gt;
3) High watermark of a partition will never decrease.&lt;br/&gt;
4) For any replica in ISR set, its log end offset &amp;gt;= high-watermark. &lt;/p&gt;

&lt;p&gt;Implementation:&lt;br/&gt;
1) For each follower, the leader keeps track of the time of the last fetch request from this follower. Let&apos;s call it lastFetchTime. In addition, the leader also maintains the log end offset of the leader at the lastFetchTime for each follower. Let&apos;s call it lastFetchLeaderLEO. Both variables will be updated after leader has processed a FetchRequest from a follower.&lt;br/&gt;
2) When leader receives FetchRequest from a follower, if begin offset of the FetchRequest &amp;gt;= current leader&apos;s LEO, follower&apos;s lastCatchUpTimeMs will be set to current system time. Otherwise, if begin offset of the FetchRequest &amp;gt;= lastFetchLeaderLEO, follower&apos;s lastCatchUpTimeMs will be set to lastFetchTime. Replica&apos;s lag = current system time - lastCatchUpTimeMs.&lt;br/&gt;
3) The leader can update pseudo-ISR set, high-watermark and ISR set of the partition based on the lag of replicas of this partition, according to the definition described above.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="13025264">KAFKA-4485</key>
            <summary>Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lindong">Dong Lin</assignee>
                                    <reporter username="lindong">Dong Lin</reporter>
                        <labels>
                    </labels>
                <created>Sat, 3 Dec 2016 00:25:32 +0000</created>
                <updated>Fri, 24 Sep 2021 06:21:14 +0000</updated>
                            <resolved>Wed, 21 Dec 2016 05:32:09 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15717277" author="githubbot" created="Sat, 3 Dec 2016 03:34:27 +0000"  >&lt;p&gt;GitHub user lindong28 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2208&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4485&quot; title=&quot;Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4485&quot;&gt;&lt;del&gt;KAFKA-4485&lt;/del&gt;&lt;/a&gt;; Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/lindong28/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lindong28/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4485&quot; title=&quot;Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4485&quot;&gt;&lt;del&gt;KAFKA-4485&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2208.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2208.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2208&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c2c24839708ac0e60214f69606813d7aeff6ed21&lt;br/&gt;
Author: Dong Lin &amp;lt;lindong28@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-03T03:32:59Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4485&quot; title=&quot;Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4485&quot;&gt;&lt;del&gt;KAFKA-4485&lt;/del&gt;&lt;/a&gt;; Follower should be in the isr if its FetchRequest has fetched up to the logEndOffset of leader&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15766181" author="junrao" created="Wed, 21 Dec 2016 05:32:09 +0000"  >&lt;p&gt;Issue resolved by pull request 2208&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2208&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15766182" author="githubbot" created="Wed, 21 Dec 2016 05:32:38 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2208&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17419590" author="iamgd67" created="Fri, 24 Sep 2021 06:21:14 +0000"  >&lt;p&gt;affect versions should be &lt;span class=&quot;error&quot;&gt;&amp;#91;0.9.0.0, 0.10.1.0&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1546&quot; title=&quot;Automate replica lag tuning&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1546&quot;&gt;&lt;del&gt;KAFKA-1546&lt;/del&gt;&lt;/a&gt; introduced a&#160;time-based ISR check which was released with version 0.9.0.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i373un:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>becket_qin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>