<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:25:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8362] LogCleaner gets stuck after partition move between log directories</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8362</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When a partition is moved from one directory to another, their checkpoint entry in&#160;cleaner-offset-checkpoint file is not removed from the source directory.&lt;/p&gt;

&lt;p&gt;As a consequence when we read the last&#160;firstDirtyOffset, we might get a stale value from the old checkpoint file.&lt;/p&gt;

&lt;p&gt;Basically, we need clean up the entry from the check point file in the source directory when the move is completed&lt;/p&gt;

&lt;p&gt;The current issue is that the code in LogCleanerManager:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/**
 * @return the position processed for all logs.
 */
def allCleanerCheckpoints: Map[TopicPartition, Long] = {
  inLock(lock) {
    checkpoints.values.flatMap(checkpoint =&amp;gt; {
      try {
        checkpoint.read()
      } catch {
        case e: KafkaStorageException =&amp;gt;
          error(s&quot;Failed to access checkpoint file ${checkpoint.file.getName} in dir ${checkpoint.file.getParentFile.getAbsolutePath}&quot;, e)
          Map.empty[TopicPartition, Long]
      }
    }).toMap
  }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;collapses the offsets when multiple entries exist for the topicPartition&lt;/p&gt;</description>
                <environment></environment>
        <key id="13233101">KAFKA-8362</key>
            <summary>LogCleaner gets stuck after partition move between log directories</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="showuon">Luke Chen</assignee>
                                    <reporter username="julion">Julio Ng</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 May 2019 00:20:15 +0000</created>
                <updated>Mon, 14 Sep 2020 15:51:42 +0000</updated>
                            <resolved>Mon, 14 Sep 2020 15:51:42 +0000</resolved>
                                                    <fixVersion>2.7.0</fixVersion>
                                    <component>jbod</component>
                    <component>log cleaner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17135400" author="mingaliu" created="Mon, 15 Jun 2020 04:26:30 +0000"  >&lt;p&gt;&#160;In 2.5 Kafka, this still easily repro for me.&lt;/p&gt;

&lt;p&gt;With compacted topic, let&apos;s say topic Test1 partition 100 is disk 1, in &quot;cleaner-offset-checkpoint&quot;, you can see&lt;/p&gt;

&lt;p&gt;Test1 100 2344432&lt;/p&gt;

&lt;p&gt;Then if you move that partition to disk 2, you will see the same thing in&#160;&quot;cleaner-offset-checkpoint&quot;, but the disk 1&#160;&quot;cleaner-offset-checkpoint&quot; still contains that partition.&lt;/p&gt;

&lt;p&gt;Test1 100 2344543&#160;&lt;/p&gt;

&lt;p&gt;This actually caused the problem during logclean due to how&#160;allCleanerCheckpoints is implemented.&lt;/p&gt;</comment>
                            <comment id="17176257" author="showuon" created="Wed, 12 Aug 2020 10:57:21 +0000"  >&lt;p&gt;Currently, we&apos;ll append a tombstone record into the source(old) diretory when moved, which is expected. I think we can add a collection to keep the source(old) directories, and filter out these records in &lt;b&gt;allCleanerCheckpoints&lt;/b&gt; method.&lt;/p&gt;</comment>
                            <comment id="17176476" author="mingaliu" created="Wed, 12 Aug 2020 16:51:36 +0000"  >&lt;p&gt;In that case, we need to modify&#160;&lt;b&gt;allCleanerCheckpoints&lt;/b&gt;&#160;implementation. Otherwise, the logcleanner is completely broken.&#160;&lt;/p&gt;</comment>
                            <comment id="17176934" author="showuon" created="Thu, 13 Aug 2020 11:21:43 +0000"  >&lt;p&gt;OK, after further investigation today, I found I was wrong. The root cause is the &lt;b&gt;alterCheckpointDir&lt;/b&gt; method doesn&apos;t remove the source dir data. It called &lt;b&gt;updateCheckpoints&lt;/b&gt; with None update data, which just update nothing to the source dir file, but not removing the data. So, after the fix, the &lt;b&gt;allCleanerCheckpoints&lt;/b&gt; will work as expected (since the source dir is removed). Submitted patch now. Thanks.&lt;/p&gt;</comment>
                            <comment id="17177123" author="mingaliu" created="Thu, 13 Aug 2020 16:11:05 +0000"  >&lt;p&gt;Awesome, what is the patch link?&lt;/p&gt;</comment>
                            <comment id="17177416" author="showuon" created="Fri, 14 Aug 2020 01:48:18 +0000"  >&lt;p&gt;Sorry, I linked to the wrong Jira id yesterday. You can check the &lt;b&gt;links to&lt;/b&gt; PR section above. Thanks.&lt;/p&gt;</comment>
                            <comment id="17195550" author="junrao" created="Mon, 14 Sep 2020 15:51:42 +0000"  >&lt;p&gt;Merged the PR to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02neo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>