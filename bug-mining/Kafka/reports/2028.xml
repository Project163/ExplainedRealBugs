<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:14:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7242] Externalized secrets are revealed in task configuration</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7242</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Trying to use&#160;new &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6886&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;externalized secrets&lt;/a&gt; feature I noticed that task configuration is being saved in config topic with disclosed secrets. It seems like the main goal of feature was not achieved - secrets are still persisted in plain-text. Probably I&apos;m misusing this new config, please correct me if I wrong.&lt;/p&gt;

&lt;p&gt;I&apos;m running connect in distributed mode, creating connector with following config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc-sink-test&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;config&quot;&lt;/span&gt; : {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.jdbc.JdbcSinkConnector&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers.file.class&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.common.config.provider.FileConfigProvider&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers.file.param.secrets&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/mysecrets&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;test_topic&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;connection.url&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/mysecrets:url}&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;connection.user&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/mysecrets:user}&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;connection.password&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/mysecrets:password}&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;insert.mode&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;upsert&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;pk.mode&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;record_value&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;pk.field&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Connector works fine, placeholders are substituted with correct values from file, but then updated config is written into&#160; the topic again (see 3 following records in config topic):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
key: connector-jdbc-sink-test
value:
{
&lt;span class=&quot;code-quote&quot;&gt;&quot;properties&quot;&lt;/span&gt;: {
&lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.jdbc.JdbcSinkConnector&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers.file.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.common.config.provider.FileConfigProvider&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers.file.param.secrets&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/mysecrets&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test_topic&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;connection.url&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/mysecrets:url}&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;connection.user&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/mysecrets:user}&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;connection.password&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;${file:/opt/mysecrets:password}&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;insert.mode&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;upsert&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;pk.mode&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;record_value&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;pk.field&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc-sink-test&quot;&lt;/span&gt;
}
}


key: task-jdbc-sink-test-0
value:
{
&lt;span class=&quot;code-quote&quot;&gt;&quot;properties&quot;&lt;/span&gt;: {
&lt;span class=&quot;code-quote&quot;&gt;&quot;connector.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.jdbc.JdbcSinkConnector&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers.file.param.secrets&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/mysecrets&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;connection.password&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;actualpassword&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;tasks.max&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;topics&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test_topic&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;pk.field&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;task.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;io.confluent.connect.jdbc.sink.JdbcSinkTask&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;connection.user&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;datawarehouse&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc-sink-test&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;config.providers.file.class&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.kafka.common.config.provider.FileConfigProvider&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;connection.url&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:postgresql:&lt;span class=&quot;code-comment&quot;&gt;//actualurl:5432/datawarehouse?stringtype=unspecified&quot;&lt;/span&gt;,
&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;insert.mode&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;upsert&quot;&lt;/span&gt;,
&lt;span class=&quot;code-quote&quot;&gt;&quot;pk.mode&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;record_value&quot;&lt;/span&gt;
}
}

key: commit-jdbc-sink-test
value:
{
&lt;span class=&quot;code-quote&quot;&gt;&quot;tasks&quot;&lt;/span&gt;:1
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please advice have I misunderstood the goal of the given feature, have I missed&#160;smth in configuration or is it actually a bug? Thank you&lt;/p&gt;</description>
                <environment></environment>
        <key id="13176733">KAFKA-7242</key>
            <summary>Externalized secrets are revealed in task configuration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rayokota">Robert Yokota</assignee>
                                    <reporter username="bsiamionau">Bahdan Siamionau</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Aug 2018 15:21:26 +0000</created>
                <updated>Tue, 28 Aug 2018 20:00:59 +0000</updated>
                            <resolved>Tue, 28 Aug 2018 19:59:41 +0000</resolved>
                                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16571135" author="rayokota" created="Tue, 7 Aug 2018 05:40:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bsiamionau&quot; class=&quot;user-hover&quot; rel=&quot;bsiamionau&quot;&gt;bsiamionau&lt;/a&gt;, thanks for finding and logging this issue. &#160;Unfortunately this appears to be a bug that occurs when task configurations get rewritten back to the topic during a reconfiguration. &#160;I&apos;ll submit a PR shortly.&lt;/p&gt;</comment>
                            <comment id="16571235" author="bsiamionau" created="Tue, 7 Aug 2018 08:01:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rayokota&quot; class=&quot;user-hover&quot; rel=&quot;rayokota&quot;&gt;rayokota&lt;/a&gt; good news, thank you!&lt;/p&gt;</comment>
                            <comment id="16572353" author="githubbot" created="Tue, 7 Aug 2018 21:22:43 +0000"  >&lt;p&gt;rayokota opened a new pull request #5475: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7242&quot; title=&quot;Externalized secrets are revealed in task configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7242&quot;&gt;&lt;del&gt;KAFKA-7242&lt;/del&gt;&lt;/a&gt;: Reverse xform configs before saving&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5475&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5475&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   During actions such as a reconfiguration, the task configs are obtained&lt;br/&gt;
   via `Worker.connectorTaskConfigs` and then subsequently saved into an&lt;br/&gt;
   instance of `ClusterConfigState`.  The values of the properties are&lt;br/&gt;
   post-transformation (of variable references) when they should be&lt;br/&gt;
   pre-transformation.  This is to avoid secrets appearing in plaintext in&lt;br/&gt;
   the `connect-configs` topic, for example.&lt;/p&gt;

&lt;p&gt;   The fix is to change the 2 clients of `Worker.connectorTaskConfigs` to&lt;br/&gt;
   perform a reverse transformation (values converted back into variable&lt;br/&gt;
   references) before saving them into an instance of `ClusterConfigState`.&lt;br/&gt;
   The 2 places where the save is performed are&lt;br/&gt;
   `DistributedHerder.reconfigureConnector` and&lt;br/&gt;
   `StandaloneHerder.updateConnectorTasks`.&lt;/p&gt;

&lt;p&gt;   The way that the reverse transformation works is to try to obtain the&lt;br/&gt;
   &quot;raw&quot; task config (with variable references still intact) from&lt;br/&gt;
   `ClusterConfigState`, and if that is not available, then use the &quot;raw&quot;&lt;br/&gt;
   connector config from `ClusterConfigState`.  The &quot;raw&quot; task config is&lt;br/&gt;
   checked first since the user may have inserted task configs directly&lt;br/&gt;
   using the REST API that may differ from the &quot;raw&quot; connector config.&lt;/p&gt;

&lt;p&gt;   There are 2 additional small changes:&lt;/p&gt;

&lt;p&gt;   1) `ClusterConfigState.allTasksConfigs` has been changed to perform a&lt;br/&gt;
   transformation (resolution) on all variable references.  This is&lt;br/&gt;
   necessary because the result of this method is compared directly to&lt;br/&gt;
   `Worker.connectorTaskConfigs`, which also has variable references&lt;br/&gt;
   resolved.&lt;/p&gt;

&lt;p&gt;   2) `StandaloneHerder.startConnector` has been changed to match&lt;br/&gt;
   `DistributedHerder.startConnector`.  This is to fix an issue where&lt;br/&gt;
   during `StandaloneHerder.restartConnector`, the post-transformed&lt;br/&gt;
   connector config would be saved back into `ClusterConfigState`.&lt;/p&gt;

&lt;p&gt;   I also performed an anlysis of all other code paths where configs are&lt;br/&gt;
   saved back into `ClusterConfigState` and did not find any other&lt;br/&gt;
   issues.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16595522" author="ewencp" created="Tue, 28 Aug 2018 19:59:41 +0000"  >&lt;p&gt;Issue resolved by pull request 5475&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/5475&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5475&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16595525" author="githubbot" created="Tue, 28 Aug 2018 20:00:59 +0000"  >&lt;p&gt;ewencp closed pull request #5475: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7242&quot; title=&quot;Externalized secrets are revealed in task configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7242&quot;&gt;&lt;del&gt;KAFKA-7242&lt;/del&gt;&lt;/a&gt;: Reverse xform configs before saving&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5475&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5475&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/config/ConfigTransformer.java b/clients/src/main/java/org/apache/kafka/common/config/ConfigTransformer.java&lt;br/&gt;
index f5a3737d334..6430ffdd419 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/config/ConfigTransformer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/config/ConfigTransformer.java&lt;br/&gt;
@@ -53,7 +53,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;{@link ConfigProvider#unsubscribe(String, Set, ConfigChangeCallback)}
&lt;p&gt; methods.&lt;br/&gt;
  */&lt;br/&gt;
 public class ConfigTransformer {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Pattern DEFAULT_PATTERN = Pattern.compile(&quot;\\$&lt;br class=&quot;atl-forced-newline&quot; /&gt;
{(.*?):((.*?):)?(.*?)\\}
&lt;p&gt;&quot;);&lt;br/&gt;
+    public static final Pattern DEFAULT_PATTERN = Pattern.compile(&quot;\\$&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
{(.*?):((.*?):)?(.*?)\\}
&lt;p&gt;&quot;);&lt;br/&gt;
     private static final String EMPTY_PATH = &quot;&quot;;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final Map&amp;lt;String, ConfigProvider&amp;gt; configProviders;&lt;br/&gt;
diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractHerder.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractHerder.java&lt;br/&gt;
index cadb4e05d9a..82fdeccc96b 100644&lt;br/&gt;
&amp;#8212; a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractHerder.java&lt;br/&gt;
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/AbstractHerder.java&lt;br/&gt;
@@ -20,9 +20,11 @@&lt;br/&gt;
 import org.apache.kafka.common.config.ConfigDef;&lt;br/&gt;
 import org.apache.kafka.common.config.ConfigDef.ConfigKey;&lt;br/&gt;
 import org.apache.kafka.common.config.ConfigDef.Type;&lt;br/&gt;
+import org.apache.kafka.common.config.ConfigTransformer;&lt;br/&gt;
 import org.apache.kafka.common.config.ConfigValue;&lt;br/&gt;
 import org.apache.kafka.connect.connector.Connector;&lt;br/&gt;
 import org.apache.kafka.connect.errors.NotFoundException;&lt;br/&gt;
+import org.apache.kafka.connect.runtime.distributed.ClusterConfigState;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.isolation.Plugins;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.rest.entities.ConfigInfo;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.rest.entities.ConfigInfos;&lt;br/&gt;
@@ -46,6 +48,7 @@&lt;br/&gt;
 import java.util.Collection;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
+import java.util.HashSet;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
 import java.util.LinkedHashSet;&lt;br/&gt;
 import java.util.LinkedList;&lt;br/&gt;
@@ -53,6 +56,8 @@&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
 import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
+import java.util.regex.Matcher;&lt;br/&gt;
+import java.util.regex.Pattern;&lt;/p&gt;

&lt;p&gt; /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Abstract Herder implementation which handles connector/task lifecycle tracking. Extensions&lt;br/&gt;
@@ -431,4 +436,42 @@ private String trace(Throwable t) 
{
             return null;
         }
&lt;p&gt;     }&lt;br/&gt;
+&lt;br/&gt;
+    /*&lt;br/&gt;
+     * Performs a reverse transformation on a set of task configs, by replacing values with variable references.&lt;br/&gt;
+     */&lt;br/&gt;
+    public static List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; reverseTransform(String connName,&lt;br/&gt;
+                                                             ClusterConfigState configState,&lt;br/&gt;
+                                                             List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; configs) {&lt;br/&gt;
+&lt;br/&gt;
+        // Find the config keys in the raw connector config that have variable references&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; rawConnConfig = configState.rawConnectorConfig(connName);&lt;br/&gt;
+        Set&amp;lt;String&amp;gt; connKeysWithVariableValues = keysWithVariableValues(rawConnConfig, ConfigTransformer.DEFAULT_PATTERN);&lt;br/&gt;
+&lt;br/&gt;
+        List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; result = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+        for (Map&amp;lt;String, String&amp;gt; config : configs) {&lt;br/&gt;
+            Map&amp;lt;String, String&amp;gt; newConfig = new HashMap&amp;lt;&amp;gt;(config);&lt;br/&gt;
+            for (String key : connKeysWithVariableValues) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                if (newConfig.containsKey(key)) {
+                    newConfig.put(key, rawConnConfig.get(key));
+                }+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+            result.add(newConfig);&lt;br/&gt;
+        }&lt;br/&gt;
+        return result;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private static Set&amp;lt;String&amp;gt; keysWithVariableValues(Map&amp;lt;String, String&amp;gt; rawConfig, Pattern pattern) {&lt;br/&gt;
+        Set&amp;lt;String&amp;gt; keys = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
+        for (Map.Entry&amp;lt;String, String&amp;gt; config : rawConfig.entrySet()) {&lt;br/&gt;
+            if (config.getValue() != null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                Matcher matcher = pattern.matcher(config.getValue());+                if (matcher.matches()) {
+                    keys.add(config.getKey());
+                }+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        }&lt;br/&gt;
+        return keys;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/ClusterConfigState.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/ClusterConfigState.java&lt;br/&gt;
index 11693b51795..fc6a50d2fc0 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/ClusterConfigState.java&lt;br/&gt;
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/ClusterConfigState.java&lt;br/&gt;
@@ -123,6 +123,10 @@ public boolean contains(String connector) 
{
         return configs;
     }&lt;br/&gt;
 &lt;br/&gt;
+    public Map&amp;lt;String, String&amp;gt; rawConnectorConfig(String connector) {
+        return connectorConfigs.get(connector);
+    }&lt;br/&gt;
+&lt;br/&gt;
     /**&lt;br/&gt;
      * Get the target state of the connector&lt;br/&gt;
      * @param connector name of the connector&lt;br/&gt;
@@ -148,16 +152,28 @@ public TargetState targetState(String connector) {         return configs;     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    public Map&amp;lt;String, String&amp;gt; rawTaskConfig(ConnectorTaskId task) &lt;/p&gt;
{
+        return taskConfigs.get(task);
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Get all task configs for a connector.&lt;br/&gt;
+     * Get all task configs for a connector.  The configurations will have been transformed by&lt;br/&gt;
+     * 
{@link org.apache.kafka.common.config.ConfigTransformer}
&lt;p&gt; by having all variable&lt;br/&gt;
+     * references replaced with the current values from external instances of&lt;br/&gt;
+     * &lt;/p&gt;
{@link ConfigProvider}
&lt;p&gt;, and may include secrets.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param connector name of the connector&lt;/li&gt;
	&lt;li&gt;@return a list of task configurations&lt;br/&gt;
      */&lt;br/&gt;
     public List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; allTaskConfigs(String connector) {&lt;br/&gt;
         Map&amp;lt;Integer, Map&amp;lt;String, String&amp;gt;&amp;gt; taskConfigs = new TreeMap&amp;lt;&amp;gt;();&lt;br/&gt;
         for (Map.Entry&amp;lt;ConnectorTaskId, Map&amp;lt;String, String&amp;gt;&amp;gt; taskConfigEntry : this.taskConfigs.entrySet()) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (taskConfigEntry.getKey().connector().equals(connector))&lt;/li&gt;
	&lt;li&gt;taskConfigs.put(taskConfigEntry.getKey().task(), taskConfigEntry.getValue());&lt;br/&gt;
+            if (taskConfigEntry.getKey().connector().equals(connector)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                Map&amp;lt;String, String&amp;gt; configs = taskConfigEntry.getValue();+                if (configTransformer != null) {
+                    configs = configTransformer.transform(connector, configs);
+                }+                taskConfigs.put(taskConfigEntry.getKey().task(), configs);+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;         }&lt;br/&gt;
         return new LinkedList&amp;lt;&amp;gt;(taskConfigs.values());&lt;br/&gt;
     }&lt;br/&gt;
diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java&lt;br/&gt;
index 5efb78a93e4..f2009dbac1e 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java&lt;br/&gt;
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java&lt;br/&gt;
@@ -1020,8 +1020,9 @@ private void reconfigureConnector(final String connName, final Callback&amp;lt;Void&amp;gt; cb&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
             if (changed) {&lt;br/&gt;
+                List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; rawTaskProps = reverseTransform(connName, configState, taskProps);&lt;br/&gt;
                 if (isLeader()) 
{
-                    configBackingStore.putTaskConfigs(connName, taskProps);
+                    configBackingStore.putTaskConfigs(connName, rawTaskProps);
                     cb.onCompletion(null, null);
                 }
&lt;p&gt; else {&lt;br/&gt;
                     // We cannot forward the request on the same thread because this reconfiguration can happen as a result of connector&lt;br/&gt;
@@ -1031,7 +1032,7 @@ private void reconfigureConnector(final String connName, final Callback&amp;lt;Void&amp;gt; cb&lt;br/&gt;
                         public void run() {&lt;br/&gt;
                             try &lt;/p&gt;
{
                                 String reconfigUrl = RestServer.urlJoin(leaderUrl(), &quot;/connectors/&quot; + connName + &quot;/tasks&quot;);
-                                RestClient.httpRequest(reconfigUrl, &quot;POST&quot;, taskProps, null, config);
+                                RestClient.httpRequest(reconfigUrl, &quot;POST&quot;, rawTaskProps, null, config);
                                 cb.onCompletion(null, null);
                             }
&lt;p&gt; catch (ConnectException e) &lt;/p&gt;
{
                                 log.error(&quot;Request to leader to reconfigure connector tasks failed&quot;, e);
diff --git a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/standalone/StandaloneHerder.java b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/standalone/StandaloneHerder.java
index 20c6a24d384..40ad9803a2c 100644
--- a/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/standalone/StandaloneHerder.java
+++ b/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/standalone/StandaloneHerder.java
@@ -201,7 +201,9 @@ public synchronized void putConnectorConfig(String connName,
                 created = true;
             }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!startConnector(config)) {&lt;br/&gt;
+            configBackingStore.putConnectorConfig(connName, config);&lt;br/&gt;
+&lt;br/&gt;
+            if (!startConnector(connName)) 
{
                 callback.onCompletion(new ConnectException(&quot;Failed to start connector: &quot; + connName), null);
                 return;
             }
&lt;p&gt;@@ -270,9 +272,8 @@ public synchronized void restartConnector(String connName, Callback&amp;lt;Void&amp;gt; cb) {&lt;br/&gt;
         if (!configState.contains(connName))&lt;br/&gt;
             cb.onCompletion(new NotFoundException(&quot;Connector &quot; + connName + &quot; not found&quot;, null), null);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Map&amp;lt;String, String&amp;gt; config = configState.connectorConfig(connName);&lt;br/&gt;
         worker.stopConnector(connName);&lt;/li&gt;
	&lt;li&gt;if (startConnector(config))&lt;br/&gt;
+        if (startConnector(connName))&lt;br/&gt;
             cb.onCompletion(null, null);&lt;br/&gt;
         else&lt;br/&gt;
             cb.onCompletion(new ConnectException(&quot;Failed to start connector: &quot; + connName), null);&lt;br/&gt;
@@ -290,9 +291,7 @@ public void run() 
{
         return new StandaloneHerderRequest(requestSeqNum.incrementAndGet(), future);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean startConnector(Map&amp;lt;String, String&amp;gt; connectorProps) {&lt;/li&gt;
	&lt;li&gt;String connName = connectorProps.get(ConnectorConfig.NAME_CONFIG);&lt;/li&gt;
	&lt;li&gt;configBackingStore.putConnectorConfig(connName, connectorProps);&lt;br/&gt;
+    private boolean startConnector(String connName) {&lt;br/&gt;
         Map&amp;lt;String, String&amp;gt; connConfigs = configState.connectorConfig(connName);&lt;br/&gt;
         TargetState targetState = configState.targetState(connName);&lt;br/&gt;
         return worker.startConnector(connName, connConfigs, new HerderConnectorContext(this, connName), this, targetState);&lt;br/&gt;
@@ -336,7 +335,8 @@ private void updateConnectorTasks(String connName) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         if (!newTaskConfigs.equals(oldTaskConfigs)) &lt;/p&gt;
{
             removeConnectorTasks(connName);
-            configBackingStore.putTaskConfigs(connName, newTaskConfigs);
+            List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; rawTaskConfigs = reverseTransform(connName, configState, newTaskConfigs);
+            configBackingStore.putTaskConfigs(connName, rawTaskConfigs);
             createConnectorTasks(connName, configState.targetState(connName));
         }
&lt;p&gt;     }&lt;br/&gt;
diff --git a/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/AbstractHerderTest.java b/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/AbstractHerderTest.java&lt;br/&gt;
index db3cf273fe7..8dbda185401 100644&lt;br/&gt;
&amp;#8212; a/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/AbstractHerderTest.java&lt;br/&gt;
+++ b/connect/runtime/src/test/java/org/apache/kafka/connect/runtime/AbstractHerderTest.java&lt;br/&gt;
@@ -20,12 +20,15 @@&lt;br/&gt;
 import org.apache.kafka.common.config.ConfigException;&lt;br/&gt;
 import org.apache.kafka.connect.connector.ConnectRecord;&lt;br/&gt;
 import org.apache.kafka.connect.connector.Connector;&lt;br/&gt;
+import org.apache.kafka.connect.runtime.distributed.ClusterConfigState;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.isolation.PluginDesc;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.isolation.Plugins;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.rest.entities.ConfigInfos;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.rest.entities.ConnectorStateInfo;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.rest.entities.ConnectorType;&lt;br/&gt;
 import org.apache.kafka.connect.runtime.rest.errors.BadRequestException;&lt;br/&gt;
+import org.apache.kafka.connect.source.SourceConnector;&lt;br/&gt;
+import org.apache.kafka.connect.source.SourceTask;&lt;br/&gt;
 import org.apache.kafka.connect.storage.ConfigBackingStore;&lt;br/&gt;
 import org.apache.kafka.connect.storage.StatusBackingStore;&lt;br/&gt;
 import org.apache.kafka.connect.transforms.Transformation;&lt;br/&gt;
@@ -40,6 +43,7 @@&lt;br/&gt;
 import org.powermock.core.classloader.annotations.PrepareForTest;&lt;br/&gt;
 import org.powermock.modules.junit4.PowerMockRunner;&lt;/p&gt;

&lt;p&gt;+import java.util.ArrayList;&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
@@ -61,6 +65,53 @@&lt;br/&gt;
 @PrepareForTest(&lt;/p&gt;
{AbstractHerder.class}
&lt;p&gt;)&lt;br/&gt;
 public class AbstractHerderTest {&lt;/p&gt;

&lt;p&gt;+    private static final String CONN1 = &quot;sourceA&quot;;&lt;br/&gt;
+    private static final ConnectorTaskId TASK0 = new ConnectorTaskId(CONN1, 0);&lt;br/&gt;
+    private static final ConnectorTaskId TASK1 = new ConnectorTaskId(CONN1, 1);&lt;br/&gt;
+    private static final ConnectorTaskId TASK2 = new ConnectorTaskId(CONN1, 2);&lt;br/&gt;
+    private static final Integer MAX_TASKS = 3;&lt;br/&gt;
+    private static final Map&amp;lt;String, String&amp;gt; CONN1_CONFIG = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+    private static final String TEST_KEY = &quot;testKey&quot;;&lt;br/&gt;
+    private static final String TEST_KEY2 = &quot;testKey2&quot;;&lt;br/&gt;
+    private static final String TEST_KEY3 = &quot;testKey3&quot;;&lt;br/&gt;
+    private static final String TEST_VAL = &quot;testVal&quot;;&lt;br/&gt;
+    private static final String TEST_VAL2 = &quot;testVal2&quot;;&lt;br/&gt;
+    private static final String TEST_REF = &quot;${&lt;a href=&quot;file:/tmp/somefile.txt:somevar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/tmp/somefile.txt:somevar&lt;/a&gt;}&quot;;&lt;br/&gt;
+    private static final String TEST_REF2 = &quot;${&lt;a href=&quot;file:/tmp/somefile2.txt:somevar2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/tmp/somefile2.txt:somevar2&lt;/a&gt;}&quot;;&lt;br/&gt;
+    private static final String TEST_REF3 = &quot;${&lt;a href=&quot;file:/tmp/somefile3.txt:somevar3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/tmp/somefile3.txt:somevar3&lt;/a&gt;}&quot;;&lt;br/&gt;
+    static &lt;/p&gt;
{
+        CONN1_CONFIG.put(ConnectorConfig.NAME_CONFIG, CONN1);
+        CONN1_CONFIG.put(ConnectorConfig.TASKS_MAX_CONFIG, MAX_TASKS.toString());
+        CONN1_CONFIG.put(SinkConnectorConfig.TOPICS_CONFIG, &quot;foo,bar&quot;);
+        CONN1_CONFIG.put(ConnectorConfig.CONNECTOR_CLASS_CONFIG, BogusSourceConnector.class.getName());
+        CONN1_CONFIG.put(TEST_KEY, TEST_REF);
+        CONN1_CONFIG.put(TEST_KEY2, TEST_REF2);
+        CONN1_CONFIG.put(TEST_KEY3, TEST_REF3);
+    }
&lt;p&gt;+    private static final Map&amp;lt;String, String&amp;gt; TASK_CONFIG = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+    static &lt;/p&gt;
{
+        TASK_CONFIG.put(TaskConfig.TASK_CLASS_CONFIG, BogusSourceTask.class.getName());
+        TASK_CONFIG.put(TEST_KEY, TEST_REF);
+    }
&lt;p&gt;+    private static final List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; TASK_CONFIGS = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
+    static &lt;/p&gt;
{
+        TASK_CONFIGS.add(TASK_CONFIG);
+        TASK_CONFIGS.add(TASK_CONFIG);
+        TASK_CONFIGS.add(TASK_CONFIG);
+    }
&lt;p&gt;+    private static final HashMap&amp;lt;ConnectorTaskId, Map&amp;lt;String, String&amp;gt;&amp;gt; TASK_CONFIGS_MAP = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+    static &lt;/p&gt;
{
+        TASK_CONFIGS_MAP.put(TASK0, TASK_CONFIG);
+        TASK_CONFIGS_MAP.put(TASK1, TASK_CONFIG);
+        TASK_CONFIGS_MAP.put(TASK2, TASK_CONFIG);
+    }
&lt;p&gt;+    private static final ClusterConfigState SNAPSHOT = new ClusterConfigState(1, Collections.singletonMap(CONN1, 3),&lt;br/&gt;
+            Collections.singletonMap(CONN1, CONN1_CONFIG), Collections.singletonMap(CONN1, TargetState.STARTED),&lt;br/&gt;
+            TASK_CONFIGS_MAP, Collections.&amp;lt;String&amp;gt;emptySet());&lt;br/&gt;
+    private static final ClusterConfigState SNAPSHOT_NO_TASKS = new ClusterConfigState(1, Collections.singletonMap(CONN1, 3),&lt;br/&gt;
+            Collections.singletonMap(CONN1, CONN1_CONFIG), Collections.singletonMap(CONN1, TargetState.STARTED),&lt;br/&gt;
+            Collections.emptyMap(), Collections.&amp;lt;String&amp;gt;emptySet());&lt;br/&gt;
+&lt;br/&gt;
     private final String workerId = &quot;workerId&quot;;&lt;br/&gt;
     private final String kafkaClusterId = &quot;I4ZmrWqfT2e-upky_4fdPA&quot;;&lt;br/&gt;
     private final int generation = 5;&lt;br/&gt;
@@ -248,6 +299,29 @@ public void testConfigValidationTransformsExtendResults() &lt;/p&gt;
{
         verifyAll();
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testReverseTransformConfigs() throws Exception &lt;/p&gt;
{
+        // Construct a task config with constant values for TEST_KEY and TEST_KEY2
+        Map&amp;lt;String, String&amp;gt; newTaskConfig = new HashMap&amp;lt;&amp;gt;();
+        newTaskConfig.put(TaskConfig.TASK_CLASS_CONFIG, BogusSourceTask.class.getName());
+        newTaskConfig.put(TEST_KEY, TEST_VAL);
+        newTaskConfig.put(TEST_KEY2, TEST_VAL2);
+        List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; newTaskConfigs = new ArrayList&amp;lt;&amp;gt;();
+        newTaskConfigs.add(newTaskConfig);
+
+        // The SNAPSHOT has a task config with TEST_KEY and TEST_REF
+        List&amp;lt;Map&amp;lt;String, String&amp;gt;&amp;gt; reverseTransformed = AbstractHerder.reverseTransform(CONN1, SNAPSHOT, newTaskConfigs);
+        assertEquals(TEST_REF, reverseTransformed.get(0).get(TEST_KEY));
+
+        // The SNAPSHOT has no task configs but does have a connector config with TEST_KEY2 and TEST_REF2
+        reverseTransformed = AbstractHerder.reverseTransform(CONN1, SNAPSHOT_NO_TASKS, newTaskConfigs);
+        assertEquals(TEST_REF2, reverseTransformed.get(0).get(TEST_KEY2));
+
+        // The reverseTransformed result should not have TEST_KEY3 since newTaskConfigs does not have TEST_KEY3
+        reverseTransformed = AbstractHerder.reverseTransform(CONN1, SNAPSHOT_NO_TASKS, newTaskConfigs);
+        assertFalse(reverseTransformed.get(0).containsKey(TEST_KEY3));
+    }
&lt;p&gt;+&lt;br/&gt;
     private AbstractHerder createConfigValidationHerder(Class&amp;lt;? extends Connector&amp;gt; connectorClass) {&lt;/p&gt;


&lt;p&gt;@@ -299,4 +373,11 @@ public void close() {&lt;/p&gt;

&lt;p&gt;         }&lt;br/&gt;
     }&lt;br/&gt;
+&lt;br/&gt;
+    // We need to use a real class here due to some issue with mocking java.lang.Class&lt;br/&gt;
+    private abstract class BogusSourceConnector extends SourceConnector &lt;/p&gt;
{
+    }&lt;br/&gt;
+&lt;br/&gt;
+    private abstract class BogusSourceTask extends SourceTask {+    }
&lt;p&gt; }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wo1b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>