<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16460] New consumer times out consuming records in multiple consumer_test.py system tests</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16460</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The &lt;tt&gt;consumer_test.py&lt;/tt&gt; system test fails with the following errors:&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;Timed out waiting for consumption&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Affected tests:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;test_broker_failure&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_consumer_bounce&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_static_consumer_bounce&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13574331">KAFKA-16460</key>
            <summary>New consumer times out consuming records in multiple consumer_test.py system tests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yangpoan">PoAn Yang</assignee>
                                    <reporter username="kirktrue">Kirk True</reporter>
                        <labels>
                            <label>kip-848-client-support</label>
                            <label>system-tests</label>
                    </labels>
                <created>Tue, 2 Apr 2024 17:16:16 +0000</created>
                <updated>Tue, 19 Nov 2024 18:41:47 +0000</updated>
                            <resolved>Tue, 19 Nov 2024 18:41:47 +0000</resolved>
                                    <version>3.7.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                    <component>system tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17834082" author="kirktrue" created="Thu, 4 Apr 2024 21:06:58 +0000"  >&lt;p&gt;Good or bad, the test actually passes a good fraction of the time.&lt;/p&gt;</comment>
                            <comment id="17884336" author="JIRAUSER301926" created="Tue, 24 Sep 2024 15:45:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; I want to pick this up , Can you give a reference to the document which can provide more context to the problem.&lt;/p&gt;</comment>
                            <comment id="17884399" author="kirktrue" created="Tue, 24 Sep 2024 18:10:23 +0000"  >&lt;p&gt;There&apos;s a good chance this is a result of a different problem, so I don&apos;t want you to chase issues that are unrelated. If I find an actionable bug to fix, I&apos;ll assign it to you.&lt;/p&gt;</comment>
                            <comment id="17887252" author="JIRAUSER300229" created="Mon, 7 Oct 2024 04:26:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, if you&apos;re not working on this, may I take it? Thank you.&lt;/p&gt;</comment>
                            <comment id="17887388" author="kirktrue" created="Mon, 7 Oct 2024 16:20:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yangpoan&quot; class=&quot;user-hover&quot; rel=&quot;yangpoan&quot;&gt;yangpoan&lt;/a&gt;&#8212;yes, you are free to take it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thanks!&lt;/p&gt;</comment>
                            <comment id="17896539" author="kirktrue" created="Fri, 8 Nov 2024 02:17:11 +0000"  >&lt;p&gt;I&apos;m not seeing this reproduce in the last three runs of the system tests.&lt;/p&gt;</comment>
                            <comment id="17896832" author="kirktrue" created="Sat, 9 Nov 2024 01:30:02 +0000"  >&lt;p&gt;And, of course, my very next system test run I get a test failure &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Parameters: &lt;tt&gt;test_broker_failure.clean_shutdown=True.enable_autocommit=True.metadata_quorum=ISOLATED_KRAFT.use_new_coordinator=True.group_protocol=consumer&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;AssertionError(&apos;Total consumed records 10391 did not match consumed position 9891&apos;)
Traceback (most recent call last):
  File &quot;/home/semaphore/kafka-overlay/kafka/venv/lib/python3.8/site-packages/ducktape/tests/runner_client.py&quot;, line 351, in _do_run
    data = self.run_test()
  File &quot;/home/semaphore/kafka-overlay/kafka/venv/lib/python3.8/site-packages/ducktape/tests/runner_client.py&quot;, line 411, in run_test
    return self.test_context.function(self.test)
  File &quot;/home/semaphore/kafka-overlay/kafka/venv/lib/python3.8/site-packages/ducktape/mark/_mark.py&quot;, line 438, in wrapper
    return functools.partial(f, *args, **kwargs)(*w_args, **w_kwargs)
  File &quot;/home/semaphore/kafka-overlay/kafka/tests/kafkatest/tests/client/consumer_test.py&quot;, line 496, in test_broker_failure
    assert consumer.current_position(partition) == consumer.total_consumed(), \
AssertionError: Total consumed records 10391 did not match consumed position 9891
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17896841" author="kirktrue" created="Sat, 9 Nov 2024 04:05:21 +0000"  >&lt;p&gt;Looking at this in depth, there&apos;s an interesting race condition with the test itself because it creates multiple consumers all vying for a single partition. The consumers all use auto-commit to record their progress.&lt;/p&gt;

&lt;p&gt;In the example test failure I inspected, this was the basic order of events:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Consumer A is assigned the partition&lt;/li&gt;
	&lt;li&gt;Consumer A reads 500 records&lt;/li&gt;
	&lt;li&gt;Consumer A records a &lt;tt&gt;records_consumed&lt;/tt&gt; value of 500 (see &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13072712/13072712_verifiable_consumer_worker_A.stdout&quot; title=&quot;verifiable_consumer_worker_A.stdout attached to KAFKA-16460&quot;&gt;verifiable_consumer_worker_A.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;)&lt;/li&gt;
	&lt;li&gt;Consumer A&apos;s assignment is revoked before it can (auto-)commit its offsets&lt;/li&gt;
	&lt;li&gt;Consumer B is assigned the partition&lt;/li&gt;
	&lt;li&gt;Consumer B reads multiple batches of records up to the full number of records produced (see &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13072711/13072711_verifiable_consumer_worker_B.stdout&quot; title=&quot;verifiable_consumer_worker_B.stdout attached to KAFKA-16460&quot;&gt;verifiable_consumer_worker_B.stdout&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;), outputs them to the JSON, and commits the offsets&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So from the test runner&apos;s standpoint, it sees:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Consumer A&apos;s &lt;tt&gt;records_consumed&lt;/tt&gt;: 500&lt;/li&gt;
	&lt;li&gt;Consumer B&apos;s &lt;tt&gt;records_consumed&lt;/tt&gt;: 9891&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the error message, the value for &quot;consumed records&quot; is the summation of all the &lt;tt&gt;records_consumed&lt;/tt&gt; values the test received from the workers (consumer A and B). The value for &quot;consumed position&quot; is the latest value of the &lt;tt&gt;minOffset&lt;/tt&gt; value the test received from the workers (consumer B, in this example).&lt;/p&gt;

&lt;p&gt;When the number of consumed records from both workers are added, you get the value of 10391.&lt;/p&gt;</comment>
                            <comment id="17896842" author="kirktrue" created="Sat, 9 Nov 2024 04:06:11 +0000"  >&lt;p&gt;My question is: why was consumer A&apos;s assignment revoked? There&apos;s nothing in the worker logs to suggest why that was done. More digging is required.&lt;/p&gt;</comment>
                            <comment id="17897211" author="JIRAUSER300229" created="Mon, 11 Nov 2024 15:28:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, I also can reproduce the same case in my cluster.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;IIUC, the consumer A&apos;s assignment is revoked, because the node receive SIGTERM. After that, another consumer (B) will starts and keep polling.&lt;/del&gt; The question is that: why consumer B doesn&apos;t start from consumer A&apos;s last offset? The consumer B still starts from offset 0.&lt;/p&gt;</comment>
                            <comment id="17897431" author="JIRAUSER300229" created="Tue, 12 Nov 2024 09:32:06 +0000"  >&lt;p&gt;&amp;gt; My question is: why was consumer A&apos;s assignment revoked?&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, I find the reason. Following is related server log in my cluster. When the third member join the group, the target assignment changes. We use RangeAssignor, the assignment change is caused by the change of member.id relative order.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[GroupId test_group_id] Member a45a9X28TsytoqZU2S0zYQ joins the consumer group using the consumer protocol.
[GroupId test_group_id] Member a45a9X28TsytoqZU2S0zYQ updated its subscribed topics to: [test_topic].
[GroupId test_group_id] Computed new subscription metadata: {test_topic=TopicMetadata(id=mZkLnq_pSLSzCjXUFtuFow, name=test_topic, numPartitions=1)}.
[GroupId test_group_id] Bumped group epoch to 1.
[GroupId test_group_id] Computed a new target assignment for epoch 1 with &apos;range&apos; assignor in 5ms: {a45a9X28TsytoqZU2S0zYQ=MemberAssignment(partitions={mZkLnq_pSLSzCjXUFtuFow=RangeSet(from=0 (inclusive), to=1 (exclusive))})}.
[GroupId test_group_id] Member a45a9X28TsytoqZU2S0zYQ new assignment state: epoch=1, previousEpoch=0, state=STABLE, assignedPartitions=[mZkLnq_pSLSzCjXUFtuFow-0] and revokedPartitions=[].

[GroupId test_group_id] Member k6bk7X-vT5SDXzKJtaM7tQ joins the consumer group using the consumer protocol.
[GroupId test_group_id] Member k6bk7X-vT5SDXzKJtaM7tQ updated its subscribed topics to: [test_topic].
[GroupId test_group_id] Bumped group epoch to 2.
[GroupId test_group_id] Computed a new target assignment for epoch 2 with &apos;range&apos; assignor in 1ms: {a45a9X28TsytoqZU2S0zYQ=MemberAssignment(partitions={mZkLnq_pSLSzCjXUFtuFow=RangeSet(from=0 (inclusive), to=1 (exclusive))}), k6bk7X-vT5SDXzKJtaM7tQ=MemberAssignment(partitions={})}.
[GroupId test_group_id] Member k6bk7X-vT5SDXzKJtaM7tQ new assignment state: epoch=2, previousEpoch=0, state=STABLE, assignedPartitions=[] and revokedPartitions=[].

[GroupId test_group_id] Member TpLC0hQXSpGvGoKocAK18w joins the consumer group using the consumer protocol.
[GroupId test_group_id] Member TpLC0hQXSpGvGoKocAK18w updated its subscribed topics to: [test_topic].
[GroupId test_group_id] Bumped group epoch to 3.
[GroupId test_group_id] Computed a new target assignment for epoch 3 with &apos;range&apos; assignor in 1ms: {TpLC0hQXSpGvGoKocAK18w=MemberAssignment(partitions={mZkLnq_pSLSzCjXUFtuFow=RangeSet(from=0 (inclusive), to=1 (exclusive))}), a45a9X28TsytoqZU2S0zYQ=MemberAssignment(partitions={}), k6bk7X-vT5SDXzKJtaM7tQ=MemberAssignment(partitions={})}.
[GroupId test_group_id] Member TpLC0hQXSpGvGoKocAK18w new assignment state: epoch=3, previousEpoch=0, state=UNRELEASED_PARTITIONS, assignedPartitions=[] and revokedPartitions=[].
[GroupId test_group_id] Member TpLC0hQXSpGvGoKocAK18w new assignment state: epoch=3, previousEpoch=3, state=UNRELEASED_PARTITIONS, assignedPartitions=[] and revokedPartitions=[].
[GroupId test_group_id] Member a45a9X28TsytoqZU2S0zYQ new assignment state: epoch=1, previousEpoch=1, state=UNREVOKED_PARTITIONS, assignedPartitions=[] and revokedPartitions=[mZkLnq_pSLSzCjXUFtuFow-0].
[GroupId test_group_id] Member TpLC0hQXSpGvGoKocAK18w new assignment state: epoch=3, previousEpoch=3, state=STABLE, assignedPartitions=[mZkLnq_pSLSzCjXUFtuFow-0] and revokedPartitions=[].
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17897481" author="JIRAUSER300229" created="Tue, 12 Nov 2024 11:41:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, I found two potential race conditions:&lt;/p&gt;

&lt;p&gt;P1. When a member receives heartbeat response with revoked partitions, a member with auto commit config will send OffsetCommit request before doing SubscriptionState#assignFromSubscribedAwaitingCallback. However, the member doesn&apos;t make sure the FetchBuffer is empty before building the request, so it may send a request with error offset.&lt;br/&gt;
P2. The member doesn&apos;t stop to send FetchRequest when the membership reconciliation is in progress. Before the member does SubscriptionState#assignFromSubscribedAwaitingCallback, a new FetchRequest with revoked partitions may be sent to a broker.&lt;/p&gt;</comment>
                            <comment id="17898117" author="kirktrue" created="Thu, 14 Nov 2024 03:12:43 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17898567" author="JIRAUSER300229" created="Fri, 15 Nov 2024 10:27:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt;, I create a PR for this issue and can&apos;t reproduce it with the PR. Could you help me review it? Thanks.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/17777&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/17777&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                                                <inwardlinks description="is fixed by">
                                        <issuelink>
            <issuekey id="13560695">KAFKA-15974</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13566363">KAFKA-16200</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13072714" name="verifiable_consumer_worker_A.log" size="1090144" author="kirktrue" created="Sat, 9 Nov 2024 03:56:22 +0000"/>
                            <attachment id="13072712" name="verifiable_consumer_worker_A.stdout" size="559" author="kirktrue" created="Sat, 9 Nov 2024 03:49:52 +0000"/>
                            <attachment id="13072713" name="verifiable_consumer_worker_B.log" size="6652409" author="kirktrue" created="Sat, 9 Nov 2024 03:56:24 +0000"/>
                            <attachment id="13072711" name="verifiable_consumer_worker_B.stdout" size="110869" author="kirktrue" created="Sat, 9 Nov 2024 03:49:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1oe08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>lianetm</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>