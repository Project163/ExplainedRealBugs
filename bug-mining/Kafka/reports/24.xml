<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:34:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-145] Kafka server mirror shutdown bug</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-145</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When a machine that is mirroring data off of another Kafka broker is shutdown, it runs into the following exception, effectively dropping data. The shutdown API needs to be fixed to first shutdown the consumer threads, drain all the data to the producer, and only then shutdown the producer. &lt;/p&gt;

&lt;p&gt;FATAL kafka.server.EmbeddedConsumer  - kafka.producer.async.QueueClosedException: Attempt to add event to a closed queue.kafka.producer.async.QueueClosedException: Attempt to add event to a closed queue.&lt;br/&gt;
        at kafka.producer.async.AsyncProducer.send(AsyncProducer.scala:87)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1$$anonfun$apply$mcVI$sp$1$$anonfun$apply$2.apply(ProducerPool.scala:131)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1$$anonfun$apply$mcVI$sp$1$$anonfun$apply$2.apply(ProducerPool.scala:131)&lt;br/&gt;
        at scala.collection.LinearSeqOptimized$class.foreach(LinearSeqOptimized.scala:61)&lt;br/&gt;
        at scala.collection.immutable.List.foreach(List.scala:45)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1$$anonfun$apply$mcVI$sp$1.apply(ProducerPool.scala:131)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1$$anonfun$apply$mcVI$sp$1.apply(ProducerPool.scala:130)&lt;br/&gt;
        at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:57)&lt;br/&gt;
        at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:43)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1.apply$mcVI$sp(ProducerPool.scala:130)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1.apply(ProducerPool.scala:102)&lt;br/&gt;
        at kafka.producer.ProducerPool$$anonfun$send$1.apply(ProducerPool.scala:102)&lt;br/&gt;
        at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:57)&lt;br/&gt;
        at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:43)&lt;br/&gt;
        at kafka.producer.ProducerPool.send(ProducerPool.scala:102)&lt;br/&gt;
        at kafka.producer.Producer.zkSend(Producer.scala:144)&lt;br/&gt;
        at kafka.producer.Producer.send(Producer.scala:106)&lt;br/&gt;
        at kafka.server.EmbeddedConsumer$$anonfun$startNewConsumerThreads$1$$anonfun$apply$1$$anon$1$$anonfun$run$1.apply(KafkaServerStartable.scala:136)&lt;br/&gt;
        at kafka.server.EmbeddedConsumer$$anonfun$startNewConsumerThreads$1$$anonfun$apply$1$$anon$1$$anonfun$run$1.apply(KafkaServerStartable.scala:134)&lt;br/&gt;
        at scala.collection.Iterator$class.foreach(Iterator.scala:631)&lt;br/&gt;
        at kafka.utils.IteratorTemplate.foreach(IteratorTemplate.scala:30)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525599">KAFKA-145</key>
            <summary>Kafka server mirror shutdown bug</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Oct 2011 23:25:53 +0000</created>
                <updated>Wed, 5 Oct 2011 23:03:16 +0000</updated>
                            <resolved>Wed, 5 Oct 2011 23:03:16 +0000</resolved>
                                                    <fixVersion>0.7</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13121477" author="nehanarkhede" created="Wed, 5 Oct 2011 21:09:32 +0000"  >&lt;p&gt;This patch corrects the shutdown behavior of Kafka mirroring, i.e. EmbeddedConsumer. It first shuts down the new topic watcher, then the zookeeper consumer connector. After this, it stops the mirroring threads. At this point, all mirroring threads have finished mirroring all data that they&apos;ve ever consumed. Only then, it shuts down the producer. &lt;/p&gt;

&lt;p&gt;This ensures that the producer is not shutdown, before the mirroring threads have finished their work, thereby avoiding data loss caused due to QueueClosedException.&lt;/p&gt;</comment>
                            <comment id="13121537" author="junrao" created="Wed, 5 Oct 2011 22:14:53 +0000"  >&lt;p&gt;In MirroringThread.run, it&apos;s probably better to do the countdown even when we hit an exception.&lt;/p&gt;</comment>
                            <comment id="13121545" author="nehanarkhede" created="Wed, 5 Oct 2011 22:27:51 +0000"  >&lt;p&gt;Uploading an updated patch, in which the shutdown latch is decremented in a finally block, to make sure the mirroring threads will shutdown even when they run into an error/exception.&lt;/p&gt;</comment>
                            <comment id="13121558" author="junrao" created="Wed, 5 Oct 2011 22:40:31 +0000"  >&lt;p&gt;+1 on the new patch.&lt;/p&gt;</comment>
                            <comment id="13121572" author="nehanarkhede" created="Wed, 5 Oct 2011 23:03:16 +0000"  >&lt;p&gt;Thanks. Just committed the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12497912" name="KAFKA-145.patch" size="5223" author="nehanarkhede" created="Wed, 5 Oct 2011 22:27:51 +0000"/>
                            <attachment id="12497895" name="KAFKA-145.patch" size="5207" author="nehanarkhede" created="Wed, 5 Oct 2011 21:09:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43962</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i15z5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242995</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>