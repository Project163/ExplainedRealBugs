<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4443] Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4443</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Currently in onControllerFailover(), controller will startup replicaStatemachine and partitionStateMachine before invoking sendUpdateMetadataRequest(controllerContext.liveOrShuttingDownBrokerIds.toSeq). However, if a broker starts right after controller election, the LeaderAndIsrRequest sent to follower partitions on this broker will all be ignored because broker doesn&apos;t know the leaders are alive. &lt;/p&gt;

&lt;p&gt;To fix this problem, in onControllerFailover(), controller should send UpdateMetadataRequest to brokers after initializeControllerContext() but before it starts replicaStatemachine and partitionStateMachine. The first MetadatUpdateRequest will include list of live broker. Although it will not include partition leader information, it is OK because we will always send MetadataUpdateRequest again when we send LeaderAndIsrRequest during replicaStateMachine.startup() and partitionStateMachine.startup().&lt;/p&gt;</description>
                <environment></environment>
        <key id="13023287">KAFKA-4443</key>
            <summary>Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lindong">Dong Lin</assignee>
                                    <reporter username="lindong">Dong Lin</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Fri, 25 Nov 2016 04:20:43 +0000</created>
                <updated>Thu, 1 Dec 2016 15:41:10 +0000</updated>
                            <resolved>Tue, 29 Nov 2016 22:34:43 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15694806" author="githubbot" created="Fri, 25 Nov 2016 04:33:13 +0000"  >&lt;p&gt;GitHub user lindong28 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2168&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2168&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4443&quot; title=&quot;Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4443&quot;&gt;&lt;del&gt;KAFKA-4443&lt;/del&gt;&lt;/a&gt;; Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/lindong28/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lindong28/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4443&quot; title=&quot;Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4443&quot;&gt;&lt;del&gt;KAFKA-4443&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2168.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2168.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2168&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4db70c9e9960c688932dda8d942ee2fedc459e1e&lt;br/&gt;
Author: Dong Lin &amp;lt;lindong28@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-11-25T04:21:50Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4443&quot; title=&quot;Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4443&quot;&gt;&lt;del&gt;KAFKA-4443&lt;/del&gt;&lt;/a&gt;; Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15705851" author="junrao" created="Tue, 29 Nov 2016 16:59:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt;, thanks for filing the jira. A couple of questions. (1) I am not sure that I understand the description in the jira &quot;However, if a broker right after controller election,&quot;. Could you clarify that? (2) Is this the same issue as reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3042&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3042&lt;/a&gt; and is the fix the same? If so, it would be useful to mark the other one as duplicate.&lt;/p&gt;</comment>
                            <comment id="15706039" author="githubbot" created="Tue, 29 Nov 2016 18:04:21 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2168&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2168&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15706867" author="ijuma" created="Tue, 29 Nov 2016 23:13:09 +0000"  >&lt;p&gt;The fix version should be 0.10.2.0, right? The PR was only merged to trunk.&lt;/p&gt;</comment>
                            <comment id="15707330" author="lindong" created="Wed, 30 Nov 2016 02:54:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; Sure. I just updated the description to correct the typo. What I mean is that, if a broker starts right after controller election, the LeaderAndIsrRequest will be ignored because the broker doesn&apos;t have the needed information (e.g. port) of live brokers.&lt;/p&gt;

&lt;p&gt;As for (2), I think this is probably the same issue reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3042&quot; title=&quot;updateIsr should stop after failed several times due to zkVersion issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3042&quot;&gt;KAFKA-3042&lt;/a&gt;. All phenomena described in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3042&quot; title=&quot;updateIsr should stop after failed several times due to zkVersion issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3042&quot;&gt;KAFKA-3042&lt;/a&gt; can be caused by the bug fixed in this JIRA. Actually, you described exactly the same fix applied in this JIRA 7 months ago, i.e. &quot;... to fix this particular issue, the simplest approach is to send UpdateMetadataRequest first during controller failover&quot;.&lt;/p&gt;

&lt;p&gt;As of current design of controller, I prefer the solution where controller sends MetadataUpdateRequest without LeaderAndIsrRequset. Broker will handle MedataDataUpdateRequest in the following steps: 1) update cache with live broker info extracted from MetadataUpdateRequest, 2) reconstruct LeaderAndIsrRequest from MetadataUpdateRequest and process it, and 3) update cache with partition information extracted from MetadataUpdateRequest. This solution is simple and doesn&apos;t require wire protocol change. And it is strictly better than current implementation because we no longer have to send MetadataUpdateRequest before LeaderAndIsrRequest. &lt;/p&gt;

&lt;p&gt;But I am not 100% sure this is long term solution because it relies on existing implementation detail where controller always send MetadataUpdateRequest after LeaderAndIsrRequest. In theory this may not be the case if controller is re-designed. For example, we may want to send MetadataUpdateRequest only after Controller has received LeaderAndIsrResponse with success. The idea is to expose new external state to user only after internal state change is completed.&lt;/p&gt;

&lt;p&gt;If we don&apos;t adopt the solution above which uses MetadataUpateRequest as combination of LeaderAndIsrRequest + MetadataUpdateRequest, then I think we should include endpoints of all leaders in the LeaderAndIsrRequest so that LeaderAndIsrRequest can provide enough information on its own to switch broker between leader and follower.&lt;/p&gt;</comment>
                            <comment id="15708268" author="githubbot" created="Wed, 30 Nov 2016 11:12:32 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2194&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2194&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4443&quot; title=&quot;Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4443&quot;&gt;&lt;del&gt;KAFKA-4443&lt;/del&gt;&lt;/a&gt;: Minor comment clean-up&lt;/p&gt;

&lt;p&gt;    Removed stale comment left behind, minor fixes (UpdateMetadataRequest instead of MetadataUpdateRequest) and remove redundant comments.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-4443-minor-follow-up&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2194.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2194.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2194&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4f299c7280fe52fe1ec4bc690f61038f05c5de04&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2016-11-30T11:12:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4443&quot; title=&quot;Controller should send UpdateMetadataRequest prior to LeaderAndIsrRequest during failover&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4443&quot;&gt;&lt;del&gt;KAFKA-4443&lt;/del&gt;&lt;/a&gt;: Minor comment clean-up&lt;/p&gt;

&lt;p&gt;    Removed stale comment left behind, minor fixes (UpdateMetadataRequest instead of MetadataUpdateRequest)&lt;br/&gt;
    and remove redundant comments.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15712243" author="avermeerbergen" created="Thu, 1 Dec 2016 15:23:55 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Could this fix be back-ported to Kafka 0.9.0.2 please, or better, as a patch for 0.9.0.1 ?&lt;br/&gt;
We had repeated occurrences in the past weeks with Kafka 0.9.0.1&lt;/p&gt;

&lt;p&gt;Best regards,&lt;br/&gt;
Alex&lt;/p&gt;</comment>
                            <comment id="15712288" author="githubbot" created="Thu, 1 Dec 2016 15:41:10 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2194&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2194&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36rnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>