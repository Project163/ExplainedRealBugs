<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16323] Failing test: fix testRemoteFetchExpiresPerSecMetric </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16323</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Refer to &lt;a href=&quot;https://ci-builds.apache.org/job/Kafka/job/kafka/job/trunk/2685/testReport/junit/kafka.server/ReplicaManagerTest/Build___JDK_21_and_Scala_2_13___testRemoteFetchExpiresPerSecMetric__/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Kafka/job/kafka/job/trunk/2685/testReport/junit/kafka.server/ReplicaManagerTest/Build___JDK_21_and_Scala_2_13___testRemoteFetchExpiresPerSecMetric__/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This test is failing, and this ticket aims to address this&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13570621">KAFKA-16323</key>
            <summary>Failing test: fix testRemoteFetchExpiresPerSecMetric </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="johnnyhsu">Johnny Hsu</assignee>
                                    <reporter username="johnnyhsu">Johnny Hsu</reporter>
                        <labels>
                            <label>test-failure</label>
                    </labels>
                <created>Mon, 4 Mar 2024 06:03:58 +0000</created>
                <updated>Mon, 1 Apr 2024 10:26:37 +0000</updated>
                            <resolved>Mon, 1 Apr 2024 02:51:56 +0000</resolved>
                                                    <fixVersion>3.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17828304" author="JIRAUSER304478" created="Tue, 19 Mar 2024 12:17:09 +0000"  >&lt;p&gt;I have added logs to observe and tried to verify some potential causes:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;check whether it really enters the delayed remote fetch&lt;/li&gt;
	&lt;li&gt;check whether it really enters the onExpire() section&lt;/li&gt;
	&lt;li&gt;check whether it succeeds in marking the metrics&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All verified and works as expected.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;, I also tried to add @BeforeAll to the tear down function, which remove all metrics before the test. However it still failed.&#160;&lt;/p&gt;

&lt;p&gt;Need some more tries to find the root causes...&lt;/p&gt;</comment>
                            <comment id="17831291" author="chia7712" created="Wed, 27 Mar 2024 10:46:54 +0000"  >&lt;p&gt;It seems to me the root cause could be the `spy` does not work well. We had met similar issue before - the spied method results in unexpected behavior when we test it in multi-threads. see &lt;a href=&quot;https://github.com/apache/kafka/pull/10006&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/10006&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hence, we can try to fix it by using `override` to replace spied method. for example: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    val latch = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(1)
    val remoteLogManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RemoteLogManager(
      remoteLogManagerConfig,
      0,
      TestUtils.tempRelativeDir(&lt;span class=&quot;code-quote&quot;&gt;&quot;data&quot;&lt;/span&gt;).getAbsolutePath,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;clusterId&quot;&lt;/span&gt;,
      time,
      _ =&amp;gt; Optional.of(dummyLog),
      (TopicPartition, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;) =&amp;gt; {},
      brokerTopicStats) {
      override def read(remoteStorageFetchInfo: RemoteStorageFetchInfo): FetchDataInfo = {
        &lt;span class=&quot;code-comment&quot;&gt;// wait until verification completes
&lt;/span&gt;        latch.await(5000, TimeUnit.MILLISECONDS)
        mock(classOf[FetchDataInfo])
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nr4g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>