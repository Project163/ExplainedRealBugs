<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10471] TimeIndex handling may cause data loss in certain back to back failure</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10471</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;ol&gt;
	&lt;li&gt;Active segment for log A going clean shutdown - trim the time index to the latest fill value, set the clean shutdown marker.&lt;/li&gt;
	&lt;li&gt;Broker restarts, loading logs - no recovery due to clean shutdown marker, log A recovers with the previous active segment as current. It also resized the TimeIndex to the max.&lt;/li&gt;
	&lt;li&gt;&#160;Before all the log loads, the broker had a hard shutdown causing a clean shutdown marker left as is.&lt;/li&gt;
	&lt;li&gt;&#160;Broker restarts, log A skips recovery due to the presence of a clean shutdown marker but the TimeIndex file assumes the resized file from the previous instance is all full (it assumes either file is newly created or is full with valid value).&lt;/li&gt;
	&lt;li&gt;The first append to the active segment will result in roll and TimeIndex will be rolled with the timestamp value of the last valid entry (0)&lt;/li&gt;
	&lt;li&gt;Segment&apos;s largest timestamp gives 0 (this can cause premature deletion of data due to retention.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13326557">KAFKA-10471</key>
            <summary>TimeIndex handling may cause data loss in certain back to back failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ramanverma">Raman Verma</assignee>
                                    <reporter username="rshekhar">Rohit Shekhar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Sep 2020 21:03:11 +0000</created>
                <updated>Tue, 15 Jun 2021 01:39:29 +0000</updated>
                            <resolved>Mon, 2 Nov 2020 21:09:01 +0000</resolved>
                                                    <fixVersion>2.8.0</fixVersion>
                                    <component>core</component>
                    <component>log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17192492" author="junrao" created="Tue, 8 Sep 2020 21:39:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rshekhar&quot; class=&quot;user-hover&quot; rel=&quot;rshekhar&quot;&gt;rshekhar&lt;/a&gt;: Thanks for reporting this. This is a very good finding. If the TimeIndex doesn&apos;t start in a clean state, it can cause multiple things to go wrong afterward.&lt;/p&gt;

&lt;p&gt;One way to fix this issue is to check the presence of the clean shutdown file in LogManager.loadLogs() before loading each individual log. We  then delete the clean shutdown file and pass a clean shutdown flag to Log and use that in Log.recoverLog(). That way, in step 4 above, the TimeIndex will be rebuilt properly.&lt;/p&gt;</comment>
                            <comment id="17192494" author="dhruvilshah" created="Tue, 8 Sep 2020 21:46:02 +0000"  >&lt;p&gt;It may be nice to use the time index sanity check to catch issues where an index file is not in a state we expect. We used to perform a sanity check for indices associated with all segments, but with the changes to load segments lazily, we dropped those checks. If we could reintroduce those checks back safely, that may be sufficient to catch and fix such cases. We are taking a similar approach in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-10207&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-10207&lt;/a&gt;,&#160;so that might help here too.&lt;/p&gt;</comment>
                            <comment id="17192503" author="junrao" created="Tue, 8 Sep 2020 21:59:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dhruvilshah&quot; class=&quot;user-hover&quot; rel=&quot;dhruvilshah&quot;&gt;dhruvilshah&lt;/a&gt; : I agree that the sanity check in the index file is useful to catch bugs like this. For this particular bug, the root cause is that the clean shutdown file doesn&apos;t reflect the actual on-disk state correctly. So, it would be useful to fix that directly too.&lt;/p&gt;</comment>
                            <comment id="17192504" author="rshekhar" created="Tue, 8 Sep 2020 22:00:40 +0000"  >&lt;p&gt;+1 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&#160;will detect unclean shutdown more reliably.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dhruvilshah&quot; class=&quot;user-hover&quot; rel=&quot;dhruvilshah&quot;&gt;dhruvilshah&lt;/a&gt;&#160;agree with your comment too, just not sure the cost of it during the log load time, so can we do a sanity test in a lazy fashion too?&lt;/p&gt;</comment>
                            <comment id="17206054" author="ramanverma" created="Fri, 2 Oct 2020 09:08:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/9364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9364&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17224956" author="junrao" created="Mon, 2 Nov 2020 21:09:01 +0000"  >&lt;p&gt;merged the PR to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ifi8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>