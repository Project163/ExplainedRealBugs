<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16319] Wrong broker destinations for DeleteRecords requests when more than one topic is involved and the topics/partitions are led by different brokers</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16319</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Context&quot;&gt;&lt;/a&gt;Context&lt;/h2&gt;

&lt;p&gt;Kafka streams applications send, time after time, &lt;tt&gt;DeleteRecords&lt;/tt&gt; requests, via &lt;tt&gt;org.apache.kafka.streams.processor.internals.TaskManager#maybePurgeCommittedRecords&lt;/tt&gt; method. Such requests may involve more than 1 topic (or partition), and such requests are supposed to be sent to partitions&apos; leaders brokers.&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Observedbehaviour&quot;&gt;&lt;/a&gt;Observed behaviour&lt;/h2&gt;

&lt;p&gt;In case when &lt;tt&gt;DeleteRecords&lt;/tt&gt; request includes more than one topic (let&apos;s say 2 - &lt;tt&gt;topic1&lt;/tt&gt; and &lt;tt&gt;topic2&lt;/tt&gt;), and these topics are led by different brokers (let&#8217;s say &lt;tt&gt;broker1&lt;/tt&gt; and &lt;tt&gt;broker2&lt;/tt&gt;&#160;respectively), the request is sent to only one broker (let&#8217;s say &lt;tt&gt;broker1&lt;/tt&gt;), leading to partial&#160;not_leader_or_follower errors. As not the whole request was successful (&lt;tt&gt;topic1&lt;/tt&gt; is fine, but &lt;tt&gt;topic2&lt;/tt&gt;&#160;is not), it gets retried, with the &lt;em&gt;same&lt;/em&gt; arguments, to the &lt;em&gt;same&lt;/em&gt; broker (&lt;tt&gt;broker1&lt;/tt&gt;), meaning the response will be partially faulty again and again. It also may (and does) happen that there is a &#8220;mirrored&#8221; half-faulty request - in this case, to &lt;tt&gt;broker2&lt;/tt&gt;, where &lt;tt&gt;topic2&lt;/tt&gt; operation is successful, but &lt;tt&gt;topic1&lt;/tt&gt; operation fails.&lt;/p&gt;

&lt;p&gt;Here&#8217;s an anonymised logs example from a production system (&#8220;direct&#8221; and &#8220;mirrored&#8221; requests, one after another):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[AdminClient clientId=worker-admin]
Sending DeleteRecordsRequestData(topics=[
  DeleteRecordsTopic(
    name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic1&apos;&lt;/span&gt;,
    partitions=[DeleteRecordsPartition(partitionIndex=5, offset=88017574)]
    ),
  DeleteRecordsTopic(
    name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic2&apos;&lt;/span&gt;,
    partitions=[DeleteRecordsPartition(partitionIndex=5, offset=243841)]
)], timeoutMs=60000)
to broker1:PORT (id: 2 rack: RACK1). &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- Note the broker, it&apos;s broker1
&lt;/span&gt;correlationId=42003907, timeoutMs=30000

[AdminClient clientId=worker-admin]
Sending DeleteRecordsRequestData(topics=[
  DeleteRecordsTopic(
    name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic1&apos;&lt;/span&gt;,
    partitions=[DeleteRecordsPartition(partitionIndex=5, offset=88017574)]
  ),
  DeleteRecordsTopic(
    name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic2&apos;&lt;/span&gt;,
    partitions=[DeleteRecordsPartition(partitionIndex=5, offset=243841)]
)], timeoutMs=60000)
to broker2:9098 (id: 4 rack: RACK2). &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- Note the broker, here it&apos;s broker2
&lt;/span&gt;correlationId=42003906, timeoutMs=30000 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Such request results in the following response (in this case, only for the &quot;direct&quot; response):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[AdminClient clientId=worker-admin]
Call(
  callName=deleteRecords(api=DELETE_RECORDS),
  deadlineMs=...,
  tries=..., &lt;span class=&quot;code-comment&quot;&gt;// Can be hundreds
&lt;/span&gt;  nextAllowedTryMs=...)
got response DeleteRecordsResponseData(
  throttleTimeMs=0,
  topics=[
    DeleteRecordsTopicResult(
      name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic2&apos;&lt;/span&gt;,
      partitions=[DeleteRecordsPartitionResult(
        partitionIndex=5, lowWatermark=-1, errorCode=6)]), &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- Note the errorCode 6, which is not_leader_or_follower
&lt;/span&gt;    DeleteRecordsTopicResult(
      name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic1&apos;&lt;/span&gt;,
      partitions=[DeleteRecordsPartitionResult(
        partitionIndex=5, lowWatermark=..., errorCode=0)]) &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- Note the errorCode 0, which means the operation was successful
&lt;/span&gt;  ]
) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h2&gt;&lt;a name=&quot;Expectedbehaviour&quot;&gt;&lt;/a&gt;Expected behaviour&lt;/h2&gt;

&lt;p&gt;&lt;tt&gt;DeleteRecords&lt;/tt&gt; requests are sent to corresponding partitions&apos; leaders brokers when more than 1 topic/partition is involved and they are led by different brokers.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Notes&quot;&gt;&lt;/a&gt;Notes&lt;/h2&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;em&gt;presumably&lt;/em&gt;, introduced in 3.6.1 via &lt;a href=&quot;https://github.com/apache/kafka/pull/13760&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/13760&lt;/a&gt; .&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13570504">KAFKA-16319</key>
            <summary>Wrong broker destinations for DeleteRecords requests when more than one topic is involved and the topics/partitions are led by different brokers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="schofielaj">Andrew Schofield</assignee>
                                    <reporter username="alexeyasf">AlexeyASF</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Mar 2024 15:43:42 +0000</created>
                <updated>Thu, 20 Feb 2025 22:26:05 +0000</updated>
                            <resolved>Thu, 7 Mar 2024 15:42:06 +0000</resolved>
                                    <version>3.6.0</version>
                    <version>3.6.1</version>
                    <version>3.7.0</version>
                                    <fixVersion>3.6.2</fixVersion>
                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>admin</component>
                    <component>clients</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17823276" author="schofielaj" created="Mon, 4 Mar 2024 18:10:21 +0000"  >&lt;p&gt;With an AK 3.7 client, I see that the DeleteRecords requests for different leaders are correctly sent to their own respective brokers. So, it&apos;s not as simple as just &quot;DeleteRecords is broken in Kafka&quot;.&lt;/p&gt;</comment>
                            <comment id="17823521" author="JIRAUSER304466" created="Tue, 5 Mar 2024 09:54:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=schofielaj&quot; class=&quot;user-hover&quot; rel=&quot;schofielaj&quot;&gt;schofielaj&lt;/a&gt; Maybe we&apos;re trying a different thing. I&apos;ve just tried 3.7 client, and still experience the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[AdminClient clientId=...-worker2-admin] Call(callName=deleteRecords(api=DELETE_RECORDS), deadlineMs=1709631680871, tries=64, nextAllowedTryMs=1709631680616) got response DeleteRecordsResponseData(throttleTimeMs=0, topics=[DeleteRecordsTopicResult(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic1&apos;&lt;/span&gt;, partitions=[DeleteRecordsPartitionResult(partitionIndex=5, lowWatermark=-1, errorCode=6)]), DeleteRecordsTopicResult(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;topic2&apos;&lt;/span&gt;, partitions=[DeleteRecordsPartitionResult(partitionIndex=5, lowWatermark=71227289, errorCode=0)])]) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note &lt;tt&gt;errorCode=6&lt;/tt&gt; for &lt;tt&gt;topic1&lt;/tt&gt; and &lt;tt&gt;errorCode=0&lt;/tt&gt; for &lt;tt&gt;topic2&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17823653" author="schofielaj" created="Tue, 5 Mar 2024 14:48:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexeyasf&quot; class=&quot;user-hover&quot; rel=&quot;alexeyasf&quot;&gt;alexeyasf&lt;/a&gt; How do you get it to do that? Do you have a small test program and instructions for setting up the cluster to make it happen? I&apos;m sure I can fix it if only I can make it fail &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; For one thing, I would add a test that fails without the fix and then succeeds when the code has been fixed so having a pointer would be helpful.&lt;/p&gt;</comment>
                            <comment id="17823706" author="schofielaj" created="Tue, 5 Mar 2024 16:52:43 +0000"  >&lt;p&gt;I have reproduced it. Certainly fails like this on 3.6.0.&lt;/p&gt;</comment>
                            <comment id="17823723" author="JIRAUSER304466" created="Tue, 5 Mar 2024 17:35:42 +0000"  >&lt;p&gt;&lt;cite&gt;How do you get it to do that? Do you have a small test program and instructions for setting up the cluster to make it happen? I&apos;m sure I can fix it if only I can make it fail &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;For one thing, I would add a test that fails without the fix and then succeeds when the code has been fixed so having a pointer would be helpful.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;That&apos;s all a great idea, but, unfortunately, no, i haven&apos;t yet created a minimalistic test setup.&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;I have reproduced it. Certainly fails like this on 3.6.0.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=schofielaj&quot; class=&quot;user-hover&quot; rel=&quot;schofielaj&quot;&gt;schofielaj&lt;/a&gt; Did you have a chance already to add a minimalistic test for this? If you did / you are on it already, i&apos;d like to avoid duplicated work, but if you&apos;re haven&apos;t started yet - i can give it a shot 2-3 hours later.&lt;/p&gt;</comment>
                            <comment id="17823755" author="schofielaj" created="Tue, 5 Mar 2024 19:52:17 +0000"  >&lt;p&gt;No worries. My initial assessment was incorrect. The code was broken in 3.6.0 and was still broken in trunk. I&apos;ve submitted a fix.&lt;/p&gt;

&lt;p&gt;Essentially, every broker was being sent every topic-partition, even ones that it didn&apos;t lead. So, the kafka-delete-records.sh tool was working because overall the KafkaAdmin.deleteRecords request was working, but the bad error codes were being masked/ignored.&lt;/p&gt;</comment>
                            <comment id="17823757" author="JIRAUSER304466" created="Tue, 5 Mar 2024 20:00:02 +0000"  >&lt;p&gt;Great news, thank you very much for quick reaction! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nqeg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>