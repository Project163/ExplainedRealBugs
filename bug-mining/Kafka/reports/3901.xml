<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17112] StreamThread shutdown calls completeShutdown only in CREATED state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17112</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;While running tests in `StreamThreadTest.java` in kafka/streams, I noticed the test left many&#160;lingering threads. Though the class runs `shutdown` after each test, the shutdown only executes `completeShutdown` if the StreamThread is in CREATED state. See&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/0b11971f2c94f7aadc3fab2c51d94642065a72e5/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java#L231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0b11971f2c94f7aadc3fab2c51d94642065a72e5/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java#L231&lt;/a&gt;&#160;and&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/0b11971f2c94f7aadc3fab2c51d94642065a72e5/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L1435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/0b11971f2c94f7aadc3fab2c51d94642065a72e5/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java#L1435&lt;/a&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
For example, you may run test&#160;org.apache.kafka.streams.processor.internals.StreamThreadTest#shouldNotCloseTaskProducerWhenSuspending with commit&#160;0b11971f2c94f7aadc3fab2c51d94642065a72e5. When the test calls `thread.shutdown()`, the thread is in `PARTITIONS_REVOKED` state. Thus, `completeShutdown` is not called. The test creates three lingering threads: 2 `StateUpdater` and 1 `TaskExecutor`&lt;br/&gt;
&#160;&lt;br/&gt;
This means that calls to `thread.shutdown` has no effect in `StreamThreadTest.java`.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13585344">KAFKA-17112</key>
            <summary>StreamThread shutdown calls completeShutdown only in CREATED state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aoli-al">Ao Li</assignee>
                                    <reporter username="aoli-al">Ao Li</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Jul 2024 17:05:52 +0000</created>
                <updated>Mon, 28 Oct 2024 13:34:44 +0000</updated>
                            <resolved>Fri, 23 Aug 2024 03:37:50 +0000</resolved>
                                    <version>3.9.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>streams</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17865048" author="cadonna" created="Thu, 11 Jul 2024 12:48:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aoli-al&quot; class=&quot;user-hover&quot; rel=&quot;aoli-al&quot;&gt;aoli-al&lt;/a&gt; I think you are right. We are leaking the state updater and processing threads in that test. The issue is that when we create the stream thread we create and start the state updater thread and the processing threads. &lt;/p&gt;

&lt;p&gt;Would you be interested to fix this issue?&lt;/p&gt;</comment>
                            <comment id="17865080" author="JIRAUSER306156" created="Thu, 11 Jul 2024 13:50:15 +0000"  >&lt;p&gt;Yes, I&apos;m happy to submit a patch. I&apos;m thinking of two potential fixes: &lt;/p&gt;

&lt;p&gt;1. extend the `shutdown()` method to `shutdown(boolean forceCleanup)`. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shutdown(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; forceCleanup) {
        log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Informed to shut down&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; State oldState = setState(State.PENDING_SHUTDOWN);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldState == State.CREATED || forceCleanup) {
            &lt;span class=&quot;code-comment&quot;&gt;// The thread may not have been started. Take responsibility &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shutting down
&lt;/span&gt;            completeShutdown(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. make `completeShutdown` public and directly call it from the test. &lt;/p&gt;

&lt;p&gt;Which one do you think is better?&lt;/p&gt;</comment>
                            <comment id="17865553" author="cadonna" created="Fri, 12 Jul 2024 17:35:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aoli-al&quot; class=&quot;user-hover&quot; rel=&quot;aoli-al&quot;&gt;aoli-al&lt;/a&gt; I think it would be better to change where the state updater and the processing threads are started. I am not sure why we start the threads before we start the stream thread. If we start those threads in the same location where we start the stream thread, we should not need to change anything in our shutdown logic to not leak threads in tests.&lt;/p&gt;</comment>
                            <comment id="17865569" author="JIRAUSER306156" created="Fri, 12 Jul 2024 19:08:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt; Aren&apos;t stateUpdater and processingThread expected to be started in some tests since the parameterized tests control them.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Parameter(0)
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; stateUpdaterEnabled = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

    @Parameter(1)
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; processingThreadsEnabled = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

    @Parameters
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; data() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Arrays.asList(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[][] {
            {&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}, {&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}, {&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;}
        });
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and here &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; StateUpdater maybeCreateAndStartStateUpdater(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; stateUpdaterEnabled,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsMetricsImpl streamsMetrics,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsConfig streamsConfig,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Consumer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; restoreConsumer,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ChangelogReader changelogReader,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TopologyMetadata topologyMetadata,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Time time,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clientId,
                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; threadIdx) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stateUpdaterEnabled) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = clientId + &lt;span class=&quot;code-quote&quot;&gt;&quot;-StateUpdater-&quot;&lt;/span&gt; + threadIdx;
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StateUpdater stateUpdater = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultStateUpdater(
                name,
                streamsMetrics.metricsRegistry(),
                streamsConfig,
                restoreConsumer,
                changelogReader,
                topologyMetadata,
                time
            );
            stateUpdater.start();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; stateUpdater;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17865670" author="cadonna" created="Sat, 13 Jul 2024 11:10:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aoli-al&quot; class=&quot;user-hover&quot; rel=&quot;aoli-al&quot;&gt;aoli-al&lt;/a&gt; Yes, but I guess they are only expected to be started in tests that also start the stream thread. So ideally, the processing thread and the state updater thread should be started when the stream thread is started. I haven&apos;t double checked my assumption.&lt;/p&gt;</comment>
                            <comment id="17865693" author="JIRAUSER306156" created="Sat, 13 Jul 2024 14:26:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt;Thanks for your reply! I&apos;ve tried moving `stateUpdater.start();` to `StreamThread::start`. This does not work for many tests because the `StreamTread::start` is never called. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shouldLogAndRecordSkippedRecordsForInvalidTimestamps() {
        internalTopologyBuilder.addSource(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;source1&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, topic1);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Properties properties = configProps(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        properties.setProperty(
            StreamsConfig.DEFAULT_TIMESTAMP_EXTRACTOR_CLASS_CONFIG,
            LogAndSkipOnInvalidTimestamp.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName()
        );
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsConfig config = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamsConfig(properties);
        thread = createStreamThread(CLIENT_ID, config);

        thread.setState(StreamThread.State.STARTING);
        thread.setState(StreamThread.State.PARTITIONS_REVOKED);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TaskId task1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskId(0, t1p1.partition());
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;TopicPartition&amp;gt; assignedPartitions = Collections.singleton(t1p1);
        thread.taskManager().handleAssignment(
            Collections.singletonMap(
                task1,
                assignedPartitions),
            emptyMap());

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MockConsumer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; mockConsumer = (MockConsumer&amp;lt;&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;) thread.mainConsumer();
        mockConsumer.assign(Collections.singleton(t1p1));
        mockConsumer.updateBeginningOffsets(Collections.singletonMap(t1p1, 0L));
        thread.rebalanceListener().onPartitionsAssigned(assignedPartitions);
        runOnce();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we move `stateUpdater.start();` to `StreamThread::start`, they will hang because they may wait for stateUpdater. I also tried to replace all `thread.setState(StreamThread.State.STARTING);` with `thread.start();` to see if it is an easy fix, but it also breaks many tests. &lt;/p&gt;

&lt;p&gt;Also, the processingThread (TaskExecutor) is created in `StreamThread::create` and then passed to `TaskManager`, and StreamThread will lose its access after the StreamThread::creat call. This could be fixed easily by implementing a start method in TaskManager.&lt;/p&gt;</comment>
                            <comment id="17865978" author="cadonna" created="Mon, 15 Jul 2024 09:20:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aoli-al&quot; class=&quot;user-hover&quot; rel=&quot;aoli-al&quot;&gt;aoli-al&lt;/a&gt; I think a quick fix to get rid of the leaked threads is to shutdown them in the tests by calling &lt;tt&gt;thread.taskmanager().shutdown()&lt;/tt&gt;.&lt;br/&gt;
For the rest, it seems we need to how we start the threads and revisit &lt;tt&gt;StreamThreadTest&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17868965" author="JIRAUSER306156" created="Fri, 26 Jul 2024 15:16:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt;, I&apos;ve submitted a patch. Could you please take a look at it when you have time?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13590189">KAFKA-17432</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 15 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1q9eo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>