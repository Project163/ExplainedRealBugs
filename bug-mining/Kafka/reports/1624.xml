<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:03:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5595] Illegal state in SocketServer; attempt to send with another send in progress</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5595</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have seen this a couple times, but I&apos;m not sure the conditions associated with it. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalStateException: Attempt to begin a send operation with prior send operation still in progress.
	at org.apache.kafka.common.network.KafkaChannel.setSend(KafkaChannel.java:138)
	at org.apache.kafka.common.network.Selector.send(Selector.java:248)
	at kafka.network.Processor.sendResponse(SocketServer.scala:488)
	at kafka.network.Processor.processNewResponses(SocketServer.scala:466)
	at kafka.network.Processor.run(SocketServer.scala:431)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Prior to this event, I see a lot of this message in the logs (always for the same connection id):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Attempting to send response via channel &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; which there is no open connection, connection id 7
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13087268">KAFKA-5595</key>
            <summary>Illegal state in SocketServer; attempt to send with another send in progress</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Jul 2017 18:25:19 +0000</created>
                <updated>Fri, 25 Aug 2017 08:27:22 +0000</updated>
                            <resolved>Fri, 25 Aug 2017 08:27:22 +0000</resolved>
                                                    <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16087745" author="hachikuji" created="Fri, 14 Jul 2017 18:25:50 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; In case you have any ideas.&lt;/p&gt;</comment>
                            <comment id="16087749" author="ijuma" created="Fri, 14 Jul 2017 18:33:07 +0000"  >&lt;p&gt;I haven&apos;t checked this in detail, but a possibility:&lt;/p&gt;

&lt;p&gt;1. There is an inflight response for client c&lt;br/&gt;
2. There is a disconnection and reconnection from client c causing us to lose the channel state&lt;br/&gt;
3. Client c sends another request&lt;br/&gt;
4. Because we lost the channel state and we don&apos;t drain the response queue on disconnections, we may allow 2 inflight responses for the same connection&lt;br/&gt;
5. Under the right set of circumstances, this could lead to the IllegalStateException reported&lt;/p&gt;

&lt;p&gt;Am I missing something?&lt;/p&gt;</comment>
                            <comment id="16087916" author="rsivaram" created="Fri, 14 Jul 2017 19:46:04 +0000"  >&lt;p&gt;Connection id contains remote port, it is currently logging processor id, hence the integer value 7 in the logs. I have submitted a PR to fix that.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Since connection id contains remote port, for the scenario you described, the port needs to get reused. Typically that shouldn&apos;t happen while still processing requests of an older connection using that port. In theory, I suppose it could happen if there lots of connections being created and closed.&lt;/p&gt;
</comment>
                            <comment id="16087999" author="ijuma" created="Fri, 14 Jul 2017 20:30:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;, this is a pretty rare case, we only saw two log entries for the ISE after a lot of log entries for closed channels. Also, the kernel tends to favour reusing ports that have just been released (based on our experience with port conflicts in tests). So, I think it seems possible, although I am not sure.&lt;/p&gt;</comment>
                            <comment id="16088601" author="githubbot" created="Sat, 15 Jul 2017 13:36:27 +0000"  >&lt;p&gt;GitHub user rajinisivaram opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3530&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5595&quot; title=&quot;Illegal state in SocketServer; attempt to send with another send in progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5595&quot;&gt;&lt;del&gt;KAFKA-5595&lt;/del&gt;&lt;/a&gt;: Ensure client connection ids are not reused too quickly&lt;/p&gt;

&lt;p&gt;    On the broker, if client ports are reused when response to a closed connection is outstanding, broker may send the outstanding response to a new connection with the reused port. The new connection will end up with correlation id mismatch, requiring process restart. This is also a security exposure since clients receive response intended for the wrong connection.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rajinisivaram/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rajinisivaram/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5595&quot; title=&quot;Illegal state in SocketServer; attempt to send with another send in progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5595&quot;&gt;&lt;del&gt;KAFKA-5595&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3530.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3530.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3530&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f1f42bcb57e77cd0841b588ae91cee457ba07832&lt;br/&gt;
Author: Rajini Sivaram &amp;lt;rajinisivaram@googlemail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-15T13:01:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5595&quot; title=&quot;Illegal state in SocketServer; attempt to send with another send in progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5595&quot;&gt;&lt;del&gt;KAFKA-5595&lt;/del&gt;&lt;/a&gt;: Ensure client connection ids are not reused too quickly&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16089093" author="githubbot" created="Sun, 16 Jul 2017 19:50:00 +0000"  >&lt;p&gt;Github user rajinisivaram closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3530&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16089098" author="rsivaram" created="Sun, 16 Jul 2017 19:58:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; I dont think the scenario that you described can occur. Broker mutes connections when requests are processed. Even if client disconnected, the disconnection would be processed only when the response was ready to be sent. And response is sent before any disconnections are processed.&lt;/p&gt;</comment>
                            <comment id="16089137" author="rsivaram" created="Sun, 16 Jul 2017 21:22:06 +0000"  >&lt;p&gt;I think this issue can occur when idle connections are closed by the broker. This would cause the channel to be removed when responses are still pending. And if ports are reused, it can result in the IllegalStateException.&lt;/p&gt;</comment>
                            <comment id="16089143" author="githubbot" created="Sun, 16 Jul 2017 21:31:57 +0000"  >&lt;p&gt;GitHub user rajinisivaram reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3530&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5595&quot; title=&quot;Illegal state in SocketServer; attempt to send with another send in progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5595&quot;&gt;&lt;del&gt;KAFKA-5595&lt;/del&gt;&lt;/a&gt;: Ensure client connection ids are not reused too quickly&lt;/p&gt;

&lt;p&gt;    When there are broker delays that cause a response to take longer than `connections.max.idle.ms`, connections may be closed by the broker (as well as by the client) before the response is processed.&lt;br/&gt;
    If the port is reused, broker may send the outstanding response to a new connection with the reused port. The new connection will end up with correlation id mismatch, requiring process restart. This is also a security exposure since clients receive response intended for the wrong connection.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rajinisivaram/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rajinisivaram/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5595&quot; title=&quot;Illegal state in SocketServer; attempt to send with another send in progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5595&quot;&gt;&lt;del&gt;KAFKA-5595&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3530.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3530.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3530&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 99f3374b5c3b0cb5efcdfe4c553aac943297b016&lt;br/&gt;
Author: Rajini Sivaram &amp;lt;rajinisivaram@googlemail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-15T13:01:47Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5595&quot; title=&quot;Illegal state in SocketServer; attempt to send with another send in progress&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5595&quot;&gt;&lt;del&gt;KAFKA-5595&lt;/del&gt;&lt;/a&gt;: Ensure client connection ids are not reused too quickly&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16089775" author="ijuma" created="Mon, 17 Jul 2017 12:48:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;, thanks for looking deeper into the issue (my suggestion was just a hunch without having looked at the code in detail). One thing that occurred to me over the weekend is that if we close a KafkaChannel, then it doesn&apos;t seem possible to throw IllegalStateException since the Send is stored in the KafkaChannel itself (and the IllegalStateException is thrown by KafkaChannel.setSend). Isn&apos;t that the case even if the connections are closed because they are idle?&lt;/p&gt;

&lt;p&gt;In any case, it does seem safer to avoid reusing connection ids. Also, we should probably update Selector.connect to check if the channel id is in `closingChannels` and perhaps throw an exception?&lt;/p&gt;</comment>
                            <comment id="16090205" author="hachikuji" created="Mon, 17 Jul 2017 18:12:02 +0000"  >&lt;p&gt;Ensuring connectionId uniqueness is a nice improvement, but I agree with Ismael that it seems unlikely to fix the underlying issue. We may have to be content with Rajini&apos;s logging improvements for now and hope that they will give us some more hints the next time it happens. Seems extremely rare in any case. &lt;/p&gt;

&lt;p&gt;One other data point worth mentioning: I mentioned the &quot;Attempting to send response via channel ...&quot; messages above. In fact, there were about 13K of these messages within 1 second of the illegal state exceptions. &lt;/p&gt;</comment>
                            <comment id="16091282" author="rsivaram" created="Tue, 18 Jul 2017 08:34:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;  I have to admit I didn&apos;t look much deeper into it either. The scenario I was thinking of was where a slow broker closes a few connections because it thinks they are idle. Some connections without port reuse would show the log entry &lt;tt&gt;Attempting to send response via channel for which there is no open connection&lt;/tt&gt;. One connection where the port did get reused will have a new channel.  When the response to the older connection is ready, it would get sent to the newer connection with a channel in selector. And that would throw &lt;tt&gt;IllegalStateException&lt;/tt&gt; if there is already a send outstanding to the newer connection.&lt;/p&gt;

&lt;p&gt;But I hadn&apos;t realized that there were 13K warnings. So I agree this is not the scenario here. &lt;/p&gt;</comment>
                            <comment id="16125907" author="githubbot" created="Mon, 14 Aug 2017 16:18:02 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3530&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16141366" author="ijuma" created="Fri, 25 Aug 2017 08:27:22 +0000"  >&lt;p&gt;I&apos;m going to close this. If we see the issue again, we can reopen it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hjlz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>