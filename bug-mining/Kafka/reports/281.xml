<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-899] LeaderNotAvailableException the first time a new message for a partition is processed.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-899</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I&apos;m porting some unit tests from 0.7.2 to 0.8.0.  The test does the following, all embedded in the same java process:&lt;/p&gt;

&lt;p&gt;&amp;#8211; spins up a zk instance&lt;br/&gt;
&amp;#8211; spins up a kafka server using a fresh log directory&lt;br/&gt;
&amp;#8211; creates a producer and sends a message&lt;br/&gt;
&amp;#8211; creates a high-level consumer and verifies that it can consume the message&lt;br/&gt;
&amp;#8211; shuts down the consumer&lt;br/&gt;
&amp;#8211; stops the kafka server&lt;br/&gt;
&amp;#8211; stops zk&lt;/p&gt;

&lt;p&gt;The test seems to be working fine now, however, I consistently see the following exceptions (which from poking around the mailing list seem to be expected?).  If these are expected, can we suppress the logging of these exceptions, since it clutters the output of tests, and presumably, clutters the logs of the running server/consumers, during clean startup and shutdown......&lt;/p&gt;

&lt;p&gt;When I call producer.send(), I get:&lt;/p&gt;

&lt;p&gt;1071 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; WARN kafka.producer.BrokerPartitionInfo  - Error while fetching metadata 	partition 0	leader: none	replicas: 	isr: 	isUnderReplicated: false for topic partition &lt;span class=&quot;error&quot;&gt;&amp;#91;test-topic,0&amp;#93;&lt;/span&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;class kafka.common.LeaderNotAvailableException&amp;#93;&lt;/span&gt;&lt;br/&gt;
1081 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; WARN kafka.producer.async.DefaultEventHandler  - Failed to collate messages by topic,partition due to&lt;br/&gt;
kafka.common.LeaderNotAvailableException: No leader for any partition&lt;br/&gt;
	at kafka.producer.async.DefaultEventHandler.kafka$producer$async$DefaultEventHandler$$getPartition(DefaultEventHandler.scala:212)&lt;br/&gt;
	at kafka.producer.async.DefaultEventHandler$$anonfun$partitionAndCollate$1.apply(DefaultEventHandler.scala:150)&lt;br/&gt;
	at kafka.producer.async.DefaultEventHandler$$anonfun$partitionAndCollate$1.apply(DefaultEventHandler.scala:148)&lt;br/&gt;
	at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:57)&lt;br/&gt;
	at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:43)&lt;br/&gt;
	at kafka.producer.async.DefaultEventHandler.partitionAndCollate(DefaultEventHandler.scala:148)&lt;br/&gt;
	at kafka.producer.async.DefaultEventHandler.dispatchSerializedData(DefaultEventHandler.scala:94)&lt;br/&gt;
	at kafka.producer.async.DefaultEventHandler.handle(DefaultEventHandler.scala:72)&lt;br/&gt;
	at kafka.producer.Producer.send(Producer.scala:74)&lt;br/&gt;
	at kafka.javaapi.producer.Producer.send(Producer.scala:32)&lt;br/&gt;
	at com.squareup.kafka.server.KafkaServerTest.produceAndConsumeMessage(KafkaServerTest.java:98)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)&lt;br/&gt;
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)&lt;br/&gt;
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)&lt;br/&gt;
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)&lt;br/&gt;
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)&lt;br/&gt;
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:69)&lt;br/&gt;
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:48)&lt;br/&gt;
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)&lt;br/&gt;
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)&lt;br/&gt;
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)&lt;br/&gt;
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)&lt;br/&gt;
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)&lt;br/&gt;
	at org.junit.runners.ParentRunner.run(ParentRunner.java:292)&lt;br/&gt;
	at org.junit.runner.JUnitCore.run(JUnitCore.java:157)&lt;br/&gt;
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:77)&lt;br/&gt;
	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:195)&lt;br/&gt;
	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:63)&lt;br/&gt;
1133 &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-request-handler-1&amp;#93;&lt;/span&gt; WARN kafka.server.HighwaterMarkCheckpoint  - No highwatermark file is found. Returning 0 as the highwatermark for partition &lt;span class=&quot;error&quot;&gt;&amp;#91;test-topic,0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	...&lt;br/&gt;
        ...&lt;/p&gt;

&lt;p&gt;It would be great if instead of this exception, it would just log a meaningful message, like:&lt;/p&gt;

&lt;p&gt;&quot;No leader was available for partition X, one will now be created&quot;&lt;/p&gt;

&lt;p&gt;Jason&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646751">KAFKA-899</key>
            <summary>LeaderNotAvailableException the first time a new message for a partition is processed.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="jbrosenberg">Jason Rosenberg</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 May 2013 05:18:20 +0000</created>
                <updated>Wed, 1 Oct 2014 23:01:39 +0000</updated>
                            <resolved>Fri, 31 May 2013 05:18:20 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.2.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13653331" author="junrao" created="Thu, 9 May 2013 22:40:44 +0000"  >&lt;p&gt;Attach a patch. Jason, could you give it a try?&lt;/p&gt;</comment>
                            <comment id="13669383" author="junrao" created="Wed, 29 May 2013 16:19:20 +0000"  >&lt;p&gt;Attach patch v2 after the rebase.&lt;/p&gt;</comment>
                            <comment id="13669404" author="nehanarkhede" created="Wed, 29 May 2013 16:35:03 +0000"  >&lt;p&gt;Thanks for the patch!&lt;/p&gt;

&lt;p&gt;1. Another place where we can make it easier for the user to know the reason for the send failure -&lt;/p&gt;

&lt;p&gt;            error(&quot;Produce request with correlation id %d failed due to response %s. List of failed topic partitions is %s&quot;&lt;br/&gt;
              .format(currentCorrelationId, response.toString, failedTopicPartitions.mkString(&quot;,&quot;)))&lt;/p&gt;

&lt;p&gt;Here, we print the entire response. Rather we should only print the partition and corresponding error status for partitions with non-zero error code&lt;/p&gt;

&lt;p&gt;2. When we do print the error status above, we should print the text name of the error instead of the integer error code. For this, we can override toString() in ProducerResponseStatus.&lt;/p&gt;</comment>
                            <comment id="13669950" author="junrao" created="Thu, 30 May 2013 01:21:51 +0000"  >&lt;p&gt;Thanks for the review. Attach patch v3 that addresses the above issue. Changed the logging level from error to warning since the real error will be reported when all retries have failed.&lt;/p&gt;</comment>
                            <comment id="13670916" author="nehanarkhede" created="Thu, 30 May 2013 22:51:01 +0000"  >&lt;p&gt;+1 on the latest patch&lt;/p&gt;</comment>
                            <comment id="13671176" author="junrao" created="Fri, 31 May 2013 05:18:20 +0000"  >&lt;p&gt;Thanks for the review. Committed to 0.8 after fixing a bug and a typo.&lt;/p&gt;</comment>
                            <comment id="14150648" author="andras hatvani" created="Sat, 27 Sep 2014 16:09:10 +0000"  >&lt;p&gt;This isn&apos;t fixed in 0.8.1.1 as the behavior is the same.&lt;/p&gt;

&lt;p&gt;As a workaround increase retry.backoff.ms from the default 100 ms to 1000 ms.&lt;br/&gt;
In case this would be not enough for you, you can try to change the values of &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;message.send.max.retries from the default 5 to e.g. 10 and&lt;/li&gt;
	&lt;li&gt;topic.metadata.refresh.interval.ms to 0.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is the expected behavior, therefore an exception mustn&apos;t be thrown, rather it has to be communicated that the leader election is in progress. Furthermore, suggestions regarding changing the values variables I mentioned should be mandatory.&lt;/p&gt;</comment>
                            <comment id="14151245" author="junrao" created="Sun, 28 Sep 2014 22:08:42 +0000"  >&lt;p&gt;This fix actually wasn&apos;t included in 0.8.1. Changed the fix version in the jira.&lt;/p&gt;</comment>
                            <comment id="14151709" author="andras hatvani" created="Mon, 29 Sep 2014 14:12:01 +0000"  >&lt;p&gt;Jun, can I do any support regarding this issue (e.g. verify the implementation)?&lt;/p&gt;</comment>
                            <comment id="14151847" author="junrao" created="Mon, 29 Sep 2014 16:08:54 +0000"  >&lt;p&gt;Andras,&lt;/p&gt;

&lt;p&gt;It seems that your issue is a bit different from this jira. This jira is about removing the stacktrace in the producer log when the metadata is not available. Your issue seems to be that the metadata is not propagated as quickly as you expect. Normally, 100ms should be long enough for a new topic to be created and its metadata be propagated to all brokers. In your case, it seems that process takes more than 1 sec. Could you look at the controller and the state-change log to see where the delay is? For example, is the write to ZK slow or is the propagation of metadata from the controller to the broker slow?&lt;/p&gt;</comment>
                            <comment id="14151907" author="andras hatvani" created="Mon, 29 Sep 2014 17:11:47 +0000"  >&lt;p&gt;Jun,&lt;/p&gt;

&lt;p&gt;Although the reasons may be different, the objective is identical (see my last post in the thread &quot;LeaderNotAvailableException, although leader elected&quot; on the Kafka user mailing list): There shouldn&apos;t be any exception in case no leader can be communicated to the producer (whether it&apos;s because metadata propagation delay or non-completed leader election or any other valid non-erroneous cause), but rather a status message enabling the producer to be tuned.&lt;br/&gt;
This exception should really only cover exceptional cases. &lt;/p&gt;

&lt;p&gt;But you&apos;re right, my case will exactly be covered by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1494&quot; title=&quot;Failed to send messages after 3 tries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1494&quot;&gt;&lt;del&gt;KAFKA-1494&lt;/del&gt;&lt;/a&gt;. I&apos;ll provide further data in that issue.&lt;/p&gt;</comment>
                            <comment id="14151992" author="junrao" created="Mon, 29 Sep 2014 18:16:36 +0000"  >&lt;p&gt;Andras,&lt;/p&gt;

&lt;p&gt;If a message couldn&apos;t be sent (after all retries), we need to indicate this to the producer client. We currently do that by throwing an exception back to the caller. The caller can decide what to do. Are you suggesting sth else?&lt;/p&gt;</comment>
                            <comment id="14152220" author="andras hatvani" created="Mon, 29 Sep 2014 20:29:12 +0000"  >&lt;p&gt;Jun,&lt;/p&gt;

&lt;p&gt;Yes, I suggest a classification of the server&apos;s response so that the client can distinguish between technical failures (e.g. network unavailable) and functional state (e.g. leader election for partition in progress). For example, a topic&apos;s state could be: non-existent, being created, existent, leader election in progress, failed (and in this case the reason of the failure, like no disk-space). &lt;br/&gt;
Furthermore, in case of topic auto-creation I&apos;d separate and communicate the fact of creation from the message sending and handle the results and failures separately, too.&lt;br/&gt;
Returning a value instead of void would support both mechanisms. What do you think?&lt;/p&gt;</comment>
                            <comment id="14155742" author="junrao" created="Wed, 1 Oct 2014 23:01:39 +0000"  >&lt;p&gt;We started doing that classification in the new java producer. For example, there are certain exceptions are of RetriableException. Transient failures like leader not available are in that category. Exceptions like MessageTooLarge are in a different category. Perhaps you can take a look at that in the new producer and see if that makes sense.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12582535" name="kafka-899.patch" size="5351" author="junrao" created="Thu, 9 May 2013 22:40:44 +0000"/>
                            <attachment id="12585236" name="kafka-899_v2.patch" size="4975" author="junrao" created="Wed, 29 May 2013 16:19:20 +0000"/>
                            <attachment id="12585349" name="kafka-899_v3.patch" size="6558" author="junrao" created="Thu, 30 May 2013 01:21:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327109</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kftz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327453</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>