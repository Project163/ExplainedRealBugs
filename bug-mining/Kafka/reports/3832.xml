<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16954] Move consumer leave operations on close to background thread</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16954</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When a consumer unsubscribes, the app thread simply triggers an Unsubscribe event that will take care of it all in the background thread: release assignment (callbacks), clear assigned partitions, and send leave group HB.&lt;/p&gt;

&lt;p&gt;On the contrary, when a consumer is closed, these actions happen in both threads:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;release assignment -&amp;gt; in the app thread by directly running the callbacks&lt;/li&gt;
	&lt;li&gt;clear assignment -&amp;gt; in app thread by updating the subscriptionState&lt;/li&gt;
	&lt;li&gt;send leave group HB -&amp;gt; in the background thread via an event LeaveOnClose&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This situation could lead to race conditions, mainly because of the close updating the subscription state in the app thread, when other operations in the background could be already running based on it. Ex.&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;unsubscribe in app thread (triggers background UnsubscribeEvent to revoke and leave)&lt;/li&gt;
	&lt;li&gt;unsubscribe fails (ex. interrupted, leaving operation running in the background thread to revoke partitions and leave)&lt;/li&gt;
	&lt;li&gt;consumer close (will revoke and clear assignment in the app thread)&lt;/li&gt;
	&lt;li&gt;&#160;UnsubscribeEvent in the background may fail by trying to revoke partitions that it does not own anymore - &lt;em&gt;No current assignment for partition ...&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A basic check has been added to the background thread revocation to avoid the race condition, ensuring that we only revoke partitions we own, but still we should avoid the root cause, which is updating the assignment on the app thread. We should consider having the close operation as a single LeaveOnClose event handled in the background. That even already takes cares of revoking the partitions and clearing assignment on the background, so no need to take care of it in the app thread. We should only ensure that we processBackgroundEvents until the LeaveOnClose completes (to allow for callbacks to run in the app thread)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Trying to understand the current approach, I imagine the initial motivation to have the callabacks (and assignment cleared) in the app thread was to avoid the back-and-forth: app thread close -&amp;gt; background thread leave event -&amp;gt; app thread to run callback -&amp;gt; background thread to clear assignment and send HB. But updating the assignment on the app thread ends up being problematic, as it mainly happens in the background so it opens up the door for race conditions on the subscription state.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13582600">KAFKA-16954</key>
            <summary>Move consumer leave operations on close to background thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lianetm">Lianet Magrans</assignee>
                                    <reporter username="lianetm">Lianet Magrans</reporter>
                        <labels>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Thu, 13 Jun 2024 20:09:25 +0000</created>
                <updated>Mon, 7 Oct 2024 04:13:44 +0000</updated>
                            <resolved>Tue, 18 Jun 2024 07:02:38 +0000</resolved>
                                                    <fixVersion>3.8.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17855806" author="jlprat" created="Tue, 18 Jun 2024 07:02:38 +0000"  >&lt;p&gt;fixed with &lt;a href=&quot;https://github.com/apache/kafka/pull/16376#issuecomment-2175272676&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/16376#issuecomment-2175272676&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13562063">KAFKA-16022</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13569308">KAFKA-16290</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1psig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>