<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:22:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6647] KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6647</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When calling kafkaStreams.cleanUp() before starting a stream the StateDirectory.cleanRemovedTasks() method contains this check:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
... Line 240
                  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lock(id, 0)) {
                        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; now = time.milliseconds();
                        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; lastModifiedMs = taskDir.lastModified();
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (now &amp;gt; lastModifiedMs + cleanupDelayMs) {
                            log.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} Deleting obsolete state directory {} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task {} as {}ms has elapsed (cleanup delay is {}ms)&quot;&lt;/span&gt;, logPrefix(), dirName, id, now - lastModifiedMs, cleanupDelayMs);
                            Utils.delete(taskDir);
                        }
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The check for lock(id,0) will create a .lock file in the directory that subsequently is going to be deleted. If the .lock file already exists from a previous run the attempt to delete the .lock file fails with AccessDeniedException.&lt;/p&gt;

&lt;p&gt;This leaves the .lock file in the taskDir. Calling Utils.delete(taskDir) will then attempt to remove the taskDir path calling Files.delete(path).&lt;/p&gt;

&lt;p&gt;The call to files.delete(path) in postVisitDirectory will then fail java.nio.file.DirectoryNotEmptyException as the failed attempt to delete the .lock file left the directory not empty. (o.a.k.s.p.internals.StateDirectory       : stream-thread &lt;span class=&quot;error&quot;&gt;&amp;#91;restartedMain&amp;#93;&lt;/span&gt; Failed to lock the state directory due to an unexpected exception)&lt;/p&gt;

&lt;p&gt;This seems to then cause issues using streams from a topic to an inMemory store.&lt;/p&gt;</description>
                <environment>windows 10.&lt;br/&gt;
java version &amp;quot;1.8.0_162&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.8.0_162-b12)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)&lt;br/&gt;
org.apache.kafka:kafka-streams:1.0.1&lt;br/&gt;
Kafka commitId : c0518aa65f25317e</environment>
        <key id="13144789">KAFKA-6647</key>
            <summary>KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="gbloggs">George Bloggs</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Mar 2018 17:10:33 +0000</created>
                <updated>Thu, 29 Dec 2022 00:31:52 +0000</updated>
                            <resolved>Sat, 14 Mar 2020 21:10:11 +0000</resolved>
                                    <version>1.0.1</version>
                                    <fixVersion>2.5.1</fixVersion>
                    <fixVersion>2.6.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>12</votes>
                                    <watches>27</watches>
                                                                                                                <comments>
                            <comment id="16397366" author="yuzhihong@gmail.com" created="Tue, 13 Mar 2018 17:49:52 +0000"  >&lt;p&gt;The above code is paired with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        unlock(id);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where unlock() has:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            lockAndOwner.lock.release();
            log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} Released state dir lock &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task {}&quot;&lt;/span&gt;, logPrefix(), taskId);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Wouldn&apos;t the above get rid of the lock file ?&lt;/p&gt;</comment>
                            <comment id="16397429" author="githubbot" created="Tue, 13 Mar 2018 18:27:38 +0000"  >&lt;p&gt;tedyu opened a new pull request #4702: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory it tries to clean&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4702&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Specify StandardOpenOption#DELETE_ON_CLOSE when creating the FileChannel.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16397437" author="gbloggs" created="Tue, 13 Mar 2018 18:32:08 +0000"  >&lt;p&gt;Hi. It does remove the lock file in the finally block but this is too late as the attempt to delete the directory has failed with the exception as the lock file exists in the directory it&#8217;s trying to delete. &lt;/p&gt;</comment>
                            <comment id="16398119" author="mjsax" created="Wed, 14 Mar 2018 05:46:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbloggs&quot; class=&quot;user-hover&quot; rel=&quot;gbloggs&quot;&gt;gbloggs&lt;/a&gt; Thanks for reporting the issue. What I am wondering is, why there is a .lock file in the task directory in the first place. On a clean shutdown, all lock files should be releases.&lt;/p&gt;

&lt;p&gt;Thus, an existing .lock file indicates, that some thread is actually using the task directory and thus, it should not be deleted (ie, it&apos;s expected that cleanup() fails for this case).&lt;/p&gt;

&lt;p&gt;Also note, a thread can delete a directory even if the directory contains it&apos;s own lock file (because the threads owns this lock).&lt;/p&gt;

&lt;p&gt;Does this make sense?&lt;/p&gt;</comment>
                            <comment id="16398133" author="gbloggs" created="Wed, 14 Mar 2018 06:08:44 +0000"  >&lt;p&gt;Yeah, I can see your thought path. The .lock file is created by the streams process. It seems impossible for the thread attempting to delete the .lock file to do so. On Windows 10, attempting to delete the .lock file throws an AccessDeniedException. &lt;/p&gt;

&lt;p&gt;To repeat, run an app that streams from a topic to an inMemory KTable. Stop the app. The .lock file will remain even if you have cleanup in a shutdownHook. If you attempt to cleanup before a streams.start(), as per docs, it too fails ultimately as it tries to delete the parent directory. The failure is due to the fact the Utils.delete call failed to delete the .lock file so when it attempts to delete the parent directory it fails as the directory is not empty. &lt;/p&gt;

&lt;p&gt;Understand what you are saying about the thread owning the .lock. If no process owns any lock on the .lock then the cleanup process should be able to acquire the lock and delete the file. This isn&#8217;t happening. Give it a whirl. &lt;/p&gt;</comment>
                            <comment id="16399347" author="guozhang" created="Wed, 14 Mar 2018 20:27:28 +0000"  >&lt;p&gt;Hi George,&lt;/p&gt;

&lt;p&gt;By looking into your issue, I think the root cause maybe that there is still some un-closed handle on that file in which Windows 10 would not actually delete the file and hence future attempt to recreate the file will fail with ERROR_ACCESS_DENIED. I&apos;m not an expert in Windows but I find the following may be relevant:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/31606978/odd-behaviour-when-deleting-files-with-files-delete&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/31606978/odd-behaviour-when-deleting-files-with-files-delete&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To verify if that is indeed the case, could you share your code snippet including the shutdown hook implementation for us to try to re-produce in Windows?&lt;/p&gt;

&lt;p&gt;BTW regarding to your PR, changing the state directory structure such as lifting the lock file on level up would not be a backward compatible change, since if users upgrade their streams library version to the one that includes this change their code will be broken. So I&apos;d suggest we hold on the proposed PR and try to investigate further what actually causes &lt;tt&gt;AccessDeniedException&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16399362" author="guozhang" created="Wed, 14 Mar 2018 20:36:32 +0000"  >&lt;p&gt;Just another note, for locking purposes, when the apps shutdown cleanly, it is OK to have the lock file left in the state directory since threads are excluding each other not via the ownership of the file but via locking the file handle. So for your case, if you indeed want to clean up the whole directory upon shutting down, then I think there is still a valid point to close all the file channels upon shutting down. For which we can consider:&lt;/p&gt;

&lt;p&gt;1) either use StandardOpenOption.DELETE_ON_CLOSE as you did in the PR.&lt;br/&gt;
2) or add a new function in the state directory class that closes all the managed file channels upon KafkaStreams.close(); which may be safer than 1) since StandardOpenOption.DELETE_ON_CLOSE is best-effort.&lt;/p&gt;</comment>
                            <comment id="16399532" author="gbloggs" created="Wed, 14 Mar 2018 22:13:14 +0000"  >&lt;p&gt;Guozhang. &lt;/p&gt;

&lt;p&gt;I have not submitted any PRs. I too commented on one PR to say I did not believe it would resolve the issue. Furthermore, I see moving the .lock file to a parent directory is not a full solution. &lt;/p&gt;

&lt;p&gt;In reply to:&lt;/p&gt;

&lt;p&gt;`...By looking into your issue, I think the root cause maybe that there is still some un-closed handle on that file in which Windows 10 would not actually delete the file...`&lt;/p&gt;

&lt;p&gt;I do not believe this is true.  I have patched the issue in our code calling Kafka Utils.delete directly just before performing KafkaStreams.start(). This works. I also believe the issue is happening on Linux. We run our code on a linux instance deploying using ansible. The code is showing the same issues on linux although I am not able to debug it on the linux boxes to prove through.&lt;/p&gt;

&lt;p&gt;I have debugged this on Windows and from what I was able to tell, it is the lock code that is causing the isssue. This is bourne out by the fact that my patch in our code works. &lt;/p&gt;

&lt;p&gt;As further proof that no other process is holding a handle on the file, the parent directory can be deleted through Windows Explorer before KafkaStreams.start() is called. If a handle was being held on the .lock file Windows would prevent the deletion I believe. &lt;/p&gt;

&lt;p&gt;The shutdownHook is not overly important I believe but it simply has 3 ines of code:&lt;/p&gt;

&lt;p&gt;```java&lt;br/&gt;
kafkaStreams.close();&lt;br/&gt;
kafkaStreams.cleanUp();&lt;br/&gt;
LOG.info(&quot;KafkaStream shutdown hook completed&quot;);&lt;br/&gt;
```&lt;br/&gt;
Shutting down the app I see the log message. The dirrectory is not cleaned up.&lt;/p&gt;

&lt;p&gt;We also call kafkaStreams.cleanUp(); on the line &lt;b&gt;BEFORE&lt;/b&gt; kafkaStreams.start() as per documentation.&lt;/p&gt;

&lt;p&gt;`So I&apos;d suggest we hold on the proposed PR and try to investigate further what actually causes AccessDeniedException.` &lt;br/&gt;
I agree. The issue is more subtle than simply moving the .lock file to an alternative location. I am unable to access our GitLab repo at present but will copy my hack to allow our code to work tomorrow. This is merely a hack in our code but using Kafka Utils.delete without using KafkaStreams.cleanUp(). To be clear, I am not stating this is a perfect solution, its a hack to get our code working in the hope a full solution in KafkaStreams.cleanUp() can be found. It works, in the same codebase, with the only difference being my solution goes direct to Utils.delete() without checking the lock. I can do this as there is only one instance of our app running on one instance for now.&lt;/p&gt;</comment>
                            <comment id="16399545" author="mjsax" created="Wed, 14 Mar 2018 22:32:19 +0000"  >&lt;p&gt;I just opened a related PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/4713&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4713&lt;/a&gt;&#160;(stumbled over this while digging into this JIRA). The original code that tries to get the lock&lt;br/&gt;
if (lock(id, 0)) {&lt;br/&gt;
should actually throw. The root cause, why the lock cannot be acquired is still unclear to me though &#8211; thus, I don&apos;t think that my PR is an actual fix for this ticket but an improvement of the behavior in general.&lt;/p&gt;</comment>
                            <comment id="16400125" author="gbloggs" created="Thu, 15 Mar 2018 09:28:24 +0000"  >&lt;p&gt;As mentioned earlier, in our code I have implemented the following and call this directly before kafkaStreams.start(); It works and clears the directory which highlights the issue is within the lock functionality :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void ourCleanUp() {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; File baseDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(streamsConfig.getString(StreamsConfig.STATE_DIR_CONFIG));
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; File stateDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(baseDir, streamsConfig.getString(StreamsConfig.APPLICATION_ID_CONFIG));
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            Utils.delete(stateDir);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Arrgghhhhh!! ourCleanUp failed!&quot;&lt;/span&gt;, e);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16400690" author="mjsax" created="Thu, 15 Mar 2018 16:42:06 +0000"  >&lt;p&gt;As pointed out by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt;, the lock file does not prevent to delete the whole directory &#8211; it&apos;s just a &quot;hint&quot; that a thread is using the directory. Thus, you code works &#8211; however, if there is a running thread using the directory, you would delete the threads used files and the thread would die with an IOException. Thus, our `cleanUp` implementation checks if it can delete the directories safely.&lt;/p&gt;

&lt;p&gt;The question remains, why for your case, the lock files are not release properly... Not sure if this is related &lt;a href=&quot;https://stackoverflow.com/questions/34039846/filechannel-trylock-sometimes-throws-accessdeniedexception&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/34039846/filechannel-trylock-sometimes-throws-accessdeniedexception&lt;/a&gt;&#160;Does the exception you get have a more detailed error message, why the operation is denied?&lt;/p&gt;</comment>
                            <comment id="16400819" author="gbloggs" created="Thu, 15 Mar 2018 17:46:00 +0000"  >&lt;p&gt;I will check this in the morning and update this issue. The SO does look like it describes what I was seeing, but unable to test this this evening as I don&apos;t have access to the code.&lt;/p&gt;</comment>
                            <comment id="16400900" author="guozhang" created="Thu, 15 Mar 2018 18:27:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbloggs&quot; class=&quot;user-hover&quot; rel=&quot;gbloggs&quot;&gt;gbloggs&lt;/a&gt; As explained in the link I posted previously, there is a difference how file systems handle deletes on Linux v.s. Windows. Cross-copying here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Unix deletes the file name immediately, &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; Windows deletes the file name only when the last handle is closed. It however, prevents you from opening a file with the same name until the last handle to the (deleted) file is closed.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16571725" author="pgrabarsky" created="Tue, 7 Aug 2018 14:13:33 +0000"  >&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;I also have this problem on Windows during unit testing on a&#160;&lt;tt&gt;TopologyTestDriver.close()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Having tracked the execution path, what is happening is that&#160;&lt;tt&gt;StateDirectory.cleanRemovedTasks&lt;/tt&gt; is calling &lt;tt&gt;lock(id)&lt;/tt&gt;. This is this last call that is creating a open file handle to the &lt;tt&gt;.lock&lt;/tt&gt; file in the directory to be deleted (&lt;tt&gt;final FileLock lock = tryLock(channel);&lt;/tt&gt; is performed succesfully and also I have seen the rockdb folder being succesfully deleted). The exception is raised at the last stage of the process (to delete the &lt;tt&gt;0_0&lt;/tt&gt; folder in my case).&lt;/p&gt;

&lt;p&gt;As the directory is trying to be deleted before the handle is close there is an exception. I tried to comment the &lt;tt&gt;if (lock(id))&lt;/tt&gt; line and the exception disappeared which seems to confirm this (even if it is not the proper way to fix). Thus I think the lock should just be released before the call to &lt;tt&gt;Utils.delete(taskDir)&lt;/tt&gt; in &lt;tt&gt;StateDirectory.cleanRemovedTasks&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16571897" author="guozhang" created="Tue, 7 Aug 2018 16:07:42 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pgrabarsky&quot; class=&quot;user-hover&quot; rel=&quot;pgrabarsky&quot;&gt;pgrabarsky&lt;/a&gt;, is this a consistently reproducible issue on your machine?&lt;/p&gt;</comment>
                            <comment id="16572130" author="lind" created="Tue, 7 Aug 2018 18:35:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pgrabarsky&quot; class=&quot;user-hover&quot; rel=&quot;pgrabarsky&quot;&gt;pgrabarsky&lt;/a&gt;&#160;this test using TopologyTestDriver, from a Udemy corse, fails on Windows but not on Mac or Linux: &lt;a href=&quot;https://github.com/simplesteph/kafka-streams-course/blob/1.1.0/word-count/src/test/java/com/github/simplesteph/udemy/kafka/streams/WordCountAppTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/simplesteph/kafka-streams-course/blob/1.1.0/word-count/src/test/java/com/github/simplesteph/udemy/kafka/streams/WordCountAppTest.java&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Works on&#160;Windows if using &lt;a href=&quot;https://docs.microsoft.com/en-us/windows/wsl/install-win10#install-the-windows-subsystem-for-linux&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Windows Subsystem for Linux&lt;/a&gt; but not in PowerShell.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16572563" author="guozhang" created="Wed, 8 Aug 2018 02:02:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lind&quot; class=&quot;user-hover&quot; rel=&quot;lind&quot;&gt;lind&lt;/a&gt; Thanks for letting us know! If it is indeed consistent, then &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pgrabarsky&quot; class=&quot;user-hover&quot; rel=&quot;pgrabarsky&quot;&gt;pgrabarsky&lt;/a&gt;&apos;s theory may indeed be true. In this case, we may need to consider &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzhihong%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;yuzhihong@gmail.com&quot;&gt;yuzhihong@gmail.com&lt;/a&gt;&apos;s approach for moving the lock file one level up to not make inside the task directory, in a compatible way.&lt;/p&gt;</comment>
                            <comment id="16572711" author="pgrabarsky" created="Wed, 8 Aug 2018 06:02:05 +0000"  >&lt;p&gt;Hi Guozhang, I confirm the issue is consistently reproducible and, for instance using the Jonas WordCountAppTest, I have also:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO stream-thread [main] Deleting state directory 0_0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 0_0 as user calling cleanup. (org.apache.kafka.streams.processor.internals.StateDirectory:281) 
ERROR stream-thread [main] Failed to delete the state directory. (org.apache.kafka.streams.processor.internals.StateDirectory:297) 
java.nio.file.DirectoryNotEmptyException: \tmp\kafka-streams\test\0_0
 at sun.nio.fs.WindowsFileSystemProvider.implDelete(WindowsFileSystemProvider.java:266)
 at sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:103)
 at java.nio.file.Files.delete(Files.java:1126)
 at org.apache.kafka.common.utils.Utils$1.postVisitDirectory(Utils.java:651)
 at org.apache.kafka.common.utils.Utils$1.postVisitDirectory(Utils.java:634)
 at java.nio.file.Files.walkFileTree(Files.java:2688)
 at java.nio.file.Files.walkFileTree(Files.java:2742)
 at org.apache.kafka.common.utils.Utils.delete(Utils.java:634)
 at org.apache.kafka.streams.processor.internals.StateDirectory.cleanRemovedTasks(StateDirectory.java:287)
 at org.apache.kafka.streams.processor.internals.StateDirectory.clean(StateDirectory.java:228)
 at org.apache.kafka.streams.TopologyTestDriver.close(TopologyTestDriver.java:568)
 at com.github.simplesteph.udemy.kafka.streams.WordCountAppTest.closeTestDriver(WordCountAppTest.java:46)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16572793" author="yuzhihong@gmail.com" created="Wed, 8 Aug 2018 07:22:52 +0000"  >&lt;p&gt;Using the change from pull request 4702, does the test pass ?&lt;br/&gt;
I don&apos;t have access to windows, hence the question. &lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="16572905" author="pgrabarsky" created="Wed, 8 Aug 2018 09:00:24 +0000"  >&lt;p&gt;I re-run &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lind&quot; class=&quot;user-hover&quot; rel=&quot;lind&quot;&gt;lind&lt;/a&gt;&#160;WordCountAppTest based on the 1.2.0-SNAPSHOT build from a checkout of &apos;&lt;tt&gt;git fetch upstream pull/4702/head:windows-fix-cleanup&lt;/tt&gt;&apos; and&#160;it &lt;b&gt;does not anymore throw the exception&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;It looks the fix is fixing!&lt;/p&gt;</comment>
                            <comment id="16596169" author="gfo" created="Wed, 29 Aug 2018 10:13:11 +0000"  >&lt;p&gt;I&#160;have a similar issue too&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-08-29 12:06:34.749 INFO 38968 --- [e-CleanupThread] o.a.k.s.p.internals.StateDirectory : stream-thread [events-step-three-CleanupThread] Deleting obsolete state directory 8_0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 8_0 as 600014ms has elapsed (cleanup delay is 600000ms).
2018-08-29 12:06:34.749 ERROR 38968 --- [e-CleanupThread] o.a.k.s.p.internals.StateDirectory : stream-thread [events-step-three-CleanupThread] Failed to delete the state directory.

java.nio.file.DirectoryNotEmptyException: \tmp\kafka-streams\events-step-three\8_0
at sun.nio.fs.WindowsFileSystemProvider.implDelete(WindowsFileSystemProvider.java:266) ~[na:1.8.0_171]
at sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:103) ~[na:1.8.0_171]
at java.nio.file.Files.delete(Files.java:1126) ~[na:1.8.0_171]
at org.apache.kafka.common.utils.Utils$2.postVisitDirectory(Utils.java:740) ~[kafka-clients-2.0.0.jar:na]
at org.apache.kafka.common.utils.Utils$2.postVisitDirectory(Utils.java:723) ~[kafka-clients-2.0.0.jar:na]
at java.nio.file.Files.walkFileTree(Files.java:2688) ~[na:1.8.0_171]
at java.nio.file.Files.walkFileTree(Files.java:2742) ~[na:1.8.0_171]
at org.apache.kafka.common.utils.Utils.delete(Utils.java:723) ~[kafka-clients-2.0.0.jar:na]
at org.apache.kafka.streams.processor.internals.StateDirectory.cleanRemovedTasks(StateDirectory.java:287) [kafka-streams-2.0.0.jar:na]
at org.apache.kafka.streams.processor.internals.StateDirectory.cleanRemovedTasks(StateDirectory.java:250) [kafka-streams-2.0.0.jar:na]
at org.apache.kafka.streams.KafkaStreams$2.run(KafkaStreams.java:800) [kafka-streams-2.0.0.jar:na]
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_171]
at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308) [na:1.8.0_171]
at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180) [na:1.8.0_171]
at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294) [na:1.8.0_171]
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [na:1.8.0_171]
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [na:1.8.0_171]
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [na:1.8.0_171]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16614177" author="githubbot" created="Fri, 14 Sep 2018 00:09:31 +0000"  >&lt;p&gt;tedyu opened a new pull request #5650: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory it tries to clean&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5650&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Specify StandardOpenOption#DELETE_ON_CLOSE when creating the FileChannel.&lt;/p&gt;

&lt;p&gt;   Move lock file up one level.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16614178" author="githubbot" created="Fri, 14 Sep 2018 00:10:12 +0000"  >&lt;p&gt;tedyu closed pull request #4702: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory it tries to clean&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4702&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16722566" author="sachabarber" created="Sun, 16 Dec 2018 20:28:04 +0000"  >&lt;p&gt;I would also like to add this seems to be caused by the&#160;&lt;/p&gt;

&lt;p&gt;TopologyTestDriver.close&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;if I add a method like this (scala sorry)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def cleanup(props:Properties, testDriver: TopologyTestDriver) = {

 &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160; testDriver.close
 } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Exception =&amp;gt; {
&#160; &#160; &#160; delete(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;C:\\data\\kafka-streams&quot;&lt;/span&gt;))
&#160; &#160; }
&#160; }
}

def delete(file: File) {
&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (file.isDirectory)
&#160; &#160; Option(file.listFiles).map(_.toList).getOrElse(Nil).foreach(delete(_))
&#160; &#160; file.delete
&#160; }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I see the Exception others are talking about above getting caught for the&#160;TopologyTestDriver close() call, But then I just resort to using regular&#160;&lt;/p&gt;

&lt;p&gt;java.io to do the actual delete for my tests. This does get my tests to pass ok, but why cant the Kafka code do this on windows, if my simple tests code works. I read the part about how windows will only delete file on next file assignment, but to my eyes my simple tests using delete worked here, whilst Kafka&#160;TopologyTestDriver close() did not&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am using Windows 10.0, and am using Kafka 2.1.0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And have changed my state directory to this one&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
props.put(StreamsConfig.STATE_DIR_CONFIG, s&lt;span class=&quot;code-quote&quot;&gt;&quot;C:\\data\\kafka-streams&quot;&lt;/span&gt;.asInstanceOf[&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;])

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Any ideas when this will get fixed properly?&lt;/p&gt;</comment>
                            <comment id="16816099" author="githubbot" created="Fri, 12 Apr 2019 08:54:12 +0000"  >&lt;p&gt;jukkakarvanen commented on pull request #6569:  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS) &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6569&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS) has been open for a while, and long conversation in previous Pull Requests. Anyway this problems is causing the TopologyTestDriver driver based unit test failing in Windows if not adding extra exception handling in there.&lt;/p&gt;

&lt;p&gt;   This PR version is trying to keep the general functionality as similar as earlier. Only add one extra retry of delete, if first failed due to DirectoryNotExmptyException. When added the retry logic only at the end of finally, caused checkstyle CyclomaticComplexity and NPathComplexity to go above threshold.&lt;br/&gt;
   After it extracted cleanRemovedTaskDir and deleteTaskDir methods to avoid complexity.&lt;br/&gt;
   Also time condition evaluation changed to be first before locking, so no need to lock if inner block is doing nothing.&lt;/p&gt;


&lt;p&gt;   No external functionality changed, so no additional test cases added.&lt;/p&gt;

&lt;p&gt;   Following five test in StateDirectoryTest failed earlier in Windows.&lt;br/&gt;
   StateDirectoryTest.shouldCleanUpTaskStateDirectoriesThatAreNotCurrentlyLocked&lt;br/&gt;
   StateDirectoryTest.shouldCleanupStateDirectoriesWhenLastModifiedIsLessThanNowMinusCleanupDelay&lt;br/&gt;
   StateDirectoryTest.shouldNotLockStateDirLockedByAnotherThread&lt;br/&gt;
   StateDirectoryTest.shouldNotUnLockStateDirLockedByAnotherThread&lt;br/&gt;
   StateDirectoryTest.shouldCleanupAllTaskDirectoriesIncludingGlobalOne&lt;/p&gt;

&lt;p&gt;   Test shouldNotLockStateDirLockedByAnotherThread is still failing due to&lt;br/&gt;
   there is no way to unlock task of already dead thread without adding extra code to StateDirectory class.&lt;br/&gt;
   The test left as is, but explanatory comment added. The rest four of those five tests are now successful also in Windows.&lt;/p&gt;


&lt;p&gt;   Also shouldUseSerdesDefinedInMaterializedToConsumeGlobalTable test in StreamsBuilderTest failed in Windows before this change. After the change all the tests in StreamsBuilderTest are succesful.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16819731" author="githubbot" created="Wed, 17 Apr 2019 05:18:29 +0000"  >&lt;p&gt;jukkakarvanen commented on pull request #6569:  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS) &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6569&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16819732" author="githubbot" created="Wed, 17 Apr 2019 05:21:28 +0000"  >&lt;p&gt;jukkakarvanen commented on pull request #6569:  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS) &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6569&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS) has been open for a while, and long conversation in previous Pull Requests. Anyway this problems is causing the TopologyTestDriver driver based unit test failing in Windows if not adding extra exception handling in there.&lt;/p&gt;

&lt;p&gt;   This PR version is trying to keep the general functionality as similar as earlier. Only add one extra retry of delete, if first failed due to DirectoryNotExmptyException. When added the retry logic only at the end of finally, caused checkstyle CyclomaticComplexity and NPathComplexity to go above threshold.&lt;br/&gt;
   After it extracted cleanRemovedTaskDir and deleteTaskDir methods to avoid complexity.&lt;br/&gt;
   Also time condition evaluation changed to be first before locking, so no need to lock if inner block is doing nothing.&lt;/p&gt;


&lt;p&gt;   No external functionality changed, so no additional test cases added.&lt;/p&gt;

&lt;p&gt;   Following five test in StateDirectoryTest failed earlier in Windows.&lt;br/&gt;
   StateDirectoryTest.shouldCleanUpTaskStateDirectoriesThatAreNotCurrentlyLocked&lt;br/&gt;
   StateDirectoryTest.shouldCleanupStateDirectoriesWhenLastModifiedIsLessThanNowMinusCleanupDelay&lt;br/&gt;
   StateDirectoryTest.shouldNotLockStateDirLockedByAnotherThread&lt;br/&gt;
   StateDirectoryTest.shouldNotUnLockStateDirLockedByAnotherThread&lt;br/&gt;
   StateDirectoryTest.shouldCleanupAllTaskDirectoriesIncludingGlobalOne&lt;/p&gt;

&lt;p&gt;   Test shouldNotLockStateDirLockedByAnotherThread is still failing due to&lt;br/&gt;
   there is no way to unlock task of already dead thread without adding extra code to StateDirectory class.&lt;br/&gt;
   The test left as is, but explanatory comment added. The rest four of those five tests are now successful also in Windows.&lt;/p&gt;


&lt;p&gt;   Also shouldUseSerdesDefinedInMaterializedToConsumeGlobalTable test in StreamsBuilderTest failed in Windows before this change. After the change all the tests in StreamsBuilderTest are succesful.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16819734" author="githubbot" created="Wed, 17 Apr 2019 05:25:46 +0000"  >&lt;p&gt;jukkakarvanen commented on pull request #6569:  &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS) &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6569&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16856401" author="sebastiaan83" created="Wed, 5 Jun 2019 06:36:07 +0000"  >&lt;p&gt;I also seem to be suffering from this issue. Any updates?&lt;/p&gt;</comment>
                            <comment id="16899894" author="cadonna" created="Mon, 5 Aug 2019 08:29:06 +0000"  >&lt;p&gt;Besides Windows OS, the issue also seems to occur on Linux with the state directory on an NFS filesystem.&lt;/p&gt;</comment>
                            <comment id="16947390" author="shoffmeister" created="Wed, 9 Oct 2019 06:28:55 +0000"  >&lt;p&gt;I have created &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8999&quot; title=&quot;org.apache.kafka.common.utils.Utils.delete masks errors encountered during processing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8999&quot;&gt;KAFKA-8999&lt;/a&gt; to document that the root cause for DirectoryNotEmptyException being raised is masked inside the utility function.&lt;/p&gt;</comment>
                            <comment id="16972597" author="slmingol" created="Tue, 12 Nov 2019 16:33:33 +0000"  >&lt;p&gt;Is there any timeline around getting this resolved in some fashion? The fundamental problem appears to be Kafka relying on the filesystem allowing for delete on close. This &quot;feels like&quot; a design flaw IMO, that Kafka expects the underlying filesystems to behave in this manner.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We&apos;d like to use NFS for PVs in Kubernetes to back Kafka but this inherent flaw is a limiting factor in being able to do this.&lt;/p&gt;</comment>
                            <comment id="17055452" author="guozhang" created="Mon, 9 Mar 2020 23:05:59 +0000"  >&lt;p&gt;I looked at this ticket for another time and I think the major root is not on OS (windows or linux) but FS, and more specifically, under NFS the deletion of the directory would not succeed if there&apos;s a lock file created and handle grabbed by the same thread. Given its commonness I would put up an effort to fix it asap.&lt;/p&gt;</comment>
                            <comment id="17056509" author="githubbot" created="Tue, 10 Mar 2020 23:13:58 +0000"  >&lt;p&gt;guozhangwang commented on pull request #8267: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt;: Do note delete the lock file while holding the lock &lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8267&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   1. Inside StateDirectory#cleanRemovedTasks, skip deleting the lock file (and hence the parent directory) until releasing the lock. And after the lock is released only go ahead and delete the parent directory if `manualUserCall == true`. That is, this is triggered from `KafkaStreams#cleanUp` and users are responsible to make sure that Streams instance is not started and hence there are no other threads trying to grab that lock.&lt;/p&gt;

&lt;p&gt;   2. As a result, during scheduled cleanup the corresponding task.dir would not be empty but be left with only the lock file, so effectively we still achieve the goal of releasing disk spaces. For callers of `listTaskDirectories` like KIP-441 (cc @ableegoldman to take a look) I&apos;ve introduced a new `listNonEmptyTaskDirectories` which excludes such dummy task.dirs with only the lock file left.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17056511" author="guozhang" created="Tue, 10 Mar 2020 23:16:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shoffmeister&quot; class=&quot;user-hover&quot; rel=&quot;shoffmeister&quot;&gt;shoffmeister&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slmingol&quot; class=&quot;user-hover&quot; rel=&quot;slmingol&quot;&gt;slmingol&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lind&quot; class=&quot;user-hover&quot; rel=&quot;lind&quot;&gt;lind&lt;/a&gt; I have a tentative PR to fix this issue (&lt;a href=&quot;https://github.com/apache/kafka/pull/8267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8267&lt;/a&gt;), but it&apos;s a bit hard for me to reproduce it since it requires NFS at the first place, do you have time to try it out in your NFS environment with, e.g. &lt;a href=&quot;https://github.com/simplesteph/kafka-streams-course/blob/1.1.0/word-count/src/test/java/com/github/simplesteph/udemy/kafka/streams/WordCountAppTest.java?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/simplesteph/kafka-streams-course/blob/1.1.0/word-count/src/test/java/com/github/simplesteph/udemy/kafka/streams/WordCountAppTest.java?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17059486" author="githubbot" created="Sat, 14 Mar 2020 20:49:15 +0000"  >&lt;p&gt;guozhangwang commented on pull request #8267: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt;: Do note delete the lock file while holding the lock&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8267&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17059488" author="guozhang" created="Sat, 14 Mar 2020 21:09:56 +0000"  >&lt;p&gt;I&apos;ve pushed the fix to trunk / 2.5 which is verified fixing the issue. I&apos;m going to this ticket now.&lt;/p&gt;</comment>
                            <comment id="17491083" author="rleland" created="Fri, 11 Feb 2022 18:14:47 +0000"  >&lt;p&gt;4 Unit tests are silently swallowing exception attributed to this issue. Search for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6647&quot; title=&quot;KafkaStreams.cleanUp creates .lock file in directory its trying to clean (Windows OS)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6647&quot;&gt;&lt;del&gt;KAFKA-6647&lt;/del&gt;&lt;/a&gt; in source code. If this ticket is truly fixed that should not be needed.&lt;/p&gt;

&lt;p&gt;Also in future if there is an OS specific issue you need to code around temporarily please consider taking two steps:&lt;br/&gt;
1) Find method to only exclude for Particular OS not all operating system.&lt;br/&gt;
2) Agree on mechanism to clean this type of technical debt up since it would be useful for detecting regressions.&lt;/p&gt;

&lt;p&gt;-Rob&lt;/p&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17491093" author="mjsax" created="Fri, 11 Feb 2022 18:56:47 +0000"  >&lt;p&gt;Not sure if I can follow the details &#8211; it might be best to file a new ticket describing the problem?&lt;/p&gt;

&lt;p&gt;Also note that WindowsOS is officially not supported and we don&apos;t test for it. Thus we only try to support WindowsOS in a best-effort mode. So we need to see what we can really do; we might also introduce regressions as we don&apos;t have test infrastructure for WindowsOS in place.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13145049">KAFKA-6655</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13428164">KAFKA-13666</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 39 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3r8tr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>