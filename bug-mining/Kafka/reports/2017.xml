<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:13:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7298] Concurrent DeleteRecords can lead to fatal OutOfSequence error in producer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7298</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have logic in the producer to handle unknown producer errors. Basically when the producer gets an unknown producer error, it checks whether the log start offset is larger than the last acknowledged offset. If it is, then we know the error is spurious and we reset the sequence number to 0, which the broker will then accept.&lt;/p&gt;

&lt;p&gt;It can happen after a DeleteRecords call, however, that the only record remaining in the log is a transaction marker, which does not have a sequence number. The error we get in this case is OUT_OF_SEQUENCE rather than UNKNOWN_PRODUCER, which is fatal.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13179210">KAFKA-7298</key>
            <summary>Concurrent DeleteRecords can lead to fatal OutOfSequence error in producer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Aug 2018 00:12:11 +0000</created>
                <updated>Mon, 20 Aug 2018 18:16:09 +0000</updated>
                            <resolved>Mon, 20 Aug 2018 16:06:52 +0000</resolved>
                                                    <fixVersion>2.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16582790" author="githubbot" created="Thu, 16 Aug 2018 16:30:26 +0000"  >&lt;p&gt;hachikuji opened a new pull request #5518: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7298&quot; title=&quot;Concurrent DeleteRecords can lead to fatal OutOfSequence error in producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7298&quot;&gt;&lt;del&gt;KAFKA-7298&lt;/del&gt;&lt;/a&gt;; Raise UnknownProducerIdException if next sequence number is unknown&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5518&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   If the only producer state left in the log is a transaction marker, then we do not know the next expected sequence number. This can happen if there is a call to DeleteRecords which arrives prior to the writing of the marker. Currently we raise an OutOfOrderSequence error when this happens, but this is treated as a fatal error by the producer. Raising UnknownProducerId instead allows the producer to check for truncation using the last acknowledged sequence number and reset if possible.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16586140" author="githubbot" created="Mon, 20 Aug 2018 16:00:24 +0000"  >&lt;p&gt;hachikuji closed pull request #5518: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7298&quot; title=&quot;Concurrent DeleteRecords can lead to fatal OutOfSequence error in producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7298&quot;&gt;&lt;del&gt;KAFKA-7298&lt;/del&gt;&lt;/a&gt;; Raise UnknownProducerIdException if next sequence number is unknown&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5518&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/log/ProducerStateManager.scala b/core/src/main/scala/kafka/log/ProducerStateManager.scala&lt;br/&gt;
index 49c887b771c..2f711234bdb 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/log/ProducerStateManager.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/log/ProducerStateManager.scala&lt;br/&gt;
@@ -234,9 +234,13 @@ private&lt;span class=&quot;error&quot;&gt;&amp;#91;log&amp;#93;&lt;/span&gt; class ProducerAppendInfo(val producerId: Long,&lt;br/&gt;
         RecordBatch.NO_SEQUENCE&lt;/p&gt;

&lt;p&gt;       if (currentLastSeq == RecordBatch.NO_SEQUENCE &amp;amp;&amp;amp; appendFirstSeq != 0) &lt;/p&gt;
{
-        // the epoch was bumped by a control record, so we expect the sequence number to be reset
-        throw new OutOfOrderSequenceException(s&quot;Out of order sequence number for producerId $producerId: found $appendFirstSeq &quot; +
-          s&quot;(incoming seq. number), but expected 0&quot;)
+        // We have a matching epoch, but we do not know the next sequence number. This case can happen if
+        // only a transaction marker is left in the log for this producer. We treat this as an unknown
+        // producer id error, so that the producer can check the log start offset for truncation and reset
+        // the sequence number. Note that this check follows the fencing check, so the marker still fences
+        // old producers even if it cannot determine our next expected sequence number.
+        throw new UnknownProducerIdException(s&quot;Local producer state matches expected epoch $producerEpoch &quot; +
+          s&quot;for producerId=$producerId, but next expected sequence number is not known.&quot;)
       }
&lt;p&gt; else if (!inSequence(currentLastSeq, appendFirstSeq)) {&lt;br/&gt;
         throw new OutOfOrderSequenceException(s&quot;Out of order sequence number for producerId $producerId: $appendFirstSeq &quot; +&lt;br/&gt;
           s&quot;(incoming seq. number), $currentLastSeq (current end sequence number)&quot;)&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/log/ProducerStateManagerTest.scala b/core/src/test/scala/unit/kafka/log/ProducerStateManagerTest.scala&lt;br/&gt;
index 053aed7c915..f9f4a239023 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/log/ProducerStateManagerTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/log/ProducerStateManagerTest.scala&lt;br/&gt;
@@ -81,6 +81,35 @@ class ProducerStateManagerTest extends JUnitSuite {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  def testAppendTxnMarkerWithNoProducerState(): Unit = {&lt;br/&gt;
+    val producerEpoch = 2.toShort&lt;br/&gt;
+    appendEndTxnMarker(stateManager, producerId, producerEpoch, ControlRecordType.COMMIT, offset = 27L)&lt;br/&gt;
+&lt;br/&gt;
+    val firstEntry = stateManager.lastEntry(producerId).getOrElse(fail(&quot;Expected last entry to be defined&quot;))&lt;br/&gt;
+    assertEquals(producerEpoch, firstEntry.producerEpoch)&lt;br/&gt;
+    assertEquals(producerId, firstEntry.producerId)&lt;br/&gt;
+    assertEquals(RecordBatch.NO_SEQUENCE, firstEntry.lastSeq)&lt;br/&gt;
+&lt;br/&gt;
+    // Fencing should continue to work even if the marker is the only thing left&lt;br/&gt;
+    assertThrows&lt;span class=&quot;error&quot;&gt;&amp;#91;ProducerFencedException&amp;#93;&lt;/span&gt; &lt;/p&gt;
{
+      append(stateManager, producerId, 0.toShort, 0, 0L, 4L)
+    }
&lt;p&gt;+&lt;br/&gt;
+    // If the transaction marker is the only thing left in the log, then an attempt to write using a&lt;br/&gt;
+    // non-zero sequence number should cause an UnknownProducerId, so that the producer can reset its state&lt;br/&gt;
+    assertThrows&lt;span class=&quot;error&quot;&gt;&amp;#91;UnknownProducerIdException&amp;#93;&lt;/span&gt; &lt;/p&gt;
{
+      append(stateManager, producerId, producerEpoch, 17, 0L, 4L)
+    }
&lt;p&gt;+&lt;br/&gt;
+    // The broker should accept the request if the sequence number is reset to 0&lt;br/&gt;
+    append(stateManager, producerId, producerEpoch, 0, 39L, 4L)&lt;br/&gt;
+    val secondEntry = stateManager.lastEntry(producerId).getOrElse(fail(&quot;Expected last entry to be defined&quot;))&lt;br/&gt;
+    assertEquals(producerEpoch, secondEntry.producerEpoch)&lt;br/&gt;
+    assertEquals(producerId, secondEntry.producerId)&lt;br/&gt;
+    assertEquals(0, secondEntry.lastSeq)&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
   @Test&lt;br/&gt;
   def testProducerSequenceWrapAround(): Unit = {&lt;br/&gt;
     val epoch = 15.toShort&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16586339" author="mjsax" created="Mon, 20 Aug 2018 18:16:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; Should this be back ported to older branches, too?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x3bj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>