<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16086] Kafka Streams has RocksDB native memory leak</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16086</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The current 3.7 and trunk versions are leaking native memory while running Kafka streams over several hours. This will likely kill any real workload over time, so this should be treated as a blocker bug for 3.7.&lt;/p&gt;

&lt;p&gt;This is discovered in a long-running soak test. Attached is the memory consumption, which steadily approaches 100% and then the JVM is killed.&lt;/p&gt;

&lt;p&gt;Rerunning the same test with jemalloc native memory profiling, we see these allocated objects after a few hours:&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(jeprof) top
Total: 13283138973 B
10296829713 77.5% 77.5% 10296829713 77.5% rocksdb::port::cacheline_aligned_alloc
2487325671 18.7% 96.2% 2487325671 18.7% rocksdb::BlockFetcher::ReadBlockContents
150937547 1.1% 97.4% 150937547 1.1% rocksdb::lru_cache::LRUHandleTable::LRUHandleTable
119591613 0.9% 98.3% 119591613 0.9% prof_backtrace_impl
47331433 0.4% 98.6% 105040933 0.8% rocksdb::BlockBasedTable::PutDataBlockToCache
32516797 0.2% 98.9% 32516797 0.2% rocksdb::Arena::AllocateNewBlock
29796095 0.2% 99.1% 30451535 0.2% Java_org_rocksdb_Options_newOptions
18172716 0.1% 99.2% 20008397 0.2% rocksdb::InternalStats::InternalStats
16032145 0.1% 99.4% 16032145 0.1% rocksdb::ColumnFamilyDescriptorJni::construct
12454120 0.1% 99.5% 12454120 0.1% std::_Rb_tree::_M_insert_unique&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The first hypothesis is that this is caused by the leaking `Options` object introduced in this line:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/14852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java#L312&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Introduced in this PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/14852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14852&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13563690">KAFKA-16086</key>
            <summary>Kafka Streams has RocksDB native memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nicktelford">Nicholas Telford</assignee>
                                    <reporter username="lucasbru">Lucas Brutschy</reporter>
                        <labels>
                            <label>streams</label>
                    </labels>
                <created>Fri, 5 Jan 2024 09:44:37 +0000</created>
                <updated>Mon, 19 Feb 2024 10:05:14 +0000</updated>
                            <resolved>Fri, 5 Jan 2024 18:35:27 +0000</resolved>
                                    <version>3.7.0</version>
                                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17803506" author="nicktelford" created="Fri, 5 Jan 2024 10:44:58 +0000"  >&lt;p&gt;As discussed on Slack:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;rocksdb::port::cacheline_aligned_alloc&lt;/tt&gt; is called by &lt;tt&gt;StatisticsImpl&lt;/tt&gt; &lt;em&gt;once per-core&lt;/em&gt; to allocate a block of memory for storing stats tickers. The size of this block of memory looks to be &lt;em&gt;at least&lt;/em&gt; 2112 bytes (enough to store 199 tickers and 62 histograms, aligned to the cache line size).&lt;/p&gt;

&lt;p&gt;For example, if the running machine has 16 cores, this would be 16*2112 = 33 KiB per-invocation. I&apos;m not able to accurately determine the exact size of the allocation, in practice it&apos;s likely to be considerably more than this.&lt;/p&gt;

&lt;p&gt;Our temporary &lt;tt&gt;Options&lt;/tt&gt; object passes the global &lt;tt&gt;DBOptions&lt;/tt&gt; object in its constructor. This invokes the copy-constructor on &lt;tt&gt;DBOptions&lt;/tt&gt; copying the &lt;tt&gt;Statistics&lt;/tt&gt; that was configured on &lt;tt&gt;DBOptions&lt;/tt&gt;. Since we never &lt;tt&gt;close()&lt;/tt&gt; the &lt;tt&gt;Options&lt;/tt&gt;, this copied &lt;tt&gt;Statistics&lt;/tt&gt; leaks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13065746" name="image.png" size="29428" author="JIRAUSER295470" created="Fri, 5 Jan 2024 09:39:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mkug:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>