<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19407] OffsetsOutOfOrderException on followers due to the race condition in the leader</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19407</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Environment&quot;&gt;&lt;/a&gt;Environment&lt;/h2&gt;
&lt;ul&gt;
	&lt;li&gt;Kafka version: 3.3.2 (But we suppose this issue still exists in latest Kafka)&lt;/li&gt;
	&lt;li&gt;Replication factor: 3&lt;/li&gt;
	&lt;li&gt;Topic&apos;s cleanup.policy: delete&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;Phenomenon&quot;&gt;&lt;/a&gt;Phenomenon&lt;/h2&gt;

&lt;p&gt;We experienced a partition in our cluster got UnderMinISR suddenly without any hardware/network issue or any operation.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-06-10 20:27:14,310] INFO [Partition topic-X-49 broker=17] Shrinking ISR from 15,16,17 to 17. Leader: (highWatermark: 572579089, endOffset: 572579215). Out of sync replicas: (brokerId: 15, endOffset: 572579089) (brokerId: 16, endOffset: 572579089). (kafka.cluster.Partition)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On both followers, we saw below log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-06-10 20:26:59,804] ERROR [ReplicaFetcher replicaId=16, leaderId=17, fetcherId=1] Unexpected error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition topic-X-49 at offset 572579089 (kafka.server.ReplicaFetcherThread)
kafka.common.OffsetsOutOfOrderException: Out of order offsets found in append to topic-X-49: ArrayBuffer(572579089, 572579090, 572579091, 572579092, 572579093, 572579094, 572579095, 572579096, 572579097, 572579098, 572579099, 572579100, 572579101, 572579102, 572579103, 572579104, 572579105, 572579106, 572579107, 572579108, 572579109, 572579089,...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The log tells there&apos;s an offset regression after 572579109 (to 572579089).&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Analysis&quot;&gt;&lt;/a&gt;Analysis&lt;/h2&gt;
&lt;h3&gt;&lt;a name=&quot;Thecauseoftheoffsetregression&quot;&gt;&lt;/a&gt;The cause of the offset regression&lt;/h3&gt;

&lt;p&gt;We dumped active log segment on the leader and confirmed that the leader&apos;s log actually contains records where non-monotonic offsets assigned.&lt;br/&gt;
So the problem must exists on the leader rather than the follower.&lt;/p&gt;

&lt;p&gt;On the leader, we found below log is output right before the follower experiences OffsetsOutOfOrderException.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2025-06-10 20:26:37,463] ERROR [ReplicaManager broker=17] Error processing append operation on partition topic-X-49 (kafka.server.ReplicaManager)
java.lang.IllegalStateException: Attempt to append a timestamp (1749554796970) to slot 1 no larger than the last timestamp appended (1749554797191) to /path/to/kafka-log-dir/topic-X-49/00000000000572579060.timeindex.
        at kafka.log.TimeIndex.$anonfun$maybeAppend$1(TimeIndex.scala:128)
        at kafka.log.TimeIndex.maybeAppend(TimeIndex.scala:114)
        at kafka.log.LogSegment.append(LogSegment.scala:167)
        at kafka.log.LocalLog.append(LocalLog.scala:442)
        at kafka.log.UnifiedLog.append(UnifiedLog.scala:950)
        at kafka.log.UnifiedLog.appendAsLeader(UnifiedLog.scala:760)
        at kafka.cluster.Partition.$anonfun$appendRecordsToLeader$1(Partition.scala:1170)
        at kafka.cluster.Partition.appendRecordsToLeader(Partition.scala:1158)
        at kafka.server.ReplicaManager.$anonfun$appendToLocalLog$6(ReplicaManager.scala:956)
        at scala.collection.StrictOptimizedMapOps.map(StrictOptimizedMapOps.scala:28)
        at scala.collection.StrictOptimizedMapOps.map$(StrictOptimizedMapOps.scala:27)
        at scala.collection.mutable.HashMap.map(HashMap.scala:35)
        at kafka.server.ReplicaManager.appendToLocalLog(ReplicaManager.scala:944)
        at kafka.server.ReplicaManager.appendRecords(ReplicaManager.scala:602)
        at kafka.server.KafkaApis.handleProduceRequest(KafkaApis.scala:666)
        at kafka.server.KafkaApis.handle(KafkaApis.scala:175)
        at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:75)
        at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This explains the offset regression as below:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Due to the IllegalStateException in the middle of handling produce request, LogEndOffset wasn&apos;t updated while records were already written to the log segment.&lt;/li&gt;
	&lt;li&gt;When the leader handles subsequent produce requests, it assigns same offset to the record batch
	&lt;ul&gt;
		&lt;li&gt;=&amp;gt; Non-monotonic offset sequence happens and it causes OffsetsOutOfOrderException on followers&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;ThecauseofIllegalStateException&quot;&gt;&lt;/a&gt;The cause of IllegalStateException&lt;/h3&gt;

&lt;p&gt;The exception tells that trying to append timestamp 1749554796970 which is smaller than the last entry in the time index (1749554797191), that is invalid.&lt;/p&gt;

&lt;p&gt;The timestamp about to be appended here is &lt;a href=&quot;https://github.com/apache/kafka/blob/3.3.2/core/src/main/scala/kafka/log/LogSegment.scala#L355&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;LogSegment#maxTimestampSoFar&lt;/a&gt;. It means that maxTimestampSoFar regressed somehow.&lt;/p&gt;

&lt;p&gt;After reading the code, we found that below race-condition is possible and it explains the phenomenon we experienced:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076994/13076994_image-2025-06-13-23-01-40-371.png&quot; height=&quot;471&quot; width=&quot;597&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Actually we confirmed the log-segment was rolled out right before the phenomenon (i.e. entering &lt;a href=&quot;https://github.com/apache/kafka/blob/3.3.2/core/src/main/scala/kafka/log/LogSegment.scala#L106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;if block at LogSegment#L106&lt;/a&gt; is possible) and there were clients calling listOffsets API on the partition, which matches to the scenario.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;SuggestedFix&quot;&gt;&lt;/a&gt;Suggested Fix&lt;/h2&gt;

&lt;p&gt;We should protect &lt;a href=&quot;https://github.com/apache/kafka/blob/4.0.0/storage/src/main/java/org/apache/kafka/storage/internals/log/LogSegment.java#L195-L197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;maxTimestampAndOffsetSoFar here&lt;/a&gt; by double-checked locking&lt;/p&gt;</description>
                <environment></environment>
        <key id="13620859">KAFKA-19407</key>
            <summary>OffsetsOutOfOrderException on followers due to the race condition in the leader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ocadaruma">Haruki Okada</assignee>
                                    <reporter username="ocadaruma">Haruki Okada</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Jun 2025 14:11:13 +0000</created>
                <updated>Tue, 24 Jun 2025 16:43:59 +0000</updated>
                            <resolved>Tue, 24 Jun 2025 16:43:58 +0000</resolved>
                                    <version>3.3.2</version>
                                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>4.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17979322" author="ocadaruma" created="Mon, 16 Jun 2025 22:36:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hi, I submitted &lt;a href=&quot;https://github.com/apache/kafka/pull/19972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the patch&lt;/a&gt; for this. Could you take a look?&lt;/p&gt;</comment>
                            <comment id="17985909" author="chia7712" created="Tue, 24 Jun 2025 16:43:59 +0000"  >&lt;p&gt;trunk: &lt;a href=&quot;https://github.com/apache/kafka/commit/959021de59fb03bafc8a5e0a8cfde748c38a3c9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/959021de59fb03bafc8a5e0a8cfde748c38a3c9c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.1: &lt;a href=&quot;https://github.com/apache/kafka/commit/1dad77615d345a68cddaa50416279c34b6f4ac8b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/1dad77615d345a68cddaa50416279c34b6f4ac8b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.0: &lt;a href=&quot;https://github.com/apache/kafka/commit/9fcfe546d1313b77ad5dc6b10be3095fe6d32569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/9fcfe546d1313b77ad5dc6b10be3095fe6d32569&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076994" name="image-2025-06-13-23-01-40-371.png" size="793694" author="ocadaruma" created="Fri, 13 Jun 2025 14:01:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wbm8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>