<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1029] Zookeeper leader election stuck in ephemeral node retry loop</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1029</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We&apos;re seeing the following log statements (over and over):&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-08-27 07:21:49,538&amp;#93;&lt;/span&gt; INFO conflict in /controller data: &lt;/p&gt;
{ &quot;brokerid&quot;:3, &quot;timestamp&quot;:&quot;1377587945206&quot;, &quot;version&quot;:1 }
&lt;p&gt; stored data: &lt;/p&gt;
{ &quot;brokerid&quot;:2, &quot;timestamp&quot;:&quot;1377587460904&quot;, &quot;version&quot;:1 }
&lt;p&gt; (kafka.utils.ZkUtils$)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2013-08-27 07:21:49,559&amp;#93;&lt;/span&gt; INFO I wrote this conflicted ephemeral node [&lt;/p&gt;
{ &quot;brokerid&quot;:3, &quot;timestamp&quot;:&quot;1377587945206&quot;, &quot;version&quot;:1 }
&lt;p&gt;] at /controller a while back in a different session, hence I will backoff for this node to be deleted by Zookeeper and retry (kafka.utils.ZkUtils$)&lt;/p&gt;

&lt;p&gt;where the broker is essentially stuck in the loop that is trying to deal with left-over ephemeral nodes. The code looks a bit racy to me. In particular:&lt;/p&gt;

&lt;p&gt;ZookeeperLeaderElector:&lt;/p&gt;

&lt;p&gt;  def elect: Boolean = {&lt;br/&gt;
    controllerContext.zkClient.subscribeDataChanges(electionPath, leaderChangeListener)&lt;br/&gt;
    val timestamp = SystemTime.milliseconds.toString&lt;br/&gt;
    val electString = ...&lt;/p&gt;

&lt;p&gt;    try {&lt;br/&gt;
      createEphemeralPathExpectConflictHandleZKBug(controllerContext.zkClient, electionPath, electString, leaderId,&lt;br/&gt;
        (controllerString : String, leaderId : Any) =&amp;gt; KafkaController.parseControllerId(controllerString) == leaderId.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt;,&lt;br/&gt;
        controllerContext.zkSessionTimeout)&lt;/p&gt;

&lt;p&gt;leaderChangeListener is registered before the create call (by the way, it looks like a new registration will be added every elect call - shouldn&apos;t it register in startup()?) so can update leaderId to the current leader before the call to create. If that happens then we will continuously get node exists exceptions and the checker function will always return true, i.e. we will never get out of the while(true) loop.&lt;/p&gt;

&lt;p&gt;I think the right fix here is to pass brokerId instead of leaderId when calling create, i.e.&lt;/p&gt;

&lt;p&gt;createEphemeralPathExpectConflictHandleZKBug(controllerContext.zkClient, electionPath, electString, brokerId,&lt;br/&gt;
        (controllerString : String, leaderId : Any) =&amp;gt; KafkaController.parseControllerId(controllerString) == leaderId.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt;,&lt;br/&gt;
        controllerContext.zkSessionTimeout)&lt;/p&gt;

&lt;p&gt;The loop dealing with the ephemeral node bug is now only triggered for the broker that owned the node previously, although I am still not 100% sure if that is sufficient.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12665679">KAFKA-1029</key>
            <summary>Zookeeper leader election stuck in ephemeral node retry loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smeder">Sam Meder</assignee>
                                    <reporter username="smeder">Sam Meder</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Aug 2013 09:39:21 +0000</created>
                <updated>Thu, 21 Aug 2014 16:58:58 +0000</updated>
                            <resolved>Tue, 27 Aug 2013 17:20:50 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13751410" author="guozhang" created="Tue, 27 Aug 2013 16:36:03 +0000"  >&lt;p&gt;Thanks for the catch Sam. Yes the comparison value should be brokerId instead of leaderId. This is a bug in the patch of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-992&quot; title=&quot;Double Check on Broker Registration to Avoid False NodeExist Exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-992&quot;&gt;&lt;del&gt;KAFKA-992&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Also I agree that we only need to register leaderChangeListener once, which we can do in startup, before the elect statement. Could you also make this change?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Guozhang&lt;/p&gt;</comment>
                            <comment id="13751415" author="nehanarkhede" created="Tue, 27 Aug 2013 16:40:04 +0000"  >&lt;p&gt;Good catch. The election and leader change update happens on the same lock. It is possible that the old controller becomes the new controller, and the leaderId field is not updated since the elect() API has acquired the controllerLock. This makes broker 3 retry the controller election on behalf of broker 2 and it may never stop until the next controller election.&lt;/p&gt;

&lt;p&gt;+1 on this patch&lt;/p&gt;</comment>
                            <comment id="13751431" author="smeder" created="Tue, 27 Aug 2013 16:52:19 +0000"  >&lt;p&gt;Updated patch to also include moving the listener registration to startup()&lt;/p&gt;</comment>
                            <comment id="13751449" author="guozhang" created="Tue, 27 Aug 2013 17:06:46 +0000"  >&lt;p&gt;Thanks for v2. +1 on this one.&lt;/p&gt;</comment>
                            <comment id="13751466" author="nehanarkhede" created="Tue, 27 Aug 2013 17:20:50 +0000"  >&lt;p&gt;Thanks for patch v2. Committed it to 0.8&lt;/p&gt;</comment>
                            <comment id="13943920" author="jbrosenberg@gmail.com" created="Sat, 22 Mar 2014 05:28:04 +0000"  >&lt;p&gt;I&apos;m seeing this happening now (we are running 0.8).  Should this have been fixed?&lt;/p&gt;

&lt;p&gt;It appears to only happen every once in a while, but when it does, it seems persist and repeat indefinitely.  Sometimes restarting the consumer app can fix the problem, but not always.&lt;/p&gt;</comment>
                            <comment id="13944233" author="guozhang" created="Sat, 22 Mar 2014 21:00:51 +0000"  >&lt;p&gt;This is a little wired. The patch should have been in 0.8 already. Could you upload the related logs here?&lt;/p&gt;</comment>
                            <comment id="13944775" author="jbrosenberg@gmail.com" created="Mon, 24 Mar 2014 06:22:53 +0000"  >&lt;p&gt;Perhaps this should be re-opened a separate ticket?&lt;/p&gt;

&lt;p&gt;The issue seems to have started when we had a network outage.  Several high-level consumers could not communicate at all with zookeeper (or kafka) for several minutes.  When the network was restarted, these continual &quot;I wrote this conlicted ephemeral node....&quot; log messages have been running steadily, e.g.:&lt;/p&gt;

&lt;p&gt;2014-03-19 00:13:14,165  INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ZkClient-EventThread-51-myzkserver&amp;#93;&lt;/span&gt; utils.ZkUtils$ - conflict in /consumers/myapp/ids/myapp_myhost-1394905418548-e159fc25 data: { &quot;pattern&quot;:&quot;white_list&quot;, &quot;subscription&quot;:&lt;/p&gt;
{ &quot;(^\\Qmy.event\\E(\\.[\\w-]+)*$)&quot; : 1 }
&lt;p&gt;, &quot;timestamp&quot;:&quot;1395187970147&quot;, &quot;version&quot;:1 } stored data: { &quot;pattern&quot;:&quot;white_list&quot;, &quot;subscription&quot;:&lt;/p&gt;
{ &quot;(^\\Qmy.event\\E(\\.[\\w-]+)*$)&quot; : 1 }
&lt;p&gt;, &quot;timestamp&quot;:&quot;1395187967170&quot;, &quot;version&quot;:1 }&lt;br/&gt;
2014-03-19 00:13:14,166  INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ZkClient-EventThread-51-myzkserver&amp;#93;&lt;/span&gt; utils.ZkUtils$ - I wrote this conflicted ephemeral node [{ &quot;pattern&quot;:&quot;white_list&quot;, &quot;subscription&quot;:&lt;/p&gt;
{ &quot;(^\\Qmy.event\\E(\\.[\\w-]+)*$)&quot; : 1 }
&lt;p&gt;, &quot;timestamp&quot;:&quot;1395187970147&quot;, &quot;version&quot;:1 }] at /consumers/myapp/ids/myapp_awa60.sjc1b.square-1394905418548-e159fc25 a while back in a different session, hence I will backoff for this node to be deleted by Zookeeper and retry&lt;/p&gt;

&lt;p&gt;These are happening continuously.  We have tried doing a rolling restart of our consumer apps, and even a rolling restart of zk.  We are using zk 3.3.6, in this case, but will try upgrading to 3.4.5 shortly.&lt;/p&gt;

&lt;p&gt;It seems that these ephemeral node errors always happen right after a consumer rebalance occurs.&lt;/p&gt;</comment>
                            <comment id="13945223" author="jbrosenberg@gmail.com" created="Mon, 24 Mar 2014 15:40:35 +0000"  >&lt;p&gt;I&apos;m starting to suspect my issue is actually due to network latency introduced between the consumers and the zk servers, which is causing zk connection timeouts and flapping.  Thus, I think the issue is probably not related to the original bug in this issue per se (it is having trouble with zk timeouts, possibly resulting in consumer clients not seeing/updating a consistent view of these ephemeral nodes?  Does that make sense?&lt;/p&gt;

&lt;p&gt;That being said, it still doesn&apos;t seem to make sense that an ephemeral node would not ever get removed eventually.  Also, perhaps the strange folksy error log messaging in this case is assuming rather specific scenarios that don&apos;t always apply, which could be more simplified here?&lt;/p&gt;</comment>
                            <comment id="13945311" author="nehanarkhede" created="Mon, 24 Mar 2014 16:29:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbrosenberg%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;jbrosenberg@gmail.com&quot;&gt;jbrosenberg@gmail.com&lt;/a&gt; It is a little difficult to say what&apos;s going on. It would help if you can tell us how to reproduce this? If you suspect this is due to network outage, try doing a test where you disable the network interface and see if you can reproduce it. That will help us troubleshoot this.&lt;/p&gt;</comment>
                            <comment id="13946076" author="smeder" created="Tue, 25 Mar 2014 03:09:39 +0000"  >&lt;p&gt;We&apos;ve seen this as well (once or twice in ~4 months). The exact conditions under which it occurs have been pretty hard to pin-point.&lt;/p&gt;</comment>
                            <comment id="13955320" author="jbrosenberg@gmail.com" created="Mon, 31 Mar 2014 15:51:06 +0000"  >&lt;p&gt;Just to wrap this up, it turns out the app that was seeing this behavior had a but which was causing unnecessary memory pressure and continual garbage collection.  This ended up slowing the app down, such that zk timeouts were continual, and the consumer connector decided continually to keep re-balancing.  This caused the flapping of ephemeral nodes, and other problems, it would seem (the last part here is conjecture).&lt;/p&gt;

&lt;p&gt;So, I think the app was the problem, not the high-level kafka consumer code.  However, perhaps there is something that can be done to prevent or throttle continual re-balancing in this case!  It was confusing to look at the logs and see almost exclusively warnings/exceptions coming from kafka, and not the app itself.&lt;/p&gt;</comment>
                            <comment id="13984265" author="miguno" created="Tue, 29 Apr 2014 12:58:50 +0000"  >&lt;p&gt;Interestingly I ran into a very similar issue while doing basic validation of Kafka 0.8.1.1.  Note that unlike Jason Rosenberg&apos;s case I was only using code/tools/scripts that are shipped with Kafka (e.g. console producer and console consumer).&lt;/p&gt;

&lt;p&gt;Here is an example log message, which was repeated indefinitely:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-29 09:48:27,207] INFO conflict in /controller data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398764901156&quot;&lt;/span&gt;} stored data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398764894941&quot;&lt;/span&gt;} (kafka.utils.ZkUtils$)
[2014-04-29 09:48:27,218] INFO I wrote &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; conflicted ephemeral node [{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398764901156&quot;&lt;/span&gt;}] at /controller a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; back in a different session, hence I will backoff &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node to be deleted by Zookeeper and retry (kafka.utils.ZkUtils$)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;How to reproduce (unsolved)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately I cannot consistently reproduce the issue and, to be honest, I am still not sure what actually triggers the bug.  As such I can only summarize what I did before and around the time when this bug was triggered, which I could observe through errors in log files and through errors being displayed after running certain commands.  So yes, it&apos;s a bit like shooting in the dark.&lt;/p&gt;

&lt;p&gt;Here&apos;s an overview of my test setup:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I deployed Kafka 0.8.1.1 to one machine &lt;tt&gt;kafka1&lt;/tt&gt; and ZooKeeper 3.4.5 to a second machine &lt;tt&gt;zookeeper1&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;I followed the Kafka 0.8.1 quick start guide to create a topic &quot;test&quot; with 1 partition and a replication factor of 1.&lt;/li&gt;
	&lt;li&gt;I sent test messages to the topic &quot;test&quot; via the console producer.&lt;/li&gt;
	&lt;li&gt;I read test messages from the topic &quot;test&quot; via the console consumer.&lt;/li&gt;
	&lt;li&gt;Apart from producing and consuming a handful of test messages I also ran some supposedly read-only admin commands such as &quot;describing&quot; the topic, and running the consumer offset checker tool.&lt;/li&gt;
	&lt;li&gt;At &quot;some&quot; point, Kafka was caught in an indefinite loop complaining about &quot;conflict in &lt;tt&gt;/controller&lt;/tt&gt; data&quot;.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;The following paragraphs list in more detail what I did before the error popped up.&lt;/p&gt;

&lt;p&gt;Producer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ sudo su - kafka
$ cd /opt/kafka

# This command returned no topics at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point = worked as expected
$ bin/kafka-topics.sh --list --zookeeper zookeeper1

# I created a topic, worked as expected
$ bin/kafka-topics.sh --create --zookeeper zookeeper1 --replication-factor 1 --partitions 1 --topic test

# I requested details of topic &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, worked as expected
$ bin/kafka-topics.sh --zookeeper zookeeper1 --describe --topic test
Topic:test	PartitionCount:1	ReplicationFactor:1	Configs:
	Topic: test	Partition: 0	Leader: 0	Replicas: 0	Isr: 0

# I started a console producer and manually send a handful of test messages, worked as expected (see consumer below)
$ bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Consumer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ sudo su - kafka
$ cd /opt/kafka

# I started a console consumer, worked as expected (i.e. could read messages sent by producer, see above)
$ bin/kafka-console-consumer.sh --zookeeper zookeeper1 --topic test --from-beginning
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Up to that point, everything worked.  But then the Kafka broker went the way of the dodo.  As I said I can&apos;t pinpoint the cause, and re-running the same commands on a fresh Kafka/ZooKeeper deployment (fresh VMs etc.) didn&apos;t consistently trigger the issue like I hoped.&lt;/p&gt;

&lt;p&gt;Here&apos;s what I did after the commands above, and at some point I eventually did observe the original error described in this JIRA ticket.  Again, at the moment I cannot tell what actually triggered the bug.&lt;/p&gt;

&lt;p&gt;Producer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# Test-driving the consumer offset checker
$ bin/kafka-run-&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;sh kafka.tools.ConsumerOffsetChecker --zkconnect zookeeper1
# At &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point consumer &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; was not expected to exist.
$ bin/kafka-run-&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;sh kafka.tools.ConsumerOffsetChecker --zkconnect zookeeper1 --broker-info --group foo

#
# I then re-started the console producer (see below), now configured to use the group id &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;.
#
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Consumer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# I re-started the console consumer, now configured to use the group id &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;.
$ bin/kafka-console-consumer.sh --zookeeper zookeeper1 --topic test --from-beginning --group foo
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point &quot;describing&quot; the topic gave the following info, indicating that there was a problem (e.g. no leader for partition, no ISR available):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ bin/kafka-topics.sh --zookeeper zookeeper1 --describe --topic test
Topic:test	PartitionCount:1	ReplicationFactor:1	Configs:
	Topic: test	Partition: 0	Leader: -1	Replicas: 0	Isr:
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Log files such as &lt;tt&gt;state-change.log&lt;/tt&gt; showed these error messages:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

[2014-04-29 07:44:47,673] TRACE Controller 0 epoch 1 changed partition [test,0] state from NonExistentPartition to NewPartition with assigned replicas 0 (state.change.logger)
[2014-04-29 07:44:47,679] TRACE Controller 0 epoch 1 changed state of replica 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from NonExistentReplica to NewReplica (state.change.logger)
[2014-04-29 07:44:47,703] TRACE Controller 0 epoch 1 changed partition [test,0] from NewPartition to OnlinePartition with leader 0 (state.change.logger)
[2014-04-29 07:44:47,708] TRACE Controller 0 epoch 1 sending become-leader LeaderAndIsr request (Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1) with correlationId 7 to broker 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,716] TRACE Controller 0 epoch 1 sending UpdateMetadata request (Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1) with correlationId 7 to broker 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,721] TRACE Controller 0 epoch 1 changed state of replica 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from NewReplica to OnlineReplica (state.change.logger)
[2014-04-29 07:44:47,729] TRACE Broker 0 received LeaderAndIsr request (LeaderAndIsrInfo:(Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1),ReplicationFactor:1),AllReplicas:0) correlation id 7 from controller 0 epoch 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,733] TRACE Broker 0 handling LeaderAndIsr request correlationId 7 from controller 0 epoch 1 starting the become-leader transition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,741] TRACE Broker 0 stopped fetchers as part of become-leader request from controller 0 epoch 1 with correlation id 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,783] TRACE Broker 0 completed LeaderAndIsr request correlationId 7 from controller 0 epoch 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the become-leader transition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,796] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-29 07:44:47,816] TRACE Broker 0 cached leader info (LeaderAndIsrInfo:(Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1),ReplicationFactor:1),AllReplicas:0) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] in response to UpdateMetadata request sent by controller 0 epoch 1 with correlation id 7 (state.change.logger)
[2014-04-29 07:44:47,818] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-29 08:48:06,559] TRACE Controller 0 epoch 1 changed partition [test,0] state from OnlinePartition to OfflinePartition (state.change.logger)
[2014-04-29 08:48:06,561] TRACE Controller 0 epoch 1 started leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 08:48:06,574] ERROR Controller 0 epoch 1 initiated state change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OfflinePartition to OnlinePartition failed (state.change.logger)
kafka.common.NoReplicaOnlineException: No replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is alive. Live brokers are: [Set()], Assigned replicas are: [List(0)]
        at kafka.controller.OfflinePartitionLeaderSelector.selectLeader(PartitionLeaderSelector.scala:61)
        at kafka.controller.PartitionStateMachine.electLeaderForPartition(PartitionStateMachine.scala:336)
        at kafka.controller.PartitionStateMachine.kafka$controller$PartitionStateMachine$$handleStateChange(PartitionStateMachine.scala:185)
        at kafka.controller.PartitionStateMachine$$anonfun$triggerOnlinePartitionStateChange$3.apply(PartitionStateMachine.scala:99)
        at kafka.controller.PartitionStateMachine$$anonfun$triggerOnlinePartitionStateChange$3.apply(PartitionStateMachine.scala:96)
        at scala.collection.TraversableLike$WithFilter$$anonfun$foreach$1.apply(TraversableLike.scala:772)
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:98)
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:98)
        at scala.collection.mutable.HashTable$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreachEntry(HashTable.scala:226)
        at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:39)
        at scala.collection.mutable.HashMap.foreach(HashMap.scala:98)
[2014-04-29 09:33:16,161] INFO conflict in /controller data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398761286651&quot;&lt;/span&gt;} stored data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398761286608&quot;&lt;/span&gt;} (kafka.utils.ZkUtils$)
[2014-04-29 09:33:16,163] INFO I wrote &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; conflicted ephemeral node [{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398761286651&quot;&lt;/span&gt;}] at /controller a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; back in a different session, hence I will backoff &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node to be deleted by Zookeeper and retry (kafka.utils.ZkUtils$)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also tried a few admin commands to see what would happen:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ bin/kafka-preferred-replica-election.sh --zookeeper zookeeper1 --path-to-json-file /tmp/test.json
Failed to start preferred replica election
kafka.common.AdminCommandFailedException: Admin command failed
	at kafka.admin.PreferredReplicaLeaderElectionCommand.moveLeaderToPreferredReplica(PreferredReplicaLeaderElectionCommand.scala:115)
	at kafka.admin.PreferredReplicaLeaderElectionCommand$.main(PreferredReplicaLeaderElectionCommand.scala:60)
	at kafka.admin.PreferredReplicaLeaderElectionCommand.main(PreferredReplicaLeaderElectionCommand.scala)
Caused by: kafka.admin.AdminOperationException: Preferred replica leader election currently in progress &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Set(). Aborting operation
	at kafka.admin.PreferredReplicaLeaderElectionCommand$.writePreferredReplicaElectionData(PreferredReplicaLeaderElectionCommand.scala:101)
	at kafka.admin.PreferredReplicaLeaderElectionCommand.moveLeaderToPreferredReplica(PreferredReplicaLeaderElectionCommand.scala:113)
	... 2 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Workaround&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;One workaround I found was to delete the &lt;tt&gt;/controller&lt;/tt&gt; znode in ZooKeeper, but this seems like swinging a big hammer.  Here&apos;s the console history of my ZooKeeper session.  The data associated with &lt;tt&gt;/controller&lt;/tt&gt; was from a &quot;buggy&quot; test run, i.e. a test run where I did observe the indefinite loop error.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[zk: zookeeper1:2181(CONNECTED) 7] ls /
[zookeeper, admin, consumers, config, controller, brokers, controller_epoch]
[zk: zookeeper1:2181(CONNECTED) 21] ls /controller
[]
[zk: zookeeper1:2181(CONNECTED) 22] get /controller
{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398764894941&quot;&lt;/span&gt;}
cZxid = 0x2f2
ctime = Tue Apr 29 09:48:21 UTC 2014
mZxid = 0x2f2
mtime = Tue Apr 29 09:48:21 UTC 2014
pZxid = 0x2f2
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x145ac679efa0023
dataLength = 54
numChildren = 0
[zk: zookeeper1:2181(CONNECTED) 23] rmr /controller
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;Addendum 1&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In Jason Rosenberg&apos;s case Kafka complained about a &lt;tt&gt;/consumer/*&lt;/tt&gt; znode:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;conflict in /consumers/myapp/ids/myapp_myhost-1394905418548-e159fc25 data: [...] stored data: [...]
2014-03-19 00:13:14,166 INFO [ZkClient-EventThread-51-myzkserver] utils.ZkUtils$ - I wrote &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; conflicted ephemeral node [...] at /consumers/myapp/ids/myapp_awa60.sjc1b.square-1394905418548-e159fc25 a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; back in a different session, hence I will backoff &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node to be deleted by Zookeeper and retry
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In my case Kafka complained about &lt;tt&gt;/controller&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-29 08:48:06,574] ERROR Controller 0 epoch 1 initiated state change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OfflinePartition to OnlinePartition failed (state.change.logger)
kafka.common.NoReplicaOnlineException: No replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is alive. Live brokers are: [Set()], Assigned replicas are: [List(0)]
[...]
[2014-04-29 09:33:16,161] INFO conflict in /controller data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398761286651&quot;&lt;/span&gt;} stored data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398761286608&quot;&lt;/span&gt;} (kafka.utils.ZkUtils$)
[2014-04-29 09:33:16,163] INFO I wrote &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; conflicted ephemeral node [{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398761286651&quot;&lt;/span&gt;}] at /controller a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; back in a different session, hence I will backoff &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node to be deleted by Zookeeper and retry (kafka.utils.ZkUtils$)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From what I understand my error message is rather similar to the original error report, which a) also mentions a conflict for &lt;tt&gt;/controller&lt;/tt&gt;, and b) where the issue seems to be different timestamp values.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Addendum 2&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;FWIW I noticed another similarity between my two &quot;buggy&quot; test runs.  In both cases the bug &quot;triggered&quot; 64 minutes after the last normal/successful state change.  Not sure what to make out of this observation. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Unfortunately I do not have the full log files from those test runs, otherwise I would have provided them here.  I will make sure to capture all log files now that I&apos;m on alert.&lt;/p&gt;

&lt;p&gt;Buggy run #1, going from 07:44:47 to 08:48:06.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-29 07:44:47,783] TRACE Broker 0 completed LeaderAndIsr request correlationId 7 from controller 0 epoch 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the become-leader transition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 07:44:47,796] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-29 07:44:47,816] TRACE Broker 0 cached leader info (LeaderAndIsrInfo:(Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1),ReplicationFactor:1),AllReplicas:0) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] in response to UpdateMetadata request sent by controller 0 epoch 1 with correlation id 7 (state.change.logger)
[2014-04-29 07:44:47,818] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-29 08:48:06,559] TRACE Controller 0 epoch 1 changed partition [test,0] state from OnlinePartition to OfflinePartition (state.change.logger)
[2014-04-29 08:48:06,561] TRACE Controller 0 epoch 1 started leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 08:48:06,574] ERROR Controller 0 epoch 1 initiated state change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OfflinePartition to OnlinePartition failed (state.change.logger)
kafka.common.NoReplicaOnlineException: No replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is alive. Live brokers are: [Set()], Assigned replicas are: [List(0)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Buggy run #2, going from 10:08:31 to 11:12:31.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-29 10:03:16,837] TRACE Broker 0 cached leader info (LeaderAndIsrInfo:(Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1),ReplicationFactor:1),AllReplicas:0) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] in response to UpdateMetadata request sent by controller 0 epoch 1 with correlation id 7 (state.change.logger)
[2014-04-29 10:03:16,838] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-29 10:08:31,393] TRACE Controller 0 epoch 1 started leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 10:08:31,407] TRACE Controller 0 epoch 1 changed partition [test,0] from OnlinePartition to OnlinePartition with leader 0 (state.change.logger)
[2014-04-29 11:12:31,318] TRACE Controller 0 epoch 1 changed partition [test,0] state from OnlinePartition to OfflinePartition (state.change.logger)
[2014-04-29 11:12:31,318] TRACE Controller 0 epoch 1 started leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-29 11:12:31,333] ERROR Controller 0 epoch 1 initiated state change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OfflinePartition to OnlinePartition failed (state.change.logger)
kafka.common.NoReplicaOnlineException: No replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is alive. Live brokers are: [Set()], Assigned replicas are: [List(0)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13984377" author="junrao" created="Tue, 29 Apr 2014 15:11:26 +0000"  >&lt;p&gt;Interesting, did you see any ZK session expiration in the broker log (search for Expired)?&lt;/p&gt;</comment>
                            <comment id="13984631" author="jbrosenberg@gmail.com" created="Tue, 29 Apr 2014 18:34:39 +0000"  >&lt;p&gt;I&apos;ll add that we still see this from time to time (we&apos;re still on 0.8.0), and it&apos;s usually after an abnormal event, such as a failed meta-data request for a large group of topics, that times out, etc.  But once this happens, it&apos;s very difficult to make it go away, other than restarting the consumer.&lt;/p&gt;</comment>
                            <comment id="13985617" author="miguno" created="Wed, 30 Apr 2014 15:26:37 +0000"  >&lt;p&gt;I could finally reproduce the bug again, though still not consistently yet.&lt;/p&gt;

&lt;p&gt;And I think I have an idea what the root cause might be:  I was test-driving Kafka in several VMs locally on a Mac MBP laptop, and the energy saver settings (or sth similar) might be responsible for triggering the problem when the laptop was idle.  (In the test run below I intentionally let the laptop idle for 2-3 hours after creating a &quot;test&quot; topic and sending/consuming a few test massages.)  The timestamp of when the problem was triggered (11:01) correlates with me unlocking the laptop (user screen).  What&apos;s strange is that the laptop is configured not to go to sleep when idle, the hard disk is not asked to sleep either (and even if you did enable that setting in Mac OS X it does not have an effect on SSD&apos;s, which is the only disk installed in the laptop I was using), etc.  &amp;#8211; only the display is allowed to turn off after 10 minutes.  So even though the laptop is configured to be &quot;always on&quot; there apparently is something that throws off Kafka/ZooKeeper.  Also, as I said in my earlier comment I still cannot reproduce the issue consistently, i.e. sometimes Kafka/ZK work correctly after idling/unlocking;  still I think the root cause has ultimately to do with idling on Mac OS X.&lt;/p&gt;

&lt;p&gt;Lastly, I don&apos;t know what the expected failure handling of Kafka/ZK is in such a scenario.  From what I can read from the logs below my setup seems to have simulated what could happen during a network partitioning (Kafka broker could not talk to ZooKeeper for a long time, hence ZK session expired, then Kafka could talk again to ZK, but couldn&apos;t fully recover).&lt;/p&gt;

&lt;p&gt;FWIW I still list further log messages and details just in case that information may be useful in the future.&lt;/p&gt;


&lt;p&gt;@Jun Rao:  Yes, I did see ZK expiration in &lt;tt&gt;controller.log&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO [SessionExpirationListener on 0], ZK expired; shut down all controller components and &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to re-elect (kafka.controller.KafkaController$SessionExpirationListener)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Below are some further details.  Things turn bad at 11:01.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;kafka1 (Kafka broker)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;server.log&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-30 07:18:56,481] INFO Completed load of log test-0 with log end offset 0 (kafka.log.Log)
[2014-04-30 07:18:56,485] INFO Created log &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] in /app/kafka/log with properties {segment.index.bytes -&amp;gt; 10485760, file.delete.delay.ms -&amp;gt; 60000, segment.bytes -&amp;gt; 1073741824, flush.ms -&amp;gt; 9223372036854775807, delete.retention.ms -&amp;gt; 86400000, index.interval.bytes -&amp;gt; 4096, retention.bytes -&amp;gt; -1, cleanup.policy -&amp;gt; delete, segment.ms -&amp;gt; 172800000, max.message.bytes -&amp;gt; 1000012, flush.messages -&amp;gt; 9223372036854775807, min.cleanable.dirty.ratio -&amp;gt; 0.5, retention.ms -&amp;gt; 172800000}. (kafka.log.LogManager)
[2014-04-30 07:18:56,486] WARN Partition [test,0] on broker 0: No checkpointed highwatermark is found &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (kafka.cluster.Partition)
[2014-04-30 07:19:32,637] INFO Closing socket connection to /127.0.1.1. (kafka.network.Processor)
[2014-04-30 07:19:37,328] INFO Closing socket connection to /127.0.0.1. (kafka.network.Processor)
[2014-04-30 07:19:56,356] INFO Closing socket connection to /127.0.1.1. (kafka.network.Processor)
[2014-04-30 07:20:52,090] ERROR Closing socket &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /127.0.1.1 because of error (kafka.network.Processor)
java.io.IOException: Connection reset by peer
        at sun.nio.ch.FileDispatcher.read0(Native Method)
        at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)
        at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:251)
        at sun.nio.ch.IOUtil.read(IOUtil.java:224)
        at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:254)
        at kafka.utils.Utils$.read(Utils.scala:375)
        at kafka.network.BoundedByteBufferReceive.readFrom(BoundedByteBufferReceive.scala:54)
        at kafka.network.Processor.read(SocketServer.scala:347)
        at kafka.network.Processor.run(SocketServer.scala:245)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:701)
[2014-04-30 07:21:02,805] INFO Closing socket connection to /127.0.1.1. (kafka.network.Processor)
[2014-04-30 07:21:05,803] INFO Closing socket connection to /127.0.0.1. (kafka.network.Processor)
[2014-04-30 11:01:57,138] INFO Closing socket connection to /127.0.1.1. (kafka.network.Processor)
[2014-04-30 11:01:59,561] INFO Closing socket connection to /127.0.1.1. (kafka.network.Processor)
[2014-04-30 11:01:59,648] INFO 0 successfully elected as leader (kafka.server.ZookeeperLeaderElector)
[2014-04-30 11:01:59,692] INFO conflict in /controller data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398855719690&quot;&lt;/span&gt;} stored data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398855719646&quot;&lt;/span&gt;} (kafka.utils.ZkUtils$)
[2014-04-30 11:01:59,699] INFO I wrote &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; conflicted ephemeral node [{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398855719690&quot;&lt;/span&gt;}] at /controller a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; back in a different session, hence I will backoff &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node to be deleted by Zookeeper and retry (kafka.utils.ZkUtils$)
[2014-04-30 11:02:05,704] INFO conflict in /controller data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398855719690&quot;&lt;/span&gt;} stored data: {&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398855719646&quot;&lt;/span&gt;} (kafka.utils.ZkUtils$)
[2014-04-30 11:02:05,711] INFO I wrote &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; conflicted ephemeral node [{&lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;brokerid&quot;&lt;/span&gt;:0,&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1398855719690&quot;&lt;/span&gt;}] at /controller a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; back in a different session, hence I will backoff &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; node to be deleted by Zookeeper and retry (kafka.utils.ZkUtils$)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;tt&gt;state-change.log&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-30 07:18:56,433] TRACE Controller 0 epoch 1 changed state of replica 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from NewReplica to OnlineReplica (state.change.logger)
[2014-04-30 07:18:56,443] TRACE Broker 0 received LeaderAndIsr request (LeaderAndIsrInfo:(Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1),ReplicationFactor:1),AllReplicas:0) correlation id 7 from controller 0 epoch 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-30 07:18:56,448] TRACE Broker 0 handling LeaderAndIsr request correlationId 7 from controller 0 epoch 1 starting the become-leader transition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-30 07:18:56,455] TRACE Broker 0 stopped fetchers as part of become-leader request from controller 0 epoch 1 with correlation id 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-30 07:18:56,495] TRACE Broker 0 completed LeaderAndIsr request correlationId 7 from controller 0 epoch 1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the become-leader transition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-30 07:18:56,506] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-30 07:18:56,525] TRACE Broker 0 cached leader info (LeaderAndIsrInfo:(Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1),ReplicationFactor:1),AllReplicas:0) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] in response to UpdateMetadata request sent by controller 0 epoch 1 with correlation id 7 (state.change.logger)
[2014-04-30 07:18:56,526] TRACE Controller 0 epoch 1 received response correlationId 7 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a request sent to broker id:0,host:kafka1,port:9092 (state.change.logger)
[2014-04-30 11:01:59,564] TRACE Controller 0 epoch 1 changed partition [test,0] state from OnlinePartition to OfflinePartition (state.change.logger)
[2014-04-30 11:01:59,569] TRACE Controller 0 epoch 1 started leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-30 11:01:59,589] ERROR Controller 0 epoch 1 initiated state change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OfflinePartition to OnlinePartition failed (state.change.logger)
kafka.common.NoReplicaOnlineException: No replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is alive. Live brokers are: [Set()], Assigned replicas are: [List(0)]
        at kafka.controller.OfflinePartitionLeaderSelector.selectLeader(PartitionLeaderSelector.scala:61)
        at kafka.controller.PartitionStateMachine.electLeaderForPartition(PartitionStateMachine.scala:336)
        at kafka.controller.PartitionStateMachine.kafka$controller$PartitionStateMachine$$handleStateChange(PartitionStateMachine.scala:185)
        at kafka.controller.PartitionStateMachine$$anonfun$triggerOnlinePartitionStateChange$3.apply(PartitionStateMachine.scala:99)
        at kafka.controller.PartitionStateMachine$$anonfun$triggerOnlinePartitionStateChange$3.apply(PartitionStateMachine.scala:96)
        at scala.collection.TraversableLike$WithFilter$$anonfun$foreach$1.apply(TraversableLike.scala:772)
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:98)
        at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:98)
        at scala.collection.mutable.HashTable$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreachEntry(HashTable.scala:226)
        at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:39)
        at scala.collection.mutable.HashMap.foreach(HashMap.scala:98)
        at scala.collection.TraversableLike$WithFilter.foreach(TraversableLike.scala:771)
        at kafka.controller.PartitionStateMachine.triggerOnlinePartitionStateChange(PartitionStateMachine.scala:96)
        at kafka.controller.KafkaController.onBrokerFailure(KafkaController.scala:433)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1$$anonfun$apply$mcV$sp$1.apply$mcV$sp(ReplicaStateMachine.scala:344)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1$$anonfun$apply$mcV$sp$1.apply(ReplicaStateMachine.scala:330)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1$$anonfun$apply$mcV$sp$1.apply(ReplicaStateMachine.scala:330)
        at kafka.metrics.KafkaTimer.time(KafkaTimer.scala:33)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1.apply$mcV$sp(ReplicaStateMachine.scala:329)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1.apply(ReplicaStateMachine.scala:328)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener$$anonfun$handleChildChange$1.apply(ReplicaStateMachine.scala:328)
        at kafka.utils.Utils$.inLock(Utils.scala:538)
        at kafka.controller.ReplicaStateMachine$BrokerChangeListener.handleChildChange(ReplicaStateMachine.scala:327)
        at org.I0Itec.zkclient.ZkClient$7.run(ZkClient.java:568)
        at org.I0Itec.zkclient.ZkEventThread.run(ZkEventThread.java:71)
[2014-04-30 11:01:59,625] TRACE Controller 0 epoch 1 changed state of replica 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OnlineReplica to OfflineReplica (state.change.logger)
[2014-04-30 11:01:59,676] TRACE Controller 0 epoch 2 started leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] (state.change.logger)
[2014-04-30 11:01:59,686] ERROR Controller 0 epoch 2 initiated state change &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] from OfflinePartition to OnlinePartition failed (state.change.logger)
kafka.common.NoReplicaOnlineException: No replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is alive. Live brokers are: [Set()], Assigned replicas are: [List(0)]
        at kafka.controller.OfflinePartitionLeaderSelector.selectLeader(PartitionLeaderSelector.scala:61)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;tt&gt;controller.log&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2014-04-30 07:18:56,354] DEBUG [TopicChangeListener on Controller 0]: Topic change listener fired &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; path /brokers/topics with children test (kafka.controller.PartitionStateMachine$TopicChangeListener)
[2014-04-30 07:18:56,373] INFO [TopicChangeListener on Controller 0]: New topics: [Set(test)], deleted topics: [Set()], &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; partition replica assignment [Map([test,0] -&amp;gt; List(0))] (kafka.controller.PartitionStateMachine$TopicChangeListener)
[2014-04-30 07:18:56,373] INFO [Controller 0]: New topic creation callback &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [test,0] (kafka.controller.KafkaController)
[2014-04-30 07:18:56,376] INFO [Controller 0]: New partition creation callback &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [test,0] (kafka.controller.KafkaController)
[2014-04-30 07:18:56,376] INFO [Partition state machine on Controller 0]: Invoking state change to NewPartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions [test,0] (kafka.controller.PartitionStateMachine)
[2014-04-30 07:18:56,391] INFO [Replica state machine on controller 0]: Invoking state change to NewReplica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; replicas [Topic=test,Partition=0,Replica=0] (kafka.controller.ReplicaStateMachine)
[2014-04-30 07:18:56,394] INFO [Partition state machine on Controller 0]: Invoking state change to OnlinePartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions [test,0] (kafka.controller.PartitionStateMachine)
[2014-04-30 07:18:56,395] DEBUG [Partition state machine on Controller 0]: Live assigned replicas &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] are: [List(0)] (kafka.controller.PartitionStateMachine)
[2014-04-30 07:18:56,398] DEBUG [Partition state machine on Controller 0]: Initializing leader and isr &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] to (Leader:0,ISR:0,LeaderEpoch:0,ControllerEpoch:1) (kafka.controller.PartitionStateMachine)
[2014-04-30 07:18:56,431] INFO [Replica state machine on controller 0]: Invoking state change to OnlineReplica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; replicas [Topic=test,Partition=0,Replica=0] (kafka.controller.ReplicaStateMachine)
[2014-04-30 11:01:59,560] INFO [BrokerChangeListener on Controller 0]: Broker change listener fired &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; path /brokers/ids with children  (kafka.controller.ReplicaStateMachine$BrokerChangeListener)
[2014-04-30 11:01:59,560] INFO [BrokerChangeListener on Controller 0]: Newly added brokers: , deleted brokers: 0, all live brokers:  (kafka.controller.ReplicaStateMachine$BrokerChangeListener)
[2014-04-30 11:01:59,561] INFO [Controller-0-to-broker-0-send-thread], Shutting down (kafka.controller.RequestSendThread)
[2014-04-30 11:01:59,562] INFO [Controller-0-to-broker-0-send-thread], Stopped  (kafka.controller.RequestSendThread)
[2014-04-30 11:01:59,562] INFO [Controller-0-to-broker-0-send-thread], Shutdown completed (kafka.controller.RequestSendThread)
[2014-04-30 11:01:59,563] INFO [Controller 0]: Broker failure callback &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 0 (kafka.controller.KafkaController)
[2014-04-30 11:01:59,564] INFO [Controller 0]: Removed ArrayBuffer() from list of shutting down brokers. (kafka.controller.KafkaController)
[2014-04-30 11:01:59,564] INFO [Partition state machine on Controller 0]: Invoking state change to OfflinePartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions [test,0] (kafka.controller.PartitionStateMachine)
[2014-04-30 11:01:59,588] DEBUG [OfflinePartitionLeaderSelector]: No broker in ISR is alive &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [test,0]. Pick the leader from the alive assigned replicas:  (kafka.controller.OfflinePartitionLeaderSelector)
[2014-04-30 11:01:59,595] INFO [Replica state machine on controller 0]: Invoking state change to OfflineReplica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; replicas [Topic=test,Partition=0,Replica=0] (kafka.controller.ReplicaStateMachine)
[2014-04-30 11:01:59,597] DEBUG [Controller 0]: Removing replica 0 from ISR 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0]. (kafka.controller.KafkaController)
[2014-04-30 11:01:59,625] INFO [Controller 0]: New leader and ISR &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [test,0] is {&lt;span class=&quot;code-quote&quot;&gt;&quot;leader&quot;&lt;/span&gt;:-1,&lt;span class=&quot;code-quote&quot;&gt;&quot;leader_epoch&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;isr&quot;&lt;/span&gt;:[]} (kafka.controller.KafkaController)
[2014-04-30 11:01:59,628] DEBUG The stop replica request (delete = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) sent to broker 0 is  (kafka.controller.ControllerBrokerRequestBatch)
[2014-04-30 11:01:59,629] DEBUG The stop replica request (delete = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) sent to broker 0 is [Topic=test,Partition=0,Replica=0] (kafka.controller.ControllerBrokerRequestBatch)
[2014-04-30 11:01:59,635] WARN [Channel manager on controller 0]: Not sending request Name: StopReplicaRequest; Version: 0; CorrelationId: 11; ClientId: ; DeletePartitions: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; ControllerId: 0; ControllerEpoch: 1; Partitions: [test,0] to broker 0, since it is offline. (kafka.controller.ControllerChannelManager)
[2014-04-30 11:01:59,644] INFO [Controller 0]: Controller shutdown complete (kafka.controller.KafkaController)
[2014-04-30 11:01:59,649] INFO [Controller 0]: Broker 0 starting become controller state transition (kafka.controller.KafkaController)
[2014-04-30 11:01:59,651] INFO [Controller 0]: Controller 0 incremented epoch to 2 (kafka.controller.KafkaController)
[2014-04-30 11:01:59,672] INFO [Controller 0]: Partitions undergoing preferred replica election:  (kafka.controller.KafkaController)
[2014-04-30 11:01:59,672] INFO [Controller 0]: Partitions that completed preferred replica election:  (kafka.controller.KafkaController)
[2014-04-30 11:01:59,672] INFO [Controller 0]: Resuming preferred replica election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions:  (kafka.controller.KafkaController)
[2014-04-30 11:01:59,673] INFO [Controller 0]: Partitions being reassigned: Map() (kafka.controller.KafkaController)
[2014-04-30 11:01:59,673] INFO [Controller 0]: Partitions already reassigned: List() (kafka.controller.KafkaController)
[2014-04-30 11:01:59,673] INFO [Controller 0]: Resuming reassignment of partitions: Map() (kafka.controller.KafkaController)
[2014-04-30 11:01:59,675] INFO [Controller 0]: List of topics to be deleted:  (kafka.controller.KafkaController)
[2014-04-30 11:01:59,675] INFO [Controller 0]: List of topics ineligible &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion: test (kafka.controller.KafkaController)
[2014-04-30 11:01:59,675] INFO [Controller 0]: Currently active brokers in the cluster: Set() (kafka.controller.KafkaController)
[2014-04-30 11:01:59,675] INFO [Controller 0]: Currently shutting brokers in the cluster: Set() (kafka.controller.KafkaController)
[2014-04-30 11:01:59,675] INFO [Controller 0]: Current list of topics in the cluster: Set(test) (kafka.controller.KafkaController)
[2014-04-30 11:01:59,676] INFO [Replica state machine on controller 0]: Started replica state machine with initial state -&amp;gt; Map([Topic=test,Partition=0,Replica=0] -&amp;gt; ReplicaDeletionIneligible) (kafka.controller.ReplicaStateMachine)
[2014-04-30 11:01:59,685] DEBUG [OfflinePartitionLeaderSelector]: No broker in ISR is alive &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [test,0]. Pick the leader from the alive assigned replicas:  (kafka.controller.OfflinePartitionLeaderSelector)
[2014-04-30 11:01:59,686] INFO [Partition state machine on Controller 0]: Started partition state machine with initial state -&amp;gt; Map([test,0] -&amp;gt; OfflinePartition) (kafka.controller.PartitionStateMachine)
[2014-04-30 11:01:59,687] INFO [Controller 0]: Broker 0 is ready to serve as the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; controller with epoch 2 (kafka.controller.KafkaController)
[2014-04-30 11:01:59,688] INFO [Controller 0]: Starting preferred replica leader election &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions  (kafka.controller.KafkaController)
[2014-04-30 11:01:59,688] INFO [Partition state machine on Controller 0]: Invoking state change to OnlinePartition &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partitions  (kafka.controller.PartitionStateMachine)
[2014-04-30 11:01:59,690] INFO [SessionExpirationListener on 0], ZK expired; shut down all controller components and &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to re-elect (kafka.controller.KafkaController$SessionExpirationListener)
[2014-04-30 11:01:59,690] INFO [Controller 0]: Controller shutdown complete (kafka.controller.KafkaController)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;zookeeper1 (ZooKeeper server)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;zookeeper.log&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-04-30 07:32:37,460 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /10.0.0.21:43468
2014-04-30 07:32:37,462 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@793] - Connection request from old client /10.0.0.21:43468; will be dropped &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; server is in r-o mode
2014-04-30 07:32:37,462 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@832] - Client attempting to renew session 0x145b15f015d0000 at /10.0.0.21:43468
2014-04-30 07:32:37,463 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@595] - Established session 0x145b15f015d0000 with negotiated timeout 6000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43468
2014-04-30 11:01:57,832 [myid:] - INFO  [SessionTracker:ZooKeeperServer@325] - Expiring session 0x145b15f015d0000, timeout of 6000ms exceeded
2014-04-30 11:01:57,833 [myid:] - INFO  [SessionTracker:ZooKeeperServer@325] - Expiring session 0x145b15f015d0009, timeout of 6000ms exceeded
2014-04-30 11:01:57,837 [myid:] - INFO  [ProcessThread(sid:0 cport:-1)::PrepRequestProcessor@476] - Processed session termination &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid: 0x145b15f015d0000
2014-04-30 11:01:57,837 [myid:] - INFO  [ProcessThread(sid:0 cport:-1)::PrepRequestProcessor@476] - Processed session termination &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sessionid: 0x145b15f015d0009
2014-04-30 11:01:57,842 [myid:] - INFO  [SyncThread:0:NIOServerCnxn@1001] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43468 which had sessionid 0x145b15f015d0000
2014-04-30 11:01:57,845 [myid:] - INFO  [SyncThread:0:NIOServerCnxn@1001] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43467 which had sessionid 0x145b15f015d0009
2014-04-30 11:01:59,001 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /10.0.0.21:43469
2014-04-30 11:01:59,002 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@793] - Connection request from old client /10.0.0.21:43469; will be dropped &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; server is in r-o mode
2014-04-30 11:01:59,002 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@832] - Client attempting to renew session 0x145b15f015d0009 at /10.0.0.21:43469
2014-04-30 11:01:59,003 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@588] - Invalid session 0x145b15f015d0009 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43469, probably expired
2014-04-30 11:01:59,004 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1001] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43469 which had sessionid 0x145b15f015d0009
2014-04-30 11:01:59,005 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /10.0.0.21:43470
2014-04-30 11:01:59,008 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@793] - Connection request from old client /10.0.0.21:43470; will be dropped &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; server is in r-o mode
2014-04-30 11:01:59,008 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@839] - Client attempting to establish &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session at /10.0.0.21:43470
2014-04-30 11:01:59,012 [myid:] - INFO  [SyncThread:0:ZooKeeperServer@595] - Established session 0x145b15f015d000b with negotiated timeout 6000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43470
2014-04-30 11:01:59,545 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /10.0.0.21:43471
2014-04-30 11:01:59,545 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@793] - Connection request from old client /10.0.0.21:43471; will be dropped &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; server is in r-o mode
2014-04-30 11:01:59,545 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@832] - Client attempting to renew session 0x145b15f015d0000 at /10.0.0.21:43471
2014-04-30 11:01:59,546 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@588] - Invalid session 0x145b15f015d0000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43471, probably expired
2014-04-30 11:01:59,546 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1001] - Closed socket connection &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43471 which had sessionid 0x145b15f015d0000
2014-04-30 11:01:59,553 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@197] - Accepted socket connection from /10.0.0.21:43472
2014-04-30 11:01:59,555 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@793] - Connection request from old client /10.0.0.21:43472; will be dropped &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; server is in r-o mode
2014-04-30 11:01:59,556 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@839] - Client attempting to establish &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; session at /10.0.0.21:43472
2014-04-30 11:01:59,557 [myid:] - INFO  [SyncThread:0:ZooKeeperServer@595] - Established session 0x145b15f015d000c with negotiated timeout 6000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; client /10.0.0.21:43472
2014-04-30 11:01:59,687 [myid:] - INFO  [ProcessThread(sid:0 cport:-1)::PrepRequestProcessor@627] - Got user-level KeeperException when processing sessionid:0x145b15f015d000c type:delete cxid:0x19 zxid:0x5c txntype:-1 reqpath:n/a Error Path:/admin/preferred_replica_election Error:KeeperErrorCode = NoNode &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /admin/preferred_replica_election
2014-04-30 11:01:59,689 [myid:] - INFO  [ProcessThread(sid:0 cport:-1)::PrepRequestProcessor@627] - Got user-level KeeperException when processing sessionid:0x145b15f015d000c type:create cxid:0x1a zxid:0x5d txntype:-1 reqpath:n/a Error Path:/controller Error:KeeperErrorCode = NodeExists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /controller
2014-04-30 11:02:05,700 [myid:] - INFO  [ProcessThread(sid:0 cport:-1)::PrepRequestProcessor@627] - Got user-level KeeperException when processing sessionid:0x145b15f015d000c type:create cxid:0x1d zxid:0x5e txntype:-1 reqpath:n/a Error Path:/controller Error:KeeperErrorCode = NodeExists &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /controller
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;State of topic after issue did trigger&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ date;bin/kafka-topics.sh --zookeeper zookeeper1 --describe --topic test
Wed Apr 30 11:02:25 UTC 2014
Topic:test	PartitionCount:1	ReplicationFactor:1	Configs:
	Topic: test	Partition: 0	Leader: -1	Replicas: 0	Isr:
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;b&gt;Notes&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Kafka kinda recovered at some point.&lt;/p&gt;

&lt;p&gt;What indicated a recovery:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;state-change.log&lt;/tt&gt; reverted back to normal messages (partition wen tfrom OfflinePartition to OnlinePartition with leader 0; leader -1 was replaced with leader 0; etc.)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;kafka-topics.sh --descripe --topic test&lt;/tt&gt; showed normal operations, too, i.e. one partition with one replica with one leader and with one ISR.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What speaks against a full recovery:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;server.log&lt;/tt&gt; was still showing an indefinite loop of messages {{I wrote this conflicted ephemeral node [
{&quot;version&quot;:1,&quot;brokerid&quot;:0,&quot;timestamp&quot;:&quot;1398860644679&quot;}
&lt;p&gt;] at /controller a while back in a different session}}.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14072905" author="vincentye38" created="Thu, 24 Jul 2014 06:58:50 +0000"  >&lt;p&gt;I think the problem is because registerSessionExpirationListener() is called before controllerElector.startup in kafkaController.startup().&lt;br/&gt;
If the session expired before the election happens in controllerElector.startup, SessionExpirationListener calls election to create a ephemeral node. Then the election triggered by controllerElector.startup will run into the infinite loop dealing with the ephemeral node bug.&lt;/p&gt;</comment>
                            <comment id="14074081" author="junrao" created="Fri, 25 Jul 2014 05:19:29 +0000"  >&lt;p&gt;I think the proposed fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1451&quot; title=&quot;Broker stuck due to leader election race &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1451&quot;&gt;&lt;del&gt;KAFKA-1451&lt;/del&gt;&lt;/a&gt; will fix this issue too.&lt;/p&gt;</comment>
                            <comment id="14105480" author="yiyang li" created="Thu, 21 Aug 2014 15:49:55 +0000"  >&lt;p&gt;Hello, I am totally new to Kafka, and we are .Net developers who is testing the kafka by the kafka-net library. The Nuget package is still under alpha version, leaving lots of functionality not implemented. &lt;/p&gt;

&lt;p&gt;We recently got this problem when we embed a producer in a service, where according to the library, it will do a ResponseTimeoutCheck every 30000 ms. However, one of the client throws an error (the others are fine)&lt;/p&gt;

&lt;p&gt;ERROR Closing socket for /10.207.x.x because of error (kafka.network.Processor)&lt;br/&gt;
java.io.IOException: An existing connection was forcibly closed by the remote host&lt;br/&gt;
        at sun.nio.ch.SocketDispatcher.write0(Native Method)&lt;br/&gt;
        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:51)&lt;br/&gt;
        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)&lt;br/&gt;
        at sun.nio.ch.IOUtil.write(IOUtil.java:65)&lt;br/&gt;
        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:466)&lt;br/&gt;
        at kafka.api.FetchResponseSend.writeTo(FetchResponse.scala:217)&lt;br/&gt;
        at kafka.network.Processor.write(SocketServer.scala:375)&lt;br/&gt;
        at kafka.network.Processor.run(SocketServer.scala:247)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
log4j:ERROR Failed to rename &lt;span class=&quot;error&quot;&gt;&amp;#91;/cygdrive/c/kafka/bin/../logs/server.log&amp;#93;&lt;/span&gt; to &lt;span class=&quot;error&quot;&gt;&amp;#91;/cygdrive/c/kafka/bin/../logs/server.log.2014-08-20-17&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;under the kafka-server-start.sh&lt;/p&gt;

&lt;p&gt;I have change the log4j properties to &lt;/p&gt;

&lt;p&gt;log4j.appender.kafkaAppender.DatePattern=&apos;.&apos;yyyy-MM&lt;br/&gt;
log4j.appender.kafkaAppender.File=${kafka.logs.dir}/server.log&lt;/p&gt;

&lt;p&gt;Other backgound:&lt;br/&gt;
Kafka binaries: Scala 2.9.2 - kafka_2.9.2-0.8.1.1&lt;br/&gt;
Brokers: 3 brokers in 3 different machines, using the same port under each IP  (borker id = 0, 1, 2)&lt;br/&gt;
Zookeeper: 2181 port at one of the brokers&lt;/p&gt;

&lt;p&gt;I understand that it might be hard to reproduce as it might be the problem in incomplete .Net client&lt;/p&gt;

&lt;p&gt;Details of ResponseTimeoutCheck:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/YiyangLi/kafka-net/blob/master/src/kafka-net/KafkaConnection.cs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/YiyangLi/kafka-net/blob/master/src/kafka-net/KafkaConnection.cs&lt;/a&gt; (Line 200)&lt;/p&gt;

&lt;p&gt;Thanks. &lt;/p&gt;</comment>
                            <comment id="14105546" author="guozhang" created="Thu, 21 Aug 2014 16:32:32 +0000"  >&lt;p&gt;Hello Yiyang,&lt;/p&gt;

&lt;p&gt;Could you send an email to the users mailing list about your issue since it seems not relevant to this jira?&lt;/p&gt;</comment>
                            <comment id="14105553" author="yiyang li" created="Thu, 21 Aug 2014 16:36:59 +0000"  >&lt;p&gt;could you elaborate the users mailing list? &lt;/p&gt;

&lt;p&gt;It&apos;s the same issue as the following:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://grokbase.com/t/kafka/users/141nmnah7e/kafka-server-occure-java-nio-bufferunderflowexception&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://grokbase.com/t/kafka/users/141nmnah7e/kafka-server-occure-java-nio-bufferunderflowexception&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14105587" author="guozhang" created="Thu, 21 Aug 2014 16:58:58 +0000"  >&lt;p&gt;You can send an email to users@kafka.apache.org.&lt;/p&gt;

&lt;p&gt;Here is the summary of the mailing lists:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://kafka.apache.org/contact.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://kafka.apache.org/contact.html&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12600201" name="0002-KAFKA-1029-Use-brokerId-instead-of-leaderId-when-tri.patch" size="1899" author="smeder" created="Tue, 27 Aug 2013 16:51:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345619</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nlm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345920</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>