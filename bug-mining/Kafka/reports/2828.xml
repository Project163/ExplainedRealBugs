<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10470] zstd decompression with small batches is slow and causes excessive GC</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10470</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5150&quot; title=&quot;LZ4 decompression is 4-5x slower than Snappy on small batches / messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5150&quot;&gt;&lt;del&gt;KAFKA-5150&lt;/del&gt;&lt;/a&gt; but for zstd instead of LZ4, it appears that a large decompression buffer (128kb) created by zstd-jni per batch is causing a significant performance bottleneck.&lt;/p&gt;

&lt;p&gt;The next upcoming version of zstd-jni (1.4.5-7) will have a new constructor for ZstdInputStream that allows the client to pass its own buffer.&#160; A similar fix as &lt;a href=&quot;https://github.com/apache/kafka/pull/2967&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #2967&lt;/a&gt; could be used to have the&#160;&#160;ZstdConstructor use a BufferSupplier to re-use the decompression buffer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13326529">KAFKA-10470</key>
            <summary>zstd decompression with small batches is slow and causes excessive GC</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yuzawa-san">James Yuzawa</assignee>
                                    <reporter username="wolfchimneyrock">Robert Wagner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Sep 2020 17:01:32 +0000</created>
                <updated>Wed, 11 Nov 2020 02:12:10 +0000</updated>
                            <resolved>Wed, 11 Nov 2020 02:12:10 +0000</resolved>
                                    <version>2.5.1</version>
                                    <fixVersion>2.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17193398" author="chia7712" created="Thu, 10 Sep 2020 06:26:19 +0000"  >&lt;p&gt;Yep, that is why I submitted the patch to zstd-jni. the pressure of GC produced by kafka Zstd compression is trouble to me also.&lt;/p&gt;</comment>
                            <comment id="17202351" author="yuzawa-san" created="Fri, 25 Sep 2020 18:28:56 +0000"  >&lt;p&gt;I also noticed the large amount of allocations and GC activity in my profiling. However, there is an additional issue related to the the number of calls Kafka does to ZstdOutputStream.write(int). Each of these single byte writes gets sent to the JNI for compression. I think an input buffer could improve this, by only crossing over into the JNI code when a critical mass of input has been accumulated. Option 1: We could wrap the ZstdOutputStream with a&#160;BufferedOutputStream like how it is done for GZIP currently. Option 2: Alter the library to use buffering. I have this ticket open with the zstd-jni project &lt;a href=&quot;https://github.com/luben/zstd-jni/issues/141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/luben/zstd-jni/issues/141&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17217623" author="wolfchimneyrock" created="Tue, 20 Oct 2020 14:01:50 +0000"  >
&lt;p&gt;&lt;a href=&quot;https://github.com/luben/zstd-jni/releases/tag/v1.4.5-7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;zstd-jni version 1.4.5-7&lt;/a&gt; has been released, which internally implements a BufferPool to re-use the decompression buffer without changing their API.&#160; This fixes the issue of GC pressure but doesn&apos;t address &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzawa-san&quot; class=&quot;user-hover&quot; rel=&quot;yuzawa-san&quot;&gt;yuzawa-san&lt;/a&gt;&apos;s concern about JNI boundary crossings.&lt;/p&gt;

&lt;p&gt;My initial test with this updated dependency shows memory allocations and GC pressure comparable to gzip. overall throughput with small message batches still seems to lag behind all other codecs.&lt;/p&gt;</comment>
                            <comment id="17217626" author="yuzawa-san" created="Tue, 20 Oct 2020 14:11:21 +0000"  >&lt;p&gt;The maintainer of zstd-jni seems to be back from vacation, so I was going to inquire more about what they think about adding more buffering on that linked github issue above. I&apos;m finding the performance hits are occurring when Kafka writes a few bytes at a time typically from ByteUtils class when using the ZstdOutputStream. I also found that the ZstdInputStream has the same performance hit when reading a few bytes at a time. As a stopgap solution, we could add a&#160;BufferedOutputStream and BufferedInputStream like it is done for GZIP:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java#L57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java#L57&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java#L69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java#L69&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but in the zstd enum value &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java#L118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java#L118&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This would help but at the cost of not being able to reuse the internal buffers within the&#160;BufferedOutputStream and and&#160;BufferedInputStream.&lt;/p&gt;</comment>
                            <comment id="17217734" author="wolfchimneyrock" created="Tue, 20 Oct 2020 16:27:19 +0000"  >&lt;p&gt;I have run a test with the zstd streams wrapped with buffered streams as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzawa-san&quot; class=&quot;user-hover&quot; rel=&quot;yuzawa-san&quot;&gt;yuzawa-san&lt;/a&gt; mentioned, and together with the upgraded zstd-jni package seems to give zstd a throughput similar to gzip when using small message batches, and there is no additional discernable broker memory overhead.  I think this is the way to go.&lt;/p&gt;

&lt;p&gt;I don&apos;t think that not being able to re-use the BufferedOutputStream or BufferedInputStream buffers is that important.&lt;/p&gt;</comment>
                            <comment id="17217786" author="yuzawa-san" created="Tue, 20 Oct 2020 17:09:26 +0000"  >&lt;p&gt;Ok, I&apos;m still going to attempt to add some buffering within the library per my conversation here&#160;&lt;a href=&quot;https://github.com/luben/zstd-jni/issues/141#issuecomment-712922973&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/luben/zstd-jni/issues/141#issuecomment-712922973&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17217836" author="wolfchimneyrock" created="Tue, 20 Oct 2020 18:06:36 +0000"  >&lt;p&gt;sounds good&lt;/p&gt;</comment>
                            <comment id="17218064" author="chia7712" created="Wed, 21 Oct 2020 02:51:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzawa-san&quot; class=&quot;user-hover&quot; rel=&quot;yuzawa-san&quot;&gt;yuzawa-san&lt;/a&gt; Thanks for your effort on zstd-jni. Do you want to take over this issue to leverage the new BufferPool you introduced ? &lt;/p&gt;

&lt;p&gt;There are two tasks for this issue.&lt;/p&gt;

&lt;p&gt;1. update zstd to v1.4.5-8 to use the new interface (BufferPool) introduced by your PR (&lt;a href=&quot;https://github.com/luben/zstd-jni/pull/146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/luben/zstd-jni/pull/146&lt;/a&gt;)&lt;br/&gt;
2. implement the BufferPool of zstd to reuse the byte buffer (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/CompressionType.java&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Also, there is a PR (&lt;a href=&quot;https://github.com/apache/kafka/pull/9229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9229&lt;/a&gt;) trying to use true reusable BufferSupplier to create IO stream (before the PR, the passed BufferSupplier does not recycle the byte buffer).&lt;/p&gt;
</comment>
                            <comment id="17220488" author="chia7712" created="Mon, 26 Oct 2020 05:30:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuzawa-san&quot; class=&quot;user-hover&quot; rel=&quot;yuzawa-san&quot;&gt;yuzawa-san&lt;/a&gt; I have assigned this issue to you as you have filed a PR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ifc0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>