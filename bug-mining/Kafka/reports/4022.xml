<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17040] Unknown telemetry state: TERMINATED thrown when closing AsyncKafkaConsumer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17040</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;An error is occasionally thrown when closing the &lt;tt&gt;AsyncKafkaConsumer&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ERROR] 2024-06-20 17:13:54,121 [consumer_background_thread] org.apache.kafka.clients.consumer.internals.ConsumerNetworkThread lambda$configureThread$0 - Uncaught exception in thread &apos;consumer_background_thread&apos;:
java.lang.IllegalStateException: Unknown telemetry state: TERMINATED
&#160; &#160; &#160; &#160; at org.apache.kafka.common.telemetry.internals.ClientTelemetryReporter$DefaultClientTelemetrySender.timeToNextUpdate(ClientTelemetryReporter.java:363)
&#160; &#160; &#160; &#160; at org.apache.kafka.clients.NetworkClient$TelemetrySender.maybeUpdate(NetworkClient.java:1392)
&#160; &#160; &#160; &#160; at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:668)
&#160; &#160; &#160; &#160; at org.apache.kafka.clients.consumer.internals.NetworkClientDelegate.poll(NetworkClientDelegate.java:143)
&#160; &#160; &#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerNetworkThread.sendUnsentRequests(ConsumerNetworkThread.java:299)
&#160; &#160; &#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerNetworkThread.cleanup(ConsumerNetworkThread.java:318)
&#160; &#160; &#160; &#160; at org.apache.kafka.clients.consumer.internals.ConsumerNetworkThread.run(ConsumerNetworkThread.java:105)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The issue appears to be that the &lt;tt&gt;TERMINATED&lt;/tt&gt; state is not expected in the switch statement inside &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/telemetry/internals/ClientTelemetryReporter.java#L307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;timeToNextUpdate()&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As an aside, the error message might make more sense to be written as &quot;&lt;em&gt;Unexpected&lt;/em&gt; telemetry state&quot; instead of &quot;&lt;em&gt;Unknown&lt;/em&gt; telemetry state&quot; since &lt;tt&gt;TERMINATED&lt;/tt&gt; is a known state, but heretofore unexpected.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13583818">KAFKA-17040</key>
            <summary>Unknown telemetry state: TERMINATED thrown when closing AsyncKafkaConsumer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apoorvmittal10">Apoorv Mittal</assignee>
                                    <reporter username="kirktrue">Kirk True</reporter>
                        <labels>
                            <label>consumer-threading-refactor</label>
                    </labels>
                <created>Tue, 25 Jun 2024 18:45:16 +0000</created>
                <updated>Wed, 11 Dec 2024 20:48:05 +0000</updated>
                            <resolved>Wed, 11 Dec 2024 20:48:05 +0000</resolved>
                                    <version>3.9.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>clients</component>
                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17860012" author="apoorvmittal10" created="Tue, 25 Jun 2024 19:21:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; Thanks for reporting, I can take it up. Just a quick question, the error only occurs while closing the consumer, correct? Is it under scenarios when consumer close took more time than next network client poll time? I expect that&apos;s the only scenario when this issue can occur. I am just wondering when specifically this scenrio happens?&lt;/p&gt;</comment>
                            <comment id="17904232" author="JIRAUSER300183" created="Mon, 9 Dec 2024 17:50:18 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apoorvmittal10&quot; class=&quot;user-hover&quot; rel=&quot;apoorvmittal10&quot;&gt;apoorvmittal10&lt;/a&gt; , in case it helps, I believe this issue happens when the consumer close cannot wait for the network thread to close (ex. close with low timeout or interrupted). This flow:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;async consumer app thread triggers action to close network thread, and block until it completes (won&apos;t wait if interrupted or low timeout) &lt;a href=&quot;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1323&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1323&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;async consumer app thread moves on and closes the telemetry reporter &lt;a href=&quot;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1335&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1335&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;background thread still running the network thread close, makes it to the point where it polls the client to send the unsent requests it has before closing &lt;a href=&quot;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L309&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L309&lt;/a&gt;&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;with that sequence, we would end up trying to update the telemetry reporter that is already TERMINATED I expect, so this line would throw when we poll the network client:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/NetworkClient.java#L643&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/clients/src/main/java/org/apache/kafka/clients/NetworkClient.java#L643&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Makes sense? I was taking a look at a flaky test we have with interrupt and saw this error a lot, it may help here: &lt;a href=&quot;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/core/src/test/scala/integration/kafka/api/PlaintextConsumerTest.scala#L834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3a9777a667620c5f926176452744c751df4dac17/core/src/test/scala/integration/kafka/api/PlaintextConsumerTest.scala#L834&lt;/a&gt; &#160;&lt;/p&gt;</comment>
                            <comment id="17904862" author="apoorvmittal10" created="Wed, 11 Dec 2024 17:08:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lianetm&quot; class=&quot;user-hover&quot; rel=&quot;lianetm&quot;&gt;lianetm&lt;/a&gt; for adding details. I have created a PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/18143,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/18143,&lt;/a&gt; let me know if it makes sense.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13599144">KAFKA-18031</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1q000:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>