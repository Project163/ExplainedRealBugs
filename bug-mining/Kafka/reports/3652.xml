<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16089] Kafka Streams still leaking memory</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16089</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://github.com/apache/kafka/commit/58d6d2e5922df60cdc5c5c1bcd1c2d82dd2b71e2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/58d6d2e5922df60cdc5c5c1bcd1c2d82dd2b71e2&lt;/a&gt; a leak was fixed in the release candidate for 3.7.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, Kafka Streams still seems to be leaking memory (just slower) after the fix.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Attached is the `jeprof` output right before a crash after ~11 hours.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13563862">KAFKA-16089</key>
            <summary>Kafka Streams still leaking memory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nicktelford">Nicholas Telford</assignee>
                                    <reporter username="lucasbru">Lucas Brutschy</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Jan 2024 08:59:37 +0000</created>
                <updated>Mon, 26 Feb 2024 21:32:24 +0000</updated>
                            <resolved>Thu, 11 Jan 2024 21:02:34 +0000</resolved>
                                    <version>3.8.0</version>
                                    <fixVersion>3.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17804630" author="JIRAUSER302322" created="Tue, 9 Jan 2024 08:31:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/14852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14852&lt;/a&gt; was identified as a very likely suspect for introducing this leak - A soak test without the change ran with very little native memory growth. The change will be reverted in 3.7, until a solution was found&lt;/p&gt;</comment>
                            <comment id="17804648" author="JIRAUSER302322" created="Tue, 9 Jan 2024 09:16:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enether&quot; class=&quot;user-hover&quot; rel=&quot;enether&quot;&gt;enether&lt;/a&gt; Keeping the bug open but updating &quot;Affected Version&quot; to 3.8.0&lt;/p&gt;</comment>
                            <comment id="17805519" author="nicktelford" created="Thu, 11 Jan 2024 11:26:42 +0000"  >&lt;p&gt;I built a basic memory leak test, which essentially runs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;while (System.currentTimeMillis() - started &amp;lt; 3600000) {
    final RocksDBStore store = new RocksDBStore(&quot;test&quot;, &quot;test&quot;);
    try {
        store.init(context, store);
    } finally {
        store.close();
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And then ran it with the JVM args &lt;tt&gt;-Xms200m -Xmx200m -XX:+AlwaysPreTouch&lt;/tt&gt; to ensure the JVM heap doesn&apos;t grow over time.&lt;/p&gt;

&lt;p&gt;Measuring RSS, shows the memory leak:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065897/13065897_unfix.png&quot; height=&quot;280&quot; width=&quot;374&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I tracked it down to &lt;tt&gt;ColumnFamilyHandle#getDescriptor()&lt;/tt&gt;, called in the new &lt;tt&gt;mergeColumnFamilyHandleLists&lt;/tt&gt; method. A &lt;tt&gt;ColumnFamilyDescriptor&lt;/tt&gt; is &lt;b&gt;not&lt;/b&gt; a &lt;tt&gt;RocksObject&lt;/tt&gt;, which means it&apos;s not backed by any native memory. However, when calling &lt;tt&gt;ColumnFamilyHandle#getDescriptor()&lt;/tt&gt;, an internal &lt;a href=&quot;https://github.com/facebook/rocksdb/blob/c5fbfd7ad807867f85fb992a61a228e4417b55ea/db/column_family.cc#L91C21-L91C21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;rocksdb::db::ColumnFamilyDescriptor is allocated&lt;/a&gt;, copying the name of the column family and its options from the handle.&lt;/p&gt;

&lt;p&gt;Since `ColumnFamilyDescriptor` is not a `RocksObject`, it&apos;s not possible to free this allocated &lt;tt&gt;rocksdb::db::ColumnFamilyDescriptor&lt;/tt&gt;, which leaks.&lt;/p&gt;

&lt;p&gt;Fortunately, since we&apos;re only interested in the name of the column family, we can simply avoid calling &lt;tt&gt;ColumnFamilyHandle#getDescriptor()&lt;/tt&gt;, and instead just call &lt;tt&gt;ColumnFamilyHandle#getName()&lt;/tt&gt;, which does not leak memory.&lt;/p&gt;

&lt;p&gt;With this fixed, running the same test again demonstrates no memory leak:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13065898/13065898_fix.png&quot; height=&quot;275&quot; width=&quot;367&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I have opened an issue with RocksDB to report this bug: &lt;a href=&quot;https://github.com/facebook/rocksdb/issues/12224,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/rocksdb/issues/12224,&lt;/a&gt; but we are not dependent on it being resolved.&lt;/p&gt;</comment>
                            <comment id="17805551" author="JIRAUSER302322" created="Thu, 11 Jan 2024 12:25:49 +0000"  >&lt;p&gt;Thanks for the investigation, Nick!&lt;/p&gt;</comment>
                            <comment id="17805801" author="ableegoldman" created="Thu, 11 Jan 2024 21:01:57 +0000"  >&lt;p&gt;Yeah, nice investigation! That was a tricky one&lt;/p&gt;</comment>
                            <comment id="17806217" author="mjsax" created="Fri, 12 Jan 2024 22:05:11 +0000"  >&lt;p&gt;Great job!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13065898" name="fix.png" size="5237" author="nicktelford" created="Thu, 11 Jan 2024 11:20:33 +0000"/>
                            <attachment id="13065787" name="graphviz (1).svg" size="107678" author="JIRAUSER295470" created="Mon, 8 Jan 2024 08:58:26 +0000"/>
                            <attachment id="13065897" name="unfix.png" size="4407" author="nicktelford" created="Thu, 11 Jan 2024 11:16:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mlwo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>