<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:37:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15675] Fix flaky ConnectorRestartApiIntegrationTest.testMultiWorkerRestartOnlyConnector() test</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15675</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This integration test is flaky around 9% of test runs. Source: &lt;a href=&quot;https://ge.apache.org/scans/tests?search.relativeStartTime=P28D&amp;amp;search.rootProjectNames=KAFKA&amp;amp;tests.container=org.apache.kafka.connect.integration.ConnectorRestartApiIntegrationTest&amp;amp;tests.test=testMultiWorkerRestartOnlyConnector&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Gradle Enterprise test trends&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;One failure had this message:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: Failed to stop connector and tasks within 120000ms &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please see the attachments for the stack trace and stdout log.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13555250">KAFKA-15675</key>
            <summary>Fix flaky ConnectorRestartApiIntegrationTest.testMultiWorkerRestartOnlyConnector() test</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ChrisEgerton">Chris Egerton</assignee>
                                    <reporter username="kirktrue">Kirk True</reporter>
                        <labels>
                            <label>flaky-test</label>
                    </labels>
                <created>Mon, 23 Oct 2023 22:06:58 +0000</created>
                <updated>Thu, 1 Feb 2024 14:20:39 +0000</updated>
                            <resolved>Thu, 1 Feb 2024 14:20:39 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17810057" author="chrisegerton" created="Tue, 23 Jan 2024 17:36:01 +0000"  >&lt;p&gt;I&apos;ve done some analysis on this one and believe I&apos;ve found the root cause. It&apos;s a confluence of a few different issues, but the TL;DR is: &lt;b&gt;the request to &lt;tt&gt;POST /connectors/&amp;lt;connector&amp;gt;/restart?onlyFailed=false&amp;amp;includeTasks=false&lt;/tt&gt; fails with a 409 error, this does not cause the test to (immediately) fail, but the connector is never restarted, which causes the test to time out while &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/test/java/org/apache/kafka/connect/integration/ConnectorRestartApiIntegrationTest.java#L272-L275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;waiting for the connector to be stopped&lt;/a&gt;.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This kind of scenario probably raises several questions. Here&apos;s my best attempt to anticipate and address them:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Why does the 409 response not cause the test to immediately fail?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s unclear on the original rationale for this, but the code structure &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/test/java/org/apache/kafka/connect/util/clusters/EmbeddedConnect.java#L374-L383&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; is fairly clear: issue the request, and if the status code is less than 400, attempt to deserialize the body. Then, unconditionally, return either null or the deserialized response body.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Why is the 409 response occurring?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The cluster (or, to be more specific, either the worker that received the initial REST request or, if the request was forwarded, the leader) detected that a rebalance due to an added/removed connector or new task configs was about to take place, and rejected the request. See the &lt;tt&gt;DistributedHerder&lt;/tt&gt; class&apos;s &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java#L1467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;restartConnectorAndTasks&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java#L2302-L2307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;checkRebalanceNeeded&lt;/a&gt; methods for the logic to check for pending rebalances, and its logic for detecting pending rebalances &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java#L2385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java#L2400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, and &lt;a href=&quot;https://github.com/apache/kafka/blob/4d6a422e8607c257e58b6956061732dc33621fc2/connect/runtime/src/main/java/org/apache/kafka/connect/runtime/distributed/DistributedHerder.java#L2419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Why is a rebalance pending by the time we try to restart the connector? Shouldn&apos;t the cluster and the set of connectors and tasks on it be stable by this point?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Yes, the cluster and set of connectors and tasks on it should be stable by the time we issue our restart request. We check to make sure that &lt;a href=&quot;https://github.com/apache/kafka/blob/0ef89a7cc059b0ba9b2536e018303c9004ac9142/connect/runtime/src/test/java/org/apache/kafka/connect/integration/ConnectorRestartApiIntegrationTest.java#L116-L117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;every worker in the cluster is up and running&lt;/a&gt; before proceeding with the rest of the test, and that the &lt;a href=&quot;https://github.com/apache/kafka/blob/0ef89a7cc059b0ba9b2536e018303c9004ac9142/connect/runtime/src/test/java/org/apache/kafka/connect/integration/ConnectorRestartApiIntegrationTest.java#L252-L253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;connector and expected number of tasks are running&lt;/a&gt; before issuing the restart request. Unfortunately, the former check&#8211;for worker liveness across the cluster&#8211;does not guarantee that every worker has joined the cluster. This check is &lt;a href=&quot;https://github.com/apache/kafka/blob/0ef89a7cc059b0ba9b2536e018303c9004ac9142/connect/runtime/src/test/java/org/apache/kafka/connect/util/clusters/EmbeddedConnect.java#L956-L975&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;performed by issuing a request to the root resource&lt;/a&gt; (&lt;tt&gt;GET /&lt;/tt&gt;) for each worker: if the response is valid (i.e., its body matches the expected format), then the worker is considered up and running. However, this does not guarantee that the worker has actually completed startup: it may not have finished reading to the end of internal topics, or had a chance to contact the group coordinator and join the cluster yet.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After examining the logs of one test case, it appeared that the following sequence of events took place:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;A single worker completes startup (creates and reads to the end of internal topics, then joins the cluster)&lt;/li&gt;
	&lt;li&gt;The connector is created (by chance, the REST request to create the connector happens to be sent to the only worker that has completed startup so far)&lt;/li&gt;
	&lt;li&gt;The connector is assigned to the only worker currently in the cluster&lt;/li&gt;
	&lt;li&gt;The connector generates task configs&lt;/li&gt;
	&lt;li&gt;The tasks for that connector are assigned to the only worker currently in the cluster&lt;/li&gt;
	&lt;li&gt;The other, more sluggish, workers in the cluster detect the new connector and/or task configs, and realize that a rebalance is pending&lt;/li&gt;
	&lt;li&gt;An attempt is made to restart the connector (by chance, the REST request happens to be sent to a worker that knows a rebalance is pending, but has not yet completed that rebalance)&lt;/li&gt;
	&lt;li&gt;The restart request is rejected with a 409 response&lt;/li&gt;
	&lt;li&gt;The test fails&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There are a few action items that come to mind based on this analysis:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Unconditionally log an ERROR-level message in our integration testing framework whenever a REST request is met with a response whose status code is 300 or higher&lt;/li&gt;
	&lt;li&gt;Improve our worker liveness checks to guarantee not only that a worker&apos;s REST server has started, but that it has had a chance to join the cluster&lt;/li&gt;
	&lt;li&gt;Add retry logic when 409 responses are encountered during our integration tests (this one is debatable, but our CI infrastructure is so miraculously sluggish that rebalances from failure to read to the end of the config topic may not be out of the realm of possibility). One possible approach could be to re-perform a worker liveness check (one that guarantees that a worker is caught up on the config topic and has had a chance to (re-)join the cluster) and then re-issue the request, but only once.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13556146">KAFKA-15761</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13344623">KAFKA-10816</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063811" name="error.stacktrace.txt" size="4635" author="kirktrue" created="Mon, 23 Oct 2023 22:05:49 +0000"/>
                            <attachment id="13063812" name="error.stdout.txt" size="139254" author="kirktrue" created="Mon, 23 Oct 2023 22:05:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l54g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>