<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:23:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9796] Broker shutdown could be stuck forever under certain conditions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9796</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;During the broker initialisation, the Acceptor threads are started early to know the bound port and delays starting the processors to the end of the initialisation sequence. We have found out that the shutdown of a broker could be stuck forever under the following conditions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the shutdown procedure is started before the processors are started;&lt;/li&gt;
	&lt;li&gt;the `newConnections` queues of the processors are full; and&lt;/li&gt;
	&lt;li&gt;an extra new connection has been accepted but can&apos;t be queued up in a processor.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For instance, this could happen if a `NodeExistsException` is raised when the broker tries to register itself in ZK.&lt;/p&gt;

&lt;p&gt;When the above conditions happens, the shutting down triggers the shutdown of the acceptor threads and waits until they are (first thread dump bellow). If an acceptor as a pending connection which can&apos;t be queued up in a processor, it ends up waiting until space is made is new queue to accept the new connection (second thread dump bellow). As the processors are not started, the new connection queues are not drained so it never releases the acceptor thread.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Shutdown wait on acceptor to shutdown&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;main&quot; #1 prio=5 os_prio=0 cpu=3626.89ms elapsed=106360.56s tid=0x00007f625001c800 nid=0x272 waiting on condition  [0x00007f6257ca4000]
   java.lang.Thread.State: WAITING (parking)
	at jdk.internal.misc.Unsafe.park(java.base@11.0.5/Native Method)
	- parking to wait for  &amp;lt;0x0000000689a61800&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)
	at java.util.concurrent.locks.LockSupport.park(java.base@11.0.5/LockSupport.java:194)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(java.base@11.0.5/AbstractQueuedSynchronizer.java:885)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(java.base@11.0.5/AbstractQueuedSynchronizer.java:1039)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(java.base@11.0.5/AbstractQueuedSynchronizer.java:1345)
	at java.util.concurrent.CountDownLatch.await(java.base@11.0.5/CountDownLatch.java:232)
	at kafka.network.AbstractServerThread.shutdown(SocketServer.scala:430)
	at kafka.network.Acceptor.shutdown(SocketServer.scala:521)
	at kafka.network.SocketServer.$anonfun$stopProcessingRequests$2(SocketServer.scala:267)
	at kafka.network.SocketServer.$anonfun$stopProcessingRequests$2$adapted(SocketServer.scala:267)
	at kafka.network.SocketServer$$Lambda$604/0x0000000840540840.apply(Unknown Source)
	at scala.collection.Iterator.foreach(Iterator.scala:941)
	at scala.collection.Iterator.foreach$(Iterator.scala:941)
	at scala.collection.AbstractIterator.foreach(Iterator.scala:1429)
	at scala.collection.MapLike$DefaultValuesIterable.foreach(MapLike.scala:213)
	at kafka.network.SocketServer.stopProcessingRequests(SocketServer.scala:267)
	- locked &amp;lt;0x0000000689a61ac0&amp;gt; (a kafka.network.SocketServer)
	at kafka.server.KafkaServer.$anonfun$shutdown$5(KafkaServer.scala:806)
	at kafka.server.KafkaServer$$Lambda$602/0x000000084052b040.apply$mcV$sp(Unknown Source)
	at kafka.utils.CoreUtils$.swallow(CoreUtils.scala:68)
	at kafka.server.KafkaServer.shutdown(KafkaServer.scala:806)
	at kafka.server.KafkaServer.startup(KafkaServer.scala:522)
	at kafka.server.KafkaServerStartable.startup(KafkaServerStartable.scala:44)
	at kafka.Kafka$.main(Kafka.scala:82)
	at kafka.Kafka.main(Kafka.scala)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Acceptor waits on processor to accept the new connection&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;data-plane-kafka-socket-acceptor-ListenerName(EXTERNAL)-SASL_SSL-9092&quot; #54 prio=5 os_prio=0 cpu=16.23ms elapsed=106346.62s tid=0x00007f62523b5000 nid=0x2ca waiting on condition  [0x00007f6157130000]
   java.lang.Thread.State: WAITING (parking)
	at jdk.internal.misc.Unsafe.park(java.base@11.0.5/Native Method)
	- parking to wait for  &amp;lt;0x0000000689a7cad8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.park(java.base@11.0.5/LockSupport.java:194)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(java.base@11.0.5/AbstractQueuedSynchronizer.java:2081)
	at java.util.concurrent.ArrayBlockingQueue.put(java.base@11.0.5/ArrayBlockingQueue.java:367)
	at kafka.network.Processor.accept(SocketServer.scala:1020)
	at kafka.network.Acceptor.assignNewConnection(SocketServer.scala:639)
	at kafka.network.Acceptor.$anonfun$run$1(SocketServer.scala:566)
	at kafka.network.Acceptor.run(SocketServer.scala:550)
	at java.lang.Thread.run(java.base@11.0.5/Thread.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13295482">KAFKA-9796</key>
            <summary>Broker shutdown could be stuck forever under certain conditions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dajac">David Jacot</assignee>
                                    <reporter username="dajac">David Jacot</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Apr 2020 09:36:45 +0000</created>
                <updated>Wed, 3 Nov 2021 13:08:39 +0000</updated>
                            <resolved>Thu, 16 Apr 2020 16:15:00 +0000</resolved>
                                                    <fixVersion>2.6.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17078228" author="githubbot" created="Wed, 8 Apr 2020 12:24:31 +0000"  >&lt;p&gt;dajac commented on pull request #8448: &lt;span class=&quot;error&quot;&gt;&amp;#91;WIP&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9796&quot; title=&quot;Broker shutdown could be stuck forever under certain conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9796&quot;&gt;&lt;del&gt;KAFKA-9796&lt;/del&gt;&lt;/a&gt;; Broker shutdown could be stuck forever under certain conditions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8448&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This patch reworks the SocketServer to always start the acceptor threads after the processor threads and to always stop the processor threads before the acceptor threads. It also ensure that the processor threads drain its newConnection queue to unblock acceptors that may be waiting. However, the acceptors still bind during the startup, only the processing is further delayed.&lt;/p&gt;

&lt;p&gt;   The flow looks like this now:&lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
   val socketServer = ...&lt;/p&gt;

&lt;p&gt;   socketServer.startup(startProcessingRequests = false)&lt;br/&gt;
   // Acceptors are bound.&lt;/p&gt;

&lt;p&gt;   socketServer.startProcessingRequests(authorizerFutures)&lt;br/&gt;
   // Acceptors and Processors process new connections and requests&lt;/p&gt;

&lt;p&gt;   socketServer.stopProcessingRequests()&lt;br/&gt;
   // Acceptors and Processors are stopped&lt;/p&gt;

&lt;p&gt;   socketServer.shutdown()&lt;br/&gt;
   // SocketServer is shutdown (metrics, etc.)&lt;br/&gt;
   ```&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17085058" author="githubbot" created="Thu, 16 Apr 2020 16:14:08 +0000"  >&lt;p&gt;rajinisivaram commented on pull request #8448: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9796&quot; title=&quot;Broker shutdown could be stuck forever under certain conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9796&quot;&gt;&lt;del&gt;KAFKA-9796&lt;/del&gt;&lt;/a&gt;; Broker shutdown could be stuck forever under certain conditions&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8448&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13409592">KAFKA-13428</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0d5ow:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rsivaram</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>