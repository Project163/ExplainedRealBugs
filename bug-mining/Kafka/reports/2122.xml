<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7110] Windowed changelog keys not deserialized properly by TimeWindowedSerde</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7110</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Backed by KIP: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-393%3A+Time+windowed+serde+to+properly+deserialize+changelog+input+topic&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-393%3A+Time+windowed+serde+to+properly+deserialize+changelog+input+topic&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Currently the TimeWindowedSerde does not deserialize the windowed keys from a changelog topic properly. There are a few assumptions made in the TimeWindowedDeserializer that prevents the changelog windowed keys from being correctly deserialized.&lt;/p&gt;

&lt;p&gt;1) In the from method of WindowKeySchema (called in deserialize in TimeWindowedDeserializer), we extract the window from the binary key, but we call getLong(binaryKey.length -TIMESTAMP_SIZE). However, the changelog for ChangeLoggingWindowBytesStore will log the windowed key as:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;changeLogger.logChange(WindowKeySchema.toStoreKeyBinary(key, timestamp, maybeUpdateSeqnumForDups()), value);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In toStoreKeyBinary, we store the key in&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;final ByteBuffer buf = ByteBuffer.allocate(serializedKey.length + TIMESTAMP_SIZE + SEQNUM_SIZE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with the seqnum (used for de-duping). So the eventual result is that when we deserialize, we do not assume the windowed changelog key has a seq_num, and the window extracted will be gibberish values since the bytes extracted won&apos;t be alligned.&lt;/p&gt;

&lt;p&gt;The fix here is to introduce a new Serde in WindowSerdes that will handle explicitly, windowed changelog input topic.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2) In the constructor of TimeWindowedDeserializer, the windowSize is fixed to Long.MAX_VALUE:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// TODO: fix this part as last bits of KAFKA-4468 public TimeWindowedDeserializer(final Deserializer&amp;lt;T&amp;gt; inner) { this(inner, Long.MAX_VALUE); } 
public TimeWindowedDeserializer(final Deserializer&amp;lt;T&amp;gt; inner, final long windowSize) { this.inner = inner; this.windowSize = windowSize; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will cause the end times to be giberrish when we extract the window since the windowSize is subtracted from the start time in:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public static &amp;lt;K&amp;gt; Windowed&amp;lt;K&amp;gt; from(final byte[] binaryKey, final long windowSize, final Deserializer&amp;lt;K&amp;gt; deserializer, final String topic) { final byte[] bytes = new byte[binaryKey.length - TIMESTAMP_SIZE]; System.arraycopy(binaryKey, 0, bytes, 0, bytes.length); final K key = deserializer.deserialize(topic, bytes); final Window window = extractWindow(binaryKey, windowSize); return new Windowed&amp;lt;&amp;gt;(key, window); } 
private static Window extractWindow(final byte[] binaryKey, final long windowSize) { final ByteBuffer buffer = ByteBuffer.wrap(binaryKey); final long start = buffer.getLong(binaryKey.length - TIMESTAMP_SIZE); return timeWindowForSize(start, windowSize); }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So in the new serde, we will make windowSize a constructor param that can be supplied.&lt;/p&gt;

&lt;p&gt;I&apos;ve started a patch, and will prepare a PR for the fix for 1) and 2) above. Let me know if this sounds reasonable.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13168705">KAFKA-7110</key>
            <summary>Windowed changelog keys not deserialized properly by TimeWindowedSerde</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shnguyen">Shawn Nguyen</assignee>
                                    <reporter username="shnguyen">Shawn Nguyen</reporter>
                        <labels>
                            <label>kip</label>
                    </labels>
                <created>Wed, 27 Jun 2018 19:22:19 +0000</created>
                <updated>Tue, 8 Jan 2019 21:05:16 +0000</updated>
                            <resolved>Fri, 4 Jan 2019 19:42:49 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16525496" author="shnguyen" created="Wed, 27 Jun 2018 19:27:00 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ishiihara&quot; class=&quot;user-hover&quot; rel=&quot;ishiihara&quot;&gt;ishiihara&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16525782" author="guozhang" created="Thu, 28 Jun 2018 00:53:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shnguyen&quot; class=&quot;user-hover&quot; rel=&quot;shnguyen&quot;&gt;shnguyen&lt;/a&gt;, thanks for reporting this issue.&lt;/p&gt;

&lt;p&gt;For 1), when serializing into the Kafka topic, we should call `WindowKeySchema#toBinary` not `WindowKeySchema#toStoreKeyBinary`. As the comment indicates, the former is for serializing into the Kafka topic, while the latter is for serializing for the underlying persistent store. I think you&apos;ve spotted a bug that we should call&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
changeLogger.logChange(WindowKeySchema.toBinary(key, timestamp, maybeUpdateSeqnumForDups()), value);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;instead. With this we would not need to have a new serde.&lt;/p&gt;

&lt;p&gt;2) This is a known issue described in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4468&quot; title=&quot;Correctly calculate the window end timestamp after read from state stores&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4468&quot;&gt;&lt;del&gt;KAFKA-4468&lt;/del&gt;&lt;/a&gt;. I&apos;d like to see what&apos;s your proposed solution on it, are you trying to add an overloaded constructor for &lt;tt&gt;TimeWindowedSerde&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Note that we already have the constructor in &lt;tt&gt;TimeWindowedDeserializer&lt;/tt&gt; that takes a window size, the tricky part is, though, for users to read from the changelog topic directly, she still needs to pass that window size to the constructor via the serde. Maybe we can pass in it as a property key-value pair and let the `configure` call to set it, but that would make the window size parameter to not be a final variable.&lt;/p&gt;</comment>
                            <comment id="16525787" author="githubbot" created="Thu, 28 Jun 2018 01:05:53 +0000"  >&lt;p&gt;shawnsnguyen opened a new pull request #5307: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7110&quot; title=&quot;Windowed changelog keys not deserialized properly by TimeWindowedSerde&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7110&quot;&gt;&lt;del&gt;KAFKA-7110&lt;/del&gt;&lt;/a&gt; Add windowed changelog serde&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5307&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   *Currently the TimeWindowedSerde does not deserialize the windowed keys from a changelog topic properly. There are a few assumptions made in the TimeWindowedDeserializer that prevents the changelog windowed keys from being correctly deserialized. This PR will introduce a new WindowSerde to allow proper deserialization of changelog windowed keys. See &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7110&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7110&lt;/a&gt; for more details. &lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16526643" author="shnguyen" created="Thu, 28 Jun 2018 18:21:06 +0000"  >&lt;p&gt;Thanks for the quick response &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;1) I agree, serialization should actually be toBinary since we&apos;re serializing into a topic. Since no such method signature exists, I can extend the WindowKeySchema to have a toBinary call with the additional seqnum parameter, along with a fromBinary method for the deserialization w/ seqnum. That way we can reuse the existing TimeWindowedSerde for writing and reading windowed topics (and windowed changelog topics).&lt;/p&gt;

&lt;p&gt;2) In the PR attached to this ticket, I had an overloaded constructor with the window size.&#160;I don&apos;t have a clean solution to passing in the window size, but for the use case of ingesting the time windowed ktable (whose input is a changelog topic) described here - &lt;a href=&quot;https://github.com/apache/kafka/pull/5044,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5044,&lt;/a&gt;&#160;we could just set the window size in the serde when the windowConsumed() method is called in the timeWindowedKTable api.&lt;/p&gt;

&lt;p&gt;Something like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public synchronized &amp;lt;K, V&amp;gt; KTable&amp;lt;Windowed&amp;lt;K&amp;gt;, V&amp;gt; timeWindowedKTable(final String topic, final Consumed&amp;lt;K, V&amp;gt; consumed, final Materialized&amp;lt;K, V, WindowStore&amp;lt;Bytes, byte[]&amp;gt;&amp;gt; materialized, final TimeWindows timeWindow) {
Consumed&amp;lt;Windowed&amp;lt;K&amp;gt;, V&amp;gt; windowedConsumed = consumed.windowedChangelogConsumed(timeWindow.size()); 
ConsumedInternal&amp;lt;Windowed&amp;lt;K&amp;gt;, V&amp;gt; consumedInternal = new ConsumedInternal&amp;lt;&amp;gt;(windowedConsumed);
...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I considered this approach since this is the only use case for a client to ingest a changelog topic for now. However, this way&#160;is very specific to the window ktable api.&#160;&lt;/p&gt;</comment>
                            <comment id="16526857" author="guozhang" created="Thu, 28 Jun 2018 22:24:34 +0000"  >&lt;p&gt;1) Not sure I understand your statement.. We do have `WindowKeySchema#toBinary` in trunk: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowKeySchema.java#L110-L121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/state/internals/WindowKeySchema.java#L110-L121&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And then in &lt;a href=&quot;https://github.com/apache/kafka/blob/b1aa1912f08765d9914e3d036deee6b71ea009dd/streams/src/main/java/org/apache/kafka/streams/state/internals/ChangeLoggingWindowBytesStore.java#L82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/b1aa1912f08765d9914e3d036deee6b71ea009dd/streams/src/main/java/org/apache/kafka/streams/state/internals/ChangeLoggingWindowBytesStore.java#L82&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;we still use `toStoreBinary` instead, while for deserializing we assume that `toBinary` was used, which is wrong. This should be fixed.&lt;/p&gt;

&lt;p&gt;2) I will reply to you in the PR.&lt;/p&gt;</comment>
                            <comment id="16526860" author="shnguyen" created="Thu, 28 Jun 2018 22:30:55 +0000"  >&lt;p&gt;1) If we want the changelog to use toBinary, it needs to include the seqnum param as well (to allocate the proper size for the byte array). The existing toBinary method does not allow us to pass in seqnum.&lt;/p&gt;</comment>
                            <comment id="16649079" author="mjsax" created="Sat, 13 Oct 2018 19:16:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shnguyen&quot; class=&quot;user-hover&quot; rel=&quot;shnguyen&quot;&gt;shnguyen&lt;/a&gt; I just added you to the list of contributors and assigned the ticket to you (you can now also self assign tickets).&lt;/p&gt;</comment>
                            <comment id="16724735" author="shnguyen" created="Wed, 19 Dec 2018 07:06:18 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;. Do you mind giving me a binding vote on &lt;a href=&quot;https://lists.apache.org/list.html?dev@kafka.apache.org:lte=1M:393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/list.html?dev@kafka.apache.org:lte=1M:393&lt;/a&gt;&#160;to finalize the KIP vote? I&apos;ll update the PR if you agree with&#160;the proposal to finalize things.&lt;/p&gt;</comment>
                            <comment id="16734524" author="githubbot" created="Fri, 4 Jan 2019 19:42:37 +0000"  >&lt;p&gt;guozhangwang commented on pull request #5307: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7110&quot; title=&quot;Windowed changelog keys not deserialized properly by TimeWindowedSerde&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7110&quot;&gt;&lt;del&gt;KAFKA-7110&lt;/del&gt;&lt;/a&gt;: Add windowed changelog serde&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5307&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vb47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>