<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:11:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6906] Kafka Streams does not commit transactions if data is produced via wall-clock punctuation</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6906</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Committing in Kafka Streams happens in regular intervals. However, committing only happens if new input records got processed since the last commit (via setting flag `commitOffsetNeeded` within `StreamTask#process()`)&lt;/p&gt;

&lt;p&gt;However, data could also be emitted via wall-clock based punctuation calls. Especially if EOS is enabled, this is an issue (maybe also for non-EOS) because the current running transaction is not committed and thus might time out leading to a fatal error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13159556">KAFKA-6906</key>
            <summary>Kafka Streams does not commit transactions if data is produced via wall-clock punctuation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jadireddi">Jagadesh Adireddi</assignee>
                                    <reporter username="mjsax">Matthias J. Sax</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 May 2018 22:10:38 +0000</created>
                <updated>Wed, 13 Jun 2018 18:00:49 +0000</updated>
                            <resolved>Mon, 11 Jun 2018 23:36:38 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>0.11.0.3</fixVersion>
                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16476832" author="mjsax" created="Wed, 16 May 2018 04:54:21 +0000"  >&lt;p&gt;Thinking about this twice, I am wondering if using wall-clock time punctuation in combination with EOS is actually a good idea and if we should allow it or not? Because wall-clock time punctuations are inherently non-deterministic there usage seem to contract (and violate?) exactly-once processing guarantees?&lt;/p&gt;

&lt;p&gt;\cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurva&quot; class=&quot;user-hover&quot; rel=&quot;apurva&quot;&gt;apurva&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="16477158" author="adireddijagadesh@gmail.com" created="Wed, 16 May 2018 09:30:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;, Identified fix for this. Once we decide to go head with the ticket, will send the PR.&lt;/p&gt;</comment>
                            <comment id="16477993" author="guozhang" created="Wed, 16 May 2018 20:03:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; EOS does not guarantee determinism when we execute multiple times, so I think we should not disallow wall-clock punctuation when EOS turned on.&lt;/p&gt;

&lt;p&gt;As for the fix, I think we should get rid of &lt;tt&gt;commitOffsetNeeded&lt;/tt&gt; and always call &lt;tt&gt;StreamTask#commitOffsets&lt;/tt&gt;, the motivations is that:&lt;/p&gt;

&lt;p&gt;1. When EOS is turned on, we need to make sure &lt;tt&gt;StreamTask#commitOffsets&lt;/tt&gt; is called even if there is no records being processed at all (including the ones from wall-clock punctuate).&lt;br/&gt;
2. Without KIP-211, currently the offsets may be deleted even if the group is still valid after the specified retention period if there is no new offset commits during that period.&lt;/p&gt;

&lt;p&gt;What we could change, though, is that inside the &lt;tt&gt;StreamTask#commitOffsets&lt;/tt&gt; we check the following:&lt;/p&gt;

&lt;p&gt;For each topic partition in &lt;tt&gt;consumedOffsets}, if there is a change since the last commit; and filter those topic partitions if no changes are made when calling {{commitSync&lt;/tt&gt;. After KIP-211 this should be safe to do.&lt;/p&gt;</comment>
                            <comment id="16477998" author="mjsax" created="Wed, 16 May 2018 20:07:19 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;! Sounds good to me. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jadireddi&quot; class=&quot;user-hover&quot; rel=&quot;jadireddi&quot;&gt;jadireddi&lt;/a&gt;&#160;looking forward to your PR.&lt;/p&gt;</comment>
                            <comment id="16492827" author="adireddijagadesh@gmail.com" created="Mon, 28 May 2018 16:57:28 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Sorry for the late response.&#160;I am on vacation. I want to re-iterate the solution provided from above comments.&#160;&lt;br/&gt;
 1) When EOS is turned on, we need to call&#160;&#160;StreamTask#commitOffsets for both `PipeInput` and `advanceWallClockTime` cases.&#160;&lt;/p&gt;

&lt;p&gt;2) We need to delete `commitOffsetNeeded`&#160; field in `StreamTask` class.&lt;/p&gt;

&lt;p&gt;3)&#160;For each topic partition in&#160;&#160;StreamTask#&lt;tt&gt;consumedOffsets, we need to filter out topic partitions&#160;that have changes from last commit. And commit transaction.&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;4)&#160;And partitions with no changes from last commit Map, need to sent to `&lt;/tt&gt;&lt;tt&gt;commitSync&lt;/tt&gt;&lt;tt&gt;` method, once KIP-211 is merged.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Can you please&#160;clarify whether&#160;point 3 &amp;amp; 4 applicable&#160;irrespective of EOS is turned-ON/OFF.And&lt;/tt&gt;&lt;tt&gt;&#160;&lt;/tt&gt;&lt;b&gt;consumedOffsets&lt;/b&gt; Map or&#160;&lt;b&gt;stateMgr&lt;/b&gt; Map in `StreamTask` gives the information of last commit?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;`&lt;/p&gt;

&lt;p&gt;`&lt;/p&gt;</comment>
                            <comment id="16494307" author="mjsax" created="Tue, 29 May 2018 21:33:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jadireddi&quot; class=&quot;user-hover&quot; rel=&quot;jadireddi&quot;&gt;jadireddi&lt;/a&gt; no need to apologize &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;From my understanding 3/4 is applicable for both cases &#8211; however, KIP-211 is not merged yet and the change is actually also not related to the bug reported in this Jira &#8211; personally, I would prefer to only fix the bug itself with one PR, and do a second PR with a new Jira to we can resolve after KIP-211 is merged. This ensure that this fix can make it into 2.0.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="16494692" author="adireddijagadesh@gmail.com" created="Wed, 30 May 2018 05:08:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;, should we keep using `commitOffsetNeeded`&#160; flag&#160;and proceed further to fix this bug. And push point 3 and 4&#160;code changes to another Jira?.&#160;&lt;/p&gt;</comment>
                            <comment id="16494725" author="guozhang" created="Wed, 30 May 2018 06:01:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; Sounds good to me. For this JIRA just doing 1/2/3 is sufficient.&lt;/p&gt;</comment>
                            <comment id="16494742" author="adireddijagadesh@gmail.com" created="Wed, 30 May 2018 06:21:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, Thank you for the conformation. Will&#160;&lt;b&gt;consumedOffsets&lt;/b&gt;&#160;Map or&#160;&lt;b&gt;stateMgr&lt;/b&gt;&#160;Map in `StreamTask` gives the information of last commit?. Or am i looking at wrong place?.&lt;/p&gt;</comment>
                            <comment id="16495278" author="mjsax" created="Wed, 30 May 2018 15:01:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; I am not sure if I understand why we need to do (3) &#8211; from my current understanding, removing `commitOffsetNeeded` should be sufficient? Can you elaborate?&lt;/p&gt;</comment>
                            <comment id="16496155" author="githubbot" created="Thu, 31 May 2018 06:07:47 +0000"  >&lt;p&gt;jadireddi opened a new pull request #5105: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6906&quot; title=&quot;Kafka Streams does not commit transactions if data is produced via wall-clock punctuation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6906&quot;&gt;&lt;del&gt;KAFKA-6906&lt;/del&gt;&lt;/a&gt;: Fixed to commit transactions if data is produced via wall clock punctuation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5105&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Fixed `StreamTask` to commit transactions if the data is produced via wall-clock punctuation too.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16508805" author="githubbot" created="Mon, 11 Jun 2018 21:40:06 +0000"  >&lt;p&gt;mjsax closed pull request #5105: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6906&quot; title=&quot;Kafka Streams does not commit transactions if data is produced via wall-clock punctuation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6906&quot;&gt;&lt;del&gt;KAFKA-6906&lt;/del&gt;&lt;/a&gt;: Fixed to commit transactions if data is produced via wall clock punctuation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5105&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
index e2be3e29172..4cea5280f86 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
@@ -424,17 +424,22 @@ private void commitOffsets(final boolean startNewTransaction) {&lt;/p&gt;

&lt;p&gt;                 if (eosEnabled) {&lt;br/&gt;
                     producer.sendOffsetsToTransaction(consumedOffsetsAndMetadata, applicationId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;producer.commitTransaction();&lt;/li&gt;
	&lt;li&gt;transactionInFlight = false;&lt;/li&gt;
	&lt;li&gt;if (startNewTransaction) 
{
-                        producer.beginTransaction();
-                        transactionInFlight = true;
-                    }
&lt;p&gt;                 } else &lt;/p&gt;
{
                     consumer.commitSync(consumedOffsetsAndMetadata);
                 }
&lt;p&gt;                 commitOffsetNeeded = false;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;} else if (eosEnabled &amp;amp;&amp;amp; !startNewTransaction &amp;amp;&amp;amp; transactionInFlight) 
{ // need to make sure to commit txn for suspend case
+            }
&lt;p&gt;+&lt;br/&gt;
+            if (eosEnabled) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                producer.commitTransaction();+                transactionInFlight = false;+                if (startNewTransaction) {
+                    producer.beginTransaction();
+                    transactionInFlight = true;
+                }+            }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+            if (eosEnabled &amp;amp;&amp;amp; !startNewTransaction &amp;amp;&amp;amp; transactionInFlight) &lt;/p&gt;
{ // need to make sure to commit txn for suspend case
                 producer.commitTransaction();
                 transactionInFlight = false;
             }
&lt;p&gt;diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java&lt;br/&gt;
index 5537335b221..bfbb2a00270 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java&lt;br/&gt;
@@ -35,6 +35,7 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.MockTime;&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
 import org.apache.kafka.streams.StreamsConfig;&lt;br/&gt;
+import org.apache.kafka.streams.errors.DefaultProductionExceptionHandler;&lt;br/&gt;
 import org.apache.kafka.streams.errors.StreamsException;&lt;br/&gt;
 import org.apache.kafka.streams.processor.PunctuationType;&lt;br/&gt;
 import org.apache.kafka.streams.processor.Punctuator;&lt;br/&gt;
@@ -913,6 +914,7 @@ public void shouldNotAbortTransactionOnDirtyClosedIfEosDisabled() {&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldCloseProducerOnCloseWhenEosEnabled() {&lt;br/&gt;
         task = createStatelessTask(createConfig(true));&lt;br/&gt;
+        task.initializeTopology();&lt;br/&gt;
         task.close(true, false);&lt;br/&gt;
         task = null;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -1028,6 +1030,39 @@ public void shouldReturnOffsetsForRepartitionTopicsForPurging() &lt;/p&gt;
{
         assertThat(map, equalTo(Collections.singletonMap(repartition, 11L)));
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldThrowOnCleanCloseTaskWhenEosEnabledIfTransactionInFlight() {&lt;br/&gt;
+        task = createStatelessTask(createConfig(true));&lt;br/&gt;
+        try &lt;/p&gt;
{
+            task.close(true, false);
+            fail(&quot;should have throw IllegalStateException&quot;);
+        }
&lt;p&gt; catch (final IllegalStateException expected) &lt;/p&gt;
{
+            // pass
+        }
&lt;p&gt;+        task = null;&lt;br/&gt;
+&lt;br/&gt;
+        assertTrue(producer.closed());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void shouldAlwaysCommitIfEosEnabled() {&lt;br/&gt;
+        final RecordCollectorImpl recordCollector =  new RecordCollectorImpl(producer, &quot;StreamTask&quot;,&lt;br/&gt;
+                new LogContext(&quot;StreamTaskTest &quot;), new DefaultProductionExceptionHandler(), new Metrics().sensor(&quot;skipped-records&quot;));&lt;br/&gt;
+&lt;br/&gt;
+        task = createStatelessTask(createConfig(true));&lt;br/&gt;
+        task.initializeStateStores();&lt;br/&gt;
+        task.initializeTopology();&lt;br/&gt;
+        task.punctuate(processorSystemTime, 5, PunctuationType.WALL_CLOCK_TIME, new Punctuator() {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public void punctuate(final long timestamp) &lt;/p&gt;
{
+                recordCollector.send(&quot;result-topic1&quot;, 3, 5, null, 0, time.milliseconds(),
+                        new IntegerSerializer(),  new IntegerSerializer());
+            }
&lt;p&gt;+        });&lt;br/&gt;
+        task.commit();&lt;br/&gt;
+        assertEquals(1, producer.history().size());&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     private StreamTask createStatefulTask(final StreamsConfig config, final boolean logged) {&lt;br/&gt;
         final ProcessorTopology topology = ProcessorTopology.with(&lt;br/&gt;
             Utils.&amp;lt;ProcessorNode&amp;gt;mkList(source1, source2),&lt;br/&gt;
@@ -1144,5 +1179,4 @@ protected void flushState() &lt;/p&gt;
{
             recordValue
         );
     }
&lt;p&gt;-&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java&lt;br/&gt;
index 936c67b8ef8..1cc9c06c5b3 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamThreadTest.java&lt;br/&gt;
@@ -660,7 +660,7 @@ public void shouldCloseTaskAsZombieAndRemoveFromActiveTasksIfProducerWasFencedWh&lt;br/&gt;
             new TestCondition() {&lt;br/&gt;
                 @Override&lt;br/&gt;
                 public boolean conditionMet() &lt;/p&gt;
{
-                    return producer.commitCount() == 1;
+                    return producer.commitCount() == 2;
                 }
&lt;p&gt;             },&lt;br/&gt;
             &quot;StreamsThread did not commit transaction.&quot;);&lt;br/&gt;
@@ -681,7 +681,7 @@ public boolean conditionMet() {&lt;br/&gt;
             },&lt;br/&gt;
             &quot;StreamsThread did not remove fenced zombie task.&quot;);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertThat(producer.commitCount(), equalTo(1L));&lt;br/&gt;
+        assertThat(producer.commitCount(), equalTo(2L));&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16508991" author="githubbot" created="Tue, 12 Jun 2018 00:24:31 +0000"  >&lt;p&gt;mjsax opened a new pull request #5196: MINOR: code cleanup follow up for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6906&quot; title=&quot;Kafka Streams does not commit transactions if data is produced via wall-clock punctuation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6906&quot;&gt;&lt;del&gt;KAFKA-6906&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5196&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Intellij warned that the condition of the `if` will always be `false` &amp;#8211; thinking about this, it makes sense. After refactoring the code in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6906&quot; title=&quot;Kafka Streams does not commit transactions if data is produced via wall-clock punctuation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6906&quot;&gt;&lt;del&gt;KAFKA-6906&lt;/del&gt;&lt;/a&gt; and moving the EOS-part out of the `commitOffsetNeeded` block L433-440 cover this case already and we can remove redundant code.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16511485" author="githubbot" created="Wed, 13 Jun 2018 18:00:49 +0000"  >&lt;p&gt;mjsax closed pull request #5196: MINOR: code cleanup follow up for &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6906&quot; title=&quot;Kafka Streams does not commit transactions if data is produced via wall-clock punctuation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6906&quot;&gt;&lt;del&gt;KAFKA-6906&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5196&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
index 4cea5280f86..c4305624ec1 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java&lt;br/&gt;
@@ -438,11 +438,6 @@ private void commitOffsets(final boolean startNewTransaction) &lt;/p&gt;
{
                     transactionInFlight = true;
                 }
&lt;p&gt;             }&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (eosEnabled &amp;amp;&amp;amp; !startNewTransaction &amp;amp;&amp;amp; transactionInFlight) 
{ // need to make sure to commit txn for suspend case
-                producer.commitTransaction();
-                transactionInFlight = false;
-            }
&lt;p&gt;         } catch (final CommitFailedException | ProducerFencedException fatal) &lt;/p&gt;
{
             throw new TaskMigratedException(this, fatal);
         }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13156079">KAFKA-6838</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13082326">KAFKA-5510</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tr3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>