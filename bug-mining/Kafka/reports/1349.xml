<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:59:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4557] ConcurrentModificationException in KafkaProducer event loop</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4557</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Under heavy load, Kafka producer can stop publishing events. Logs below.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.779Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;NetworkClient&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt;: Disconnecting from node 2 due to request timeout.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.793Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaProducerClient&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1B2M2Y8Asg&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARN&amp;#93;&lt;/span&gt;: Error sending message to Kafka&lt;br/&gt;
org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.838Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaProducerClient&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1B2M2Y8Asg&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARN&amp;#93;&lt;/span&gt;: Error sending message to Kafka&lt;br/&gt;
  org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received. (#2 from 2016-12-19T15:01:28.793Z)&lt;/p&gt;

&lt;p&gt;--------------------------------&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.956Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaProducerClient&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1B2M2Y8Asg&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARN&amp;#93;&lt;/span&gt;: Error sending message to Kafka&lt;br/&gt;
  org.apache.kafka.common.errors.TimeoutException: Expiring 46 record(s) for events-deadletter-0 due to 30032 ms has passed since batch creation plus linger time (#285 from 2016-12-19&lt;br/&gt;
T15:01:28.793Z)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.956Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;SgsService&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1B2M2Y8Asg&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARN&amp;#93;&lt;/span&gt;: Error writing signal to Kafka deadletter queue&lt;br/&gt;
  org.apache.kafka.common.errors.TimeoutException: Expiring 46 record(s) for events-deadletter-0 due to 30032 ms has passed since batch creation plus linger time (#286 from 2016-12-19&lt;br/&gt;
T15:01:28.793Z)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.960Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Sender&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1B2M2Y8Asg&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt;: Uncaught error in kafka producer I/O thread:&lt;br/&gt;
java.util.ConcurrentModificationException: null&lt;br/&gt;
        at java.util.ArrayDeque$DeqIterator.next(ArrayDeque.java:643) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_45&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.kafka.clients.producer.internals.RecordAccumulator.abortExpiredBatches(RecordAccumulator.java:242) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-clients-0.10.1.0.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:212) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-clients-0.10.1.0.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:135) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-clients-0.10.1.0.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_45&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2016-12-19T15:01:28.981Z&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;sgs&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-producer-network-thread | producer-3&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;NetworkClient&amp;#93;&lt;/span&gt; [] &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;none&amp;gt;&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1B2M2Y8Asg&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;WARN&amp;#93;&lt;/span&gt;: Error while fetching metadata with correlation id 28711 : &lt;/p&gt;
{events-deadletter=LEADER_NOT_AVAILABLE}</description>
                <environment></environment>
        <key id="13029163">KAFKA-4557</key>
            <summary>ConcurrentModificationException in KafkaProducer event loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="salaev">Sergey Alaev</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Mon, 19 Dec 2016 15:07:13 +0000</created>
                <updated>Fri, 27 Jan 2017 23:28:16 +0000</updated>
                            <resolved>Fri, 27 Jan 2017 23:28:10 +0000</resolved>
                                    <version>0.10.1.0</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15761434" author="ijuma" created="Mon, 19 Dec 2016 15:20:29 +0000"  >&lt;p&gt;Thanks for the report. Not clear how this is happening since we synchronize on the `Deque` when we access and mutate it. I had a quick look and could not find a case where that didn&apos;t apply. A more in-depth look is required, it seems.&lt;/p&gt;</comment>
                            <comment id="15823399" author="huxi_2b" created="Mon, 16 Jan 2017 03:19:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scf37&quot; class=&quot;user-hover&quot; rel=&quot;scf37&quot;&gt;scf37&lt;/a&gt; Did you create your own Sender instances in the producer code?&lt;/p&gt;</comment>
                            <comment id="15825654" author="salaev" created="Tue, 17 Jan 2017 08:44:38 +0000"  >&lt;p&gt;No, I only use KafkaProducer.send, calling it concurrently from multiple threads.&lt;/p&gt;</comment>
                            <comment id="15836738" author="ewencp" created="Tue, 24 Jan 2017 22:13:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=salaev&quot; class=&quot;user-hover&quot; rel=&quot;salaev&quot;&gt;salaev&lt;/a&gt; Can you give an idea of the workload &amp;#8211; # of threads, messages/s, size of messages, etc? Might help someone reproduce. (Also, clearly in this case they&apos;d need to trigger timeouts of message batches).&lt;/p&gt;

&lt;p&gt;I wonder if we should try to report more stacktrace info from more threads when we get unexpected exceptions like this. It&apos;s not always a concurrency problem, but often other thread info can help pin down the source of the problem.&lt;/p&gt;</comment>
                            <comment id="15839587" author="rsivaram" created="Thu, 26 Jan 2017 11:26:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=salaev&quot; class=&quot;user-hover&quot; rel=&quot;salaev&quot;&gt;salaev&lt;/a&gt; Does the producer application send messages from a send callback when an exception occurs?&lt;/p&gt;

&lt;p&gt;I think this scenario can occur if a message is sent from the callback when some message expires. I think we do allow sends to be called from callbacks (can&apos;t find anything in Javadocs that says otherwise) and it is not unusual to send messages to a dead-letter-queue when send fails. So it makes sense to fix this scenario.&lt;/p&gt;</comment>
                            <comment id="15839589" author="ijuma" created="Thu, 26 Jan 2017 11:29:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;, oh so you mean the issue is that we are modifying the ArrayDeque while iterating over it?&lt;/p&gt;</comment>
                            <comment id="15839608" author="rsivaram" created="Thu, 26 Jan 2017 11:49:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Yes, if a message is sent to the same partition from a callback when an earlier send fails due to expiry, then we are iterating over the deque for expiry while holding the deque lock, but the callback adds to the deque from the same thread (hence holds the lock). So the iterator can throw &lt;tt&gt;ConcurrentModificationException&lt;/tt&gt;. I couldn&apos;t find any other scenarios where this exception could occur since the deque is correctly synchronized everywhere. &lt;/p&gt;</comment>
                            <comment id="15839627" author="ijuma" created="Thu, 26 Jan 2017 12:14:45 +0000"  >&lt;p&gt;Yes, that makes sense. Thanks for figuring it out. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15839637" author="salaev" created="Thu, 26 Jan 2017 12:30:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; Yep, that seems to be the case. Actual code is built on Twitter Futures which concurrency model prefers to use current thread for new calls.&lt;/p&gt;</comment>
                            <comment id="15839994" author="githubbot" created="Thu, 26 Jan 2017 16:38:22 +0000"  >&lt;p&gt;GitHub user rajinisivaram opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2449&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4557&quot; title=&quot;ConcurrentModificationException in KafkaProducer event loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4557&quot;&gt;&lt;del&gt;KAFKA-4557&lt;/del&gt;&lt;/a&gt;: Handle Producer.send correctly in expiry callbacks&lt;/p&gt;

&lt;p&gt;    When iterating deque for expiring record batches, delay the actual completion of the batch until iteration is complete since callbacks invoked during expiry may send more records, modifying the deque, resulting in ConcurrentModificationException in the iterator.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rajinisivaram/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rajinisivaram/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4557&quot; title=&quot;ConcurrentModificationException in KafkaProducer event loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4557&quot;&gt;&lt;del&gt;KAFKA-4557&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2449.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2449.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2449&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit dae191b0dc14bed39b8f77589c74a2394ed4ea48&lt;br/&gt;
Author: Rajini Sivaram &amp;lt;rajinisivaram@googlemail.com&amp;gt;&lt;br/&gt;
Date:   2017-01-26T16:23:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4557&quot; title=&quot;ConcurrentModificationException in KafkaProducer event loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4557&quot;&gt;&lt;del&gt;KAFKA-4557&lt;/del&gt;&lt;/a&gt;: Handle Producer.send correctly in expiry callbacks&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15843646" author="ijuma" created="Fri, 27 Jan 2017 23:28:10 +0000"  >&lt;p&gt;Issue resolved by pull request 2449&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2449&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15843647" author="githubbot" created="Fri, 27 Jan 2017 23:28:16 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2449&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37rwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>