<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13261] KTable to KTable foreign key join loose events when using several partitions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13261</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KIP-775: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-775%3A+Custom+partitioners+in+foreign+key+joins&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-775%3A+Custom+partitioners+in+foreign+key+joins&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Two incoming streams A and B.&#160;&lt;/p&gt;

&lt;p&gt;Stream A uses a composite key &lt;span class=&quot;error&quot;&gt;&amp;#91;a, b&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Stream B has key &lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Stream B has 4 partitions and steams A has 1 partition.&lt;/p&gt;

&lt;p&gt;What we try to do is repartition stream A to have 4 partitions too, then put both A and B into KTable and do a foreign key join on from A to B&lt;/p&gt;

&lt;p&gt;When doing this, all messages does not end up in the output topic.&lt;/p&gt;

&lt;p&gt;Repartitioning both to only use 1 partition each solve the problem so it seem like it has something to do with the foreign key join in combination with several partitions.&#160;&lt;/p&gt;

&lt;p&gt;One suspicion would be that it is not possible to define what partitioner to use for the join.&lt;/p&gt;

&lt;p&gt;Any insight or help is greatly appreciated.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Example code of the problem&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Topology createTopoology(){
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamsBuilder();

    KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; tableB = builder.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;,  stringMaterialized(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.b&quot;&lt;/span&gt;));

    builder
        .stream(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, Consumed.with(Serde.of(KeyA.class), Serde.of(EventA.class)))
        .repartition(repartitionTopicA())
        .toTable(Named.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.a&quot;&lt;/span&gt;), aMaterialized(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.a&quot;&lt;/span&gt;))
        .join(tableB, EventA::getKeyB, topicAandBeJoiner(), Named.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;join.ab&quot;&lt;/span&gt;), joinMaterialized(&lt;span class=&quot;code-quote&quot;&gt;&quot;join.ab&quot;&lt;/span&gt;))
        .toStream()
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;output&quot;&lt;/span&gt;, with(...));

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; builder.build();
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Materialized&amp;lt;KeyA, EventA&amp;gt; aMaterialized(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) {
  Materialized&amp;lt;KeyA, EventA, KeyValueStore&amp;lt;Bytes, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; table = Materialized.as(name);
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; table.withKeySerde(Serde.of(KeyA.class)).withValueSerde(Serde.of(EventA.class));
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Repartitioned&amp;lt;DriverPeriod, DriverCosts&amp;gt; repartitionTopicA() {
    Repartitioned&amp;lt;DriverPeriod, DriverCosts&amp;gt; repartitioned = Repartitioned.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;driverperiod&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; repartitioned.withKeySerde(Serde.of(KeyA.class)).withValueSerde(Serde.of(EventA.class))
        .withStreamPartitioner(topicAPartitioner())
        .withNumberOfPartitions(4);
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; StreamPartitioner&amp;lt;DriverPeriod, DriverCosts&amp;gt; topicAPartitioner() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (topic, key, value, numPartitions) -&amp;gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.abs(key.getKeyB().hashCode()) % numPartitions;
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Materialized&amp;lt;KeyA, EventA, KeyValueStore&amp;lt;Bytes, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; joinMaterialized(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) {
    Materialized&amp;lt;DriverPeriod, DriverCosts, KeyValueStore&amp;lt;Bytes, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; table = Materialized.as(name);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; table.withKeySerde(Serde.of(KeyA.class)).withValueSerde(Serde.of(EventA.class));
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13398684">KAFKA-13261</key>
            <summary>KTable to KTable foreign key join loose events when using several partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vcrfxia">Victoria Xia</assignee>
                                    <reporter username="xnix">Tomas Forsman</reporter>
                        <labels>
                            <label>kip</label>
                    </labels>
                <created>Wed, 1 Sep 2021 13:42:27 +0000</created>
                <updated>Thu, 4 Nov 2021 01:52:08 +0000</updated>
                            <resolved>Wed, 3 Nov 2021 17:56:37 +0000</resolved>
                                    <version>2.7.1</version>
                    <version>2.8.0</version>
                                    <fixVersion>3.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17408294" author="guozhang" created="Wed, 1 Sep 2021 17:31:04 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve re-read the design doc in &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-213+Support+non-key+joining+in+KTable&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-213+Support+non-key+joining+in+KTable&lt;/a&gt;, although it&apos;s illustrated where the foreign key is encoded on the values, not as part of the key, I think that should still work with the round-trip re-partitioning, and hence I&apos;m not sure why foreign-key encoded as part of the key would not work. Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; could you take a look to see if this is a bug?&lt;/p&gt;</comment>
                            <comment id="17408303" author="abellemare" created="Wed, 1 Sep 2021 17:55:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt;. We&apos;ll need some more information:&lt;/p&gt;

&lt;p&gt;Have you already verified that the repartitioned Stream A is correctly co-partitioned with Stream B? This would be your first step, as if you can consistently reproduce this, it could very well be an incorrect repartitioning.&#160;&lt;/p&gt;

&lt;p&gt;Assuming that the events are correctly repartitioned and keyed, you may be seeing the following:&lt;br/&gt;
 &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-213+Support+non-key+joining+in+KTable#KIP213SupportnonkeyjoininginKTable-JoinerPropagationofStaleData&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-213+Support+non-key+joining+in+KTable#KIP213SupportnonkeyjoininginKTable-JoinerPropagationofStaleData&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Due to the distributed and independent-processing nature of Kafka Streams (tasks), it is possible that newer events are joined prior to older events. This is due to context switching between tasks at inopportune times, crashing instances, failures, etc. Stale events, from the perspective of the Left-Hand Side, will not be propagated, because they would otherwise overwrite newer data. This is one of the tradeoffs of this implementation.&lt;/p&gt;

&lt;p&gt;For example, your Stream B inputs may be:&#160;&lt;br/&gt;
(1, &lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt;, foo )&lt;br/&gt;
(2, &lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt;, bar )&lt;br/&gt;
(1, &lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt;, bar )&lt;/p&gt;

&lt;p&gt;But depending on how Kafka streams loads the events into the KTable (eg: loads them all in in a single batch, writes to the KTable, and writes to the subscription topic), you will either get all 3 joined events out, OR, you will only get:&lt;br/&gt;
(2, joinedResults&lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt;, bar )&lt;br/&gt;
(1, joinedResults&lt;span class=&quot;error&quot;&gt;&amp;#91;b&amp;#93;&lt;/span&gt;, bar ) (&amp;lt;--- this is the &quot;final&quot; state given the current inputs).&lt;/p&gt;

&lt;p&gt;You&#160;&lt;em&gt;should&lt;/em&gt; always see the final join result, and it should always be the same value each time you run the test. If this is&#160;not occurring, could you please post a simple test demonstrating the inputs? I think you could probably get away &lt;a href=&quot;https://github.com/a0x8o/kafka/blob/master/streams/src/test/java/org/apache/kafka/streams/kstream/internals/KTableKTableForeignKeyJoinScenarioTest.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;with copying this test&lt;/a&gt; and modifying it to showcase your inputs.&#160;&lt;/p&gt;

&lt;p&gt;Finally, the reason I suspect its either the partitioner or the discarding of stale events is that with singular partitions, all data is necessarily both co-located and is guaranteed to be processed sequentially. In this case I would expect to always see every join result, in sequential order, without anything missing (as you so observed).&#160;&lt;/p&gt;</comment>
                            <comment id="17408786" author="xnix" created="Thu, 2 Sep 2021 12:38:55 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt;, thank you for your answers.&lt;/p&gt;

&lt;p&gt;Yes, A and B use a partitioner that use the same value from respective topic key.&lt;/p&gt;

&lt;p&gt;In the scenario we have the output topic is compacted on the same key as Topic A, so if intermediate events would not come - it would be fine. We want the final result. What we&apos;re seeing though is combinations missing completely.&#160;&lt;/p&gt;

&lt;p&gt;We&apos;ve read out all events from the A,B and output topics but also the internal topics created by the join. Expected is that all would have 66 ids. As said, running with same data with one partition create a perfect match where all events has passed through.&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#Using 4 partitions
A&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;: ids: 66
B&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;: ids: 66
table.b-changelog : ids: 66
table.a-changelog : ids: 66
join.ab-changelog : ids: 20
output&#160; &#160; &#160; &#160; &#160; &#160; : ids: 20&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Attached KafkaTest.java, but we&apos;ve written several junit test cases with the TopologyTestDriver and different amount of test data but are unable to reproduce the problem. (does the test driver consider several partitions?)&lt;/p&gt;

&lt;p&gt;However, in a local docker environment we can reproduce the above scenario every time when using 4 partitions and the problem goes away when using 1 partition.&lt;/p&gt;

&lt;p&gt;Below is when reading from the different topics directly for a specific id &quot;ID123&quot;&#160;&lt;/p&gt;

&lt;p&gt;Columns are &apos;offset, timestamp, partition | &lt;span class=&quot;error&quot;&gt;&amp;#91;key&amp;#93;&lt;/span&gt;value&apos;&lt;/p&gt;

&lt;p&gt;Using 4 partitions&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;table.a-changelog 
5 1612435945196 0 | [ID123, 202101] A01 
15 1614863137136 0 | [ID123, 202102] A02 
25 1617882052260 0 | [ID123, 202103] A03 
35 1620299210336 0 | [ID123, 202104] A04 
45 1622804606823 0 | [ID123, 202105] A05 
table.b-changelog 
6 1622617868856 0 | [ID123] BBB 
join.ab-changelog 
0 1622617868856 0 | [ID123, 202104] A04, BBB 
output 
0 1622617868856 0 | [ID123, 202104] A04, BBB 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Using 1 partition&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;table.a-changelog 
28 1612435945196 0 | [ID123, 202101] A01 
88 1614863137136 0 | [ID123, 202102] A02 
149 1617882052260 0 | [ID123, 202103] A03 
210 1620299210336 0 | [ID123, 202104] A04 
269 1622804606823 0 | [ID123, 202105] A05 
table.b-changelog 
7 1622617868856 0 | [ID123] BBB 
join.ab-changelog 
28 1622617868856 0 | [ID123, 202101] A01, BBB 
88 1622617868856 0 | [ID123, 202102] A02, BBB 
149 1622617868856 0 | [ID123, 202103] A03, BBB 
210 1622617868856 0 | [ID123, 202104] A04, BBB 
269 1622804606823 0 | [ID123, 202105] A05, BBB 
output 
5 1622617868856 0 | [ID123, 202101] A01, BBB 
15 1622617868856 0 | [ID123, 202102] A02, BBB 
25 1622617868856 0 | [ID123, 202103] A03, BBB 
35 1622617868856 0 | [ID123, 202104] A04, BBB 
45 1622804606823 0 | [ID123, 202105] A05, BBB&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17408967" author="guozhang" created="Thu, 2 Sep 2021 16:33:18 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt; regarding &quot;However, in a local docker environment we can reproduce the above scenario every time when using 4 partitions and the problem goes away when using 1 partition.&quot; Is that a test done through the TopologyTestDriver or is it a full-fledged integration test with Kafka clusters and Kafka Streams clients?&lt;/p&gt;
</comment>
                            <comment id="17408977" author="vvcephei" created="Thu, 2 Sep 2021 16:43:07 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Your suspicion is correct. TopologyTestDriver doesn&apos;t simulate partitions at all, so you won&apos;t be able to use it to test this case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When it comes to a repro, you might be interested in this class, which verifies that foreign-key joins perform correctly when the input topics have different partitions: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyInnerJoinMultiIntegrationTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/test/java/org/apache/kafka/streams/integration/KTableKTableForeignKeyInnerJoinMultiIntegrationTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If we have a bug, my suspicion would be whether we&apos;re correctly capturing the partitioner that you&apos;re setting via Repartitioned. I&apos;d suggest modifying that test to be closer to your example and seeing whether or not we still get the correct result.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;On the subject of Repartitioned, I didn&apos;t quite follow why you&apos;re doing it. To be clear, when you&apos;re doing foreign-key joins, you do not need the two tables to have the same number of partitions, nor do you need them to be co-partitioned. This should work just fine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  KTable&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; tableB = builder.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;,  stringMaterialized(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.b&quot;&lt;/span&gt;));

    builder
        .stream(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, Consumed.with(Serde.of(KeyA.class), Serde.of(EventA.class)))
        .toTable(Named.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.a&quot;&lt;/span&gt;), aMaterialized(&lt;span class=&quot;code-quote&quot;&gt;&quot;table.a&quot;&lt;/span&gt;))
        .join(tableB, EventA::getKeyB, topicAandBeJoiner(), Named.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;join.ab&quot;&lt;/span&gt;), joinMaterialized(&lt;span class=&quot;code-quote&quot;&gt;&quot;join.ab&quot;&lt;/span&gt;))
        .toStream()
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;output&quot;&lt;/span&gt;, with(...));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Unless you have some other requirement for which you need the repartition operation, I&apos;d suggest just completely dropping those repartition steps. At least, I&apos;d suggest trying out removing them from the topology and verifying if you get the correct join results.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I hope this helps!&lt;/p&gt;</comment>
                            <comment id="17409883" author="xnix" created="Sat, 4 Sep 2021 06:38:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, the local one is full-fledged, however scaled down, setup running the actual services needed to reproduce the problem. We do have test environment and staging environment with complete setup where we also can reproduce the problem.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;, i&apos;ll look into setting up a test case based on the one you sent me.&lt;/p&gt;

&lt;p&gt;About removing the partitioned, the example I&apos;ve given is the minimal one needed to show the problem. Our topologies are bigger in general and we where hoping to be able to use several partitions, with custom partitioner, instead of just one. &lt;br/&gt;
I will follow your suggestion and try without it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17410256" author="xnix" created="Sun, 5 Sep 2021 22:16:33 +0000"  >&lt;p&gt;I&apos;ve added a test that seem to verify a problem with the join. I need to look at it more tomorrow. If anyone&apos;s curious it&apos;s here&#160;&lt;a href=&quot;https://github.com/apache/kafka/commit/2e6edf2951f482029aea80acd2f0960085a5f396&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/2e6edf2951f482029aea80acd2f0960085a5f396&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Branch:&#160;&lt;a href=&quot;https://github.com/tomas-forsman/kafka/tree/KAFKA-13261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tomas-forsman/kafka/tree/KAFKA-13261&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17410650" author="xnix" created="Mon, 6 Sep 2021 14:45:43 +0000"  >&lt;p&gt;I think I need some help to verify if that test does what it should. I also tried to look at the code for the foreign key join, but I couldn&apos;t figure out where a partitioner could be passed on to the internal topics for the foreign key join.&lt;/p&gt;</comment>
                            <comment id="17410827" author="abellemare" created="Mon, 6 Sep 2021 22:08:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt;&#160;- Thank you for the test code to reproduce it! It is very helpful. I can confirm that when I run it, it also fails to meet the expected values you supplied. Additionally, if I take out the `repartition` steps, it seems to join properly and work fine. Does this match your expectations?&lt;/p&gt;

&lt;p&gt;If so, then I am a bit perplexed. I am not 100% sure how repartitioning KTables upstream can affect the joins downstream. I&#160;&lt;em&gt;think&lt;/em&gt; that&#160; it could be possible that the FK joiner is using the &lt;em&gt;original&lt;/em&gt; repartitioner logic for the `Subscription` and `SubscriptionResponse` topics (and not the logic in the `repartition` command), and thus be routing the subscription and subscription responses to the wrong instances. This would certainly cause loss of events if this is indeed the case.&#160;&lt;/p&gt;

&lt;p&gt;I will need to look into the Repartition aspects a bit more because I am not familiar with them. Both the repartition command and the FKJ were added around the same time (developed in parallel), so my inclination is to start inspecting there. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;, are you more familiar with the `repartition` chunk of code? What do you think about this theory?&lt;/p&gt;</comment>
                            <comment id="17415337" author="vcrfxia" created="Wed, 15 Sep 2021 06:16:41 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=abellemare&quot; class=&quot;user-hover&quot; rel=&quot;abellemare&quot;&gt;abellemare&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&#160;I had a look at the code and it seems to support Adam&apos;s theory that the custom partitioners from the repartition() step aren&apos;t taken into account by the foreign key join. In particular, both the subscription sink topic and the response sink topic are created without partitioners specified in the&#160;StreamSinkNode:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/75795d1ed8402f185e00b5f3aedcc2bcbb914ca9/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java#L1051&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/75795d1ed8402f185e00b5f3aedcc2bcbb914ca9/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java#L1051&lt;/a&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/75795d1ed8402f185e00b5f3aedcc2bcbb914ca9/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java#L1122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/75795d1ed8402f185e00b5f3aedcc2bcbb914ca9/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KTableImpl.java#L1122&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;IIUC, this means the default partitioner is used for both topics despite the custom partitioners on the source tables, which explains the missing join results.&lt;/p&gt;

&lt;p&gt;One thing I don&apos;t understand: even if we fix this bug by propagating the partitioner information from the repartition() step to the foreign key join, wouldn&apos;t we still have an analogous bug if either of the topics for the source tables had custom partitioning logic created from outside Streams (i.e., without a repartition() step in the Streams topology)? In this case, Streams has no way of determining the partitioning of the source tables, which means we need an update to the interface for foreign key joins so that users can specify a partitioner to use in order to ensure copartitioning of the subscription and response topics with the relevant tables. Is this reasoning sound?&lt;/p&gt;

&lt;p&gt;If so, does it make sense to add logic into Streams to propagate information about the partitioner from the repartition() step to the foreign key join, or would it be better to require users to use the new interface to pass the same partitioner from the repartition() step(s) to the foreign key join as well? The latter seems more consistent with how copartitioning for joins is typically the user&apos;s responsibility, and also avoids the need to update Streams with logic for tracking partitioners throughout the topology.&lt;/p&gt;</comment>
                            <comment id="17415690" author="mjsax" created="Wed, 15 Sep 2021 18:55:00 +0000"  >&lt;p&gt;I would prefer to do a KIP and allow user to pass in a custom partitioner.&lt;/p&gt;

&lt;p&gt;If we really get follow up requests, we could extend the DSL logic to auto-forward an upstream partitioner later. Overall, it seems not that there is no bug in the strong sense, but a missing feature. We never designed FK-join to support custom partitioning.&lt;/p&gt;

&lt;p&gt;Might be worth to update the docs for 3.0 and earlier to point out this limitation.&lt;/p&gt;</comment>
                            <comment id="17415747" author="guozhang" created="Wed, 15 Sep 2021 20:41:11 +0000"  >&lt;p&gt;&amp;gt; wouldn&apos;t we still have an analogous bug if either of the topics for the source tables had custom partitioning logic created from outside Streams (i.e., without a repartition() step in the Streams topology)? In this case, Streams has no way of determining the partitioning of the source tables, which means we need an update to the interface for foreign key joins so that users can specify a partitioner to use in order to ensure copartitioning of the subscription and response topics with the relevant tables. Is this reasoning sound?&lt;/p&gt;

&lt;p&gt;Yeah I think that&apos;s faire; KS assumes the source topics are partitioned by key, but does not require it has to be partitioned with default mechanism. However when getting back to the source tables from the subscription table it simply assumes default partitioning is used. For that, I agree allowing users to pass in the partitioner in FK would be good, so that if users know the source tables are not partitioned with the default partitioner, they should be responsible for passing that custom partitioner in FK.&lt;/p&gt;</comment>
                            <comment id="17415792" author="vcrfxia" created="Wed, 15 Sep 2021 22:52:52 +0000"  >&lt;p&gt;Thanks for the confirmation, Matthias and Guozhang! I&apos;ve opened a small KIP with the proposed interface changes to allow users to pass in custom partitioners for FK joins: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-775%3A+Custom+partitioners+in+foreign+key+joins&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-775%3A+Custom+partitioners+in+foreign+key+joins&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I tried sending an email to the &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;mailto:dev@kafka.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dev@kafka.apache.org&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/mail_small.gif&quot; height=&quot;12&quot; width=&quot;13&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;mailing list to start discussion but either it&apos;s taking a while to send or my permissions aren&apos;t yet set up correctly. Hopefully it will be ready for discussion soon.&lt;/p&gt;

&lt;p&gt;UPDATE: Email for KIP discussion has been sent.&lt;/p&gt;</comment>
                            <comment id="17416776" author="vcrfxia" created="Fri, 17 Sep 2021 15:57:44 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;, after opening the KIP above I noticed a slight &quot;problem&quot; with the interfaces for users to pass custom partitioners. Can you double-check my reasoning below?&lt;/p&gt;

&lt;p&gt;The &quot;problem&quot; with the interfaces in the KIP is that interfaces currently ask users to provide &lt;tt&gt;StreamPartitioner&amp;lt;K, V&amp;gt; thisPartitioner&#160;&lt;/tt&gt;(representing the partitioning strategy for the right/foreign-key table) &#8211; as these are the partitioners that users should know &#8211; but the FK join implementation actually needs a partitioner of the form&#160;&lt;tt&gt;StreamPartitioner&amp;lt;KO, SubscriptionWrapper&amp;lt;K&amp;gt;&amp;gt;&lt;/tt&gt; instead of&#160;&lt;tt&gt;otherPartitioner&lt;/tt&gt;, and a partitioner of the form &lt;tt&gt;StreamPartitioner&amp;lt;K, SubscriptionResponseWrapper&amp;lt;VO&amp;gt;&amp;gt;&lt;/tt&gt; instead of &lt;tt&gt;thisPartitioner&lt;/tt&gt;, based on the actual messages being passed in the subscription and response topics.&lt;/p&gt;

&lt;p&gt;It doesn&apos;t make sense to ask users to pass these other partitioners since &lt;tt&gt;SubscriptionWrapper&lt;/tt&gt;&#160;and &lt;tt&gt;SubscriptionResponseWrapper&lt;/tt&gt; are internal implementation details. What we really want is to require that any custom partitioners select a partition based only on the message key, without taking the message value into consideration. I think this is a reasonable requirement for the right/foreign-key table since the subscription store mechanism (in the FK join implementation) won&apos;t work at all unless all messages with the same (foreign) key are always sent to the same partition. We don&apos;t technically need to require this for the left table since, if we wanted to, we could send the original value along with the subscription in order to ensure that the response is routed back to the correct partition, but this seems unnecessarily complicated and also bloats the size of the subscription store and topic.&lt;/p&gt;

&lt;p&gt;As such, I think we should require that any custom partitioner used for tables must partition messages based only on message key (and not value), in order to be used in FK joins. Do you agree?&lt;/p&gt;

&lt;p&gt;If so, we could make this requirement explicit in the FK join interfaces by asking users for&#160;&lt;tt&gt;StreamPartitioner&amp;lt;K, Void&amp;gt; thisPartitioner }}and{{&#160;&lt;/tt&gt;&lt;tt&gt;StreamPartitioner&amp;lt;KO, Void&amp;gt; otherPartitioner }}instead of the original partitioners. Or we could keep the interfaces as is ({{StreamPartitioner&amp;lt;K, V&amp;gt; thisPartitioner and&#160;&lt;/tt&gt;&lt;tt&gt;StreamPartitioner&amp;lt;KO, VO&amp;gt; otherPartitioner&lt;/tt&gt;), since users probably already have these handy anyway, and leave a note in the javadocs to explain the requirement. I have a preference for the latter but am curious what you think. Thanks!&lt;/p&gt;</comment>
                            <comment id="17417203" author="mjsax" created="Sat, 18 Sep 2021 18:06:39 +0000"  >&lt;p&gt;Let keep the discussion on the mailing list. &#8211; But I agree to the problem you describe. The FK-join can only work, if both tables are only partitioned using their respective key. I don&apos;t think it will become a problem in practice, but it&apos;s worth to point out in the JavaDocs.&lt;/p&gt;

&lt;p&gt;Furthermore, this problem seems to be very fundamental and I don&apos;t think we could solve it. As you pointed out, we don&apos;t have access to the value of the foreign key and thus could not pass it into the partitioner. I also agree that we should not send the full left-hand value to the right side just for this purpose. As a matter of fact, in the original FK-KIP, there was a discussion about sending the left value and computing the join result on the right side to avoid the response topics &#8211; this idea was rejected for various reasons.&lt;/p&gt;

&lt;p&gt;After I read the first paragraphs, my thought was also &quot;let&apos;s make the value-type &lt;tt&gt;Void&lt;/tt&gt;&quot;, so I am happy that you propose the exact same thing! I am on-board with it! &#8211; I&apos;ll reply to the mailing list, too.&lt;/p&gt;</comment>
                            <comment id="17423385" author="vcrfxia" created="Fri, 1 Oct 2021 17:49:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/11368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/11368&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17423388" author="vcrfxia" created="Fri, 1 Oct 2021 17:52:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt;, KIP-775 for adding interfaces to support custom partitioners in foreign key joins has been accepted and I&apos;ve opened a PR with an implementation. The integration test you shared for demonstrating the feature gap was super convenient to work with, and I&apos;ve also checked it in as part of the PR. Please let me know if you&apos;d like to be added as a contributor on the PR. Thanks again for raising this gap! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17424158" author="xnix" created="Mon, 4 Oct 2021 20:22:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vcrfxia&quot; class=&quot;user-hover&quot; rel=&quot;vcrfxia&quot;&gt;vcrfxia&lt;/a&gt;&#160;thank you so much for solving this issue, it has been very interesting to follow the progress and how the process works. Great job &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m glad the integration test could be of use!&#160;If it cause no trouble, then it would be an honor to be added as contributor.&#160;&lt;/p&gt;</comment>
                            <comment id="17426245" author="vcrfxia" created="Fri, 8 Oct 2021 15:50:46 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xnix&quot; class=&quot;user-hover&quot; rel=&quot;xnix&quot;&gt;xnix&lt;/a&gt;&#160;, of course! It&apos;s no trouble at all. Could you please share an email address to include as a coauthor on the commit when the PR is merged? &lt;a href=&quot;https://docs.github.com/en/github/committing-changes-to-your-project/creating-and-editing-commits/creating-a-commit-with-multiple-authors#required-co-author-information&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.github.com/en/github/committing-changes-to-your-project/creating-and-editing-commits/creating-a-commit-with-multiple-authors#required-co-author-information&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17427468" author="xnix" created="Tue, 12 Oct 2021 06:34:13 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vcrfxia&quot; class=&quot;user-hover&quot; rel=&quot;vcrfxia&quot;&gt;vcrfxia&lt;/a&gt;. Email&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;mailto:tomas-forsman@users.noreply.github.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tomas-forsman@users.noreply.github.com&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/mail_small.gif&quot; height=&quot;12&quot; width=&quot;13&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="13398991">KAFKA-13268</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13398991">KAFKA-13268</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13032900" name="KafkaTest.java" size="4211" author="xnix" created="Thu, 2 Sep 2021 13:22:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uhvk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mjsax</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>