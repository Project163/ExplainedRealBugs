<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19724] Global stream thread ignores all exceptions</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19724</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;tt&gt;globalStreamThread&lt;/tt&gt; in &lt;tt&gt;KafkaStreams&lt;/tt&gt; class ignores all exceptions and fails to apply the user-provided &lt;tt&gt;StreamsUncaughtExceptionHandler&lt;/tt&gt; in:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setUncaughtExceptionHandler(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsUncaughtExceptionHandler userStreamsUncaughtExceptionHandler)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This can lead to streams being stuck in faulty state after an exception is thrown during their initialization phase (e.g. failure to load the RocksDB native library). The exception isn&apos;t logged, so debugging such problem is difficult.&lt;/p&gt;

&lt;p&gt;From my understanding of the&#160;&lt;tt&gt;b62d8b97&lt;/tt&gt; commit message, the following code is unnecessary as the &lt;tt&gt;globalStreamThread&lt;/tt&gt; can&apos;t be replaced and the issue description from &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12699&quot; title=&quot;Streams no longer overrides the java default uncaught exception handler  &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12699&quot;&gt;&lt;del&gt;KAFKA-12699&lt;/del&gt;&lt;/a&gt; doesn&apos;t apply to it. Removing it should help.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (globalStreamThread != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    globalStreamThread.setUncaughtExceptionHandler((t, e) -&amp;gt; { }
    );
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13629404">KAFKA-19724</key>
            <summary>Global stream thread ignores all exceptions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fatihcelik">Fatih Celik</assignee>
                                    <reporter username="mikkolaj">Miko&#322;aj Bul</reporter>
                        <labels>
                            <label>beginner</label>
                            <label>newbie</label>
                    </labels>
                <created>Fri, 19 Sep 2025 06:53:51 +0000</created>
                <updated>Fri, 17 Oct 2025 07:59:36 +0000</updated>
                            <resolved>Fri, 17 Oct 2025 07:59:36 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.9.2</fixVersion>
                    <fixVersion>4.2.0</fixVersion>
                    <fixVersion>4.0.2</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="18021470" author="mjsax" created="Fri, 19 Sep 2025 17:24:30 +0000"  >&lt;p&gt;Thanks for reporting the issue. &#8211; Not logging some exception is for sure a problem. This should be easy to fix.&lt;/p&gt;

&lt;p&gt;While I agree that `globalStreamThread.setUncaughtExceptionHandler((t, e) -&amp;gt; { });` is not useful any longer, I don&apos;t think removing this code solves the problem. &#8211; In older version of KS, we use the Java uncaught exception handler, but we did move off it, in favor of a custom implementation. However, this custom implementation which allows to restart dying thread, only makes sense for `StreamsThreads`, but not for the `GlobalThread` &#8211; of the `GlobalThread` dies, we can only close KafkaStreams client with an ERROR state (what we do). &lt;span class=&quot;error&quot;&gt;&amp;#91;In AK 4.0, we remove the old code, and it seems we did not do a proper cleanup; that&amp;#39;s all.&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;But yes, we should fix the logging issue for sure.&lt;/p&gt;</comment>
                            <comment id="18021483" author="JIRAUSER310996" created="Fri, 19 Sep 2025 18:37:25 +0000"  >&lt;p&gt;You&apos;re right, now I see that the first call to &lt;tt&gt;setUncaughtExceptionHandler&lt;/tt&gt; on &lt;tt&gt;globalStreamThread&lt;/tt&gt; is using the new implementation and sets it right. I might have incorrectly pinpointed my issue.&lt;/p&gt;

&lt;p&gt;I&apos;ve verified that the problem I&apos;ve encountered happens when &lt;tt&gt;initialize()&lt;/tt&gt; call in &lt;tt&gt;GlobalStreamThread:276&lt;/tt&gt; throws an &lt;tt&gt;ExceptionInInitializerError&lt;/tt&gt; due to RocksDB failing to load the library in static initializer of &lt;tt&gt;DBOptions&lt;/tt&gt;. This exception was only caught inside the &lt;tt&gt;java.lang.Thread&lt;/tt&gt; exception handler of the &lt;tt&gt;globalStreamThread&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="18021553" author="JIRAUSER311005" created="Sat, 20 Sep 2025 07:49:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I want to help Kafka development for the first time. I have the ticket but I don&apos;t know what to do exactly. Can you guide me on what to do about it?&lt;/p&gt;</comment>
                            <comment id="18021595" author="JIRAUSER310996" created="Sat, 20 Sep 2025 21:56:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fatihcelik&quot; class=&quot;user-hover&quot; rel=&quot;fatihcelik&quot;&gt;fatihcelik&lt;/a&gt;, thanks for your interest in solving the issue.&lt;/p&gt;

&lt;p&gt;The problem I see is that &lt;tt&gt;GlobalStreamThread&lt;/tt&gt; lacks handling for &lt;tt&gt;Error&lt;/tt&gt; instances (e.g. &lt;tt&gt;ExceptionInInitializerError&lt;/tt&gt; or &lt;tt&gt;UnsatisfiedLinkError&lt;/tt&gt;). They aren&apos;t caught in &lt;tt&gt;streamsUncaughtExceptionHandler&lt;/tt&gt; and propagate to &lt;tt&gt;Thread.UncaughtExceptionHandler&lt;/tt&gt;, which might be a no-op. As a result the global thread can die silently.&lt;/p&gt;

&lt;p&gt;Let&apos;s wait for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&apos;s opinion, but I think it would be possible to handle it by implementing a &lt;tt&gt;Thread.UncaughtExceptionHandler&lt;/tt&gt; for &lt;tt&gt;globalStreamThread&lt;/tt&gt;, which logs the error and calls &lt;tt&gt;closeToError()&lt;/tt&gt;, so that the stream can transition to &lt;tt&gt;ERROR&lt;/tt&gt; state.&lt;/p&gt;</comment>
                            <comment id="18021656" author="JIRAUSER311005" created="Sun, 21 Sep 2025 13:10:20 +0000"  >&lt;p&gt;Thank you for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt;. So, for now we&apos;re waiting to hear from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="18021744" author="mjsax" created="Mon, 22 Sep 2025 06:34:43 +0000"  >&lt;p&gt;While this might work, I am wondering if it&apos;s really how we want/need to do it? Where does &quot;UnsatisfiedLinkError&quot; happen, and how could we test it properly?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt; can you clarify if the problem is only missing logging, or also that KafkaStreams does not go into ERROR state?&lt;/p&gt;

&lt;p&gt;Looking into the code, `run()` first call `initialize()` which has a try-catch that covers the whole method, and would set `startupException`, and return `null`, what should actually transit the state into PENDING_SHUTDOWN and DEAD, and log an error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error happened during initialization of the global state store; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; thread has shutdown.&quot;&lt;/span&gt;); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Of course, if the error does not happen inside `initialize()` or we don&apos;t handle it properly (we catch `Exception` but not `Throwable`) this code won&apos;t work as expected... Could it be, that catching Throwable instead of Exception would be enough to fix the issue? We also catch Throwable in `StreamsThread#run()`...&lt;/p&gt;</comment>
                            <comment id="18021835" author="JIRAUSER310996" created="Mon, 22 Sep 2025 11:34:56 +0000"  >&lt;p&gt;It is both missing logging and stream not going into &lt;tt&gt;ERROR&lt;/tt&gt; state.&lt;/p&gt;

&lt;p&gt;Replication of &lt;tt&gt;UnsatisfiedLinkError&lt;/tt&gt; hitting the no-op error handler:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Include &lt;tt&gt;kafka-streams-scala&lt;/tt&gt; dependency in &lt;tt&gt;4.1.0&lt;/tt&gt; version&lt;/li&gt;
	&lt;li&gt;Create a Scala app with a KafkaStreams topology which relies on RocksDB global state store, e.g:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; builder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamsBuilder()
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; input: KStream[String, String] = builder.stream[String, String](&lt;span class=&quot;code-quote&quot;&gt;&quot;input-topic&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; globalTable: GlobalKTable[String, Int] = builder.globalTable[String, Int](&lt;span class=&quot;code-quote&quot;&gt;&quot;global-table-topic&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; joinedStream: KStream[String, Int] = input.join(globalTable)((key, _) =&amp;gt; key, (_, joinedValue) =&amp;gt; joinedValue)
    joinedStream.to(&lt;span class=&quot;code-quote&quot;&gt;&quot;output-topic&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; streams: KafkaStreams = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaStreams(builder.build(), config)
    streams.setUncaughtExceptionHandler { _ =&amp;gt;
      &lt;span class=&quot;code-comment&quot;&gt;// currently I won&apos;t be called
&lt;/span&gt;      SHUTDOWN_APPLICATION
    }
    streams.start()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Set up required topics&lt;/li&gt;
	&lt;li&gt;Run the app on Linux with &lt;tt&gt;/tmp&lt;/tt&gt; directory mounted with &lt;tt&gt;noexec&lt;/tt&gt; option (or set &lt;tt&gt;ROCKSDB_SHAREDLIB_DIR&lt;/tt&gt; env variable to point to such directory)&lt;/li&gt;
	&lt;li&gt;No error logging present and &lt;tt&gt;globalStreamThread&lt;/tt&gt; dies&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Catching &lt;tt&gt;Throwable&lt;/tt&gt; as you suggested will fix my issue but I&apos;m not sure if it&apos;s a good solution in general. Will it work in more serious cases, e.g. &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; being thrown? As per &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/lang/Error.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java docs&lt;/a&gt; in general &lt;tt&gt;Error&lt;/tt&gt; shouldn&apos;t be caught (and in Scala I&apos;ve usually seen &lt;a href=&quot;https://www.scala-lang.org/api/2.13.3/scala/util/control/NonFatal$.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NonFatal&lt;/a&gt; extractor being used instead of catching &lt;tt&gt;Throwable&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="18021966" author="mjsax" created="Mon, 22 Sep 2025 23:23:33 +0000"  >&lt;p&gt;OutOfMemoryError is also a Throwable. &#8211; Yes, in general, Error / Throwable should not be caught. But if you just try to log, it should be ok?&lt;/p&gt;

&lt;p&gt;The problem with the Java uncaught exception handler is, that the thread is already dead. So I think you can do even less? &#8211; I am also not objecting to use the Java uncaught exception handler as a last line of defense (but I am not sure if we need to do this, when we can also get it done by catching Throwable), but if we go this route, we should do it for all threads, including `StreamThread` and `StateUpdaterThread`?&lt;/p&gt;

&lt;p&gt;Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lucasbru&quot; class=&quot;user-hover&quot; rel=&quot;lucasbru&quot;&gt;lucasbru&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt; have an opinion?&lt;/p&gt;</comment>
                            <comment id="18022063" author="JIRAUSER310996" created="Tue, 23 Sep 2025 07:05:47 +0000"  >&lt;p&gt;I was wondering if maybe going a similar way to &lt;tt&gt;NonFatal&lt;/tt&gt; would be a good approach &#8211; catch only these exceptions / errors that we know won&apos;t interrupt executing the regular cleanup code (e.g. &lt;tt&gt;UnsatisfiedLinkError&lt;/tt&gt; in &lt;tt&gt;initialize()&lt;/tt&gt; method) and propagate other ones to some &lt;tt&gt;UncaughtExceptionHandler&lt;/tt&gt; defined in the user code, giving user the ability to forcefully shut down the application if something really bad happens.&#160;&lt;/p&gt;</comment>
                            <comment id="18022105" author="cadonna" created="Tue, 23 Sep 2025 08:57:58 +0000"  >&lt;p&gt;We specified the Streams uncaught exception handler to handle &lt;tt&gt;Throwable&lt;/tt&gt;. If we want to keep that, we need to catch {{Throwable}}s. And we actually already do that for stream threads. &lt;br/&gt;
The Java uncaught exception handler also handles {{Throwable}}s and we wanted to have a custom uncaught exception handler for Streams.&lt;br/&gt;
To be fair, the global stream thread is a bit special since it cannot be replaced as the stream threads. So, I would either:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;log the failure in the Java uncaught exception of the global stream thread and let the Kafka Streams instance just fail with the throwable, or&lt;/li&gt;
	&lt;li&gt;catch the &lt;tt&gt;Throwable&lt;/tt&gt; and log (and let the Kafka Streams instance fail).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="18022455" author="JIRAUSER311005" created="Wed, 24 Sep 2025 14:53:16 +0000"  >&lt;p&gt;I don&apos;t fully understand the situations mentioned. I might be misunderstanding, and I&apos;d appreciate it if you could correct me. Currently, if a handler isn&apos;t set with &lt;tt&gt;setUncaughtExceptionHandler&lt;/tt&gt;, I can already see the error in the logs. The error occurs when &lt;tt&gt;setUncaughtExceptionHandler()&lt;/tt&gt; is called. Is the change here really to catch and log a &lt;tt&gt;Throwable&lt;/tt&gt; object on the relevant line? It does this when setUncaughtExceptionHandler isn&apos;t called. (Also, the application doesn&apos;t shutdown despite receiving the error.)&lt;/p&gt;</comment>
                            <comment id="18022529" author="mjsax" created="Wed, 24 Sep 2025 19:37:42 +0000"  >&lt;p&gt;Not sure if I can follow &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt;? All exception that go into the StreamsUncaughtExceptionHandler are fatal exception. Or course, there is still different &quot;classes&quot; of fatal ones, but not sure if it would really matter much? KS tries to call the handler in any case and let the user react to it.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The error occurs when &lt;tt&gt;setUncaughtExceptionHandler()&lt;/tt&gt;&#160;is called&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, that&apos;s &quot;just&quot; a bug. By default, when you call `new KafkaStreams()` there is a default exception handler set (also on the GlobalThreadThread; for this case, via the constructor). When you call `KafkaStreams#setUncaughExceptionHandler()` the issue happens because we first set the user provided handler correctly (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L467-L471)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L467-L471)&lt;/a&gt; but later overwrite it incorrectly (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Nevertheless, the initialization phase is not covered: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L276-L292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L276-L292&lt;/a&gt; and I would assume that `UnsatisfiedLinkError` would be thrown here, not invoking any handler. The regular processing-loop is covered though, and we call the handler (however, we don&apos;t catch Throwable): &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L295-L343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L295-L343&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18022675" author="JIRAUSER310996" created="Thu, 25 Sep 2025 08:08:42 +0000"  >&lt;p&gt;My case can be fixed by catching the error&#160;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and it will get re-thrown by the thread calling &lt;tt&gt;streams.start()&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I was trying to advocate against catching &lt;tt&gt;Throwable&lt;/tt&gt; because I&apos;ve seen posts like &lt;a href=&quot;https://stackoverflow.com/a/352793&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;, saying that when a &lt;tt&gt;VirtualMachineError&lt;/tt&gt; is thrown there are no guarantees for executing any code reliably, including error handling or passing the error to a custom exception handler.&lt;/p&gt;

&lt;p&gt;Java&apos;s &lt;tt&gt;UncaughtExceptionHandler&lt;/tt&gt; seems to me like the last line of defense, where user could try to detect these problems and take action like shutting down the app. Setting these handlers to no-op &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L472-L478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; looks like ignoring everything that&apos;s unexpected.&lt;/p&gt;

&lt;p&gt;I might be wrong though, so I&apos;m not pushing for any specific solution. Catching &lt;tt&gt;Throwable&lt;/tt&gt; should probably handle most of the cases just fine.&lt;/p&gt;</comment>
                            <comment id="18023029" author="JIRAUSER311005" created="Fri, 26 Sep 2025 08:15:58 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; , everything is much clearer now. However, we need to fix one issue. The &lt;tt&gt;UnsatisfiedLinkError&lt;/tt&gt; does not appear in the lines specified here.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L295-L343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L295-L343&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s appearing exactly here. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt;&#160; already mentioned this in their last comment:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L276&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18023224" author="mjsax" created="Fri, 26 Sep 2025 23:04:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt;, yes, this aligns to what I said earlier: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-19724?focusedCommentId=18021744&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-18021744&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-19724?focusedCommentId=18021744&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-18021744&lt;/a&gt; &#8211; catching Throwable instead of Exception should&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; address the issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The concern about catching Throwable is totally valid; no disagreement. We do it in Kafka Streams basically as a &quot;best effort&quot; approach, and are well aware that it might not always work.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Java&apos;s&#160;&lt;tt&gt;UncaughtExceptionHandler&lt;/tt&gt;&#160;seems to me like the last line of defense, where user could try to detect these problems and take action like shutting down the app&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am not deep enough into JVM details, but I am wondering if this is actually guaranteed? After a Throwable, the JVM is in &quot;very bad state&quot; from my understanding, and I am not sure what guarantees there are that the handler is invoked, and what code would be guaranteed to get executed inside the handler?&lt;/p&gt;

&lt;p&gt;That we set the handler as a no-op, is clearly a bug (as said above already): We actually set the handler first &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L467-L471&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L467-L471&lt;/a&gt; and incorrectly set it as no-op right afterwards.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Catching&#160;&lt;tt&gt;Throwable&lt;/tt&gt;&#160;should probably handle most of the cases just fine.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, that&apos;s why we do is this way.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fatihcelik&quot; class=&quot;user-hover&quot; rel=&quot;fatihcelik&quot;&gt;fatihcelik&lt;/a&gt; &#8211; yes. But inside `initialize()` as also pointed out by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikkolaj&quot; class=&quot;user-hover&quot; rel=&quot;mikkolaj&quot;&gt;mikkolaj&lt;/a&gt;, we would catch `Throwable` here: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434&lt;/a&gt; to address it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So easy fix: Change &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/GlobalStreamThread.java#L434&lt;/a&gt; from `Exception` to `Throwable` and remove &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java#L475-L478&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Additionally, we could consider to also mess with `Thread#setUncaughtExceptionHandler()` (note, that both `StreamsThread` and `GlobalThread`, and neither the new `StateUpdatedThread` use this method &#8211; the methods we discussed above, are overload from KS which work with `StreamsUncaughtExceptionHandler`, not the Java `Thread.UncaughtExceptionHandler`), but I am not sure if this would buy us much? The tricky part would be, that `StreamsThreads`, `StateUpdaterThread` and `GlobalStreamThread` are background threads and are not exposed to the user, and we also would not want to add new public API to avoid confusion (having `KafkaStreams#setUncaughtExceptionHandler(StreamsUncaughtExceptionHandler)` and `KafkaStreams#setUncaughtExceptionHandler(Thread.UncaughExceptionHandler)` would be very weird). &#8211; But we could either register our own KS specific handler, or use `Thread.currentThread().getUncaughExceptionHandler` to get whatever handler is set on the main thread, and add it to background threads. But as said already, not sure if this would help much &#8211; but I also don&apos;t think it would cause any issues? &#8211; Also not sure if this is necessary as using `Thread.setDefaultUncaughtExceptionHandler()` should just do the trick?&lt;/p&gt;</comment>
                            <comment id="18028593" author="JIRAUSER311005" created="Thu, 9 Oct 2025 08:41:29 +0000"  >&lt;p&gt;For this issue, I created the following PR:&#160;&lt;a href=&quot;https://github.com/apache/kafka/pull/20668&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/20668 &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is my first contribution to an open source project &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Could you please let me know if there are any things I need to fix?&lt;/p&gt;</comment>
                            <comment id="18030008" author="JIRAUSER310996" created="Wed, 15 Oct 2025 08:48:03 +0000"  >&lt;p&gt;&lt;cite&gt;I am not sure what guarantees there are that the handler is invoked&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I haven&apos;t found any specific guarantees being mentioned in the docs, so I would assume it&apos;s executed on a best efforts basis.&lt;/p&gt;

&lt;p&gt;I agree that exposing a separate API for setting the Java exception handler would be confusing and a KS specific handler seems like a difficult thing to implement (I&apos;m not sure what would be a proper behavior that would suit all the cases). From my perspective not setting such handler and relying on user supplying his own default handler with &lt;tt&gt;Thread.setDefaultUncaughtExceptionHandler()&lt;/tt&gt; seems like a reasonable solution.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fatihcelik&quot; class=&quot;user-hover&quot; rel=&quot;fatihcelik&quot;&gt;fatihcelik&lt;/a&gt;&apos;s PR looks good to me. Thanks guys for your help and cooperation here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xrzs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>