<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:29:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7572] Producer should not send requests with negative partition id</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7572</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Issue%3A&quot;&gt;&lt;/a&gt;Issue:&lt;/h3&gt;

&lt;p&gt;In one Kafka producer log from our users, we found the following weird one:&lt;/p&gt;

&lt;p&gt;timestamp=&quot;2018-10-09T17:37:41,237-0700&quot;,level=&quot;ERROR&quot;, Message=&quot;Write to Kafka failed with: &quot;,exception=&quot;java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Expiring 1 record(s) for topicName--2: 30042 ms has passed since batch creation plus linger time&lt;br/&gt;
 at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.valueOrError(FutureRecordMetadata.java:94)&lt;br/&gt;
 at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.get(FutureRecordMetadata.java:64)&lt;br/&gt;
 at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.get(FutureRecordMetadata.java:29)&lt;br/&gt;
 at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
 at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
 at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused by: org.apache.kafka.common.errors.TimeoutException: Expiring 1 record(s) for topicName--2: 30042 ms has passed since batch creation plus linger time&quot;&lt;/p&gt;

&lt;p&gt;After a few hours debugging, we finally understood the root cause of this issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The producer used a buggy custom Partitioner, which sometimes generates negative partition ids for new records.&lt;/li&gt;
	&lt;li&gt;The corresponding produce requests were rejected by brokers, because it&apos;s illegal to have a partition with a negative id.&lt;/li&gt;
	&lt;li&gt;The client kept refreshing its local cluster metadata, but could not send produce requests successfully.&lt;/li&gt;
	&lt;li&gt;From the above log, we found a suspicious string &quot;topicName--2&quot;:&lt;/li&gt;
	&lt;li&gt;According to the source code, the format of this string in the log is TopicName+&quot;-&quot;+PartitionId.&lt;/li&gt;
	&lt;li&gt;It&apos;s not easy to notice that there were 2 consecutive dash in the above log.&lt;/li&gt;
	&lt;li&gt;Eventually, we found that the second dash was a negative sign. Therefore, the partition id is -2, rather than 2.&lt;/li&gt;
	&lt;li&gt;The bug the custom Partitioner.&lt;/li&gt;
&lt;/ol&gt;


&lt;h3&gt;&lt;a name=&quot;Proposal%3A&quot;&gt;&lt;/a&gt;Proposal:&lt;/h3&gt;
&lt;ol&gt;
	&lt;li&gt;Producer code should check the partitionId before sending requests to brokers.&lt;/li&gt;
	&lt;li&gt;If there is a negative partition Id, just throw an IllegalStateException{{&#160;}}exception.&lt;/li&gt;
	&lt;li&gt;Such a quick&#160;check can save lots of time for people debugging their producer code.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13195206">KAFKA-7572</key>
            <summary>Producer should not send requests with negative partition id</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zetaplusae">Wenhao Ji</assignee>
                                    <reporter username="yaodong">Yaodong Yang</reporter>
                        <labels>
                            <label>patch-available</label>
                    </labels>
                <created>Tue, 30 Oct 2018 19:41:33 +0000</created>
                <updated>Mon, 7 Feb 2022 17:54:36 +0000</updated>
                            <resolved>Mon, 7 Feb 2022 17:54:36 +0000</resolved>
                                    <version>1.0.1</version>
                    <version>1.1.1</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16669268" author="githubbot" created="Tue, 30 Oct 2018 20:08:49 +0000"  >&lt;p&gt;yaodong66 opened a new pull request #5858: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7572&quot; title=&quot;Producer should not send requests with negative partition id&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7572&quot;&gt;&lt;del&gt;KAFKA-7572&lt;/del&gt;&lt;/a&gt;: Producer should not send requests with negative partition id&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5858&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5858&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Partition id should never be a negative value.&lt;br/&gt;
   This commit will make debug easier, when custom Partitioner generate an invalid negative partition id.&lt;/p&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16684574" author="yaodong" created="Tue, 13 Nov 2018 00:54:05 +0000"  >&lt;p&gt;I updated this PR with a change of exception type. Please let me know if there is any question about this issue.&lt;/p&gt;</comment>
                            <comment id="17482323" author="zetaplusae" created="Wed, 26 Jan 2022 08:38:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Would you mind reviewing the pr &lt;a href=&quot;https://github.com/apache/kafka/pull/10525&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#10525&lt;/a&gt; for me?&lt;/p&gt;</comment>
                            <comment id="17486780" author="guozhang" created="Fri, 4 Feb 2022 01:48:52 +0000"  >&lt;p&gt;Thanks for pinging me. I&apos;ve just made a pass on the PR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zte7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>guozhang</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>