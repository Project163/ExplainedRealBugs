<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-498] Controller code has race conditions and synchronization bugs</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-498</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The controller maintains some internal data structures that are updated by state changes triggered by zookeeper listeners. There are race conditions in the controller channel manager and the controller state machine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12606436">KAFKA-498</key>
            <summary>Controller code has race conditions and synchronization bugs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Thu, 6 Sep 2012 16:53:02 +0000</created>
                <updated>Wed, 12 Sep 2012 04:14:10 +0000</updated>
                            <resolved>Tue, 11 Sep 2012 20:42:13 +0000</resolved>
                                    <version>0.8.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13449877" author="nehanarkhede" created="Thu, 6 Sep 2012 18:09:10 +0000"  >&lt;p&gt;1. Refactoring of current procedural controller code to functional style&lt;br/&gt;
1.1. Using switch case statements instead of if-else&lt;br/&gt;
1.2. Avoid explicit return statements from try-catch blocks&lt;br/&gt;
1.3. Use Option instead of null. This is very important, there were several places that handled only the non-null case, basically making way for NPE&apos;s in error cases.&lt;br/&gt;
1.4. Rename variables in all capital letters to camel case&lt;br/&gt;
1.5. Fixed logging since a lot of log statements were at info and were somewhat unclear&lt;br/&gt;
1.6. Fixed indentation, some places uses 4 spaces, others used 2 spaces.&lt;br/&gt;
1.7. ZkUtils.scala&lt;br/&gt;
1.7.1 Refactored readDataMaybeNull to return an Option instead of null. This allows all usages of that API that query an ephemeral path to handle the case when the value in zookeeper does not exist anymore&lt;br/&gt;
1.7.2. Refactored getBrokerInfoFromIds to handle only a single broker id. The reason is that most usages of that API used it to query for a single broker id.&lt;br/&gt;
1.8 Many places in the code did not wrap the lines correctly. Fixed this as much as I could.&lt;/p&gt;

&lt;p&gt;2. KafkaController.scala&lt;br/&gt;
2.1/ Renamed deliverLeaderAndISRFromZookeeper to readLeaderAndIsrFromZookeeper&lt;br/&gt;
2.2 There is a race condition in KafkaController where it doesn&apos;t synchronize access to the controller&apos;s data structures while creating a new session. Basically, controllerRegisterOrFailover is a private API that modifies almost all the internal controller data structures that require synchronization. Since this API is not synchronizing on the controller lock, all usages of this API need to do this correctly. Fixed handleNewSession to synchronize the controllerRegisterOrFailover API, since that can be concurrently executed with the startup procedure.&lt;br/&gt;
2.3 In onBrokerChange, defaulting to empty list instead of null. This lets us avoid null checks&lt;br/&gt;
2.4 Refactored onBrokerChange() API and moved the leader election logic to a separate API. After starting on this path, I figured that this code is going to need a major refactoring that I&apos;d like to fix in a separate patch. Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-499&quot; title=&quot;Refactor controller state machine &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-499&quot;&gt;&lt;del&gt;KAFKA-499&lt;/del&gt;&lt;/a&gt; to cover that. For now, we can keep this although it will look complete only after &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-499&quot; title=&quot;Refactor controller state machine &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-499&quot;&gt;&lt;del&gt;KAFKA-499&lt;/del&gt;&lt;/a&gt; is in.&lt;br/&gt;
2.5 onBrokerChange() and initLeaders() APIs are very similar and duplicate quite a lot of code. I refactored onBrokerChange() but realized later that initLeaders would have to refactored too. To keep the changes in this patch small enough, I will fix this as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-499&quot; title=&quot;Refactor controller state machine &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-499&quot;&gt;&lt;del&gt;KAFKA-499&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;3. ControllerChannelManager &amp;amp; KafkaController&lt;br/&gt;
3.1 There are 3 types of information that the controller maintains per broker - request thread, message queue and socket channel. Currently, they are maintained in 3 separate variables and we need to ensure all 3 are synchronized correctly. To simplify this, I created a case class to wrap this state in one object.&lt;br/&gt;
3.2 There is a lock object whose purpose is to synchronize access to the broker cache. Currently, the lock doesn&apos;t seem to protect all access to these caches, which looks like a synchronization bug. Fixed this to have startup API synchronize access to the broker cache.&lt;br/&gt;
3.3. The addBroker logic was duplicated in 2 places. Refactored the constructors to add an auxilary constructor to call the addBroker API that handles creating controller state info for a new broker and the appropriate synchronization. Currently, the constructor duplicates code to add a new broker, probably since it is not right to invoke an API from inside the primary constructor&lt;br/&gt;
3.4 There are 2 ways to remove a broker from the controller&apos;s broker cache - during shutdown of the channel manager or when a broker change listener fires. Since removeBroker is a public API, it is synchronized using the brokerLock. The shutdown API calls removeBroker internally and ends up acquiring and releasing the lock multiple times. Ideally, it is sufficient to acquire the brokerLock just once for the entire shutdown API. Refactored to move the common removeBroker logic to a private API that doesn&apos;t synchronize on the brokerLock. Changed removeBroker to acquire lock and call removeExistingBroker, changed shutdown to acquire lock once and call removeExistingBroker.&lt;/p&gt;

&lt;p&gt;4. Renamed LeaderAndISR to LeaderAndIsr&lt;/p&gt;

&lt;p&gt;5. Renamed BrokerNotExistException to BrokerNotAvailableException to remain consistent with other exceptions of the same type (LeaderNotAvailableException, ReplicaNotAvailableException)&lt;/p&gt;


&lt;p&gt;NOTE: Apache svn seems to hang at the time of uploading this patch. It will apply cleanly on revision 1380945&lt;/p&gt;</comment>
                            <comment id="13450122" author="nehanarkhede" created="Thu, 6 Sep 2012 22:59:16 +0000"  >&lt;p&gt;Deleted an unused file, fixed minor typo&lt;/p&gt;</comment>
                            <comment id="13450808" author="junrao" created="Fri, 7 Sep 2012 17:26:20 +0000"  >&lt;p&gt;Thanks for the patch. Overall, a good cleanup patch. Some minor comments:&lt;/p&gt;

&lt;p&gt;1. ControllerBrokerStateInfo: Should we include Broker in this class too?&lt;/p&gt;

&lt;p&gt;2. ControllerChannelManager:&lt;br/&gt;
2.1  brokers.foreach(broker =&amp;gt; brokerStateInfo(broker._1).requestSendThread.start()) can be done as &lt;br/&gt;
    brokers.foreach&lt;/p&gt;
{ case(brokerId, _)  =&amp;gt; brokerStateInfo(brokerId).requestSendThread.start() }
&lt;p&gt;2.2 startup: Should call startRequestSendThread()&lt;/p&gt;

&lt;p&gt;3. readLeaderAndIsrFromZookeeper:&lt;br/&gt;
3.1 This method also sends leaderAndISR requests to brokers, in addition to reading from ZK. Maybe we can call it readAndSendLeaderAndIsrFromZookeeper?&lt;br/&gt;
3.2 If no replicas are assigned to a partition, is it necessary to log the assignment for all partitions? Ditto for onBrokerChange&lt;/p&gt;</comment>
                            <comment id="13450840" author="nehanarkhede" created="Fri, 7 Sep 2012 18:08:01 +0000"  >&lt;p&gt;Thanks for the review !&lt;/p&gt;

&lt;p&gt;1. Good point. Included Broker in ControllerBrokerStateInfo&lt;br/&gt;
2.1 brokerStateInfo.foreach(brokerState =&amp;gt; startRequestSendThread(brokerState._1)) looks simpler&lt;br/&gt;
2.2 Al though it will be slightly inefficient to do that, it probably is easier to read&lt;br/&gt;
3.1 This API is pretty badly named and designed. It will be refactored in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-499&quot; title=&quot;Refactor controller state machine &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-499&quot;&gt;&lt;del&gt;KAFKA-499&lt;/del&gt;&lt;/a&gt;, but changed the name to what you&lt;br/&gt;
suggested for now.&lt;br/&gt;
3.2 Not sure it is very useful in the context of the controller&apos;s state machine. But right now, it is very unclear as&lt;br/&gt;
to what the state machine is and which transitions cause what state changes. I think I will have a better handle on this in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-499&quot; title=&quot;Refactor controller state machine &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-499&quot;&gt;&lt;del&gt;KAFKA-499&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
4. Synchronized the addBroker public API on the brokerLock&lt;br/&gt;
5. Synchronized the sendRequest public API on the brokerLock&lt;/p&gt;</comment>
                            <comment id="13451088" author="junrao" created="Fri, 7 Sep 2012 22:34:22 +0000"  >&lt;p&gt;+1 on the latest patch.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12514679">KAFKA-42</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12544084" name="kafka-498-v1.patch" size="101316" author="nehanarkhede" created="Thu, 6 Sep 2012 18:09:10 +0000"/>
                            <attachment id="12544250" name="kafka-498-v2.patch" size="103716" author="nehanarkhede" created="Fri, 7 Sep 2012 18:08:01 +0000"/>
                            <attachment id="12544129" name="kafka-498-v2.patch" size="103602" author="nehanarkhede" created="Thu, 6 Sep 2012 22:59:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>299148</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 11 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i15zw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243115</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>