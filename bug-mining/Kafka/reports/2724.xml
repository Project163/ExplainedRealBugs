<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:24:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10173] BufferUnderflowException during Kafka Streams Upgrade</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10173</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I migrated a Kafka Streams application from version 2.3.1 to 2.5.0. I followed the steps described in the upgrade guide and set the property &lt;tt&gt;migrate.from=2.3&lt;/tt&gt;. On my dev system with just one running instance I got the following exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;stream-thread [0-StreamThread-2] Encountered the following error during processing:
java.nio.BufferUnderflowException: null
	at java.base/java.nio.HeapByteBuffer.get(Unknown Source)
	at java.base/java.nio.ByteBuffer.get(Unknown Source)
	at org.apache.kafka.streams.state.internals.BufferValue.extractValue(BufferValue.java:94)
	at org.apache.kafka.streams.state.internals.BufferValue.deserialize(BufferValue.java:83)
	at org.apache.kafka.streams.state.internals.InMemoryTimeOrderedKeyValueBuffer.restoreBatch(InMemoryTimeOrderedKeyValueBuffer.java:368)
	at org.apache.kafka.streams.processor.internals.CompositeRestoreListener.restoreBatch(CompositeRestoreListener.java:89)
	at org.apache.kafka.streams.processor.internals.StateRestorer.restore(StateRestorer.java:92)
	at org.apache.kafka.streams.processor.internals.StoreChangelogReader.processNext(StoreChangelogReader.java:350)
	at org.apache.kafka.streams.processor.internals.StoreChangelogReader.restore(StoreChangelogReader.java:94)
	at org.apache.kafka.streams.processor.internals.TaskManager.updateNewAndRestoringTasks(TaskManager.java:401)
	at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:779)
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:697)
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:670)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I figured out, that this problem only occurs for stores, where I use the suppress feature. If I rename the changelog topics during the migration, the problem will not occur.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311732">KAFKA-10173</key>
            <summary>BufferUnderflowException during Kafka Streams Upgrade</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vvcephei">John Roesler</assignee>
                                    <reporter username="karsten.schnitter">Karsten Schnitter</reporter>
                        <labels>
                            <label>suppress</label>
                    </labels>
                <created>Tue, 16 Jun 2020 13:58:06 +0000</created>
                <updated>Wed, 12 Jan 2022 19:03:36 +0000</updated>
                            <resolved>Mon, 6 Jul 2020 19:09:08 +0000</resolved>
                                    <version>2.5.0</version>
                                    <fixVersion>2.4.2</fixVersion>
                    <fixVersion>2.5.1</fixVersion>
                    <fixVersion>2.6.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17137089" author="vvcephei" created="Tue, 16 Jun 2020 17:25:21 +0000"  >&lt;p&gt;Thanks for the report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt; . I&apos;m sorry for the trouble.&lt;/p&gt;

&lt;p&gt;I&apos;ve marked it as a blocker for the ongoing 2.5.1 release. I&apos;ll investigate the root cause ASAP.&lt;/p&gt;</comment>
                            <comment id="17137902" author="mjsax" created="Tue, 16 Jun 2020 20:10:44 +0000"  >&lt;p&gt;Would be great to know if this might be a blocker for 2.6, too. \cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt;&#160;(just as a potential heads-up).&lt;/p&gt;</comment>
                            <comment id="17138616" author="rhauch" created="Wed, 17 Jun 2020 16:19:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;: I guess whether we should include this in 2.6 depends on the timing and the risk. We&apos;ll start cutting RCs pretty soon.&lt;/p&gt;</comment>
                            <comment id="17140863" author="vvcephei" created="Fri, 19 Jun 2020 22:23:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I&apos;ve had a chance now to look into this. It&apos;s actually quite strange, although I&apos;m probably missing something.&lt;/p&gt;

&lt;p&gt;That stacktrace means that Streams is actually having trouble deserializing data written with changelog schema version 2, which IIRC was introduced in version 2.4.0. If you only ran the application with version 2.3.1, stopped it, then started it with version 2.5.0, it shouldn&apos;t be possible to hit this branch, as it means reading data that 2.3.1 couldn&apos;t possibly have written.&lt;/p&gt;

&lt;p&gt;The only thing I can imagine is if you had previously run Streams with a version &lt;em&gt;less than&lt;/em&gt; 2.3.0 AND if some of your data happened to contain a header with the name &quot;v&quot;, then it could lead to this kind of corruption. But, in that case, you should have gotten an exception while running with version 2.3.1 already. So, this doesn&apos;t sound like it fits.&lt;/p&gt;

&lt;p&gt;The only thing that seems to fit your report is that the serialization/deserialization logic is actually wrong. But it&apos;s quite heavily tested, and has been exercised in production for quite a while also. There is always the possibility of a rare edge case, though. I&apos;ve just given the logic another pass, and I&apos;m not seeing what could be the problem. Is there any chance you could find the changelog record that caused this exception and just send me the bytes for it?&lt;/p&gt;

&lt;p&gt;Short of that, I&apos;m not sure how to proceed.&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;

&lt;p&gt;P.s., while reviewing the code, I did find one flaw, which I&apos;ve submitted &lt;a href=&quot;https://github.com/apache/kafka/pull/8905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8905&lt;/a&gt; for. I doubt that was your problem, but we might as well fix it anyway.&lt;/p&gt;</comment>
                            <comment id="17140865" author="vvcephei" created="Fri, 19 Jun 2020 22:29:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; , you can consider my last comment for yourselves, but it doesn&apos;t seem like this would need to block 2.6.0. The code in question doesn&apos;t seem to have changed since 2.4.0.&lt;/p&gt;</comment>
                            <comment id="17141736" author="karsten.schnitter" created="Mon, 22 Jun 2020 07:01:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;The application has been running in different version for quite some time. Since it consumes the Kafka dependencies via Spring, I am very confident, that it never ran in any 2.4.x version. It started with earlier versions though. I try to get the offending message, but this is not an easy endeavour so far. I am not sure what topic to look at: Do I need to investigate the suppress topics or the original store changelog? Or can this stem from even other topics? How can I identify the message within the topic? And lastly once identified, how can I get the bytes? Soo far I am using the Kafka-console-consumer.sh for these kinds of investigations. But as far as I know this is not well suited to extract the bytes, right?&lt;/p&gt;</comment>
                            <comment id="17141983" author="karsten.schnitter" created="Mon, 22 Jun 2020 12:20:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;after trying for the whole weekend, I finally found a solution to provide the messages. My approach is to change &lt;tt&gt;org.apache.kafka.streams.state.internals.BufferValue&lt;/tt&gt; in a way to log during deserialisation:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BufferValue {
        &lt;span class=&quot;code-comment&quot;&gt;// omitted
&lt;/span&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger LOG = LoggerFactory.getLogger(BufferValue.class);

	&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; BufferValue deserialize(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBuffer buffer) {
		&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ProcessorRecordContext context = ProcessorRecordContext.deserialize(buffer);

		LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Deserialize with context &amp;lt;{}&amp;gt;&quot;&lt;/span&gt;, context);

		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] priorValue = extractValue(buffer);

			&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] oldValue;
			&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; oldValueLength = buffer.getInt();
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldValueLength == NULL_VALUE_SENTINEL) {
				oldValue = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldValueLength == OLD_PREV_DUPLICATE_VALUE_SENTINEL) {
				oldValue = priorValue;
			} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
				oldValue = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[oldValueLength];
				buffer.get(oldValue);
			}

			&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] newValue = extractValue(buffer);

			&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferValue(priorValue, oldValue, newValue, context);
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (BufferUnderflowException underflow) {
			LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error deserializing buffer &amp;lt;{}&amp;gt;&quot;&lt;/span&gt;, bytesToHex(buffer.array()));
			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; underflow;
		}
	}

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] HEX_ARRAY = &lt;span class=&quot;code-quote&quot;&gt;&quot;0123456789ABCDEF&quot;&lt;/span&gt;.toCharArray();

	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; bytesToHex(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes) {
		&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] hexChars = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[bytes.length * 2];
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; bytes.length; j++) {
			&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; v = bytes[j] &amp;amp; 0xFF;
			hexChars[j * 2] = HEX_ARRAY[v &amp;gt;&amp;gt;&amp;gt; 4];
			hexChars[j * 2 + 1] = HEX_ARRAY[v &amp;amp; 0x0F];
		}
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(hexChars);
	}

        &lt;span class=&quot;code-comment&quot;&gt;// omitted
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result of this is somewhat confusing to me:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG.   Deserialize with context &amp;lt;ProcessorRecordContext{topic=&apos;logs-ingress&apos;, partition=57, offset=0, timestamp=1592648746703, headers=RecordHeaders(headers = [], isReadOnly = false)}&amp;gt;
ERROR.   Error deserializing buffer &amp;lt;00000172D14346CF00000000000000000000000C6C6F67732D696E6772657373000000390000000000000059FFFFFFFF00000051080110AC051A2436346139616437662D313838352D346234342D613163302D633134346565633162636665222436346139616437662D313838352D346234342D613163302D633134346565633162636665FFFFFFFF00000172D14346CF&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
	&lt;li&gt;The DEBUG log of the context tells me, that a message from my main topic was read. I would have expected a message from a store changelog. I guess the context is misleading here?&lt;/li&gt;
	&lt;li&gt;The ERROR log has a rather short message, that fits much better to a store changelog. As a background: This is most likely a protobuf message containing two uuids encoded as strings together with some integer or long numbers.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The system I used was freshly created on Saturday, June 20th. It is running a Kafka Cluster on version 2.4.1 and the Kafka Streams application in version 2.3.1. The error was recorded with the same Kafka Streams application ugraded to v2.5.0 with the modification from above. Since there are two stream threads, I can provide another buffer that fails:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR.   Error deserializing buffer &amp;lt;00000172D1434655000000000000006F0000000C6C6F67732D696E6772657373000000180000000000000059FFFFFFFF00000051080110AC051A2436346139616437662D313838352D346234342D613163302D633134346565633162636665222436346139616437662D313838352D346234342D613163302D633134346565633162636665FFFFFFFF00000172D1434655&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
Karsten&lt;/p&gt;</comment>
                            <comment id="17142460" author="vvcephei" created="Mon, 22 Jun 2020 22:36:31 +0000"  >&lt;p&gt;Wow, thanks for that great information, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;I was able to reproduce your exception with this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BufferValue {
...

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; str=&lt;span class=&quot;code-quote&quot;&gt;&quot;00000172D14346CF00000000000000000000000C6C6F67732D696E6772657373000000390000000000000059FFFFFFFF00000051080110AC051A2436346139616437662D313838352D346234342D613163302D633134346565633162636665222436346139616437662D313838352D346234342D613163302D633134346565633162636665FFFFFFFF00000172D14346CF&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] arr = hexStringToByteArray(str);

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BufferValue deserialize = deserialize(ByteBuffer.wrap(arr));
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(deserialize);
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] hexStringToByteArray(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s) {
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; len = s.length();
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] data = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[len / 2];
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; len; i += 2) {
        data[i / 2] = (&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) ((&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.digit(s.charAt(i), 16) &amp;lt;&amp;lt; 4)
            + &lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.digit(s.charAt(i+1), 16));
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; data;
}

...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also see the context deserialized as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ProcessorRecordContext{topic=&lt;span class=&quot;code-quote&quot;&gt;&apos;logs-ingress&apos;&lt;/span&gt;, partition=57, offset=0, timestamp=1592648746703, headers=RecordHeaders(headers = [], isReadOnly = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note, this is not the record context of the suppression changelog, it&apos;s the context of the input record that got suppressed.&lt;/p&gt;

&lt;p&gt;Incidentally, the context I get for that second record is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ProcessorRecordContext{topic=&lt;span class=&quot;code-quote&quot;&gt;&apos;logs-ingress&apos;&lt;/span&gt;, partition=24, offset=111, timestamp=1592648746581, headers=RecordHeaders(headers = [], isReadOnly = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One hypothesis I was hoping to verify was that we are in fact correctly attempting to deserialize a &quot;version 2&quot; record, not another record we&apos;re erroneously interpreting as &quot;version 2&quot;. It looks like this is the case, otherwise it seems like we&apos;d be unlikely to get a valid-looking ProcessorRecordContext. Still, maybe you can confirm that your topic &quot;logs-ingress&quot; really has a partition 57, and that the record at offset 0 has timestamp 1592648746703? And also, I guess, that it doesn&apos;t have any headers?&lt;/p&gt;

&lt;p&gt;At least, that looks like a plausible timestamp:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jshell&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(1592648746703L)
$1 ==&amp;gt; Sat Jun 20 05:25:46 CDT 2020

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Just looking at what is getting unpacked from this buffer (which ultimately results in that exception):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the context above&lt;/li&gt;
	&lt;li&gt;a &quot;prior value&quot; for this key (a byte array of length 89) of (hex): &quot;FFFFFFFF00000051080110AC051A2436346139616437662D313838352D346234342D613163302D633134346565633162636665222436346139616437662D313838352D346234342D613163302D633134346565633162636665&quot;
	&lt;ul&gt;
		&lt;li&gt;Surprisingly, the &quot;prior value&quot; for the other record you gave me is exactly the same! It comes from a different partition of logs-ingress, though, so I don&apos;t think it could be the same record.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;a null &quot;old value&quot;&lt;/li&gt;
	&lt;li&gt;When we come to extract the &quot;new value&quot; part, we read the length of the new value as 370, but at this point, we&apos;re at position 141 in the buffer, which is only 145 bytes long, so we get the underflow because we try to read 370 bytes, but there are only 4 bytes remaining.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Unfortunately, I still don&apos;t have any good answers at this point.&lt;/p&gt;

&lt;p&gt;I think it&apos;s suspicious that we are reading a record that is apparently from offset zero of its topic partition, yet it has a &quot;prior value&quot;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt;, I&apos;m sorry to put this back on you, but can you try to:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Verify that the context we got above looks legitimate? If not, it&apos;ll help narrow down where my serializer went wrong.&lt;/li&gt;
	&lt;li&gt;If you&apos;re able, perhaps you can take a look at the input records from the partition and offset that we see encoded here to see if it has the same key as the record we&apos;re trying to restore from the suppression changelog?&lt;/li&gt;
	&lt;li&gt;In addition to the information you&apos;ve captured so far, can you also try to dump out the whole record we&apos;re restoring in `restoreBatch`? That one will let me look at the metadata for the changelog entry itself, not just the record we suppressed.&lt;/li&gt;
	&lt;li&gt;I&apos;m really sorry to do this to you, but perhaps you can add some more debugging to the ByteBuffer#serialize path as well, so that we can see what actually went in when we wrote these records?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m still a little mystified about how we even wind up in this position... We&apos;re deserializing a version 2 changelog record, which must have been written by the &lt;em&gt;upgraded&lt;/em&gt; application, since version 2 was introduced in 2.4.0. But if all you&apos;re doing to repro this is run the app with 2.3.1 and then restarting with version 2.5.0, it shouldn&apos;t even be possible to get a version 2 record in the restore path.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep trying to figure it out, but any further assistance you can provide is greatly appreciated. Thanks (and sorry).&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="17143066" author="karsten.schnitter" created="Tue, 23 Jun 2020 15:59:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;the original message is lost due to retention. I will implement the additional logging and start from a clean slate once again. Today, the system was unavailable to me, but I hope to get to more testing tomorrow or the day after. If you have any further suggestions, were I can add logging statements to extract information, please let me know. So far I can verify, that the context looks legitimate. There are actually 60 partitions, so 57 is fine. Can the equal priors be explained by very similar data in both partitions? It is not unlikely, that both partitions may have been aggregated to very similar data.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
Karsten&lt;/p&gt;</comment>
                            <comment id="17143075" author="vvcephei" created="Tue, 23 Jun 2020 16:15:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thanks for your efforts. I&apos;m also adding some additional system tests specifically for suppression in combination with an upgrade from 2.3.1 to 2.5.0.&lt;/p&gt;

&lt;p&gt;Thanks for the confirmation about the context. I think logging both the serialization and deserialization path should provide a lot of clarity for now. The stacktrace above implies the record was written by the 2.5.0 application, so it will be interesting to see if it really prints out your serialization log messages.&lt;/p&gt;

&lt;p&gt;I&apos;ll also add some &quot;trace&quot; level log messages to suppression in AK to help in future debugging efforts.&lt;/p&gt;

&lt;p&gt;If you&apos;re able, I guess this should be sufficient for now:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Log the who record during restore&lt;/li&gt;
	&lt;li&gt;Log the data in InMemoryTimeOrderedKeyValueBuffer#logValue, both the Key and BufferValue before serialization and the byte array that we return from BufferValue#serialize&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In response to your last question, certainly! You&apos;d know best what data this application is producing. If the value for two different records could be exactly the same, then the identical priorValue may be expected.&lt;/p&gt;

&lt;p&gt;What doesn&apos;t seem expected to me is that there would be a priorValue at all for the record that was at offset zero of the input. It makes me wonder if the application state is corrupted somehow, but I can&apos;t wrap my head around &lt;em&gt;how&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll let you know how my testing efforts progress today.&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="17143917" author="vvcephei" created="Wed, 24 Jun 2020 15:13:28 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I have &quot;good&quot; news! I managed to reproduce this exception in a system test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.nio.BufferUnderflowException
	at java.nio.HeapByteBuffer.get(HeapByteBuffer.java:151)
	at java.nio.ByteBuffer.get(ByteBuffer.java:715)
	at org.apache.kafka.streams.state.internals.BufferValue.extractValue(BufferValue.java:94)
	at org.apache.kafka.streams.state.internals.BufferValue.deserialize(BufferValue.java:83)
	at org.apache.kafka.streams.state.internals.InMemoryTimeOrderedKeyValueBuffer.restoreBatch(InMemoryTimeOrderedKeyValueBuffer.java:368)
	at org.apache.kafka.streams.processor.internals.CompositeRestoreListener.restoreBatch(CompositeRestoreListener.java:89)
	at org.apache.kafka.streams.processor.internals.StateRestorer.restore(StateRestorer.java:92)
	at org.apache.kafka.streams.processor.internals.StoreChangelogReader.processNext(StoreChangelogReader.java:350)
	at org.apache.kafka.streams.processor.internals.StoreChangelogReader.restore(StoreChangelogReader.java:94)
	at org.apache.kafka.streams.processor.internals.TaskManager.updateNewAndRestoringTasks(TaskManager.java:401)
	at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:779)
	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:697)
	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:670)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I know it&apos;s a pain for you to debug on your end. Please feel free to continue if you like to, but I should be able to make progress by iterating on the test for now. I&apos;ll let you know what I learn.&lt;/p&gt;

&lt;p&gt;Thanks so much for your help,&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="17143956" author="karsten.schnitter" created="Wed, 24 Jun 2020 15:46:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;That is great news. Actually, I had some problems with my setup and could not do further testing today.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
Karsten&lt;/p&gt;</comment>
                            <comment id="17144485" author="vvcephei" created="Wed, 24 Jun 2020 23:21:35 +0000"  >&lt;p&gt;Ok, I&apos;m horrified and embarrassed to report that I know what the problem is, as well as the solution. I&apos;ll update my PR tomorrow, and I&apos;ll re-escalate this ticket to a blocker for 2.5.1 and 2.6.0.&lt;/p&gt;

&lt;p&gt;In a nutshell, although we have a version number on these changelog records so that we can deserialize old formats, I subtly changed the serialization format in 2.4.0 without updating the version number, so although the serialization format is incompatible between 2.3.1 and 2.5.0, they both claim to be at &quot;version 2&quot; (I was mistaken about this before).&lt;/p&gt;

&lt;p&gt;This mistake happens to also render the serialization compatibility test I had written to be ineffectual.&lt;/p&gt;

&lt;p&gt;And I&apos;ve also just discovered that our system test that covers application upgrades had suffered an oversight that made it skip these versions.&lt;/p&gt;

&lt;p&gt;Needless to say, in addition to fixing this bug, I&apos;m fixing the serialization test to avoid using the same code paths as the application, and I&apos;m also revamping the upgrade system test to be sure we&apos;ll have a much more robust test going forward.&lt;/p&gt;

&lt;p&gt;Although this bug was introduced in 2.4.0, I&apos;d still classify it as a blocker, since it&apos;s so severe (you simply can&apos;t upgrade the application until we fix it).&lt;/p&gt;

&lt;p&gt;Thanks for the excellently detailed report, and, again, my sincere apologies,&lt;/p&gt;

&lt;p&gt;-John&lt;/p&gt;</comment>
                            <comment id="17144573" author="bchen225242" created="Thu, 25 Jun 2020 01:17:44 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhauch&quot; class=&quot;user-hover&quot; rel=&quot;rhauch&quot;&gt;rhauch&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17144771" author="karsten.schnitter" created="Thu, 25 Jun 2020 09:06:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I am really glad to hear, that you found the problem and the solution. No need to feel embarrassed though. I really appreciate all the hard work, that goes into this project. Keep it up.&lt;/p&gt;

&lt;p&gt;One more background information: I consume the Kafka Streams dependency transitively through Spring Boot. Spring skipped the 2.4.x releases and went directly from 2.3.1 to 2.5.0. So I would expect, that more people will have this kind of migration.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
Karsten&lt;/p&gt;</comment>
                            <comment id="17145112" author="vvcephei" created="Thu, 25 Jun 2020 17:07:47 +0000"  >&lt;p&gt;Thanks for that information, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=karsten.schnitter&quot; class=&quot;user-hover&quot; rel=&quot;karsten.schnitter&quot;&gt;karsten.schnitter&lt;/a&gt; . It really reinforces the importance of blocking the 2.5.1 bugfix release in particular.&lt;/p&gt;</comment>
                            <comment id="17146749" author="vvcephei" created="Sat, 27 Jun 2020 02:52:42 +0000"  >&lt;p&gt;Ok, I&apos;ve just merged the fix (&lt;a href=&quot;https://github.com/apache/kafka/pull/8905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8905&lt;/a&gt; ), and I&apos;m backporting it now.&lt;/p&gt;

&lt;p&gt;To control the scope of the change, I&apos;ve separated the upgrade system tests out for a second PR, which I&apos;ll submit next week. I did run them locally, and they pass after #8905, so I have confidence the bug is really fixed.&lt;/p&gt;</comment>
                            <comment id="17146758" author="vvcephei" created="Sat, 27 Jun 2020 03:41:44 +0000"  >&lt;p&gt;Ok, the fix is now backported all the way back to 2.4. I&apos;ll leave this ticket open until I get the system test PR in.&lt;/p&gt;</comment>
                            <comment id="17147049" author="vvcephei" created="Sat, 27 Jun 2020 18:30:58 +0000"  >&lt;p&gt;Here&apos;s the system test PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/8938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8938&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17152259" author="vvcephei" created="Mon, 6 Jul 2020 19:10:28 +0000"  >&lt;p&gt;Hey all, I&apos;m resolving this ticket to unblock the 2.6.0 release. I&apos;m still working on backporting the system test fixes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13320438">KAFKA-10336</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fwew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>