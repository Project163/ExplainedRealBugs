<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-916] Deadlock between fetcher shutdown and handling partitions with error</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-916</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Here is another consumer deadlock that we encountered. All consumers are&lt;br/&gt;
vulnerable to this during a rebalance if there happen to be partitions in&lt;br/&gt;
error.&lt;/p&gt;

&lt;p&gt;On a rebalance, the fetcher manager closes all fetchers and this holds on to&lt;br/&gt;
the fetcher thread map&apos;s lock. (mapLock in AbstractFetcherManager). &lt;span class=&quot;error&quot;&gt;&amp;#91;t1&amp;#93;&lt;/span&gt;&lt;br/&gt;
While the fetcher manager is iterating over fetchers to stop them, a fetcher&lt;br/&gt;
that is yet to be stopped hits an error on a partition and proceeds to&lt;br/&gt;
handle partitions with error &lt;span class=&quot;error&quot;&gt;&amp;#91;t2&amp;#93;&lt;/span&gt;. This handling involves looking up the&lt;br/&gt;
fetcher for that partition and then removing it from the fetcher&apos;s set of&lt;br/&gt;
partitions to consume. This requires grabbing the same map lock in &lt;span class=&quot;error&quot;&gt;&amp;#91;t1&amp;#93;&lt;/span&gt;,&lt;br/&gt;
hence the deadlock.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;t1&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-05-22_20:23:11.95767 &quot;main&quot; prio=10 tid=0x00007f1b24007800 nid=0x573b waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f1b2bd38000&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-05-22_20:23:11.95767    java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
2013-05-22_20:23:11.95767 	at sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
2013-05-22_20:23:11.95767 	- parking to wait for  &amp;lt;0x00007f1a25780598&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)&lt;br/&gt;
2013-05-22_20:23:11.95767 	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)&lt;br/&gt;
2013-05-22_20:23:11.95767 	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)&lt;br/&gt;
2013-05-22_20:23:11.95768 	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:969)&lt;br/&gt;
2013-05-22_20:23:11.95768 	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1281)&lt;br/&gt;
2013-05-22_20:23:11.95768 	at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:207)&lt;br/&gt;
2013-05-22_20:23:11.95768 	at kafka.utils.ShutdownableThread.shutdown(ShutdownableThread.scala:36)&lt;br/&gt;
2013-05-22_20:23:11.95769 	at kafka.server.AbstractFetcherThread.shutdown(AbstractFetcherThread.scala:68)&lt;br/&gt;
2013-05-22_20:23:11.95769 	at kafka.server.AbstractFetcherManager$$anonfun$closeAllFetchers$1.apply(AbstractFetcherManager.scala:79)&lt;br/&gt;
2013-05-22_20:23:11.95769 	at kafka.server.AbstractFetcherManager$$anonfun$closeAllFetchers$1.apply(AbstractFetcherManager.scala:78)&lt;br/&gt;
2013-05-22_20:23:11.95769 	at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:80)&lt;br/&gt;
2013-05-22_20:23:11.95769 	at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:80)&lt;br/&gt;
2013-05-22_20:23:11.95770 	at scala.collection.Iterator$class.foreach(Iterator.scala:631)&lt;br/&gt;
2013-05-22_20:23:11.95770 	at scala.collection.mutable.HashTable$$anon$1.foreach(HashTable.scala:161)&lt;br/&gt;
2013-05-22_20:23:11.95770 	at scala.collection.mutable.HashTable$class.foreachEntry(HashTable.scala:194)&lt;br/&gt;
2013-05-22_20:23:11.95770 	at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:39)&lt;br/&gt;
2013-05-22_20:23:11.95771 	at scala.collection.mutable.HashMap.foreach(HashMap.scala:80)&lt;br/&gt;
2013-05-22_20:23:11.95771 	at kafka.server.AbstractFetcherManager.closeAllFetchers(AbstractFetcherManager.scala:78)&lt;br/&gt;
---&amp;gt; 2013-05-22_20:23:11.95771 	- locked &amp;lt;0x00007f1a2ae92510&amp;gt; (a java.lang.Object)&lt;br/&gt;
2013-05-22_20:23:11.95771 	at kafka.consumer.ConsumerFetcherManager.stopConnections(ConsumerFetcherManager.scala:156)&lt;br/&gt;
2013-05-22_20:23:11.95771 	at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.kafka$consumer$ZookeeperConsumerConnector$ZKRebalancerListener$$closeFetchersForQueues(ZookeeperConsumerConnector.scala:488)&lt;br/&gt;
2013-05-22_20:23:11.95772 	at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.closeFetchers(ZookeeperConsumerConnector.scala:525)&lt;br/&gt;
2013-05-22_20:23:11.95772 	at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.kafka$consumer$ZookeeperConsumerConnector$ZKRebalancerListener$$rebalance(ZookeeperConsumerConnector.scala:422)&lt;br/&gt;
2013-05-22_20:23:11.95772 	at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener$$anonfun$syncedRebalance$1.apply$mcVI$sp(ZookeeperConsumerConnector.scala:374)&lt;br/&gt;
2013-05-22_20:23:11.95772 	at scala.collection.immutable.Range$ByOne$class.foreach$mVc$sp(Range.scala:282)&lt;br/&gt;
2013-05-22_20:23:11.95773 	at scala.collection.immutable.Range$$anon$2.foreach$mVc$sp(Range.scala:265)&lt;br/&gt;
2013-05-22_20:23:11.95773 	at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.syncedRebalance(ZookeeperConsumerConnector.scala:369)&lt;br/&gt;
2013-05-22_20:23:11.95773 	- locked &amp;lt;0x00007f1a2a29b450&amp;gt; (a java.lang.Object)&lt;br/&gt;
2013-05-22_20:23:11.95773 	at kafka.consumer.ZookeeperConsumerConnector.kafka$consumer$ZookeeperConsumerConnector$$reinitializeConsumer(ZookeeperConsumerConnector.scala:680)&lt;br/&gt;
2013-05-22_20:23:11.95774 	at kafka.consumer.ZookeeperConsumerConnector$WildcardStreamsHandler.handleTopicEvent(ZookeeperConsumerConnector.scala:754)&lt;br/&gt;
2013-05-22_20:23:11.95774 	at kafka.consumer.ZookeeperTopicEventWatcher$ZkTopicEventListener.liftedTree1$1(ZookeeperTopicEventWatcher.scala:74)&lt;br/&gt;
2013-05-22_20:23:11.95774 	at kafka.consumer.ZookeeperTopicEventWatcher$ZkTopicEventListener.handleChildChange(ZookeeperTopicEventWatcher.scala:69)&lt;br/&gt;
2013-05-22_20:23:11.95774 	- locked &amp;lt;0x00007f1a2a69b1d8&amp;gt; (a java.lang.Object)&lt;br/&gt;
2013-05-22_20:23:11.95774 	at kafka.consumer.ZookeeperTopicEventWatcher.startWatchingTopicEvents(ZookeeperTopicEventWatcher.scala:46)&lt;br/&gt;
2013-05-22_20:23:11.95775 	at kafka.consumer.ZookeeperTopicEventWatcher.&amp;lt;init&amp;gt;(ZookeeperTopicEventWatcher.scala:33)&lt;br/&gt;
2013-05-22_20:23:11.95775 	at kafka.consumer.ZookeeperConsumerConnector$WildcardStreamsHandler.&amp;lt;init&amp;gt;(ZookeeperConsumerConnector.scala:721)&lt;br/&gt;
2013-05-22_20:23:11.95775 	at kafka.consumer.ZookeeperConsumerConnector.createMessageStreamsByFilter(ZookeeperConsumerConnector.scala:140)&lt;br/&gt;
2013-05-22_20:23:11.95776 	at kafka.tools.MirrorMaker$$anonfun$main$3.apply(MirrorMaker.scala:118)&lt;br/&gt;
2013-05-22_20:23:11.95776 	at kafka.tools.MirrorMaker$$anonfun$main$3.apply(MirrorMaker.scala:118)&lt;br/&gt;
2013-05-22_20:23:11.95776 	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
2013-05-22_20:23:11.95776 	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
2013-05-22_20:23:11.95776 	at scala.collection.LinearSeqOptimized$class.foreach(LinearSeqOptimized.scala:61)&lt;br/&gt;
2013-05-22_20:23:11.95777 	at scala.collection.immutable.List.foreach(List.scala:45)&lt;br/&gt;
2013-05-22_20:23:11.95777 	at scala.collection.TraversableLike$class.map(TraversableLike.scala:206)&lt;br/&gt;
2013-05-22_20:23:11.95777 	at scala.collection.immutable.List.map(List.scala:45)&lt;br/&gt;
2013-05-22_20:23:11.95777 	at kafka.tools.MirrorMaker$.main(MirrorMaker.scala:118)&lt;br/&gt;
2013-05-22_20:23:11.95777 	at kafka.tools.MirrorMaker.main(MirrorMaker.scala)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;t2&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;2013-05-22_20:23:11.87465 &quot;ConsumerFetcherThread-xxxx-1369238724254-cff180ff-0-505&quot; prio=10 tid=0x00007f196401a800 nid=0x717a waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f19bf0ef000&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-05-22_20:23:11.87466    java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
2013-05-22_20:23:11.87467 	at kafka.server.AbstractFetcherManager.removeFetcher(AbstractFetcherManager.scala:57)&lt;br/&gt;
---&amp;gt; 2013-05-22_20:23:11.87467 	- waiting to lock &amp;lt;0x00007f1a2ae92510&amp;gt; (a java.lang.Object)&lt;br/&gt;
2013-05-22_20:23:11.87468 	at kafka.consumer.ConsumerFetcherManager$$anonfun$addPartitionsWithError$2.apply(ConsumerFetcherManager.scala:170)&lt;br/&gt;
2013-05-22_20:23:11.95682 	at kafka.consumer.ConsumerFetcherManager$$anonfun$addPartitionsWithError$2.apply(ConsumerFetcherManager.scala:170)&lt;br/&gt;
2013-05-22_20:23:11.95683 	at scala.collection.mutable.HashSet.foreach(HashSet.scala:61)&lt;br/&gt;
2013-05-22_20:23:11.95684 	at kafka.consumer.ConsumerFetcherManager.addPartitionsWithError(ConsumerFetcherManager.scala:170)&lt;br/&gt;
2013-05-22_20:23:11.95684 	at kafka.consumer.ConsumerFetcherThread.handlePartitionsWithErrors(ConsumerFetcherThread.scala:69)&lt;br/&gt;
2013-05-22_20:23:11.95684 	at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:168)&lt;br/&gt;
2013-05-22_20:23:11.95684 	at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:88)&lt;br/&gt;
2013-05-22_20:23:11.95684 	at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:51)&lt;br/&gt;
2013-05-22_20:23:11.95686 &lt;br/&gt;
2013-05-22_20:23:11.95686 &quot;main-EventThread&quot; daemon prio=10 tid=0x00007f1b2471d000 nid=0x605a waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f19bedec000&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-05-22_20:23:11.95686    java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
2013-05-22_20:23:11.95686 	at sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
2013-05-22_20:23:11.95686 	- parking to wait for  &amp;lt;0x00007f1a2a4426f8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
2013-05-22_20:23:11.95687 	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)&lt;br/&gt;
2013-05-22_20:23:11.95687 	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1987)&lt;br/&gt;
2013-05-22_20:23:11.95687 	at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)&lt;br/&gt;
2013-05-22_20:23:11.95687 	at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:503)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12648995">KAFKA-916</key>
            <summary>Deadlock between fetcher shutdown and handling partitions with error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 May 2013 23:23:21 +0000</created>
                <updated>Tue, 28 May 2013 16:56:17 +0000</updated>
                            <resolved>Tue, 28 May 2013 16:55:56 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13665299" author="junrao" created="Thu, 23 May 2013 16:08:29 +0000"  >&lt;p&gt;Thanks for finding this. The deadlock is introduced because AbstractFetcherManager.removeFetcher() can be called from AbstractFetcherThread and AbstractFetcherManager.closeAllFetchers can wait for AbstractFetcherThread to stop. This is only happening for the ConsumerFetcherThread. So, one possible fix is to remove the error partitions from the fetcher directly in ConsumerFetcherThread.handlePartitionsWithErrors(), instead of going through ConsumerFetcherManager. This will break the cycle.&lt;/p&gt;</comment>
                            <comment id="13666848" author="jjkoshy" created="Sat, 25 May 2013 00:09:55 +0000"  >&lt;p&gt;Agreed - I think that should fix the issue.&lt;/p&gt;</comment>
                            <comment id="13666973" author="junrao" created="Sat, 25 May 2013 05:13:46 +0000"  >&lt;p&gt;Thanks for the patch. +1.&lt;/p&gt;</comment>
                            <comment id="13668443" author="jjkoshy" created="Tue, 28 May 2013 16:56:17 +0000"  >&lt;p&gt;Thanks for the review. Committed to 0.8&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12584794" name="KAFKA-916-v1.patch" size="1271" author="jjkoshy" created="Sat, 25 May 2013 00:09:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>329324</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ktfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>329659</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>