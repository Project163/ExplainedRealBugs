<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:43:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2235] LogCleaner offset map overflow</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2235</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We&apos;ve seen log cleaning generating an error for a topic with lots of small messages. It seems that cleanup map overflow is possible if a log segment contains more unique keys than empty slots in offsetMap. Check for baseOffset and map utilization before processing segment seems to be not enough because it doesn&apos;t take into account segment size (number of unique messages in the segment).&lt;/p&gt;

&lt;p&gt;I suggest to estimate upper bound of keys in a segment as a number of messages in the segment and compare it with the number of available slots in the map (keeping in mind desired load factor). It should work in cases where an empty map is capable to hold all the keys for a single segment. If even a single segment no able to fit into an empty map cleanup process will still fail. Probably there should be a limit on the log segment entries count?&lt;/p&gt;

&lt;p&gt;Here is the stack trace for this error:&lt;br/&gt;
2015-05-19 16:52:48,758 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt; kafka.log.LogCleaner - &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-log-cleaner-thread-0&amp;#93;&lt;/span&gt;, Error due to&lt;br/&gt;
java.lang.IllegalArgumentException: requirement failed: Attempt to add a new entry to a full offset map.&lt;br/&gt;
       at scala.Predef$.require(Predef.scala:233)&lt;br/&gt;
       at kafka.log.SkimpyOffsetMap.put(OffsetMap.scala:79)&lt;br/&gt;
       at kafka.log.Cleaner$$anonfun$kafka$log$Cleaner$$buildOffsetMapForSegment$1.apply(LogCleaner.scala:543)&lt;br/&gt;
       at kafka.log.Cleaner$$anonfun$kafka$log$Cleaner$$buildOffsetMapForSegment$1.apply(LogCleaner.scala:538)&lt;br/&gt;
       at scala.collection.Iterator$class.foreach(Iterator.scala:727)&lt;br/&gt;
       at kafka.utils.IteratorTemplate.foreach(IteratorTemplate.scala:32)&lt;br/&gt;
       at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)&lt;br/&gt;
       at kafka.message.MessageSet.foreach(MessageSet.scala:67)&lt;br/&gt;
       at kafka.log.Cleaner.kafka$log$Cleaner$$buildOffsetMapForSegment(LogCleaner.scala:538)&lt;br/&gt;
       at kafka.log.Cleaner$$anonfun$buildOffsetMap$3.apply(LogCleaner.scala:515)&lt;br/&gt;
       at kafka.log.Cleaner$$anonfun$buildOffsetMap$3.apply(LogCleaner.scala:512)&lt;br/&gt;
       at scala.collection.immutable.Stream.foreach(Stream.scala:547)&lt;br/&gt;
       at kafka.log.Cleaner.buildOffsetMap(LogCleaner.scala:512)&lt;br/&gt;
       at kafka.log.Cleaner.clean(LogCleaner.scala:307)&lt;br/&gt;
       at kafka.log.LogCleaner$CleanerThread.cleanOrSleep(LogCleaner.scala:221)&lt;br/&gt;
       at kafka.log.LogCleaner$CleanerThread.doWork(LogCleaner.scala:199)&lt;br/&gt;
       at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:60)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12834338">KAFKA-2235</key>
            <summary>LogCleaner offset map overflow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ivan.simonenko">Ivan Simoneko</assignee>
                                    <reporter username="ivan.simonenko">Ivan Simoneko</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Jun 2015 19:04:13 +0000</created>
                <updated>Tue, 3 May 2016 21:05:35 +0000</updated>
                            <resolved>Mon, 22 Jun 2015 16:21:28 +0000</resolved>
                                    <version>0.8.1</version>
                    <version>0.8.2.0</version>
                                    <fixVersion>0.9.0.0</fixVersion>
                                    <component>core</component>
                    <component>log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14589003" author="junrao" created="Tue, 16 Jun 2015 23:27:53 +0000"  >&lt;p&gt;Thanks for the patch. Nice catch! A couple of comments below.&lt;/p&gt;

&lt;p&gt;1. When there are not enough slots to build a map for a single segment, it would be useful to suggest the action In the message string for require(). Sth like &quot;please increase log.cleaner.dedupe.buffer.size&quot;.&lt;br/&gt;
2. Our current coding convention is to not include {} for single line statement under if/else. &lt;/p&gt;</comment>
                            <comment id="14595798" author="ivan.simonenko" created="Mon, 22 Jun 2015 11:28:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; thank you for review. Please check the patch v2. I think in most cases mentioning log.cleaner.dedupe.buffer.size should be enough, but as log.cleaner.threads is also used in determining map size I&apos;ve added both of them. If someone increases threads num and start getting this message he can easily understand cause of the problem&lt;/p&gt;</comment>
                            <comment id="14596162" author="junrao" created="Mon, 22 Jun 2015 16:21:28 +0000"  >&lt;p&gt;Thanks for patch v2. +1. Committed to trunk after changing the following statement from testing &amp;lt; to &amp;lt;=.&lt;/p&gt;

&lt;p&gt;      if (map.size + segmentSize &amp;lt;= maxDesiredMapSize)&lt;/p&gt;</comment>
                            <comment id="14971728" author="jjkoshy" created="Fri, 23 Oct 2015 19:51:40 +0000"  >&lt;p&gt;While I think the change is well-motivated I&apos;m not sure this is the right fix for this issue as the check is too conservative. i.e., especially with highly compressible messages the message-count in the segment may be extremely high but the unique-key-count may be low.&lt;/p&gt;</comment>
                            <comment id="14971740" author="toddpalino" created="Fri, 23 Oct 2015 20:00:31 +0000"  >&lt;p&gt;I&apos;m sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; will follow along with more detail on this, but we&apos;ve run into a serious problem with this check. Basically, it&apos;s impossible to perform this kind of check accurately before the offset map is built. We now have partitions that should be able to be compacted as the total number of unique keys is far below the size of the offset map (currently at ~39 million for our configuration) but the messages are very frequent and very small. Even at a segment size of 64 MB, we have over 300 million messages in those segments. So this check creates a situation where log compaction should succeed, but fails because of a speculative check.&lt;/p&gt;

&lt;p&gt;While I can play the game of trying to walk back segment sizes, there&apos;s no way to size segments by number of messages, so it&apos;s a guessing game. In addition, the check is clearly wrong in that case, so I shouldn&apos;t have to config around it. Lastly, the check causes the log cleaner thread to exit, which means log compaction on the broker fails entirely, rather than just skipping that partition.&lt;/p&gt;

&lt;p&gt;A better way to handle this would be to cleanly catch the original error you are seeing, generate a clear error message in the logs as to what the failure is, and allow the log cleaner to continue and handle other partitions. You could also maintain a blacklist of partitions in memory in the log cleaner to make sure you don&apos;t come back around and try and compact the partition again.&lt;/p&gt;</comment>
                            <comment id="14971804" author="junrao" created="Fri, 23 Oct 2015 20:38:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=toddpalino&quot; class=&quot;user-hover&quot; rel=&quot;toddpalino&quot;&gt;toddpalino&lt;/a&gt;, thanks for reporting this issue. I agree that it&apos;s better to log an error and then continue. For your use case, it seems that you can just increase log.cleaner.dedupe.buffer.size.&lt;/p&gt;</comment>
                            <comment id="14971806" author="toddpalino" created="Fri, 23 Oct 2015 20:40:28 +0000"  >&lt;p&gt;I don&apos;t think we can. I have already increased it from 512MB to 1GB, and we still hit the same problems. That only provides a 2x increase in the size of the map, and I would need almost a 10x increase to solve the problem.&lt;/p&gt;</comment>
                            <comment id="14971848" author="ivan.simonenko" created="Fri, 23 Oct 2015 21:08:11 +0000"  >&lt;p&gt;The core problem is that offset map is limited by number of messages while segment is limited by size in bytes and this patch doesn&apos;t fix it. But the way it handles the problem (just throws exception end stops compacting) is consistent with other errors in compactor.&lt;/p&gt;</comment>
                            <comment id="14974502" author="jjkoshy" created="Mon, 26 Oct 2015 16:28:09 +0000"  >&lt;p&gt;Agreed with Todd - this is very similar to the proposal in btw, &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1755?focusedCommentId=14216486&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-1755?focusedCommentId=14216486&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14974667" author="junrao" created="Mon, 26 Oct 2015 17:56:18 +0000"  >&lt;p&gt;One way to get around your problem now is to set log.cleaner.io.buffer.load.factor to a larger value. Currently, it doesn&apos;t seem that we check the range of the value. So you can set it to a value larger than 1.0, which will allow you to build a bigger offset map with the same buffer size.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12960070">KAFKA-3587</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12736626" name="KAFKA-2235_v1.patch" size="1814" author="ivan.simonenko" created="Mon, 1 Jun 2015 19:08:01 +0000"/>
                            <attachment id="12741012" name="KAFKA-2235_v2.patch" size="1902" author="ivan.simonenko" created="Mon, 22 Jun 2015 11:15:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fh0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>