<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:38:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16639] AsyncKafkaConsumer#close does not send heartbeat to leave group</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16639</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This bug can be reproduced by immediately closing a consumer which is just created.&lt;/p&gt;

&lt;p&gt;The root cause is that we skip the new heartbeat used to leave group when there is a in-flight heartbeat request (&lt;a href=&quot;https://github.com/apache/kafka/blob/5de5d967adffd864bad3ec729760a430253abf38/clients/src/main/java/org/apache/kafka/clients/consumer/internals/HeartbeatRequestManager.java#L212).&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5de5d967adffd864bad3ec729760a430253abf38/clients/src/main/java/org/apache/kafka/clients/consumer/internals/HeartbeatRequestManager.java#L212).&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It seems to me the simple solution is that we create a heartbeat request when meeting above situation and then send it by pollOnClose (&lt;a href=&quot;https://github.com/apache/kafka/blob/5de5d967adffd864bad3ec729760a430253abf38/clients/src/main/java/org/apache/kafka/clients/consumer/internals/RequestManager.java#L62).&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/5de5d967adffd864bad3ec729760a430253abf38/clients/src/main/java/org/apache/kafka/clients/consumer/internals/RequestManager.java#L62).&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13577493">KAFKA-16639</key>
            <summary>AsyncKafkaConsumer#close does not send heartbeat to leave group</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="chia7712">Chia-Ping Tsai</reporter>
                        <labels>
                            <label>kip-848-client-support</label>
                    </labels>
                <created>Sun, 28 Apr 2024 17:09:04 +0000</created>
                <updated>Fri, 31 May 2024 20:23:41 +0000</updated>
                            <resolved>Fri, 31 May 2024 20:14:31 +0000</resolved>
                                                    <fixVersion>3.8.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17841675" author="chia7712" created="Sun, 28 Apr 2024 17:10:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt; Could you please take a look if you have free cycle? thanks!&lt;/p&gt;</comment>
                            <comment id="17841678" author="JIRAUSER283568" created="Sun, 28 Apr 2024 17:20:18 +0000"  >&lt;p&gt;thanks for reporting. will do.&lt;/p&gt;</comment>
                            <comment id="17842099" author="chia7712" created="Mon, 29 Apr 2024 16:52:20 +0000"  >&lt;p&gt;check the code again. It seems there are two possible bugs if we change the state to `LEAVING` before receiving the heartbeat response&lt;/p&gt;

&lt;p&gt;1. &lt;a href=&quot;https://github.com/apache/kafka/commit/8c0488b887be4a9178563f1d72514010f83b8614&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/8c0488b887be4a9178563f1d72514010f83b8614&lt;/a&gt; ignore the response and leave the member id be empty. That obstructs from leaving the group as server will reject the request (epoch=-1 and member is empty)&lt;/p&gt;

&lt;p&gt;2. &lt;a href=&quot;https://github.com/apache/kafka/blob/636e65aa6b3558a7ae239ce69579b62ab3377fcb/clients/src/main/java/org/apache/kafka/clients/consumer/internals/HeartbeatRequestManager.java#L212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/636e65aa6b3558a7ae239ce69579b62ab3377fcb/clients/src/main/java/org/apache/kafka/clients/consumer/internals/HeartbeatRequestManager.java#L212&lt;/a&gt; could ignore the request due to in-flight request.&lt;/p&gt;</comment>
                            <comment id="17842186" author="chia7712" created="Mon, 29 Apr 2024 23:52:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt; I just notice that you have took over this jira. Do you plan to offer a patch for it? If you have no free cycles, we can file a PR for it and then be waiting for your reviews &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17842187" author="JIRAUSER283568" created="Mon, 29 Apr 2024 23:55:02 +0000"  >&lt;p&gt;hey - sorry.&#160; I took this because I wasn&apos;t sure if you wanted me to look into it.&#160; Please go ahead assign it back.&#160; We would love to review it. Thanks. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17842192" author="chia7712" created="Tue, 30 Apr 2024 00:11:01 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I took this because I wasn&apos;t sure if you wanted me to look into it.  Please go ahead assign it back.  We would love to review it. Thanks. Chia-Ping Tsai &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry I just make sure there is someone who can have a fix for it, and won&apos;t have duplicate PR. Thanks for your response (and reviews in the future). We will prepare the patch ASAP.&lt;/p&gt;</comment>
                            <comment id="17850044" author="JIRAUSER300183" created="Tue, 28 May 2024 14:24:02 +0000"  >&lt;p&gt;I reassigned the task to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; who is the one working on this one (linked PR). Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt;! Follow-up comments on the PR.&#160;&lt;/p&gt;</comment>
                            <comment id="17850506" author="chia7712" created="Wed, 29 May 2024 21:34:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15305&quot; title=&quot;The background thread should try to process the remaining task until the shutdown timer is expired&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15305&quot;&gt;&lt;del&gt;KAFKA-15305&lt;/del&gt;&lt;/a&gt; is the necessary cure for this issue. Otherwise, the heartbeat request may not be sent in closing. &lt;/p&gt;

&lt;p&gt;In this ticket we focus on fixing the &quot;uncreated heartbeat request&quot;&lt;/p&gt;</comment>
                            <comment id="17850779" author="JIRAUSER300183" created="Thu, 30 May 2024 15:58:04 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chia7712&quot; class=&quot;user-hover&quot; rel=&quot;chia7712&quot;&gt;chia7712&lt;/a&gt; , totally agree. The PR in this ticket is ensuring the &quot;create request&quot; part: IF the HBManager is polled when the member wants to leave, it will create the leave request (no matter the in-flights). But we also need to make sure that the manager is actually polled (as you had suggested initially, but this PR ended up focusing on the create part as you said). Follow-up comments related to that on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15305&quot; title=&quot;The background thread should try to process the remaining task until the shutdown timer is expired&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-15305&quot;&gt;&lt;del&gt;KAFKA-15305&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17851197" author="chia7712" created="Fri, 31 May 2024 20:23:41 +0000"  >&lt;p&gt;I have shipped the PR into trunk and 3.8&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; thanks for all your contribution. nice fix!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                                                <inwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13546182">KAFKA-15305</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ox2g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>