<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:41:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-589] Clean shutdown after startup connection failure</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-589</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m embedding the kafka server (0.7.2) in an application container.   I&apos;ve noticed that if I try to start the server without zookeeper being available, by default it gets a zk connection timeout after 6 seconds, and then throws an Exception out of KafkaServer.startup()....E.g., I see this stack trace:&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; org.I0Itec.zkclient.exception.ZkTimeoutException: Unable to connect to zookeeper server within timeout: 6000&lt;br/&gt;
	at org.I0Itec.zkclient.ZkClient.connect(ZkClient.java:876)&lt;br/&gt;
	at org.I0Itec.zkclient.ZkClient.&amp;lt;init&amp;gt;(ZkClient.java:98)&lt;br/&gt;
	at org.I0Itec.zkclient.ZkClient.&amp;lt;init&amp;gt;(ZkClient.java:84)&lt;br/&gt;
	at kafka.server.KafkaZooKeeper.startup(KafkaZooKeeper.scala:44)&lt;br/&gt;
	at kafka.log.LogManager.&amp;lt;init&amp;gt;(LogManager.scala:93)&lt;br/&gt;
	at kafka.server.KafkaServer.startup(KafkaServer.scala:58)&lt;br/&gt;
        ....&lt;br/&gt;
        ....&lt;/p&gt;

&lt;p&gt;So that&apos;s ok, I can catch the exception, and then shut everything down gracefully, in this case.  However, when I do this, it seems there is a daemon thread still around, which doesn&apos;t quit, and so the server never actually exits the jvm.  Specifically, this thread seems to hang around:&lt;/p&gt;

&lt;p&gt;&quot;kafka-logcleaner-0&quot; prio=5 tid=7fd9b48b1000 nid=0x112c08000 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;112c07000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (parking)&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;7f40d4be8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2025)&lt;br/&gt;
	at java.util.concurrent.DelayQueue.take(DelayQueue.java:164)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:609)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:602)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:680)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Looking at the code in kafka.log.LogManager(), it does seem like it starts up the scheduler to clean logs, before then trying to connect to zk (and in this case fail):&lt;/p&gt;

&lt;p&gt;  /* Schedule the cleanup task to delete old logs */&lt;br/&gt;
  if(scheduler != null) &lt;/p&gt;
{
    info(&quot;starting log cleaner every &quot; + logCleanupIntervalMs + &quot; ms&quot;)    
    scheduler.scheduleWithRate(cleanupLogs, 60 * 1000, logCleanupIntervalMs)
  }

&lt;p&gt;So this scheduler does not appear to be stopped if startup fails.  However, if I catch the above RuntimeException, and then call KafkaServer.shutdown(), then it will stop the scheduler, and all is good.&lt;/p&gt;

&lt;p&gt;However, it seems odd that if I get an exception when calling KafkaServer.startup(), that I should still have to do a KafkaServer.shutdown().  Rather, wouldn&apos;t it be better to have it internally cleanup after itself if startup() gets an exception?  I&apos;m not sure I can reliably call shutdown() after a failed startup()....&lt;/p&gt;</description>
                <environment></environment>
        <key id="12613686">KAFKA-589</key>
            <summary>Clean shutdown after startup connection failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ewencp">Ewen Cheslack-Postava</assignee>
                                    <reporter username="jbrosenberg">Jason Rosenberg</reporter>
                        <labels>
                            <label>bugs</label>
                            <label>newbie</label>
                    </labels>
                <created>Fri, 26 Oct 2012 17:24:18 +0000</created>
                <updated>Fri, 26 Sep 2014 04:24:28 +0000</updated>
                            <resolved>Fri, 26 Sep 2014 04:23:45 +0000</resolved>
                                    <version>0.7.2</version>
                    <version>0.8.0</version>
                                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13485798" author="junrao" created="Mon, 29 Oct 2012 02:47:18 +0000"  >&lt;p&gt;This problem exists in 0.8 too. What we need to do is to add a try/catch in KafkaServer.start() and call shutdown if we hit any exceptions.&lt;/p&gt;</comment>
                            <comment id="13486378" author="swapnilghike" created="Mon, 29 Oct 2012 21:21:35 +0000"  >&lt;p&gt;Hi Jason, &lt;/p&gt;

&lt;p&gt;Are you using the KafkaServer.startup() or KafkaServerStartable.startup()? The latter calls the former and also shuts the server down in case of an exception.&lt;/p&gt;</comment>
                            <comment id="13490899" author="jbrosenberg" created="Mon, 5 Nov 2012 20:32:43 +0000"  >&lt;p&gt;I was using KafkaServerStartable.startup(), but switched to KafkaServer.startup(), because I wanted to have a bit more control of things, e.g. I want to be able know if there was a problem within the container, and retry, etc.  In KafkaServerStartable.startup(), if there&apos;s an exception, it swallows the exception, and then calls shutdown(), but the caller has no idea if the startup was successful or not.&lt;/p&gt;

&lt;p&gt;But I don&apos;t think that&apos;s relevant here.  I think it&apos;s counter intuitive that the KafkaServer.startup() would fail to startup, and throw an exception, and then not cleanup after itself, and require a call to shutdown in the first place.&lt;/p&gt;</comment>
                            <comment id="14148509" author="ewencp" created="Thu, 25 Sep 2014 23:52:49 +0000"  >&lt;p&gt;This patch makes KafkaServer clean up after itself, but still rethrow any caught exceptions. This keeps the existing interface the same, should still work if the caller does cleanup themselves by catching exceptions and calling shutdown, but also cleans up if they don&apos;t so the leftover thread won&apos;t cause a hang. Also adds a test of this behavior.&lt;/p&gt;</comment>
                            <comment id="14148726" author="nehanarkhede" created="Fri, 26 Sep 2014 04:23:35 +0000"  >&lt;p&gt;Thanks for fixing a longstanding bug! +1 on the patch.&lt;/p&gt;</comment>
                            <comment id="14148728" author="nehanarkhede" created="Fri, 26 Sep 2014 04:23:45 +0000"  >&lt;p&gt;Pushed to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12671345" name="KAFKA-589-v1.patch" size="10980" author="ewencp" created="Thu, 25 Sep 2014 23:54:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>251638</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0c2yn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>68424</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>