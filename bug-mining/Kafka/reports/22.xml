<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:34:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-129] ZK-based producer can throw an unexpceted exception when sending a message</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-129</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Here is a log trace when that happens.&lt;/p&gt;

&lt;p&gt;2011/08/26 11:25:20.104 FATAL &lt;span class=&quot;error&quot;&gt;&amp;#91;EmbeddedConsumer&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka-embedded-consumer-firehoseActivity-0&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;kafka&amp;#93;&lt;/span&gt; java.util.NoSuchElementException: None.getjava.util.NoSuchElementException: None.get&lt;br/&gt;
        at scala.None$.get(Option.scala:185)&lt;br/&gt;
        at scala.None$.get(Option.scala:183)&lt;br/&gt;
        at kafka.producer.Producer$$anonfun$3.apply(Producer.scala:115)&lt;br/&gt;
        at kafka.producer.Producer$$anonfun$3.apply(Producer.scala:101)&lt;br/&gt;
        at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
        at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:206)&lt;br/&gt;
        at scala.collection.IndexedSeqOptimized$class.foreach(IndexedSeqOptimized.scala:34)&lt;br/&gt;
        at scala.collection.mutable.WrappedArray.foreach(WrappedArray.scala:32)&lt;br/&gt;
        at scala.collection.TraversableLike$class.map(TraversableLike.scala:206)&lt;br/&gt;
        at scala.collection.mutable.WrappedArray.map(WrappedArray.scala:32)&lt;br/&gt;
        at kafka.producer.Producer.send(Producer.scala:101)&lt;br/&gt;
        at kafka.server.EmbeddedConsumer$$anonfun$startNewConsumerThreads$1$$anonfun$apply$1$$anon$1$$anonfun$run$1.apply(KafkaServerStartable.scala:136)&lt;br/&gt;
        at kafka.server.EmbeddedConsumer$$anonfun$startNewConsumerThreads$1$$anonfun$apply$1$$anon$1$$anonfun$run$1.apply(KafkaServerStartable.scala:134)&lt;br/&gt;
        at scala.collection.Iterator$class.foreach(Iterator.scala:631)&lt;br/&gt;
        at kafka.utils.IteratorTemplate.foreach(IteratorTemplate.scala:30)&lt;br/&gt;
        at scala.collection.IterableLike$class.foreach(IterableLike.scala:79)&lt;br/&gt;
        at kafka.consumer.KafkaMessageStream.foreach(KafkaMessageStream.scala:29)&lt;br/&gt;
        at kafka.server.EmbeddedConsumer$$anonfun$startNewConsumerThreads$1$$anonfun$apply$1$$anon$1.run(KafkaServerStartable.scala:134)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12521006">KAFKA-129</key>
            <summary>ZK-based producer can throw an unexpceted exception when sending a message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Sep 2011 01:36:06 +0000</created>
                <updated>Tue, 4 Oct 2011 23:05:59 +0000</updated>
                            <resolved>Tue, 4 Oct 2011 23:05:59 +0000</resolved>
                                    <version>0.7</version>
                                    <fixVersion>0.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13119719" author="nehanarkhede" created="Mon, 3 Oct 2011 23:08:36 +0000"  >&lt;p&gt;The producer using the zookeeper software load balancer maintains a ZK cache that gets updated by the zookeeper watcher listeners. During some events like a broker bounce, the producer ZK cache can get into an inconsistent state, for a small time period. In this time period, it could end up picking a broker partition that is unavailable, to complete the send operation. &lt;/p&gt;

&lt;p&gt;When this happens, the ZK cache needs to be updated, and the process of picking a broker partition for the current event should be repeated. This is repeated for a configurable number of retries, defaulting to 3. Arguably, if it takes more than 1-2 retries to get consistent data from zookeeper, something is really wrong, and we should throw an exception back to the user and fail the send operation.&lt;/p&gt;

&lt;p&gt;This patch also adds a check around the debug and trace level logging in the producer&lt;/p&gt;</comment>
                            <comment id="13120307" author="junrao" created="Tue, 4 Oct 2011 17:35:56 +0000"  >&lt;p&gt;1. import collection.SortedSet is not used in Producer.&lt;/p&gt;

&lt;p&gt;2. In ZKBrokerPatitionInfo, it seem that we need to synchronize on zkWatcherLock in getBrokerInfo, to prevent seeing inconsistent info between allBrokers and the syncProducer list in ProducerPool.&lt;/p&gt;

&lt;p&gt;3. In ProducerTest.testSendSingleMessage, the comment says that we want to send the request to a random partition, why is the partition number changed from -1 to 0? &lt;/p&gt;</comment>
                            <comment id="13120342" author="nehanarkhede" created="Tue, 4 Oct 2011 18:05:50 +0000"  >&lt;p&gt;2. Good catch. Updated the patch to include this.&lt;br/&gt;
3. While I was making this change, I found a bug in the partitioning approach of the producer when broker.list option is used. Previously, it choose a random broker, and then created a produce request with -1 as the partition. This is not, however, we intend to do partitioning. We let the default partitioner pick the right broker partition from amongst all available. So we never end up with a request with -1 as the partition. That test was also written with this buggy logic. It is using the StaticPartitioner, so the broker partition is deterministically selected. I fixed the bug as well as the tests to expose the right behavior.&lt;/p&gt;</comment>
                            <comment id="13120371" author="junrao" created="Tue, 4 Oct 2011 18:43:08 +0000"  >&lt;p&gt;OK, for item 3, could you change the comment accordingly?&lt;/p&gt;</comment>
                            <comment id="13120423" author="nehanarkhede" created="Tue, 4 Oct 2011 19:58:07 +0000"  >&lt;p&gt;Yeah, the comment in the test didn&apos;t quite match the new behavior. Fixed it&lt;/p&gt;</comment>
                            <comment id="13120511" author="nehanarkhede" created="Tue, 4 Oct 2011 21:55:18 +0000"  >&lt;p&gt;This patch fixes the comments that didn&apos;t match the expected behavior in the code&lt;/p&gt;</comment>
                            <comment id="13120513" author="junrao" created="Tue, 4 Oct 2011 21:59:32 +0000"  >&lt;p&gt;+1. Thanks for the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12497714" name="KAFKA-129.patch" size="33468" author="nehanarkhede" created="Tue, 4 Oct 2011 21:55:18 +0000"/>
                            <attachment id="12497673" name="KAFKA-129.patch" size="33115" author="nehanarkhede" created="Tue, 4 Oct 2011 18:05:50 +0000"/>
                            <attachment id="12497565" name="KAFKA-129.patch" size="32685" author="nehanarkhede" created="Mon, 3 Oct 2011 23:08:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43959</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i15z2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242982</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>