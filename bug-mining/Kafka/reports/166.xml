<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-646] Provide aggregate stats at the high level Producer and ZookeeperConsumerConnector level</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-646</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;WIth &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-622&quot; title=&quot;Create mbeans per client &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-622&quot;&gt;&lt;del&gt;KAFKA-622&lt;/del&gt;&lt;/a&gt;, we measure ProducerRequestStats and FetchRequestAndResponseStats at the SyncProducer and SimpleConsumer level respectively. We could also aggregate them in the high level Producer and ZookeeperConsumerConnector level to provide an overall sense of request/response rate/size at the client level. Currently, I am not completely clear about the math that might be necessary for such  aggregation or if metrics already provides an API for aggregating stats of the same type.&lt;/p&gt;

&lt;p&gt;We should also address the comments by Jun at &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-622&quot; title=&quot;Create mbeans per client &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-622&quot;&gt;&lt;del&gt;KAFKA-622&lt;/del&gt;&lt;/a&gt;, I am copy pasting them here:&lt;/p&gt;

&lt;p&gt;60. What happens if have 2 instances of Consumers with the same clientid in the same jvm? Does one of them fail because it fails to register metrics? Ditto for Producers.&lt;br/&gt;
61. ConsumerTopicStats: What if a topic is named AllTopics? We use to handle this by adding a - in topic specific stats.&lt;br/&gt;
62. ZookeeperConsumerConnector: Do we need to validate groupid?&lt;br/&gt;
63. ClientId: Does the clientid length need to be different from topic length?&lt;br/&gt;
64. AbstractFetcherThread: When building a fetch request, do we need to pass in brokerInfo as part of the client id? BrokerInfo contains the source broker info and the fetch requests are always made to the source broker.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12618775">KAFKA-646</key>
            <summary>Provide aggregate stats at the high level Producer and ZookeeperConsumerConnector level</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="swapnilghike">Swapnil Ghike</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Tue, 4 Dec 2012 19:44:18 +0000</created>
                <updated>Mon, 17 Dec 2012 22:07:47 +0000</updated>
                            <resolved>Mon, 17 Dec 2012 22:07:44 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13526949" author="swapnilghike" created="Sat, 8 Dec 2012 01:06:16 +0000"  >&lt;p&gt;This patch has a bunch of refactoring changes and a couple of new additions. &lt;/p&gt;

&lt;p&gt;Addressing Jun&apos;s comments: &lt;br/&gt;
These are all great catches! Thanks for being so thorough.&lt;/p&gt;

&lt;p&gt;60. By default, metrics-core will return an existing metric object of the same name using a getOrCreate() like functionality. As discussed offline, we should fail the clients that use an already registered clientId name. We will need to create two objects thaty contain hashmaps to record the existing producer and consumer clientIds and methods to throw an exception if a client attempts to use an existing clientId. I worked on this change a bit, but it breaks a lot of our unit tests (about half) and the refactoring will take some time. Hence, I think it will be better if I submit a patch for all other changes and create another patch for this issue under this jira. Until then we can keep this jira open.&lt;/p&gt;

&lt;p&gt;61. For recording stats about all topics, I am now using a string &quot;All.Topics&quot;. Since &apos;.&apos; is not allowed in the legal character set for topic names, this will differentiate from a topic named AllTopics.&lt;/p&gt;

&lt;p&gt;62. Yes, we should validate groupId. Added the functionality and a unit test. It has the same validation rules as ClientId.&lt;/p&gt;

&lt;p&gt;63. A metric name is something like (clientId + topic + some string) and this entire string is limited by fillename size. We already allow topic name to be at most 255 bytes long. We could fix max lengths for each of clientId, groupId, topic name so that the metric name never exceeds filename size. But those lengths will be quite arbitrary, perhaps we should skip the check on the length of clientId and groupId. &lt;/p&gt;

&lt;p&gt;64. Removed brokerInfo from the clientId used to instantiate FetchRequestBuilder.&lt;/p&gt;


&lt;p&gt;Refactoring: &lt;br/&gt;
1. Moved validation of clientId at the end of instantiation of ProducerConfig and ConsumerConfig. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Created static objects ProducerConfig and ConsumerConfig which contain a validate() method.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2. Created global *Registry objects in which each high level Producer and Consumer can register their *stats objects.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;These objects are registered in the static object only once using utils.Pool.getAndMaybePut functionality.&lt;/li&gt;
	&lt;li&gt;This will remove the need to pass *stats objects around the code in constructors (I thought having the metrics objects right up in the constructors was a bit intrusive, since one doesn&apos;t quite always think about the monitoring mechanism while instantiating various modules of the program, for example while unit testing.)&lt;/li&gt;
	&lt;li&gt;Instead of the constructor, each concerned class obtains the *Stats objects from the global registry object.&lt;/li&gt;
	&lt;li&gt;This cleans up any metrics objects created in the unit tests.&lt;/li&gt;
	&lt;li&gt;Special mention: The producer constructors are back to the old themselves. With clientId validation moved to *Config objects, the intermediate Producer constructor that merely separated the parameters of a quadruplet is gone.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;3. Created separate files&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for ProducerStats, ProducerTopicStats, ProducerRequestStats in kafka.producer package and for FetchRequestAndResponseStats in kafka.consumer package. Thought it was appropriate given that we already had ConsumerTopicStats in a separate file, and since the code for metrics had increased in size due to addition of &lt;b&gt;Registry and Aggregated&lt;/b&gt; objects. Added comments.&lt;/li&gt;
	&lt;li&gt;for objects Topic, ClientId and GroupId in kafka.utils package.&lt;/li&gt;
	&lt;li&gt;to move the helper case classes ClientIdAndTopic, ClientIdAndBroker to kafka.common package.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;4. Renamed a few variables to easier names (anyOldName to &quot;metricId&quot; change).&lt;/p&gt;


&lt;p&gt;New additions: &lt;br/&gt;
1. Added two objects to aggregate metrics recorded by SyncProducers and SimpleConsumers at the high level Producer and Consumer. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;For this, changed KafkaTimer to accept a list of Timers. Typically we will pass a specificTimer and a globalTimer to this KafkaTimer class. Created a new KafkaHistogram in a similar way.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2. Validation of groupId.&lt;/p&gt;


&lt;p&gt;Issues:&lt;br/&gt;
1. Initializing the aggregator metrics with default values: For example, let&apos;s say that a syncProducer could be created (which will register a ProducerRequestStats mbean for this syncProducer). However, if no request is sent by this syncProducer then the absense of its data is not reflected in the aggregator histogram. For instance, the min requestSize for the syncProducer that never sent a request will be 0, but this won&apos;t be accurately represented in the aggregator histogram. Thus, we need to understand that if the request count of a syncProducer is 0, then its data will not be accurately reflected in the aggregator histogram.&lt;/p&gt;

&lt;p&gt;The question is whether it is possible to inform the aggregator histogram of some default values without increasing the request count of any syncProducer or the aggregated stats.&lt;/p&gt;


&lt;p&gt;Further proposed changes: &lt;br/&gt;
Another patch under this jira to address comment 60 by Jun.&lt;/p&gt;</comment>
                            <comment id="13527019" author="swapnilghike" created="Sat, 8 Dec 2012 03:12:46 +0000"  >&lt;p&gt;Actually I just realized that the Aggregated*Stats objects that I have created are not consistent with the way &quot;All.Topics-MessageRate&quot; is measured. It is possible to measure &quot;All.Brokers-producerRequestSize&quot; in a similar way in ProducerRequestStats.&lt;br/&gt;
But it&apos;s not possible to measure &quot;All.Brokers-ProduceRequestRateAndTimeMs&quot; in the same manner since we use a timer block. &lt;/p&gt;

&lt;p&gt;To make everything look consistent, I can delete the aggregator objects from my v1 patch and create a KafkaMeter class that accepts a list of meters. Will upload another version of patch.&lt;/p&gt;
</comment>
                            <comment id="13527078" author="swapnilghike" created="Sat, 8 Dec 2012 06:16:43 +0000"  >&lt;p&gt;Attached patch v2. &lt;/p&gt;

&lt;p&gt;The changes from patch v1:&lt;br/&gt;
1. Deleted KafkaHistogram class. (There is also no need for KafkaMeter class.)&lt;/p&gt;

&lt;p&gt;2. Deleted the Aggregated*Stats objects. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The metrics of SyncProducer and SimpleConsumer for different brokers are aggregated together using the same way the producerTopicStats are aggregated for &quot;All.Topics&quot;.&lt;/li&gt;
	&lt;li&gt;Measuring the time for produce requests and fetch requests is achieved by passing a list of timers to KafkaTimer.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13528183" author="nehanarkhede" created="Mon, 10 Dec 2012 19:07:34 +0000"  >&lt;p&gt;Patch v2 looks good to me. Few minor questions -&lt;br/&gt;
1. Producer&lt;br/&gt;
You probably don&apos;t validate the client id anymore in the secondary constructor. Shouldn&apos;t we do that ?&lt;/p&gt;

&lt;p&gt;2. ZookeeperConsumerConnector&lt;br/&gt;
consumerTopicStats is unused&lt;/p&gt;

&lt;p&gt;3. Do the singleton validate() APIs need to be synchronized ? &lt;/p&gt;</comment>
                            <comment id="13528298" author="swapnilghike" created="Mon, 10 Dec 2012 21:16:46 +0000"  >&lt;p&gt;Thanks for reviewing.&lt;/p&gt;

&lt;p&gt;Patch v3:&lt;br/&gt;
1. Oh, that&apos;s because clientId is validated at the end of ProducerConfig constructor.&lt;/p&gt;

&lt;p&gt;2. Removed it. &lt;/p&gt;

&lt;p&gt;3. Currently the validate() APIs only check for illegal chars and they don&apos;t yet check whether the incoming clientId has already been taken. (I am planning to do it in a separate patch in the same jira, after this patch has been checked in). &lt;/p&gt;</comment>
                            <comment id="13528353" author="swapnilghike" created="Mon, 10 Dec 2012 22:17:42 +0000"  >&lt;p&gt;Fixed a typo in FetchRequestAndResponseStats mbean creation.&lt;/p&gt;</comment>
                            <comment id="13528559" author="junrao" created="Tue, 11 Dec 2012 01:18:09 +0000"  >&lt;p&gt;Thanks for patch v4. Looks good overall. A few minor comments:&lt;/p&gt;

&lt;p&gt;40. GroupId,ClientId: The validation code is identical. Could we combine them into one utility? We can throw a generic InvalidConfigurationException with the right text.&lt;/p&gt;

&lt;p&gt;41. The patch does apply because of changes in system_test/testcase_to_run.json. Do you actually intend to change this file?&lt;/p&gt;</comment>
                            <comment id="13529268" author="swapnilghike" created="Tue, 11 Dec 2012 19:48:34 +0000"  >&lt;p&gt;Patch v5:&lt;/p&gt;

&lt;p&gt;40. I agree with you. Created a new trait Config in common package, it has a method that can validate a clientId or a groupId. ProducerConfig and ConsumerConfig extend this trait and they have their additional methods to validate config values that are specific to themselves.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Moved config value validations in ZookeeperConsumerConnector and Producer to ConsumerConfig and ProducerConfig objects respectively, since we can throw an InvalidConfigException when the Config is getting instantiated.&lt;/li&gt;
	&lt;li&gt;Moved Topic and TopicTest to common package.&lt;/li&gt;
	&lt;li&gt;Added a ConfigTest to common package.&lt;/li&gt;
	&lt;li&gt;Removed InvalidClientException and InvalidGroupException. Instead I am now re-using the existing InvalidConfigException to print the appropriate message.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;41. It automatically got changed when I ran sanity test, John probably has a patch that will add another file run_test, he says we can use it once it is checked in.&lt;/p&gt;</comment>
                            <comment id="13529566" author="nehanarkhede" created="Wed, 12 Dec 2012 01:54:37 +0000"  >&lt;p&gt;+1 on v5. I think we can check this in and wait for v6 addressing rest of the issues ?&lt;/p&gt;</comment>
                            <comment id="13529639" author="junrao" created="Wed, 12 Dec 2012 05:47:06 +0000"  >&lt;p&gt;Thanks for patch v5. A few more comments:&lt;/p&gt;

&lt;p&gt;50. Config: &lt;br/&gt;
50.1 Could we rename validateClientIdOrGroupId to sth more general like validateAlphaNumericString?&lt;br/&gt;
50.2 We should add a separator btw prop and value in the message string of InvalidConfigException.&lt;/p&gt;

&lt;p&gt;51. ConsumerConfig: In validateAutoOffsetReset(), let&apos;s add the autoOffsetReset value in the message string of InvalidConfigException.&lt;/p&gt;

&lt;p&gt;52. ProducerConfig: In validateProducerType(), let&apos;s add the producerType value in the message string of InvalidConfigException.&lt;/p&gt;</comment>
                            <comment id="13529745" author="swapnilghike" created="Wed, 12 Dec 2012 08:31:30 +0000"  >&lt;p&gt;Made the changes.&lt;/p&gt;</comment>
                            <comment id="13530217" author="swapnilghike" created="Wed, 12 Dec 2012 19:04:22 +0000"  >&lt;p&gt;Including in patch v7 Joel&apos;s suggestion at &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-604&quot; title=&quot;Add missing metrics in 0.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-604&quot;&gt;&lt;del&gt;KAFKA-604&lt;/del&gt;&lt;/a&gt; to measure time as following :&lt;/p&gt;

&lt;p&gt;aggregatekafkatimer.time {&lt;br/&gt;
  specifickafkatimer.time &lt;/p&gt;
{
    &amp;lt;code block&amp;gt;
  }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;This style is probably ok, since we don&apos;t have a use case where we use more than two timers to time the same block. This also removes the need to modify KafkaTimer.&lt;/p&gt;</comment>
                            <comment id="13534355" author="nehanarkhede" created="Mon, 17 Dec 2012 22:07:44 +0000"  >&lt;p&gt;Thanks for v7. Just checked it in.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12559995" name="kafka-646-patch-num1-v1.patch" size="66096" author="swapnilghike" created="Sat, 8 Dec 2012 01:06:16 +0000"/>
                            <attachment id="12560022" name="kafka-646-patch-num1-v2.patch" size="65342" author="swapnilghike" created="Sat, 8 Dec 2012 06:16:43 +0000"/>
                            <attachment id="12560279" name="kafka-646-patch-num1-v3.patch" size="65304" author="swapnilghike" created="Mon, 10 Dec 2012 21:16:46 +0000"/>
                            <attachment id="12560292" name="kafka-646-patch-num1-v4.patch" size="65283" author="swapnilghike" created="Mon, 10 Dec 2012 22:17:42 +0000"/>
                            <attachment id="12560434" name="kafka-646-patch-num1-v5.patch" size="72784" author="swapnilghike" created="Tue, 11 Dec 2012 19:48:34 +0000"/>
                            <attachment id="12560529" name="kafka-646-patch-num1-v6.patch" size="72841" author="swapnilghike" created="Wed, 12 Dec 2012 08:31:30 +0000"/>
                            <attachment id="12560615" name="kafka-646-patch-num1-v7.patch" size="71983" author="swapnilghike" created="Wed, 12 Dec 2012 19:04:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>296023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i144qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>232232</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>