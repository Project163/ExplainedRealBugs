<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:02:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5634] Replica fetcher thread crashes due to OffsetOutOfRangeException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5634</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have seen the following exception recently:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;kafka.common.KafkaException: error processing data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition [foo,0] offset 1459250
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1$$anonfun$apply$2.apply(AbstractFetcherThread.scala:203)
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1$$anonfun$apply$2.apply(AbstractFetcherThread.scala:174)
        at scala.Option.foreach(Option.scala:257)
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1.apply(AbstractFetcherThread.scala:174)
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2$$anonfun$apply$mcV$sp$1.apply(AbstractFetcherThread.scala:171)
        at scala.collection.mutable.ResizableArray$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(ResizableArray.scala:59)
        at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:48)
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2.apply$mcV$sp(AbstractFetcherThread.scala:171)
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2.apply(AbstractFetcherThread.scala:171)
        at kafka.server.AbstractFetcherThread$$anonfun$processFetchRequest$2.apply(AbstractFetcherThread.scala:171)
        at kafka.utils.CoreUtils$.inLock(CoreUtils.scala:213)
        at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:169)
        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:112)
        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:64)
Caused by: org.apache.kafka.common.errors.OffsetOutOfRangeException: The specified offset 1459250 is higher than the high watermark 1459032 of the partition foo-0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The error check was added in the patch for KIP-107: &lt;a href=&quot;https://github.com/apache/kafka/commit/8b05ad406d4cba6a75d1683b6d8699c3ab28f9d6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/commit/8b05ad406d4cba6a75d1683b6d8699c3ab28f9d6&lt;/a&gt;. After investigation, we found that it is possible for the log start offset on the leader to get ahead of the high watermark on the follower after segment deletion. The check therefore seems incorrect. The impact of this bug is that the fetcher thread crashes on the follower and the broker must be restarted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13089770">KAFKA-5634</key>
            <summary>Replica fetcher thread crashes due to OffsetOutOfRangeException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                            <label>regression</label>
                            <label>reliability</label>
                    </labels>
                <created>Tue, 25 Jul 2017 04:07:51 +0000</created>
                <updated>Thu, 8 Aug 2019 14:20:10 +0000</updated>
                            <resolved>Thu, 27 Jul 2017 20:23:04 +0000</resolved>
                                    <version>0.11.0.0</version>
                                    <fixVersion>0.11.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16099470" author="hachikuji" created="Tue, 25 Jul 2017 04:12:23 +0000"  >&lt;p&gt;Should have mentioned this, but the specific line is here: &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/cluster/Replica.scala#L109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/cluster/Replica.scala#L109&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16099834" author="ijuma" created="Tue, 25 Jul 2017 10:26:04 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16099943" author="ijuma" created="Tue, 25 Jul 2017 12:17:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;, restarting the follower is not enough as the thread will die again, right? The simplest way is probably to just delete all the data in the follower so that it re-replicates (assuming that re-replication is not too costly).&lt;/p&gt;</comment>
                            <comment id="16100252" author="hachikuji" created="Tue, 25 Jul 2017 15:52:39 +0000"  >&lt;p&gt;I&apos;ve been looking at this a bit more. I think the only way this can happen is if the offsets returned by the leader are inconsistent. In this case, it seems like the high watermark returned in the fetch must have been behind the log start offset. The relevant snippet in the replica fetch response handler is here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    val followerHighWatermark = replica.logEndOffset.messageOffset.min(partitionData.highWatermark)
    val leaderLogStartOffset = partitionData.logStartOffset
    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the follower replica, we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not need to keep
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// its segment base offset the physical position,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// these values will be computed upon making the leader
&lt;/span&gt;    replica.highWatermark = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LogOffsetMetadata(followerHighWatermark)
    replica.maybeIncrementLogStartOffset(leaderLogStartOffset)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The fetched offset was 1459250, which means the follower&apos;s LEO couldn&apos;t have been lower than that. So the follower high watermark must have been taken from the fetch response. Then the call to &lt;tt&gt;maybeIncrementLogStartOffset&lt;/tt&gt; fails because the leader&apos;s log start offset is ahead of the high watermark which was just set. &lt;/p&gt;</comment>
                            <comment id="16100381" author="hachikuji" created="Tue, 25 Jul 2017 17:14:31 +0000"  >&lt;p&gt;I can confirm that this bug occurs when a fetch response contains a high watermark lower than the log start offset. It is easily reproducible by creating a replicated topic configured with compact+delete and a low retention value, and writing data older than the retention value quickly from a producer. Here is the topic command I used:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;bin/kafka-topics.sh --create --topic foo --replication-factor 2 --partitions 1 --config retention.ms=60000 --config cleanup.policy=compact,delete --zookeeper localhost:2181 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then I did a simple producer loop which wrote records with timestamps from a day ago. Almost immediately I saw the exception and was able to confirm the contents of the fetch response data. &lt;/p&gt;</comment>
                            <comment id="16101008" author="githubbot" created="Wed, 26 Jul 2017 00:46:07 +0000"  >&lt;p&gt;GitHub user hachikuji opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3575&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5634&quot; title=&quot;Replica fetcher thread crashes due to OffsetOutOfRangeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5634&quot;&gt;&lt;del&gt;KAFKA-5634&lt;/del&gt;&lt;/a&gt;; Do not allow segment deletion beyond high watermark&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hachikuji/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5634&quot; title=&quot;Replica fetcher thread crashes due to OffsetOutOfRangeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5634&quot;&gt;&lt;del&gt;KAFKA-5634&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3575.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3575.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3575&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 28ba15871d954fa7036b26ebebc5268fbaf1b818&lt;br/&gt;
Author: Jason Gustafson &amp;lt;jason@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-07-26T00:13:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5634&quot; title=&quot;Replica fetcher thread crashes due to OffsetOutOfRangeException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5634&quot;&gt;&lt;del&gt;KAFKA-5634&lt;/del&gt;&lt;/a&gt;; Do not allow segment deletion beyond high watermark&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16103800" author="githubbot" created="Thu, 27 Jul 2017 19:55:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3575&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16103841" author="hachikuji" created="Thu, 27 Jul 2017 20:23:04 +0000"  >&lt;p&gt;Issue resolved by pull request 3575&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3575&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16139966" author="muradm" created="Thu, 24 Aug 2017 12:18:26 +0000"  >&lt;p&gt;Figured it out. As workaround, for topics which configured with cleanup policy compact+delete and have retention time specified, applications should not allow events which has timestamp older than time range of retention.ms ... now.&lt;/p&gt;</comment>
                            <comment id="16197300" author="lindong" created="Mon, 9 Oct 2017 16:56:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; I just realized that I have missed most email notifications after someone mentioned me in the JIRA ticket like this. I just added a filter to make sure I can see such notification in the future.&lt;/p&gt;</comment>
                            <comment id="16903024" author="kalbm" created="Thu, 8 Aug 2019 14:20:10 +0000"  >&lt;p&gt;Does anyone know of a work around for this issue? To get replicas to stop being in this failed state (as a replica but no longer able to join ISR)? Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hynb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>