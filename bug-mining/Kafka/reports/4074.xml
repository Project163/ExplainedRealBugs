<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:41:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17162] DefaultTaskManagerTest may leak AwaitingRunnable thread</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17162</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The `DefaultTaskManagerTest#shouldReturnFromAwaitOnInterruption` will fail with the following patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
```
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManager.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManager.java
index 5d2db3c279..b87a82b85b 100644
--- a/streams/src/main/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManager.java
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManager.java
@@ -348,6 +348,10 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DefaultTaskManager &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; TaskManager {
     }
 
     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &amp;lt;T&amp;gt; T returnWithTasksLocked(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Supplier&amp;lt;T&amp;gt; action) {
+        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
+        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception e) {
+        }
         tasksLock.lock();
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; action.get();
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManagerTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManagerTest.java
index 98065eae7d..0d8dde7156 100644
--- a/streams/src/test/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManagerTest.java
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/tasks/DefaultTaskManagerTest.java
@@ -114,6 +114,10 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DefaultTaskManagerTest {
         @Override
         &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
             &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!shutdownRequested.get()) {
+                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
+                    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
+                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception e) {
+                }
                 &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                     taskManager.awaitProcessableTasks();
                 } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; InterruptedException ignored) {
@@ -151,6 +155,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DefaultTaskManagerTest {
         assertTrue(awaitingRunnable.awaitDone.await(VERIFICATION_TIMEOUT, TimeUnit.MILLISECONDS));
 
         awaitingRunnable.shutdown();
+        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
+        assertFalse(awaitingThread.isAlive());
     }
 
     @Test
```
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; awatingThread is left unclosed because it was waiting for the signal&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-3&quot;&lt;/span&gt; #25 [26371] prio=5 os_prio=31 cpu=9.68ms elapsed=74.89s tid=0x00000001250d8600 nid=26371 waiting on condition  [0x0000000173d4e000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
        at jdk.internal.misc.Unsafe.park(java.base@21.0.2/Native Method)
        - parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007dcd49b88&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
        at java.util.concurrent.locks.LockSupport.park(java.base@21.0.2/LockSupport.java:371)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionNode.block(java.base@21.0.2/AbstractQueuedSynchronizer.java:519)
        at java.util.concurrent.ForkJoinPool.unmanagedBlock(java.base@21.0.2/ForkJoinPool.java:3780)
        at java.util.concurrent.ForkJoinPool.managedBlock(java.base@21.0.2/ForkJoinPool.java:3725)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(java.base@21.0.2/AbstractQueuedSynchronizer.java:1707)
        at org.apache.kafka.streams.processor.internals.tasks.DefaultTaskManager.lambda$awaitProcessableTasks$1(DefaultTaskManager.java:142)
        at org.apache.kafka.streams.processor.internals.tasks.DefaultTaskManager$$Lambda/0x0000007001305428.get(Unknown Source)
        at org.apache.kafka.streams.processor.internals.tasks.DefaultTaskManager.returnWithTasksLocked(DefaultTaskManager.java:357)
        at org.apache.kafka.streams.processor.internals.tasks.DefaultTaskManager.awaitProcessableTasks(DefaultTaskManager.java:129)
        at org.apache.kafka.streams.processor.internals.tasks.DefaultTaskManagerTest$AwaitingRunnable.run(DefaultTaskManagerTest.java:122)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.runWith(java.base@21.0.2/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1596)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@21.0.2/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1583)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13586281">KAFKA-17162</key>
            <summary>DefaultTaskManagerTest may leak AwaitingRunnable thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="aoli-al">Ao Li</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Jul 2024 15:34:57 +0000</created>
                <updated>Tue, 28 Jan 2025 00:49:35 +0000</updated>
                            <resolved>Tue, 28 Jan 2025 00:49:35 +0000</resolved>
                                    <version>3.9.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>streams</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17875192" author="JIRAUSER306156" created="Tue, 20 Aug 2024 13:56:00 +0000"  >&lt;p&gt;Please follow this branch &lt;a href=&quot;https://github.com/aoli-al/kafka/tree/KAFKA-83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aoli-al/kafka/tree/KAFKA-83&lt;/a&gt; and run test `DefaultTaskManagerTest::shouldReturnFromAwaitOnInterruption` to reproduce the failure&lt;/p&gt;</comment>
                            <comment id="17913537" author="mjsax" created="Thu, 16 Jan 2025 03:50:52 +0000"  >&lt;p&gt;I could not reproduce this... applied your patch to `trunk` but the test passed.&lt;/p&gt;

&lt;p&gt;I agree that we should `join()` the threads that we `start()` though &#8211; if there is any issue that a thread stays in `WAITING` state, `join()` should surface the issue. Opened a PR for it, but test did pass locally with `join()` and also with `join()` + your patch.&lt;/p&gt;

&lt;p&gt;If we cannot reproduce this, I would propose to just close the ticket.&lt;/p&gt;</comment>
                            <comment id="17913543" author="JIRAUSER306156" created="Thu, 16 Jan 2025 04:26:55 +0000"  >&lt;p&gt;Thanks for proposing the fix. I&apos;ve tried to download a clean clone on my laptop (MacBook pro M3 Max) and my desktop (i9-11900 with ubuntu 24.04) and run command `./gradlew :streams:test --tests  DefaultTaskManagerTest.shouldReturnFromAwaitOnInterruption`. I could see failures on both machines. &lt;/p&gt;

&lt;p&gt;My JDK version is: openjdk 16.0.2 2021-07-20 (ubuntu), and openjdk 21.0.5 2024-10-15 (macos)&lt;/p&gt;

&lt;p&gt;I&apos;ve submitted a commit to the branch to adjust sleep durations.  &lt;a href=&quot;https://github.com/aoli-al/kafka/commit/30c485f244c3e0eeafec0a4d5f42ddc4d5019333&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aoli-al/kafka/commit/30c485f244c3e0eeafec0a4d5f42ddc4d5019333&lt;/a&gt; (you may pull the changes from the branch &lt;a href=&quot;https://github.com/aoli-al/kafka/tree/KAFKA-83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aoli-al/kafka/tree/KAFKA-83&lt;/a&gt;). Please let me know if this makes the failure more reproducible. &lt;/p&gt;</comment>
                            <comment id="17914281" author="mjsax" created="Sat, 18 Jan 2025 03:21:16 +0000"  >&lt;p&gt;The proposed fix should address the issue, right? If we call `join()` before testing `isAlive()` the test passes &#8211; even if we put the sleeps into the code to reproduce the leak.&lt;/p&gt;</comment>
                            <comment id="17914288" author="JIRAUSER306156" created="Sat, 18 Jan 2025 04:03:40 +0000"  >&lt;p&gt;Yes, I can confirm that adding `join` in the test method will fix this issue. &lt;/p&gt;

&lt;p&gt;Again, thanks for taking the time to fix these issues!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qf6o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>