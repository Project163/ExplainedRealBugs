<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:59:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4558] throttling_test fails if the producer starts too fast.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4558</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;As described in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4526&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4526&lt;/a&gt;, the throttling test will fail if the producer in the produce-consume-validate loop starts up before the consumer is fully initialized.&lt;/p&gt;

&lt;p&gt;We need to block the start of the producer until the consumer is ready to go. &lt;/p&gt;

&lt;p&gt;The current plan is to poll the consumer for a particular metric (like, for instance, partition assignment) which will act as a good proxy for successful initialization. Currently, we just check for the existence of a process with the PID, which is not a strong enough check, causing the test to fail intermittently. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13029284">KAFKA-4558</key>
            <summary>throttling_test fails if the producer starts too fast.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurva">Apurva Mehta</assignee>
                                    <reporter username="apurva">Apurva Mehta</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Dec 2016 23:12:52 +0000</created>
                <updated>Sun, 5 Feb 2017 10:33:48 +0000</updated>
                            <resolved>Sun, 5 Feb 2017 10:33:47 +0000</resolved>
                                                    <fixVersion>0.10.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15773299" author="ewencp" created="Fri, 23 Dec 2016 17:14:34 +0000"  >&lt;p&gt;There&apos;s another case that looks basically the same as this issue:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://confluent-kafka-system-test-results.s3-us-west-2.amazonaws.com/2016-12-23--001.1482484603--apache--trunk--76169f9/report.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://confluent-kafka-system-test-results.s3-us-west-2.amazonaws.com/2016-12-23--001.1482484603--apache--trunk--76169f9/report.html&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;test_id:    kafkatest.tests.core.replication_test.ReplicationTest.test_replication_with_broker_failure.security_protocol=SASL_SSL.failure_mode=hard_bounce.broker_type=controller&lt;br/&gt;
status:     FAIL&lt;br/&gt;
run time:   3 minutes 27.556 seconds&lt;/p&gt;


&lt;p&gt;    9 acked message did not make it to the Consumer. They are: &lt;span class=&quot;error&quot;&gt;&amp;#91;3425, 3428, 3404, 3407, 3410, 3413, 3416, 3419, 3422&amp;#93;&lt;/span&gt;. We validated that the first 9 of these missing messages correctly made it into Kafka&apos;s data files. This suggests they were lost on their way to the consumer.&lt;br/&gt;
Traceback (most recent call last):&lt;br/&gt;
  File &quot;/var/lib/jenkins/workspace/system-test-kafka/kafka/venv/local/lib/python2.7/site-packages/ducktape-0.6.0-py2.7.egg/ducktape/tests/runner_client.py&quot;, line 123, in run&lt;br/&gt;
    data = self.run_test()&lt;br/&gt;
  File &quot;/var/lib/jenkins/workspace/system-test-kafka/kafka/venv/local/lib/python2.7/site-packages/ducktape-0.6.0-py2.7.egg/ducktape/tests/runner_client.py&quot;, line 176, in run_test&lt;br/&gt;
    return self.test_context.function(self.test)&lt;br/&gt;
  File &quot;/var/lib/jenkins/workspace/system-test-kafka/kafka/venv/local/lib/python2.7/site-packages/ducktape-0.6.0-py2.7.egg/ducktape/mark/_mark.py&quot;, line 321, in wrapper&lt;br/&gt;
    return functools.partial(f, *args, **kwargs)(*w_args, **w_kwargs)&lt;br/&gt;
  File &quot;/var/lib/jenkins/workspace/system-test-kafka/kafka/tests/kafkatest/tests/core/replication_test.py&quot;, line 155, in test_replication_with_broker_failure&lt;br/&gt;
    self.run_produce_consume_validate(core_test_action=lambda: failures&lt;span class=&quot;error&quot;&gt;&amp;#91;failure_mode&amp;#93;&lt;/span&gt;(self, broker_type))&lt;br/&gt;
  File &quot;/var/lib/jenkins/workspace/system-test-kafka/kafka/tests/kafkatest/tests/produce_consume_validate.py&quot;, line 101, in run_produce_consume_validate&lt;br/&gt;
    self.validate()&lt;br/&gt;
  File &quot;/var/lib/jenkins/workspace/system-test-kafka/kafka/tests/kafkatest/tests/produce_consume_validate.py&quot;, line 163, in validate&lt;br/&gt;
    assert success, msg&lt;br/&gt;
AssertionError: 9 acked message did not make it to the Consumer. They are: &lt;span class=&quot;error&quot;&gt;&amp;#91;3425, 3428, 3404, 3407, 3410, 3413, 3416, 3419, 3422&amp;#93;&lt;/span&gt;. We validated that the first 9 of these missing messages correctly made it into Kafka&apos;s data files. This suggests they were lost on their way to the consumer.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;These are in the middle of the set and are all 3 apart, which is presumably due to the fact that there are 3 partitions in the topic and we are seeing a piece of one of the partitions missing instead of all 3. I think probably this is fairly pervasive in the ProduceConsumeValidate tests, so may not be &quot;fixable&quot; just by ignoring tests one-off.&lt;/p&gt;</comment>
                            <comment id="15776893" author="ewencp" created="Sun, 25 Dec 2016 18:39:33 +0000"  >&lt;p&gt;And this is also happening, albeit less frequently, on the 3.1.x branch: &lt;a href=&quot;http://confluent-kafka-0-10-1-system-test-results.s3-us-west-2.amazonaws.com/2016-12-25--001.1482666294--apache--0.10.1--8c62858/report.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://confluent-kafka-0-10-1-system-test-results.s3-us-west-2.amazonaws.com/2016-12-25--001.1482666294--apache--0.10.1--8c62858/report.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15797404" author="ewencp" created="Wed, 4 Jan 2017 07:15:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurva&quot; class=&quot;user-hover&quot; rel=&quot;apurva&quot;&gt;apurva&lt;/a&gt; I&apos;m thinking it&apos;d be a lot easier to handle this type of issue if we forced system tests to use a custom MetricsReporter that exposes metrics via HTTP. Right now it&apos;s a pain to grab metrics because the JMX reporter isn&apos;t easily accessible to the test driver app written in python. If we provided an alternative that gave access to metrics via HTTP, we&apos;d have a really easy way to validate metrics from system tests.&lt;/p&gt;

&lt;p&gt;To fix this specific problem we might still need to add another metric to the consumer, but as I looked into how to get the metrics required in the system tests, it seemed really painful in its current form. This would probably also simplify some other tests currently relying on the &lt;tt&gt;JmxMixin&lt;/tt&gt; class in the system tests.&lt;/p&gt;

&lt;p&gt;What do you think? We could add this in the test binaries for now to avoid any KIPs, dependency issues, etc, though I suspect we might eventually want to graduate it to its own module as many folks might find it useful to be able to just ping a URL periodically and collect all metrics data from a Kafka process.&lt;/p&gt;</comment>
                            <comment id="15799448" author="apurva" created="Wed, 4 Jan 2017 21:46:48 +0000"  >&lt;p&gt;That sounds like a good idea in general, to make metrics easier to gather from a variety of clients. What metric would you add to the consumer to fix this test? Number of partitions assigned or something else?&lt;/p&gt;

&lt;p&gt;Another thought: the Throttling test strictly requires that consumer be started and ready to go before the producer starts. The other tests using `ProduceConsumeValidate` do not require this. One short term work around is to revert &lt;a href=&quot;https://github.com/apache/kafka/pull/1904/files#diff-70247099943a55f682e6e6e4f400334eL35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this patch to ProduceConsumeValidate&lt;/a&gt; . This way, we could keep the throttling test ignored until we have a more reliable way to determine that the consumer is ready, but the other tests would be good to go..&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="15800434" author="ewencp" created="Thu, 5 Jan 2017 05:58:47 +0000"  >&lt;p&gt;Number of partitions probably isn&apos;t reliable since some consumers could end up with 0 assigned partitions (unless we always make sure tests have enough partitions to go around). Maybe just a metric indicating whether the consumer state, i.e. joining, member, etc? This is actually kind of tricky because we don&apos;t just need the partitions assigned, we also need to make sure the we&apos;ve looked up and set the fetch offsets in the consumer. This might require per-assigned-partition offset information &amp;#8211; maybe have a metric for list of assigned partitions and then a metric for the offset (or lag) for each of them?&lt;/p&gt;

&lt;p&gt;Given some issues with other tests we&apos;ve seen, I think there are others that have the same requirement. I&apos;m fine with {{@ignore}}ing some tests if people think that&apos;s valuable, but I think it&apos;d be better to just try to get the fix in asap since it&apos;ll be quite a bit of effort to evaluate all the tests using ProduceConsumeValidate &amp;#8211; I see at least 13 or so in kafkatest.&lt;/p&gt;</comment>
                            <comment id="15806421" author="apurva" created="Sat, 7 Jan 2017 01:28:43 +0000"  >&lt;p&gt;So I had a look at the code. All the 13 tests which use `ProduceConsumeValidate` have changed since that commit. So it is totally unproductive revert that change at this point.&lt;/p&gt;

&lt;p&gt;Regarding your proposal for two metrics: partitions assigned and per-partition lag may not be what we want. Particularly, in the`ProduceConsumeValidate` test, the producer is started after the consumer. So if the topic is originally empty, or if the consumer is configured to read from the end, the lag will always be zero. This is per my understanding of how lag is reported, viz. how far from the tail of the log the consumer is. So the lag metric probably won&apos;t be very useful in majority of the cases. &lt;/p&gt;

&lt;p&gt;But waiting until partitions assigned is non zero may be what we want. The tests I have seen just have a single console consumer for the entire topic, so there should be enough partitions to go around. Of course this may not be true in the future). At the very least it will be better than what we have right now. And if there are not enough partitions to go around, the test will fail early (since the wait_until will time out), and can be diagnosed before checkin. &lt;/p&gt;

&lt;p&gt;Regarding implementation of partitions assigned alone, I thought it might be worth staging the implementation by first using the metric through jmx. This would give us a shorter turn around time and validate whether this approach is sufficient to fix the current issues. We can even play with different metrics more quickly if necessary. &lt;/p&gt;

&lt;p&gt;Finally, would adding an HttpMetricsReporter necessitate a KIP?&lt;/p&gt;
</comment>
                            <comment id="15806466" author="apurva" created="Sat, 7 Jan 2017 01:49:00 +0000"  >&lt;p&gt;I dug a bit further into the `JmxMixin`, and it seems that all we have to do in the console consumer is something like the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def has_partitions_assigned(self): 
  # we run at init jmx_object_names += [&lt;span class=&quot;code-quote&quot;&gt;&apos;partitions-assigned&apos;&lt;/span&gt;]
  self.read_jmx_output(idx, node)
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; self.average_jmx_value[&lt;span class=&quot;code-quote&quot;&gt;&apos;partitions_assigned&apos;&lt;/span&gt;] &amp;gt; 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then the current `wait_until` in `ProduceConsumeValidate.start_producer_and_consumer` should just wait until `has_partitions_assigned` returns true. Does this seem reasonable? Or have I misunderstood how this is supposed to work?   &lt;/p&gt;</comment>
                            <comment id="15810593" author="ewencp" created="Mon, 9 Jan 2017 03:56:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurva&quot; class=&quot;user-hover&quot; rel=&quot;apurva&quot;&gt;apurva&lt;/a&gt; I couldn&apos;t remember when lag metrics are actually updated, but I guess if they are 0 even if the topic doesn&apos;t exist then it doesn&apos;t help. You&apos;re right that at least we&apos;ll be a lot closer to the correct condition by checking that we at least have an assignment.&lt;/p&gt;

&lt;p&gt;Using JMX seems fine to me, I didn&apos;t look carefully through the JmxMixin implementation but thought I remembered it being pretty messy (I think partially since it has to run an extra process that does the data collection). If it&apos;s easy to get from that, that&apos;s great. I was also selfishly considering other future uses of metrics where we&apos;d probably like there to be easier (and cheaper) ways to capture this info &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Re: HttpMetricsReporter &amp;#8211; nothing in tests requires a KIP since it&apos;d be unsupported, although I have no doubt once it existed some folks would want it to be supported.&lt;/p&gt;</comment>
                            <comment id="15853193" author="ijuma" created="Sun, 5 Feb 2017 10:33:48 +0000"  >&lt;p&gt;Issue resolved by pull request 2347&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2347&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37snr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>