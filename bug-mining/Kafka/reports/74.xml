<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:35:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-379] TopicCount.constructTopicCount isn&apos;t thread-safe</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-379</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;TopicCount uses scala.util.parsing.json.JSON, which isn&apos;t thread-safe &lt;a href=&quot;https://issues.scala-lang.org/browse/SI-4929&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.scala-lang.org/browse/SI-4929&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you have multiple consumers within the same JVM, and they all rebalance at the same time, you can get errors like the following:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; kafka.consumer.TopicCount$.constructTopicCount:39] ERROR: error parsing consumer json string &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
        at scala.util.parsing.combinator.Parsers$NoSuccess.&amp;lt;init&amp;gt;(Parsers.scala:131)&lt;br/&gt;
        at scala.util.parsing.combinator.Parsers$Failure.&amp;lt;init&amp;gt;(Parsers.scala:158)&lt;br/&gt;
        at scala.util.parsing.combinator.Parsers$$anonfun$acceptIf$1.apply(Parsers.scala:489)&lt;br/&gt;
        ...&lt;br/&gt;
        at scala.util.parsing.combinator.Parsers$$anon$2.apply(Parsers.scala:742)&lt;br/&gt;
        at scala.util.parsing.json.JSON$.parseRaw(JSON.scala:71)&lt;br/&gt;
        at scala.util.parsing.json.JSON$.parseFull(JSON.scala:85)&lt;br/&gt;
        at kafka.consumer.TopicCount$.constructTopicCount(TopicCount.scala:32)&lt;br/&gt;
        at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.kafka$consumer$ZookeeperConsumerConnector$ZKRebalancerListener$$getTopicCount(ZookeeperConsumerConnector.scala:422)&lt;br/&gt;
        at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.kafka$consumer$ZookeeperConsumerConnector$ZKRebalancerListener$$rebalance(ZookeeperConsumerConnector.scala:460)&lt;br/&gt;
        at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener$$anonfun$syncedRebalance$1.apply$mcVI$sp(ZookeeperConsumerConnector.scala:437)&lt;br/&gt;
        at scala.collection.immutable.Range$ByOne$class.foreach$mVc$sp(Range.scala:282)&lt;br/&gt;
        at scala.collection.immutable.Range$$anon$2.foreach$mVc$sp(Range.scala:265)&lt;br/&gt;
        at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.syncedRebalance(ZookeeperConsumerConnector.scala:433)&lt;br/&gt;
        at kafka.consumer.ZookeeperConsumerConnector$ZKRebalancerListener.handleChildChange(ZookeeperConsumerConnector.scala:375)&lt;br/&gt;
        at org.I0Itec.zkclient.ZkClient$7.run(ZkClient.java:568)&lt;br/&gt;
        at org.I0Itec.zkclient.ZkEventThread.run(ZkEventThread.java:71)&lt;/p&gt;

&lt;p&gt;I ran into this on 0.7.0, but the code in trunk appears to be vulnerable to the same issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596325">KAFKA-379</key>
            <summary>TopicCount.constructTopicCount isn&apos;t thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="baroquebobcat">Nick Howard</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Thu, 28 Jun 2012 21:01:29 +0000</created>
                <updated>Tue, 18 Sep 2012 05:06:14 +0000</updated>
                            <resolved>Tue, 18 Sep 2012 05:06:08 +0000</resolved>
                                    <version>0.7</version>
                    <version>0.8.0</version>
                                    <fixVersion>0.7</fixVersion>
                    <fixVersion>0.8.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13403486" author="baroquebobcat" created="Thu, 28 Jun 2012 21:26:06 +0000"  >&lt;p&gt;I patched our fork like this.&lt;/p&gt;

&lt;p&gt;The patch takes the parsing code from scala.util.parsing.json.JSON and puts it in a class instead of an object, so it&apos;s instantiable.&lt;/p&gt;</comment>
                            <comment id="13403629" author="jjkoshy" created="Fri, 29 Jun 2012 00:45:19 +0000"  >&lt;p&gt;Thanks for reporting this - and the SI reference.&lt;/p&gt;

&lt;p&gt;This likely affects 0.8 in other places as well:&lt;br/&gt;
git grep parseFull&lt;br/&gt;
core/src/main/scala/kafka/consumer/TopicCount.scala:        JSON.parseFull(topicCountString) match {&lt;br/&gt;
core/src/main/scala/kafka/server/StateChangeCommand.scala:      JSON.parseFull(requestJson) match {&lt;br/&gt;
core/src/main/scala/kafka/utils/ZkUtils.scala:        JSON.parseFull(jsonPartitionMap) match {&lt;/p&gt;</comment>
                            <comment id="13407248" author="junrao" created="Thu, 5 Jul 2012 16:29:06 +0000"  >&lt;p&gt;Thanks for the patch. In 0.7, the only usage of JSON is in TopicCount and all usages are called from ZookeeperConsumerConnector.rebalance, which is synchronized. So, it seems that we just need to create a new JSONParser instance per ZookeeperConsumerConnctor instance. Creating 1 JSONParser instance each time a parser is needed may be too expensive.&lt;/p&gt;</comment>
                            <comment id="13426764" author="junrao" created="Wed, 1 Aug 2012 17:38:20 +0000"  >&lt;p&gt;Attach patch v1 in 0.8. Just created a synchronized singleton that wraps scala JSON. Since json parsing is used rarely in Kafka, this is likely not a performance concern.&lt;/p&gt;</comment>
                            <comment id="13431304" author="jjkoshy" created="Wed, 8 Aug 2012 19:09:15 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13431309" author="nehanarkhede" created="Wed, 8 Aug 2012 19:14:40 +0000"  >&lt;p&gt;+1. Looks good.&lt;/p&gt;</comment>
                            <comment id="13431329" author="jjkoshy" created="Wed, 8 Aug 2012 19:49:53 +0000"  >&lt;p&gt;Forgot to add - can we get this patched on trunk as well?&lt;/p&gt;</comment>
                            <comment id="13440464" author="junrao" created="Thu, 23 Aug 2012 17:16:36 +0000"  >&lt;p&gt;Thanks for the review. Rebased and committed to 0.8. Will port to 0.7.&lt;/p&gt;</comment>
                            <comment id="13450034" author="velvia" created="Thu, 6 Sep 2012 20:52:21 +0000"  >&lt;p&gt;Do you guys want a patch for 0.6?   I just created one and can attach it.   I know, we should really upgrade to 0.7.&lt;/p&gt;</comment>
                            <comment id="13450119" author="junrao" created="Thu, 6 Sep 2012 22:45:20 +0000"  >&lt;p&gt;Evan,&lt;/p&gt;

&lt;p&gt;The 0.6 release is pre Apache. So, we won&apos;t be able to patch it. Sorry.&lt;/p&gt;</comment>
                            <comment id="13457604" author="junrao" created="Tue, 18 Sep 2012 05:06:08 +0000"  >&lt;p&gt;Patched and committed to trunk too.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12533891" name="TopicCount.scala.diff" size="2198" author="baroquebobcat" created="Thu, 28 Jun 2012 21:26:06 +0000"/>
                            <attachment id="12538804" name="kafka-379_0.8_v1.patch" size="8350" author="junrao" created="Wed, 1 Aug 2012 17:38:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>292177</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rs9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160224</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>