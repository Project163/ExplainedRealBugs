<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:53:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3488] commitAsync() fails if metadata update creates new SASL/SSL connection</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3488</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Sasl/SslConsumerTest.testSimpleConsumption() fails intermittently with a failure in &lt;tt&gt;commitAsync()&lt;/tt&gt;. The exception stack trace shows:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;kafka.api.SaslPlaintextConsumerTest.testSimpleConsumption FAILED&lt;br/&gt;
java.lang.AssertionError: expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;&lt;br/&gt;
	at org.junit.Assert.fail(Assert.java:88)&lt;br/&gt;
	at org.junit.Assert.failNotEquals(Assert.java:834)&lt;br/&gt;
	at org.junit.Assert.assertEquals(Assert.java:645)&lt;br/&gt;
	at org.junit.Assert.assertEquals(Assert.java:631)&lt;br/&gt;
	at kafka.api.BaseConsumerTest.awaitCommitCallback(BaseConsumerTest.scala:340)&lt;br/&gt;
	at kafka.api.BaseConsumerTest.testSimpleConsumption(BaseConsumerTest.scala:85)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have recreated this with some additional trace. The tests run with a very small metadata expiry interval, triggering metadata updates quite often. If a metadata request immediately following a &lt;tt&gt;commitAsync()&lt;/tt&gt; call creates a new SSL/SASL connection, &lt;tt&gt;ConsumerNetworkClient.poll&lt;/tt&gt; returns to process the connection handshake packets. Since &lt;tt&gt;ConsumerNetworkClient.poll&lt;/tt&gt; discards all unsent packets before returning from poll, this can result in the failure of the commit - the callback is invoked with &lt;tt&gt;SendFailedException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I understand that &lt;tt&gt;ConsumerNetworkClient.poll()&lt;/tt&gt; discards unsent packets rather than buffer them to keep the code simple. And perhaps it is ok to fail &lt;tt&gt;commitAsync&lt;/tt&gt; occasionally since the callback does indicate that the caller should retry. But it feels like an unnecessary limitation that requires error handling in client applications when there are no real failures and makes it much harder to test reliably. As special handling to fix issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3412&quot; title=&quot;Multiple commitAsync() calls causes SendFailedException in commit callback&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3412&quot;&gt;&lt;del&gt;KAFKA-3412&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2672&quot; title=&quot;SendFailedException when new consumer is run with SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2672&quot;&gt;&lt;del&gt;KAFKA-2672&lt;/del&gt;&lt;/a&gt; adds more complexity to the code anyway, and because it is much harder to debug failures that affect only SSL/SASL, it may be worth considering improving this behaviour.&lt;/p&gt;

&lt;p&gt;I will see if I can submit a PR for the specific issue I was seeing with the impact of handshakes on &lt;tt&gt;commitAsync()&lt;/tt&gt;, but I will be interested in views on improving the logic in &lt;tt&gt;ConsumerNetworkClient&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12954920">KAFKA-3488</key>
            <summary>commitAsync() fails if metadata update creates new SASL/SSL connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rsivaram">Rajini Sivaram</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Mar 2016 10:40:39 +0000</created>
                <updated>Tue, 17 May 2016 14:29:18 +0000</updated>
                            <resolved>Thu, 7 Apr 2016 22:49:30 +0000</resolved>
                                    <version>0.9.0.1</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15219731" author="ijuma" created="Thu, 31 Mar 2016 10:47:08 +0000"  >&lt;p&gt;Good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt;. Thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15220272" author="hachikuji" created="Thu, 31 Mar 2016 17:30:26 +0000"  >&lt;p&gt;This has come up a few times in slightly different scenarios, so it&apos;s definitely worth fixing. A few options come to mind:&lt;/p&gt;

&lt;p&gt;1. The current behavior is basically a consequence of the fact that NetworkClient only accepts one request send for each connection on each invocation of poll(). If it supported multiple request sends, then we wouldn&apos;t have to touch ConsumerNetworkClient. For the consumer, requests are usually tiny, so we ought to be able to send a bunch of them at once.&lt;br/&gt;
2. We can have ConsumerNetworkClient &quot;try harder&quot; to get the requests out. Instead of throwing on the first send failure, we can have it go back into poll(). This should clear the pending request send in NetworkClient so that another can be sent. This is actually how it was written initially, so you can look back at the history to see what that looked like. I don&apos;t recall whether there was a great reason to change it, but I think we were concerned about the overhead from multiple iterations of poll().&lt;br/&gt;
3. We can reschedule the async commit to be sent later. Because send failure remains a possibility even with the above fixes, this is really the only way to guarantee that a commit eventually will get sent. Unfortunately, it introduces the possibility of commit reordering, so we need an approach to deal with that (e.g. sequence numbers).&lt;/p&gt;

&lt;p&gt;Among the these options, (2) probably has the least risk, but it might be worthwhile seeing what (1) would look like. There may be other options as well that I haven&apos;t thought of. &lt;/p&gt;</comment>
                            <comment id="15220416" author="rsivaram" created="Thu, 31 Mar 2016 18:34:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; Thank you for the feedback. I was thinking along the lines of 2) since it felt like the simplest change. I will take a look at the commits to see if I can reuse the code. I will look into 1) as well. Thanks.&lt;/p&gt;</comment>
                            <comment id="15223872" author="githubbot" created="Mon, 4 Apr 2016 09:36:39 +0000"  >&lt;p&gt;GitHub user rajinisivaram opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1183&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3488&quot; title=&quot;commitAsync() fails if metadata update creates new SASL/SSL connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3488&quot;&gt;&lt;del&gt;KAFKA-3488&lt;/del&gt;&lt;/a&gt;: Avoid failing of unsent requests in consumer where possible&lt;/p&gt;

&lt;p&gt;    Fail unsent requests only when returning from KafkaConsumer.poll().&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rajinisivaram/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rajinisivaram/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3488&quot; title=&quot;commitAsync() fails if metadata update creates new SASL/SSL connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3488&quot;&gt;&lt;del&gt;KAFKA-3488&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1183.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1183.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1183&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit dfad7b0215573800bed56abd3bcc2cf7f6134513&lt;br/&gt;
Author: Rajini Sivaram &amp;lt;rajinisivaram@googlemail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-04T08:38:27Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3488&quot; title=&quot;commitAsync() fails if metadata update creates new SASL/SSL connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3488&quot;&gt;&lt;del&gt;KAFKA-3488&lt;/del&gt;&lt;/a&gt;: Avoid failing of unsent requests in consumer where possible&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15231278" author="ewencp" created="Thu, 7 Apr 2016 22:49:30 +0000"  >&lt;p&gt;Issue resolved by pull request 1183&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1183&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15231279" author="githubbot" created="Thu, 7 Apr 2016 22:49:43 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1183&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15231326" author="guozhang" created="Thu, 7 Apr 2016 23:25:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; I think the original motivation for having the simpler behavior of failing all the rest after the loop is that if there is one request that un-succeeds to be sent, retrying would cause later requests for the same destination blocking until it either succeeds or timed out (which could take long time). Would that still be a problem?&lt;/p&gt;</comment>
                            <comment id="15232311" author="rsivaram" created="Fri, 8 Apr 2016 15:10:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Since requests from the consumer tend to be small, the impact of retrying sends shouldn&apos;t be too bad. When sends to a destination are unblocked, it would typically be possible to send another batch of buffered requests.&lt;/p&gt;</comment>
                            <comment id="15236348" author="hachikuji" created="Tue, 12 Apr 2016 00:46:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Sorry for the late response. I thought about that issue too. I don&apos;t see any problems for fetches since we currently only allow one pending request per connection. Maybe there are cases where we end up unnecessarily retrying a failed fetch after a position has been updated, but usually we&apos;d expect the fetch to be sent quickly or fail from a disconnect, so it doesn&apos;t feel like a case worth optimizing for. For requests to the coordinator, it might be possible for a bunch of asynchronous commits could pile up and prevent a needed join group from being sent. This situation is hard to avoid generally even without this patch because offset commits are so small and many can be sent at once. I think it&apos;s probably unlikely to hit this in practice unless you&apos;re sending commits at a high rate. I was more concerned about requests to the old coordinator being sent after we had already failed over to the new coordinator, but the patch included logic to cancel unsent requests whenever the coordinator is marked dead. Are there any other concerns?&lt;/p&gt;</comment>
                            <comment id="15236357" author="guozhang" created="Tue, 12 Apr 2016 00:50:40 +0000"  >&lt;p&gt;That is good. My previous concern does not actually exist.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vg9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>hachikuji</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>