<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:53:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-2960] DelayedProduce may cause message loss during repeated leader change</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-2960</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;related to #&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1148&quot; title=&quot;Delayed fetch/producer requests should be satisfied on a leader change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1148&quot;&gt;&lt;del&gt;KAFKA-1148&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
When a leader replica became follower then leader again, it may truncated its log as follower. But the second time it became leader, its ISR may shrink and if at this moment new messages were appended, the DelayedProduce generated when it was leader the first time may be satisfied, and the client will receive a response with no error. But, actually the messages were lost. &lt;/p&gt;

&lt;p&gt;We simulated this scene, which proved the message lose could happen. And it seems to be the reason for a data lose recently happened to us according to broker logs and client logs.&lt;/p&gt;

&lt;p&gt;I think we should check the leader epoch when send a response, or satisfy DelayedProduce when leader change as described in #&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1148&quot; title=&quot;Delayed fetch/producer requests should be satisfied on a leader change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1148&quot;&gt;&lt;del&gt;KAFKA-1148&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;And we may need an new error code to inform the producer about this error. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12920026">KAFKA-2960</key>
            <summary>DelayedProduce may cause message loss during repeated leader change</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="peoplebike">Xing Huang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Dec 2015 10:08:57 +0000</created>
                <updated>Fri, 11 Mar 2016 19:22:50 +0000</updated>
                            <resolved>Fri, 11 Mar 2016 19:22:44 +0000</resolved>
                                    <version>0.9.0.0</version>
                                    <fixVersion>0.10.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15047198" author="becket_qin" created="Tue, 8 Dec 2015 18:27:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iBuddha&quot; class=&quot;user-hover&quot; rel=&quot;iBuddha&quot;&gt;iBuddha&lt;/a&gt; In Kafka, the persistence guarantee are at different levels. Would the following settings solve the scenario you mentioned?&lt;br/&gt;
acks=-1&lt;br/&gt;
min.isr=2&lt;br/&gt;
replication factor &amp;gt; 2&lt;/p&gt;

&lt;p&gt;This should guarantee when response was sent, at least two brokers in the ISR has persisted the messages. So there should be no message loss unless the entire cluster is down.&lt;/p&gt;</comment>
                            <comment id="15047753" author="peoplebike" created="Wed, 9 Dec 2015 00:17:59 +0000"  >&lt;p&gt;The Partition class  check log end offset and current ISR to decide if there&apos;s enough replicas. But after a leader become follower, it may truncate its log, and if it became leader again very quickly, there is a chance that another client sent messages to it, so the LEO will increase, and the current ISR has changed to 2, so the DelayedProduce is satisfied, even acks=-1 and min.isr=2 and replica.factor=3&lt;/p&gt;</comment>
                            <comment id="15047825" author="becket_qin" created="Wed, 9 Dec 2015 01:19:16 +0000"  >&lt;p&gt;Not sure I follow the issue, in that case the ProducerRequest to the new leader will sit in Purgatory until the new follower have the message.&lt;/p&gt;</comment>
                            <comment id="15048115" author="guozhang" created="Wed, 9 Dec 2015 06:13:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; I think the issue here is that when a broker becomes follower, its delayed produce request does NOT get cleaned and returned an error code to the producer, but will still sit in the purgatory. If its producer timeout is long enough to not being timed out, it can be incorrectly satisfied when the follower becomes leader again. For example let&apos;s say we have two brokers:&lt;/p&gt;

&lt;p&gt;Broker 1 is the leader with its current LEO 50, HW 50.&lt;br/&gt;
Broker 2 is follower with current LEO 50, HW 50.&lt;/p&gt;

&lt;p&gt;1) broker 1 gets one message &quot;a&quot; with ack = all and append with offset 51, and its LEO is 51.&lt;br/&gt;
2) this produce request sit in the purgatory for broker 2 to replicate.&lt;br/&gt;
3) broker 1 becomes the follower and broker 2 becomes leader.&lt;br/&gt;
4) broker 1 sees broker 2&apos;s HW is 50, so it will truncate out message &quot;a&quot; and reset its LEO to 50.&lt;br/&gt;
5) broker 1 becomes leader again and broker 2 becomes follower again.&lt;br/&gt;
6) broker 1 gets another message &quot;b&quot;, append with offset 51.&lt;br/&gt;
7) broker 2 replicates message &quot;b&quot;.&lt;br/&gt;
8) broker 1 now advanced its HW to 51, and satisfying both produce requests for &quot;a&quot; and &quot;b&quot; based on the offset, but &quot;a&quot; is actually truncated.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peoplebike&quot; class=&quot;user-hover&quot; rel=&quot;peoplebike&quot;&gt;peoplebike&lt;/a&gt; I&apos;m wondering in your case, what is the produce request timeout value to trigger this issue? And how long did you observe the original leader to transit to follower and back to leader again?&lt;/p&gt;</comment>
                            <comment id="15048206" author="peoplebike" created="Wed, 9 Dec 2015 07:30:09 +0000"  >&lt;p&gt;We use Kafka 0.8.2. The produce request timeout is the default value, which is 10000ms.&lt;br/&gt;
At 40:07, controller did a preferred leader election, sent LeaderAndIsrRequest to replicas. Just one or two seconds later, it found the broker hosted the new leader failed. So, the controller did another leader election, and send the second batch of LeaderAndIsrRequests.&lt;br/&gt;
At 40:11, the related replicas processed the first LeaderAndIsrRequest.&lt;br/&gt;
At 40:12, they processed the second LeaderAndIsrRequest.&lt;br/&gt;
So, the original leader experienced a leader -&amp;gt; follower -&amp;gt; leader change in just two seconds, I think. &lt;/p&gt;</comment>
                            <comment id="15049028" author="becket_qin" created="Wed, 9 Dec 2015 17:37:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Got it. Thanks for the explanation.&lt;/p&gt;</comment>
                            <comment id="15182552" author="githubbot" created="Mon, 7 Mar 2016 04:08:46 +0000"  >&lt;p&gt;GitHub user becketqin opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1018&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2960&quot; title=&quot;DelayedProduce may cause message loss during repeated leader change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2960&quot;&gt;&lt;del&gt;KAFKA-2960&lt;/del&gt;&lt;/a&gt;: Clear purgatory for partitions before becoming follower&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/becketqin/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/becketqin/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2960&quot; title=&quot;DelayedProduce may cause message loss during repeated leader change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2960&quot;&gt;&lt;del&gt;KAFKA-2960&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1018.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1018.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1018&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6ee590bc8f65217227c8bda98644dce35ed0d701&lt;br/&gt;
Author: Jiangjie Qin &amp;lt;becket.qin@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-03-07T04:04:45Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-2960&quot; title=&quot;DelayedProduce may cause message loss during repeated leader change&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-2960&quot;&gt;&lt;del&gt;KAFKA-2960&lt;/del&gt;&lt;/a&gt;: Clear purgatory for partition before becoming follower&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15191414" author="jjkoshy" created="Fri, 11 Mar 2016 19:22:44 +0000"  >&lt;p&gt;Issue resolved by pull request 1018&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/1018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1018&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15191416" author="githubbot" created="Fri, 11 Mar 2016 19:22:50 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1018&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2plav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>