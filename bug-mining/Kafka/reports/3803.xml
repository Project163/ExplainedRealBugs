<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15305] The background thread should try to process the remaining task until the shutdown timer is expired</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15305</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;While working on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-15304&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-15304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;close() API supplies a timeout parameter so that the consumer can have a grace period to process things before shutting down.&#160; The background thread currently doesn&apos;t do that, when close() is initiated, it will immediately close all of its dependencies.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This might not be desirable because there could be remaining tasks to be processed before closing.&#160; Maybe the correct things to do is to first stop accepting API request, second, let the runOnce() continue to run before the shutdown timer expires, then we can force closing all of its dependencies.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13546182">KAFKA-15305</key>
            <summary>The background thread should try to process the remaining task until the shutdown timer is expired</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="pnee">Philip Nee</reporter>
                        <labels>
                            <label>consumer-threading-refactor</label>
                            <label>timeout</label>
                    </labels>
                <created>Fri, 4 Aug 2023 18:39:26 +0000</created>
                <updated>Tue, 4 Jun 2024 20:28:23 +0000</updated>
                            <resolved>Tue, 4 Jun 2024 20:28:06 +0000</resolved>
                                                    <fixVersion>3.8.0</fixVersion>
                                    <component>clients</component>
                    <component>consumer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17850505" author="chia7712" created="Wed, 29 May 2024 21:27:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16639&quot; title=&quot;AsyncKafkaConsumer#close does not send heartbeat to leave group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16639&quot;&gt;&lt;del&gt;KAFKA-16639&lt;/del&gt;&lt;/a&gt; needs this ticket to fix root cause. As this ticket described, `ConsumerNetworkThread` does not honor the close timeout. Even though we put a heartbeat request to leave group, `ConsumerNetworkThread` will move it to `NetworkClient` and then exit the waiting ...&lt;/p&gt;

&lt;p&gt;It seems to me the simple solution is to add a method &quot;hasInFlightRequests&quot; to &quot;networkClientDelegate&quot;, and then we change the while condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; from &quot;timer.notExpired() &amp;amp;&amp;amp; !networkClientDelegate.unsentRequests().isEmpty()&quot; to following condition&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasPendingRequessts() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; client.hasInFlightRequests() || !networkClientDelegate.unsentRequests().isEmpty()
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
            networkClientDelegate.poll(timer.remainingMs(), timer.currentTimeMs());
            timer.update();
        } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (timer.notExpired() &amp;amp;&amp;amp; networkClientDelegate.hasPendingRequessts());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; WDYT? &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/kafka/blob/cc269b0d438534ae8fef16b39354da1d78332a2c/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/cc269b0d438534ae8fef16b39354da1d78332a2c/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L301&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17850511" author="chia7712" created="Wed, 29 May 2024 22:07:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt; As you unassign this ticket, I take over this one and will file PR according to above solution.&lt;/p&gt;</comment>
                            <comment id="17850778" author="JIRAUSER300183" created="Thu, 30 May 2024 15:57:16 +0000"  >&lt;p&gt;Agree with this missing bit, but I wonder if we need a bit more than just &quot;wait for pending requests&quot;, because I don&apos;t see that we&apos;ll ever generate one on the close situation. With &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16639&quot; title=&quot;AsyncKafkaConsumer#close does not send heartbeat to leave group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16639&quot;&gt;&lt;del&gt;KAFKA-16639&lt;/del&gt;&lt;/a&gt; we ensure that HB request to leave is created, but that happens only IF the HB manager is polled when closing the consumer. On close, looks to me that may not happen, because &lt;a href=&quot;https://github.com/apache/kafka/blob/32b2b73f673ecd41d17c03e99db3746c517990c4/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1232&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; is where the close operation triggers the leave event (that will just leave the state machine indicating LEAVING, to be used by the HB manager next poll), but right after we shutdown the network thread &lt;a href=&quot;https://github.com/apache/kafka/blob/32b2b73f673ecd41d17c03e99db3746c517990c4/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, so not polling managers anymore. At this point, even with the inflight suggestion above, the networkClient.poll &lt;a href=&quot;https://github.com/apache/kafka/blob/cc269b0d438534ae8fef16b39354da1d78332a2c/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; would return empty I expect. &lt;/p&gt;

&lt;p&gt;So seems we also need to make sure that the HB manager is actually polled when closing the consumer (the HBManager.pollOnClose you had suggested at some point). With that, at &lt;a href=&quot;https://github.com/apache/kafka/blob/cc269b0d438534ae8fef16b39354da1d78332a2c/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L216-L217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; point we would actually generate the HB to leave, add then we would hit the logic you mentioned above with a request to send (not empty), &lt;a href=&quot;https://github.com/apache/kafka/blob/cc269b0d438534ae8fef16b39354da1d78332a2c/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Makes sense?&lt;/p&gt;</comment>
                            <comment id="17850834" author="chia7712" created="Thu, 30 May 2024 18:36:22 +0000"  >&lt;blockquote&gt;
&lt;p&gt;So seems we also need to make sure that the HB manager is actually polled when closing the consumer (the HBManager.pollOnClose you had suggested at some point)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yep, I prefer to return HB of leaving group by `pollOnClose` and that is the description I written in &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16639&quot; title=&quot;AsyncKafkaConsumer#close does not send heartbeat to leave group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16639&quot;&gt;&lt;del&gt;KAFKA-16639&lt;/del&gt;&lt;/a&gt;. Also, I agree the solution of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16639&quot; title=&quot;AsyncKafkaConsumer#close does not send heartbeat to leave group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16639&quot;&gt;&lt;del&gt;KAFKA-16639&lt;/del&gt;&lt;/a&gt; PR as in the current flow the HB of leaving group can be generated.&lt;/p&gt;

&lt;p&gt;thread of closing consumer&lt;/p&gt;

&lt;p&gt;1. prepareShutdown (&lt;a href=&quot;https://github.com/apache/kafka/blob/32b2b73f673ecd41d17c03e99db3746c517990c4/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/32b2b73f673ecd41d17c03e99db3746c517990c4/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1268&lt;/a&gt;)&lt;br/&gt;
2. waiting for `LeaveOnCloseEvent` (&lt;a href=&quot;https://github.com/apache/kafka/blob/32b2b73f673ecd41d17c03e99db3746c517990c4/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/32b2b73f673ecd41d17c03e99db3746c517990c4/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1279&lt;/a&gt;)&lt;br/&gt;
3. call ConsumerNetworkThread#close to stop the loop of ConsumerNetworkThread#run() (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L281&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;network thread (ConsumerNetworkThread)&lt;/p&gt;

&lt;p&gt;1.  processApplicationEvents (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L138&lt;/a&gt;). This method must be executed to handle `LeaveOnCloseEvent`&lt;br/&gt;
2. After `processApplicationEvents` (LeaveOnCloseEvent), `membershipManager.leaveGroup` is executed so ConsumerNetworkThread is aware of &quot;leaving&quot;&lt;br/&gt;
3. After `processApplicationEvents`, ConsumerNetworkThread will call HB manager poll sequentially (&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/ConsumerNetworkThread.java#L144&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;In short, ConsumerNetworkThread always call the HB manager poll after handling LeaveOnCloseEvent.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;With that, at this point we would actually generate the HB to leave, add then we would hit the logic you mentioned above with a request to send (not empty), here. Makes sense?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Both ways (poll/pollOnClose) can resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-16639&quot; title=&quot;AsyncKafkaConsumer#close does not send heartbeat to leave group&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-16639&quot;&gt;&lt;del&gt;KAFKA-16639&lt;/del&gt;&lt;/a&gt;. I feel your comment (&lt;a href=&quot;https://github.com/apache/kafka/pull/16017#discussion_r1612039771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/16017#discussion_r1612039771&lt;/a&gt;) is a simple solution, and so I did not add comment to say &quot;we must to create HB request in pollOnClose)&lt;/p&gt;
</comment>
                            <comment id="17851115" author="JIRAUSER300183" created="Fri, 31 May 2024 14:05:29 +0000"  >&lt;p&gt;Makes sense, I was concerned about the actual poll just because I briefly forgot that the close blocks on the LeaveGroupEvent &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1287.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AsyncKafkaConsumer.java#L1287.&lt;/a&gt; This is the magic bit. It means that before shutting down the network thread we ensure the HB manager poll and the request added to the network thread (done sequentially as your point 3). All good.&#160;&lt;/p&gt;</comment>
                            <comment id="17852183" author="chia7712" created="Tue, 4 Jun 2024 20:28:06 +0000"  >&lt;p&gt;push to trunk and 3.8&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13577493">KAFKA-16639</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jlk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>