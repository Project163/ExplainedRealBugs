<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:16:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7657] Invalid reporting of stream state in Kafka streams application</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7657</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have a streams application with 3 instances running, two of which are reporting the state of REBALANCING even after they have been running for days. Restarting the application has no effect on the stream state.&lt;/p&gt;

&lt;p&gt;This seems suspect because each instance appears to be processing messages, and the kafka-consumer-groups CLI tool reports hardly any offset lag in any of the partitions assigned to the REBALANCING consumers. Each partition seems to be processing an equal amount of records too.&lt;/p&gt;

&lt;p&gt;Inspecting the state.dir on disk, it looks like the RocksDB state has been built and hovers at the expected size on disk.&lt;/p&gt;

&lt;p&gt;This problem has persisted for us after we rebuilt our Kafka cluster and reset topics + consumer groups in our dev environment.&lt;/p&gt;

&lt;p&gt;There is nothing in the logs (with level set to DEBUG) in both the broker or the application that suggests something exceptional has happened causing the application to be stuck REBALANCING.&lt;/p&gt;

&lt;p&gt;We are also running multiple streaming applications where this problem does not exist.&lt;/p&gt;

&lt;p&gt;Two differences between this application and our other streaming applications are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We have processing.guarantee set to exactly_once&lt;/li&gt;
	&lt;li&gt;We are using a ValueTransformer which fetches from and puts data on a windowed state store&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The REBALANCING state is returned from both polling the state method of our KafkaStreams instance, and our custom metric which is derived from some logic in a KafkaStreams.StateListener class attached via the setStateListener method.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;While I have provided a bit of context, before I reply with some reproducible code - is there a simple way in which I can determine that my streams application is in a RUNNING state without relying on the same mechanisms as used above?&lt;/p&gt;

&lt;p&gt;Further, given that it seems like my application is actually running - could this perhaps be a bug to do with how the stream state is being reported (in the context of a transactional stream using the processor API)?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13199516">KAFKA-7657</key>
            <summary>Invalid reporting of stream state in Kafka streams application</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="guozhang">Guozhang Wang</assignee>
                                    <reporter username="tscrowley">Thomas Crowley</reporter>
                        <labels>
                            <label>bug</label>
                    </labels>
                <created>Tue, 20 Nov 2018 05:37:18 +0000</created>
                <updated>Sat, 18 Apr 2020 21:32:43 +0000</updated>
                            <resolved>Sat, 5 Jan 2019 05:29:41 +0000</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16695186" author="guozhang" created="Wed, 21 Nov 2018 19:42:44 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tscrowley&quot; class=&quot;user-hover&quot; rel=&quot;tscrowley&quot;&gt;tscrowley&lt;/a&gt; Thanks for reporting this issue. The described situation does sound like a bug to me. And since you are already running on a pretty new version (2.0.1) this bug may well be existing in trunk as well.&lt;/p&gt;

&lt;p&gt;At the moment if the Streams state is not reliable reporting the status of your application, I&apos;d suggest using the consumer lag as a side-indicator of your application&apos;s &quot;healthness&quot;. And to investigate this issue, could you share with me steps to reproduce this issue, and also try to turn off EOS and see if the issue goes away? I doubt the transformer has anything to do with the bug, and hence the one that would be my suspicion is EOS config. And if turning off EOS can resolve the issue, it can help us narrowing down the investigation scope.&lt;/p&gt;</comment>
                            <comment id="16706877" author="pkleindl" created="Mon, 3 Dec 2018 09:28:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; It seems we are seeing the same behaviour here in one of our environments.&lt;/p&gt;

&lt;p&gt;Version is&#160;2.0.0-cp1, EOS is not enabled.&lt;/p&gt;

&lt;p&gt;Stream applications are running on two hosts each, on each of them I currently see one (but not the same) stream application reporting REBALANCING.&lt;/p&gt;

&lt;p&gt;I have suggested to the customer to open a Confluent support ticket.&lt;/p&gt;</comment>
                            <comment id="16707585" author="guozhang" created="Mon, 3 Dec 2018 17:44:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt; could you provide the logs around the time when the stream application has started to report REBALANCING so we can investigate?&lt;/p&gt;</comment>
                            <comment id="16710573" author="pkleindl" created="Wed, 5 Dec 2018 20:03:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have tried to grab the relevant part of the log and remove all client references, not much to be seen.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-30 08:50:06,885 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Group coordinator broker:9092 (id: 2147483644 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) is unavailable or invalid, will attempt rediscovery
2018-11-30 08:50:06,986 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Discovered group coordinator broker:9092 (id: 2147483644 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
2018-11-30 08:50:06,986 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Group coordinator broker:9092 (id: 2147483644 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) is unavailable or invalid, will attempt rediscovery
2018-11-30 08:50:07,087 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Discovered group coordinator broker:9092 (id: 2147483644 rack: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
2018-11-30 09:08:45,717 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Attempt to heartbeat failed since group is rebalancing
2018-11-30 09:08:45,749 INFO [org.apache.kafka.clients.consumer.internals.ConsumerCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Revoking previously assigned partitions [...]
2018-11-30 09:08:45,750 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-thread [client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 09:08:45,750 INFO [org.apache.kafka.streams.KafkaStreams] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-client [client-610151c7-8769-4cc5-9254-969a831e4a4d] State transition from RUNNING to REBALANCING
2018-11-30 09:08:45,865 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-thread [client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] partition revocation took 115 ms.
2018-11-30 09:08:45,865 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] (Re-)joining group
2018-11-30 09:08:47,544 INFO [org.apache.kafka.clients.consumer.internals.AbstractCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Successfully joined group with generation 3374
2018-11-30 09:08:47,547 INFO [org.apache.kafka.clients.consumer.internals.ConsumerCoordinator] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... [Consumer clientId=client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16-consumer, groupId=client-appname] Setting newly assigned partitions [...]
2018-11-30 09:08:47,547 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-thread [client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 09:08:47,574 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-thread [client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] partition assignment took 27 ms.
2018-11-30 09:08:47,874 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-thread [client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] State transition from PARTITIONS_ASSIGNED to RUNNING
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After this line the state of the streams application was stuck at rebalancing for this node:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-30 09:08:45,750 INFO [org.apache.kafka.streams.KafkaStreams] (client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - ... stream-client [client-610151c7-8769-4cc5-9254-969a831e4a4d] State transition from RUNNING to REBALANCING&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16710842" author="guozhang" created="Thu, 6 Dec 2018 01:18:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt; Seems you have at least 16 because &quot;client-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16&quot;, could you grab for the keywords of &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
State transition from
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which should include both thread-level state transition as well as application instance-level state transition. Note that the latter is what we observed the issue, i.e. it never transits back to RUNNING, but it should be as long as ALL of its threads have transited to RUNNING. So I&apos;d like to verify if:&lt;/p&gt;

&lt;p&gt;1) all threads have indeed transit back to RUNNING after rebalance.&lt;br/&gt;
2) if 1) is true, is there any transition happened for the application instance-level state.&lt;/p&gt;</comment>
                            <comment id="16710864" author="guozhang" created="Thu, 6 Dec 2018 01:37:22 +0000"  >&lt;p&gt;Another question for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tscrowley&quot; class=&quot;user-hover&quot; rel=&quot;tscrowley&quot;&gt;tscrowley&lt;/a&gt;: in your topology, do you have any global stores / GlobalKTable?&lt;/p&gt;</comment>
                            <comment id="16711247" author="pkleindl" created="Thu, 6 Dec 2018 10:32:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-30 08:58:25,560 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 08:58:25,561 INFO [org.apache.kafka.streams.KafkaStreams] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11) - stream-client [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e] State transition from RUNNING to REBALANCING
2018-11-30 08:58:25,630 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-10) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-10] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 08:58:25,638 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-9) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-9] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 08:58:25,885 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 08:58:28,238 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 08:58:28,238 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-9) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-9] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 08:58:28,249 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-10) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-10] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 08:58:28,279 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 08:58:28,505 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-11] State transition from PARTITIONS_ASSIGNED to RUNNING
2018-11-30 08:58:29,664 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-10) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-10] State transition from PARTITIONS_ASSIGNED to RUNNING
2018-11-30 08:58:33,300 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-9) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-9] State transition from PARTITIONS_ASSIGNED to RUNNING
2018-11-30 08:58:34,490 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12) - stream-thread [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12] State transition from PARTITIONS_ASSIGNED to RUNNING
2018-11-30 08:58:34,491 INFO [org.apache.kafka.streams.KafkaStreams] (application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e-StreamThread-12) - stream-client [application-ab20ef7d-6de2-4335-a8ce-4cb81d01fb7e] State transition from REBALANCING to RUNNING
2018-11-30 09:08:14,273 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15] State transition from RUNNING to PENDING_SHUTDOWN
2018-11-30 09:08:14,715 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15] State transition from PENDING_SHUTDOWN to DEAD
2018-11-30 09:08:45,750 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 09:08:45,750 INFO [org.apache.kafka.streams.KafkaStreams] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - stream-client [application-610151c7-8769-4cc5-9254-969a831e4a4d] State transition from RUNNING to REBALANCING
2018-11-30 09:08:46,928 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-14) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-14] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 09:08:47,301 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-13) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-13] State transition from RUNNING to PARTITIONS_REVOKED
2018-11-30 09:08:47,546 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-14) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-14] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 09:08:47,547 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 09:08:47,549 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-13) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-13] State transition from PARTITIONS_REVOKED to PARTITIONS_ASSIGNED
2018-11-30 09:08:47,776 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-13) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-13] State transition from PARTITIONS_ASSIGNED to RUNNING
2018-11-30 09:08:47,779 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-14) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-14] State transition from PARTITIONS_ASSIGNED to RUNNING
2018-11-30 09:08:47,874 INFO [org.apache.kafka.streams.processor.internals.StreamThread] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16) - stream-thread [application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-16] State transition from PARTITIONS_ASSIGNED to RUNNING

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;StreamThread-15 died because of this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - You can increase producer parameter `retries` and `retry.backoff.ms` to avoid &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; error.
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.recordSendError(RecordCollectorImpl.java:130)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.streams.processor.internals.RecordCollectorImpl.access$500(RecordCollectorImpl.java:50)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.streams.processor.internals.RecordCollectorImpl$1.onCompletion(RecordCollectorImpl.java:189)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.KafkaProducer$InterceptorCallback.onCompletion(KafkaProducer.java:1253)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.ProducerBatch.completeFutureAndFireCallbacks(ProducerBatch.java:204)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.ProducerBatch.done(ProducerBatch.java:187)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.failBatch(Sender.java:640)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.failBatch(Sender.java:609)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:566)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.handleProduceResponse(Sender.java:490)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.access$100(Sender.java:74)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender$1.onComplete(Sender.java:705)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.ClientResponse.onComplete(ClientResponse.java:109)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.NetworkClient.completeResponses(NetworkClient.java:532)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:524)
2018-11-30 09:08:14,716 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:244)
2018-11-30 09:08:14,717 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:168)
2018-11-30 09:08:14,717 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
2018-11-30 09:08:14,717 ERROR [stderr] (application-610151c7-8769-4cc5-9254-969a831e4a4d-StreamThread-15) - Caused by: org.apache.kafka.common.errors.NotLeaderForPartitionException: This server is not the leader &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; that topic-partition.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But as the application kept running it should be fine anyway, shouldn&apos;t it? And a rebalance should be visible on the other instance too?&lt;/p&gt;

&lt;p&gt;As far as I can see, for this streams application there are no global state stores.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16711839" author="guozhang" created="Thu, 6 Dec 2018 18:36:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkleindl&quot; class=&quot;user-hover&quot; rel=&quot;pkleindl&quot;&gt;pkleindl&lt;/a&gt; I think I&apos;ve spotted the root cause of your issue. Here s a brief summary:&lt;/p&gt;

&lt;p&gt;1) During the time of &lt;tt&gt;2018-11-30 09:08:14&lt;/tt&gt; there is a broker-side leader migration, which caused Streams&apos; embedded producers to get &lt;tt&gt;NotLeaderForPartitionException&lt;/tt&gt;. This error is not a fatal error but retriable. The producer will retry based on the configured number of retries and backoffs. In 2.0.1 that you and  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tscrowley&quot; class=&quot;user-hover&quot; rel=&quot;tscrowley&quot;&gt;tscrowley&lt;/a&gt; is running, the default value is 10 and 100ms (in trunk and in the up coming 2.1.0 version we&apos;ve changed the default to int.MAX as part of KIP-91), which means that if you did not change that value, then if the broker side&apos;s metadata did not get refreshed in 10 * 100ms ~ 1 second the num.retries will be exhausted and it will be treated as fatal and cause the producer to throw.&lt;/p&gt;

&lt;p&gt;2) When producer throws (which is the case from your logs), the corresponding stream thread (15 in your case) will be shutdown gracefully, and its tasks are migrated to other threads. And I think after that the broker side resumes normal so the other threads can proceed, i.e from then on the streams app instance is running with one thread less. But from outside this is still normal.&lt;/p&gt;

&lt;p&gt;3) The bug correlated to this scenario is that, when 2) happens we did not remove the corresponding thread-state from the map, and hence because this dangling state is never coming back to RUNNING, the application-instance-level state would never be transited. I can provide a PR for this issue.&lt;/p&gt;

&lt;p&gt;4) Atm, if you want to be notified if something similar happens which causes you to lose some threads within the application instance, you can either a) watch one the thread-level metrics, and alert when they&apos;ve gone black, or b) watch on the thread-level state as well, which can be read from KafkaStreams#localThreadMetadata.&lt;/p&gt;</comment>
                            <comment id="16712734" author="pkleindl" created="Fri, 7 Dec 2018 11:54:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; Thanks for the fast analysis. It is not a major problem for us currently, so a fix in an upcoming 2.0.x or 2.1 would be sufficient.&lt;/p&gt;

&lt;p&gt;As you guessed correctly the retries is set to 10 and I will increase it to hopefully prevent such a problem.&lt;/p&gt;</comment>
                            <comment id="16714156" author="githubbot" created="Sun, 9 Dec 2018 23:21:38 +0000"  >&lt;p&gt;guozhangwang opened a new pull request #6018: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7657&quot; title=&quot;Invalid reporting of stream state in Kafka streams application&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7657&quot;&gt;&lt;del&gt;KAFKA-7657&lt;/del&gt;&lt;/a&gt;: Fixing thread state change to instance state change&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6018&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   While looking into &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7657&quot; title=&quot;Invalid reporting of stream state in Kafka streams application&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7657&quot;&gt;&lt;del&gt;KAFKA-7657&lt;/del&gt;&lt;/a&gt;, I found there are a few loopholes in this logic:&lt;/p&gt;

&lt;p&gt;   1. We kept a map of thread-name to thread-state and a global-thread state at the KafkaStreams instance-level, in addition to the instance state itself. `stateLock` is used when accessing the instance state, however when we are in the thread state change callback, we are accessing both the thread-states as well as the instance state at the same time in the callers of `setState` without a lock, which is vulnerable to concurrent multi-stream threads.&lt;/p&gt;

&lt;p&gt;   The fix is a) introduce a `threadStatesLock` in addition to the `stateLock`, which should always be grabbed to modify the thread-states map before the `stateLock` for modifying the instance level; and we also defer the checking of the instance-level state inside the `setState` call.&lt;/p&gt;

&lt;p&gt;   2. When transiting to state.RUNNING, we check if all threads are either in RUNNING or DEAD state, this is because some threads maybe dead at the rebalance period but we should still proceed to RUNNING if the rest of threads are still transiting to RUNNING.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16734639" author="githubbot" created="Fri, 4 Jan 2019 22:39:50 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6018: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7657&quot; title=&quot;Invalid reporting of stream state in Kafka streams application&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7657&quot;&gt;&lt;del&gt;KAFKA-7657&lt;/del&gt;&lt;/a&gt;: Fixing thread state change to instance state change&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6018&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16734642" author="githubbot" created="Fri, 4 Jan 2019 22:40:55 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6090: Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7657&quot; title=&quot;Invalid reporting of stream state in Kafka streams application&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7657&quot;&gt;&lt;del&gt;KAFKA-7657&lt;/del&gt;&lt;/a&gt;: Fixing thread state change to instance state change&quot;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6090&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Reverts apache/kafka#6018 because it lacks one final commit.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16734643" author="githubbot" created="Fri, 4 Jan 2019 22:41:18 +0000"  >&lt;p&gt;guozhangwang commented on pull request #6090: Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7657&quot; title=&quot;Invalid reporting of stream state in Kafka streams application&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7657&quot;&gt;&lt;del&gt;KAFKA-7657&lt;/del&gt;&lt;/a&gt;: Fixing thread state change to instance state change&quot;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6090&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16750278" author="wushujames" created="Wed, 23 Jan 2019 17:58:24 +0000"  >&lt;p&gt;This was fixed in &lt;a href=&quot;https://github.com/apache/kafka/pull/6091&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6091&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But the Jira didn&apos;t get updated/linked to it, because the title for that PR&#160;was &quot;K7657&quot; instead of &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7657&quot; title=&quot;Invalid reporting of stream state in Kafka streams application&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7657&quot;&gt;&lt;del&gt;KAFKA-7657&lt;/del&gt;&lt;/a&gt;&quot; /cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13173011">KAFKA-7181</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00onc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>