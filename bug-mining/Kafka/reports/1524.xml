<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:01:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5164] SetSchemaMetadata does not replace the schemas in structs correctly</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5164</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In SetSchemaMetadataTest we verify that the name and version of the schema in the record have been replaced:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/test/java/org/apache/kafka/connect/transforms/SetSchemaMetadataTest.java#L62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/test/java/org/apache/kafka/connect/transforms/SetSchemaMetadataTest.java#L62&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, in the case of Structs, the schema will be attached to both the record and the Struct itself. So we correctly rebuild the Record:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/SetSchemaMetadata.java#L77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/SetSchemaMetadata.java#L77&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/SetSchemaMetadata.java#L104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/SetSchemaMetadata.java#L104&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/SetSchemaMetadata.java#L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/SetSchemaMetadata.java#L119&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But if the key or value are a struct, they will still contain the old schema embedded in the struct.&lt;/p&gt;

&lt;p&gt;Ultimately this can lead to validations in other code failing (even for very simple changes like adjusting the name of a schema):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(org.apache.kafka.connect.runtime.WorkerTask:141)
org.apache.kafka.connect.errors.DataException: Mismatching struct schema
    at io.confluent.connect.avro.AvroData.fromConnectData(AvroData.java:471)
    at io.confluent.connect.avro.AvroData.fromConnectData(AvroData.java:295)
    at io.confluent.connect.avro.AvroConverter.fromConnectData(AvroConverter.java:73)
    at org.apache.kafka.connect.runtime.WorkerSourceTask.sendRecords(WorkerSourceTask.java:196)
    at org.apache.kafka.connect.runtime.WorkerSourceTask.execute(WorkerSourceTask.java:167)
    at org.apache.kafka.connect.runtime.WorkerTask.doRun(WorkerTask.java:139)
    at org.apache.kafka.connect.runtime.WorkerTask.run(WorkerTask.java:182)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The solution to this is probably to check whether we&apos;re dealing with a Struct when we use a new schema and potentially copy/reallocate it.&lt;/p&gt;

&lt;p&gt;This particular issue would only appear if we don&apos;t modify the data, so I think SetSchemaMetadata is currently the only transformation that would have the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13068545">KAFKA-5164</key>
            <summary>SetSchemaMetadata does not replace the schemas in structs correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhauch">Randall Hauch</assignee>
                                    <reporter username="ewencp">Ewen Cheslack-Postava</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 May 2017 20:49:18 +0000</created>
                <updated>Mon, 2 Aug 2021 15:13:32 +0000</updated>
                            <resolved>Fri, 2 Jun 2017 17:03:01 +0000</resolved>
                                    <version>0.10.2.1</version>
                                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>connect</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16033687" author="githubbot" created="Thu, 1 Jun 2017 21:00:14 +0000"  >&lt;p&gt;GitHub user rhauch opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3198&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5164&quot; title=&quot;SetSchemaMetadata does not replace the schemas in structs correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5164&quot;&gt;&lt;del&gt;KAFKA-5164&lt;/del&gt;&lt;/a&gt; Ensure SetSchemaMetadata updates key or value when Schema changes&lt;/p&gt;

&lt;p&gt;    When the `SetSchemaMetadata` SMT is used to change the name and/or version of the key or value&#8217;s schema, any references to the old schema in the key or value must be changed to reference the new schema. Only keys or values that are `Struct` have such references, and so currently only these are adjusted.&lt;/p&gt;

&lt;p&gt;    This is based on `trunk` since the fix is expected to be targeted to the 0.11.1 release.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/rhauch/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rhauch/kafka&lt;/a&gt; kafka-5164&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3198.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3198.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3198&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 68bf68b3df065437318e2a87a6d1181b1205a806&lt;br/&gt;
Author: Randall Hauch &amp;lt;rhauch@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-01T20:40:01Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5164&quot; title=&quot;SetSchemaMetadata does not replace the schemas in structs correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5164&quot;&gt;&lt;del&gt;KAFKA-5164&lt;/del&gt;&lt;/a&gt; Ensure SetSchemaMetadata updates key or value when Schema changes&lt;/p&gt;

&lt;p&gt;    When the `SetSchemaMetadata` SMT is used to change the name and/or version of the key or value&#8217;s schema, any references to the old schema in the key or value must be changed to reference the new schema. Only keys or values that are `Struct` have such references, and so currently only these are adjusted.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16035050" author="ewencp" created="Fri, 2 Jun 2017 17:03:01 +0000"  >&lt;p&gt;Issue resolved by pull request 3198&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3198&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16035053" author="githubbot" created="Fri, 2 Jun 2017 17:04:04 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3198&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17391645" author="jomach" created="Mon, 2 Aug 2021 15:13:32 +0000"  >&lt;p&gt;Actually not solved imho. See&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7883&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-7883&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3edxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>