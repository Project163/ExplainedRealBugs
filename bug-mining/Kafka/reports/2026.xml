<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:14:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7347] Wrong error code returned for OffsetsForLeaderEpoch from non-replica</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7347</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We should return NOT_LEADER_FOR_PARTITION from OffsetsForLeaderEpoch requests to non-replicas instead of UNKNOWN_TOPIC_OR_PARTITION.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13181211">KAFKA-7347</key>
            <summary>Wrong error code returned for OffsetsForLeaderEpoch from non-replica</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Sun, 26 Aug 2018 22:09:21 +0000</created>
                <updated>Tue, 28 Aug 2018 00:40:11 +0000</updated>
                            <resolved>Tue, 28 Aug 2018 00:40:11 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16593044" author="githubbot" created="Sun, 26 Aug 2018 22:20:48 +0000"  >&lt;p&gt;hachikuji opened a new pull request #5576: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7347&quot; title=&quot;Wrong error code returned for OffsetsForLeaderEpoch from non-replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7347&quot;&gt;&lt;del&gt;KAFKA-7347&lt;/del&gt;&lt;/a&gt;; Return not leader error OffsetsForLeaderEpoch requests to non-leaders&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5576&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Currently we do not return an error in the OffsetsForLeaderEpoch request for followers and for non-replicas, we return UNKNOWN_TOPIC_OR_PARTITION. We should return NOT_LEADER_FOR_PARTITION for both cases.&lt;/p&gt;

&lt;p&gt;   This patch also fixes a minor bug in the handling of ListOffsets request using the DEBUG replica id. We should return UNKNOWN_TOPIC_OR_PARTITION if the topic doesn&apos;t exist.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16594357" author="githubbot" created="Tue, 28 Aug 2018 00:39:47 +0000"  >&lt;p&gt;hachikuji closed pull request #5576: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7347&quot; title=&quot;Wrong error code returned for OffsetsForLeaderEpoch from non-replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7347&quot;&gt;&lt;del&gt;KAFKA-7347&lt;/del&gt;&lt;/a&gt;; Return not leader error OffsetsForLeaderEpoch requests to non-replicas&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5576&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/server/ReplicaManager.scala b/core/src/main/scala/kafka/server/ReplicaManager.scala&lt;br/&gt;
index 14e537e63db..59581e738cf 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/server/ReplicaManager.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/server/ReplicaManager.scala&lt;br/&gt;
@@ -35,7 +35,6 @@ import org.apache.kafka.common.errors._&lt;br/&gt;
 import org.apache.kafka.common.internals.Topic&lt;br/&gt;
 import org.apache.kafka.common.metrics.Metrics&lt;br/&gt;
 import org.apache.kafka.common.protocol.Errors&lt;br/&gt;
-import org.apache.kafka.common.protocol.Errors.&lt;/p&gt;
{KAFKA_STORAGE_ERROR, UNKNOWN_TOPIC_OR_PARTITION}
&lt;p&gt; import org.apache.kafka.common.record._&lt;br/&gt;
 import org.apache.kafka.common.requests.FetchResponse.AbortedTransaction&lt;br/&gt;
 import org.apache.kafka.common.requests.DescribeLogDirsResponse.&lt;/p&gt;
{LogDirInfo, ReplicaInfo}
&lt;p&gt;@@ -405,12 +404,18 @@ class ReplicaManager(val config: KafkaConfig,&lt;br/&gt;
         else&lt;br/&gt;
           partition.getReplica(brokerId).getOrElse(&lt;br/&gt;
             throw new ReplicaNotAvailableException(s&quot;Replica $brokerId is not available for partition $topicPartition&quot;))&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;case None =&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
+      case None if metadataCache.contains(topicPartition) =&amp;gt;&lt;br/&gt;
         throw new ReplicaNotAvailableException(s&quot;Replica $brokerId is not available for partition $topicPartition&quot;)&lt;br/&gt;
+&lt;br/&gt;
+      case None =&amp;gt;&lt;br/&gt;
+        throw new UnknownTopicOrPartitionException(s&quot;Partition $topicPartition doesn&apos;t exist&quot;)&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def getReplicaOrException(topicPartition: TopicPartition): Replica = getReplicaOrException(topicPartition, localBrokerId)&lt;br/&gt;
+  def getReplicaOrException(topicPartition: TopicPartition): Replica = 
{
+    getReplicaOrException(topicPartition, localBrokerId)
+  }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   def getLeaderReplicaIfLocal(topicPartition: TopicPartition): Replica =  {&lt;br/&gt;
     val (_, replica) = getPartitionAndLeaderReplicaIfLocal(topicPartition)&lt;br/&gt;
@@ -1475,11 +1480,15 @@ class ReplicaManager(val config: KafkaConfig,&lt;br/&gt;
       val epochEndOffset = getPartition(tp) match &lt;/p&gt;
{
         case Some(partition) =&amp;gt;
           if (partition eq ReplicaManager.OfflinePartition)
-            new EpochEndOffset(KAFKA_STORAGE_ERROR, UNDEFINED_EPOCH, UNDEFINED_EPOCH_OFFSET)
+            new EpochEndOffset(Errors.KAFKA_STORAGE_ERROR, UNDEFINED_EPOCH, UNDEFINED_EPOCH_OFFSET)
           else
             partition.lastOffsetForLeaderEpoch(leaderEpoch)
+
+        case None if metadataCache.contains(tp) =&amp;gt;
+          new EpochEndOffset(Errors.NOT_LEADER_FOR_PARTITION, UNDEFINED_EPOCH, UNDEFINED_EPOCH_OFFSET)
+
         case None =&amp;gt;
-          new EpochEndOffset(UNKNOWN_TOPIC_OR_PARTITION, UNDEFINED_EPOCH, UNDEFINED_EPOCH_OFFSET)
+          new EpochEndOffset(Errors.UNKNOWN_TOPIC_OR_PARTITION, UNDEFINED_EPOCH, UNDEFINED_EPOCH_OFFSET)
       }
&lt;p&gt;       tp -&amp;gt; epochEndOffset&lt;br/&gt;
     }&lt;br/&gt;
diff --git a/core/src/test/scala/integration/kafka/api/AdminClientIntegrationTest.scala b/core/src/test/scala/integration/kafka/api/AdminClientIntegrationTest.scala&lt;br/&gt;
index 20cf03829cb..672a6698c3f 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/integration/kafka/api/AdminClientIntegrationTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/integration/kafka/api/AdminClientIntegrationTest.scala&lt;br/&gt;
@@ -319,7 +319,7 @@ class AdminClientIntegrationTest extends IntegrationTestHarness with Logging {&lt;br/&gt;
       new AlterReplicaLogDirsOptions).values.asScala.values&lt;br/&gt;
     futures.foreach &lt;/p&gt;
{ future =&amp;gt;
       val exception = intercept[ExecutionException](future.get)
-      assertTrue(exception.getCause.isInstanceOf[ReplicaNotAvailableException])
+      assertTrue(exception.getCause.isInstanceOf[UnknownTopicOrPartitionException])
     }

&lt;p&gt;     createTopic(topic, numPartitions = 1, replicationFactor = serverCount)&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/AlterReplicaLogDirsRequestTest.scala b/core/src/test/scala/unit/kafka/server/AlterReplicaLogDirsRequestTest.scala&lt;br/&gt;
index e6fa1cb7d6e..e986805e2fd 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/server/AlterReplicaLogDirsRequestTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/AlterReplicaLogDirsRequestTest.scala&lt;br/&gt;
@@ -49,7 +49,7 @@ class AlterReplicaLogDirsRequestTest extends BaseRequestTest {&lt;br/&gt;
     // The response should show error REPLICA_NOT_AVAILABLE for all partitions&lt;br/&gt;
     (0 until partitionNum).foreach &lt;/p&gt;
{ partition =&amp;gt;
       val tp = new TopicPartition(topic, partition)
-      assertEquals(Errors.REPLICA_NOT_AVAILABLE, alterReplicaLogDirsResponse1.responses().get(tp))
+      assertEquals(Errors.UNKNOWN_TOPIC_OR_PARTITION, alterReplicaLogDirsResponse1.responses().get(tp))
       assertTrue(servers.head.logManager.getLog(tp).isEmpty)
     }

&lt;p&gt;@@ -85,7 +85,7 @@ class AlterReplicaLogDirsRequestTest extends BaseRequestTest {&lt;br/&gt;
     partitionDirs1.put(new TopicPartition(topic, 1), validDir1)&lt;br/&gt;
     val alterReplicaDirResponse1 = sendAlterReplicaLogDirsRequest(partitionDirs1.toMap)&lt;br/&gt;
     assertEquals(Errors.LOG_DIR_NOT_FOUND, alterReplicaDirResponse1.responses().get(new TopicPartition(topic, 0)))&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertEquals(Errors.REPLICA_NOT_AVAILABLE, alterReplicaDirResponse1.responses().get(new TopicPartition(topic, 1)))&lt;br/&gt;
+    assertEquals(Errors.UNKNOWN_TOPIC_OR_PARTITION, alterReplicaDirResponse1.responses().get(new TopicPartition(topic, 1)))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     createTopic(topic, 3, 1)&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/test/scala/unit/kafka/server/ListOffsetsRequestTest.scala b/core/src/test/scala/unit/kafka/server/ListOffsetsRequestTest.scala&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..6ee47eecda2&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/ListOffsetsRequestTest.scala&lt;br/&gt;
@@ -0,0 +1,88 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package kafka.server&lt;br/&gt;
+&lt;br/&gt;
+import java.lang.&lt;/p&gt;
{Long =&amp;gt; JLong}
&lt;p&gt;+&lt;br/&gt;
+import kafka.utils.TestUtils&lt;br/&gt;
+import org.apache.kafka.common.TopicPartition&lt;br/&gt;
+import org.apache.kafka.common.protocol.&lt;/p&gt;
{ApiKeys, Errors}&lt;br/&gt;
+import org.apache.kafka.common.requests.{IsolationLevel, ListOffsetRequest, ListOffsetResponse}&lt;br/&gt;
+import org.junit.Assert._&lt;br/&gt;
+import org.junit.Test&lt;br/&gt;
+&lt;br/&gt;
+import scala.collection.JavaConverters._&lt;br/&gt;
+&lt;br/&gt;
+class ListOffsetsRequestTest extends BaseRequestTest {&lt;br/&gt;
+&lt;br/&gt;
+  @Test&lt;br/&gt;
+  def testListOffsetsErrorCodes(): Unit = {
+    val topic = &quot;topic&quot;
+    val partition = new TopicPartition(topic, 0)
+
+    val consumerRequest = ListOffsetRequest.Builder
+      .forConsumer(false, IsolationLevel.READ_UNCOMMITTED)
+      .setTargetTimes(Map(partition -&amp;gt; ListOffsetRequest.EARLIEST_TIMESTAMP.asInstanceOf[JLong]).asJava)
+      .build()
+
+    val replicaRequest = ListOffsetRequest.Builder
+      .forReplica(ApiKeys.LIST_OFFSETS.latestVersion, servers.head.config.brokerId)
+      .setTargetTimes(Map(partition -&amp;gt; ListOffsetRequest.EARLIEST_TIMESTAMP.asInstanceOf[JLong]).asJava)
+      .build()
+
+    val debugReplicaRequest = ListOffsetRequest.Builder
+      .forReplica(ApiKeys.LIST_OFFSETS.latestVersion, ListOffsetRequest.DEBUGGING_REPLICA_ID)
+      .setTargetTimes(Map(partition -&amp;gt; ListOffsetRequest.EARLIEST_TIMESTAMP.asInstanceOf[JLong]).asJava)
+      .build()
+
+    // Unknown topic
+    val randomBrokerId = servers.head.config.brokerId
+    assertResponseError(Errors.UNKNOWN_TOPIC_OR_PARTITION, randomBrokerId, consumerRequest)
+    assertResponseError(Errors.UNKNOWN_TOPIC_OR_PARTITION, randomBrokerId, replicaRequest)
+    assertResponseError(Errors.UNKNOWN_TOPIC_OR_PARTITION, randomBrokerId, debugReplicaRequest)
+
+    val partitionToLeader = TestUtils.createTopic(zkClient, topic, numPartitions = 1, replicationFactor = 2, servers)
+    val replicas = zkClient.getReplicasForPartition(partition).toSet
+    val leader = partitionToLeader(partition.partition)
+    val follower = replicas.find(_ != leader).get
+    val nonReplica = servers.map(_.config.brokerId).find(!replicas.contains(_)).get
+
+    // Follower
+    assertResponseError(Errors.NOT_LEADER_FOR_PARTITION, follower, consumerRequest)
+    assertResponseError(Errors.NOT_LEADER_FOR_PARTITION, follower, replicaRequest)
+    assertResponseError(Errors.NONE, follower, debugReplicaRequest)
+
+    // Non-replica
+    assertResponseError(Errors.NOT_LEADER_FOR_PARTITION, nonReplica, consumerRequest)
+    assertResponseError(Errors.NOT_LEADER_FOR_PARTITION, nonReplica, replicaRequest)
+    assertResponseError(Errors.REPLICA_NOT_AVAILABLE, nonReplica, debugReplicaRequest)
+  }&lt;br/&gt;
+&lt;br/&gt;
+  private def assertResponseError(error: Errors, brokerId: Int, request: ListOffsetRequest): Unit = {&lt;br/&gt;
+    val response = sendRequest(brokerId, request)&lt;br/&gt;
+    assertEquals(request.partitionTimestamps.size, response.responseData.size)&lt;br/&gt;
+    response.responseData.asScala.values.foreach { partitionData =&amp;gt;
+      assertEquals(error, partitionData.error)
+    }&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
+  private def sendRequest(leaderId: Int, request: ListOffsetRequest): ListOffsetResponse = {
+    val response = connectAndSend(request, ApiKeys.LIST_OFFSETS, destination = brokerSocketServer(leaderId))
+    ListOffsetResponse.parse(response, request.version)
+  }&lt;br/&gt;
+&lt;br/&gt;
+}&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/OffsetsForLeaderEpochRequestTest.scala b/core/src/test/scala/unit/kafka/server/OffsetsForLeaderEpochRequestTest.scala&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..c6385f325ec&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/OffsetsForLeaderEpochRequestTest.scala&lt;br/&gt;
@@ -0,0 +1,65 @@&lt;br/&gt;
+/*&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements. See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package kafka.server&lt;br/&gt;
+&lt;br/&gt;
+import kafka.utils.TestUtils&lt;br/&gt;
+import org.apache.kafka.common.TopicPartition&lt;br/&gt;
+import org.apache.kafka.common.protocol.{ApiKeys, Errors}
&lt;p&gt;+import org.apache.kafka.common.requests.&lt;/p&gt;
{OffsetsForLeaderEpochRequest, OffsetsForLeaderEpochResponse}
&lt;p&gt;+import org.junit.Assert._&lt;br/&gt;
+import org.junit.Test&lt;br/&gt;
+&lt;br/&gt;
+import scala.collection.JavaConverters._&lt;br/&gt;
+&lt;br/&gt;
+class OffsetsForLeaderEpochRequestTest extends BaseRequestTest {&lt;br/&gt;
+&lt;br/&gt;
+  @Test&lt;br/&gt;
+  def testOffsetsForLeaderEpochErrorCodes(): Unit = &lt;/p&gt;
{
+    val topic = &quot;topic&quot;
+    val partition = new TopicPartition(topic, 0)
+
+    val request = new OffsetsForLeaderEpochRequest.Builder(ApiKeys.OFFSET_FOR_LEADER_EPOCH.latestVersion)
+      .add(partition, 0)
+      .build()
+
+    // Unknown topic
+    val randomBrokerId = servers.head.config.brokerId
+    assertResponseError(Errors.UNKNOWN_TOPIC_OR_PARTITION, randomBrokerId, request)
+
+    val partitionToLeader = TestUtils.createTopic(zkClient, topic, numPartitions = 1, replicationFactor = 2, servers)
+    val replicas = zkClient.getReplicasForPartition(partition).toSet
+    val leader = partitionToLeader(partition.partition)
+    val follower = replicas.find(_ != leader).get
+    val nonReplica = servers.map(_.config.brokerId).find(!replicas.contains(_)).get
+
+    assertResponseError(Errors.NOT_LEADER_FOR_PARTITION, follower, request)
+    assertResponseError(Errors.NOT_LEADER_FOR_PARTITION, nonReplica, request)
+  }
&lt;p&gt;+&lt;br/&gt;
+  private def assertResponseError(error: Errors, brokerId: Int, request: OffsetsForLeaderEpochRequest): Unit = {&lt;br/&gt;
+    val response = sendRequest(brokerId, request)&lt;br/&gt;
+    assertEquals(request.epochsByTopicPartition.size, response.responses.size)&lt;br/&gt;
+    response.responses.asScala.values.foreach &lt;/p&gt;
{ partitionData =&amp;gt;
+      assertEquals(error, partitionData.error)
+    }
&lt;p&gt;+  }&lt;br/&gt;
+&lt;br/&gt;
+  private def sendRequest(leaderId: Int, request: OffsetsForLeaderEpochRequest): OffsetsForLeaderEpochResponse = &lt;/p&gt;
{
+    val response = connectAndSend(request, ApiKeys.OFFSET_FOR_LEADER_EPOCH, destination = brokerSocketServer(leaderId))
+    OffsetsForLeaderEpochResponse.parse(response, request.version)
+  }
&lt;p&gt;+}&lt;br/&gt;
diff --git a/core/src/test/scala/unit/kafka/server/epoch/LeaderEpochIntegrationTest.scala b/core/src/test/scala/unit/kafka/server/epoch/LeaderEpochIntegrationTest.scala&lt;br/&gt;
index a6b77325811..17683f4f3fd 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/server/epoch/LeaderEpochIntegrationTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/server/epoch/LeaderEpochIntegrationTest.scala&lt;br/&gt;
@@ -128,7 +128,7 @@ class LeaderEpochIntegrationTest extends ZooKeeperTestHarness with Logging {&lt;/p&gt;

&lt;p&gt;     //And should get no leader for partition error from t1p1 (as it&apos;s not on broker 0)&lt;br/&gt;
     assertTrue(offsetsForEpochs(t1p1).hasError)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertEquals(UNKNOWN_TOPIC_OR_PARTITION, offsetsForEpochs(t1p1).error)&lt;br/&gt;
+    assertEquals(NOT_LEADER_FOR_PARTITION, offsetsForEpochs(t1p1).error)&lt;br/&gt;
     assertEquals(UNDEFINED_EPOCH_OFFSET, offsetsForEpochs(t1p1).endOffset)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     //Repointing to broker 1 we should get the correct offset for t1p1&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xfm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>