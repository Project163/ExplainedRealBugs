<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:41:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1647] Replication offset checkpoints (high water marks) can be lost on hard kills and restarts</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1647</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We ran into this scenario recently in a production environment. This can happen when enough brokers in a cluster are taken down. i.e., a rolling bounce done properly should not cause this issue. It can occur if all replicas for any partition are taken down.&lt;/p&gt;

&lt;p&gt;Here is a sample scenario:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Cluster of three brokers: b0, b1, b2&lt;/li&gt;
	&lt;li&gt;Two partitions (of some topic) with replication factor two: p0, p1&lt;/li&gt;
	&lt;li&gt;Initial state:&lt;br/&gt;
p0: leader = b0, ISR = 
{b0, b1}&lt;br/&gt;
p1: leader = b1, ISR = {b0, b1}&lt;/li&gt;
	&lt;li&gt;Do a parallel hard-kill of all brokers&lt;/li&gt;
	&lt;li&gt;Bring up b2, so it is the new controller&lt;/li&gt;
	&lt;li&gt;b2 initializes its controller context and populates its leader/ISR cache (i.e., controllerContext.partitionLeadershipInfo) from zookeeper. The last known leaders are b0 (for p0) and b1 (for p2)&lt;/li&gt;
	&lt;li&gt;Bring up b1&lt;/li&gt;
	&lt;li&gt;The controller&apos;s onBrokerStartup procedure initiates a replica state change for all replicas on b1 to become online. As part of this replica state change it gets the last known leader and ISR and sends a LeaderAndIsrRequest to b1 (for p1 and p2). This LeaderAndIsr request contains: {{p0: leader=b0; p1: leader=b1;} leaders=b1}. b0 is indicated as the leader of p0 but it is not included in the leaders field because b0 is down.&lt;/li&gt;
	&lt;li&gt;On receiving the LeaderAndIsrRequest, b1&apos;s replica manager will successfully make itself (b1) the leader for p1 (and create the local replica object corresponding to p1). It will however abort the become follower transition for p0 because the designated leader b0 is offline. So it will not create the local replica object for p0.&lt;/li&gt;
	&lt;li&gt;It will then start the high water mark checkpoint thread. Since only p1 has a local replica object, only p1&apos;s high water mark will be checkpointed to disk. p0&apos;s previously written checkpoint  if any will be lost.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So in summary it seems we should always create the local replica object even if the online transition does not happen.&lt;/p&gt;

&lt;p&gt;Possible symptoms of the above bug could be one or more of the following (we saw 2 and 3):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Data loss; yes on a hard-kill data loss is expected, but this can actually cause loss of nearly all data if the broker becomes follower, truncates, and soon after happens to become leader.&lt;/li&gt;
	&lt;li&gt;High IO on brokers that lose their high water mark then subsequently (on a successful become follower transition) truncate their log to zero and start catching up from the beginning.&lt;/li&gt;
	&lt;li&gt;If the offsets topic is affected, then offsets can get reset. This is because during an offset load we don&apos;t read past the high water mark. So if a water mark is missing then we don&apos;t load anything (even if the offsets are there in the log).&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12743558">KAFKA-1647</key>
            <summary>Replication offset checkpoints (high water marks) can be lost on hard kills and restarts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="becket_qin">Jiangjie Qin</assignee>
                                    <reporter username="jjkoshy">Joel Jacob Koshy</reporter>
                        <labels>
                            <label>newbie++</label>
                    </labels>
                <created>Tue, 23 Sep 2014 17:35:05 +0000</created>
                <updated>Thu, 30 Oct 2014 23:33:33 +0000</updated>
                            <resolved>Thu, 30 Oct 2014 23:33:33 +0000</resolved>
                                    <version>0.8.2.0</version>
                                    <fixVersion>0.8.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14148301" author="nehanarkhede" created="Thu, 25 Sep 2014 20:57:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; Sounds like a problem. I have a question about something that I don&apos;t quite understand. &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;On receiving the LeaderAndIsrRequest, b1&apos;s replica manager will successfully make b2 the leader for p1 (and create the local replica object corresponding to p1). It will however abort the become follower transition for p0 because the designated leader b2 is offline. So it will not create the local replica object for p0.&lt;/p&gt;&lt;/blockquote&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Did you mean &quot;b1&apos;s replica manager will successfully make b1 the leader for p1&quot;?&lt;/li&gt;
	&lt;li&gt;I&apos;m not sure why b1 ends up truncating all it&apos;s data for p0 even if it ends up aborting it&apos;s become follower transition? I see how the highwatermark checkpoint ends up removing p0&apos;s checkpoint, but not how b1 ends up deleting all it&apos;s data for p0.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14148336" author="jjkoshy" created="Thu, 25 Sep 2014 21:25:31 +0000"  >&lt;p&gt;If b1 aborts the follower transition the high watermark checkpoint can be removed. It does not truncate all the data at that point. However, on a subsequent become-follower transition (if any and if successful) it will truncate the log (since on unknown HW we take HW as zero).&lt;/p&gt;

&lt;p&gt;This shouldn&apos;t be too difficult to fix though.&lt;/p&gt;</comment>
                            <comment id="14148702" author="nehanarkhede" created="Fri, 26 Sep 2014 03:56:06 +0000"  >&lt;p&gt;I see. So for this to lose all the data for the concerned partition, b1 has to be bounced to become a follower again and at that time b0 should be up for the become follower to succeed. Right? It is a pretty corner case, but should be fixed. &lt;/p&gt;</comment>
                            <comment id="14148802" author="jjkoshy" created="Fri, 26 Sep 2014 05:33:49 +0000"  >&lt;p&gt;Yes that is one possibility but not the only one. For example, suppose this is a topic with replication factor three. This is typically when bringing up a cluster that was previously hard-killed. Suppose b1 and b2 are brought up simultaneously and lose their HW as described above. Suppose the controller then elects b1 as the leader. b2 then becomes the follower (successfully) but as part of that transition will truncate to zero. I think there should be more scenarios since I also saw this with a topic with replication factor of two but have not checked the logs yet to see if it was due to a subsequent bounce or something else.&lt;/p&gt;</comment>
                            <comment id="14150021" author="nehanarkhede" created="Fri, 26 Sep 2014 21:32:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; Makes sense, thanks for the explanation! I guess the behavior of the follower dropping the partition out of the highwatermark checkpoint due to an aborted follower transition, needs to be fixed.&lt;/p&gt;</comment>
                            <comment id="14151234" author="junrao" created="Sun, 28 Sep 2014 21:45:50 +0000"  >&lt;p&gt;Joel,&lt;/p&gt;

&lt;p&gt;Is this because in ReplicaManger.makeFollowers(), we skip partition.makeFollower() if the leader is not alive? If so, we probably can just skip the check there. Then, another issue is that we will hit an exception in the following code, which will prevent the rest of the followers from being added to the fetcher. We probably need to do the try/catch there per partition and log an error if we hit an exception.&lt;br/&gt;
          new TopicAndPartition(partition) -&amp;gt; BrokerAndInitialOffset(&lt;br/&gt;
            leaders.find(_.id == partition.leaderReplicaIdOpt.get).get,&lt;br/&gt;
            partition.getReplica().get.logEndOffset.messageOffset)&lt;/p&gt;</comment>
                            <comment id="14151955" author="jjkoshy" created="Mon, 29 Sep 2014 17:53:37 +0000"  >&lt;p&gt;Yes that is exactly why it happens and the fix is relatively straightforward.&lt;/p&gt;</comment>
                            <comment id="14160510" author="becket_qin" created="Mon, 6 Oct 2014 17:06:59 +0000"  >&lt;p&gt;Created reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14170242" author="becket_qin" created="Mon, 13 Oct 2014 23:38:46 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14175898" author="becket_qin" created="Sat, 18 Oct 2014 07:26:53 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14179077" author="noslowerdna" created="Tue, 21 Oct 2014 20:52:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; Will this correction be included in 0.8.2-beta? It sounds like a blocker for the 0.8.2 release, in any case.&lt;/p&gt;</comment>
                            <comment id="14179622" author="becket_qin" created="Wed, 22 Oct 2014 06:08:51 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14180148" author="nehanarkhede" created="Wed, 22 Oct 2014 16:45:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=noslowerdna&quot; class=&quot;user-hover&quot; rel=&quot;noslowerdna&quot;&gt;noslowerdna&lt;/a&gt; This is pretty corner case and we are trying to get it in 0.8.2 if it can go through some testing. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; I think my comment may have been lost in the reviewboard, so reposting it here - In order to accept this patch, I&apos;d like us to repeat the kind of testing that was done to find this bug. Did you get a chance to do that on your latest patch?&lt;/p&gt;</comment>
                            <comment id="14180181" author="becket_qin" created="Wed, 22 Oct 2014 17:08:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nehanarkhede&quot; class=&quot;user-hover&quot; rel=&quot;nehanarkhede&quot;&gt;nehanarkhede&lt;/a&gt; I haven&apos;t got a chance to do tests yet... I&apos;ll do the test later this week and verify if it works.&lt;/p&gt;</comment>
                            <comment id="14180328" author="jjkoshy" created="Wed, 22 Oct 2014 18:56:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; here are some steps to reproduce locally. There are probably simpler steps, but I ran into it while debugging something else, so here you go:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Set up three brokers. Sample config: &lt;a href=&quot;https://gist.github.com/jjkoshy/1ec36e5cef41ac4bd8fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/jjkoshy/1ec36e5cef41ac4bd8fb&lt;/a&gt; (You will need to edit the logs directory and port)&lt;/li&gt;
	&lt;li&gt;Create 50 topics;  each with 4 partitions; replication factor 2 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..50}; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; ./bin/kafka-topics.sh --create --topic test$i --zookeeper localhost:2181 --partitions 4 --replication-factor 2; done&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Run producer performance: 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./bin/kafka-producer-perf-test.sh --threads 4 --broker-list localhost:9092,localhost:9093 --vary-message-size --messages 922337203685477580 --topics test1,test2,test3,test4,test5,test6,test7,test8,test9,test10,test11,test12,test13,test14,test15,test16,test17,test18,test19,test20,test21,test22,test23,test24,test25,test26,test27,test28,test29,test30,test31,test32,test33,test34,test35,test36,test37,test38,test39,test40,test41,test42,test43,test44,test45,test46,test47,test48,test49,test50 --message-size 500&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Parallel hard kill of all brokers: &lt;tt&gt;pkill -9 -f Kafka&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Kill producer performance&lt;/li&gt;
	&lt;li&gt;Restart brokers&lt;/li&gt;
	&lt;li&gt;You should see &quot;WARN No checkpointed highwatermark is found for partition...&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14186104" author="becket_qin" created="Tue, 28 Oct 2014 00:19:14 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14190490" author="jjkoshy" created="Thu, 30 Oct 2014 17:58:07 +0000"  >&lt;p&gt;Patch is good, but could you rebase?&lt;/p&gt;</comment>
                            <comment id="14190931" author="becket_qin" created="Thu, 30 Oct 2014 22:07:15 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14190936" author="becket_qin" created="Thu, 30 Oct 2014 22:10:27 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14190963" author="becket_qin" created="Thu, 30 Oct 2014 22:38:11 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14190977" author="becket_qin" created="Thu, 30 Oct 2014 22:50:43 +0000"  >&lt;p&gt;Updated reviewboard &lt;a href=&quot;https://reviews.apache.org/r/26373/diff/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/26373/diff/&lt;/a&gt;&lt;br/&gt;
 against branch origin/trunk&lt;/p&gt;</comment>
                            <comment id="14191039" author="jjkoshy" created="Thu, 30 Oct 2014 23:33:33 +0000"  >&lt;p&gt;Thanks for the patch - committed to 0.8.2 and trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12673125" name="KAFKA-1647.patch" size="4199" author="becket_qin" created="Mon, 6 Oct 2014 17:06:59 +0000"/>
                            <attachment id="12674645" name="KAFKA-1647_2014-10-13_16:38:39.patch" size="7156" author="becket_qin" created="Mon, 13 Oct 2014 23:38:46 +0000"/>
                            <attachment id="12675659" name="KAFKA-1647_2014-10-18_00:26:51.patch" size="8780" author="becket_qin" created="Sat, 18 Oct 2014 07:26:53 +0000"/>
                            <attachment id="12676274" name="KAFKA-1647_2014-10-21_23:08:43.patch" size="10439" author="becket_qin" created="Wed, 22 Oct 2014 06:08:50 +0000"/>
                            <attachment id="12677471" name="KAFKA-1647_2014-10-27_17:19:07.patch" size="12231" author="becket_qin" created="Tue, 28 Oct 2014 00:19:14 +0000"/>
                            <attachment id="12678325" name="KAFKA-1647_2014-10-30_15:07:09.patch" size="6960" author="becket_qin" created="Thu, 30 Oct 2014 22:07:15 +0000"/>
                            <attachment id="12678327" name="KAFKA-1647_2014-10-30_15:10:22.patch" size="8674" author="becket_qin" created="Thu, 30 Oct 2014 22:10:27 +0000"/>
                            <attachment id="12678335" name="KAFKA-1647_2014-10-30_15:38:02.patch" size="9737" author="becket_qin" created="Thu, 30 Oct 2014 22:38:11 +0000"/>
                            <attachment id="12678337" name="KAFKA-1647_2014-10-30_15:50:33.patch" size="12525" author="becket_qin" created="Thu, 30 Oct 2014 22:50:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20een:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>