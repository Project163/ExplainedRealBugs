<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:37:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-831] Controller does not send the complete list of partitions to a newly started broker</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-831</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;On a new broker startup, the controller is supposed to send the entire list of partitions that the new broker is supposed to host in one leader and isr request. In this request, it specifies if the new broker is the leader or follower for each of those partitions. For most of the partitions, the new broker will be a follower. However, for some partitions that don&apos;t have any other broker alive, the new broker will be the leader. The bug is that the controller first elects the leaders for offline partitons to see if the new broker is the leader for any of those and sends only those partitions for which leader was elected in the first leader and isr request. Right after that, it does send a leader and isr request with all partitions, but that breaks the guarantee that the very first leader and isr request has all partitions. As a result of this bug, the high watermark checkpointing logic behaves incorrectly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639613">KAFKA-831</key>
            <summary>Controller does not send the complete list of partitions to a newly started broker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nehanarkhede">Neha Narkhede</assignee>
                                    <reporter username="nehanarkhede">Neha Narkhede</reporter>
                        <labels>
                            <label>kafka-0.8</label>
                            <label>p1</label>
                    </labels>
                <created>Thu, 28 Mar 2013 16:12:45 +0000</created>
                <updated>Fri, 29 Mar 2013 15:27:26 +0000</updated>
                            <resolved>Thu, 28 Mar 2013 23:30:13 +0000</resolved>
                                    <version>0.8.0</version>
                                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13616773" author="nehanarkhede" created="Thu, 28 Mar 2013 23:07:37 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The fix is to switch the order of leader election and sending the list of all partitions to the newly restarted broker.&lt;/li&gt;
	&lt;li&gt;This is ok since the impact of doing that is that the newly started broker could be asked to become follower of a dead leader. On the ReplicaManager side, we actually abort a become follower if the leader is not alive anymore.&lt;/li&gt;
	&lt;li&gt;Right after sending the list of all partitions, the controller will trigger leader election for all new and offline partitions. This will take care of the case when the newly started broker is the next leader of such partitions&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13616806" author="junrao" created="Thu, 28 Mar 2013 23:21:31 +0000"  >&lt;p&gt;Thanks for the patch. +1.&lt;/p&gt;</comment>
                            <comment id="13616820" author="nehanarkhede" created="Thu, 28 Mar 2013 23:30:13 +0000"  >&lt;p&gt;Thanks for the review, checked in!&lt;/p&gt;</comment>
                            <comment id="13616827" author="swapnilghike" created="Thu, 28 Mar 2013 23:42:10 +0000"  >&lt;p&gt;This patch may not fix the issue. In the OfflineReplica-&amp;gt;OnlineReplica state transition, we send a leaderAndIsr request that includes only those partitions whose leader is alive. So if another broker was down which was leading the partition that the broker that has recently started was following, the 1st leaderAndIsr request will miss that partition.&lt;/p&gt;</comment>
                            <comment id="13616843" author="swapnilghike" created="Thu, 28 Mar 2013 23:49:01 +0000"  >&lt;p&gt;One way to avoid it could be that in the Online/OfflineReplica -&amp;gt; OnlineReplica state transition, send a leaderAndIsr request that contains all partitions. If the leader of the partition is offline, then the ReplicaManager will drop the request.&lt;/p&gt;

&lt;p&gt;The replica manager will also log &quot;the leader for this partition went down during the state transition&quot;, so perhaps we can change this log statement to say &quot;the leader for this partition is down&quot;.&lt;/p&gt;</comment>
                            <comment id="13616996" author="nehanarkhede" created="Fri, 29 Mar 2013 02:16:17 +0000"  >&lt;p&gt;Ack, you&apos;re right. The optimization of sending the leader and isr request only if the leader is alive is flawed. This is because even if the leader is alive at the time of the check, it can immediately go offline by the time the broker is ready to act on the request. In any case, the replica manager does the appropriate check just before executing the leader/follower state change on its end. &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This patch removes the above optimization and sends the leader and isr request for all partitions in Offline/Online state&lt;/li&gt;
	&lt;li&gt;Note that, in the first request, the partitions in NewPartition state are not included since they never had a leader. This is ok since it means that the broker never started a log for such partitions. So there is no worry of previously written checkpoint getting lost&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13617414" author="junrao" created="Fri, 29 Mar 2013 15:15:29 +0000"  >&lt;p&gt;+1 on patch v2.&lt;/p&gt;</comment>
                            <comment id="13617426" author="nehanarkhede" created="Fri, 29 Mar 2013 15:27:26 +0000"  >&lt;p&gt;Thank you for the follow up review!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12575969" name="kafka-831-v1.patch" size="1419" author="nehanarkhede" created="Thu, 28 Mar 2013 23:07:37 +0000"/>
                            <attachment id="12576009" name="kafka-831-v2.patch" size="3982" author="nehanarkhede" created="Fri, 29 Mar 2013 02:16:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320082</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j87j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320423</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>