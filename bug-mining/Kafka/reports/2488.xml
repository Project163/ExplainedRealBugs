<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:21:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9491] Fast election during reassignment can lead to replica fetcher failures</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9491</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We have observed an unusual case in which a new replica became leader before it had received an initial high watermark from the previous leader. This resulted in an OffsetOutOfRangeException being raised while looking up the segment position of the uninitialized high watermark, since it was lower than the log start offset. The error was raised while handle the fetch request from one of the followers and prevented it from making progress.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.kafka.common.errors.OffsetOutOfRangeException: Received request &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; offset 0 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition foo-0, but we only have log segments in the range 20 to 20.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is what we have observed from the logs. The initial state of the partition for the relevant sequence of events is the following:&lt;/p&gt;

&lt;p&gt;Initial state: replicas=&lt;span class=&quot;error&quot;&gt;&amp;#91;4,1,2,3&amp;#93;&lt;/span&gt;, leader=1, isr=&lt;span class=&quot;error&quot;&gt;&amp;#91;1,2,3&amp;#93;&lt;/span&gt;, adding=&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;, removing=&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, epoch=5, logStartOffset=20, logEndOffset=20&lt;/p&gt;

&lt;p&gt;We see the following events:&lt;/p&gt;

&lt;p&gt;t0: Replica 4 becomes follower and initializes log with hw=0, logStartOffset=0&lt;br/&gt;
t1: Replica 4 begins fetching from offset 0 and receives an out of range error&lt;br/&gt;
t2: After a ListOffset request to the leader, replica 4 initializes logStartOffset to 20.&lt;br/&gt;
t3: Replica 4 sends fetch request to the leader at start offset 20&lt;br/&gt;
t4: Upon receiving the fetch request, the leader adds 4 to the ISR (i.e. isr=&lt;span class=&quot;error&quot;&gt;&amp;#91;1,2,3,4&amp;#93;&lt;/span&gt;)&lt;br/&gt;
t5: The controller notices the ISR addition and makes 4 the leader since 1 is to be removed and 4 is the new preferred leader&lt;br/&gt;
t6: Replica 4 stops fetchers and becomes leader&lt;br/&gt;
t7: We begin seeing the out of range errors as the other replicas begin fetching from 4.&lt;/p&gt;

&lt;p&gt;We know from analysis of a heap dump from broker 4, that the high watermark was still set to 0 some time after it had become leader. We also know that broker 1 was under significant load. The time between events t4 and t6 was less than 10ms. We don&apos;t know when the fetch response sent at t3 returned to broker 4, but we speculate that it happened after t6 due to the heavy load on the leader, which is why broker 4 had an uninitialized high watermark.&lt;/p&gt;

&lt;p&gt;A more mundane possibility is that there is a bug in the fetch session logic and the partition was simply not included in the fetch response. However, the code appears to anticipate this case. When a partition has an error, we set the cached high watermark to -1 to ensure that it gets updated as soon as the error clears.&lt;/p&gt;

&lt;p&gt;Regardless how we got there, the fix should be straightforward. When a broker becomes leader, it should ensure its high watermark is at least as large as the log start offset.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13282748">KAFKA-9491</key>
            <summary>Fast election during reassignment can lead to replica fetcher failures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Sat, 1 Feb 2020 08:39:07 +0000</created>
                <updated>Tue, 4 Feb 2020 23:23:13 +0000</updated>
                            <resolved>Tue, 4 Feb 2020 23:21:25 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>2.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17029595" author="githubbot" created="Tue, 4 Feb 2020 06:19:55 +0000"  >&lt;p&gt;hachikuji commented on pull request #8037: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9491&quot; title=&quot;Fast election during reassignment can lead to replica fetcher failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9491&quot;&gt;&lt;del&gt;KAFKA-9491&lt;/del&gt;&lt;/a&gt;; Increment high watermark after full log truncation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8037&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   When a follower&apos;s fetch offset is behind the leader&apos;s log start offset, the follower will do a full log truncation. When it does so, it must update both its log start offset and high watermark. Failure to do so can lead to out of range errors if the follower becomes leader before getting the latest high watermark from the previous leader. The out of range errors occur when we attempt to resolve the log position of the high watermark in `DelayedFetch` in order to determine if a fetch is satisfied.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17030074" author="githubbot" created="Tue, 4 Feb 2020 19:22:38 +0000"  >&lt;p&gt;ijuma commented on pull request #8037: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9491&quot; title=&quot;Fast election during reassignment can lead to replica fetcher failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9491&quot;&gt;&lt;del&gt;KAFKA-9491&lt;/del&gt;&lt;/a&gt;; Increment high watermark after full log truncation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/8037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/8037&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17030082" author="ijuma" created="Tue, 4 Feb 2020 19:40:24 +0000"  >&lt;p&gt;Reopening as we are still considering a cherry-pick to 2.3.&lt;/p&gt;</comment>
                            <comment id="17030206" author="hachikuji" created="Tue, 4 Feb 2020 23:23:13 +0000"  >&lt;p&gt;After reviewing the previous logic, it looks like this was a regression in 2.4.0. It came from the new logic in KIP-392, which required followers to maintain the high watermark more strictly than before.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0b2e8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>