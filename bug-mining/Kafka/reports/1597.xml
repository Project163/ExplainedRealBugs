<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:02:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5610] KafkaApis.handleWriteTxnMarkerRequest can return UNSUPPORTED_FOR_MESSAGE_FORMAT error on partition emigration</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5610</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;This bug was revealed by the following system test failure &lt;a href=&quot;http://confluent-systest.s3-website-us-west-2.amazonaws.com/confluent-kafka-system-test-results/?prefix=2017-07-18--001.1500383975--apache--trunk--28c83d9/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://confluent-systest.s3-website-us-west-2.amazonaws.com/confluent-kafka-system-test-results/?prefix=2017-07-18--001.1500383975--apache--trunk--28c83d9/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What happened was that a commit marker to the offsets topic (sent as part of the &lt;tt&gt;producer.sendOffsetsToTransaction&lt;/tt&gt; method) was lost, causing data to be reprocessed, and hence causing the test to fail. &lt;/p&gt;

&lt;p&gt;The bug is that the wrong error code is returned from the handleWriteTxnMarker request when there is partition emigration. In particular, we have: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (marker &amp;lt;- markers.asScala) {
      val producerId = marker.producerId
      val (goodPartitions, partitionsWithIncorrectMessageFormat) = marker.partitions.asScala.partition { partition =&amp;gt;
        replicaManager.getMagic(partition) match {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(magic) &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; magic &amp;gt;= RecordBatch.MAGIC_VALUE_V2 =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
        }
      }

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partitionsWithIncorrectMessageFormat.nonEmpty) {
        val currentErrors = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap[TopicPartition, Errors]()
        partitionsWithIncorrectMessageFormat.foreach { partition =&amp;gt; currentErrors.put(partition, Errors.UNSUPPORTED_FOR_MESSAGE_FORMAT) }
        updateErrors(producerId, currentErrors)
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the &lt;tt&gt;replicaManager.getMagic()&lt;/tt&gt; call will return &lt;tt&gt;None&lt;/tt&gt; when the partition emigrates, causing the &lt;tt&gt;handleWriteTxnMarkersRequest&lt;/tt&gt; to return an &lt;tt&gt;UNSUPPORTED_FOR_MESSAGE_FORMAT&lt;/tt&gt; error. &lt;/p&gt;

&lt;p&gt;From the log, we see that the partition did emigrate a few milliseconds before the &lt;tt&gt;WriteTxnMarkerRequest&lt;/tt&gt; was sent.&lt;/p&gt;

&lt;p&gt;On the old leader, worker10:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./worker10/debug/server.log:32245:[2017-07-18 05:43:20,950] INFO [GroupCoordinator 2]: Unloading group metadata for transactions-test-consumer-group with generation 0 (kafka.coordinator.group.GroupCoordinator)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the client: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2017-07-18 05:43:20,959] INFO [Transaction Marker Request Completion Handler 1]: Sending my-first-transactional-id&apos;s transaction marker from partition __consumer_offsets-47 has failed with  UNSUPPORTED_FOR_MESSAGE_FORMAT. This partition will be removed from the set of partitions waiting for completion (kafka.coordinator.transaction.TransactionMarkerRequestCompletionHandler)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see, the client received the response 9 ms after the emigration was initiated on the server.&lt;/p&gt;

&lt;p&gt;Since it is perfectly acceptable for the LeaderISR metadata to be propagated asynchronously, we should have more robust handling of emgiration in KafkaApis so that it returns the right error code when handling a request for a partition for which the broker is no longer the leader.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13088554">KAFKA-5610</key>
            <summary>KafkaApis.handleWriteTxnMarkerRequest can return UNSUPPORTED_FOR_MESSAGE_FORMAT error on partition emigration</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="apurva">Apurva Mehta</assignee>
                                    <reporter username="apurva">Apurva Mehta</reporter>
                        <labels>
                            <label>exactly-once</label>
                    </labels>
                <created>Wed, 19 Jul 2017 21:01:00 +0000</created>
                <updated>Thu, 20 Jul 2017 20:09:11 +0000</updated>
                            <resolved>Thu, 20 Jul 2017 20:08:27 +0000</resolved>
                                    <version>0.11.0.0</version>
                                    <fixVersion>0.11.0.1</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16093880" author="githubbot" created="Wed, 19 Jul 2017 22:12:48 +0000"  >&lt;p&gt;GitHub user apurvam opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3550&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3550&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5610&quot; title=&quot;KafkaApis.handleWriteTxnMarkerRequest can return UNSUPPORTED_FOR_MESSAGE_FORMAT error on partition emigration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5610&quot;&gt;&lt;del&gt;KAFKA-5610&lt;/del&gt;&lt;/a&gt;: KafkaApis.HandleWriteTxnMarkerRequest should return UNKNOWN_TOPIC_OR_PARTITION on partition emigration.&lt;/p&gt;

&lt;p&gt;    Before this patch, we would return the non-retriable `UNSUPPORTED_FOR_MESSAGE_FORMAT` error when leadership changed, causing markers to be lost.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/apurvam/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apurvam/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5610&quot; title=&quot;KafkaApis.handleWriteTxnMarkerRequest can return UNSUPPORTED_FOR_MESSAGE_FORMAT error on partition emigration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5610&quot;&gt;&lt;del&gt;KAFKA-5610&lt;/del&gt;&lt;/a&gt;-handleWriteTxnMarker-should-handle-emigration&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3550.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3550.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3550&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3ceba90e31964dc13e264376c993aadfe29e632c&lt;br/&gt;
Author: Apurva Mehta &amp;lt;apurva@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-07-19T22:10:33Z&lt;/p&gt;

&lt;p&gt;    Return UKNOWN_TOPIC_OR_PARTITION when partition emigrates during KafkaApis.handleWriteTxnMarkerRequest&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16095278" author="hachikuji" created="Thu, 20 Jul 2017 20:08:27 +0000"  >&lt;p&gt;Issue resolved by pull request 3550&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3550&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3550&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16095282" author="githubbot" created="Thu, 20 Jul 2017 20:09:11 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3550&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3550&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hrjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>