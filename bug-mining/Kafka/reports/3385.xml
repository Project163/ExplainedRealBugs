<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12679] Rebalancing a restoring or running task may cause directory livelocking with newly created task</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12679</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If a task that uses a state store is in the restoring state or in a running state and the task gets rebalanced to a separate thread on the same instance, the newly created task will attempt to lock the state store director while the first thread is continuing to use it. This is totally normal and expected behavior when the first thread is not yet aware of the rebalance. However, that newly created task is effectively running a while loop with no backoff waiting to lock the directory:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;TaskManager tells the task to restore in `tryToCompleteRestoration`&lt;/li&gt;
	&lt;li&gt;The task attempts to lock the directory&lt;/li&gt;
	&lt;li&gt;The lock attempt fails and throws a `org.apache.kafka.streams.errors.LockException`&lt;/li&gt;
	&lt;li&gt;TaskManager catches the exception, stops further processing on the task and reports that not all tasks have restored&lt;/li&gt;
	&lt;li&gt;The StreamThread `runLoop` continues to run.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ve seen some documentation indicate that there is supposed to be a backoff when this condition occurs, but there does not appear to be any in the code. The result is that if this goes on for long enough, the lock-loop may dominate CPU usage in the process and starve out the old stream thread task processing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When in this state, the DEBUG level logging for TaskManager will produce a steady stream of messages like the following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-03-30 20:59:51,098 DEBUG --- [StreamThread-10] o.a.k.s.p.i.TaskManager                 : stream-thread [StreamThread-10] Could not initialize 0_34 due to the following exception; will retry
org.apache.kafka.streams.errors.LockException: stream-thread [StreamThread-10] standby-task [0_34] Failed to lock the state directory for task 0_34
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a git formatted patch to resolve the issue. Simply detect the scenario and sleep for the backoff time in the appropriate StreamThread.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>Broker and client version 2.6.1&lt;br/&gt;
Multi-node broker cluster&lt;br/&gt;
Multi-node, auto scaling streams app instances&lt;br/&gt;
</environment>
        <key id="13373097">KAFKA-12679</key>
            <summary>Rebalancing a restoring or running task may cause directory livelocking with newly created task</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lucasbru">Lucas Brutschy</assignee>
                                    <reporter username="pnahas">Peter Nahas</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Apr 2021 17:56:34 +0000</created>
                <updated>Thu, 25 Sep 2025 09:55:12 +0000</updated>
                            <resolved>Tue, 26 Dec 2023 22:17:50 +0000</resolved>
                                    <version>2.6.1</version>
                                    <fixVersion>3.9.1</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="17571042" author="divijvaidya" created="Mon, 25 Jul 2022 18:28:47 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnahas&quot; class=&quot;user-hover&quot; rel=&quot;pnahas&quot;&gt;pnahas&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I understand that it has been a while since this Jira is open. Would you like to submit the patch as a pull request against the trunk branch? &lt;br/&gt;
One thing that would be useful to merge this change is to have a reproducer test that succeeds after the fix. I would be happy to help you merge this in any way I can.&#160;&lt;/p&gt;

&lt;p&gt;Please let us know whether you are still interested.&lt;/p&gt;</comment>
                            <comment id="17627873" author="btiwana" created="Wed, 2 Nov 2022 17:53:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt; We are facing a similar issue in 2.8.1 and need a fix ASAP. I am willing to create a pull request for this for the trunk branch. But can we also get it backported to 2.8.1. Even if backporting is not possible can I create a separate PR for 2.8.1 and get it released so that it is available for use?&lt;/p&gt;</comment>
                            <comment id="17630721" author="ableegoldman" created="Wed, 9 Nov 2022 03:20:12 +0000"  >&lt;p&gt;Huh, I thought we had already fixed this a while ago but if you&apos;re still seeing it on 2.8.1 then maybe I&apos;m misremembering. If you&apos;re interested in submitting a patch for this it would be welcome &#8211; I can backport it to older branches once it&apos;s merged, but just a heads up it&apos;s unlikely for there to be another bugfix release for 2.8. If you&apos;re willing/able to build from source then of course this should be fine.&lt;/p&gt;

&lt;p&gt;I&apos;m pretty sure not much has changed in the initialization loop logic between now and 2.8 so it should hopefully be a smooth cherrypick from trunk to 2.8, but it might be worth poking around both branches when you are looking at a fix to see if that fix will apply without conflicts to both.&lt;/p&gt;

&lt;p&gt;Anyways if/when you have a patch ready, feel free to ping me directly on the PR&lt;/p&gt;</comment>
                            <comment id="17630746" author="btiwana" created="Wed, 9 Nov 2022 04:24:50 +0000"  >&lt;p&gt;Actually the root cause of our issue turned out to be in some custom code that we implemented by inheriting some kafka streams API interfaces. We were running a huge loop there which was not needed.&lt;/p&gt;

&lt;p&gt;But to clarify the &lt;em&gt;retry.backoff.ms&lt;/em&gt; config parameter is still not being used to do a retry in case of LockException here &lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java#L679.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java#L679.&lt;/a&gt; I am not sure if that is documented anywhere that this has to be done in a KIP etc. or not.&#160;&lt;/p&gt;</comment>
                            <comment id="17630754" author="ableegoldman" created="Wed, 9 Nov 2022 05:22:30 +0000"  >&lt;p&gt;Ah ok, thanks for the update. Regarding the retry.backoff.ms config, that&apos;s technically speaking a client config meaning it&apos;s intended to give Streams users control over the backoff between requests in the embedded consumer, producer, or admin client(s). This is what the Streams docs for that config mean by &quot;The amount of time in milliseconds, before a request is retried&quot; &#8211; it&apos;s not a universal config for backing off any and every operation within Streams.&lt;/p&gt;

&lt;p&gt;There is one case where it&apos;s currently used by Streams itself however, vs just passing it through to the client configuration, which is when the assignor is validating and/or setting up internal topics during a rebalance &#8211; this is still kind of a client/request config since it controls how long to wait between various admin calls, but my point is it&apos;s not entirely out of the question to reuse this config for other things within Streams. Still, I would probably advocate for adding a new config for backing off something like this that&apos;s completely unrelated to any client requests.&lt;/p&gt;

&lt;p&gt;All that is to say, we could probably improve the docs to clarify what this config actually controls, and possibly introduce a new config to address things like the busy loop while initializing/locking a task. I&apos;ll take a look at the current code on trunk to see if we&apos;ve improved things since 2.6 as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=divijvaidya&quot; class=&quot;user-hover&quot; rel=&quot;divijvaidya&quot;&gt;divijvaidya&lt;/a&gt; was experiencing. Honestly it&apos;s probably sufficient to just hard code a short sleep rather than bother with a configurable backoff&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;By the way, there is actually ongoing work to move the restoration process to a separate thread, which will presumably include this part where we try to lock the task. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt; &#160;&#8211; in case this isn&apos;t on your radar already, we should try and do this in a better way in the new restoration architecture&lt;/p&gt;</comment>
                            <comment id="17640125" author="JIRAUSER302322" created="Mon, 28 Nov 2022 16:23:00 +0000"  >&lt;p&gt;I addressed this in the new state restoration architecture.&lt;/p&gt;</comment>
                            <comment id="17642054" author="mjsax" created="Thu, 1 Dec 2022 17:09:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lbrutschy&quot; class=&quot;user-hover&quot; rel=&quot;lbrutschy&quot;&gt;lbrutschy&lt;/a&gt; Can you link the corresponding ticket?&lt;/p&gt;</comment>
                            <comment id="17642502" author="JIRAUSER302322" created="Fri, 2 Dec 2022 13:28:22 +0000"  >&lt;p&gt;I referenced this ticket in the PR&lt;/p&gt;</comment>
                            <comment id="17732025" author="andras hatvani" created="Tue, 13 Jun 2023 11:07:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lbrutschy&quot; class=&quot;user-hover&quot; rel=&quot;lbrutschy&quot;&gt;lbrutschy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; This is a pressing issue for my client as I could only work it around by reducing &lt;tt&gt;num.stream.threads&lt;/tt&gt; to &lt;tt&gt;1&lt;/tt&gt; which shouldn&apos;t be necessary.&lt;/p&gt;</comment>
                            <comment id="17732032" author="cadonna" created="Tue, 13 Jun 2023 11:27:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andras+Hatvani&quot; class=&quot;user-hover&quot; rel=&quot;Andras Hatvani&quot;&gt;Andras Hatvani&lt;/a&gt; Lucas&apos; PR solves the issue for the state updater (aka new restoration architecture). It does not solve it for the current initialization.        &lt;/p&gt;</comment>
                            <comment id="17771463" author="JIRAUSER302428" created="Tue, 3 Oct 2023 12:32:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lbrutschy&quot; class=&quot;user-hover&quot; rel=&quot;lbrutschy&quot;&gt;lbrutschy&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; In my company we are using the latest version of the Kafka Streams and we still experience this issue. Any ETA for when it&apos;s going to be fixed?&lt;/p&gt;</comment>
                            <comment id="17789127" author="JIRAUSER302322" created="Thu, 23 Nov 2023 13:24:24 +0000"  >&lt;p&gt;This is solved in current master and will be solved in the 3.7 release.&lt;/p&gt;</comment>
                            <comment id="17797281" author="JIRAUSER303392" created="Fri, 15 Dec 2023 19:14:56 +0000"  >&lt;p&gt;Would it be possible to add some logging as to which thread owns the lock when this happens? We are currently experiencing this issue repeatedly on one client, and it would be helpful to understand which other streams thread is the lock owner in case that thread is behaving unexpectedly. We are on streams 3.4.x and not using the stateUpdater.&lt;/p&gt;</comment>
                            <comment id="17800634" author="enether" created="Tue, 26 Dec 2023 22:17:50 +0000"  >&lt;p&gt;Marking this as done as per Lucas&apos; comment that this is solved&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17847100" author="JIRAUSER305369" created="Thu, 16 May 2024 21:09:38 +0000"  >&lt;p&gt;I&apos;m not quite sure if this is somehow related, but I see the following in a Kafka Streams application utilizing version &lt;em&gt;3.7.0&lt;/em&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stream-thread [kstreams-folder-aggregator-6667c2e7-17f0-43f4-85d3-1246e1deb948-StreamThread-3] standby-task [1_4] Failed to acquire lock &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; closing the state store &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; STANDBY task 1_4&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17847115" author="JIRAUSER301663" created="Thu, 16 May 2024 23:58:27 +0000"  >&lt;p&gt;We have pretty much the same issue running `3.7.0` with 5 stream threads and recovering from a mildly unclean shutdown. We get it for both `ACTIVE` and `STANDBY` tasks. This is the same whether or not the State Updater is enabled via the internal config.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Our cluster was completely orzdashed and we couldn&apos;t figure out how to &quot;heal&quot; it, but we were able to rectify the issue by setting `num.stream.threads=1` and restorations started making progress again.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We also notice that the application makes zero forward progress at all; restorations are stuck.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lucasbru&quot; class=&quot;user-hover&quot; rel=&quot;lucasbru&quot;&gt;lucasbru&lt;/a&gt; &apos;s comment about this being solved in `trunk` might be outdated? That is because, if I recall correctly, the State Updater was planned to be GA in 3.7.0 at one point and was then backed out. Is that correct?&lt;/p&gt;</comment>
                            <comment id="17847334" author="JIRAUSER302322" created="Fri, 17 May 2024 14:17:39 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stoeckmk&quot; class=&quot;user-hover&quot; rel=&quot;stoeckmk&quot;&gt;stoeckmk&lt;/a&gt;. It is true that the state updater was not enabled in 3.7 in the end, so there is no back-off when locking the state directory. We missed updating the fix version on this ticket. I updated it now. &lt;/p&gt;

&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=coltmcnealy-lh&quot; class=&quot;user-hover&quot; rel=&quot;coltmcnealy-lh&quot;&gt;coltmcnealy-lh&lt;/a&gt;. The change I implemented was to back-off in case of a lock error, but essentially retry. You should see something like `&quot;Encountered lock exception. Reattempting locking the state in the next iteration.` If you are completely stuck and the application makes zero progress, this does not seem like it would be solved by a back-off, and somehow that seems to describe a different problem, especially if it also happens with state updater enabled. We may want to create a separate ticket for this, since the problem described in this ticket should resolve itself once the old thread releases the lock on the state directory.&lt;/p&gt;</comment>
                            <comment id="17867622" author="JIRAUSER301663" created="Sun, 21 Jul 2024 18:13:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lucasbru&quot; class=&quot;user-hover&quot; rel=&quot;lucasbru&quot;&gt;lucasbru&lt;/a&gt; thanks for the comment and sorry for the delayed response. The issue we had turned out to be a separate problem, caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-17098&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-17098&lt;/a&gt; and fixed by Bruno&apos;s PR.&lt;/p&gt;</comment>
                            <comment id="17896322" author="JIRAUSER302322" created="Thu, 7 Nov 2024 13:56:31 +0000"  >&lt;p&gt;We haven&apos;t seen live-locking with the state updater, but there is a regression to busy waiting on the state directory lock, creating a lot of noise. The fix here: &lt;a href=&quot;https://github.com/apache/kafka/pull/17209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/17209&lt;/a&gt;. I set the fix version to 4.0.0&lt;/p&gt;</comment>
                            <comment id="17940026" author="foal" created="Tue, 1 Apr 2025 11:30:30 +0000"  >&lt;p&gt;Will it be also a part of 3.9.1 release?&#160;&lt;/p&gt;</comment>
                            <comment id="17940434" author="JIRAUSER302322" created="Wed, 2 Apr 2025 18:54:54 +0000"  >&lt;p&gt;Yes, looks like this was cherry-picked here: &lt;a href=&quot;https://github.com/apache/kafka/pull/18485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/18485&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13024194" name="Backoff-between-directory-lock-attempts.patch" size="6129" author="pnahas" created="Fri, 16 Apr 2021 17:55:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q47k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>