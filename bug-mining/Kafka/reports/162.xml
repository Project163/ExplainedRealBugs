<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-597] Refactor KafkaScheduler</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-597</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;It would be nice to cleanup KafkaScheduler. Here is what I am thinking&lt;/p&gt;

&lt;p&gt;Extract the following interface:&lt;/p&gt;

&lt;p&gt;trait Scheduler {&lt;br/&gt;
  def startup()&lt;br/&gt;
  def schedule(fun: () =&amp;gt; Unit, name: String, delayMs: Long = 0, periodMs: Long): Scheduled&lt;br/&gt;
  def shutdown(interrupt: Boolean = false)&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;class Scheduled {&lt;br/&gt;
  def lastExecution: Long&lt;br/&gt;
  def cancel()&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;We would have two implementations, KafkaScheduler and  MockScheduler. KafkaScheduler would be a wrapper for ScheduledThreadPoolExecutor. MockScheduler would only allow manual time advancement rather than using the system clock, we would switch unit tests over to this.&lt;/p&gt;

&lt;p&gt;This change would be different from the existing scheduler in a the following ways:&lt;br/&gt;
1. Would not return a ScheduledFuture (since this is useless)&lt;br/&gt;
2. shutdown() would be a blocking call. The current shutdown calls, don&apos;t really do what people want.&lt;br/&gt;
3. We would remove the daemon thread flag, as I don&apos;t think it works.&lt;br/&gt;
4. It returns an object which let&apos;s you cancel the job or get the last execution time.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12614258">KAFKA-597</key>
            <summary>Refactor KafkaScheduler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkreps">Jay Kreps</assignee>
                                    <reporter username="jkreps">Jay Kreps</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Oct 2012 18:46:54 +0000</created>
                <updated>Mon, 10 Dec 2012 19:31:50 +0000</updated>
                            <resolved>Mon, 10 Dec 2012 19:31:50 +0000</resolved>
                                    <version>0.8.1</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13509520" author="jkreps" created="Tue, 4 Dec 2012 05:33:31 +0000"  >&lt;p&gt;This patch refactors the scheduler as described above except that I didn&apos;t implement task cancelation.&lt;/p&gt;

&lt;p&gt;It also converts LogManagerTest to use the new MockScheduler.&lt;/p&gt;</comment>
                            <comment id="13509915" author="jkreps" created="Tue, 4 Dec 2012 18:10:11 +0000"  >&lt;p&gt;Updated patch, includes misc additional cleanups.&lt;/p&gt;</comment>
                            <comment id="13510986" author="jkreps" created="Thu, 6 Dec 2012 00:43:43 +0000"  >&lt;p&gt;Attached v3 patch, same as before but fully rebased to trunk.&lt;/p&gt;</comment>
                            <comment id="13511129" author="jkreps" created="Thu, 6 Dec 2012 05:33:23 +0000"  >&lt;p&gt;Ready for review.&lt;/p&gt;</comment>
                            <comment id="13526860" author="jkreps" created="Fri, 7 Dec 2012 23:12:12 +0000"  >&lt;p&gt;Patch v4. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Rebased&lt;/li&gt;
	&lt;li&gt;Makes use of thread factory&lt;/li&gt;
	&lt;li&gt;Fixed broken scaladoc&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13526966" author="jjkoshy" created="Sat, 8 Dec 2012 01:35:23 +0000"  >&lt;p&gt;I haven&apos;t fully reviewed, but a couple of initial comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I think the javadoc on KafkaScheduler&apos;s daemon param is a bit misleading as it currently suggests that daemon=true would prevent the VM from shutting down.&lt;/li&gt;
	&lt;li&gt;The patch inverts the daemon flag on some of the existing usages of KafkaScheduler - i.e., daemon now defaults to true and there are some places where daemon was false. We would need to survey these usages and identify whether it makes sense to keep them non-daemon or not.&lt;/li&gt;
	&lt;li&gt;The other question is on shutdownNow: the previous scheduler allowed the relaxed shutdown - i.e., don&apos;t interrupt threads that are currently executing. This change forces all shutdowns to use shutdownNow. Question is whether there are existing tasks that need to complete that would not tolerate an interrupt. I&apos;m not sure about that - we&apos;ll need to look at existing usages. E.g., KafkaServer&apos;s kafkaScheduler used the shutdown() method - now it&apos;s effectively shutdownNow.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13527027" author="jkreps" created="Sat, 8 Dec 2012 04:02:20 +0000"  >&lt;p&gt;Thanks, new patch v5 addresses your comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Improved javadoc&lt;/li&gt;
	&lt;li&gt;This is actually good. I thought about it a bit and since I am making shutdown block the only time daemon vs non-daemon comes into play is if you don&apos;t call shutdown. If that is the case non-daemon threads will prevent garbage collection of the scheduler tasks and eventually block shutdown of the jvm, which seems unnecessary.&lt;/li&gt;
	&lt;li&gt;The change to shutdownNow is not good. This will invoke interrupt on all threads, which is too aggressive. Better to let them finish. If we end up needing to schedule long-running tasks we can invent a new notification mechanism. I changed this so that we use normal shutdown instead.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13527084" author="jjkoshy" created="Sat, 8 Dec 2012 06:55:04 +0000"  >&lt;p&gt;On daemon vs non-daemon and shutdown vs shutdownNow. I may be misunderstanding the javadoc but I think: since the&lt;br/&gt;
default is now daemon=true and you switched to use shutdown, VM shutdown can continue even in the middle of a&lt;br/&gt;
scheduled task like checkpointing high watermarks or cleaning up logs. i.e., there may be such scenarios where it makes&lt;br/&gt;
sense to make them non-daemon - i.e., set it as a non-daemon, and use shutdown (not shutdownNow - or use&lt;br/&gt;
shutdownNow and handle InterruptedException properly in the task) to let them finish gracefully. Otherwise (iiuc)&lt;br/&gt;
it seems if we call shutdown on the executor the VM could exit and simply kill (i.e., abruptly terminate) any running&lt;br/&gt;
task that was started by the executor in one of the (daemon) threads from its pool.&lt;/p&gt;

&lt;p&gt;Minor comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Line 81 of KafkaScheduler: closing brace is mis-aligned.&lt;/li&gt;
	&lt;li&gt;The scaladoc on MockScheduler uses a non-existent schedule variant - i.e., I think you intended to add a period &amp;lt; 0&lt;br/&gt;
  no?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13527168" author="jkreps" created="Sat, 8 Dec 2012 15:35:53 +0000"  >&lt;p&gt;Nice catch on the brace, will fix before check in.&lt;/p&gt;

&lt;p&gt;With respect to the scaladoc, that is a legitimate call, I think. The api take default values so all of the following should work:&lt;br/&gt;
  scheduler.schedule(&quot;task&quot;, println(&quot;hello&quot;)) // immediately kick of a one-time background task&lt;br/&gt;
  scheduler.schedule(&quot;task&quot;, println(&quot;hello&quot;), delay=50) // kick off a one-time task in 50ms&lt;br/&gt;
  scheduler.schedule(&quot;task&quot;, println(&quot;hello&quot;), period = 50) // immediately kick off a repeating task that will repeat every 50 ms&lt;br/&gt;
  etc&lt;/p&gt;

&lt;p&gt;WRT daemon, you are correct, but I don&apos;t think this is necessarily a bad thing. The requirement of the api is that you call startup() before calling schedule() and call shutdown() when done. Shutdown was previously a non-blocking call so it was very important whether the threads were blocking or non-blocking (but this functionality was totally &lt;b&gt;broken&lt;/b&gt;) because you would likely call shutdown() and then exit the JVM. Now the only possible way to get to JVM shutdown with remaining scheduler threads is if your program has a bug and fails to call shutdown(). What should we do in this case? Hard to say. All tasks must handle unclean shutdown because unclean shutdown is a lot like a crash. Blocking JVM shutdown can really mess up automated deployment, so defaulting to that is not necessarily wise. So I am fine with either default but at least the consumer scheduler really needs to be set to daemon so we don&apos;t block people&apos;s jvms.&lt;/p&gt;</comment>
                            <comment id="13528185" author="jkreps" created="Mon, 10 Dec 2012 19:11:32 +0000"  >&lt;p&gt;Attached patch v6, which fixes Joel&apos;s comments--&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Formatting issue&lt;/li&gt;
	&lt;li&gt;Scaladoc issue&lt;/li&gt;
	&lt;li&gt;Changed shutdownNow to shutdown&lt;/li&gt;
	&lt;li&gt;But leaves daemon as the defualt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13528195" author="jjkoshy" created="Mon, 10 Dec 2012 19:22:51 +0000"  >&lt;p&gt;+1 - thanks for the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12555896" name="KAFKA-597-v1.patch" size="31719" author="jkreps" created="Tue, 4 Dec 2012 05:33:31 +0000"/>
                            <attachment id="12555960" name="KAFKA-597-v2.patch" size="34018" author="jkreps" created="Tue, 4 Dec 2012 18:10:11 +0000"/>
                            <attachment id="12556189" name="KAFKA-597-v3.patch" size="34325" author="jkreps" created="Thu, 6 Dec 2012 00:43:43 +0000"/>
                            <attachment id="12559975" name="KAFKA-597-v4.patch" size="34504" author="jkreps" created="Fri, 7 Dec 2012 23:12:12 +0000"/>
                            <attachment id="12560016" name="KAFKA-597-v5.patch" size="34548" author="jkreps" created="Sat, 8 Dec 2012 04:02:20 +0000"/>
                            <attachment id="12560239" name="KAFKA-597-v6.patch" size="34518" author="jkreps" created="Mon, 10 Dec 2012 19:11:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>253491</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0dnun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>77793</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>