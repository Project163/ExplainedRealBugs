<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:42:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-1481] Stop using dashes AND underscores as separators in MBean names</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-1481</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;MBeans should not use dashes or underscores as separators because these characters are allowed in hostnames, topics, group and consumer IDs, etc., and these are embedded in MBeans names making it impossible to parse out individual bits from MBeans.&lt;/p&gt;

&lt;p&gt;Perhaps a pipe character should be used to avoid the conflict. &lt;/p&gt;

&lt;p&gt;This looks like a major blocker because it means nobody can write Kafka 0.8.x monitoring tools unless they are doing it for themselves AND do not use dashes AND do not use underscores.&lt;/p&gt;

&lt;p&gt;See: &lt;a href=&quot;http://search-hadoop.com/m/4TaT4lonIW&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://search-hadoop.com/m/4TaT4lonIW&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12718028">KAFKA-1481</key>
            <summary>Stop using dashes AND underscores as separators in MBean names</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vladimir.tretyakov">Vladimir Tretyakov</assignee>
                                    <reporter username="otis">Otis Gospodnetic</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Tue, 3 Jun 2014 00:13:42 +0000</created>
                <updated>Wed, 18 Mar 2015 20:54:05 +0000</updated>
                            <resolved>Thu, 20 Nov 2014 02:00:11 +0000</resolved>
                                    <version>0.8.1.1</version>
                                    <fixVersion>0.8.2.0</fixVersion>
                    <fixVersion>0.9.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                                                                                                            <comments>
                            <comment id="14016078" author="otis" created="Tue, 3 Jun 2014 00:21:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1100&quot; title=&quot;metrics shouldn&amp;#39;t have generation/timestamp specific names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1100&quot;&gt;&lt;del&gt;KAFKA-1100&lt;/del&gt;&lt;/a&gt; is similar in the sense that it points out a problem with embedding stuff in MBean names that makes it difficult to parse those MBeans.&lt;/p&gt;</comment>
                            <comment id="14019732" author="vladimir.tretyakov" created="Fri, 6 Jun 2014 10:19:08 +0000"  >&lt;p&gt;I&apos;ve made some modifications (cloned 0.8.1 branch), now Kafka use &quot;|&quot; instead of &quot;&amp;#45;&quot; or &quot;&amp;#95;&quot; in JMX Bean names where they prevented make parsing (I didn&apos;t replace all &apos;&amp;#45;&apos; and &apos;&amp;#95;&apos;, just replaced in places which were critical for parsing point of view).&lt;/p&gt;

&lt;p&gt;I&apos;ve also noticed that these names Kafka uses not only for JMX Bean names, but for directory names and other things (my changes can be dangerous by this reason). &lt;/p&gt;

&lt;p&gt;I&apos;ve tested Broker/Producer/Consumer locally, it works, but will be perfect if somebody check everything I am not 100% sure about my changes (I am new in Kafka code).&lt;/p&gt;

&lt;p&gt;Best Regards, Vladimir.&lt;/p&gt;</comment>
                            <comment id="14038721" author="otis" created="Fri, 20 Jun 2014 12:01:27 +0000"  >&lt;p&gt;Nice and simple patch.  Question about this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   def validateChars(prop: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, value: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) {
-    val legalChars = &lt;span class=&quot;code-quote&quot;&gt;&quot;[a-zA-Z0-9\\._\\-]&quot;&lt;/span&gt;
+    val legalChars = &quot;[a-zA-Z0-9\\._\\-\\|]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I didn&apos;t check the source code to understand the bigger context, but the above looks like &quot;|&quot; is now a valid character, but should it really be valid/allowed?&lt;/p&gt;</comment>
                            <comment id="14038843" author="junrao" created="Fri, 20 Jun 2014 14:30:02 +0000"  >&lt;p&gt;Thanks for the patch. I agree that the current jmx bean names are not ideal. I do have the following concerns.&lt;/p&gt;

&lt;p&gt;1. While this may help some users, it may equally affect some other users who now would need to change their parsing of the jmx names.&lt;br/&gt;
2. I am not sure how wide-spread the separator issue. If it only helps a small number of users, I&apos;d prefer that we only do that on the new consumer.&lt;br/&gt;
3. Other than the separator issue, there are other things that are not ideal. For example, the bean name is just unnecessarily too long. If we do want to change the bean names, perhaps we should fix other problems together as well.&lt;/p&gt;
</comment>
                            <comment id="14040652" author="otis" created="Mon, 23 Jun 2014 11:42:50 +0000"  >&lt;p&gt;Hi Jun, thanks for having a look.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;1. While this may help some users, it may equally affect some other users who now would need to change their parsing of the jmx names.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Won&apos;t they have to do that sooner or later anyway, because dashes as separators obviously can&apos;t stay?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2. I am not sure how wide-spread the separator issue. If it only helps a small number of users, I&apos;d prefer that we only do that on the new consumer.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nobody knows one way or the other though.  So in absence of info I think it makes sense to at least make a move in the right direction.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Other than the separator issue, there are other things that are not ideal. For example, the bean name is just unnecessarily too long. If we do want to change the bean names, perhaps we should fix other problems together as well.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Long bean names may not be pretty, but they are not blockers.  The dashes are likely blockers for some portion of users and definitely blockers for any Kafka monitoring tool makers.  If long bean names are a problem (are they?) let&apos;s open a separate issue, ha?&lt;/p&gt;
</comment>
                            <comment id="14092501" author="otis" created="Mon, 11 Aug 2014 06:33:14 +0000"  >&lt;p&gt;Looks like 0.9 has been pushed to December 2014.  Any chance this can go into 0.8.2 then?  It&apos;s a blocker for us &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14092863" author="junrao" created="Mon, 11 Aug 2014 15:14:41 +0000"  >&lt;p&gt;I am wondering if you can get around the problem by just parsing the mbean names a bit differently. For example, for an mbean like the following in which &quot;topic-1&quot; is the topic name. When parsing the name part, you can find the last &quot;-&quot; to break the name into two parts.&lt;/p&gt;

&lt;p&gt;&quot;kafka.server&quot;:type=&quot;BrokerTopicMetrics&quot;,name=&quot;topic-1-BytesInPerSec&quot;&lt;/p&gt;</comment>
                            <comment id="14092910" author="vladimir.tretyakov" created="Mon, 11 Aug 2014 15:53:12 +0000"  >&lt;p&gt;Hi Jun Rao, look at &lt;a href=&quot;http://search-hadoop.com/m/4TaT4lonIW&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://search-hadoop.com/m/4TaT4lonIW&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;kafka.consumer:type=&quot;ZookeeperConsumerConnector&quot;,name=&quot;af_servers-af_servers-spm_new_cluster_topic-af_servers_wawanawna-Dell-1401353748289-fcaaea29-0-FetchQueueSize&quot;&lt;/p&gt;

&lt;p&gt;Look at part: &quot;spm_new_cluster_topic-af_servers_wawanawna-Dell&quot;, what is&lt;br/&gt;
host name here &quot;servers_wawanawna-Dell&quot; or &quot;wawanawna-Dell&quot; ?&lt;/p&gt;</comment>
                            <comment id="14093709" author="junrao" created="Tue, 12 Aug 2014 04:22:33 +0000"  >&lt;p&gt;I am not sure exactly what your use cases are, but I was thinking of the following. For the AllTopics metric like below, you can figure out the clientId. Then, you can use that info to parse other beans more reliably.&lt;/p&gt;

&lt;p&gt;&quot;kafka.consumer&quot;:type=&quot;ConsumerTopicMetrics&quot;,name=&quot;test-consumer-group-AllTopicsBytesPerSec&quot;&lt;/p&gt;

&lt;p&gt;I understand that this is still painful. However, my concern is that this patch may fix the issues for some users, but may force other users to change the way they extract mbeans. &lt;/p&gt;</comment>
                            <comment id="14093822" author="vladimir.tretyakov" created="Tue, 12 Aug 2014 07:01:47 +0000"  >&lt;p&gt;Hi Jun Rao, I understood what you suggest, thx, but I am afraid it will not work everywhere or I&apos;ve missed something. Look at example from my local env:&lt;/p&gt;

&lt;p&gt;1) &quot;kafka.producer&quot;:type=&quot;ProducerRequestMetrics&quot;,name=&quot;af-servers-AllBrokersProducerRequestRateAndTimeMs&quot;&lt;/p&gt;

&lt;p&gt;2) &quot;kafka.consumer&quot;:type=&quot;ZookeeperConsumerConnector&quot;,name=&quot;af-servers-af-servers-spm-new-cluster-topic-af-servers-wawanawna-Dell-1401353748289-fcaaea29-0-FetchQueueSize&quot;&lt;/p&gt;

&lt;p&gt;From 1 I can parse &quot;af-servers&quot; as clientId, ok.&lt;/p&gt;

&lt;p&gt;From 2 I have to parse: topic ,groupId, consumer host, timestamp, uuid, num_streams.&lt;/p&gt;

&lt;p&gt;If I remove &quot;af-servers&quot; from 2 I will get &quot;spm-new-cluster-topic-af-servers-wawanawna-Dell-1401353748289-fcaaea29-0-FetchQueueSize&quot;.&lt;/p&gt;

&lt;p&gt;I can extract &quot;timestamp, uuid, num_streams&quot; without problems, now let me talk about this part &quot;spm-new-cluster-topic-af-servers-wawanawna-Dell&quot; I see &quot;af-servers&quot;  in the middle but can I be sure that &quot;clientId&quot; will be always here?&lt;/p&gt;

&lt;p&gt;Why initial bean name contains &quot;af-servers&quot; 3 times? I have a feeling sometimes all these 3 parts may be different and I will not able to parse everything in right way. &lt;/p&gt;

&lt;p&gt;It is painful in general as you mentioned above because we have to remember &quot;context&quot; for parse each line, I am pretty sure nobody like it.&lt;br/&gt;
Even if somebody parse names in way you have described I think they will glad to change its parse mechanism with  more easiest.&lt;/p&gt;</comment>
                            <comment id="14093830" author="joestein" created="Tue, 12 Aug 2014 07:10:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; If this patch is going to cause existing users that are not having a problem issues and it is causing existing users issues by not patching it then can we introduce a configuration so we can accommodate both (default to how it is working now)? Then we can get it in 0.8.2. Thoughts?&lt;/p&gt;</comment>
                            <comment id="14094147" author="junrao" created="Tue, 12 Aug 2014 15:13:16 +0000"  >&lt;p&gt;The name of &quot;FetchQueueSize&quot; is of the following format. If the clientId is not explicitly specified, the groupId will be used. So if you know the clientId, you can parse the rest of the string. You probably don&apos;t need to figure out every part of the mbean name. The most important ones are clientId, groupId and topic. &lt;/p&gt;

&lt;p&gt;config.clientId + &quot;&lt;del&gt;&quot; + config.groupId + &quot;&lt;/del&gt;&quot; + topicThreadId._1 + &quot;-&quot; + topicThreadId._2 + &quot;-FetchQueueSize&quot;&lt;/p&gt;

&lt;p&gt;Joe,&lt;/p&gt;

&lt;p&gt;I am not sure having a config is necessarily better. If we want to fix the mbean names, I&apos;d rather that we fix them once into the end state that we want, instead of patching little by little and changing the names multiple times.&lt;/p&gt;</comment>
                            <comment id="14113641" author="otis" created="Thu, 28 Aug 2014 10:30:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;if you know the clientId, you can parse the rest of the string. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this makes parsers unnecessarily difficult to write and probably harder to maintain.  Parsers have to remember things this way.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If this patch is going to cause existing users that are not having a problem issues &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it won&apos;t cause them issues.  I &lt;b&gt;think&lt;/b&gt; they would just need to change which delimiter character they use to break MBean names into parts.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If it is causing existing users issues by not patching it&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it is causing issues to anyone who has any of the multiple characters Kafka uses as delimiters in their hostnames or topic names.  So I think these people have issues when they first try parsing stuff from JMX, and then they have to go modify their hostnames, topic names and such.&lt;/p&gt;</comment>
                            <comment id="14122025" author="guozhang" created="Thu, 4 Sep 2014 21:47:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; do you think we can check in this ticket in time for 0.8.2?&lt;/p&gt;</comment>
                            <comment id="14127899" author="otis" created="Wed, 10 Sep 2014 01:38:00 +0000"  >&lt;p&gt;Here is a Kafka user who said:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; I have topic name with &#8220;.&#8221;  So, it is hard to distinguish metric name and topic&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;c.f. &lt;a href=&quot;http://search-hadoop.com/m/4TaT4IRD0t1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://search-hadoop.com/m/4TaT4IRD0t1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That&apos;s the sort of problem this patch solves.&lt;/p&gt;</comment>
                            <comment id="14131073" author="nehanarkhede" created="Fri, 12 Sep 2014 03:51:12 +0000"  >&lt;p&gt;This issue has popped up enough times on the mailing list that we should pay attention to it and fix it. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;, what plan would you suggest for fixing this so that the change works for everyone?&lt;/p&gt;</comment>
                            <comment id="14134039" author="junrao" created="Mon, 15 Sep 2014 15:54:56 +0000"  >&lt;p&gt;Ok, I am fine with taking this patch as a stop-gap solution. Since this is going to affect how people monitor Kafka, we probably should have a discussion in the mailing list.&lt;/p&gt;

&lt;p&gt;Otis/Vladimir,&lt;br/&gt;
Do you want to start a discussion thread in our dev and user mailing list that describes the problem, the solution and the impact? If there are no serious concerns, we can commit the patch.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                            <comment id="14143500" author="otis" created="Mon, 22 Sep 2014 17:40:18 +0000"  >&lt;p&gt;This is &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&apos;s new suggestion for dealing with the problem this issue is meant to address: &lt;a href=&quot;http://search-hadoop.com/m/4TaT4aHH1S&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://search-hadoop.com/m/4TaT4aHH1S&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14169396" author="vladimir.tretyakov" created="Mon, 13 Oct 2014 15:28:11 +0000"  >&lt;p&gt;Added another patch which introduce metrics name like pairs (key=value), examples:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.consumer&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;ConsumerTopicMetrics&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;clientId=af_servers,AllTopics,BytesPerSec&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.cluster&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;Partition&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;topic=spm_alerts_topic,partitionId=0,UnderReplicated&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.network&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;SocketServer&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;NetworkProcessorNum=1,IdlePercent&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.server&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;BrokerTopicMetrics&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;topic=spm_topic,MessagesInPerSec&quot;&lt;/span&gt;

&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.server&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetcherStats&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;clientId=af_servers,ConsumerFetcherThread,groupId=af_servers,consumerHostName=wawanawna,timestamp=1413199781501,uuid=58a5cc70,fetcherId=0,sourceBrokerId=0,brokerHost=wawanawna,brokerPort=9092,BytesPerSec&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.server&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetcherLagMetrics&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;clientId=af_servers,ConsumerFetcherThread,groupId=af_servers,consumerHostName=wawanawna,timestamp=1413199781501,uuid=58a5cc70,fetcherId=0,sourceBrokerId=0,brokerHost=wawanawna,brokerPort=9092,topic=spm_topic,partitionId=0,ConsumerLag&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.consumer&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetchRequestAndResponseMetrics&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;clientId=af_servers,ConsumerFetcherThread,groupId=af_servers,consumerHostName=wawanawna,timestamp=1413199781501,uuid=58a5cc70,fetcherId=0,sourceBrokerId=0,brokerHost=wawanawna,brokerPort=9092,FetchResponseSize&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14170275" author="junrao" created="Tue, 14 Oct 2014 00:10:25 +0000"  >&lt;p&gt;Vladimir,&lt;/p&gt;

&lt;p&gt;Thanks for the patch. My suggestion is actually slightly different from what you did. Instead of using&lt;/p&gt;

&lt;p&gt;&quot;kafka.consumer&quot;:type=&quot;ConsumerTopicMetrics&quot;,name=&quot;clientId=af_servers,AllTopics,BytesPerSec&quot;&lt;/p&gt;

&lt;p&gt;I was suggesting&lt;/p&gt;

&lt;p&gt;&quot;kafka.consumer&quot;:type=&quot;ConsumerTopicMetrics&quot;,clientId=&quot;af_servers&quot;,topic=&quot;AllTopics&quot;,name=&quot;BytesPerSec&quot;&lt;/p&gt;

&lt;p&gt;This is probably the more standard mbean name.&lt;/p&gt;

&lt;p&gt;We can do that by using the following method to create MetricName and pass in the mBeanName that we want.&lt;br/&gt;
    public MetricName(String group, String type, String name, String scope, String mBeanName).&lt;/p&gt;

&lt;p&gt;We also need to extend KafkaMetricsGroup by adding new helper functions that take a MetricName explicitly.&lt;br/&gt;
  def newMeter(name: MetricName, eventType: String, timeUnit: TimeUnit)&lt;/p&gt;

&lt;p&gt;Also, your patch doesn&apos;t seem to apply to latest trunk.&lt;br/&gt;
git apply ~/Downloads/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_2014-10-13_18-23-35.patch &lt;br/&gt;
error: core/src/main/scala/kafka/common/ClientIdTopic.scala: No such file or directory&lt;/p&gt;


</comment>
                            <comment id="14171371" author="vladimir.tretyakov" created="Tue, 14 Oct 2014 19:07:26 +0000"  >&lt;p&gt;Hi, Jun, &lt;/p&gt;

&lt;p&gt;Thx that you found a time to look at patch, I&apos;ve added another regarding your suggestion, now in JMX you will see (hope it is what you need):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.server&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetcherStats&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;RequestsPerSec&quot;&lt;/span&gt;,clientId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,threadName=&lt;span class=&quot;code-quote&quot;&gt;&quot;ConsumerFetcherThread&quot;&lt;/span&gt;,groupId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,consumerHostName=&lt;span class=&quot;code-quote&quot;&gt;&quot;wawanawna&quot;&lt;/span&gt;,timestamp=&lt;span class=&quot;code-quote&quot;&gt;&quot;1413306414731&quot;&lt;/span&gt;,uuid=&lt;span class=&quot;code-quote&quot;&gt;&quot;4624cb0f&quot;&lt;/span&gt;,fetcherId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,sourceBrokerId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,brokerHost=&lt;span class=&quot;code-quote&quot;&gt;&quot;wawanawna&quot;&lt;/span&gt;,brokerPort=&lt;span class=&quot;code-quote&quot;&gt;&quot;9092&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.server&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetcherLagMetrics&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;ConsumerLag&quot;&lt;/span&gt;,clientId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,threadName=&lt;span class=&quot;code-quote&quot;&gt;&quot;ConsumerFetcherThread&quot;&lt;/span&gt;,groupId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,consumerHostName=&lt;span class=&quot;code-quote&quot;&gt;&quot;wawanawna&quot;&lt;/span&gt;,timestamp=&lt;span class=&quot;code-quote&quot;&gt;&quot;1413306414731&quot;&lt;/span&gt;,uuid=&lt;span class=&quot;code-quote&quot;&gt;&quot;4624cb0f&quot;&lt;/span&gt;,fetcherId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,sourceBrokerId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,brokerHost=&lt;span class=&quot;code-quote&quot;&gt;&quot;wawanawna&quot;&lt;/span&gt;,brokerPort=&lt;span class=&quot;code-quote&quot;&gt;&quot;9092&quot;&lt;/span&gt;,topic=&lt;span class=&quot;code-quote&quot;&gt;&quot;spm_topic&quot;&lt;/span&gt;,partitionId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.consumer&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;ZookeeperConsumerConnector&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;OwnedPartitionsCount&quot;&lt;/span&gt;,clientId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,groupId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,topic=&lt;span class=&quot;code-quote&quot;&gt;&quot;spm_topic&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;kafka.consumer&quot;&lt;/span&gt;:type=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetchRequestAndResponseMetrics&quot;&lt;/span&gt;,name=&lt;span class=&quot;code-quote&quot;&gt;&quot;FetchResponseSize&quot;&lt;/span&gt;,clientId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,threadName=&lt;span class=&quot;code-quote&quot;&gt;&quot;ConsumerFetcherThread&quot;&lt;/span&gt;,groupId=&lt;span class=&quot;code-quote&quot;&gt;&quot;af_servers&quot;&lt;/span&gt;,consumerHostName=&lt;span class=&quot;code-quote&quot;&gt;&quot;wawanawna&quot;&lt;/span&gt;,timestamp=&lt;span class=&quot;code-quote&quot;&gt;&quot;1413306414731&quot;&lt;/span&gt;,uuid=&lt;span class=&quot;code-quote&quot;&gt;&quot;4624cb0f&quot;&lt;/span&gt;,fetcherId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,sourceBrokerId=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,allBrokers=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
&lt;p&gt;Also, your patch doesn&apos;t seem to apply to latest trunk.&lt;br/&gt;
git apply ~/Downloads/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_2014-10-13_18-23-35.patch &lt;br/&gt;
error: core/src/main/scala/kafka/common/ClientIdTopic.scala: No such file or directory&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Interesting...&lt;br/&gt;
1. I&apos;ve worked with 0.8.2 branch, not trunk&lt;br/&gt;
2. ClientIdTopic.scala - I&apos;ve added this file (must be in patch). &lt;/p&gt;

&lt;p&gt;Added 2 equal patches (created them in different way):&lt;br/&gt;
1. &apos;git diff&apos; (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_2014-10-14_21-53-35.patch)&lt;br/&gt;
2. With help from IDEA IDE. (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_IDEA_IDE_2014-10-14_21-53-35.patch)&lt;/p&gt;

&lt;p&gt;Try please, maybe one of them will work&lt;/p&gt;

&lt;p&gt;Thx again.&lt;/p&gt;</comment>
                            <comment id="14172118" author="vladimir.tretyakov" created="Wed, 15 Oct 2014 08:00:29 +0000"  >&lt;p&gt;Added 2 patches (created with git diff and from IDEA IDE) with a small refactoring in KafkaMetricsGroup.&lt;/p&gt;

&lt;p&gt;Jun can you please double check and change part related to metrics removing (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1567&quot; title=&quot;Metric memory leaking after closing the clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1567&quot;&gt;&lt;del&gt;KAFKA-1567&lt;/del&gt;&lt;/a&gt;) I can&apos;t easily test this code locally, thx a lot.&lt;/p&gt;

&lt;p&gt;PS: all tests passed after this patch for me locally.&lt;/p&gt;</comment>
                            <comment id="14173157" author="junrao" created="Wed, 15 Oct 2014 23:50:12 +0000"  >&lt;p&gt;Thanks for the patch. The IDEA one applies successfully for me. However, it seems to cause compilation failure since in a few cases, two lines are incorrectly merged into a single one. Do you think you can try our patch review tool (&lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Patch+submission+and+review)?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/Patch+submission+and+review)?&lt;/a&gt; Some comments.&lt;/p&gt;

&lt;p&gt;1. KafkaMetricsGroup:&lt;br/&gt;
1.1 We now have 2&lt;br/&gt;
       new MetricName(&quot;kafka.consumer&quot;, &quot;ConsumerTopicMetrics&quot;, &quot;MessagesPerSec&quot;),&lt;br/&gt;
    and 2&lt;br/&gt;
       new MetricName(&quot;kafka.consumer&quot;, &quot;ConsumerTopicMetrics&quot;, &quot;BytesPerSec&quot;),&lt;br/&gt;
1.2 Could we combine the following two methods&lt;br/&gt;
  def newGauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;(name: String, mBeanName: String, metric: Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;)&lt;/p&gt;

&lt;p&gt;  def newGauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;(name: String, metric: Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;) : Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;  to&lt;br/&gt;
  def newGauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;(name: String, metric: Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;, tags: Map&lt;span class=&quot;error&quot;&gt;&amp;#91;String, String&amp;#93;&lt;/span&gt; = Map.empty)? We can then general the metric name based on name and the tags. This will consolidate the metric name generation in a single place. In this patch, we have too many places generating the key/value string for the metric name.&lt;/p&gt;

&lt;p&gt;2. AbstractFetcherThread: &lt;br/&gt;
2.1 name in this class should be just used for the thread name and it shouldn&apos;t be included in the metric name.&lt;br/&gt;
2.2. The way that we get the metric name in classes like ClientIdAndBroker, ClientIdBrokerTopicPartition and ClientIdAndTopic is not consistently. Sometimes, we generate the key/value in the toString(). Some other times, we rely on the key/value string to be passed in. It&apos;s easier to understand if those classes are constructed by just passing in the clientId string, the broker object, the topic string and the partition number, etc. We can generate the metric name by using what&apos;s described in 1.2.&lt;br/&gt;
2.3 FetcherLagStats just needs to take clientId, instead of ClientIdAndBroker since the per partition lag metric is unique per client id.&lt;br/&gt;
2.4 The metric name for a Broker can just use the brokerId, instead of its host and port.&lt;/p&gt;

&lt;p&gt;3. Throttler: Do we need to add mBeanName to the constructor? It seems that nobody is using it at the moment.&lt;/p&gt;

&lt;p&gt;4. KafkaMetricsGroup: We need to change the way how removeAllMetricsInList() works. We need to do equal comparison on group, type and name and do regex matching with clientId on MetricName.mBeanName.&lt;/p&gt;</comment>
                            <comment id="14173425" author="vladimir.tretyakov" created="Thu, 16 Oct 2014 06:26:05 +0000"  >&lt;p&gt;Hi Jun, thx for juicy feedback, few comments fro me:&lt;/p&gt;

&lt;p&gt;1-2. Did it in this way because I didn&apos;t want to change existing code a lot, tried got what we need based on current method signatures. I&apos;ve thought about your approach with Map too, reject it because of larger changes. Now I see that I will do it.&lt;/p&gt;

&lt;p&gt;3. Removed &apos;mBeanName&apos; param, was legacy code.&lt;br/&gt;
4. As I&apos;ve understood from code this method must be called before shutdown in hook, right? We have to remove only metrics related to particular clientId and we shouldn&apos;t touch others, right?&lt;/p&gt;</comment>
                            <comment id="14173792" author="junrao" created="Thu, 16 Oct 2014 14:16:03 +0000"  >&lt;p&gt;4. removeAllMetricsInList() will be called when a producer/consumer instance is closed to remove metrics related to a specific client id.&lt;/p&gt;</comment>
                            <comment id="14177149" author="vladimir.tretyakov" created="Mon, 20 Oct 2014 17:29:24 +0000"  >&lt;p&gt;Hi, fuf&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, created new patch (for 0.8.2 branch).&lt;/p&gt;

&lt;p&gt;re 2.1, 2.3 - didn&apos;t change this part because we use this part in our monitoring, it is more handy for user to see something like &apos;localhost:9092&apos; instead of &apos;2 (where 2 is broker id)&apos;. For us it is easiest to see/have this information directly in mBean.&lt;/p&gt;

&lt;p&gt;With this patch mBeanNames look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;kafka.producer:type=ProducerTopicMetrics,name=MessagesPerSec,topic=spm_alerts_topic
kafka.producer:type=ProducerTopicMetrics,name=MessagesPerSec,allTopics=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
kafka.log:type=Log,name=LogEndOffset,topic=spm_alerts_topic,partitionId=0
kafka.consumer:type=ZookeeperConsumerConnector,name=FetchQueueSize,timestamp=1413817796508,clientId=af_servers,uuid=9f99df40,groupId=af_servers,topicThreadId=spm_topic,consumerHostName=wawanawna,threadId=0
kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=af_servers,threadName=ConsumerFetcherThread,fetcherId=0,sourceBrokerId=0,groupId=af_servers,consumerHostName=wawanawna,timestamp=1413817796508,uuid=9f99df40,brokerHost=wawanawna,brokerPort=9092
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is not everything clear for me in code, so I&apos;ve tried to avoid deep refactoring. All tests passed for me locally.&lt;/p&gt;

&lt;p&gt;PS: note that if &apos;value&apos; part is empty (in key-&amp;gt;value structure) we will not see this part in attributes.&lt;br/&gt;
example: &quot;key1&quot;&lt;del&gt;&amp;gt;&quot;value1&quot;,&quot;key2&quot;&lt;/del&gt;&amp;gt;null,&quot;key3&quot;-&amp;gt;&quot;value3&quot; will be converted to &quot;key1=value1,key3=value3&quot;.&lt;/p&gt;




</comment>
                            <comment id="14177250" author="junrao" created="Mon, 20 Oct 2014 18:24:17 +0000"  >&lt;p&gt;Thanks for the patch. It doesn&apos;t seem to apply. Could you rebase?&lt;/p&gt;

&lt;p&gt;git apply -p0 ~/Downloads/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_IDEA_IDE_2014-10-20_20-14-35.patch &lt;br/&gt;
error: core/src/main/scala/kafka/common/ClientIdTopic.scala: No such file or directory&lt;br/&gt;
error: patch failed: core/src/main/scala/kafka/server/KafkaApis.scala:285&lt;br/&gt;
error: core/src/main/scala/kafka/server/KafkaApis.scala: patch does not apply&lt;br/&gt;
error: patch failed: core/src/test/scala/integration/kafka/api/ProducerCompressionTest.scala:74&lt;br/&gt;
error: core/src/test/scala/integration/kafka/api/ProducerCompressionTest.scala: patch does not apply&lt;br/&gt;
error: patch failed: core/src/main/scala/kafka/consumer/PartitionAssignor.scala:101&lt;br/&gt;
error: core/src/main/scala/kafka/consumer/PartitionAssignor.scala: patch does not apply&lt;br/&gt;
error: patch failed: core/src/test/scala/integration/kafka/api/ProducerFailureHandlingTest.scala:17&lt;br/&gt;
error: core/src/test/scala/integration/kafka/api/ProducerFailureHandlingTest.scala: patch does not apply&lt;/p&gt;</comment>
                            <comment id="14177423" author="vladimir.tretyakov" created="Mon, 20 Oct 2014 20:30:09 +0000"  >&lt;p&gt;Hi, thx for quick reply, did rebase, added new patches (1 was created by git, 1 by IDEA IDE).&lt;/p&gt;</comment>
                            <comment id="14177717" author="junrao" created="Tue, 21 Oct 2014 00:38:30 +0000"  >&lt;p&gt;It still doesn&apos;t apply.&lt;/p&gt;

&lt;p&gt;git apply -p0 ~/Downloads/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_IDEA_IDE_2014-10-20_23-14-35.patch &lt;br/&gt;
/Users/junrao/Downloads/&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_IDEA_IDE_2014-10-20_23-14-35.patch:311: trailing whitespace.&lt;br/&gt;
           })  &lt;br/&gt;
error: core/src/main/scala/kafka/common/TopicInfo.scala: No such file or directory&lt;/p&gt;

&lt;p&gt;Does the patch apply on a fresh checkout for you?&lt;/p&gt;</comment>
                            <comment id="14178039" author="vladimir.tretyakov" created="Tue, 21 Oct 2014 06:48:36 +0000"  >&lt;p&gt;Hi, added last patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_2014-10-21_09-14-35.patch). Worked for me locally (previous worked too&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ).&lt;br/&gt;
There are commands I&apos;ve used:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PATCH CREATION
wawanawna@wawanawna:/home/storage/sematext/src/kfk2/kafka$ git status
On branch 0.8.2
Your branch is up-to-date with &lt;span class=&quot;code-quote&quot;&gt;&apos;origin/0.8.2&apos;&lt;/span&gt;.

Changes to be committed:
  (use &lt;span class=&quot;code-quote&quot;&gt;&quot;git reset HEAD &amp;lt;file&amp;gt;...&quot;&lt;/span&gt; to unstage)

	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; file:   core/src/main/scala/kafka/common/BrokerInfo.scala
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; file:   core/src/main/scala/kafka/common/ClientIdTopic.scala
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; file:   core/src/main/scala/kafka/common/Taggable.scala
	renamed:    core/src/main/scala/kafka/common/ClientIdAndTopic.scala -&amp;gt; core/src/main/scala/kafka/common/TopicInfo.scala
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; file:   core/src/main/scala/kafka/consumer/ConsumerFetcherThreadId.scala
	&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; file:   core/src/main/scala/kafka/consumer/ConsumerId.scala

Changes not staged &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commit:
  (use &lt;span class=&quot;code-quote&quot;&gt;&quot;git add &amp;lt;file&amp;gt;...&quot;&lt;/span&gt; to update what will be committed)
  (use &lt;span class=&quot;code-quote&quot;&gt;&quot;git checkout -- &amp;lt;file&amp;gt;...&quot;&lt;/span&gt; to discard changes in working directory)

	modified:   core/src/main/scala/kafka/admin/AdminUtils.scala
	modified:   core/src/main/scala/kafka/api/HeartbeatRequestAndHeader.scala
	modified:   core/src/main/scala/kafka/api/HeartbeatResponseAndHeader.scala
	modified:   core/src/main/scala/kafka/api/JoinGroupRequestAndHeader.scala
	modified:   core/src/main/scala/kafka/api/JoinGroupResponseAndHeader.scala
	modified:   core/src/main/scala/kafka/api/RequestKeys.scala
	modified:   core/src/main/scala/kafka/cluster/Partition.scala
...
...
...
wawanawna@wawanawna:/home/storage/sematext/src/kfk2/kafka$ git commit -a -m &lt;span class=&quot;code-quote&quot;&gt;&apos;kafka-1481; JMX renaming&apos;&lt;/span&gt;
[0.8.2 a232af6] kafka-1481; JMX renaming
 73 files changed, 666 insertions(+), 435 deletions(-)
 create mode 100644 core/src/main/scala/kafka/common/BrokerInfo.scala
 create mode 100644 core/src/main/scala/kafka/common/ClientIdTopic.scala
 create mode 100644 core/src/main/scala/kafka/common/Taggable.scala
 rename core/src/main/scala/kafka/common/{ClientIdAndTopic.scala =&amp;gt; TopicInfo.scala} (68%)
 create mode 100644 core/src/main/scala/kafka/consumer/ConsumerFetcherThreadId.scala
 create mode 100644 core/src/main/scala/kafka/consumer/ConsumerId.scala
wawanawna@wawanawna:/home/storage/sematext/src/kfk2/kafka$ git log | head -n 20
commit a232af63b8a1f43054994a74520b31ef7b9b347c
Author: wawanawna &amp;lt;sematex@mail.com&amp;gt;
Date:   Tue Oct 21 09:29:31 2014 +0300

    kafka-1481; JMX renaming

commit eb7ac9eb7eebc4e0655b65e07cae594e61a6c05e
Author: Jun Rao &amp;lt;junrao@gmail.com&amp;gt;
Date:   Mon Oct 20 11:09:31 2014 -0700

    kafka-1717; remove netty dependency through ZK 3.4.x; patched by Jun Rao; reviewed by Sriharsha Chintalapani and Neha Narkhede


wawanawna@wawanawna:/home/storage/sematext/src/kfk2/kafka$ git diff eb7ac9eb7eebc4e0655b65e07cae594e61a6c05e a232af63b8a1f43054994a74520b31ef7b9b347c &amp;gt; /tmp/KAFKA-1481_2014-10-21_09-14-35.patch

PATCH APPLYING

wawanawna@wawanawna:/home/storage/sematext/src/kfk3$ git clone https:&lt;span class=&quot;code-comment&quot;&gt;//github.com/apache/kafka.git
&lt;/span&gt;

wawanawna@wawanawna:/home/storage/sematext/src/kfk3/kafka$ git checkout -b 0.8.2 origin/0.8.2
Branch 0.8.2 set up to track remote branch 0.8.2 from origin.
Switched to a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; branch &lt;span class=&quot;code-quote&quot;&gt;&apos;0.8.2&apos;&lt;/span&gt;


wawanawna@wawanawna:/home/storage/sematext/src/kfk3/kafka$ git apply /tmp/KAFKA-1481_2014-10-21_09-14-35.patch
/tmp/KAFKA-1481_2014-10-21_09-14-35.patch:1410: trailing whitespace.
           })  
warning: 1 line adds whitespace errors.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is warning, but everything works (compilation/tests passed without errors)&lt;/p&gt;

&lt;p&gt;PS: please tell me what I am doing wrong.&lt;br/&gt;
wawanawna@wawanawna:/home/storage/sematext/src/kfk3/kafka$ git --version&lt;br/&gt;
git version 1.9.1&lt;/p&gt;</comment>
                            <comment id="14178592" author="otis" created="Tue, 21 Oct 2014 16:28:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joestump&quot; class=&quot;user-hover&quot; rel=&quot;joestump&quot;&gt;joestump&lt;/a&gt; can we pleeeeeease have this back in 0.8.2?  The patch is ready, just needs to be merged in.  We&apos;ve been working very, very hard to get this into 0.8.2.&lt;/p&gt;</comment>
                            <comment id="14178739" author="junrao" created="Tue, 21 Oct 2014 17:53:31 +0000"  >&lt;p&gt;Otis,&lt;/p&gt;

&lt;p&gt;Yes, we can include this in the 0.8.2 final release. Does that sound good? Thanks,&lt;/p&gt;</comment>
                            <comment id="14178815" author="vladimir.tretyakov" created="Tue, 21 Oct 2014 18:42:22 +0000"  >&lt;p&gt;Hi, Jun, will be perfect!&lt;/p&gt;</comment>
                            <comment id="14179092" author="bmis13" created="Tue, 21 Oct 2014 20:57:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Can you please let me know if this will also address the &lt;span class=&quot;error&quot;&gt;&amp;#91;New Java Producer&amp;#93;&lt;/span&gt; metrics() method and which client.id or topic has special chars ?  So we have consistent naming across all JMX name bean or metrics() methods ?&lt;/p&gt;

&lt;p&gt;Here is background on this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Bhavesh,

Yes, allowing dot in clientId and topic makes it a bit harder to define the
JMX bean names. I see a couple of solutions here.

1. Disable dot in clientId and topic names. The issue is that dot may
already be used in existing deployment.

2. We can represent the JMX bean name differently in the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; producer.
Instead of
  kafka.producer.myclientid:type=mytopic
we could change it to
  kafka.producer:clientId=myclientid,topic=mytopic

I felt that option 2 is probably better since it doesn&apos;t affect existing
users.

Otis,

We probably can also use option 2 to address KAFKA-1481. For topic/clientid
specific metrics, we could explicitly specify the metric name so that it
contains &lt;span class=&quot;code-quote&quot;&gt;&quot;topic=mytopic,clientid=myclientid&quot;&lt;/span&gt;. That seems to be a much
cleaner way than having all parts included in a single string separated by
&lt;span class=&quot;code-quote&quot;&gt;&apos;|&apos;&lt;/span&gt;.

Thanks,

Jun
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Bhavesh &lt;/p&gt;</comment>
                            <comment id="14179102" author="junrao" created="Tue, 21 Oct 2014 21:08:10 +0000"  >&lt;p&gt;Thanks for the patch. Some comments below.&lt;/p&gt;

&lt;p&gt;20. KafkaMetricsGroup:&lt;br/&gt;
20.1 In the following, instead of doing map(kv =&amp;gt; ), could we do map &lt;/p&gt;
{ case(key, value) =&amp;gt; }
&lt;p&gt;?&lt;br/&gt;
        .filter(_._2 != &quot;&quot;).map(kv =&amp;gt; &quot;%s=%s&quot;.format(kv._1, kv._2))&lt;br/&gt;
20.2 In the following, shouldn&apos;t the pattern be (&quot;.&lt;b&gt;&quot; + &quot;clientId=&quot; + clientId + &quot;.&lt;/b&gt;&quot;).r&lt;br/&gt;
      val pattern = (&quot;.&lt;b&gt;&quot; + clientId + &quot;.&lt;/b&gt;&quot;).r&lt;/p&gt;

&lt;p&gt;21. TaggableInfo: tags should be an immutable hashmap, right?&lt;br/&gt;
case class TaggableInfo(tags: mutable.LinkedHashMap&lt;span class=&quot;error&quot;&gt;&amp;#91;String, String&amp;#93;&lt;/span&gt;) extends Taggable {&lt;/p&gt;

&lt;p&gt;22. New files:&lt;br/&gt;
22.1 The license header should be at the very beginning, before the package and import.&lt;br/&gt;
22.2 I am not sure if we really need to have the Taggable trait. For example, in ConsumerTopicMetrics, we can just take the original clientIdAndTopic and explicitly create the tag for clientId and topic when creating those metrics. The tags are really specific to the metrics. So, we probably don&apos;t need to expose them in places other than where the metrics are created.&lt;/p&gt;

&lt;p&gt;23. ReplicaFetcherManager: The first statement in shutdown() is on the same line as the method. A similar issue happens in a few other classes like RequestChannel and ConsumerFetcherManager. Perhaps you can follow the patch creation process in &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/Patch+submission+and+review#Patchsubmissionandreview-Simplecontributorworkflow&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/Patch+submission+and+review#Patchsubmissionandreview-Simplecontributorworkflow&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;24. FetchRequestAndResponseStatsRegistry.removeConsumerFetchRequestAndResponseStats(): Should we use &quot;clientId=&quot; + clientId in pattern?&lt;/p&gt;

&lt;p&gt;25. SimpleConsumer: Ideally, we shouldn&apos;t change the constructor since this will be an api change.&lt;/p&gt;

&lt;p&gt;26. Could you add a unit test to make sure that after a producer/consumer is closed, all metrics specific to the producer/consumer are removed?&lt;/p&gt;</comment>
                            <comment id="14179132" author="junrao" created="Tue, 21 Oct 2014 21:22:43 +0000"  >&lt;p&gt;Bhavesh,&lt;/p&gt;

&lt;p&gt;Created a subtask to track the metric name in the new producer. Thanks,&lt;/p&gt;</comment>
                            <comment id="14179935" author="otis" created="Wed, 22 Oct 2014 14:08:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; - in interest of getting this into 0.8.2 can we please just make sure the MBeans look good &quot;on the outside&quot;, commit that, and then iterate on improving the internals?&lt;/p&gt;</comment>
                            <comment id="14180056" author="junrao" created="Wed, 22 Oct 2014 15:34:36 +0000"  >&lt;p&gt;Otis,&lt;/p&gt;

&lt;p&gt;I expect that we will have about another 4 weeks before 0.8.2 final is released. That should give us enough time to iterate on this, right? Since the patch touches many files, I&apos;d prefer that we get a clean version upfront.&lt;/p&gt;</comment>
                            <comment id="14182670" author="vladimir.tretyakov" created="Fri, 24 Oct 2014 11:05:55 +0000"  >&lt;p&gt;Hi Jun, thx for your feedback again, attached new patch.&lt;/p&gt;

&lt;p&gt;20.1 done.&lt;br/&gt;
20.2 &quot;clientId&quot; is &quot;Taggable&quot; here, it will convert to something like &quot;clientId=XXX&quot; automatically&lt;br/&gt;
21 tags should be Map which iterators iterate in the same order elements were inserted (final string must be stable): from LinkedHashMap docs &quot;The iterator and all traversal methods of this class visit elements in the order they were inserted.&quot;. I am new in scala, if you know better candidate with predictable iterators please let me know&lt;br/&gt;
22.1 done&lt;br/&gt;
22.2 clientId is not always just &quot;clientId=XXX&quot;, look at:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ConsumerFetcherThread(consumerFetcherThreadId: ConsumerFetcherThreadId,
                            val config: ConsumerConfig,
                            sourceBroker: Broker,
                            partitionMap: Map[TopicAndPartition, PartitionTopicInfo],
                            val consumerFetcherManager: ConsumerFetcherManager)
        &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractFetcherThread(name = consumerFetcherThreadId,
                                      clientId = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaggableInfo(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaggableInfo(&lt;span class=&quot;code-quote&quot;&gt;&quot;clientId&quot;&lt;/span&gt; -&amp;gt; config.clientId), consumerFetcherThreadId),  
                                      sourceBroker = sourceBroker,
                                      socketTimeout = config.socketTimeoutMs,
                                      socketBufferSize = config.socketReceiveBufferBytes,
                                      fetchSize = config.fetchMessageMaxBytes,
                                      fetcherBrokerId = Request.OrdinaryConsumerId,
                                      maxWait = config.fetchWaitMaxMs,
                                      minBytes = config.fetchMinBytes,
                                      isInterruptible = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;this &quot;clientId = new TaggableInfo(new TaggableInfo(&quot;clientId&quot; -&amp;gt; config.clientId), consumerFetcherThreadId)&quot; part was in code before my changes (was manipulation with strings, not &quot;Taggable&quot; of course). Yeah, somewhere in code we can use string instead of &quot;Taggable&quot;, but maybe it is better to has &quot;Taggable&quot; everywhere what is related to metrics. At least it was not easy to me decide where I have to use &quot;Taggable&quot;, but where I can leave string. I&apos;d prefer &quot;Taggable&quot; everywhere in this case, sorry&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;23. done everything as described by link, checked how it works/applies on &apos;origin/0.8.2&apos; from scratch.&lt;br/&gt;
24. see 22.2&lt;br/&gt;
25. agree, added second constructor with &apos;String&apos; as clientId, can&apos;t remove constructor with &quot;Taggable&quot; as clientId because as you can see in 22.2 sometimes clientId is not just &quot;clientId&quot; but something more complex.&lt;br/&gt;
26. added &apos;MetricsLeakTest&apos;, basic idea is start/stop many producers/consumes and observe count of metrics in Metrics.defaultRegistry(), count should not grow.&lt;/p&gt;</comment>
                            <comment id="14186124" author="junrao" created="Tue, 28 Oct 2014 00:35:10 +0000"  >&lt;p&gt;Vladimir,&lt;/p&gt;

&lt;p&gt;Thanks for the patch. Really appreciate your help. I realized that this is one of the biggest technical debt that we have accumulated over time. So, it may take some time to sort this out. So, bear with me. Some more comments.&lt;/p&gt;

&lt;p&gt;30. About Taggable, I still have mixed feelings. I can see why you created it. However, my reasoning is that for a lot of the case classes (ClientIdTopic, CliendIdAndBroker) that we create, it&apos;s weird that some of them are taggable and some of them are not, depending whether they are used for tagging metric names or not. Those classes have no direct relationships with the metrics. Similarly, we only need to be aware of tags when creating metrics. Also, because of this, we change the constructor of SimpleConsumer. Since this is an API change, we should really try to avoid it. &lt;/p&gt;

&lt;p&gt;My feeling is that it&apos;s probably simpler if we just create regular case classes as before and generate metric tags explicitly when we create the metric. For example, in AbstractFetcherThread, we can do&lt;/p&gt;

&lt;p&gt;class FetcherStats(clientIdAndBroker: ClientIdAndBroker) extends KafkaMetricsGroup {&lt;br/&gt;
  val requestRate = newMeter(&quot;RequestsPerSec&quot;, &quot;requests&quot;, TimeUnit.SECONDS,&lt;br/&gt;
                                                Map(&quot;cliendId&quot; -&amp;gt; clientIdAndBroker.clientId,&lt;br/&gt;
                                                        &quot;brokerHost&quot; -&amp;gt; clientIdAndBroker.host,&lt;br/&gt;
                                                        &quot;brokerPort&quot; -&amp;gt; clientIdAndBroker.port))&lt;/p&gt;

&lt;p&gt;and just have ClientIdAndBroker be the following case class.&lt;/p&gt;

&lt;p&gt;case class ClientIdAndBroker(clientId: String, host: String, port: Int)&lt;/p&gt;

&lt;p&gt;This way, the code is a bit cleaner since all the metric tag related stuff are isolated to those places when the metrics are created. So, I&apos;d suggest that we remove Taggable.&lt;/p&gt;

&lt;p&gt;31. AbstractFetcherThread:&lt;br/&gt;
31.1 You changed the meaning of clientId. clientId is used in the fetch request and we want to leave it as just the clientId string. Since the clientId should be uniquely representing a particular consumer client, we just need to include the clientId in the metric name. We don&apos;t need to include the consumer id in either the fetch request or the metric name since it&apos;s too long and has redundant info. &lt;br/&gt;
31.2 FetcherLagStats: This is an existing problem. FetcherLagMetrics shouldn&apos;t be keyed off ClientIdBrokerTopicPartition. It should be keyed off ClientIdTopicPartition. This way, the metric name remains the same independent of the current leader of those partitions.&lt;/p&gt;

&lt;p&gt;32. ZookeeperConsumerConnector:&lt;br/&gt;
32.1 FetchQueueSize: I agree that the metric name just needs to be tagged with clientId, topic and threadId. We don&apos;t need to include the consumerId since it&apos;s too long (note that topicThread._2 includes both the consumerId and the threadId).&lt;/p&gt;

&lt;p&gt;33. KafkaMetricsGroup: Duplicate entries.&lt;br/&gt;
    // kafka.consumer.ConsumerTopicStats &amp;lt;-- kafka.consumer.&lt;/p&gt;
{ConsumerIterator, PartitionTopicInfo}
&lt;p&gt;    explicitMetricName(&quot;kafka.consumer&quot;, &quot;ConsumerTopicMetrics&quot;, &quot;MessagesPerSec&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;ConsumerTopicMetrics&quot;, &quot;MessagesPerSec&quot;),&lt;/p&gt;

&lt;p&gt;    // kafka.consumer.ConsumerTopicStats&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;ConsumerTopicMetrics&quot;, &quot;BytesPerSec&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;ConsumerTopicMetrics&quot;, &quot;BytesPerSec&quot;),&lt;/p&gt;

&lt;p&gt;    // kafka.consumer.FetchRequestAndResponseStats &amp;lt;-- kafka.consumer.SimpleConsumer&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;FetchRequestAndResponseMetrics&quot;, &quot;FetchResponseSize&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;FetchRequestAndResponseMetrics&quot;, &quot;FetchRequestRateAndTimeMs&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;FetchRequestAndResponseMetrics&quot;, &quot;FetchResponseSize&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.consumer&quot;, &quot;FetchRequestAndResponseMetrics&quot;, &quot;FetchRequestRateAndTimeMs&quot;),&lt;/p&gt;

&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ProducerRequestStats &amp;lt;-- SyncProducer&lt;/li&gt;
	&lt;li&gt;metric for SyncProducer in fetchTopicMetaData() needs to be removed when consumer is closed.&lt;br/&gt;
     */&lt;br/&gt;
    explicitMetricName(&quot;kafka.producer&quot;, &quot;ProducerRequestMetrics&quot;, &quot;ProducerRequestRateAndTimeMs&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.producer&quot;, &quot;ProducerRequestMetrics&quot;, &quot;ProducerRequestSize&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.producer&quot;, &quot;ProducerRequestMetrics&quot;, &quot;ProducerRequestRateAndTimeMs&quot;),&lt;br/&gt;
    explicitMetricName(&quot;kafka.producer&quot;, &quot;ProducerRequestMetrics&quot;, &quot;ProducerRequestSize&quot;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;34. AbstractFetcherManager: Could you put the followings in 2 separate lines? Similar things happen in a few other files. Perhaps you need to change the formatting in your IDE?&lt;/p&gt;

&lt;p&gt;   }, metricPrefix.toTags&lt;/p&gt;

&lt;p&gt;  private def getFetcherId(topic: String, partitionId: Int) : Int = {    Utils.abs(31 * topic.hashCode() + partitionId) % numFetchers&lt;/p&gt;
</comment>
                            <comment id="14188553" author="vladimir.tretyakov" created="Wed, 29 Oct 2014 16:46:03 +0000"  >&lt;p&gt;Hi Jun, thx for juicy feedback again, one question:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;31. AbstractFetcherThread:&lt;br/&gt;
31.1 You changed the meaning of clientId. clientId is used in the fetch request and we want to leave it as just the clientId string. Since the clientId should be uniquely representing a particular consumer client, we just need to include the clientId in the metric name. We don&apos;t need to include the consumer id in either the fetch request or the metric name since it&apos;s too long and has redundant info. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I didn&apos;t change meaning of clientId here, look (all code without my changes):&lt;/p&gt;

&lt;p&gt;consumerIdString string is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val consumerIdString = {
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; consumerUuid : &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
    config.consumerId match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(consumerId) &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; testing only
&lt;/span&gt;      =&amp;gt; consumerUuid = consumerId
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None &lt;span class=&quot;code-comment&quot;&gt;// generate unique consumerId automatically
&lt;/span&gt;      =&amp;gt; val uuid = UUID.randomUUID()
      consumerUuid = &lt;span class=&quot;code-quote&quot;&gt;&quot;%s-%d-%s&quot;&lt;/span&gt;.format(
        InetAddress.getLocalHost.getHostName, &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis,
        uuid.getMostSignificantBits().toHexString.substring(0,8))
    }
    config.groupId + &lt;span class=&quot;code-quote&quot;&gt;&quot;_&quot;&lt;/span&gt; + consumerUuid
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;thread name is (consumerIdString + fetcherId + sourceBroker.id):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; override def createFetcherThread(fetcherId: Int, sourceBroker: Broker): AbstractFetcherThread = {
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConsumerFetcherThread(
      &lt;span class=&quot;code-quote&quot;&gt;&quot;ConsumerFetcherThread-%s-%d-%d&quot;&lt;/span&gt;.format(consumerIdString, fetcherId, sourceBroker.id),
      config, sourceBroker, partitionMap, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;clientId inside AbstractFetcherThread is: config.clientId + consumerIdString + fetcherId + sourceBroker.id&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ConsumerFetcherThread(name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
                            val config: ConsumerConfig,
                            sourceBroker: Broker,
                            partitionMap: Map[TopicAndPartition, PartitionTopicInfo],
                            val consumerFetcherManager: ConsumerFetcherManager)
        &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractFetcherThread(name = name, 
                                      clientId = config.clientId + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt; + name,
                                      sourceBroker = sourceBroker,
                                      socketTimeout = config.socketTimeoutMs,
                                      socketBufferSize = config.socketReceiveBufferBytes,
                                      fetchSize = config.fetchMessageMaxBytes,
                                      fetcherBrokerId = Request.OrdinaryConsumerId,
                                      maxWait = config.fetchWaitMaxMs,
                                      minBytes = config.fetchMinBytes,
                                      isInterruptible = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you see there is no clean clientId inside AbstractFetcherThread class and it is not unique situation, and this is main goal why I added Taggable.&lt;br/&gt;
Now I am trying to remove Taggable, but I have no idea what to do with such cases I&apos;ve described. Can I add new &apos;clientId&apos; parameter to all these classes and use only this new/clean clientId as part of matric name? Any other suggestions? Thx.&lt;/p&gt;

&lt;p&gt;PS: there is no way t get &apos;clean&apos; parameters in such classes and build map for metrics just here, I must stretching parameters during all classes as Taggable. &lt;br/&gt;
PSS: Can we use more interactive way for communication, Jira is not a bets way for discussion/explanation, not fast at least&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14190581" author="vladimir.tretyakov" created="Thu, 30 Oct 2014 18:40:14 +0000"  >&lt;p&gt;Hi Jun, added new patch, removed Taggable, did everything as you have suggested.&lt;/p&gt;</comment>
                            <comment id="14191115" author="junrao" created="Fri, 31 Oct 2014 00:42:07 +0000"  >&lt;p&gt;Thanks for the patch. Looks good overall. Some minor comments below.&lt;/p&gt;

&lt;p&gt;40. KafkaMetricsGroup:&lt;br/&gt;
40.1 Since we already match the metric name directly, shouldn&apos;t the following pattern&lt;br/&gt;
           val pattern = (&quot;.&lt;b&gt;&quot; + metric.getName + &quot;.&lt;/b&gt;&quot; + clientId + &quot;.*&quot;).r&lt;br/&gt;
       be&lt;br/&gt;
           val pattern = (&quot;.&lt;b&gt;clientId=&quot; + clientId + &quot;.&lt;/b&gt;&quot;).r&lt;br/&gt;
40.2 Can we make toMBeanName() private?&lt;br/&gt;
40.3 According to &lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/javax/management/ObjectName.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/7/docs/api/javax/management/ObjectName.html&lt;/a&gt;,  the key properties in an Mbean objectname are a set of unordered keys. So, we don&apos;t need the toMap() method. The caller can just create the Map using Map(&quot;tag1&quot;&lt;del&gt;&amp;gt;&quot;val1&quot;, &quot;tag1&quot;&lt;/del&gt;&amp;gt;va2&quot;). &lt;/p&gt;

&lt;p&gt;41. FetchRequestAndResponseMetrics: The following two lines should be in the same line.&lt;br/&gt;
  val tags = metricId&lt;br/&gt;
  match {&lt;/p&gt;

&lt;p&gt;42. Log, Partition,AbstractFetcherThread,ProducerRequestPurgatory: &quot;partitionId&quot; =&amp;gt; &quot;partition&quot;&lt;/p&gt;

&lt;p&gt;43. TopicPartitionRequestKey: We don&apos;t need keyLabel() any more. Instead, we can override the toString() method to get the string in the same way as that in TopicAndPartition.toString().&lt;/p&gt;

&lt;p&gt;44. RequestChannel: Lower case &quot;processor&quot; in the following.&lt;br/&gt;
      toMap(&quot;Processor&quot; -&amp;gt; i.toString)&lt;/p&gt;

&lt;p&gt;45. SocketServer: &quot;NetworkProcessor&quot; =&amp;gt;  &quot;networkProcessor&quot;&lt;/p&gt;

&lt;p&gt;46. ZookeeperConsumerConnector: Could we put the new Gauge and the toMap() into a separate line?&lt;br/&gt;
    newGauge(&quot;OwnedPartitionsCount&quot;, new Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt; &lt;/p&gt;
{
      def value() = allTopicsOwnedPartitionsCount
    }
&lt;p&gt;, toMap(&quot;clientId&quot; -&amp;gt; config.clientId, &quot;groupId&quot; -&amp;gt; config.groupId, &quot;allTopics&quot; -&amp;gt; &quot;true&quot;))&lt;/p&gt;

&lt;p&gt;              newGauge(&quot;OwnedPartitionsCount&quot;, new Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt; &lt;/p&gt;
{
                def value() = partitionThreadPairs.size
              }
&lt;p&gt;, ownedPartitionsCountMetricName(topic))&lt;/p&gt;</comment>
                            <comment id="14191698" author="vladimir.tretyakov" created="Fri, 31 Oct 2014 11:16:18 +0000"  >&lt;p&gt;Hi Jun, added new one, changed according to your last comments.&lt;/p&gt;</comment>
                            <comment id="14192034" author="junrao" created="Fri, 31 Oct 2014 16:44:23 +0000"  >&lt;p&gt;Thanks for the patch. A few more comments.&lt;/p&gt;

&lt;p&gt;50. ClientIdBroker: Instead of having 2 subclasses, would it be better to have just one class&lt;br/&gt;
  case class ClientIdAndBroker(clientId: String, brokerHost: Option&lt;span class=&quot;error&quot;&gt;&amp;#91;String&amp;#93;&lt;/span&gt;, brokerPort: Option&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt;)?&lt;br/&gt;
Ditto to ClientIdTopic.&lt;/p&gt;

&lt;p&gt;51. TopicPartitionRequestKey: Can this just be TopicAndPartition?&lt;/p&gt;

&lt;p&gt;52. MetricsTest:&lt;br/&gt;
52.1 Could we remove the extra empty lines after the class?&lt;br/&gt;
52.2 remove unnecessary {} in the following (a few other files have a similar issue)&lt;br/&gt;
import java.util.&lt;/p&gt;
{Properties}
&lt;p&gt;52.3 In testMetricsLeak(), you don&apos;t need to create a new zkClient. You can get one from the base class in ZooKeeperTestHarness.&lt;br/&gt;
52.4 Instead of duplicating the createAndShutdownStep() calls, could we use a loop instead?&lt;br/&gt;
52.5 Instead of duplicating sendMessages() and getMessages() from ZookeeperConsumerConnectorTest, could we extract those methods to TestUtils and add comments to describe what they do? Then, we can reuse those methods.&lt;/p&gt;

&lt;p&gt;53. Could you also include a patch to the 0.8.2 doc (&lt;a href=&quot;https://svn.apache.org/repos/asf/kafka/site/082/ops.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/kafka/site/082/ops.html&lt;/a&gt;) with the metric name changes?&lt;/p&gt;



</comment>
                            <comment id="14194551" author="vladimir.tretyakov" created="Mon, 3 Nov 2014 14:08:01 +0000"  >&lt;p&gt;Hi, added new patch&lt;/p&gt;

&lt;p&gt;50. I think it is better to have separate case class for &apos;all&apos; things. It is real &apos;other&apos; case.&lt;br/&gt;
51. Done&lt;br/&gt;
52.1 Done&lt;br/&gt;
52.2 Done&lt;br/&gt;
52.3 Done&lt;br/&gt;
52.4 Done&lt;br/&gt;
52.5 Done&lt;br/&gt;
53. &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12678927/KAFKA-1481_2014-11-03_16-39-41_doc.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12678927/KAFKA-1481_2014-11-03_16-39-41_doc.patch&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14195545" author="junrao" created="Tue, 4 Nov 2014 01:46:55 +0000"  >&lt;p&gt;Thanks for the patch. Just some minor comments below. Otherwise, +1 from me.&lt;/p&gt;

&lt;p&gt;60. AbstractFetcherManager: In the following, we don&apos;t need to wrap new Gauge in {}.&lt;br/&gt;
  &quot;MinFetchRate&quot;, {&lt;br/&gt;
    new Gauge&lt;span class=&quot;error&quot;&gt;&amp;#91;Double&amp;#93;&lt;/span&gt; {&lt;br/&gt;
      // current min fetch rate across all fetchers/topics/partitions&lt;br/&gt;
      def value = {&lt;br/&gt;
        val headRate: Double =&lt;br/&gt;
          fetcherThreadMap.headOption.map(_._2.fetcherStats.requestRate.oneMinuteRate).getOrElse(0)&lt;/p&gt;

&lt;p&gt;        fetcherThreadMap.foldLeft(headRate)((curMinAll, fetcherThreadMapEntry) =&amp;gt; &lt;/p&gt;
{
          fetcherThreadMapEntry._2.fetcherStats.requestRate.oneMinuteRate.min(curMinAll)
        }
&lt;p&gt;)&lt;br/&gt;
      }&lt;br/&gt;
    }&lt;br/&gt;
  },&lt;/p&gt;

&lt;p&gt;61. AbstractFetcherThread: Could we align &quot;topic&quot; and &quot;partition&quot; to the same column as &quot;clientId&quot;? Ditto in a few other places.&lt;br/&gt;
    Map(&quot;clientId&quot; -&amp;gt; metricId.clientId,&lt;br/&gt;
      &quot;topic&quot; -&amp;gt; metricId.topic,&lt;br/&gt;
      &quot;partition&quot; -&amp;gt; metricId.partitionId.toString)&lt;br/&gt;
  )&lt;/p&gt;

&lt;p&gt;62. FetchRequestAndResponseMetrics: In the following, could we put Map in a separate line?&lt;br/&gt;
  val tags = metricId match &lt;/p&gt;
{
    case ClientIdAndBroker(clientId, brokerHost, brokerPort) =&amp;gt; Map(&quot;clientId&quot; -&amp;gt; clientId, &quot;brokerHost&quot; -&amp;gt; brokerHost,
      &quot;brokerPort&quot; -&amp;gt; brokerPort.toString)
    case ClientIdAllBrokers(clientId) =&amp;gt; Map(&quot;clientId&quot; -&amp;gt; clientId, &quot;allBrokers&quot; -&amp;gt; &quot;true&quot;)
  }

&lt;p&gt;62. TestUtils: It&apos;s a bit weird that sendMessagesToBrokerPartition() has both a config and configs. We actually don&apos;t need the config any more. When sending a message to a partition, we actually don&apos;t know which broker the partition is on. So, the message can just be of the form test + &quot;&lt;del&gt;&quot; + partition + &quot;&lt;/del&gt;&quot; + x. We can also rename the method to sendMessagesToPartition().&lt;/p&gt;</comment>
                            <comment id="14195548" author="junrao" created="Tue, 4 Nov 2014 01:47:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt;, do you want to take another look at the patch?&lt;/p&gt;</comment>
                            <comment id="14195573" author="jjkoshy" created="Tue, 4 Nov 2014 02:08:44 +0000"  >&lt;p&gt;Yes thanks - I&apos;ll take a look at this tomorrow.&lt;/p&gt;</comment>
                            <comment id="14197412" author="jjkoshy" created="Wed, 5 Nov 2014 02:53:48 +0000"  >&lt;p&gt;Sorry I ran out of time - will look tomorrow.&lt;/p&gt;</comment>
                            <comment id="14201251" author="jjkoshy" created="Fri, 7 Nov 2014 00:02:54 +0000"  >&lt;p&gt;Can you rebase? Sorry I know you have rebased a couple times already. &lt;br/&gt;
Hopefully this should be the last time as these are minor comments.&lt;/p&gt;

&lt;p&gt;KafkaMetricsGroup: 64: foreach&lt;/p&gt;

&lt;p&gt;KafkaMetricsGroup: toMbeanName: 150/153: can you use filter &lt;/p&gt;
{ case(tagKey, tagValue) =&amp;gt;
...}


&lt;p&gt;For aggregate topic metrics, since allTopics=true appears at the end it is a &lt;br/&gt;
bit weird when browsing mbeans in jvisualvm/other tools. i.e., the mbean is&lt;br/&gt;
listed as &quot;true&quot;. I understand why - it is just a bit weird. I&apos;m referring &lt;br/&gt;
to (for example)&lt;br/&gt;
kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec,allTopics=true&lt;br/&gt;
See the attached originalLayout.png&lt;/p&gt;

&lt;p&gt;Personally I prefer aggregate=true to allTopics=true. A further improvement &lt;br/&gt;
with aggregate=true is the following: in KafkaMetricsGroup.metricName you&lt;br/&gt;
can check in the tags map if aggregate=true. If so, then modify the typeName &lt;br/&gt;
by pre-pending Aggregate to it and then strip off the aggregate=true tag. So&lt;br/&gt;
you will end up with:&lt;br/&gt;
kafka.server:type=BrokerTopicMetrics,name=AggregateBytesOutPerSec &lt;/p&gt;

&lt;p&gt;See alternateLayout1.png &lt;/p&gt;

&lt;p&gt;Another alternative is to modify the name (not the typeName). See &lt;br/&gt;
alternateLayout2.png&lt;/p&gt;

&lt;p&gt;The aggregate=true approach seems generic enough to apply to any other&lt;br/&gt;
all-topic, all-request, or all-broker level mbeans. What do you think?&lt;/p&gt;</comment>
                            <comment id="14204467" author="vladimir.tretyakov" created="Mon, 10 Nov 2014 07:37:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; thx for your feedback, will change, one question from me:&lt;/p&gt;

&lt;p&gt;What if I include Kafka version in any of the MBeans?  It will easy for external tools to detect Kafka version and use parsing rules for particular version. Something like Elasticsearch provides by http (Kafka will provide by JMX).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;curl localhost:9200 
{
...
  &lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt; : {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;number&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;1.3.2&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;build_hash&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;dee175dbe2f254f3f26992f5d7591939aaefd12f&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;build_timestamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2014-08-13T14:29:30Z&quot;&lt;/span&gt;
....
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Maybe you can point out code place where I can get current Kafka version? &lt;/p&gt;</comment>
                            <comment id="14205103" author="vladimir.tretyakov" created="Mon, 10 Nov 2014 18:16:39 +0000"  >&lt;p&gt;Hi again, added new patches (for code and for docs). New patch was done according to &apos;Alternative 1&apos;.&lt;br/&gt;
How about Kafka version publishing in JMX?&lt;br/&gt;
Thx!&lt;/p&gt;</comment>
                            <comment id="14205937" author="junrao" created="Tue, 11 Nov 2014 04:34:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.tretyakov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.tretyakov&quot;&gt;vladimir.tretyakov&lt;/a&gt;, we could probably just add a new MBean to expose the Kafka version number. Any value in exposing other things like build hash and build timestamp?&lt;/p&gt;

&lt;p&gt;Also, could you address my last few comments? For example, it seem #62 is still not addressed. A few more comments on the new patch.&lt;/p&gt;

&lt;p&gt;64. ConsumerTopicMetrics: Could you merge the following into a single line?&lt;br/&gt;
  val tags = metricId&lt;br/&gt;
  match {&lt;/p&gt;

&lt;p&gt;65. About the change to the aggregate metric name. It seems that we now have the following MBean name. A couple of comments on this.&lt;br/&gt;
kafka.consumer:type=AggregateFetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=console-consumer-50964&lt;br/&gt;
65.1 We only include the following in KafkaMetricsGroup.consumerMetricNameList. That won&apos;t match the above aggregate metric&apos;s name. So, I am not sure how this metric is removed when closing the consumer. The unit test does pass. So, I am not sure if it&apos;s testing the right thing.&lt;br/&gt;
    new MetricName(&quot;kafka.consumer&quot;, &quot;FetchRequestAndResponseMetrics&quot;, &quot;FetchResponseSize&quot;),&lt;br/&gt;
65.1 I think adding Aggregate in front of the class name is a bit weird. The way that we add it in KafkaMetricsGroup is also a bit hacky since it essentially changed the typeName for aggregate metrics w/o actually changing it. I was thinking for aggregate metrics, would it be simpler just to have the following? The fact that it doesn&apos;t have any broker level labels is enough an indication that it&apos;s an aggregate across all brokers.&lt;br/&gt;
kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=console-consumer-50964&lt;/p&gt;</comment>
                            <comment id="14206303" author="vladimir.tretyakov" created="Tue, 11 Nov 2014 11:13:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;, &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Vladimir Tretyakov, we could probably just add a new MBean to expose the Kafka version number. Any value in exposing other things like build hash and build timestamp?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Version will be ok I think, but my question was also about where I can get this Version? Should I hardcoded this Version in MBean? What is the best place for such information? Maybe you already have some special property file?&lt;/p&gt;</comment>
                            <comment id="14206333" author="vladimir.tretyakov" created="Tue, 11 Nov 2014 11:41:45 +0000"  >&lt;p&gt;Hi again, &lt;br/&gt;
65. Honestly I&apos;d prefer allBrokers=true and allTopics=true or maybe brokers=aggregated, topics=aggregated.&lt;br/&gt;
From first view user will not know what this is about:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=console-consumer-50964
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and only after user will see something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=console-consumer-50964, broker=0
kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=console-consumer-50964, broker=1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;user can understand (not sure) that name without &apos;broker=..&apos; is aggregated value, I&apos;d prefer explicit definition.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; what do you think about:&lt;br/&gt;
&quot;brokers=aggregated, topics=aggregated&quot; ? In jconsole user will see &quot;aggregated&quot; instead of &quot;true&quot;, handy from my point of view.&lt;/p&gt;</comment>
                            <comment id="14208284" author="vladimir.tretyakov" created="Wed, 12 Nov 2014 17:22:33 +0000"  >&lt;p&gt;Maybe somebody can answer my last questions? Have to finish with this patch and moving forward! Thx.&lt;/p&gt;

&lt;p&gt;Will extract Kafka version like &quot;Gwen Shapira&lt;br/&gt;
&quot; has suggested in &lt;a href=&quot;http://search-hadoop.com/m/4TaT4xtk36/Programmatic+Kafka+version+detection%252Fextraction&amp;amp;subj=Programmatic+Kafka+version+detection+extraction+&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://search-hadoop.com/m/4TaT4xtk36/Programmatic+Kafka+version+detection%252Fextraction&amp;amp;subj=Programmatic+Kafka+version+detection+extraction+&lt;/a&gt; &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;So it looks like we can use Gradle to add properties to manifest file and&lt;br/&gt;
then use getResourceAsStream to read the file and parse it.&lt;/p&gt;

&lt;p&gt;The Gradle part would be something like:&lt;br/&gt;
jar.manifest &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {            attributes(&amp;#39;Implementation-Title&amp;#39;}&lt;/span&gt; &lt;/div&gt;

&lt;p&gt;The code part would be:&lt;br/&gt;
this.getClass().getClassLoader().getResourceAsStream(&quot;/META-INF/MANIFEST.MF&quot;)&lt;/p&gt;

&lt;p&gt;Does that look like the right approach?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What do you think?&lt;/p&gt;

&lt;p&gt;What about 65?&lt;/p&gt;
&lt;blockquote&gt;&lt;/blockquote&gt;</comment>
                            <comment id="14208497" author="junrao" created="Wed, 12 Nov 2014 19:19:38 +0000"  >
&lt;p&gt;65. The following are some of the choices that we have.&lt;br/&gt;
(1) kafka.server:type=BrokerTopicMetrics,name=AggregateBytesOutPerSec&lt;br/&gt;
(2) kafka.server:type=AggregateBrokerTopicMetrics,name=BytesOutPerSec&lt;br/&gt;
(3) kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec&lt;br/&gt;
(4) kafka.server:type=BrokerTopicMetrics,name=AllTopicsBytesOutPerSec&lt;br/&gt;
(5) kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec,allTopics=true&lt;br/&gt;
(6) kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec,topics=aggregate&lt;br/&gt;
The following is my take. The issue with (1), (2) and (3) is that it&apos;s not obvious which dimension is being aggregated upon. I also don&apos;t quite like (2) since it breaks the convention that type is the class name. If we do go with this route, I&apos;d prefer that we explicitly create an AggregateBrokerTopicMetrics class instead of sneaking in the prefix in KafkaMetricsGroup. (4), (5) and (6) will all make it clear which dimension is being aggregated upon. (4) is a bit weird now that we support tags since the main purpose of tags is that we don&apos;t have to squeeze everything into a single name. So, either (5) and (6) looks reasonable to me. Also, I am not sure how jconsole displays mbeans, but the key/value pairs in the mbean name are supposed to be unordered.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt;, what&apos;s your take?&lt;/p&gt;

&lt;p&gt;As for the mbean for the Kafka version, could we do that in a separate jira? The approach seems reasonable.&lt;/p&gt;</comment>
                            <comment id="14209055" author="jjkoshy" created="Thu, 13 Nov 2014 01:22:48 +0000"  >&lt;p&gt;(1) and (4) seem equivalent (i.e., AllTopics vs Aggregate) - or are you saying that (4) will be AllTopics or AllBrokers as appropriate?&lt;/p&gt;

&lt;p&gt;I&apos;m +0 on (5) for the reason I stated above. i.e., it is odd to see &quot;true&quot; when browsing mbeans&lt;/p&gt;

&lt;p&gt;I&apos;m +0 on (6) as well as &quot;topics=aggregate&quot; is a bit odd. The field name suggests it is a list of topics but it is more like a boolean. Between this and (5) I prefer (5).&lt;/p&gt;

&lt;p&gt;(3) seems reasonable to me although it is not as clear as having an explicit aggregate term in the type. However, I think (1), (2) and (3) do make it clear enough what is being aggregated: i.e., bytes-out-per-sec aggregated on topic. I actually think &quot;Broker&quot; should not be there since this is a broker-side mbean already. i.e., if we had kafka.server:type=TopicMetrics,name=BytesOutPerSec (wouldn&apos;t it be clear that the dimension of aggregation is across topics?) i.e., I think we can just make the dimension clear from the typename.&lt;/p&gt;

&lt;p&gt;Likewise, it should be clear (for consumers) that FetchRequestAndResponseMetrics is really a broker-level aggregation.&lt;/p&gt;</comment>
                            <comment id="14210144" author="junrao" created="Thu, 13 Nov 2014 18:50:26 +0000"  >&lt;p&gt;Thinking about his a bit more, I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt; that (3) is probably the best choice. It&apos;s the simplest. Also, if you look at a metric like the following, it should be clear that the request rate is for a particular client, aggregated. There are different ways that this metrics can be broken down. However, that information shouldn&apos;t need to be included in the aggregate metrics.&lt;/p&gt;

&lt;p&gt;kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=console-consumer-50964&lt;/p&gt;

&lt;p&gt;We can probably keep the name BrokerTopicMetrics so that it can be distinguished from ConsumerTopicMetrics and ProducerTopicMetrics.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.tretyakov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.tretyakov&quot;&gt;vladimir.tretyakov&lt;/a&gt;, are you ok with this approach?&lt;/p&gt;</comment>
                            <comment id="14211341" author="jjkoshy" created="Thu, 13 Nov 2014 21:44:37 +0000"  >&lt;p&gt;Re: BrokerTopicMetrics so that it can be distinguished from ConsumerTopicMetrics and ProducerTopicMetrics&lt;/p&gt;

&lt;p&gt;Why do we need to distinguish it? i.e., BrokerTopicMetrics would only be on the server right? Or are you concerned about the possibility of a producer or consumer that happens to run in the same VM as a broker?&lt;/p&gt;</comment>
                            <comment id="14211555" author="junrao" created="Fri, 14 Nov 2014 00:15:25 +0000"  >&lt;p&gt;My concern is that in the code, if you have a class TopicMetrics, it&apos;s not clear what it is for (broker, consumer or producer). Also, if you have a centralized monitoring system that pulls all Kafka metrics (for both the client and the broker), TopicMetrics will be a bit out of context.&lt;/p&gt;</comment>
                            <comment id="14212264" author="vladimir.tretyakov" created="Fri, 14 Nov 2014 13:55:51 +0000"  >&lt;p&gt;Hi, added new patches (code + doc), go by way 3:&lt;br/&gt;
(3) kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec&lt;/p&gt;


&lt;p&gt;Also added Kafka version MBean, it exposes only Kafka version now (from gradle.properties file). I didn&apos;t find easy way where I can get build hash, so only version for now.&lt;/p&gt;

&lt;p&gt;I hope it will be my last patches, it is a time consumption to change things many times and test everything each time and prepare patched, so I really hope these patches are good enough and I will not do additional iterations, thx.&lt;/p&gt;</comment>
                            <comment id="14212536" author="junrao" created="Fri, 14 Nov 2014 17:49:31 +0000"  >&lt;p&gt;Thanks for the patch. Appreciate your persistence. A few comments below.&lt;/p&gt;

&lt;p&gt;80. AppInfo.registerInfo()&lt;br/&gt;
80.1 On the server side, this needs to be called in KafkaServerStartable.startup(). Some users will start up a Kafka broker using KafkaServerStartable in a container and not from the command line. &lt;br/&gt;
80.2 On the client side, if there are multiple instances of clients running in the same jvm, registerInfo() will be called multiple times. It would be good if we make sure registerInfo() only register the mbean once no matter how many times it&apos;s called. We can maintain an isRegistered flag internally and only register the mbean if the flag is not set. We can also make this a synchronized method.&lt;br/&gt;
80.3 There is no need to call registerInfo() in ConsoleConsumer and ProducerPerformance since the mbean will be registered by the consumer/producer client.&lt;br/&gt;
80.4 We will need to add the same version mbean in the new java client. We don&apos;t need to do that in this jira. Could you file a separate jira to track that?&lt;/p&gt;

&lt;p&gt;81. KafkaServer: remove unused import AppInfo&lt;/p&gt;

&lt;p&gt;82. TestUtils: Could you fix the indentation in the following?&lt;br/&gt;
  def sendMessagesToPartition(configs: Seq&lt;span class=&quot;error&quot;&gt;&amp;#91;KafkaConfig&amp;#93;&lt;/span&gt;,&lt;br/&gt;
                                    topic: String,&lt;br/&gt;
                                    partition: Int,&lt;br/&gt;
                                    numMessages: Int,&lt;br/&gt;
                                    compression: CompressionCodec = NoCompressionCodec): List&lt;span class=&quot;error&quot;&gt;&amp;#91;String&amp;#93;&lt;/span&gt; = {&lt;/p&gt;

&lt;p&gt;83. As I was reviewing &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1684&quot; title=&quot;Implement TLS/SSL authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1684&quot;&gt;&lt;del&gt;KAFKA-1684&lt;/del&gt;&lt;/a&gt;, I realized that in the future, a broker may have multiple ports: plain text, SSL, SASL, etc. In this patch, the broker-specific mbeans have the tag of brokerHost and brokerPort. This is going to be inconvenient once the broker has more than one port. I was thinking it&apos;s simpler if we just add the brokerId tag or both the brokerId and the brokerHost tag. What do you think?&lt;/p&gt;</comment>
                            <comment id="14212563" author="junrao" created="Fri, 14 Nov 2014 18:09:56 +0000"  >&lt;p&gt;83. On another thought, the port tag may be ok since a client is only going to connect to one port any way.&lt;/p&gt;</comment>
                            <comment id="14212598" author="vladimir.tretyakov" created="Fri, 14 Nov 2014 18:36:29 +0000"  >&lt;p&gt;Thx Jun, will try to fix everything according your last comments.&lt;br/&gt;
re 83, yeah host:port is unique pair, so it will work even with &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1684&quot; title=&quot;Implement TLS/SSL authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1684&quot;&gt;&lt;del&gt;KAFKA-1684&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14212873" author="jjkoshy" created="Fri, 14 Nov 2014 21:38:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; For 80.2, I believe the additional registration will not create any new mbeans. i.e., it should be a no-op.&lt;br/&gt;
For 83, we could have one set of mbeans per port right? Or do you think that would be too much? Your suggestion is to drop the port and just unify right? That should also be good.&lt;/p&gt;

&lt;p&gt;Also, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.tretyakov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.tretyakov&quot;&gt;vladimir.tretyakov&lt;/a&gt; your patch needs a rebase as mentioned earlier.&lt;/p&gt;</comment>
                            <comment id="14212987" author="junrao" created="Fri, 14 Nov 2014 22:39:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt;, yes, re-registering an existing mbean is a no-op. However, it would probably be good not to depend on this and to avoid the unnecessary checks on resources.&lt;/p&gt;

&lt;p&gt;For 83, chances are a given application is going to use one type of port. So, we can leave this as it is.&lt;/p&gt;

&lt;p&gt;The patch is actually intended for 0.8.2 and it applies.&lt;/p&gt;</comment>
                            <comment id="14213409" author="otis" created="Sat, 15 Nov 2014 06:18:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;80.4 We will need to add the same version mbean in the new java client. We don&apos;t need to do that in this jira. Could you file a separate jira to track that?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1768&quot; title=&quot;Expose version via JMX&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1768&quot;&gt;&lt;del&gt;KAFKA-1768&lt;/del&gt;&lt;/a&gt; a few days ago and have linked it to this issue.&lt;/p&gt;</comment>
                            <comment id="14214559" author="vladimir.tretyakov" created="Mon, 17 Nov 2014 11:40:47 +0000"  >&lt;p&gt;Hi, provided new patch, last one?&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;p&gt;80.1 Done&lt;br/&gt;
80.2 Done&lt;br/&gt;
80.3 Done&lt;br/&gt;
80.4 Do you mean &apos;new producer&apos;? Can I just reformulate &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1768&quot; title=&quot;Expose version via JMX&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1768&quot;&gt;&lt;del&gt;KAFKA-1768&lt;/del&gt;&lt;/a&gt;? Something like: &quot;Expose version via JMX in new client&quot;?&lt;br/&gt;
81. Done&lt;br/&gt;
82. Done&lt;br/&gt;
83. Left as is.&lt;/p&gt;

&lt;p&gt;PS: I&apos;ll be traveling for 3 week starting 19.11 (Wednesday) and won&apos;t Internet access.  Can we get this committed before I go pleaase?&lt;/p&gt;</comment>
                            <comment id="14215304" author="junrao" created="Mon, 17 Nov 2014 22:26:27 +0000"  >&lt;p&gt;Thanks for the patch. +1 from me. Just a few minor comments from me.&lt;/p&gt;

&lt;p&gt;90. Kafka: No need to call AppInfo.registerInfo().&lt;/p&gt;

&lt;p&gt;91. ZookeeperConsumerConnector: Could we rename the following method to ownedPartitionsCountMetricTags?&lt;br/&gt;
def ownedPartitionsCountMetricName&lt;/p&gt;

&lt;p&gt;Could you also provide a patch for trunk?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjkoshy&quot; class=&quot;user-hover&quot; rel=&quot;jjkoshy&quot;&gt;jjkoshy&lt;/a&gt;, do you want to look at the patch again?&lt;/p&gt;</comment>
                            <comment id="14215371" author="jjkoshy" created="Mon, 17 Nov 2014 23:19:12 +0000"  >&lt;p&gt;+1  (for 0.8.2)&lt;/p&gt;</comment>
                            <comment id="14215645" author="junrao" created="Tue, 18 Nov 2014 02:39:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.tretyakov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.tretyakov&quot;&gt;vladimir.tretyakov&lt;/a&gt;, thanks a lot for your work. Committed to 0.8.2 after fixing 90 and 91.&lt;/p&gt;

&lt;p&gt;Will leave the jira open until trunk is patched too.&lt;/p&gt;</comment>
                            <comment id="14215868" author="vladimir.tretyakov" created="Tue, 18 Nov 2014 08:05:40 +0000"  >&lt;p&gt;Thx a lot guys, will try prepare patch for trunk today.&lt;/p&gt;</comment>
                            <comment id="14217887" author="vladimir.tretyakov" created="Wed, 19 Nov 2014 13:17:43 +0000"  >&lt;p&gt;Added patch for trunk - &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-1481&quot; title=&quot;Stop using dashes AND underscores as separators in MBean names&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-1481&quot;&gt;&lt;del&gt;KAFKA-1481&lt;/del&gt;&lt;/a&gt;_2014-11-19_16-03-03_trunk.patch&lt;/p&gt;</comment>
                            <comment id="14218886" author="junrao" created="Thu, 20 Nov 2014 02:00:11 +0000"  >&lt;p&gt;Thanks for the patch for trunk. +1 and committed to trunk.&lt;/p&gt;</comment>
                            <comment id="14255722" author="vladimir.tretyakov" created="Mon, 22 Dec 2014 13:27:35 +0000"  >&lt;p&gt;Hi guys, maybe it is not a best place for this question, but it is related to metric, so I will try:&lt;/p&gt;

&lt;p&gt;In code ( &quot;kafka/core/src/main/scala/kafka/log/FileMessageSet.scala&quot; ) I see:&lt;/p&gt;
 &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;object LogFlushStats &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; KafkaMetricsGroup {
  val logFlushTimer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaTimer(newTimer(&lt;span class=&quot;code-quote&quot;&gt;&quot;LogFlushRateAndTimeMs&quot;&lt;/span&gt;, TimeUnit.MILLISECONDS, TimeUnit.SECONDS))
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But I don&apos;t see this metric in JMX when I attach JConsole to my broker.&lt;/p&gt;

&lt;p&gt;Is it ok?&lt;br/&gt;
What I have to do to see this metric?&lt;br/&gt;
Maybe this bean/metric exists short time and recreates each time after/during log flushes?&lt;br/&gt;
Can somebody explain me?&lt;/p&gt;

&lt;p&gt;Best regards. Vladimir.&lt;/p&gt;</comment>
                            <comment id="14255845" author="junrao" created="Mon, 22 Dec 2014 15:41:34 +0000"  >&lt;p&gt;The JMX will be registered the first time that the flush stat is recorded. So, try producing some messages to a topic.&lt;/p&gt;</comment>
                            <comment id="14255875" author="vladimir.tretyakov" created="Mon, 22 Dec 2014 16:06:06 +0000"  >&lt;p&gt;Hi Jun, thx for answer, already did (added many messages), waited more than 1 day (on our test env), nothing, no bean with such name is in broker process.&lt;/p&gt;</comment>
                            <comment id="14255956" author="junrao" created="Mon, 22 Dec 2014 17:28:42 +0000"  >&lt;p&gt;Ok, the metric does show up. By default, the flush is only done in a background thread and it only flushes old log segments. So, a flush is only called when a new log segment is rolled. If you want to see the metric quicker, you can try setting log.flush.interval.messages to a small value.&lt;/p&gt;</comment>
                            <comment id="14258109" author="vladimir.tretyakov" created="Wed, 24 Dec 2014 08:40:57 +0000"  >&lt;p&gt;Hi Jun, thx for answer, it helps (&quot;log.flush.interval.messages&quot; property), I see data on charts&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12689019/logflushes.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Maybe you also have a receipt how to force displaying of these metrics kafka.log.LogCleaner:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;newGauge(&lt;span class=&quot;code-quote&quot;&gt;&quot;max-buffer-utilization-percent&quot;&lt;/span&gt;, 
           &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Gauge[Int] {
             def value: Int = cleaners.map(_.lastStats).map(100 * _.bufferUtilization).max.toInt
           })
  &lt;span class=&quot;code-comment&quot;&gt;/* a metric to track the recopy rate of each thread&apos;s last cleaning */&lt;/span&gt;
  newGauge(&lt;span class=&quot;code-quote&quot;&gt;&quot;cleaner-recopy-percent&quot;&lt;/span&gt;, 
           &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Gauge[Int] {
             def value: Int = {
               val stats = cleaners.map(_.lastStats)
               val recopyRate = stats.map(_.bytesWritten).sum.toDouble / math.max(stats.map(_.bytesRead).sum, 1)
               (100 * recopyRate).toInt
             }
           })
  &lt;span class=&quot;code-comment&quot;&gt;/* a metric to track the maximum cleaning time &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the last cleaning from each thread */&lt;/span&gt;
  newGauge(&lt;span class=&quot;code-quote&quot;&gt;&quot;max-clean-time-secs&quot;&lt;/span&gt;,
           &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Gauge[Int] {
             def value: Int = cleaners.map(_.lastStats).map(_.elapsedSecs).max.toInt
           })
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;?&lt;/p&gt;

&lt;p&gt;Thx again.&lt;/p&gt;</comment>
                            <comment id="14272057" author="junrao" created="Fri, 9 Jan 2015 23:23:09 +0000"  >&lt;p&gt;Also committed the doc change to 0.8.2 documentation.&lt;/p&gt;</comment>
                            <comment id="14367878" author="guozhang" created="Wed, 18 Mar 2015 20:54:05 +0000"  >&lt;p&gt;We hit an issue related to this ticket, which adds the &quot;brokerHost&quot; / &quot;brokerPort&quot; into FetchRequestAndResponseMetrics. The root cause is that when server starts up, it gets local host string by calling:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;InetAddress.getLocalHost.getCanonicalHostName
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which, will possibly just return the textual representation of the IP address if somehow accessing local hostname is not allowed:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/net/InetAddress.html#getCanonicalHostName%28%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/7/docs/api/java/net/InetAddress.html#getCanonicalHostName%28%29&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In our case, the IPV6 address string is returned, which is registered in ZK, read by controller and propogated to brokers through metadata update, and eventually read by consumers. And when that happens, we got the following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2015-03-18 09:46:30 JmxReporter [WARN] Error processing kafka.consumer:type=FetchRequestAndResponseMetrics,name=FetchRequestRateAndTimeMs,clientId=samza_checkpoint_manager-wikipedia_parser-1-1426697189628-0,brokerHost=fe80:0:0:0:7ed1:c3ff:fee0:c60f%4,brokerPort=9092
javax.management.MalformedObjectNameException: Invalid character &lt;span class=&quot;code-quote&quot;&gt;&apos;:&apos;&lt;/span&gt; in value part of property
at javax.management.ObjectName.construct(ObjectName.java:618)
at javax.management.ObjectName.&amp;lt;init&amp;gt;(ObjectName.java:1382)
at com.yammer.metrics.reporting.JmxReporter.onMetricAdded(JmxReporter.java:395)
at com.yammer.metrics.core.MetricsRegistry.notifyMetricAdded(MetricsRegistry.java:516)
at com.yammer.metrics.core.MetricsRegistry.getOrAdd(MetricsRegistry.java:491)
at com.yammer.metrics.core.MetricsRegistry.newTimer(MetricsRegistry.java:320)
at kafka.metrics.KafkaMetricsGroup$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;newTimer(KafkaMetricsGroup.scala:85)
at kafka.consumer.FetchRequestAndResponseMetrics.newTimer(FetchRequestAndResponseStats.scala:26)
at kafka.consumer.FetchRequestAndResponseMetrics.&amp;lt;init&amp;gt;(FetchRequestAndResponseStats.scala:35)
at kafka.consumer.FetchRequestAndResponseStats$$anonfun$1.apply(FetchRequestAndResponseStats.scala:44)
at kafka.consumer.FetchRequestAndResponseStats$$anonfun$1.apply(FetchRequestAndResponseStats.scala:44)
at kafka.utils.Pool.getAndMaybePut(Pool.scala:61)
at kafka.consumer.FetchRequestAndResponseStats.getFetchRequestAndResponseStats(FetchRequestAndResponseStats.scala:51)
at kafka.consumer.SimpleConsumer.fetch(SimpleConsumer.scala:108)
at org.apache.samza.checkpoint.kafka.KafkaCheckpointManager$$anonfun$readLog$1.apply(KafkaCheckpointManager.scala:283)
at org.apache.samza.checkpoint.kafka.KafkaCheckpointManager$$anonfun$readLog$1.apply(KafkaCheckpointManager.scala:256)
at org.apache.samza.util.ExponentialSleepStrategy.run(ExponentialSleepStrategy.scala:82)
at org.apache.samza.checkpoint.kafka.KafkaCheckpointManager.readLog(KafkaCheckpointManager.scala:255)
at org.apache.samza.checkpoint.kafka.KafkaCheckpointManager.readChangeLogPartitionMapping(KafkaCheckpointManager.scala:242)
at org.apache.samza.coordinator.JobCoordinator$.buildJobModel(JobCoordinator.scala:136)
at org.apache.samza.coordinator.JobCoordinator.buildJobModel(JobCoordinator.scala)
at org.apache.samza.job.standalone.controller.StandaloneZkCoordinatorController.refreshOwnership(StandaloneZkCoordinatorController.java:161)
at org.apache.samza.job.standalone.controller.StandaloneZkCoordinatorController.access$900(StandaloneZkCoordinatorController.java:49)
at org.apache.samza.job.standalone.controller.StandaloneZkCoordinatorController$ContainerPathListener.handleChildChange(StandaloneZkCoordinatorController.java:256)
at org.I0Itec.zkclient.ZkClient$7.run(ZkClient.java:568)
at org.I0Itec.zkclient.ZkEventThread.run(ZkEventThread.java:71)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think the right solution here is that BrokerHost string should also be canonized before adding to sensor tags. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vladimir.tretyakov&quot; class=&quot;user-hover&quot; rel=&quot;vladimir.tretyakov&quot;&gt;vladimir.tretyakov&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; what do you think?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12675195">KAFKA-1100</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12754990">KAFKA-1768</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12648621" name="KAFKA-1481_2014-06-06_13-06-35.patch" size="16975" author="vladimir.tretyakov" created="Fri, 6 Jun 2014 10:20:37 +0000"/>
                            <attachment id="12674516" name="KAFKA-1481_2014-10-13_18-23-35.patch" size="44998" author="vladimir.tretyakov" created="Mon, 13 Oct 2014 15:28:58 +0000"/>
                            <attachment id="12674821" name="KAFKA-1481_2014-10-14_21-53-35.patch" size="80529" author="vladimir.tretyakov" created="Tue, 14 Oct 2014 19:08:41 +0000"/>
                            <attachment id="12674949" name="KAFKA-1481_2014-10-15_10-23-35.patch" size="74156" author="vladimir.tretyakov" created="Wed, 15 Oct 2014 07:55:57 +0000"/>
                            <attachment id="12675934" name="KAFKA-1481_2014-10-20_23-14-35.patch" size="150214" author="vladimir.tretyakov" created="Mon, 20 Oct 2014 20:31:49 +0000"/>
                            <attachment id="12676039" name="KAFKA-1481_2014-10-21_09-14-35.patch" size="161152" author="vladimir.tretyakov" created="Tue, 21 Oct 2014 06:42:39 +0000"/>
                            <attachment id="12678267" name="KAFKA-1481_2014-10-30_21-35-43.patch" size="64271" author="vladimir.tretyakov" created="Thu, 30 Oct 2014 18:44:19 +0000"/>
                            <attachment id="12678454" name="KAFKA-1481_2014-10-31_14-35-43.patch" size="68256" author="vladimir.tretyakov" created="Fri, 31 Oct 2014 11:14:28 +0000"/>
                            <attachment id="12678927" name="KAFKA-1481_2014-11-03_16-39-41_doc.patch" size="7609" author="vladimir.tretyakov" created="Mon, 3 Nov 2014 13:43:32 +0000"/>
                            <attachment id="12678930" name="KAFKA-1481_2014-11-03_17-02-23.patch" size="84865" author="vladimir.tretyakov" created="Mon, 3 Nov 2014 14:05:19 +0000"/>
                            <attachment id="12680615" name="KAFKA-1481_2014-11-10_20-39-41_doc.patch" size="7576" author="vladimir.tretyakov" created="Mon, 10 Nov 2014 18:14:01 +0000"/>
                            <attachment id="12680614" name="KAFKA-1481_2014-11-10_21-02-23.patch" size="84991" author="vladimir.tretyakov" created="Mon, 10 Nov 2014 18:14:01 +0000"/>
                            <attachment id="12681538" name="KAFKA-1481_2014-11-14_16-33-03.patch" size="92501" author="vladimir.tretyakov" created="Fri, 14 Nov 2014 13:48:56 +0000"/>
                            <attachment id="12681539" name="KAFKA-1481_2014-11-14_16-39-41_doc.patch" size="7564" author="vladimir.tretyakov" created="Fri, 14 Nov 2014 13:48:56 +0000"/>
                            <attachment id="12681882" name="KAFKA-1481_2014-11-17_14-33-03.patch" size="91877" author="vladimir.tretyakov" created="Mon, 17 Nov 2014 11:36:20 +0000"/>
                            <attachment id="12682416" name="KAFKA-1481_2014-11-19_16-03-03_trunk.patch" size="87789" author="vladimir.tretyakov" created="Wed, 19 Nov 2014 13:10:08 +0000"/>
                            <attachment id="12674822" name="KAFKA-1481_IDEA_IDE_2014-10-14_21-53-35.patch" size="83040" author="vladimir.tretyakov" created="Tue, 14 Oct 2014 19:08:41 +0000"/>
                            <attachment id="12674948" name="KAFKA-1481_IDEA_IDE_2014-10-15_10-23-35.patch" size="76807" author="vladimir.tretyakov" created="Wed, 15 Oct 2014 07:55:57 +0000"/>
                            <attachment id="12675877" name="KAFKA-1481_IDEA_IDE_2014-10-20_20-14-35.patch" size="159002" author="vladimir.tretyakov" created="Mon, 20 Oct 2014 17:30:23 +0000"/>
                            <attachment id="12675933" name="KAFKA-1481_IDEA_IDE_2014-10-20_23-14-35.patch" size="160757" author="vladimir.tretyakov" created="Mon, 20 Oct 2014 20:31:49 +0000"/>
                            <attachment id="12680011" name="alternateLayout1.png" size="33624" author="jjkoshy" created="Fri, 7 Nov 2014 00:02:54 +0000"/>
                            <attachment id="12680012" name="alternateLayout2.png" size="33970" author="jjkoshy" created="Fri, 7 Nov 2014 00:02:54 +0000"/>
                            <attachment id="12680010" name="diff-for-alternate-layout1.patch" size="962" author="jjkoshy" created="Fri, 7 Nov 2014 00:02:54 +0000"/>
                            <attachment id="12680009" name="diff-for-alternate-layout2.patch" size="888" author="jjkoshy" created="Fri, 7 Nov 2014 00:02:54 +0000"/>
                            <attachment id="12689019" name="logflushes.png" size="60457" author="vladimir.tretyakov" created="Wed, 24 Dec 2014 08:43:51 +0000"/>
                            <attachment id="12680008" name="originalLayout.png" size="21920" author="jjkoshy" created="Fri, 7 Nov 2014 00:02:54 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12749626">KAFKA-1723</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>26.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396230</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 35 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1w7un:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396353</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jjkoshy</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>