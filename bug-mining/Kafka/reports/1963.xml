<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:12:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7012] Performance issue upgrading to kafka 1.0.1 or 1.1</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7012</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We are trying to upgrade kafka cluster from Kafka 0.11.0.1 to Kafka 1.0.1. After upgrading 1 node on the cluster, we notice that network threads use most of the cpu. It is a 3 node cluster with 15k messages/sec on each node. With Kafka 0.11.0.1 typical usage of the servers is around 50 to 60% vcpu(using less than 1 vcpu). After upgrade we are noticing that cpu usage is high depending on the number of network threads used. If networks threads is set to 8, then the cpu usage is around 850%(9 vcpus) and if it is set to 4 then the cpu usage is around 450%(5 vcpus). Using the same kafka server.properties for both.&lt;/p&gt;

&lt;p&gt;Did further analysis with git bisect, couple of build and deploys, traced the issue to commit 47ee8e954df62b9a79099e944ec4be29afe046f6. CPU usage is fine for commit f15cdbc91b240e656d9a2aeb6877e94624b21f8d. But with commit 47ee8e954df62b9a79099e944ec4be29afe046f6 cpu usage has increased. Have attached screenshots of profiling done with both the commits. Screenshot Commit-f15cdbc91b-profile shows less cpu usage by network threads and Screenshots Commit-47ee8e954-profile and Commit-47ee8e954-profile2 show higher cpu usage(almost entire cpu usage) by network threads. Also noticed that kafka.network.Processor.poll() method is invoked 10 times more with commit 47ee8e954df62b9a79099e944ec4be29afe046f6.&lt;/p&gt;

&lt;p&gt;We need the issue to be resolved to upgrade the cluster. Please let me know if you need any additional information.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13164522">KAFKA-7012</key>
            <summary>Performance issue upgrading to kafka 1.0.1 or 1.1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rsivaram">Rajini Sivaram</assignee>
                                    <reporter username="rajadayalanvdms">rajadayalan perumalsamy</reporter>
                        <labels>
                            <label>regression</label>
                    </labels>
                <created>Wed, 6 Jun 2018 18:14:52 +0000</created>
                <updated>Tue, 26 Jun 2018 06:49:08 +0000</updated>
                            <resolved>Tue, 19 Jun 2018 14:21:47 +0000</resolved>
                                    <version>1.0.1</version>
                    <version>1.1.0</version>
                                    <fixVersion>1.0.2</fixVersion>
                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16503794" author="ckasten" created="Wed, 6 Jun 2018 19:36:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=patl&quot; class=&quot;user-hover&quot; rel=&quot;patl&quot;&gt;patl&lt;/a&gt;, I&apos;m working with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajadayalanvdms&quot; class=&quot;user-hover&quot; rel=&quot;rajadayalanvdms&quot;&gt;rajadayalanvdms&lt;/a&gt; , and noticed you&#160; have assigned this ticket to yourself. I just wanted to inquire about your expectations of when you&apos;ll have time to look into this ticket, etc. This will help us plan work on our side. Thank you!&lt;/p&gt;</comment>
                            <comment id="16504282" author="ijuma" created="Thu, 7 Jun 2018 05:56:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=radai&quot; class=&quot;user-hover&quot; rel=&quot;radai&quot;&gt;radai&lt;/a&gt;, any thoughts on this?&lt;/p&gt;</comment>
                            <comment id="16504672" author="radai" created="Thu, 7 Jun 2018 13:21:34 +0000"  >&lt;p&gt;the attached profile screenshot shows only 210ms (out of &amp;gt;650k ms) of self time in pool.tryAllocate().&lt;br/&gt;
a possible time drain with the patch is determineHandlingOrder() - it may shuffle the sockets in order to guarantee fairness under low memory conditions - but it doesnt appear in the screenshot.&lt;br/&gt;
there&apos;s also no equivalent screenshot of a detailed profile breakdown for the results without the patch, so no base to compare to.&lt;br/&gt;
was the profiler using cpu time or wall clock time for measurements?&lt;br/&gt;
were the ssl settings (cipher used etc) the same across measurements?&lt;/p&gt;</comment>
                            <comment id="16504977" author="rajadayalanvdms" created="Thu, 7 Jun 2018 17:25:29 +0000"  >&lt;p&gt;Thanks,&#160;my comments added inline&lt;/p&gt;

&lt;p&gt;the attached profile screenshot shows only 210ms (out of &amp;gt;650k ms) of self time in pool.tryAllocate().&lt;br/&gt;
 a possible time drain with the patch is determineHandlingOrder() - it may shuffle the sockets in order to guarantee fairness under low memory conditions - but it doesnt appear in the screenshot.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;did not notice issue with memory, i can do profiling with memory and include it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; there&apos;s also no equivalent screenshot of a detailed profile breakdown for the results without the patch, so no base to compare to.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;attaching screenshot&#160;Commit-f15cdbc91b-profile2 for comparing.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; was the profiler using cpu time or wall clock time for measurements?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In the attached screenshot Total time is the wall clock time and Total time(CPU) is the cpu time.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; were the ssl settings (cipher used etc) the same across measurements?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ssl settings and cipher used are same across measurements.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16504986" author="yuzhihong@gmail.com" created="Thu, 7 Jun 2018 17:30:41 +0000"  >&lt;p&gt;You can precede quoted comment with &apos;bq.&apos; (note the trailing dot).&lt;/p&gt;</comment>
                            <comment id="16505565" author="rajadayalanvdms" created="Fri, 8 Jun 2018 00:48:39 +0000"  >&lt;p&gt;attached the screenshots(Commit-47ee8e954-0607-profile,&#160;Commit-47ee8e954-0607-memory)&#160; done with one more&#160;profiling.&lt;/p&gt;</comment>
                            <comment id="16505583" author="radai" created="Fri, 8 Jun 2018 01:11:46 +0000"  >&lt;p&gt;my only current hypothesis is that `keysWithBufferedRead` is non-empty, causing lots of very short poll() calls for those.&lt;br/&gt;
could you try comment out that poll() and re-run the experiment ?&lt;/p&gt;</comment>
                            <comment id="16506664" author="rajadayalanvdms" created="Fri, 8 Jun 2018 22:56:53 +0000"  >&lt;p&gt;do you mean to comment the poll method in&#160;org.apache.kafka.common.network.Selector as below&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;@@ -324,6 +324,7 @@ public class Selector implements Selectable, AutoCloseable {&lt;br/&gt;
 */&lt;br/&gt;
 @Override&lt;br/&gt;
 public void poll(long timeout) throws IOException {&lt;br/&gt;
 + /*&lt;br/&gt;
 if (timeout &amp;lt; 0)&lt;br/&gt;
 throw new IllegalArgumentException(&quot;timeout should be &amp;gt;= 0&quot;);&lt;/p&gt;

&lt;p&gt;@@ -345,8 +346,10 @@ public class Selector implements Selectable, AutoCloseable {&lt;br/&gt;
 }&lt;br/&gt;
 outOfMemory = false;&lt;br/&gt;
 }&lt;br/&gt;
 -&lt;br/&gt;
 + */&lt;br/&gt;
 /* check ready keys */&lt;br/&gt;
 +&lt;br/&gt;
 + /*&lt;br/&gt;
 long startSelect = time.nanoseconds();&lt;br/&gt;
 int numReadyKeys = select(timeout);&lt;br/&gt;
 long endSelect = time.nanoseconds();&lt;br/&gt;
 @@ -379,6 +382,7 @@ public class Selector implements Selectable, AutoCloseable&lt;br/&gt;
Unknown macro: { // Add to completedReceives after closing expired connections to avoid removing // channels with completed receives until all staged receives are completed. addToCompletedReceives();+ */ }&lt;br/&gt;
&#160;&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16506787" author="radai" created="Sat, 9 Jun 2018 02:05:57 +0000"  >&lt;p&gt;no, not all of poll(), just this part:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-comment&quot;&gt;// Poll from channels that have buffered data (but nothing more from the underlying socket)
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dataInBuffers) {
                keysWithBufferedRead.removeAll(readyKeys); &lt;span class=&quot;code-comment&quot;&gt;//so no channel gets polled twice
&lt;/span&gt;                Set&amp;lt;SelectionKey&amp;gt; toPoll = keysWithBufferedRead;
                keysWithBufferedRead = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;(); &lt;span class=&quot;code-comment&quot;&gt;//poll() calls will repopulate &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; needed
&lt;/span&gt;                pollSelectionKeys(toPoll, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, endSelect);  &amp;lt;---- COMMENT THIS OUT
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;just comment out the call to pollSelectionKeys() at the end of the condition&lt;/p&gt;</comment>
                            <comment id="16506838" author="rajadayalanvdms" created="Sat, 9 Jun 2018 06:23:27 +0000"  >&lt;p&gt;yes, your hypothesis&#160;is right. cpu usage is fine with the pollSelectionKeys() line commented, screenshot attached. Tried it on 1.0.1 version also and cpu usage is fine.&lt;/p&gt;</comment>
                            <comment id="16506994" author="radai" created="Sat, 9 Jun 2018 13:39:18 +0000"  >&lt;p&gt;that line is meant to handle a (hypothetical) scenario where socket data is available in the SSL cyphertext buffer but no data will ever be read from the socket itself again.&lt;br/&gt;
i guess we&apos;ll need to add some code to only run this path every-so-often as the SSL code is apparently likely to leave things behind.&lt;br/&gt;
did commenting this out affect function/correctness? missing msgs? higher 99th percentile latencies?&lt;/p&gt;</comment>
                            <comment id="16507172" author="rajadayalanvdms" created="Sat, 9 Jun 2018 22:19:09 +0000"  >&lt;p&gt;Need to check regarding the correctness/missing msgs. Will check and update.&lt;/p&gt;</comment>
                            <comment id="16509927" author="rajadayalanvdms" created="Tue, 12 Jun 2018 17:37:21 +0000"  >&lt;p&gt;Tried out in&#160;a different cluster 20 nodes(million msgs/sec), upgraded 5 nodes to 1.0.1 with the patched jar. can confirm that it is not affecting function/Missing msgs and latency also looks fine.&lt;/p&gt;</comment>
                            <comment id="16510122" author="radai" created="Tue, 12 Jun 2018 20:07:01 +0000"  >&lt;p&gt;in light of that i think the safe change to make would be to only record keys with bytes still buffered if memory pressure prevented anything from being read out this round (as opposed to always, as is current behaviour).&lt;/p&gt;</comment>
                            <comment id="16512935" author="rajadayalanvdms" created="Thu, 14 Jun 2018 20:18:43 +0000"  >&lt;p&gt;Thanks, are you&#160;planning a PR to change the&#160;behaviour of polling buffered keys?&#160;&lt;/p&gt;</comment>
                            <comment id="16513037" author="radai" created="Thu, 14 Jun 2018 21:45:49 +0000"  >&lt;p&gt;i dont have the time to pick this up right now.&lt;/p&gt;

&lt;p&gt;IIRC the original PR (&lt;a href=&quot;https://github.com/apache/kafka/pull/2330&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2330&lt;/a&gt;) had a more complicated condition for when a key (channel) gets picked into `keysWithBufferedRead`. the codition is currently&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (channel.hasBytesBuffered()) {
                    &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; channel has bytes enqueued in intermediary buffers that we could not read
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;//(possibly because no memory). it may be the &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; that the underlying socket will
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;//not come up in the next poll() and so we need to remember &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; channel &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;//next poll call otherwise data may be stuck in said buffers forever.
&lt;/span&gt;                    keysWithBufferedRead.add(key);
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which results in lots of &quot;false positives&quot; - keys that have something left over in ssl buffers (likely, since request sizes are rarely a multiple of ssl cipher block sizes) that cause the next poll() cycle to be inefficient.&lt;/p&gt;

&lt;p&gt;the conditions needs to check if a channel has something left &lt;b&gt;that could not be read out due to memory pressure&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;alternatively - the doomsday scenario this is meant to handle is pretty rare: if a channel has a request fully inside the ssl buffers that cannot be read due to memory pressure, &lt;b&gt;and&lt;/b&gt; the underlying channel will never have any more incoming bytes (so will never come back from select) the request will sit there and rot resulting in a client timeout.&lt;/p&gt;

&lt;p&gt;the alternative to making the condition more complicated is not treating this case at all and suffering the (rare?) timeout?&lt;/p&gt;</comment>
                            <comment id="16513045" author="yuzhihong@gmail.com" created="Thu, 14 Jun 2018 21:54:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;not treating this case at all and suffering the (rare?) timeout?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Should be acceptable before better solution (with no performance penalty) is found.&lt;/p&gt;</comment>
                            <comment id="16513910" author="ijuma" created="Fri, 15 Jun 2018 14:44:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;, what are your thoughts on this one? It&apos;s a performance regression so it would be good to address.&lt;/p&gt;</comment>
                            <comment id="16513957" author="rsivaram" created="Fri, 15 Jun 2018 15:21:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=patl&quot; class=&quot;user-hover&quot; rel=&quot;patl&quot;&gt;patl&lt;/a&gt; Are you actively working on this JIRA? If not, can I pick it up and provide a simple solution to include in 2.0.0 - we are very close to cutting the first RC and it will be good to include at least a simple fix for this issue (we can improve on that in a follow on PR if required after the release). Let me know if you have any objections. Thank you!&lt;/p&gt;</comment>
                            <comment id="16514484" author="githubbot" created="Fri, 15 Jun 2018 23:15:55 +0000"  >&lt;p&gt;rajinisivaram opened a new pull request #5237: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7012&quot; title=&quot;Performance issue upgrading to kafka 1.0.1 or 1.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7012&quot;&gt;&lt;del&gt;KAFKA-7012&lt;/del&gt;&lt;/a&gt;: Don&apos;t process SSL channels without data to process&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5237&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Avoid unnecessary processing of SSL channels when there are some bytes buffered, but not enough to make progress.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16517146" author="githubbot" created="Tue, 19 Jun 2018 14:16:20 +0000"  >&lt;p&gt;rajinisivaram closed pull request #5237: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7012&quot; title=&quot;Performance issue upgrading to kafka 1.0.1 or 1.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7012&quot;&gt;&lt;del&gt;KAFKA-7012&lt;/del&gt;&lt;/a&gt;: Don&apos;t process SSL channels without data to process&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5237&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/Selector.java b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
index 334ca79f035..a269f0fd604 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/Selector.java&lt;br/&gt;
@@ -498,7 +498,9 @@ void pollSelectionKeys(Set&amp;lt;SelectionKey&amp;gt; selectionKeys,&lt;br/&gt;
                     //this channel has bytes enqueued in intermediary buffers that we could not read&lt;br/&gt;
                     //(possibly because no memory). it may be the case that the underlying socket will&lt;br/&gt;
                     //not come up in the next poll() and so we need to remember this channel for the&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;//next poll call otherwise data may be stuck in said buffers forever.&lt;br/&gt;
+                    //next poll call otherwise data may be stuck in said buffers forever. If we attempt&lt;br/&gt;
+                    //to process buffered data and no progress is made, the channel buffered status is&lt;br/&gt;
+                    //cleared to avoid the overhead of checking every time.&lt;br/&gt;
                     keysWithBufferedRead.add(key);&lt;br/&gt;
                 }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java b/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
index 704a19818e2..06e7e937886 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/SslTransportLayer.java&lt;br/&gt;
@@ -64,6 +64,7 @@&lt;br/&gt;
     private ByteBuffer netReadBuffer;&lt;br/&gt;
     private ByteBuffer netWriteBuffer;&lt;br/&gt;
     private ByteBuffer appReadBuffer;&lt;br/&gt;
+    private boolean hasBytesBuffered;&lt;br/&gt;
     private ByteBuffer emptyBuf = ByteBuffer.allocate(0);&lt;/p&gt;

&lt;p&gt;     public static SslTransportLayer create(String channelId, SelectionKey key, SSLEngine sslEngine) throws IOException {&lt;br/&gt;
@@ -503,13 +504,17 @@ public int read(ByteBuffer dst) throws IOException &lt;/p&gt;
{
             read = readFromAppBuffer(dst);
         }

&lt;p&gt;+        boolean readFromNetwork = false;&lt;br/&gt;
         boolean isClosed = false;&lt;br/&gt;
         // Each loop reads at most once from the socket.&lt;br/&gt;
         while (dst.remaining() &amp;gt; 0) {&lt;br/&gt;
             int netread = 0;&lt;br/&gt;
             netReadBuffer = Utils.ensureCapacity(netReadBuffer, netReadBufferSize());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (netReadBuffer.remaining() &amp;gt; 0)&lt;br/&gt;
+            if (netReadBuffer.remaining() &amp;gt; 0) 
{
                 netread = readFromSocketChannel();
+                if (netread &amp;gt; 0)
+                    readFromNetwork = true;
+            }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             while (netReadBuffer.position() &amp;gt; 0) {&lt;br/&gt;
                 netReadBuffer.flip();&lt;br/&gt;
@@ -563,6 +568,7 @@ public int read(ByteBuffer dst) throws IOException &lt;/p&gt;
{
             if (netread &amp;lt;= 0 || isClosed)
                 break;
         }
&lt;p&gt;+        updateBytesBuffered(readFromNetwork || read &amp;gt; 0);&lt;br/&gt;
         // If data has been read and unwrapped, return the data even if end-of-stream, channel will be closed&lt;br/&gt;
         // on a subsequent poll.&lt;br/&gt;
         return read;&lt;br/&gt;
@@ -793,6 +799,11 @@ protected ByteBuffer netReadBuffer() &lt;/p&gt;
{
         return netReadBuffer;
     }

&lt;p&gt;+    // Visibility for testing&lt;br/&gt;
+    protected ByteBuffer appReadBuffer() &lt;/p&gt;
{
+        return appReadBuffer;
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;SSL exceptions are propagated as authentication failures so that clients can avoid&lt;/li&gt;
	&lt;li&gt;retries and report the failure. If `flush` is true, exceptions are propagated after&lt;br/&gt;
@@ -826,12 +837,22 @@ public boolean isMute() {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
     public boolean hasBytesBuffered() &lt;/p&gt;
{
-        return netReadBuffer.position() != 0 || appReadBuffer.position() != 0;
+        return hasBytesBuffered;
+    }
&lt;p&gt;+&lt;br/&gt;
+    // Update `hasBytesBuffered` status. If any bytes were read from the network or&lt;br/&gt;
+    // if data was returned from read, `hasBytesBuffered` is set to true if any buffered&lt;br/&gt;
+    // data is still remaining. If not, `hasBytesBuffered` is set to false since no progress&lt;br/&gt;
+    // can be made until more data is available to read from the network.&lt;br/&gt;
+    private void updateBytesBuffered(boolean madeProgress) &lt;/p&gt;
{
+        if (madeProgress)
+            hasBytesBuffered = netReadBuffer.position() != 0 || appReadBuffer.position() != 0;
+        else
+            hasBytesBuffered = false;
     }

&lt;p&gt;     @Override&lt;br/&gt;
     public long transferFrom(FileChannel fileChannel, long position, long count) throws IOException &lt;/p&gt;
{
         return fileChannel.transferTo(position, count, this);
     }
&lt;p&gt;-&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/clients/src/main/java/org/apache/kafka/common/network/TransportLayer.java b/clients/src/main/java/org/apache/kafka/common/network/TransportLayer.java&lt;br/&gt;
index 3673d21dae6..a8a4b873028 100644&lt;br/&gt;
&amp;#8212; a/clients/src/main/java/org/apache/kafka/common/network/TransportLayer.java&lt;br/&gt;
+++ b/clients/src/main/java/org/apache/kafka/common/network/TransportLayer.java&lt;br/&gt;
@@ -94,6 +94,7 @@&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@return true if channel has bytes to be read in any intermediate buffers&lt;br/&gt;
+     * which may be processed without reading additional data from the network.&lt;br/&gt;
      */&lt;br/&gt;
     boolean hasBytesBuffered();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/clients/src/test/java/org/apache/kafka/common/network/SslSelectorTest.java b/clients/src/test/java/org/apache/kafka/common/network/SslSelectorTest.java&lt;br/&gt;
index 1d78e5aa8e1..3bdb07a87c3 100644&lt;br/&gt;
&amp;#8212; a/clients/src/test/java/org/apache/kafka/common/network/SslSelectorTest.java&lt;br/&gt;
+++ b/clients/src/test/java/org/apache/kafka/common/network/SslSelectorTest.java&lt;br/&gt;
@@ -42,6 +42,9 @@&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
+import java.util.Set;&lt;br/&gt;
+import java.util.concurrent.atomic.AtomicInteger;&lt;br/&gt;
+import java.util.function.Consumer;&lt;/p&gt;

&lt;p&gt; import static org.junit.Assert.assertEquals;&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
@@ -96,6 +99,13 @@ public void testDisconnectWithIntermediateBufferedBytes() throws Exception &lt;/p&gt;
{
         connect(node, new InetSocketAddress(&quot;localhost&quot;, server.port));
         selector.send(createSend(node, request));
 
+        waitForBytesBuffered(selector, node);
+
+        selector.close(node);
+        verifySelectorEmpty();
+    }
&lt;p&gt;+&lt;br/&gt;
+    private void waitForBytesBuffered(Selector selector, String node) throws Exception {&lt;br/&gt;
         TestUtils.waitForCondition(new TestCondition() {&lt;br/&gt;
             @Override&lt;br/&gt;
             public boolean conditionMet() {&lt;br/&gt;
@@ -107,8 +117,72 @@ public boolean conditionMet() {&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }, 2000L, &quot;Failed to reach socket state with bytes buffered&quot;);&lt;br/&gt;
+    }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;selector.close(node);&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testBytesBufferedChannelWithNoIncomingBytes() throws Exception 
{
+        verifyNoUnnecessaryPollWithBytesBuffered(key -&amp;gt;
+            key.interestOps(key.interestOps() &amp;amp; ~SelectionKey.OP_READ));
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testBytesBufferedChannelAfterMute() throws Exception &lt;/p&gt;
{
+        verifyNoUnnecessaryPollWithBytesBuffered(key -&amp;gt; ((KafkaChannel) key.attachment()).mute());
+    }
&lt;p&gt;+&lt;br/&gt;
+    private void verifyNoUnnecessaryPollWithBytesBuffered(Consumer&amp;lt;SelectionKey&amp;gt; disableRead)&lt;br/&gt;
+            throws Exception {&lt;br/&gt;
+        this.selector.close();&lt;br/&gt;
+&lt;br/&gt;
+        String node1 = &quot;1&quot;;&lt;br/&gt;
+        String node2 = &quot;2&quot;;&lt;br/&gt;
+        final AtomicInteger node1Polls = new AtomicInteger();&lt;br/&gt;
+&lt;br/&gt;
+        this.channelBuilder = new TestSslChannelBuilder(Mode.CLIENT);&lt;br/&gt;
+        this.channelBuilder.configure(sslClientConfigs);&lt;br/&gt;
+        this.selector = new Selector(5000, metrics, time, &quot;MetricGroup&quot;, channelBuilder, new LogContext()) {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            void pollSelectionKeys(Set&amp;lt;SelectionKey&amp;gt; selectionKeys, boolean isImmediatelyConnected, long currentTimeNanos) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                for (SelectionKey key }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        };&lt;br/&gt;
+&lt;br/&gt;
+        // Get node1 into bytes buffered state and then disable read on the socket.&lt;br/&gt;
+        // Truncate the read buffers to ensure that there is buffered data, but not enough to make progress.&lt;br/&gt;
+        int largeRequestSize = 100 * 1024;&lt;br/&gt;
+        connect(node1, new InetSocketAddress(&quot;localhost&quot;, server.port));&lt;br/&gt;
+        selector.send(createSend(node1,  TestUtils.randomString(largeRequestSize)));&lt;br/&gt;
+        waitForBytesBuffered(selector, node1);&lt;br/&gt;
+        TestSslChannelBuilder.TestSslTransportLayer.transportLayers.get(node1).truncateReadBuffer();&lt;br/&gt;
+        disableRead.accept(selector.channel(node1).selectionKey());&lt;br/&gt;
+&lt;br/&gt;
+        // Clear poll count and count the polls from now on&lt;br/&gt;
+        node1Polls.set(0);&lt;br/&gt;
+&lt;br/&gt;
+        // Process sends and receives on node2. Test verifies that we don&apos;t process node1&lt;br/&gt;
+        // unnecessarily on each of these polls.&lt;br/&gt;
+        connect(node2, new InetSocketAddress(&quot;localhost&quot;, server.port));&lt;br/&gt;
+        int received = 0;&lt;br/&gt;
+        String request = TestUtils.randomString(10);&lt;br/&gt;
+        selector.send(createSend(node2, request));&lt;br/&gt;
+        while (received &amp;lt; 100) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            received += selector.completedReceives().size();+            if (!selector.completedSends().isEmpty()) {
+                selector.send(createSend(node2, request));
+            }+            selector.poll(5);+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+        // Verify that pollSelectionKeys was invoked once to process buffered data&lt;br/&gt;
+        // but not again since there isn&apos;t sufficient data to process.&lt;br/&gt;
+        assertEquals(1, node1Polls.get());&lt;br/&gt;
+        selector.close(node1);&lt;br/&gt;
+        selector.close(node2);&lt;br/&gt;
         verifySelectorEmpty();&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -252,22 +326,33 @@ protected SslTransportLayer buildTransportLayer(SslFactory sslFactory, String id&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TestSslTransportLayer will read from socket once every two tries. This increases&lt;/li&gt;
	&lt;li&gt;the chance that there will be bytes buffered in the transport layer after read().&lt;br/&gt;
          */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;class TestSslTransportLayer extends SslTransportLayer {&lt;br/&gt;
+        static class TestSslTransportLayer extends SslTransportLayer {&lt;br/&gt;
+            static Map&amp;lt;String, TestSslTransportLayer&amp;gt; transportLayers = new HashMap&amp;lt;&amp;gt;();&lt;br/&gt;
             boolean muteSocket = false;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             public TestSslTransportLayer(String channelId, SelectionKey key, SSLEngine sslEngine) throws IOException &lt;/p&gt;
{
                 super(channelId, key, sslEngine);
+                transportLayers.put(channelId, this);
             }

&lt;p&gt;             @Override&lt;br/&gt;
             protected int readFromSocketChannel() throws IOException {&lt;br/&gt;
                 if (muteSocket) &lt;/p&gt;
{
-                    muteSocket = false;
+                    if ((selectionKey().interestOps() &amp;amp; SelectionKey.OP_READ) != 0)
+                        muteSocket = false;
                     return 0;
                 }
&lt;p&gt;                 muteSocket = true;&lt;br/&gt;
                 return super.readFromSocketChannel();&lt;br/&gt;
             }&lt;br/&gt;
+&lt;br/&gt;
+            // Leave one byte in network read buffer so that some buffered bytes are present,&lt;br/&gt;
+            // but not enough to make progress on a read.&lt;br/&gt;
+            void truncateReadBuffer() throws Exception &lt;/p&gt;
{
+                netReadBuffer().position(1);
+                appReadBuffer().position(0);
+                muteSocket = true;
+            }
&lt;p&gt;         }&lt;br/&gt;
     }&lt;/p&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16517386" author="rajadayalanvdms" created="Tue, 19 Jun 2018 18:05:21 +0000"  >&lt;p&gt;Thanks for resolving the issue. Will this patch be applied to 1.0.1/1.1&#160;versions also? We are planning to upgrade to 1.0.1/1.1 version, patch for that version will be helpful.&lt;/p&gt;</comment>
                            <comment id="16517937" author="rsivaram" created="Wed, 20 Jun 2018 08:51:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajadayalanvdms&quot; class=&quot;user-hover&quot; rel=&quot;rajadayalanvdms&quot;&gt;rajadayalanvdms&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; I have cherry-picked this to 1.0 and 1.1 branches, so it should be available in the next bug-fix release.&lt;/p&gt;</comment>
                            <comment id="16518387" author="mjsax" created="Wed, 20 Jun 2018 17:36:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rsivaram&quot; class=&quot;user-hover&quot; rel=&quot;rsivaram&quot;&gt;rsivaram&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; Was this cherry-picked to 1.1 before or after the RC0 was cut? Might not be in 1.1.1 release, but go into 1.1.2 if cherry-picked afterwards. We should double check and maybe update the &quot;fix version&quot; of this ticket. For 1.0.2, is will go in &#8211; I am blocked on some system test atm to cut the first RC.&lt;/p&gt;</comment>
                            <comment id="16518445" author="ijuma" created="Wed, 20 Jun 2018 18:24:43 +0000"  >&lt;p&gt;Yes, I think this may have missed the 1.1.1 cut.&lt;/p&gt;</comment>
                            <comment id="16518751" author="lindong" created="Thu, 21 Jun 2018 00:36:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt;&#160;It is not included in RC0 for 1.1.1. I just updated the &quot;fix version&quot; to include 1.1.2.&lt;/p&gt;

&lt;p&gt;For cases like this, do we expect to include the patch in RC1 for 1.1.1?&lt;/p&gt;</comment>
                            <comment id="16518753" author="ijuma" created="Thu, 21 Jun 2018 00:38:22 +0000"  >&lt;p&gt;Unless it&apos;s deemed a blocker, it would wait until 1.1.2.&lt;/p&gt;</comment>
                            <comment id="16519666" author="ijuma" created="Thu, 21 Jun 2018 18:32:57 +0000"  >&lt;p&gt;Dong has published 1.1.1 RC1 due to another issue which means that this will be in 1.1.1.&lt;/p&gt;</comment>
                            <comment id="16519694" author="ckasten" created="Thu, 21 Jun 2018 19:08:13 +0000"  >&lt;p&gt;On behalf of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajadayalanvdms&quot; class=&quot;user-hover&quot; rel=&quot;rajadayalanvdms&quot;&gt;rajadayalanvdms&lt;/a&gt; and myself, thank you all!&lt;/p&gt;</comment>
                            <comment id="16522861" author="rajadayalanvdms" created="Mon, 25 Jun 2018 21:49:52 +0000"  >&lt;p&gt;Tried 1.1.2 version in our kafka cluster, performance looks good.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
Thank you&#160;all again!!!&lt;/p&gt;</comment>
                            <comment id="16523303" author="lindong" created="Tue, 26 Jun 2018 06:49:08 +0000"  >&lt;p&gt;Great to know that the fix works!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12927155" name="Commit-47ee8e954-0607-bufferkeys-nopoll-profile.png" size="494304" author="rajadayalanvdms" created="Sat, 9 Jun 2018 06:22:24 +0000"/>
                            <attachment id="12926997" name="Commit-47ee8e954-0607-memory.png" size="96479" author="rajadayalanvdms" created="Fri, 8 Jun 2018 00:47:08 +0000"/>
                            <attachment id="12926998" name="Commit-47ee8e954-0607-profile.png" size="285686" author="rajadayalanvdms" created="Fri, 8 Jun 2018 00:47:08 +0000"/>
                            <attachment id="12926766" name="Commit-47ee8e954-profile.png" size="247562" author="rajadayalanvdms" created="Wed, 6 Jun 2018 18:14:41 +0000"/>
                            <attachment id="12926767" name="Commit-47ee8e954-profile2.png" size="565868" author="rajadayalanvdms" created="Wed, 6 Jun 2018 18:14:41 +0000"/>
                            <attachment id="12926765" name="Commit-f15cdbc91b-profile.png" size="236237" author="rajadayalanvdms" created="Wed, 6 Jun 2018 18:14:41 +0000"/>
                            <attachment id="12926933" name="Commit-f15cdbc91b-profile2.png" size="548620" author="rajadayalanvdms" created="Thu, 7 Jun 2018 17:26:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ulav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>junrao</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>