<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:06:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6367] Fix StateRestoreListener To Use Correct Batch Ending Offset</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6367</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;tt&gt;StateRestoreListener#restoreBatchCompleted&lt;/tt&gt; takes the &lt;tt&gt;nextPosition&lt;/tt&gt; long&#160;for the batch ending offset, but the &lt;tt&gt;nextPosition&lt;/tt&gt; is not correct, it should be the offset of the latest restored offset, but &lt;tt&gt;nextPosition&lt;/tt&gt; is the offset of the first not restored offset.&lt;/p&gt;

&lt;p&gt;We can&apos;t automatically use &lt;tt&gt;nextPosition&lt;/tt&gt; - 1 as this could be a commit marker.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13125048">KAFKA-6367</key>
            <summary>Fix StateRestoreListener To Use Correct Batch Ending Offset</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bbejeck">Bill Bejeck</assignee>
                                    <reporter username="bbejeck">Bill Bejeck</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Dec 2017 22:37:58 +0000</created>
                <updated>Mon, 12 Feb 2018 17:20:51 +0000</updated>
                            <resolved>Wed, 7 Feb 2018 19:24:37 +0000</resolved>
                                    <version>0.11.0.0</version>
                    <version>1.0.0</version>
                                    <fixVersion>1.0.1</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16292054" author="mjsax" created="Fri, 15 Dec 2017 05:36:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;We can&apos;t automatically use &lt;tt&gt;nextPosition - 1&lt;/tt&gt; as this could be a commit marker.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It a valid point, but I am not sure if returning the offset of a commit marker would be an issue or not. The provided offset is called &lt;tt&gt;batchEndOffset&lt;/tt&gt; &amp;#8211; this does not imply &quot;offset of last restored record&quot;; or does it?&lt;/p&gt;

&lt;p&gt;If we don&apos;t return commit marker offsets, we get &quot;gaps&quot; &amp;#8211; thus, if someone tracks the offsets in the callback and assume &quot;completeness&quot; this would be violated. On the other hand, if there are aborted messages, we might have gaps anyway...&lt;/p&gt;

&lt;p&gt;Not sure what other think. To me it seems, we don&apos;t get much advantage if we don&apos;t &quot;return&quot; commit markers but get lot of additional complexity. Thus, I tend to think that using &lt;tt&gt;nextPosition - 1&lt;/tt&gt; might be ok.&lt;/p&gt;</comment>
                            <comment id="16343892" author="ewencp" created="Mon, 29 Jan 2018 19:42:03 +0000"  >&lt;p&gt;Moving from 1.0.1 to 1.0.2 as this isn&apos;t ready for 1.0.1.&lt;/p&gt;</comment>
                            <comment id="16349206" author="githubbot" created="Thu, 1 Feb 2018 20:29:05 +0000"  >&lt;p&gt;bbejeck opened a new pull request #4507: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6367&quot; title=&quot;Fix StateRestoreListener To Use Correct Batch Ending Offset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6367&quot;&gt;&lt;del&gt;KAFKA-6367&lt;/del&gt;&lt;/a&gt;: StateRestoreListener use actual last restored offset for restored batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4507&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4507&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;   Use the last actual restored offset for the `StoreRestoreListener.onBatchRestored` method.  Probably should update the docs to inform users this could include gaps in sequence due to commit markers.&lt;/p&gt;

&lt;p&gt;   Updated existing tests&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16355902" author="githubbot" created="Wed, 7 Feb 2018 19:07:34 +0000"  >&lt;p&gt;mjsax closed pull request #4507: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6367&quot; title=&quot;Fix StateRestoreListener To Use Correct Batch Ending Offset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6367&quot;&gt;&lt;del&gt;KAFKA-6367&lt;/del&gt;&lt;/a&gt;: StateRestoreListener use actual last restored offset for restored batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4507&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4507&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/StateRestoreListener.java b/streams/src/main/java/org/apache/kafka/streams/processor/StateRestoreListener.java&lt;br/&gt;
index c80a736734d..ea1c2888409 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/processor/StateRestoreListener.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/StateRestoreListener.java&lt;br/&gt;
@@ -43,7 +43,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param topicPartition the TopicPartition containing the values to restore&lt;/li&gt;
	&lt;li&gt;@param storeName      the name of the store undergoing restoration&lt;/li&gt;
	&lt;li&gt;@param startingOffset the starting offset of the entire restoration process for this TopicPartition&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param endingOffset   the ending offset of the entire restoration process for this TopicPartition&lt;br/&gt;
+     * @param endingOffset   the exclusive ending offset of the entire restoration process for this TopicPartition&lt;br/&gt;
      */&lt;br/&gt;
     void onRestoreStart(final TopicPartition topicPartition,&lt;br/&gt;
                         final String storeName,&lt;br/&gt;
@@ -62,7 +62,7 @@ void onRestoreStart(final TopicPartition topicPartition,&lt;br/&gt;
      *&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param topicPartition the TopicPartition containing the values to restore&lt;/li&gt;
	&lt;li&gt;@param storeName the name of the store undergoing restoration&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* @param batchEndOffset the ending offset for the current restored batch for this TopicPartition&lt;br/&gt;
+     * @param batchEndOffset the inclusive ending offset for the current restored batch for this TopicPartition&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;@param numRestored the total number of records restored in this batch for this TopicPartition&lt;br/&gt;
      */&lt;br/&gt;
     void onBatchRestored(final TopicPartition topicPartition,&lt;br/&gt;
diff --git a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java&lt;br/&gt;
index ba17ce95ede..b11c45ba313 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java&lt;br/&gt;
@@ -273,12 +273,14 @@ private long processNext(final List&amp;lt;ConsumerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; records,&lt;br/&gt;
         long nextPosition = -1;&lt;br/&gt;
         int numberRecords = records.size();&lt;br/&gt;
         int numberRestored = 0;&lt;br/&gt;
+        long lastRestoredOffset = -1;&lt;br/&gt;
         for (final ConsumerRecord&amp;lt;byte[], byte[]&amp;gt; record : records) {&lt;br/&gt;
             final long offset = record.offset();&lt;br/&gt;
             if (restorer.hasCompleted(offset, endOffset)) 
{
                 nextPosition = record.offset();
                 break;
             }
&lt;p&gt;+            lastRestoredOffset = offset;&lt;br/&gt;
             numberRestored++;&lt;br/&gt;
             if (record.key() != null) {&lt;br/&gt;
                 restoreRecords.add(KeyValue.pair(record.key(), record.value()));&lt;br/&gt;
@@ -295,8 +297,7 @@ private long processNext(final List&amp;lt;ConsumerRecord&amp;lt;byte[], byte[]&amp;gt;&amp;gt; records,&lt;/p&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         if (!restoreRecords.isEmpty()) &lt;/p&gt;
{
             restorer.restore(restoreRecords);
-            restorer.restoreBatchCompleted(nextPosition, records.size());
-
+            restorer.restoreBatchCompleted(lastRestoredOffset, records.size());
         }

&lt;p&gt;         return nextPosition;&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreChangelogReaderTest.java b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreChangelogReaderTest.java&lt;br/&gt;
index ee964513415..e69cede23fd 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreChangelogReaderTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/processor/internals/StoreChangelogReaderTest.java&lt;br/&gt;
@@ -234,15 +234,28 @@ public void shouldRestoreAndNotifyMultipleStores() throws Exception &lt;/p&gt;
{
         assertThat(callbackTwo.restored.size(), equalTo(3));
 
         assertAllCallbackStatesExecuted(callback, &quot;storeName1&quot;);
-        assertCorrectOffsetsReportedByListener(callback, 0L, 10L, 10L);
+        assertCorrectOffsetsReportedByListener(callback, 0L, 9L, 10L);
 
         assertAllCallbackStatesExecuted(callbackOne, &quot;storeName2&quot;);
-        assertCorrectOffsetsReportedByListener(callbackOne, 0L, 5L, 5L);
+        assertCorrectOffsetsReportedByListener(callbackOne, 0L, 4L, 5L);
 
         assertAllCallbackStatesExecuted(callbackTwo, &quot;storeName3&quot;);
-        assertCorrectOffsetsReportedByListener(callbackTwo, 0L, 3L, 3L);
+        assertCorrectOffsetsReportedByListener(callbackTwo, 0L, 2L, 3L);
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldOnlyReportTheLastRestoredOffset() &lt;/p&gt;
{
+        setupConsumer(10, topicPartition);
+        changelogReader
+            .register(new StateRestorer(topicPartition, restoreListener, null, 5, true, &quot;storeName1&quot;));
+        changelogReader.restore(active);
+
+        assertThat(callback.restored.size(), equalTo(5));
+        assertAllCallbackStatesExecuted(callback, &quot;storeName1&quot;);
+        assertCorrectOffsetsReportedByListener(callback, 0L, 4L, 5L);
+    }
&lt;p&gt;+&lt;br/&gt;
+&lt;br/&gt;
     private void assertAllCallbackStatesExecuted(final MockStateRestoreListener restoreListener,&lt;br/&gt;
                                                  final String storeName) {&lt;br/&gt;
         assertThat(restoreListener.storeNameCalledStates.get(RESTORE_START), equalTo(storeName));&lt;br/&gt;
@@ -253,11 +266,12 @@ private void assertAllCallbackStatesExecuted(final MockStateRestoreListener rest&lt;/p&gt;

&lt;p&gt;     private void assertCorrectOffsetsReportedByListener(final MockStateRestoreListener restoreListener,&lt;br/&gt;
                                                         final long startOffset,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long batchOffset, final long endOffset) {&lt;br/&gt;
+                                                        final long batchOffset,&lt;br/&gt;
+                                                        final long totalRestored) 
{
 
         assertThat(restoreListener.restoreStartOffset, equalTo(startOffset));
         assertThat(restoreListener.restoredBatchOffset, equalTo(batchOffset));
-        assertThat(restoreListener.restoreEndOffset, equalTo(endOffset));
+        assertThat(restoreListener.totalNumRestored, equalTo(totalRestored));
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nx5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>