<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:22:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-9355] RocksDB statistics are removed from JMX when EOS enabled and empty local state dir</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-9355</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;b&gt;Steps to Reproduce&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Set&#160;processing.guarantee = exactly_once and remove local state dir in order to force state restoration from changelog topics that have to be non empty.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expected Behavior&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;There are registered MBeans like&#160;kafka.streams:type=stream-state-metrics,client-id=&amp;lt;application.id&amp;gt;-678e4b25-8fc7-4266-85a0-7a5fe52a4060-StreamThread-1,task-id=0_0,rocksdb-state-id=&amp;lt;state.store&amp;gt; for persistent RocksDB KeyValueStore-s after streams task state restoration.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Actual Behavior&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;There are no registered MBeans like above&#160;after streams task state restoration.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Details&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I managed to inject custom MetricsReporter in order to log&#160;metricChange and metricRemoval calls. According to the logs at some point the missing metrics are removed and never restored later. Here is an excerpt for number-open-files metric:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;16:33:40.403 DEBUG c.m.r.LoggingMetricsReporter - metricChange MetricName [name=number-open-files, group=stream-state-metrics, description=Number of currently open files, tags={client-id=morpheus.conversion-678e4b25-8fc7-4266-85a0-7a5fe52a4060-StreamThread-1, task-id=0_0, rocksdb-state-id=buffered-event}]
16:33:40.403 DEBUG o.a.k.s.s.i.m.RocksDBMetricsRecorder - [RocksDB Metrics Recorder for buffered-event] Adding metrics recorder of task 0_0 to metrics recording trigger
16:33:40.403 DEBUG o.a.k.s.s.i.m.RocksDBMetricsRecorder - [RocksDB Metrics Recorder for buffered-event] Adding statistics for store buffered-event of task 0_0
16:33:40.610 INFO  o.a.k.s.p.i.StoreChangelogReader - stream-thread [morpheus.conversion-678e4b25-8fc7-4266-85a0-7a5fe52a4060-StreamThread-1] No checkpoint found for task 0_0 state store buffered-event changelog morpheus.conversion-buffered-event-changelog-0 with EOS turned on. Reinitializing the task and restore its state from the beginning.
16:33:40.610 DEBUG o.a.k.s.s.i.m.RocksDBMetricsRecorder - [RocksDB Metrics Recorder for buffered-event] Removing statistics for store buffered-event of task 0_0
16:33:40.610 DEBUG o.a.k.s.s.i.m.RocksDBMetricsRecorder - [RocksDB Metrics Recorder for buffered-event] Removing metrics recorder for store buffered-event of task 0_0 from metrics recording trigger
16:33
16:33:40.611 DEBUG c.m.r.LoggingMetricsReporter - metricRemoval MetricName [name=number-open-files, group=stream-state-metrics, description=Number of currently open files, tags={client-id=morpheus.conversion-678e4b25-8fc7-4266-85a0-7a5fe52a4060-StreamThread-1, task-id=0_0, rocksdb-state-id=buffered-event}]
16:33:40.625 DEBUG o.a.k.s.s.i.m.RocksDBMetricsRecorder - [RocksDB Metrics Recorder for buffered-event] Adding metrics recorder of task 0_0 to metrics recording trigger
16:33:40.625 DEBUG o.a.k.s.s.i.m.RocksDBMetricsRecorder - [RocksDB Metrics Recorder for buffered-event] Adding statistics for store buffered-event of task 0_0
...
(no more calls to metricChange for the removed number-open-files metric)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Also a complete log is attached&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12989809/12989809_metric-removal.log&quot; title=&quot;metric-removal.log attached to KAFKA-9355&quot;&gt;metric-removal.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Metric removal happens along this call stack:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;19:27:35.509 DEBUG c.m.r.LoggingMetricsReporter - metricRemoval MetricName [name=number-open-files, group=stream-state-metrics, description=Number of currently open files, tags={client-id=morpheus.conversion-9b76f302-7149-47de-b17b-362d642e05d5-StreamThread-1, task-id=0_0, rocksdb-state-id=buffered-event}]
java.lang.Exception: null
   at casino.morpheus.reporter.LoggingMetricsReporter.metricRemoval(LoggingMetricsReporter.scala:24)
   at org.apache.kafka.common.metrics.Metrics.removeMetric(Metrics.java:534)
   at org.apache.kafka.common.metrics.Metrics.removeSensor(Metrics.java:448)
   at org.apache.kafka.streams.processor.internals.metrics.StreamsMetricsImpl.removeAllStoreLevelSensors(StreamsMetricsImpl.java:440)
   at org.apache.kafka.streams.state.internals.MeteredKeyValueStore.close(MeteredKeyValueStore.java:345)
   at org.apache.kafka.streams.processor.internals.StateManagerUtil.reinitializeStateStoresForPartitions(StateManagerUtil.java:93)
   at org.apache.kafka.streams.processor.internals.ProcessorStateManager.reinitializeStateStoresForPartitions(ProcessorStateManager.java:190)
   at org.apache.kafka.streams.processor.internals.AbstractTask.reinitializeStateStoresForPartitions(AbstractTask.java:215)
   at org.apache.kafka.streams.processor.internals.StoreChangelogReader.startRestoration(StoreChangelogReader.java:234)
   at org.apache.kafka.streams.processor.internals.StoreChangelogReader.initialize(StoreChangelogReader.java:185)
   at org.apache.kafka.streams.processor.internals.StoreChangelogReader.restore(StoreChangelogReader.java:81)
   at org.apache.kafka.streams.processor.internals.TaskManager.updateNewAndRestoringTasks(TaskManager.java:389)
   at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:769)
   at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:698)
   at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:671)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13277169">KAFKA-9355</key>
            <summary>RocksDB statistics are removed from JMX when EOS enabled and empty local state dir</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cadonna">Bruno Cadonna</assignee>
                                    <reporter username="savulchik">Stanislav Savulchik</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Jan 2020 09:36:56 +0000</created>
                <updated>Tue, 9 Mar 2021 09:12:05 +0000</updated>
                            <resolved>Wed, 12 Feb 2020 01:32:46 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>metrics</component>
                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17006722" author="savulchik" created="Thu, 2 Jan 2020 10:28:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt;&#160;could you please take a look at this case? Thanks in advance!&lt;/p&gt;</comment>
                            <comment id="17006983" author="bchen225242" created="Thu, 2 Jan 2020 17:45:17 +0000"  >&lt;p&gt;Thanks for the report. Does all RocksDB metrics vanish or some of them?&#160;&lt;/p&gt;</comment>
                            <comment id="17007238" author="savulchik" created="Fri, 3 Jan 2020 05:16:36 +0000"  >&lt;p&gt;All RocksDB metrics vanished for all restoring state stores that have non empty changelog topics.&#160;There are no stream-state-metrics MBeans for that state stores in JMX.&#160; &#160;&lt;/p&gt;

&lt;p&gt;I believe it happens due to&#160;StreamsMetricsImpl.removeAllStoreLevelSensors call before state store restoration and missing sensors reinitialization in&#160;RocksDBMetricsRecorder afterwards.&lt;/p&gt;</comment>
                            <comment id="17009469" author="cadonna" created="Tue, 7 Jan 2020 08:20:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=savulchik&quot; class=&quot;user-hover&quot; rel=&quot;savulchik&quot;&gt;savulchik&lt;/a&gt; Thank you for reporting this. I will take a look.&lt;/p&gt;</comment>
                            <comment id="17020731" author="githubbot" created="Wed, 22 Jan 2020 02:43:35 +0000"  >&lt;p&gt;cadonna commented on pull request #7996: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9355&quot; title=&quot;RocksDB statistics are removed from JMX when EOS enabled and empty local state dir&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9355&quot;&gt;&lt;del&gt;KAFKA-9355&lt;/del&gt;&lt;/a&gt;: Fix bug that removed RocksDB metrics after failure in EOS&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7996&lt;/a&gt;&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `init()` method to `RocksDBMetricsRecorder`&lt;/li&gt;
	&lt;li&gt;Added call to `init()` of `RocksDBMetricsRecorder` to `init()` of RocksDB store&lt;/li&gt;
	&lt;li&gt;Added call to `init()` of `RocksDBMetricsRecorder` to `openExisting()` of segmented state stores&lt;/li&gt;
	&lt;li&gt;Adapted unit tests&lt;/li&gt;
	&lt;li&gt;Added integration test that reproduces the situation in which the bug occurred&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17020733" author="cadonna" created="Wed, 22 Jan 2020 03:01:54 +0000"  >&lt;p&gt;The cause of the bug is the following. In EOS when the a task is not shutdown gracefully (i.e., no checkpoint found, which happens when the local state directory is wiped out), the state stores are reinitialized. During reinitialization all metrics on state store level are removed when the state store is closed on `Metered*Store` level. Afterwards when the store is initialised again the RocksDB metrics recorder does not know that the RocksDB metrics were removed by `Metered*Store` and does not reinitialize them. The above PR fixes this issue. &lt;/p&gt;</comment>
                            <comment id="17034963" author="githubbot" created="Wed, 12 Feb 2020 01:31:18 +0000"  >&lt;p&gt;guozhangwang commented on pull request #7996: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-9355&quot; title=&quot;RocksDB statistics are removed from JMX when EOS enabled and empty local state dir&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-9355&quot;&gt;&lt;del&gt;KAFKA-9355&lt;/del&gt;&lt;/a&gt;: Fix bug that removed RocksDB metrics after failure in EOS&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/7996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/7996&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13134530">KAFKA-6498</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12989809" name="metric-removal.log" size="1494322" author="savulchik" created="Thu, 2 Jan 2020 10:20:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0a4ow:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>