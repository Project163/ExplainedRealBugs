<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:40:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-17877] IllegalStateException: missing producer id from the WriteTxnMarkersResponse</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-17877</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: WriteTxnMarkerResponse &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; lkc-devcv9jg9n_transaction-bench-transaction-id-72UwIuNVQkOxl4y_OEBAlA does not contain expected error map &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; producer id 8308
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerRequestCompletionHandler.scala#L100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/transaction/TransactionMarkerRequestCompletionHandler.scala#L100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;------&lt;/p&gt;

&lt;p&gt;It is a data partition side bug. The leader may return the response early without all the producer ID included in the response.&lt;/p&gt;

&lt;p&gt;Consider the following 2 cases:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We have 2 markers to append, one for producer-0, one for producer-1&lt;/li&gt;
	&lt;li&gt;When we first process producer-0, it appends a marker to the __consumer_offset.&lt;/li&gt;
	&lt;li&gt;The __consumer_offset append finishes very fast because the group coordinator is no longer the leader. So the coordinator directly returns NOT_LEADER_OR_FOLLOWER. In its callback, it calls the&#160;&lt;tt&gt;maybeComplete()&lt;/tt&gt;&#160;for the first time, and because there is only one partition to append, it is able to go further to call&#160;&lt;tt&gt;maybeSendResponseCallback()&lt;/tt&gt;&#160;and decrement&#160;&lt;tt&gt;numAppends&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Then it calls the replica manager append for nothing, in the callback, it calls the&#160;&lt;tt&gt;maybeComplete()&lt;/tt&gt;&#160;for the second time. This time, it also decrements&#160;&lt;tt&gt;numAppends&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We have 2 markers to append, one for producer-0, one for producer-1&lt;/li&gt;
	&lt;li&gt;When we first process producer-0, it appends a marker to the __consumer_offset and a data topic foo.&lt;/li&gt;
	&lt;li&gt;The 2 appends will be handled by group coordinator and replica manager asynchronously.&lt;/li&gt;
	&lt;li&gt;It can be a race that, both appends finishes together, then they can fill the&#160;&lt;tt&gt;markerResults&lt;/tt&gt;&#160;at the same time, then call the&#160;&lt;tt&gt;maybeComplete&lt;/tt&gt;. Because the&#160;&lt;tt&gt;partitionsWithCompatibleMessageFormat.size == markerResults.size&lt;/tt&gt;&#160;condition is satisfied, both&#160;&lt;tt&gt;maybeComplete&lt;/tt&gt;&#160;calls can go through to decrement the&#160;&lt;tt&gt;numAppends&lt;/tt&gt;&#160;and cause a premature response.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Remember, because we only have 2 markers, the initial value for&#160;&lt;tt&gt;numAppends&lt;/tt&gt;&#160;is also 2. So in step 4, it is able to finish the request without even processing producer-1. This will cause the producer-1 missing from the WriteTxnMarkers response.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;As a result, the txn coordinator will not update the txn state correctly though the markers may have been written in the data partitions. There is an impact on the clients. the client believes the txn is completed but when it tries to send any request for the new transaction with the same transaction ID, the request will fail with CONCURRENT_TRANSACTIONS.&#160;&lt;/p&gt;

&lt;p&gt;Note, this can only happen with the KIP-848 coordinator enabled.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13596765">KAFKA-17877</key>
            <summary>IllegalStateException: missing producer id from the WriteTxnMarkersResponse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="calvinliu">Calvin Liu</assignee>
                                    <reporter username="calvinliu">Calvin Liu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Oct 2024 17:49:43 +0000</created>
                <updated>Tue, 5 Nov 2024 10:06:48 +0000</updated>
                            <resolved>Tue, 5 Nov 2024 10:06:48 +0000</resolved>
                                                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1s7sg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>