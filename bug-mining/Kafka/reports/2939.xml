<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:27:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-12508] Emit-on-change tables may lose updates on error or restart in at_least_once</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-12508</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-557%3A+Add+emit+on+change+support+for+Kafka+Streams&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-557&lt;/a&gt; added emit-on-change semantics to KTables that suppress updates for duplicate values.&lt;/p&gt;

&lt;p&gt;However, this may cause data loss in at_least_once topologies when records are retried from the last commit due to an error / restart / etc.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Consider the following example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
streams.table(source, materialized)
.toStream()
.map(mayThrow())
.to(output)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Record A gets read&lt;/li&gt;
	&lt;li&gt;Record A is stored in the table&lt;/li&gt;
	&lt;li&gt;The update for record A is forwarded through the topology&lt;/li&gt;
	&lt;li&gt;Map() throws (or alternatively, any restart while the forwarded update was still being processed and not yet produced to the output topic)&lt;/li&gt;
	&lt;li&gt;The stream is restarted and &quot;retries&quot; from the last commit&lt;/li&gt;
	&lt;li&gt;Record A gets read again&lt;/li&gt;
	&lt;li&gt;The table will discard the update for record A because
	&lt;ol&gt;
		&lt;li&gt;The value is the same&lt;/li&gt;
		&lt;li&gt;The timestamp is the same&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Eventually the stream will commit&lt;/li&gt;
	&lt;li&gt;There is absolutely no output for Record A even though we&apos;re running in at_least_once&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This behaviour does not seem intentional. &lt;a href=&quot;https://github.com/apache/kafka/blob/367eca083b44261d4e5fa8aa61b7990a8b35f8b0/streams/src/main/java/org/apache/kafka/streams/state/internals/ValueAndTimestampSerializer.java#L50&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;The emit-on-change logic explicitly forwards records that have the same value and an older timestamp.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This logic should probably be changed to also forward updates that have an older&#160;&lt;b&gt;or equal&lt;/b&gt; timestamp.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13366247">KAFKA-12508</key>
            <summary>Emit-on-change tables may lose updates on error or restart in at_least_once</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vvcephei">John Roesler</assignee>
                                    <reporter username="nhab">Nico Habermann</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Mar 2021 05:06:36 +0000</created>
                <updated>Mon, 17 May 2021 21:41:42 +0000</updated>
                            <resolved>Thu, 25 Mar 2021 23:10:52 +0000</resolved>
                                    <version>2.6.0</version>
                    <version>2.6.1</version>
                    <version>2.7.0</version>
                                    <fixVersion>2.6.2</fixVersion>
                    <fixVersion>2.7.1</fixVersion>
                    <fixVersion>2.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17304894" author="cadonna" created="Fri, 19 Mar 2021 13:25:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nhab&quot; class=&quot;user-hover&quot; rel=&quot;nhab&quot;&gt;nhab&lt;/a&gt; Thank you for the bug report. I could reproduce the bug and it indeed leads to data loss as you described. I will open an bug fix PR shortly.&lt;/p&gt;</comment>
                            <comment id="17304915" author="cadonna" created="Fri, 19 Mar 2021 13:49:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ableegoldman&quot; class=&quot;user-hover&quot; rel=&quot;ableegoldman&quot;&gt;ableegoldman&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vvcephei&quot; class=&quot;user-hover&quot; rel=&quot;vvcephei&quot;&gt;vvcephei&lt;/a&gt;, I set this bug as a blocker for the ongoing releases since it might lead to data loss (i.e., it breaks at-least-once and exactly-once processing guarantees) and emit-on-change cannot be switched off. Feel free to set it back to major, if you think it is not a blocker. &lt;/p&gt;</comment>
                            <comment id="17304924" author="nhab" created="Fri, 19 Mar 2021 13:57:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cadonna&quot; class=&quot;user-hover&quot; rel=&quot;cadonna&quot;&gt;cadonna&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for the quick feedback!&lt;/p&gt;

&lt;p&gt;To clarify, exactly_once should not be affected by this, since EOS would also revert the table-state, so the record wouldn&apos;t be classified as duplicate record and dropped&lt;/p&gt;</comment>
                            <comment id="17304925" author="cadonna" created="Fri, 19 Mar 2021 13:59:51 +0000"  >&lt;p&gt;You are right! My bad!&lt;/p&gt;</comment>
                            <comment id="17306323" author="cmaus" created="Mon, 22 Mar 2021 16:08:09 +0000"  >&lt;p&gt;I&apos;m wondering if emit-on-change tables can be safely used with compacted input topics and at-least-once semantics.&lt;/p&gt;

&lt;p&gt;Given the following records in the input topic:&lt;br/&gt;
timestamp, key, value&lt;/p&gt;

&lt;p&gt;1, 1, 1&lt;br/&gt;
2, 1, 1&lt;br/&gt;
3, 1, 1&lt;/p&gt;


&lt;p&gt;The records with ts 1 and two are read, an exception occurs, causing a restart.&lt;/p&gt;

&lt;p&gt;During restart of the consuming process, log compaction removes the records with ts 1 and two, leaving only the record with ts 3 in the input topic.&lt;/p&gt;

&lt;p&gt;When the topic is consumed, we will only see a record with ts 3, which is greater than the greatest ts seen for the key.&lt;br/&gt;
As the value is the same as stored in the table, the output will be suppressed.&lt;/p&gt;

&lt;p&gt;Is there a flaw in my thinking or is this a plausible scenario?&lt;/p&gt;</comment>
                            <comment id="17308063" author="vvcephei" created="Wed, 24 Mar 2021 17:51:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmaus&quot; class=&quot;user-hover&quot; rel=&quot;cmaus&quot;&gt;cmaus&lt;/a&gt; , I think you&apos;re right.&lt;/p&gt;

&lt;p&gt;Since this feature is purely an optimization, and since it doesn&apos;t seem like we&apos;re going to be able to patch it up to avoid these data loss conditions, I&apos;m just going to disable it entirely.&lt;/p&gt;

&lt;p&gt;I&apos;m confident that we can re-introduce it later and avoid these edge cases, but for now I&apos;d like to err on the side of correctness.&lt;/p&gt;</comment>
                            <comment id="17309034" author="vvcephei" created="Thu, 25 Mar 2021 23:10:52 +0000"  >&lt;p&gt;Disabled KIP-557 entirely.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13315717">KAFKA-10248</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13249691">KAFKA-8770</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0oyo8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>