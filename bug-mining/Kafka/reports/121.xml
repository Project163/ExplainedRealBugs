<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:36:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-567] Replication Data Loss in Mirror Maker Bouncing testcase</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-567</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;Test Description:&lt;br/&gt;
1. Start a 3-broker cluster as source&lt;br/&gt;
2. Start a 3-broker cluster as target&lt;br/&gt;
3. Start 1 instance of Mirror Maker to replicate data from source to target&lt;br/&gt;
4. While producer is sending data into source cluster, stop Mirror Maker with &quot;kill -15&quot;. Start Mirror Maker again after 1 second.&lt;br/&gt;
5. Start a consumer to consume data from target cluster.&lt;br/&gt;
6. Compare the MessageID in the data between producer log and consumer log.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;To reproduce this issue, please do the followings:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1. Download the latest 0.8 branch&lt;br/&gt;
2. Apply the patch attached to this JIRA&lt;br/&gt;
3. Build kafka by running &quot;./sbt update package&quot;&lt;br/&gt;
4. Execute the test in directory &quot;system_test&quot; : &quot;python -B system_test_runner.py&quot;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The test result may look like the following:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;_test_case_name  :  testcase_5002&lt;br/&gt;
_test_class_name  :  MirrorMakerTest&lt;br/&gt;
arg : bounce_leader  :  false&lt;br/&gt;
arg : bounce_mirror_maker  :  true&lt;br/&gt;
arg : message_producing_free_time_sec  :  15&lt;br/&gt;
arg : num_iteration  :  1&lt;br/&gt;
arg : num_messages_to_produce_per_producer_call  :  50&lt;br/&gt;
arg : num_partition  :  1&lt;br/&gt;
arg : replica_factor  :  3&lt;br/&gt;
arg : sleep_seconds_between_producer_calls  :  1&lt;br/&gt;
validation_status  : &lt;br/&gt;
     Log segment checksum matching across all replicas  :  FAILED&lt;br/&gt;
     Unique messages from consumer on &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1&amp;#93;&lt;/span&gt;  :  355&lt;br/&gt;
     Unique messages from producer on &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1&amp;#93;&lt;/span&gt;  :  400&lt;br/&gt;
     Validate for data matched on topic &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1&amp;#93;&lt;/span&gt;  :  FAILED&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Attached a tar file for the system test output log, the brokers&apos; log4j files and data log segment files.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;There are no unusual Exception / Error found in the logs. However, there are consistently data loss in this Mirror Maker bouncing test case. Not sure if this is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-552&quot; title=&quot;No error messages logged for those failing-to-send messages from Producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-552&quot;&gt;&lt;del&gt;KAFKA-552&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12611389">KAFKA-567</key>
            <summary>Replication Data Loss in Mirror Maker Bouncing testcase</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="jfung">John Fung</reporter>
                        <labels>
                            <label>bugs</label>
                    </labels>
                <created>Thu, 11 Oct 2012 17:08:07 +0000</created>
                <updated>Fri, 12 Oct 2012 20:35:24 +0000</updated>
                            <resolved>Fri, 12 Oct 2012 20:29:37 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13474428" author="junrao" created="Thu, 11 Oct 2012 18:54:08 +0000"  >&lt;p&gt;Took a quick look.&lt;/p&gt;

&lt;p&gt;Log in source broker:&lt;br/&gt;
system_test_1349971807_testcase_5002 jrao$ ls kafka_server_4_logs/test_1-0/*.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000000.log  kafka_server_4_logs/test_1-0/00000000000000000140.log  kafka_server_4_logs/test_1-0/00000000000000000280.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000020.log  kafka_server_4_logs/test_1-0/00000000000000000160.log  kafka_server_4_logs/test_1-0/00000000000000000300.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000040.log  kafka_server_4_logs/test_1-0/00000000000000000180.log  kafka_server_4_logs/test_1-0/00000000000000000320.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000060.log  kafka_server_4_logs/test_1-0/00000000000000000200.log  kafka_server_4_logs/test_1-0/00000000000000000340.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000080.log  kafka_server_4_logs/test_1-0/00000000000000000220.log  kafka_server_4_logs/test_1-0/00000000000000000360.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000100.log  kafka_server_4_logs/test_1-0/00000000000000000240.log  kafka_server_4_logs/test_1-0/00000000000000000380.log&lt;br/&gt;
kafka_server_4_logs/test_1-0/00000000000000000120.log  kafka_server_4_logs/test_1-0/00000000000000000260.log&lt;/p&gt;

&lt;p&gt;Log in target broker&lt;br/&gt;
system_test_1349971807_testcase_5002 jrao$ ls kafka_server_7_logs/test_1-0/*.log&lt;br/&gt;
kafka_server_7_logs/test_1-0/00000000000000000000.log  kafka_server_7_logs/test_1-0/00000000000000000185.log  kafka_server_7_logs/test_1-0/00000000000000000312.log&lt;br/&gt;
kafka_server_7_logs/test_1-0/00000000000000000100.log  kafka_server_7_logs/test_1-0/00000000000000000235.log&lt;br/&gt;
kafka_server_7_logs/test_1-0/00000000000000000155.log  kafka_server_7_logs/test_1-0/00000000000000000262.log&lt;/p&gt;

&lt;p&gt;It seems that the test didn&apos;t give mirror maker enough time to catch up data after bouncing. Could you change the test to wait a bit longer after bounce?&lt;/p&gt;</comment>
                            <comment id="13474435" author="nehanarkhede" created="Thu, 11 Oct 2012 18:59:36 +0000"  >&lt;p&gt;We should probably increase time outs after knowing why the test is running slower. Increasing timeouts can hide performance regressions.&lt;/p&gt;</comment>
                            <comment id="13474456" author="jfung" created="Thu, 11 Oct 2012 19:36:06 +0000"  >&lt;p&gt;Uploaded mirror_maker_12.log for a similar test but with the following changes:&lt;/p&gt;

&lt;p&gt;11. After Mirror Maker is bounced and wait 15 seconds, Producer (sending data in the source cluster) is stopped. Then wait for 60 seconds more to make sure that Mirror Maker is able to catch up.&lt;/p&gt;

&lt;p&gt;12. kafka.consumer.ConsumerIterator is configured to be at TRACE level in log4j.properties&lt;/p&gt;

&lt;p&gt;13. kafka.producer.Producer is also configured to be at TRACE level.&lt;/p&gt;

&lt;p&gt;14. The attached mirror maker log file shows that there are 400 messages each showing in the TRACE level messages which is matching the Producer data count but Target consumer is still missing some messages.&lt;/p&gt;</comment>
                            <comment id="13474794" author="junrao" created="Fri, 12 Oct 2012 04:52:10 +0000"  >&lt;p&gt;Attach a patch. The problem is that async producer didn&apos;t drain the last batch of events on close, a bug introduced during producer refactoring. Now, the test has no data loss.&lt;/p&gt;</comment>
                            <comment id="13475094" author="jfung" created="Fri, 12 Oct 2012 15:51:03 +0000"  >&lt;p&gt;Thanks Jun for the patch. The fix is tested with the latest 0.8 branch (r.1397616) by apply both your patch and the patch to reproduce the issue. The following is the test result: (Please ignore the checksum validating failure for the time being)&lt;/p&gt;

&lt;p&gt;_test_case_name  :  testcase_5002&lt;br/&gt;
_test_class_name  :  MirrorMakerTest&lt;br/&gt;
arg : bounce_leader  :  false&lt;br/&gt;
arg : bounce_mirror_maker  :  true&lt;br/&gt;
arg : message_producing_free_time_sec  :  15&lt;br/&gt;
arg : num_iteration  :  1&lt;br/&gt;
arg : num_messages_to_produce_per_producer_call  :  50&lt;br/&gt;
arg : num_partition  :  1&lt;br/&gt;
arg : replica_factor  :  3&lt;br/&gt;
arg : sleep_seconds_between_producer_calls  :  1&lt;br/&gt;
validation_status  : &lt;br/&gt;
     Log segment checksum matching across all replicas  :  FAILED&lt;br/&gt;
     Unique messages from consumer on &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1&amp;#93;&lt;/span&gt;  :  400&lt;br/&gt;
     Unique messages from producer on &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1&amp;#93;&lt;/span&gt;  :  400&lt;br/&gt;
     Validate for data matched on topic &lt;span class=&quot;error&quot;&gt;&amp;#91;test_1&amp;#93;&lt;/span&gt;  :  PASSED&lt;/p&gt;</comment>
                            <comment id="13475126" author="jjkoshy" created="Fri, 12 Oct 2012 16:34:22 +0000"  >&lt;p&gt;+1 for kafka-567.patch&lt;/p&gt;

&lt;p&gt;Also, right now mirror maker does not always shutdown cleanly. E.g., if you want to use consumer.timeout.ms (and avoid having to do an external wait for mirroring to finish). John, I&apos;ll attach a patch for that as well if it helps the testing framework.&lt;/p&gt;</comment>
                            <comment id="13475153" author="nehanarkhede" created="Fri, 12 Oct 2012 16:57:26 +0000"  >&lt;p&gt;+1 on &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-567&quot; title=&quot;Replication Data Loss in Mirror Maker Bouncing testcase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-567&quot;&gt;&lt;del&gt;KAFKA-567&lt;/del&gt;&lt;/a&gt;.patch, good catch !&lt;/p&gt;</comment>
                            <comment id="13475320" author="junrao" created="Fri, 12 Oct 2012 20:29:37 +0000"  >&lt;p&gt;Thanks for the reviews. Committed to 0.8.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548913" name="KAFKA-567-mirrormakershutdown-v1.patch" size="2412" author="jjkoshy" created="Fri, 12 Oct 2012 16:35:47 +0000"/>
                            <attachment id="12548853" name="kafka-567.patch" size="643" author="junrao" created="Fri, 12 Oct 2012 04:52:10 +0000"/>
                            <attachment id="12548773" name="kafka-mirror-maker-bouncing-data-loss.patch" size="18325" author="jfung" created="Thu, 11 Oct 2012 17:08:46 +0000"/>
                            <attachment id="12548793" name="mirror_maker_12.log" size="224446" author="jfung" created="Thu, 11 Oct 2012 19:31:09 +0000"/>
                            <attachment id="12548774" name="system_test_1349971807_testcase_5002.tar" size="2109440" author="jfung" created="Thu, 11 Oct 2012 17:09:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>247721</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 6 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i08pcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>48705</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>