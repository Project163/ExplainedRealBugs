<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:43:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19354] KRaft observer unable to recover after re-bootstrapping to follower</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19354</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://lists.apache.org/thread/ws3390khsxhdg2b8cnv2mzv8slz5xq7q&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Original dev mail thread&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If an observer&apos;s FETCH request to the quorum leader experiences a failure/timeout, it is possible that when it re-bootstraps, it will connect to a follower node (random selection). Subsequently, the observer node will continually send FETCH requests to that follower, and in receive a response with a &quot;partitionError&quot; errorCode=6 (NOT_LEADER_OR_FOLLOWER), which does not trigger a re-bootstrap.&lt;br/&gt;
Thus, the observer will be stuck sending FETCH requests to the follower instead of the leader, halting metadata replication and causing it to fall out of sync.&lt;/p&gt;

&lt;p&gt;To recover from this state, re-bootstrapping would need to occur by restarting the affected observer or follower, until it connects to the correct leader.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to reproduce:&lt;/b&gt;&lt;br/&gt;
1. Spin up Kafka cluster with 3 or 5 controllers. (ideally 5 to increase likelihood of bootstrapping to a follower instead of the leader)&lt;br/&gt;
2. Enable a network delay on a particular observer broker (e.g. `tc qdisc add dev eth0 root netem delay 2500ms`). I picked 2500ms since default timeout is 2s for `controller.quorum.fetch.timeout.ms`/`controller.quorum.request.timeout.ms`. After a few seconds, disable the network delay (e.g. `tc qdisc del dev eth0 root netem`).&lt;br/&gt;
3. The observer node will re-bootstrap, potentially to a follower instead of the leader. If so, the observer will continuously send fetch requests to the follower node, receive `NOT_LEADER_OR_FOLLOWER` in response, and will no longer replicate metadata.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Debug logs demonstrating this scenario:&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://gist.github.com/justin-chen/1f3eee79d9a5066a467818a0b1bc006f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/justin-chen/1f3eee79d9a5066a467818a0b1bc006f&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;kraftcontroller-3 (leader), kraftcontroller-4 (follower), kafka-0 (observer)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13619705">KAFKA-19354</key>
            <summary>KRaft observer unable to recover after re-bootstrapping to follower</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alyssahuang">Alyssa Huang</assignee>
                                    <reporter username="justin-chen">Justin Chen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 May 2025 17:59:08 +0000</created>
                <updated>Sat, 11 Oct 2025 15:49:51 +0000</updated>
                            <resolved>Mon, 28 Jul 2025 17:07:02 +0000</resolved>
                                    <version>3.9.1</version>
                    <version>4.0.0</version>
                                    <fixVersion>4.2.0</fixVersion>
                                    <component>kraft</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17955322" author="alyssahuang" created="Fri, 30 May 2025 21:41:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/19854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/19854&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17955720" author="jsancio" created="Mon, 2 Jun 2025 16:59:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alyssahuang&quot; class=&quot;user-hover&quot; rel=&quot;alyssahuang&quot;&gt;alyssahuang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=justin-chen&quot; class=&quot;user-hover&quot; rel=&quot;justin-chen&quot;&gt;justin-chen&lt;/a&gt; I think part of the issue is that the default fetch and request timeouts are the same, 2 seconds.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=justin-chen&quot; class=&quot;user-hover&quot; rel=&quot;justin-chen&quot;&gt;justin-chen&lt;/a&gt; are you able to reproduce this issue if you sent the request timeout to 1 second for example: controller.quorum.request.timeout.ms=1000&lt;/p&gt;</comment>
                            <comment id="17955941" author="JIRAUSER305053" created="Tue, 3 Jun 2025 16:21:45 +0000"  >&lt;p&gt;Hi Jos&#233;, I was able to reproduce the issue with a differing request timeout (controller.quorum.fetch.timeout.ms=2000, controller.quorum.request.timeout.ms=1000)&lt;br/&gt;
Logs attached here: &lt;a href=&quot;https://gist.github.com/justin-chen/a7deade5b0ab17b33d64ec07cd2542ab&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/justin-chen/a7deade5b0ab17b33d64ec07cd2542ab&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17955957" author="alyssahuang" created="Tue, 3 Jun 2025 17:58:22 +0000"  >&lt;p&gt;Hey Justin, I believe what Jos&#233; is saying that this can increase the likelihood of hitting this bug, but won&apos;t prevent it entirely. If you simulate the network delay you can certainly continue to see the issue.&#160;&lt;/p&gt;</comment>
                            <comment id="17956078" author="jsancio" created="Wed, 4 Jun 2025 11:11:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=justin-chen&quot; class=&quot;user-hover&quot; rel=&quot;justin-chen&quot;&gt;justin-chen&lt;/a&gt;, I should have provided more details. Can you make your network delay a value between the controller.quorum.fetch.timeout.ms and controller.quorum.request.timeout.m? For example, if the fetch timeout is 2000ms and the request timeout is 1000 ms, you can make the delay 1500ms.&lt;/p&gt;</comment>
                            <comment id="17956147" author="JIRAUSER305053" created="Wed, 4 Jun 2025 16:18:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jsancio&quot; class=&quot;user-hover&quot; rel=&quot;jsancio&quot;&gt;jsancio&lt;/a&gt; Re-ran the test with a network delay of 1500ms instead of 2500ms and fetch timeout as 2000ms and request timeout as 1000ms. Was able to re-produce the observer (kafka-0) getting stuck fetching from follower node (7003) instead of the leader (7002).&lt;/p&gt;

&lt;p&gt;Observer node logs: &lt;a href=&quot;https://gist.github.com/justin-chen/717f8fb1c066a72d3ef443f945583a9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/justin-chen/717f8fb1c066a72d3ef443f945583a9c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17956166" author="jsancio" created="Wed, 4 Jun 2025 17:22:10 +0000"  >&lt;p&gt;Okay. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w4hs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>