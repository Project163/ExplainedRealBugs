<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:25:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-8334] Occasional OffsetCommit Timeout</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-8334</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;1%29IssueSummary&quot;&gt;&lt;/a&gt;1) Issue Summary&lt;/h2&gt;
&lt;p&gt;Since we have upgraded to 1.1, we have observed occasional&#160;OffsetCommit timeouts from clients&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Offset commit failed on partition sometopic-somepartition at offset someoffset: The request timed out&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Normally OffsetCommit completes within 10ms but when we check the 99.9 percentile, we see the request duration time jumps up to 5000 ms (offsets.commit.timeout.ms)&lt;/p&gt;

&lt;p&gt;Here is a screenshot of prometheus recording kafka_network_request_duration_milliseconds&lt;br/&gt;
(offsetcommit_p99.9_cut.jpg)&lt;br/&gt;
and after checking the duration breakdown, most of the time was spent on &quot;Remote&quot; Scope&lt;/p&gt;

&lt;p&gt;(Below is a request log line produced by inhouse slow request logger&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2019-04-16 13:06:20,339] WARN Slow response:RequestHeader(apiKey=OFFSET_COMMIT, apiVersion=2, clientId=kafka-python-1.4.6, correlationId=953) -- {group_id=wilson-tester,generation_id=28,member_id=kafka-python-1.4.6-69ed979d-a069-4c6d-9862-e4fc34883269,retention_time=-1,topics=[{topic=test,partitions=[{partition=2,offset=63456,metadata=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}]}]} from connection;totalTime:5001.942000,requestQueueTime:0.030000,localTime:0.574000,remoteTime:5001.173000,responseQueueTime:0.058000,sendTime:0.053000,securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.request.logger)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h2&gt;&lt;a name=&quot;2%29Whatgotchangedin1.1from0.10.2.1%3F&quot;&gt;&lt;/a&gt;2) What got changed in 1.1 from 0.10.2.1?&lt;/h2&gt;

&lt;ol&gt;
	&lt;li&gt;Log Level Changed&lt;br/&gt;
In 1.1 Kafka Consumer, logging about timed out OffsetCommit is changed from DEBUG to WARN&lt;/li&gt;
	&lt;li&gt;Group Lock is acquired when trying to complete DelayedProduce of OffsetCommit&lt;br/&gt;
This was added after 0.11.0.2&lt;br/&gt;
(Ticket: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6042&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-6042&lt;/a&gt;)&lt;br/&gt;
(PR: &lt;a href=&quot;https://github.com/apache/kafka/pull/4103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4103&lt;/a&gt;)&lt;br/&gt;
(in 1.1 &lt;a href=&quot;https://github.com/apache/kafka/blob/1.1/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/1.1/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L292&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Followers do incremental fetch&lt;br/&gt;
&lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-227%3A+Introduce+Incremental+FetchRequests+to+Increase+Partition+Scalability&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-227%3A+Introduce+Incremental+FetchRequests+to+Increase+Partition+Scalability&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;h2&gt;&lt;a name=&quot;3%29InteractionbetweenOffsetCommit%2CDelayedProduceandFetchFollower&quot;&gt;&lt;/a&gt;3) Interaction between OffsetCommit, DelayedProduce and FetchFollower&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;OffsetCommit append a message of committed offset to partition of topic `__consumer_offsets`&lt;/p&gt;

&lt;p&gt;During the append, it would create a DelayedProduce with lock to GroupMetadata.lock (ReentrantLock) and add to delayedProducePurgatory&lt;/p&gt;

&lt;p&gt;When follower fetches the partition of topic `__consumer_offsets` and causes an increase in HighWaterMark, delayedProducePurgatory would be transversed and all operations related to the partition may be completed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;b&gt;DelayedProduce from OffsetCommit may not be completed, if the group metadata lock was held by others&lt;/b&gt;&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;4%29Reproduce&quot;&gt;&lt;/a&gt;4) Reproduce&lt;/h2&gt;
&lt;h4&gt;&lt;a name=&quot;Methodology&quot;&gt;&lt;/a&gt;Methodology&lt;/h4&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1. DelayedProduce on __consumer_offsets could not be completed &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the group.lock is acquired by others
2. We spam requests like Heartbeat to keep acquiring group.lock
3. We keep sending OffsetCommit and check the processing time
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;ReproduceScript&quot;&gt;&lt;/a&gt;Reproduce Script&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://gist.github.com/windkit/3384bb86dc146111d1e0857e66b85861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/windkit/3384bb86dc146111d1e0857e66b85861&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;jammer.py - join the group &quot;wilson-tester&quot; and keep spamming Heartbeat&lt;/li&gt;
	&lt;li&gt;tester.py - fetch one message and do a long processing (or sleep) and then commit the offset&lt;/li&gt;
&lt;/ol&gt;


&lt;h4&gt;&lt;a name=&quot;Result&quot;&gt;&lt;/a&gt;Result&lt;/h4&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Seq&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Operation&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Lock&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OffsetCommit Request&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Append to local __consumer_offsets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DelayedProduce tryComplete&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Added into delayedProducePurgatory&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;FetchFollower1 Fetch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;FetchFollower2 Fetch&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Heartbeat Request&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Acquired group.lock&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;FetchFollower2 maybeTryComplete DelayedProduce&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Failed to acquire group.lock&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Heartbeat Response&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Released group.lock&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;(NO FetchFollower Requests on the partitions __consumer_offsets)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OffsetCommit Response (Timeout)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;h4&gt;&lt;a name=&quot;TraceLog&quot;&gt;&lt;/a&gt;Trace Log&lt;/h4&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// The OffsetCommit Request
&lt;/span&gt;[2019-04-15 23:59:53,736] TRACE [KafkaApi-1] Handling request:RequestHeader(apiKey=OFFSET_COMMIT, apiVersion=2, clientId=kafka-python-1.4.6, correlationId=2114) -- {group_id=wilson-tester,generation_id=20,member_id=kafka-python-1.4.6-60008b58-4d6a-4cfd-948f-dd9e19e7f981,retention_time=-1,topics=[{topic=test,partitions=[{partition=2,offset=22654,metadata=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}]}]} from connection;securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.server.KafkaApis)
 
&lt;span class=&quot;code-comment&quot;&gt;// Initial Check of DelayedProduce:tryCompleteElseWatch
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// https://github.com/apache/kafka/blob/1.1/core/src/main/scala/kafka/server/DelayedOperation.scala#L217
&lt;/span&gt;[2019-04-15 23:59:53,736] TRACE Initial partition status &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; __consumer_offsets-48 is [acksPending: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, error: 7, startOffset: 23134, requiredOffset: 23135] (kafka.server.DelayedProduce)
[2019-04-15 23:59:53,736] TRACE Checking produce satisfaction &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; __consumer_offsets-48, current status [acksPending: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, error: 7, startOffset: 23134, requiredOffset: 23135] (kafka.server.DelayedProduce)
[2019-04-15 23:59:53,736] TRACE Checking produce satisfaction &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; __consumer_offsets-48, current status [acksPending: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, error: 7, startOffset: 23134, requiredOffset: 23135] (kafka.server.DelayedProduce)
 
&lt;span class=&quot;code-comment&quot;&gt;// Follower fetching the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; message in __consumer_offsets-48, and with Heartbeat in between
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// DelayedOperation:maybeTryComplete leaves the DelayedProduce unchecked when it cannot obtain the lock (group.lock)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// https://github.com/apache/kafka/blob/1.1/core/src/main/scala/kafka/server/DelayedOperation.scala#L371
&lt;/span&gt;[2019-04-15 23:59:53,737] TRACE [KafkaApi-1] Sending heartbeat response org.apache.kafka.common.requests.HeartbeatResponse@4388ce00 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; correlation id 1492702 to client kafka-python-1.4.6. (kafka.server.KafkaApis)
[2019-04-15 23:59:53,737] TRACE [KafkaApi-1] Handling request:RequestHeader(apiKey=HEARTBEAT, apiVersion=1, clientId=kafka-python-1.4.6, correlationId=1492703) -- {group_id=wilson-tester,generation_id=20,member_id=kafka-python-1.4.6-4910b677-ecf2-4d1e-9fd0-a705aa37e0a6} from connection;securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.server.KafkaApis)
[2019-04-15 23:59:53,737] TRACE [KafkaApi-1] Sending heartbeat response org.apache.kafka.common.requests.HeartbeatResponse@96e1b92 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; correlation id 1492703 to client kafka-python-1.4.6. (kafka.server.KafkaApis)
[2019-04-15 23:59:53,737] TRACE [KafkaApi-1] Handling request:RequestHeader(apiKey=FETCH, apiVersion=7, clientId=broker-5-fetcher-0, correlationId=1788883) -- {replica_id=5,max_wait_time=500,min_bytes=1,max_bytes=10485760,isolation_level=0,session_id=357018451,epoch=1788882,topics=[{topic=__consumer_offsets,partitions=[{partition=48,fetch_offset=23135,log_start_offset=0,max_bytes=1048576}]}],forgetten_topics_data=[]} from connection;securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.server.KafkaApis)
[2019-04-15 23:59:53,737] TRACE [KafkaApi-1] Handling request:RequestHeader(apiKey=HEARTBEAT, apiVersion=1, clientId=kafka-python-1.4.6, correlationId=1492704) -- {group_id=wilson-tester,generation_id=20,member_id=kafka-python-1.4.6-4910b677-ecf2-4d1e-9fd0-a705aa37e0a6} from connection;securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.server.KafkaApis)
[2019-04-15 23:59:53,737] TRACE [KafkaApi-1] Sending heartbeat response org.apache.kafka.common.requests.HeartbeatResponse@6cb7676f &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; correlation id 1492704 to client kafka-python-1.4.6. (kafka.server.KafkaApis)
[2019-04-15 23:59:53,738] TRACE [KafkaApi-1] Handling request:RequestHeader(apiKey=HEARTBEAT, apiVersion=1, clientId=kafka-python-1.4.6, correlationId=1492705) -- {group_id=wilson-tester,generation_id=20,member_id=kafka-python-1.4.6-4910b677-ecf2-4d1e-9fd0-a705aa37e0a6} from connection;securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.server.KafkaApis)
[2019-04-15 23:59:53,738] TRACE [KafkaApi-1] Handling request:RequestHeader(apiKey=FETCH, apiVersion=7, clientId=broker-4-fetcher-0, correlationId=1788529) -- {replica_id=4,max_wait_time=500,min_bytes=1,max_bytes=10485760,isolation_level=0,session_id=1188767819,epoch=1788528,topics=[{topic=__consumer_offsets,partitions=[{partition=48,fetch_offset=23135,log_start_offset=0,max_bytes=1048576}]}],forgetten_topics_data=[]} from connection;securityProtocol:PLAINTEXT,principal:User:ANONYMOUS (kafka.server.KafkaApis)
[2019-04-15 23:59:53,738] TRACE [KafkaApi-1] Sending heartbeat response org.apache.kafka.common.requests.HeartbeatResponse@5552d3ab &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; correlation id 1492705 to client kafka-python-1.4.6. (kafka.server.KafkaApis)
 
&lt;span class=&quot;code-comment&quot;&gt;// OffsetCommit Timed out
&lt;/span&gt;[2019-04-15 23:59:58,737] DEBUG [KafkaApi-1] Offset commit request with correlation id 2114 from client kafka-python-1.4.6 on partition test-2 failed due to org.apache.kafka.common.errors.TimeoutException (kafka.server.KafkaApis)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;OffsetCommit%2CFetcherFollower%2CHeartBeat&quot;&gt;&lt;/a&gt;OffsetCommit, FetcherFollower, HeartBeat&lt;/h4&gt;
&lt;p&gt;When a FetchFollower comes and updates the HighWaterMark, it supposes to complete the DelayedProduce and so the OffsetCommit request.&lt;br/&gt;
However, it would only do it when it can obtain the GroupMetaDataLock (retry only once and immediately...)&lt;br/&gt;
As a result, the DelayedProduce would only be checked next time when FetchFollower comes (and updates the HighWaterMark).&lt;br/&gt;
Which usually means the next OffsetCommit, this explains why we observe OffsetCommit request timed out (high OffsetCommit latency) during low traffic time.&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;OffsetCommit&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;FetcherFollower&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;HeartBeat&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; replicaManager.appendRecords &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; delayedProducePurgatory.tryCompleteElseWatch &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; tryComplete() &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; watchForOperation() &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; operation.maybeTryComplete() &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; partition.updateReplicaLogReadResult &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; tryCompleteDelayedRequests &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; delayedProducePurgatory.checkAndComplete &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; watchers.tryCompleteWatched &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; operation.maybeTryComplete() &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; group.lock&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; group.tryLock &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#8594; false &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; group.unlock&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;h2&gt;&lt;a name=&quot;5%29Solution&quot;&gt;&lt;/a&gt;5) Solution&lt;/h2&gt;
&lt;p&gt;We can have a separate executor to later retry completing DelayedOperation which failed to obtain lock&lt;/p&gt;</description>
                <environment></environment>
        <key id="13232161">KAFKA-8334</key>
            <summary>Occasional OffsetCommit Timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chia7712">Chia-Ping Tsai</assignee>
                                    <reporter username="windkithk">windkithk</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 May 2019 05:49:23 +0000</created>
                <updated>Mon, 23 Dec 2024 03:37:00 +0000</updated>
                            <resolved>Wed, 9 Sep 2020 21:45:31 +0000</resolved>
                                    <version>1.1.1</version>
                    <version>2.0.0</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                    <version>2.3.0</version>
                    <version>2.4.0</version>
                    <version>2.5.0</version>
                    <version>2.6.0</version>
                                    <fixVersion>2.7.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>20</watches>
                                                                                                                <comments>
                            <comment id="16861023" author="githubbot" created="Tue, 11 Jun 2019 13:14:03 +0000"  >&lt;p&gt;windkit commented on pull request #6915: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8334&quot; title=&quot;Occasional OffsetCommit Timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-8334&quot;&gt;&lt;del&gt;KAFKA-8334&lt;/del&gt;&lt;/a&gt; Executor to retry delayed operations failed to obtain lock&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/6915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/6915&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   *&lt;b&gt;ASF&lt;/b&gt;*: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-8334&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-8334&lt;/a&gt;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Brief Summary:&lt;br/&gt;
   We have seen `OffsetCommit` timed out when we do manual offset commit with low traffic.&lt;br/&gt;
   When we append the offset commit to the topic `__consumer_offsets`, the `DelayedProduce` would need to obtain the group metadata in order to complete.&lt;br/&gt;
   If the group metadata is obtained by others (such as `HeartBeat`), it would fail and it would only be retried when there is a next `OffsetCommit`&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Reproduce
			&lt;ol&gt;
				&lt;li&gt;Methodology&lt;br/&gt;
   1. DelayedProduce on __consumer_offsets could not be completed if the group.lock is acquired by others&lt;br/&gt;
   2. We spam requests like Heartbeat to keep acquiring group.lock&lt;br/&gt;
   3. We keep sending OffsetCommit and check the processing time&lt;/li&gt;
			&lt;/ol&gt;
			&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;
			&lt;ol&gt;
				&lt;li&gt;Reproduce Script&lt;br/&gt;
   &lt;a href=&quot;https://gist.github.com/windkit/3384bb86dc146111d1e0857e66b85861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/windkit/3384bb86dc146111d1e0857e66b85861&lt;/a&gt;&lt;/li&gt;
			&lt;/ol&gt;
			&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;jammer.py - join the group &quot;wilson-tester&quot; and keep spamming Heartbeat&lt;/li&gt;
	&lt;li&gt;tester.py - fetch one message and do a long processing (or sleep) and then commit the offset&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on to GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="17026030" author="lothar" created="Wed, 29 Jan 2020 16:48:18 +0000"  >&lt;p&gt;Hi @windkithk, we also hit this issue. with patch installed, this error still exists. do u have any other suggestion? thank u for help.&lt;/p&gt;</comment>
                            <comment id="17026441" author="windkithk" created="Thu, 30 Jan 2020 05:51:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lothar&quot; class=&quot;user-hover&quot; rel=&quot;Lothar&quot;&gt;Lothar&lt;/a&gt; &lt;br/&gt;
We observed the issue in 1.1.1, are you using the same version?&lt;br/&gt;
And we only observed the issue with low traffic topic such that consumer was idle for more than 5 seconds so no further OffsetCommit, does your use case also have this pattern?&lt;/p&gt;</comment>
                            <comment id="17027501" author="lothar" created="Fri, 31 Jan 2020 13:43:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=windkithk&quot; class=&quot;user-hover&quot; rel=&quot;windkithk&quot;&gt;windkithk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for your reply. Our version is 1.1.0. we got this error more frequently while consumer group rebalancing. i think the patch can reduce the probability of error. and we are looking for some way which can solve this issue thoroughly, but have no specific idea now...&lt;/p&gt;</comment>
                            <comment id="17027613" author="bchen225242" created="Fri, 31 Jan 2020 16:01:06 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=windkithk&quot; class=&quot;user-hover&quot; rel=&quot;windkithk&quot;&gt;windkithk&lt;/a&gt;, one thing I&apos;m interested is how we configure:&lt;br/&gt;
1. different timeouts for requests here, especially for offset commit request&lt;/p&gt;

&lt;p&gt;2. heartbeat interval for clients, and how many clients there are&lt;/p&gt;

&lt;p&gt;3. The follower fetch interval&lt;/p&gt;

&lt;p&gt;Basically I have doubt as these numbers may not add up correctly, for example if we have a reasonable commit timeout, the follower fetch interval should be much smaller (correct me if wrong) which will trigger another group lock check soon.&lt;/p&gt;</comment>
                            <comment id="17027624" author="windkithk" created="Fri, 31 Jan 2020 16:17:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt;&lt;br/&gt;
Thanks for your interest, let me try to answer your questions.&lt;br/&gt;
1. If I remember correctly, we encountered the issue with default timeout settings&lt;br/&gt;
2. I do not have exact number here, but it was &amp;lt;= 100. And the reproduce script is to spam like crazy so you can reproduce it quickly, we encountered it about once per week....&lt;br/&gt;
3. We used default values, but it does not matter here. Because follower does incremental fetch, if the topic does not receive messages, no effect on HW.&lt;/p&gt;

&lt;p&gt;I don&apos;t think configurations have fundamental impact on this issue, it only affects how frequent you would encounter.&lt;br/&gt;
If you have a low traffic topic, consumer group(s) consuming it, you may encounter the issue.&lt;/p&gt;</comment>
                            <comment id="17027784" author="bchen225242" created="Fri, 31 Jan 2020 19:51:40 +0000"  >&lt;p&gt;The default heartbeat interval is 3 seconds, and only if you took 10 ms to do a heartbeat request handling, still you need 300 consumer instances running concurrently in best chance. The part I&apos;m confused is that I agree we could reproduce with crazy heartbeats, but blocking the group lock acquiring is already a bit concerning for a client side setup. &lt;/p&gt;

&lt;p&gt;Also IIUC the default API timeout is one minute, so it is pretty important how frequent we trigger follower fetch. For my own education purpose, how often we trigger produce purgatory check with the incremental fetch session? If there is no data flowing in, we shall not trigger any fetch at all?&lt;/p&gt;</comment>
                            <comment id="17027887" author="windkithk" created="Fri, 31 Jan 2020 23:51:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bchen225242&quot; class=&quot;user-hover&quot; rel=&quot;bchen225242&quot;&gt;bchen225242&lt;/a&gt;&lt;br/&gt;
My theory is, when HeartBeat and OffsetCommit request occurs at the same time, the issue would happen. So more consumer would mean higher chance, but less consumers do not mean the issue does not happen.&lt;/p&gt;

&lt;p&gt;DelayedProduce purgatory check works with key, &lt;a href=&quot;https://github.com/apache/kafka/blob/1.1/core/src/main/scala/kafka/server/ReplicaManager.scala#L281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/1.1/core/src/main/scala/kafka/server/ReplicaManager.scala#L281&lt;/a&gt;&lt;br/&gt;
so if the partition does not have new data flowing in, (HW does not change, partition is not included in the incremental fetch), corresponding DelayedProduce(s) do not get completed.&lt;/p&gt;</comment>
                            <comment id="17028260" author="bchen225242" created="Sun, 2 Feb 2020 03:18:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=windkithk&quot; class=&quot;user-hover&quot; rel=&quot;windkithk&quot;&gt;windkithk&lt;/a&gt;&#160;Thanks for the explanation. I have one thing I don&apos;t understand which is how the incremental fetch works. Does the session on leader side has some sort of notification mechanism to followers to let them fetch data when new appending comes in? Because fetch request should come in pretty frequent correct? Let&apos;s say there are some newly appended data to the leader log end, but HW doesn&apos;t move yet, does that mean the follower shall never touch that partition?&lt;/p&gt;</comment>
                            <comment id="17031750" author="lothar" created="Thu, 6 Feb 2020 16:48:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=windkithk&quot; class=&quot;user-hover&quot; rel=&quot;windkithk&quot;&gt;windkithk&lt;/a&gt;, I reproduced the error in my cluster. I have 300 client consuming one topic. and i set the server log level to DEBUG. I found that when fetch __consumer_offsets topic, the replica fetch thread in follower blocked du to log4j appender waiting to lock. This looks like a log4j&#160;defect. After change the log level to INFO,&#160; i do not get this error yet. But i think INFO level log4j&#160;may also trigger the thread&#160;blocking.&#160;&lt;/p&gt;

&lt;p&gt;I checked the time of wating group lock in leader also. It cost less than 10 milliseconds.&lt;/p&gt;</comment>
                            <comment id="17118396" author="bdelbosc" created="Thu, 28 May 2020 07:12:06 +0000"  >&lt;p&gt;Hi, it looks like a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7791&quot; title=&quot;Not log retriable exceptions as errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7791&quot;&gt;KAFKA-7791&lt;/a&gt; wdyt?&lt;/p&gt;</comment>
                            <comment id="17193197" author="junrao" created="Wed, 9 Sep 2020 21:45:31 +0000"  >&lt;p&gt;Merged the PR to trunk.&lt;/p&gt;</comment>
                            <comment id="17407907" author="geek-chen" created="Wed, 1 Sep 2021 07:20:56 +0000"  >&lt;p&gt;Excuse me, this problem also occurs in my online environment, but the online environment version cannot be upgraded.&lt;/p&gt;

&lt;p&gt;Can I solve this problem by upgrading the client consumer to 2.7.0 &#65292; and my kafka server is 2.3.0&lt;/p&gt;

&lt;p&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17412714" author="junrao" created="Thu, 9 Sep 2021 17:11:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=geek-chen&quot; class=&quot;user-hover&quot; rel=&quot;geek-chen&quot;&gt;geek-chen&lt;/a&gt;: This is a server side issue. So you will need to upgrade Kafka server.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13294537">KAFKA-9777</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12968166" name="kafka8334.patch" size="4911" author="windkithk" created="Wed, 8 May 2019 07:31:57 +0000"/>
                            <attachment id="12968155" name="offsetcommit_p99.9_cut.jpg" size="473927" author="windkithk" created="Wed, 8 May 2019 05:22:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02hnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>