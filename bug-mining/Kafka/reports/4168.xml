<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:42:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-19242] Fix commit bugs caused by race condition during rebalancing.</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-19242</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;b&gt;Motivation&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;While investigating &#8220;events skipped in group rebalancing&#8221;&#8239;(spring&#8209;projects/spring&#8209;kafka#3703) I discovered a race condition between&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the main poll/commit thread, and&lt;/li&gt;
	&lt;li&gt;the consumer&#8209;coordinator heartbeat thread.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If the main thread enters `ConsumerCoordinator.sendOffsetCommitRequest()`&#8239;while the heartbeat thread is finishing a rebalance (`SyncGroupResponseHandler.handle()`), the group state transitions in the following order:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076473/13076473_image-2025-05-12-21-43-07-656.png&quot; height=&quot;448&quot; width=&quot;761&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Because we read the state twice without a lock:&lt;br/&gt;
1. `generationIfStable()` returns `null` (state still `COMPLETING_REBALANCE`),&lt;br/&gt;
2. the heartbeat thread flips the state to `STABLE`,&lt;br/&gt;
3. the main thread re&#8209;checks with `rebalanceInProgress()` and wrongly decides that a rebalance is still active,&lt;br/&gt;
4. a spurious `CommitFailedException` is returned even though the commit could succeed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Impact&lt;/b&gt;&#160;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The exception is semantically wrong: the consumer is in a stable group, but reports failure.&lt;/li&gt;
	&lt;li&gt;Frameworks and applications that rely on the semantics of `CommitFailedException` and&#8239;`RetryableCommitException` (for example `Spring Kafka`) take the wrong code path, which can ultimately skip the events and break &#8220;at&#8209;most&#8209;once&#8221; guarantees.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Fix&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We enlarge the synchronized block in `ConsumerCoordinator.sendOffsetCommitRequest()` so that the consumer group state is examined atomically with respect to the heartbeat thread:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13617118">KAFKA-19242</key>
            <summary>Fix commit bugs caused by race condition during rebalancing.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chickenchickenlove">sanghyeok An</assignee>
                                    <reporter username="chickenchickenlove">sanghyeok An</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 May 2025 10:06:47 +0000</created>
                <updated>Mon, 15 Sep 2025 16:53:07 +0000</updated>
                            <resolved>Mon, 12 May 2025 15:08:56 +0000</resolved>
                                                    <fixVersion>3.9.2</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>4.1.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17949403" author="JIRAUSER303328" created="Mon, 5 May 2025 10:19:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/19631&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/19631&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17949405" author="JIRAUSER303328" created="Mon, 5 May 2025 10:23:52 +0000"  >&lt;p&gt;CC. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=m1a2st&quot; class=&quot;user-hover&quot; rel=&quot;m1a2st&quot;&gt;m1a2st&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076366" name="image-2025-05-05-19-19-06-147.png" size="242171" author="chickenchickenlove" created="Mon, 5 May 2025 10:19:08 +0000"/>
                            <attachment id="13076473" name="image-2025-05-12-21-43-07-656.png" size="245738" author="chickenchickenlove" created="Mon, 12 May 2025 12:43:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1voiw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>