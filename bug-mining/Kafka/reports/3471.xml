<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:32:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14054] Unexpected client shutdown as TimeoutException is thrown as IllegalStateException</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14054</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&#160;Re: &lt;a href=&quot;https://forum.confluent.io/t/bug-timeoutexception-is-thrown-as-illegalstateexception-causing-client-shutdown/5460/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://forum.confluent.io/t/bug-timeoutexception-is-thrown-as-illegalstateexception-causing-client-shutdown/5460/2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1) TimeoutException is thrown as IllegalStateException in &lt;em&gt;org.apache.kafka.streams.processor.internals.StreamTask#commitNeeded&lt;/em&gt;. Which causes the client to shutdown in&#160;&lt;em&gt;org.apache.kafka.streams.KafkaStreams#getActionForThrowable&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;2) Should Timeout be a recoverable error which is expected to be handled by User?&lt;/p&gt;

&lt;p&gt;3) This issue is exposed by change &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-12887&quot; title=&quot;Do not trigger user-customized ExceptionalHandler for RTE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-12887&quot;&gt;KAFKA-12887&lt;/a&gt;&#160;which was introduced in kafka-streams ver 3.1.0&lt;/p&gt;

&lt;p&gt;&lt;b&gt;code referenced&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.kafka.streams.processor.internals.StreamTask#commitNeeded&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; commitNeeded() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commitNeeded) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map.Entry&amp;lt;TopicPartition, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; entry : consumedOffsets.entrySet()) {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TopicPartition partition = entry.getKey();
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; offset = mainConsumer.position(partition);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (offset &amp;gt; entry.getValue() + 1) {
                        commitNeeded = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                        entry.setValue(offset - 1);
                    }
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TimeoutException error) {
                    &lt;span class=&quot;code-comment&quot;&gt;// the `consumer.position()` call should never block, because we know that we did process data
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the requested partition and thus the consumer should have a valid local position
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// that it can &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; immediately
&lt;/span&gt;
                    &lt;span class=&quot;code-comment&quot;&gt;// hence, a `TimeoutException` indicates a bug and thus we rethrow it as fatal `IllegalStateException`
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(error);
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KafkaException fatal) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StreamsException(fatal);
                }
            }

            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; commitNeeded;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;org.apache.kafka.streams.KafkaStreams#getActionForThrowable&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; StreamsUncaughtExceptionHandler.StreamThreadExceptionResponse getActionForThrowable(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable throwable,
                                                                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsUncaughtExceptionHandler streamsUncaughtExceptionHandler) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsUncaughtExceptionHandler.StreamThreadExceptionResponse action;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wrappedExceptionIsIn(throwable, EXCEPTIONS_NOT_TO_BE_HANDLED_BY_USERS)) {
            action = SHUTDOWN_CLIENT;
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            action = streamsUncaughtExceptionHandler.handle(throwable);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; action;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void handleStreamsUncaughtException(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable throwable,
                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsUncaughtExceptionHandler streamsUncaughtExceptionHandler,
                                                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; skipThreadReplacement) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamsUncaughtExceptionHandler.StreamThreadExceptionResponse action = getActionForThrowable(throwable, streamsUncaughtExceptionHandler);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldHandler) {
            log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stream&apos;s &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; uncaught exception handler is set as well as the deprecated old handler.&quot;&lt;/span&gt; +
                    &lt;span class=&quot;code-quote&quot;&gt;&quot;The old handler will be ignored as &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; as a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; handler is set.&quot;&lt;/span&gt;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (action) {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; REPLACE_THREAD:
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!skipThreadReplacement) {
                    log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Replacing thread in the streams uncaught exception handler&quot;&lt;/span&gt;, throwable);
                    replaceStreamThread(throwable);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    log.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Skipping thread replacement &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; recoverable error&quot;&lt;/span&gt;);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; SHUTDOWN_CLIENT:
                log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Encountered the following exception during processing &quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;and Kafka Streams opted to &quot;&lt;/span&gt; + action + &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot; The streams client is going to shut down now. &quot;&lt;/span&gt;, throwable);
                closeToError();
                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;b&gt;Stacktrace&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;error log kafka-streams v. 3.1.0&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-06-22 13:58:35,796 ERROR thread=[com_stmartin_hammer_v3_platform-hammer-facade-fdc90fab-ed3a-4e62-b458-e73f80e6975d-StreamThread-1] logger=o.a.k.s.KafkaStreams - stream-client [com_stmartin_hammer_v3_platform-hammer-facade-fdc90fab-ed3a-4e62-b458-e73f80e6975d] Encountered the following exception during processing and Kafka Streams opted to SHUTDOWN_CLIENT. The streams client is going to shut down now.
org.apache.kafka.streams.errors.StreamsException: java.lang.IllegalStateException: org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before the position &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition com_stmartin_hammer_v3_command_pte_hammercommand--demo--compacted-4 could be determined
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:642)
        at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:576)
Caused by: java.lang.IllegalStateException: org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before the position &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition com_stmartin_hammer_v3_command_pte_hammercommand--demo--compacted-4 could be determined
        at org.apache.kafka.streams.processor.internals.StreamTask.commitNeeded(StreamTask.java:1185)
        at org.apache.kafka.streams.processor.internals.TaskManager.commitTasksAndMaybeUpdateCommittableOffsets(TaskManager.java:1111)
        at org.apache.kafka.streams.processor.internals.TaskManager.commit(TaskManager.java:1084)
        at org.apache.kafka.streams.processor.internals.StreamThread.maybeCommit(StreamThread.java:1071)
        at org.apache.kafka.streams.processor.internals.StreamThread.runOnce(StreamThread.java:817)
        at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:604)
        ... 1 common frames omitted
Caused by: org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before the position &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition com_stmartin_hammer_v3_command_pte_hammercommand--demo--compacted-4 could be determined
2022-06-22 13:58:35,796  INFO thread=[com_stmartin_hammer_v3_platform-hammer-facade-fdc90fab-ed3a-4e62-b458-e73f80e6975d-StreamThread-1] logger=o.a.k.s.KafkaStreams - stream-client [com_stmartin_hammer_v3_platform-hammer-facade-fdc90fab-ed3a-4e62-b458-e73f80e6975d] State transition from RUNNING to PENDING_ERROR
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13470553">KAFKA-14054</key>
            <summary>Unexpected client shutdown as TimeoutException is thrown as IllegalStateException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="donald.n">Donald</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jul 2022 14:52:46 +0000</created>
                <updated>Mon, 26 Feb 2024 21:32:24 +0000</updated>
                            <resolved>Fri, 14 Apr 2023 19:00:59 +0000</resolved>
                                    <version>3.1.0</version>
                    <version>3.1.1</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.4.1</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17647099" author="JIRAUSER302322" created="Wed, 14 Dec 2022 13:20:17 +0000"  >&lt;p&gt;Bug confirmed with 3.1.1.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16oqw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>