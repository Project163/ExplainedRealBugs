<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:26:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-10722] Timestamped store is used even if not desired</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-10722</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;I have a stream which I then group and aggregate (this results in a KTable). When aggregating, I explicitly tell to materialize the result table using a usual (not timestamped) store.&lt;/p&gt;

&lt;p&gt;After that, the KTable is filtered and streamed. This stream is processed by a processor that accesses the store.&lt;/p&gt;

&lt;p&gt;The problem/bug is that even if I tell to use a non-timestamped store, a timestamped one is used, which leads to a ClassCastException in the processor (it iterates over the store and expects the items to be of type &quot;KeyValue&quot; but they are of type &quot;ValueAndTimestamp&quot;).&lt;/p&gt;

&lt;p&gt;Here is the code (schematically).&lt;/p&gt;

&lt;p&gt;First, I define the topology:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
KTable table = ...aggregate(
  initializer, &lt;span class=&quot;code-comment&quot;&gt;// initializer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the KTable row
&lt;/span&gt;  aggregator, &lt;span class=&quot;code-comment&quot;&gt;// aggregator
&lt;/span&gt;  Materialized.as(Stores.persistentKeyValueStore(&lt;span class=&quot;code-quote&quot;&gt;&quot;MyStore&quot;&lt;/span&gt;)) &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- Non-Timestamped!
&lt;/span&gt;    .withKeySerde(...).withValueSerde(...));

table.toStream().process(theProcessor);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the class for the processor:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(ProcessorContext context) {
   &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; store = context.getStateStore(&lt;span class=&quot;code-quote&quot;&gt;&quot;MyStore&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// Returns a TimestampedKeyValueStore!
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A timestamped store is returned even if I explicitly told to use a non-timestamped one!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I tried to find the cause for this behaviour and think that I&apos;ve found it. It lies in this line: &lt;a href=&quot;https://github.com/apache/kafka/blob/cfc813537e955c267106eea989f6aec4879e14d7/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KGroupedStreamImpl.java#L241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/cfc813537e955c267106eea989f6aec4879e14d7/streams/src/main/java/org/apache/kafka/streams/kstream/internals/KGroupedStreamImpl.java#L241&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There, TimestampedKeyValueStoreMaterializer is used regardless of whether materialization supplier is a timestamped one or not.&lt;/p&gt;

&lt;p&gt;I think this is a bug.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13340602">KAFKA-10722</key>
            <summary>Timestamped store is used even if not desired</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fml2">fml2</assignee>
                                    <reporter username="fml2">fml2</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Nov 2020 22:26:11 +0000</created>
                <updated>Wed, 23 Dec 2020 23:53:16 +0000</updated>
                            <resolved>Wed, 23 Dec 2020 23:53:16 +0000</resolved>
                                    <version>2.4.1</version>
                    <version>2.6.0</version>
                                    <fixVersion>2.8.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17231896" author="mjsax" created="Sat, 14 Nov 2020 00:57:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fml2&quot; class=&quot;user-hover&quot; rel=&quot;fml2&quot;&gt;fml2&lt;/a&gt;, what you describe is not a bug but it&apos;s by design. Note, that technically, the `aggregate()` operator requires a timestamped key-value store. The only reason why we allow you to pass in a plain key-value store is for backward compatibility reasons. Before we introduced timestamped key-value store, users might have written code like yours, and we needed to make sure to not break their code when they upgrade.&lt;/p&gt;

&lt;p&gt;If we would have designed the API &quot;from scratch&quot; your code would not be valid and we would enforce that you pass a timestamped key-value store into `aggregate()`.&lt;/p&gt;

&lt;p&gt;Does this make sense?&lt;/p&gt;</comment>
                            <comment id="17231972" author="fml2" created="Sat, 14 Nov 2020 09:17:26 +0000"  >&lt;p&gt;Hello, thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; for the quick response! This perfectly makes sense. Could you please explain why the aggregate operation requires a timestamped store? The operation is not windowed if I understand correctly. It it was windowed (by time), then I&apos;d understand it. Could you please explain? Why is the timestamp needed?&lt;/p&gt;

&lt;p&gt;And one more thing (proposal): if such usage is discouraged, wouldn&apos;t it make sense to log some warning that such usage is not good anymore? Or make the API deprecated so that IDEs warn the developers.&lt;/p&gt;

&lt;p&gt;Because, as of now, it mesleads to wrong usage.&lt;/p&gt;</comment>
                            <comment id="17231981" author="fml2" created="Sat, 14 Nov 2020 10:29:04 +0000"  >&lt;p&gt;Matthias, does your response mean that we &lt;b&gt;always&lt;/b&gt; get a timestamped store? Now, since I&apos;m not sure what I get, I wrote the code that can handle both (unwrap the ValueAndTimestamp to get the data). WIth that knowledge I could simplify the code. Tahnk you.&lt;/p&gt;</comment>
                            <comment id="17232993" author="mjsax" created="Mon, 16 Nov 2020 18:42:50 +0000"  >&lt;p&gt;Every record in Kafka Streams has a timestamp, and aggregate() needs to set a timestamp for its output records. It computes the output record timestamps as &quot;max&quot; over all input records. That is why it needs a timestamped key-value store to track the maximum timestamp.&lt;/p&gt;

&lt;p&gt;Unfortunately, we cannot deprecate the API easily because of Java type erasure... I guess we could log a warn message thought... Feel free to do a PR for it. We could log when we create the `KeyValueToTimestampedKeyValueByteStoreAdapter`.&lt;/p&gt;

&lt;p&gt;And yes, you always get a timestamped key-value store and you can simplify your code accordingly. (Note thought, that if you provide a non-timestamped store, the timestamp won&apos;t really be stored, because the above mentioned adapter will just drop the timestamp before storing the data in the provided store &#8211; on read, the adapter will just set `-1`, ie, unknown, as timestamp.)&lt;/p&gt;

&lt;p&gt;Thus, I would actually recommend to pass in a timestamped key-value store to begin with.&#160; On the other hand, why do you pass in a store at all? I seem you actually only want to set a name (to be able to access the store from the other `Processor`) what you can do via `Materialized.as(&quot;MyStore&quot;)` &#8211; passing in a `StoreSupplier` should be used if you want to pass in your own custom store implementation. As you create the store using `Stores` anyway, you can just let KS DSL create the store for you.&lt;/p&gt;

&lt;p&gt;I am also open to improve our docs, to point out this issue better. Atm, it seem we only documented in the upgrade guide when the feature was added:&#160;&lt;a href=&quot;https://kafka.apache.org/26/documentation/streams/upgrade-guide#streams_api_changes_230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/26/documentation/streams/upgrade-guide#streams_api_changes_230&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17233116" author="fml2" created="Mon, 16 Nov 2020 21:58:21 +0000"  >&lt;p&gt;OK, I accept that Kafka Streams needs timestamps for the internal processing. But I still fail to see why all the users (clients) are imposed to use it. It adds an additional (I assume, rarely needed) wrapping layer (`ValueAndTimestamp` with the value within in being a `KeyValues` vs. just `KeyValue`). But OK, I accepti it.&lt;/p&gt;

&lt;p&gt;I can&apos;t see why a method can&apos;t be deprecated. Deprecation does not change the API, the code will still work. Just the IDE will issue a warning alert if the method is used.&lt;/p&gt;

&lt;p&gt;And you are of course right that I can just use `Materialized.as(&quot;MyStore&quot;)`. Actually this is what I did first. And got a `ClassCastException`. And started to investigate the case. And wanted to guarantee that I get a non-timestamped store &#8211; but could not get it. And hence this ticket &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;I also saw the upgrade note for 2.3.0. I understood the words &quot;Some DSL operators (for example KTables) are using those new stores.&quot; as &quot;they can use them&quot; or &quot;they use them internally&quot; &#8211; but not as &quot;you will always get the new store type and should unwrap timestamped values&quot;. And &quot;you might need to update your code to cast to the correct type&quot; did not sound very obligatory too.&lt;/p&gt;

&lt;p&gt;Would it make sense to introduce the method &quot;value()&quot; (or similar) that would return the real data &#8211; both for a `KeyValue` and a `ValueAndTimestamp`? This would be confusing for `ValueAndTimestamp` though since `value` (the field) would return a `KeyValue` but `value()` (the method) would return the value part of the KeyValue.&lt;/p&gt;

&lt;p&gt;Another note is that I could not find the explanation of the values of timestamps used in Kafka Streams. I found out this is a millis epoch. But, judging just by the type, it could have been the nano epoch. Using e.g. `Instance` would eliminate the question. But this is spread over so many places that I assume a change is not possible. Besides, this is another topic.&lt;/p&gt;

&lt;p&gt;Thank you for your replies!&lt;/p&gt;</comment>
                            <comment id="17233692" author="mjsax" created="Tue, 17 Nov 2020 16:05:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;But I still fail to see why all the users (clients) are imposed to use it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure why you say this? Note, that for your case, you try to get access to an &quot;existing&quot; (ie, automatically added) store by a different processor. If you would add a new store (that is not used by &#8211; and not added by &#8211; the aggergate() operator) you can also use a plain key-value store.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I can&apos;t see why a method can&apos;t be deprecated. Deprecation does not change the API, the code will still work. Just the IDE will issue a warning alert if the method is used.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well, of course a method could be deprecated, however, we would need to add a new one &lt;em&gt;with different name&lt;/em&gt;. We cannot overload the method due to type erasure. And renaming the method is tricky... (naming is hard... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I also saw the upgrade note for 2.3.0. I understood the words &quot;Some DSL operators (for example KTables) are using those new stores.&quot; as &quot;they can use them&quot; or &quot;they use them internally&quot; &#8211; but not as &quot;you will always get the new store type and should unwrap timestamped values&quot;. And &quot;you might need to update your code to cast to the correct type&quot; did not sound very obligatory too.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for the feedback! Can you help us improve the docs and open a PR?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Would it make sense to introduce the method &quot;value()&quot; (or similar) that would return the real data &#8211; both for a `KeyValue` and a `ValueAndTimestamp`? This would be confusing for `ValueAndTimestamp` though since `value` (the field) would return a `KeyValue` but `value()` (the method) would return the value part of the KeyValue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure. But this would be public API change and would require a KIP. Thus, we would discuss on the KIP.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Another note is that I could not find the explanation of the values of timestamps used in Kafka Streams. I found out this is a millis epoch. But, judging just by the type, it could have been the nano epoch. Using e.g. `Instance` would eliminate the question. But this is spread over so many places that I assume a change is not possible. Besides, this is another topic.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We use plain `long` for performance reasons. Many public APIs that are not at the critical code path got already migrated from `long` to `Duration` and `Instant`. However, for the &quot;runtime code&quot; that is on the hot code path, there are not plans to move off `long`.&lt;/p&gt;</comment>
                            <comment id="17233730" author="fml2" created="Tue, 17 Nov 2020 16:47:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;If you would add a new store (that is not used by &#8211; and not added by &#8211; the aggergate() operator) you can also use a plain key-value store.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah, that&apos;s the clue! I use something the system provides and uses for its internal purposes, and hence have to take what&apos;s there. This is a good explanation, I&apos;m fully satisfied now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Where do you think the note about timestamped stores should be placed? I found two candidates:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://kafka.apache.org/26/documentation/streams/core-concepts#streams_state&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/26/documentation/streams/core-concepts#streams_state&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://kafka.apache.org/26/documentation/streams/developer-guide/processor-api.html#id3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/26/documentation/streams/developer-guide/processor-api.html#id3&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d write something like this: Note that some stream operations, e.g. `aggregate()`, need a state store for doing their work. You can define the name of the store, but not its type. It will always be a `TimestampedKeyValueStore`.&lt;/p&gt;

&lt;p&gt;You can close the ticket if you wish.&lt;/p&gt;</comment>
                            <comment id="17233740" author="mjsax" created="Tue, 17 Nov 2020 17:06:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m fully satisfied now&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Glad to hear &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;About the docs: I would not put it into the &quot;core concepts&quot; sections, as this section talks about state stores only in a more abstract/conceptual way.&lt;/p&gt;

&lt;p&gt;For the &quot;Processor API&quot; section, I am not sure either. In general, the Processor API allows you to add any state store you want... It&apos;s the DSL that uses the timestamped store. Thus, it seem the best place would be &lt;a href=&quot;https://kafka.apache.org/documentation/streams/developer-guide/dsl-api.html#stateful-transformations&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kafka.apache.org/documentation/streams/developer-guide/dsl-api.html#stateful-transformations&lt;/a&gt;? (1) non-windowed aggregations and plain KTables use timestamped kv-store (2) time-windowed aggregations and kstream-kstream joins use timestamped window stores (3) session windowed aggregations use plain session stores (there is no timestamped session store atm).&lt;/p&gt;

&lt;p&gt;If you do a PR, please use this ticket as reference. We can close the ticket after we merged the PR. Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="17234030" author="fml2" created="Tue, 17 Nov 2020 21:50:18 +0000"  >&lt;p&gt;I&apos;ve created &lt;a href=&quot;https://github.com/apache/kafka/pull/9606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9606&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/kafka/pull/9607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/9607&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17254330" author="mjsax" created="Wed, 23 Dec 2020 23:53:16 +0000"  >&lt;p&gt;Added you to the list of contributors and assigned the ticket to you. You can now also self-assign tickets.&lt;/p&gt;

&lt;p&gt;Thanks for reporting the issue and for helping to improve the JavaDocs.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 46 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kl4o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>