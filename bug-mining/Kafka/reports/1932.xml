<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:11:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-6704] Checking hasNext from SegementIterator could throw InvalidStateStoreException </title>
                <link>https://issues.apache.org/jira/browse/KAFKA-6704</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;When using Interactive Queries to do a range query on a Windowed store ,&lt;tt&gt;SegmentIterator.hasNext&lt;/tt&gt;&#160;could throw an &lt;tt&gt;InvalidStateStoreException&lt;/tt&gt; if the &lt;tt&gt;StreamThread&lt;/tt&gt; has closed the store.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13147280">KAFKA-6704</key>
            <summary>Checking hasNext from SegementIterator could throw InvalidStateStoreException </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bbejeck">Bill Bejeck</assignee>
                                    <reporter username="bbejeck">Bill Bejeck</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Mar 2018 20:47:43 +0000</created>
                <updated>Tue, 5 Jun 2018 18:50:32 +0000</updated>
                            <resolved>Tue, 5 Jun 2018 18:50:32 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16420996" author="githubbot" created="Fri, 30 Mar 2018 22:10:13 +0000"  >&lt;p&gt;bbejeck opened a new pull request #4801: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6704&quot; title=&quot;Checking hasNext from SegementIterator could throw InvalidStateStoreException &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6704&quot;&gt;&lt;del&gt;KAFKA-6704&lt;/del&gt;&lt;/a&gt;: InvalidStateStoreException from IQ when StreamThread closes store&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4801&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   While using an `iterator` from IQ, it&apos;s possible to get an `InvalidStateStoreException` if the `StreamThread` closes the store during a range query.&lt;/p&gt;

&lt;p&gt;   Added a unit test to `SegmentIteratorTest` for this condition.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16502293" author="githubbot" created="Tue, 5 Jun 2018 18:49:39 +0000"  >&lt;p&gt;guozhangwang closed pull request #4801: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-6704&quot; title=&quot;Checking hasNext from SegementIterator could throw InvalidStateStoreException &quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-6704&quot;&gt;&lt;del&gt;KAFKA-6704&lt;/del&gt;&lt;/a&gt;: InvalidStateStoreException from IQ when StreamThread closes store&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/4801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/4801&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java&lt;br/&gt;
index d2b8cd2bac6..ff6c56add84 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/RocksDBStore.java&lt;br/&gt;
@@ -17,6 +17,7 @@&lt;br/&gt;
 package org.apache.kafka.streams.state.internals;&lt;/p&gt;

&lt;p&gt; import org.apache.kafka.common.TopicPartition;&lt;br/&gt;
+import org.apache.kafka.common.utils.AbstractIterator;&lt;br/&gt;
 import org.apache.kafka.common.utils.Bytes;&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
 import org.apache.kafka.streams.KeyValue;&lt;br/&gt;
@@ -441,46 +442,46 @@ private void closeOpenIterators() {&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private class RocksDbIterator implements KeyValueIterator&amp;lt;Bytes, byte[]&amp;gt; {&lt;br/&gt;
+    private class RocksDbIterator extends AbstractIterator&amp;lt;KeyValue&amp;lt;Bytes, byte[]&amp;gt;&amp;gt; implements KeyValueIterator&amp;lt;Bytes, byte[]&amp;gt; {&lt;br/&gt;
         private final String storeName;&lt;br/&gt;
         private final RocksIterator iter;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         private volatile boolean open = true;&lt;/p&gt;

&lt;p&gt;+        private KeyValue&amp;lt;Bytes, byte[]&amp;gt; next;&lt;br/&gt;
+&lt;br/&gt;
         RocksDbIterator(final String storeName,&lt;br/&gt;
                         final RocksIterator iter) &lt;/p&gt;
{
             this.iter = iter;
             this.storeName = storeName;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;byte[] peekRawKey() 
{
-            return iter.key();
-        }
&lt;p&gt;-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;private KeyValue&amp;lt;Bytes, byte[]&amp;gt; getKeyValue() 
{
-            return new KeyValue&amp;lt;&amp;gt;(new Bytes(iter.key()), iter.value());
-        }
&lt;p&gt;-&lt;br/&gt;
         @Override&lt;br/&gt;
         public synchronized boolean hasNext() {&lt;br/&gt;
             if (!open) &lt;/p&gt;
{
                 throw new InvalidStateStoreException(String.format(&quot;RocksDB store %s has closed&quot;, storeName));
             }
&lt;p&gt;-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return iter.isValid();&lt;br/&gt;
+            return super.hasNext();&lt;br/&gt;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* @throws NoSuchElementException if no next element exist&lt;/li&gt;
	&lt;li&gt;*/&lt;br/&gt;
         @Override&lt;br/&gt;
         public synchronized KeyValue&amp;lt;Bytes, byte[]&amp;gt; next() 
{
-            if (!hasNext())
-                throw new NoSuchElementException();
+            return super.next();
+        }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final KeyValue&amp;lt;Bytes, byte[]&amp;gt; entry = this.getKeyValue();&lt;/li&gt;
	&lt;li&gt;iter.next();&lt;/li&gt;
	&lt;li&gt;return entry;&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public KeyValue&amp;lt;Bytes, byte[]&amp;gt; makeNext() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            if (!iter.isValid()) {
+                return allDone();
+            } else {
+                next = this.getKeyValue();
+                iter.next();
+                return next;
+            }&lt;br/&gt;
+        }&lt;br/&gt;
+&lt;br/&gt;
+        private KeyValue&amp;lt;Bytes, byte[]&amp;gt; getKeyValue() {
+            return new KeyValue&amp;lt;&amp;gt;(new Bytes(iter.key()), iter.value());
         }&lt;br/&gt;
 &lt;br/&gt;
         @Override&lt;br/&gt;
@@ -500,7 +501,7 @@ public Bytes peekNextKey() {&lt;br/&gt;
             if (!hasNext()) {
                 throw new NoSuchElementException();
             }&lt;br/&gt;
-            return new Bytes(iter.key());&lt;br/&gt;
+            return next.key;&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
@@ -524,8 +525,17 @@ public Bytes peekNextKey() {&lt;br/&gt;
         }&lt;br/&gt;
 &lt;br/&gt;
         @Override&lt;br/&gt;
-        public synchronized boolean hasNext() {&lt;br/&gt;
-            return super.hasNext() &amp;amp;&amp;amp; comparator.compare(super.peekRawKey(), this.rawToKey) &amp;lt;= 0;&lt;br/&gt;
+        public KeyValue&amp;lt;Bytes, byte[]&amp;gt; makeNext() {&lt;br/&gt;
+            final KeyValue&amp;lt;Bytes, byte[]&amp;gt; next = super.makeNext();&lt;br/&gt;
+&lt;br/&gt;
+            if (next == null) {+                return allDone();+            } else {
+                if (comparator.compare(next.key.get(), this.rawToKey) &amp;lt;= 0)
+                    return next;
+                else
+                    return allDone();
+            }         }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/SegmentIterator.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/SegmentIterator.java&lt;br/&gt;
index 099cba17328..331ffdb3769 100644&lt;br/&gt;
&amp;#8212; a/streams/src/main/java/org/apache/kafka/streams/state/internals/SegmentIterator.java&lt;br/&gt;
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/SegmentIterator.java&lt;br/&gt;
@@ -66,7 +66,7 @@ public Bytes peekNextKey() {&lt;br/&gt;
     @Override&lt;br/&gt;
     public boolean hasNext() {&lt;br/&gt;
         boolean hasNext = false;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while ((currentIterator == null || !(hasNext = hasNextCondition.hasNext(currentIterator)) || !currentSegment.isOpen())&lt;br/&gt;
+        while ((currentIterator == null || !(hasNext = hasNextConditionHasNext()) || !currentSegment.isOpen())&lt;br/&gt;
                 &amp;amp;&amp;amp; segments.hasNext()) {&lt;br/&gt;
             close();&lt;br/&gt;
             currentSegment = segments.next();&lt;br/&gt;
@@ -83,6 +83,16 @@ public boolean hasNext() 
{
         return currentIterator != null &amp;amp;&amp;amp; hasNext;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    private boolean hasNextConditionHasNext() {&lt;br/&gt;
+        boolean hasNext = false;&lt;br/&gt;
+        try &lt;/p&gt;
{
+            hasNext = hasNextCondition.hasNext(currentIterator);
+        }
&lt;p&gt; catch (InvalidStateStoreException e) &lt;/p&gt;
{
+            //already closed so ignore
+        }
&lt;p&gt;+        return hasNext;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
     public KeyValue&amp;lt;Bytes, byte[]&amp;gt; next() {&lt;br/&gt;
         if (!hasNext()) {&lt;br/&gt;
             throw new NoSuchElementException();&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
index be4ede8ae91..c436e9e588f 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/RocksDBWindowStoreTest.java&lt;br/&gt;
@@ -27,7 +27,6 @@&lt;br/&gt;
 import org.apache.kafka.common.utils.Utils;&lt;br/&gt;
 import org.apache.kafka.streams.KeyValue;&lt;br/&gt;
 import org.apache.kafka.streams.errors.DefaultProductionExceptionHandler;&lt;br/&gt;
-import org.apache.kafka.streams.errors.InvalidStateStoreException;&lt;br/&gt;
 import org.apache.kafka.streams.kstream.Windowed;&lt;br/&gt;
 import org.apache.kafka.streams.processor.ProcessorContext;&lt;br/&gt;
 import org.apache.kafka.streams.processor.internals.MockStreamsMetrics;&lt;br/&gt;
@@ -61,7 +60,6 @@&lt;br/&gt;
 import static org.junit.Assert.assertFalse;&lt;br/&gt;
 import static org.junit.Assert.assertNull;&lt;br/&gt;
 import static org.junit.Assert.assertTrue;&lt;br/&gt;
-import static org.junit.Assert.fail;&lt;/p&gt;

&lt;p&gt; @SuppressWarnings(&quot;PointlessArithmeticExpression&quot;)&lt;br/&gt;
 public class RocksDBWindowStoreTest {&lt;br/&gt;
@@ -747,7 +745,7 @@ public void testInitialLoading() {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     @Test&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shouldCloseOpenIteratorsWhenStoreIsClosedAndThrowInvalidStateStoreExceptionOnHasNextAndNext() {&lt;br/&gt;
+    public void shouldCloseOpenIteratorsWhenStoreIsClosedAndNotThrowInvalidStateStoreExceptionOnHasNext() {&lt;br/&gt;
         windowStore = createWindowStore(context);&lt;br/&gt;
         context.setRecordContext(createRecordContext(0));&lt;br/&gt;
         windowStore.put(1, &quot;one&quot;, 1L);&lt;br/&gt;
@@ -757,20 +755,9 @@ public void shouldCloseOpenIteratorsWhenStoreIsClosedAndThrowInvalidStateStoreEx&lt;br/&gt;
         final WindowStoreIterator&amp;lt;String&amp;gt; iterator = windowStore.fetch(1, 1L, 3L);&lt;br/&gt;
         assertTrue(iterator.hasNext());&lt;br/&gt;
         windowStore.close();&lt;/li&gt;
	&lt;li&gt;try 
{
-            //noinspection ResultOfMethodCallIgnored
-            iterator.hasNext();
-            fail(&quot;should have thrown InvalidStateStoreException on closed store&quot;);
-        }
&lt;p&gt; catch (final InvalidStateStoreException e) &lt;/p&gt;
{
-            // ok
-        }&lt;br/&gt;
 &lt;br/&gt;
-        try {
-            iterator.next();
-            fail(&quot;should have thrown InvalidStateStoreException on closed store&quot;);
-        } catch (final InvalidStateStoreException e) {-            // ok-        }
&lt;p&gt;+        assertFalse(iterator.hasNext());&lt;br/&gt;
+&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
diff --git a/streams/src/test/java/org/apache/kafka/streams/state/internals/SegmentIteratorTest.java b/streams/src/test/java/org/apache/kafka/streams/state/internals/SegmentIteratorTest.java&lt;br/&gt;
index 7a7b266537b..80459641f0f 100644&lt;br/&gt;
&amp;#8212; a/streams/src/test/java/org/apache/kafka/streams/state/internals/SegmentIteratorTest.java&lt;br/&gt;
+++ b/streams/src/test/java/org/apache/kafka/streams/state/internals/SegmentIteratorTest.java&lt;br/&gt;
@@ -31,6 +31,7 @@&lt;br/&gt;
 import org.junit.Test;&lt;/p&gt;

&lt;p&gt; import java.util.Arrays;&lt;br/&gt;
+import java.util.Collections;&lt;br/&gt;
 import java.util.NoSuchElementException;&lt;/p&gt;

&lt;p&gt; import static org.junit.Assert.assertEquals;&lt;br/&gt;
@@ -104,6 +105,19 @@ public void shouldIterateOverAllSegments() &lt;/p&gt;
{
         assertFalse(iterator.hasNext());
     }

&lt;p&gt;+    @Test&lt;br/&gt;
+    public void shouldNotThrowExceptionOnHasNextWhenStoreClosed() &lt;/p&gt;
{
+        iterator = new SegmentIterator(Collections.singletonList(segmentOne).iterator(),
+                                       hasNextCondition,
+                                       Bytes.wrap(&quot;a&quot;.getBytes()),
+                                       Bytes.wrap(&quot;z&quot;.getBytes()));
+
+
+        iterator.currentIterator = segmentOne.all();
+        segmentOne.close();
+        assertFalse(iterator.hasNext());
+    }
&lt;p&gt;+&lt;br/&gt;
     @Test&lt;br/&gt;
     public void shouldOnlyIterateOverSegmentsInRange() {&lt;br/&gt;
         iterator = new SegmentIterator(Arrays.asList(segmentOne, segmentTwo).iterator(),&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ro5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>