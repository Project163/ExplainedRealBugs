<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:36:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15602] Breaking change in 3.4.0 ByteBufferSerializer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15602</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/pull/12683/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This PR&lt;/a&gt; claims to have solved the situation described by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt;, namely, to have ByteBufferSerializer respect ByteBuffers wrapping byte arrays with non-0 offsets (or, put another way, to honor the buffer&apos;s position() as the start point to consume bytes from). Unfortunately, it failed to actually do this, and instead changed the expectations for how an input ByteBuffer&apos;s limit and position should be set before being provided to send() on a producer configured with ByteBufferSerializer. Code that worked with pre-3.4.0 releases now produce 0-length messages instead of the intended messages, effectively introducing a breaking change for existing users of the serializer in the wild.&lt;/p&gt;

&lt;p&gt;Here are a few different inputs and serialized outputs under pre-3.4.0 and 3.4.0+ to summarize the breaking change:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;buffer argument&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.3.2 serialized output&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.4.0+ serialized output&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ByteBuffer.wrap(&quot;test&quot;.getBytes(UTF_8))&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 &lt;br/&gt;
val=test&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 val=test&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ByteBuffer.allocate(8).put(&quot;test&quot;.getBytes(UTF_8)).flip()&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 &lt;br/&gt;
val=test&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=0 val=&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ByteBuffer.allocate(8).put(&quot;test&quot;.getBytes(UTF_8))&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=8 val=test&amp;lt;0&amp;gt;&amp;lt;0&amp;gt;&amp;lt;0&amp;gt;&amp;lt;0&amp;gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 val=test&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ByteBuffer buff = ByteBuffer.allocate(8).put(&quot;test&quot;.getBytes(UTF_8));&lt;br/&gt;
buff.limit(buff.position());&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 &lt;br/&gt;
val=test&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 val=test&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ByteBuffer.wrap(&quot;test&quot;.getBytes(UTF_8), 1, 3)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=4 val=test&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;len=1 val=t&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Notably, plain-wrappers of byte arrays continue to work under both versions due to the special case in the serializer for them. I suspect that this is the dominant use-case, which is why this has apparently gone un-reported to this point. The wrapped-with-offset case fails for both cases for different reasons (the expected value would be &quot;est&quot;). As demonstrated here, you can ensure that a manually assembled ByteBuffer will work under both versions by ensuring that your buffers start have position == limit == message-length (and an actual desired start position of 0). Clearly, though, behavior has changed dramatically for the second and third case there, with the 3.3.2 behavior, in my experience, aligning better with naive expectations.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/kafka/blob/35a0de32ee3823dfb548a1cd5d5faf4f7c99e4e0/clients/src/main/java/org/apache/kafka/common/serialization/ByteBufferSerializer.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Previously&lt;/a&gt;, the serializer would just rewind() the buffer and respect the limit as the indicator as to how much data was in the buffer. So, essentially, the prevailing contract was that the data from position 0 (always!) up to the limit on the buffer would be serialized; so it was really just the limit that was honored. So if, per the original issue, you have a byte[] array wrapped with, say, ByteBuffer.wrap(bytes, 3, 5) then that will yield a ByteBuffer() with position = 3 indicating the desired start point to read from, but effectively ignored by the serializer due to the rewind().&lt;/p&gt;

&lt;p&gt;So while the serializer didn&apos;t work when presenting a ByteBuffer view onto a sub-view of a backing array, it did however follow expected behavior when employing standard patterns to populate ByteBuffers backed by larger-than-necessary arrays and using limit() to identify the end of actual data, consistent with conventional usage of flip() to switch from writing to a buffer to setting it up to be read from (e.g., to be passed into a producer.send() call). E.g.,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ByteBuffer bb = ByteBuffer.allocate(TOO_MUCH);
... &lt;span class=&quot;code-comment&quot;&gt;// some sequence of 
&lt;/span&gt;bb.put(...); &lt;span class=&quot;code-comment&quot;&gt;// populate buffer with some number of bytes less than TOO_MUCH ... 
&lt;/span&gt;bb.flip(); &lt;span class=&quot;code-comment&quot;&gt;/* logically, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; says &lt;span class=&quot;code-quote&quot;&gt;&quot;I am done writing, let&apos;s set &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; up &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; reading&quot;&lt;/span&gt;; pragmatically, it sets the limit to the current position so that whoever reads the buffer knows when to stop reading, and sets the position to zero so it knows where to start reading from */&lt;/span&gt; 
producer.send(bb); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Technically, you wouldn&apos;t even need to use flip() there, since position is ignored; it would sufficient to just call &lt;tt&gt;bb.limit(bb.position())&lt;/tt&gt;. Notably, a buffer constructed using any variant of ByteBuffer.wrap() is essentially immediately in read-mode with position indicating the start and limit the end.&lt;/p&gt;

&lt;p&gt;With the change introduced in 3.4.0, however, the contract changes dramatically, and the code just presented produces a 0-byte message. As indicated above, it also continues to fail if you just passed in an offset-specified ByteBuffer.wrap()ped message, too, i.e., the case described by &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testByteBufferSerializerOnOffsetWrappedBytes() {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello&quot;&lt;/span&gt;.getBytes(UTF_8);
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBufferSerializer serializer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteBufferSerializer()) {
        assertArrayEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;ello&quot;&lt;/span&gt;.getBytes(UTF_8), 
                &lt;span class=&quot;code-comment&quot;&gt;// FAILS: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will yield &lt;span class=&quot;code-quote&quot;&gt;&quot;H&quot;&lt;/span&gt;, not &lt;span class=&quot;code-quote&quot;&gt;&quot;ello&quot;&lt;/span&gt;
&lt;/span&gt;                serializer.serialize(topic, ByteBuffer.wrap(bytes, 1, bytes.length - 1)));
    }
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What happened here?&lt;/p&gt;

&lt;p&gt;The resulting PR, it seems, focussed on a flawed proposed test case in the first comment of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt; that failed against pre-3.4.0 Kafka. I reproduce that here with commented annotations from me:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test &lt;span class=&quot;code-comment&quot;&gt;// flawed proposed test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testByteBufferSerializer() {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello&quot;&lt;/span&gt;.getBytes(UTF_8);
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBuffer buffer = ByteBuffer.allocate(7);
    buffer.put(bytes);
    &lt;span class=&quot;code-comment&quot;&gt;// buffer.flip();   &amp;lt;-- would make the test work
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBufferSerializer serializer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteBufferSerializer()) {
        assertArrayEquals(bytes, serializer.serialize(topic, buffer));
    }
}  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In pre-3.4.0, this would yield a 7-byte serialization of &quot;Hello&quot; followed by 2 0-value bytes. I contend that this was actually expected and correct behavior, as the ByteBuffer had never had its limit set, so the implicit and mildly expected contract was never actually abided by. If there was a buffer.flip() after the .put(bytes) call, as the calling code &lt;em&gt;should&lt;/em&gt; have applied, however, then the test would have succeeded. In short, by trying to make this test case succeed, I think this PR represented nothing more than a misunderstanding for how one should prepare ByteBuffers for reading, but has managed to result in a breaking change. The breaking nature of this was actually briefly noted in PR comments but kind of shrugged off with some test changes and explanatory comments on the class.&lt;/p&gt;

&lt;p&gt;Obviously a correction to restore 3.3.2 behavior would represent another breaking change for users that are running on 3.4+, unless they were also somewhat surprisingly configuring buffers for position() == limit() before passing them to send. Arguably, it would also be a breaking change (though possibly not one of great consequence) if either version was changed to correctly handle the wrapped-with-offset case as represented in the original ticket.&lt;/p&gt;

&lt;p&gt;I do not have much experience contending with a situation like this, but at the risk of jumping to a solution here, I wonder if the only way to really move forward safely and unambiguously here is to remove ByteBufferSerializer as it stands and replace it with a differently named substitute that handles both the plain-wrapped special case and just serializes content from position() to limit(), forcing an evaluation by users when upgrading as to whether the provided byte buffer is correctly configured or not. Of course, a change like that would have be released at an appropriate version level, too, so I don&apos;t know exactly what the desired interim behavior would be (deprecation?). I believe I would be eager to contribute to a fix, but obviously I would need guidance from maintainers regarding the correct path forward semantically.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13553948">KAFKA-15602</key>
            <summary>Breaking change in 3.4.0 ByteBufferSerializer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mjsax">Matthias J. Sax</assignee>
                                    <reporter username="luke.kirby">Luke Kirby</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Oct 2023 02:33:02 +0000</created>
                <updated>Thu, 2 Nov 2023 02:17:03 +0000</updated>
                            <resolved>Mon, 30 Oct 2023 20:18:14 +0000</resolved>
                                    <version>3.4.0</version>
                    <version>3.4.1</version>
                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.4.2</fixVersion>
                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.1</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>producer </component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17774807" author="JIRAUSER283568" created="Fri, 13 Oct 2023 06:26:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thanks for reporting this.&#160; I briefly went over the code a bit and I can now understand your concern.&lt;/p&gt;

&lt;p&gt;The original documentation mentioned the user &quot;&lt;em&gt;Do not need to flip&lt;/em&gt;&quot;, I assume that means the serializer will automatically rewind the position to zero for the user as flip explicitly stated &quot;.&lt;em&gt;..limit is set to the current position and then the position is set to zero&lt;/em&gt;&quot;.&#160; However, the serializer API didn&apos;t make any assumptions to the current position of the buffer, so it is hard to say if the original design intended to handle a user-given offset... From reading the unit test, it doesn&apos;t seem so.&lt;/p&gt;

&lt;p&gt;I can see the problem comes from the serializer doesn&apos;t know if the position is an offset or just the next byte to be written.&#160; These are two different definitions of the position so it doesn&apos;t really make sense to handle both cases in a single API call.&lt;/p&gt;

&lt;p&gt;I wonder if the sensible thing to do for now is to is to make the contract and expectations more explicit on the Javadoc, i.e., the serialize method doesn&apos;t support user-provided offset, and the serializer will rewind the current offset to zero for the user.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; - Would you kindly provide some input on this issue? As you reviewed the &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;P&lt;/p&gt;</comment>
                            <comment id="17775037" author="JIRAUSER302550" created="Fri, 13 Oct 2023 19:34:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;The original documentation mentioned the user &quot;&lt;em&gt;Do not need to flip&lt;/em&gt;&quot;, I assume that means the serializer will automatically rewind the position to zero for the user as flip explicitly stated &quot;.&lt;em&gt;..limit is set to the current position and then the position is set to zero&lt;/em&gt;&quot;.&#160; However, the serializer API didn&apos;t make any assumptions to the current position of the buffer, so it is hard to say if the original design intended to handle a user-given offset... From reading the unit test, it doesn&apos;t seem so.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah, no there was no documentation on the serializer before; the &quot;Do not need to flip&quot; comment was introduced with the breaking change in 3.4, though it&apos;s pretty plain to see that previous users of the serializer likely &lt;em&gt;were&lt;/em&gt; flipping, or, at least, writing buffers (with content starting at position 0), flipping them, and sending them &lt;em&gt;worked&lt;/em&gt;&#160;but now doesn&apos;t.&lt;/p&gt;

&lt;p&gt;Looking at the history for the file, it does look like prior to the 3.4 change it always did a rewind() so yeah, position() on the buffer has never really been respected. Now, it kind of &lt;em&gt;does&lt;/em&gt; respect position;&#160;but not in the expected way, as it essentially identifies the end of the buffer rather than the start.&lt;/p&gt;

&lt;p&gt;I don&apos;t know why the original version used a rewind() rather than expecting the buffer to already have a position() reflecting the start point to read from, since in my experience this is clearly the convention for passing ByteBuffer inputs for reading in any library I&apos;m familiar with, and I expect the expectation of most users; perhaps I&apos;m ignorant of some other pattern! I don&apos;t know if there&apos;s some valid contextual reason for it using explicit rewinds() before, but it seems unusual. My suggestion would be to replace the currently named ByteBufferSerializer with a new one that respects the standard interface unambiguously &#8211; i.e., it serializes data from buffer.pos() to buffer.limit(), continuing to use appropriate shortcuts for the simple wrap(byte[]) cases.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I wonder if the sensible thing to do for now is to is to make the contract and expectations more explicit on the Javadoc, i.e., the serialize method doesn&apos;t support user-provided offset, and the serializer will rewind the current offset to zero for the user.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Explicit documentation would surely be improvement, and is probably at the core of how this situation was arrived at, but it doesn&apos;t do anything about folk being surprised by the completely different behavior and broken output that worked from 0.10 - 3.3.2 when upgrading to 3.4.0... though hopefully they notice it.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17775065" author="JIRAUSER283568" created="Fri, 13 Oct 2023 21:09:57 +0000"  >&lt;p&gt;The original intent of the PR was to make the serializer compatible with user offsets; I don&apos;t see any test that covers this, am I missing anything?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;replace the currently named ByteBufferSerializer with a new one that respects the standard interface unambiguously&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We are talking about creating a separated serializer that handles the user offset aren&apos;t we? It seems to be the only way to handle this case.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17775069" author="JIRAUSER302550" created="Fri, 13 Oct 2023 21:23:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;The original intent of the PR was to make the serializer compatible with user offsets; I don&apos;t see any test that covers this, am I missing anything?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yep, no test that covers it. I wrote up the kind of test you&apos;d use to assess it above and it fails. I think the actual intent of the PR writer was to handle the case that they noticed (incorrectly, I contend) and the offsets question just kind of got accidentally ignored. That said, I&apos;m more concerned about the breaking behavior change more than the specifics of handling offsets, which neither version has ever done properly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;We are talking about creating a separated serializer that handles the user offset aren&apos;t we? It seems to be the only way to handle this case.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
Yeah, I think so. Again, though, I think something has to be done to advertise to users that the contract here has changed and that upgrades to 3.4 will more likely than not result in previously functional producers emitting 0-length messages if anything other than a ByteBuffer.wrap(byte[]) message is provided to send(), and that removing the existing class may be the only way to really achieve that safely &#8211; i.e., break loudly. Totally not my call though!&lt;/p&gt;</comment>
                            <comment id="17775087" author="JIRAUSER283568" created="Fri, 13 Oct 2023 22:54:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; , i think we need to do two things here. One is probably revert the change and patch it with better documentation and tests. &#160;Second is optional, if you want to introduce a separated serializer to handle offset, I think we might need to write a KIP. &#160;This is a long term solution. &#160;Are you interested in helping out to resolve this issue? &#160;I can help reviewing the code and KIP.&lt;/p&gt;</comment>
                            <comment id="17775928" author="JIRAUSER302550" created="Mon, 16 Oct 2023 21:37:34 +0000"  >&lt;p&gt;Hi Philip! Are we at all concerned about how reverting that change might break other folks&apos; code if they&apos;d started a project in 3.4+ or had already changed their buffer configurations without complaining about it? Not my decision to make here, obviously, I just want to confirm that that&apos;s not a big concern.&lt;/p&gt;

&lt;p&gt;And yeah, we&apos;d like to be involved in both of these things and am in the process of doing some paperwork to make that accomplishable; might take a little time though.&lt;/p&gt;</comment>
                            <comment id="17775986" author="JIRAUSER283568" created="Tue, 17 Oct 2023 02:35:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think since the PR didn&apos;t actually solve the problem, but introduced a subtle behavior change to the previous implementation (flip the position), whether it was the correct way of setting the position or not, so it seems logical to me to revert that PR and actually try to solve &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I wonder what do folks on the other ticket think - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LSK&quot; class=&quot;user-hover&quot; rel=&quot;LSK&quot;&gt;LSK&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wdaehn&quot; class=&quot;user-hover&quot; rel=&quot;wdaehn&quot;&gt;wdaehn&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;P&lt;/p&gt;</comment>
                            <comment id="17776422" author="JIRAUSER302550" created="Tue, 17 Oct 2023 22:54:43 +0000"  >&lt;p&gt;I think that&apos;s a pretty reasonable take, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt;! Will give the others involved some time to chime in. Should we be doing anything about changing the state of &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt; given that it doesn&apos;t seem like it&apos;s really resolved at all?&lt;/p&gt;</comment>
                            <comment id="17778511" author="mjsax" created="Mon, 23 Oct 2023 03:34:47 +0000"  >&lt;p&gt;Hey, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt; pointed me to this ticket. I am not a ByterBuffer expert, but it seems to me, that a reasonable API contract would be, that the user is responsible to prepare the buffer for reading, and the returned byte[] array is from the buffer&apos;s position to limit. Any other behavior seems odd to me. Thoughts? (Not sure if the position should be modified by the serializer or not thought? I tend to think yes?)&lt;/p&gt;

&lt;p&gt;Overall, it seems like a case to fix forward? If the above propose contract makes sense, it&apos;s rather a bug fix and we should just push it out? (In the end &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt; was done without a KIP, too &#8211; kinda boarder line to begin with...)&#160;&lt;/p&gt;

&lt;p&gt;For example (1), it seems it would be a breaking change though? Given that this is indeed the &quot;prime&quot; use-case, doing a KIP might indeed be better? (For this case, reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852&quot; title=&quot;ByteBufferSerializer not compatible with offsets&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-4852&quot;&gt;KAFKA-4852&lt;/a&gt; might indeed be a good call, as it breaks more than it fixes as it seems.)&lt;/p&gt;

&lt;p&gt;For example (2), pre-3.4 seems to be correct, while 3.4+ is broken.&lt;/p&gt;

&lt;p&gt;For example (3), pre-3.4 seems to be correct, while 3.4+ seems to be incorrect &#8211; the user did not limit to 4 bytes, so all 8 bytes should be returned IMHO?&lt;/p&gt;

&lt;p&gt;For example (4), pre-3.4 seems to be incorrect, while 3.4+ seems to be incorrect, too? In the end, the position was not set back to zero, hence a zero-length array should be returned?&lt;/p&gt;

&lt;p&gt;And last example (5), as already discussed, is also broken in all versions, but should result &quot;est&quot;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I can see the problem comes from the serializer doesn&apos;t know if the position is an offset or just the next byte to be written.&#160; These are two different definitions of the position so it doesn&apos;t really make sense to handle both cases in a single API call.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure if I can follow here? What do you mean bey &quot;is an offset or just the next byte to be written&quot;? Why would position have two different definitions?&lt;/p&gt;

&lt;p&gt;\cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt; as RM for 3.5.2 release &#8211; might be worth to get this fix in, too?&lt;/p&gt;</comment>
                            <comment id="17778515" author="JIRAUSER283568" created="Mon, 23 Oct 2023 04:18:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; - Thanks for the response!&lt;/p&gt;

&lt;p&gt;I think your proposal can be a breaking change because, in both versions, the user is expecting the serializer to rewind the position, whether through flip or rewind...&lt;/p&gt;

&lt;p&gt;To make the serializer also compatible with user-provided offset, I think your proposal would work, but it would require a KIP, to document the expectation, right? Because now we are asking the user to rewind the position to the starting position.&lt;/p&gt;</comment>
                            <comment id="17778719" author="mjsax" created="Mon, 23 Oct 2023 15:55:12 +0000"  >&lt;p&gt;Sounds fair. &#8211; Let me revert K4852 in all applicable branches and re-open it for a proper KIP. &#8211; Guess we can close this ticket afterwards?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17778726" author="JIRAUSER283568" created="Mon, 23 Oct 2023 16:13:28 +0000"  >&lt;p&gt;Great I think so. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; - Do you agree? Also, do you agree with Matthias&apos;s proposal? Are you interested in writing a KIP?&lt;/p&gt;</comment>
                            <comment id="17778731" author="mjsax" created="Mon, 23 Oct 2023 16:19:52 +0000"  >&lt;p&gt;Btw: also left a comment on K4852: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-4852?focusedCommentId=17778727&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17778727&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-4852?focusedCommentId=17778727&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17778727&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17778797" author="JIRAUSER302550" created="Mon, 23 Oct 2023 19:21:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &#8211; I largely agree with what&apos;s been said and am fully on board with the plan to revert the change from K4852. Thanks for taking care of that, Matthias!&lt;/p&gt;

&lt;p&gt;That said, I&apos;m not entirely sure I understand Matthias&apos;s point regarding example 1, which has the right behavior under both examples, and we would expect to work similarly under any revised serializers. I agree that I think example 4 highlights the weirdness of just not respecting position() at all, and we would expect different behavior under the serializer to emerge from the KIP.&lt;/p&gt;

&lt;p&gt;I will leave it up to you to decide whether this change, that &lt;em&gt;might&lt;/em&gt; break users previously on 3.4+, has to be communicated strongly in some fashion to those upgrading. In the interest of avoiding &lt;em&gt;other&lt;/em&gt; interesting ways of breaking things, I agree with Philip that in the interest of minimizing surprising behavior under upgrades, creating a properly functioning serializer that respects starting position should be covered by a KIP and a new class with fresh, clean and good behavior, with the existing serializer maintaining its curious always-rewind behavior. I would still be interested in taking charge with a KIP there just because it seems like a nice lightweight KIP to get our feet wet with, anticipating that we might be interested in some others down the line.&lt;/p&gt;</comment>
                            <comment id="17778913" author="JIRAUSER283568" created="Tue, 24 Oct 2023 03:47:07 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; - Can you create a Jira to document what you intend to do in the KIP? I think we can close this issue after reverting the PR.&#160; Let us know if you have any questions regarding the KIP process, we are here to help!&lt;/p&gt;</comment>
                            <comment id="17779216" author="mjsax" created="Tue, 24 Oct 2023 19:48:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not entirely sure I understand Matthias&apos;s point regarding example 1,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well, in example one, the position is at 4, and if we say we want to respect position the result would be empty &#8211; the user would need to rewind to zero before calling the serializer to make it work. Does this make sense?&lt;/p&gt;

&lt;p&gt;We can discuss details on a KIP, but instead of introducing a new class, I was thinking if we should use a config `enable.auto.rewind=true` (by default), that users can set to `false` to get the new behavior. For this case, we don&apos;t break compatibility, and it gives user the ability to add explicit rewind call before calling serialize before they change the config to `false`.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Can you create a Jira to document&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we can re-open K4852 for this purpse?&lt;/p&gt;</comment>
                            <comment id="17779276" author="JIRAUSER302550" created="Tue, 24 Oct 2023 23:54:03 +0000"  >&lt;p&gt;&amp;gt;Well, in example one, the position is at 4, and if we say we want to respect position the result would be empty &#8211; the user would need to rewind to zero before calling the serializer to make it work. Does this make sense?&lt;/p&gt;

&lt;p&gt;Ah, nah, ByteBuffer.wrap(&quot;test&quot;.getBytes()) yields a ByteBuffer with position=0 limit=4; i.e., it&apos;s already ready to be read.&lt;/p&gt;

&lt;p&gt;I would hope to be able to get some time to start on the KIP sometime this week; happy for you two to tell me where I should do it!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17779278" author="JIRAUSER283568" created="Wed, 25 Oct 2023 00:01:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; - Here&apos;s the guide to create a KIP: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/kafka/kafka+improvement+proposals&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/kafka/kafka+improvement+proposals&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17780013" author="mjsax" created="Thu, 26 Oct 2023 16:57:53 +0000"  >&lt;p&gt;&amp;gt; Ah, nah, ByteBuffer.wrap(&quot;test&quot;.getBytes()) yields a ByteBuffer with position=0 limit=4; i.e., it&apos;s already ready to be read.&lt;/p&gt;

&lt;p&gt;Ah, great. For this case, there is not even a backward compatibility concern. &#8211; Should make it pretty easy to get the KIP approved for this case.&lt;/p&gt;</comment>
                            <comment id="17780759" author="guozhang" created="Sun, 29 Oct 2023 18:38:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; Thanks for reporting the issue, I read through the description / examples that you and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mjsax&quot; class=&quot;user-hover&quot; rel=&quot;mjsax&quot;&gt;mjsax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnee&quot; class=&quot;user-hover&quot; rel=&quot;pnee&quot;&gt;pnee&lt;/a&gt; discussed, and I agree I totally misread the original issue while reviewing it. To make it quick into the hotfix version, I&apos;m onboard with reverting the changes first.&lt;/p&gt;</comment>
                            <comment id="17781118" author="mjsax" created="Mon, 30 Oct 2023 20:18:14 +0000"  >&lt;p&gt;As discussed, reverted this in all applicable branches.&lt;/p&gt;</comment>
                            <comment id="17781911" author="JIRAUSER302550" created="Wed, 1 Nov 2023 22:09:24 +0000"  >&lt;p&gt;Thanks so much team! Maybe not the right place to ask this, but is there a plan for a 3.4.2 release? I can see that there&apos;s a 3.5.2 just waiting on some things.&lt;/p&gt;

&lt;p&gt;On the KIP front, I am still interested in pursuing that, but it&apos;s not as pressing a concern. Reading through the guidance there (thanks Philip!) it looks like I have to request committer status first? I&apos;ll probably get some CCLA stuff rolling on my end to make that happen.&lt;/p&gt;</comment>
                            <comment id="17781922" author="JIRAUSER283568" created="Wed, 1 Nov 2023 23:00:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; - You don&apos;t need to become a committer to write a KIP, apache committer means something different &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;You just need to send an email to the mailing list to request the permission per...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
If &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is your first time contributing:Sign up &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the Developer mailing list&#160;dev@kafka.apache.org&#160;. The instructions to sign up are here:&#160;http:&lt;span class=&quot;code-comment&quot;&gt;//kafka.apache.org/contactCreate a wiki ID (https://cwiki.apache.org/confluence/signup.action)Create a Jira ID (It&apos;s a different system than the wiki) using the ASF Self-serve Portal (https://selfserve.apache.org/jira-account.html)Send an email to the dev mailing list (dev@kafka.apache.org)&#160;containing your wiki ID and Jira ID requesting permissions to contribute to Apache Kafka. &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looking forward to seeing the KIP!&lt;/p&gt;</comment>
                            <comment id="17781935" author="mjsax" created="Thu, 2 Nov 2023 00:00:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luke.kirby&quot; class=&quot;user-hover&quot; rel=&quot;luke.kirby&quot;&gt;luke.kirby&lt;/a&gt; &#8211; it seems unlikely that there will be a 3.4.2 bug-fix release &#8211; I am actually surprised that we do a 3.5.2... Historically, we focus on bug-fix releases for the current release minor/major version (ie, currently 3.6) only.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kx34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>