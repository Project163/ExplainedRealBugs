<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7196] Remove heartbeat delayed operation for those removed consumers at the end of each rebalance</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7196</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;During the consumer group rebalance, when the joining group phase finishes, the heartbeat delayed operation of&#160;the consumer that&#160;fails to rejoin the group should be removed from the purgatory. Otherwise, even though the member ID of the consumer has been removed from the group, its heartbeat delayed operation is still registered in the purgatory and the heartbeat delayed operation is going to timeout and then another unnecessary rebalance is triggered because of it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13173944">KAFKA-7196</key>
            <summary>Remove heartbeat delayed operation for those removed consumers at the end of each rebalance</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrewlincong@gmail.com">Lincong Li</assignee>
                                    <reporter username="andrewlincong@gmail.com">Lincong Li</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Jul 2018 22:43:29 +0000</created>
                <updated>Tue, 16 Oct 2018 18:23:02 +0000</updated>
                            <resolved>Tue, 16 Oct 2018 18:23:02 +0000</resolved>
                                                    <fixVersion>1.0.3</fixVersion>
                    <fixVersion>1.1.2</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>core</component>
                    <component>purgatory</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="16589247" author="githubbot" created="Wed, 22 Aug 2018 18:45:38 +0000"  >&lt;p&gt;Lincong opened a new pull request #5556: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7196&quot; title=&quot;Remove heartbeat delayed operation for those removed consumers at the end of each rebalance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7196&quot;&gt;&lt;del&gt;KAFKA-7196&lt;/del&gt;&lt;/a&gt;: Remove heartbeat delayed operation for those removed cons&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5556&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Description&lt;br/&gt;
   During the consumer group rebalance, when the joining group phase finishes, the heartbeat delayed operation of the consumer that fails to rejoin the group should be removed from the purgatory. Otherwise, even though the member ID of the consumer has been removed from the group, its heartbeat delayed operation is still registered in the purgatory and the heartbeat delayed operation is going to timeout and then another unnecessary rebalance is triggered because of it.&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Summary of testing strategy&lt;br/&gt;
   Extend one of the existing unit test &quot;testRebalanceCompletesBeforeMemberJoins&quot; to verify that the delayed heart beat operation has actually been removed so that it would not trigger another unnecessary group rebalance.&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16638459" author="githubbot" created="Thu, 4 Oct 2018 16:18:03 +0000"  >&lt;p&gt;lindong28 closed pull request #5556: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7196&quot; title=&quot;Remove heartbeat delayed operation for those removed consumers at the end of each rebalance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7196&quot;&gt;&lt;del&gt;KAFKA-7196&lt;/del&gt;&lt;/a&gt;: Remove heartbeat delayed operation for those removed consumers at the end of each rebalance&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5556&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/scala/kafka/coordinator/group/GroupCoordinator.scala b/core/src/main/scala/kafka/coordinator/group/GroupCoordinator.scala&lt;br/&gt;
index c4e6dc97137..db89f14592f 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/scala/kafka/coordinator/group/GroupCoordinator.scala&lt;br/&gt;
+++ b/core/src/main/scala/kafka/coordinator/group/GroupCoordinator.scala&lt;br/&gt;
@@ -775,6 +775,7 @@ class GroupCoordinator(val brokerId: Int,&lt;br/&gt;
     group.inLock {&lt;br/&gt;
       // remove any members who haven&apos;t joined the group yet&lt;br/&gt;
       group.notYetRejoinedMembers.foreach &lt;/p&gt;
{ failedMember =&amp;gt;
+        removeHeartbeatForLeavingMember(group, failedMember)
         group.remove(failedMember.memberId)
         // TODO: cut the socket connection to the client
       }
&lt;p&gt;diff --git a/core/src/test/scala/unit/kafka/coordinator/group/GroupCoordinatorTest.scala b/core/src/test/scala/unit/kafka/coordinator/group/GroupCoordinatorTest.scala&lt;br/&gt;
index 608d7cc997f..efa44fa4ae8 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/scala/unit/kafka/coordinator/group/GroupCoordinatorTest.scala&lt;br/&gt;
+++ b/core/src/test/scala/unit/kafka/coordinator/group/GroupCoordinatorTest.scala&lt;br/&gt;
@@ -527,11 +527,29 @@ class GroupCoordinatorTest extends JUnitSuite {&lt;br/&gt;
     heartbeatResult = heartbeat(groupId, firstMemberId, firstGenerationId)&lt;br/&gt;
     assertEquals(Errors.REBALANCE_IN_PROGRESS, heartbeatResult)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// now timeout the rebalance, which should kick the unjoined member out of the group&lt;/li&gt;
	&lt;li&gt;// and let the rebalance finish with only the new member&lt;br/&gt;
+    // now timeout the rebalance&lt;br/&gt;
     timer.advanceClock(500)&lt;br/&gt;
     val otherJoinResult = await(otherJoinFuture, DefaultSessionTimeout+100)&lt;br/&gt;
+    val otherMemberId = otherJoinResult.memberId&lt;br/&gt;
+    val otherGenerationId = otherJoinResult.generationId&lt;br/&gt;
+    EasyMock.reset(replicaManager)&lt;br/&gt;
+    val syncResult = syncGroupLeader(groupId, otherGenerationId, otherMemberId, Map(otherMemberId -&amp;gt; Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;()))&lt;br/&gt;
+    assertEquals(Errors.NONE, syncResult._2)&lt;br/&gt;
+&lt;br/&gt;
+    // the unjoined member should be kicked out from the group&lt;br/&gt;
     assertEquals(Errors.NONE, otherJoinResult.error)&lt;br/&gt;
+    EasyMock.reset(replicaManager)&lt;br/&gt;
+    heartbeatResult = heartbeat(groupId, firstMemberId, firstGenerationId)&lt;br/&gt;
+    assertEquals(Errors.UNKNOWN_MEMBER_ID, heartbeatResult)&lt;br/&gt;
+&lt;br/&gt;
+    // the joined member should get heart beat response with no error. Let the new member keep heartbeating for a while&lt;br/&gt;
+    // to verify that no new rebalance is triggered unexpectedly&lt;br/&gt;
+    for ( _ &amp;lt;-  1 to 20) 
{
+      timer.advanceClock(500)
+      EasyMock.reset(replicaManager)
+      heartbeatResult = heartbeat(groupId, otherMemberId, otherGenerationId)
+      assertEquals(Errors.NONE, heartbeatResult)
+    }
&lt;p&gt;   }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   @Test&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w74n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>