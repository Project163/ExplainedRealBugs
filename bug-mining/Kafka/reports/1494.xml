<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:01:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5289] One StopReplicaRequest will caused two Responses</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5289</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;After discussed with my friend markTC&#65292;we find a bug.&lt;br/&gt;
One StopReplicaRequest will caused two Responses.&lt;/p&gt;

&lt;p&gt;At core/src/main/scala/kafka/server/KafkaApi.class 175 and 176 lines.&lt;/p&gt;

&lt;p&gt;When an exception caused at &apos;replicaManager.replicaFetcherManager.shutdownIdleFetcherThreads()&apos;, &lt;br/&gt;
will also return two responses.&lt;/p&gt;

&lt;p&gt;one is at 175 lines &apos;requestChannel.sendResponse(new RequestChannel.Response(request, new ResponseSend(request.connectionId, responseHeader, response)))&apos; and another at 111 lines &apos;requestChannel.sendResponse(new Response(request, new ResponseSend(request.connectionId, respHeader, response)))&apos;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13073358">KAFKA-5289</key>
            <summary>One StopReplicaRequest will caused two Responses</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ijuma">Ismael Juma</assignee>
                                    <reporter username="xuzq_zander">ZanderXu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 May 2017 08:43:43 +0000</created>
                <updated>Tue, 25 Jul 2017 11:11:33 +0000</updated>
                            <resolved>Mon, 22 May 2017 12:39:41 +0000</resolved>
                                    <version>0.10.0.0</version>
                                    <fixVersion>0.11.0.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16017075" author="ijuma" created="Fri, 19 May 2017 08:51:47 +0000"  >&lt;p&gt;Thanks for the report. Great catch. What kind of exceptions can `shutdownIdleFetcherThreads()` throw?&lt;/p&gt;</comment>
                            <comment id="16017098" author="xuzq_zander" created="Fri, 19 May 2017 09:08:23 +0000"  >&lt;p&gt;We overwrote the  ReplicaFetcherManager class, and threw an exception in method shutdownIdleFetcherThreads(). &lt;br/&gt;
In the original code, an exception will be threw in fetcher.shutdown(), such as InterruptedException when the thread interrupted.&lt;/p&gt;</comment>
                            <comment id="16017102" author="githubbot" created="Fri, 19 May 2017 09:13:24 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3096&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3096&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5289&quot; title=&quot;One StopReplicaRequest will caused two Responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5289&quot;&gt;&lt;del&gt;KAFKA-5289&lt;/del&gt;&lt;/a&gt;: handleStopReplica should not send a second response&lt;/p&gt;

&lt;p&gt;    `shutdownIdleFetcherThreads()` can throw InterruptedException&lt;br/&gt;
    for example.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; kafka-5289-stop-replica-should-not-send-two-responses&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3096.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3096.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3096&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 09eb235157af651dacf4397c7ac84815937fa425&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-05-19T09:11:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5289&quot; title=&quot;One StopReplicaRequest will caused two Responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5289&quot;&gt;&lt;del&gt;KAFKA-5289&lt;/del&gt;&lt;/a&gt;: handleStopReplica should not send a second response&lt;/p&gt;

&lt;p&gt;    `shutdownIdleFetcherThreads()` can throw InterruptedException&lt;br/&gt;
    for example.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16017105" author="xuzq_zander" created="Fri, 19 May 2017 09:15:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;  Why not put the line &apos;requestChannel.sendResponse(new RequestChannel.Response(request, new ResponseSend(request.connectionId, responseHeader, response)))&apos; in the last row of the method handleStopReplicaRequest(request: RequestChannel.Request)?&lt;/p&gt;</comment>
                            <comment id="16017111" author="marktc" created="Fri, 19 May 2017 09:20:58 +0000"  >&lt;p&gt;I think the importation thing is not &quot;What kind of exceptions can `shutdownIdleFetcherThreads()` throw?&quot;.It is that requestChannel.sendResponse(new RequestChannel.Response(request, new ResponseSend() should be put at the last line.Even though the shutdownIdleFetcherThreads() throw nothing,but it is very danger. Because if an error be thrown after send  requestChannel.sendResponse,the error will be caught by KafkaApi and cause StopReplicaRequest.handleError which will send response again.&lt;/p&gt;</comment>
                            <comment id="16017122" author="ijuma" created="Fri, 19 May 2017 09:32:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xuzq_zander&quot; class=&quot;user-hover&quot; rel=&quot;xuzq_zander&quot;&gt;xuzq_zander&lt;/a&gt;, because we don&apos;t want to delay the response while the idle threads are being shutdown.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markTC&quot; class=&quot;user-hover&quot; rel=&quot;markTC&quot;&gt;markTC&lt;/a&gt;, both questions are important, actually. Yes, `KafkaApis` should protect itself against exceptions if it performs an operation after the response is sent, but there could also have been a bug in `shutdownIdleFetcherThreads()` (and hence the question).&lt;/p&gt;</comment>
                            <comment id="16017208" author="marktc" created="Fri, 19 May 2017 10:32:02 +0000"  >&lt;p&gt;just catch it&lt;/p&gt;</comment>
                            <comment id="16019531" author="rsivaram" created="Mon, 22 May 2017 12:39:41 +0000"  >&lt;p&gt;Issue resolved by pull request 3096&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/3096&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3096&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16019532" author="githubbot" created="Mon, 22 May 2017 12:40:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3096&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3096&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12868911" name="KAFKA-5289.patch" size="891" author="markTC" created="Fri, 19 May 2017 10:32:02 +0000"/>
                            <attachment id="12868903" name="handleStopReplicaRequest.png" size="293834" author="xuzq_zander" created="Fri, 19 May 2017 08:47:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f7kn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>markTC</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>