<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:15:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-7481] Consider options for safer upgrade of offset commit value schema</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-7481</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;KIP-211 and KIP-320 add new versions of the offset commit value schema. The use of the new schema version is controlled by the `inter.broker.protocol.version` configuration.  Once the new inter-broker version is in use, it is not possible to downgrade since the older brokers will not be able to parse the new schema. &lt;/p&gt;

&lt;p&gt;The options at the moment are the following:&lt;/p&gt;

&lt;p&gt;1. Do nothing. Users can try the new version and keep `inter.broker.protocol.version` locked to the old release. Downgrade will still be possible, but users will not be able to test new capabilities which depend on inter-broker protocol changes.&lt;br/&gt;
2. Instead of using `inter.broker.protocol.version`, we could use `message.format.version`. This would basically extend the use of this config to apply to all persistent formats. The advantage is that it allows users to upgrade the broker and begin using the new inter-broker protocol while still allowing downgrade. But features which depend on the persistent format could not be tested.&lt;/p&gt;

&lt;p&gt;Any other options?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13189610">KAFKA-7481</key>
            <summary>Consider options for safer upgrade of offset commit value schema</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="4" iconUrl="https://issues.apache.org/jira/images/icons/statuses/reopened.png" description="This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.">Reopened</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="hachikuji">Jason Gustafson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Oct 2018 00:28:54 +0000</created>
                <updated>Wed, 13 Feb 2019 18:45:50 +0000</updated>
                                                                                <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="16639095" author="ijuma" created="Fri, 5 Oct 2018 00:32:10 +0000"  >&lt;p&gt;Another option would be to introduce a new config. Option 2 may be a reasonable compromise. I&apos;d be interested in what others think.&lt;/p&gt;</comment>
                            <comment id="16654757" author="lindong" created="Thu, 18 Oct 2018 07:29:43 +0000"  >&lt;p&gt;Option 2 sounds good to me. For option 2, it is true that &quot;features which depend on the persistent format could not be tested&quot;. This is anyway the case for all other features (e.g. transaction semantics) that depends on the newer message format, right? So this is the existing state and I probably will not call it the downside of option 2.&lt;/p&gt;</comment>
                            <comment id="16654759" author="lindong" created="Thu, 18 Oct 2018 07:31:23 +0000"  >&lt;p&gt;BTW, this is currently the only blocking issue for 2.1.0 release.&#160;It will be&#160;great to fix it and unblock 2.1.0 release.&lt;/p&gt;</comment>
                            <comment id="16655701" author="hachikuji" created="Thu, 18 Oct 2018 18:18:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; Thanks for the responses. I find myself leaning toward using a separate configuration as a long-term solution. There are two basic problems with reusing the `log.message.format.version`. First, it can be overridden at the topic level, which does not make sense for &quot;global&quot; message schemas like the consumer offsets. Second, its usage is tied to performance concerns (in particular down-conversion), which are not directly related to whether or not downgrade should be supported. In any case, my feeling is that we probably need a KIP and a larger discussion before either making a semantic change to one of the configs or adding a new config.&lt;/p&gt;

&lt;p&gt;In order to unblock the release, I am wondering if we can do option 1. It might not be ideal, but it is consistent with how we have upgraded internal schemas in the past (this is how we have handled previous bumps to the __consumer_offsets schemas). We could add some additional upgrade notes to emphasize that downgrade is not possible after changing the inter-broker protocol version. What do you think?&lt;/p&gt;</comment>
                            <comment id="16656026" author="lindong" created="Thu, 18 Oct 2018 23:26:03 +0000"  >&lt;p&gt;Thanks for the detailed explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;. I agree with your short term and long term solution. I assume previously when we upgrade the consumer offset topic schema version, we have the same issue of not being able to downgrade the Kafka broker version after the schema version has been upgraded. So this is the status quo.&lt;/p&gt;

&lt;p&gt;I took a look at the upgrade.html. It seems that we currently don&apos;t have downgrade note. Maybe we need to additionally note in the upgrade.html that after user bumps up the inter.broker.protocol to 2.1.0, they can no longer downgrade the server version to be below 2.1.0.&lt;/p&gt;</comment>
                            <comment id="16656051" author="ijuma" created="Thu, 18 Oct 2018 23:55:03 +0000"  >&lt;p&gt;In the past we did a major bump whenever we changed the message format version. I think it&apos;s surprising that a minor version upgrade causes irreversible disk changes once you bump the inter.broker.protocol.version.&#160;It&#160;is usually safe to change this config and change it back. It would be useful to know when we last bumped the consumer offsets schema in a non major release.&lt;/p&gt;</comment>
                            <comment id="16657064" author="hachikuji" created="Fri, 19 Oct 2018 16:45:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; I&apos;m not sure if it was the last time, but we bumped the group metadata schema in 0.10.1 for the addition of the rebalance timeout.&lt;/p&gt;</comment>
                            <comment id="16657635" author="lindong" created="Sat, 20 Oct 2018 01:09:58 +0000"  >&lt;p&gt;Previously I thought that major version indicates 1) major features addition for marketing purpose and 2) backward incompatible change. I was not aware that user in general will also relate major version bump with&#160;1) irreversible disk change and 2) inability to downgrade.&lt;/p&gt;</comment>
                            <comment id="16657718" author="hachikuji" created="Sat, 20 Oct 2018 04:26:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; For consideration, I drafted a short KIP: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-384%3A+Add+config+for+incompatible+changes+to+persistent+metadata&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/KAFKA/KIP-384%3A+Add+config+for+incompatible+changes+to+persistent+metadata&lt;/a&gt;. We could either try to get this in for this release or choose one of the other options for now. I think long term we should probably have something like this, so if we can agree on the approach, perhaps now is as good of a time as any.&lt;/p&gt;</comment>
                            <comment id="16657754" author="lindong" created="Sat, 20 Oct 2018 06:34:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; Thanks for the quick work on the KIP! The KIP looks good overall. I may have some question about how to make it easier for user to understand the use of&#160;inter.broker.protocol.version,&#160;message.format.version and&#160;persistent.metadata.version and document it in both Kafka wiki and the KIP. This can be discussed in more detail in the KIP discussion thread. Overall I think this KIP is the right long term solution for the problem.&lt;/p&gt;

&lt;p&gt;I am inclined not to block the 2.1 release on this KIP given that it is an existing issue that has affected previous release. But I am open to the other choice if other&#160;committers prefer that.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16658038" author="ijuma" created="Sun, 21 Oct 2018 01:25:09 +0000"  >&lt;p&gt;Thanks for the KIP &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt;, it&apos;s very helpful to have a write-up to evaluate the options better. After thinking about it some more, I think 3 configs is going to be too complicated to explain and the benefit is not enough. Instead, we should change the documentation&#160;of `inter.broker.protocol.version` so that it&apos;s not safe to change it back after an upgrade. The recommendation would then be to stick with the old version for some time and only bump to the new version once a downgrade was no longer necessary.&lt;/p&gt;

&lt;p&gt;Thoughts? cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; who may also have some thoughts.&lt;/p&gt;</comment>
                            <comment id="16658580" author="ewencp" created="Mon, 22 Oct 2018 05:16:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; Arguably your suggestion isn&apos;t something we should do in a minor version since it is a breaking semantic change, though I don&apos;t know whether we&apos;ve really committed to the reversibility of inter broker protocol version. The upgrade notes already don&apos;t really point out that you can roll that back. In fact, reading them now I&apos;m not sure how many people even realize this is possible &#8211; we never really explain anything about &lt;b&gt;why&lt;/b&gt; the upgrade process is the way it is. At a bare minimum, if we&apos;re aware of any cases where people have rolled back without reverting the broker version entirely, I would be wary of changing the semantics like this.&lt;/p&gt;

&lt;p&gt;I think the tension between the two existing configs is that inter.broker.protocol.version &lt;b&gt;today&lt;/b&gt; is basically all the stateless protocol stuff, which makes it safe to upgrade/downgrade, whereas log.message.format.version is about persisted format, but for client-facing data. The consumer state (and other examples from the KIP) are internal but persistent, which makes neither a great fit.&lt;/p&gt;

&lt;p&gt;re: being too complicated to explain, it seems like today we basically just rely on telling them the mechanics and only for log.message.format.version do we go into a bit more detail, and only because of the perf impact. If we just documented what to do with the new config and it just fits in alongside one of the other two for the common case, is it really that much more complicated?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We should probably also be clear about upgrade/downgrade scenarios. For example, the rejected alternatives state:&lt;/p&gt;

&lt;blockquote&gt;
&lt;ol&gt;
	&lt;li&gt;We considered overloading `inter.broker.protocol.version` to include changes to the persistent metadata format. The main drawback is that users cannot test features which depend on the inter-broker protocol behavior without committing to the upgrade. For example, KIP-320 makes changes to replication protocol which may require additional testing.&lt;/li&gt;
&lt;/ol&gt;

&lt;/blockquote&gt;

&lt;p&gt;It took me a while to realize that &quot;without committing to the upgrade&quot; specifically means the &lt;b&gt;broker version upgrade&lt;/b&gt;, not the &lt;b&gt;upgrade to the metadata format&lt;/b&gt;. Even with a new config, you could roll back further use of that format, but brokers could still process the data (as mentioned elsewhere in the KIP wrt an in-progress rolling update to turn on the new format) as long as it is compatible (and it seems likely we&apos;d always have a compatibility path since we could always have clusters with both formats).&lt;/p&gt;

&lt;p&gt;I&apos;m hesitant to add more configs since we already have tons, but I also wouldn&apos;t want to conflate two things in one config unless we&apos;re really convinced they belong together. I&apos;d rather have the configs and then hide them behind some aggregate config that overrides them and handles the 99% use case as cleanly as possible than end up with fewer configs but which are harder to reason about.&lt;/p&gt;</comment>
                            <comment id="16659227" author="ijuma" created="Mon, 22 Oct 2018 17:50:54 +0000"  >&lt;p&gt;The key insight for me is that the the benefit of having a separate config for the stateless parts is minimal and increasing the testing surface area for both upgrades and downgrades is not desirable (in addition to the addition complexity for the user).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yes, these things should ideally not be done in minor releases, but we are where we are.&lt;/p&gt;</comment>
                            <comment id="16659935" author="ewencp" created="Tue, 23 Oct 2018 01:55:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt; As it stands today, is the only use case for inter.broker.protocol.version to hold back the version during rolling upgrade? Do we even really need this with KIP-35? It sounds like aside from the two rolling bounce upgrade, you expect people wouldn&apos;t generally be using this today (given you say the benefit is minimal)?&lt;/p&gt;

&lt;p&gt;I&apos;m fine overloading one of them if we think the existing use case for it is either ok to compromise with additional restrictions OR tradeoffs aren&apos;t weird like they are for log.message.format.version. Test surface area is a fair point, wrt complexity I guess I don&apos;t see that much of a difference for users since they just copy/paste 2 lines rather than 1 and otherwise probably blindly follow the directions.&lt;/p&gt;</comment>
                            <comment id="16661482" author="lindong" created="Tue, 23 Oct 2018 23:49:05 +0000"  >&lt;p&gt;I removed 2.1.0 tag so that release.py would generate release for 2.1.0-RC0. The goal is for open source users to be able to help test this release even before we have addressed all issues. We can add the tag back later.&lt;/p&gt;</comment>
                            <comment id="16662460" author="ewencp" created="Wed, 24 Oct 2018 15:53:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; we might just want to update the script with a flag to override any remaining blockers (and maybe even just list them in the notes for the RC). Ideally we don&apos;t hit this type of situation regularly, but when we do, might be better to be able to override on the release mgr side rather than possibly losing stuff by adjusting priorities on the JIRA.&lt;/p&gt;</comment>
                            <comment id="16662555" author="lindong" created="Wed, 24 Oct 2018 17:05:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt; for the suggestion. I agree. Will do this in the future.&lt;/p&gt;</comment>
                            <comment id="16662610" author="lindong" created="Wed, 24 Oct 2018 17:45:55 +0000"  >&lt;p&gt;After reading through the discussion and thinking through the problem more, I have the following alternative solution.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Basically we have the following three&#160;catagories of features:&lt;/p&gt;

&lt;p&gt;1) Features that require only the protocol change. These features can be rolled back.&lt;/p&gt;

&lt;p&gt;2) Features that require both the protocol and disk format change without having performance impact. These features can not be rolled back.&lt;/p&gt;

&lt;p&gt;3) Features that require both the protocol and disk format change and have performance impact. These features can not be rolled back.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My proposed solution is to this:&lt;/p&gt;

&lt;p&gt;1) For features that&#160;require only the protocol change, let broker automatically detect the protocol version (e.g. KIP-35) as&#160;the lower version of the two brokers in communication instead of controlling the version explicitly using inter.broker.protocol.version.&lt;/p&gt;

&lt;p&gt;2) For features that&#160;require both the protocol&#160;and disk format change without having performance impact, the version can be&#160;specified explicitly using the existing inter.broker.protocol.version config. And we tell user that this config can not be rolled back after it is bumped.&lt;/p&gt;

&lt;p&gt;3) For features&#160;that require both the protocol and disk format change and have performance impact, the version will be&#160;specified explicitly using&#160;message.format.version as we are currently doing. There is no change in this category.&lt;/p&gt;

&lt;p&gt;This solution does not increase config or the testing surface area which meet the goal of Ismael. And this&#160;solution also minimizes the cases in which we do not allow broker version downgrade which meet the goal of Jason and Ewen. One additional benefit, as mentioned by Ewen with KIP-35, is that for features that require only the protocol change, which is the common case, user only need one rolling bounce to pick up the feature.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Does this sound good?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16662619" author="lindong" created="Wed, 24 Oct 2018 17:52:47 +0000"  >&lt;p&gt;BTW, if we think this the long term solution, then this issue is no longer blocking for this 2.1.0 release because we will tell user that both&#160;inter.broker.protocol.version and&#160;message.format.version involves disk format change and thus can not be rolled back.&lt;/p&gt;</comment>
                            <comment id="16663144" author="ewencp" created="Thu, 25 Oct 2018 03:20:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lindong&quot; class=&quot;user-hover&quot; rel=&quot;lindong&quot;&gt;lindong&lt;/a&gt; I think anything here ends up having at least &lt;b&gt;some&lt;/b&gt; blocker component for 2.1 because we&apos;re either a) changing the previously understood (even if not promised) semantics for a setting or b) need to at least do some docs/upgrade notes clarifications.&lt;/p&gt;

&lt;p&gt;I think we may also need to consider both short and long term solutions. Anything relying on KIP-35 to check inter-broker protocol compatibility seems like not a good idea for 2.1 this late in the release cycle. (I mentioned for completeness &amp;amp; getting to a good long term solution even if we have a short-term hack, but I don&apos;t think that&apos;s a practical change to get into 2.1 at this point.) Also, even if we switch to using KIP-35, there&apos;s a whole compatibility story wrt existing settings that would need to be worked out.&lt;/p&gt;

&lt;p&gt;re: your specific proposal, it generally sounds reasonable but wrt testing surface area, it actually does increase it to some degree because we would need tests that validate correct behavior via KIP-35 checks while upgrading.&lt;/p&gt;

&lt;p&gt;Longer term, I definitely think making things &quot;just work&quot; rather than having the user manage protocol versions manually during upgrade is better. Just not sure we can actually make that happen immediately for this release.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16663274" author="lindong" created="Thu, 25 Oct 2018 05:42:15 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewencp&quot; class=&quot;user-hover&quot; rel=&quot;ewencp&quot;&gt;ewencp&lt;/a&gt;, regarding the change for 2.1.0 release, say we don&apos;t make further code change for this issue, I agree it is good to clarify in the upgrade note that&#160;inter.broker.protocol.version can not be reverted after it is bumped to 2.1.0.&lt;/p&gt;

&lt;p&gt;Regarding the short term solution, I also prefer&#160;not to make big code change to e.g. use KIP-35 idea to solve the issue here. I would prefer to just clarify in the upgrade note that&#160;inter.broker.protocol.version can not be reverted after it is bumped to 2.1.0. Also, since&#160;we currently do not mention anything about downgrade in the upgrade note, and the other config&#160;log.message.format.version can not be downgraded, I am not sure user actually expect to be able to downgrade the inter.broker.protocol. So I feel this short term solution is OK&#160;and strictly speaking it does not break any semantic guarantee.&lt;/p&gt;

&lt;p&gt;Regarding the long term solution, it seems that we actually want user to&#160;manually&#160;manage the protocol version config in order to pickup any new feature that can change the data format on disk. Otherwise, say we&#160;always make things work with one rolling bounce, then whenever there is feature that change data format on disk, we will have to bump up the major version for the next Kafka release to indicate that the version can not be downgraded, which delays the acceptance for the release. Also, if we automatically bump up the&#160;message.format.version for the new broker version, the broker performance will downgrade so much because user wont&apos; even have time upgrade client library version for most users in the organization.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16667490" author="ijuma" created="Mon, 29 Oct 2018 17:29:48 +0000"  >&lt;p&gt;Using KIP-35 to negotiate protocols is something that has been discussed and something we want to do, but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; pointed out that we need to think it through to make sure it works. Another way to avoid two restarts is to use dynamic broker configs to bump the inter.broker.protocol.version. I am still not sure if there&apos;s a lot of value in having two separate upgrade states, but could be convinced otherwise.&lt;/p&gt;</comment>
                            <comment id="16667977" author="junrao" created="Tue, 30 Oct 2018 01:24:00 +0000"  >&lt;p&gt;I agree that introducing a new config probably needs more thought. Between option 1 and 2, option 2 doesn&apos;t seem to provide much more benefits than option 1 and option 1 is simpler. So, I am in favor of option 1 too.&lt;/p&gt;</comment>
                            <comment id="16669120" author="hachikuji" created="Tue, 30 Oct 2018 17:49:39 +0000"  >&lt;p&gt;I am also in favor of option 1 for the time being. While writing the KIP above, I felt the actual benefit to having a separate configuration was marginal and probably not worth the upgrade complexity that it adds. Note that I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7570&quot; title=&quot;Make internal offsets/transaction schemas forward compatible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7570&quot;&gt;KAFKA-7570&lt;/a&gt; to explore better options for managing the compatibility of the internal topic schemas. If we could figure that out, then we may not ultimately need the separate configuration. This discussion has also made it clear that we need a consistent and tested approach for downgrading Kafka. I also filed &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7571&quot; title=&quot;Add system tests for downgrading Kafka&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7571&quot;&gt;KAFKA-7571&lt;/a&gt; to add system tests, which are lacking at the moment. Then we just need to agree on the long-term approach and document it.&lt;/p&gt;

&lt;p&gt;For now, I will go ahead and submit a PR to add some additional upgrade notes mentioning the incompatible changes to the offsets schema and the impact for downgrades.&lt;/p&gt;</comment>
                            <comment id="16669203" author="githubbot" created="Tue, 30 Oct 2018 18:59:46 +0000"  >&lt;p&gt;hachikuji opened a new pull request #5857: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7481&quot; title=&quot;Consider options for safer upgrade of offset commit value schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7481&quot;&gt;KAFKA-7481&lt;/a&gt;; Add upgrade/downgrade notes for 2.1.x&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5857&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   We seemed to be missing the usual rolling upgrade instructions so I&apos;ve added them and emphasized the impact for downgrades after bumping the inter-broker protocol version.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Committer Checklist (excluded from commit message)&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Verify design and implementation&lt;/li&gt;
	&lt;li&gt;[ ] Verify test coverage and CI build status&lt;/li&gt;
	&lt;li&gt;[ ] Verify documentation (including upgrade notes)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16669323" author="lindong" created="Tue, 30 Oct 2018 20:54:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&#160;Regarding `I am still not sure if there&apos;s a lot of value in having two separate upgrade states`, I think we need at least one separate upgrade state for changes that can not be rolled back, since it seems weird not to be able to downgrade if there is only minor version change in the Kafka. And the rational for the second separate upgrade state is that, there are two categories of changes that prevents downgrade, e.g. those that changes topic schema and those that changes message format. It is common for user to be willing to pickup the first category of change very soon, and only pickup the second category of change much later after client library has been upgraded to&#160;reduce&#160;performance cost&#160;in the broker.&lt;/p&gt;</comment>
                            <comment id="16669360" author="ijuma" created="Tue, 30 Oct 2018 21:32:18 +0000"  >&lt;p&gt;The state where you can roll back is &quot;upgrade binaries&quot; and don&apos;t bump either of the configs. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16669391" author="lindong" created="Tue, 30 Oct 2018 22:10:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ijuma&quot; class=&quot;user-hover&quot; rel=&quot;ijuma&quot;&gt;ijuma&lt;/a&gt;&#160;Yeah this works and&#160;this&#160;is why I think we need two separate upgrade states. Currently there are three possible upgrade state, i.e. binary version is upgraded, binary version + inter.broker.protocol.version are upgraded, and&#160;binary version + inter.broker.protocol.version + message.format.version is upgraded. I guess my point is that it is reasonable to keep these three states in the long term.&lt;/p&gt;</comment>
                            <comment id="16670137" author="ijuma" created="Wed, 31 Oct 2018 13:57:12 +0000"  >&lt;p&gt;Yeah, in my original comment, I was not counting the &quot;binary upgraded&quot; state. My claim is that having 4 states: &quot;binary upgraded&quot;, &quot;binary upgraded, new protocol version, old persistent metadata, old message format&quot;, &quot;binary upgraded, new protocol version, new persistent metadata, old message format&quot;, &quot;new protocol, new persistent metadata, new message format&quot; is not useful enough.&lt;/p&gt;

&lt;p&gt;Another example, in 2.0.0 we only allow prefixed ACLs if inter.broker.protocol.version is 2.0. Downgrading in this case is quite dangerous since the older broker won&apos;t know what to do with prefixed ACLs.&lt;/p&gt;</comment>
                            <comment id="16671625" author="songxinlei" created="Thu, 1 Nov 2018 13:40:12 +0000"  >&lt;p&gt;kafka version1.0 &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2018-11-01 21:37:26,250&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller id=13 epoch=8&amp;#93;&lt;/span&gt; Initiated state change for partition topic.cloud.service.bigdata.news_contents_submits_stats.content-6 from OnlinePartition to OnlinePartition failed (state.change.logger)&lt;br/&gt;
kafka.common.StateChangeFailedException: &lt;span class=&quot;error&quot;&gt;&amp;#91;Controller id=13 epoch=8&amp;#93;&lt;/span&gt; Encountered error while electing leader for partition topic.cloud.service.bigdata.news_contents_submits_stats.content-6 due to: Preferred replica 12 for partition topic.cloud.service.bigdata.news_contents_submits_stats.content-6 is either not alive or not in the isr. Current leader and ISR: [&lt;/p&gt;
{&quot;leader&quot;:13,&quot;leader_epoch&quot;:74,&quot;isr&quot;:[13]}
&lt;p&gt;]&lt;br/&gt;
        at kafka.controller.PartitionStateMachine.electLeaderForPartition(PartitionStateMachine.scala:324)&lt;/p&gt;

&lt;p&gt;How did it happen?How to solve?&lt;/p&gt;

&lt;p&gt;coding&lt;br/&gt;
def selectLeader(topicAndPartition: TopicAndPartition,&lt;br/&gt;
                   currentLeaderAndIsr: LeaderAndIsr): (LeaderAndIsr, Seq&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt;) = {&lt;br/&gt;
    val assignedReplicas = controllerContext.partitionReplicaAssignment(topicAndPartition)&lt;br/&gt;
    val preferredReplica = assignedReplicas.head&lt;br/&gt;
    // check if preferred replica is the current leader&lt;br/&gt;
    val currentLeader = controllerContext.partitionLeadershipInfo(topicAndPartition).leaderAndIsr.leader&lt;br/&gt;
    if (currentLeader == preferredReplica) &lt;/p&gt;
{
      throw new LeaderElectionNotNeededException(&quot;Preferred replica %d is already the current leader for partition %s&quot;
                                                   .format(preferredReplica, topicAndPartition))
    }
&lt;p&gt; else {&lt;br/&gt;
      info(&quot;Current leader %d for partition %s is not the preferred replica.&quot;.format(currentLeader, topicAndPartition) +&lt;br/&gt;
        &quot; Triggering preferred replica leader election&quot;)&lt;br/&gt;
      // check if preferred replica is not the current leader and is alive and in the isr&lt;br/&gt;
      if (controllerContext.isReplicaOnline(preferredReplica, topicAndPartition) &amp;amp;&amp;amp; currentLeaderAndIsr.isr.contains(preferredReplica)) &lt;/p&gt;
{
        val newLeaderAndIsr = currentLeaderAndIsr.newLeader(preferredReplica)
        (newLeaderAndIsr, assignedReplicas)
      }
&lt;p&gt; else &lt;/p&gt;
{
        throw new StateChangeFailedException(s&quot;Preferred replica $preferredReplica for partition $topicAndPartition &quot; +
          s&quot;is either not alive or not in the isr. Current leader and ISR: [$currentLeaderAndIsr]&quot;)
      }
&lt;p&gt;    }&lt;/p&gt;</comment>
                            <comment id="16677334" author="githubbot" created="Tue, 6 Nov 2018 21:58:53 +0000"  >&lt;p&gt;lindong28 closed pull request #5857: &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-7481&quot; title=&quot;Consider options for safer upgrade of offset commit value schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-7481&quot;&gt;KAFKA-7481&lt;/a&gt;; Add upgrade/downgrade notes for 2.1.x&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/kafka/pull/5857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/5857&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/docs/upgrade.html b/docs/upgrade.html&lt;br/&gt;
index 41e2277bb24..33d9964113a 100644&lt;br/&gt;
&amp;#8212; a/docs/upgrade.html&lt;br/&gt;
+++ b/docs/upgrade.html&lt;br/&gt;
@@ -20,6 +20,47 @@&lt;br/&gt;
 &amp;lt;script id=&quot;upgrade-template&quot; type=&quot;text/x-handlebars-template&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt; &amp;lt;h4&amp;gt;&amp;lt;a id=&quot;upgrade_2_1_0&quot; href=&quot;#upgrade_2_1_0&quot;&amp;gt;Upgrading from 0.8.x, 0.9.x, 0.10.0.x, 0.10.1.x, 0.10.2.x, 0.11.0.x, 1.0.x, 1.1.x, or 2.0.0 to 2.1.0&amp;lt;/a&amp;gt;&amp;lt;/h4&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
+&amp;lt;p&amp;gt;&amp;lt;b&amp;gt;Note that 2.1.x contains a change to the internal schema used to store consumer offsets. Once the upgrade is&lt;br/&gt;
+  complete, it will not be possible to downgrade to previous versions. See the rolling upgrade notes below for more detail.&amp;lt;/b&amp;gt;&amp;lt;/p&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
+&amp;lt;p&amp;gt;&amp;lt;b&amp;gt;For a rolling upgrade:&amp;lt;/b&amp;gt;&amp;lt;/p&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
+&amp;lt;ol&amp;gt;&lt;br/&gt;
+    &amp;lt;li&amp;gt; Update server.properties on all brokers and add the following properties. CURRENT_KAFKA_VERSION refers to the version you&lt;br/&gt;
+        are upgrading from. CURRENT_MESSAGE_FORMAT_VERSION refers to the message format version currently in use. If you have previously&lt;br/&gt;
+        overridden the message format version, you should keep its current value. Alternatively, if you are upgrading from a version prior&lt;br/&gt;
+        to 0.11.0.x, then CURRENT_MESSAGE_FORMAT_VERSION should be set to match CURRENT_KAFKA_VERSION.&lt;br/&gt;
+        &amp;lt;ul&amp;gt;&lt;br/&gt;
+            &amp;lt;li&amp;gt;inter.broker.protocol.version=CURRENT_KAFKA_VERSION (e.g. 0.8.2, 0.9.0, 0.10.0, 0.10.1, 0.10.2, 0.11.0, 1.0, 1.1).&amp;lt;/li&amp;gt;&lt;br/&gt;
+            &amp;lt;li&amp;gt;log.message.format.version=CURRENT_MESSAGE_FORMAT_VERSION  (See &amp;lt;a href=&quot;#upgrade_10_performance_impact&quot;&amp;gt;potential performance impact&lt;br/&gt;
+                following the upgrade&amp;lt;/a&amp;gt; for the details on what this configuration does.)&amp;lt;/li&amp;gt;&lt;br/&gt;
+        &amp;lt;/ul&amp;gt;&lt;br/&gt;
+        If you are upgrading from 0.11.0.x, 1.0.x, 1.1.x, or 2.0.x and you have not overridden the message format, then you only need to override&lt;br/&gt;
+        the inter-broker protocol version.&lt;br/&gt;
+        &amp;lt;ul&amp;gt;&lt;br/&gt;
+            &amp;lt;li&amp;gt;inter.broker.protocol.version=CURRENT_KAFKA_VERSION (0.11.0, 1.0, 1.1, 2.0).&amp;lt;/li&amp;gt;&lt;br/&gt;
+        &amp;lt;/ul&amp;gt;&lt;br/&gt;
+    &amp;lt;/li&amp;gt;&lt;br/&gt;
+    &amp;lt;li&amp;gt; Upgrade the brokers one at a time: shut down the broker, update the code, and restart it. Once you have done so, the&lt;br/&gt;
+        brokers will be running the latest version and you can verify that the cluster&apos;s behavior and performance meets expectations.&lt;br/&gt;
+        It is still possible to downgrade at this point if there are any problems. &lt;br/&gt;
+    &amp;lt;/li&amp;gt;&lt;br/&gt;
+    &amp;lt;li&amp;gt; Once the cluster&apos;s behavior and performance has been verified, bump the protocol version by editing&lt;br/&gt;
+        &amp;lt;code&amp;gt;inter.broker.protocol.version&amp;lt;/code&amp;gt; and setting it to 2.1.&lt;br/&gt;
+    &amp;lt;/li&amp;gt;&lt;br/&gt;
+    &amp;lt;li&amp;gt; Restart the brokers one by one for the new protocol version to take effect. Once the brokers begin using the latest&lt;br/&gt;
+        protocol version, it will no longer be possible to downgrade the cluster to an older version.&lt;br/&gt;
+    &amp;lt;/li&amp;gt;&lt;br/&gt;
+    &amp;lt;li&amp;gt; If you have overridden the message format version as instructed above, then you need to do one more rolling restart to&lt;br/&gt;
+        upgrade it to its latest version. Once all (or most) consumers have been upgraded to 0.11.0 or later,&lt;br/&gt;
+        change log.message.format.version to 2.1 on each broker and restart them one by one. Note that the older Scala clients,&lt;br/&gt;
+        which are no longer maintained, do not support the message format introduced in 0.11, so to avoid conversion costs &lt;br/&gt;
+        (or to take advantage of &amp;lt;a href=&quot;#upgrade_11_exactly_once_semantics&quot;&amp;gt;exactly once semantics&amp;lt;/a&amp;gt;),&lt;br/&gt;
+        the newer Java clients must be used.&lt;br/&gt;
+    &amp;lt;/li&amp;gt;&lt;br/&gt;
+&amp;lt;/ol&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
 &amp;lt;p&amp;gt;&amp;lt;b&amp;gt;Additional Upgrade Notes:&amp;lt;/b&amp;gt;&amp;lt;/p&amp;gt;&lt;/p&gt;

&lt;p&gt; &amp;lt;ol&amp;gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16758861" author="mjsax" created="Sat, 2 Feb 2019 03:30:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; This is marked as blocker, was closed, and reopened. Is this going into 2.2?&lt;/p&gt;</comment>
                            <comment id="16765463" author="mjsax" created="Mon, 11 Feb 2019 22:41:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; The corresponding KIP of this Jira has status &quot;under discussion&quot; &#8211; if you don&apos;t object, I will move this out of 2.2.&lt;/p&gt;</comment>
                            <comment id="16766769" author="ijuma" created="Wed, 13 Feb 2019 04:45:57 +0000"  >&lt;p&gt;I would remove the target version and reduce priority personally.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yv1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>