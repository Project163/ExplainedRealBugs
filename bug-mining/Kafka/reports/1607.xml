<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:02:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-5611] One or more consumers in a consumer-group stop consuming after rebalancing</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-5611</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Scenario: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;3 zookeepers, 4 Kafkas. 0.10.2.0, with 0.9.0 compatibility still on (other apps need it but the one mentioned below is already on kafka 0.10.2.0  client).&lt;/li&gt;
	&lt;li&gt;3 servers running 1 consumer each under the same consumer groupId.&lt;/li&gt;
	&lt;li&gt;Servers seem to be consuming messages happily but then there is a timeout to an external service that causes our app to restart the Kafka Consumer on one of the servers (this is by design). That causes rebalancing of the group and upon restart of one of the Consumers seem to &quot;block&quot;.&lt;/li&gt;
	&lt;li&gt;Server 3 is where the problems occur.&lt;/li&gt;
	&lt;li&gt;Problem fixes itself either by restarting one of the 3 servers or cause the group to rebalance again by using the console consumer with the autocommit set to false and using the same group.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Haven&apos;t managed to recreate it at will yet.&lt;/li&gt;
	&lt;li&gt;Mainly happens in production environment, often enough. Hence I do not have any logs with DEBUG/TRACE statements yet.&lt;/li&gt;
	&lt;li&gt;Extracts from log of each app server are attached. Also the log of the kafka that seems to be dealing with the related group and generations.&lt;/li&gt;
	&lt;li&gt;See COMMENT lines in the files for further info.&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="13088611">KAFKA-5611</key>
            <summary>One or more consumers in a consumer-group stop consuming after rebalancing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hachikuji">Jason Gustafson</assignee>
                                    <reporter username="pskianis">Panos Skianis</reporter>
                        <labels>
                            <label>reliability</label>
                    </labels>
                <created>Thu, 20 Jul 2017 01:09:18 +0000</created>
                <updated>Fri, 11 May 2018 06:11:42 +0000</updated>
                            <resolved>Wed, 16 Aug 2017 12:44:37 +0000</resolved>
                                    <version>0.10.2.0</version>
                                    <fixVersion>0.11.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16094053" author="pskianis" created="Thu, 20 Jul 2017 01:21:25 +0000"  >&lt;p&gt;I am wondering if this is related actually to &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5016&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-5016&lt;/a&gt; but I am not sure if the scenarios match 100% yet and at the moment&lt;br/&gt;
eg 5016 mentions 2 consumers run sequentially with the second one blocking whilst this one refers to three of them running concurrently &lt;/p&gt;</comment>
                            <comment id="16094108" author="huxi_2b" created="Thu, 20 Jul 2017 02:52:22 +0000"  >&lt;p&gt;Is there anything wrong with the network between server 3 and kafka cluster?&lt;/p&gt;</comment>
                            <comment id="16094176" author="hachikuji" created="Thu, 20 Jul 2017 05:04:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pskianis&quot; class=&quot;user-hover&quot; rel=&quot;pskianis&quot;&gt;pskianis&lt;/a&gt; Thanks for the report. If at all possible, can you try to reproduce this with DEBUG logging enabled? It would also be helpful to see a thread dump from the hanging consumer. Especially puzzling that it recovers after any of the consumers is restarted...&lt;/p&gt;</comment>
                            <comment id="16095510" author="pskianis" created="Thu, 20 Jul 2017 22:55:59 +0000"  >&lt;p&gt;huxihx, in general not really. Looking at some metric graphs around data sent/received by Server 3 and Kafka, I couldn&apos;t see anything network wise. So with be able to exclude it completely, I haven&apos;t got any proof that this was the issue.&lt;/p&gt;

&lt;p&gt;Jason Gustafson, I am trying to arrange for switching on DEBUG in the particular environment. I will provide a thread dump next time we experience this problem at least. &lt;/p&gt;

&lt;p&gt;My current issue is the fact that while it is happening almost daily on the particular environment, I do not have a way to recreate it nor is the problem repeatable at particular times. &lt;/p&gt;</comment>
                            <comment id="16095916" author="huxi_2b" created="Fri, 21 Jul 2017 07:51:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pskianis&quot; class=&quot;user-hover&quot; rel=&quot;pskianis&quot;&gt;pskianis&lt;/a&gt; In the log, seems that the consumer on Server 3 did not get any assigned partitions with generation ID 12470.&lt;/p&gt;</comment>
                            <comment id="16096311" author="pskianis" created="Fri, 21 Jul 2017 14:28:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huxi_2b&quot; class=&quot;user-hover&quot; rel=&quot;huxi_2b&quot;&gt;huxi_2b&lt;/a&gt; Yep, that seems to be the case indeed (and usually it is reflected in the assigned-partitions metric). I say usually because that hasn&apos;t been always the case. The log always shows what you have seen up to now but the metric is not always set to 0 when this issue happens (but that could be how metrics are being collected).&lt;/p&gt;</comment>
                            <comment id="16097048" author="pskianis" created="Sat, 22 Jul 2017 01:10:28 +0000"  >&lt;p&gt;Somehow managed to recreate this on a different environment but stll cannot do it at will. I am attaching a filtered log from the &quot;consumer&quot; app that had the issue. &lt;br/&gt;
Debugging was switched on for the consumer internals package of the kafka clients (o.a.k.c.consumer.internals). &lt;/p&gt;

&lt;p&gt;We have introduced a way to force the kafka consumer code to be &quot;restarted&quot; manually. At the moment, on a cluster of 4 kafkas/3 zookeepers  and 3 client consumer apps, we have been trying to recreate this problem by causing rebalancing on purpose (group.id = salesforce-group-gb). You may notice other groups as well since this app is using multiple groups but those are ok at the moment afaik. &lt;/p&gt;

&lt;p&gt;File related to this comment is attached as bad-server-with-more-logging-1 (tarballed and gzipped). Let me know if you want me to provide it in another format.&lt;br/&gt;
There are some comments inside that file (starting normally with the word COMMENT). &lt;/p&gt;

&lt;p&gt;Note: the app is using akka-kafka-streams and I believe there is a timeout involved. You will be able to see this if you search for WakeupException.&lt;br/&gt;
I am wondering if that is causing the issue because there is delay in getting the information back from kafka (timeout current set at 3s). I will go looking down that route in case this is just a long network call and the timeout is &quot;short&quot;.&lt;/p&gt;

</comment>
                            <comment id="16098973" author="hachikuji" created="Mon, 24 Jul 2017 18:47:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pskianis&quot; class=&quot;user-hover&quot; rel=&quot;pskianis&quot;&gt;pskianis&lt;/a&gt; You&apos;d have to get pretty unlikely with the timing, but a wakeup following rebalance completion could explain the issue. Prior to invoking the partition assignor, we have a check to ensure that we have up-to-date metadata. It is possible to get a wakeup when fetching new metadata and the code does not appear clever enough at the moment to resume assignment on the next call to &lt;tt&gt;poll()&lt;/tt&gt;. I&apos;ll submit a patch to fix this and maybe we can see if it addresses the problem.&lt;/p&gt;</comment>
                            <comment id="16099537" author="githubbot" created="Tue, 25 Jul 2017 05:44:55 +0000"  >&lt;p&gt;GitHub user hachikuji opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3571&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5611&quot; title=&quot;One or more consumers in a consumer-group stop consuming after rebalancing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5611&quot;&gt;&lt;del&gt;KAFKA-5611&lt;/del&gt;&lt;/a&gt;; AbstractCoordinator should handle wakeup raised from onJoinComplete&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/hachikuji/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hachikuji/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5611&quot; title=&quot;One or more consumers in a consumer-group stop consuming after rebalancing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5611&quot;&gt;&lt;del&gt;KAFKA-5611&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3571.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3571.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3571&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e0b4f65031dbb8135d872811c68dec94f7a45efd&lt;br/&gt;
Author: Jason Gustafson &amp;lt;jason@confluent.io&amp;gt;&lt;br/&gt;
Date:   2017-07-25T05:14:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-5611&quot; title=&quot;One or more consumers in a consumer-group stop consuming after rebalancing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-5611&quot;&gt;&lt;del&gt;KAFKA-5611&lt;/del&gt;&lt;/a&gt;; AbstractCoordinator should handle wakeup raised from onJoinComplete&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16099599" author="pskianis" created="Tue, 25 Jul 2017 07:05:30 +0000"  >&lt;p&gt;Just an observation based on metrics &amp;amp; logs on the client side and the consumer-group command.&lt;br/&gt;
In the last occurrence of this problem, the assigned partitions metric on the consumer side shows 0 but the client seems to be heartbeating as usual. The consumer group command through show that the particular consumer has 24 partitions assigned to it.&lt;/p&gt;

&lt;p&gt;Is the above a valid scenario? Does that mean that we have a healthy consumer that has been assigned no partitions and it will never get any until there is a reason to rebalance?&lt;/p&gt;

&lt;p&gt;Secondly, we were looking at the same code and were thinking (since there is no stacktrace at the mo) that wakeup call was against the the client.poll(future) line in the same code where you applied the patch. Couldn&apos;t that be the case? What would happen then?&lt;/p&gt;</comment>
                            <comment id="16099978" author="ijuma" created="Tue, 25 Jul 2017 12:47:38 +0000"  >&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hachikuji&quot; class=&quot;user-hover&quot; rel=&quot;hachikuji&quot;&gt;hachikuji&lt;/a&gt; addresses your comments, would you be able to test the fix to see if it fixes the issue for you?&lt;/p&gt;</comment>
                            <comment id="16100986" author="hachikuji" created="Wed, 26 Jul 2017 00:21:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is the above a valid scenario? Does that mean that we have a healthy consumer that has been assigned no partitions and it will never get any until there is a reason to rebalance?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The heartbeat thread begins after the join completes, but a wakeup could prevent the assignment from finishing. From the perspective of the coordinator logic, there is nothing left to be done, and that will remain until the next rebalance.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Secondly, we were looking at the same code and were thinking (since there is no stacktrace at the mo) that wakeup call was against the the client.poll(future) line in the same code where you applied the patch. Couldn&apos;t that be the case? What would happen then?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This case was previously handled. The future will not be reset and the next call to poll() will resume the wait for it. What we did not account for was the metadata fetch which occurs in the onJoinComplete callback. We can discuss this on the PR if you like.&lt;/p&gt;</comment>
                            <comment id="16102758" author="githubbot" created="Thu, 27 Jul 2017 05:59:58 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/3571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3571&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16102759" author="hachikuji" created="Thu, 27 Jul 2017 06:02:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pskianis&quot; class=&quot;user-hover&quot; rel=&quot;pskianis&quot;&gt;pskianis&lt;/a&gt; We have merged the patch above. We would appreciate if you could confirm whether or not it fixes the issue. &lt;/p&gt;</comment>
                            <comment id="16128734" author="ijuma" created="Wed, 16 Aug 2017 12:44:38 +0000"  >&lt;p&gt;I&apos;m going to mark this as closed. If &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pskianis&quot; class=&quot;user-hover&quot; rel=&quot;pskianis&quot;&gt;pskianis&lt;/a&gt; or someone else can still see the issue after the fix that was merged, we can reopen.&lt;/p&gt;</comment>
                            <comment id="16147990" author="pskianis" created="Wed, 30 Aug 2017 20:24:44 +0000"  >&lt;p&gt;Apologies for not coming back earlier to this.&lt;br/&gt;
Since we haven&apos;t been able to recreate this issue at will and I am not in full control of the environments where I have seen this problem happening, I will try to find time to attempt to recreate it on a local setup again and then apply the change. &lt;br/&gt;
I will try to come back to you with some results asap but I am not sure when that will be.&lt;/p&gt;
</comment>
                            <comment id="16471522" author="qiuyueqiong" created="Fri, 11 May 2018 06:11:42 +0000"  >&lt;p&gt;after applied &lt;a href=&quot;https://github.com/apache/kafka/pull/3571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/3571&lt;/a&gt; on version 0.10.2.0, we encountered an infinite loop occurs in ConsumerCoordinator.java:&lt;br/&gt;
java.lang.IllegalStateException: Coordinator selected invalid assignment protocol: null&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.onJoinComplete(ConsumerCoordinator.java:208)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.joinGroupIfNeeded(AbstractCoordinator.java:339)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.clients.consumer.internals.AbstractCoordinator.ensureActiveGroup(AbstractCoordinator.java:305)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.kafka.clients.consumer.internals.ConsumerCoordinator.poll(ConsumerCoordinator.java:286)&lt;/p&gt;

&lt;p&gt;for some reason, the ConsumerCoordinator&apos;s resetGeneration() is called, and the protocol of generation is set to null.&lt;br/&gt;
then in method joinGroupIfNeeded() of org.apache.kafka.clients.consumer.internals.AbstractCoordinator.java ,onJoinComplete() method throws an IllegalStateException, &lt;br/&gt;
and the resetJoinGroupFuture() method will never has the chance to be call:&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (future.succeeded()) {&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; onJoinComplete(generation.generationId, generation.memberId, generation.protocol, future.value());&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // We reset the join group future only after the completion callback returns. This ensures&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // that if the callback is woken up, we will retry it on the next joinGroupIfNeeded.&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; resetJoinGroupFuture();&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; needsJoinPrepare = true;&lt;/p&gt;

&lt;p&gt;the joinFuture is not clear to null, JoinGroupRequest will not be sent in the next loop&lt;/p&gt;

&lt;p&gt;is this an issue?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12878078" name="Server 1" size="15343" author="pskianis" created="Thu, 20 Jul 2017 00:33:02 +0000"/>
                            <attachment id="12878079" name="Server 2" size="15480" author="pskianis" created="Thu, 20 Jul 2017 00:33:02 +0000"/>
                            <attachment id="12878080" name="Server 3" size="14877" author="pskianis" created="Thu, 20 Jul 2017 00:33:02 +0000"/>
                            <attachment id="12878437" name="bad-server-with-more-logging-1.tar.gz" size="34579" author="pskianis" created="Sat, 22 Jul 2017 01:10:45 +0000"/>
                            <attachment id="12878077" name="kka02" size="155244" author="pskianis" created="Thu, 20 Jul 2017 01:09:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hrw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>