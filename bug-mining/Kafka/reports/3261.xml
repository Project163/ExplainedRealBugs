<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:30:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-13939] Memory Leak When Logging Is Disabled In InMemoryTimeOrderedKeyValueBuffer</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-13939</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;If `loggingEnabled` is false, the `dirtyKeys` Set is not cleared within `flush()`, see &lt;a href=&quot;https://github.com/apache/kafka/blob/3.2/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryTimeOrderedKeyValueBuffer.java#L262.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/3.2/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryTimeOrderedKeyValueBuffer.java#L262.&lt;/a&gt; However, dirtyKeys is still written to in the loop within `evictWhile`. This causes dirtyKeys to continuously grow for the life of the buffer.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13446881">KAFKA-13939</key>
            <summary>Memory Leak When Logging Is Disabled In InMemoryTimeOrderedKeyValueBuffer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jnewhouse">Jackson Newhouse</assignee>
                                    <reporter username="jnewhouse">Jackson Newhouse</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 May 2022 19:38:00 +0000</created>
                <updated>Thu, 16 Jun 2022 21:28:09 +0000</updated>
                            <resolved>Thu, 16 Jun 2022 21:28:09 +0000</resolved>
                                                    <fixVersion>3.3.0</fixVersion>
                                    <component>streams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17542269" author="JIRAUSER290030" created="Wed, 25 May 2022 23:02:20 +0000"  >&lt;p&gt;One way to patch this would be something like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jnewhouse - kafka % git diff
diff --git a/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryTimeOrderedKeyValueBuffer.java b/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryTimeOrderedKeyValueBuffer.java
index 2909e2763f..b0ee755b3f 100644
--- a/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryTimeOrderedKeyValueBuffer.java
+++ b/streams/src/main/java/org/apache/kafka/streams/state/internals/InMemoryTimeOrderedKeyValueBuffer.java
@@ -403,7 +403,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;InMemoryTimeOrderedKeyValueBuffer&amp;lt;K, V&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; TimeOrdere
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; delegate.remove();
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; index.remove(next.getKey().key());
&#160;
-&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; dirtyKeys.add(next.getKey().key());
+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (loggingEnabled) {
+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; dirtyKeys.add(next.getKey().key());
+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&#160;
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; memBufferSize -= computeRecordSize(next.getKey().key(), bufferValue);
&#160;
@@ -478,7 +480,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;InMemoryTimeOrderedKeyValueBuffer&amp;lt;K, V&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; TimeOrdere
&#160;&#160; &#160; &#160; &#160; &#160; &#160; serializedKey,
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferValue(serializedPriorValue, serialChange.oldValue, serialChange.newValue, recordContext)
&#160;&#160; &#160; &#160; &#160; );
-&#160; &#160; &#160; &#160; dirtyKeys.add(serializedKey);
+&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (loggingEnabled) {
+&#160; &#160; &#160; &#160; &#160; &#160; dirtyKeys.add(serializedKey);
+&#160; &#160; &#160; &#160; }
&#160;&#160; &#160; &#160; &#160; updateBufferMetrics();
&#160;&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since `loggingEnabled` is final, we can just not track the dirty keys. The set is only read from if `loggingEnabled` is true.&lt;/p&gt;</comment>
                            <comment id="17542270" author="JIRAUSER290030" created="Wed, 25 May 2022 23:07:47 +0000"  >&lt;p&gt;If you search Stack Overflow you&apos;ll find occasional instances of people running into this problem, such as &lt;a href=&quot;https://stackoverflow.com/questions/59239783/kafka-streams-suppressed-feature-causes-oom-heavy-gc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/59239783/kafka-streams-suppressed-feature-causes-oom-heavy-gc&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/70651437/kafka-stream-oom-out-of-memory/70660956#70660956&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/70651437/kafka-stream-oom-out-of-memory&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17544645" author="mjsax" created="Tue, 31 May 2022 23:55:41 +0000"  >&lt;p&gt;Thanks for reporting this issue &#8211; sound rather severs &#8211; I bumped the priority to blocker.&lt;/p&gt;

&lt;p&gt;As you already have a fix, would you like to open a PR on GitHub?&lt;/p&gt;</comment>
                            <comment id="17545102" author="guozhang" created="Wed, 1 Jun 2022 19:02:07 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnewhouse&quot; class=&quot;user-hover&quot; rel=&quot;jnewhouse&quot;&gt;jnewhouse&lt;/a&gt;, I looked at the code you pointed it out and I agree it&apos;s a bug indeed, and should be fixed asap. Please let us know if you&apos;d like to open a PR to fix it.&lt;/p&gt;</comment>
                            <comment id="17551215" author="JIRAUSER290030" created="Tue, 7 Jun 2022 18:26:27 +0000"  >&lt;p&gt;I&apos;ll open a PR.&lt;/p&gt;</comment>
                            <comment id="17551217" author="JIRAUSER290030" created="Tue, 7 Jun 2022 18:26:55 +0000"  >&lt;p&gt;What&apos;s the protocol for back-porting a fix like this?&lt;/p&gt;</comment>
                            <comment id="17551235" author="guozhang" created="Tue, 7 Jun 2022 18:57:54 +0000"  >&lt;p&gt;Once the PR is merged, we can cherry-pick the commit to old branches. But whether the fix would be release depends on whether we would have a bug-fix release (e.g. say 3.2.1) planned in the future.&lt;/p&gt;</comment>
                            <comment id="17554742" author="mjsax" created="Wed, 15 Jun 2022 18:03:21 +0000"  >&lt;p&gt;Thanks for the PR. I added you to list of contributors and assigned the ticket to you. You can know also self-assign tickets.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12oxk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>