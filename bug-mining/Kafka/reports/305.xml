<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:38:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-987] Avoid checkpointing offsets in Kafka consumer that have not changed since the last commit</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-987</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;We need to fix the Kafka zookeeper consumer to avoid checkpointing offsets that have not changed since the last offset commit. This will help reduce the write load on zookeeper.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12659224">KAFKA-987</key>
            <summary>Avoid checkpointing offsets in Kafka consumer that have not changed since the last commit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swapnilghike">Swapnil Ghike</assignee>
                                    <reporter username="swapnilghike">Swapnil Ghike</reporter>
                        <labels>
                            <label>improvement</label>
                    </labels>
                <created>Mon, 22 Jul 2013 23:08:52 +0000</created>
                <updated>Fri, 26 Jul 2013 21:19:01 +0000</updated>
                            <resolved>Tue, 23 Jul 2013 18:21:05 +0000</resolved>
                                    <version>0.8.0</version>
                                    <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13715877" author="swapnilghike" created="Mon, 22 Jul 2013 23:56:23 +0000"  >&lt;p&gt;The only case wherein the code does not have a bug and yet the consumer could end up consuming from an offset &amp;lt; the previously committed offset is when there is an unclean leader election. Hence, this patch will commit new offsets as long as they are different from the previously committed offsets.&lt;/p&gt;</comment>
                            <comment id="13716583" author="nehanarkhede" created="Tue, 23 Jul 2013 16:47:35 +0000"  >&lt;p&gt;Thanks for the patch, Swapnil. Good thinking about not limiting the check to offset &amp;lt; committed offset. Just one question about your patch -&lt;/p&gt;

&lt;p&gt; In commitOffsets, should the the map update move to inside the try block to ensure that the map is updated only if the zk write succeeds ?&lt;/p&gt;</comment>
                            <comment id="13716651" author="swapnilghike" created="Tue, 23 Jul 2013 17:41:32 +0000"  >&lt;p&gt;Yes, thank you. Attached v2.&lt;/p&gt;</comment>
                            <comment id="13716680" author="nehanarkhede" created="Tue, 23 Jul 2013 18:18:16 +0000"  >&lt;p&gt;+1 on v2.&lt;/p&gt;</comment>
                            <comment id="13716683" author="nehanarkhede" created="Tue, 23 Jul 2013 18:20:59 +0000"  >&lt;p&gt;committed v2 to 0.8&lt;/p&gt;</comment>
                            <comment id="13717977" author="junrao" created="Wed, 24 Jul 2013 04:55:06 +0000"  >&lt;p&gt;It seems that we don&apos;t need to update the offset map in addPartitionTopicInfo(). In fact, currently, if there is no new messages coming in, we won&apos;t checkpoint the first offset.&lt;/p&gt;</comment>
                            <comment id="13718044" author="swapnilghike" created="Wed, 24 Jul 2013 06:48:00 +0000"  >&lt;p&gt;I think that any call to createMessageStreams will trigger a rebalance, that will fill up the topicregistry and the checkpointing of offsets will start regardless of whether new messages are being consumed or not. Hence, we should probably update the cached checkpointedOffsets map in addPartitionTopicInfo().&lt;/p&gt;

&lt;p&gt;May be I have missed something?&lt;/p&gt;</comment>
                            <comment id="13718567" author="nehanarkhede" created="Wed, 24 Jul 2013 16:55:24 +0000"  >&lt;p&gt;Jun,&lt;/p&gt;

&lt;p&gt;I think what you are suggesting makes sense on startup before the consumer has consumed any messages. However, since the offset map is a cache for what&apos;s in zookeeper, the safest way is to keep it in sync with the zookeeper data. Before the consumer can pull any data, it has to rebalance and while rebalancing we read the offsets from zk anyways. So I think it is correct to update the offset cache in addPartitionTopicInfo()&lt;/p&gt;</comment>
                            <comment id="13719723" author="junrao" created="Thu, 25 Jul 2013 15:52:48 +0000"  >&lt;p&gt;1. The issue on startup is the following. If a consumer starts up from the end of the log and there is no new message coming in, no offset will be checkpointed to ZK. This will affect tools like ConsumerOffsetChecker.&lt;/p&gt;

&lt;p&gt;2. During rebalance, a consumer may pick up offsets committed by other consumer instances. If we don&apos;t update the offset cache in addPartitionTopicInfo(), we will do an extra unnecessary offset update to ZK.&lt;/p&gt;

&lt;p&gt;It seems to me that the impact for #1 is bigger than the slight performance impact in #2. Another way to do that is to always force the very first offset (per partition) write to ZK. However, I am not sure if it&apos;s worth the complexity.&lt;/p&gt;</comment>
                            <comment id="13720886" author="nehanarkhede" created="Fri, 26 Jul 2013 15:34:06 +0000"  >&lt;p&gt;I&apos;m trying to see if I understand what you are saying here. &lt;/p&gt;

&lt;p&gt;1. The basic logic is that as long as the consumer rebalances before starting consumption, the offset cache will be updated. This is true for the zookeeper consumer behavior today. Now, it really doesn&apos;t matter much where the consumer starts consuming from. If it hasn&apos;t read any messages, there is no need to update offsets in zookeeper. If it reads messages, the offsets will be different from what&apos;s in the cache, so they will get checkpointed.&lt;/p&gt;

&lt;p&gt;2. I don&apos;t think this is worth doing since it only reduces one zookeeper write.&lt;/p&gt;</comment>
                            <comment id="13721221" author="swapnilghike" created="Fri, 26 Jul 2013 21:19:01 +0000"  >&lt;p&gt;I discussed this yesterday with Jun. If there is no offset already present in zookeeper, we set the offset value to -1 in the offset cache in addPartitionInfo(). Later, even if no message is consumed, the real offset will be checkpointed. Jun said that he was ok with this patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12593742" name="kafka-987-v2.patch" size="2456" author="swapnilghike" created="Tue, 23 Jul 2013 17:41:32 +0000"/>
                            <attachment id="12593616" name="kafka-987.patch" size="2454" author="swapnilghike" created="Mon, 22 Jul 2013 23:56:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>339417</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 17 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mjiv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>339737</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>