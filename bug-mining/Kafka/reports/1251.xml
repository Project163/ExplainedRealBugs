<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:57:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-4360] Controller may deadLock when autoLeaderRebalance encounter zk expired</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-4360</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;when controller has checkAndTriggerPartitionRebalance task in autoRebalanceScheduler&#65292;and then zk expired at that time. It will&lt;br/&gt;
run into deadlock.&lt;/p&gt;

&lt;p&gt;we can restore the scene as below&#65292;when zk session expired&#65292;zk thread will call handleNewSession which defined in SessionExpirationListener, and it will get controllerContext.controllerLock&#65292;and then it will autoRebalanceScheduler.shutdown()&#65292;which need complete all the task in the autoRebalanceScheduler&#65292;but that threadPoll also need get controllerContext.controllerLock&#65292;but it has already owned by zk callback thread&#65292;which will then run into deadlock.&lt;/p&gt;

&lt;p&gt;because of that&#65292;it will cause two problems at least, first is the broker&#8217;s id is cannot register to the zookeeper&#65292;and it will be considered as dead by new controller&#65292;second this procedure can not be stop by kafka-server-stop.sh, because shutdown function&lt;br/&gt;
can not get controllerContext.controllerLock also, we cannot shutdown kafka except using kill -9.&lt;/p&gt;

&lt;p&gt;In my attachment, I upload a jstack file, which was created when my kafka procedure cannot shutdown by kafka-server-stop.sh.&lt;/p&gt;

&lt;p&gt;I have met this scenes for several times&#65292;I think this may be a bug that not solved in kafka.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13016620">KAFKA-4360</key>
            <summary>Controller may deadLock when autoLeaderRebalance encounter zk expired</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Json Tu">tuyang</reporter>
                        <labels>
                            <label>bugfix</label>
                            <label>reliability</label>
                    </labels>
                <created>Mon, 31 Oct 2016 14:48:37 +0000</created>
                <updated>Fri, 16 Mar 2018 18:55:29 +0000</updated>
                            <resolved>Wed, 9 Nov 2016 18:38:19 +0000</resolved>
                                    <version>0.9.0.0</version>
                    <version>0.9.0.1</version>
                    <version>0.10.0.0</version>
                    <version>0.10.0.1</version>
                                    <fixVersion>0.10.2.0</fixVersion>
                                    <component>controller</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="604800">168h</timeoriginalestimate>
                            <timeestimate seconds="604800">168h</timeestimate>
                                        <comments>
                            <comment id="15622368" author="json tu" created="Mon, 31 Oct 2016 14:52:31 +0000"  >&lt;p&gt;the jstack file created when kill kafka&lt;/p&gt;</comment>
                            <comment id="15622377" author="json tu" created="Mon, 31 Oct 2016 14:55:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;  do you think this is may be a bug, if so, I will be pleased to put a pull request for it.&lt;/p&gt;</comment>
                            <comment id="15624155" author="huxi_2b" created="Tue, 1 Nov 2016 02:54:28 +0000"  >&lt;p&gt;Excellent analysis! What I am intrigued is whether this is a deadlock issue or a liveness issue. Here is my analysis:&lt;br/&gt;
1. Say at time T1, the zookeeper session expires, so &apos;handleNewSession&apos; methods for SessionExpirationListener is executed, therefore, obtaining the controller lock(controllerContext.controllerLock)&lt;br/&gt;
2. Then it invokes &apos;onControllerResignation&apos; method to have the current controller quit, which will shutdown leader rebalance scheduler by calling KafkaScheduler.shutdown&lt;br/&gt;
3. In &apos;shutdown&apos; method, it shuts down the ScheduledThreadPoolExecutor and blocks until all tasks have completed execution after a shutdown request&lt;br/&gt;
4. If there exists any tasks submitted before calling shutdown, the check-imbalance thread should get started with checking isActive which acquires the controller lock at the very beginning and then soon be blocked due to the lock has already been held by the main thread.&lt;br/&gt;
5. In that case, the main thread will block in onControllerResignation method until one day has elapsed by default or you just interrupt the check thread.&lt;/p&gt;

&lt;p&gt;Does it make sense?&lt;/p&gt;</comment>
                            <comment id="15624174" author="json tu" created="Tue, 1 Nov 2016 03:02:19 +0000"  >&lt;p&gt;yes&#65292;it is this deadlock block the broker register itself to zookeeper again, I think we should add a AtomicBoolean variable may be called isRebalanceInProgress which is set to true when executing a task and is set to false after execute it&#65292;then the handleNewSession methods should not get controllerContext.controllerLock before isRebalanceInProgress be set to false.&lt;/p&gt;</comment>
                            <comment id="15624312" author="becket_qin" created="Tue, 1 Nov 2016 04:26:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Json+Tu&quot; class=&quot;user-hover&quot; rel=&quot;Json Tu&quot;&gt;Json Tu&lt;/a&gt; Good catch. In terms of the solution, I am thinking that we don&apos;t need to call &lt;tt&gt;KafkaController.onControllerResignation()&lt;/tt&gt; in the controller lock because the method itself is thread safe. In &lt;tt&gt;KafkaController.shutdown()&lt;/tt&gt; we actually call it without grabbing the controller lock.&lt;/p&gt;

&lt;p&gt;Another related issue is that we also call  &lt;tt&gt;KafkaController.onControllerResignation()&lt;/tt&gt; in the controllerElector while holding the controller lock. It seems that may also result in the same deadlock. &lt;/p&gt;</comment>
                            <comment id="15624461" author="json tu" created="Tue, 1 Nov 2016 05:49:22 +0000"  >&lt;p&gt;it is wonderful&#65292;I search &lt;tt&gt;onControllerResignation()&lt;/tt&gt; in kafka codes. just as you say&#65292;there are two other invokes in ZookeeperLeaderElector&#65292;can you assign this task to me&#65292;I am very pleased to put a pull request for it&#65292;thank you&lt;/p&gt;</comment>
                            <comment id="15625317" author="json tu" created="Tue, 1 Nov 2016 12:36:46 +0000"  >&lt;p&gt;I put a pull request&#65306;&lt;a href=&quot;https://github.com/apache/kafka/pull/2085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2085&lt;/a&gt;&#65292;can someone review it&#65311;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15626869" author="guozhang" created="Tue, 1 Nov 2016 22:25:27 +0000"  >&lt;p&gt;Thanks for the find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Json+Tu&quot; class=&quot;user-hover&quot; rel=&quot;Json Tu&quot;&gt;Json Tu&lt;/a&gt;. And I agree with Jiangjie that we could consider moving &lt;tt&gt;onControllerResignation&lt;/tt&gt; out of the lock itself.&lt;/p&gt;</comment>
                            <comment id="15631474" author="json tu" created="Thu, 3 Nov 2016 04:06:55 +0000"  >&lt;p&gt;I&apos;m sorry, I rollback one comment commit, and &lt;a href=&quot;https://github.com/apache/kafka/pull/2085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2085&lt;/a&gt; is closed by github&#65292;so I put a new pull request&#65306;&lt;a href=&quot;https://github.com/apache/kafka/pull/2094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2094&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Can someone help to promote the project landing.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guozhang&quot; class=&quot;user-hover&quot; rel=&quot;guozhang&quot;&gt;guozhang&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=onurkaraman&quot; class=&quot;user-hover&quot; rel=&quot;onurkaraman&quot;&gt;onurkaraman&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wushujames&quot; class=&quot;user-hover&quot; rel=&quot;wushujames&quot;&gt;wushujames&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gwenshap&quot; class=&quot;user-hover&quot; rel=&quot;gwenshap&quot;&gt;gwenshap&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15651691" author="guozhang" created="Wed, 9 Nov 2016 18:38:19 +0000"  >&lt;p&gt;Issue resolved by pull request 2094&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/kafka/pull/2094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2094&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12711037">KAFKA-1429</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13145468">KAFKA-6665</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12836267" name="deadlock_patch" size="2428" author="Json Tu" created="Tue, 1 Nov 2016 03:16:41 +0000"/>
                            <attachment id="12836163" name="yf-mafka2-common02_jstack.txt" size="25658" author="Json Tu" created="Mon, 31 Oct 2016 14:52:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35min:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>becket_qin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>