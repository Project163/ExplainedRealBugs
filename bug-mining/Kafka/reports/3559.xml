<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:33:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-15353] Empty ISR returned from controller after AlterPartition request</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-15353</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-903%3A+Replicas+with+stale+broker+epoch+should+not+be+allowed+to+join+the+ISR&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-903&lt;/a&gt;, (more specifically this &lt;a href=&quot;https://github.com/apache/kafka/pull/13408&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;), we bumped the AlterPartitionRequest version to 3 to use `NewIsrWithEpochs` field instead of `NewIsr` one. And when building the request for older version, we&apos;ll manually convert/downgrade the request into the older version for backward compatibility &lt;a href=&quot;https://github.com/apache/kafka/blob/6bd17419b76f8cf8d7e4a11c071494dfaa72cd50/clients/src/main/java/org/apache/kafka/common/requests/AlterPartitionRequest.java#L85-L96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, to extract ISR info from `NewIsrWithEpochs` and then fill in the `NewIsr` field, and then clear the `NewIsrWithEpochs` field.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is, when the AlterPartitionRequest sent out for the first time, if there&apos;s some transient error (ex: NOT_CONTROLLER), we&apos;ll retry. On the retry, we&apos;ll build the AlterPartitionRequest again. But this time, the request data is the one that already converted above. At this point, when we try to extract the ISR from `NewIsrWithEpochs`, we&apos;ll get empty. So, we&apos;ll send out an AlterPartition request with empty ISR, and impacting the kafka availability.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;From the log, I can see this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[2023-08-16 03:57:55,122] INFO [Partition test_topic-1 broker=3] ISR updated to &#160;(under-min-isr) and version updated to 9 (kafka.cluster.Partition)
...
[2023-08-16 03:57:55,157] ERROR [ReplicaManager broker=3] Error processing append operation on partition test_topic-1 (kafka.server.ReplicaManager)org.apache.kafka.common.errors.NotEnoughReplicasException: The size of the current ISR Set() is insufficient to satisfy the min.isr requirement of 2 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition test_topic-1 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;Impact%3A&quot;&gt;&lt;/a&gt;&lt;b&gt;Impact:&lt;/b&gt;&lt;/h4&gt;

&lt;p&gt;This will happen when users trying to upgrade from versions &amp;lt; 3.5.0 to 3.5.0 or later. During the rolling upgrade, there will be some nodes in v3.5.0, and some are not. So, for the node in v3.5.0 will try to build an old version of AlterPartitionRequest. And then, if it happen to have some transient error during the AlterPartitionRequest send, the ISR will be empty and no producers will be able to write data to the partitions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13547531">KAFKA-15353</key>
            <summary>Empty ISR returned from controller after AlterPartition request</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="calvinliu">Calvin Liu</assignee>
                                    <reporter username="showuon">Luke Chen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Aug 2023 10:16:08 +0000</created>
                <updated>Mon, 28 Aug 2023 13:59:17 +0000</updated>
                            <resolved>Mon, 28 Aug 2023 10:02:42 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>3.5.1</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.6.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17754976" author="showuon" created="Wed, 16 Aug 2023 10:21:24 +0000"  >&lt;p&gt;I&apos;m setting this issue as blocker for v3.5.2 and v3.6.0. Let me know if you have any thoughts.&lt;/p&gt;

&lt;p&gt;Sorry that I&apos;m going to attend a conference the following days, so I can&apos;t submit patch for this issue soon. Welcome to take it over if anyone has available cycle. Thanks.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=calvinliu&quot; class=&quot;user-hover&quot; rel=&quot;calvinliu&quot;&gt;calvinliu&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dajac&quot; class=&quot;user-hover&quot; rel=&quot;dajac&quot;&gt;dajac&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17755614" author="JIRAUSER298384" created="Thu, 17 Aug 2023 16:10:47 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=showuon&quot; class=&quot;user-hover&quot; rel=&quot;showuon&quot;&gt;showuon&lt;/a&gt;, thanks for pointing it out! Will work on the fix.&lt;/p&gt;</comment>
                            <comment id="17755648" author="JIRAUSER298384" created="Thu, 17 Aug 2023 17:26:26 +0000"  >&lt;p&gt;Opened a PR &lt;a href=&quot;https://github.com/apache/kafka/pull/14236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/14236&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17757372" author="mimaison" created="Tue, 22 Aug 2023 10:53:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=calvinliu&quot; class=&quot;user-hover&quot; rel=&quot;calvinliu&quot;&gt;calvinliu&lt;/a&gt; Thanks for the quick PR!&lt;/p&gt;

&lt;p&gt;I&apos;m trying to evaluate the severity of this issue. As far as I understand the issue can happen as soon as one broker is upgraded to the 3.5 binaries. If it fails sending an AlterPartitions request that needs to be downconverted to v2 (as the controller is still running older binaries or IBP), when retrying to send the request, it will have an empty ISR field and cause the controller to mark the followers as out of sync.&lt;/p&gt;

&lt;p&gt;Restarting the leader should resolve the issue and allow the follower to rejoin the ISR.&lt;/p&gt;
</comment>
                            <comment id="17758188" author="JIRAUSER298384" created="Wed, 23 Aug 2023 18:35:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;From my understanding, in Kraft mode&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;del&gt;It only happens in Kraft mode.&lt;/del&gt;&lt;/li&gt;
	&lt;li&gt;The issue can happen during the roll where the broker has to downgrade the AlterPartition requests.&lt;/li&gt;
	&lt;li&gt;If the leader needs to resend the AlterPartition request, the new request will have an empty ISR.&lt;/li&gt;
	&lt;li&gt;The controller does not update the ISR field because it avoids persisting an empty ISR. However, the partition will become leaderless and offline.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The problem can be resolved if any ISR broker gets fenced/rebooted.&lt;/p&gt;</comment>
                            <comment id="17758209" author="mimaison" created="Wed, 23 Aug 2023 19:30:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;It only happens in Kraft mode.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;AlterPartitions requests are also used in ZooKeeper mode. Can you clarify why only KRaft would be affected?&lt;/p&gt;</comment>
                            <comment id="17758227" author="JIRAUSER298384" created="Wed, 23 Aug 2023 20:12:38 +0000"  >&lt;p&gt;You are right, since IBP 2.7IV2, the AlterPartition request is used in ZK mode.&lt;/p&gt;</comment>
                            <comment id="17759179" author="JIRAUSER298384" created="Fri, 25 Aug 2023 22:50:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mimaison&quot; class=&quot;user-hover&quot; rel=&quot;mimaison&quot;&gt;mimaison&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;If I understand correctly, in ZK mode, the leader can send AlterPartition request to empty the ISR. But the leader will continue to serve as the leader.&#160;&lt;/p&gt;

&lt;p&gt;If the leader stays alive, the previous ISR members except itself will be added back. I guess the partition will stay in this wield &quot;leader not in ISR&quot; state until the leadership is changed.&lt;/p&gt;

&lt;p&gt;If the leader fails before any followers can be added to the ISR, an unclean leader election will be required.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 11 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jtiw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>