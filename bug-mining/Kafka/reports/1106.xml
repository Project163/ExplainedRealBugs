<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 16:55:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-3761] Controller has RunningAsBroker instead of RunningAsController state</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-3761</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;In `KafkaServer.start`, we start `KafkaController`:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;/* start kafka controller */&lt;/span&gt;
kafkaController = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KafkaController(config, zkUtils, brokerState, kafkaMetricsTime, metrics, threadNamePrefix)
kafkaController.startup()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which sets the state to `RunningAsController` in `KafkaController.onControllerFailover`:&lt;/p&gt;

&lt;p&gt;`brokerState.newState(RunningAsController)`&lt;/p&gt;

&lt;p&gt;And this later gets set to `RunningAsBroker`.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t match the diagram in `BrokerStates`. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junrao&quot; class=&quot;user-hover&quot; rel=&quot;junrao&quot;&gt;junrao&lt;/a&gt; suggested that we should start the controller after we register the broker in ZK, but this seems tricky as we need to controller in `KafkaApis`.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12973243">KAFKA-3761</key>
            <summary>Controller has RunningAsBroker instead of RunningAsController state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="theduderog">Roger Hoover</assignee>
                                    <reporter username="ijuma">Ismael Juma</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 May 2016 23:51:15 +0000</created>
                <updated>Wed, 31 May 2017 00:00:47 +0000</updated>
                            <resolved>Thu, 30 Jun 2016 11:26:24 +0000</resolved>
                                                    <fixVersion>0.10.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15303571" author="githubbot" created="Fri, 27 May 2016 05:59:14 +0000"  >&lt;p&gt;GitHub user theduderog opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1437&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3761&quot; title=&quot;Controller has RunningAsBroker instead of RunningAsController state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3761&quot;&gt;&lt;del&gt;KAFKA-3761&lt;/del&gt;&lt;/a&gt;: Controller has RunningAsBroker instead of RunningAsController state&lt;/p&gt;

&lt;p&gt;    @junrao @ijuma &lt;/p&gt;

&lt;p&gt;    This works for me in local testing.  Do you see any issues?&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/theduderog/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/theduderog/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3761&quot; title=&quot;Controller has RunningAsBroker instead of RunningAsController state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3761&quot;&gt;&lt;del&gt;KAFKA-3761&lt;/del&gt;&lt;/a&gt;-broker-state&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1437.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1437.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1437&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6278fdec8c75a6ccc610a602c8cf27c2c1706bfb&lt;br/&gt;
Author: Roger Hoover &amp;lt;roger.hoover@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-05-27T05:54:50Z&lt;/p&gt;

&lt;p&gt;    Setting RunningAsController after RunningAsBroker&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15353508" author="githubbot" created="Tue, 28 Jun 2016 18:39:28 +0000"  >&lt;p&gt;Github user theduderog closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1437&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15353509" author="githubbot" created="Tue, 28 Jun 2016 18:39:31 +0000"  >&lt;p&gt;GitHub user theduderog reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1437&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3761&quot; title=&quot;Controller has RunningAsBroker instead of RunningAsController state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3761&quot;&gt;&lt;del&gt;KAFKA-3761&lt;/del&gt;&lt;/a&gt;: Remove BrokerState &quot;RunningAsController&quot;&lt;/p&gt;

&lt;p&gt;    The reasons to remove it are:&lt;br/&gt;
    1. It&apos;s currently broken.  The purpose of the &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3761&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/KAFKA-3761&lt;/a&gt;) was to report that the RunningAsController state gets overwritten back to &quot;RunningAsBroker&quot;.&lt;br/&gt;
    2. It&apos;s not a useful state.&lt;br/&gt;
      a. If clients want to use this metric to know whether a broker is ready to receive requests or not, they do not care whether or not the broker is the controller&lt;br/&gt;
      b. there is already a separate boolean property, KafkaController.isActive which contains this information.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/theduderog/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/theduderog/kafka&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3761&quot; title=&quot;Controller has RunningAsBroker instead of RunningAsController state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3761&quot;&gt;&lt;del&gt;KAFKA-3761&lt;/del&gt;&lt;/a&gt;-broker-state&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/1437.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/1437.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1437&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c0201c5ab8125ea885ff52b234d235d288cd86fb&lt;br/&gt;
Author: Roger Hoover &amp;lt;roger.hoover@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-23T21:52:32Z&lt;/p&gt;

&lt;p&gt;    Removed RunningAsController state&lt;/p&gt;

&lt;p&gt;commit cefead1bed0f0699908bc2819535be4a8f046fd4&lt;br/&gt;
Author: Roger Hoover &amp;lt;roger.hoover@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-23T22:15:30Z&lt;/p&gt;

&lt;p&gt;    Better formatting for ASCII art&lt;/p&gt;

&lt;p&gt;commit 974ba7d4a27dd5ac6b43bc888ece5170737614c5&lt;br/&gt;
Author: Roger Hoover &amp;lt;roger.hoover@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-24T18:26:40Z&lt;/p&gt;

&lt;p&gt;    Added upgrade note&lt;/p&gt;

&lt;p&gt;commit 887fbc0aca264178bb4428b1fdb98dcbe8f2ffdd&lt;br/&gt;
Author: Roger Hoover &amp;lt;roger.hoover@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-24T20:18:17Z&lt;/p&gt;

&lt;p&gt;    Updated upgrade note based on @ijuma&apos;s feedback&lt;/p&gt;

&lt;p&gt;commit 5db6479970472fdc8366c17b1cad66971e542a48&lt;br/&gt;
Author: Roger Hoover &amp;lt;roger.hoover@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-24T21:38:43Z&lt;/p&gt;

&lt;p&gt;    Moved 0.10.1.0 section to the top&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15988745" author="githubbot" created="Fri, 28 Apr 2017 12:39:17 +0000"  >&lt;p&gt;GitHub user ijuma opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2935&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2935&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    MINOR: onControllerResignation should be invoked if triggerControllerMove is called&lt;/p&gt;

&lt;p&gt;    This fixes a transient test failure due to a NPE in ControllerFailoverTest.testMetadataUpdate:&lt;/p&gt;

&lt;p&gt;    ```text&lt;br/&gt;
    Caused by: java.lang.NullPointerException&lt;br/&gt;
    	at kafka.controller.ControllerBrokerRequestBatch.addUpdateMetadataRequestForBrokers(ControllerChannelManager.scala:338)&lt;br/&gt;
    	at kafka.controller.KafkaController.sendUpdateMetadataRequest(KafkaController.scala:975)&lt;br/&gt;
    	at kafka.controller.ControllerFailoverTest.testMetadataUpdate(ControllerFailoverTest.scala:141)&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    The underlying issue is that setting `activeControllerId.set(-1)` in `triggerControllerMove`&lt;br/&gt;
    causes `Reelect` not to invoke `onControllerResignation`. Among other things, this&lt;br/&gt;
    causes an IllegalStateException to be thrown when `KafkaScheduler.startup` is invoked&lt;br/&gt;
    for the second time without the corresponding `shutdown`.&lt;/p&gt;

&lt;p&gt;    I also updated the test so that we can trigger this issue deterministically instead of&lt;br/&gt;
    transiently.&lt;/p&gt;

&lt;p&gt;    Finally, I included a few clean-ups:&lt;br/&gt;
    1. No longer update the broker state in `onControllerFailover`. This is no longer needed&lt;br/&gt;
    since we removed the `RunningAsController` state (&lt;a href=&quot;https://issues.apache.org/jira/browse/KAFKA-3761&quot; title=&quot;Controller has RunningAsBroker instead of RunningAsController state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KAFKA-3761&quot;&gt;&lt;del&gt;KAFKA-3761&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
    2. Trivial clean-ups in KafkaController&lt;br/&gt;
    3. Removed unused parameter in `ZkUtils.getPartitionLeaderAndIsrForTopics`&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ijuma/kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ijuma/kafka&lt;/a&gt; on-controller-resignation-if-trigger-controller-move&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2935.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2935.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2935&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c01d29b3a95e7ddffb91550397a5505d9711d5c8&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-04-28T12:30:03Z&lt;/p&gt;

&lt;p&gt;    MINOR: onControllerResignation should be invoked if triggerControllerMove is called&lt;/p&gt;

&lt;p&gt;commit f28de697f7d109893537652e8b8216c4d06677a7&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-04-28T12:30:47Z&lt;/p&gt;

&lt;p&gt;    Remove remnant broker state update in `onControllerFailover`&lt;/p&gt;

&lt;p&gt;commit 898b88b59cffbfdb7df864d0b070ed7a4960601e&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-04-28T12:31:15Z&lt;/p&gt;

&lt;p&gt;    A few trivial clean-ups in KafkaController&lt;/p&gt;

&lt;p&gt;commit 241b9890ab47b4670e61f3f9d3b51c6aa92a8a94&lt;br/&gt;
Author: Ismael Juma &amp;lt;ismael@juma.me.uk&amp;gt;&lt;br/&gt;
Date:   2017-04-28T12:31:38Z&lt;/p&gt;

&lt;p&gt;    Remove unused parameter in `getPartitionLeaderAndIsrForTopics`&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16030397" author="githubbot" created="Wed, 31 May 2017 00:00:47 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/kafka/pull/2935&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/2935&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ykk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>