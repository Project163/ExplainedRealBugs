<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16967] NioEchoServer fails to register connection and causes flaky failure</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16967</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The NioEchoServer calls Selector#register for new connections. This call can throw exceptions, which then kill the NioEchoServer. This has been observed in the SslTransportLayerTest testUngracefulRemoteCloseDuringHandshake* methods.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;echoserver&quot; java.lang.IllegalStateException: There is already a connection for id 127.0.0.1:40007-127.0.0.1:43710
	at org.apache.kafka.common.network.Selector.ensureNotRegistered(Selector.java:322)
	at org.apache.kafka.common.network.Selector.register(Selector.java:310)
	at org.apache.kafka.common.network.NioEchoServer.run(NioEchoServer.java:229)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This causes the test to fail with essentially a timeout, when the connection is expired for becoming idle unexpectedly:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.opentest4j.AssertionFailedError: Unexpected channel state EXPIRED ==&amp;gt; expected: &amp;lt;true&amp;gt; but was: &amp;lt;false&amp;gt;
    at org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)
&#160; &#160;&#160;at org.junit.jupiter.api.AssertionFailureBuilder.buildAndThrow(AssertionFailureBuilder.java:132)
    at org.junit.jupiter.api.AssertTrue.failNotTrue(AssertTrue.java:63)
    at org.junit.jupiter.api.AssertTrue.assertTrue(AssertTrue.java:36)
    at org.junit.jupiter.api.Assertions.assertTrue(Assertions.java:214)
    at org.apache.kafka.common.network.SslTransportLayerTest.testIOExceptionsDuringHandshake(SslTransportLayerTest.java:898)
    at org.apache.kafka.common.network.SslTransportLayerTest.testUngracefulRemoteCloseDuringHandshakeRead(SslTransportLayerTest.java:837)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Instead, the NioEchoServer should handle exceptions from register in a similar fashion to the SocketServer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13582748">KAFKA-16967</key>
            <summary>NioEchoServer fails to register connection and causes flaky failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankvicky">TengYao Chi</assignee>
                                    <reporter username="gharris1727">Greg Harris</reporter>
                        <labels>
                            <label>flaky-test</label>
                            <label>newbie</label>
                    </labels>
                <created>Sat, 15 Jun 2024 00:45:36 +0000</created>
                <updated>Mon, 24 Jun 2024 13:40:05 +0000</updated>
                            <resolved>Mon, 24 Jun 2024 13:40:05 +0000</resolved>
                                                    <fixVersion>3.9.0</fixVersion>
                                    <component>core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17855161" author="JIRAUSER305181" created="Sat, 15 Jun 2024 01:01:04 +0000"  >&lt;p&gt;If this ticket is open, I would like to fix it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17855170" author="gharris1727" created="Sat, 15 Jun 2024 02:22:06 +0000"  >&lt;p&gt;I looked into the IllegalStateException more to see if it was worth preventing. I think this appears in the tests because Linux allows fast port reuse on loopback adapters: &lt;a href=&quot;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=79e9fed460385a3d8ba0b5782e9e74405cb199b1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=79e9fed460385a3d8ba0b5782e9e74405cb199b1&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;This shouldn&apos;t happen in the wild, as the 2MSL (4 minute) timeout for port reuse should be much longer than any race condition in the code, and it would probably be more complicated to remove the registration state before closing the underlying transport. I think this ticket can stand alone, and we don&apos;t need to change the double-registration behavior of the Selector.&lt;/p&gt;</comment>
                            <comment id="17855172" author="gharris1727" created="Sat, 15 Jun 2024 02:25:31 +0000"  >&lt;p&gt;Thanks for picking this up &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankvicky&quot; class=&quot;user-hover&quot; rel=&quot;frankvicky&quot;&gt;frankvicky&lt;/a&gt; . Don&apos;t worry too much about reproducing the IllegalStateException naturally. I suspect that requires Linux and a very lucky sequence of port re-use.&lt;/p&gt;</comment>
                            <comment id="17855614" author="JIRAUSER305181" created="Mon, 17 Jun 2024 13:18:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;user-hover&quot; rel=&quot;gharris1727&quot;&gt;gharris1727&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thank you for the information. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13558285">KAFKA-15845</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ptfc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>