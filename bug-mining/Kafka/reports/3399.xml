<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:31:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-14496] Wrong Base64 encoder used by OIDC OAuthBearerLoginCallbackHandler</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-14496</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;Currently our team is setting up a blueprint for our Kafka consumers/producers to provide guidelines on how to connect to our broker using the OIDC security mechanism. The blueprint is written in Java using the latest 3.3.1 Kafka library dependencies managed by Spring Boot 3.0.0.&lt;/p&gt;

&lt;p&gt;While trying to use the new built-in &lt;tt&gt;org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerLoginCallbackHandler&lt;/tt&gt; introduced by &lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=186877575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;KIP-768: Extend SASL/OAUTHBEARER with Support for OIDC&lt;/a&gt;, we&apos;ve noticed that some calls to retrieve the token work out well, while some of them (seemingly randomly) are failing with 401 Unauthorized.&lt;/p&gt;

&lt;p&gt;After some debugging we&apos;ve got to the conclusion that the faulty behavior is caused by &lt;tt&gt;org.apache.kafka.common.security.oauthbearer.secured.HttpAccessTokenRetriever#formatAuthorizationHeader:&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; formatAuthorizationHeader(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clientId, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; clientSecret) {
&#160; &#160; clientId = sanitizeString(&lt;span class=&quot;code-quote&quot;&gt;&quot;the token endpoint request client ID parameter&quot;&lt;/span&gt;, clientId);
&#160; &#160; clientSecret = sanitizeString(&lt;span class=&quot;code-quote&quot;&gt;&quot;the token endpoint request client secret parameter&quot;&lt;/span&gt;, clientSecret);
    
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s:%s&quot;&lt;/span&gt;, clientId, clientSecret);
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; encoded = Base64.getUrlEncoder().encodeToString(Utils.utf8(s));
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Basic %s&quot;&lt;/span&gt;, encoded);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above code is using &lt;tt&gt;java.util.Base64#getUrlEncoder&lt;/tt&gt; on line 311 to encode the authorization header value, which is using the alphabet described in &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc4648#section-5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;section 5 of the RFC&lt;/a&gt; during the encoding algorithm. As stated by the Basic Authentication Scheme &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc7617#section-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;definition&lt;/a&gt; however, &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc4648#section-4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;section 4 of the RFC&lt;/a&gt; should be used:&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;4. and obtains the basic-credentials by encoding this octet sequence using Base64 (&lt;span class=&quot;error&quot;&gt;&amp;#91;RFC4648&amp;#93;&lt;/span&gt;, Section&#160;4) into a sequence of US-ASCII characters (&lt;span class=&quot;error&quot;&gt;&amp;#91;RFC0020&amp;#93;&lt;/span&gt;).&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;The difference between the 2 alphabets are only on two characters (62: &apos;+&apos; vs. &apos;-&apos; and 63: &apos;/&apos; vs. &apos;_&apos;), that&apos;s why the 401 Unauthorized response arises only for certain credential values.&lt;/p&gt;

&lt;p&gt;Here&apos;s a concrete example use case:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s:%s&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;SOME_RANDOM_LONG_USER_01234&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;9Q|0`8i~ute-n9ksjLWb\\50\&quot;&lt;/span&gt;AX@UUED5E&quot;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(Base64.getUrlEncoder().encodeToString(Utils.utf8(s))); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;would print out:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
U09NRV9SQU5ET01fTE9OR19VU0VSXzAxMjM0OjlRfDBgOGl-dXRlLW45a3NqTFdiXDUwIkFYQFVVRUQ1RQ== &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;while&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s:%s&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;SOME_RANDOM_LONG_USER_01234&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;9Q|0`8i~ute-n9ksjLWb\\50\&quot;&lt;/span&gt;AX@UUED5E&quot;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(Base64.getEncoder().encodeToString(Utils.utf8(s))); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;would give:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
U09NRV9SQU5ET01fTE9OR19VU0VSXzAxMjM0OjlRfDBgOGl+dXRlLW45a3NqTFdiXDUwIkFYQFVVRUQ1RQ== &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please notice the &apos;-&apos; vs. &apos;+&apos; characters.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The 2 code snippets above would not behave differently for other credentials, where the encoded result doesn&apos;t use the 62nd character of the alphabet:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s:%s&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;SHORT_USER_01234&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;9Q|0`8i~ute-n9ksjLWb\\50\&quot;&lt;/span&gt;AX@UUED5E&quot;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(Base64.getEncoder().encodeToString(Utils.utf8(s))); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
U0hPUlRfVVNFUl8wMTIzNDo5UXwwYDhpfnV0ZS1uOWtzakxXYlw1MCJBWEBVVUVENUU=

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As a &lt;b&gt;conclusion&lt;/b&gt; I would suggest that line 311 of&#160;&lt;tt&gt;HttpAccessTokenRetriever&lt;/tt&gt; should be modified to use &lt;tt&gt;Base64.getEncoder().encodeToString(...)&lt;/tt&gt; instead of&#160;&lt;tt&gt;Base64.getUrlEncoder().encodeToString(...).&lt;/tt&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a short sample application with tests proving that the above encoding method is rejected by the standard Spring Security HTTP basic authentication as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13514039">KAFKA-14496</key>
            <summary>Wrong Base64 encoder used by OIDC OAuthBearerLoginCallbackHandler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kirktrue">Kirk True</assignee>
                                    <reporter username="vendre">Endre Vig</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Dec 2022 12:04:09 +0000</created>
                <updated>Fri, 16 Dec 2022 14:31:13 +0000</updated>
                            <resolved>Fri, 16 Dec 2022 14:31:13 +0000</resolved>
                                    <version>3.3.1</version>
                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>clients</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17648154" author="omkreddy" created="Thu, 15 Dec 2022 16:25:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vendre&quot; class=&quot;user-hover&quot; rel=&quot;vendre&quot;&gt;vendre&lt;/a&gt; Thanks for reporting the issue. Would you like to submit a fix for this?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17648208" author="JIRAUSER298558" created="Thu, 15 Dec 2022 18:54:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=omkreddy&quot; class=&quot;user-hover&quot; rel=&quot;omkreddy&quot;&gt;omkreddy&lt;/a&gt; I would be very glad to submit a fix.&lt;/p&gt;</comment>
                            <comment id="17648231" author="kirktrue" created="Thu, 15 Dec 2022 20:12:54 +0000"  >&lt;p&gt;Thanks for catching this, Endre!&lt;/p&gt;</comment>
                            <comment id="17648239" author="kirktrue" created="Thu, 15 Dec 2022 20:34:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vendre&quot; class=&quot;user-hover&quot; rel=&quot;vendre&quot;&gt;vendre&lt;/a&gt; - has been deemed a release blocker for AK 3.3.2 and 3.4. We really need a fix ASAP. Are you in a position to submit a patch in the next day or two? I want to make sure you get the credit for finding/fixing the issue. Thanks!&lt;/p&gt;</comment>
                            <comment id="17648245" author="JIRAUSER298558" created="Thu, 15 Dec 2022 20:55:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, there would be no technical issue for me to submit a fix.&lt;/p&gt;

&lt;p&gt;Two things to consider however that could incur some delay:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;would be the first time for me to contribute (I already have gone through the guide, but you never know, I might miss something)&lt;/li&gt;
	&lt;li&gt;I&apos;m from Europe time zone, today I cannot stay for a long time&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Please feel free to decide based on the above info, and if necessary, just assign the ticket to someone else, I wouldn&apos;t mind.&lt;/p&gt;

&lt;p&gt;Thanks a lot!&lt;/p&gt;</comment>
                            <comment id="17648281" author="kirktrue" created="Thu, 15 Dec 2022 22:56:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vendre&quot; class=&quot;user-hover&quot; rel=&quot;vendre&quot;&gt;vendre&lt;/a&gt; - thanks for the timely response!&lt;/p&gt;

&lt;p&gt;I appreciate your candor and certainly don&apos;t want to rush you due to the tight scheduling of the AK release. I&apos;ll reassign the ticket to myself and use your fix and test case.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17648297" author="kirktrue" created="Thu, 15 Dec 2022 23:48:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vendre&quot; class=&quot;user-hover&quot; rel=&quot;vendre&quot;&gt;vendre&lt;/a&gt; - I&apos;ve made a pull request (&lt;a href=&quot;https://github.com/apache/kafka/pull/13000)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/pull/13000)&lt;/a&gt; based off your suggestions.&lt;/p&gt;

&lt;p&gt;I&apos;m happy to give you co-authorship attribution if you are comfortable sharing your email address.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="17648357" author="JIRAUSER298558" created="Fri, 16 Dec 2022 06:40:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kirktrue&quot; class=&quot;user-hover&quot; rel=&quot;kirktrue&quot;&gt;kirktrue&lt;/a&gt;, thanks for acting so fast upon the ticket and quickly applying the fix. We&apos;ll be very happy to have it available within the next release.&lt;/p&gt;

&lt;p&gt;I&apos;m definitely comfortable sharing my GitHub email address: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;mailto:vendre@gmail.com.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;vendre@gmail.com.&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/mail_small.gif&quot; height=&quot;12&quot; width=&quot;13&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; Thanks for the offering!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13053903" name="base64test.zip" size="5219" author="vendre" created="Thu, 15 Dec 2022 12:05:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1e488:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>manikumar</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>