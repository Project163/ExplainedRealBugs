<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 17:39:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KAFKA-16765] NioEchoServer leaks accepted SocketChannel instances due to race condition</title>
                <link>https://issues.apache.org/jira/browse/KAFKA-16765</link>
                <project id="12311720" key="KAFKA">Kafka</project>
                    <description>&lt;p&gt;The NioEchoServer has an AcceptorThread that calls accept() to open new SocketChannel instances and insert them into the `newChannels` List, and a main thread that drains the `newChannels` List and moves them to the `socketChannels` List.&lt;/p&gt;

&lt;p&gt;During shutdown, the serverSocketChannel is closed, which causes both threads to exit their while loops. It is possible for the NioEchoServer main thread to sense the serverSocketChannel close and terminate before the Acceptor thread does, and for the Acceptor thread to put a SocketChannel in `newChannels` before terminating. This instance is never closed by either thread, because it is never moved to `socketChannels`.&lt;/p&gt;

&lt;p&gt;A precise execution order that has this leak is:&lt;br/&gt;
1. NioEchoServer thread locks `newChannels`.&lt;br/&gt;
2. Acceptor thread accept() completes, and the SocketChannel is created&lt;br/&gt;
3. Acceptor thread blocks waiting for the `newChannels` lock&lt;br/&gt;
4. NioEchoServer thread releases the `newChannels` lock and does some processing&lt;br/&gt;
5. NioEchoServer#close() is called, which closes the serverSocketChannel&lt;br/&gt;
6. NioEchoServer thread checks serverSocketChannel.isOpen() and then terminates&lt;br/&gt;
7. Acceptor thread acquires the `newChannels` lock and adds the SocketChannel to `newChannels`.&lt;br/&gt;
8. Acceptor thread checks serverSocketChannel.isOpen() and then terminates.&lt;br/&gt;
9. NioEchoServer#close() stops blocking now that both other threads have terminated.&lt;/p&gt;

&lt;p&gt;The end result is that the leaked socket is left open in the `newChannels` list at the end of close(), which is incorrect.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13579287">KAFKA-16765</key>
            <summary>NioEchoServer leaks accepted SocketChannel instances due to race condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zzk1">zhengke zhou</assignee>
                                    <reporter username="gharris1727">Greg Harris</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Tue, 14 May 2024 20:03:03 +0000</created>
                <updated>Tue, 6 Aug 2024 15:53:28 +0000</updated>
                            <resolved>Wed, 24 Jul 2024 17:21:17 +0000</resolved>
                                    <version>3.8.0</version>
                                    <fixVersion>3.9.0</fixVersion>
                                    <component>core</component>
                    <component>unit tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17846475" author="gharris1727" created="Wed, 15 May 2024 02:25:49 +0000"  >&lt;p&gt;This is also a bug in EchoServer: &lt;a href=&quot;https://github.com/apache/kafka/blob/cb968845ecb3cb0982182d9dd437ecf652fe38d3/clients/src/test/java/org/apache/kafka/common/network/EchoServer.java#L76-L81&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/cb968845ecb3cb0982182d9dd437ecf652fe38d3/clients/src/test/java/org/apache/kafka/common/network/EchoServer.java#L76-L81&lt;/a&gt; and ServerShutdownTest: &lt;a href=&quot;https://github.com/apache/kafka/blob/cb968845ecb3cb0982182d9dd437ecf652fe38d3/core/src/test/scala/unit/kafka/server/ServerShutdownTest.scala#L274-L275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/kafka/blob/cb968845ecb3cb0982182d9dd437ecf652fe38d3/core/src/test/scala/unit/kafka/server/ServerShutdownTest.scala#L274-L275&lt;/a&gt; except those don&apos;t require a race condition to happen.&lt;/p&gt;</comment>
                            <comment id="17860996" author="JIRAUSER305940" created="Sun, 30 Jun 2024 13:21:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gharris1727&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Greg Harris&lt;/a&gt; In this ticket, we want to avoid the situation where the Producer: acceptorThread creates a channel and adds it to SocketChannels that will never be consumed by the main thread. To resolve this, we can clear up closeSocketChannels after acceptorThread exited.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13588010">KAFKA-17269</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13579313">KAFKA-16768</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13558285">KAFKA-15845</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1p83k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>